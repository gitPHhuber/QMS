PROJECT CORE FILES OVERVIEW
================================================================================
- QMS-Client-main/index.html
- QMS-Client-main/package.json
- QMS-Client-main/postcss.config.js
- QMS-Client-main/src/App.css
- QMS-Client-main/src/App.tsx
- QMS-Client-main/src/api/apiClient.ts
- QMS-Client-main/src/api/auditApi.ts
- QMS-Client-main/src/api/index.ts
- QMS-Client-main/src/api/labelTemplatesApi.ts
- QMS-Client-main/src/api/projectsApi.ts
- QMS-Client-main/src/api/qmsApi.ts
- QMS-Client-main/src/api/rbacApi.ts
- QMS-Client-main/src/api/structureApi.ts
- QMS-Client-main/src/api/tasksApi.ts
- QMS-Client-main/src/api/userApi.ts
- QMS-Client-main/src/api/warehouseApi.ts
- QMS-Client-main/src/components/AppRouter.tsx
- QMS-Client-main/src/components/Footer/Footer.tsx
- QMS-Client-main/src/components/Header/DateTimeDisplay.tsx
- QMS-Client-main/src/components/Header/Header.tsx
- QMS-Client-main/src/components/Modal/ConfirmModal.tsx
- QMS-Client-main/src/components/Modal/Modal.tsx
- QMS-Client-main/src/components/common/Preloader.tsx
- QMS-Client-main/src/components/common/PreloaderMini.tsx
- QMS-Client-main/src/hooks/useBetaflyData.ts
- QMS-Client-main/src/index.css
- QMS-Client-main/src/main.tsx
- QMS-Client-main/src/pages/Admin/AdminPCs/AdminEditPC.tsx
- QMS-Client-main/src/pages/Admin/AdminPCs/AdminOnePC.tsx
- QMS-Client-main/src/pages/Admin/AdminPCs/AdminPCs.tsx
- QMS-Client-main/src/pages/Admin/AdminPanel.tsx
- QMS-Client-main/src/pages/Admin/AdminUsers/AdminEditUser.tsx
- QMS-Client-main/src/pages/Admin/AdminUsers/AdminOneUser.tsx
- QMS-Client-main/src/pages/Admin/AdminUsers/AdminUsers.tsx
- QMS-Client-main/src/pages/Admin/Audit/AuditLogPage.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreateDefect.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreatePC.tsx
- QMS-Client-main/src/pages/Admin/Main/AdminCard.tsx
- QMS-Client-main/src/pages/Admin/Main/StructureSection.tsx
- QMS-Client-main/src/pages/Admin/Main/UsersSection.tsx
- QMS-Client-main/src/pages/Admin/Main/WarehouseSection.tsx
- QMS-Client-main/src/pages/Admin/RBAC/AdminRightsPage.tsx
- QMS-Client-main/src/pages/Admin/Structure/StructurePage.tsx
- QMS-Client-main/src/pages/Admin/Warehouse/WarehousePage.tsx
- QMS-Client-main/src/pages/CAPA/CapaPage.tsx
- QMS-Client-main/src/pages/Documents/DocumentsPage.tsx
- QMS-Client-main/src/pages/Login/Login.tsx
- QMS-Client-main/src/pages/Login/Registration.tsx
- QMS-Client-main/src/pages/Nonconformity/NonconformityPage.tsx
- QMS-Client-main/src/pages/PCs/OnePC.tsx
- QMS-Client-main/src/pages/PCs/SelectPC.tsx
- QMS-Client-main/src/pages/Profile/Profile.tsx
- QMS-Client-main/src/pages/QMS/QmsDashboardPage.tsx
- QMS-Client-main/src/pages/StartPage/StartPage.tsx
- QMS-Client-main/src/pages/Tasks/ProjectsList.tsx
- QMS-Client-main/src/pages/Tasks/TasksList.tsx
- QMS-Client-main/src/pages/Tasks/TasksPage.tsx
- QMS-Client-main/src/pages/Users/OneUser.tsx
- QMS-Client-main/src/pages/Users/Users.tsx
- QMS-Client-main/src/pages/Warehouse/AnalyticsPage.tsx
- QMS-Client-main/src/pages/Warehouse/InventoryPage.tsx
- QMS-Client-main/src/pages/Warehouse/WarehousePage.tsx
- QMS-Client-main/src/pages/Warehouse/__tests__/utils.test.ts
- QMS-Client-main/src/pages/Warehouse/components/LabelConstructor.tsx
- QMS-Client-main/src/pages/Warehouse/components/LabelPreview.tsx
- QMS-Client-main/src/pages/Warehouse/components/ProjectDashboard.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/VideoTransmittersLabel.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseBalance.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseDocs.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseIntake.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseLabels.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseMoves.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehousePrintHistory.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseSettings.tsx
- QMS-Client-main/src/pages/Warehouse/utils.ts
- QMS-Client-main/src/routes.ts
- QMS-Client-main/src/setupTests.ts
- QMS-Client-main/src/store/StructureStore.ts
- QMS-Client-main/src/store/UserStore.ts
- QMS-Client-main/src/store/__tests__/UserStore.test.ts
- QMS-Client-main/src/types/AssemblyModels.ts
- QMS-Client-main/src/types/AuditLogModel.ts
- QMS-Client-main/src/types/BoardsForFlashModel.ts
- QMS-Client-main/src/types/ComponentModel.ts
- QMS-Client-main/src/types/DefectModel.ts
- QMS-Client-main/src/types/DefectTypes.ts
- QMS-Client-main/src/types/PCModel.ts
- QMS-Client-main/src/types/ProductModel.ts
- QMS-Client-main/src/types/SessionModel.ts
- QMS-Client-main/src/types/UserModel.ts
- QMS-Client-main/src/types/WarehouseModels.ts
- QMS-Client-main/src/types/beryll/components.ts
- QMS-Client-main/src/types/beryll/defectsAndMonitoring.ts
- QMS-Client-main/src/utils/consts.ts
- QMS-Client-main/src/utils/constsModalType.ts
- QMS-Client-main/src/vite-env.d.ts
- QMS-Client-main/tailwind.config.js
- QMS-Client-main/tsconfig.json
- QMS-Client-main/tsconfig.node.json
- QMS-Client-main/vite.config.ts
- QMS-Client-main/vitest.config.ts
- QMS-Mobile/mes-pwa/deploy.sh
- QMS-Mobile/mes-pwa/index.html
- QMS-Mobile/mes-pwa/package.json
- QMS-Mobile/mes-pwa/postcss.config.js
- QMS-Mobile/mes-pwa/public/silent-check-sso.html
- QMS-Mobile/mes-pwa/src/App.tsx
- QMS-Mobile/mes-pwa/src/api/client.ts
- QMS-Mobile/mes-pwa/src/components/common/Layout.tsx
- QMS-Mobile/mes-pwa/src/components/ui/index.tsx
- QMS-Mobile/mes-pwa/src/config/index.ts
- QMS-Mobile/mes-pwa/src/hooks/index.ts
- QMS-Mobile/mes-pwa/src/index.css
- QMS-Mobile/mes-pwa/src/main.tsx
- QMS-Mobile/mes-pwa/src/pages/Auth/LoginPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Home/HomePage.tsx
- QMS-Mobile/mes-pwa/src/pages/Production/ChecklistPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Production/ProductScanPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Production/ProductionPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Profile/ProfilePage.tsx
- QMS-Mobile/mes-pwa/src/pages/Rankings/RankingsPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Tasks/TasksPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Warehouse/BoxDetailPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Warehouse/WarehousePage.tsx
- QMS-Mobile/mes-pwa/src/types/index.ts
- QMS-Mobile/mes-pwa/src/vite-env.d.ts
- QMS-Mobile/mes-pwa/tailwind.config.js
- QMS-Mobile/mes-pwa/tsconfig.json
- QMS-Mobile/mes-pwa/tsconfig.node.json
- QMS-Mobile/mes-pwa/vite.config.ts
- QMS-Server-master/_backup_20260210_123659/General.js
- QMS-Server-master/_backup_20260210_123659/index.js
- QMS-Server-master/config/config.js
- QMS-Server-master/controllers/ProjectController.js
- QMS-Server-master/controllers/TaskController.js
- QMS-Server-master/controllers/auditController.js
- QMS-Server-master/controllers/documentController.js
- QMS-Server-master/controllers/ncCapaController.js
- QMS-Server-master/controllers/pcController.js
- QMS-Server-master/controllers/rbacController.js
- QMS-Server-master/controllers/riskController.js
- QMS-Server-master/controllers/sessionController.js
- QMS-Server-master/controllers/structureController.js
- QMS-Server-master/controllers/userController.js
- QMS-Server-master/controllers/warehouse/AlertsController.js
- QMS-Server-master/controllers/warehouse/AnalyticsController.js
- QMS-Server-master/controllers/warehouse/BoxController.js
- QMS-Server-master/controllers/warehouse/DocumentController.js
- QMS-Server-master/controllers/warehouse/HistoryController.js
- QMS-Server-master/controllers/warehouse/MovementController.js
- QMS-Server-master/controllers/warehouse/SupplyController.js
- QMS-Server-master/db.js
- QMS-Server-master/docker-compose.yml
- QMS-Server-master/error/ApiError.js
- QMS-Server-master/fonts/README.md
- QMS-Server-master/index.js
- QMS-Server-master/jest.config.js
- QMS-Server-master/middleware/ErrorHandlingMiddleware.js
- QMS-Server-master/middleware/authMiddleware.js
- QMS-Server-master/middleware/checkAbilityMiddleware.js
- QMS-Server-master/middleware/checkRoleMiddleware.js
- QMS-Server-master/middleware/syncUserMiddleware.js
- QMS-Server-master/migrations/20250126-add-structure-manager-fields.js
- QMS-Server-master/migrations/20260209-create-core.js
- QMS-Server-master/migrations/20260210-audit-hashchain.js
- QMS-Server-master/migrations/20260210-create-dms.js
- QMS-Server-master/migrations/20260210-create-nc-capa.js
- QMS-Server-master/migrations/20260210-create-rbac.js
- QMS-Server-master/migrations/20260211-p1p2-all-modules.js
- QMS-Server-master/migrations/seeders/20260121-seed-defect-categories.js
- QMS-Server-master/models/definitions/Document.js
- QMS-Server-master/models/definitions/Equipment.js
- QMS-Server-master/models/definitions/General.js
- QMS-Server-master/models/definitions/InternalAudit.js
- QMS-Server-master/models/definitions/ManagementReview.js
- QMS-Server-master/models/definitions/NcCapa.js
- QMS-Server-master/models/definitions/Project.js
- QMS-Server-master/models/definitions/Risk.js
- QMS-Server-master/models/definitions/Structure.js
- QMS-Server-master/models/definitions/Supplier.js
- QMS-Server-master/models/definitions/Training.js
- QMS-Server-master/models/definitions/Warehouse.js
- QMS-Server-master/models/index.js
- QMS-Server-master/package.json
- QMS-Server-master/routes/auditRouter.js
- QMS-Server-master/routes/documentRouter.js
- QMS-Server-master/routes/index.js
- QMS-Server-master/routes/ncCapaRouter.js
- QMS-Server-master/routes/pcRouter.js
- QMS-Server-master/routes/projectRouter.js
- QMS-Server-master/routes/rbacRouter.js
- QMS-Server-master/routes/riskRouter.js
- QMS-Server-master/routes/sessionRouter.js
- QMS-Server-master/routes/structureRouter.js
- QMS-Server-master/routes/taskRouter.js
- QMS-Server-master/routes/userRouter.js
- QMS-Server-master/routes/warehouseRouter.js
- QMS-Server-master/run-migration.js
- QMS-Server-master/scripts/backfill-audit-hashes.js
- QMS-Server-master/scripts/cleanup-mes-legacy.sh
- QMS-Server-master/scripts/import_nov_dec_2025.js
- QMS-Server-master/scripts/import_production_outputs.js
- QMS-Server-master/scripts/import_thermal_outputs_2.js
- QMS-Server-master/scripts/run-migration-components.js
- QMS-Server-master/seeders/20260123-beryll-abilities.js
- QMS-Server-master/seeders/20260123-component-catalog.js
- QMS-Server-master/seeders/20260123-sla-config.js
- QMS-Server-master/seeders/20260201-vegman-component-revisions.js
- QMS-Server-master/seeders/beryllSeeder.js
- QMS-Server-master/services/DocumentService.js
- QMS-Server-master/services/ExcelImportService.js
- QMS-Server-master/services/NcCapaService.js
- QMS-Server-master/services/PdfService.js
- QMS-Server-master/services/RiskMatrixService.js
- QMS-Server-master/services/SupplierScoringService.js
- QMS-Server-master/static/defect-records/2/1769537183976_README.md
- QMS-Server-master/static/defect-records/2/1769579757522_README.md
- QMS-Server-master/static/defect-records/2/1769580241363_README.md
- QMS-Server-master/tests/controllers/box.test.js
- QMS-Server-master/tests/controllers/movement.test.js
- QMS-Server-master/tests/controllers/supply.test.js
- QMS-Server-master/tests/middleware/checkAbility.test.js
- QMS-Server-master/tests/middleware/syncUser.test.js
- QMS-Server-master/utils/auditLogger.js
- QMS-Server-master/utils/auditVerifier.js
- QMS-Server-master/utils/hashChainLogger.js
- README.md
- dump_project_full.py
- integrate-qms.sh
- remove_comments.py


================================================================================
FILE: QMS-Client-main/index.html
================================================================================

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MES-Kryptonit</title>
    <link rel="icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/apple-touch-icon-180x180.png" sizes="180x180" />
    <link rel="mask-icon" href="/public/maskable-icon-512x512.png" color="#FFFFFF">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: QMS-Client-main/package.json
================================================================================

{
  "name": "MES-Kryptonit",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "lint": "eslint src/ --ext ts,tsx --report-unused-disable-directives",
    "preview": "vite preview",
    "generate-pwa-assets": "pwa-assets-generator --preset minimal src/assets/images/logo.svg",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "coverage": "vitest run --coverage"
  },
  "dependencies": {
    "@headlessui/react": "^2.0.4",
    "@heroicons/react": "^2.1.3",
    "@sendgrid/mail": "^8.1.3",
    "@skbkontur/react-ui": "^5.0.10",
    "@types/axios": "^0.14.0",
    "@types/node": "^20.12.12",
    "axios": "^1.6.8",
    "clsx": "^2.1.1",
    "dayjs": "^1.11.13",
    "jwt-decode": "^4.0.0",
    "lucide-react": "^0.562.0",
    "mobx": "^6.13.5",
    "mobx-react-lite": "^4.1.0",
    "oidc-client-ts": "^3.4.1",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-hot-toast": "^2.6.0",
    "react-oidc-context": "^3.3.0",
    "react-qr-code": "^2.0.15",
    "react-router-dom": "^6.22.3",
    "react-use": "^17.6.0",
    "recharts": "^3.5.1",
    "socket.io-client": "^4.8.1"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^6.4.5",
    "@testing-library/react": "^14.3.1",
    "@types/react": "^18.3.2",
    "@types/react-dom": "^18.3.0",
    "@types/w3c-web-serial": "^1.0.8",
    "@typescript-eslint/eslint-plugin": "^7.2.0",
    "@typescript-eslint/parser": "^7.2.0",
    "@vite-pwa/assets-generator": "^0.2.4",
    "@vitejs/plugin-react": "^4.2.1",
    "@vitejs/plugin-react-swc": "^4.2.2",
    "@vitest/ui": "^1.6.0",
    "autoprefixer": "^10.4.19",
    "eslint": "^8.57.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.6",
    "jsdom": "^24.1.0",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.3",
    "typescript": "^5.4.5",
    "vite": "^5.2.0",
    "vite-plugin-pwa": "^0.20.0",
    "vitest": "^1.6.0"
  }
}

================================================================================
FILE: QMS-Client-main/postcss.config.js
================================================================================

export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: QMS-Client-main/src/App.css
================================================================================

* {
  margin: 0;
  padding: 0;
}

.App {
  text-align: center;
}

.img {
  background-color: burlywood;
  width: 300px;
  height: 300px;
}
.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}
================================================================================
FILE: QMS-Client-main/src/App.tsx
================================================================================

import "./App.css";
import { Header } from "components/Header/Header";
import background from "assets/images/backGroundTest1.svg";
import { AppRouter } from "components/AppRouter";
import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState, useRef } from "react";
import { Context, getSavedPath, clearSavedPath } from "./main";
import { Preloader } from "./components/common/Preloader";
import { useAuth } from "react-oidc-context";
import { useNavigate, useLocation } from "react-router-dom";
import { SELECT_PC_ROUTE } from "./utils/consts";
import { check } from "./api/userApi";
import { ShieldCheck, Lock, Cpu, X } from "lucide-react";
import { Toaster } from 'react-hot-toast';

const App = observer(() => {
  const auth = useAuth();
  const context = useContext(Context);
  const navigate = useNavigate();
  const location = useLocation();

  const [isUserLoading, setIsUserLoading] = useState(auth.isAuthenticated);

  const [showNotification, setShowNotification] = useState(false);
  const [notificationStep, setNotificationStep] = useState(1);


  const hasRestoredPath = useRef(false);


  const initialPathRef = useRef<string | null>(null);

  useEffect(() => {

    if (initialPathRef.current === null) {
      const currentPath = window.location.pathname + window.location.search;

      const hasOidcParams = window.location.search.includes('code=') ||
                            window.location.search.includes('state=');
      if (currentPath !== "/" && !hasOidcParams) {
        initialPathRef.current = currentPath;
      }
    }
  }, []);

  if (!context) throw new Error("Context required");
  const { user } = context;


  useEffect(() => {
    const timer1 = setTimeout(() => {
        setNotificationStep(1);
        setShowNotification(true);
    }, 1000);

    const timer2 = setTimeout(() => {
        setShowNotification(false);
    }, 5000);

    const timer3 = setTimeout(() => {
        setNotificationStep(2);
        setShowNotification(true);
    }, 5500);

    return () => {
        clearTimeout(timer1);
        clearTimeout(timer2);
        clearTimeout(timer3);
    };
  }, []);


  useEffect(() => {
    if (auth.isAuthenticated && auth.user) {
      localStorage.setItem('token', auth.user.access_token);
      setIsUserLoading(true);

      check()
        .then((userData) => {
            user.setUser(userData);
            user.setIsAuth(true);


            const pcId = localStorage.getItem('pcID');


            if (!hasRestoredPath.current) {
              hasRestoredPath.current = true;


              const savedPath = getSavedPath();
              const targetPath = initialPathRef.current || savedPath;


              if (savedPath) {
                clearSavedPath();
              }


              const currentPath = location.pathname;

              if (targetPath && targetPath !== "/" && targetPath !== currentPath) {

                console.log(`[App] –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å: ${targetPath}`);
                navigate(targetPath, { replace: true });
              } else if (!pcId && currentPath !== SELECT_PC_ROUTE && currentPath === "/") {


                console.log(`[App] –ù–µ—Ç pcID, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≤—ã–±–æ—Ä –ü–ö`);
                navigate(SELECT_PC_ROUTE, { replace: true });
              }

            }
        })
        .catch((err) => {
            console.error("‚ùå Failed to fetch user profile:", err);
        })
        .finally(() => setIsUserLoading(false));

    } else if (!auth.isLoading && !auth.isAuthenticated) {
      user.resetUser();
      localStorage.removeItem('token');
      localStorage.removeItem('userID');
      setIsUserLoading(false);
      hasRestoredPath.current = false;
      initialPathRef.current = null;
    }
  }, [auth.isAuthenticated, auth.user, user, navigate, location.pathname]);


  if (auth.isLoading || isUserLoading) {
    return <Preloader />;
  }


  if (!auth.isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 relative overflow-hidden font-sans">


        <div className="absolute inset-0 z-0">
            <div className="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]"></div>
            <div className="absolute left-0 right-0 top-0 -z-10 m-auto h-[310px] w-[310px] rounded-full bg-blue-400 opacity-20 blur-[100px]"></div>
            <div className="absolute right-0 bottom-0 -z-10 h-[310px] w-[310px] rounded-full bg-emerald-400 opacity-20 blur-[100px]"></div>
        </div>


        <div
            className={`absolute top-8 right-8 z-50 transition-all duration-700 transform ${showNotification ? 'translate-x-0 opacity-100' : 'translate-x-20 opacity-0'}`}
        >
            <div className="bg-white/90 backdrop-blur-md p-4 rounded-2xl shadow-2xl border border-white/60 max-w-xs relative group cursor-default hover:scale-105 transition-transform duration-300">
                <button
                    onClick={() => setShowNotification(false)}
                    className="absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition"
                >
                    <X size={14} />
                </button>

                <div className="flex gap-3">

                    <div className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-md transition-colors duration-500 ${notificationStep === 1 ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : 'bg-gradient-to-br from-blue-500 to-indigo-600'}`}>
                        {notificationStep === 1 ? 'üòá' : 'üëã'}
                    </div>

                    <div>

                        {notificationStep === 1 && (
                            <div className="animate-fadeIn">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="font-bold text-sm text-slate-800">–ú—ã —Å—Ç–∞–ª–∏ –ª—É—á—à–µ!</span>
                                </div>
                                <p className="text-xs text-slate-600 leading-relaxed">
                                    –° –≤–µ—Ä—Å–∏–µ–π <span className="font-bold text-orange-600">2.0</span> —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–ª–æ –µ—â–µ —É–¥–æ–±–Ω–µ–µ –∏ –ø—Ä–∏—è—Ç–Ω–µ–µ.
                                </p>
                            </div>
                        )}


                        {notificationStep === 2 && (
                            <div className="animate-fadeIn">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="font-bold text-sm text-slate-800">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MES</span>
                                    <span className="text-[10px] text-slate-400 bg-slate-100 px-1.5 rounded-full">v2.1</span>
                                </div>
                                <p className="text-xs text-slate-600 leading-relaxed">
                                    <span className="font-semibold text-indigo-600">–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</span> üòä <br/>
                                    –í–∫–ª—é—á–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ (RBAC).
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>


        <div className="relative z-10 bg-white/80 backdrop-blur-xl p-8 md:p-12 rounded-3xl shadow-2xl border border-white/50 max-w-md w-full mx-4 flex flex-col items-center transition-all duration-500 hover:shadow-blue-200/50">

           <div className="relative w-20 h-20 bg-gradient-to-br from-blue-600 to-emerald-500 rounded-2xl flex items-center justify-center shadow-lg mb-6 transform rotate-3 hover:rotate-0 transition-transform duration-300 group">
              <Cpu className="text-white w-10 h-10 group-hover:animate-pulse" strokeWidth={1.5} />
              <div className="absolute inset-0 bg-white opacity-20 rounded-2xl animate-ping"></div>
           </div>

           <h1 className="text-3xl font-bold text-slate-800 mb-2 tracking-tight">MES Kryptonit</h1>
           <p className="text-slate-500 mb-8 text-center text-sm">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º</p>

           <button
             onClick={() => auth.signinRedirect()}
             className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5 group"
           >
             <ShieldCheck className="w-5 h-5 group-hover:animate-bounce" />
             <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Keycloak</span>
           </button>

           <div className="mt-8 flex items-center gap-2 text-xs text-slate-400">
              <Lock size={12} />
              <span>–ó–∞—â–∏—â–µ–Ω–æ SSO –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π</span>
           </div>
        </div>


        <div className="absolute bottom-6 text-center text-xs text-slate-400">
          <p>¬© 2024 MES Kryptonit ‚Ä¢ –í–µ—Ä—Å–∏—è 2.1</p>
        </div>
      </div>
    );
  }


  return (
    <div
      style={{ backgroundImage: `url(${background})` }}
      className="bg-cover bg-no-repeat bg-center min-h-screen flex flex-col"
    >
      <Toaster
        position="top-right"
        toastOptions={{
          duration: 4000,
          style: {
            background: '#1e293b',
            color: '#fff',
            borderRadius: '12px',
          },
        }}
      />
      <Header />
      <main className="flex-1 overflow-auto pb-4 pt-14">
        <AppRouter />
      </main>
    </div>
  );
});

export default App;

================================================================================
FILE: QMS-Client-main/src/api/apiClient.ts
================================================================================

import { $authHost } from "./index";

export const apiClient = $authHost;

================================================================================
FILE: QMS-Client-main/src/api/auditApi.ts
================================================================================

import { $authHost } from "./index";
import { AuditLogModel } from "src/types/AuditLogModel";

export interface AuditLogFilter {
  page?: number;
  limit?: number;
  userId?: number;
  action?: string;
  entity?: string;
  dateFrom?: string;
  dateTo?: string;
}

export interface AuditLogResponse {
  count: number;
  rows: AuditLogModel[];
}

export const fetchAuditLogs = async (
  params: AuditLogFilter
): Promise<AuditLogResponse> => {
  const { data } = await $authHost.get<AuditLogResponse>("api/audit", {
    params,
  });
  return data;
};

================================================================================
FILE: QMS-Client-main/src/api/index.ts
================================================================================

import axios from 'axios';


const $host = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
});

const $authHost = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
});


const authInterceptor = (config: any) => {
  const token = localStorage.getItem('token');

  if (token && token !== "undefined" && token !== "null") {
    config.headers.authorization = `Bearer ${token}`;
  }
  return config;
};

$authHost.interceptors.request.use(authInterceptor);

export {
  $host,
  $authHost,
};

================================================================================
FILE: QMS-Client-main/src/api/labelTemplatesApi.ts
================================================================================

import { $authHost } from "./index";

export type LabelElementType = "TEXT" | "QR" | "RECTANGLE" | "LINE" | "IMAGE" | "COUNTER" | "ICON";

export interface LabelElement {
  id: string;
  type: LabelElementType;
  x: number;
  y: number;
  width: number;
  height: number;
  text?: string;
  content?: string;
  fontSize?: number;
  isBold?: boolean;
  align?: "left" | "center" | "right";
  counterFormat?: string;
  imageUrl?: string;
  imageName?: string;
  iconType?: string;
  strokeWidth?: number;
}

export interface LabelTemplateModel {
  id: number;
  name: string;
  type: string;
  width: number;
  height: number;
  layout?: LabelElement[];
  elements: LabelElement[];
  createdAt: string;
  updatedAt: string;
}

export const fetchLabelTemplates = async (): Promise<LabelTemplateModel[]> => {
  const { data } = await $authHost.get("api/warehouse/label-templates");
  return data;
};

export const createLabelTemplate = async (
  name: string,
  width: number,
  height: number,
  elements: LabelElement[]
): Promise<LabelTemplateModel> => {
  const { data } = await $authHost.post("api/warehouse/label-templates", {
    name,
    width,
    height,
    elements,
  });
  return data;
};

export const deleteLabelTemplate = async (id: number): Promise<void> => {
  await $authHost.delete(`api/warehouse/label-templates/${id}`);
};

================================================================================
FILE: QMS-Client-main/src/api/projectsApi.ts
================================================================================

import { $authHost } from "./index";

export interface ProjectModel {
    id: number;
    title: string;
    description: string;
    status: string;
    createdAt: string;
    author?: { name: string; surname: string };
}

export const fetchProjects = async () => {
    const { data } = await $authHost.get("api/projects");
    return data as ProjectModel[];
};

export const createProject = async (title: string, description: string) => {
    const { data } = await $authHost.post("api/projects", { title, description });
    return data;
};

export const deleteProject = async (id: number) => {
    await $authHost.delete(`api/projects/${id}`);
};
================================================================================
FILE: QMS-Client-main/src/api/qmsApi.ts
================================================================================










import { $authHost } from "./index";






export interface AuditVerifyReport {
  valid: boolean;
  totalRecords: number;
  validRecords: number;
  invalidRecords: number;
  unchainedRecords: number;
  firstChainIndex: number | null;
  lastChainIndex: number | null;
  errors: Array<{ chainIndex: number; recordId: number; valid: boolean; errors: string[] }>;
  verifiedAt: string;
  durationMs: number;
}

export interface AuditStats {
  period: { days: number; since: string };
  total: number;
  chainedTotal: number;
  chainCoverage: number;
  bySeverity: Array<{ severity: string; count: string }>;
  byEntity: Array<{ entity: string; count: string }>;
  byAction: Array<{ action: string; count: string }>;
}

export interface AuditInspectionReport {
  system: string;
  standard: string;
  generatedAt: string;
  chainIntegrity: AuditVerifyReport;
  severityDistribution: Array<{ severity: string; count: string }>;
  monthlyActivity: Array<{ month: string; count: string }>;
  conclusion: string;
}


export type DocType = "POLICY" | "MANUAL" | "PROCEDURE" | "WORK_INSTRUCTION" | "FORM" | "RECORD" | "SPECIFICATION" | "PLAN" | "EXTERNAL" | "OTHER";
export type DocStatus = "DRAFT" | "REVIEW" | "APPROVED" | "EFFECTIVE" | "REVISION" | "OBSOLETE" | "CANCELLED";

export interface DocumentShort {
  id: number;
  code: string;
  title: string;
  type: DocType;
  status: DocStatus;
  category: string | null;
  effectiveDate: string | null;
  nextReviewDate: string | null;
  owner: { id: number; name: string; surname: string };
  currentVersion: { id: number; version: string; status: string; effectiveAt: string | null } | null;
  updatedAt: string;
}

export interface DocumentApprovalItem {
  id: number;
  step: number;
  role: string;
  decision: string;
  comment: string | null;
  decidedAt: string | null;
  dueDate: string | null;
  assignedTo: { id: number; name: string; surname: string };
  version: {
    id: number;
    version: string;
    document: { id: number; code: string; title: string; type: string };
    createdBy: { id: number; name: string; surname: string };
  };
}

export interface DocumentStats {
  byStatus: Array<{ status: string; count: string }>;
  byType: Array<{ type: string; count: string }>;
  overdueCount: number;
  pendingApprovalsCount: number;
}


export type NcStatus = "OPEN" | "INVESTIGATING" | "DISPOSITION" | "IMPLEMENTING" | "VERIFICATION" | "CLOSED" | "REOPENED";
export type NcClassification = "CRITICAL" | "MAJOR" | "MINOR";

export interface NcShort {
  id: number;
  number: string;
  title: string;
  source: string;
  classification: NcClassification;
  status: NcStatus;
  detectedAt: string;
  dueDate: string | null;
  reportedBy: { id: number; name: string; surname: string };
  assignedTo: { id: number; name: string; surname: string } | null;
}


export type CapaStatus = "INITIATED" | "INVESTIGATING" | "PLANNING" | "PLAN_APPROVED" | "IMPLEMENTING" | "VERIFYING" | "EFFECTIVE" | "INEFFECTIVE" | "CLOSED";

export interface CapaShort {
  id: number;
  number: string;
  type: "CORRECTIVE" | "PREVENTIVE";
  title: string;
  status: CapaStatus;
  priority: string;
  dueDate: string | null;
  assignedTo: { id: number; name: string; surname: string } | null;
  initiatedBy: { id: number; name: string; surname: string };
  nonconformity: { id: number; number: string; title: string; classification: string } | null;
}

export interface NcCapaStats {
  ncByStatus: Array<{ status: string; count: string }>;
  ncBySource: Array<{ source: string; count: string }>;
  ncByClassification: Array<{ classification: string; count: string }>;
  capaByStatus: Array<{ status: string; count: string }>;
  capaByType: Array<{ type: string; count: string }>;
  overdueNc: number;
  overdueCapa: number;
}





export const auditApi = {
  getLogs: (params: Record<string, any>) =>
    $authHost.get("/api/audit/", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/audit/${id}`).then(r => r.data),

  quickVerify: (count = 100): Promise<AuditVerifyReport> =>
    $authHost.get("/api/audit/verify", { params: { count } }).then(r => r.data),

  fullVerify: (fromIndex?: number, toIndex?: number): Promise<AuditVerifyReport> =>
    $authHost.get("/api/audit/verify/full", { params: { fromIndex, toIndex } }).then(r => r.data),

  getReport: (): Promise<AuditInspectionReport> =>
    $authHost.get("/api/audit/report").then(r => r.data),

  getStats: (days = 30): Promise<AuditStats> =>
    $authHost.get("/api/audit/stats", { params: { days } }).then(r => r.data),
};





export const documentsApi = {
  getAll: (params: Record<string, any>) =>
    $authHost.get("/api/documents/", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/documents/${id}`).then(r => r.data),

  getStats: (): Promise<DocumentStats> =>
    $authHost.get("/api/documents/stats").then(r => r.data),

  getPending: (): Promise<DocumentApprovalItem[]> =>
    $authHost.get("/api/documents/pending").then(r => r.data),

  getOverdue: () =>
    $authHost.get("/api/documents/overdue").then(r => r.data),

  create: (data: { title: string; type: DocType; category?: string; description?: string; isoSection?: string }) =>
    $authHost.post("/api/documents/", data).then(r => r.data),

  createVersion: (docId: number, data: { changeDescription?: string }) =>
    $authHost.post(`/api/documents/${docId}/versions`, data).then(r => r.data),

  uploadFile: (versionId: number, file: File) => {
    const form = new FormData();
    form.append("file", file);
    return $authHost.post(`/api/documents/versions/${versionId}/upload`, form).then(r => r.data);
  },

  submitForReview: (versionId: number, approvalChain: Array<{ userId: number; role: string; dueDate?: string }>) =>
    $authHost.post(`/api/documents/versions/${versionId}/submit`, { approvalChain }).then(r => r.data),

  decide: (approvalId: number, data: { decision: string; comment?: string }) =>
    $authHost.post(`/api/documents/approvals/${approvalId}/decide`, data).then(r => r.data),

  makeEffective: (versionId: number) =>
    $authHost.post(`/api/documents/versions/${versionId}/effective`).then(r => r.data),

  distribute: (versionId: number, userIds: number[]) =>
    $authHost.post(`/api/documents/versions/${versionId}/distribute`, { userIds }).then(r => r.data),

  acknowledge: (distributionId: number) =>
    $authHost.post(`/api/documents/distributions/${distributionId}/ack`).then(r => r.data),
};





export const ncApi = {
  getAll: (params: Record<string, any>) =>
    $authHost.get("/api/nc/", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/nc/${id}`).then(r => r.data),

  create: (data: Record<string, any>) =>
    $authHost.post("/api/nc/", data).then(r => r.data),

  update: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/nc/${id}`, data).then(r => r.data),

  close: (id: number, data: { closingComment?: string }) =>
    $authHost.post(`/api/nc/${id}/close`, data).then(r => r.data),

  getStats: (): Promise<NcCapaStats> =>
    $authHost.get("/api/nc/stats").then(r => r.data),
};





export const capaApi = {
  getAll: (params: Record<string, any>) =>
    $authHost.get("/api/nc/capa", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/nc/capa/${id}`).then(r => r.data),

  create: (data: Record<string, any>) =>
    $authHost.post("/api/nc/capa", data).then(r => r.data),

  updateStatus: (id: number, data: { status: string; comment?: string }) =>
    $authHost.put(`/api/nc/capa/${id}/status`, data).then(r => r.data),

  addAction: (capaId: number, data: { description: string; assignedToId?: number; dueDate?: string }) =>
    $authHost.post(`/api/nc/capa/${capaId}/actions`, data).then(r => r.data),

  updateAction: (actionId: number, data: Record<string, any>) =>
    $authHost.put(`/api/nc/capa/actions/${actionId}`, data).then(r => r.data),

  verify: (capaId: number, data: { isEffective: boolean; evidence?: string; comment?: string }) =>
    $authHost.post(`/api/nc/capa/${capaId}/verify`, data).then(r => r.data),
};

================================================================================
FILE: QMS-Client-main/src/api/rbacApi.ts
================================================================================

import { $authHost } from "./index";

export interface AbilityModel {
    id: number;
    code: string;
    description: string;
}

export interface RoleModel {
    id: number;
    name: string;
    description: string;
    abilities: AbilityModel[];
}

export const fetchAllRoles = async () => {
    const { data } = await $authHost.get("api/rbac/roles");
    return data as RoleModel[];
};

export const fetchAllAbilities = async () => {
    const { data } = await $authHost.get("api/rbac/abilities");
    return data as AbilityModel[];
};

export const updateRoleAbilities = async (roleId: number, abilityIds: number[]) => {
    const { data } = await $authHost.post(`api/rbac/role/${roleId}`, { abilityIds });
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/structureApi.ts
================================================================================

import { $authHost } from "src/api";
import { userGetModel } from "src/types/UserModel";

export const fetchStructure = async () => {
    const { data } = await $authHost.get("api/structure");
    return data;
};


export const fetchUnassignedUsers = async () => {
    const { data } = await $authHost.get("api/structure/users/unassigned");
    return data as userGetModel[];
};

export const createSection = async (title: string) => {
    const { data } = await $authHost.post("api/structure/section", { title });
    return data;
};

export const createTeam = async (title: string, sectionId: number) => {
    const { data } = await $authHost.post("api/structure/team", { title, sectionId });
    return data;
};

export const assignSectionManager = async (sectionId: number, userId: number) => {
    const { data } = await $authHost.put("api/structure/section/manager", { sectionId, userId });
    return data;
};

export const assignTeamLead = async (teamId: number, userId: number) => {
    const { data } = await $authHost.put("api/structure/team/lead", { teamId, userId });
    return data;
};

export const addUserToTeam = async (teamId: number, userId: number) => {
    const { data } = await $authHost.put("api/structure/user/assign", { teamId, userId });
    return data;
};

export const removeUserFromTeam = async (userId: number) => {
    const { data } = await $authHost.put("api/structure/user/remove", { userId });
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/tasksApi.ts
================================================================================

import { $authHost } from "./index";
import { InventoryBoxModel } from "src/types/WarehouseModels";

export interface TaskStats {
  total: number;
  done: number;
  inWork: number;
  onStock: number;
}

export interface ProductionTask {
  id: number;
  title: string;
  originType?: string | null;
  originId?: number | null;
  targetQty: number;
  unit: string;
  dueDate?: string | null;
  status: string;
  priority?: number | null;
  comment?: string | null;

  responsibleId?: number | null;
  sectionId?: number | null;
  projectId?: number | null;

  responsible?: { id: number; name: string; surname: string } | null;
  targetSection?: { id: number; title: string } | null;
  project?: { id: number; title: string } | null;

  stats?: TaskStats;
  progressPercent?: number;
}

export interface TaskListResponse {
  rows: ProductionTask[];
  count: number;
  page: number;
  limit: number;
}

export interface TaskBreakdownItem {
  status: string;
  sectionId: number | null;
  sectionTitle: string | null;
  qty: number;
}

export interface TaskDetailResponse {
  task: ProductionTask;
  totalQty: number;
  breakdown: TaskBreakdownItem[];
  boxes: InventoryBoxModel[];
}

export const createTask = async (payload: {
  title: string;
  originType?: string;
  originId?: number;
  targetQty: number;
  unit: string;
  dueDate?: string;
  priority?: number;
  comment?: string;
  responsibleId?: number;
  sectionId?: number;
  projectId?: number;
}) => {
  const { data } = await $authHost.post("api/tasks", payload);
  return data as ProductionTask;
};

export const fetchTasks = async (params?: {
  page?: number;
  limit?: number;
  status?: string;
  search?: string;
  originType?: string;
}) => {
  const { data } = await $authHost.get("api/tasks", { params });
  return data as TaskListResponse;
};

export const fetchTaskById = async (id: number) => {
  const { data } = await $authHost.get(`api/tasks/${id}`);
  return data as TaskDetailResponse;
};

export const updateTaskStatus = async (id: number, status: string) => {
  const { data } = await $authHost.patch(`api/tasks/${id}/status`, { status });
  return data as ProductionTask;
};

export const updateTask = async (id: number, payload: any) => {
    const { data } = await $authHost.put(`api/tasks/${id}`, payload);
    return data as ProductionTask;
};

export const deleteTask = async (id: number) => {
    const { data } = await $authHost.delete(`api/tasks/${id}`);
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/userApi.ts
================================================================================

import { $authHost, $host } from "./index"
import { userModel } from "src/types/UserModel"

export const login = async (login: string, password: string) => {
    const { data } = await $host.post("api/users/login", { login, password })
    localStorage.setItem("token", data.token)
    return data
}

export const registration = async (login: string, password: string, name: string, surname: string) => {
    const { data } = await $host.post("api/users/registration", { login, password, name, surname })
    localStorage.setItem("token", data.token)
    return data
}

export const check = async () => {
    const { data } = await $authHost.get("api/users/auth")
    if (data && data.id) {
        localStorage.setItem("userID", String(data.id))
    }
    return data as userModel
}

export const fetchCurrentUser = async (id: number) => {
    const { data } = await $authHost.get(`api/users/${id}`)
    return data
}

export const updateUser = async (id: number, password: string, name: string, surname: string) => {
    const { data } = await $authHost.put("api/users", { id, password, name, surname })
    return data
}

export const updateUserImg = async (idAndImg: FormData) => {
    const { data } = await $authHost.patch("api/users", idAndImg)
    return data
}

export const deleteUser = async (id: number) => {
    const { data } = await $authHost.delete(`api/users/${id}`)
    return data
}

export const getUsers = async () => {
    const { data } = await $authHost.get("api/users")
    return data
}

export const fetchUsers = async () => {
    const { data } = await $authHost.get("api/users")
    return data
}

export const fetchSession = async () => {
    const { data } = await $authHost.get("api/sessions")
    return data
}

export const fetchPC = async () => {
    const { data } = await $authHost.get("api/pcs")
    return data
}

export const setSessionOnline = async (online: boolean, userId: number, pcId: number | null) => {
    const { data } = await $authHost.post("api/sessions", { online, userId, pcId })
    return data
}

export const createPC = async (ip: string, pc_name: string, cabinet: string) => {
    const { data } = await $authHost.post("api/pcs", { ip, pc_name, cabinet })
    return data
}

export const updatePC = async (id: number, ip: string, pc_name: string, cabinet: string) => {
    const { data } = await $authHost.put(`api/pcs/${id}`, { ip, pc_name, cabinet })
    return data
}

export const deletePC = async (id: number) => {
    const { data } = await $authHost.delete(`api/pcs/${id}`)
    return data
}
================================================================================
FILE: QMS-Client-main/src/api/warehouseApi.ts
================================================================================

import { $authHost } from "./index";
import {
  SupplyModel,
  InventoryBoxModel,
  WarehouseMovement,
  WarehouseDocument,
  StockBalanceItem
} from "src/types/WarehouseModels";

export type { WarehouseMovement };
export type WarehouseBox = InventoryBoxModel;

export interface SupplyCreateDto {
  supplier?: string;
  docNumber?: string;
  expectedDate?: string;
  comment?: string;
}

export interface BoxCreateDto {
  supplyId: number;
  sectionId: number;
  itemName: string;
  quantity: number;
  unit: string;
  kitNumber?: string;
  comment?: string;
}

export interface CreateBoxesBatchPayload {
  label: string;
  projectName?: string;
  batchName?: string;
  originType?: string;
  originId?: number | null;
  quantity: number;
  itemsPerBox: number;
  unit: string;
  status?: string;
  currentSectionId?: number | null;
  currentTeamId?: number | null;
  notes?: string;
}

export interface FetchBoxesParams {
  page?: number;
  limit?: number;
  search?: string;
  batchName?: string;
  projectName?: string;
  originType?: string;
  status?: string;
  sectionId?: number;
  teamId?: number;
  supplyId?: number;
}

export interface MoveBoxPayload {
  boxId: number;
  toSectionId?: number | null;
  toTeamId?: number | null;
  operation: string;
  statusAfter?: string;
  comment?: string;
  goodQty?: number;
  scrapQty?: number;
  deltaQty?: number;
}

export interface BatchMovePayload {
    movements: Array<{
        boxId: number;
        operation: string;
        toSectionId?: number | null;
        toTeamId?: number | null;
        statusAfter?: string;
        deltaQty?: number;
        goodQty?: number;
        scrapQty?: number;
        comment?: string;
    }>;
    documentData?: {
        createNew: boolean;
        number?: string;
        type?: string;
        comment?: string;
        documentId?: number;
    };
}

export interface FetchDocumentsParams {
  page?: number;
  limit?: number;
  search?: string;
  type?: string;
  boxId?: number;
  dateFrom?: string;
  dateTo?: string;
}

export interface CreateDocumentPayload {
  boxId?: number | null;
  number: string;
  type?: string;
  date?: string;
  fileUrl?: string;
  comment?: string;
}

export interface InventoryLimitModel {
    id: number;
    label: string;
    originType?: string;
    originId?: number;
    minQuantity: number;
}

export interface StockAlertModel {
    id: number;
    label: string;
    min: number;
    current: number;
    deficit: number;
}

export interface RankingResponse {
    users: {
        id: number;
        name: string;
        surname: string;
        teamName: string;
        avatar: string | null;
        output: number;
        defects: number;
        efficiency: number;
        place: number;
    }[];
    teams: {
        id: number;
        title: string;
        section: string;
        teamLead: string;
        totalOutput: number;
        avgEfficiency: number;
        progress: number;
        membersCount: number;
    }[];
}


export const createSupply = async (data: SupplyCreateDto): Promise<SupplyModel> => {
  const { data: response } = await $authHost.post('api/warehouse/supplies', data);
  return response;
};

export const fetchSupplies = async (): Promise<SupplyModel[]> => {
  const { data } = await $authHost.get('api/warehouse/supplies');
  return data;
};

export const createBox = async (data: BoxCreateDto): Promise<InventoryBoxModel> => {
  const { data: response } = await $authHost.post('api/warehouse/boxes/single', data);
  return response;
};

export const createBoxesBatch = async (payload: CreateBoxesBatchPayload) => {
  const { data } = await $authHost.post("api/warehouse/boxes/batch", payload);
  return data as { boxes: InventoryBoxModel[] };
};

export const updateBoxesBatch = async (ids: number[], updates: Partial<InventoryBoxModel>) => {
    const { data } = await $authHost.put("api/warehouse/boxes/batch", { ids, updates });
    return data;
};

export const fetchBoxes = async (params: FetchBoxesParams): Promise<any> => {
  const { data } = await $authHost.get("api/warehouse/boxes", { params });
  if (Array.isArray(data)) return data;
  return data as { rows: InventoryBoxModel[]; count: number; page: number; limit: number };
};

export const fetchBoxById = async (id: number) => {
  const { data } = await $authHost.get(`api/warehouse/boxes/${id}`);
  return data as {
    box: InventoryBoxModel;
    movements: WarehouseMovement[];
    documents: WarehouseDocument[];
  };
};

export const fetchBoxByQr = async (qrCode: string) => {
  const encoded = encodeURIComponent(qrCode);
  const { data } = await $authHost.get(`api/warehouse/boxes/by-qr/${encoded}`);
  return data as {
    box: InventoryBoxModel;
    movements: WarehouseMovement[];
    documents: WarehouseDocument[];
  };
};


export const fetchStockBalance = async () => {
    const { data } = await $authHost.get("api/warehouse/balance");
    return data as StockBalanceItem[];
};


export const fetchDashboardStats = async () => {
    const { data } = await $authHost.get("api/warehouse/analytics/dashboard");
    return data;
};

export const fetchAlerts = async () => {
    const { data } = await $authHost.get("api/warehouse/alerts");
    return data as StockAlertModel[];
};

export const fetchAllLimits = async () => {
    const { data } = await $authHost.get("api/warehouse/limits");
    return data as InventoryLimitModel[];
};

export const saveLimit = async (payload: { label: string, min: number, originType?: string, originId?: number }) => {
    const { data } = await $authHost.post("api/warehouse/limits", payload);
    return data;
};


export const moveBox = async (payload: MoveBoxPayload) => {
  const { data } = await $authHost.post("api/warehouse/movements", payload);
  return data as { box: InventoryBoxModel; movement: WarehouseMovement };
};

export const moveBoxesBatch = async (payload: BatchMovePayload) => {
    const { data } = await $authHost.post("api/warehouse/movements/batch", payload);
    return data;
};


export const downloadBoxesExcel = async (ids: number[]) => {
  const { data } = await $authHost.post(
    "api/warehouse/boxes/export",
    { ids },
    { responseType: 'blob' }
  );
  const url = window.URL.createObjectURL(new Blob([data]));
  const link = document.createElement('a');
  link.href = url;
  const date = new Date().toISOString().split('T')[0];
  link.setAttribute('download', `labels_export_${date}.csv`);
  document.body.appendChild(link); link.click(); link.remove();
};

export const printBoxesPdf = async (ids: number[]) => {
  const { data } = await $authHost.post(
    "api/warehouse/boxes/print-pdf",
    { ids },
    { responseType: 'blob' }
  );
  const url = window.URL.createObjectURL(new Blob([data], { type: 'application/pdf' }));
  const link = document.createElement('a');
  link.href = url;
  const date = new Date().toISOString().split('T')[0];
  link.setAttribute('download', `labels_print_${date}.pdf`);
  document.body.appendChild(link); link.click(); link.remove();
};

export const printSpecialLabel = async (data: any) => {
  const response = await $authHost.post("api/warehouse/boxes/print-special", data, {
    responseType: 'blob'
  });

  const url = window.URL.createObjectURL(new Blob([response.data], { type: 'application/pdf' }));

  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = url;
  document.body.appendChild(iframe);

  iframe.onload = () => {
      iframe.contentWindow?.print();
  };
};


export const fetchPrintHistory = async (params: {
    page?: number;
    limit?: number;
    search?: string;
    template?: string;
    dateFrom?: string;
    dateTo?: string;
}) => {
    const { data } = await $authHost.get("api/warehouse/print-history", { params });
    return data as { rows: any[]; count: number; page: number; limit: number };
};


export const fetchDocuments = async (params: FetchDocumentsParams) => {
  const { data } = await $authHost.get("api/warehouse/documents", { params });
  return data as { rows: WarehouseDocument[]; count: number; page: number; limit: number };
};

export const createDocument = async (payload: CreateDocumentPayload) => {
  const { data } = await $authHost.post("api/warehouse/documents", payload);
  return data as WarehouseDocument;
};

export const exportLabelsCsv = async (supplyId: number): Promise<Blob> => {
  const { data } = await $authHost.get(`api/warehouse/supplies/${supplyId}/export-csv`, {
    responseType: 'blob',
  });
  return data;
};

export const fetchRankings = async (period: 'day' | 'week' | 'month') => {
    const { data } = await $authHost.get("api/warehouse/rankings", {
        params: { period }
    });
    return data as RankingResponse;
};

================================================================================
FILE: QMS-Client-main/src/components/AppRouter.tsx
================================================================================

import { useContext } from "react";
import { Navigate, Route, Routes, useLocation } from "react-router-dom";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import { adminRoutes, authRoutes, publicRoutes } from "src/routes";
import { START_ROUTE } from "src/utils/consts";

export const AppRouter: React.FC = observer(() => {
  const context = useContext(Context);
  const location = useLocation();

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { user } = context;

  return (


    <div key={location.pathname} className="animate-slide-in-up w-full h-full">
      <Routes>


        {user.isAuth && user.can('admin.access') &&
          adminRoutes.map(({ path, Component }) => {


              if (path.includes('/users') && !user.can('users.manage')) return null;


              if (path.includes('/warehouse') && !user.can('warehouse.manage')) return null;

              return <Route key={path} path={path} element={<Component />} />;
          })
        }


        {user.isAuth &&
          authRoutes.map(({ path, Component }) => {


              if (path.includes('/warehouse') && !user.can('warehouse.view')) return null;

              return <Route key={path} path={path} element={<Component />} />;
          })
        }


        {publicRoutes.map(({ path, Component }) => (
          <Route key={path} path={path} element={<Component />} />
        ))}


        <Route path="*" element={<Navigate to={START_ROUTE} />} />
      </Routes>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/components/Footer/Footer.tsx
================================================================================

import Logo from "assets/images/logo.svg";
import PhoneIcon from "assets/icons/Phone.svg";
import MailIcon from "assets/icons/mail.svg";
import LogoVK from "assets/icons/logoVK.svg";
import LogoYT from "assets/icons/logoYOUT.svg";

export const Footer: React.FC = () => {
  return (
    <div className="flex justify-between items-center px-8 py-4 bg-white text-gray-800">
      <div className="flex items-center">
        <img src={Logo} alt="Logo" className="h-6 mr-2" />
        <div>
          <div>¬© 2018-2025 –ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç</div>
        </div>
      </div>

      <div className="flex flex-col items-center">
        <div className="flex items-center mb-1">
          <img src={PhoneIcon} alt="Phone" className="h-4 mr-2" />
          <div>+7 (499) 455 04 13</div>
        </div>
        <div className="flex items-center">
          <img src={MailIcon} alt="Mail" className="h-4 mr-2" />
          <div>office.npk@kryptonite.ru</div>
        </div>
      </div>

      <div className="flex items-center">
        <img src={LogoVK} alt="VK" className="h-8 mr-4" />
        <img src={LogoYT} alt="YouTube" className="h-8" />
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/Header/DateTimeDisplay.tsx
================================================================================

import { useState, useEffect } from 'react';

export const DateTimeDisplay = () => {
  const [currentTime, setCurrentTime] = useState(new Date());

  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);

    return () => clearInterval(timer);
  }, []);


  const formatDate = (date: Date) => {
    return date.toLocaleDateString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  };

  const formatTime = (date: Date) => {
    return date.toLocaleTimeString('ru-RU', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
  };

  return (
    <div className="flex flex-col items-end justify-center">
      <div className="text-xl font-semibold text-emerald-700 tracking-wide">
        {formatDate(currentTime)}
      </div>
      <div className="text-sm text-gray-600 font-medium bg-emerald-50 px-2 py-1 rounded-md">
        {formatTime(currentTime)}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/Header/Header.tsx
================================================================================


import React, { useContext, Fragment, useState, useEffect, useRef } from "react";
import Logo from "assets/images/logo.svg";
import { NavLink, useLocation } from "react-router-dom";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import { useAuth } from "react-oidc-context";
import { Menu, Transition } from "@headlessui/react";
import { setSessionOnline } from "src/api/userApi";
import { DateTimeDisplay } from "./DateTimeDisplay";
import clsx from "clsx";


import {
  Shield, Archive,
  ClipboardList, User, LogOut,
  ChevronDown,
} from "lucide-react";


import {
  ADMIN_ROUTE,
  WAREHOUSE_ROUTE, TASKS_ROUTE,
  PROFILE_ROUTE,
} from "src/utils/consts";

type NavItem = {
  label: string;
  icon: React.ElementType;
  to?: string;
  permissions?: string[];
  children?: { label: string; to: string; icon?: React.ElementType }[];
};


export const HEADER_HEIGHT = 56;

export const Header: React.FC = observer(() => {
  const auth = useAuth();
  const context = useContext(Context);
  const _location = useLocation();

  if (!context) throw new Error("Context required");
  const { user } = context;


  const [isVisible, setIsVisible] = useState(true);
  const [isAtTop, setIsAtTop] = useState(true);
  const lastScrollY = useRef(0);
  const scrollThreshold = 10;

  useEffect(() => {
    const handleScroll = () => {
      const currentScrollY = window.scrollY;


      setIsAtTop(currentScrollY < 5);


      const scrollDiff = currentScrollY - lastScrollY.current;

      if (Math.abs(scrollDiff) < scrollThreshold) {
        return;
      }

      if (scrollDiff > 0 && currentScrollY > HEADER_HEIGHT) {

        setIsVisible(false);
      } else {

        setIsVisible(true);
      }

      lastScrollY.current = currentScrollY;
    };

    window.addEventListener("scroll", handleScroll, { passive: true });
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);


  const logOut = async () => {
    try {
      const userId = Number(localStorage.getItem("userID"));
      const pcId = localStorage.getItem("pcID");
      const pcIdNum = pcId === "PERSONAL" ? null : Number(pcId);
      if (userId) await setSessionOnline(false, userId, pcIdNum);
    } catch (error) { console.error(error); }

    user.resetUser();
    localStorage.clear();
    sessionStorage.clear();
    await auth.signoutRedirect({ post_logout_redirect_uri: window.location.origin });
  };


  const navigation: NavItem[] = [
    {
      label: "–ó–∞–¥–∞—á–∏",
      icon: ClipboardList,
      to: TASKS_ROUTE,
    },
    {
      label: "–°–∫–ª–∞–¥",
      icon: Archive,
      to: WAREHOUSE_ROUTE,
      permissions: ["warehouse.view"]
    },
    {
      label: "–ê–¥–º–∏–Ω",
      icon: Shield,
      to: ADMIN_ROUTE,
      permissions: ["admin.access"]
    },
  ];


  const visibleNav = navigation.filter(item => {
      if (!item.permissions) return true;
      return item.permissions.some(p => user.can(p));
  });

  return (
    <div
      className={clsx(
        "fixed top-0 left-0 right-0 z-50 h-14",
        "bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm",
        "transition-transform duration-300 ease-in-out",
        !isVisible && "-translate-y-full",
        isAtTop && "shadow-none"
      )}
    >
      <div className="max-w-[1920px] mx-auto px-4 h-full flex justify-between items-center">

        <div className="flex items-center gap-6 min-w-max">
          <NavLink to="/" className="flex items-center gap-2 group">
            <img src={Logo} alt="Logo" className="h-7 w-auto group-hover:opacity-80 transition-opacity" />
            <span className="text-lg font-bold text-slate-800 tracking-tight leading-none">
              QMS
            </span>
          </NavLink>
          <div className="h-6 w-px bg-gray-200 hidden lg:block"></div>
        </div>

        {auth.isAuthenticated && (
          <nav className="hidden lg:flex items-center gap-1">
            {visibleNav.map((item, idx) => (
              <Fragment key={idx}>
                {item.children ? (
                  <Menu as="div" className="relative">
                    <Menu.Button className={({ open }) => clsx(
                        "flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all outline-none",
                        open ? "bg-slate-100 text-slate-900" : "text-slate-600 hover:bg-slate-50 hover:text-slate-900"
                    )}>
                      <item.icon size={16} />
                      <span>{item.label}</span>
                      <ChevronDown size={12} className="opacity-50" />
                    </Menu.Button>
                    <Transition
                      as={Fragment}
                      enter="transition ease-[cubic-bezier(0.16,1,0.3,1)] duration-200"
                      enterFrom="transform opacity-0 scale-95 -translate-y-2"
                      enterTo="transform opacity-100 scale-100 translate-y-0"
                      leave="transition ease-in duration-150"
                      leaveFrom="transform opacity-100 scale-100 translate-y-0"
                      leaveTo="transform opacity-0 scale-95 -translate-y-2"
                    >
                      <Menu.Items className="absolute left-0 mt-2 w-56 origin-top-left divide-y divide-gray-100 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                        <div className="p-1">
                          {item.children.map((sub, sIdx) => (
                            <Menu.Item key={sIdx}>
                              {({ active }) => (
                                <NavLink
                                  to={sub.to}
                                  className={clsx(
                                    "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm",
                                    active ? "bg-slate-100 text-indigo-700 font-medium" : "text-slate-700 hover:bg-slate-50"
                                  )}
                                >
                                  {sub.icon && <sub.icon size={14} className={active ? "text-indigo-600" : "text-slate-400"} />}
                                  {sub.label}
                                </NavLink>
                              )}
                            </Menu.Item>
                          ))}
                        </div>
                      </Menu.Items>
                    </Transition>
                  </Menu>
                ) : (
                  <NavLink
                    to={item.to!}
                    className={({ isActive }) => clsx(
                        "flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all",
                        isActive
                          ? "bg-slate-100 text-indigo-700 font-bold"
                          : "text-slate-600 hover:bg-slate-50 hover:text-slate-900"
                    )}
                  >
                    <item.icon size={16} />
                    <span>{item.label}</span>
                  </NavLink>
                )}
              </Fragment>
            ))}
          </nav>
        )}

        <div className="flex items-center gap-4 min-w-max">
          <div className="hidden xl:block text-right">
             <DateTimeDisplay />
          </div>

          {auth.isAuthenticated ? (
            <Menu as="div" className="relative ml-2">
                <Menu.Button className="flex items-center gap-2 pl-2 pr-1 py-1 rounded-full hover:bg-slate-100 transition border border-transparent hover:border-slate-200 group outline-none">
                    <div className="flex flex-col items-end leading-none mr-1">
                        <span className="text-xs font-bold text-slate-700">{user.user?.surname} {user.user?.name?.[0]}.</span>
                        <span className="text-[10px] text-slate-400">{user.user?.role}</span>
                    </div>
                    <div className="h-8 w-8 rounded-full bg-slate-200 overflow-hidden ring-2 ring-white shadow-sm">
                         {user.user?.img
                            ? <img src={`${import.meta.env.VITE_API_URL}/${user.user.img}`} alt="" className="h-full w-full object-cover"/>
                            : <div className="h-full w-full flex items-center justify-center text-slate-500 font-bold text-xs">{user.user?.name?.[0]}</div>
                         }
                    </div>
                </Menu.Button>

                <Transition
                  as={Fragment}
                  enter="transition ease-out duration-100"
                  enterFrom="transform opacity-0 scale-95"
                  enterTo="transform opacity-100 scale-100"
                  leave="transition ease-in duration-75"
                  leaveFrom="transform opacity-100 scale-100"
                  leaveTo="transform opacity-0 scale-95"
                >
                  <Menu.Items className="absolute right-0 mt-2 w-48 origin-top-right divide-y divide-gray-100 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                    <div className="p-1">
                      <Menu.Item>
                        {({ active }) => (
                          <NavLink
                            to={PROFILE_ROUTE}
                            className={clsx(
                              "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm",
                              active ? "bg-slate-100 text-indigo-700" : "text-slate-700"
                            )}
                          >
                            <User size={14} />
                            –ü—Ä–æ—Ñ–∏–ª—å
                          </NavLink>
                        )}
                      </Menu.Item>
                    </div>
                    <div className="p-1">
                      <Menu.Item>
                        {({ active }) => (
                          <button
                            onClick={logOut}
                            className={clsx(
                              "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm",
                              active ? "bg-red-50 text-red-700" : "text-slate-700"
                            )}
                          >
                            <LogOut size={14} />
                            –í—ã–π—Ç–∏
                          </button>
                        )}
                      </Menu.Item>
                    </div>
                  </Menu.Items>
                </Transition>
            </Menu>
          ) : null}
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/components/Modal/ConfirmModal.tsx
================================================================================

import React from "react";

export interface ConfirmModalProps {
  isOpen?: boolean;
  title?: string;
  title1?: string;
  message?: string;
  onConfirm?: () => void;
  onCancel?: () => void;
  actionConfirm?: () => void;
  onClose?: () => void;
  confirmText?: string;
  cancelText?: string;
  confirmColor?: "red" | "green" | "blue";
}

export const ConfirmModal: React.FC<ConfirmModalProps> = ({
  isOpen,
  title = "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
  title1,
  message = "–í—ã —É–≤–µ—Ä–µ–Ω—ã?",
  onConfirm,
  onCancel,
  actionConfirm,
  onClose,
  confirmText = "‚úÖ –î–ê",
  cancelText = "‚ùå –û—Ç–º–µ–Ω–∞",
  confirmColor = "green"
}) => {
  const handleConfirm = actionConfirm || onConfirm || (() => {});
  const handleCancel = onClose || onCancel || (() => {});

  if (!isOpen) return null;

  const confirmColorClasses = {
    red: "bg-red-600 hover:bg-red-700",
    green: "bg-emerald-600 hover:bg-emerald-700",
    blue: "bg-blue-600 hover:bg-blue-700"
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">

      <div
        className="absolute inset-0 bg-black/50"
        onClick={handleCancel}
      />


      <div className="relative bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
        <div className="flex flex-col items-center justify-center text-center">
          {(title1 || title) && (
            <h2 className="text-xl font-bold text-gray-800">{title1 || title}</h2>
          )}
          {message && (
            <p className="text-gray-600 mt-2">{message}</p>
          )}
          <div className="flex justify-center gap-4 mt-6 w-full">
            <button
              type="button"
              className={`flex-1 ${confirmColorClasses[confirmColor]} text-white py-3 rounded-lg transition font-semibold shadow-lg`}
              onClick={handleConfirm}
            >
              {confirmText}
            </button>
            <button
              type="button"
              className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg"
              onClick={handleCancel}
            >
              {cancelText}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ConfirmModal;

================================================================================
FILE: QMS-Client-main/src/components/Modal/Modal.tsx
================================================================================


import React, { useEffect } from "react";

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
  title?: string;
  size?: string;
}

const SIZE_CLASSES: Record<string, string> = {
  sm: "max-w-sm",
  md: "max-w-md",
  lg: "max-w-lg",
  xl: "max-w-xl",
  "2xl": "max-w-2xl",
  "3xl": "max-w-3xl",
  "4xl": "max-w-4xl",
  "5xl": "max-w-5xl",
};

export const Modal: React.FC<ModalProps> = ({ isOpen, onClose, children, title, size }) => {

  useEffect(() => {
    if (!isOpen) return;

    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === "Escape") {
        onClose();
      }
    };

    document.addEventListener("keydown", handleKeyDown);


    document.body.style.overflow = "hidden";

    return () => {
      document.removeEventListener("keydown", handleKeyDown);
      document.body.style.overflow = "";
    };
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      onClick={onClose}
    >
      <div
        className={`bg-white rounded-lg p-6 w-full ${size ? SIZE_CLASSES[size] || "max-w-lg" : "max-w-lg"} relative max-h-[90vh] overflow-y-auto`}
        onClick={(e) => e.stopPropagation()}
      >
        <button
          className="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl"
          onClick={onClose}
        >
          &times;
        </button>

        {title && (
          <h2 className="text-xl font-semibold mb-4 pr-8">{title}</h2>
        )}

        {children}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/common/Preloader.tsx
================================================================================

export const Preloader: React.FC = () => {
  return (
    <div className="flex justify-center items-center h-64">
      <div className="w-8 h-8 border-4 border-t-4 border-red-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/common/PreloaderMini.tsx
================================================================================

export const PreloaderMini: React.FC = () => {
  return (
    <div className="w-full h-full">
      <div className="w-8 h-8 border-4 border-t-4 border-red-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/hooks/useBetaflyData.ts
================================================================================

import { useEffect, useRef, useState } from "react";

export interface BetaflyDevice {
  port: string;
  attitude?: { roll: number; pitch: number; yaw: number };
  altitude?: { estAlt: number; vario: number };
  analog?: { amperage: number; vbat?: number; rssi?: number };
  timestamp?: number;
}

export function useBetaflyData(socketKey: number) {
  const [devices, setDevices] = useState<BetaflyDevice[]>([]);
  const [deviceHighlight, setDeviceHighlight] = useState<{ [key: string]: "green" | "red" }>({});
  const [checking, setChecking] = useState(false);

  const devicesRef = useRef<BetaflyDevice[]>([]);
  const timeouts = useRef<Record<string, NodeJS.Timeout>>({});
  const checkTimer = useRef<NodeJS.Timeout | null>(null);


  useEffect(() => {
    const ws = new WebSocket("ws://localhost:8090");


    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

     const incomingDevices: BetaflyDevice[] = Array.isArray(data.devices)
          ? data.devices
          : data.port
          ? [data]
          : [];

        if (incomingDevices.length > 0) {
          setDevices((prev) => {
            const updated = [...prev];

            incomingDevices.forEach((incoming) => {
              const idx = updated.findIndex((d) => d.port === incoming.port);
              if (idx >= 0) {
                updated[idx] = incoming;
              } else {
                updated.push(incoming);
              }


              if (timeouts.current[incoming.port]) {
                clearTimeout(timeouts.current[incoming.port]);
              }


              timeouts.current[incoming.port] = setTimeout(() => {
                setDevices((current) =>
                  current.filter((d) => d.port !== incoming.port)
                );
              }, 2000);
            });

            devicesRef.current = updated;
            return updated;
          });
        }

      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WS:", err);
      }
    };

    ws.onerror = (err) => {
      console.error("–û—à–∏–±–∫–∞ WebSocket:", err);
    };

    return () => {
      ws.close();
      Object.values(timeouts.current).forEach(clearTimeout);

    };
  }, [socketKey]);


  const startChecking = () => {
    if (checking === true) return;

    setChecking(true);
    setDeviceHighlight({});
    if (checkTimer.current) clearTimeout(checkTimer.current);


    checkTimer.current = setTimeout(() => {
            const latestDevices = devicesRef.current;

      setDeviceHighlight(() => {
        const result: { [key: string]: "green" | "red" } = {};
        latestDevices.forEach((d) => {
          const hasDataAttitude =
            (d.attitude?.roll ?? 0) !== 0 ||
            (d.attitude?.pitch ?? 0) !== 0 ||
            (d.attitude?.yaw ?? 0) !== 0;

          const hasDataAnalog = (d.analog?.amperage ?? 0) !== 0;
          const hasDataAltitude = (d.altitude?.estAlt ?? 0) !== 0;

          const hasData = hasDataAttitude && hasDataAnalog && hasDataAltitude;
          result[d.port] = hasData ? "green" : "red";

          console.log(`Port ${d.port} ‚Üí hasData=${hasData}`);
        });
        return result;
      });
      setChecking(false);
    }, 5000);
  };


  const resetDeviceHiglicht = () => setDeviceHighlight({})


  return { devices, deviceHighlight, startChecking, resetDeviceHiglicht };
}

================================================================================
FILE: QMS-Client-main/src/index.css
================================================================================


@font-face {
  font-family: 'GOST type A';
  src: url('/fonts/GOST-type-A.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: 'GOST type B';
  src: url('/fonts/GOST-type-B.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}


@tailwind base;
@tailwind components;
@tailwind utilities;


@media print {
  .print-area {
    page-break-inside: avoid;
  }

  
  .no-print {
    display: none !important;
  }
}
================================================================================
FILE: QMS-Client-main/src/main.tsx
================================================================================

import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App.tsx";
import "./index.css";
import { BrowserRouter } from "react-router-dom";
import { AuthProvider } from "react-oidc-context";
import UserStore from "./store/UserStore.ts";
import StructureStore from "./store/StructureStore.ts";


interface IContext {
  user: UserStore;
  structureStore: StructureStore;
}

export const Context = React.createContext<IContext | null>(null);


const REDIRECT_PATH_KEY = "qms_redirect_path";


const saveCurrentPath = () => {
  const currentPath = window.location.pathname + window.location.search;


  const hasOidcParams = window.location.search.includes('code=') ||
                        window.location.search.includes('state=');

  if (currentPath !== "/" &&
      !currentPath.includes("/login") &&
      !hasOidcParams) {
    sessionStorage.setItem(REDIRECT_PATH_KEY, currentPath);
  }
};


export const getSavedPath = (): string | null => {
  return sessionStorage.getItem(REDIRECT_PATH_KEY);
};


export const clearSavedPath = () => {
  sessionStorage.removeItem(REDIRECT_PATH_KEY);
};


saveCurrentPath();


const oidcConfig = {
  authority: "http://keycloak.local/realms/MES-Realm",
  client_id: "mes-client",
  redirect_uri: window.location.origin + "/",
  post_logout_redirect_uri: window.location.origin + "/",
  response_type: "code",


  onSigninCallback: () => {

    const savedPath = getSavedPath();


    const cleanUrl = savedPath || "/";

    window.history.replaceState({}, document.title, cleanUrl);


  }
};


ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <AuthProvider {...oidcConfig}>
      <BrowserRouter>
        <Context.Provider
          value={{
            user: new UserStore(),
            structureStore: new StructureStore(),
          }}
        >
          <App />
        </Context.Provider>
      </BrowserRouter>
    </AuthProvider>
  </React.StrictMode>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPCs/AdminEditPC.tsx
================================================================================

import { useState } from "react";
import { updatePC } from "src/api/userApi";

interface AdminEditPCProps {
  updatePCList: () => void;
  PCname: string;
  IP: string;
  Cabinet: string;
  ID: number;
}

export const AdminEditPC: React.FC<AdminEditPCProps> = ({
  updatePCList,

  IP,
  PCname,
  Cabinet,
  ID,
}) => {
  const [ip, SetIp] = useState(IP);
  const [pc_name, SetPc_name] = useState(PCname);
  const [cabinet, SetCabinet] = useState(Cabinet);

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const editPC = async () => {
    try {
      await updatePC(ID, ip, pc_name, cabinet);

      SetIp("");
      SetPc_name("");
      SetCabinet("");
      setSuccessMessage("–ö–æ–º–ø—å—é—Ç–µ—Ä —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω");
      setErrorMessage("");
      updatePCList();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä</h2>
      <form>
        <input
          type="text"
          placeholder="–ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞"
          className="w-full p-2 border rounded-lg mb-2"
          value={pc_name}
          onChange={(e) => SetPc_name(e.target.value)}
        />
        <input
          type="text"
          placeholder="IP-–∞–¥—Ä–µ—Å"
          className="w-full p-2 border rounded-lg mb-2"
          value={ip}
          onChange={(e) => SetIp(e.target.value)}
        />
        <input
          type="text"
          placeholder="–ö–∞–±–∏–Ω–µ—Ç"
          className="w-full p-2 border rounded-lg mb-2"
          value={cabinet}
          onChange={(e) => SetCabinet(e.target.value)}
        />
        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          –ò–∑–º–µ–Ω–∏—Ç—å
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">–ò–∑–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä?</p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  editPC();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –∏–∑–º–µ–Ω–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPCs/AdminOnePC.tsx
================================================================================

import { Pencil, Trash2 } from "lucide-react";
import { useState } from "react";
import { Modal } from "src/components/Modal/Modal";
import { AdminEditPC } from "./AdminEditPC";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";

interface OnePCProps {
  deleteComputer: () => void;
  updatePCList: () => void;
  PCname: string;
  IP: string;
  cabinet: string;
  ID: number;
}

export const AdminOnePC: React.FC<OnePCProps> = ({
  deleteComputer,
  updatePCList,
  PCname,
  IP,
  cabinet,
  ID,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  return (
    <div className="bg-white p-4 rounded-lg shadow-lg border-l-4 border-blue-500 transition duration-300 hover:shadow-xl relative">
      <h3 className="text-xl font-bold text-gray-800 mb-2">–ò–º—è –ø–∫: {PCname}</h3>
      <p className="text-gray-600">
        <span className="font-semibold">IP:</span> {IP}
      </p>
      <p className="text-gray-600">
        <span className="font-semibold">–ö–∞–±–∏–Ω–µ—Ç:</span> {cabinet}
      </p>


      <div className="absolute top-4 right-4 flex space-x-2">
        <button
          onClick={() => openModal("computerEdit")}
          className="p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition"
        >
          <Pencil size={18} />
        </button>
        <button
          className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition"
          onClick={() => openModal("computerDelete")}
        >
          <Trash2 size={18} />
        </button>
      </div>

      <Modal isOpen={modalType === "computerDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä ${PCname} ?`}
          actionConfirm={deleteComputer}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "computerEdit"} onClose={closeModal}>
        <AdminEditPC
          ID={ID}
          PCname={PCname}
          IP={IP}
          Cabinet={cabinet}
          updatePCList={updatePCList}
        />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPCs/AdminPCs.tsx
================================================================================

import { useEffect, useState } from "react";
import { deletePC, fetchPC } from "src/api/userApi";
import { AdminOnePC } from "./AdminOnePC";
import { pcModelFull } from "src/types/PCModel";

export const AdminPCs: React.FC = () => {
  const [pcs, setPcs] = useState<pcModelFull[]>([]);

  const updatePCList = async () => {
    fetchPC().then((data) => setPcs(data));
  };

  useEffect(() => {
    updatePCList();
  }, []);

  const deleteComputer = async (id: number) => {
    try {
      await deletePC(id);
      updatePCList()
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–ø–∞:", error);
    }
  };

  let PCs = pcs.map((el: pcModelFull) => (
    <AdminOnePC
      deleteComputer={() => deleteComputer(el.id)}
      updatePCList = {()=> updatePCList()}
      key={el.id}
      ID={el.id}
      PCname={el.pc_name}
      IP={el.ip}
      cabinet={el.cabinet}
    />
  ));

  return (
    <div className="p-4  bg-gray-100/80 shadow-lg rounded-lg h-screen overflow-y-auto">
      <h2 className="text-xl font-bold text-gray-900 mb-4 border-b-2 pb-2">
        –°–ø–∏—Å–æ–∫ –ü–ö
      </h2>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
        {PCs}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPanel.tsx
================================================================================

import React, { useState, useContext } from "react";
import { observer } from "mobx-react-lite";
import { useNavigate } from "react-router-dom";
import clsx from "clsx";

import { Context } from "src/main";

import {
  Shield,
  Users,
  Network,
  Package,
  History,
  Plus,
  ArrowUpRight,
  Settings,
} from "lucide-react";

import { CreatePC } from "./CreateModals/CreatePC";
import { Modal } from "src/components/Modal/Modal";

import {
  ADMIN_RBAC_ROUTE,
  ADMIN_USERS_ROUTE,
  STRUCTURE_ROUTE,
  AUDIT_LOG_ROUTE,
  ADMIN_WAREHOUSE_ROUTE,
} from "src/utils/consts";

import {
  CREATE_COMPUTER,
} from "src/utils/constsModalType";


interface BentoItemProps {
  title: string;
  subtitle?: string;
  icon: React.ElementType;
  link: string;
  className?: string;
  colorClass?: string;
  iconColorClass?: string;
  onAdd?: () => void;
}

const BentoItem: React.FC<BentoItemProps> = ({
  title,
  subtitle,
  icon: Icon,
  link,
  className,
  colorClass = "bg-white hover:border-indigo-300",
  iconColorClass = "text-indigo-600 bg-indigo-50",
  onAdd,
}) => {
  const navigate = useNavigate();

  return (
    <div
      onClick={() => navigate(link)}
      className={clsx(
        "relative p-6 rounded-3xl border border-transparent shadow-sm transition-all duration-300 cursor-pointer group overflow-hidden flex flex-col justify-between hover:shadow-xl hover:-translate-y-1",
        colorClass,
        className
      )}
    >
      <div className="absolute -right-6 -top-6 w-24 h-24 bg-current opacity-5 rounded-full pointer-events-none group-hover:scale-150 transition-transform duration-500" />

      <div className="flex justify-between items-start z-10">
        <div className={clsx("p-3 rounded-2xl", iconColorClass)}>
          <Icon size={28} strokeWidth={1.5} />
        </div>
        <div className="p-2 rounded-full text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity">
          <ArrowUpRight size={20} />
        </div>
      </div>

      <div className="mt-4 z-10">
        <h3 className="text-xl font-bold tracking-tight mb-1">{title}</h3>
        {subtitle && (
          <p className="text-sm opacity-70 font-medium leading-tight">
            {subtitle}
          </p>
        )}
      </div>

      {onAdd && (
        <button
          onClick={(e) => {
            e.stopPropagation();
            onAdd();
          }}
          className="absolute bottom-4 right-4 p-2 bg-white/90 backdrop-blur-sm border border-slate-200 rounded-xl text-slate-600 shadow-sm hover:bg-indigo-600 hover:text-white hover:border-indigo-600 transition-all z-20"
          title="–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ"
        >
          <Plus size={20} />
        </button>
      )}
    </div>
  );
};


export const AdminPanel: React.FC = observer(() => {
  const { user } = useContext(Context)!;
  const navigate = useNavigate();
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  const canManageUsers =
    user.can("users.manage") || user.can("admin.users_manage");

  return (
    <div className="p-6 max-w-[1600px] mx-auto min-h-screen">
      <div className="mb-8">
        <h1 className="text-4xl font-extrabold text-slate-900 tracking-tight">
          –¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        </h1>
        <p className="text-slate-500 mt-2 text-lg">
          –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ –∫–∞—á–µ—Å—Ç–≤–∞
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 auto-rows-[180px]">
        {(canManageUsers || user.can("rbac.manage")) && (
          <div className="md:col-span-2 row-span-2 bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden group shadow-2xl">
            <div className="absolute top-0 right-0 w-96 h-96 bg-indigo-500 rounded-full blur-[100px] opacity-20 -mr-20 -mt-20 pointer-events-none" />

            <div className="relative z-10 flex flex-col h-full justify-between">
              <div className="flex justify-between items-start">
                <div className="p-4 bg-white/10 backdrop-blur-md rounded-2xl border border-white/10">
                  <Shield size={40} className="text-emerald-400" />
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => openModal(CREATE_COMPUTER)}
                    className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-xl text-sm font-bold transition backdrop-blur-sm border border-white/5"
                  >
                    + –ü–ö
                  </button>
                </div>
              </div>

              <div>
                <h2 className="text-3xl font-bold mb-2">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
                <p className="text-slate-400 mb-6 max-w-md">
                  –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–≤–æ–π –º–æ–¥–µ–ª—å—é (RBAC), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–∞–±–æ—á–∏–º–∏ —Å—Ç–∞–Ω—Ü–∏—è–º–∏.
                </p>

                <div className="flex gap-3 flex-wrap">
                  <button
                    onClick={() => navigate(ADMIN_RBAC_ROUTE)}
                    className="flex items-center gap-2 px-5 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold transition shadow-lg shadow-indigo-900/50"
                  >
                    <Settings size={18} /> –î–æ—Å—Ç—É–ø (RBAC)
                  </button>
                  <button
                    onClick={() => navigate(ADMIN_USERS_ROUTE)}
                    className="flex items-center gap-2 px-5 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold transition"
                  >
                    <Users size={18} /> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                  </button>
                  <button
                    onClick={() => navigate(AUDIT_LOG_ROUTE)}
                    className="flex items-center gap-2 px-5 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl font-bold transition"
                  >
                    <History size={18} /> –ê—É–¥–∏—Ç
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {user.can("admin.structure_manage") && (
          <BentoItem
            title="–°—Ç—Ä—É–∫—Ç—É—Ä–∞"
            subtitle="–¶–µ—Ö–∞, —É—á–∞—Å—Ç–∫–∏ –∏ –±—Ä–∏–≥–∞–¥—ã"
            icon={Network}
            link={STRUCTURE_ROUTE}
            className="md:col-span-2"
            colorClass="bg-gradient-to-br from-indigo-50 to-blue-50 border border-blue-100 hover:shadow-lg"
            iconColorClass="bg-blue-100 text-blue-600"
          />
        )}

        {user.can("warehouse.manage") && (
          <BentoItem
            title="WMS –°–∫–ª–∞–¥"
            subtitle="–ü–æ—Å—Ç–∞–≤–∫–∏ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ"
            icon={Package}
            link={ADMIN_WAREHOUSE_ROUTE}
            colorClass="bg-white border-slate-200 hover:border-emerald-400"
            iconColorClass="bg-emerald-50 text-emerald-600"
          />
        )}
      </div>

      <Modal isOpen={modalType === CREATE_COMPUTER} onClose={closeModal}>
        <CreatePC />
      </Modal>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminUsers/AdminEditUser.tsx
================================================================================

import { UserIcon } from "lucide-react";
import { ChangeEvent, useEffect, useState } from "react";
import { fetchCurrentUser, updateUser, updateUserImg } from "src/api/userApi";

interface AdminEditUserModel {
  updateUsersList: () => void;
  ID: number;
}

export const AdminEditUser: React.FC<AdminEditUserModel> = ({
  updateUsersList,
  ID,
}) => {
  const [currentUser, setCurrentUser] = useState({
    id: 0,
    login: "",
    password: "",
    role: "",
    name: "",
    surname: "",
    createdAt: "",
    updatedAt: "",
    img: "",
  });

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [isAvatarEditVisible, setAvatarEditVisible] = useState(false);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleAvatarUpload = async () => {
    if (!selectedFile) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏");
      return;
    }

    const formData = new FormData();
    formData.append("id", String(currentUser.id));
    formData.append("img", selectedFile);

    try {
      await updateUserImg(formData);
      setAvatarEditVisible(false);
      setSuccessMessage("—É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      refetchUser();
      updateUsersList()
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }
  };

  const refetchUser = () => {
    fetchCurrentUser(ID).then((data) => setCurrentUser(data));
  };

  useEffect(() => {
    fetchCurrentUser(ID).then((data) => setCurrentUser(data));
  }, []);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setCurrentUser((prevUser) => ({
      ...prevUser,
      [name]: value,
    }));
  };

  const handleSave = async () => {
    try {
      await updateUser(
        currentUser.id,
        currentUser.password,
        currentUser.name,
        currentUser.surname
      );
      setSuccessMessage("—É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      refetchUser();
      updateUsersList();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }
  };

  return (
    <div className="p-8 max-w-2xl mx-auto bg-gradient-to-br from-blue-50 to-purple-50 shadow-2xl rounded-3xl transform transition-all">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 text-center">
        –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      </h1>


      <div className="flex flex-col items-center mb-8">
        <div className="relative w-32 h-32 rounded-full overflow-hidden shadow-lg border-4 border-white hover:border-purple-500 transition-all duration-300">
          {currentUser.img ? (
            <img
              src={import.meta.env.VITE_API_URL + "/" + currentUser.img}
              alt=""
              className="w-full h-full object-cover"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center bg-blue-50">
              <UserIcon className="text-blue-600 w-16 h-16" />
            </div>
          )}
        </div>
      </div>


      {isAvatarEditVisible ? (
        <div className="flex flex-col items-center mb-8">
          <input
            type="file"
            onChange={handleFileChange}
            className="mb-4 p-2 bg-white rounded-lg shadow-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={handleAvatarUpload}
          >
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
          </button>
        </div>
      ) : (
        <div className="flex justify-center mb-8">
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={() => setAvatarEditVisible(true)}
          >
            –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
          </button>
        </div>
      )}


      <div className="space-y-6 bg-white p-8 rounded-2xl shadow-xl">

        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–õ–æ–≥–∏–Ω:</span>{" "}
          <span className="text-gray-900">{currentUser.login}</span>
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–ü–∞—Ä–æ–ª—å:</span>{" "}
          <input
            type="password"
            name="password"
            value={currentUser.password}
            onChange={handleInputChange}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–†–æ–ª—å:</span>{" "}
          <span className="text-gray-900">{currentUser.role}</span>
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–ò–º—è:</span>{" "}
          <input
            name="name"
            value={currentUser.name}
            onChange={handleInputChange}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–§–∞–º–∏–ª–∏—è:</span>{" "}
          <input
            name="surname"
            value={currentUser.surname}
            onChange={handleInputChange}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </p>
      </div>


      <div className="mt-8 flex justify-center space-x-4">
        <button
          onClick={handleSave}
          className="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
        >
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button
          onClick={() => {
            refetchUser();
          }}
          className="bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
        >
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminUsers/AdminOneUser.tsx
================================================================================

import {
  UserIcon,
  ShieldCheck,
  MonitorDot,
  User,
  Pencil,
  Trash2,
} from "lucide-react";
import { useState } from "react";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { AdminEditUser } from "./AdminEditUser";

interface AdminOneUserProps {
  updateUsersList: () => void;
  deleteUser: () => void;
  ID: number;
  login: string;
  role: string;
  name: string;
  surName: string;
  img: string | null;
  active: boolean;
  pcName: string | undefined;
  pcIP: string | undefined;
}

export const AdminOneUser: React.FC<AdminOneUserProps> = ({
  updateUsersList,
  deleteUser,
  ID,
  login,
  role,
  name,
  surName,
  img,
  active,
  pcName,
  pcIP,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  return (
    <div className="bg-white shadow-md rounded-xl p-4 flex items-center gap-4 border-l-4 border-blue-500 transition duration-300 hover:shadow-lg overflow-hidden flex-wrap relative">

      {img ? (
        <div className="relative w-24 h-24 rounded-full overflow-hidden shadow-2xl border-4 border-white hover:border-purple-500 transition-all duration-300 transform hover:scale-105 group">
          <img
            src={import.meta.env.VITE_API_URL + "/" + img}
            alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
            className="w-full h-full object-cover"
          />
        </div>
      ) : (
        <div className="bg-gradient-to-br from-blue-100 to-purple-100 p-3 rounded-full w-24 h-24 flex items-center justify-center shadow-lg transform transition-all hover:scale-105 duration-300">
          <UserIcon className="text-blue-600 w-12 h-12" />
        </div>
      )}


      <div className="flex-1">
        <h3 className="text-2xl font-bold text-gray-900">
          {name} {surName}
        </h3>
        <p className="text-gray-600 text-sm mt-1">{login}</p>
      </div>


      {active ? (
        <div className="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-full shadow-sm">
          <div className="relative">
            <MonitorDot className="text-green-600 w-6 h-6" />

            <div className="absolute inset-0 flex items-center justify-center">
              <div className="w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
            </div>
          </div>
          <p className="text-sm font-medium text-green-800">
            {pcName} ({pcIP}) ‚Äì Online
          </p>
        </div>
      ) : (
        <div className="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-full shadow-sm">
          <MonitorDot className="text-red-600 w-6 h-6" />
          <p className="text-sm font-medium text-red-800">Offline</p>
        </div>
      )}


      <div className="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-purple-50 px-4 py-2 rounded-full shadow-sm">
        {role === "ADMIN" ? (
          <ShieldCheck className="text-green-600 w-6 h-6" />
        ) : (
          <User className="text-blue-600 w-6 h-6" />
        )}
        <span className="text-gray-700 font-medium">{role}</span>
      </div>


      <div className="absolute top-4 right-4 flex space-x-2 z-10">
        <button
          onClick={() => openModal("userEdit")}
          className="p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition transform hover:scale-110"
        >
          <Pencil size={18} />
        </button>
        <button
          className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition transform hover:scale-110"
          onClick={() => openModal("userDelete")}
        >
          <Trash2 size={18} />
        </button>
      </div>

      <Modal isOpen={modalType === "userDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${name} ${surName} ?`}
          actionConfirm={deleteUser}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "userEdit"} onClose={closeModal}>
        <AdminEditUser ID={ID} updateUsersList={updateUsersList} />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminUsers/AdminUsers.tsx
================================================================================

import { useEffect, useState } from "react";
import { fetchPC, fetchSession, fetchUsers, deleteUser } from "src/api/userApi";
import { AdminOneUser } from "./AdminOneUser";
import { userGetModel } from "src/types/UserModel";
import { SessionModelFull } from "src/types/SessionModel";
import { pcModelFull } from "src/types/PCModel";

export const AdminUsers: React.FC = () => {
  const [users, setUsers] = useState<userGetModel[]>([]);
  const [sessions, setSessions] = useState<SessionModelFull[]>([]);
  const [pcs, setPcs] = useState<pcModelFull[]>([]);

  const updateUsersList = async () => {
    fetchUsers().then((data) => setUsers(data));
    fetchSession().then((data) => setSessions(data));
    fetchPC().then((data) => setPcs(data));
  };

  useEffect(() => {
    updateUsersList();
  }, []);

  const getActiveSession = () => {
    return sessions.filter(
      (session: SessionModelFull) => session.online === true
    );
  };

  const getUsersOnlineID = () => {
    return (

      getActiveSession().map((session: SessionModelFull) => session.userId)
    );
  };

  const isOnline = (id: number) => {
    return getUsersOnlineID().includes(id);
  };

  const getCurrentPCName = (userId: number) => {
    const currentSession = getActiveSession().find(
      (session) => session.userId === userId
    );
    const currentPC = pcs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    return currentPC;
  };

  const deleteCurrentUser = async (id: number) => {
    try {
      await deleteUser(id);
      updateUsersList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —é–∑–µ—Ä–∞:", error);
    }
  };

  let allUsers = users.map((user: userGetModel) => (
    <AdminOneUser
      key={user.id}
      ID={user.id}
      login={user.login}
      role={user.role}
      name={user.name}
      surName={user.surname}
      img={user.img}
      active={isOnline(user.id)}
      pcName={getCurrentPCName(user.id)?.pc_name}
      pcIP={getCurrentPCName(user.id)?.ip}
      updateUsersList={() => updateUsersList()}
      deleteUser={() => deleteCurrentUser(user.id)}
    />
  ));
  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
        üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {allUsers}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Audit/AuditLogPage.tsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { fetchAuditLogs } from "api/auditApi";
import { Preloader } from "src/components/common/Preloader";
import {
  History, Search, LogIn, Building2, Shield,
  Warehouse, MoreHorizontal,
  Download, RefreshCw
} from "lucide-react";
import { AuditLogModel } from "types/AuditLogModel";
import { fetchUsers } from "src/api/userApi";
import { userGetModel } from "src/types/UserModel";


type AuditTab =
  | "ALL"
  | "SESSIONS"
  | "STRUCTURE"
  | "ACCESS"
  | "WAREHOUSE"
  | "OTHER";


const TABS: { id: AuditTab; label: string; icon: React.ElementType; description: string }[] = [
  { id: "ALL", label: "–í—Å–µ —Å–æ–±—ã—Ç–∏—è", icon: History, description: "–í—Å–µ –∑–∞–ø–∏—Å–∏ –∂—É—Ä–Ω–∞–ª–∞" },
  { id: "SESSIONS", label: "–°–µ—Å—Å–∏–∏", icon: LogIn, description: "–í—Ö–æ–¥ –∏ –≤—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" },
  { id: "WAREHOUSE", label: "–°–∫–ª–∞–¥", icon: Warehouse, description: "–°–∫–ª–∞–¥—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏" },
  { id: "STRUCTURE", label: "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", icon: Building2, description: "–£—á–∞—Å—Ç–∫–∏ –∏ –±—Ä–∏–≥–∞–¥—ã" },
  { id: "ACCESS", label: "–ü—Ä–∞–≤–∞", icon: Shield, description: "–†–æ–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è" },
  { id: "OTHER", label: "–ü—Ä–æ—á–µ–µ", icon: MoreHorizontal, description: "–û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è" },
];


const ENTITY_TAB_MAP: Record<string, AuditTab> = {
  SESSION: "SESSIONS",

  Section: "STRUCTURE",
  Team: "STRUCTURE",

  Role: "ACCESS",
  Ability: "ACCESS",
  RoleAbility: "ACCESS",

  WarehouseMovement: "WAREHOUSE",
  InventoryBox: "WAREHOUSE",
  Supply: "WAREHOUSE",
  WarehouseDocument: "WAREHOUSE",
  Warehouse: "WAREHOUSE",
  Box: "WAREHOUSE",
};


const ACTION_COLORS: Record<string, string> = {
  CREATE: "bg-green-100 text-green-800",
  CREATED: "bg-green-100 text-green-800",
  UPDATE: "bg-blue-100 text-blue-800",
  UPDATED: "bg-blue-100 text-blue-800",
  DELETE: "bg-red-100 text-red-800",
  DELETED: "bg-red-100 text-red-800",
  SESSION_START: "bg-emerald-100 text-emerald-800",
  SESSION_END: "bg-amber-100 text-amber-800",
  SESSION_DELETE: "bg-red-100 text-red-800",
  SESSION_AUTO_OFF: "bg-gray-100 text-gray-800",
  SESSION_FORCE_OFF: "bg-orange-100 text-orange-800",
  WAREHOUSE_MOVE: "bg-purple-100 text-purple-800",
  WAREHOUSE_MOVE_BATCH: "bg-purple-100 text-purple-800",
  DEFECT_RESOLVED: "bg-green-100 text-green-800",
  DEFECT_CREATED: "bg-red-100 text-red-800",
  COMPONENT_SYNC: "bg-cyan-100 text-cyan-800",
  EXPORT: "bg-indigo-100 text-indigo-800",
};


export const AuditLogPage: React.FC = () => {
  const [logs, setLogs] = useState<AuditLogModel[]>([]);
  const [page, setPage] = useState(1);
  const [limit] = useState(50);
  const [totalCount, setTotalCount] = useState(0);

  const [dateFrom, setDateFrom] = useState<string>("");
  const [dateTo, setDateTo] = useState<string>("");
  const [actionFilter, setActionFilter] = useState<string>("");
  const [entityFilter, setEntityFilter] = useState<string>("");

  const [searchText, setSearchText] = useState<string>("");
  const [activeTab, setActiveTab] = useState<AuditTab>("ALL");

  const [selectedUserId, setSelectedUserId] = useState<string>("");
  const [users, setUsers] = useState<userGetModel[]>([]);

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);


  useEffect(() => {
    const loadUsers = async () => {
      try {
        const data = await fetchUsers();
        setUsers(data);
      } catch (e) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –∂—É—Ä–Ω–∞–ª–∞", e);
      }
    };
    loadUsers();
  }, []);


  useEffect(() => {
    const load = async () => {
      setLoading(true);
      setError(null);
      try {
        const userIdParam =
          selectedUserId && selectedUserId !== "ALL"
            ? Number(selectedUserId)
            : undefined;

        const { count, rows } = await fetchAuditLogs({
          page,
          limit,
          action: actionFilter || undefined,
          entity: entityFilter || undefined,
          dateFrom: dateFrom || undefined,
          dateTo: dateTo || undefined,
          userId: userIdParam,
        });

        setLogs(rows);
        setTotalCount(count);
      } catch (e: any) {
        console.error(e);
        setError(e?.response?.data?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞");
      } finally {
        setLoading(false);
      }
    };

    load();
  }, [page, limit, actionFilter, entityFilter, dateFrom, dateTo, selectedUserId]);


  const actions = useMemo(() => {
    const set = new Set<string>();
    logs.forEach((log) => {
      if (log.action) set.add(log.action);
    });
    return Array.from(set).sort();
  }, [logs]);


  const _entities = useMemo(() => {
    const set = new Set<string>();
    logs.forEach((log) => {
      if (log.entity) set.add(log.entity);
    });
    return Array.from(set).sort();
  }, [logs]);


  const totalPages = useMemo(
    () => Math.max(1, Math.ceil(totalCount / limit)),
    [totalCount, limit]
  );


  const getLogTab = (log: AuditLogModel): AuditTab => {
    if (log.entity && ENTITY_TAB_MAP[log.entity]) {
      return ENTITY_TAB_MAP[log.entity];
    }

    if (log.action?.startsWith("SESSION_")) return "SESSIONS";
    if (log.action?.startsWith("WAREHOUSE_")) return "WAREHOUSE";
    return "OTHER";
  };


  const filteredLogs = useMemo(() => {
    const query = searchText.toLowerCase();
    let data = logs;


    if (activeTab !== "ALL") {
      data = data.filter((log) => getLogTab(log) === activeTab);
    }


    if (query) {
      data = data.filter((log) => {
        const description = (log.description || "").toLowerCase();
        const action = (log.action || "").toLowerCase();
        const entity = (log.entity || "").toLowerCase();
        const user = `${log.User?.name || ""} ${log.User?.surname || ""} ${log.User?.login || ""}`
          .trim()
          .toLowerCase();

        return (
          description.includes(query) ||
          action.includes(query) ||
          entity.includes(query) ||
          user.includes(query)
        );
      });
    }

    return data;
  }, [logs, searchText, activeTab]);


  const tabStats = useMemo(() => {
    const stats: Record<AuditTab, number> = {
      ALL: logs.length,
      SESSIONS: 0,
      STRUCTURE: 0,
      ACCESS: 0,
      WAREHOUSE: 0,
      OTHER: 0,
    };

    logs.forEach((log) => {
      const tab = getLogTab(log);
      stats[tab]++;
    });

    return stats;
  }, [logs]);


  const getActionBadgeClass = (action: string): string => {
    if (ACTION_COLORS[action]) return ACTION_COLORS[action];
    if (action.includes("CREATE") || action.includes("ADD")) return ACTION_COLORS.CREATE;
    if (action.includes("UPDATE") || action.includes("EDIT")) return ACTION_COLORS.UPDATE;
    if (action.includes("DELETE") || action.includes("REMOVE")) return ACTION_COLORS.DELETE;
    return "bg-gray-100 text-gray-700";
  };


  const handleExport = () => {
    const headers = ["–í—Ä–µ–º—è", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "–î–µ–π—Å—Ç–≤–∏–µ", "–°—É—â–Ω–æ—Å—Ç—å", "–û–ø–∏—Å–∞–Ω–∏–µ"];
    const rows = filteredLogs.map((log) => [
      new Date(log.createdAt).toLocaleString("ru-RU"),
      log.User ? `${log.User.name} ${log.User.surname}` : "–°–∏—Å—Ç–µ–º–∞",
      log.action || "",
      log.entity || "",
      log.description || "",
    ]);

    const csv = [headers, ...rows]
      .map((row) => row.map((cell) => `"${cell}"`).join(","))
      .join("\n");

    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `audit_log_${new Date().toISOString().split("T")[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="px-4 py-6 max-w-[1800px] mx-auto">

      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
            <History className="w-5 h-5 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</h1>
            <p className="text-sm text-gray-500">–ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ QMS</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={() => window.location.reload()}
            className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
            title="–û–±–Ω–æ–≤–∏—Ç—å"
          >
            <RefreshCw className="w-5 h-5" />
          </button>
          <button
            onClick={handleExport}
            className="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
          >
            <Download className="w-4 h-4" />
            –≠–∫—Å–ø–æ—Ä—Ç
          </button>
        </div>
      </div>


      <div className="mb-4 flex flex-wrap gap-2">
        {TABS.map((tab) => {
          const Icon = tab.icon;
          const count = tabStats[tab.id];
          const isActive = activeTab === tab.id;

          return (
            <button
              key={tab.id}
              type="button"
              onClick={() => {
                setActiveTab(tab.id);
                setPage(1);
              }}
              title={tab.description}
              className={[
                "flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium border transition-all",
                isActive
                  ? "bg-blue-600 text-white border-blue-600 shadow-sm"
                  : "bg-white text-gray-600 border-gray-200 hover:bg-gray-50 hover:border-gray-300",
              ].join(" ")}
            >
              <Icon className="w-4 h-4" />
              {tab.label}
              {count > 0 && (
                <span
                  className={[
                    "px-1.5 py-0.5 rounded-full text-xs",
                    isActive ? "bg-blue-500 text-white" : "bg-gray-100 text-gray-600",
                  ].join(" ")}
                >
                  {count}
                </span>
              )}
            </button>
          );
        })}
      </div>


      <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">

          <div className="lg:col-span-2">
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–ü–æ–∏—Å–∫</label>
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
              <input
                type="text"
                value={searchText}
                onChange={(e) => setSearchText(e.target.value)}
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é, –¥–µ–π—Å—Ç–≤–∏—é, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é..."
                className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–î–∞—Ç–∞ —Å</label>
            <input
              type="date"
              value={dateFrom}
              onChange={(e) => {
                setDateFrom(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–î–∞—Ç–∞ –ø–æ</label>
            <input
              type="date"
              value={dateTo}
              onChange={(e) => {
                setDateTo(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
            <select
              value={selectedUserId}
              onChange={(e) => {
                setSelectedUserId(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">–í—Å–µ</option>
              {users.map((u) => (
                <option key={u.id} value={u.id}>
                  {u.name} {u.surname}
                </option>
              ))}
            </select>
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–î–µ–π—Å—Ç–≤–∏–µ</label>
            <select
              value={actionFilter}
              onChange={(e) => {
                setActionFilter(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">–í—Å–µ</option>
              {actions.map((a) => (
                <option key={a} value={a}>
                  {a}
                </option>
              ))}
            </select>
          </div>
        </div>
      </div>


      {loading && <Preloader />}


      {error && (
        <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
          <strong>–û—à–∏–±–∫–∞:</strong> {error}
        </div>
      )}


      {!loading && (
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div className="overflow-x-auto">
            <table className="min-w-full text-left text-sm">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-40">
                    –í—Ä–µ–º—è
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-48">
                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-40">
                    –î–µ–π—Å—Ç–≤–∏–µ
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-36">
                    –°—É—â–Ω–æ—Å—Ç—å
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">
                    –û–ø–∏—Å–∞–Ω–∏–µ
                  </th>
                </tr>
              </thead>
              <tbody>
                {filteredLogs.length === 0 && (
                  <tr>
                    <td colSpan={5} className="px-4 py-12 text-center text-gray-400">
                      <History className="w-12 h-12 mx-auto mb-3 opacity-30" />
                      <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                    </td>
                  </tr>
                )}

                {filteredLogs.map((log) => (
                  <tr
                    key={log.id}
                    className="border-b last:border-b-0 hover:bg-gray-50 transition-colors"
                  >
                    <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                      {new Date(log.createdAt).toLocaleString("ru-RU", {
                        day: "2-digit",
                        month: "2-digit",
                        year: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </td>

                    <td className="px-4 py-3 text-sm">
                      {log.User ? (
                        <div>
                          <div className="font-medium text-gray-800">
                            {log.User.name} {log.User.surname}
                          </div>
                          <div className="text-xs text-gray-400">{log.User.login}</div>
                        </div>
                      ) : (
                        <span className="text-gray-400 italic">–°–∏—Å—Ç–µ–º–∞</span>
                      )}
                    </td>

                    <td className="px-4 py-3">
                      <span
                        className={`inline-block px-2 py-1 rounded text-xs font-medium ${getActionBadgeClass(
                          log.action || ""
                        )}`}
                      >
                        {log.action}
                      </span>
                    </td>

                    <td className="px-4 py-3 text-sm text-gray-600">
                      {log.entity && (
                        <span className="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs">
                          {log.entity}
                          {log.entityId && <span className="text-gray-400 ml-1">#{log.entityId}</span>}
                        </span>
                      )}
                    </td>

                    <td className="px-4 py-3 text-sm text-gray-600">
                      {log.description || <span className="text-gray-300 italic">‚Äî</span>}


                      {log.metadata && (
                        <div className="mt-1 flex flex-wrap gap-1">
                          {log.metadata.pcName && (
                            <span className="text-xs bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded">
                              –ü–ö: {log.metadata.pcName}
                            </span>
                          )}
                          {log.metadata.ip && (
                            <span className="text-xs bg-gray-50 text-gray-500 px-1.5 py-0.5 rounded">
                              IP: {log.metadata.ip}
                            </span>
                          )}
                          {log.metadata.serverSerial && (
                            <span className="text-xs bg-purple-50 text-purple-600 px-1.5 py-0.5 rounded">
                              S/N: {log.metadata.serverSerial}
                            </span>
                          )}
                          {log.metadata.count !== undefined && (
                            <span className="text-xs bg-amber-50 text-amber-600 px-1.5 py-0.5 rounded">
                              –ö–æ–ª-–≤–æ: {log.metadata.count}
                            </span>
                          )}
                        </div>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>


          {totalPages > 1 && (
            <div className="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
              <div className="text-sm text-gray-500">
                –ü–æ–∫–∞–∑–∞–Ω–æ {filteredLogs.length} –∏–∑ {totalCount} –∑–∞–ø–∏—Å–µ–π
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setPage((p) => Math.max(1, p - 1))}
                  disabled={page === 1}
                  className="px-3 py-1 border border-gray-200 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition-colors"
                >
                  –ù–∞–∑–∞–¥
                </button>
                <span className="text-sm text-gray-600">
                  {page} / {totalPages}
                </span>
                <button
                  onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
                  disabled={page === totalPages}
                  className="px-3 py-1 border border-gray-200 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition-colors"
                >
                  –í–ø–µ—Ä—ë–¥
                </button>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default AuditLogPage;

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreateDefect.tsx
================================================================================

import { useState } from "react";

interface CreateDefectModel {
  createDefect: (title: string, description: string) => void;
}
export const CreateDefect: React.FC<CreateDefectModel> = ({ createDefect }) => {
  const [title, SetTitle] = useState("");
  const [description, SetDescription] = useState("");

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const addCategoryDefect = async () => {
    try {
      await createDefect(title, description);
      SetTitle("");
      SetDescription("");

      setSuccessMessage("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–µ—Ñ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
      setErrorMessage("");
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞</h2>
      <form>
        <input
          type="text"
          placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
          className="w-full p-2 border rounded-lg mb-2"
          value={title}
          onChange={(e) => SetTitle(e.target.value)}
        />
        <textarea
          placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
          className="w-full p-2 border rounded-lg mb-2"
          value={description}
          onChange={(e) => SetDescription(e.target.value)}
        />
        <button
          type="button"
          className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition"
          onClick={() => setConfirm(true)}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>

      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">
              –î–æ–±–∞–≤–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞ –≤ –±–∞–∑—É?
            </p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  addCategoryDefect();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreatePC.tsx
================================================================================

import { useState } from "react";
import { createPC } from "src/api/userApi";

export const CreatePC = () => {
  const [ip, SetIp] = useState("");
  const [pc_name, SetPc_name] = useState("");
  const [cabinet, SetCabinet] = useState("");

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const addPC = async () => {
    try {
      await createPC(ip, pc_name, cabinet);

      SetIp("");
      SetPc_name("");
      SetCabinet("");
      setSuccessMessage("–ö–æ–º–ø—å—é—Ç–µ—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω");
      setErrorMessage("");
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä</h2>
      <form>
        <input
          type="text"
          placeholder="–ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞"
          className="w-full p-2 border rounded-lg mb-2"
          value={pc_name}
          onChange={(e) => SetPc_name(e.target.value)}
        />
        <input
          type="text"
          placeholder="IP-–∞–¥—Ä–µ—Å"
          className="w-full p-2 border rounded-lg mb-2"
          value={ip}
          onChange={(e) => SetIp(e.target.value)}
        />
        <input
          type="text"
          placeholder="–ö–∞–±–∏–Ω–µ—Ç"
          className="w-full p-2 border rounded-lg mb-2"
          value={cabinet}
          onChange={(e) => SetCabinet(e.target.value)}
        />
        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">
              –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä –≤ –±–∞–∑—É?
            </p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  addPC();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/AdminCard.tsx
================================================================================

import { NavLink } from "react-router-dom";

type AdminCardProps = {
  image: string | React.ReactNode;
  title: string;
  description: string;
  onAdd?: () => void;
  editLink: string;
};

export const AdminCard = ({
  image,
  title,
  description,
  onAdd,
  editLink,
}: AdminCardProps) => (
  <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer">
    <div className="flex items-center gap-4">
      {typeof image === "string" ? (
        <img src={image} alt={title} className="w-12 h-12" />
      ) : (
        image
      )}
      <div>
        <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
        <p className="text-sm text-gray-600">{description}</p>
      </div>
    </div>
    <div className="mt-4 flex gap-2">
      {onAdd && (
        <button
          className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition"
          onClick={onAdd}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      )}
      <NavLink
        to={editLink}
        className="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition"
      >
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
      </NavLink>
    </div>
  </div>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/StructureSection.tsx
================================================================================

import React from "react";
import { AdminCard } from "./AdminCard";
import { Network } from "lucide-react";
import { STRUCTURE_ROUTE } from "src/utils/consts";

export const StructureSection: React.FC = () => {
  return (
    <div className="w-full max-w-4xl mt-8">
      <h2 className="text-xl font-semibold text-gray-700 mb-4">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <AdminCard
          image={<Network className="w-12 h-12 text-indigo-600" />}
          title="–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ò–µ—Ä–∞—Ä—Ö–∏—è"
          description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞–º–∏, –±—Ä–∏–≥–∞–¥–∞–º–∏ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö"
          editLink={STRUCTURE_ROUTE}
        />
      </div>
    </div>
  );
};
================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/UsersSection.tsx
================================================================================

import { ADMIN_PCs_ROUTE, ADMIN_USERS_ROUTE, AUDIT_LOG_ROUTE } from "src/utils/consts";
import { AdminCard } from "./AdminCard";
import ComputerImage from "assets/images/pc.png";
import { Users, History } from "lucide-react";
import { CREATE_COMPUTER } from "src/utils/constsModalType";

type UsersSectionProps = {
  openModal: (type: string) => void;
};

export const UsersSection: React.FC<UsersSectionProps> = ({ openModal }) => (
  <div className="w-full max-w-4xl mt-8">
    <h2 className="text-xl font-semibold text-gray-700 mb-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ö–æ–Ω—Ç—Ä–æ–ª—å</h2>

    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <AdminCard
        image={ComputerImage}
        title="–ö–æ–º–ø—å—é—Ç–µ—Ä—ã"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–ö"
        onAdd={() => openModal(CREATE_COMPUTER)}
        editLink={ADMIN_PCs_ROUTE}
      />
      <AdminCard
        image={<Users className="w-12 h-12 text-purple-600" />}
        title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"
        onAdd={() => alert("–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å—É—Ç—Å–≤—É–µ—Ç, —Ä–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")}
        editLink={ADMIN_USERS_ROUTE}
      />

      <AdminCard
        image={<History className="w-12 h-12 text-amber-600" />}
        title="–ñ—É—Ä–Ω–∞–ª –ê—É–¥–∏—Ç–∞"
        description="–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        editLink={AUDIT_LOG_ROUTE}
      />
    </div>
  </div>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/WarehouseSection.tsx
================================================================================

import React from "react";
import { AdminCard } from "./AdminCard";
import { Package } from "lucide-react";
import { ADMIN_WAREHOUSE_ROUTE } from "src/utils/consts";

export const WarehouseSection: React.FC = () => {
  return (
    <div className="w-full max-w-4xl mt-8">
      <h2 className="text-xl font-semibold text-gray-700 mb-4">
        –°–∫–ª–∞–¥ –∏ –ø—Ä–∏—ë–º–∫–∞
      </h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <AdminCard
          image={<Package className="w-12 h-12 text-emerald-600" />}
          title="–ü—Ä–∏—ë–º–∫–∞ –∏ —Å–∫–ª–∞–¥"
          description="–ü–æ—Å—Ç–∞–≤–∫–∏, –∫–æ—Ä–æ–±–∫–∏ –∏ —ç—Ç–∏–∫–µ—Ç–∫–∏"
          editLink={ADMIN_WAREHOUSE_ROUTE}
        />
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/RBAC/AdminRightsPage.tsx
================================================================================

import React, { useEffect, useState, useMemo } from "react";
import { observer } from "mobx-react-lite";
import {
    fetchAllRoles,
    fetchAllAbilities,
    updateRoleAbilities,
    RoleModel,
    AbilityModel
} from "src/api/rbacApi";
import { fetchUsers } from "src/api/userApi";
import { userGetModel } from "src/types/UserModel";
import {
    Shield, Save, CheckSquare, Square,
    Loader2, Users, Key, Search, User,
    ChevronDown, ChevronRight, X,
    AlertCircle
} from "lucide-react";
import toast from "react-hot-toast";


interface AbilityGroup {
    prefix: string;
    label: string;
    abilities: AbilityModel[];
    isExpanded: boolean;
}


const GROUP_LABELS: Record<string, string> = {
    warehouse: "–°–∫–ª–∞–¥",
    rbac: "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞",
    users: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
    admin: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ",
    tasks: "–ó–∞–¥–∞—á–∏",
    dms: "–î–æ–∫—É–º–µ–Ω—Ç—ã",
    nc: "–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è",
    capa: "CAPA",
    qms: "–ê—É–¥–∏—Ç QMS",
    labels: "–≠—Ç–∏–∫–µ—Ç–∫–∏",
};


export const AdminRightsPage: React.FC = observer(() => {

    const [viewMode, setViewMode] = useState<"USERS" | "MATRIX">("USERS");
    const [loading, setLoading] = useState(false);


    const [roles, setRoles] = useState<RoleModel[]>([]);
    const [abilities, setAbilities] = useState<AbilityModel[]>([]);
    const [users, setUsers] = useState<userGetModel[]>([]);


    const [matrix, setMatrix] = useState<Record<number, Set<number>>>({});
    const [originalMatrix, setOriginalMatrix] = useState<Record<number, Set<number>>>({});
    const [savingId, setSavingId] = useState<number | null>(null);
    const [savingAll, setSavingAll] = useState(false);


    const [userSearch, setUserSearch] = useState("");
    const [abilitySearch, setAbilitySearch] = useState("");


    const [expandedGroups, setExpandedGroups] = useState<Set<string>>(new Set());
    const [compactMode, setCompactMode] = useState(false);


    useEffect(() => {
        loadData();
    }, []);

    const loadData = async () => {
        setLoading(true);
        try {
            const [rolesData, abilitiesData, usersData] = await Promise.all([
                fetchAllRoles(),
                fetchAllAbilities(),
                fetchUsers()
            ]);

            setRoles(rolesData);
            setAbilities(abilitiesData);
            setUsers(usersData);


            const initialMatrix: Record<number, Set<number>> = {};
            rolesData.forEach(role => {
                const abilityIds = new Set(role.abilities.map(a => a.id));
                initialMatrix[role.id] = abilityIds;
            });
            setMatrix(initialMatrix);
            setOriginalMatrix(JSON.parse(JSON.stringify(
                Object.fromEntries(
                    Object.entries(initialMatrix).map(([k, v]) => [k, Array.from(v)])
                )
            )));


            const prefixes = new Set(abilitiesData.map(a => a.code.split('.')[0]));
            setExpandedGroups(prefixes);

        } catch (e) {
            console.error(e);
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏");
        } finally {
            setLoading(false);
        }
    };


    const groupedAbilities = useMemo(() => {
        const groups: Record<string, AbilityModel[]> = {};

        abilities.forEach(ability => {
            const prefix = ability.code.split('.')[0];
            if (!groups[prefix]) groups[prefix] = [];
            groups[prefix].push(ability);
        });


        const filtered: AbilityGroup[] = Object.entries(groups)
            .map(([prefix, abs]) => ({
                prefix,
                label: GROUP_LABELS[prefix] || prefix,
                abilities: abs.filter(a =>
                    !abilitySearch ||
                    a.code.toLowerCase().includes(abilitySearch.toLowerCase()) ||
                    a.description.toLowerCase().includes(abilitySearch.toLowerCase())
                ),
                isExpanded: expandedGroups.has(prefix)
            }))
            .filter(g => g.abilities.length > 0)
            .sort((a, b) => a.label.localeCompare(b.label));

        return filtered;
    }, [abilities, abilitySearch, expandedGroups]);


    const _visibleAbilities = useMemo(() => {
        const result: { ability: AbilityModel; groupPrefix: string; isFirstInGroup: boolean; groupLabel: string; groupSize: number }[] = [];

        groupedAbilities.forEach(group => {
            if (group.isExpanded) {
                group.abilities.forEach((ability, idx) => {
                    result.push({
                        ability,
                        groupPrefix: group.prefix,
                        isFirstInGroup: idx === 0,
                        groupLabel: group.label,
                        groupSize: group.abilities.length
                    });
                });
            }
        });

        return result;
    }, [groupedAbilities]);


    const togglePermission = (roleId: number, abilityId: number) => {
        const role = roles.find(r => r.id === roleId);
        if (role?.name === 'SUPER_ADMIN') {
            toast('–ü—Ä–∞–≤–∞ –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∞ –Ω–µ–∏–∑–º–µ–Ω–Ω—ã', { icon: 'üîí' });
            return;
        }

        setMatrix(prev => {
            const roleAbilities = new Set(prev[roleId]);
            if (roleAbilities.has(abilityId)) {
                roleAbilities.delete(abilityId);
            } else {
                roleAbilities.add(abilityId);
            }
            return { ...prev, [roleId]: roleAbilities };
        });
    };


    const toggleGroupForRole = (roleId: number, groupPrefix: string) => {
        const role = roles.find(r => r.id === roleId);
        if (role?.name === 'SUPER_ADMIN') {
            toast('–ü—Ä–∞–≤–∞ –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∞ –Ω–µ–∏–∑–º–µ–Ω–Ω—ã', { icon: 'üîí' });
            return;
        }

        const groupAbilities = abilities.filter(a => a.code.startsWith(groupPrefix + '.'));
        const groupIds = groupAbilities.map(a => a.id);

        setMatrix(prev => {
            const roleAbilities = new Set(prev[roleId]);
            const allChecked = groupIds.every(id => roleAbilities.has(id));

            if (allChecked) {

                groupIds.forEach(id => roleAbilities.delete(id));
            } else {

                groupIds.forEach(id => roleAbilities.add(id));
            }
            return { ...prev, [roleId]: roleAbilities };
        });
    };


    const hasChanges = (roleId: number): boolean => {
        const current = matrix[roleId] || new Set();
        const original = new Set(originalMatrix[roleId] || []);

        if (current.size !== original.size) return true;
        for (const id of current) {
            if (!original.has(id)) return true;
        }
        return false;
    };


    const changedRolesCount = useMemo(() => {
        return roles.filter(r => hasChanges(r.id)).length;
    }, [roles, matrix, originalMatrix]);


    const saveRole = async (roleId: number) => {
        setSavingId(roleId);
        try {
            const abilityIds = Array.from(matrix[roleId] || []);
            await updateRoleAbilities(roleId, abilityIds);
            toast.success("–ü—Ä–∞–≤–∞ —Ä–æ–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã");


            setOriginalMatrix(prev => ({
                ...prev,
                [roleId]: new Set(abilityIds)
            }));


            const updatedRoles = roles.map(r => {
                if (r.id === roleId) {
                    const newAbilities = abilities.filter(a => abilityIds.includes(a.id));
                    return { ...r, abilities: newAbilities };
                }
                return r;
            });
            setRoles(updatedRoles);
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        } finally {
            setSavingId(null);
        }
    };

    const saveAllChanges = async () => {
        const changedRoles = roles.filter(r => hasChanges(r.id));
        if (changedRoles.length === 0) return;

        setSavingAll(true);
        let successCount = 0;
        let errorCount = 0;

        for (const role of changedRoles) {
            try {
                const abilityIds = Array.from(matrix[role.id] || []);
                await updateRoleAbilities(role.id, abilityIds);

                setOriginalMatrix(prev => ({
                    ...prev,
                    [role.id]: new Set(abilityIds)
                }));
                successCount++;
            } catch (e) {
                errorCount++;
            }
        }

        setSavingAll(false);

        if (errorCount === 0) {
            toast.success(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${successCount} —Ä–æ–ª–µ–π`);
        } else {
            toast.error(`–û—à–∏–±–∫–∏: ${errorCount} –∏–∑ ${changedRoles.length}`);
        }


        loadData();
    };


    const getUserAbilities = (userRoleName: string) => {
        if (userRoleName === 'SUPER_ADMIN') return abilities;
        const roleObj = roles.find(r => r.name === userRoleName);
        return roleObj ? roleObj.abilities : [];
    };

    const filteredUsers = users.filter(u =>
        u.login.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.name?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.surname?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.role.toLowerCase().includes(userSearch.toLowerCase())
    );


    const toggleGroup = (prefix: string) => {
        setExpandedGroups(prev => {
            const next = new Set(prev);
            if (next.has(prefix)) {
                next.delete(prefix);
            } else {
                next.add(prefix);
            }
            return next;
        });
    };

    const expandAllGroups = () => {
        const allPrefixes = new Set(abilities.map(a => a.code.split('.')[0]));
        setExpandedGroups(allPrefixes);
    };

    const collapseAllGroups = () => {
        setExpandedGroups(new Set());
    };


    if (loading && roles.length === 0) {
        return (
            <div className="flex justify-center p-20">
                <Loader2 className="animate-spin text-indigo-600" size={32}/>
            </div>
        );
    }

    return (
        <div className="p-6 bg-gray-50 min-h-screen">
            <div className="max-w-full mx-auto">


                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div className="flex items-center gap-4">
                        <div className="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 text-white">
                            <Shield size={32} />
                        </div>
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800">–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞</h1>
                            <p className="text-gray-500 font-medium">RBAC: –†–æ–ª–∏ –∏ –ø–æ–ª–Ω–æ–º–æ—á–∏—è</p>
                        </div>
                    </div>


                    <div className="bg-white p-1 rounded-xl shadow-sm border border-gray-200 flex">
                        <button
                            onClick={() => setViewMode("USERS")}
                            className={`px-6 py-2 rounded-lg font-bold transition flex items-center gap-2 ${
                                viewMode === "USERS"
                                    ? "bg-indigo-50 text-indigo-700 shadow-sm"
                                    : "text-gray-500 hover:bg-gray-50"
                            }`}
                        >
                            <Users size={18} /> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                        </button>
                        <button
                            onClick={() => setViewMode("MATRIX")}
                            className={`px-6 py-2 rounded-lg font-bold transition flex items-center gap-2 ${
                                viewMode === "MATRIX"
                                    ? "bg-indigo-50 text-indigo-700 shadow-sm"
                                    : "text-gray-500 hover:bg-gray-50"
                            }`}
                        >
                            <Key size={18} /> –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤
                        </button>
                    </div>
                </div>


                {viewMode === "USERS" && (
                    <div className="space-y-4 animate-fade-in">

                        <div className="relative max-w-md">
                            <Search className="absolute left-3 top-2.5 text-gray-400 w-5 h-5"/>
                            <input
                                value={userSearch}
                                onChange={e => setUserSearch(e.target.value)}
                                className="w-full pl-10 pr-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="–ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞..."
                            />
                        </div>

                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                                    <tr>
                                        <th className="p-4">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                        <th className="p-4">–†–æ–ª—å (Keycloak)</th>
                                        <th className="p-4">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∞</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filteredUsers.map(user => {
                                        const effectiveAbilities = getUserAbilities(user.role);
                                        return (
                                            <tr key={user.id} className="hover:bg-indigo-50/30 transition">
                                                <td className="p-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 overflow-hidden border border-gray-200">
                                                            {user.img ? (
                                                                <img src={user.img} alt="" className="w-full h-full object-cover"/>
                                                            ) : (
                                                                <User size={20}/>
                                                            )}
                                                        </div>
                                                        <div>
                                                            <div className="font-semibold text-gray-800">
                                                                {user.surname} {user.name}
                                                            </div>
                                                            <div className="text-xs text-gray-400">{user.login}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="p-4">
                                                    <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold">
                                                        {user.role}
                                                    </span>
                                                </td>
                                                <td className="p-4">
                                                    <div className="flex flex-wrap gap-1 max-w-xl">
                                                        {effectiveAbilities.length > 0 ? effectiveAbilities.map(ab => (
                                                            <span
                                                                key={ab.id}
                                                                className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-[10px] border border-gray-200"
                                                                title={ab.code}
                                                            >
                                                                {ab.description}
                                                            </span>
                                                        )) : (
                                                            <span className="text-gray-400 text-sm italic">–ù–µ—Ç –ø—Ä–∞–≤</span>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {filteredUsers.length === 0 && (
                                <div className="p-8 text-center text-gray-400">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                            )}
                        </div>
                    </div>
                )}


                {viewMode === "MATRIX" && (
                    <div className="space-y-4 animate-fade-in">


                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <div className="flex flex-wrap items-center gap-4">

                                <div className="relative flex-1 min-w-[200px] max-w-md">
                                    <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4"/>
                                    <input
                                        value={abilitySearch}
                                        onChange={e => setAbilitySearch(e.target.value)}
                                        className="w-full pl-9 pr-8 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∞–≤–∞..."
                                    />
                                    {abilitySearch && (
                                        <button
                                            onClick={() => setAbilitySearch("")}
                                            className="absolute right-2 top-2.5 text-gray-400 hover:text-gray-600"
                                        >
                                            <X size={16}/>
                                        </button>
                                    )}
                                </div>


                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={expandAllGroups}
                                        className="px-3 py-2 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition"
                                    >
                                        –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
                                    </button>
                                    <button
                                        onClick={collapseAllGroups}
                                        className="px-3 py-2 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition"
                                    >
                                        –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
                                    </button>
                                </div>


                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={compactMode}
                                        onChange={e => setCompactMode(e.target.checked)}
                                        className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                    />
                                    <span className="text-sm text-gray-600">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º</span>
                                </label>


                                <div className="ml-auto flex items-center gap-4 text-sm text-gray-500">
                                    <span>{roles.length} —Ä–æ–ª–µ–π</span>
                                    <span>{abilities.length} –ø—Ä–∞–≤</span>
                                    <span>{groupedAbilities.length} –≥—Ä—É–ø–ø</span>
                                </div>
                            </div>
                        </div>


                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full border-collapse">
                                    <thead>
                                        <tr>

                                            <th className={`
                                                ${compactMode ? 'p-2 min-w-[160px]' : 'p-4 min-w-[220px]'}
                                                text-left bg-gray-50 border-b border-r
                                                sticky left-0 z-20
                                                shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}>
                                                <div className="text-xs text-gray-400 font-normal uppercase mb-1">–†–æ–ª—å</div>
                                                <div className="font-bold text-gray-800">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏</div>
                                            </th>


                                            {groupedAbilities.map(group => (
                                                <th
                                                    key={group.prefix}
                                                    colSpan={group.isExpanded ? group.abilities.length : 1}
                                                    className={`
                                                        ${compactMode ? 'p-1' : 'p-2'}
                                                        text-center bg-gray-100 border-b border-r
                                                        ${!group.isExpanded ? 'cursor-pointer hover:bg-gray-200' : ''}
                                                    `}
                                                    onClick={() => !group.isExpanded && toggleGroup(group.prefix)}
                                                >
                                                    <div className="flex items-center justify-center gap-1">
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); toggleGroup(group.prefix); }}
                                                            className="p-1 hover:bg-gray-200 rounded transition"
                                                        >
                                                            {group.isExpanded
                                                                ? <ChevronDown size={14} className="text-gray-500"/>
                                                                : <ChevronRight size={14} className="text-gray-500"/>
                                                            }
                                                        </button>
                                                        <span className="font-bold text-gray-700 text-xs uppercase">
                                                            {group.label}
                                                        </span>
                                                        <span className="text-[10px] text-gray-400 ml-1">
                                                            ({group.abilities.length})
                                                        </span>
                                                    </div>
                                                </th>
                                            ))}


                                            <th className={`
                                                ${compactMode ? 'p-2 min-w-[70px]' : 'p-4 min-w-[100px]'}
                                                bg-gray-50 border-b
                                                sticky right-0 z-20
                                                shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}>
                                                <div className="text-xs text-gray-500 font-bold">–°–æ—Ö—Ä.</div>
                                            </th>
                                        </tr>


                                        <tr>
                                            <th className={`
                                                ${compactMode ? 'p-1' : 'p-2'}
                                                bg-gray-50 border-b border-r
                                                sticky left-0 z-20
                                                shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}></th>

                                            {groupedAbilities.map(group => (
                                                group.isExpanded ? (
                                                    group.abilities.map(ab => (
                                                        <th
                                                            key={ab.id}
                                                            className={`
                                                                ${compactMode ? 'p-1 min-w-[80px]' : 'p-2 min-w-[110px]'}
                                                                text-center bg-gray-50 border-b border-r align-top
                                                            `}
                                                        >
                                                            <div className={`
                                                                ${compactMode ? 'text-[8px]' : 'text-[10px]'}
                                                                text-gray-400 font-mono mb-0.5 truncate
                                                            `} title={ab.code}>
                                                                .{ab.code.split('.')[1]}
                                                            </div>
                                                            <div className={`
                                                                ${compactMode ? 'text-[9px]' : 'text-xs'}
                                                                font-semibold text-gray-600 leading-tight
                                                            `} title={ab.description}>
                                                                {compactMode
                                                                    ? ab.description.slice(0, 12) + (ab.description.length > 12 ? '‚Ä¶' : '')
                                                                    : ab.description
                                                                }
                                                            </div>
                                                        </th>
                                                    ))
                                                ) : (
                                                    <th key={group.prefix + '-collapsed'} className="p-1 bg-gray-50 border-b border-r">
                                                        <div className="text-[10px] text-gray-400 italic">—Å–≤—ë—Ä–Ω—É—Ç–æ</div>
                                                    </th>
                                                )
                                            ))}

                                            <th className={`
                                                ${compactMode ? 'p-1' : 'p-2'}
                                                bg-gray-50 border-b
                                                sticky right-0 z-20
                                                shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}></th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        {roles.map(role => {
                                            const isChanged = hasChanges(role.id);
                                            const isSuperAdmin = role.name === 'SUPER_ADMIN';

                                            return (
                                                <tr
                                                    key={role.id}
                                                    className={`
                                                        hover:bg-indigo-50/30 transition group
                                                        ${isChanged ? 'bg-amber-50/50' : ''}
                                                    `}
                                                >

                                                    <td className={`
                                                        ${compactMode ? 'p-2' : 'p-4'}
                                                        border-r border-b bg-white
                                                        sticky left-0 z-10
                                                        group-hover:bg-indigo-50/30
                                                        ${isChanged ? 'bg-amber-50/50 group-hover:bg-amber-100/50' : ''}
                                                        shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                                    `}>
                                                        <div className={`font-bold text-gray-800 ${compactMode ? 'text-xs' : 'text-sm'}`}>
                                                            {role.description}
                                                        </div>
                                                        <div className={`text-indigo-500 font-mono mt-0.5 ${compactMode ? 'text-[10px]' : 'text-xs'}`}>
                                                            {role.name}
                                                        </div>
                                                        {isChanged && (
                                                            <div className="flex items-center gap-1 mt-1 text-amber-600">
                                                                <AlertCircle size={12}/>
                                                                <span className="text-[10px]">–ò–∑–º–µ–Ω–µ–Ω–æ</span>
                                                            </div>
                                                        )}
                                                    </td>


                                                    {groupedAbilities.map(group => (
                                                        group.isExpanded ? (
                                                            group.abilities.map(ab => {
                                                                const isChecked = isSuperAdmin || matrix[role.id]?.has(ab.id);
                                                                return (
                                                                    <td
                                                                        key={ab.id}
                                                                        onClick={() => togglePermission(role.id, ab.id)}
                                                                        className={`
                                                                            ${compactMode ? 'p-1' : 'p-2'}
                                                                            border-r border-b text-center
                                                                            ${isSuperAdmin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer'}
                                                                            transition-colors
                                                                            ${isChecked ? 'bg-indigo-50/50' : ''}
                                                                            ${!isSuperAdmin && 'hover:bg-indigo-100/50'}
                                                                        `}
                                                                    >
                                                                        <div className="flex justify-center">
                                                                            {isChecked
                                                                                ? <CheckSquare size={compactMode ? 16 : 20} className="text-indigo-600"/>
                                                                                : <Square size={compactMode ? 16 : 20} className="text-gray-300"/>
                                                                            }
                                                                        </div>
                                                                    </td>
                                                                );
                                                            })
                                                        ) : (

                                                            <td
                                                                key={group.prefix + '-collapsed'}
                                                                onClick={() => !isSuperAdmin && toggleGroupForRole(role.id, group.prefix)}
                                                                className={`
                                                                    ${compactMode ? 'p-1' : 'p-2'}
                                                                    border-r border-b text-center
                                                                    ${isSuperAdmin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer hover:bg-indigo-100/50'}
                                                                    transition-colors
                                                                `}
                                                                title="–ö–ª–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ–π –≥—Ä—É–ø–ø—ã"
                                                            >
                                                                {(() => {
                                                                    const groupAbilities = abilities.filter(a => a.code.startsWith(group.prefix + '.'));
                                                                    const checkedCount = isSuperAdmin
                                                                        ? groupAbilities.length
                                                                        : groupAbilities.filter(a => matrix[role.id]?.has(a.id)).length;
                                                                    const total = groupAbilities.length;

                                                                    return (
                                                                        <div className={`
                                                                            font-mono font-bold
                                                                            ${checkedCount === total ? 'text-green-600' :
                                                                              checkedCount === 0 ? 'text-gray-400' : 'text-amber-600'}
                                                                            ${compactMode ? 'text-xs' : 'text-sm'}
                                                                        `}>
                                                                            {checkedCount}/{total}
                                                                        </div>
                                                                    );
                                                                })()}
                                                            </td>
                                                        )
                                                    ))}


                                                    <td className={`
                                                        ${compactMode ? 'p-1' : 'p-2'}
                                                        border-b bg-white
                                                        sticky right-0 z-10
                                                        group-hover:bg-indigo-50/30
                                                        ${isChanged ? 'bg-amber-50/50 group-hover:bg-amber-100/50' : ''}
                                                        shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                                    `}>
                                                        <button
                                                            onClick={() => saveRole(role.id)}
                                                            disabled={!isChanged || savingId === role.id || isSuperAdmin}
                                                            className={`
                                                                p-2 rounded-lg transition-all flex items-center justify-center
                                                                ${isChanged && !isSuperAdmin
                                                                    ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md'
                                                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                                }
                                                            `}
                                                            title={isSuperAdmin ? '–ü—Ä–∞–≤–∞ –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∞ –Ω–µ–∏–∑–º–µ–Ω–Ω—ã' : isChanged ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π'}
                                                        >
                                                            {savingId === role.id
                                                                ? <Loader2 size={16} className="animate-spin"/>
                                                                : <Save size={16}/>
                                                            }
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>


                        <div className="flex flex-wrap items-center gap-6 text-xs text-gray-500 px-2">
                            <div className="flex items-center gap-2">
                                <CheckSquare size={16} className="text-indigo-600"/>
                                <span>–ü—Ä–∞–≤–æ –≤–∫–ª—é—á–µ–Ω–æ</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <Square size={16} className="text-gray-300"/>
                                <span>–ü—Ä–∞–≤–æ –≤—ã–∫–ª—é—á–µ–Ω–æ</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 bg-amber-100 rounded"/>
                                <span>–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="font-mono text-green-600 font-bold">3/3</span>
                                <span>–í—Å–µ –ø—Ä–∞–≤–∞ –≥—Ä—É–ø–ø—ã (–≤ —Å–≤—ë—Ä–Ω—É—Ç–æ–º –≤–∏–¥–µ)</span>
                            </div>
                        </div>
                    </div>
                )}


                {viewMode === "MATRIX" && changedRolesCount > 0 && (
                    <div className="fixed bottom-6 right-6 z-50 animate-bounce-in">
                        <button
                            onClick={saveAllChanges}
                            disabled={savingAll}
                            className="
                                flex items-center gap-3 px-6 py-4
                                bg-gradient-to-r from-indigo-600 to-purple-600
                                text-white font-bold rounded-2xl
                                shadow-2xl shadow-indigo-500/40
                                hover:from-indigo-700 hover:to-purple-700
                                transition-all transform hover:scale-105
                                disabled:opacity-70 disabled:cursor-not-allowed
                            "
                        >
                            {savingAll ? (
                                <>
                                    <Loader2 size={24} className="animate-spin"/>
                                    <span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
                                </>
                            ) : (
                                <>
                                    <Save size={24}/>
                                    <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</span>
                                    <span className="
                                        ml-2 px-2 py-1
                                        bg-white/20 rounded-full
                                        text-sm font-mono
                                    ">
                                        {changedRolesCount}
                                    </span>
                                </>
                            )}
                        </button>
                    </div>
                )}
            </div>


            <style>{`
                @keyframes fade-in {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes bounce-in {
                    0% { opacity: 0; transform: scale(0.8) translateY(20px); }
                    50% { transform: scale(1.05) translateY(-5px); }
                    100% { opacity: 1; transform: scale(1) translateY(0); }
                }
                .animate-fade-in {
                    animation: fade-in 0.3s ease-out;
                }
                .animate-bounce-in {
                    animation: bounce-in 0.4s ease-out;
                }
            `}</style>
        </div>
    );
});

export default AdminRightsPage;

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Structure/StructurePage.tsx
================================================================================

import React, { useContext, useEffect, useState } from "react";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import {
  Network,
  Users,
  Plus,
  ChevronRight,
  ChevronDown,
  Crown,
  UserCheck,
  UserPlus,
  Trash2,
  Layers,
  UserX,
  ArrowRight
} from "lucide-react";
import {
  fetchStructure,
  createSection,
  createTeam,
  assignSectionManager,
  assignTeamLead,
  addUserToTeam,
  removeUserFromTeam,
  fetchUnassignedUsers,
} from "src/api/structureApi";
import { fetchUsers } from "src/api/userApi";
import { Modal } from "src/components/Modal/Modal";
import { userGetModel } from "src/types/UserModel";
import toast from "react-hot-toast";

type Tab = "HIERARCHY" | "UNASSIGNED";

export const StructurePage: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { structureStore } = context;


  const [activeTab, setActiveTab] = useState<Tab>("HIERARCHY");
  const [expandedSections, setExpandedSections] = useState<number[]>([]);
  const [allUsers, setAllUsers] = useState<userGetModel[]>([]);
  const [unassignedUsers, setUnassignedUsers] = useState<userGetModel[]>([]);


  const [modalType, setModalType] = useState<"CREATE_SECTION" | "CREATE_TEAM" | "SELECT_USER" | null>(null);
  const [targetId, setTargetId] = useState<number | null>(null);
  const [actionType, setActionType] = useState<"MANAGER" | "LEAD" | "MEMBER" | null>(null);
  const [inputTitle, setInputTitle] = useState("");
  const [userSearch, setUserSearch] = useState("");


  const [assigningUserId, setAssigningUserId] = useState<number | null>(null);
  const [selectedSectionId, setSelectedSectionId] = useState<number | "">("");
  const [selectedTeamId, setSelectedTeamId] = useState<number | "">("");

  const loadData = async () => {
    try {
      const structData = await fetchStructure();
      structureStore.setSections(structData);

      const usersData = await fetchUsers();
      setAllUsers(usersData);


      try {
        const unassigned = await fetchUnassignedUsers();
        setUnassignedUsers(unassigned);
      } catch (e) {
        console.warn("API –¥–ª—è –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ –∏–ª–∏ –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É");
      }
    } catch (e) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
    }
  };

  useEffect(() => {
    void loadData();
  }, []);


  const handleCreateSection = async () => {
    if (!inputTitle.trim()) return;
    await createSection(inputTitle.trim());
    setInputTitle("");
    closeModal();
    await loadData();
    toast.success("–£—á–∞—Å—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω");
  };

  const handleCreateTeam = async () => {
    if (!targetId || !inputTitle.trim()) return;
    await createTeam(inputTitle.trim(), targetId);
    setInputTitle("");
    closeModal();
    await loadData();
    if (!expandedSections.includes(targetId)) {
      setExpandedSections((prev) => [...prev, targetId]);
    }
    toast.success("–ë—Ä–∏–≥–∞–¥–∞ —Å–æ–∑–¥–∞–Ω–∞");
  };

  const handleUserSelect = async (userId: number) => {
    if (!targetId || !actionType) return;

    try {
      if (actionType === "MANAGER") {
        await assignSectionManager(targetId, userId);
      } else if (actionType === "LEAD") {
        await assignTeamLead(targetId, userId);
      } else if (actionType === "MEMBER") {
        await addUserToTeam(targetId, userId);
      }
      toast.success("–£—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ");
    } catch (e) {
      toast.error("–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è");
    }

    closeModal();
    await loadData();
  };

  const handleRemoveMember = async (userId: number) => {
    if(!window.confirm("–£–±—Ä–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –±—Ä–∏–≥–∞–¥—ã?")) return;
    try {
      await removeUserFromTeam(userId);
      await loadData();
      toast.success("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω");
    } catch (e) {
      toast.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    }
  };


  const handleQuickAssign = async () => {
    if (!assigningUserId || !selectedTeamId) return;
    try {
        await addUserToTeam(Number(selectedTeamId), assigningUserId);
        toast.success("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω!");


        setAssigningUserId(null);
        setSelectedSectionId("");
        setSelectedTeamId("");

        await loadData();
    } catch (e) {
        toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏");
    }
  };


  const openUserSelect = (id: number, type: "MANAGER" | "LEAD" | "MEMBER") => {
    setTargetId(id);
    setActionType(type);
    setUserSearch("");
    setModalType("SELECT_USER");
  };

  const openCreateTeam = (sectionId: number) => {
    setTargetId(sectionId);
    setInputTitle("");
    setModalType("CREATE_TEAM");
  };

  const closeModal = () => {
    setModalType(null);
    setTargetId(null);
    setActionType(null);
  };

  const toggleSection = (id: number) => {
    setExpandedSections((prev) =>
      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id],
    );
  };

  const filteredUsers = allUsers.filter((user) => {
    const query = userSearch.trim().toLowerCase();
    if (!query) return true;
    return `${user.name} ${user.surname} ${user.login}`.toLowerCase().includes(query);
  });


  const availableTeamsForQuickAssign = structureStore.sections
      .find(s => s.id === Number(selectedSectionId))?.production_teams || [];

  return (
    <div className="min-h-screen bg-gray-50 p-8 pb-20">
      <div className="max-w-6xl mx-auto">


        <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center">
              <Network className="w-6 h-6 text-indigo-600" />
            </div>
            <div>
              <h1 className="text-2xl font-bold text-gray-800">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</h1>
              <p className="text-sm text-gray-500">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–µ–π –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º</p>
            </div>
          </div>

          <div className="bg-white p-1 rounded-xl border border-gray-200 shadow-sm flex gap-1">
              <button
                onClick={() => setActiveTab("HIERARCHY")}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'HIERARCHY' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}
              >
                  <Layers size={16}/> –ò–µ—Ä–∞—Ä—Ö–∏—è
              </button>
              <button
                onClick={() => setActiveTab("UNASSIGNED")}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'UNASSIGNED' ? 'bg-orange-50 text-orange-600' : 'text-gray-500 hover:text-gray-700'}`}
              >
                  <UserX size={16}/> –ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ
                  {unassignedUsers.length > 0 && (
                    <span className="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-1">
                        {unassignedUsers.length}
                    </span>
                  )}
              </button>
          </div>
        </div>


        {activeTab === "HIERARCHY" && (
            <div className="space-y-6 animate-fade-in">
                <div className="flex justify-end">
                    <button
                        type="button"
                        onClick={() => { setInputTitle(""); setModalType("CREATE_SECTION"); }}
                        className="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold shadow hover:bg-blue-700 transition"
                    >
                        <Plus size={18} /> –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–æ–∫
                    </button>
                </div>

                {structureStore.sections.map((section) => (
                    <div key={section.id} className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">

                        <div className="p-5 bg-gray-50 flex items-center justify-between gap-4 border-b border-gray-200 group">
                            <div className="flex items-center gap-4 cursor-pointer flex-1" onClick={() => toggleSection(section.id)}>
                                <button className="text-gray-400 hover:text-blue-600 transition">
                                    {expandedSections.includes(section.id) ? <ChevronDown size={20} /> : <ChevronRight size={20} />}
                                </button>
                                <div>
                                    <h2 className="font-semibold text-lg text-gray-800 flex items-center gap-2">{section.title}</h2>
                                    <div className="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                        <Crown size={14} className="text-yellow-600" /> –ù–∞—á–∞–ª—å–Ω–∏–∫:
                                        {section.manager ? (
                                            <span
                                                className="font-bold text-gray-700 underline decoration-dotted cursor-pointer hover:text-blue-600"
                                                onClick={(e) => { e.stopPropagation(); openUserSelect(section.id, "MANAGER"); }}
                                            >
                                                {section.manager.name} {section.manager.surname}
                                            </span>
                                        ) : (
                                            <button
                                                onClick={(e) => { e.stopPropagation(); openUserSelect(section.id, "MANAGER"); }}
                                                className="text-red-500 text-xs font-bold border border-red-200 bg-red-50 px-2 py-0.5 rounded hover:bg-red-100"
                                            >
                                                + –ù–ê–ó–ù–ê–ß–ò–¢–¨
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2 items-center">
                                <span className="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded-full border border-blue-100">–ë—Ä–∏–≥–∞–¥: {section.production_teams?.length || 0}</span>
                                <button onClick={() => openCreateTeam(section.id)} className="p-2 text-gray-500 hover:text-blue-600 bg-white rounded-lg border hover:border-blue-300 transition flex items-center gap-2 text-sm font-medium">
                                    <Plus size={16} /> –ë—Ä–∏–≥–∞–¥–∞
                                </button>
                            </div>
                        </div>


                        {expandedSections.includes(section.id) && (
                            <div className="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white">
                                {section.production_teams?.length > 0 ? (
                                    section.production_teams.map((team) => (
                                        <div key={team.id} className="border rounded-xl p-4 bg-gray-50/60 hover:bg-gray-50 transition shadow-sm">
                                            <div className="flex justify-between items-start mb-3 pb-2 border-b border-dashed border-gray-300">
                                                <div>
                                                    <h3 className="font-bold text-lg text-gray-700 flex items-center gap-2">
                                                        <Users size={18} className="text-blue-500" /> {team.title}
                                                    </h3>
                                                    <div className="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                                        <UserCheck size={12} /> –°—Ç–∞—Ä—à–∏–π:
                                                        {team.teamLead ? (
                                                            <button onClick={() => openUserSelect(team.id, "LEAD")} className="font-medium text-gray-800 cursor-pointer hover:text-blue-600 border-b border-dotted border-gray-400 ml-1">
                                                                {team.teamLead.name} {team.teamLead.surname}
                                                            </button>
                                                        ) : (
                                                            <button onClick={() => openUserSelect(team.id, "LEAD")} className="text-blue-600 font-bold hover:underline ml-1">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="space-y-2 min-h-[50px]">
                                                {team.users?.map((member) => (
                                                    <div key={member.id} className="flex items-center justify-between text-sm text-gray-600 bg-white border border-gray-200 p-2 rounded-lg shadow-sm">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs font-bold text-indigo-600">{member.name[0]}</div>
                                                            <span>{member.name} {member.surname}</span>
                                                        </div>
                                                        <button onClick={() => handleRemoveMember(member.id)} className="p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-50 transition" title="–£–±—Ä–∞—Ç—å –∏–∑ –±—Ä–∏–≥–∞–¥—ã">
                                                            <Trash2 size={14} />
                                                        </button>
                                                    </div>
                                                ))}
                                                <button onClick={() => openUserSelect(team.id, "MEMBER")} className="w-full py-2 text-xs font-bold text-blue-500 border border-dashed border-blue-300 rounded-lg hover:bg-blue-50 transition flex items-center justify-center gap-1">
                                                    <UserPlus size={14} /> –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="col-span-full text-center py-8 text-gray-400 border-2 border-dashed rounded-xl">–í —ç—Ç–æ–º —É—á–∞—Å—Ç–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–∏–≥–∞–¥. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</div>
                                )}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        )}


        {activeTab === "UNASSIGNED" && (
            <div className="animate-fade-in bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="p-6 border-b border-gray-100 bg-orange-50/30">
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <UserX className="text-orange-500"/> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±–µ–∑ –±—Ä–∏–≥–∞–¥—ã
                    </h2>
                    <p className="text-gray-500 text-sm mt-1">
                        –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –Ω–∏ –∫ –æ–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–π –µ–¥–∏–Ω–∏—Ü–µ.
                        –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∏—Ö –ø—Ä—è–º–æ –∑–¥–µ—Å—å.
                    </p>
                </div>

                <div className="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {unassignedUsers.length === 0 && (
                        <div className="col-span-full text-center py-20">
                            <div className="inline-flex p-4 bg-green-50 rounded-full mb-3"><UserCheck size={32} className="text-green-500"/></div>
                            <h3 className="text-lg font-bold text-gray-700">–í—Å–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã!</h3>
                            <p className="text-gray-400">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –±—Ä–∏–≥–∞–¥–µ.</p>
                        </div>
                    )}

                    {unassignedUsers.map(user => (
                        <div key={user.id} className={`p-4 border rounded-xl transition-all ${assigningUserId === user.id ? 'bg-indigo-50 border-indigo-300 ring-2 ring-indigo-100 shadow-md' : 'bg-white border-gray-200 shadow-sm hover:shadow-md'}`}>
                            <div className="flex justify-between items-center mb-3">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold overflow-hidden border border-gray-300">
                                        {user.img ? <img src={`${import.meta.env.VITE_API_URL}/${user.img}`} className="w-full h-full object-cover"/> : user.name[0]}
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">{user.name} {user.surname}</div>
                                        <div className="text-xs text-gray-500">{user.login} ‚Ä¢ {user.role}</div>
                                    </div>
                                </div>

                                {assigningUserId !== user.id && (
                                    <button
                                        onClick={() => { setAssigningUserId(user.id); setSelectedSectionId(""); setSelectedTeamId(""); }}
                                        className="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 text-xs font-bold rounded-lg hover:border-indigo-500 hover:text-indigo-600 transition"
                                    >
                                        –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                    </button>
                                )}
                            </div>


                            {assigningUserId === user.id && (
                                <div className="pt-3 border-t border-indigo-200 flex flex-col gap-2 animate-fade-in">
                                    <div className="space-y-2">
                                        <div>
                                            <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">–£—á–∞—Å—Ç–æ–∫</label>
                                            <select
                                                className="w-full p-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none"
                                                value={selectedSectionId}
                                                onChange={e => { setSelectedSectionId(Number(e.target.value)); setSelectedTeamId(""); }}
                                            >
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                                                {structureStore.sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">–ë—Ä–∏–≥–∞–¥–∞</label>
                                            <select
                                                className="w-full p-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none disabled:bg-gray-100 disabled:text-gray-400"
                                                value={selectedTeamId}
                                                onChange={e => setSelectedTeamId(Number(e.target.value))}
                                                disabled={!selectedSectionId}
                                            >
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                                                {availableTeamsForQuickAssign.map(t => <option key={t.id} value={t.id}>{t.title}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-2 mt-2">
                                        <button onClick={() => setAssigningUserId(null)} className="px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-200 rounded font-medium">–û—Ç–º–µ–Ω–∞</button>
                                        <button
                                            onClick={handleQuickAssign}
                                            disabled={!selectedTeamId}
                                            className="px-4 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-1 shadow-sm transition"
                                        >
                                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å <ArrowRight size={12}/>
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        )}


        <Modal isOpen={modalType === "CREATE_SECTION"} onClose={closeModal}>
          <div className="p-4">
            <h2 className="text-lg font-semibold mb-3">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</h2>
            <input
              className="w-full border rounded px-3 py-2 mb-3 text-sm"
              placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞"
              value={inputTitle}
              onChange={(e) => setInputTitle(e.target.value)}
            />
            <div className="flex justify-end gap-2">
              <button onClick={closeModal} className="px-3 py-1.5 text-sm rounded border border-gray-300 bg-white hover:bg-gray-50">–û—Ç–º–µ–Ω–∞</button>
              <button onClick={handleCreateSection} className="px-3 py-1.5 text-sm rounded bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300" disabled={!inputTitle.trim()}>–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </div>
        </Modal>

        <Modal isOpen={modalType === "CREATE_TEAM"} onClose={closeModal}>
          <div className="p-4">
            <h2 className="text-lg font-semibold mb-3">–ù–æ–≤–∞—è –±—Ä–∏–≥–∞–¥–∞</h2>
            <input
              className="w-full border rounded px-3 py-2 mb-3 text-sm"
              placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–∏–≥–∞–¥—ã"
              value={inputTitle}
              onChange={(e) => setInputTitle(e.target.value)}
            />
            <div className="flex justify-end gap-2">
              <button onClick={closeModal} className="px-3 py-1.5 text-sm rounded border border-gray-300 bg-white hover:bg-gray-50">–û—Ç–º–µ–Ω–∞</button>
              <button onClick={handleCreateTeam} className="px-3 py-1.5 text-sm rounded bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300" disabled={!inputTitle.trim()}>–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </div>
        </Modal>

        <Modal isOpen={modalType === "SELECT_USER"} onClose={closeModal}>
          <div className="p-4 h-[500px] flex flex-col">
            <h2 className="text-lg font-semibold mb-3">
              {actionType === "MANAGER" && "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ —É—á–∞—Å—Ç–∫–∞"}
              {actionType === "LEAD" && "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—à–µ–≥–æ –±—Ä–∏–≥–∞–¥—ã"}
              {actionType === "MEMBER" && "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ –±—Ä–∏–≥–∞–¥—É"}
            </h2>
            <input className="w-full p-2 border rounded mb-2 text-sm" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –ª–æ–≥–∏–Ω—É" value={userSearch} onChange={(e) => setUserSearch(e.target.value)} />
            <div className="overflow-y-auto flex-1 space-y-2 pr-1 custom-scrollbar">
              {filteredUsers.map((user) => (
                <button key={user.id} type="button" onClick={() => handleUserSelect(user.id)} className="w-full flex flex-col items-start px-3 py-2 border border-gray-200 rounded-lg bg-white hover:bg-blue-50 hover:border-blue-300 text-left transition">
                  <span className="font-medium text-gray-700">{user.name} {user.surname}</span>
                  <span className="text-xs text-gray-400">{user.login}</span>
                </button>
              ))}
            </div>
          </div>
        </Modal>

      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Warehouse/WarehousePage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  createSupply,
  fetchSupplies,
  createBox,
  fetchBoxes,
  exportLabelsCsv,
  BoxCreateDto,
  SupplyCreateDto,
} from "src/api/warehouseApi";

import { SupplyModel, InventoryBoxModel } from "src/types/WarehouseModels";
import { fetchStructure } from "src/api/structureApi";

type SectionShort = {
  id: number;
  title: string;
};

export const WarehousePage: React.FC = () => {
  const [supplies, setSupplies] = useState<SupplyModel[]>([]);
  const [selectedSupplyId, setSelectedSupplyId] = useState<number | null>(null);
  const [boxes, setBoxes] = useState<InventoryBoxModel[]>([]);
  const [sections, setSections] = useState<SectionShort[]>([]);


  const [supplier, setSupplier] = useState("");
  const [docNumber, setDocNumber] = useState("");
  const [expectedDate, setExpectedDate] = useState("");
  const [supplyComment, setSupplyComment] = useState("");


  const [sectionId, setSectionId] = useState<number | "">("");
  const [itemName, setItemName] = useState("");
  const [quantity, setQuantity] = useState<number>(1);
  const [unit, setUnit] = useState("—à—Ç");
  const [kitNumber, setKitNumber] = useState("");
  const [boxComment, setBoxComment] = useState("");

  const loadSupplies = async () => {
    const data = await fetchSupplies();
    setSupplies(data);
    if (!selectedSupplyId && data.length > 0) {
      setSelectedSupplyId(data[0].id);
    }
  };

  const loadBoxes = async (supplyId: number) => {
    const data = await fetchBoxes({ supplyId });
    setBoxes(data);
  };

  const loadSections = async () => {
    const structData = await fetchStructure();
    const shorts: SectionShort[] = structData.map((s: any) => ({
      id: s.id,
      title: s.title,
    }));
    setSections(shorts);
  };

  useEffect(() => {
    void loadSupplies();
    void loadSections();
  }, []);

  useEffect(() => {
    if (selectedSupplyId) {
      void loadBoxes(selectedSupplyId);
    } else {
      setBoxes([]);
    }
  }, [selectedSupplyId]);

  const handleCreateSupply = async () => {
    const payload: SupplyCreateDto = {
      supplier: supplier.trim() || undefined,
      docNumber: docNumber.trim() || undefined,
      expectedDate: expectedDate || undefined,
      comment: supplyComment.trim() || undefined,
    };

    const created = await createSupply(payload);
    setSupplier("");
    setDocNumber("");
    setExpectedDate("");
    setSupplyComment("");
    await loadSupplies();
    setSelectedSupplyId(created.id);
  };

  const handleCreateBox = async () => {
    if (!selectedSupplyId) {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é.");
      return;
    }
    if (!sectionId) {
      alert("–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–æ–∫.");
      return;
    }
    if (!itemName.trim()) {
      alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è / –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–≥–æ.");
      return;
    }

    const payload: BoxCreateDto = {
      supplyId: selectedSupplyId,
      sectionId: Number(sectionId),
      itemName: itemName.trim(),
      quantity: quantity || 1,
      unit: unit.trim() || "—à—Ç",
      kitNumber: kitNumber.trim() || undefined,
      comment: boxComment.trim() || undefined,
    };

    await createBox(payload);
    setItemName("");
    setQuantity(1);
    setUnit("—à—Ç");
    setKitNumber("");
    setBoxComment("");
    await loadBoxes(selectedSupplyId);
  };

  const handleExportCsv = async () => {
    if (!selectedSupplyId) {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤–∫—É.");
      return;
    }
    const blob = await exportLabelsCsv(selectedSupplyId);
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `kryptonit_labels_supply_${selectedSupplyId}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  };

  const currentSupply = supplies.find((s) => s.id === selectedSupplyId);

  return (
    <div className="p-6 bg-gray-100/80 min-h-screen">
      <h1 className="text-2xl font-bold text-gray-800 mb-4">
        –°–∫–ª–∞–¥ –∏ –ø—Ä–∏—ë–º–∫–∞
      </h1>
      <p className="text-gray-600 mb-6">
        –ó–¥–µ—Å—å –ø—Ä–∏–Ω–∏–º–∞–µ–º –∏–∑–¥–µ–ª–∏—è –∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ, —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ –∫–æ—Ä–æ–±–∫–∞–º –∏
        –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç—Ç–∏–∫–µ—Ç–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º ¬´–ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç¬ª.
      </p>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">

        <div className="xl:col-span-1 bg-white rounded-lg shadow p-4">
          <h2 className="text-lg font-semibold mb-3">–ü–æ—Å—Ç–∞–≤–∫–∏</h2>

          <div className="space-y-3 max-h-[420px] overflow-y-auto">
            {supplies.map((s) => (
              <button
                key={s.id}
                onClick={() => setSelectedSupplyId(s.id)}
                className={`w-full text-left border rounded-md p-3 mb-1 transition ${
                  selectedSupplyId === s.id
                    ? "bg-emerald-50 border-emerald-400"
                    : "bg-gray-50 hover:bg-gray-100 border-gray-200"
                }`}
              >
                <div className="text-sm text-gray-500">
                  #{s.id} ‚Ä¢ {new Date(s.createdAt).toLocaleDateString()}
                </div>
                <div className="font-semibold">
                  {s.supplier || "–ë–µ–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"}
                </div>
                <div className="text-sm text-gray-600">
                  –î–æ–∫—É–º–µ–Ω—Ç: {s.docNumber || "‚Äî"}
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  –°—Ç–∞—Ç—É—Å: {s.status}
                </div>
              </button>
            ))}

            {supplies.length === 0 && (
              <div className="text-sm text-gray-500">
                –ü–æ—Å—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é.
              </div>
            )}
          </div>

          <div className="mt-4 border-t pt-4">
            <h3 className="text-md font-semibold mb-2">–ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞</h3>
            <div className="space-y-2">
              <input
                className="w-full border rounded px-2 py-1 text-sm"
                placeholder="–ü–æ—Å—Ç–∞–≤—â–∏–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
                value={supplier}
                onChange={(e) => setSupplier(e.target.value)}
              />
              <input
                className="w-full border rounded px-2 py-1 text-sm"
                placeholder="–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞"
                value={docNumber}
                onChange={(e) => setDocNumber(e.target.value)}
              />
              <input
                type="date"
                className="w-full border rounded px-2 py-1 text-sm"
                value={expectedDate}
                onChange={(e) => setExpectedDate(e.target.value)}
              />
              <textarea
                className="w-full border rounded px-2 py-1 text-sm"
                placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                value={supplyComment}
                onChange={(e) => setSupplyComment(e.target.value)}
                rows={2}
              />
              <button
                onClick={handleCreateSupply}
                className="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold py-2 rounded"
              >
                –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É
              </button>
            </div>
          </div>
        </div>


        <div className="xl:col-span-2 space-y-6">
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="text-lg font-semibold mb-3">
              –ö–æ—Ä–æ–±–∫–∏ –≤ –ø–æ—Å—Ç–∞–≤–∫–µ{" "}
              {currentSupply
                ? `#${currentSupply.id} (${currentSupply.supplier || "‚Äî"})`
                : "‚Äî"}
            </h2>

            <div className="flex flex-col md:flex-row gap-4 mb-4">
              <div className="flex-1 space-y-2">
                <label className="text-sm text-gray-700">
                  –£—á–∞—Å—Ç–æ–∫, –∫—É–¥–∞ –ø–æ–π–¥—ë—Ç –∫–æ—Ä–æ–±–∫–∞
                </label>
                <select
                  className="w-full border rounded px-2 py-1 text-sm"
                  value={sectionId}
                  onChange={(e) =>
                    setSectionId(
                      e.target.value ? Number(e.target.value) : ""
                    )
                  }
                >
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                  {sections.map((s) => (
                    <option key={s.id} value={s.id}>
                      {s.title}
                    </option>
                  ))}
                </select>

                <label className="text-sm text-gray-700">
                  –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–±–µ–∑ ¬´–ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç¬ª)
                </label>
                <input
                  className="w-full border rounded px-2 py-1 text-sm"
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: FC 2.4 –ì–ì—Ü, –ø–∞—Ä—Ç–∏—è 01"
                  value={itemName}
                  onChange={(e) => setItemName(e.target.value)}
                />

                <div className="flex gap-2">
                  <div className="flex-1">
                    <label className="text-sm text-gray-700">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input
                      type="number"
                      min={1}
                      className="w-full border rounded px-2 py-1 text-sm"
                      value={quantity}
                      onChange={(e) =>
                        setQuantity(Number(e.target.value) || 1)
                      }
                    />
                  </div>
                  <div className="w-28">
                    <label className="text-sm text-gray-700">–ï–¥. –∏–∑–º</label>
                    <input
                      className="w-full border rounded px-2 py-1 text-sm"
                      value={unit}
                      onChange={(e) => setUnit(e.target.value)}
                    />
                  </div>
                </div>

                <label className="text-sm text-gray-700">
                  –ù–æ–º–µ—Ä –∫–æ–º–ø–ª–µ–∫—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                </label>
                <input
                  className="w-full border rounded px-2 py-1 text-sm"
                  placeholder="–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –≤–æ–∑—å–º—ë—Ç—Å—è –Ω–æ–º–µ—Ä –∫–æ—Ä–æ–±–∫–∏"
                  value={kitNumber}
                  onChange={(e) => setKitNumber(e.target.value)}
                />

                <label className="text-sm text-gray-700">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea
                  className="w-full border rounded px-2 py-1 text-sm"
                  rows={2}
                  value={boxComment}
                  onChange={(e) => setBoxComment(e.target.value)}
                />
              </div>

              <div className="w-full md:w-52 flex flex-col justify-between">
                <div className="border rounded-lg p-3 bg-gray-50 text-sm text-gray-700 mb-3">
                  <div className="font-semibold mb-1">
                    –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —ç—Ç–∏–∫–µ—Ç–∫–∏
                  </div>
                  <div className="text-xs text-gray-500">–ò–º—è:</div>
                  <div className="font-medium">
                    {sectionId && itemName
                      ? `–ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç ${itemName.trim()}${
                          sections.find((s) => s.id === sectionId)
                            ? ` / ${
                                sections.find((s) => s.id === sectionId)?.title
                              }`
                            : ""
                        }`
                      : "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ —É—á–∞—Å—Ç–æ–∫"}
                  </div>
                  <div className="mt-2 text-xs text-gray-500">
                    –ö–æ–ª-–≤–æ: {quantity} {unit}
                  </div>
                </div>

                <button
                  onClick={handleCreateBox}
                  className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold py-2 rounded"
                >
                  –î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–æ–±–∫—É
                </button>

                <button
                  onClick={handleExportCsv}
                  className="w-full mt-2 border border-emerald-500 text-emerald-700 hover:bg-emerald-50 text-sm font-semibold py-2 rounded"
                >
                  –í—ã–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏ (CSV –¥–ª—è Excel)
                </button>
              </div>
            </div>

            <div className="mt-4">
              <div className="overflow-x-auto max-h-[380px] border rounded-lg">
                <table className="min-w-full text-sm">
                  <thead className="bg-gray-100 sticky top-0">
                    <tr>
                      <th className="px-2 py-1 border-b">–ö–æ—Ä–æ–±–∫–∞</th>
                      <th className="px-2 py-1 border-b">–ò–º—è —ç—Ç–∏–∫–µ—Ç–∫–∏</th>
                      <th className="px-2 py-1 border-b">–£—á–∞—Å—Ç–æ–∫</th>
                      <th className="px-2 py-1 border-b">–ö–æ–ª-–≤–æ</th>
                      <th className="px-2 py-1 border-b">–®—Ç—Ä–∏—Ö/QR –∫–æ–¥</th>
                    </tr>
                  </thead>
                  <tbody>
                    {boxes.map((b) => (
                      <tr key={b.id} className="hover:bg-gray-50">
                        <td className="px-2 py-1 border-b">
                          {b.boxNumber || `#${b.id}`}
                        </td>
                        <td className="px-2 py-1 border-b">{b.displayName}</td>
                        <td className="px-2 py-1 border-b">
                          {b.section?.title || "‚Äî"}
                        </td>
                        <td className="px-2 py-1 border-b">
                          {b.quantity} {b.unit}
                        </td>
                        <td className="px-2 py-1 border-b">{b.labelCode}</td>
                      </tr>
                    ))}

                    {boxes.length === 0 && (
                      <tr>
                        <td
                          colSpan={5}
                          className="px-2 py-3 text-center text-gray-500"
                        >
                          –î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ—Å—Ç–∞–≤–∫–∏ –∫–æ—Ä–æ–±–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
              {boxes.length > 0 && (
                <div className="mt-2 text-xs text-gray-500">
                  –í—Å–µ–≥–æ –∫–æ—Ä–æ–±–æ–∫: {boxes.length}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default WarehousePage;

================================================================================
FILE: QMS-Client-main/src/pages/CAPA/CapaPage.tsx
================================================================================






import React, { useCallback, useEffect, useState } from "react";
import {
  CheckCircle2, Plus, Search, Loader2, ChevronRight, X,
  Clock, Zap
} from "lucide-react";
import { capaApi } from "src/api/qmsApi";
import type { CapaShort, CapaStatus } from "src/api/qmsApi";

const STATUS_FLOW: { key: CapaStatus; label: string; cls: string }[] = [
  { key: "INITIATED", label: "–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ", cls: "bg-gray-100 text-gray-700" },
  { key: "INVESTIGATING", label: "–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ", cls: "bg-blue-100 text-blue-700" },
  { key: "PLANNING", label: "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", cls: "bg-indigo-100 text-indigo-700" },
  { key: "PLAN_APPROVED", label: "–ü–ª–∞–Ω —É—Ç–≤–µ—Ä–∂–¥—ë–Ω", cls: "bg-purple-100 text-purple-700" },
  { key: "IMPLEMENTING", label: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ", cls: "bg-cyan-100 text-cyan-700" },
  { key: "VERIFYING", label: "–ü—Ä–æ–≤–µ—Ä–∫–∞", cls: "bg-amber-100 text-amber-700" },
  { key: "EFFECTIVE", label: "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ", cls: "bg-emerald-100 text-emerald-700" },
  { key: "INEFFECTIVE", label: "–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ", cls: "bg-red-100 text-red-700" },
  { key: "CLOSED", label: "–ó–∞–∫—Ä—ã—Ç–æ", cls: "bg-gray-100 text-gray-500" },
];

const PRIORITY_BADGE: Record<string, { label: string; cls: string }> = {
  URGENT: { label: "–°—Ä–æ—á–Ω–æ", cls: "bg-red-600 text-white" },
  HIGH: { label: "–í—ã—Å–æ–∫–∏–π", cls: "bg-orange-500 text-white" },
  MEDIUM: { label: "–°—Ä–µ–¥–Ω–∏–π", cls: "bg-blue-100 text-blue-700" },
  LOW: { label: "–ù–∏–∑–∫–∏–π", cls: "bg-gray-100 text-gray-600" },
};

const TYPE_LABEL: Record<string, string> = {
  CORRECTIVE: "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–µ–µ",
  PREVENTIVE: "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–µ–µ",
};

export const CapaPage: React.FC = () => {
  const [capas, setCapas] = useState<CapaShort[]>([]);
  const [count, setCount] = useState(0);
  const [page, setPage] = useState(1);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState("");
  const [typeFilter, setTypeFilter] = useState("");
  const [showCreate, setShowCreate] = useState(false);
  const [creating, setCreating] = useState(false);
  const [form, setForm] = useState({
    title: "", type: "CORRECTIVE", priority: "MEDIUM", description: "",
    nonconformityId: "", dueDate: "", effectivenessCheckDays: "90",
  });

  const load = useCallback(async () => {
    setLoading(true);
    try {
      const r = await capaApi.getAll({
        page, limit: 20, search: search || undefined,
        status: statusFilter || undefined, type: typeFilter || undefined,
      });
      setCapas(r.rows);
      setCount(r.count);
    } finally { setLoading(false); }
  }, [page, search, statusFilter, typeFilter]);

  useEffect(() => { load(); }, [load]);

  const handleCreate = async () => {
    if (!form.title) return;
    setCreating(true);
    try {
      await capaApi.create({
        ...form,
        nonconformityId: form.nonconformityId ? Number(form.nonconformityId) : undefined,
        effectivenessCheckDays: Number(form.effectivenessCheckDays) || 90,
      });
      setShowCreate(false);
      setForm({ title: "", type: "CORRECTIVE", priority: "MEDIUM", description: "", nonconformityId: "", dueDate: "", effectivenessCheckDays: "90" });
      load();
    } finally { setCreating(false); }
  };

  const getStatusStep = (status: CapaStatus) => STATUS_FLOW.findIndex(s => s.key === status);
  const totalPages = Math.max(1, Math.ceil(count / 20));

  return (
    <div className="px-4 py-6 max-w-[1600px] mx-auto">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-amber-500 to-yellow-600 rounded-xl flex items-center justify-center shadow-lg">
            <CheckCircle2 className="w-5 h-5 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">CAPA</h1>
            <p className="text-sm text-gray-500">ISO 13485 ¬ß8.5.2/¬ß8.5.3 ‚Äî –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</p>
          </div>
        </div>
        <button onClick={() => setShowCreate(true)}
          className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-amber-500 to-yellow-600 text-white rounded-xl shadow hover:shadow-lg transition text-sm font-medium">
          <Plus size={16} /> –°–æ–∑–¥–∞—Ç—å CAPA
        </button>
      </div>

      {}
      <div className="flex flex-wrap items-center gap-3 mb-4">
        <div className="relative flex-1 min-w-[200px] max-w-md">
          <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
          <input value={search} onChange={e => { setSearch(e.target.value); setPage(1); }}
            placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, –Ω–∞–∑–≤–∞–Ω–∏—é..."
            className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-amber-400" />
        </div>
        <select value={statusFilter} onChange={e => { setStatusFilter(e.target.value); setPage(1); }}
          className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          {STATUS_FLOW.map(s => <option key={s.key} value={s.key}>{s.label}</option>)}
        </select>
        <select value={typeFilter} onChange={e => { setTypeFilter(e.target.value); setPage(1); }}
          className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
          <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
          <option value="CORRECTIVE">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–µ–µ</option>
          <option value="PREVENTIVE">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–µ–µ</option>
        </select>
      </div>

      {}
      <div className="space-y-2">
        {loading ? (
          <div className="text-center py-16"><Loader2 className="w-6 h-6 animate-spin text-gray-400 mx-auto" /></div>
        ) : capas.length === 0 ? (
          <div className="text-center py-16 text-gray-400">CAPA –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        ) : capas.map(capa => {
          const st = STATUS_FLOW.find(s => s.key === capa.status) || STATUS_FLOW[0];
          const pr = PRIORITY_BADGE[capa.priority] || PRIORITY_BADGE.MEDIUM;
          const step = getStatusStep(capa.status);
          const overdue = capa.dueDate && new Date(capa.dueDate) < new Date() && !["CLOSED", "EFFECTIVE"].includes(capa.status);
          return (
            <div key={capa.id} onClick={() => window.location.href = `/capa/${capa.id}`}
              className={`bg-white border rounded-xl p-4 cursor-pointer hover:shadow-md transition ${
                overdue ? "border-red-300" : "border-gray-200"
              }`}>
              <div className="flex items-center gap-4">
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1 flex-wrap">
                    <span className="font-mono text-xs font-bold text-amber-700">{capa.number}</span>
                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${pr.cls}`}>{pr.label}</span>
                    <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${st.cls}`}>{st.label}</span>
                    <span className="px-2 py-0.5 rounded text-xs bg-gray-50 text-gray-600 border">
                      {TYPE_LABEL[capa.type] || capa.type}
                    </span>
                    {overdue && (
                      <span className="flex items-center gap-0.5 px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-700">
                        <Clock size={10} /> –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                      </span>
                    )}
                  </div>
                  <div className="font-medium text-gray-800 text-sm">{capa.title}</div>
                  {capa.nonconformity && (
                    <div className="text-xs text-gray-500 mt-1 flex items-center gap-1">
                      <Zap size={10} className="text-red-400" />
                      {capa.nonconformity.number}: {capa.nonconformity.title}
                    </div>
                  )}
                </div>

                {}
                <div className="flex-shrink-0 w-32 hidden md:block">
                  <div className="flex gap-0.5">
                    {STATUS_FLOW.slice(0, 7).map((s, i) => (
                      <div key={s.key} className={`h-1.5 flex-1 rounded-full ${
                        i <= step ? (capa.status === "INEFFECTIVE" ? "bg-red-400" : "bg-emerald-400") : "bg-gray-200"
                      }`} />
                    ))}
                  </div>
                  <div className="text-xs text-gray-400 mt-1 text-center">
                    {step + 1} / {STATUS_FLOW.length - 2}
                  </div>
                </div>

                {capa.assignedTo && (
                  <div className="text-xs text-gray-500 text-right flex-shrink-0 hidden lg:block">
                    <div className="text-gray-400">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</div>
                    <div>{capa.assignedTo.name} {capa.assignedTo.surname}</div>
                  </div>
                )}
                <ChevronRight size={16} className="text-gray-400 flex-shrink-0" />
              </div>
            </div>
          );
        })}
      </div>

      {}
      {totalPages > 1 && (
        <div className="flex items-center justify-between mt-4 text-sm text-gray-600">
          <span>–í—Å–µ–≥–æ: {count}</span>
          <div className="flex gap-1">
            {Array.from({ length: Math.min(totalPages, 10) }, (_, i) => i + 1).map(p => (
              <button key={p} onClick={() => setPage(p)}
                className={`px-3 py-1 rounded ${p === page ? "bg-amber-600 text-white" : "bg-gray-100 hover:bg-gray-200"}`}>{p}</button>
            ))}
          </div>
        </div>
      )}

      {}
      {showCreate && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold text-gray-800">–°–æ–∑–¥–∞–Ω–∏–µ CAPA</h2>
              <button onClick={() => setShowCreate(false)}><X size={20} className="text-gray-400" /></button>
            </div>
            <div className="space-y-3">
              <div>
                <label className="text-xs text-gray-600 font-medium">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                <input value={form.title} onChange={e => setForm(f => ({ ...f, title: e.target.value }))}
                  className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" />
              </div>
              <div className="grid grid-cols-3 gap-3">
                <div>
                  <label className="text-xs text-gray-600 font-medium">–¢–∏–ø</label>
                  <select value={form.type} onChange={e => setForm(f => ({ ...f, type: e.target.value }))}
                    className="w-full mt-1 px-3 py-2 border rounded-lg text-sm bg-white">
                    <option value="CORRECTIVE">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–µ–µ</option>
                    <option value="PREVENTIVE">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–µ–µ</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs text-gray-600 font-medium">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                  <select value={form.priority} onChange={e => setForm(f => ({ ...f, priority: e.target.value }))}
                    className="w-full mt-1 px-3 py-2 border rounded-lg text-sm bg-white">
                    {Object.entries(PRIORITY_BADGE).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-gray-600 font-medium">–°—Ä–æ–∫</label>
                  <input type="date" value={form.dueDate} onChange={e => setForm(f => ({ ...f, dueDate: e.target.value }))}
                    className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" />
                </div>
              </div>
              <div>
                <label className="text-xs text-gray-600 font-medium">NC –Ω–æ–º–µ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
                <input value={form.nonconformityId} onChange={e => setForm(f => ({ ...f, nonconformityId: e.target.value }))}
                  className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" placeholder="ID –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è" />
              </div>
              <div>
                <label className="text-xs text-gray-600 font-medium">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea value={form.description} onChange={e => setForm(f => ({ ...f, description: e.target.value }))}
                  className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" rows={3} />
              </div>
              <div>
                <label className="text-xs text-gray-600 font-medium">–ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ (–¥–Ω–µ–π)</label>
                <input type="number" value={form.effectivenessCheckDays} onChange={e => setForm(f => ({ ...f, effectivenessCheckDays: e.target.value }))}
                  className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" />
              </div>
            </div>
            <div className="flex justify-end gap-2 mt-4">
              <button onClick={() => setShowCreate(false)} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
              <button onClick={handleCreate} disabled={creating || !form.title}
                className="px-4 py-2 text-sm bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50 flex items-center gap-1">
                {creating && <Loader2 size={14} className="animate-spin" />} –°–æ–∑–¥–∞—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Documents/DocumentsPage.tsx
================================================================================






import React, { useCallback, useEffect, useState } from "react";
import {
  FileText, Plus, Search, ChevronRight,
  AlertTriangle, Loader2, X
} from "lucide-react";
import { documentsApi } from "src/api/qmsApi";
import type { DocumentShort, DocType } from "src/api/qmsApi";

const STATUS_BADGE: Record<string, { label: string; cls: string }> = {
  DRAFT: { label: "–ß–µ—Ä–Ω–æ–≤–∏–∫", cls: "bg-gray-100 text-gray-700" },
  REVIEW: { label: "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ", cls: "bg-blue-100 text-blue-700" },
  APPROVED: { label: "–£—Ç–≤–µ—Ä–∂–¥—ë–Ω", cls: "bg-purple-100 text-purple-700" },
  EFFECTIVE: { label: "–î–µ–π—Å—Ç–≤—É—é—â–∏–π", cls: "bg-emerald-100 text-emerald-700" },
  REVISION: { label: "–ü–µ—Ä–µ—Å–º–æ—Ç—Ä", cls: "bg-amber-100 text-amber-700" },
  OBSOLETE: { label: "–£—Å—Ç–∞—Ä–µ–ª", cls: "bg-gray-100 text-gray-500" },
  CANCELLED: { label: "–û—Ç–º–µ–Ω—ë–Ω", cls: "bg-red-100 text-red-700" },
};

const TYPE_LABELS: Record<string, string> = {
  POLICY: "–ü–æ–ª–∏—Ç–∏–∫–∞", MANUAL: "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ", PROCEDURE: "–°–¢–û",
  WORK_INSTRUCTION: "–†–∞–±–æ—á–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", FORM: "–§–æ—Ä–º–∞", RECORD: "–ó–∞–ø–∏—Å—å",
  SPECIFICATION: "–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è", PLAN: "–ü–ª–∞–Ω", EXTERNAL: "–í–Ω–µ—à–Ω–∏–π", OTHER: "–ü—Ä–æ—á–µ–µ",
};

export const DocumentsPage: React.FC = () => {
  const [docs, setDocs] = useState<DocumentShort[]>([]);
  const [count, setCount] = useState(0);
  const [page, setPage] = useState(1);
  const [loading, setLoading] = useState(true);

  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState<string>("");
  const [typeFilter, setTypeFilter] = useState<string>("");

  const [showCreate, setShowCreate] = useState(false);
  const [createData, setCreateData] = useState({ title: "", type: "PROCEDURE" as DocType, category: "", description: "" });
  const [creating, setCreating] = useState(false);

  const load = useCallback(async () => {
    setLoading(true);
    try {
      const r = await documentsApi.getAll({
        page, limit: 20, search: search || undefined,
        status: statusFilter || undefined, type: typeFilter || undefined,
      });
      setDocs(r.rows);
      setCount(r.count);
    } finally { setLoading(false); }
  }, [page, search, statusFilter, typeFilter]);

  useEffect(() => { load(); }, [load]);

  const handleCreate = async () => {
    if (!createData.title) return;
    setCreating(true);
    try {
      await documentsApi.create(createData);
      setShowCreate(false);
      setCreateData({ title: "", type: "PROCEDURE", category: "", description: "" });
      load();
    } finally { setCreating(false); }
  };

  const totalPages = Math.max(1, Math.ceil(count / 20));

  return (
    <div className="px-4 py-6 max-w-[1600px] mx-auto">
      {}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center shadow-lg">
            <FileText className="w-5 h-5 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">–î–æ–∫—É–º–µ–Ω—Ç—ã –°–ú–ö</h1>
            <p className="text-sm text-gray-500">ISO 13485 ¬ß4.2.4 ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π</p>
          </div>
        </div>
        <button onClick={() => setShowCreate(true)}
          className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-xl shadow hover:shadow-lg transition text-sm font-medium">
          <Plus size={16} /> –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
        </button>
      </div>

      {}
      <div className="flex flex-wrap items-center gap-3 mb-4">
        <div className="relative flex-1 min-w-[200px] max-w-md">
          <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
          <input value={search} onChange={e => { setSearch(e.target.value); setPage(1); }}
            placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É, –Ω–∞–∑–≤–∞–Ω–∏—é..."
            className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-400" />
        </div>
        <select value={statusFilter} onChange={e => { setStatusFilter(e.target.value); setPage(1); }}
          className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          {Object.entries(STATUS_BADGE).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
        </select>
        <select value={typeFilter} onChange={e => { setTypeFilter(e.target.value); setPage(1); }}
          className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
          <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
          {Object.entries(TYPE_LABELS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
        </select>
      </div>

      {}
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden">
        <table className="w-full text-sm">
          <thead className="bg-gray-50 border-b">
            <tr>
              <th className="text-left px-4 py-3 font-medium text-gray-600">–ö–æ–¥</th>
              <th className="text-left px-4 py-3 font-medium text-gray-600">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th className="text-left px-4 py-3 font-medium text-gray-600">–¢–∏–ø</th>
              <th className="text-left px-4 py-3 font-medium text-gray-600">–°—Ç–∞—Ç—É—Å</th>
              <th className="text-left px-4 py-3 font-medium text-gray-600">–í–µ—Ä—Å–∏—è</th>
              <th className="text-left px-4 py-3 font-medium text-gray-600">–í–ª–∞–¥–µ–ª–µ—Ü</th>
              <th className="text-left px-4 py-3 font-medium text-gray-600">–ü–µ—Ä–µ—Å–º–æ—Ç—Ä</th>
              <th className="w-8"></th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr><td colSpan={8} className="text-center py-12"><Loader2 className="w-6 h-6 animate-spin text-gray-400 mx-auto" /></td></tr>
            ) : docs.length === 0 ? (
              <tr><td colSpan={8} className="text-center py-12 text-gray-400">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>
            ) : docs.map(doc => {
              const sb = STATUS_BADGE[doc.status] || STATUS_BADGE.DRAFT;
              const overdue = doc.nextReviewDate && new Date(doc.nextReviewDate) < new Date();
              return (
                <tr key={doc.id} className="border-b last:border-0 hover:bg-gray-50 cursor-pointer"
                  onClick={() => window.location.href = `/documents/${doc.id}`}>
                  <td className="px-4 py-3 font-mono text-xs text-blue-600 font-bold">{doc.code}</td>
                  <td className="px-4 py-3 font-medium text-gray-800 max-w-xs truncate">{doc.title}</td>
                  <td className="px-4 py-3 text-gray-600">{TYPE_LABELS[doc.type] || doc.type}</td>
                  <td className="px-4 py-3">
                    <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${sb.cls}`}>{sb.label}</span>
                  </td>
                  <td className="px-4 py-3 text-gray-600">{doc.currentVersion?.version || "‚Äî"}</td>
                  <td className="px-4 py-3 text-gray-600 text-xs">
                    {doc.owner ? `${doc.owner.name} ${doc.owner.surname}` : "‚Äî"}
                  </td>
                  <td className="px-4 py-3">
                    {doc.nextReviewDate ? (
                      <span className={`flex items-center gap-1 text-xs ${overdue ? "text-red-600 font-bold" : "text-gray-500"}`}>
                        {overdue && <AlertTriangle size={12} />}
                        {new Date(doc.nextReviewDate).toLocaleDateString("ru-RU")}
                      </span>
                    ) : "‚Äî"}
                  </td>
                  <td className="px-4 py-3"><ChevronRight size={14} className="text-gray-400" /></td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {}
      {totalPages > 1 && (
        <div className="flex items-center justify-between mt-4 text-sm text-gray-600">
          <span>–í—Å–µ–≥–æ: {count}</span>
          <div className="flex gap-1">
            {Array.from({ length: Math.min(totalPages, 10) }, (_, i) => i + 1).map(p => (
              <button key={p} onClick={() => setPage(p)}
                className={`px-3 py-1 rounded ${p === page ? "bg-blue-600 text-white" : "bg-gray-100 hover:bg-gray-200"}`}>{p}</button>
            ))}
          </div>
        </div>
      )}

      {}
      {showCreate && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold text-gray-800">–ù–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç</h2>
              <button onClick={() => setShowCreate(false)}><X size={20} className="text-gray-400" /></button>
            </div>
            <div className="space-y-3">
              <div>
                <label className="text-xs text-gray-600 font-medium">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                <input value={createData.title} onChange={e => setCreateData(d => ({ ...d, title: e.target.value }))}
                  className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" placeholder="–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É" />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-xs text-gray-600 font-medium">–¢–∏–ø *</label>
                  <select value={createData.type} onChange={e => setCreateData(d => ({ ...d, type: e.target.value as DocType }))}
                    className="w-full mt-1 px-3 py-2 border rounded-lg text-sm bg-white">
                    {Object.entries(TYPE_LABELS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-gray-600 font-medium">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                  <input value={createData.category} onChange={e => setCreateData(d => ({ ...d, category: e.target.value }))}
                    className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" placeholder="–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ" />
                </div>
              </div>
              <div>
                <label className="text-xs text-gray-600 font-medium">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea value={createData.description} onChange={e => setCreateData(d => ({ ...d, description: e.target.value }))}
                  className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" rows={3} />
              </div>
            </div>
            <div className="flex justify-end gap-2 mt-4">
              <button onClick={() => setShowCreate(false)} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
              <button onClick={handleCreate} disabled={creating || !createData.title}
                className="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-1">
                {creating && <Loader2 size={14} className="animate-spin" />} –°–æ–∑–¥–∞—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Login/Login.tsx
================================================================================

import { useContext, useState } from "react";
import { NavLink, useNavigate } from "react-router-dom";
import { login } from "src/api/userApi";
import { Context } from "src/main";
import { REGISTRATION_ROUTE, SELECT_PC_ROUTE } from "src/utils/consts";

export const Login: React.FC = () => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { user } = context;

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const navigate = useNavigate();

  const [loginName, setLoginName] = useState("");
  const [password, setPassword] = useState("");

  const signIN = async (event: React.FormEvent) => {
    event.preventDefault();

    try {
      const currentUser = await login(loginName, password);

      user.setUser(currentUser);
      user.setIsAuth(true);

      console.log(user.user);
      setSuccessMessage("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ");
      setErrorMessage("");
      localStorage.removeItem("pcID");
      localStorage.removeItem("sessionID");

      setTimeout(() => {
        navigate(SELECT_PC_ROUTE);
        window.location.reload();
      }, 1000);
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-yellow-200 to-green-300">
      <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
        <h2 className="text-2xl font-bold mb-4">
          –í–æ–π—Ç–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫–∫–∞—É–Ω—Ç
        </h2>
        <form>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">
              –õ–æ–≥–∏–Ω
            </label>
            <input
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
              value={loginName}
              onChange={(e) => setLoginName(e.target.value)}
            />
          </div>
          <div className="mb-6">
            <label
              className="block text-gray-700 text-sm font-bold mb-2"
              htmlFor="password"
            >
              –ü–∞—Ä–æ–ª—å
            </label>
            <input
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
              value={password}
              type="password"
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>
          <div className="flex items-center justify-between">
            <button
              onClick={signIN}
              type="submit"
              className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
            >
              –í–æ–π—Ç–∏
            </button>

            <NavLink
              to={REGISTRATION_ROUTE}
              className="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800"
            >
              –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
            </NavLink>
          </div>
        </form>
        {successMessage && (
          <div className="mt-4 text-green-500 font-medium">
            {successMessage}
          </div>
        )}
        {errorMessage && (
          <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Login/Registration.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useState } from "react";
import { useNavigate } from "react-router-dom";
import { registration } from "src/api/userApi";
import { Context } from "src/main";
import { SELECT_PC_ROUTE } from "src/utils/consts";

export const Registration: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { user } = context;

  const [successMessage, setSuccessMessage] = useState("");
  const [errorMessage, setErrorMessage] = useState("");

  const navigate = useNavigate();

  const [login, setLogin] = useState("");
  const [password, setPassword] = useState("");
  const [name, setName] = useState("");
  const [surname, setSurname] = useState("");

  const signUP = async (event: React.FormEvent) => {
    event.preventDefault();
    try {
      const currentUser = await registration(login, password, name, surname);
      user.setUser(currentUser);
      user.setIsAuth(true);
      setSuccessMessage("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!");
      setErrorMessage("");
      localStorage.removeItem("pcID");
      localStorage.removeItem("sessionID");
      setTimeout(() => {
        navigate(SELECT_PC_ROUTE);
        window.location.reload();

      }, 2000);
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-yellow-200 to-green-300">
      <div className="max-w-md w-full p-6 bg-white shadow-md rounded-lg">
        <h2 className="text-2xl font-semibold mb-4">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

        <form>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">
              –õ–æ–≥–∏–Ω
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={login}
              onChange={(e) => setLogin(e.target.value)}
            />
          </div>

          <div className="mb-4">
            <label
              htmlFor="password"
              className="block text-sm font-medium text-gray-700"
            >
              –ü–∞—Ä–æ–ª—å
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={password}
              type="password"
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">
              –ò–º—è
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={name}
              onChange={(e) => setName(e.target.value)}
            />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">
              –§–∞–º–∏–ª–∏—è
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={surname}
              onChange={(e) => setSurname(e.target.value)}
            />
          </div>

          <div className="mb-4">
            <button
              onClick={signUP}
              type="submit"
              className="w-full bg-blue-500 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring focus:ring-blue-300"
            >
              –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
            </button>
          </div>
        </form>
        {successMessage && (
          <div className="mt-4 text-green-500 font-medium">
            {successMessage}
          </div>
        )}
        {errorMessage && (
          <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
        )}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Nonconformity/NonconformityPage.tsx
================================================================================






import React, { useCallback, useEffect, useState } from "react";
import {
  AlertTriangle, Plus, Search, Loader2, ChevronRight, X,
  AlertCircle, Clock
} from "lucide-react";
import { ncApi } from "src/api/qmsApi";
import type { NcShort, NcClassification } from "src/api/qmsApi";

const CLS_BADGE: Record<string, { label: string; cls: string }> = {
  CRITICAL: { label: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ", cls: "bg-red-100 text-red-700 border-red-200" },
  MAJOR: { label: "–°–µ—Ä—å—ë–∑–Ω–æ–µ", cls: "bg-amber-100 text-amber-700 border-amber-200" },
  MINOR: { label: "–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ", cls: "bg-gray-100 text-gray-600 border-gray-200" },
};

const STATUS_BADGE: Record<string, { label: string; cls: string }> = {
  OPEN: { label: "–û—Ç–∫—Ä—ã—Ç–æ", cls: "bg-red-100 text-red-700" },
  INVESTIGATING: { label: "–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ", cls: "bg-blue-100 text-blue-700" },
  DISPOSITION: { label: "–†–µ—à–µ–Ω–∏–µ", cls: "bg-purple-100 text-purple-700" },
  IMPLEMENTING: { label: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ", cls: "bg-indigo-100 text-indigo-700" },
  VERIFICATION: { label: "–ü—Ä–æ–≤–µ—Ä–∫–∞", cls: "bg-amber-100 text-amber-700" },
  CLOSED: { label: "–ó–∞–∫—Ä—ã—Ç–æ", cls: "bg-emerald-100 text-emerald-700" },
  REOPENED: { label: "–ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–æ", cls: "bg-orange-100 text-orange-700" },
};

const SOURCE_LABELS: Record<string, string> = {
  INCOMING_INSPECTION: "–í—Ö–æ–¥–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
  IN_PROCESS: "–í –ø—Ä–æ—Ü–µ—Å—Å–µ",
  FINAL_INSPECTION: "–í—ã—Ö–æ–¥–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
  CUSTOMER_COMPLAINT: "–ñ–∞–ª–æ–±–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è",
  INTERNAL_AUDIT: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∞—É–¥–∏—Ç",
  EXTERNAL_AUDIT: "–í–Ω–µ—à–Ω–∏–π –∞—É–¥–∏—Ç",
  SUPPLIER: "–ü–æ—Å—Ç–∞–≤—â–∏–∫",
  FIELD_RETURN: "–í–æ–∑–≤—Ä–∞—Ç",
  OTHER: "–ü—Ä–æ—á–µ–µ",
};

export const NonconformityPage: React.FC = () => {
  const [ncs, setNcs] = useState<NcShort[]>([]);
  const [count, setCount] = useState(0);
  const [page, setPage] = useState(1);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState("");
  const [classFilter, setClassFilter] = useState("");
  const [showCreate, setShowCreate] = useState(false);
  const [creating, setCreating] = useState(false);
  const [form, setForm] = useState({
    title: "", description: "", source: "IN_PROCESS",
    classification: "MINOR" as NcClassification,
    productType: "", lotNumber: "", immediateAction: "",
  });

  const load = useCallback(async () => {
    setLoading(true);
    try {
      const r = await ncApi.getAll({
        page, limit: 20, search: search || undefined,
        status: statusFilter || undefined, classification: classFilter || undefined,
      });
      setNcs(r.rows);
      setCount(r.count);
    } finally { setLoading(false); }
  }, [page, search, statusFilter, classFilter]);

  useEffect(() => { load(); }, [load]);

  const handleCreate = async () => {
    if (!form.title || !form.description) return;
    setCreating(true);
    try {
      await ncApi.create(form);
      setShowCreate(false);
      setForm({ title: "", description: "", source: "IN_PROCESS", classification: "MINOR", productType: "", lotNumber: "", immediateAction: "" });
      load();
    } finally { setCreating(false); }
  };

  const totalPages = Math.max(1, Math.ceil(count / 20));

  return (
    <div className="px-4 py-6 max-w-[1600px] mx-auto">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-red-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg">
            <AlertTriangle className="w-5 h-5 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h1>
            <p className="text-sm text-gray-500">ISO 13485 ¬ß8.3 ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –ø—Ä–æ–¥—É–∫—Ü–∏–µ–π</p>
          </div>
        </div>
        <button onClick={() => setShowCreate(true)}
          className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-xl shadow hover:shadow-lg transition text-sm font-medium">
          <Plus size={16} /> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å NC
        </button>
      </div>

      {}
      <div className="flex flex-wrap items-center gap-3 mb-4">
        <div className="relative flex-1 min-w-[200px] max-w-md">
          <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
          <input value={search} onChange={e => { setSearch(e.target.value); setPage(1); }}
            placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, –Ω–∞–∑–≤–∞–Ω–∏—é..."
            className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-red-400" />
        </div>
        <select value={statusFilter} onChange={e => { setStatusFilter(e.target.value); setPage(1); }}
          className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          {Object.entries(STATUS_BADGE).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
        </select>
        <select value={classFilter} onChange={e => { setClassFilter(e.target.value); setPage(1); }}
          className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white">
          <option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>
          {Object.entries(CLS_BADGE).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
        </select>
      </div>

      {}
      <div className="space-y-2">
        {loading ? (
          <div className="text-center py-16"><Loader2 className="w-6 h-6 animate-spin text-gray-400 mx-auto" /></div>
        ) : ncs.length === 0 ? (
          <div className="text-center py-16 text-gray-400">–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        ) : ncs.map(nc => {
          const cls = CLS_BADGE[nc.classification] || CLS_BADGE.MINOR;
          const st = STATUS_BADGE[nc.status] || STATUS_BADGE.OPEN;
          const overdue = nc.dueDate && new Date(nc.dueDate) < new Date() && nc.status !== "CLOSED";
          return (
            <div key={nc.id} onClick={() => window.location.href = `/nonconformity/${nc.id}`}
              className={`bg-white border rounded-xl p-4 flex items-center gap-4 cursor-pointer hover:shadow-md transition ${
                overdue ? "border-red-300 bg-red-50/30" : "border-gray-200"
              }`}>
              <div className={`w-1 h-12 rounded-full flex-shrink-0 ${
                nc.classification === "CRITICAL" ? "bg-red-500" : nc.classification === "MAJOR" ? "bg-amber-400" : "bg-gray-300"
              }`} />
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 mb-1">
                  <span className="font-mono text-xs font-bold text-red-600">{nc.number}</span>
                  <span className={`px-2 py-0.5 rounded-full text-xs font-medium border ${cls.cls}`}>{cls.label}</span>
                  <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${st.cls}`}>{st.label}</span>
                  {overdue && (
                    <span className="flex items-center gap-0.5 px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-700">
                      <Clock size={10} /> –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                    </span>
                  )}
                </div>
                <div className="font-medium text-gray-800 text-sm truncate">{nc.title}</div>
                <div className="text-xs text-gray-500 mt-0.5">
                  {SOURCE_LABELS[nc.source] || nc.source} ‚Ä¢{" "}
                  {new Date(nc.detectedAt).toLocaleDateString("ru-RU")} ‚Ä¢{" "}
                  {nc.reportedBy ? `${nc.reportedBy.name} ${nc.reportedBy.surname}` : ""}
                </div>
              </div>
              {nc.assignedTo && (
                <div className="text-xs text-gray-500 text-right flex-shrink-0">
                  <div className="text-gray-400">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</div>
                  <div>{nc.assignedTo.name} {nc.assignedTo.surname}</div>
                </div>
              )}
              <ChevronRight size={16} className="text-gray-400 flex-shrink-0" />
            </div>
          );
        })}
      </div>

      {}
      {totalPages > 1 && (
        <div className="flex items-center justify-between mt-4 text-sm text-gray-600">
          <span>–í—Å–µ–≥–æ: {count}</span>
          <div className="flex gap-1">
            {Array.from({ length: Math.min(totalPages, 10) }, (_, i) => i + 1).map(p => (
              <button key={p} onClick={() => setPage(p)}
                className={`px-3 py-1 rounded ${p === page ? "bg-red-600 text-white" : "bg-gray-100 hover:bg-gray-200"}`}>{p}</button>
            ))}
          </div>
        </div>
      )}

      {}
      {showCreate && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6 max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold text-gray-800">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h2>
              <button onClick={() => setShowCreate(false)}><X size={20} className="text-gray-400" /></button>
            </div>
            <div className="space-y-3">
              <div>
                <label className="text-xs text-gray-600 font-medium">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                <input value={form.title} onChange={e => setForm(f => ({ ...f, title: e.target.value }))}
                  className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ NC" />
              </div>
              <div>
                <label className="text-xs text-gray-600 font-medium">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ *</label>
                <textarea value={form.description} onChange={e => setForm(f => ({ ...f, description: e.target.value }))}
                  className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" rows={3} placeholder="–ß—Ç–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, –≥–¥–µ, –ø—Ä–∏ –∫–∞–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö..." />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-xs text-gray-600 font-medium">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                  <select value={form.source} onChange={e => setForm(f => ({ ...f, source: e.target.value }))}
                    className="w-full mt-1 px-3 py-2 border rounded-lg text-sm bg-white">
                    {Object.entries(SOURCE_LABELS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-gray-600 font-medium">–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</label>
                  <select value={form.classification} onChange={e => setForm(f => ({ ...f, classification: e.target.value as NcClassification }))}
                    className="w-full mt-1 px-3 py-2 border rounded-lg text-sm bg-white">
                    {Object.entries(CLS_BADGE).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                  </select>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-xs text-gray-600 font-medium">–¢–∏–ø –ø—Ä–æ–¥—É–∫—Ü–∏–∏</label>
                  <input value={form.productType} onChange={e => setForm(f => ({ ...f, productType: e.target.value }))}
                    className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" />
                </div>
                <div>
                  <label className="text-xs text-gray-600 font-medium">–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏</label>
                  <input value={form.lotNumber} onChange={e => setForm(f => ({ ...f, lotNumber: e.target.value }))}
                    className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" />
                </div>
              </div>
              <div>
                <label className="text-xs text-gray-600 font-medium">–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ</label>
                <textarea value={form.immediateAction} onChange={e => setForm(f => ({ ...f, immediateAction: e.target.value }))}
                  className="w-full mt-1 px-3 py-2 border rounded-lg text-sm" rows={2} placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ —Å—Ä–∞–∑—É (–∏–∑–æ–ª—è—Ü–∏—è, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —Ç.–¥.)" />
              </div>
              {form.classification === "CRITICAL" && (
                <div className="flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-xs text-red-700">
                  <AlertCircle size={14} />
                  –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö NC –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è CAPA
                </div>
              )}
            </div>
            <div className="flex justify-end gap-2 mt-4">
              <button onClick={() => setShowCreate(false)} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
              <button onClick={handleCreate} disabled={creating || !form.title || !form.description}
                className="px-4 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 flex items-center gap-1">
                {creating && <Loader2 size={14} className="animate-spin" />} –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/PCs/OnePC.tsx
================================================================================

import clsx from "clsx";

interface OnePCProps {
  active: boolean;
  onClick: () => void;
  PCname: string;
  IP: string;
  userName: string;
  userSurname: string;
}

export const OnePC: React.FC<OnePCProps> = ({
  active,
  onClick,
  PCname,
  IP,
  userName,
  userSurname
}) => {
  return (
    <div className="flex justify-center items-center">
      <div
        className={clsx(
          "p-3 rounded-lg shadow-md mb-2 border-l-4 transition duration-200 w-1/3",
          active
            ? "bg-red-500 text-white border-red-700 pointer-events-none opacity-70"
            : "bg-gray-100 text-gray-800 border-emerald-500 hover:bg-gray-400 cursor-pointer"
        )}
        onClick={!active ? onClick : undefined}
      >
        <p className="text-lg font-semibold">{PCname}</p>
        <p className="text-sm">{IP}</p>

        {active && (
          <p className="text-xs font-semibold mt-2 bg-red-700 px-2 py-1 rounded-md text-center">
            –ü–ö –∑–∞–Ω—è—Ç {userName} {userSurname}
          </p>
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/PCs/SelectPC.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect, useMemo, useState } from "react";
import { Context } from "src/main";
import {
  fetchPC,
  fetchSession,
  fetchUsers,
  setSessionOnline,
} from "src/api/userApi";
import { pcModelFull } from "src/types/PCModel";
import { SessionModelFull } from "src/types/SessionModel";
import { useNavigate } from "react-router-dom";
import { START_ROUTE } from "src/utils/consts";
import { userGetModel } from "src/types/UserModel";
import { Monitor, Search, MapPin, User, Lock, Wifi, Laptop } from "lucide-react";

export const SelectPC: React.FC = observer(() => {
  const context = useContext(Context);
  const navigate = useNavigate();
  const [searchTerm, setSearchTerm] = useState("");

  if (!context) throw new Error("Context required");
  const { user } = context;

  const [pcs, setPcs] = useState<pcModelFull[]>([]);
  const [sessions, setSessions] = useState<SessionModelFull[]>([]);
  const [users, setUsers] = useState<userGetModel[]>([]);

  useEffect(() => {

    if (!user.isAuth) return;

    const loadData = async () => {

      try {
        const [pcsData, sessionsData] = await Promise.all([fetchPC(), fetchSession()]);
        setPcs(pcsData);
        setSessions(sessionsData);
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –ü–ö:", error);
      }


      try {
        const usersData = await fetchUsers();
        setUsers(usersData);
      } catch (error) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–æ–∑–º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –ø—Ä–∞–≤–∞):", error);
      }
    };

    loadData();
  }, [user.isAuth]);


  const getActiveSessionInfo = (pcId: number) => {
    const session = sessions.find(
      (s: SessionModelFull) => s.online === true && s.PCId === pcId
    );

    if (!session) return null;

    const sessionUser = users.find(
      (u: userGetModel) => u.id === session.userId
    );


    return sessionUser
      ? { name: sessionUser.name, surname: sessionUser.surname }
      : { name: "–°–æ—Ç—Ä—É–¥–Ω–∏–∫", surname: `ID: ${session.userId}` };
  };


  const handleSelectPC = async (pcId: number | null) => {
    const userIdStr = localStorage.getItem("userID");
    if (!userIdStr) {
        alert("–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–π—Ç–∏ (F5).");
        return;
    }
    const userId = Number(userIdStr);

    try {
        await setSessionOnline(true, userId, pcId);
        navigate(START_ROUTE);
    } catch (error: any) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ü–ö:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ.");
    }
  };


  const groupedPCs = useMemo(() => {
    const filtered = pcs.filter(pc =>
        pc.pc_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        pc.ip.includes(searchTerm) ||
        pc.cabinet?.toLowerCase().includes(searchTerm.toLowerCase())
    );

    const groups: Record<string, pcModelFull[]> = {};

    filtered.forEach(pc => {
        const cab = pc.cabinet || "–ë–µ–∑ –∫–∞–±–∏–Ω–µ—Ç–∞";
        if (!groups[cab]) groups[cab] = [];
        groups[cab].push(pc);
    });

    return groups;
  }, [pcs, searchTerm]);

  return (
    <div className="min-h-screen bg-slate-50 relative overflow-hidden font-sans flex flex-col">


      <div className="absolute inset-0 z-0 pointer-events-none">
          <div className="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]"></div>
          <div className="absolute left-0 right-0 top-0 -z-10 m-auto h-[500px] w-[500px] rounded-full bg-blue-400 opacity-10 blur-[120px]"></div>
      </div>

      <div className="relative z-10 container mx-auto px-4 py-8 flex flex-col h-screen">


        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 className="text-3xl font-extrabold text-slate-800 flex items-center gap-3">
                    <Monitor className="text-indigo-600" size={32}/>
                    –†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ
                </h1>
                <p className="text-slate-500">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã</p>
            </div>


            <div className="relative w-full md:w-96">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Search className="text-gray-400" size={20}/>
                </div>
                <input
                    type="text"
                    className="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 transition shadow-sm"
                    placeholder="–ù–∞–π—Ç–∏ –ü–ö –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ IP..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                />
            </div>
        </div>


        <div className="mb-8 animate-fadeIn">
            <button
                onClick={() => handleSelectPC(null)}
                className="w-full md:w-auto flex items-center justify-center gap-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all group border border-purple-400"
            >
                <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm group-hover:bg-white/30 transition">
                    <Laptop size={32} />
                </div>
                <div className="text-left">
                    <h3 className="font-bold text-lg">–Ø –Ω–∞ –ª–∏—á–Ω–æ–º –Ω–æ—É—Ç–±—É–∫–µ</h3>
                    <p className="text-purple-100 text-sm">–†–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ–º—É –ü–ö</p>
                </div>
            </button>
        </div>


        <div className="flex-1 overflow-y-auto pr-2 pb-10 custom-scrollbar">


            {localStorage.getItem("pcID") && (
                 <div className="mb-8 p-4 bg-yellow-50 border border-yellow-200 rounded-xl flex items-start gap-3 animate-fadeIn">
                     <div className="p-2 bg-yellow-100 rounded-full text-yellow-600">
                         <Lock size={20}/>
                     </div>
                     <div>
                         <h3 className="font-bold text-yellow-800">–í–Ω–∏–º–∞–Ω–∏–µ</h3>
                         <p className="text-sm text-yellow-700">
                             –£ –≤–∞—Å —É–∂–µ –≤—ã–±—Ä–∞–Ω –ü–ö –≤ –ø—Ä–æ—à–ª–æ–π —Å–µ—Å—Å–∏–∏. –ß—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å –µ–≥–æ, –≤—ã–π–¥–∏—Ç–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏ –∑–∞–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.
                         </p>
                     </div>
                 </div>
            )}

            {Object.keys(groupedPCs).length === 0 ? (
                <div className="text-center py-20 text-gray-400">
                    –ö–æ–º–ø—å—é—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è)
                </div>
            ) : (
                Object.entries(groupedPCs).map(([cabinet, pcsGroup]) => (
                    <div key={cabinet} className="mb-8">
                        <div className="flex items-center gap-2 mb-4 px-2">
                            <MapPin className="text-indigo-500" size={18}/>
                            <h2 className="text-lg font-bold text-gray-700 uppercase tracking-wide">
                                {cabinet}
                            </h2>
                            <span className="text-xs font-medium bg-gray-100 text-gray-500 px-2 py-1 rounded-full">
                                {pcsGroup.length} —à—Ç.
                            </span>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                            {pcsGroup.map(pc => {
                                const activeUser = getActiveSessionInfo(pc.id);
                                const isOccupied = !!activeUser;
                                const isMyPC = localStorage.getItem("pcID") === String(pc.id);

                                return (
                                    <button
                                        key={pc.id}
                                        disabled={isOccupied}
                                        onClick={() => handleSelectPC(pc.id)}
                                        className={`relative group text-left p-4 rounded-2xl border transition-all duration-200 flex flex-col gap-3
                                            ${isOccupied
                                                ? "bg-slate-50 border-slate-200 opacity-80 cursor-not-allowed"
                                                : "bg-white border-slate-200 hover:border-indigo-400 hover:shadow-lg hover:-translate-y-1 cursor-pointer"
                                            }
                                            ${isMyPC ? "ring-2 ring-indigo-500 border-indigo-500 bg-indigo-50" : ""}
                                        `}
                                    >
                                        <div className="flex justify-between items-start">
                                            <div className={`p-2.5 rounded-xl ${isOccupied ? "bg-red-100 text-red-500" : "bg-emerald-100 text-emerald-600"}`}>
                                                <Monitor size={22} strokeWidth={2}/>
                                            </div>
                                            {isOccupied ? (
                                                <span className="px-2 py-1 bg-red-50 text-red-600 text-[10px] font-bold uppercase rounded-md border border-red-100">
                                                    –ó–∞–Ω—è—Ç
                                                </span>
                                            ) : (
                                                <span className="px-2 py-1 bg-emerald-50 text-emerald-600 text-[10px] font-bold uppercase rounded-md border border-emerald-100">
                                                    –°–≤–æ–±–æ–¥–µ–Ω
                                                </span>
                                            )}
                                        </div>

                                        <div>
                                            <h3 className="font-bold text-slate-800 text-lg leading-tight truncate" title={pc.pc_name}>
                                                {pc.pc_name}
                                            </h3>
                                            <div className="flex items-center gap-1.5 mt-1 text-xs text-slate-500 font-mono">
                                                <Wifi size={12}/> {pc.ip}
                                            </div>
                                        </div>

                                        {isOccupied && (
                                            <div className="mt-auto pt-3 border-t border-slate-100 flex items-center gap-2">
                                                <div className="w-6 h-6 rounded-full bg-red-100 flex items-center justify-center text-red-600 text-xs font-bold">
                                                    <User size={12}/>
                                                </div>
                                                <div className="text-xs font-medium text-slate-600 truncate">
                                                    {activeUser.name} {activeUser.surname}
                                                </div>
                                            </div>
                                        )}

                                        {!isOccupied && (
                                            <div className="mt-auto pt-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                 <div className="w-full py-1.5 bg-indigo-600 text-white text-xs font-bold text-center rounded-lg">
                                                     –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –ü–ö
                                                 </div>
                                            </div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                ))
            )}
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Profile/Profile.tsx
================================================================================

import { useEffect, useState, ChangeEvent } from "react";
import { fetchCurrentUser, updateUser, updateUserImg } from "src/api/userApi";
import { UserIcon } from "lucide-react";

export const Profile: React.FC = () => {
  const [currentUser, setCurrentUser] = useState({
    id: 0,
    login: "",
    password: "",
    role: "",
    name: "",
    surname: "",
    createdAt: "",
    updatedAt: "",
    img: "",
  });

  const [isEditing, setIsEditing] = useState(false);

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [isAvatarEditVisible, setAvatarEditVisible] = useState(false);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleAvatarUpload = async () => {
    if (!selectedFile) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏");
      return;
    }

    const formData = new FormData();
    formData.append("id", String(currentUser.id));
    formData.append("img", selectedFile);

    try {
      await updateUserImg(formData);
      setAvatarEditVisible(false);
      setSuccessMessage("—É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      refetchUser();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }
  };

  const refetchUser = () => {
    fetchCurrentUser(Number(localStorage.getItem("userID"))).then((data) => setCurrentUser(data));
  };

  useEffect(() => {
    fetchCurrentUser(Number(localStorage.getItem("userID"))).then((data) => setCurrentUser(data));
  }, []);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setCurrentUser((prevUser) => ({
      ...prevUser,
      [name]: value,
    }));
  };

  const handleEditToggle = () => {
    setIsEditing((prev) => !prev);
  };

  const handleSave = async () => {
    try {
      await updateUser(
        currentUser.id,
        currentUser.password,
        currentUser.name,
        currentUser.surname
      );
      setSuccessMessage("—É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      refetchUser();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }

    setIsEditing(false);
  };


  return (
    <div className="p-8 max-w-2xl mx-auto bg-gradient-to-br from-blue-50 to-purple-50 shadow-2xl rounded-3xl transform transition-all">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 text-center">
        –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      </h1>


      <div className="flex flex-col items-center mb-8">
  <div className="relative w-32 h-32 rounded-full overflow-hidden shadow-lg border-4 border-white hover:border-purple-500 transition-all duration-300">
    {currentUser.img ? (
      <img
        src={import.meta.env.VITE_API_URL + "/" + currentUser.img}
        alt=''
        className="w-full h-full object-cover"
      />
    ) : (
      <div className="w-full h-full flex items-center justify-center bg-blue-50">
        <UserIcon className="text-blue-600 w-16 h-16" />
      </div>
    )}
  </div>
</div>


      {isAvatarEditVisible ? (
        <div className="flex flex-col items-center mb-8">
          <input
            type="file"
            onChange={handleFileChange}
            className="mb-4 p-2 bg-white rounded-lg shadow-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={handleAvatarUpload}
          >
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
          </button>
        </div>
      ) : (
        <div className="flex justify-center mb-8">
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={() => setAvatarEditVisible(true)}
          >
            –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
          </button>
        </div>
      )}


<div className="space-y-6 bg-white p-8 rounded-2xl shadow-xl">

  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–õ–æ–≥–∏–Ω:</span>{" "}
    <span className="text-gray-900">{currentUser.login}</span>
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–ü–∞—Ä–æ–ª—å:</span>{" "}
    {isEditing ? (
      <input
        type="password"
        name="password"
        value={currentUser.password}
        onChange={handleInputChange}
        className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    ) : (
      <span className="text-gray-900">********</span>
    )}
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–†–æ–ª—å:</span>{" "}
    <span className="text-gray-900">{currentUser.role}</span>
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–ò–º—è:</span>{" "}
    {isEditing ? (
      <input
        name="name"
        value={currentUser.name}
        onChange={handleInputChange}
        className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    ) : (
      <span className="text-gray-900">{currentUser.name}</span>
    )}
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–§–∞–º–∏–ª–∏—è:</span>{" "}
    {isEditing ? (
      <input
        name="surname"
        value={currentUser.surname}
        onChange={handleInputChange}
        className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    ) : (
      <span className="text-gray-900">{currentUser.surname}</span>
    )}
  </p>
</div>


<div className="mt-8 flex justify-center space-x-4">
  {isEditing ? (
    <>
      <button
        onClick={handleSave}
        className="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
      >
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
      </button>
      <button
        onClick={() => {
          handleEditToggle();
          refetchUser();
        }}
        className="bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
      >
        –û—Ç–º–µ–Ω–∞
      </button>
    </>
  ) : (
    <button
      onClick={handleEditToggle}
      className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
    >
      –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
    </button>
  )}
</div>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/QMS/QmsDashboardPage.tsx
================================================================================








import React, { useEffect, useState } from "react";
import {
  Shield, FileText, AlertTriangle, CheckCircle2,
  Clock, Activity, Loader2, RefreshCw,
  ChevronRight, Lock, Unlock
} from "lucide-react";
import { auditApi, documentsApi, ncApi } from "src/api/qmsApi";
import type { AuditVerifyReport, AuditStats, DocumentStats, NcCapaStats } from "src/api/qmsApi";

const StatCard: React.FC<{
  icon: React.ElementType;
  label: string;
  value: string | number;
  sub?: string;
  color?: string;
  onClick?: () => void;
}> = ({ icon: Icon, label, value, sub, color = "text-white", onClick }) => (
  <div
    className={`bg-gray-900 border border-gray-800 rounded-xl p-4 ${onClick ? "cursor-pointer hover:border-gray-600 transition" : ""}`}
    onClick={onClick}
  >
    <div className="flex items-center gap-2 mb-2">
      <Icon size={16} className="text-gray-500" />
      <span className="text-xs text-gray-500">{label}</span>
    </div>
    <div className={`text-2xl font-bold ${color}`}>{value}</div>
    {sub && <div className="text-xs text-gray-600 mt-1">{sub}</div>}
  </div>
);

export const QmsDashboardPage: React.FC = () => {
  const [chainReport, setChainReport] = useState<AuditVerifyReport | null>(null);
  const [auditStats, setAuditStats] = useState<AuditStats | null>(null);
  const [docStats, setDocStats] = useState<DocumentStats | null>(null);
  const [ncStats, setNcStats] = useState<NcCapaStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [verifying, setVerifying] = useState(false);

  const loadAll = async () => {
    setLoading(true);
    try {
      const [chain, audit, docs, nc] = await Promise.allSettled([
        auditApi.quickVerify(200),
        auditApi.getStats(30),
        documentsApi.getStats(),
        ncApi.getStats(),
      ]);
      if (chain.status === "fulfilled") setChainReport(chain.value);
      if (audit.status === "fulfilled") setAuditStats(audit.value);
      if (docs.status === "fulfilled") setDocStats(docs.value);
      if (nc.status === "fulfilled") setNcStats(nc.value);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { loadAll(); }, []);

  const runFullVerify = async () => {
    setVerifying(true);
    try {
      const report = await auditApi.fullVerify();
      setChainReport(report);
    } finally {
      setVerifying(false);
    }
  };

  const ncOpen = ncStats?.ncByStatus?.find(s => s.status === "OPEN");
  const ncTotal = ncStats?.ncByStatus?.reduce((s, v) => s + Number(v.count), 0) || 0;
  const capaOpen = ncStats?.capaByStatus?.filter(s => !["CLOSED", "EFFECTIVE"].includes(s.status))
    .reduce((s, v) => s + Number(v.count), 0) || 0;

  const docsEffective = docStats?.byStatus?.find(s => s.status === "EFFECTIVE");

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <Loader2 className="w-8 h-8 animate-spin text-indigo-500" />
      </div>
    );
  }

  return (
    <div className="px-4 py-6 max-w-[1600px] mx-auto">
      {}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
            <Shield className="w-5 h-5 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">ASVO-QMS</h1>
            <p className="text-sm text-gray-500">–°–∏—Å—Ç–µ–º–∞ –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ –∫–∞—á–µ—Å—Ç–≤–∞ ‚Ä¢ ISO 13485</p>
          </div>
        </div>
        <button onClick={loadAll} className="flex items-center gap-1 px-3 py-1.5 text-xs text-gray-600 hover:text-gray-800 border border-gray-200 rounded-lg">
          <RefreshCw size={12} /> –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>

      {}
      {chainReport && (
        <div className={`rounded-xl p-4 mb-6 border ${
          chainReport.valid
            ? "bg-emerald-50 border-emerald-200"
            : "bg-red-50 border-red-200"
        }`}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {chainReport.valid ? (
                <Lock className="w-6 h-6 text-emerald-600" />
              ) : (
                <Unlock className="w-6 h-6 text-red-600" />
              )}
              <div>
                <div className={`font-bold ${chainReport.valid ? "text-emerald-800" : "text-red-800"}`}>
                  {chainReport.valid ? "–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç-—Ç—Ä–µ–π–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞" : `–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${chainReport.invalidRecords} –Ω–∞—Ä—É—à–µ–Ω–∏–π!`}
                </div>
                <div className="text-xs text-gray-600">
                  {chainReport.totalRecords} –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚Ä¢ {chainReport.unchainedRecords} –±–µ–∑ hash-chain (legacy)
                  {chainReport.durationMs && ` ‚Ä¢ ${chainReport.durationMs}ms`}
                </div>
              </div>
            </div>
            <button
              onClick={runFullVerify}
              disabled={verifying}
              className="flex items-center gap-1 px-3 py-1.5 text-xs bg-white border rounded-lg hover:bg-gray-50 disabled:opacity-50"
            >
              {verifying ? <Loader2 size={12} className="animate-spin" /> : <Shield size={12} />}
              –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            </button>
          </div>
        </div>
      )}

      {}
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
        <StatCard icon={Activity} label="–ê—É–¥–∏—Ç —Å–æ–±—ã—Ç–∏–π (30–¥)" value={auditStats?.total || 0}
          sub={`${auditStats?.chainCoverage || 0}% —Å hash-chain`} color="text-indigo-400" />

        <StatCard icon={FileText} label="–î–æ–∫—É–º–µ–Ω—Ç–æ–≤" value={Number(docsEffective?.count || 0)}
          sub={`${docStats?.pendingApprovalsCount || 0} –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏`} color="text-blue-400" />

        <StatCard icon={AlertTriangle} label="NC –æ—Ç–∫—Ä—ã—Ç—ã—Ö" value={Number(ncOpen?.count || 0)}
          sub={`${ncTotal} –≤—Å–µ–≥–æ`} color={Number(ncOpen?.count || 0) > 0 ? "text-red-400" : "text-emerald-400"} />

        <StatCard icon={CheckCircle2} label="CAPA –∞–∫—Ç–∏–≤–Ω—ã—Ö" value={capaOpen}
          color={capaOpen > 0 ? "text-amber-400" : "text-emerald-400"} />

        <StatCard icon={Clock} label="NC –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" value={ncStats?.overdueNc || 0}
          color={Number(ncStats?.overdueNc || 0) > 0 ? "text-red-500" : "text-gray-400"} />

        <StatCard icon={Clock} label="CAPA –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" value={ncStats?.overdueCapa || 0}
          color={Number(ncStats?.overdueCapa || 0) > 0 ? "text-red-500" : "text-gray-400"} />
      </div>

      {}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        {[
          { title: "–ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞", desc: "Hash-chain –∞—É–¥–∏—Ç-—Ç—Ä–µ–π–ª", href: "/audit", icon: Shield, color: "from-indigo-500 to-blue-600" },
          { title: "–î–æ–∫—É–º–µ–Ω—Ç—ã –°–ú–ö", desc: "–†–µ–µ—Å—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏", href: "/documents", icon: FileText, color: "from-blue-500 to-cyan-600" },
          { title: "–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è", desc: "–†–µ–µ—Å—Ç—Ä NC", href: "/nonconformity", icon: AlertTriangle, color: "from-red-500 to-orange-600" },
          { title: "CAPA", desc: "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è", href: "/capa", icon: CheckCircle2, color: "from-amber-500 to-yellow-600" },
        ].map((link) => (
          <a
            key={link.href}
            href={link.href}
            className="group bg-white border border-gray-200 rounded-xl p-4 hover:shadow-lg hover:border-gray-300 transition flex items-center gap-3"
          >
            <div className={`w-10 h-10 bg-gradient-to-br ${link.color} rounded-lg flex items-center justify-center shadow`}>
              <link.icon className="w-5 h-5 text-white" />
            </div>
            <div className="flex-1">
              <div className="font-semibold text-gray-800 text-sm">{link.title}</div>
              <div className="text-xs text-gray-500">{link.desc}</div>
            </div>
            <ChevronRight size={16} className="text-gray-400 group-hover:text-gray-600" />
          </a>
        ))}
      </div>

      {}
      {auditStats?.bySeverity && auditStats.bySeverity.length > 0 && (
        <div className="bg-white border border-gray-200 rounded-xl p-4 mb-6">
          <h3 className="text-sm font-bold text-gray-700 mb-3">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ severity (30 –¥–Ω–µ–π)</h3>
          <div className="flex gap-2">
            {auditStats.bySeverity.map((s) => {
              const colors: Record<string, string> = {
                INFO: "bg-gray-100 text-gray-700",
                WARNING: "bg-amber-100 text-amber-700",
                CRITICAL: "bg-red-100 text-red-700",
                SECURITY: "bg-purple-100 text-purple-700",
              };
              return (
                <div key={s.severity} className={`px-3 py-2 rounded-lg ${colors[s.severity] || "bg-gray-100"}`}>
                  <div className="text-lg font-bold">{s.count}</div>
                  <div className="text-xs">{s.severity}</div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {}
      {ncStats?.ncByClassification && ncStats.ncByClassification.length > 0 && (
        <div className="bg-white border border-gray-200 rounded-xl p-4">
          <h3 className="text-sm font-bold text-gray-700 mb-3">NC –ø–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
          <div className="flex gap-2">
            {ncStats.ncByClassification.map((c) => {
              const colors: Record<string, string> = {
                CRITICAL: "bg-red-100 text-red-700 border-red-200",
                MAJOR: "bg-amber-100 text-amber-700 border-amber-200",
                MINOR: "bg-gray-100 text-gray-700 border-gray-200",
              };
              const labels: Record<string, string> = {
                CRITICAL: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ", MAJOR: "–°–µ—Ä—å—ë–∑–Ω—ã–µ", MINOR: "–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ",
              };
              return (
                <div key={c.classification} className={`px-4 py-3 rounded-lg border ${colors[c.classification] || "bg-gray-100"}`}>
                  <div className="text-2xl font-bold">{c.count}</div>
                  <div className="text-xs">{labels[c.classification] || c.classification}</div>
                </div>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/StartPage/StartPage.tsx
================================================================================

import React, { useState, useEffect, useContext } from "react";
import { Context } from "src/main";
import { observer } from "mobx-react-lite";
import { useNavigate } from "react-router-dom";
import clsx from "clsx";
import {
  Box, Activity, ArrowRight, Clock,
  Users, Settings,
  ClipboardList,
  Monitor, Laptop, RefreshCw, AlertTriangle, CheckCircle2, Circle
} from "lucide-react";
import {
  WAREHOUSE_ROUTE,
  TASKS_ROUTE,
  ADMIN_ROUTE,
} from "src/utils/consts";
import { fetchPC, fetchSession, fetchUsers } from "src/api/userApi";


const UPDATES = [
    { ver: "3.00", date: "10.02", desc: "QMS-—è–¥—Ä–æ: –¥–æ–∫—É–º–µ–Ω—Ç—ã, —Ä–∏—Å–∫–∏, NC/CAPA." },
    { ver: "2.04", date: "21.01", desc: "–í–∏–¥–∂–µ—Ç –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π." },
];


const HeroCard = ({ title, sub, icon: Icon, to }: any) => {
    const navigate = useNavigate();
    return (
        <div
            onClick={() => navigate(to)}
            className="group relative col-span-1 md:col-span-2 lg:col-span-2 row-span-2 cursor-pointer overflow-hidden rounded-[2.5rem] bg-gradient-to-br from-indigo-600 to-violet-700 p-8 text-white shadow-2xl shadow-indigo-200 transition-all duration-500 hover:-translate-y-1 hover:shadow-indigo-300"
        >
            <div className="absolute -right-20 -top-20 h-64 w-64 rounded-full bg-white opacity-10 blur-3xl transition-transform duration-700 group-hover:scale-150"></div>
            <div className="absolute bottom-0 left-0 h-40 w-full bg-gradient-to-t from-black/20 to-transparent"></div>

            <div className="relative z-10 flex h-full flex-col justify-between">
                <div className="flex items-start justify-between">
                    <div className="rounded-2xl bg-white/20 p-4 backdrop-blur-md transition-transform duration-300 group-hover:rotate-12">
                        <Icon size={32} className="text-white" />
                    </div>
                    <div className="rounded-full border border-white/20 bg-white/10 px-3 py-1 text-xs font-bold uppercase tracking-wider backdrop-blur-md">
                        QMS
                    </div>
                </div>

                <div>
                    <h2 className="text-3xl font-black leading-tight tracking-tight md:text-4xl">{title}</h2>
                    <p className="mt-2 max-w-sm text-sm font-medium text-indigo-100 opacity-90">{sub}</p>
                    <div className="mt-6 flex items-center gap-2 font-bold text-white opacity-0 transition-all duration-300 group-hover:translate-x-2 group-hover:opacity-100">
                        –ü–µ—Ä–µ–π—Ç–∏ <ArrowRight size={18} />
                    </div>
                </div>
            </div>
        </div>
    );
};


const InfoTile = ({ title, sub, icon: Icon, to, colorClass, iconColor }: any) => {
    const navigate = useNavigate();
    return (
        <div
            onClick={() => navigate(to)}
            className="group relative flex cursor-pointer flex-col justify-between overflow-hidden rounded-[2rem] border border-slate-100 bg-white p-6 shadow-sm transition-all duration-300 hover:-translate-y-1 hover:shadow-xl col-span-1"
        >
            <div className={clsx("absolute -right-4 -top-4 h-24 w-24 rounded-full opacity-5 transition-transform duration-500 group-hover:scale-150", colorClass)}></div>
            <div className="flex items-start justify-between">
                <div className={clsx("rounded-2xl p-3 shadow-sm transition-transform duration-300 group-hover:scale-110", colorClass)}>
                    <Icon size={24} className={iconColor} strokeWidth={2} />
                </div>
            </div>
            <div className="mt-4">
                <h3 className="text-lg font-bold text-slate-800 transition-colors group-hover:text-indigo-600">{title}</h3>
                <p className="mt-1 text-xs font-medium text-slate-400">{sub}</p>
            </div>
        </div>
    );
};


const SystemWidget = () => (
    <div className="col-span-1 md:col-span-1 lg:row-span-2 flex flex-col gap-4">
        <div className="flex-1 rounded-[2rem] border border-slate-100 bg-white p-6 shadow-sm relative overflow-hidden">
             <div className="mb-4 flex items-center justify-between">
                <h3 className="font-bold text-slate-700 flex items-center gap-2">
                    <Activity size={18} className="text-emerald-500"/> –°—Ç–∞—Ç—É—Å
                </h3>
                <span className="flex h-2.5 w-2.5">
                  <span className="absolute inline-flex h-2.5 w-2.5 animate-ping rounded-full bg-emerald-400 opacity-75"></span>
                  <span className="relative inline-flex h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
                </span>
             </div>
             <div className="space-y-4">
                 <div className="flex items-center justify-between rounded-xl bg-slate-50 p-3">
                     <div className="flex items-center gap-3">
                         <div className="text-xs font-bold text-slate-600">Core API</div>
                     </div>
                     <span className="text-[10px] font-bold text-emerald-600">ONLINE</span>
                 </div>
             </div>
        </div>

        <div className="flex-1 rounded-[2rem] border border-slate-100 bg-slate-900 p-6 text-slate-300 shadow-lg relative overflow-hidden group">
            <div className="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>
            <h3 className="mb-4 flex items-center gap-2 text-sm font-bold text-white uppercase tracking-wider">
                Updates
            </h3>
            <div className="space-y-3">
                {UPDATES.map((u, i) => (
                    <div key={i} className="flex items-start gap-3 text-xs">
                        <span className="font-mono text-indigo-400 min-w-[32px]">{u.ver}</span>
                        <p className="leading-snug opacity-80">{u.desc}</p>
                    </div>
                ))}
            </div>
        </div>
    </div>
);


interface OnlineUser {
  id: number;
  name: string;
  surname: string;
  role: string;
  pcName: string | null;
  isPersonalLaptop: boolean;
}

const OnlineUsersWidget = () => {
    const [onlineUsers, setOnlineUsers] = useState<OnlineUser[]>([]);
    const [loading, setLoading] = useState(true);
    const [lastUpdate, setLastUpdate] = useState<Date>(new Date());

    const loadOnlineUsers = async () => {
        try {
            setLoading(true);
            const [sessions, users, pcs] = await Promise.all([
                fetchSession(),
                fetchUsers(),
                fetchPC().catch(() => [])
            ]);

            const activeSessions = sessions.filter((s: any) => s.online === true);

            const online: OnlineUser[] = activeSessions.map((session: any) => {
                const user = users.find((u: any) => u.id === session.userId);
                const pc = pcs.find((p: any) => p.id === session.PCId);
                return {
                    id: user?.id || 0,
                    name: user?.name || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",
                    surname: user?.surname || "",
                    role: user?.role || "USER",
                    pcName: pc?.pc_name || null,
                    isPersonalLaptop: session.PCId === null
                };
            });

            const uniqueOnline = online.filter((user, index, self) =>
                index === self.findIndex(u => u.id === user.id)
            );

            setOnlineUsers(uniqueOnline);
            setLastUpdate(new Date());
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", e);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        loadOnlineUsers();
        const interval = setInterval(loadOnlineUsers, 30000);
        return () => clearInterval(interval);
    }, []);

    const getRoleLabel = (role: string) => {
        const roles: Record<string, string> = {
            SUPER_ADMIN: "–ê–¥–º–∏–Ω", ADMIN: "–ê–¥–º–∏–Ω",
            WAREHOUSE_MASTER: "–°–∫–ª–∞–¥", QC_ENGINEER: "–û–¢–ö",
            USER: "User"
        };
        return roles[role] || role;
    };

    const canReboot = onlineUsers.length === 0;

    return (
        <div className="col-span-1 md:col-span-2 row-span-2 rounded-[2rem] border border-slate-100 bg-white shadow-sm overflow-hidden flex flex-col">
            <div className="p-5 border-b border-slate-100 flex-shrink-0">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className={clsx(
                            "p-2.5 rounded-xl",
                            onlineUsers.length > 0 ? "bg-emerald-100" : "bg-slate-100"
                        )}>
                            <Users size={20} className={onlineUsers.length > 0 ? "text-emerald-600" : "text-slate-500"} />
                        </div>
                        <div>
                            <h3 className="font-bold text-slate-800">–°–µ–π—á–∞—Å –≤ —Å–∏—Å—Ç–µ–º–µ</h3>
                            <p className="text-xs text-slate-400">
                                –û–±–Ω: {lastUpdate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
                            </p>
                        </div>
                    </div>

                    <div className="flex items-center gap-2">
                        <div className={clsx(
                            "flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold",
                            canReboot
                                ? "bg-emerald-50 text-emerald-700 border border-emerald-200"
                                : "bg-amber-50 text-amber-700 border border-amber-200"
                        )}>
                            {canReboot ? (
                                <><CheckCircle2 size={12} /> OK</>
                            ) : (
                                <><AlertTriangle size={12} /> {onlineUsers.length}</>
                            )}
                        </div>
                        <button
                            onClick={loadOnlineUsers}
                            disabled={loading}
                            className="p-1.5 rounded-lg hover:bg-slate-100 transition-colors"
                        >
                            <RefreshCw size={14} className={clsx("text-slate-500", loading && "animate-spin")} />
                        </button>
                    </div>
                </div>
            </div>

            <div className="flex-1 overflow-y-auto p-4">
                {loading && onlineUsers.length === 0 ? (
                    <div className="flex items-center justify-center h-full">
                        <RefreshCw size={20} className="text-slate-300 animate-spin" />
                    </div>
                ) : onlineUsers.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full text-center">
                        <div className="w-14 h-14 mb-3 rounded-full bg-slate-100 flex items-center justify-center">
                            <Users size={24} className="text-slate-400" />
                        </div>
                        <p className="font-medium text-slate-600 text-sm">–ù–∏–∫–æ–≥–æ –Ω–µ—Ç</p>
                        <p className="text-xs text-slate-400 mt-1">–ú–æ–∂–Ω–æ —Ä–µ–±—É—Ç–∞—Ç—å —Å–µ—Ä–≤–µ—Ä</p>
                    </div>
                ) : (
                    <div className="space-y-2">
                        {onlineUsers.map((user) => (
                            <div
                                key={user.id}
                                className="flex items-center justify-between p-2.5 rounded-xl bg-slate-50 hover:bg-slate-100 transition-colors"
                            >
                                <div className="flex items-center gap-2.5">
                                    <div className="relative">
                                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold">
                                            {user.name[0]}{user.surname?.[0] || ""}
                                        </div>
                                        <span className="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-emerald-500 border-2 border-white rounded-full"></span>
                                    </div>
                                    <div>
                                        <div className="font-semibold text-slate-800 text-sm leading-tight">
                                            {user.name} {user.surname?.[0] ? user.surname[0] + "." : ""}
                                        </div>
                                        <span className="text-[10px] font-medium text-slate-400">
                                            {getRoleLabel(user.role)}
                                        </span>
                                    </div>
                                </div>
                                <div className="flex items-center gap-1 text-[10px] text-slate-400">
                                    {user.isPersonalLaptop ? (
                                        <Laptop size={12} />
                                    ) : (
                                        <Monitor size={12} />
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {onlineUsers.length > 0 && (
                <div className="px-5 py-2.5 bg-slate-50 border-t border-slate-100 flex-shrink-0">
                    <div className="flex items-center justify-between text-xs">
                        <span className="text-slate-500">
                            –û–Ω–ª–∞–π–Ω: <span className="font-bold text-emerald-600">{onlineUsers.length}</span>
                        </span>
                        <div className="flex items-center gap-1 text-slate-400">
                            <Circle size={6} className="fill-emerald-500 text-emerald-500" />
                            <span>Live</span>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};


export const StartPage: React.FC = observer(() => {
    const { user } = useContext(Context)!;
    const [greeting, setGreeting] = useState("");
    const [currentTime, setCurrentTime] = useState(new Date());

    useEffect(() => {
        const updateTime = () => {
            const now = new Date();
            setCurrentTime(now);
            const hour = now.getHours();
            if (hour < 12) setGreeting("–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ");
            else if (hour < 18) setGreeting("–î–æ–±—Ä—ã–π –¥–µ–Ω—å");
            else setGreeting("–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä");
        };
        updateTime();
        const t = setInterval(updateTime, 1000);
        return () => clearInterval(t);
    }, []);

    const today = currentTime.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
    const isAdmin = user.can('admin.access') || user.can('users.manage');

    return (
        <div className="min-h-screen bg-[#F6F8FA] p-6 lg:p-10 font-sans text-slate-800 pb-20">
            <div className="max-w-[1400px] mx-auto animate-fade-in-up">

                <div className="mb-10 flex flex-col justify-between gap-4 md:flex-row md:items-end">
                    <div>
                        <div className="mb-2 flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-slate-400">
                            <Clock size={14} className="text-indigo-500"/>
                            {today}
                        </div>
                        <h1 className="text-4xl font-black tracking-tight text-slate-900 md:text-5xl">
                            {greeting}, <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">{user.user?.name || "–ö–æ–ª–ª–µ–≥–∞"}</span>.
                        </h1>
                        <p className="mt-2 text-lg font-medium text-slate-500">
                            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ –∫–∞—á–µ—Å—Ç–≤–∞.
                        </p>
                    </div>

                    <div className="hidden md:block">
                        <div className="flex items-center gap-3 rounded-2xl bg-white px-5 py-3 shadow-sm border border-slate-100">
                            <div className="h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold">
                                {user.user?.name?.[0] || "U"}
                            </div>
                            <div>
                                <div className="text-xs font-bold uppercase text-slate-400">–í–∞—à–∞ —Ä–æ–ª—å</div>
                                <div className="font-bold text-indigo-600">{user.user?.role || "–°–æ—Ç—Ä—É–¥–Ω–∏–∫"}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4 auto-rows-auto">

                    <HeroCard
                        title="–ó–∞–¥–∞—á–∏"
                        sub="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏"
                        icon={ClipboardList}
                        to={TASKS_ROUTE}
                    />

                    <InfoTile title="–°–∫–ª–∞–¥" sub="–û—Å—Ç–∞—Ç–∫–∏ –∏ –¥–≤–∏–∂–µ–Ω–∏–µ" icon={Box} to={WAREHOUSE_ROUTE} colorClass="bg-emerald-500" iconColor="text-emerald-600" />

                    {isAdmin && (
                        <InfoTile title="–ê–¥–º–∏–Ω–∫–∞" sub="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã" icon={Settings} to={ADMIN_ROUTE} colorClass="bg-slate-800" iconColor="text-slate-700" />
                    )}

                    <SystemWidget />

                    {isAdmin && <OnlineUsersWidget />}
                </div>
            </div>
        </div>
    );
});

================================================================================
FILE: QMS-Client-main/src/pages/Tasks/ProjectsList.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { Plus, Trash2, FolderOpen } from "lucide-react";
import { fetchProjects, createProject, deleteProject, ProjectModel } from "src/api/projectsApi";
import { Modal } from "src/components/Modal/Modal";

const ProjectsList: React.FC = () => {
    const [projects, setProjects] = useState<ProjectModel[]>([]);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [form, setForm] = useState({ title: "", description: "" });

    const load = async () => {
        const data = await fetchProjects();
        setProjects(data);
    };

    useEffect(() => { load(); }, []);

    const handleCreate = async () => {
        if(!form.title) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
        await createProject(form.title, form.description);
        setIsModalOpen(false);
        setForm({ title: "", description: "" });
        load();
    };

    const handleDelete = async (id: number) => {
        if(window.confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) {
            await deleteProject(id);
            load();
        }
    };

    return (
        <div className="animate-fade-in">
            <div className="flex justify-end mb-4">
                <button onClick={() => setIsModalOpen(true)} className="flex items-center gap-2 bg-gray-900 text-white px-4 py-2 rounded-xl font-bold hover:bg-black transition">
                    <Plus size={18}/> –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {projects.map(p => (
                    <div key={p.id} className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 hover:shadow-md transition relative group">
                        <div className="flex justify-between items-start mb-2">
                            <div className="p-3 bg-blue-50 text-blue-600 rounded-xl">
                                <FolderOpen size={24}/>
                            </div>
                            <button onClick={() => handleDelete(p.id)} className="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100">
                                <Trash2 size={18}/>
                            </button>
                        </div>
                        <h3 className="text-lg font-bold text-gray-800 mb-1">{p.title}</h3>
                        <p className="text-sm text-gray-500 mb-4 line-clamp-2 h-10">{p.description || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}</p>

                        <div className="flex justify-between items-center text-xs text-gray-400 border-t pt-3">
                            <span>–°–æ–∑–¥–∞–ª: {p.author?.surname || "Admin"}</span>
                            <span>{new Date(p.createdAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                ))}
            </div>

            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)}>
                <div className="p-4">
                    <h2 className="text-xl font-bold mb-4">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h2>
                    <input className="w-full p-3 border rounded-xl mb-3" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –î—Ä–æ–Ω-—Ä–∞–∑–≤–µ–¥—á–∏–∫)" value={form.title} onChange={e => setForm({...form, title: e.target.value})} />
                    <textarea className="w-full p-3 border rounded-xl mb-3" placeholder="–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –ø—Ä–æ–µ–∫—Ç..." rows={3} value={form.description} onChange={e => setForm({...form, description: e.target.value})} />
                    <button onClick={handleCreate} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </Modal>
        </div>
    );
};

export default ProjectsList;

================================================================================
FILE: QMS-Client-main/src/pages/Tasks/TasksList.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  ProductionTask,
  TaskDetailResponse,
  fetchTasks,
  fetchTaskById,
  createTask,
  updateTask,
} from "src/api/tasksApi";
import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { fetchUsers } from "src/api/userApi";
import { fetchStructure } from "src/api/structureApi";
import { userGetModel } from "src/types/UserModel";
import { SectionModel } from "src/store/StructureStore";
import {
  Plus, Loader2, MapPin,
  Edit3, Save, X, Briefcase
} from "lucide-react";
import { Modal } from "src/components/Modal/Modal";

interface TaskStats { total: number; done: number; inWork: number; onStock: number; }
interface ExtendedTask extends ProductionTask { stats?: TaskStats; }

const TasksList: React.FC = () => {
  const [tasks, setTasks] = useState<ExtendedTask[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedTask, setSelectedTask] = useState<TaskDetailResponse | null>(null);

  const [isEditing, setIsEditing] = useState(false);
  const [editForm, setEditForm] = useState<any>({});

  const [users, setUsers] = useState<userGetModel[]>([]);
  const [_sections, setSections] = useState<SectionModel[]>([]);
  const [projects, setProjects] = useState<ProjectModel[]>([]);

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [createForm, setCreateForm] = useState<any>({ priority: "1", targetQty: "" });

  const loadData = async () => {
    setLoading(true);
    try {
      const res = await fetchTasks({ page: 1, limit: 100 });
      setTasks(res.rows as unknown as ExtendedTask[]);
    } catch (e) { console.error(e); }
    finally { setLoading(false); }
  };

  useEffect(() => {
      loadData();
      fetchUsers().then(setUsers);
      fetchStructure().then(setSections);
      fetchProjects().then(setProjects);
  }, []);

  const handleSelectTask = async (id: number) => {
    setIsEditing(false);
    try {
      const res = await fetchTaskById(id);
      setSelectedTask(res);
    } catch (e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π"); }
  };

  const startEditing = () => {
      if(!selectedTask) return;
      setEditForm({
          priority: selectedTask.task.priority,
          dueDate: selectedTask.task.dueDate,
          responsibleId: selectedTask.task.responsibleId,
          sectionId: selectedTask.task.sectionId,
          projectId: selectedTask.task.projectId,
          status: selectedTask.task.status
      });
      setIsEditing(true);
  };

  const saveChanges = async () => {
      if(!selectedTask) return;
      try {
          await updateTask(selectedTask.task.id, editForm);
          setIsEditing(false);
          handleSelectTask(selectedTask.task.id);
          loadData();
      } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
  };


  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">


        <div className="lg:col-span-7 space-y-4">
            <button onClick={() => setIsModalOpen(true)} className="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:border-indigo-500 hover:text-indigo-600 transition flex justify-center items-center gap-2">
                <Plus size={20}/> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
            </button>

            {loading && <Loader2 className="animate-spin mx-auto"/>}

            {tasks.map(task => {
                const stats = task.stats || { done: 0, inWork: 0, onStock: 0, total: 0 };
                const pDone = Math.min(100, Math.round((stats.done / task.targetQty) * 100));

                const projName = projects.find(p => p.id === task.projectId)?.title;

                return (
                    <div
                        key={task.id}
                        onClick={() => handleSelectTask(task.id)}
                        className={`bg-white p-5 rounded-2xl border transition-all cursor-pointer hover:shadow-lg relative overflow-hidden ${selectedTask?.task.id === task.id ? 'border-indigo-500 ring-2 ring-indigo-100' : 'border-gray-200'}`}
                    >

                        <div className="flex justify-between items-start mb-2">
                            <div className="flex flex-col">
                                <h3 className="font-bold text-lg text-gray-800">{task.title}</h3>
                                {projName && <span className="text-xs text-indigo-600 font-bold flex items-center gap-1"><Briefcase size={10}/> {projName}</span>}
                            </div>
                            <div className="text-right">
                                <div className="text-2xl font-black text-gray-900">{stats.total} <span className="text-sm text-gray-400">/ {task.targetQty}</span></div>
                            </div>
                        </div>

                        <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden mt-2">
                            <div style={{width: `${pDone}%`}} className="bg-emerald-500 h-full"></div>
                        </div>
                    </div>
                )
            })}
        </div>


        <div className="lg:col-span-5">
           {selectedTask ? (
             <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sticky top-6">


                <div className="flex justify-between items-start mb-4 border-b pb-4">
                    <h2 className="text-xl font-bold text-gray-800 w-3/4">{selectedTask.task.title}</h2>
                    <div className="flex gap-2">
                        {isEditing ? (
                            <>
                                <button onClick={saveChanges} className="p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200"><Save size={18}/></button>
                                <button onClick={() => setIsEditing(false)} className="p-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200"><X size={18}/></button>
                            </>
                        ) : (
                            <button onClick={startEditing} className="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100"><Edit3 size={18}/></button>
                        )}
                    </div>
                </div>


                <div className="space-y-4 mb-6">

                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–°—Ç–∞—Ç—É—Å</span>
                        {isEditing ? (
                            <select
                                value={editForm.status}
                                onChange={e => setEditForm({...editForm, status: e.target.value})}
                                className="border rounded p-1 text-sm font-bold"
                            >
                                <option value="NEW">–ù–û–í–ê–Ø</option>
                                <option value="IN_PROGRESS">–í –†–ê–ë–û–¢–ï</option>
                                <option value="DONE">–ì–û–¢–û–í–û</option>
                            </select>
                        ) : (
                            <span className="px-2 py-1 bg-gray-100 rounded text-xs font-bold">{selectedTask.task.status}</span>
                        )}
                    </div>


                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–ü—Ä–æ–µ–∫—Ç</span>
                        {isEditing ? (
                            <select
                                value={editForm.projectId || ""}
                                onChange={e => setEditForm({...editForm, projectId: e.target.value || null})}
                                className="border rounded p-1 text-sm w-48"
                            >
                                <option value="">–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞</option>
                                {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                            </select>
                        ) : (
                            <span className="text-sm font-medium text-indigo-600">
                                {projects.find(p => p.id === selectedTask.task.projectId)?.title || "‚Äî"}
                            </span>
                        )}
                    </div>


                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
                        {isEditing ? (
                            <select
                                value={editForm.priority || 1}
                                onChange={e => setEditForm({...editForm, priority: e.target.value})}
                                className="border rounded p-1 text-sm"
                            >
                                <option value="1">–ù–∏–∑–∫–∏–π</option>
                                <option value="2">–°—Ä–µ–¥–Ω–∏–π</option>
                                <option value="3">–í—ã—Å–æ–∫–∏–π</option>
                            </select>
                        ) : (
                            <span className="text-sm">{selectedTask.task.priority === 3 ? "üî• –í—ã—Å–æ–∫–∏–π" : "–û–±—ã—á–Ω—ã–π"}</span>
                        )}
                    </div>


                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</span>
                        {isEditing ? (
                            <select
                                value={editForm.responsibleId || ""}
                                onChange={e => setEditForm({...editForm, responsibleId: e.target.value || null})}
                                className="border rounded p-1 text-sm w-48"
                            >
                                <option value="">-- –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω --</option>
                                {users.map(u => <option key={u.id} value={u.id}>{u.surname} {u.name}</option>)}
                            </select>
                        ) : (
                            <span className="text-sm">{selectedTask.task.responsible ? `${selectedTask.task.responsible.surname} ${selectedTask.task.responsible.name}` : "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"}</span>
                        )}
                    </div>


                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–°—Ä–æ–∫ —Å–¥–∞—á–∏</span>
                        {isEditing ? (
                            <input type="date" value={editForm.dueDate || ""} onChange={e => setEditForm({...editForm, dueDate: e.target.value})} className="border rounded p-1 text-sm"/>
                        ) : (
                            <span className="text-sm">{selectedTask.task.dueDate || "‚Äî"}</span>
                        )}
                    </div>
                </div>


                <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm uppercase tracking-wide border-t pt-4">
                   <MapPin size={16} className="text-indigo-500"/> –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–¥–µ–ª–∏–π
                </h3>
                <div className="space-y-2">
                   {selectedTask.breakdown.map((item, idx) => (
                     <div key={idx} className="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                        <span>{item.sectionTitle || "–°–∫–ª–∞–¥"}</span>
                        <span className="font-bold">{item.qty} —à—Ç</span>
                     </div>
                   ))}
                </div>

             </div>
           ) : (
             <div className="h-[400px] flex items-center justify-center text-gray-400 bg-white rounded-2xl border-2 border-dashed">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É</p>
             </div>
           )}
        </div>


        <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)}>
            <div className="p-4">
                <h2 className="text-xl font-bold mb-4">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
                <div className="space-y-4">
                    <input className="w-full p-2 border rounded" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value={createCreateFormTitle(createForm)} onChange={e => setCreateForm({...createForm, title: e.target.value})} />


                    <select className="w-full p-2 border rounded" value={createForm.projectId || ""} onChange={e => setCreateForm({...createForm, projectId: e.target.value})}>
                        <option value="">-- –ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞ --</option>
                        {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                    </select>

                    <div className="grid grid-cols-2 gap-2">
                        <select className="w-full p-2 border rounded" value={createForm.originType || "PRODUCT"} onChange={e => setCreateForm({...createForm, originType: e.target.value})}>
                            <option value="PRODUCT">–ò–∑–¥–µ–ª–∏–µ</option>
                            <option value="COMPONENT">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ</option>
                        </select>
                        <input type="number" className="w-full p-2 border rounded" placeholder="ID –û–±—ä–µ–∫—Ç–∞" value={createForm.originId || ""} onChange={e => setCreateForm({...createForm, originId: e.target.value})} />
                    </div>

                    <input type="number" className="w-full p-2 border rounded font-bold" placeholder="–¶–µ–ª—å (—à—Ç)" value={createForm.targetQty} onChange={e => setCreateForm({...createForm, targetQty: e.target.value})} />

                    <button onClick={async () => {
                        await createTask({...createForm, targetQty: Number(createForm.targetQty), originId: Number(createForm.originId), projectId: createForm.projectId ? Number(createForm.projectId) : undefined});
                        setIsModalOpen(false);
                        loadData();
                    }} className="w-full py-3 bg-blue-600 text-white font-bold rounded">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </Modal>
    </div>
  );

  function createCreateFormTitle(form: any) { return form.title || ""; }
};

export default TasksList;

================================================================================
FILE: QMS-Client-main/src/pages/Tasks/TasksPage.tsx
================================================================================

import React, { useState } from "react";
import { Layout, Briefcase } from "lucide-react";
import TasksList from "./TasksList";
import ProjectsList from "./ProjectsList";

const TasksPage: React.FC = () => {
  const [activeTab, setActiveTab] = useState<"TASKS" | "PROJECTS">("TASKS");

  return (
    <div className="min-h-screen bg-gray-50/50 p-6 pb-20 font-sans text-gray-700">


      <div className="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
        <div className="flex items-center gap-4">
           <div className="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 text-white">
              {activeTab === 'TASKS' ? <Layout size={28}/> : <Briefcase size={28}/>}
           </div>
           <div>
              <h1 className="text-2xl font-bold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º</h1>
              <p className="text-gray-500 text-sm font-medium">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∑–∞–¥–∞—á</p>
           </div>
        </div>

        <div className="flex bg-white p-1 rounded-xl shadow-sm border border-gray-200">
            <button
                onClick={() => setActiveTab("TASKS")}
                className={`px-6 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'TASKS' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}
            >
                –ó–∞–¥–∞—á–∏
            </button>
            <button
                onClick={() => setActiveTab("PROJECTS")}
                className={`px-6 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'PROJECTS' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}
            >
                –ü—Ä–æ–µ–∫—Ç—ã
            </button>
        </div>
      </div>

      <div className="max-w-7xl mx-auto">
          {activeTab === "TASKS" && <TasksList />}
          {activeTab === "PROJECTS" && <ProjectsList />}
      </div>
    </div>
  );
};

export default TasksPage;

================================================================================
FILE: QMS-Client-main/src/pages/Users/OneUser.tsx
================================================================================

import { UserIcon, ShieldCheck, MonitorDot, User } from "lucide-react";

interface OneUserProps {
  login: string;
  role: string;
  name: string;
  surName: string;
  img: string | null;
  active: boolean;
  pcName: string | undefined;
  pcIP: string | undefined;
}

export const OneUser: React.FC<OneUserProps> = ({
  login,
  role,
  name,
  surName,
  img,
  active,
  pcName,
  pcIP,
}) => {
  return (
    <div className="bg-white shadow-md rounded-xl p-4 flex items-center gap-4 border-l-4 border-blue-500 transition duration-300 hover:shadow-lg overflow-hidden flex-wrap">


      {img ? (
        <div className="relative w-24 h-24 rounded-full overflow-hidden shadow-2xl border-4 border-white hover:border-purple-500 transition-all duration-300 transform hover:scale-105 group">
          <img
            src={import.meta.env.VITE_API_URL + "/" + img}
            alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
            className="w-full h-full object-cover"
          />
        </div>
      ) : (
        <div className="bg-gradient-to-br from-blue-100 to-purple-100 p-3 rounded-full w-24 h-24 flex items-center justify-center shadow-lg transform transition-all hover:scale-105 duration-300">
          <UserIcon className="text-blue-600 w-12 h-12" />
        </div>
      )}


      <div className="flex-1">
        <h3 className="text-2xl font-bold text-gray-900">
          {name} {surName}
        </h3>
        <p className="text-gray-600 text-sm mt-1">{login}</p>
      </div>


      {active ? (
        <div className="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-full shadow-sm">
          <div className="relative">
            <MonitorDot className="text-green-600 w-6 h-6" />

            <div className="absolute inset-0 flex items-center justify-center">
              <div className="w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
            </div>
          </div>
          <p className="text-sm font-medium text-green-800">
            {pcName} ({pcIP}) ‚Äì Online
          </p>
        </div>
      ) : (
        <div className="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-full shadow-sm">
          <MonitorDot className="text-red-600 w-6 h-6" />
          <p className="text-sm font-medium text-red-800">Offline</p>
        </div>
      )}


      <div className="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-purple-50 px-4 py-2 rounded-full shadow-sm">
        {role === "ADMIN" ? (
          <ShieldCheck className="text-green-600 w-6 h-6" />
        ) : (
          <User className="text-blue-600 w-6 h-6" />
        )}
        <span className="text-gray-700 font-medium">{role}</span>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Users/Users.tsx
================================================================================

import { useEffect, useState } from "react";
import { fetchPC, fetchSession, fetchUsers } from "src/api/userApi";
import { OneUser } from "./OneUser";
import { userGetModel } from "src/types/UserModel";
import { SessionModelFull } from "src/types/SessionModel";
import { pcModelFull } from "src/types/PCModel";

export const Users: React.FC = () => {
  const [users, setUsers] = useState<userGetModel[]>([]);
  const [sessions, setSessions] = useState<SessionModelFull[]>([]);
  const [pcs, setPcs] = useState<pcModelFull[]>([]);

  useEffect(() => {
    fetchUsers().then((data) => setUsers(data));
    fetchSession().then((data) => setSessions(data));
    fetchPC().then((data) => setPcs(data));
  }, []);

  const getActiveSession = () => {
    return sessions.filter(
      (session: SessionModelFull) => session.online === true
    );
  };

  const getUsersOnlineID = () => {
    return (

      getActiveSession().map((session: SessionModelFull) => session.userId)
    );
  };

  const isOnline = (id: number) => {
    return getUsersOnlineID().includes(id);
  };

  const getCurrentPCName = (userId: number) => {
    const currentSession = getActiveSession().find(
      (session) => session.userId === userId
    );
    console.log(currentSession? currentSession.PCId : '00000')
    const currentPC = pcs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    return currentPC;
  };

  let allUsers = users.map((user: userGetModel) => (
    <OneUser
      key={user.id}
      login={user.login}
      role={user.role}
      name={user.name}
      surName={user.surname}
      img = {user.img}
      active={isOnline(user.id)}
      pcName={getCurrentPCName(user.id)?.pc_name}
      pcIP={getCurrentPCName(user.id)?.ip}
    />
  ));
  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
        üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {allUsers}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/AnalyticsPage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { fetchDashboardStats } from "src/api/warehouseApi";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { TrendingUp, Package, AlertTriangle, Activity, ArrowLeft } from "lucide-react";
import { WAREHOUSE_ROUTE } from "src/utils/consts";

export const AnalyticsPage: React.FC = () => {
    const navigate = useNavigate();
    const [data, setData] = useState<any>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchDashboardStats().then(res => {
            setData(res);
            setLoading(false);
        });
    }, []);

    if (loading) return <div className="p-10 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</div>;

    const totalItems = data?.stock?.totalItems || 0;
    const totalBoxes = data?.stock?.totalBoxes || 0;
    const scrapOp = data?.today?.find((x: any) => x.operation === 'QUALITY' || x.operation === 'SCRAP');
    const scrapToday = scrapOp ? Number(scrapOp.sumScrap) : 0;
    const chartData = data?.chart?.map((item: any) => ({
        name: new Date(item.date).toLocaleDateString('ru-RU', {weekday: 'short'}),
        count: Number(item.count)
    })) || [];

    return (
        <div className="p-6 max-w-7xl mx-auto animate-fade-in bg-gray-50 min-h-screen">
            <button
                onClick={() => navigate(WAREHOUSE_ROUTE)}
                className="mb-4 flex items-center text-gray-500 hover:text-indigo-600 transition font-medium text-sm"
            >
                <ArrowLeft size={18} className="mr-1"/> –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∫–ª–∞–¥
            </button>

            <h1 className="text-3xl font-bold text-gray-800 mb-8">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h1>


            <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-gray-500 text-sm font-medium">–í—Å–µ–≥–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>
                            <h3 className="text-3xl font-bold text-indigo-600 mt-2">{Number(totalItems).toLocaleString()}</h3>
                            <p className="text-xs text-gray-400 mt-1">–µ–¥–∏–Ω–∏—Ü —Ö—Ä–∞–Ω–µ–Ω–∏—è</p>
                        </div>
                        <div className="p-3 bg-indigo-50 rounded-xl text-indigo-600"><Package /></div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-gray-500 text-sm font-medium">–ú–µ—Å—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è</p>
                            <h3 className="text-3xl font-bold text-gray-800 mt-2">{totalBoxes}</h3>
                            <p className="text-xs text-gray-400 mt-1">–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—Ä–æ–±–æ–∫</p>
                        </div>
                        <div className="p-3 bg-gray-50 rounded-xl text-gray-600"><Activity /></div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-gray-500 text-sm font-medium">–ë—Ä–∞–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</p>
                            <h3 className="text-3xl font-bold text-red-600 mt-2">{scrapToday}</h3>
                            <p className="text-xs text-gray-400 mt-1">–≤—ã—è–≤–ª–µ–Ω–æ –Ω–∞ –û–¢–ö</p>
                        </div>
                        <div className="p-3 bg-red-50 rounded-xl text-red-600"><AlertTriangle /></div>
                    </div>
                </div>

                <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-lg text-white">
                    <p className="text-indigo-100 text-sm font-medium">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
                    <h3 className="text-3xl font-bold mt-2">98.5%</h3>
                    <div className="flex items-center gap-1 text-xs text-indigo-200 mt-1">
                        <TrendingUp size={14}/> <span>–°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç</span>
                    </div>
                </div>
            </div>

            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h3 className="text-lg font-bold text-gray-700 mb-6">–î–∏–Ω–∞–º–∏–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π (7 –¥–Ω–µ–π)</h3>
                <div className="h-80 w-full">
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData}>
                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
                            <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#9ca3af'}} dy={10} />
                            <YAxis axisLine={false} tickLine={false} tick={{fill: '#9ca3af'}} />
                            <Tooltip cursor={{fill: '#f9fafb'}} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} />
                            <Bar dataKey="count" fill="#4f46e5" radius={[4, 4, 0, 0]} barSize={40} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/InventoryPage.tsx
================================================================================

import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import { fetchBoxByQr, moveBoxesBatch, fetchBoxById } from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import { Search, CheckCircle2, Save, Scale, ArrowRight, ScanLine, ArrowLeft } from "lucide-react";
import toast from 'react-hot-toast';
import { WAREHOUSE_ROUTE } from "src/utils/consts";

interface InventoryItem {
    box: InventoryBoxModel;
    systemQty: number;
    actualQty: number;
    delta: number;
}

export const InventoryPage: React.FC = () => {
    const navigate = useNavigate();
    const [scanCode, setScanCode] = useState("");
    const [loading, setLoading] = useState(false);

    const [items, setItems] = useState<InventoryItem[]>([]);
    const [scannedBox, setScannedBox] = useState<InventoryBoxModel | null>(null);
    const [actualInput, setActualInput] = useState("");

    const handleScan = async () => {
        if (!scanCode) return;
        setLoading(true);
        try {
            let res;
            if (/^\d+$/.test(scanCode)) res = await fetchBoxById(Number(scanCode));
            else res = await fetchBoxByQr(scanCode);

            if (items.some(i => i.box.id === res.box.id)) {
                toast.error("–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ!");
                setScanCode("");
                return;
            }
            setScannedBox(res.box);
            setActualInput(String(res.box.quantity));
        } catch (e) {
            toast.error("–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        } finally {
            setLoading(false);
        }
    };

    const confirmItem = () => {
        if (!scannedBox) return;
        const actual = Number(actualInput);
        if (isNaN(actual) || actual < 0) return toast.error("–ù–µ–≤–µ—Ä–Ω–æ–µ —á–∏—Å–ª–æ");
        const delta = actual - scannedBox.quantity;
        setItems(prev => [{
            box: scannedBox,
            systemQty: scannedBox.quantity,
            actualQty: actual,
            delta
        }, ...prev]);
        setScannedBox(null);
        setScanCode("");
        setActualInput("");
        if (delta === 0) toast.success("–°–æ–≤–ø–∞–¥–∞–µ—Ç");
        else toast("–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ", { icon: '‚ö†Ô∏è' });
    };

    const commitInventory = async () => {
        if (items.length === 0) return;
        const loadingToast = toast.loading("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∞...");
        try {
            await moveBoxesBatch({
                movements: items.map(item => ({
                    boxId: item.box.id,
                    operation: "INVENTORY_CHECK",
                    deltaQty: item.delta,
                    comment: `–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è. –ë—ã–ª–æ: ${item.systemQty}, –°—Ç–∞–ª–æ: ${item.actualQty}`
                })),
                documentData: {
                    createNew: true,
                    number: `INV-${Date.now()}`,
                    type: "INVENTORY_ACT",
                    comment: `–ê–∫—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ (${items.length} –ø–æ–∑.)`
                }
            });
            toast.success("–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", { id: loadingToast });
            setItems([]);
        } catch (e: any) {
            toast.error("–û—à–∏–±–∫–∞: " + e.message, { id: loadingToast });
        }
    };

    return (
        <div className="p-6 max-w-5xl mx-auto min-h-screen bg-gray-50">
            <button
                onClick={() => navigate(WAREHOUSE_ROUTE)}
                className="mb-4 flex items-center text-gray-500 hover:text-indigo-600 transition font-medium text-sm"
            >
                <ArrowLeft size={18} className="mr-1"/> –û—Ç–º–µ–Ω–∞ –∏ –≤—ã—Ö–æ–¥
            </button>

            <h1 className="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <Scale className="text-indigo-600"/> –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
            </h1>

            {scannedBox && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-fade-in">
                        <h3 className="text-xl font-bold text-gray-800 mb-1">{scannedBox.label}</h3>
                        <p className="text-gray-500 text-sm mb-6">ID: {scannedBox.id} ‚Ä¢ {scannedBox.shortCode}</p>

                        <div className="flex items-center justify-between bg-gray-100 p-4 rounded-xl mb-6">
                            <div className="text-center">
                                <div className="text-xs text-gray-500 uppercase">–ü–æ —É—á–µ—Ç—É</div>
                                <div className="text-2xl font-bold text-gray-700">{scannedBox.quantity}</div>
                            </div>
                            <ArrowRight className="text-gray-400"/>
                            <div className="text-center w-1/2">
                                <div className="text-xs text-indigo-600 uppercase font-bold mb-1">–ü–æ —Ñ–∞–∫—Ç—É</div>
                                <input
                                    type="number"
                                    value={actualInput}
                                    onChange={e => setActualInput(e.target.value)}
                                    className="w-full text-center text-3xl font-bold border-b-2 border-indigo-500 bg-transparent focus:outline-none"
                                    autoFocus
                                    onKeyDown={e => e.key === 'Enter' && confirmItem()}
                                />
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={() => setScannedBox(null)} className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300">–û—Ç–º–µ–Ω–∞</button>
                            <button onClick={confirmItem} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <div className="lg:col-span-1 space-y-4">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <label className="block text-sm font-bold text-gray-700 mb-2">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR / ID</label>
                        <div className="flex gap-2">
                            <input
                                value={scanCode} onChange={e => setScanCode(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleScan()}
                                className="w-full p-3 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 text-lg outline-none"
                                placeholder="..."
                                autoFocus={!scannedBox}
                            />
                            <button onClick={handleScan} disabled={loading} className="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700">
                                {loading ? <ScanLine className="animate-spin"/> : <Search/>}
                            </button>
                        </div>
                    </div>

                    <div className="bg-indigo-900 p-6 rounded-2xl shadow-lg text-white">
                        <div className="text-indigo-200 text-sm font-medium mb-1">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π</div>
                        <div className="text-5xl font-black">{items.length}</div>
                    </div>
                </div>


                <div className="lg:col-span-2">
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 min-h-[500px] flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="font-bold text-gray-700">–õ–∏—Å—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</h3>
                            {items.length > 0 && <button onClick={commitInventory} className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition"><Save size={18}/> –ó–∞–≤–µ—Ä—à–∏—Ç—å –∞–∫—Ç</button>}
                        </div>

                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                            {items.length === 0 && (
                                <div className="h-full flex flex-col items-center justify-center text-gray-400">
                                    <Scale size={48} className="mb-2 opacity-20"/>
                                    <p>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
                                </div>
                            )}
                            {items.map((item, idx) => (
                                <div key={idx} className="flex items-center justify-between p-3 bg-white border rounded-xl shadow-sm">
                                    <div>
                                        <div className="font-bold text-gray-800">{item.box.label}</div>
                                        <div className="text-xs text-gray-500">ID: {item.box.id}</div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="text-right">
                                            <div className="text-xs text-gray-400">–£—á–µ—Ç</div>
                                            <div className="font-medium">{item.systemQty}</div>
                                        </div>
                                        <ArrowRight size={14} className="text-gray-300"/>
                                        <div className="text-right">
                                            <div className="text-xs text-gray-400">–§–∞–∫—Ç</div>
                                            <div className="font-bold text-lg">{item.actualQty}</div>
                                        </div>
                                        <div className={`w-20 text-center py-1 rounded-lg text-xs font-bold ${item.delta === 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                            {item.delta === 0 ? <CheckCircle2 className="mx-auto" size={16}/> : `${item.delta > 0 ? '+' : ''}${item.delta}`}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/WarehousePage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import {
  Package, ArrowRightLeft, FileText, Truck, PieChart,
  BarChart3, ClipboardCheck, Settings, Tag, Tv, History
} from "lucide-react";

import { fetchStructure } from "src/api/structureApi";
import { fetchAlerts } from "src/api/warehouseApi";
import { SectionModel } from "src/store/StructureStore";
import { productModel } from "src/types/ProductModel";
import { componentModel } from "src/types/ComponentModel";
import { WAREHOUSE_ANALYTICS_ROUTE, WAREHOUSE_INVENTORY_ROUTE } from "src/utils/consts";

import { ProjectDashboard } from "./components/ProjectDashboard";
import { WarehouseIntake } from "./tabs/WarehouseIntake";
import { WarehouseMoves } from "./tabs/WarehouseMoves";
import { WarehouseDocs } from "./tabs/WarehouseDocs";
import { WarehouseBalance } from "./tabs/WarehouseBalance";
import { WarehouseSettings } from "./tabs/WarehouseSettings";
import { WarehouseLabels } from "./tabs/WarehouseLabels";
import { VideoTransmittersLabel } from "./tabs/VideoTransmittersLabel";
import { WarehousePrintHistory } from "./tabs/WarehousePrintHistory";

type Tab = "INTAKE" | "MOVES" | "BALANCE" | "DOCS" | "SETTINGS" | "LABELS" | "VIDEO_LABEL" | "HISTORY";

export const WarehousePage: React.FC = () => {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<Tab>("INTAKE");
  const [alertsCount, setAlertsCount] = useState(0);

  const [sections, setSections] = useState<SectionModel[]>([]);
  const [productsList, setProductsList] = useState<productModel[]>([]);
  const [componentsList, setComponentsList] = useState<componentModel[]>([]);

  useEffect(() => {
    fetchStructure().then(setSections);

    fetchAlerts().then(alerts => setAlertsCount(alerts.length)).catch(console.error);
  }, []);

  return (
    <div className="min-h-screen bg-gray-50 p-6 pb-20 font-sans text-gray-700">


      <div className="max-w-7xl mx-auto mb-6">
        <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6 mb-6">
            <div className="flex items-center gap-4">
               <div className="p-3 bg-indigo-100 rounded-2xl relative">
                  <Package className="w-8 h-8 text-indigo-600" />

                  {alertsCount > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>}
               </div>
               <div>
                  <h1 className="text-3xl font-bold text-gray-800">–°–∫–ª–∞–¥—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞</h1>
                  <p className="text-indigo-600/80 font-medium">WMS Kryptonit v2.4</p>
               </div>
            </div>


            <div className="flex flex-col md:flex-row gap-4 items-center w-full xl:w-auto">
                <ProjectDashboard />

                <div className="flex gap-2">
                    <button
                        onClick={() => navigate(WAREHOUSE_ANALYTICS_ROUTE)}
                        className="flex flex-col items-center justify-center w-24 h-20 bg-white border border-indigo-100 rounded-xl shadow-sm hover:shadow-md hover:border-indigo-300 transition group"
                    >
                        <div className="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600 mb-1"><BarChart3 size={20}/></div>
                        <span className="text-[10px] font-bold text-gray-600 uppercase">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                    </button>

                    <button
                        onClick={() => navigate(WAREHOUSE_INVENTORY_ROUTE)}
                        className="flex flex-col items-center justify-center w-24 h-20 bg-white border border-orange-100 rounded-xl shadow-sm hover:shadow-md hover:border-orange-300 transition group"
                    >
                        <div className="p-2 bg-orange-50 rounded-full group-hover:bg-orange-100 text-orange-600 mb-1"><ClipboardCheck size={20}/></div>
                        <span className="text-[10px] font-bold text-gray-600 uppercase">–†–µ–≤–∏–∑–∏—è</span>
                    </button>
                </div>
            </div>
        </div>


        <div className="flex gap-2 border-b border-gray-200 pb-1 overflow-x-auto">
           {[
               { id: "INTAKE", label: "–ü—Ä–∏—ë–º–∫–∞", icon: <Truck size={18}/> },
               { id: "MOVES", label: "–û–ø–µ—Ä–∞—Ü–∏–∏", icon: <ArrowRightLeft size={18}/> },
               { id: "BALANCE", label: "–û—Å—Ç–∞—Ç–∫–∏", icon: <PieChart size={18}/> },
               { id: "DOCS", label: "–ù–∞–∫–ª–∞–¥–Ω—ã–µ", icon: <FileText size={18}/> },
               { id: "LABELS", label: "–≠—Ç–∏–∫–µ—Ç–∫–∏ / –†–µ–µ—Å—Ç—Ä", icon: <Tag size={18}/> },
               { id: "VIDEO_LABEL", label: "–ü–µ—á–∞—Ç—å –í–∏–¥–µ–æ", icon: <Tv size={18}/> },

               { id: "HISTORY", label: "–ò—Å—Ç–æ—Ä–∏—è –ø–µ—á–∞—Ç–∏", icon: <History size={18}/> },

               { id: "SETTINGS", label: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –õ–∏–º–∏—Ç—ã", icon:
                 <div className="relative flex items-center gap-1">
                    <Settings size={18}/>
                    {alertsCount > 0 && <span className="bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full ml-1">{alertsCount}</span>}
                 </div>
               },
           ].map(tab => (
               <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as Tab)}
                  className={`flex items-center gap-2 px-5 py-3 rounded-t-lg font-bold text-sm transition-all relative top-[1px] whitespace-nowrap ${
                      activeTab === tab.id
                      ? "bg-white text-indigo-700 border border-gray-200 border-b-white shadow-sm z-10"
                      : "text-gray-500 hover:text-indigo-600 hover:bg-gray-100/50"
                  }`}
               >
                   {tab.icon} {tab.label}
               </button>
           ))}
        </div>
      </div>


      <div className="max-w-7xl mx-auto">
        {activeTab === "INTAKE" && <WarehouseIntake sections={sections} productsList={productsList} componentsList={componentsList} />}
        {activeTab === "MOVES" && <WarehouseMoves sections={sections} />}
        {activeTab === "BALANCE" && <WarehouseBalance />}
        {activeTab === "DOCS" && <WarehouseDocs />}
        {activeTab === "LABELS" && <WarehouseLabels />}
        {activeTab === "VIDEO_LABEL" && <VideoTransmittersLabel />}
        {activeTab === "HISTORY" && <WarehousePrintHistory />}
        {activeTab === "SETTINGS" && <WarehouseSettings />}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/__tests__/utils.test.ts
================================================================================

import { describe, it, expect } from 'vitest';
import { calculateBatch } from '../utils';

describe('Warehouse Utils - Batch Calculator', () => {

    it('–¥–æ–ª–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—ã–µ –∫–æ—Ä–æ–±–∫–∏ (—Ä–æ–≤–Ω–æ–µ –¥–µ–ª–µ–Ω–∏–µ)', () => {

        const res = calculateBatch(1000, 100);

        expect(res.fullUnits).toBe(10);
        expect(res.remainder).toBe(0);
        expect(res.totalUnits).toBe(10);
    });

    it('–¥–æ–ª–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—á–∏—Ç–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ (–Ω–µ—Ä–æ–≤–Ω–æ–µ –¥–µ–ª–µ–Ω–∏–µ)', () => {

        const res = calculateBatch(1050, 100);

        expect(res.fullUnits).toBe(10);
        expect(res.remainder).toBe(50);
        expect(res.totalUnits).toBe(11);
    });

    it('–¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω—É–ª–∏ –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –æ–±—â–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ', () => {
        const res = calculateBatch(0, 100);

        expect(res.totalUnits).toBe(0);
        expect(res.fullUnits).toBe(0);
        expect(res.remainder).toBe(0);
    });

    it('–¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–Ω—å—à–µ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏', () => {

        const res = calculateBatch(50, 100);

        expect(res.fullUnits).toBe(0);
        expect(res.remainder).toBe(50);
        expect(res.totalUnits).toBe(1);
    });

    it('–¥–æ–ª–∂–µ–Ω –∑–∞—â–∏—â–∞—Ç—å –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å (capacity = 0)', () => {

        const res = calculateBatch(100, 0);

        expect(res.fullUnits).toBe(100);
        expect(res.totalUnits).toBe(100);
    });

    it('–¥–æ–ª–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ (—Å—á–∏—Ç–∞—Ç—å –∫–∞–∫ 0)', () => {
        const res = calculateBatch(-500, 100);

        expect(res.totalUnits).toBe(0);
    });
});

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/components/LabelConstructor.tsx
================================================================================

import React, { useEffect, useMemo, useRef, useState, useCallback } from "react";
import {
  Type,
  QrCode,
  Trash2,
  Save,
  X,
  AlignLeft,
  AlignCenter,
  AlignRight,
  Minus,
  Square,


  GripHorizontal,
  ZoomIn,
  ZoomOut,
  Database,
  MousePointer2,
  Image as ImageIcon,
  Hash,
  Info,
  Umbrella,
  Wine,
  Package,
  ArrowUp,
  Snowflake,
  Flame,
  AlertTriangle,
  Upload,
  Library,
  Eye,
  Layers,
  HelpCircle,
  BookOpen,


} from "lucide-react";
import QRCode from "react-qr-code";
import clsx from "clsx";
import toast from "react-hot-toast";


export type LabelElementType = "TEXT" | "QR" | "RECTANGLE" | "LINE" | "IMAGE" | "COUNTER" | "ICON";

export interface LabelElement {
  id: string;
  type: LabelElementType;
  x: number;
  y: number;
  width: number;
  height: number;
  content?: string;
  fontSize?: number;
  fontFamily?: string;
  isBold?: boolean;
  align?: "left" | "center" | "right";
  strokeWidth?: number;
  imageUrl?: string;
  imageName?: string;
  qrDescription?: string;
  qrSource?: "code" | "name" | "custom" | "serial" | "contract" | "url";
  counterFormat?: string;
  iconType?: string;
}

interface Props {
  initialName?: string;
  initialWidth?: number;
  initialHeight?: number;
  initialLayout?: LabelElement[];
  onSave?: (name: string, w: number, h: number, layout: LabelElement[]) => void | Promise<void>;
  onClose?: () => void;
}


const PX_PER_MM = 3.78;
const SNAP_MM = 1.0;
const MIN_MM = 2;


const TEXT_VARIABLES = [
  { label: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è...", value: "", description: "" },
  { label: "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ {{code}}", value: "{{code}}", description: "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥/–∞—Ä—Ç–∏–∫—É–ª" },
  { label: "–ù–∞–∑–≤–∞–Ω–∏–µ {{name}}", value: "{{name}}", description: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" },
  { label: "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä {{serial}}", value: "{{serial}}", description: "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑–¥–µ–ª–∏—è" },
  { label: "–¶–µ–Ω–∞ {{price}}", value: "{{price}}", description: "–°—Ç–æ–∏–º–æ—Å—Ç—å" },
  { label: "–î–∞—Ç–∞ {{date}}", value: "{{date}}", description: "–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞" },
  { label: "–ö–æ–Ω—Ç—Ä–∞–∫—Ç {{contract}}", value: "{{contract}}", description: "–ù–æ–º–µ—Ä –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞" },
  { label: "–ü–∞—Ä—Ç–∏—è {{batch}}", value: "{{batch}}", description: "–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏" },
  { label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ {{qty}}", value: "{{qty}}", description: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ" },
];


interface CustomFont {
  name: string;
  fontFamily: string;
  fontDataUrl: string;
}


const CUSTOM_FONTS_STORAGE_KEY = "mes_label_custom_fonts";


const QR_SOURCES = [
  {
    value: "code",
    label: "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞",
    template: "{{code}}",
    description: "–í QR –±—É–¥–µ—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞",
    example: "7342511000501"
  },
  {
    value: "serial",
    label: "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä",
    template: "{{serial}}",
    description: "–í QR –±—É–¥–µ—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑–¥–µ–ª–∏—è",
    example: "SN-2024-00813"
  },
  {
    value: "name",
    label: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
    template: "{{name}}",
    description: "–í QR –±—É–¥–µ—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
    example: "–í–∏–¥–µ–æ–ø–µ—Ä–µ–¥–∞—Ç—á–∏–∫ –í–ü-500"
  },
  {
    value: "contract",
    label: "‚Ññ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞",
    template: "{{contract}}",
    description: "–í QR –±—É–¥–µ—Ç –Ω–æ–º–µ—Ä –≥–æ—Å–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞",
    example: "187/249/9/–ü/25-63-–§–ï"
  },
  {
    value: "url",
    label: "–°—Å—ã–ª–∫–∞/URL",
    template: "{{url}}",
    description: "–í QR –±—É–¥–µ—Ç —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
    example: "https://mes.local/item/813"
  },
  {
    value: "custom",
    label: "–°–≤–æ–π —Ç–µ–∫—Å—Ç",
    template: "",
    description: "–í–≤–µ–¥–∏—Ç–µ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è",
    example: "–õ—é–±–æ–π —Ç–µ–∫—Å—Ç"
  },
];


const COUNTER_FORMATS = [
  { label: "1 / 100", value: "{{current}} / {{total}}", description: "–¢–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä / –í—Å–µ–≥–æ" },
  { label: "1 –∏–∑ 100", value: "{{current}} –∏–∑ {{total}}", description: "–¢–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä –∏–∑ –í—Å–µ–≥–æ" },
  { label: "#1", value: "#{{current}}", description: "–¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä" },
  { label: "‚Ññ 1 (100)", value: "‚Ññ {{current}} ({{total}})", description: "–° —Å–∏–º–≤–æ–ª–æ–º –Ω–æ–º–µ—Ä–∞" },
  { label: "–≠—Ç–∏–∫–µ—Ç–∫–∞ 1/100", value: "–≠—Ç–∏–∫–µ—Ç–∫–∞ {{current}}/{{total}}", description: "–° –ø–æ–¥–ø–∏—Å—å—é" },
];


const DEFAULT_ICON_LIBRARY = [
  {
    type: "fragile",
    label: "–•—Ä—É–ø–∫–æ–µ",
    icon: Wine,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <path d="M18 6 L18 17 Q18 24 25 24 Q32 24 32 17 L32 6" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
      <line x1="25" y1="24" x2="25" y2="38" stroke="#000" stroke-width="2"/>
      <line x1="18" y1="38" x2="32" y2="38" stroke="#000" stroke-width="2" stroke-linecap="round"/>
      <line x1="14" y1="44" x2="36" y2="44" stroke="#000" stroke-width="2" stroke-linecap="round"/>
    </svg>`
  },
  {
    type: "keep_dry",
    label: "–í–ª–∞–≥–∞",
    icon: Umbrella,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <line x1="25" y1="4" x2="25" y2="10" stroke="#000" stroke-width="2"/>
      <path d="M6 22 Q6 8 25 8 Q44 8 44 22 Z" fill="none" stroke="#000" stroke-width="2"/>
      <path d="M25 22 L25 38 Q25 42 21 42" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
      <circle cx="11" cy="30" r="2" fill="#000"/>
      <circle cx="25" cy="34" r="2" fill="#000"/>
      <circle cx="39" cy="30" r="2" fill="#000"/>
      <circle cx="17" cy="40" r="2" fill="#000"/>
      <circle cx="33" cy="40" r="2" fill="#000"/>
    </svg>`
  },
  {
    type: "keep_away_heat",
    label: "–ù–∞–≥—Ä–µ–≤",
    icon: Flame,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <circle cx="25" cy="13" r="5" fill="none" stroke="#000" stroke-width="2"/>
      <line x1="25" y1="3" x2="25" y2="6" stroke="#000" stroke-width="2"/>
      <line x1="25" y1="20" x2="25" y2="23" stroke="#000" stroke-width="2"/>
      <line x1="14" y1="13" x2="17" y2="13" stroke="#000" stroke-width="2"/>
      <line x1="33" y1="13" x2="36" y2="13" stroke="#000" stroke-width="2"/>
      <line x1="17" y1="5" x2="19" y2="8" stroke="#000" stroke-width="2"/>
      <line x1="33" y1="5" x2="31" y2="8" stroke="#000" stroke-width="2"/>
      <line x1="17" y1="21" x2="19" y2="18" stroke="#000" stroke-width="2"/>
      <line x1="33" y1="21" x2="31" y2="18" stroke="#000" stroke-width="2"/>
      <path d="M8 46 L8 34 L25 26 L42 34 L42 46" fill="none" stroke="#000" stroke-width="2" stroke-linejoin="round"/>
    </svg>`
  },
  {
    type: "this_side_up",
    label: "–í–µ—Ä—Ö",
    icon: ArrowUp,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <polygon points="25,4 36,16 29,16 29,22 21,22 21,16 14,16" fill="none" stroke="#000" stroke-width="2" stroke-linejoin="round"/>
      <polygon points="25,26 36,38 29,38 29,44 21,44 21,38 14,38" fill="none" stroke="#000" stroke-width="2" stroke-linejoin="round"/>
    </svg>`
  },
  {
    type: "keep_frozen",
    label: "–ó–∞–º–æ—Ä–æ–∑–∫–∞",
    icon: Snowflake,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <rect x="16" y="12" width="10" height="24" rx="5" fill="none" stroke="#000" stroke-width="2"/>
      <circle cx="21" cy="32" r="5" fill="none" stroke="#000" stroke-width="2"/>
      <circle cx="21" cy="32" r="3" fill="#000"/>
      <line x1="21" y1="29" x2="21" y2="18" stroke="#000" stroke-width="2"/>
      <line x1="36" y1="12" x2="36" y2="28" stroke="#000" stroke-width="1.5"/>
      <line x1="28" y1="20" x2="44" y2="20" stroke="#000" stroke-width="1.5"/>
      <line x1="30" y1="14" x2="42" y2="26" stroke="#000" stroke-width="1.5"/>
      <line x1="42" y1="14" x2="30" y2="26" stroke="#000" stroke-width="1.5"/>
      <line x1="8" y1="44" x2="44" y2="44" stroke="#000" stroke-width="2"/>
      <text x="12" y="42" font-size="8" font-family="Arial, sans-serif" fill="#000">-18¬∞C</text>
    </svg>`
  },
  {
    type: "warning",
    label: "–í–Ω–∏–º–∞–Ω–∏–µ",
    icon: AlertTriangle,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <polygon points="25,5 46,44 4,44" fill="none" stroke="#000" stroke-width="2.5" stroke-linejoin="round"/>
      <line x1="25" y1="17" x2="25" y2="30" stroke="#000" stroke-width="3" stroke-linecap="round"/>
      <circle cx="25" cy="37" r="2.5" fill="#000"/>
    </svg>`
  },
  {
    type: "do_not_stack",
    label: "–ù–µ —à—Ç–∞–±–µ–ª–∏—Ä–æ–≤–∞—Ç—å",
    icon: Package,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <rect x="10" y="28" width="30" height="16" fill="none" stroke="#000" stroke-width="2"/>
      <rect x="14" y="14" width="22" height="12" fill="none" stroke="#000" stroke-width="2"/>
      <line x1="6" y1="6" x2="44" y2="44" stroke="#000" stroke-width="2.5"/>
    </svg>`
  },
];


interface CustomIcon {
  type: string;
  label: string;
  imageUrl: string;
}


const CUSTOM_ICONS_STORAGE_KEY = "mes_label_custom_icons";

const snap = (v: number) => Math.round(v / SNAP_MM) * SNAP_MM;
const round2 = (v: number) => Math.round(v * 100) / 100;


export const LabelConstructor: React.FC<Props> = ({
  initialName = "–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω",
  initialWidth = 105,
  initialHeight = 60,
  initialLayout = [],
  onSave,
  onClose,
}) => {

  const [name, setName] = useState(initialName);
  const [size, setSize] = useState({ w: initialWidth, h: initialHeight });


  const normalizedLayout = useMemo(() => {
    return initialLayout.map(el => ({
      ...el,
      fontFamily: el.fontFamily || "Arial, sans-serif",
    }));
  }, [initialLayout]);

  const [elements, setElements] = useState<LabelElement[]>(normalizedLayout);


  useEffect(() => {
    setElements(normalizedLayout);
  }, [normalizedLayout]);
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [zoom, setZoom] = useState(1.5);
  const [_showQrHelper, setShowQrHelper] = useState(false);
  const [showIconPicker, setShowIconPicker] = useState(false);
  const [_showCounterPreview, _setShowCounterPreview] = useState(false);
  const [showHelp, setShowHelp] = useState(false);


  const [fontSizeInput, setFontSizeInput] = useState<string>('');
  const [isEditingFontSize, setIsEditingFontSize] = useState(false);


  const [customIcons, setCustomIcons] = useState<CustomIcon[]>(() => {
    try {
      const saved = localStorage.getItem(CUSTOM_ICONS_STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch {
      return [];
    }
  });


  const [customFonts, setCustomFonts] = useState<CustomFont[]>(() => {
    try {
      const saved = localStorage.getItem(CUSTOM_FONTS_STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch {
      return [];
    }
  });


  useEffect(() => {
    localStorage.setItem(CUSTOM_ICONS_STORAGE_KEY, JSON.stringify(customIcons));
  }, [customIcons]);


  useEffect(() => {
    localStorage.setItem(CUSTOM_FONTS_STORAGE_KEY, JSON.stringify(customFonts));


    customFonts.forEach((font) => {
      const styleId = `custom-font-${font.name.replace(/\s+/g, '-')}`;
      if (!document.getElementById(styleId)) {
        const style = document.createElement('style');
        style.id = styleId;
        style.textContent = `
          @font-face {
            font-family: '${font.name}';
            src: url(${font.fontDataUrl});
          }
        `;
        document.head.appendChild(style);
      }
    });
  }, [customFonts]);


  const elementRefs = useRef<Map<string, HTMLDivElement>>(new Map());
  const fileInputRef = useRef<HTMLInputElement>(null);
  const iconUploadRef = useRef<HTMLInputElement>(null);
  const fontUploadRef = useRef<HTMLInputElement>(null);

  const stateRef = useRef({ elements, zoom, selectedId });
  useEffect(() => {
    stateRef.current = { elements, zoom, selectedId };
  }, [elements, zoom, selectedId]);


  const dragInfo = useRef<{
    active: boolean;
    mode: "MOVE" | "RESIZE" | null;
    elId: string | null;
    startX: number;
    startY: number;
    initialItem: LabelElement | null;
  }>({
    active: false,
    mode: null,
    elId: null,
    startX: 0,
    startY: 0,
    initialItem: null,
  });

  useEffect(() => {
    const handlePointerMove = (e: PointerEvent) => {
      if (!dragInfo.current.active || !dragInfo.current.elId || !dragInfo.current.initialItem) return;

      const { startX, startY, initialItem, mode, elId } = dragInfo.current;
      const currentZoom = stateRef.current.zoom;

      const deltaXScreen = e.clientX - startX;
      const deltaYScreen = e.clientY - startY;

      const deltaXMm = deltaXScreen / (PX_PER_MM * currentZoom);
      const deltaYMm = deltaYScreen / (PX_PER_MM * currentZoom);

      const useSnap = e.shiftKey;

      let newX = initialItem.x;
      let newY = initialItem.y;
      let newW = initialItem.width;
      let newH = initialItem.height;

      if (mode === "MOVE") {
        newX = initialItem.x + deltaXMm;
        newY = initialItem.y + deltaYMm;

        if (useSnap) {
          newX = snap(newX);
          newY = snap(newY);
        } else {
          newX = round2(newX);
          newY = round2(newY);
        }

        if (newX < 0) newX = 0;
        if (newY < 0) newY = 0;
      } else if (mode === "RESIZE") {
        newW = initialItem.width + deltaXMm;
        newH = initialItem.height + deltaYMm;

        if (useSnap) {
          newW = snap(newW);
          newH = snap(newH);
        } else {
          newW = round2(newW);
          newH = round2(newH);
        }

        if (newW < MIN_MM) newW = MIN_MM;
        if (newH < MIN_MM) newH = MIN_MM;
      }

      const node = elementRefs.current.get(elId);
      if (node) {
        node.style.left = `${newX * PX_PER_MM * currentZoom}px`;
        node.style.top = `${newY * PX_PER_MM * currentZoom}px`;
        node.style.width = `${newW * PX_PER_MM * currentZoom}px`;
        node.style.height = `${newH * PX_PER_MM * currentZoom}px`;

        const tooltip = node.querySelector(".resize-tooltip") as HTMLElement;
        if (tooltip) {
          tooltip.textContent = `${newW.toFixed(1)} √ó ${newH.toFixed(1)} –º–º`;
        }

        (node as any).dataset.lastMm = JSON.stringify({ x: newX, y: newY, w: newW, h: newH });
      }
    };

    const handlePointerUp = () => {
      if (!dragInfo.current.active) return;

      const { elId, mode, initialItem } = dragInfo.current;
      const node = elId ? elementRefs.current.get(elId) : null;

      if (node && elId) {
        const lastMm = (node as any).dataset.lastMm;
        const finalData = lastMm ? JSON.parse(lastMm) : { x: initialItem?.x, y: initialItem?.y, w: initialItem?.width, h: initialItem?.height };

        setElements((prev) =>
          prev.map((el) => {
            if (el.id === elId) {
              const updated = { ...el, x: finalData.x, y: finalData.y, width: finalData.w, height: finalData.h };

              if (mode === "RESIZE" && el.type === "TEXT" && initialItem?.height !== finalData.h) {
                updated.fontSize = Math.max(6, Math.round(finalData.h * 2.8));
              }
              return updated;
            }
            return el;
          })
        );

        delete (node as any).dataset.lastMm;
      }

      dragInfo.current = {
        active: false,
        mode: null,
        elId: null,
        startX: 0,
        startY: 0,
        initialItem: null,
      };
    };

    window.addEventListener("pointermove", handlePointerMove);
    window.addEventListener("pointerup", handlePointerUp);

    return () => {
      window.removeEventListener("pointermove", handlePointerMove);
      window.removeEventListener("pointerup", handlePointerUp);
    };
  }, []);

  const handleStartDrag = (e: React.PointerEvent, id: string, mode: "MOVE" | "RESIZE") => {
    if (e.button !== 0) return;
    e.preventDefault();
    e.stopPropagation();

    const el = elements.find((x) => x.id === id);
    if (!el) return;

    setSelectedId(id);

    dragInfo.current = {
      active: true,
      mode,
      elId: id,
      startX: e.clientX,
      startY: e.clientY,
      initialItem: { ...el },
    };
  };


  const addElement = (type: LabelElementType, extra: Partial<LabelElement> = {}) => {
    const id = Date.now().toString() + Math.random().toString().slice(2, 6);

    const defaultSizes: Record<LabelElementType, { w: number; h: number }> = {
      TEXT: { w: 30, h: 10 },
      QR: { w: 20, h: 20 },
      LINE: { w: 30, h: 2 },
      RECTANGLE: { w: 30, h: 20 },
      IMAGE: { w: 20, h: 20 },
      COUNTER: { w: 25, h: 8 },
      ICON: { w: 15, h: 15 },
    };

    const defaults = defaultSizes[type] || { w: 20, h: 20 };

    const newEl: LabelElement = {
      id,
      type,
      x: 5,
      y: 5,
      width: defaults.w,
      height: defaults.h,
      fontSize: 10,
      fontFamily: "Arial, sans-serif",
      strokeWidth: 0.3,
      align: "left",
      isBold: false,
      content: type === "TEXT" ? "–¢–µ–∫—Å—Ç" : type === "QR" ? "{{code}}" : type === "COUNTER" ? "{{current}} / {{total}}" : "",
      qrSource: type === "QR" ? "code" : undefined,
      qrDescription: type === "QR" ? "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞" : undefined,
      counterFormat: type === "COUNTER" ? "{{current}} / {{total}}" : undefined,
      ...extra,
    };

    setElements((prev) => {
      if (type === "RECTANGLE" || type === "LINE") return [newEl, ...prev];
      return [...prev, newEl];
    });

    setSelectedId(id);
  };

  const updateSelected = (updates: Partial<LabelElement>) => {
    if (!selectedId) return;
    setElements((prev) => prev.map((el) => (el.id === selectedId ? { ...el, ...updates } : el)));
  };

  const deleteSelected = () => {
    if (!selectedId) return;
    setElements((prev) => prev.filter((el) => el.id !== selectedId));
    setSelectedId(null);
  };


  const handleImageUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const dataUrl = event.target?.result as string;
      addElement("IMAGE", {
        imageUrl: dataUrl,
        imageName: file.name,
        width: 20,
        height: 20,
      });
      toast.success(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "${file.name}" –¥–æ–±–∞–≤–ª–µ–Ω–æ`);
    };
    reader.readAsDataURL(file);

    e.target.value = "";
  }, []);


  const handleIconUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
      return;
    }

    if (file.size > 100 * 1024) {
      toast.error("–ò–∫–æ–Ω–∫–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (–º–∞–∫—Å. 100KB)");
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const dataUrl = event.target?.result as string;
      const iconName = file.name.replace(/\.[^.]+$/, "");
      const iconType = `custom_${Date.now()}`;

      setCustomIcons(prev => [...prev, {
        type: iconType,
        label: iconName,
        imageUrl: dataUrl,
      }]);

      toast.success(`–ò–∫–æ–Ω–∫–∞ "${iconName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É`);
    };
    reader.readAsDataURL(file);

    e.target.value = "";
  }, []);


  const deleteCustomIcon = useCallback((iconType: string) => {
    setCustomIcons(prev => prev.filter(i => i.type !== iconType));
    toast.success("–ò–∫–æ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏");
  }, []);


  const handleFontUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const ext = file.name.split('.').pop()?.toLowerCase();
    if (!['ttf', 'otf', 'woff', 'woff2'].includes(ext || '')) {
      toast.error("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ TTF, OTF, WOFF, WOFF2");
      return;
    }

    if (file.size > 2 * 1024 * 1024) {
      toast.error("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ 2MB");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const fontDataUrl = reader.result as string;
      const fontName = file.name.replace(/\.(ttf|otf|woff|woff2)$/i, '');

      if (customFonts.find(f => f.name === fontName)) {
        toast.error("–®—Ä–∏—Ñ—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
        return;
      }

      setCustomFonts((prev) => [...prev, {
        name: fontName,
        fontFamily: `'${fontName}', sans-serif`,
        fontDataUrl,
      }]);
      toast.success(`–®—Ä–∏—Ñ—Ç "${fontName}" –∑–∞–≥—Ä—É–∂–µ–Ω`);
    };
    reader.readAsDataURL(file);
    e.target.value = "";
  }, [customFonts]);


  const _deleteCustomFont = useCallback((fontName: string) => {
    setCustomFonts((prev) => prev.filter((f) => f.name !== fontName));
    const styleEl = document.getElementById(`custom-font-${fontName.replace(/\s+/g, '-')}`);
    if (styleEl) styleEl.remove();
    toast.success("–®—Ä–∏—Ñ—Ç —É–¥–∞–ª—ë–Ω");
  }, []);

  const activeElement = elements.find((el) => el.id === selectedId);

  const gridBgSize = PX_PER_MM * zoom * 5;


  const getQrDisplayInfo = (el: LabelElement) => {
    const source = QR_SOURCES.find(s => s.value === el.qrSource);
    return source || QR_SOURCES[0];
  };

  return (
    <div className="flex flex-col h-[90vh] bg-gradient-to-br from-slate-100 to-slate-200 font-sans text-slate-800 rounded-xl overflow-hidden shadow-2xl border border-slate-300 select-none">

      <input
        ref={fileInputRef}
        type="file"
        accept="image/*"
        className="hidden"
        onChange={handleImageUpload}
      />


      <input
        ref={iconUploadRef}
        type="file"
        accept="image/*"
        className="hidden"
        onChange={handleIconUpload}
      />


      <input
        ref={fontUploadRef}
        type="file"
        accept=".ttf,.otf,.woff,.woff2"
        className="hidden"
        onChange={handleFontUpload}
      />


      <div className="h-auto min-h-[64px] bg-white border-b flex flex-wrap items-center px-4 py-2 justify-between shrink-0 z-20 shadow-sm gap-2">

        <div className="flex gap-1 flex-wrap">
          <ToolBtn icon={<Type />} label="–¢–µ–∫—Å—Ç" onClick={() => addElement("TEXT")} />


          <div className="relative">
            <ToolBtn
              icon={<QrCode />}
              label="QR"
              onClick={() => {
                addElement("QR", { width: 20, height: 20 });
                setShowQrHelper(true);
              }}
            />
          </div>


          <ToolBtn
            icon={<Hash />}
            label="–°—á—ë—Ç—á–∏–∫"
            onClick={() => addElement("COUNTER", { width: 25, height: 8 })}
            title="–ù—É–º–µ—Ä–∞—Ü–∏—è —ç—Ç–∏–∫–µ—Ç–æ–∫: 1/100, 2/100..."
          />

          <div className="w-px h-8 bg-slate-200 mx-1 self-center"></div>


          <ToolBtn
            icon={<Upload />}
            label="–ö–∞—Ä—Ç–∏–Ω–∫–∞"
            onClick={() => fileInputRef.current?.click()}
            title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—ë –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
          />


          <div className="relative">
            <ToolBtn
              icon={<Library />}
              label="–ò–∫–æ–Ω–∫–∏"
              onClick={() => setShowIconPicker(!showIconPicker)}
              title="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è —ç—Ç–∏–∫–µ—Ç–æ–∫"
            />


            {showIconPicker && (
              <div className="absolute top-full left-0 mt-1 bg-white rounded-xl shadow-2xl border border-slate-200 p-3 z-50 w-72 max-h-96 overflow-y-auto">

                <div className="text-xs font-bold text-slate-500 mb-2 uppercase">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–ì–û–°–¢ 14192)</div>
                <div className="grid grid-cols-4 gap-2 mb-3">
                  {DEFAULT_ICON_LIBRARY.map((iconItem) => (
                    <button
                      key={iconItem.type}
                      onClick={() => {
                        addElement("ICON", {
                          iconType: iconItem.type,
                          content: iconItem.label,
                          width: 15,
                          height: 15
                        });
                        setShowIconPicker(false);
                      }}
                      className="flex flex-col items-center p-2 hover:bg-indigo-50 rounded-lg transition-colors group border border-transparent hover:border-indigo-200"
                      title={iconItem.label}
                    >
                      <div
                        className="w-8 h-8"
                        dangerouslySetInnerHTML={{ __html: iconItem.svg }}
                      />
                      <span className="text-[8px] mt-1 text-slate-500 group-hover:text-indigo-600 text-center leading-tight">
                        {iconItem.label}
                      </span>
                    </button>
                  ))}
                </div>


                {customIcons.length > 0 && (
                  <>
                    <div className="text-xs font-bold text-emerald-600 mb-2 uppercase border-t pt-2">–ú–æ–∏ –∏–∫–æ–Ω–∫–∏</div>
                    <div className="grid grid-cols-4 gap-2 mb-3">
                      {customIcons.map((iconItem) => (
                        <div key={iconItem.type} className="relative group">
                          <button
                            onClick={() => {
                              addElement("ICON", {
                                iconType: iconItem.type,
                                content: iconItem.label,
                                imageUrl: iconItem.imageUrl,
                                width: 15,
                                height: 15
                              });
                              setShowIconPicker(false);
                            }}
                            className="flex flex-col items-center p-2 hover:bg-emerald-50 rounded-lg transition-colors w-full"
                            title={iconItem.label}
                          >
                            <img src={iconItem.imageUrl} alt={iconItem.label} className="w-6 h-6 object-contain" />
                            <span className="text-[8px] mt-1 text-slate-500 text-center leading-tight truncate w-full">
                              {iconItem.label}
                            </span>
                          </button>

                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteCustomIcon(iconItem.type);
                            }}
                            className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[10px] opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-600"
                            title="–£–¥–∞–ª–∏—Ç—å –∏–∫–æ–Ω–∫—É"
                          >
                            √ó
                          </button>
                        </div>
                      ))}
                    </div>
                  </>
                )}


                <button
                  onClick={() => iconUploadRef.current?.click()}
                  className="w-full flex items-center justify-center gap-2 p-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 transition-colors text-sm"
                >
                  <Upload size={16} />
                  <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é –∏–∫–æ–Ω–∫—É</span>
                </button>
                <div className="text-[10px] text-slate-400 text-center mt-1">PNG/SVG, –º–∞–∫—Å. 100KB</div>
              </div>
            )}
          </div>

          <div className="w-px h-8 bg-slate-200 mx-1 self-center"></div>


          <ToolBtn
            icon={<Minus />}
            label="–õ–∏–Ω–∏—è"
            onClick={() => addElement("LINE", { width: 30, height: 0.5, strokeWidth: 0.3 })}
          />


          <ToolBtn
            icon={<Square />}
            label="–†–∞–º–∫–∞"
            onClick={() => addElement("RECTANGLE", { strokeWidth: 0.3 })}
          />

          <div className="w-px h-8 bg-slate-200 mx-1 self-center"></div>


          <div className="flex items-center gap-1 bg-slate-50 rounded-lg px-2 py-1 border">
            <button onClick={() => setZoom((z) => Math.max(0.5, z - 0.25))} className="p-1 hover:bg-slate-200 rounded" type="button">
              <ZoomOut size={16} />
            </button>
            <span className="text-xs font-medium w-10 text-center tabular-nums">{Math.round(zoom * 100)}%</span>
            <button onClick={() => setZoom((z) => Math.min(3, z + 0.25))} className="p-1 hover:bg-slate-200 rounded" type="button">
              <ZoomIn size={16} />
            </button>
          </div>
        </div>


        <div className="flex items-center gap-2">
          <button
            onClick={() => setShowHelp(!showHelp)}
            className={clsx(
              "flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              showHelp ? "bg-amber-100 text-amber-700 border border-amber-300" : "bg-slate-100 text-slate-600 hover:bg-slate-200"
            )}
            type="button"
          >
            <HelpCircle size={18} />
            <span className="hidden sm:inline">–°–ø—Ä–∞–≤–∫–∞</span>
          </button>

          {onClose && (
            <button
              onClick={onClose}
              className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
              title="–ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä"
              type="button"
            >
              <X size={20} />
            </button>
          )}
        </div>
      </div>


      {activeElement && (
        <div className="bg-gradient-to-r from-indigo-50 to-violet-50 border-b px-4 py-3 shrink-0 z-10">
          <div className="flex items-center gap-3 flex-wrap">

            <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border border-indigo-200 shadow-sm">
              {activeElement.type === "TEXT" && <Type size={16} className="text-indigo-600" />}
              {activeElement.type === "QR" && <QrCode size={16} className="text-indigo-600" />}
              {activeElement.type === "IMAGE" && <ImageIcon size={16} className="text-indigo-600" />}
              {activeElement.type === "COUNTER" && <Hash size={16} className="text-indigo-600" />}
              {activeElement.type === "ICON" && <Library size={16} className="text-indigo-600" />}
              {(activeElement.type === "LINE" || activeElement.type === "RECTANGLE") && <Layers size={16} className="text-indigo-600" />}
              <span className="text-xs font-bold text-indigo-800 uppercase">
                {activeElement.type === "TEXT" && "–¢–µ–∫—Å—Ç"}
                {activeElement.type === "QR" && "QR-–∫–æ–¥"}
                {activeElement.type === "IMAGE" && "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"}
                {activeElement.type === "COUNTER" && "–°—á—ë—Ç—á–∏–∫"}
                {activeElement.type === "ICON" && "–ò–∫–æ–Ω–∫–∞"}
                {activeElement.type === "LINE" && "–õ–∏–Ω–∏—è"}
                {activeElement.type === "RECTANGLE" && "–†–∞–º–∫–∞"}
              </span>
            </div>


            {activeElement.type === "TEXT" && (
              <>

                <div className="relative shrink-0" style={{ width: '220px' }}>
                  <textarea
                    value={activeElement.content || ""}
                    onChange={(e) => updateSelected({ content: e.target.value })}
                    className="w-full text-sm px-3 py-2 border border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none bg-white shadow-sm resize-none"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."
                    rows={1}
                    style={{
                      minHeight: '38px',
                      height: 'auto',
                      maxHeight: '80px',
                      overflow: 'auto'
                    }}
                    onInput={(e) => {
                      const target = e.target as HTMLTextAreaElement;
                      target.style.height = '38px';
                      target.style.height = Math.min(target.scrollHeight, 80) + 'px';
                    }}
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                  />
                </div>


                <div className="relative shrink-0">
                  <select
                    className="text-sm pl-3 pr-7 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none appearance-none"
                    style={{ width: '130px' }}
                    value=""
                    onChange={(e) => {
                      if (e.target.value) updateSelected({ content: (activeElement.content || "") + e.target.value });
                    }}
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                  >
                    <option value="">+ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è</option>
                    {TEXT_VARIABLES.filter(v => v.value).map((v) => (
                      <option key={v.value} value={v.value}>{v.label}</option>
                    ))}
                  </select>
                  <Database size={14} className="absolute right-2 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none" />
                </div>


                <div className="flex items-center gap-1 shrink-0">
                  <select
                    value={activeElement.fontFamily ?? "Arial, sans-serif"}
                    onChange={(e) => {
                      const newFont = e.target.value;
                      updateSelected({ fontFamily: newFont });
                    }}
                    className="text-sm px-2 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none shadow-sm"
                    style={{ width: '130px' }}
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                  >
                    <optgroup label="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ">
                      <option value="Arial, sans-serif">Arial</option>
                      <option value="'Times New Roman', serif">Times New Roman</option>
                      <option value="'Courier New', monospace">Courier New</option>
                      <option value="Verdana, sans-serif">Verdana</option>
                      <option value="Tahoma, sans-serif">Tahoma</option>
                    </optgroup>
                    <optgroup label="–ì–û–°–¢">
                      <option value="'GOST type A', sans-serif">GOST type A</option>
                      <option value="'GOST type B', sans-serif">GOST type B</option>
                    </optgroup>
                    {customFonts.length > 0 && (
                      <optgroup label="–ú–æ–∏ —à—Ä–∏—Ñ—Ç—ã">
                        {customFonts.map((f) => (
                          <option key={f.name} value={f.fontFamily}>{f.name}</option>
                        ))}
                      </optgroup>
                    )}
                  </select>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      fontUploadRef.current?.click();
                    }}
                    className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                    title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —à—Ä–∏—Ñ—Ç (TTF, OTF, WOFF)"
                    type="button"
                  >
                    <Upload size={16} />
                  </button>
                </div>


                <div className="flex items-center bg-white border border-indigo-200 rounded-lg overflow-hidden shadow-sm">
                  <button
                    onClick={() => updateSelected({ fontSize: Math.max(6, (activeElement.fontSize || 10) - 1) })}
                    className="px-3 py-2 hover:bg-slate-50 text-sm font-bold text-indigo-600"
                    type="button"
                  >
                    ‚àí
                  </button>
                  <input
                    type="text"
                    inputMode="numeric"
                    value={isEditingFontSize ? fontSizeInput : (activeElement.fontSize || 10)}
                    onFocus={(e) => {
                      setIsEditingFontSize(true);
                      setFontSizeInput(String(activeElement.fontSize || 10));
                      e.target.select();
                    }}
                    onChange={(e) => {

                      const value = e.target.value.replace(/[^0-9]/g, '');
                      setFontSizeInput(value);
                    }}
                    onBlur={() => {
                      setIsEditingFontSize(false);
                      const val = parseInt(fontSizeInput);
                      if (!isNaN(val) && val >= 6 && val <= 200) {
                        updateSelected({ fontSize: val });
                      }

                    }}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        e.currentTarget.blur();
                      }
                      if (e.key === 'Escape') {
                        setIsEditingFontSize(false);
                        setFontSizeInput('');
                      }
                    }}
                    className="w-14 text-sm font-bold text-center tabular-nums border-x border-indigo-100 py-2 outline-none focus:bg-indigo-50 focus:ring-2 focus:ring-indigo-300"
                    onPointerDown={(e) => e.stopPropagation()}
                  />
                  <button
                    onClick={() => updateSelected({ fontSize: Math.min(200, (activeElement.fontSize || 10) + 1) })}
                    className="px-3 py-2 hover:bg-slate-50 text-sm font-bold text-indigo-600"
                    type="button"
                  >
                    +
                  </button>
                </div>


                <button
                  onClick={() => updateSelected({ isBold: !activeElement.isBold })}
                  className={clsx(
                    "w-9 h-9 border rounded-lg flex items-center justify-center font-bold transition-all shadow-sm",
                    activeElement.isBold ? "bg-indigo-600 text-white border-indigo-600" : "bg-white border-indigo-200 hover:bg-slate-50"
                  )}
                  type="button"
                >
                  B
                </button>


                <div className="flex bg-white border border-indigo-200 rounded-lg overflow-hidden shadow-sm">
                  {["left", "center", "right"].map((align) => (
                    <button
                      key={align}
                      onClick={() => updateSelected({ align: align as "left" | "center" | "right" })}
                      className={clsx("p-2 hover:bg-slate-50", activeElement.align === align && "bg-indigo-100 text-indigo-700")}
                      type="button"
                    >
                      {align === "left" && <AlignLeft size={16} />}
                      {align === "center" && <AlignCenter size={16} />}
                      {align === "right" && <AlignRight size={16} />}
                    </button>
                  ))}
                </div>
              </>
            )}


            {activeElement.type === "QR" && (
              <div className="flex items-center gap-3 flex-wrap">
                <div className="flex flex-col gap-1">
                  <label className="text-[10px] font-bold text-indigo-600 uppercase">–ß—Ç–æ –±—É–¥–µ—Ç –≤ QR:</label>
                  <select
                    value={activeElement.qrSource || "code"}
                    onChange={(e) => {
                      const source = QR_SOURCES.find(s => s.value === e.target.value);
                      if (source) {
                        updateSelected({
                          qrSource: e.target.value as any,
                          content: source.template,
                          qrDescription: source.label
                        });
                      }
                    }}
                    className="text-sm px-3 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none shadow-sm min-w-[180px]"
                    onPointerDown={(e) => e.stopPropagation()}
                  >
                    {QR_SOURCES.map((s) => (
                      <option key={s.value} value={s.value}>{s.label}</option>
                    ))}
                  </select>
                </div>

                {activeElement.qrSource === "custom" && (
                  <input
                    value={activeElement.content || ""}
                    onChange={(e) => updateSelected({ content: e.target.value })}
                    className="w-48 text-sm px-3 py-2 border border-indigo-200 rounded-lg focus:border-indigo-500 outline-none bg-white shadow-sm"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è QR..."
                    onPointerDown={(e) => e.stopPropagation()}
                  />
                )}


                <div className="flex items-start gap-2 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 max-w-sm">
                  <Info size={16} className="text-blue-500 shrink-0 mt-0.5" />
                  <div className="text-xs text-blue-700">
                    <div className="font-semibold">{getQrDisplayInfo(activeElement).description}</div>
                    <div className="text-blue-500 mt-0.5">–ü—Ä–∏–º–µ—Ä: {getQrDisplayInfo(activeElement).example}</div>
                  </div>
                </div>
              </div>
            )}


            {activeElement.type === "COUNTER" && (
              <div className="flex items-center gap-3 flex-wrap">
                <div className="flex flex-col gap-1">
                  <label className="text-[10px] font-bold text-indigo-600 uppercase">–§–æ—Ä–º–∞—Ç –Ω—É–º–µ—Ä–∞—Ü–∏–∏:</label>
                  <select
                    value={activeElement.counterFormat || COUNTER_FORMATS[0].value}
                    onChange={(e) => updateSelected({ counterFormat: e.target.value, content: e.target.value })}
                    className="text-sm px-3 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none shadow-sm min-w-[200px]"
                    onPointerDown={(e) => e.stopPropagation()}
                  >
                    {COUNTER_FORMATS.map((f) => (
                      <option key={f.value} value={f.value}>{f.label} ‚Äî {f.description}</option>
                    ))}
                  </select>
                </div>

                <div className="flex items-center bg-white border border-indigo-200 rounded-lg overflow-hidden shadow-sm">
                  <button onClick={() => updateSelected({ fontSize: Math.max(6, (activeElement.fontSize || 14) - 1) })} className="px-3 py-2 hover:bg-slate-50 text-sm font-bold" type="button">‚àí</button>
                  <span className="text-sm font-bold w-8 text-center tabular-nums border-x border-indigo-100">{activeElement.fontSize || 14}</span>
                  <button onClick={() => updateSelected({ fontSize: (activeElement.fontSize || 14) + 1 })} className="px-3 py-2 hover:bg-slate-50 text-sm font-bold" type="button">+</button>
                </div>

                <button
                  onClick={() => updateSelected({ isBold: !activeElement.isBold })}
                  className={clsx(
                    "w-9 h-9 border rounded-lg flex items-center justify-center font-bold transition-all shadow-sm",
                    activeElement.isBold ? "bg-indigo-600 text-white border-indigo-600" : "bg-white border-indigo-200 hover:bg-slate-50"
                  )}
                  type="button"
                >B</button>


                <div className="flex items-center gap-2 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2">
                  <Eye size={14} className="text-emerald-600" />
                  <span className="text-sm font-mono font-bold text-emerald-800">
                    {(activeElement.counterFormat || "{{current}} / {{total}}")
                      .replace("{{current}}", "1")
                      .replace("{{total}}", "100")}
                  </span>
                </div>
              </div>
            )}


            {activeElement.type === "IMAGE" && activeElement.imageName && (
              <div className="flex items-center gap-2 bg-slate-100 px-3 py-2 rounded-lg">
                <ImageIcon size={16} className="text-slate-500" />
                <span className="text-sm text-slate-600 truncate max-w-[200px]">{activeElement.imageName}</span>
              </div>
            )}


            {activeElement.type === "ICON" && (
              <div className="flex items-center gap-2 bg-slate-100 px-3 py-2 rounded-lg">
                <span className="text-sm font-medium text-slate-600">{activeElement.content || "–ò–∫–æ–Ω–∫–∞"}</span>
              </div>
            )}


            {(activeElement.type === "LINE" || activeElement.type === "RECTANGLE") && (
              <div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-indigo-200 shadow-sm">
                <span className="text-xs text-indigo-900 font-medium">–¢–æ–ª—â–∏–Ω–∞:</span>
                <input
                  type="number"
                  step={0.1}
                  min={0.1}
                  value={activeElement.strokeWidth}
                  onChange={(e) => updateSelected({ strokeWidth: parseFloat(e.target.value) })}
                  className="w-14 text-sm border-b border-indigo-300 px-1 py-0.5 text-center focus:outline-none focus:border-indigo-600 bg-transparent"
                  onPointerDown={(e) => e.stopPropagation()}
                />
                <span className="text-xs text-slate-400">–º–º</span>
              </div>
            )}

            <div className="flex-1"></div>


            <button
              onClick={deleteSelected}
              className="flex items-center gap-2 text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors border border-transparent hover:border-red-200"
              title="–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç"
              type="button"
            >
              <Trash2 size={18} />
              <span className="text-sm font-medium">–£–¥–∞–ª–∏—Ç—å</span>
            </button>
          </div>
        </div>
      )}


      {!activeElement && (
        <div className="bg-slate-50 border-b px-4 py-3 shrink-0">
          <div className="flex items-center gap-2 text-slate-400 text-sm">
            <MousePointer2 size={16} />
            <span>–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —ç—Ç–∏–∫–µ—Ç–∫–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —Å –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</span>
          </div>
        </div>
      )}


      <div className="flex-1 flex overflow-hidden">

        <div
          className="flex-1 overflow-auto bg-slate-300/50 flex items-center justify-center relative touch-none p-8"
          style={{
            backgroundImage: "radial-gradient(circle, #94a3b8 1px, transparent 1px)",
            backgroundSize: "20px 20px",
          }}
          onPointerDown={() => {
            setSelectedId(null);
            setShowIconPicker(false);
          }}
        >
        <div
          className="bg-white shadow-2xl relative transition-transform duration-75 rounded-sm"
          style={{
            width: size.w * PX_PER_MM * zoom,
            height: size.h * PX_PER_MM * zoom,
            backgroundImage: "linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px)",
            backgroundSize: `${gridBgSize}px ${gridBgSize}px`,
          }}
          onPointerDown={(e) => e.stopPropagation()}
        >
          {elements.map((el, idx) => {
            const isSelected = selectedId === el.id;

            const style: React.CSSProperties = {
              left: `${el.x * PX_PER_MM * zoom}px`,
              top: `${el.y * PX_PER_MM * zoom}px`,
              width: `${el.width * PX_PER_MM * zoom}px`,
              height: `${el.height * PX_PER_MM * zoom}px`,
              zIndex: isSelected ? 9999 : idx + 1,
            };

            const strokePx = (el.strokeWidth || 0.1) * PX_PER_MM * zoom;

            return (
              <div
                key={el.id}
                ref={(node) => {
                  if (node) elementRefs.current.set(el.id, node);
                  else elementRefs.current.delete(el.id);
                }}
                className={clsx(
                  "absolute box-border transition-shadow",
                  isSelected
                    ? "outline outline-2 outline-indigo-500 shadow-lg shadow-indigo-200/50"
                    : "hover:outline hover:outline-1 hover:outline-indigo-300"
                )}
                style={style}
                onPointerDown={(e) => handleStartDrag(e, el.id, "MOVE")}
              >

                {el.type === "TEXT" && (
                  <div
                    className="w-full h-full whitespace-pre-wrap break-words leading-none pointer-events-none overflow-hidden"
                    style={{
                      fontSize: `${(el.fontSize || 10) * PX_PER_MM * zoom * 0.35}px`,
                      fontWeight: el.isBold ? "bold" : "normal",
                      fontFamily: el.fontFamily || "Arial, sans-serif",
                      textAlign: el.align,
                      color: "#1e293b",
                    }}
                  >
                    {el.content}
                  </div>
                )}


                {el.type === "QR" && (
                  <div className="w-full h-full p-[2px] pointer-events-none flex items-center justify-center bg-white rounded-sm">
                    <QRCode value={el.content || "QR"} style={{ width: "100%", height: "100%" }} viewBox="0 0 256 256" />
                  </div>
                )}


                {el.type === "IMAGE" && (
                  <div className="w-full h-full pointer-events-none flex items-center justify-center bg-slate-50 rounded-sm overflow-hidden">
                    {el.imageUrl ? (
                      <img src={el.imageUrl} alt={el.imageName || "Image"} className="w-full h-full object-contain" />
                    ) : (
                      <ImageIcon size={24} className="text-slate-300" />
                    )}
                  </div>
                )}


                {el.type === "COUNTER" && (
                  <div
                    className="w-full h-full whitespace-nowrap pointer-events-none flex items-center justify-center overflow-hidden"
                    style={{
                      fontSize: `${(el.fontSize || 14) * PX_PER_MM * zoom * 0.35}px`,
                      fontWeight: el.isBold ? "bold" : "normal",
                      color: "#1e293b",
                      fontFamily: "monospace",
                    }}
                  >
                    {(el.counterFormat || "{{current}} / {{total}}")
                      .replace("{{current}}", "1")
                      .replace("{{total}}", "100")}
                  </div>
                )}


                {el.type === "ICON" && (
                  <div className="w-full h-full pointer-events-none flex items-center justify-center p-0.5">
                    {(() => {
                      const iconData = DEFAULT_ICON_LIBRARY.find(i => i.type === el.iconType);
                      if (iconData && iconData.svg) {
                        return (
                          <div
                            className="w-full h-full"
                            dangerouslySetInnerHTML={{ __html: iconData.svg }}
                          />
                        );
                      }

                      if (el.imageUrl) {
                        return <img src={el.imageUrl} alt={el.content || 'Icon'} className="w-full h-full object-contain" />;
                      }

                      const customIcon = customIcons.find(i => i.type === el.iconType);
                      if (customIcon) {
                        return <img src={customIcon.imageUrl} alt={customIcon.label} className="w-full h-full object-contain" />;
                      }

                      return <AlertTriangle size={20} className="text-slate-400" />;
                    })()}
                  </div>
                )}


                {(el.type === "LINE" || el.type === "RECTANGLE") && (
                  <svg className="w-full h-full pointer-events-none overflow-visible" xmlns="http://www.w3.org/2000/svg">
                    {el.type === "RECTANGLE" ? (
                      <rect x="0" y="0" width="100%" height="100%" fill="none" stroke="black" strokeWidth={strokePx} vectorEffect="non-scaling-stroke" />
                    ) : el.width >= el.height ? (
                      <line x1="0" y1="50%" x2="100%" y2="50%" stroke="black" strokeWidth={strokePx} vectorEffect="non-scaling-stroke" />
                    ) : (
                      <line x1="50%" y1="0" x2="50%" y2="100%" stroke="black" strokeWidth={strokePx} vectorEffect="non-scaling-stroke" />
                    )}
                  </svg>
                )}


                {isSelected && (
                  <>
                    <div
                      className="absolute -bottom-2 -right-2 w-5 h-5 bg-indigo-600 rounded-full cursor-nwse-resize flex items-center justify-center shadow-lg hover:scale-110 transition-transform z-50"
                      onPointerDown={(e) => handleStartDrag(e, el.id, "RESIZE")}
                    >
                      <GripHorizontal size={12} className="text-white -rotate-45" />
                    </div>

                    <div className="resize-tooltip absolute -top-7 left-0 bg-indigo-600 text-white text-[10px] px-2 py-1 rounded-md opacity-90 pointer-events-none whitespace-nowrap shadow-md font-mono">
                      {el.width.toFixed(1)} √ó {el.height.toFixed(1)} –º–º
                    </div>


                    <div className="absolute -top-7 right-0 bg-slate-700 text-white text-[9px] px-1.5 py-0.5 rounded opacity-80 pointer-events-none uppercase font-bold">
                      {el.type === "QR" && el.qrSource && `QR: ${QR_SOURCES.find(s => s.value === el.qrSource)?.label || el.qrSource}`}
                      {el.type === "COUNTER" && "–°—á—ë—Ç—á–∏–∫"}
                      {el.type === "IMAGE" && "–ö–∞—Ä—Ç–∏–Ω–∫–∞"}
                      {el.type === "ICON" && el.content}
                    </div>
                  </>
                )}
              </div>
            );
          })}
        </div>
      </div>


      {showHelp && (
        <div className="w-80 bg-white border-l border-slate-200 overflow-y-auto shrink-0 shadow-lg">
          <div className="sticky top-0 bg-gradient-to-r from-amber-50 to-orange-50 border-b px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <BookOpen size={20} className="text-amber-600" />
              <span className="font-bold text-amber-900">–°–ø—Ä–∞–≤–∫–∞</span>
            </div>
            <button
              onClick={() => setShowHelp(false)}
              className="p-1 hover:bg-amber-100 rounded text-amber-600"
              type="button"
            >
              <X size={18} />
            </button>
          </div>

          <div className="p-4 space-y-5 text-sm">

            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Database size={18} className="text-indigo-500" />
                –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
              </h3>
              <div className="space-y-2">
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{code}}"}</code>
                  <p className="text-slate-600 mt-1">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: 7342511000501</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{name}}"}</code>
                  <p className="text-slate-600 mt-1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: –ü—Ä–∏—ë–º–Ω–∏–∫ 2xLR1121</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{contract}}"}</code>
                  <p className="text-slate-600 mt-1">–ù–æ–º–µ—Ä –≥–æ—Å–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: ‚Ññ 249/2/–û–ü/25/1/37</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{date}}"}</code>
                  <p className="text-slate-600 mt-1">–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: 20.01.2026, 15:30</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{quantity}}"}</code>
                  <p className="text-slate-600 mt-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: 500</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{unit}}"}</code>
                  <p className="text-slate-600 mt-1">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: —à—Ç.</p>
                </div>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Hash size={18} className="text-emerald-500" />
                –°—á—ë—Ç—á–∏–∫ (–Ω—É–º–µ—Ä–∞—Ü–∏—è —ç—Ç–∏–∫–µ—Ç–æ–∫)
              </h3>
              <div className="bg-emerald-50 p-3 rounded-lg border border-emerald-100 space-y-2">
                <p className="text-slate-600">–ü—Ä–∏ –ø–µ—á–∞—Ç–∏ 100 —ç—Ç–∏–∫–µ—Ç–æ–∫:</p>
                <div className="grid grid-cols-2 gap-2 text-xs">
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">1 / 100</span>
                    <span className="text-slate-400 ml-2">‚Üê –ø–µ—Ä–≤–∞—è</span>
                  </div>
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">2 / 100</span>
                    <span className="text-slate-400 ml-2">‚Üê –≤—Ç–æ—Ä–∞—è</span>
                  </div>
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">...</span>
                  </div>
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">100 / 100</span>
                    <span className="text-slate-400 ml-2">‚Üê –ø–æ—Å–ª–µ–¥–Ω—è—è</span>
                  </div>
                </div>
                <div className="mt-2 text-xs text-slate-500">
                  <code className="text-emerald-600">{"{{current}}"}</code> ‚Äî –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —ç—Ç–∏–∫–µ—Ç–∫–∏<br/>
                  <code className="text-emerald-600">{"{{total}}"}</code> ‚Äî –≤—Å–µ–≥–æ —ç—Ç–∏–∫–µ—Ç–æ–∫ –≤ —Ç–∏—Ä–∞–∂–µ
                </div>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <QrCode size={18} className="text-violet-500" />
                QR-–∫–æ–¥
              </h3>
              <div className="bg-violet-50 p-3 rounded-lg border border-violet-100">
                <p className="text-slate-600">–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ QR –≤—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –≤ –Ω—ë–º –±—É–¥–µ—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ:</p>
                <ul className="mt-2 text-xs text-slate-600 space-y-1">
                  <li>‚Ä¢ <strong>–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞</strong> ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</li>
                  <li>‚Ä¢ <strong>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</strong> ‚Äî –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è</li>
                  <li>‚Ä¢ <strong>–ì–æ—Å–∫–æ–Ω—Ç—Ä–∞–∫—Ç</strong> ‚Äî –Ω–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</li>
                  <li>‚Ä¢ <strong>–°—Å—ã–ª–∫–∞</strong> ‚Äî URL –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                  <li>‚Ä¢ <strong>–°–≤–æ–π —Ç–µ–∫—Å—Ç</strong> ‚Äî –ª—é–±–æ–π —Ç–µ–∫—Å—Ç</li>
                </ul>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Library size={18} className="text-orange-500" />
                –ò–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏
              </h3>
              <div className="bg-orange-50 p-3 rounded-lg border border-orange-100">
                <p className="text-slate-600 mb-2">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –ø–æ –ì–û–°–¢:</p>
                <div className="grid grid-cols-2 gap-2 text-xs">
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Wine size={16} className="text-slate-600" />
                    <span>–•—Ä—É–ø–∫–æ–µ</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Umbrella size={16} className="text-slate-600" />
                    <span>–í–ª–∞–≥–∞</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Flame size={16} className="text-slate-600" />
                    <span>–ù–∞–≥—Ä–µ–≤</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <ArrowUp size={16} className="text-slate-600" />
                    <span>–í–µ—Ä—Ö</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Snowflake size={16} className="text-slate-600" />
                    <span>–ó–∞–º–æ—Ä–æ–∑–∫–∞</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <AlertTriangle size={16} className="text-slate-600" />
                    <span>–í–Ω–∏–º–∞–Ω–∏–µ</span>
                  </div>
                </div>
                <p className="text-slate-500 text-xs mt-2">+ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–∏ –∏–∫–æ–Ω–∫–∏</p>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Info size={18} className="text-cyan-500" />
                –°–æ–≤–µ—Ç—ã
              </h3>
              <div className="bg-cyan-50 p-3 rounded-lg border border-cyan-100 text-xs text-slate-600 space-y-2">
                <p>‚Ä¢ <strong>Shift + —Ç—è–Ω—É—Ç—å</strong> ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ 5–º–º</p>
                <p>‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞</p>
                <p>‚Ä¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –¥–≤–æ–π–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö <code className="text-cyan-700">{"{{}}"}</code> –∑–∞–º–µ–Ω—è—Ç—Å—è –ø—Ä–∏ –ø–µ—á–∞—Ç–∏</p>
                <p>‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —à–∞–±–ª–æ–Ω, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ</p>
              </div>
            </div>
          </div>
        </div>
      )}
      </div>


      <div className="bg-white border-t px-4 py-3 flex items-center justify-between shrink-0 z-20 gap-4 flex-wrap">
        <div className="flex gap-4 text-sm items-center">
          <label className="flex items-center gap-2 text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border">
            <span className="font-bold text-indigo-600">–®:</span>
            <input
              type="number"
              value={size.w}
              onChange={(e) => setSize({ ...size, w: +e.target.value })}
              className="bg-transparent w-12 text-center outline-none font-medium"
            />
            <span className="text-slate-400">–º–º</span>
          </label>
          <label className="flex items-center gap-2 text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border">
            <span className="font-bold text-indigo-600">–í:</span>
            <input
              type="number"
              value={size.h}
              onChange={(e) => setSize({ ...size, h: +e.target.value })}
              className="bg-transparent w-12 text-center outline-none font-medium"
            />
            <span className="text-slate-400">–º–º</span>
          </label>
          <span className="text-slate-400 hidden sm:inline">Shift = –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ</span>
        </div>

        <div className="flex gap-3 items-center">
          <input
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="border rounded-lg px-4 py-2 text-sm w-56 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all"
            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞..."
          />
          <button
            onClick={() => {
              if (!onSave) {
                toast.error("onSave –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
                return;
              }
              onSave(name, size.w, size.h, elements);
              toast.success("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
            }}
            className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-indigo-200 transition-all active:scale-95"
            type="button"
          >
            <Save size={18} /> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  );
};


const ToolBtn = ({ icon, label, onClick, title }: { icon: React.ReactElement; label: string; onClick: () => void; title?: string }) => (
  <button
    onClick={onClick}
    type="button"
    title={title}
    className="flex flex-col items-center justify-center w-14 h-14 hover:bg-indigo-50 text-slate-500 hover:text-indigo-600 rounded-xl transition-all group border border-transparent hover:border-indigo-200"
  >
    <div className="group-hover:-translate-y-0.5 transition-transform">
      {React.cloneElement(icon, { size: 22 })}
    </div>
    <span className="text-[10px] mt-1 font-medium">{label}</span>
  </button>
);

export default LabelConstructor;

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/components/LabelPreview.tsx
================================================================================

import React from "react";
import QRCode from "react-qr-code";

interface LabelPreviewProps {
  label: string;
  project: string;
  batch: string;
  id: string;
  qrValue: string;
  qty: number;
  unit: string;
  isPartial?: boolean;
}

export const LabelPreview: React.FC<LabelPreviewProps> = ({ label, project, batch, id, qrValue, qty, unit, isPartial }) => (
  <div className={`border-2 ${isPartial ? 'border-amber-500 bg-amber-50/30' : 'border-gray-800 bg-white'} rounded-lg p-3 w-full max-w-[280px] shadow-xl relative overflow-hidden group transition-all hover:scale-[1.02]`}>
      {isPartial && <div className="absolute top-0 right-0 bg-amber-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl shadow-sm">–û–°–¢–ê–¢–û–ö</div>}
      <div className="flex gap-3 items-center">
          <div className="bg-white p-1 rounded border border-gray-100">
             {qrValue ? <QRCode value={qrValue} size={70} /> : <div className="w-[70px] h-[70px] bg-gray-100 animate-pulse rounded"/>}
          </div>
          <div className="flex-1 text-left overflow-hidden">
              <div className="text-[9px] font-bold text-gray-400 uppercase tracking-wider flex justify-between">
                  <span>{batch || "–ë–ï–ó –ü–ê–†–¢–ò–ò"}</span>
              </div>
              <div className="text-sm font-black text-gray-900 leading-tight mb-1 line-clamp-2 mt-0.5">
                  {label || "–ò–∑–¥–µ–ª–∏–µ"}
              </div>
              <div className="text-[10px] text-gray-500 truncate mb-1 bg-gray-100 px-1 rounded w-max max-w-full">
                  {project || "–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞"}
              </div>
              <div className="flex items-center justify-between border-t border-gray-200 pt-1.5 mt-1">
                  <span className="font-mono text-[9px] text-gray-400">ID: {id || "..."}</span>
                  <span className={`text-xs font-bold px-1.5 py-0.5 rounded ${isPartial ? 'bg-amber-100 text-amber-800' : 'bg-black text-white'}`}>
                      {qty} {unit}
                  </span>
              </div>
          </div>
      </div>
  </div>
);
================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/components/ProjectDashboard.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchStockBalance } from "src/api/warehouseApi";
import { StockBalanceItem } from "src/types/WarehouseModels";
import { Loader2 } from "lucide-react";

export const ProjectDashboard: React.FC = () => {
    const [topItems, setTopItems] = useState<StockBalanceItem[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {

        fetchStockBalance()
            .then(data => {

                const sorted = data.sort((a, b) => Number(b.totalQuantity) - Number(a.totalQuantity)).slice(0, 3);
                setTopItems(sorted);
            })
            .catch(console.error)
            .finally(() => setLoading(false));
    }, []);

    if (loading) return <div className="flex items-center text-sm text-gray-400"><Loader2 className="animate-spin mr-2 h-4 w-4"/> –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–∞...</div>;

    if (topItems.length === 0) return <div className="text-sm text-gray-400">–°–∫–ª–∞–¥ –ø—É—Å—Ç</div>;

    return (
        <div className="flex gap-4 overflow-x-auto pb-2 w-full md:w-auto">
            {topItems.map((item, idx) => (
                <div key={idx} className="bg-white border border-gray-200 p-3 rounded-xl shadow-sm flex flex-col gap-1 min-w-[200px]">
                    <div className="flex justify-between items-start">
                        <div className="font-bold text-gray-700 text-sm truncate w-32" title={item.label}>
                            {item.label}
                        </div>
                        <div className="text-[10px] font-bold bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded">
                            TOP {idx + 1}
                        </div>
                    </div>


                    <div className="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden mt-1">
                        <div
                            className="bg-emerald-500 h-full rounded-full"
                            style={{ width: idx === 0 ? '100%' : `${(Number(item.totalQuantity) / Number(topItems[0].totalQuantity)) * 100}%` }}
                        ></div>
                    </div>

                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                        <span>–í –Ω–∞–ª–∏—á–∏–∏:</span>
                        <span className="font-bold text-gray-900">{Number(item.totalQuantity).toLocaleString()} {item.unit}</span>
                    </div>
                </div>
            ))}
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/VideoTransmittersLabel.tsx
================================================================================

import React, { useState, useMemo, useEffect } from "react";
import {
    Printer, RefreshCw, ArrowRight,
    Tv, Tag, Ruler, Trash2, FolderOpen, PenTool, LayoutTemplate,

    Wine, Umbrella, ArrowUp, Snowflake, Flame, Package, AlertTriangle
} from "lucide-react";
import { printSpecialLabel } from "src/api/warehouseApi";
import {
    fetchLabelTemplates,
    createLabelTemplate,
    deleteLabelTemplate,
    LabelTemplateModel,
    LabelElement
} from "src/api/labelTemplatesApi";
import { LabelConstructor } from "../components/LabelConstructor";
import QRCode from "react-qr-code";
import toast from "react-hot-toast";
import clsx from "clsx";

type TemplateType = "VIDEO_KIT" | "SIMPLE" | "CUSTOM";


const LabelPreviewCard: React.FC<{
    data: any,
    title: string,
    template: TemplateType,
    size: { w: number, h: number },
    customLayout?: LabelElement[],
    currentIndex?: number,
    totalCount?: number
}> = ({ data, title, template, size, customLayout, currentIndex = 1, totalCount = 1 }) => {

    const infoString = `${data.productName} - ${data.quantity} ${data.unit} (ID: ${data.code})`;


    const baseWidthPx = 300;
    const cssHeight = size.w > 0 ? (baseWidthPx * (size.h / size.w)) : 190;


    const replaceVars = (text: string) => {
        if (!text) return '';
        return text

            .replace(/\{\{code\}\}/g, data.code || '')
            .replace(/\{\{name\}\}/g, data.productName || '')
            .replace(/\{\{productName\}\}/g, data.productName || '')
            .replace(/\{\{id\}\}/g, data.id || '')
            .replace(/\{\{date\}\}/g, data.date || '')
            .replace(/\{\{serial\}\}/g, data.code || '')
            .replace(/\{\{contract\}\}/g, data.contract || '')
            .replace(/\{\{batch\}\}/g, data.batch || '')
            .replace(/\{\{qty\}\}/g, String(data.quantity || ''))
            .replace(/\{\{quantity\}\}/g, String(data.quantity || ''))
            .replace(/\{\{unit\}\}/g, data.unit || '')
            .replace(/\{\{price\}\}/g, data.price || '')
            .replace(/\{\{weight\}\}/g, data.weight || '')

            .replace(/\{\{url\}\}/g, `https://mes.local/item/${data.code}`)

            .replace(/\{\{full_info\}\}/g, infoString)
            .replace(/\{\{quantity_unit\}\}/g, `${data.quantity} ${data.unit}`)

            .replace(/\{\{current\}\}/g, String(currentIndex))
            .replace(/\{\{total\}\}/g, String(totalCount));
    };

    return (
        <div className="flex flex-col items-center animate-fade-in">
            <div className="text-xs font-bold text-gray-400 uppercase mb-2 bg-white px-2 py-1 rounded shadow-sm border border-gray-100">
                {title}
            </div>

            <div className="bg-white shadow-2xl transition-all duration-300">
                <div
                    className="bg-white relative flex flex-col box-border overflow-hidden"
                    style={{
                        width: `${baseWidthPx}px`,
                        height: `${cssHeight}px`,
                        border: '1px solid #000'
                    }}
                >

                    {template === "VIDEO_KIT" && (
                        <div className="flex flex-row h-full p-2">
                            <div className="w-6 border-r border-black flex items-end justify-center py-2 bg-gray-50">
                                <div className="text-[8px] whitespace-nowrap -rotate-90 origin-bottom-left translate-x-full mb-4 w-40 truncate font-mono">
                                    {data.contract}
                                </div>
                            </div>
                            <div className="flex-1 flex flex-col pl-2">
                                <div className="flex justify-between items-start mb-2 shrink-0">
                                    <div className="font-mono text-sm font-bold truncate mt-1">{data.code}</div>
                                    <div><QRCode value={data.code} size={35} /></div>
                                </div>
                                <div className="border-2 border-black text-center text-xs w-full mb-2">
                                    <div className="border-b border-black p-1 font-bold bg-gray-50">{data.productName}</div>
                                    <div className="flex border-b border-black h-10">
                                        <div className="border-r border-black w-1/3 font-bold flex items-center justify-center text-lg">{data.id}</div>
                                        <div className="w-2/3 flex flex-col">
                                            <div className="border-b border-black h-1/2 flex items-center justify-center text-[9px]">{data.date}</div>
                                            <div className="h-1/2 font-bold flex items-center justify-center text-sm">{data.quantity} {data.unit}</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-auto flex justify-center pb-2">
                                    <QRCode value={infoString} size={60} />
                                </div>
                            </div>
                        </div>
                    )}


                    {template === "SIMPLE" && (
                        <div className="h-full flex flex-col justify-center items-center p-2">
                            <div className="text-sm font-bold text-center mb-2 leading-tight">{data.productName}</div>
                            <div className="flex items-center gap-4 w-full justify-center">
                                <QRCode value={infoString} size={70} />
                                <div className="text-left overflow-hidden">
                                    <div className="text-[9px] text-gray-500 uppercase">ID / –ü–∞—Ä—Ç–∏—è</div>
                                    <div className="font-mono font-bold text-sm mb-1 truncate">{data.code}</div>
                                    <div className="font-black text-xl">{data.quantity} {data.unit}</div>
                                </div>
                            </div>
                        </div>
                    )}


                    {template === "CUSTOM" && customLayout && customLayout.map(el => {

                        const elStyle: React.CSSProperties = {
                            position: 'absolute',
                            left: `${(el.x / size.w) * 100}%`,
                            top: `${(el.y / size.h) * 100}%`,
                            width: `${(el.width / size.w) * 100}%`,
                            height: ['QR', 'ICON', 'IMAGE', 'RECTANGLE'].includes(el.type)
                                ? `${(el.height / size.h) * 100}%`
                                : 'auto',
                            fontSize: `${(el.fontSize || 10) * (baseWidthPx / size.w) * 0.35}px`,
                            fontWeight: el.isBold ? 'bold' : 'normal',
                            textAlign: el.align || 'left',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: el.align === 'center' ? 'center' : el.align === 'right' ? 'flex-end' : 'flex-start',
                            overflow: 'hidden',
                        };

                        return (
                            <div key={el.id} style={elStyle}>


                                {el.type === 'TEXT' && (
                                    <span className="whitespace-pre-wrap break-words leading-tight">
                                        {replaceVars(el.content || '')}
                                    </span>
                                )}


                                {el.type === 'QR' && (
                                    <QRCode
                                        value={replaceVars(el.content || '{{code}}')}
                                        style={{ width: '100%', height: '100%' }}
                                        viewBox="0 0 256 256"
                                    />
                                )}


                                {el.type === 'COUNTER' && (
                                    <span
                                        className="whitespace-nowrap font-mono"
                                        style={{ fontWeight: el.isBold ? 'bold' : 'normal' }}
                                    >
                                        {replaceVars(el.counterFormat || '{{current}} / {{total}}')}
                                    </span>
                                )}


                                {el.type === 'IMAGE' && el.imageUrl && (
                                    <img
                                        src={el.imageUrl}
                                        alt={el.imageName || 'Image'}
                                        className="w-full h-full object-contain"
                                    />
                                )}


                                {el.type === 'ICON' && (
                                    <div className="w-full h-full flex items-center justify-center p-0.5">

                                        {el.imageUrl ? (
                                            <img src={el.imageUrl} alt={el.content || 'Icon'} className="w-full h-full object-contain" />
                                        ) : (

                                            <>
                                                {el.iconType === 'fragile' && <Wine className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'keep_dry' && <Umbrella className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'this_side_up' && <ArrowUp className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'keep_frozen' && <Snowflake className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'keep_away_heat' && <Flame className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'do_not_stack' && <Package className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'warning' && <AlertTriangle className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                            </>
                                        )}
                                    </div>
                                )}


                                {el.type === 'LINE' && (
                                    <div
                                        className="bg-black"
                                        style={{
                                            width: el.width >= el.height ? '100%' : `${(el.strokeWidth || 0.3) * 3}px`,
                                            height: el.width >= el.height ? `${(el.strokeWidth || 0.3) * 3}px` : '100%',
                                        }}
                                    />
                                )}


                                {el.type === 'RECTANGLE' && (
                                    <div
                                        className="w-full h-full border-black"
                                        style={{ borderWidth: `${(el.strokeWidth || 0.3) * 2}px` }}
                                    />
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
            <div className="mt-2 text-[10px] text-gray-400 font-mono">
                {size.w} x {size.h} –º–º
            </div>
        </div>
    );
};


export const VideoTransmittersLabel: React.FC = () => {
    const [templateType, setTemplateType] = useState<TemplateType>("VIDEO_KIT");


    const [form, setForm] = useState({
        code: "7342511000501",
        productName: "–ü—Ä–∏–µ–º–Ω–∏–∫ 2xLR1121",
        id: "734",
        date: new Date().toLocaleString('ru-RU'),
        quantity: "500",
        unit: "—à—Ç.",
        contract: "–ì.–∫. ‚Ññ 249/2/–û–ü/25/1/37 –æ—Ç ¬´05¬ª —Å–µ–Ω—Ç—è–±—Ä—è 2025 –≥."
    });

    const [printCount, setPrintCount] = useState<number>(1);
    const [labelSize, setLabelSize] = useState({ width: 140, height: 90 });
    const [loading, setLoading] = useState(false);


    const [isConstructorMode, setIsConstructorMode] = useState(false);
    const [customLayout, setCustomLayout] = useState<LabelElement[]>([]);
    const [customTemplateName, setCustomTemplateName] = useState("");


    const [savedTemplates, setSavedTemplates] = useState<LabelTemplateModel[]>([]);

    useEffect(() => {
        loadTemplates();
    }, []);

    const loadTemplates = async () => {
        try {
            const data = await fetchLabelTemplates();
            setSavedTemplates(data);
        } catch (e) {
            console.error(e);
        }
    };


    const endCode = useMemo(() => {
        try {
            const cleanCode = form.code.replace(/\D/g, '');
            if(!cleanCode) return form.code;
            const startBig = BigInt(cleanCode);
            const countBig = BigInt(Math.max(1, printCount));
            const endBig = startBig + countBig - 1n;
            return endBig.toString().padStart(cleanCode.length, '0');
        } catch {
            return form.code;
        }
    }, [form.code, printCount]);

    const handlePrint = async () => {
        if (printCount < 1) return toast.error("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ø–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0");
        setLoading(true);
        try {
            await printSpecialLabel({
                ...form,
                template: templateType,

                customLayout: templateType === "CUSTOM" ? customLayout : undefined,
                printCount,
                rotate: false,
                widthMm: labelSize.width,
                heightMm: labelSize.height
            });
            toast.success(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${printCount} —ç—Ç–∏–∫–µ—Ç–æ–∫`);
        } catch (e: any) {
            toast.error("–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏: " + e.message);
        } finally {
            setLoading(false);
        }
    };


    const onSaveConstructor = async (name: string, w: number, h: number, layout: LabelElement[]) => {
        try {
            await createLabelTemplate(name, w, h, layout);
            toast.success("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑—É!");
            setIsConstructorMode(false);
            loadTemplates();


            setTemplateType("CUSTOM");
            setCustomLayout(layout);
            setCustomTemplateName(name);
            setLabelSize({ width: w, height: h });
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
    };


    const applySavedTemplate = (t: LabelTemplateModel) => {
        setIsConstructorMode(false);
        setTemplateType("CUSTOM");
        setLabelSize({ width: t.width, height: t.height });
        setCustomLayout(t.layout || []);
        setCustomTemplateName(t.name);
        toast.success(`–ó–∞–≥—Ä—É–∂–µ–Ω –º–∞–∫–µ—Ç: ${t.name}`);
    };

    const deleteSavedTemplate = async (id: number) => {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?")) return;
        await deleteLabelTemplate(id);
        loadTemplates();
        if(customTemplateName && templateType === 'CUSTOM') {
             setTemplateType("VIDEO_KIT");
             setCustomTemplateName("");
        }
    };

    const updateTime = () => {
        setForm(prev => ({...prev, date: new Date().toLocaleString('ru-RU')}));
    };

    const _toggleRotation = () => {
        setLabelSize({ width: labelSize.height, height: labelSize.width });
    };

    return (
        <div className="max-w-7xl mx-auto animate-fade-in pb-10">


            <div className="mb-6 flex flex-col md:flex-row justify-center items-center gap-4">
                <div className="bg-white p-1 rounded-xl border border-gray-200 shadow-sm inline-flex gap-1">
                    <button onClick={() => {setTemplateType("VIDEO_KIT"); setIsConstructorMode(false); setLabelSize({width: 140, height: 90})}} className={clsx("px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all", templateType === "VIDEO_KIT" && !isConstructorMode ? "bg-indigo-600 text-white shadow-md" : "text-gray-500 hover:bg-gray-100")}>
                        <Tv size={18}/> –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
                    </button>
                    <button onClick={() => {setTemplateType("SIMPLE"); setIsConstructorMode(false); setLabelSize({width: 100, height: 60})}} className={clsx("px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all", templateType === "SIMPLE" && !isConstructorMode ? "bg-indigo-600 text-white shadow-md" : "text-gray-500 hover:bg-gray-100")}>
                        <Tag size={18}/> –ü—Ä–æ—Å—Ç–æ–π
                    </button>

                    <button onClick={() => {setTemplateType("CUSTOM"); setIsConstructorMode(false)}} className={clsx("px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all", templateType === "CUSTOM" && !isConstructorMode ? "bg-indigo-600 text-white shadow-md" : "text-gray-500 hover:bg-gray-100")}>
                        <LayoutTemplate size={18}/> {customTemplateName || "–ú–æ–∏ —à–∞–±–ª–æ–Ω—ã"}
                    </button>
                </div>

                <button
                    onClick={() => setIsConstructorMode(!isConstructorMode)}
                    className={clsx("px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all border", isConstructorMode ? "bg-red-50 text-red-600 border-red-200" : "bg-white text-indigo-600 border-indigo-200 hover:bg-indigo-50")}
                >
                    {isConstructorMode ? <Trash2 size={18}/> : <PenTool size={18}/>}
                    {isConstructorMode ? "–ó–∞–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä" : "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä"}
                </button>
            </div>


            {isConstructorMode ? (
                <LabelConstructor
                    initialWidth={labelSize.width}
                    initialHeight={labelSize.height}
                    initialLayout={templateType === 'CUSTOM' ? customLayout : []}
                    onSave={onSaveConstructor as any}
                    onClose={() => setIsConstructorMode(false)}
                />
            ) : (
                <div className="flex flex-col xl:flex-row gap-8">


                    <div className="flex-1 space-y-5 bg-white p-6 rounded-3xl shadow-xl border border-gray-100">
                        <div className="flex items-center gap-2 text-indigo-800 border-b pb-4 mb-2">
                            <Printer className="text-indigo-600"/>
                            <h2 className="text-xl font-bold">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—á–∞—Ç–∏</h2>
                        </div>


                        {savedTemplates.length > 0 && (
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <div className="text-[10px] font-bold text-slate-400 uppercase flex items-center gap-2 mb-2">
                                    <FolderOpen size={12}/> –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω:
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {savedTemplates.map(t => (
                                        <div key={t.id} className={clsx("group flex items-center bg-white border rounded-lg overflow-hidden shadow-sm transition cursor-pointer", customTemplateName === t.name ? "border-indigo-500 ring-1 ring-indigo-500" : "border-gray-300 hover:border-indigo-400")}>
                                            <div onClick={() => applySavedTemplate(t)} className="px-3 py-1.5 text-xs font-bold text-gray-700 hover:text-indigo-600">
                                                {t.name} <span className="text-gray-400 font-normal ml-1">{t.width}x{t.height}</span>
                                            </div>
                                            <button onClick={(e) => { e.stopPropagation(); deleteSavedTemplate(t.id); }} className="px-2 py-1.5 hover:bg-red-50 text-gray-400 hover:text-red-500 border-l">
                                                <Trash2 size={12}/>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}


                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2">
                                <label className="text-xs font-bold text-gray-500 uppercase">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                                <input value={form.productName} onChange={e => setForm({...form, productName: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg font-bold text-gray-800 focus:border-indigo-500 outline-none" />
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">ID / –ù–æ–º–µ—Ä</label>
                                <input value={form.id} onChange={e => setForm({...form, id: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg focus:border-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">–î–∞—Ç–∞</label>
                                <div className="flex gap-1">
                                    <input value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:border-indigo-500 outline-none" />
                                    <button onClick={updateTime} className="p-2.5 bg-gray-100 rounded-lg hover:bg-gray-200"><RefreshCw size={16}/></button>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">–ö–æ–ª-–≤–æ</label>
                                <input value={form.quantity} onChange={e => setForm({...form, quantity: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg focus:border-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">–ï–¥. –∏–∑–º.</label>
                                <input value={form.unit} onChange={e => setForm({...form, unit: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 outline-none" />
                            </div>

                            <div className="md:col-span-2">
                                <label className="text-xs font-bold text-gray-500 uppercase">–î–æ–≥–æ–≤–æ—Ä / –ò–Ω—Ñ–æ</label>
                                <input value={form.contract} onChange={e => setForm({...form, contract: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:border-indigo-500 outline-none" />
                            </div>
                        </div>


                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-indigo-800 uppercase flex justify-between">
                                    <span>–°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–æ–º–µ—Ä (–î–ª—è QR)</span>
                                </label>
                                <input value={form.code} onChange={e => setForm({...form, code: e.target.value})} className="w-full p-3 border-2 border-indigo-200 rounded-xl font-mono text-xl font-black text-indigo-900 focus:border-indigo-500 outline-none shadow-sm" />
                            </div>

                            <div className="flex items-end gap-4">
                                <div className="flex-1">
                                    <label className="text-xs font-bold text-indigo-800 uppercase mb-1 block">–¢–∏—Ä–∞–∂</label>
                                    <input type="number" min="1" max="1000" value={printCount} onChange={e => setPrintCount(Number(e.target.value))} className="w-full p-3 border-2 border-indigo-200 rounded-xl font-bold text-lg" />
                                </div>
                                <div className="flex items-center gap-2 p-3 bg-white/60 rounded-xl border border-indigo-100">
                                    <Ruler size={18} className="text-indigo-400"/>
                                    <div className="text-xs font-bold text-indigo-900">{labelSize.width} x {labelSize.height} –º–º</div>
                                </div>
                            </div>

                            <div className="text-xs text-indigo-700 flex items-center justify-between">
                                <span>–î–∏–∞–ø–∞–∑–æ–Ω:</span>
                                <div className="font-mono font-bold">{form.code} <ArrowRight size={12} className="inline"/> {endCode}</div>
                            </div>

                            <button onClick={handlePrint} disabled={loading} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl rounded-xl shadow-lg hover:shadow-indigo-300 transition flex justify-center items-center gap-3">
                                {loading ? "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è..." : <><Printer /> –ü–ï–ß–ê–¢–¨</>}
                            </button>
                        </div>
                    </div>


                    <div className="flex-1 bg-gray-100 rounded-3xl p-8 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 min-h-[500px] sticky top-6">
                        <div className="grid grid-cols-1 gap-12 w-full place-items-center max-h-[800px] overflow-y-auto custom-scrollbar">
                            <LabelPreviewCard
                                title="–ü–µ—Ä–≤–∞—è –≤ —Å–µ—Ä–∏–∏"
                                data={form}
                                template={templateType}
                                size={{ w: labelSize.width, h: labelSize.height }}
                                customLayout={templateType === 'CUSTOM' ? customLayout : undefined}
                                currentIndex={1}
                                totalCount={printCount}
                            />
                            {printCount > 1 && (
                                <>
                                    <div className="text-gray-400 -my-6"><ArrowRight className="rotate-90" size={32}/></div>
                                    <LabelPreviewCard
                                        title={`–ü–æ—Å–ª–µ–¥–Ω—è—è (‚Ññ${printCount})`}
                                        data={{...form, code: endCode}}
                                        template={templateType}
                                        size={{ w: labelSize.width, h: labelSize.height }}
                                        customLayout={templateType === 'CUSTOM' ? customLayout : undefined}
                                        currentIndex={printCount}
                                        totalCount={printCount}
                                    />
                                </>
                            )}
                        </div>
                        <p className="text-xs text-gray-400 mt-6 font-mono text-center">
                            * –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç PDF.<br/>
                            –†–∞–∑–º–µ—Ä –±—É–º–∞–≥–∏: {labelSize.width}x{labelSize.height} –º–º
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseBalance.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchStockBalance } from "src/api/warehouseApi";
import { StockBalanceItem } from "src/types/WarehouseModels";
import { PieChart, RefreshCw, PackageX } from "lucide-react";

export const WarehouseBalance: React.FC = () => {
    const [balance, setBalance] = useState<StockBalanceItem[]>([]);
    const [loading, setLoading] = useState(false);

    const loadData = async () => {
        setLoading(true);
        try {
            const data = await fetchStockBalance();
            setBalance(data);
        } catch (e) { console.error(e); }
        finally { setLoading(false); }
    };

    useEffect(() => { loadData(); }, []);


    const products = balance.filter(i => i.originType === "PRODUCT");
    const components = balance.filter(i => i.originType === "COMPONENT");
    const others = balance.filter(i => i.originType !== "PRODUCT" && i.originType !== "COMPONENT");

    const renderTable = (title: string, items: StockBalanceItem[], colorClass: string) => (
        <div className="mb-8 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div className={`px-6 py-3 font-bold text-gray-700 bg-gray-50 border-b flex justify-between ${colorClass}`}>
                <span>{title}</span>
                <span className="text-xs bg-white px-2 py-0.5 rounded border">–ü–æ–∑–∏—Ü–∏–π: {items.length}</span>
            </div>
            <table className="w-full text-left">
                <thead className="bg-gray-50/50 text-xs text-gray-500 uppercase border-b">
                    <tr>
                        <th className="px-6 py-3">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th className="px-6 py-3 text-right">–û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</th>
                        <th className="px-6 py-3 text-right">–ú–µ—Å—Ç (–ö–æ—Ä–æ–±–æ–∫)</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-100 text-sm">
                    {items.map((item, idx) => (
                        <tr key={idx} className="hover:bg-gray-50 transition">
                            <td className="px-6 py-3 font-medium text-gray-800">{item.label}</td>
                            <td className="px-6 py-3 text-right font-bold text-indigo-600">
                                {Number(item.totalQuantity).toLocaleString()} <span className="text-gray-400 font-normal text-xs">{item.unit}</span>
                            </td>
                            <td className="px-6 py-3 text-right text-gray-600">{item.boxCount}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );

    return (
        <div className="animate-fade-in">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <PieChart className="text-indigo-600"/> –°–≤–æ–¥–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ —Å–∫–ª–∞–¥–∞
                </h2>
                <button onClick={loadData} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"><RefreshCw size={18}/></button>
            </div>

            {loading ? (
                <div className="text-center py-20 text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            ) : (
                <>
                    {products.length > 0 && renderTable("–ì–æ—Ç–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è", products, "border-l-4 border-l-purple-500")}
                    {components.length > 0 && renderTable("–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã", components, "border-l-4 border-l-blue-500")}
                    {others.length > 0 && renderTable("–ü—Ä–æ—á–µ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", others, "border-l-4 border-l-gray-500")}

                    {balance.length === 0 && (
                        <div className="text-center py-20 bg-white rounded-xl border-2 border-dashed">
                            <PackageX size={48} className="mx-auto text-gray-300 mb-4"/>
                            <p className="text-gray-500">–°–∫–ª–∞–¥ –ø—É—Å—Ç. –ü—Ä–∏–º–∏—Ç–µ —Ç–æ–≤–∞—Ä, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Å—Ç–∞—Ç–∫–∏.</p>
                        </div>
                    )}
                </>
            )}
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseDocs.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  FileText, Calendar, Search, Plus,
  ArrowDownToLine, Printer, User
} from "lucide-react";
import { createDocument, fetchDocuments } from "src/api/warehouseApi";
import { WarehouseDocument } from "src/types/WarehouseModels";
import { formatDateTime } from "../utils";

export const WarehouseDocs: React.FC = () => {
  const [docs, setDocs] = useState<WarehouseDocument[]>([]);
  const [loading, setLoading] = useState(false);

  const [search, setSearch] = useState("");
  const [typeFilter, setTypeFilter] = useState("");
  const [dateFrom, setDateFrom] = useState("");

  const [isCreateOpen, setIsCreateOpen] = useState(false);
  const [newDoc, setNewDoc] = useState({ number: "", type: "INCOME", comment: "" });

  const loadDocuments = async () => {
      setLoading(true);
      try {
          const res = await fetchDocuments({
            limit: 50,
            search: search || undefined,
            type: typeFilter || undefined,
            dateFrom: dateFrom || undefined
          });
          setDocs(res.rows);
      } catch(e) { console.error(e); }
      finally { setLoading(false); }
  };

  useEffect(() => {
      const timer = setTimeout(loadDocuments, 500);
      return () => clearTimeout(timer);
  }, [search, typeFilter, dateFrom]);

  const handleCreate = async () => {
      if(!newDoc.number) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä!");
      try {
          await createDocument({ ...newDoc, boxId: null });
          setIsCreateOpen(false);
          setNewDoc({ number: "", type: "INCOME", comment: "" });
          loadDocuments();
      } catch(e) { alert("–û—à–∏–±–∫–∞"); }
  };


  const getTypeStyle = (type: string | null) => {
      const t = (type || "").toUpperCase();
      if (t.includes("INCOME") || t.includes("–ü–†–ò–•–û–î")) return "bg-emerald-100 text-emerald-700 border-emerald-200";
      if (t.includes("OUT") || t.includes("–†–ê–°–•–û–î") || t.includes("–°–ü–ò–°–ê–ù–ò–ï")) return "bg-orange-100 text-orange-700 border-orange-200";
      return "bg-blue-50 text-blue-700 border-blue-200";
  }

  return (
    <div className="space-y-6 animate-fade-in">


        <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between gap-4">
            <div className="flex items-center gap-4 flex-1">
                <div className="relative flex-1 max-w-md">
                    <Search className="absolute left-3 top-2.5 text-gray-400 w-5 h-5" />
                    <input
                        value={search} onChange={e => setSearch(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é..."
                    />
                </div>

                <select
                    value={typeFilter} onChange={e => setTypeFilter(e.target.value)}
                    className="p-2 border border-gray-200 rounded-lg bg-gray-50 text-sm font-medium"
                >
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="INCOME">–ü—Ä–∏—Ö–æ–¥ (INCOME)</option>
                    <option value="OUTCOME">–†–∞—Å—Ö–æ–¥ (OUTCOME)</option>
                    <option value="MOVE">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</option>
                </select>

                <input
                    type="date"
                    value={dateFrom} onChange={e => setDateFrom(e.target.value)}
                    className="p-2 border border-gray-200 rounded-lg text-sm text-gray-600"
                />
            </div>

            <button
                onClick={() => setIsCreateOpen(!isCreateOpen)}
                className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm"
            >
                <Plus size={18} /> –ù–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
            </button>
        </div>


        {isCreateOpen && (
            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex flex-col md:flex-row gap-3 items-end animate-fade-in">
                <div className="flex-1 w-full">
                    <label className="text-xs font-bold text-indigo-900 uppercase">–ù–æ–º–µ—Ä</label>
                    <input value={newDoc.number} onChange={e => setNewDoc({...newDoc, number: e.target.value})} className="w-full p-2 border rounded-lg" placeholder="‚Ññ –ê–ö–¢-001" />
                </div>
                <div className="w-full md:w-48">
                    <label className="text-xs font-bold text-indigo-900 uppercase">–¢–∏–ø</label>
                    <select value={newDoc.type} onChange={e => setNewDoc({...newDoc, type: e.target.value})} className="w-full p-2 border rounded-lg">
                        <option value="INCOME">–ü—Ä–∏—Ö–æ–¥</option>
                        <option value="OUTCOME">–°–ø–∏—Å–∞–Ω–∏–µ</option>
                        <option value="MOVE">–ê–∫—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</option>
                    </select>
                </div>
                <div className="flex-[2] w-full">
                    <label className="text-xs font-bold text-indigo-900 uppercase">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <input value={newDoc.comment} onChange={e => setNewDoc({...newDoc, comment: e.target.value})} className="w-full p-2 border rounded-lg" placeholder="–û—Å–Ω–æ–≤–∞–Ω–∏–µ..." />
                </div>
                <button onClick={handleCreate} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        )}


        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <table className="w-full text-left border-collapse">
                <thead>
                    <tr className="bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        <th className="px-6 py-4">–î–æ–∫—É–º–µ–Ω—Ç</th>
                        <th className="px-6 py-4">–¢–∏–ø</th>
                        <th className="px-6 py-4">–î–∞—Ç–∞ / –ê–≤—Ç–æ—Ä</th>
                        <th className="px-6 py-4">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        <th className="px-6 py-4 text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                    {loading ? (
                         <tr><td colSpan={5} className="p-10 text-center text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    ) : docs.length === 0 ? (
                         <tr><td colSpan={5} className="p-10 text-center text-gray-400">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>
                    ) : (
                        docs.map(doc => (
                            <tr key={doc.id} className="hover:bg-gray-50 transition-colors group">
                                <td className="px-6 py-4">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-gray-100 rounded-lg text-gray-500">
                                            <FileText size={20} />
                                        </div>
                                        <div>
                                            <div className="font-bold text-gray-900">{doc.number}</div>
                                            <div className="text-xs text-gray-400">ID: {doc.id}</div>
                                        </div>
                                    </div>
                                </td>
                                <td className="px-6 py-4">
                                    <span className={`px-2.5 py-1 rounded-md text-xs font-bold border ${getTypeStyle(doc.type)}`}>
                                        {doc.type || "OTHER"}
                                    </span>
                                </td>
                                <td className="px-6 py-4">
                                    <div className="flex flex-col">
                                        <span className="text-sm font-medium text-gray-700 flex items-center gap-1.5">
                                            <Calendar size={14} className="text-gray-400"/>
                                            {doc.date || formatDateTime(doc.createdAt).split(',')[0]}
                                        </span>
                                        <span className="text-xs text-gray-500 flex items-center gap-1.5 mt-0.5">
                                            <User size={12}/>
                                            {doc.createdBy?.name || "–°–∏—Å—Ç–µ–º–∞"}
                                        </span>
                                    </div>
                                </td>
                                <td className="px-6 py-4 max-w-xs">
                                    <div className="text-sm text-gray-600 truncate" title={doc.comment || ""}>
                                        {doc.comment || "‚Äî"}
                                    </div>
                                </td>
                                <td className="px-6 py-4 text-right">
                                    <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="–ü–µ—á–∞—Ç—å">
                                            <Printer size={18} />
                                        </button>
                                        <button className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="–°–∫–∞—á–∞—Ç—å">
                                            <ArrowDownToLine size={18} />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))
                    )}
                </tbody>
            </table>
        </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseIntake.tsx
================================================================================

import React, { useEffect, useMemo, useState } from "react";
import QRCode from "react-qr-code";
import {
  ClipboardList, AlertCircle, Printer, Copy, Layers, FileSpreadsheet
} from "lucide-react";
import { createBoxesBatch, downloadBoxesExcel, printBoxesPdf } from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import { SectionModel } from "src/store/StructureStore";
import { productModel } from "src/types/ProductModel";
import { componentModel } from "src/types/ComponentModel";
import { LabelPreview } from "../components/LabelPreview";

interface Props {
  sections: SectionModel[];
  productsList: productModel[];
  componentsList: componentModel[];
}

export const WarehouseIntake: React.FC<Props> = ({ sections, productsList, componentsList }) => {

  const [intakeMode, setIntakeMode] = useState<"PRODUCT" | "COMPONENT" | "OTHER">("PRODUCT");
  const [selectedSkuId, setSelectedSkuId] = useState<number | "">("");
  const [label, setLabel] = useState("");
  const [projectName, setProjectName] = useState("");
  const [batchName, setBatchName] = useState("");


  const [measureType, setMeasureType] = useState<"PCS" | "METERS">("PCS");
  const [unit, setUnit] = useState("—à—Ç");
  const [shipmentTotal, setShipmentTotal] = useState<number | "">("");
  const [capacityPerUnit, setCapacityPerUnit] = useState<number>(1);

  const batchCalc = useMemo(() => {
      const total = Number(shipmentTotal) || 0;
      const capacity = Number(capacityPerUnit) || 1;
      if (total === 0) return { fullUnits: 0, remainder: 0, totalUnits: 0 };
      const fullUnits = Math.floor(total / capacity);
      const remainder = total % capacity;
      const totalUnits = fullUnits + (remainder > 0 ? 1 : 0);
      return { fullUnits, remainder, totalUnits };
  }, [shipmentTotal, capacityPerUnit]);

  const [intakeStatus, setIntakeStatus] = useState("ON_STOCK");
  const [intakeSectionId, setIntakeSectionId] = useState<number | "">("");
  const [intakeNotes, setIntakeNotes] = useState("");
  const [createdBoxes, setCreatedBoxes] = useState<InventoryBoxModel[]>([]);
  const [intakeLoading, setIntakeLoading] = useState(false);
  const [intakeError, setIntakeError] = useState<string | null>(null);


  useEffect(() => {
    setUnit(measureType === "PCS" ? "—à—Ç" : "–º");
  }, [measureType]);


  useEffect(() => {
      if (intakeMode === "PRODUCT" && selectedSkuId) {
          const p = productsList.find(x => x.id === Number(selectedSkuId));
          if(p) setLabel(p.title);
      } else if (intakeMode === "COMPONENT" && selectedSkuId) {
          const c = componentsList.find(x => x.id === Number(selectedSkuId));
          if(c) setLabel(c.title);
      }
  }, [intakeMode, selectedSkuId]);


  const applyTemplate = (type: "THERMAL" | "CABLE" | "SUB") => {
      if (type === "THERMAL") {
        setLabel("–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –¢–ü-200 (–ö–æ–º–ø–ª–µ–∫—Ç)");
        setProjectName("Project-40k");
        setBatchName("–ü–∞—Ä—Ç–∏—è 2");
        setMeasureType("PCS");
        setShipmentTotal(4000);
        setCapacityPerUnit(200);
        setIntakeNotes("–ü—Ä–∏—à–ª–∞ —á–∞—Å—Ç—å. –°–±–æ—Ä–∫—É –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–∞–º–∏.");
      } else if (type === "CABLE") {
        setLabel("–ö–∞–±–µ–ª—å –ö–æ–∞–∫—Å–∏–∞–ª—å–Ω—ã–π RG-6");
        setProjectName("–û–±—â–∏–π –∑–∞–ø–∞—Å");
        setBatchName("–ü–æ—Å—Ç–∞–≤–∫–∞ –î–µ–∫-24");
        setMeasureType("METERS");
        setShipmentTotal(5000);
        setCapacityPerUnit(1000);
        setIntakeNotes("–ö–∞–±–µ–ª—å –¥–ª—è –Ω–∞—Ä–µ–∑–∫–∏");
      } else if (type === "SUB") {
        setLabel("–ü–æ–ª—ë—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä v3 (–°—É–±–ø–æ–¥—Ä—è–¥)");
        setProjectName("–î—Ä–æ–Ω—ã FPV");
        setBatchName("–û—Ç –û–û–û '–¢–µ—Ö–Ω–æ'");
        setMeasureType("PCS");
        setShipmentTotal(10000);
        setCapacityPerUnit(500);
        setIntakeNotes("–ü—Ä–∏—à–ª–∏ –≥–æ—Ç–æ–≤—ã–µ, —Å—Ä–∞–∑—É –Ω–∞ –ø—Ä–æ—à–∏–≤–∫—É!");
        setIntakeStatus("IN_WORK");
      }
  };

  const handleCreateBatch = async () => {
    if (!label.trim()) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");
    if (batchCalc.totalUnits > 1000) return alert("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —ç—Ç–∏–∫–µ—Ç–æ–∫ (>1000).");

    setIntakeLoading(true);
    setIntakeError(null);
    try {
      let autoNote = intakeNotes;
      if (batchCalc.remainder > 0) {
         autoNote += ` | –í–ù–ò–ú–ê–ù–ò–ï: –û—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ: ${batchCalc.remainder} ${unit}`;
      }

      const res = await createBoxesBatch({
        label, projectName, batchName,
        originType: intakeMode,
        originId: selectedSkuId ? Number(selectedSkuId) : null,
        quantity: batchCalc.totalUnits,
        itemsPerBox: capacityPerUnit,
        unit,
        status: intakeStatus,
        currentSectionId: intakeSectionId ? Number(intakeSectionId) : null,
        notes: autoNote
      });

      setCreatedBoxes(res.boxes);
      setShipmentTotal("");
    } catch (e: any) {
        setIntakeError(e.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è");
    }
    finally { setIntakeLoading(false); }
  };

  return (
    <div className="grid grid-cols-1 xl:grid-cols-12 gap-8 animate-fade-in">

        <div className="xl:col-span-8 space-y-6">

            <div className="flex gap-2 overflow-x-auto pb-2">
                <button onClick={() => applyTemplate("THERMAL")} className="whitespace-nowrap px-4 py-2 bg-white border rounded text-xs font-bold text-gray-600 hover:bg-blue-50 transition flex gap-2"><Copy size={14}/> –ü—Ä–∏–º–µ—Ä: –¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä—ã</button>
                <button onClick={() => applyTemplate("SUB")} className="whitespace-nowrap px-4 py-2 bg-white border rounded text-xs font-bold text-gray-600 hover:bg-purple-50 transition flex gap-2"><Copy size={14}/> –ü—Ä–∏–º–µ—Ä: –°—É–±–ø–æ–¥—Ä—è–¥</button>
                <button onClick={() => applyTemplate("CABLE")} className="whitespace-nowrap px-4 py-2 bg-white border rounded text-xs font-bold text-gray-600 hover:bg-orange-50 transition flex gap-2"><Copy size={14}/> –ü—Ä–∏–º–µ—Ä: –ö–∞–±–µ–ª—å</button>
            </div>

            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h2 className="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <ClipboardList className="text-indigo-600"/> –ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞
                </h2>


                <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">–ß—Ç–æ –ø—Ä–∏–Ω–∏–º–∞–µ–º?</label>
                    <div className="flex gap-2">
                        {(['PRODUCT', 'COMPONENT', 'OTHER'] as const).map(m => (
                            <button
                                key={m}
                                onClick={() => { setIntakeMode(m); setSelectedSkuId(""); setLabel(""); }}
                                className={`flex-1 py-2 rounded-lg border text-sm font-bold transition ${intakeMode === m ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-gray-50 text-gray-600'}`}
                            >
                                {m === 'PRODUCT' ? '–ò–∑–¥–µ–ª–∏–µ' : m === 'COMPONENT' ? '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ' : '–ü—Ä–æ—á–µ–µ'}
                            </button>
                        ))}
                    </div>
                </div>


                {(intakeMode === 'PRODUCT' || intakeMode === 'COMPONENT') && (
                    <div className="mb-4">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</label>
                        <select
                            className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500"
                            value={selectedSkuId} onChange={e => setSelectedSkuId(e.target.value ? Number(e.target.value) : "")}
                        >
                            <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
                            {intakeMode === 'PRODUCT'
                                ? productsList.map(p => <option key={p.id} value={p.id}>{p.title}</option>)
                                : componentsList.map(c => <option key={c.id} value={c.id}>{c.title} ({c.article})</option>)
                            }
                        </select>
                    </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div className="md:col-span-2">
                         <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                         <input value={label} onChange={e => setLabel(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä FC v2.4"/>
                     </div>
                     <div>
                         <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ü–∞—Ä—Ç–∏—è</label>
                         <input value={batchName} onChange={e => setBatchName(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="‚Ññ –ø–∞—Ä—Ç–∏–∏" />
                     </div>
                     <div>
                         <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ü—Ä–æ–µ–∫—Ç</label>
                         <input value={projectName} onChange={e => setProjectName(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" />
                     </div>
                     <div>
                         <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">–ö—É–¥–∞ (–£—á–∞—Å—Ç–æ–∫)</label>
                         <select value={intakeSectionId} onChange={e => setIntakeSectionId(Number(e.target.value))} className="w-full p-2 border rounded-lg text-sm bg-gray-50">
                            <option value="">-- –°–∫–ª–∞–¥ –ü—Ä–∏—ë–º–∫–∏ --</option>
                            {sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                         </select>
                     </div>
                     <div>
                         <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">–°—Ç–∞—Ç—É—Å</label>
                         <select value={intakeStatus} onChange={e => setIntakeStatus(e.target.value)} className="w-full p-2 border rounded-lg text-sm">
                             <option value="ON_STOCK">–ù–∞ —Å–∫–ª–∞–¥–µ (–û–±—ã—á–Ω—ã–π)</option>
                             <option value="IN_WORK">–°—Ä–∞–∑—É –≤ —Ä–∞–±–æ—Ç—É</option>
                         </select>
                     </div>
                     <div className="md:col-span-2">
                         <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                         <input value={intakeNotes} onChange={e => setIntakeNotes(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="..." />
                     </div>
                </div>


                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6">
                    <div className="flex justify-between mb-2">
                        <h4 className="text-sm font-bold text-indigo-900 flex items-center gap-2"><Layers size={14}/> –†–∞—Å—á–µ—Ç –º–µ—Å—Ç</h4>
                        <div className="flex text-[10px] font-bold bg-white rounded border overflow-hidden">
                            <button onClick={() => setMeasureType("PCS")} className={`px-2 py-1 ${measureType === 'PCS' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500'}`}>–®–¢</button>
                            <button onClick={() => setMeasureType("METERS")} className={`px-2 py-1 ${measureType === 'METERS' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500'}`}>–ú–ï–¢–†–´</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-2">
                         <div>
                             <label className="text-xs text-gray-600">–í—Å–µ–≥–æ –ø—Ä–∏—à–ª–æ ({unit})</label>
                             <input type="number" min={1} value={shipmentTotal} onChange={e => setShipmentTotal(Number(e.target.value))} className="w-full p-2 border rounded-lg font-bold" placeholder="0"/>
                         </div>
                         <div>
                             <label className="text-xs text-gray-600">–í –æ–¥–Ω–æ–π —Ç–∞—Ä–µ ({unit})</label>
                             <input type="number" min={1} value={capacityPerUnit} onChange={e => setCapacityPerUnit(Number(e.target.value))} className="w-full p-2 border rounded-lg" placeholder="1"/>
                         </div>
                    </div>

                    <div className="text-sm text-indigo-800 font-medium flex justify-between items-center pt-2 border-t border-indigo-200">
                        <span>–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ —ç—Ç–∏–∫–µ—Ç–æ–∫:</span>
                        <span className="text-xl font-black">{batchCalc.totalUnits}</span>
                    </div>
                    {batchCalc.remainder > 0 && (
                        <div className="mt-2 text-xs text-orange-600 font-bold flex items-center gap-1">
                            <AlertCircle size={12}/> {batchCalc.fullUnits} –ø–æ–ª–Ω—ã—Ö + 1 —Å –æ—Å—Ç–∞—Ç–∫–æ–º ({batchCalc.remainder} {unit})
                        </div>
                    )}
                </div>

                {intakeError && <div className="text-sm text-red-600 mb-4 p-3 bg-red-50 rounded-lg">{intakeError}</div>}

                <div className="flex justify-end">
                     <button
                        onClick={handleCreateBatch} disabled={intakeLoading || !label}
                        className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2"
                     >
                        {intakeLoading ? "..." : <Printer size={20}/>} –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—é
                     </button>
                </div>
            </div>


            <div className="space-y-4">
                <div className="flex justify-between items-center">
                    <h3 className="text-lg font-bold text-gray-700">–†–µ–∑—É–ª—å—Ç–∞—Ç ({createdBoxes.length})</h3>
                    <div className="flex gap-2">

                        {createdBoxes.length > 0 && (
                            <button
                                onClick={() => printBoxesPdf(createdBoxes.map(b => b.id))}
                                className="flex items-center gap-2 text-sm font-bold text-white bg-indigo-600 px-3 py-2 rounded-lg hover:bg-indigo-700 transition shadow-md"
                            >
                                <Printer size={18}/> PDF
                            </button>
                        )}

                        {createdBoxes.length > 0 && (
                            <button
                                onClick={() => downloadBoxesExcel(createdBoxes.map(b => b.id))}
                                className="flex items-center gap-2 text-sm font-bold text-green-700 bg-green-100 px-3 py-2 rounded-lg hover:bg-green-200 transition"
                            >
                                <FileSpreadsheet size={18}/> Excel
                            </button>
                        )}
                    </div>
                </div>

                {createdBoxes.length === 0 && <div className="text-center py-10 bg-white rounded-2xl border-2 border-dashed border-gray-200 text-gray-400">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —ç—Ç–∏–∫–µ—Ç–∫–∏</div>}

                <div className="grid grid-cols-2 gap-4 max-h-[600px] overflow-y-auto pr-2">
                    {createdBoxes.map(box => (
                        <div key={box.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center text-center relative group hover:border-indigo-300 transition">
                            <div className="absolute top-2 left-2 text-[10px] font-mono bg-gray-100 px-1.5 rounded text-gray-500 font-bold">{box.shortCode}</div>
                            <div className="mb-2 bg-white p-1"><QRCode value={box.qrCode} size={80} /></div>
                            <div className="text-xs font-bold text-gray-900 w-full truncate">{box.label}</div>
                            <div className="text-[10px] text-gray-500 mt-1">ID: {box.id}</div>
                            <div className="mt-2 bg-gray-900 text-white text-xs font-bold px-2 py-0.5 rounded">{box.quantity} {box.unit}</div>
                        </div>
                    ))}
                </div>
            </div>
        </div>

        <div className="xl:col-span-4">
            <div className="sticky top-6 flex justify-center">
                <LabelPreview label={label || "–ù–∞–∑–≤–∞–Ω–∏–µ"} project={projectName} batch={batchName} id="###" qrValue={`BOX-FULL`} qty={capacityPerUnit} unit={unit} />
            </div>
        </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseLabels.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
    fetchBoxes, updateBoxesBatch, createBoxesBatch,
    printBoxesPdf
} from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import {
    Search, Filter, Printer, Edit,
    Plus, CheckSquare, Square, Tag
} from "lucide-react";
import { Modal } from "src/components/Modal/Modal";
import toast from "react-hot-toast";
import { Preloader } from "src/components/common/Preloader";

export const WarehouseLabels: React.FC = () => {

    const [boxes, setBoxes] = useState<InventoryBoxModel[]>([]);
    const [loading, setLoading] = useState(false);
    const [selectedIds, setSelectedIds] = useState<number[]>([]);


    const [search, setSearch] = useState("");
    const [batchFilter, setBatchFilter] = useState("");
    const [page, setPage] = useState(1);
    const [totalCount, setTotalCount] = useState(0);
    const limit = 50;


    const [isCreateOpen, setIsCreateOpen] = useState(false);
    const [isEditOpen, setIsEditOpen] = useState(false);


    const [createForm, setCreateForm] = useState({
        label: "", quantity: 1, count: 1, batchName: "", projectName: ""
    });


    const [editForm, setEditForm] = useState<Partial<InventoryBoxModel>>({});


    const loadData = async () => {
        setLoading(true);
        try {
            const res = await fetchBoxes({
                page, limit, search: search || undefined,
                batchName: batchFilter || undefined
            });
            setBoxes(res.rows);
            setTotalCount(res.count);
        } finally { setLoading(false); }
    };

    useEffect(() => { loadData(); }, [page, search, batchFilter]);


    const toggleSelect = (id: number) => {
        setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
    };

    const toggleSelectAll = () => {
        if (selectedIds.length === boxes.length) setSelectedIds([]);
        else setSelectedIds(boxes.map(b => b.id));
    };

    const handleCreate = async () => {
        if (!createForm.label) return toast.error("–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ");
        try {
            await createBoxesBatch({
                label: createForm.label,
                quantity: createForm.count,
                itemsPerBox: createForm.quantity,
                batchName: createForm.batchName,
                projectName: createForm.projectName,
                unit: "—à—Ç",
                status: "ON_STOCK"
            });
            toast.success(`–°–æ–∑–¥–∞–Ω–æ ${createForm.count} —ç—Ç–∏–∫–µ—Ç–æ–∫`);
            setIsCreateOpen(false);
            loadData();
        } catch (e) { toast.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è"); }
    };

    const handleBulkEdit = async () => {
        if (selectedIds.length === 0) return;
        try {
            await updateBoxesBatch(selectedIds, editForm);
            toast.success("–û–±–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ");
            setIsEditOpen(false);
            setEditForm({});
            setSelectedIds([]);
            loadData();
        } catch (e) { toast.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"); }
    };

    const handlePrint = async () => {
        if (selectedIds.length === 0) return toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∏–∫–µ—Ç–∫–∏");
        await printBoxesPdf(selectedIds);
    };

    return (
        <div className="space-y-4 animate-fade-in">

            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col xl:flex-row justify-between gap-4">
                <div className="flex gap-4 flex-1">
                    <div className="relative flex-1 max-w-md">
                        <Search className="absolute left-3 top-2.5 text-gray-400 w-5 h-5"/>
                        <input
                            value={search} onChange={e => setSearch(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, ID, QR..."
                        />
                    </div>
                    <div className="relative w-64">
                        <Filter className="absolute left-3 top-2.5 text-gray-400 w-5 h-5"/>
                        <input
                            value={batchFilter} onChange={e => setBatchFilter(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –ü–∞—Ä—Ç–∏–∏..."
                        />
                    </div>
                </div>

                <div className="flex gap-2">
                    {selectedIds.length > 0 && (
                        <>
                            <button onClick={() => setIsEditOpen(true)} className="flex items-center gap-2 bg-orange-100 text-orange-700 px-4 py-2 rounded-lg font-bold hover:bg-orange-200 transition">
                                <Edit size={18}/> –ü—Ä–∞–≤–∫–∞ ({selectedIds.length})
                            </button>
                            <button onClick={handlePrint} className="flex items-center gap-2 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg font-bold hover:bg-indigo-200 transition">
                                <Printer size={18}/> –ü–µ—á–∞—Ç—å
                            </button>
                        </>
                    )}
                    <button onClick={() => setIsCreateOpen(true)} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">
                        <Plus size={18}/> –°–æ–∑–¥–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏
                    </button>
                </div>
            </div>


            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                            <tr>
                                <th className="px-4 py-3 w-10">
                                    <button onClick={toggleSelectAll}>
                                        {selectedIds.length > 0 && selectedIds.length === boxes.length
                                            ? <CheckSquare className="text-indigo-600"/>
                                            : <Square className="text-gray-400"/>}
                                    </button>
                                </th>
                                <th className="px-4 py-3">ID / –ö–æ–¥</th>
                                <th className="px-4 py-3">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (Label)</th>
                                <th className="px-4 py-3">–ü–∞—Ä—Ç–∏—è</th>
                                <th className="px-4 py-3">–ü—Ä–æ–µ–∫—Ç</th>
                                <th className="px-4 py-3">–ö–æ–ª-–≤–æ</th>
                                <th className="px-4 py-3">–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {loading ? <tr><td colSpan={7} className="p-10"><Preloader/></td></tr> :
                             boxes.map(box => (
                                <tr key={box.id} className={`hover:bg-indigo-50/50 transition cursor-pointer ${selectedIds.includes(box.id) ? 'bg-indigo-50' : ''}`} onClick={() => toggleSelect(box.id)}>
                                    <td className="px-4 py-3">
                                        {selectedIds.includes(box.id) ? <CheckSquare className="text-indigo-600" size={18}/> : <Square className="text-gray-300" size={18}/>}
                                    </td>
                                    <td className="px-4 py-3 font-mono text-xs text-gray-500">
                                        <div className="font-bold text-gray-800">#{box.id}</div>
                                        {box.shortCode}
                                    </td>
                                    <td className="px-4 py-3 font-medium text-gray-800">{box.label}</td>
                                    <td className="px-4 py-3 text-gray-600">{box.batchName || "‚Äî"}</td>
                                    <td className="px-4 py-3 text-gray-600">{box.projectName || "‚Äî"}</td>
                                    <td className="px-4 py-3 font-bold">{box.quantity} {box.unit}</td>
                                    <td className="px-4 py-3">
                                        <span className={`px-2 py-1 rounded text-xs font-bold ${box.status === 'SCRAP' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                            {box.status}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>

                <div className="p-4 border-t border-gray-200 flex justify-between items-center bg-gray-50">
                    <span className="text-xs text-gray-500">–í—Å–µ–≥–æ: {totalCount}</span>
                    <div className="flex gap-2">
                        <button disabled={page === 1} onClick={() => setPage(p => p - 1)} className="px-3 py-1 border rounded bg-white disabled:opacity-50">–ù–∞–∑–∞–¥</button>
                        <button disabled={boxes.length < limit} onClick={() => setPage(p => p + 1)} className="px-3 py-1 border rounded bg-white disabled:opacity-50">–í–ø–µ—Ä–µ–¥</button>
                    </div>
                </div>
            </div>


            <Modal isOpen={isCreateOpen} onClose={() => setIsCreateOpen(false)}>
                <div className="p-6">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Tag/> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —ç—Ç–∏–∫–µ—Ç–æ–∫</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–ß—Ç–æ –Ω–∞ —ç—Ç–∏–∫–µ—Ç–∫–µ)</label>
                            <input className="w-full p-2 border rounded-lg" value={createForm.label} onChange={e => setCreateForm({...createForm, label: e.target.value})} placeholder="–ù–∞–ø—Ä. –ö–æ—Ä–ø—É—Å v1.0" />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">–ö–æ–ª-–≤–æ –≤ 1 –∫–æ—Ä–æ–±–∫–µ</label>
                                <input type="number" className="w-full p-2 border rounded-lg" value={createForm.quantity} onChange={e => setCreateForm({...createForm, quantity: Number(e.target.value)})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">–°–∫–æ–ª—å–∫–æ –Ω–∞–∫–ª–µ–µ–∫ —Å–æ–∑–¥–∞—Ç—å</label>
                                <input type="number" className="w-full p-2 border rounded-lg bg-indigo-50 font-bold" value={createForm.count} onChange={e => setCreateForm({...createForm, count: Number(e.target.value)})} />
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <input className="p-2 border rounded-lg text-sm" placeholder="–ü–∞—Ä—Ç–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value={createForm.batchName} onChange={e => setCreateForm({...createForm, batchName: e.target.value})} />
                            <input className="p-2 border rounded-lg text-sm" placeholder="–ü—Ä–æ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value={createForm.projectName} onChange={e => setCreateForm({...createForm, projectName: e.target.value})} />
                        </div>
                        <button onClick={handleCreate} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </Modal>


            <Modal isOpen={isEditOpen} onClose={() => setIsEditOpen(false)}>
                <div className="p-6">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-orange-600"><Edit/> –ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–∞–≤–∫–∞ ({selectedIds.length})</h2>
                    <p className="text-sm text-gray-500 mb-4">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¢–û–õ–¨–ö–û —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ—Ä–æ–±–æ–∫.</p>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">–ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input className="w-full p-2 border rounded-lg" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å" onChange={e => setEditForm({...editForm, label: e.target.value})} />
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">–ü–∞—Ä—Ç–∏—è</label>
                            <input className="w-full p-2 border rounded-lg" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏" onChange={e => setEditForm({...editForm, batchName: e.target.value})} />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                                <input type="number" className="w-full p-2 border rounded-lg" placeholder="–ù–µ –º–µ–Ω—è—Ç—å" onChange={e => setEditForm({...editForm, quantity: e.target.value ? Number(e.target.value) : undefined})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">–°—Ç–∞—Ç—É—Å</label>
                                <select className="w-full p-2 border rounded-lg" onChange={e => setEditForm({...editForm, status: e.target.value})}>
                                    <option value="">(–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)</option>
                                    <option value="ON_STOCK">–ù–∞ —Å–∫–ª–∞–¥</option>
                                    <option value="SCRAP">–ë–†–ê–ö (SCRAP)</option>
                                    <option value="IN_WORK">–í —Ä–∞–±–æ—Ç—É</option>
                                </select>
                            </div>
                        </div>

                        <button onClick={handleBulkEdit} className="w-full py-3 bg-orange-600 text-white font-bold rounded-xl hover:bg-orange-700">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseMoves.tsx
================================================================================

import React, { useState } from "react";
import { Search, Loader2, AlertCircle, MapPin, ArrowRightLeft, Trash2, ShoppingCart, Save } from "lucide-react";
import { fetchBoxById, fetchBoxByQr, moveBoxesBatch } from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import { SectionModel } from "src/store/StructureStore";

interface Props { sections: SectionModel[]; }

type CartItem = {
    box: InventoryBoxModel;
    operation: string;
    toSectionId: number | null;
    statusAfter: string;
    deltaQty: number;
    goodQty: number | null;
    scrapQty: number | null;
    comment: string;
};

export const WarehouseMoves: React.FC<Props> = ({ sections }) => {
  const [scanCode, setScanCode] = useState("");
  const [loading, setLoading] = useState(false);

  const [currentBox, setCurrentBox] = useState<InventoryBoxModel | null>(null);


  const [opType, setOpType] = useState<"MOVE" | "CONSUME">("MOVE");
  const [toSectionId, setToSectionId] = useState<number | "">("");
  const [statusAfter, setStatusAfter] = useState("");
  const [consumeAmount, setConsumeAmount] = useState<number | "">("");
  const [comment, setComment] = useState("");

  const [cart, setCart] = useState<CartItem[]>([]);
  const [docNumber, setDocNumber] = useState("");

  const handleScan = async () => {
      if (!scanCode) return;
      setLoading(true);
      setCurrentBox(null);
      try {
          let res;
          if (/^\d+$/.test(scanCode)) res = await fetchBoxById(Number(scanCode));
          else res = await fetchBoxByQr(scanCode);

          setCurrentBox(res.box);

          setOpType("MOVE");
          setToSectionId(res.box.currentSectionId || "");
          setStatusAfter(res.box.status);
          setConsumeAmount("");
          setComment("");
      } catch (e) { alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ"); }
      finally { setLoading(false); setScanCode(""); }
  };

  const addToCart = () => {
      if (!currentBox) return;

      let delta = 0;
      let op = opType;

      if (opType === "CONSUME") {
          const amount = Number(consumeAmount);
          if (!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è");
          if (amount > currentBox.quantity) return alert(`–ù–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å (${currentBox.quantity})`);

          delta = -amount;
      }

      if (cart.some(i => i.box.id === currentBox.id)) {
          alert("–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ!");
          return;
      }

      const item: CartItem = {
          box: currentBox,
          operation: op,
          toSectionId: toSectionId ? Number(toSectionId) : null,
          statusAfter: statusAfter,
          deltaQty: delta,
          goodQty: null,
          scrapQty: null,
          comment: comment
      };

      setCart([item, ...cart]);
      setCurrentBox(null);
  };

  const commitBatch = async () => {
      if (cart.length === 0) return;
      if (!docNumber.trim()) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞/–Ω–∞–∫–ª–∞–¥–Ω–æ–π –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏!");

      setLoading(true);
      try {
          await moveBoxesBatch({
              movements: cart.map(c => ({
                  boxId: c.box.id,
                  operation: c.operation,
                  toSectionId: c.toSectionId,
                  statusAfter: c.statusAfter,
                  deltaQty: c.deltaQty,
                  goodQty: c.goodQty || undefined,
                  scrapQty: c.scrapQty || undefined,
                  comment: c.comment
              })),
              documentData: {
                  createNew: true,
                  number: docNumber,
                  type: "MOVE_BATCH",
                  comment: `–ü–∞–∫–µ—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (${cart.length} –ø–æ–∑.)`
              }
          });
          setCart([]);
          setDocNumber("");
          alert("–û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞! –°–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç.");
      } catch (e: any) { alert("–û—à–∏–±–∫–∞: " + e.message); }
      finally { setLoading(false); }
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">


        <div className="lg:col-span-5 space-y-4">

             <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <label className="block text-sm font-bold text-gray-700 mb-2">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</label>
                <div className="flex gap-2">
                    <input
                        value={scanCode} onChange={e => setScanCode(e.target.value)}
                        onKeyDown={e => e.key === 'Enter' && handleScan()}
                        className="w-full p-3 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 text-lg outline-none"
                        placeholder="QR –∏–ª–∏ –∫–æ–¥..."
                        autoFocus
                    />
                    <button onClick={handleScan} disabled={loading} className="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition">
                        {loading ? <Loader2 className="animate-spin"/> : <Search/>}
                    </button>
                </div>
             </div>


             {currentBox ? (
                 <div className="bg-white rounded-xl shadow-lg border border-indigo-200 overflow-hidden animate-fade-in">
                     <div className="bg-gray-900 p-4 text-white">
                         <div className="flex justify-between items-start">
                            <div>
                                <div className="text-xs text-gray-400 uppercase font-bold">–¢–µ–∫—É—â–∞—è –∫–æ—Ä–æ–±–∫–∞</div>
                                <h3 className="font-bold text-lg leading-tight mt-1">{currentBox.label}</h3>
                            </div>
                            <div className="text-right">
                                <span className="bg-gray-700 px-2 py-1 rounded text-xs font-mono">{currentBox.shortCode}</span>
                            </div>
                         </div>
                         <div className="mt-2 text-sm opacity-80 flex gap-2 items-center">
                             <AlertCircle size={14}/>
                             <span>–û—Å—Ç–∞—Ç–æ–∫: <b>{currentBox.quantity} {currentBox.unit}</b></span>
                         </div>
                     </div>

                     <div className="p-4 space-y-4">

                         <div className="flex gap-2 bg-gray-100 p-1 rounded-lg">
                             <button onClick={() => setOpType("MOVE")} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${opType === 'MOVE' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</button>
                             <button onClick={() => setOpType("CONSUME")} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${opType === 'CONSUME' ? 'bg-white shadow text-orange-600' : 'text-gray-500'}`}>–†–∞—Å—Ö–æ–¥ / –°–ø–∏—Å–∞–Ω–∏–µ</button>
                         </div>


                         {opType === 'CONSUME' ? (
                             <div className="bg-orange-50 p-3 rounded-lg border border-orange-200">
                                 <label className="text-xs font-bold text-orange-800 uppercase">–°–∫–æ–ª—å–∫–æ –≤–∑—è—Ç—å?</label>
                                 <div className="flex gap-2 mt-1">
                                    <input type="number" className="flex-1 p-2 text-xl font-bold border-orange-300 rounded outline-none" value={consumeAmount} onChange={e => setConsumeAmount(Number(e.target.value))} autoFocus />
                                    <div className="flex items-center text-orange-700 font-bold px-2">{currentBox.unit}</div>
                                 </div>
                             </div>
                         ) : (
                             <div className="grid grid-cols-2 gap-3">
                                 <div>
                                     <label className="text-[10px] uppercase font-bold text-gray-500">–ö—É–¥–∞</label>
                                     <select className="w-full p-2 border rounded text-sm bg-white outline-none" value={toSectionId} onChange={e => setToSectionId(e.target.value ? Number(e.target.value) : "")}>
                                         <option value="">(–¢–µ–∫—É—â–µ–µ)</option>
                                         {sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                     </select>
                                 </div>
                                 <div>
                                     <label className="text-[10px] uppercase font-bold text-gray-500">–°—Ç–∞—Ç—É—Å</label>
                                     <select className="w-full p-2 border rounded text-sm bg-white outline-none" value={statusAfter} onChange={e => setStatusAfter(e.target.value)}>
                                         <option value="ON_STOCK">–ù–∞ —Å–∫–ª–∞–¥–µ</option>
                                         <option value="IN_WORK">–í —Ä–∞–±–æ—Ç–µ</option>
                                         <option value="DONE">–ì–æ—Ç–æ–≤–æ</option>
                                         <option value="SCRAP">–ë—Ä–∞–∫</option>
                                     </select>
                                 </div>
                             </div>
                         )}

                         <input className="w-full p-2 border rounded text-sm outline-none focus:border-indigo-500" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." value={comment} onChange={e => setComment(e.target.value)} />

                         <button onClick={addToCart} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-md flex justify-center items-center gap-2 transition">
                             <ShoppingCart size={18}/> –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫
                         </button>
                     </div>
                 </div>
             ) : (
                <div className="text-center p-10 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed min-h-[300px] flex flex-col items-center justify-center">
                    <ArrowRightLeft className="mb-2 opacity-20" size={40}/>
                    <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ—Ä–æ–±–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</p>
                </div>
             )}
        </div>


        <div className="lg:col-span-7 h-[calc(100vh-140px)] flex flex-col">
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 h-full flex flex-col overflow-hidden">
                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h3 className="font-bold text-gray-700 flex items-center gap-2"><ShoppingCart size={18}/> –û–ø–µ—Ä–∞—Ü–∏–∏ –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é ({cart.length})</h3>
                    {cart.length > 0 && <button onClick={() => setCart([])} className="text-xs text-red-500 hover:underline">–û—á–∏—Å—Ç–∏—Ç—å</button>}
                </div>

                <div className="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50/30">
                    {cart.length === 0 && <div className="text-center py-20 text-gray-300">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>}
                    {cart.map((item, idx) => (
                        <div key={idx} className="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm hover:shadow-md transition group">
                            <div className="flex-1">
                                <div className="font-bold text-sm text-gray-800">{item.box.label} <span className="text-gray-400 font-normal text-xs">#{item.box.id}</span></div>
                                <div className="text-xs text-gray-500 flex flex-wrap gap-2 mt-1 items-center">
                                    {item.deltaQty !== 0
                                        ? <span className="bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded font-bold">–†–ê–°–•–û–î: {Math.abs(item.deltaQty)} {item.box.unit}</span>
                                        : <span className="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold">–ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï</span>
                                    }
                                    {item.toSectionId && <span className="flex items-center gap-1"><MapPin size={10}/> –°–µ–∫—Ü–∏—è #{item.toSectionId}</span>}
                                    {item.statusAfter !== item.box.status && <span>–°—Ç–∞—Ç—É—Å: {item.statusAfter}</span>}
                                    {item.comment && <span className="italic text-gray-400">"{item.comment}"</span>}
                                </div>
                            </div>
                            <button onClick={() => setCart(cart.filter((_, i) => i !== idx))} className="p-2 text-gray-300 hover:text-red-500 transition">
                                <Trash2 size={16}/>
                            </button>
                        </div>
                    ))}
                </div>

                <div className="p-4 border-t bg-indigo-50">
                    <label className="text-xs font-bold text-indigo-800 uppercase mb-1 block">–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ / –ù–∞–∫–ª–∞–¥–Ω–æ–π</label>
                    <div className="flex gap-2">
                        <input
                            value={docNumber} onChange={e => setDocNumber(e.target.value)}
                            className="flex-1 p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="–ù–∞–ø—Ä: –¢–ù-2025-10-15"
                        />
                        <button onClick={commitBatch} disabled={loading || cart.length === 0} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow transition flex items-center gap-2 disabled:opacity-50">
                            {loading ? <Loader2 className="animate-spin"/> : <Save size={18}/>} –ü—Ä–æ–≤–µ—Å—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehousePrintHistory.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchPrintHistory } from "src/api/warehouseApi";
import {
    Search, Printer, User, History,
    ArrowRight, Tv, Tag, Info, FileText
} from "lucide-react";
import { formatDateTime } from "../utils";
import { Modal } from "src/components/Modal/Modal";
import clsx from "clsx";

export const WarehousePrintHistory: React.FC = () => {
    const [data, setData] = useState<any[]>([]);
    const [totalCount, setTotalCount] = useState(0);
    const [loading, setLoading] = useState(false);


    const [page, setPage] = useState(1);
    const [search, setSearch] = useState("");
    const [template, setTemplate] = useState("");
    const [dateFrom, setDateFrom] = useState("");


    const [selectedItem, setSelectedItem] = useState<any | null>(null);

    const loadData = async () => {
        setLoading(true);
        try {
            const res = await fetchPrintHistory({
                page,
                limit: 20,
                search,
                template,
                dateFrom
            });
            setData(res.rows);
            setTotalCount(res.count);
        } catch (e) {
            console.error(e);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        const timer = setTimeout(loadData, 500);
        return () => clearTimeout(timer);
    }, [page, search, template, dateFrom]);


    const getTemplateIcon = (type: string) => {
        if (type === "VIDEO_KIT") return <Tv size={16} className="text-indigo-600"/>;
        return <Tag size={16} className="text-gray-600"/>;
    };

    return (
        <div className="space-y-6 animate-fade-in">

            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between gap-4">
                <div className="flex items-center gap-3 text-gray-700 font-bold text-lg">
                    <History className="text-indigo-600" /> –ò—Å—Ç–æ—Ä–∏—è –ø–µ—á–∞—Ç–∏
                </div>

                <div className="flex flex-wrap gap-3 flex-1 justify-end">
                    <div className="relative w-full md:w-64">
                        <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4" />
                        <input
                            value={search} onChange={e => setSearch(e.target.value)}
                            className="w-full pl-9 pr-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, ID –∏–ª–∏ –ö–æ–¥..."
                        />
                    </div>

                    <select
                        value={template} onChange={e => setTemplate(e.target.value)}
                        className="p-2 border rounded-lg text-sm bg-gray-50 font-medium"
                    >
                        <option value="">–í—Å–µ —à–∞–±–ª–æ–Ω—ã</option>
                        <option value="VIDEO_KIT">–í–∏–¥–µ–æ–∫–æ–º–ø–ª–µ–∫—Ç</option>
                        <option value="SIMPLE">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è</option>
                    </select>

                    <input
                        type="date"
                        value={dateFrom} onChange={e => setDateFrom(e.target.value)}
                        className="p-2 border rounded-lg text-sm text-gray-600"
                    />
                </div>
            </div>


            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                        <tr>
                            <th className="px-6 py-4">–î–∞—Ç–∞ / –í—Ä–µ–º—è</th>
                            <th className="px-6 py-4">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            <th className="px-6 py-4">–®–∞–±–ª–æ–Ω</th>
                            <th className="px-6 py-4">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                            <th className="px-6 py-4">–î–∏–∞–ø–∞–∑–æ–Ω (ID)</th>
                            <th className="px-6 py-4 text-center">–¢–∏—Ä–∞–∂</th>
                            <th className="px-6 py-4 text-right">–ò–Ω—Ñ–æ</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100 text-sm">
                        {loading ? (
                            <tr><td colSpan={7} className="p-8 text-center text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        ) : data.length === 0 ? (
                            <tr><td colSpan={7} className="p-8 text-center text-gray-400">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>
                        ) : (
                            data.map(item => (
                                <tr key={item.id} className="hover:bg-slate-50 transition group">
                                    <td className="px-6 py-4 text-gray-600 whitespace-nowrap">
                                        {formatDateTime(item.createdAt)}
                                    </td>
                                    <td className="px-6 py-4">
                                        <div className="flex items-center gap-2">
                                            <div className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">
                                                {item.createdBy?.name?.[0] || <User size={12}/>}
                                            </div>
                                            <span className="font-medium text-gray-800">
                                                {item.createdBy ? `${item.createdBy.surname} ${item.createdBy.name}` : "–°–∏—Å—Ç–µ–º–∞"}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4">
                                        <div className="flex items-center gap-2">
                                            {getTemplateIcon(item.template)}
                                            <span className={clsx("text-xs font-bold px-2 py-0.5 rounded", item.template === "VIDEO_KIT" ? "bg-indigo-50 text-indigo-700" : "bg-gray-100 text-gray-700")}>
                                                {item.template === "VIDEO_KIT" ? "–í–∏–¥–µ–æ" : "–ü—Ä–æ—Å—Ç–∞—è"}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 font-bold text-gray-800 max-w-xs truncate" title={item.labelName}>
                                        {item.labelName}
                                    </td>
                                    <td className="px-6 py-4 font-mono text-xs text-gray-600">
                                        {item.quantity > 1 ? (
                                            <div className="flex items-center gap-1">
                                                {item.startCode} <ArrowRight size={10} className="text-gray-400"/> {item.endCode}
                                            </div>
                                        ) : (
                                            item.startCode
                                        )}
                                    </td>
                                    <td className="px-6 py-4 text-center">
                                        <span className="font-bold text-lg">{item.quantity}</span>
                                        <span className="text-xs text-gray-400 ml-1">—à—Ç</span>
                                    </td>
                                    <td className="px-6 py-4 text-right">
                                        <button
                                            onClick={() => setSelectedItem(item)}
                                            className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition"
                                        >
                                            <Info size={18}/>
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>


                <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center text-xs text-gray-500">
                    <span>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {totalCount}</span>
                    <div className="flex gap-2">
                        <button disabled={page === 1} onClick={() => setPage(p => p - 1)} className="px-3 py-1 bg-white border rounded hover:bg-gray-100 disabled:opacity-50">–ù–∞–∑–∞–¥</button>
                        <span className="py-1 px-2">–°—Ç—Ä. {page}</span>
                        <button disabled={data.length < 20} onClick={() => setPage(p => p + 1)} className="px-3 py-1 bg-white border rounded hover:bg-gray-100 disabled:opacity-50">–í–ø–µ—Ä–µ–¥</button>
                    </div>
                </div>
            </div>


            <Modal isOpen={!!selectedItem} onClose={() => setSelectedItem(null)}>
                {selectedItem && (
                    <div className="p-6 max-w-lg w-full">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-indigo-50 rounded-full text-indigo-600">
                                <Printer size={24}/>
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-gray-800">–î–µ—Ç–∞–ª–∏ –ø–µ—á–∞—Ç–∏</h3>
                                <p className="text-xs text-gray-500">ID –æ–ø–µ—Ä–∞—Ü–∏–∏: {selectedItem.id}</p>
                            </div>
                        </div>

                        <div className="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm">
                            <div className="flex justify-between">
                                <span className="text-gray-500">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span>
                                <span className="font-bold">{selectedItem.labelName}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">–î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏:</span>
                                <span>{formatDateTime(selectedItem.createdAt)}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">–¢–∏—Ä–∞–∂:</span>
                                <span className="font-bold">{selectedItem.quantity} —à—Ç.</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">–†–∞–∑–º–µ—Ä –±—É–º–∞–≥–∏:</span>
                                <span>{selectedItem.params?.widthMm} x {selectedItem.params?.heightMm} –º–º</span>
                            </div>

                            {selectedItem.params?.contract && (
                                <div className="border-t border-gray-200 pt-2 mt-2">
                                    <span className="text-gray-500 block mb-1">–î–æ–≥–æ–≤–æ—Ä:</span>
                                    <p className="bg-white p-2 rounded border border-gray-200 text-xs text-gray-700 italic">
                                        {selectedItem.params.contract}
                                    </p>
                                </div>
                            )}


                            <div className="border-t border-gray-200 pt-2 mt-2">
                                <span className="text-gray-500 block mb-1 flex items-center gap-1"><FileText size={12}/> –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON):</span>
                                <pre className="bg-slate-800 text-green-400 p-2 rounded text-[10px] overflow-auto max-h-32">
                                    {JSON.stringify(selectedItem.params, null, 2)}
                                </pre>
                            </div>
                        </div>

                        <button
                            onClick={() => setSelectedItem(null)}
                            className="w-full mt-6 py-3 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition"
                        >
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                )}
            </Modal>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseSettings.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchStockBalance, fetchAllLimits, saveLimit } from "src/api/warehouseApi";
import { InventoryLimitModel, StockBalanceItem } from "src/types/WarehouseModels";
import { Search, AlertTriangle, Settings } from "lucide-react";
import toast from "react-hot-toast";

export const WarehouseSettings: React.FC = () => {
    const [items, setItems] = useState<any[]>([]);
    const [search, setSearch] = useState("");
    const [loading, setLoading] = useState(false);

    const loadData = async () => {
        setLoading(true);
        try {
            const [balance, limits] = await Promise.all([
                fetchStockBalance(),
                fetchAllLimits()
            ]);


            const limitsMap = new Map();
            limits.forEach(l => limitsMap.set(l.label, l.minQuantity));

            const uniqueItems = new Map();

            balance.forEach(b => {
                uniqueItems.set(b.label, {
                    label: b.label,
                    originType: b.originType,
                    originId: b.originId,
                    current: Number(b.totalQuantity),
                    min: limitsMap.get(b.label) || 0
                });
            });

            limits.forEach(l => {
                if (!uniqueItems.has(l.label)) {
                    uniqueItems.set(l.label, {
                        label: l.label,
                        originType: l.originType,
                        originId: l.originId,
                        current: 0,
                        min: l.minQuantity
                    });
                }
            });

            setItems(Array.from(uniqueItems.values()));

        } catch (e) {
            console.error(e);
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => { loadData(); }, []);

    const handleSave = async (item: any, newMin: string) => {
        const val = parseInt(newMin);
        if (isNaN(val)) return;
        if (val === item.min) return;

        try {
            await saveLimit({
                label: item.label,
                min: val,
                originType: item.originType,
                originId: item.originId
            });
            toast.success(`–õ–∏–º–∏—Ç –¥–ª—è "${item.label}" –æ–±–Ω–æ–≤–ª–µ–Ω`);
            setItems(prev => prev.map(i => i.label === item.label ? { ...i, min: val } : i));
        } catch (e) {
            toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å");
        }
    };

    const filteredItems = items.filter(i => i.label.toLowerCase().includes(search.toLowerCase()));

    return (
        <div className="animate-fade-in max-w-4xl mx-auto">
            <div className="flex justify-between items-end mb-6">
                <div>
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <Settings className="text-indigo-600"/> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–ª–∞–¥–∞
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                </div>

                <div className="relative">
                    <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4"/>
                    <input
                        value={search} onChange={e => setSearch(e.target.value)}
                        className="pl-9 pr-4 py-2 border rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
                    />
                </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table className="w-full text-left">
                    <thead className="bg-gray-50 text-xs text-gray-500 uppercase font-semibold">
                        <tr>
                            <th className="px-6 py-4">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                            <th className="px-6 py-4 text-center">–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</th>
                            <th className="px-6 py-4 text-center w-48">–ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫</th>
                            <th className="px-6 py-4">–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {loading && <tr><td colSpan={4} className="p-8 text-center text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>}

                        {!loading && filteredItems.map((item, idx) => (
                            <tr key={idx} className="hover:bg-gray-50 transition">
                                <td className="px-6 py-4 font-medium text-gray-800">{item.label}</td>
                                <td className="px-6 py-4 text-center text-gray-600 font-mono">{item.current}</td>
                                <td className="px-6 py-4 text-center">
                                    <input
                                        type="number"
                                        defaultValue={item.min}
                                        onBlur={(e) => handleSave(item, e.target.value)}
                                        className="w-24 p-2 text-center border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition"
                                    />
                                </td>
                                <td className="px-6 py-4">
                                    {item.min > 0 && item.current < item.min ? (
                                        <span className="flex items-center gap-1 text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded-full w-max">
                                            <AlertTriangle size={12}/> –î–µ—Ñ–∏—Ü–∏—Ç (-{item.min - item.current})
                                        </span>
                                    ) : (
                                        item.min > 0 && <span className="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-full">OK</span>
                                    )}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                {!loading && filteredItems.length === 0 && (
                    <div className="p-8 text-center text-gray-400">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                )}
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/utils.ts
================================================================================

export const formatDateTime = (iso: string | null | undefined) => {
  if (!iso) return "‚Äî";
  return new Date(iso).toLocaleString("ru-RU", {
    day: "2-digit", month: "2-digit", hour: "2-digit", minute: "2-digit"
  });
};

export const getStatusBadge = (status: string) => {
  switch (status) {
    case "ON_STOCK": return "bg-emerald-100 text-emerald-700 border-emerald-200";
    case "IN_WORK": return "bg-blue-100 text-blue-700 border-blue-200";
    case "DONE": return "bg-purple-100 text-purple-700 border-purple-200";
    case "SCRAP": return "bg-red-100 text-red-700 border-red-200";
    default: return "bg-gray-100 text-gray-700 border-gray-200";
  }
};


export const calculateBatch = (total: number, capacity: number) => {

    const safeTotal = Math.max(0, Number(total) || 0);


    const safeCapacity = Math.max(1, Number(capacity) || 1);

    if (safeTotal === 0) {
        return { fullUnits: 0, remainder: 0, totalUnits: 0 };
    }

    const fullUnits = Math.floor(safeTotal / safeCapacity);
    const remainder = safeTotal % safeCapacity;


    const totalUnits = fullUnits + (remainder > 0 ? 1 : 0);

    return { fullUnits, remainder, totalUnits };
};

================================================================================
FILE: QMS-Client-main/src/routes.ts
================================================================================

import { AdminPanel } from "./pages/Admin/AdminPanel";
import { AdminPCs } from "./pages/Admin/AdminPCs/AdminPCs";
import { AdminUsers } from "./pages/Admin/AdminUsers/AdminUsers";
import { StructurePage } from "./pages/Admin/Structure/StructurePage";
import { AuditLogPage } from "./pages/Admin/Audit/AuditLogPage";
import { SelectPC } from "./pages/PCs/SelectPC";
import { Profile } from "./pages/Profile/Profile";
import { StartPage } from "./pages/StartPage/StartPage";
import { Users } from "./pages/Users/Users";
import { Login } from "./pages/Login/Login";
import { Registration } from "./pages/Login/Registration";

import { WarehousePage as AdminWarehousePage } from "./pages/Admin/Warehouse/WarehousePage";
import { WarehousePage as UserWarehousePage } from "./pages/Warehouse/WarehousePage";
import { AnalyticsPage } from "./pages/Warehouse/AnalyticsPage";
import { InventoryPage } from "./pages/Warehouse/InventoryPage";

import TasksPage from "./pages/Tasks/TasksPage";

import { AdminRightsPage } from "./pages/Admin/RBAC/AdminRightsPage";

import {
  ADMIN_PCs_ROUTE,
  ADMIN_ROUTE,
  ADMIN_USERS_ROUTE,
  PROFILE_ROUTE,
  SELECT_PC_ROUTE,
  START_ROUTE,
  USERS_ROUTE,
  STRUCTURE_ROUTE,
  AUDIT_LOG_ROUTE,
  ADMIN_WAREHOUSE_ROUTE,
  WAREHOUSE_ROUTE,
  WAREHOUSE_ANALYTICS_ROUTE,
  WAREHOUSE_INVENTORY_ROUTE,
  TASKS_ROUTE,
  ADMIN_RBAC_ROUTE,
  LOGIN_ROUTE,
  REGISTRATION_ROUTE,
} from "./utils/consts";

export const authRoutes = [
  { path: SELECT_PC_ROUTE, Component: SelectPC },
  { path: PROFILE_ROUTE, Component: Profile },
  { path: WAREHOUSE_ROUTE, Component: UserWarehousePage },
  { path: WAREHOUSE_ANALYTICS_ROUTE, Component: AnalyticsPage },
  { path: WAREHOUSE_INVENTORY_ROUTE, Component: InventoryPage },
  { path: TASKS_ROUTE, Component: TasksPage },
];

export const adminRoutes = [
  { path: ADMIN_ROUTE, Component: AdminPanel },
  { path: STRUCTURE_ROUTE, Component: StructurePage },
  { path: AUDIT_LOG_ROUTE, Component: AuditLogPage },
  { path: ADMIN_PCs_ROUTE, Component: AdminPCs },
  { path: ADMIN_USERS_ROUTE, Component: AdminUsers },
  { path: ADMIN_WAREHOUSE_ROUTE, Component: AdminWarehousePage },
  { path: ADMIN_RBAC_ROUTE, Component: AdminRightsPage },
];

export const publicRoutes = [
  { path: START_ROUTE, Component: StartPage },
  { path: USERS_ROUTE, Component: Users },
  { path: LOGIN_ROUTE, Component: Login },
  { path: REGISTRATION_ROUTE, Component: Registration },
];

================================================================================
FILE: QMS-Client-main/src/setupTests.ts
================================================================================

import '@testing-library/jest-dom';
================================================================================
FILE: QMS-Client-main/src/store/StructureStore.ts
================================================================================

import { makeAutoObservable } from "mobx";
import { userGetModel } from "src/types/UserModel";

export interface TeamModel {
    id: number;
    title: string;
    sectionId: number;
    teamLead: userGetModel | null;
    users: userGetModel[];
}

export interface SectionModel {
    id: number;
    title: string;
    manager: userGetModel | null;
    production_teams: TeamModel[];
}

export default class StructureStore {
    sections: SectionModel[] = [];

    constructor() {
        makeAutoObservable(this);
    }

    setSections(sections: SectionModel[]) {
        this.sections = sections;
    }
}

================================================================================
FILE: QMS-Client-main/src/store/UserStore.ts
================================================================================

import { makeAutoObservable } from "mobx"
import { userModel } from "src/types/UserModel"

export default class UserStore {
    private _isAuth: boolean = false
    private _user: userModel | null = null

    constructor() {
        makeAutoObservable(this)
    }

    setIsAuth(bool: boolean) {
        this._isAuth = bool
    }

    setUser(user: userModel) {
        this._user = user
    }

    resetUser() {
        this._user = null
        this._isAuth = false
    }


    can(permission: string): boolean {
        if (!this._user) return false;


        if (this._user.role === 'SUPER_ADMIN') return true;


        return this._user.abilities?.includes(permission) || false;
    }


    hasRole(role: string): boolean {
        return this._user?.role === role;
    }


    get user() {
        return this._user
    }

    get isAuth() {
        return this._isAuth
    }


    get isAdmin() {
        return this.can('admin.access') || this.can('rbac.manage');
    }
}

================================================================================
FILE: QMS-Client-main/src/store/__tests__/UserStore.test.ts
================================================================================

import { describe, it, expect, beforeEach } from 'vitest';
import UserStore from '../UserStore';

describe('UserStore RBAC', () => {
    let store: UserStore;

    beforeEach(() => {
        store = new UserStore();
    });

    it('SUPER_ADMIN –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É', () => {
        store.setUser({
            id: 1, login: 'admin', name: 'Adm', surname: 'Adm', role: 'SUPER_ADMIN', abilities: [], exp:0, iat:0, img: null
        });

        expect(store.can('warehouse.view')).toBe(true);
        expect(store.can('nuclear.launch')).toBe(true);
    });

    it('–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–∞–≤–∞', () => {
        store.setUser({
            id: 2, login: 'user', name: 'User', surname: 'U', role: 'USER',
            abilities: ['warehouse.view'],
            exp:0, iat:0, img: null
        });

        expect(store.can('warehouse.view')).toBe(true);
        expect(store.can('users.manage')).toBe(false);
    });

    it('–ì–æ—Å—Ç—å (–Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω) –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∞–≤', () => {
        store.resetUser();
        expect(store.can('warehouse.view')).toBe(false);
    });
});

================================================================================
FILE: QMS-Client-main/src/types/AssemblyModels.ts
================================================================================

export interface AssemblyRouteStepModel {
  id: number;
  routeId: number;
  order: number;
  title: string;
  operation: string;
  sectionId: number | null;
  teamId: number | null;
  description: string | null;

  section?: {
    id: number;
    title: string;
  } | null;

  team?: {
    id: number;
    title: string;
  } | null;
}

export interface AssemblyRouteModel {
  id: number;
  title: string;
  productName: string | null;
  description: string | null;
  isActive: boolean;
  createdById: number;
  createdAt: string;
  updatedAt: string;

  steps?: AssemblyRouteStepModel[];
}


export interface SaveAssemblyRouteDto {
  id?: number;
  title: string;
  productName?: string;
  description?: string;
  isActive?: boolean;
  steps?: {
    id?: number;
    order: number;
    title: string;
    operation: string;
    sectionId?: number | null;
    teamId?: number | null;
    description?: string | null;
  }[];
}

================================================================================
FILE: QMS-Client-main/src/types/AuditLogModel.ts
================================================================================

export interface AuditLogUserShort {
  id: number;
  login: string;
  name: string;
  surname: string;
}

export interface AuditLogMetadata {
  ip?: string | null;
  userAgent?: string | null;
  PCId?: number | null;
  pcName?: string | null;
  pcIp?: string | null;

  [key: string]: any;
}

export interface AuditLogModel {
  id: number;
  userId: number | null;
  action: string;
  entity: string | null;
  entityId: string | null;
  description: string | null;
  metadata: AuditLogMetadata | null;
  createdAt: string;
  updatedAt: string;
  User?: AuditLogUserShort | null;
}

================================================================================
FILE: QMS-Client-main/src/types/BoardsForFlashModel.ts
================================================================================

export interface fcModelFull {
    id: number;
    unique_device_id: string;
    firmware: boolean;
    stand_test: boolean;
    sessionId: number;
    categoryDefectId: number;
    createdAt: string;
    updatedAt: string;
}
export interface fcModelMed {
    id: number;
    firmware: boolean;
    sessionId: number;
    categoryDefectId: number;
}

export interface fcModelShort {
    unique_device_id: string;
    firmware: boolean;
    sessionId: number;
    categoryDefectId: number;
}

export interface ELRS915ModelFull {
    id: number;
    MAC_address: string;
    firmware: boolean;
    sessionId: number;
    categoryDefect915Id: number;
    firmwareVersion: string;
    createdAt: string;
    updatedAt: string;
}

export interface ELRS2_4ModelFull {
    id: number;
    MAC_address: string;
    firmware: boolean;
    sessionId: number;
    categoryDefect24Id: number;
    createdAt: string;
    updatedAt: string;
}


export interface Coral_B_ModelFull {
    id: number;
    serial: string;
    firmware: boolean;
    SAW_filter: boolean;
    firmwareVersion: string;
    sessionId: number;
    categoryDefectCoralBId: number;
    createdAt: string;
    updatedAt: string;
}
================================================================================
FILE: QMS-Client-main/src/types/ComponentModel.ts
================================================================================

import { productModel } from "./ProductModel";

export interface componentModel {
    id: number;
    title: string;
    article: string;
    quantity: number;
    image: string;
    createdAt: string;
    updatedAt: string;
}

export interface connectionProduct_ComponentModel {
    id: number;
    product_id: number;
    component_id: number;
    required_quantity: number;
    createdAt: string;
    updatedAt: string;
    Product: productModel;
    Component: componentModel;
}
================================================================================
FILE: QMS-Client-main/src/types/DefectModel.ts
================================================================================

export interface defectModelFull {
    id: number;
    title: string;
    description: string;
    createdAt: string;
    updatedAt: string;
}
export interface defectModelMed {
    id: number;
    title: string;
    description: string;
}
export interface defectModelShort {
    title: string;
    description: string;
}
================================================================================
FILE: QMS-Client-main/src/types/DefectTypes.ts
================================================================================



export interface DefectCategory {
  id: number;
  code: string;
  title: string;
  description: string | null;
  severity: "CRITICAL" | "MAJOR" | "MINOR";
  applicableTypes: string[];
  isActive: boolean;
  createdAt: string;
  updatedAt: string;
}

export interface CreateDefectCategoryDto {
  code: string;
  title: string;
  description?: string;
  severity?: "CRITICAL" | "MAJOR" | "MINOR";
  applicableTypes?: string[];
}

export interface UpdateDefectCategoryDto {
  code?: string;
  title?: string;
  description?: string;
  severity?: "CRITICAL" | "MAJOR" | "MINOR";
  applicableTypes?: string[];
  isActive?: boolean;
}


export type BoardType = "FC" | "ELRS_915" | "ELRS_2_4" | "CORAL_B" | "SMARAGD";

export type DefectStatus =
  | "OPEN"
  | "IN_REPAIR"
  | "REPAIRED"
  | "VERIFIED"
  | "SCRAPPED"
  | "RETURNED"
  | "CLOSED";

export type FinalResult =
  | "FIXED"
  | "SCRAPPED"
  | "RETURNED_TO_SUPPLIER"
  | "FALSE_POSITIVE";

export interface UserShort {
  id: number;
  name: string;
  surname: string;
}

export interface BoardDefect {
  id: number;
  boardType: BoardType;
  boardId: number | null;
  serialNumber: string | null;
  categoryId: number;
  description: string | null;
  detectedById: number;
  detectedAt: string;
  status: DefectStatus;
  closedById: number | null;
  closedAt: string | null;
  finalResult: FinalResult | null;
  totalRepairMinutes: number;
  createdAt: string;
  updatedAt: string;


  category?: DefectCategory;
  detectedBy?: UserShort;
  closedBy?: UserShort;
  repairs?: RepairAction[];
}

export interface CreateDefectDto {
  boardType: BoardType;
  boardId?: number | null;
  serialNumber?: string | null;
  categoryId: number;
  description?: string;
}

export interface DefectsResponse {
  defects: BoardDefect[];
  total: number;
  page: number;
  totalPages: number;
  stats: Record<DefectStatus, number>;
}

export interface DefectDetailResponse {
  defect: BoardDefect;
  boardInfo: any | null;
}


export type ActionType =
  | "DIAGNOSIS"
  | "SOLDER"
  | "REPLACE"
  | "FLASH"
  | "TEST"
  | "CLEAN"
  | "CLONE_DISK"
  | "CABLE_REPLACE"
  | "OTHER";

export type ActionResult = "SUCCESS" | "PARTIAL" | "FAILED" | "PENDING";

export interface RepairAction {
  id: number;
  boardDefectId: number;
  actionType: ActionType;
  performedById: number;
  performedAt: string;
  description: string;
  timeSpentMinutes: number | null;
  result: ActionResult;
  createdAt: string;
  updatedAt: string;


  performedBy?: UserShort;
}

export interface CreateRepairActionDto {
  actionType: ActionType;
  description: string;
  timeSpentMinutes?: number;
  result?: ActionResult;
}

export interface MarkRepairedDto {
  repairNote?: string;
  timeSpentMinutes?: number;
}

export interface MarkScrappedDto {
  reason?: string;
}


export interface DefectStatistics {
  byStatus: Array<{ status: DefectStatus; count: number }>;
  byCategory: Array<{ categoryId: number; count: number; "category.title"?: string }>;
  byBoardType: Array<{ boardType: BoardType; count: number }>;
  avgRepairTime: number | null;
}


export const BOARD_TYPE_LABELS: Record<BoardType, string> = {
  FC: "–ü–æ–ª—ë—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (FC)",
  ELRS_915: "ELRS 915 –ú–ì—Ü",
  ELRS_2_4: "ELRS 2.4 –ì–ì—Ü",
  CORAL_B: "Coral B",
  SMARAGD: "–°–º–∞—Ä–∞–≥–¥"
};

export const BOARD_TYPE_SHORT: Record<BoardType, string> = {
  FC: "FC",
  ELRS_915: "ELRS 915",
  ELRS_2_4: "ELRS 2.4",
  CORAL_B: "Coral B",
  SMARAGD: "–°–º–∞—Ä–∞–≥–¥"
};

export const DEFECT_STATUS_LABELS: Record<DefectStatus, string> = {
  OPEN: "–ñ–¥—ë—Ç —Ä–µ–º–æ–Ω—Ç–∞",
  IN_REPAIR: "–í —Ä–µ–º–æ–Ω—Ç–µ",
  REPAIRED: "–û—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ",
  VERIFIED: "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –û–¢–ö",
  SCRAPPED: "–°–ø–∏—Å–∞–Ω–æ",
  RETURNED: "–í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫—É",
  CLOSED: "–ó–∞–∫—Ä—ã—Ç–æ"
};

export const DEFECT_STATUS_COLORS: Record<DefectStatus, string> = {
  OPEN: "bg-red-100 text-red-700",
  IN_REPAIR: "bg-yellow-100 text-yellow-700",
  REPAIRED: "bg-blue-100 text-blue-700",
  VERIFIED: "bg-green-100 text-green-700",
  SCRAPPED: "bg-gray-100 text-gray-700",
  RETURNED: "bg-purple-100 text-purple-700",
  CLOSED: "bg-gray-100 text-gray-500"
};

export const SEVERITY_LABELS: Record<string, string> = {
  CRITICAL: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π",
  MAJOR: "–°–µ—Ä—å—ë–∑–Ω—ã–π",
  MINOR: "–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π"
};

export const SEVERITY_COLORS: Record<string, string> = {
  CRITICAL: "bg-red-100 text-red-700",
  MAJOR: "bg-yellow-100 text-yellow-700",
  MINOR: "bg-gray-100 text-gray-600"
};

export const ACTION_TYPE_LABELS: Record<ActionType, string> = {
  DIAGNOSIS: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
  SOLDER: "–ü–∞–π–∫–∞",
  REPLACE: "–ó–∞–º–µ–Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞",
  FLASH: "–ü—Ä–æ—à–∏–≤–∫–∞",
  TEST: "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
  CLEAN: "–ß–∏—Å—Ç–∫–∞",
  CLONE_DISK: "–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞",
  CABLE_REPLACE: "–ó–∞–º–µ–Ω–∞ –∫–∞–±–µ–ª—è",
  OTHER: "–î—Ä—É–≥–æ–µ"
};

export const ACTION_TYPE_ICONS: Record<ActionType, string> = {
  DIAGNOSIS: "üîç",
  SOLDER: "üîß",
  REPLACE: "üîÑ",
  FLASH: "üíæ",
  TEST: "üß™",
  CLEAN: "üßπ",
  CLONE_DISK: "üíø",
  CABLE_REPLACE: "üîå",
  OTHER: "üìù"
};

export const ACTION_RESULT_LABELS: Record<ActionResult, string> = {
  SUCCESS: "–£—Å–ø–µ—à–Ω–æ",
  PARTIAL: "–ß–∞—Å—Ç–∏—á–Ω–æ",
  FAILED: "–ù–µ—É–¥–∞—á–∞",
  PENDING: "–í –ø—Ä–æ—Ü–µ—Å—Å–µ"
};

export const ACTION_RESULT_COLORS: Record<ActionResult, string> = {
  SUCCESS: "text-green-600",
  PARTIAL: "text-yellow-600",
  FAILED: "text-red-600",
  PENDING: "text-gray-500"
};

================================================================================
FILE: QMS-Client-main/src/types/PCModel.ts
================================================================================

export interface pcModelFull {
    id: number;
    ip: string;
    pc_name: string;
    cabinet: string;
    createdAt: string;
    updatedAt: string;
}
export interface pcModelMed {
    id: number;
    ip: string;
    pc_name: string;
    cabinet: string;
}
export interface pcModelShort {
    ip: string;
    pc_name: string;
    cabinet: string;
}
================================================================================
FILE: QMS-Client-main/src/types/ProductModel.ts
================================================================================

export interface productModel {
    id: number;
    title: string;
    status_id: number;
    createdAt: string;
    updatedAt: string;
    Status: productStatusModel
}

export interface productStatusModel {
    id: number;
    title: string;
    createdAt: string;
    updatedAt: string;
}
================================================================================
FILE: QMS-Client-main/src/types/SessionModel.ts
================================================================================

export interface SessionModelFull {
    id: number;
    online: boolean;
    userId: number;
    PCId: number;
    createdAt: string;
    updatedAt: string;
}
export interface SessionModelShort {
    online: boolean;
    userId: number;
    PCId: number;
}
================================================================================
FILE: QMS-Client-main/src/types/UserModel.ts
================================================================================

export interface userModel {
    exp: number;
    iat: number;
    id: number;
    login: string;
    name: string;

    role: "SUPER_ADMIN" | "PRODUCTION_CHIEF" | "TECHNOLOGIST" | "WAREHOUSE_MASTER" | "ASSEMBLER" | "QC_ENGINEER" | "FIRMWARE_OPERATOR" | string;
    surname: string;
    img: string | null;
    abilities?: string[];
}

export interface userGetModel {
    id: number;
    login: string;
    password: string;
    role: string;
    name: string;
    surname: string;
    img: string | null;
    createdAt: string;
    updatedAt: string;
    abilities?: string[];
}

export interface userModelShort {
    login: string;
    password: string;
}

================================================================================
FILE: QMS-Client-main/src/types/WarehouseModels.ts
================================================================================

export interface WarehouseUserShort {
  id: number;
  login: string;
  name: string;
  surname: string;
}

export interface WarehouseSectionShort {
  id: number;
  title: string;
}

export interface WarehouseTeamShort {
  id: number;
  title: string;
}


export interface SupplyModel {
  id: number;
  supplier: string | null;
  docNumber: string | null;
  status: string;
  comment: string | null;
  expectedDate: string | null;
  createdAt: string;
  updatedAt: string;
}


export interface InventoryBoxModel {
  id: number;
  supplyId: number | null;

  qrCode: string;
  shortCode: string | null;

  label: string;
  displayName?: string;
  labelCode?: string;

  originType: string | null;
  originId: number | null;

  quantity: number;
  unit: string;

  parentBoxId: number | null;

  boxNumber: string | null;
  kitNumber: string | null;
  projectName: string | null;
  batchName: string | null;

  status: string;
  notes: string | null;

  currentSectionId: number | null;
  currentTeamId: number | null;

  createdAt: string;
  updatedAt: string;

  section?: WarehouseSectionShort | null;
  team?: WarehouseTeamShort | null;
  currentSection?: WarehouseSectionShort | null;
  currentTeam?: WarehouseTeamShort | null;
  supply?: SupplyModel | null;
}

export interface WarehouseMovement {
  id: number;
  boxId: number;
  documentId?: number | null;

  fromSectionId: number | null;
  toSectionId: number | null;
  fromTeamId: number | null;
  toTeamId: number | null;

  operation: string;
  statusAfter: string | null;

  deltaQty: number;
  goodQty?: number | null;
  scrapQty?: number | null;

  performedAt: string;
  comment: string | null;

  performedBy?: WarehouseUserShort;
  fromSection?: WarehouseSectionShort;
  toSection?: WarehouseSectionShort;
  fromTeam?: WarehouseTeamShort;
  toTeam?: WarehouseTeamShort;
}

export interface WarehouseDocument {
  id: number;
  boxId: number | null;
  number: string;
  type: string | null;
  date: string | null;
  fileUrl: string | null;
  comment: string | null;
  createdById: number;
  createdAt: string;
  updatedAt: string;
  createdBy?: WarehouseUserShort;
}

export interface StockBalanceItem {
  label: string;
  originType: string | null;
  originId: number | null;
  unit: string;
  totalQuantity: string;
  boxCount: string;
}

export interface InventoryLimitModel {
  id: number;
  label: string;
  min: number;
  originType?: string;
  originId?: number;
}

================================================================================
FILE: QMS-Client-main/src/types/beryll/components.ts
================================================================================



export type ComponentType =
  | 'CPU'
  | 'RAM'
  | 'HDD'
  | 'SSD'
  | 'NVME'
  | 'NIC'
  | 'MOTHERBOARD'
  | 'PSU'
  | 'GPU'
  | 'RAID'
  | 'BMC'
  | 'FAN'
  | 'CHASSIS'
  | 'OTHER';

export type ComponentStatus = 'OK' | 'WARNING' | 'CRITICAL' | 'UNKNOWN' | 'REPLACED';

export type DataSource = 'BMC' | 'REDFISH' | 'MANUAL' | 'IMPORT' | 'REPLACEMENT';

export type BMCDiscrepancyReason =
  | 'NOT_FOUND_IN_BMC'
  | 'REMOVED_FROM_BMC'
  | 'DATA_MISMATCH'
  | 'SERIAL_CHANGED';


export interface ServerComponent {
  id: number;
  serverId: number;


  componentType: ComponentType;
  name: string;


  manufacturer?: string;
  model?: string;


  serialNumber?: string;
  serialNumberYadro?: string;
  partNumber?: string;


  slot?: string;


  capacity?: number;
  speed?: string;
  capacityFormatted?: string;
  speedFormatted?: string;
  firmwareVersion?: string;


  status: ComponentStatus;
  healthPercent?: number;


  dataSource?: DataSource;
  metadata?: ComponentMetadata;
  lastUpdatedAt?: string;
  createdAt?: string;
  updatedAt?: string;


  inventoryId?: number;
  catalogId?: number;
  installedById?: number;


  bmcDiscrepancy?: boolean;
  bmcDiscrepancyReason?: BMCDiscrepancyReason;
}

export interface ComponentMetadata {

  cores?: number;
  threads?: number;
  architecture?: string;


  memoryType?: string;
  rank?: number;


  mediaType?: string;
  interface?: string;


  macAddress?: string;
  linkSpeed?: string;


  health?: string | number;
  fetchedById?: number;


  replacedAt?: string;
  replacedById?: number;
  reason?: string;
  replacesComponentId?: number;
  replacementReason?: string;
  defectRecordId?: number;
  inventorySourceId?: number;
}


export interface ComponentsResponse {
  server: {
    id: number;
    ipAddress?: string;
    hostname?: string;
    apkSerialNumber?: string;
    lastComponentsFetchAt?: string;
  };
  summary: {
    totalRAMBytes: number;
    totalStorageBytes: number;
    totalRAM: string;
    totalStorage: string;
    cpuCores: number;
    cpuThreads: number;
    totalComponents: number;
  };
  grouped: {
    CPU: ServerComponent[];
    RAM: ServerComponent[];
    storage: ServerComponent[];
    NIC: ServerComponent[];
    other: ServerComponent[];
  };
  components: ServerComponent[];
  discrepancyCount?: number;
}

export interface BMCCheckResponse {
  success: boolean;
  redfishVersion?: string;
  bmcAddress?: string;
  error?: string;
}

export interface FetchComponentsResponse {
  success: boolean;
  message: string;
  components: ServerComponent[];
}


export type SyncMode = 'compare' | 'force' | 'merge';

export interface BMCComponent {
  componentType: ComponentType;
  name?: string;
  slot?: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  partNumber?: string;
  firmwareVersion?: string;
  status?: string;
  capacityBytes?: number;
  speedMHz?: number;
  speedMT?: number;
  speed?: number;
  cores?: number;
  threads?: number;
  architecture?: string;
  memoryType?: string;
  rank?: string;
  mediaType?: string;
  interface?: string;
  macAddress?: string;
  linkSpeed?: string;
  health?: number | string;
}

export interface ComponentDifference {
  field: string;
  db: string | null;
  bmc: string | null;
}

export interface ComparisonMatchedItem {
  dbComponent: ServerComponent;
  bmcComponent: BMCComponent;
}

export interface ComparisonMissingItem {
  dbComponent: ServerComponent;
  isManual: boolean;
  reason: string;
}

export interface ComparisonNewItem {
  bmcComponent: BMCComponent;
  reason: string;
}

export interface ComparisonMismatchItem {
  dbComponent: ServerComponent;
  bmcComponent: BMCComponent;
  differences: ComponentDifference[];
}

export interface ComparisonDetails {
  matched: ComparisonMatchedItem[];
  missingInBmc: ComparisonMissingItem[];
  newInBmc: ComparisonNewItem[];
  mismatches: ComparisonMismatchItem[];
}

export interface ComparisonSummary {
  total: {
    inDb: number;
    inBmc: number;
  };
  matched: number;
  missingInBmc: number;
  newInBmc: number;
  mismatches: number;
}

export interface BMCCompareResponse {
  success: boolean;
  mode: 'compare';
  hasDiscrepancies: boolean;
  summary: ComparisonSummary;
  details: ComparisonDetails;
  message?: string;
}

export interface BMCForceResponse {
  success: boolean;
  mode: 'force';
  message: string;
  manualPreserved: number;
  components: ServerComponent[];
}

export interface BMCMergeActions {
  updated: Array<{
    id: number;
    serialNumber: string | null;
    changes: ComponentDifference[];
  }>;
  added: ServerComponent[];
  preserved: ServerComponent[];
  flaggedForReview: Array<{
    id: number;
    serialNumber: string | null;
    reason: string;
  }>;
}

export interface BMCMergeResponse {
  success: boolean;
  mode: 'merge';
  message: string;
  actions: BMCMergeActions;
}

export type BMCSyncResponse = BMCCompareResponse | BMCForceResponse | BMCMergeResponse;

export interface BMCSyncRequest {
  mode: SyncMode;
  preserveManual?: boolean;
}

export interface ResolveDiscrepancyRequest {
  resolution: 'keep' | 'delete';
}

export interface ResolveDiscrepancyResponse {
  success: boolean;
  action: 'kept' | 'deleted';
  component?: ServerComponent;
}


export interface AddComponentData {
  componentType: string;
  name?: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  serialNumberYadro?: string;
  partNumber?: string;
  slot?: string;
  status?: string;
  capacity?: number;
  speed?: string;
  firmwareVersion?: string;
  metadata?: Record<string, any>;
}

export interface UpdateComponentData {
  name?: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  serialNumberYadro?: string;
  partNumber?: string;
  slot?: string;
  status?: string;
  firmwareVersion?: string;
  capacity?: number;
  speed?: string;
  metadata?: Record<string, any>;
}

export interface ReplaceComponentData {
  newSerialNumber?: string;
  newSerialNumberYadro?: string;
  newManufacturer?: string;
  newModel?: string;
  newPartNumber?: string;
  reason?: string;
  defectRecordId?: number;
  inventoryComponentId?: number;
}


export type ComponentHistoryAction =
  | 'ADDED'
  | 'UPDATED'
  | 'REPLACED'
  | 'REMOVED'
  | 'SERIAL_CHANGED'
  | 'COMPONENTS_FETCHED'
  | 'COMPONENTS_MERGED'
  | 'DISCREPANCY_RESOLVED';

export interface ComponentHistoryEntry {
  id: number;
  action: ComponentHistoryAction;
  componentId: number;
  serverId: number;
  userId: number;
  userName?: string;
  oldValue?: Record<string, any>;
  newValue?: Record<string, any>;
  reason?: string;
  performedAt: string;
}


export interface ComponentSearchParams {
  serialNumber?: string;
  serialNumberYadro?: string;
  componentType?: string;
  serverId?: number;
}

export interface ComponentSearchResult {
  found: boolean;
  component?: ServerComponent;
  server?: {
    id: number;
    apkSerialNumber: string;
    hostname?: string;
    ipAddress?: string;
  };
  suggestions?: ServerComponent[];
}


export const COMPONENT_TYPE_LABELS: Record<ComponentType, string> = {
  CPU: '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä',
  RAM: '–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å',
  HDD: '–ñ—ë—Å—Ç–∫–∏–π –¥–∏—Å–∫',
  SSD: '–¢–≤–µ—Ä–¥–æ—Ç–µ–ª—å–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å',
  NVME: 'NVMe –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å',
  NIC: '–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞',
  MOTHERBOARD: '–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞',
  PSU: '–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è',
  GPU: '–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞',
  RAID: 'RAID-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä',
  BMC: 'BMC',
  FAN: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä',
  CHASSIS: '–ö–æ—Ä–ø—É—Å',
  OTHER: '–ü—Ä–æ—á–µ–µ'
};

export const COMPONENT_STATUS_LABELS: Record<ComponentStatus, string> = {
  OK: '–ò—Å–ø—Ä–∞–≤–µ–Ω',
  WARNING: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
  CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ',
  UNKNOWN: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
  REPLACED: '–ó–∞–º–µ–Ω—ë–Ω'
};

export const COMPONENT_STATUS_COLORS: Record<ComponentStatus, string> = {
  OK: 'bg-emerald-100 text-emerald-700 border-emerald-300',
  WARNING: 'bg-amber-100 text-amber-700 border-amber-300',
  CRITICAL: 'bg-red-100 text-red-700 border-red-300',
  UNKNOWN: 'bg-slate-100 text-slate-500 border-slate-300',
  REPLACED: 'bg-violet-100 text-violet-700 border-violet-300'
};

export const COMPONENT_TYPE_ICONS: Record<ComponentType, string> = {
  CPU: 'cpu',
  RAM: 'memory-stick',
  HDD: 'hard-drive',
  SSD: 'hard-drive',
  NVME: 'hard-drive',
  NIC: 'network',
  MOTHERBOARD: 'circuit-board',
  PSU: 'zap',
  GPU: 'circuit-board',
  RAID: 'hard-drive',
  BMC: 'server',
  FAN: 'fan',
  CHASSIS: 'box',
  OTHER: 'settings'
};

export const BMC_DISCREPANCY_LABELS: Record<BMCDiscrepancyReason, string> = {
  NOT_FOUND_IN_BMC: '–ù–µ –Ω–∞–π–¥–µ–Ω –≤ BMC',
  REMOVED_FROM_BMC: '–£–¥–∞–ª—ë–Ω –∏–∑ BMC',
  DATA_MISMATCH: '–î–∞–Ω–Ω—ã–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è',
  SERIAL_CHANGED: '–ò–∑–º–µ–Ω—ë–Ω S/N'
};


export function formatBytes(bytes: number | undefined | null): string {
  if (!bytes || bytes === 0) return '0 B';

  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));

  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

export function isStorageComponent(type: ComponentType): boolean {
  return ['HDD', 'SSD', 'NVME'].includes(type);
}

export function getStatusColor(status: ComponentStatus): string {
  return COMPONENT_STATUS_COLORS[status] || COMPONENT_STATUS_COLORS.UNKNOWN;
}

================================================================================
FILE: QMS-Client-main/src/types/beryll/defectsAndMonitoring.ts
================================================================================



export type DefectCategory = 'HARDWARE' | 'SOFTWARE' | 'ASSEMBLY' | 'COMPONENT' | 'OTHER';
export type DefectPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
export type DefectStatus = 'NEW' | 'IN_PROGRESS' | 'RESOLVED' | 'WONT_FIX';

export interface DefectFile {
  id: number;
  commentId: number;
  originalName: string;
  fileName: string;
  filePath: string;
  mimeType: string | null;
  fileSize: number | null;
  uploadedById: number | null;
  uploadedBy?: {
    id: number;
    login: string;
    name: string;
    surname: string;
  };
  createdAt: string;
}

export interface DefectComment {
  id: number;
  serverId: number;
  userId: number;
  text: string;
  defectCategory: DefectCategory;
  priority: DefectPriority;
  status: DefectStatus;
  resolvedById: number | null;
  resolvedAt: string | null;
  resolution: string | null;
  createdAt: string;
  updatedAt: string;
  author?: {
    id: number;
    login: string;
    name: string;
    surname: string;
  };
  resolvedBy?: {
    id: number;
    login: string;
    name: string;
    surname: string;
  };
  server?: {
    id: number;
    ipAddress: string;
    hostname: string;
    serialNumber: string;
    apkSerialNumber: string;
  };
  files?: DefectFile[];
}

export interface DefectStats {
  total: number;
  unresolved: number;
  resolved: number;
  byCategory: Record<DefectCategory, number>;
  byStatus: Record<DefectStatus, number>;
  byPriority: Record<DefectPriority, number>;
}


export type PingStatus = 'ONLINE' | 'OFFLINE' | 'UNKNOWN';

export interface ServerPingResult {
  serverId: number;
  ipAddress: string;
  hostname: string;
  serialNumber?: string;
  apkSerialNumber?: string;
  serverStatus?: string;
  batchId?: number;
  online: boolean;
  latency: number | null;
  error: string | null;
  checkedAt: string;
}

export interface MonitoringStats {
  byStatus: Record<PingStatus, number>;
  total: number;
  online: number;
  offline: number;
  unknown: number;
  staleServers: number;
  avgLatency: string | null;
  lastFullScan: string | null;
}

export interface PingAllResult {
  total: number;
  online: number;
  offline: number;
  checkedAt: string;
  cached?: boolean;
  servers: ServerPingResult[];
}


export const DEFECT_CATEGORY_LABELS: Record<DefectCategory, string> = {
  HARDWARE: '–ñ–µ–ª–µ–∑–æ',
  SOFTWARE: '–°–æ—Ñ—Ç',
  ASSEMBLY: '–°–±–æ—Ä–∫–∞',
  COMPONENT: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç',
  OTHER: '–î—Ä—É–≥–æ–µ'
};

export const DEFECT_PRIORITY_LABELS: Record<DefectPriority, string> = {
  LOW: '–ù–∏–∑–∫–∏–π',
  MEDIUM: '–°—Ä–µ–¥–Ω–∏–π',
  HIGH: '–í—ã—Å–æ–∫–∏–π',
  CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π'
};

export const DEFECT_STATUS_LABELS: Record<DefectStatus, string> = {
  NEW: '–ù–æ–≤—ã–π',
  IN_PROGRESS: '–í —Ä–∞–±–æ—Ç–µ',
  RESOLVED: '–†–µ—à—ë–Ω',
  WONT_FIX: '–ù–µ –±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω'
};

export const PING_STATUS_LABELS: Record<PingStatus, string> = {
  ONLINE: '–û–Ω–ª–∞–π–Ω',
  OFFLINE: '–û—Ñ—Ñ–ª–∞–π–Ω',
  UNKNOWN: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
};


export const PRIORITY_COLORS: Record<DefectPriority, string> = {
  LOW: '#4caf50',
  MEDIUM: '#ff9800',
  HIGH: '#f44336',
  CRITICAL: '#9c27b0'
};

export const STATUS_COLORS: Record<DefectStatus, string> = {
  NEW: '#2196f3',
  IN_PROGRESS: '#ff9800',
  RESOLVED: '#4caf50',
  WONT_FIX: '#9e9e9e'
};

export const PING_STATUS_COLORS: Record<PingStatus, string> = {
  ONLINE: '#4caf50',
  OFFLINE: '#f44336',
  UNKNOWN: '#9e9e9e'
};

================================================================================
FILE: QMS-Client-main/src/utils/consts.ts
================================================================================



export const ADMIN_ROUTE = '/admin';
export const ADMIN_PCs_ROUTE = '/admin/pcs';
export const ADMIN_USERS_ROUTE = '/admin/users';
export const STRUCTURE_ROUTE = '/admin/structure';
export const AUDIT_LOG_ROUTE = '/admin/audit-log';
export const ADMIN_WAREHOUSE_ROUTE = '/admin/warehouse';
export const ADMIN_RBAC_ROUTE = '/admin/rbac';

export const LOGIN_ROUTE = '/login';
export const SELECT_PC_ROUTE = '/select-pc-for-start-session';
export const REGISTRATION_ROUTE = '/registration';
export const USERS_ROUTE = '/users';
export const PROFILE_ROUTE = '/profile';

export const START_ROUTE = '/';

export const WAREHOUSE_ROUTE = '/warehouse';
export const WAREHOUSE_ANALYTICS_ROUTE = '/warehouse/analytics';
export const WAREHOUSE_INVENTORY_ROUTE = '/warehouse/inventory';

export const TASKS_ROUTE = '/tasks';

================================================================================
FILE: QMS-Client-main/src/utils/constsModalType.ts
================================================================================

  export const CREATE_COMPUTER = 'createPC'
  export const CREATE_USER = 'createUser'

================================================================================
FILE: QMS-Client-main/src/vite-env.d.ts
================================================================================



================================================================================
FILE: QMS-Client-main/tailwind.config.js
================================================================================


export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      animation: {

        'fade-in': 'fadeIn 0.4s ease-out forwards',

        'slide-in-up': 'slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',

        'scale-in': 'scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideInUp: {
          '0%': { opacity: '0', transform: 'translateY(15px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
        scaleIn: {
          '0%': { opacity: '0', transform: 'scale(0.95) translateY(-10px)' },
          '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
        }
      }
    },
  },
  plugins: [],
}

================================================================================
FILE: QMS-Client-main/tsconfig.json
================================================================================

{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,

    
    "baseUrl": ".",
    "paths": {
      "public/*": ["public/*"],
      "src/*": ["src/*"],
      "api/*": ["src/api/*"],
      "assets/*": ["src/assets/*"],
      "components/*": ["src/components/*"],
      "pages/*": ["src/pages/*"],
      "store/*": ["src/store/*"],
      "types/*": ["src/types/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}

================================================================================
FILE: QMS-Client-main/tsconfig.node.json
================================================================================

{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true,
    "strict": true
  },
  "include": ["vite.config.ts"]
}

================================================================================
FILE: QMS-Client-main/vite.config.ts
================================================================================

import { defineConfig } from "vite";
import react from "@vitejs/plugin-react-swc";
import { VitePWA } from "vite-plugin-pwa";


export default defineConfig({
  preview: {
    host: "0.0.0.0",
    port: 4173,
  },

  plugins: [
    react(),
    VitePWA({
      registerType: "autoUpdate",
      workbox: {
        maximumFileSizeToCacheInBytes: 5 * 1024 * 1024,
      },
      includeAssets: [
        "favicon.ico",
        "apple-touch-icon.png",
        "maskable-icon-512x512.svg",
      ],
      manifest: {
        name: "MES_crypto",
        short_name: "Vite PWA Project",
        theme_color: "#ffffff",
        icons: [
          {
            src: "pwa-64x64.png",
            sizes: "64x64",
            type: "image/png",
          },
          {
            src: "pwa-192x192.png",
            sizes: "192x192",
            type: "image/png",
          },
          {
            src: "pwa-512x512.png",
            sizes: "512x512",
            type: "image/png",
            purpose: "any",
          },
          {
            src: "maskable-icon-512x512.png",
            sizes: "512x512",
            type: "image/png",
            purpose: "maskable",
          },
        ],
      },
    }),
  ],

  resolve: {
    alias: {
      public: "/public",
      src: "/src",
      api: "/src/api",
      assets: "/src/assets",
      components: "/src/components",
      pages: "src/pages",
      store: "/src/store",
      types: "/src/types",
    },
  },
});

================================================================================
FILE: QMS-Client-main/vitest.config.ts
================================================================================

import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react-swc';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      public: path.resolve(__dirname, './public'),
      src: path.resolve(__dirname, './src'),
      api: path.resolve(__dirname, './src/api'),
      assets: path.resolve(__dirname, './src/assets'),
      components: path.resolve(__dirname, './src/components'),
      pages: path.resolve(__dirname, './src/pages'),
      store: path.resolve(__dirname, './src/store'),
      types: path.resolve(__dirname, './src/types'),
    },
  },
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/setupTests.ts',
    css: true,
  },
});

================================================================================
FILE: QMS-Mobile/mes-pwa/deploy.sh
================================================================================

#!/bin/bash














set -e


RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'


APP_NAME="MES Kryptonit PWA"
VERSION="2.0.0"
BUILD_DIR="./dist"
DEPLOY_DIR="/var/www/mes-pwa"
NGINX_CONF_SRC="./nginx/mes-pwa-gateway.conf"
NGINX_CONF_DST="/etc/nginx/sites-available/mes-pwa-gateway.conf"
NGINX_ENABLED="/etc/nginx/sites-enabled/mes-pwa-gateway.conf"


ENVIRONMENT=${1:-production}





log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë            $APP_NAME v$VERSION                  ‚ïë"
    echo "‚ïë                  Deployment Script                         ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    log_info "Environment: $ENVIRONMENT"
    echo ""
}

check_requirements() {
    log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π..."
    

    if ! command -v node &> /dev/null; then
        log_error "Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
        exit 1
    fi
    log_success "Node.js: $(node -v)"
    

    if ! command -v npm &> /dev/null; then
        log_error "npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
        exit 1
    fi
    log_success "npm: $(npm -v)"
    

    if [ "$ENVIRONMENT" = "production" ]; then
        if ! command -v nginx &> /dev/null; then
            log_warning "Nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞."
        else
            log_success "Nginx: $(nginx -v 2>&1 | head -1)"
        fi
    fi
}

install_dependencies() {
    log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    if [ -f "package-lock.json" ]; then
        npm ci
    else
        npm install
    fi
    
    log_success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

build_app() {
    log_info "–°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    

    rm -rf "$BUILD_DIR"
    

    npm run build
    

    if [ ! -d "$BUILD_DIR" ]; then
        log_error "–°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å - –ø–∞–ø–∫–∞ dist –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
        exit 1
    fi
    
    log_success "–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $BUILD_DIR"
    log_info "–†–∞–∑–º–µ—Ä —Å–±–æ—Ä–∫–∏: $(du -sh $BUILD_DIR | cut -f1)"
}

deploy_files() {
    log_info "–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
    

    sudo mkdir -p "$DEPLOY_DIR"
    

    sudo rm -rf "${DEPLOY_DIR:?}"/*
    

    sudo cp -r "$BUILD_DIR"/* "$DEPLOY_DIR/"
    

    sudo chown -R www-data:www-data "$DEPLOY_DIR"
    

    sudo chmod -R 755 "$DEPLOY_DIR"
    
    log_success "–§–∞–π–ª—ã —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã –≤ $DEPLOY_DIR"
}

configure_nginx() {
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."
    
    if ! command -v nginx &> /dev/null; then
        log_warning "Nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
        return
    fi
    

    if [ ! -f "$NGINX_CONF_SRC" ]; then
        log_warning "–ö–æ–Ω—Ñ–∏–≥ Nginx –Ω–µ –Ω–∞–π–¥–µ–Ω: $NGINX_CONF_SRC"
        return
    fi
    

    sudo cp "$NGINX_CONF_SRC" "$NGINX_CONF_DST"
    

    if [ ! -L "$NGINX_ENABLED" ]; then
        sudo ln -s "$NGINX_CONF_DST" "$NGINX_ENABLED"
    fi
    

    log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
    if sudo nginx -t; then
        log_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –≤–∞–ª–∏–¥–Ω–∞"
        

        sudo systemctl reload nginx
        log_success "Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
    else
        log_error "–û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx!"
        exit 1
    fi
}

print_summary() {
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ                  ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    log_success "PWA —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç!"
    echo ""
    echo "üì± –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:"
    echo ""
    echo "   –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç—å (10.11.0.x):"
    echo "   ‚Üí http://10.11.0.16:3000"
    echo ""
    echo "   WiFi —Å–µ—Ç—å (192.168.27.x):"
    echo "   ‚Üí http://192.168.27.1:3000"
    echo ""
    echo "üîß Keycloak:"
    echo "   ‚Üí –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç—å: http://10.11.0.16:8080"
    echo "   ‚Üí WiFi —Å–µ—Ç—å:     http://192.168.27.1:8080"
    echo ""
    echo "üìù –ù–µ –∑–∞–±—É–¥—å—Ç–µ:"
    echo "   1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Keycloak client —Å redirect URIs –¥–ª—è –æ–±–µ–∏—Ö —Å–µ—Ç–µ–π"
    echo "   2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É —Å–µ—Ç—è–º–∏ –Ω–∞ Gateway"
    echo "   3. –û–±–Ω–æ–≤–∏—Ç—å IP –∞–¥—Ä–µ—Å–∞ –≤ nginx –∫–æ–Ω—Ñ–∏–≥–µ –ø–æ–¥ –≤–∞—à—É –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É"
    echo ""
}





print_header

case "$ENVIRONMENT" in
    production)
        check_requirements
        install_dependencies
        build_app
        deploy_files
        configure_nginx
        print_summary
        ;;
    staging)
        check_requirements
        install_dependencies
        build_app
        deploy_files
        log_success "Staging —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
        ;;
    local)
        check_requirements
        install_dependencies
        build_app
        log_success "–õ–æ–∫–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: npm run preview"
        ;;
    *)
        log_error "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: $ENVIRONMENT"
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [production|staging|local]"
        exit 1
        ;;
esac

exit 0
================================================================================
FILE: QMS-Mobile/mes-pwa/index.html
================================================================================

<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="description" content="MES Kryptonit - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="MES Kryptonit" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <title>MES Kryptonit</title>
  </head>
  <body class="bg-background text-slate-100">
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: QMS-Mobile/mes-pwa/package.json
================================================================================

{
  "name": "mes-kryptonit-pwa",
  "version": "2.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview --host --port 3000"
  },
  "dependencies": {
    "axios": "^1.6.2",
    "lucide-react": "^0.303.0",
    "oidc-client-ts": "^3.0.1",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-oidc-context": "^3.1.0",
    "react-router-dom": "^6.21.0",
    "zustand": "^4.4.7"
  },
  "devDependencies": {
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.4.0",
    "typescript": "^5.2.2",
    "vite": "^5.0.8",
    "vite-plugin-pwa": "^0.17.4"
  }
}

================================================================================
FILE: QMS-Mobile/mes-pwa/postcss.config.js
================================================================================

export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: QMS-Mobile/mes-pwa/public/silent-check-sso.html
================================================================================

<!doctype html>
<html>
<head>
  <title>Silent SSO Check</title>
</head>
<body>
  <script>
    parent.postMessage(location.href, location.origin);
  </script>
</body>
</html>

================================================================================
FILE: QMS-Mobile/mes-pwa/src/App.tsx
================================================================================



import { useEffect } from 'react'
import { Routes, Route, Navigate } from 'react-router-dom'
import { useAuth } from 'react-oidc-context'
import { Loader } from './components/ui'


import { Layout } from './components/common/Layout'


import { LoginPage } from './pages/Auth/LoginPage'
import { HomePage } from './pages/Home/HomePage'
import { WarehousePage } from './pages/Warehouse/WarehousePage'
import { BoxDetailPage } from './pages/Warehouse/BoxDetailPage'
import { ProductionPage } from './pages/Production/ProductionPage'
import { ProductScanPage } from './pages/Production/ProductScanPage'
import { ChecklistPage } from './pages/Production/ChecklistPage'
import { RankingsPage } from './pages/Rankings/RankingsPage'
import { TasksPage } from './pages/Tasks/TasksPage'
import { ProfilePage } from './pages/Profile/ProfilePage'


const ProtectedRoute = ({ children }: { children: React.ReactNode }) => {
  const auth = useAuth()

  if (auth.isLoading) {
    return <Loader fullScreen text="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..." />
  }

  if (!auth.isAuthenticated) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}


function App() {
  const auth = useAuth()


  useEffect(() => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.ready.then((registration) => {
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                if (confirm('–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å?')) {
                  window.location.reload()
                }
              }
            })
          }
        })
      })
    }
  }, [])


  if (auth.isLoading) {
    return <Loader fullScreen text="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..." />
  }

  return (
    <Routes>

      <Route path="/login" element={<LoginPage />} />


      <Route
        path="/"
        element={
          <ProtectedRoute>
            <Layout />
          </ProtectedRoute>
        }
      >
        <Route index element={<HomePage />} />


        <Route path="warehouse" element={<WarehousePage />} />
        <Route path="warehouse/:id" element={<BoxDetailPage />} />


        <Route path="production" element={<ProductionPage />} />
        <Route path="production/scan" element={<ProductScanPage />} />
        <Route path="production/:id" element={<ProductionPage />} />
        <Route path="production/checklist/:productId/:stepId" element={<ChecklistPage />} />


        <Route path="tasks" element={<TasksPage />} />


        <Route path="rankings" element={<RankingsPage />} />


        <Route path="profile" element={<ProfilePage />} />
      </Route>


      <Route path="*" element={<Navigate to="/" replace />} />
    </Routes>
  )
}

export default App

================================================================================
FILE: QMS-Mobile/mes-pwa/src/api/client.ts
================================================================================

import axios, { AxiosError, InternalAxiosRequestConfig, AxiosResponse } from 'axios'
import { User } from 'oidc-client-ts'

export type NetworkEnvironment = 'production' | 'wifi' | 'development'

interface NetworkConfig {
  apiBaseUrl: string
  keycloakAuthority: string
  keycloakClientId: string
  network: NetworkEnvironment
}

const detectNetwork = (): NetworkConfig => {
  const hostname = window.location.hostname
  const protocol = window.location.protocol

  if (hostname.startsWith('192.168.27.')) {
    return {
      apiBaseUrl: `${protocol}//${hostname}:3000/api`,
      keycloakAuthority: `${protocol}//${hostname}:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'wifi'
    }
  }

  if (hostname === 'mes-wifi.local' || hostname === 'mes-mobile.local') {
    return {
      apiBaseUrl: `${protocol}//${hostname}:3000/api`,
      keycloakAuthority: `${protocol}//${hostname}:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'wifi'
    }
  }

  if (hostname.startsWith('10.11.0.')) {
    return {
      apiBaseUrl: `${protocol}//${hostname}:3000/api`,
      keycloakAuthority: `${protocol}//10.11.0.16:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'production'
    }
  }

  if (hostname === 'mes.local' || hostname === 'mes-kryptonit.local') {
    return {
      apiBaseUrl: `${protocol}//${hostname}:3000/api`,
      keycloakAuthority: `${protocol}//${hostname}:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'production'
    }
  }

  if (hostname === '10.11.0.16') {
    return {
      apiBaseUrl: `${protocol}//10.11.0.16:5001/api`,
      keycloakAuthority: `${protocol}//10.11.0.16:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'production'
    }
  }

  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return {
      apiBaseUrl: '/api',
      keycloakAuthority: 'http://keycloak.local/realms/MES-Realm',
      keycloakClientId: 'mes-client',
      network: 'development'
    }
  }

  return {
    apiBaseUrl: `${protocol}//${hostname}/api`,
    keycloakAuthority: `${protocol}//${hostname}:8080/realms/MES-Realm`,
    keycloakClientId: 'mes-pwa-client',
    network: 'production'
  }
}

const networkConfig = detectNetwork()

export const API_BASE_URL = networkConfig.apiBaseUrl

export const KEYCLOAK_CONFIG = {
  authority: networkConfig.keycloakAuthority,
  clientId: networkConfig.keycloakClientId,
}

const DEBUG_HTTP = import.meta.env.DEV

const maskToken = (t?: string | null): string => {
  if (!t) return '<none>'
  const head = t.slice(0, 10)
  const tail = t.slice(-6)
  return `${head}‚Ä¶${tail} (len=${t.length})`
}

const joinUrl = (baseURL?: string, url?: string): string => {
  if (!url) return baseURL ?? ''
  if (/^https?:\/\
  const base = baseURL ?? ''
  return `${base.replace(/\/+$/, '')}/${url.replace(/^\/+/, '')}`
}

const getOidcStorageKey = (): string => {
  return `oidc.user:${KEYCLOAK_CONFIG.authority}:${KEYCLOAK_CONFIG.clientId}`
}

export const getAccessToken = (): string | null => {
  const key = getOidcStorageKey()
  const data = sessionStorage.getItem(key)
  if (!data) return null
  try {
    const user = JSON.parse(data) as User
    return user.access_token || null
  } catch {
    return null
  }
}

export const getUser = (): User | null => {
  const key = getOidcStorageKey()
  const data = sessionStorage.getItem(key)
  if (!data) return null
  try {
    return JSON.parse(data) as User
  } catch {
    return null
  }
}

export const api = axios.create({
  baseURL: API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
  },
})

api.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    const token = getAccessToken()

    if (DEBUG_HTTP) {
      const method = (config.method ?? 'GET').toUpperCase()
      console.log(`[HTTP] --> ${method} ${joinUrl(config.baseURL, config.url)}`)
      console.log(`[HTTP] token = ${maskToken(token)}`)
    }

    if (token) {
      config.headers = config.headers ?? {}
      config.headers.Authorization = `Bearer ${token}`
    }

    return config
  },
  (error) => {
    console.error('[API] Request error:', error)
    return Promise.reject(error)
  }
)

api.interceptors.response.use(
  (response: AxiosResponse) => {
    if (DEBUG_HTTP) {
      console.log(`[HTTP] <-- ${response.status} ${response.config.method?.toUpperCase()} ${joinUrl(response.config.baseURL, response.config.url)}`)
    }
    return response
  },
  (err: AxiosError) => {
    const status = err.response?.status
    const url = err.config?.url

    if (DEBUG_HTTP) {
      console.error(`[HTTP] <-- ERROR`, {
        message: err.message,
        status: status,
        data: err.response?.data,
      })
    }

    if (status === 401) {
      console.warn('[API] Unauthorized - token may be expired')
    }

    if (status === 403) {
      console.warn('[API] Forbidden - insufficient permissions')
    }

    if (status === 404) {
      console.warn('[API] Not Found:', url)
    }

    if (status && status >= 500) {
      console.error('[API] Server Error:', err.response?.data)
    }

    if (!err.response) {
      console.error('[API] Network Error - check connection')
    }

    return Promise.reject(err)
  }
)

export interface ApiErrorResponse {
  message: string
  error?: string
  statusCode?: number
  details?: any
}

export const getErrorMessage = (error: unknown, fallback = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'): string => {
  if (axios.isAxiosError(error)) {
    const axiosError = error as AxiosError<ApiErrorResponse>

    if (axiosError.response?.data?.message) {
      return axiosError.response.data.message
    }

    if (axiosError.response?.status === 401) {
      return '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.'
    }
    if (axiosError.response?.status === 403) {
      return '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏.'
    }
    if (axiosError.response?.status === 404) {
      return '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π —Ä–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.'
    }
    if (axiosError.response?.status && axiosError.response.status >= 500) {
      return '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
    }

    if (axiosError.code === 'ECONNABORTED') {
      return '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.'
    }
    if (!axiosError.response) {
      return '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å.'
    }

    return axiosError.message
  }

  if (error instanceof Error) {
    return error.message
  }

  return fallback
}

export const isNetworkError = (error: unknown): boolean => {
  if (axios.isAxiosError(error)) {
    return !error.response || error.code === 'ECONNABORTED' || error.code === 'ERR_NETWORK'
  }
  return false
}

export const isAuthError = (error: unknown): boolean => {
  if (axios.isAxiosError(error)) {
    return error.response?.status === 401
  }
  return false
}

export const apiGet = async <T>(url: string, params?: any): Promise<T> => {
  const { data } = await api.get<T>(url, { params })
  return data
}

export const apiPost = async <T>(url: string, body?: any): Promise<T> => {
  const { data } = await api.post<T>(url, body)
  return data
}

export const apiPut = async <T>(url: string, body?: any): Promise<T> => {
  const { data } = await api.put<T>(url, body)
  return data
}

export const apiPatch = async <T>(url: string, body?: any): Promise<T> => {
  const { data } = await api.patch<T>(url, body)
  return data
}

export const apiDelete = async <T>(url: string): Promise<T> => {
  const { data } = await api.delete<T>(url)
  return data
}

export const apiUpload = async <T>(url: string, formData: FormData): Promise<T> => {
  const { data } = await api.post<T>(url, formData, {
    headers: {
      'Content-Type': 'multipart/form-data',
    },
    timeout: 60000,
  })
  return data
}

export const getNetworkInfo = () => ({
  apiUrl: API_BASE_URL,
  keycloakAuthority: KEYCLOAK_CONFIG.authority,
  network: networkConfig.network,
  isWifi: networkConfig.network === 'wifi',
  isProduction: networkConfig.network === 'production',
  isDevelopment: networkConfig.network === 'development',
})

console.log(`[API] Network: ${networkConfig.network}, URL: ${API_BASE_URL}`)

export default api
================================================================================
FILE: QMS-Mobile/mes-pwa/src/components/common/Layout.tsx
================================================================================



import { useState, useEffect } from 'react'
import { Outlet, NavLink, useNavigate, useLocation } from 'react-router-dom'
import {
  Home, Package, Cpu, ListTodo, Trophy, User, LogOut,
  Menu, X, Bell, QrCode, Wifi, WifiOff
} from 'lucide-react'
import { useAuth } from 'react-oidc-context'
import { USER_ROLES } from '../../config'

const navItems = [
  { to: '/', icon: Home, label: '–ì–ª–∞–≤–Ω–∞—è' },
  { to: '/warehouse', icon: Package, label: '–°–∫–ª–∞–¥' },
  { to: '/production', icon: Cpu, label: '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ' },
  { to: '/tasks', icon: ListTodo, label: '–ó–∞–¥–∞—á–∏' },
  { to: '/rankings', icon: Trophy, label: '–†–µ–π—Ç–∏–Ω–≥–∏' },
]

export const Layout = () => {
  const [sidebarOpen, setSidebarOpen] = useState(false)
  const [isOnline, setIsOnline] = useState(navigator.onLine)
  const auth = useAuth()
  const navigate = useNavigate()
  const location = useLocation()


  const user = auth.user?.profile ? {
    name: auth.user.profile.given_name || '',
    surname: auth.user.profile.family_name || '',
    role: (auth.user.profile as any).realm_access?.roles?.[0] || 'USER',
    img: (auth.user.profile as any).picture,
  } : null

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  const handleLogout = () => {
    if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
      auth.signoutRedirect()
    }
  }

  const getPageTitle = () => {
    const path = location.pathname
    if (path === '/') return '–ì–ª–∞–≤–Ω–∞—è'
    if (path.startsWith('/warehouse')) return '–°–∫–ª–∞–¥'
    if (path.startsWith('/production')) return '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ'
    if (path.startsWith('/tasks')) return '–ó–∞–¥–∞—á–∏'
    if (path.startsWith('/rankings')) return '–†–µ–π—Ç–∏–Ω–≥–∏'
    if (path.startsWith('/profile')) return '–ü—Ä–æ—Ñ–∏–ª—å'
    return 'MES'
  }

  return (
    <div className="min-h-screen bg-background flex">

      {sidebarOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-40 lg:hidden backdrop-blur-sm"
          onClick={() => setSidebarOpen(false)}
        />
      )}


      <aside className={`
        fixed lg:static inset-y-0 left-0 z-50
        w-64 bg-surface border-r border-slate-700/50
        transform transition-transform duration-300 ease-out
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
        flex flex-col
      `}>

        <div className="h-16 flex items-center justify-between px-4 border-b border-slate-700/50 shrink-0">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center shadow-lg shadow-primary/25">
              <Cpu size={20} className="text-white" />
            </div>
            <div>
              <span className="font-bold text-lg">MES</span>
              <span className="text-primary ml-1 font-light">Kryptonit</span>
            </div>
          </div>
          <button
            className="lg:hidden p-2 hover:bg-surface-light rounded-lg transition-colors"
            onClick={() => setSidebarOpen(false)}
          >
            <X size={20} />
          </button>
        </div>


        <div className="p-4 shrink-0">
          <button
            onClick={() => { navigate('/production/scan'); setSidebarOpen(false) }}
            className="w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gradient-to-r from-primary to-primary-dark text-white
              rounded-xl font-medium shadow-lg shadow-primary/25
              hover:shadow-primary/40 transition-all active:scale-[0.98]"
          >
            <QrCode size={20} />
            –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </div>


        <nav className="flex-1 px-3 space-y-1 overflow-y-auto">
          {navItems.map((item) => (
            <NavLink
              key={item.to}
              to={item.to}
              end={item.to === '/'}
              onClick={() => setSidebarOpen(false)}
              className={({ isActive }) => `
                flex items-center gap-3 px-4 py-3 rounded-xl
                transition-all duration-150
                ${isActive
                  ? 'bg-primary text-white shadow-lg shadow-primary/25'
                  : 'text-slate-400 hover:bg-surface-light hover:text-white'
                }
              `}
            >
              <item.icon size={20} />
              <span className="font-medium">{item.label}</span>
            </NavLink>
          ))}
        </nav>


        <div className="p-4 border-t border-slate-700/50 shrink-0">
          <NavLink
            to="/profile"
            onClick={() => setSidebarOpen(false)}
            className={({ isActive }) => `
              flex items-center gap-3 px-3 py-3 rounded-xl mb-2
              transition-all duration-150
              ${isActive
                ? 'bg-primary/20 text-primary'
                : 'text-slate-400 hover:bg-surface-light hover:text-white'
              }
            `}
          >
            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center border border-primary/20">
              {user?.img ? (
                <img src={user.img} alt="" className="w-full h-full rounded-full object-cover" />
              ) : (
                <User size={18} className="text-primary" />
              )}
            </div>
            <div className="flex-1 min-w-0">
              <p className="font-medium truncate text-white">
                {user?.surname} {user?.name}
              </p>
              <p className="text-xs text-slate-500 truncate">
                {USER_ROLES[user?.role || ''] || user?.role}
              </p>
            </div>
          </NavLink>

          <button
            onClick={handleLogout}
            className="w-full flex items-center gap-3 px-4 py-3 rounded-xl
              text-slate-400 hover:bg-danger/10 hover:text-danger
              transition-all duration-150"
          >
            <LogOut size={20} />
            <span className="font-medium">–í—ã–π—Ç–∏</span>
          </button>
        </div>
      </aside>


      <div className="flex-1 flex flex-col min-w-0">

        <header className="h-16 bg-surface/80 backdrop-blur-xl border-b border-slate-700/50 flex items-center px-4 lg:px-6 sticky top-0 z-30 shrink-0">
          <button
            className="lg:hidden p-2 hover:bg-surface-light rounded-lg mr-3 transition-colors"
            onClick={() => setSidebarOpen(true)}
          >
            <Menu size={22} />
          </button>

          <h1 className="text-lg font-semibold lg:hidden">{getPageTitle()}</h1>

          <div className="flex-1" />


          <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg mr-3 ${isOnline ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}`}>
            {isOnline ? <Wifi size={16} /> : <WifiOff size={16} />}
            <span className="text-xs font-medium hidden sm:inline">
              {isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}
            </span>
          </div>


          <button className="p-2 hover:bg-surface-light rounded-lg relative transition-colors">
            <Bell size={20} className="text-slate-400" />
          </button>
        </header>


        <main className="flex-1 overflow-auto p-4 lg:p-6">
          <Outlet />
        </main>
      </div>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/components/ui/index.tsx
================================================================================



import { ButtonHTMLAttributes, InputHTMLAttributes, ReactNode, forwardRef } from 'react'


interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger' | 'success' | 'outline' | 'ghost'
  size?: 'sm' | 'md' | 'lg'
  loading?: boolean
  icon?: ReactNode
  fullWidth?: boolean
}

export const Button = ({
  children,
  variant = 'primary',
  size = 'md',
  loading = false,
  icon,
  fullWidth = false,
  className = '',
  disabled,
  ...props
}: ButtonProps) => {
  const base = 'inline-flex items-center justify-center font-medium rounded-xl transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed active:scale-[0.98]'

  const variants = {
    primary: 'bg-primary hover:bg-primary-dark text-white shadow-lg shadow-primary/25',
    secondary: 'bg-slate-600 hover:bg-slate-500 text-white',
    danger: 'bg-danger hover:bg-red-600 text-white',
    success: 'bg-success hover:bg-emerald-600 text-white',
    outline: 'border-2 border-primary text-primary hover:bg-primary/10',
    ghost: 'text-slate-400 hover:bg-surface-light hover:text-white',
  }

  const sizes = {
    sm: 'px-3 py-1.5 text-sm gap-1.5',
    md: 'px-4 py-2.5 text-sm gap-2',
    lg: 'px-6 py-3 text-base gap-2',
  }

  return (
    <button
      className={`${base} ${variants[variant]} ${sizes[size]} ${fullWidth ? 'w-full' : ''} ${className}`}
      disabled={disabled || loading}
      {...props}
    >
      {loading ? (
        <div className="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin" />
      ) : icon ? (
        <span className="shrink-0">{icon}</span>
      ) : null}
      {children}
    </button>
  )
}


interface CardProps {
  children: ReactNode
  className?: string
  onClick?: () => void
  hover?: boolean
  padding?: 'none' | 'sm' | 'md' | 'lg'
}

export const Card = ({
  children,
  className = '',
  onClick,
  hover = false,
  padding = 'none'
}: CardProps) => {
  const base = 'bg-surface border border-slate-700/50 rounded-2xl'
  const hoverStyles = hover || onClick ? 'cursor-pointer hover:border-slate-600 hover:bg-surface-light/30 transition-all' : ''
  const paddings = {
    none: '',
    sm: 'p-3',
    md: 'p-4',
    lg: 'p-6',
  }

  return (
    <div
      className={`${base} ${hoverStyles} ${paddings[padding]} ${className}`}
      onClick={onClick}
    >
      {children}
    </div>
  )
}


interface BadgeProps {
  children: ReactNode
  variant?: 'primary' | 'success' | 'warning' | 'danger' | 'neutral'
  size?: 'sm' | 'md'
  dot?: boolean
}

export const Badge = ({ children, variant = 'primary', size = 'md', dot = false }: BadgeProps) => {
  const variants = {
    primary: 'bg-primary/20 text-primary',
    success: 'bg-success/20 text-success',
    warning: 'bg-warning/20 text-warning',
    danger: 'bg-danger/20 text-danger',
    neutral: 'bg-slate-600/50 text-slate-400',
  }

  const sizes = {
    sm: 'px-2 py-0.5 text-xs',
    md: 'px-2.5 py-1 text-xs',
  }

  const dotColors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    danger: 'bg-danger',
    neutral: 'bg-slate-500',
  }

  return (
    <span className={`inline-flex items-center gap-1.5 font-medium rounded-lg ${variants[variant]} ${sizes[size]}`}>
      {dot && <span className={`w-1.5 h-1.5 rounded-full ${dotColors[variant]}`} />}
      {children}
    </span>
  )
}


interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string
  error?: string
  icon?: ReactNode
  rightIcon?: ReactNode
}

export const Input = forwardRef<HTMLInputElement, InputProps>(
  ({ label, error, icon, rightIcon, className = '', ...props }, ref) => {
    return (
      <div className="space-y-1.5">
        {label && (
          <label className="block text-sm font-medium text-slate-300">
            {label}
          </label>
        )}
        <div className="relative">
          {icon && (
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">
              {icon}
            </div>
          )}
          <input
            ref={ref}
            className={`
              w-full bg-surface-light border border-slate-600 rounded-xl
              px-4 py-2.5 text-white placeholder-slate-500
              focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none
              transition-all duration-150
              ${icon ? 'pl-10' : ''}
              ${rightIcon ? 'pr-10' : ''}
              ${error ? 'border-danger focus:border-danger focus:ring-danger/20' : ''}
              ${className}
            `}
            {...props}
          />
          {rightIcon && (
            <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500">
              {rightIcon}
            </div>
          )}
        </div>
        {error && <p className="text-sm text-danger">{error}</p>}
      </div>
    )
  }
)

Input.displayName = 'Input'


export const Skeleton = ({ className = '' }: { className?: string }) => (
  <div className={`bg-surface-light rounded-lg animate-pulse ${className}`} />
)


interface LoaderProps {
  size?: 'sm' | 'md' | 'lg'
  text?: string
  fullScreen?: boolean
}

export const Loader = ({ size = 'md', text, fullScreen = false }: LoaderProps) => {
  const sizes = {
    sm: 'w-4 h-4 border-2',
    md: 'w-8 h-8 border-2',
    lg: 'w-12 h-12 border-3',
  }

  const content = (
    <div className="flex flex-col items-center justify-center gap-3">
      <div className={`${sizes[size]} border-primary border-t-transparent rounded-full animate-spin`} />
      {text && <p className="text-slate-400 text-sm">{text}</p>}
    </div>
  )

  if (fullScreen) {
    return (
      <div className="fixed inset-0 bg-background flex items-center justify-center z-50">
        {content}
      </div>
    )
  }

  return content
}


interface EmptyStateProps {
  icon?: ReactNode
  title: string
  description?: string
  action?: ReactNode
}

export const EmptyState = ({ icon, title, description, action }: EmptyStateProps) => (
  <div className="flex flex-col items-center justify-center py-12 text-center">
    {icon && <div className="text-slate-600 mb-4">{icon}</div>}
    <h3 className="text-lg font-medium text-slate-300 mb-2">{title}</h3>
    {description && <p className="text-slate-500 mb-4 max-w-sm">{description}</p>}
    {action}
  </div>
)


interface StatsCardProps {
  title: string
  value: string | number
  icon?: ReactNode
  trend?: { value: number; label?: string }
  variant?: 'default' | 'primary' | 'success' | 'warning' | 'danger'
}

export const StatsCard = ({ title, value, icon, trend, variant = 'default' }: StatsCardProps) => {
  const iconBg = {
    default: 'bg-slate-600/50',
    primary: 'bg-primary/20',
    success: 'bg-success/20',
    warning: 'bg-warning/20',
    danger: 'bg-danger/20',
  }

  const iconColor = {
    default: 'text-slate-400',
    primary: 'text-primary',
    success: 'text-success',
    warning: 'text-warning',
    danger: 'text-danger',
  }

  return (
    <Card className="p-5">
      <div className="flex items-start justify-between">
        <div className="flex-1 min-w-0">
          <p className="text-sm text-slate-400 mb-1 truncate">{title}</p>
          <p className="text-2xl font-bold truncate">{value}</p>
          {trend && (
            <p className={`text-sm mt-1 ${trend.value >= 0 ? 'text-success' : 'text-danger'}`}>
              {trend.value >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(trend.value)}%
              {trend.label && <span className="text-slate-500 ml-1">{trend.label}</span>}
            </p>
          )}
        </div>
        {icon && (
          <div className={`p-3 rounded-xl ${iconBg[variant]} shrink-0 ml-3`}>
            <div className={iconColor[variant]}>{icon}</div>
          </div>
        )}
      </div>
    </Card>
  )
}


interface ModalProps {
  isOpen: boolean
  onClose: () => void
  title?: string
  children: ReactNode
  size?: 'sm' | 'md' | 'lg'
}

export const Modal = ({ isOpen, onClose, title, children, size = 'md' }: ModalProps) => {
  if (!isOpen) return null

  const sizes = {
    sm: 'max-w-sm',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
      <div className={`relative bg-surface rounded-2xl w-full ${sizes[size]} shadow-2xl animate-slideUp`}>
        {title && (
          <div className="px-6 py-4 border-b border-slate-700">
            <h2 className="text-lg font-semibold">{title}</h2>
          </div>
        )}
        <div className="p-6">{children}</div>
      </div>
    </div>
  )
}


interface Tab {
  key: string
  label: string
  icon?: ReactNode
}

interface TabsProps {
  tabs: Tab[]
  activeTab: string
  onChange: (key: string) => void
}

export const Tabs = ({ tabs, activeTab, onChange }: TabsProps) => {
  return (
    <div className="flex gap-1 p-1 bg-surface-light rounded-xl overflow-x-auto">
      {tabs.map((tab) => (
        <button
          key={tab.key}
          onClick={() => onChange(tab.key)}
          className={`
            flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg
            text-sm font-medium transition-all duration-150 whitespace-nowrap
            ${activeTab === tab.key
              ? 'bg-primary text-white shadow-lg'
              : 'text-slate-400 hover:text-white hover:bg-surface'
            }
          `}
        >
          {tab.icon}
          {tab.label}
        </button>
      ))}
    </div>
  )
}


interface ProgressProps {
  value: number
  max?: number
  size?: 'sm' | 'md'
  variant?: 'primary' | 'success' | 'warning' | 'danger'
  showLabel?: boolean
}

export const Progress = ({
  value,
  max = 100,
  size = 'md',
  variant = 'primary',
  showLabel = false
}: ProgressProps) => {
  const percent = Math.min(100, Math.max(0, (value / max) * 100))

  const heights = { sm: 'h-1.5', md: 'h-2.5' }
  const colors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    danger: 'bg-danger',
  }

  return (
    <div className="space-y-1">
      <div className={`w-full bg-surface-light rounded-full overflow-hidden ${heights[size]}`}>
        <div
          className={`${heights[size]} ${colors[variant]} rounded-full transition-all duration-300`}
          style={{ width: `${percent}%` }}
        />
      </div>
      {showLabel && (
        <div className="flex justify-between text-xs text-slate-500">
          <span>{value} / {max}</span>
          <span>{Math.round(percent)}%</span>
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/config/index.ts
================================================================================



export { API_BASE_URL, KEYCLOAK_CONFIG } from '../api/client'


export const config = {

  REQUEST_TIMEOUT: 15000,


  CACHE_TTL: 5 * 60 * 1000,


  DEBUG: import.meta.env.DEV,
}


export const PRODUCT_STATUS = {
  IN_PRODUCTION: 'IN_PRODUCTION',
  QUALITY_CONTROL: 'QUALITY_CONTROL',
  READY: 'READY',
  SHIPPED: 'SHIPPED',
  DEFECT: 'DEFECT',
  ARCHIVED: 'ARCHIVED',
} as const

export const TASK_STATUS = {
  PENDING: 'PENDING',
  IN_PROGRESS: 'IN_PROGRESS',
  COMPLETED: 'COMPLETED',
  CANCELLED: 'CANCELLED',
  ON_HOLD: 'ON_HOLD',
} as const

export const BOX_STATUS = {
  ACTIVE: 'ACTIVE',
  RESERVED: 'RESERVED',
  EMPTY: 'EMPTY',
  WRITTEN_OFF: 'WRITTEN_OFF',
} as const

export const STATUS_COLORS: Record<string, 'primary' | 'success' | 'warning' | 'danger' | 'neutral'> = {

  IN_PRODUCTION: 'warning',
  QUALITY_CONTROL: 'primary',
  READY: 'success',
  SHIPPED: 'primary',
  DEFECT: 'danger',
  ARCHIVED: 'neutral',

  PENDING: 'warning',
  IN_PROGRESS: 'primary',
  COMPLETED: 'success',
  CANCELLED: 'danger',
  ON_HOLD: 'neutral',

  ACTIVE: 'success',
  RESERVED: 'warning',
  EMPTY: 'neutral',
  WRITTEN_OFF: 'danger',
}

export const STATUS_LABELS: Record<string, string> = {

  IN_PRODUCTION: '–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ',
  QUALITY_CONTROL: '–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞',
  READY: '–ì–æ—Ç–æ–≤',
  SHIPPED: '–û—Ç–≥—Ä—É–∂–µ–Ω',
  DEFECT: '–ë—Ä–∞–∫',
  ARCHIVED: '–í –∞—Ä—Ö–∏–≤–µ',

  PENDING: '–û–∂–∏–¥–∞–µ—Ç',
  IN_PROGRESS: '–í —Ä–∞–±–æ—Ç–µ',
  COMPLETED: '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
  CANCELLED: '–û—Ç–º–µ–Ω–µ–Ω–∞',
  ON_HOLD: '–ù–∞ –ø–∞—É–∑–µ',

  ACTIVE: '–ê–∫—Ç–∏–≤–Ω–∞',
  RESERVED: '–†–µ–∑–µ—Ä–≤',
  EMPTY: '–ü—É—Å—Ç–æ',
  WRITTEN_OFF: '–°–ø–∏—Å–∞–Ω–∞',
}

export const USER_ROLES: Record<string, string> = {
  SUPER_ADMIN: '–°—É–ø–µ—Ä–∞–¥–º–∏–Ω',
  PRODUCTION_CHIEF: '–ù–∞—á–∞–ª—å–Ω–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞',
  WAREHOUSE_MASTER: '–ö–ª–∞–¥–æ–≤—â–∏–∫',
  TECHNOLOGIST: '–¢–µ—Ö–Ω–æ–ª–æ–≥',
  ASSEMBLER: '–°–±–æ—Ä—â–∏–∫',
  QC_INSPECTOR: '–ö–æ–Ω—Ç—Ä–æ–ª—ë—Ä –û–¢–ö',
  REPAIR_TECHNICIAN: '–†–µ–º–æ–Ω—Ç–Ω–∏–∫',
}

export default config

================================================================================
FILE: QMS-Mobile/mes-pwa/src/hooks/index.ts
================================================================================



import { useState, useEffect, useCallback, useRef } from 'react'


export function useDebounce<T>(value: T, delay: number = 300): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value)

  useEffect(() => {
    const timer = setTimeout(() => setDebouncedValue(value), delay)
    return () => clearTimeout(timer)
  }, [value, delay])

  return debouncedValue
}


export function useOnlineStatus(): boolean {
  const [isOnline, setIsOnline] = useState(navigator.onLine)

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return isOnline
}


export function useLocalStorage<T>(
  key: string,
  initialValue: T
): [T, (value: T | ((prev: T) => T)) => void] {
  const [storedValue, setStoredValue] = useState<T>(() => {
    try {
      const item = localStorage.getItem(key)
      return item ? JSON.parse(item) : initialValue
    } catch {
      return initialValue
    }
  })

  const setValue = useCallback(
    (value: T | ((prev: T) => T)) => {
      try {
        const valueToStore = value instanceof Function ? value(storedValue) : value
        setStoredValue(valueToStore)
        localStorage.setItem(key, JSON.stringify(valueToStore))
      } catch (error) {
        console.error('useLocalStorage error:', error)
      }
    },
    [key, storedValue]
  )

  return [storedValue, setValue]
}


export function usePrevious<T>(value: T): T | undefined {
  const ref = useRef<T>()
  useEffect(() => {
    ref.current = value
  }, [value])
  return ref.current
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/index.css
================================================================================

@tailwind base;
@tailwind components;
@tailwind utilities;





* {
  -webkit-tap-highlight-color: transparent;
}

html {
  scroll-behavior: smooth;
}

body {
  @apply bg-background text-slate-100 antialiased;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  overscroll-behavior: none;
}





::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  @apply bg-transparent;
}

::-webkit-scrollbar-thumb {
  @apply bg-slate-700 rounded-full;
}

::-webkit-scrollbar-thumb:hover {
  @apply bg-slate-600;
}





@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

.animate-slideUp {
  animation: slideUp 0.3s ease-out;
}

.animate-slideDown {
  animation: slideDown 0.3s ease-out;
}

.animate-scaleIn {
  animation: scaleIn 0.2s ease-out;
}

.animate-shimmer {
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.05) 50%,
    transparent 100%
  );
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}





input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -moz-appearance: textfield;
}

input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus {
  -webkit-text-fill-color: white;
  -webkit-box-shadow: 0 0 0px 1000px #1e293b inset;
  transition: background-color 5000s ease-in-out 0s;
}






.splash-screen {
  @apply fixed inset-0 bg-background flex items-center justify-center z-50;
  transition: opacity 0.3s ease-out;
}

.splash-screen.hidden {
  opacity: 0;
  pointer-events: none;
}


@supports (padding: max(0px)) {
  .safe-area-inset-top {
    padding-top: max(env(safe-area-inset-top), 0px);
  }
  
  .safe-area-inset-bottom {
    padding-bottom: max(env(safe-area-inset-bottom), 0px);
  }
}





.no-select {
  -webkit-user-select: none;
  user-select: none;
}

.truncate-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.truncate-3 {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}


.glass {
  @apply bg-surface/80 backdrop-blur-xl;
}


.gradient-text {
  @apply bg-gradient-to-r from-primary to-primary-light bg-clip-text text-transparent;
}


.hide-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.hide-scrollbar::-webkit-scrollbar {
  display: none;
}





:focus-visible {
  @apply outline-none ring-2 ring-primary ring-offset-2 ring-offset-background;
}

button:focus-visible,
a:focus-visible {
  @apply outline-none ring-2 ring-primary ring-offset-2 ring-offset-background rounded-lg;
}





@media print {
  body {
    @apply bg-white text-black;
  }
  
  .no-print {
    display: none !important;
  }
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/main.tsx
================================================================================

import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import { AuthProvider, AuthProviderProps } from 'react-oidc-context'
import App from './App'
import './index.css'
import { KEYCLOAK_CONFIG, getNetworkInfo } from './api/client'

const createOidcConfig = (): AuthProviderProps => {
  const networkInfo = getNetworkInfo()

  console.log('[MES] OIDC Authority:', KEYCLOAK_CONFIG.authority)
  console.log('[MES] OIDC Client:', KEYCLOAK_CONFIG.clientId)
  console.log('[MES] Network:', networkInfo.network)

  return {
    authority: KEYCLOAK_CONFIG.authority,
    client_id: KEYCLOAK_CONFIG.clientId,
    redirect_uri: `${window.location.origin}/`,
    post_logout_redirect_uri: `${window.location.origin}/`,
    response_type: 'code',
    scope: 'openid profile email',
    automaticSilentRenew: true,
    onSigninCallback: () => {
      window.history.replaceState({}, document.title, window.location.pathname)
    },
  }
}

const oidcConfig = createOidcConfig()

const registerServiceWorker = () => {
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' })
        console.log('[PWA] SW registered:', registration.scope)

        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[PWA] New version available')
              }
            })
          }
        })
      } catch (error) {
        console.error('[PWA] SW registration failed:', error)
      }
    })
  }
}

if (import.meta.env.PROD) {
  registerServiceWorker()
}

const networkInfo = getNetworkInfo()
console.log('[MES] PWA Mode:', import.meta.env.MODE)
console.log('[MES] Network:', networkInfo.network)
console.log('[MES] API:', networkInfo.apiUrl)

const root = document.getElementById('root')

if (!root) {
  throw new Error('Root element not found')
}

ReactDOM.createRoot(root).render(
  <React.StrictMode>
    <AuthProvider {...oidcConfig}>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </AuthProvider>
  </React.StrictMode>
)

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Auth/LoginPage.tsx
================================================================================



import { useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuth } from 'react-oidc-context'
import { Cpu, Key, AlertCircle } from 'lucide-react'
import { Button, Card } from '../../components/ui'

export const LoginPage = () => {
  const navigate = useNavigate()
  const auth = useAuth()


  useEffect(() => {
    if (auth.isAuthenticated) {
      navigate('/', { replace: true })
    }
  }, [auth.isAuthenticated, navigate])

  const handleLogin = () => {
    auth.signinRedirect()
  }

  return (
    <div className="min-h-screen bg-background flex items-center justify-center p-4">
      <div className="w-full max-w-sm">

        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-primary to-primary-dark rounded-2xl mb-4 shadow-2xl shadow-primary/30">
            <Cpu size={40} className="text-white" />
          </div>
          <h1 className="text-3xl font-bold">
            MES <span className="text-primary">Kryptonit</span>
          </h1>
          <p className="text-slate-400 mt-2">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º</p>
        </div>


        <Card className="p-6">
          <div className="space-y-4">
            {auth.error && (
              <div className="flex items-center gap-2 p-3 bg-danger/10 border border-danger/20 rounded-xl text-danger text-sm">
                <AlertCircle size={16} className="shrink-0" />
                <span>{auth.error.message}</span>
              </div>
            )}

            <Button
              onClick={handleLogin}
              className="w-full"
              size="lg"
              icon={<Key size={20} />}
              loading={auth.isLoading}
            >
              –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ SSO
            </Button>
          </div>
        </Card>


        <div className="mt-6 text-center">
          <p className="text-slate-600 text-sm">
            MES Kryptonit PWA v2.0
          </p>
          <p className="text-slate-700 text-xs mt-1">
            –î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∏
          </p>
        </div>
      </div>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Home/HomePage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { Link } from 'react-router-dom'
import {
  Package, Cpu, CheckCircle2, AlertTriangle, ArrowRight,
  ListTodo, Trophy, Clock, QrCode, TrendingUp
} from 'lucide-react'
import { Card, StatsCard, Badge, Skeleton, Button } from '../../components/ui'
import { useAuth } from 'react-oidc-context'
import { api } from '../../api/client'
import { STATUS_LABELS, STATUS_COLORS } from '../../config'
import type { Task, UserStats } from '../../types'

interface DashboardData {
  warehouse: { totalBoxes: number; alertsCount: number }
  production: { today: number; inProgress: number }
  userStats: UserStats | null
  recentTasks: Task[]
}

export const HomePage = () => {
  const auth = useAuth()
  const user = auth.user?.profile ? {
    name: auth.user.profile.given_name || '',
    surname: auth.user.profile.family_name || '',
  } : null
  const [data, setData] = useState<DashboardData | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadDashboard()
  }, [])

  const loadDashboard = async () => {
    try {
      const [tasksRes] = await Promise.allSettled([
        api.get('/tasks', { params: { limit: 5 } }),
      ])

      setData({
        warehouse: {
          totalBoxes: 0,
          alertsCount: 0,
        },
        production: { today: 0, inProgress: 0 },
        userStats: null,
        recentTasks: tasksRes.status === 'fulfilled' ? (tasksRes.value.data?.rows || tasksRes.value.data || []) : [],
      })
    } catch (error) {
      console.error('Dashboard load error:', error)
    } finally {
      setLoading(false)
    }
  }

  const getGreeting = () => {
    const hour = new Date().getHours()
    if (hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ'
    if (hour < 18) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å'
    return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä'
  }

  return (
    <div className="space-y-6 animate-fadeIn">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">{getGreeting()}, {user?.name}!</h1>
          <p className="text-slate-400 mt-1">–í–æ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–≥–æ–¥–Ω—è</p>
        </div>
        <Link to="/production/scan">
          <Button icon={<QrCode size={18} />}>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</Button>
        </Link>
      </div>


      <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
        {loading ? (
          <>
            <Skeleton className="h-28" />
            <Skeleton className="h-28" />
            <Skeleton className="h-28" />
            <Skeleton className="h-28" />
          </>
        ) : (
          <>
            <StatsCard title="–ù–∞ —Å–∫–ª–∞–¥–µ" value={data?.warehouse.totalBoxes || 0} icon={<Package size={24} />} variant="primary" />
            <StatsCard title="–í —Ä–∞–±–æ—Ç–µ" value={data?.production.inProgress || 0} icon={<Cpu size={24} />} variant="warning" />
            <StatsCard title="–ú–æ–π —Ä–µ–π—Ç–∏–Ω–≥" value={data?.userStats?.rank ? `#${data.userStats.rank}` : '‚Äî'} icon={<Trophy size={24} />} variant="success" />
            <StatsCard title="–ö—Ä–∏—Ç–∏—á–Ω–æ" value={data?.warehouse.alertsCount || 0} icon={<AlertTriangle size={24} />} variant={data?.warehouse.alertsCount ? 'danger' : 'default'} />
          </>
        )}
      </div>


      {data?.userStats && (
        <Card className="p-5">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <TrendingUp size={20} className="text-primary" />
            –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          </h2>
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold text-primary">{data.userStats.todayOperations}</p>
              <p className="text-xs text-slate-400 mt-1">–°–µ–≥–æ–¥–Ω—è</p>
            </div>
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold">{data.userStats.weekOperations}</p>
              <p className="text-xs text-slate-400 mt-1">–ó–∞ –Ω–µ–¥–µ–ª—é</p>
            </div>
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold">{data.userStats.monthOperations}</p>
              <p className="text-xs text-slate-400 mt-1">–ó–∞ –º–µ—Å—è—Ü</p>
            </div>
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold">{data.userStats.totalOperations}</p>
              <p className="text-xs text-slate-400 mt-1">–í—Å–µ–≥–æ</p>
            </div>
          </div>
        </Card>
      )}


      <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 lg:gap-4">
        <Link to="/warehouse">
          <Card hover className="p-5 group h-full">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-primary/20"><Package size={24} className="text-primary" /></div>
                <div><h3 className="font-semibold">–°–∫–ª–∞–¥</h3><p className="text-sm text-slate-400">–ó–∞–ø–∞—Å—ã</p></div>
              </div>
              <ArrowRight size={20} className="text-slate-600 group-hover:text-primary group-hover:translate-x-1 transition-all" />
            </div>
          </Card>
        </Link>

        <Link to="/production">
          <Card hover className="p-5 group h-full">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-success/20"><Cpu size={24} className="text-success" /></div>
                <div><h3 className="font-semibold">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h3><p className="text-sm text-slate-400">–°–±–æ—Ä–∫–∞</p></div>
              </div>
              <ArrowRight size={20} className="text-slate-600 group-hover:text-success group-hover:translate-x-1 transition-all" />
            </div>
          </Card>
        </Link>

        <Link to="/rankings">
          <Card hover className="p-5 group h-full">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-warning/20"><Trophy size={24} className="text-warning" /></div>
                <div><h3 className="font-semibold">–†–µ–π—Ç–∏–Ω–≥–∏</h3><p className="text-sm text-slate-400">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p></div>
              </div>
              <ArrowRight size={20} className="text-slate-600 group-hover:text-warning group-hover:translate-x-1 transition-all" />
            </div>
          </Card>
        </Link>
      </div>


      <Card className="p-5">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold flex items-center gap-2">
            <ListTodo size={20} className="text-primary" />
            –ú–æ–∏ –∑–∞–¥–∞—á–∏
          </h2>
          <Link to="/tasks" className="text-sm text-primary hover:underline">–í—Å–µ –∑–∞–¥–∞—á–∏</Link>
        </div>

        {loading ? (
          <div className="space-y-3"><Skeleton className="h-14" /><Skeleton className="h-14" /><Skeleton className="h-14" /></div>
        ) : data?.recentTasks && data.recentTasks.length > 0 ? (
          <div className="space-y-2">
            {data.recentTasks.map((task) => (
              <Link key={task.id} to="/tasks" className="flex items-center justify-between p-3 rounded-xl hover:bg-surface-light transition-colors">
                <div className="flex items-center gap-3 min-w-0">
                  <div className={`w-2 h-2 rounded-full shrink-0 ${task.status === 'IN_PROGRESS' ? 'bg-primary' : 'bg-warning'}`} />
                  <span className="font-medium truncate">{task.title}</span>
                </div>
                <Badge variant={STATUS_COLORS[task.status] || 'neutral'}>{STATUS_LABELS[task.status] || task.status}</Badge>
              </Link>
            ))}
          </div>
        ) : (
          <div className="text-center py-8 text-slate-500">
            <CheckCircle2 size={32} className="mx-auto mb-2 opacity-50" />
            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</p>
          </div>
        )}
      </Card>


      <Card className="p-4">
        <div className="flex items-center justify-center gap-3 text-slate-400">
          <Clock size={18} />
          <span>{new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
        </div>
      </Card>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Production/ChecklistPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import {
  ArrowLeft,
  Check,
  Circle,
  CheckCircle2,
  AlertCircle,
  Camera,
  QrCode
} from 'lucide-react'
import { Card, Button, Input, Badge, Loader, Progress } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import type { Product, ProductionStep, ChecklistItem } from '../../types'

interface ChecklistItemState {
  item: ChecklistItem
  value: string
  completed: boolean
}

export const ChecklistPage = () => {
  const { productId, stepId } = useParams<{ productId: string; stepId: string }>()
  const navigate = useNavigate()

  const [product, setProduct] = useState<Product | null>(null)
  const [step, setStep] = useState<ProductionStep | null>(null)
  const [items, setItems] = useState<ChecklistItemState[]>([])
  const [loading, setLoading] = useState(true)
  const [submitting, setSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (productId && stepId) loadData()
  }, [productId, stepId])

  const loadData = async () => {
    try {
      setLoading(true)

      const [productRes, stepRes] = await Promise.all([
        api.get(`/products/${productId}`),
        api.get(`/production-steps/${stepId}`),
      ])

      setProduct(productRes.data)
      setStep(stepRes.data)

      const checklistItems = stepRes.data.checklistItems || []
      setItems(
        checklistItems
          .sort((a: ChecklistItem, b: ChecklistItem) => a.order - b.order)
          .map((item: ChecklistItem) => ({
            item,
            value: '',
            completed: false,
          }))
      )

      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const updateItem = (index: number, value: string, completed?: boolean) => {
    setItems(prev => prev.map((item, i) => {
      if (i !== index) return item

      const newCompleted = completed !== undefined
        ? completed
        : item.item.type === 'checkbox'
          ? !item.completed
          : !!value

      return { ...item, value, completed: newCompleted }
    }))
  }

  const completedCount = items.filter(i => i.completed).length
  const canSubmit = items.filter(i => i.item.required).every(i => i.completed)

  const handleSubmit = async () => {
    if (!canSubmit) return

    try {
      setSubmitting(true)

      await api.post(`/products/${productId}/complete-step`, {
        stepId: parseInt(stepId!),
        responses: items.map(i => ({
          itemId: i.item.id,
          value: i.item.type === 'checkbox' ? (i.completed ? 'true' : 'false') : i.value,
        })),
      })

      navigate(`/production/${productId}`, { replace: true })
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setSubmitting(false)
    }
  }

  const renderItemInput = (itemState: ChecklistItemState, index: number) => {
    const { item, value, completed } = itemState

    switch (item.type) {
      case 'checkbox':
        return (
          <button
            onClick={() => updateItem(index, '', !completed)}
            className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${
              completed
                ? 'bg-success border-success'
                : 'border-slate-600 hover:border-primary'
            }`}
          >
            {completed && <Check size={14} className="text-white" />}
          </button>
        )

      case 'text':
        return (
          <Input
            value={value}
            onChange={(e) => updateItem(index, e.target.value)}
            placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ..."
            className="mt-2"
          />
        )

      case 'number':
        return (
          <Input
            type="number"
            value={value}
            onChange={(e) => updateItem(index, e.target.value)}
            placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ..."
            className="mt-2"
          />
        )

      case 'select':
        return (
          <div className="flex flex-wrap gap-2 mt-2">
            {item.options?.map((option) => (
              <button
                key={option}
                onClick={() => updateItem(index, option, true)}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                  value === option
                    ? 'bg-primary text-white'
                    : 'bg-surface-light text-slate-400 hover:text-white'
                }`}
              >
                {option}
              </button>
            ))}
          </div>
        )

      case 'photo':
        return (
          <button
            onClick={() => updateItem(index, 'photo_captured', true)}
            className="mt-2 w-full p-4 border-2 border-dashed border-slate-600 rounded-xl
              hover:border-primary transition-colors flex flex-col items-center gap-2"
          >
            <Camera size={24} className="text-slate-500" />
            <span className="text-sm text-slate-400">
              {completed ? '–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ‚úì' : '–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ'}
            </span>
          </button>
        )

      case 'serial':
        return (
          <div className="mt-2 flex gap-2">
            <Input
              value={value}
              onChange={(e) => updateItem(index, e.target.value.toUpperCase())}
              placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä..."
              className="flex-1 font-mono"
            />
            <Button variant="outline" icon={<QrCode size={18} />}>
              –°–∫–∞–Ω
            </Button>
          </div>
        )

      default:
        return null
    }
  }

  if (loading) {
    return (
      <div className="flex justify-center py-12">
        <Loader text="–ó–∞–≥—Ä—É–∑–∫–∞..." />
      </div>
    )
  }

  if (error || !product || !step) {
    return (
      <div className="text-center py-12">
        <p className="text-danger mb-4">{error || '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}</p>
        <Button variant="outline" onClick={() => navigate(-1)}>
          –ù–∞–∑–∞–¥
        </Button>
      </div>
    )
  }

  return (
    <div className="max-w-xl mx-auto space-y-4 animate-fadeIn pb-24">

      <div className="flex items-center gap-4">
        <Button
          variant="ghost"
          icon={<ArrowLeft size={20} />}
          onClick={() => navigate(-1)}
        />
        <div className="flex-1 min-w-0">
          <h1 className="text-lg font-bold truncate">{step.title}</h1>
          <p className="text-slate-400 text-sm font-mono truncate">{product.serialNumber}</p>
        </div>
      </div>


      <Card className="p-4">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm text-slate-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
          <span className="text-sm font-medium">{completedCount} / {items.length}</span>
        </div>
        <Progress
          value={completedCount}
          max={items.length}
          variant={completedCount === items.length ? 'success' : 'primary'}
        />
      </Card>


      <div className="space-y-3">
        {items.map((itemState, index) => (
          <Card
            key={itemState.item.id}
            className={`p-4 transition-all ${
              itemState.completed ? 'border-success/30 bg-success/5' : ''
            }`}
          >
            <div className="flex items-start gap-3">
              {itemState.item.type === 'checkbox' ? (
                renderItemInput(itemState, index)
              ) : (
                <div className={`w-6 h-6 rounded-full flex items-center justify-center shrink-0 ${
                  itemState.completed ? 'bg-success/20' : 'bg-surface-light'
                }`}>
                  {itemState.completed ? (
                    <CheckCircle2 size={16} className="text-success" />
                  ) : (
                    <Circle size={16} className="text-slate-500" />
                  )}
                </div>
              )}

              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                  <p className={`font-medium ${itemState.completed ? 'text-success' : ''}`}>
                    {itemState.item.title}
                  </p>
                  {itemState.item.required && (
                    <Badge variant="danger" size="sm">–û–±—è–∑.</Badge>
                  )}
                </div>

                {itemState.item.type !== 'checkbox' && renderItemInput(itemState, index)}
              </div>
            </div>
          </Card>
        ))}
      </div>


      <div className="fixed bottom-0 left-0 right-0 p-4 bg-background/80 backdrop-blur-xl border-t border-slate-700/50">
        <div className="max-w-xl mx-auto">
          {!canSubmit && (
            <p className="text-center text-sm text-warning mb-3 flex items-center justify-center gap-2">
              <AlertCircle size={16} />
              –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã
            </p>
          )}
          <Button
            onClick={handleSubmit}
            disabled={!canSubmit}
            loading={submitting}
            fullWidth
            size="lg"
            icon={<Check size={18} />}
          >
            –ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
          </Button>
        </div>
      </div>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Production/ProductScanPage.tsx
================================================================================



import { useState, useRef, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { QrCode, Keyboard, Search, ArrowRight, Package, ArrowLeft } from 'lucide-react'
import { Card, Input, Button, Badge, Loader, EmptyState } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { STATUS_LABELS, STATUS_COLORS } from '../../config'
import type { ScanResult } from '../../types'

export const ProductScanPage = () => {
  const navigate = useNavigate()
  const inputRef = useRef<HTMLInputElement>(null)

  const [serialNumber, setSerialNumber] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [result, setResult] = useState<ScanResult | null>(null)

  useEffect(() => {
    setTimeout(() => inputRef.current?.focus(), 100)
  }, [])

  const handleSearch = async () => {
    const code = serialNumber.trim()
    if (!code) return

    setLoading(true)
    setError(null)
    setResult(null)

    try {
      const { data } = await api.post('/products/scan', { code })
      setResult(data)
    } catch (err) {
      setError(getErrorMessage(err, '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'))
    } finally {
      setLoading(false)
    }
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleSearch()
    }
  }

  const handleStartOperation = () => {
    if (result?.product && result?.nextStep) {
      navigate(`/production/checklist/${result.product.id}/${result.nextStep.id}`)
    }
  }

  const handleViewProduct = () => {
    if (result?.product) {
      navigate(`/production/${result.product.id}`)
    }
  }

  const handleReset = () => {
    setSerialNumber('')
    setResult(null)
    setError(null)
    inputRef.current?.focus()
  }

  return (
    <div className="max-w-xl mx-auto space-y-6 animate-fadeIn">

      <div className="flex items-center gap-4">
        <Button
          variant="ghost"
          icon={<ArrowLeft size={20} />}
          onClick={() => navigate(-1)}
        />
        <div>
          <h1 className="text-xl font-bold">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
          <p className="text-slate-400 text-sm">–ù–∞–π—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç</p>
        </div>
      </div>


      <div className="text-center">
        <div className="inline-flex items-center justify-center w-20 h-20 bg-primary/20 rounded-2xl">
          <QrCode size={40} className="text-primary" />
        </div>
      </div>


      <Card className="p-5">
        <div className="flex gap-3">
          <div className="flex-1">
            <Input
              ref={inputRef}
              placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ QR..."
              icon={<Keyboard size={18} />}
              value={serialNumber}
              onChange={(e) => {
                setSerialNumber(e.target.value.toUpperCase())
                setError(null)
              }}
              onKeyDown={handleKeyDown}
              className="text-lg font-mono"
            />
          </div>
          <Button
            onClick={handleSearch}
            loading={loading}
            disabled={!serialNumber.trim()}
            size="lg"
            icon={<Search size={18} />}
          >
            <span className="hidden sm:inline">–ù–∞–π—Ç–∏</span>
          </Button>
        </div>

        <p className="text-sm text-slate-500 mt-3 text-center">
          –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫–∞–Ω–µ—Ä –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é
        </p>
      </Card>


      {loading && (
        <div className="flex justify-center py-8">
          <Loader text="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞..." />
        </div>
      )}


      {error && !loading && (
        <Card className="p-6 bg-danger/10 border-danger/20">
          <div className="text-center">
            <p className="text-danger font-medium mb-4">{error}</p>
            <Button variant="outline" onClick={handleReset}>
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </Button>
          </div>
        </Card>
      )}


      {result && !loading && (
        <Card className="p-5 animate-slideUp">
          <div className="flex items-start justify-between mb-4">
            <div>
              <h2 className="text-xl font-bold font-mono">{result.product.serialNumber}</h2>
              <p className="text-slate-400">{result.product.productType?.name || '–ü—Ä–æ–¥—É–∫—Ç'}</p>
            </div>
            <Badge variant={STATUS_COLORS[result.product.status] || 'neutral'}>
              {STATUS_LABELS[result.product.status] || result.product.status}
            </Badge>
          </div>

          {result.currentStep && (
            <div className="p-4 bg-surface-light rounded-xl mb-3">
              <p className="text-sm text-slate-400 mb-1">–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø</p>
              <p className="font-medium">{result.currentStep.title}</p>
            </div>
          )}

          {result.nextStep && (
            <div className="p-4 bg-primary/10 border border-primary/20 rounded-xl mb-3">
              <p className="text-sm text-primary mb-1">–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø</p>
              <p className="font-medium">{result.nextStep.title}</p>
            </div>
          )}

          {result.message && (
            <p className="text-sm text-slate-400 text-center mb-4">
              {result.message}
            </p>
          )}

          <div className="flex gap-3 mt-6">
            {result.canProceed && result.nextStep && (
              <Button
                onClick={handleStartOperation}
                className="flex-1"
                icon={<ArrowRight size={18} />}
              >
                –ù–∞—á–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
              </Button>
            )}
            <Button
              onClick={handleViewProduct}
              variant={result.canProceed ? 'outline' : 'primary'}
              className="flex-1"
            >
              –ü–æ–¥—Ä–æ–±–Ω–µ–µ
            </Button>
          </div>

          <button
            onClick={handleReset}
            className="w-full text-center text-sm text-primary hover:underline mt-4"
          >
            –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø—Ä–æ–¥—É–∫—Ç
          </button>
        </Card>
      )}


      {!loading && !error && !result && (
        <EmptyState
          icon={<Package size={48} />}
          title="–ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é"
          description="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä"
        />
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Production/ProductionPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useNavigate, Link } from 'react-router-dom'
import {
  Search,
  Cpu,
  QrCode,
  ChevronRight
} from 'lucide-react'
import { Card, Input, Button, Badge, EmptyState, Loader, Tabs } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { useDebounce } from '../../hooks'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { Product } from '../../types'

export const ProductionPage = () => {
  const navigate = useNavigate()

  const [products, setProducts] = useState<Product[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [search, setSearch] = useState('')
  const [activeTab, setActiveTab] = useState('all')

  const debouncedSearch = useDebounce(search, 300)

  useEffect(() => {
    loadProducts()
  }, [debouncedSearch, activeTab])

  const loadProducts = async () => {
    try {
      setLoading(true)

      const params: Record<string, any> = { limit: 50 }
      if (debouncedSearch) params.search = debouncedSearch
      if (activeTab !== 'all') params.status = activeTab

      const { data } = await api.get('/production/outputs', { params })
      setProducts(Array.isArray(data) ? data : data.rows || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const tabs = [
    { key: 'all', label: '–í—Å–µ' },
    { key: 'IN_PRODUCTION', label: '–í —Ä–∞–±–æ—Ç–µ' },
    { key: 'QUALITY_CONTROL', label: '–û–¢–ö' },
    { key: 'READY', label: '–ì–æ—Ç–æ–≤–æ' },
  ]

  return (
    <div className="space-y-4 animate-fadeIn">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h1>
          <p className="text-slate-400 text-sm">–°–±–æ—Ä–∫–∞ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞</p>
        </div>
        <Link to="/production/scan">
          <Button icon={<QrCode size={18} />}>
            –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
          </Button>
        </Link>
      </div>


      <Card className="p-3">
        <Input
          placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É..."
          icon={<Search size={18} />}
          value={search}
          onChange={(e) => setSearch(e.target.value.toUpperCase())}
        />
      </Card>


      <Tabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />


      {loading ? (
        <div className="flex justify-center py-12">
          <Loader text="–ó–∞–≥—Ä—É–∑–∫–∞..." />
        </div>
      ) : error ? (
        <Card className="p-6 text-center">
          <p className="text-danger mb-4">{error}</p>
          <Button variant="outline" onClick={loadProducts}>
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
          </Button>
        </Card>
      ) : products.length === 0 ? (
        <EmptyState
          icon={<Cpu size={48} />}
          title="–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          description={search ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å' : '–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º'}
          action={
            <Link to="/production/scan">
              <Button icon={<QrCode size={18} />}>
                –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π
              </Button>
            </Link>
          }
        />
      ) : (
        <div className="grid gap-3">
          {products.map((product) => (
            <Card
              key={product.id}
              hover
              className="p-4"
              onClick={() => navigate(`/production/${product.id}`)}
            >
              <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-4 min-w-0">
                  <div className="w-12 h-12 rounded-xl bg-surface-light flex items-center justify-center shrink-0">
                    <Cpu size={24} className="text-primary" />
                  </div>
                  <div className="min-w-0">
                    <p className="font-bold truncate">{product.serialNumber}</p>
                    <p className="text-sm text-slate-400 truncate">
                      {product.productType?.name || '–ë–µ–∑ —Ç–∏–ø–∞'}
                    </p>
                    {product.currentStep && (
                      <p className="text-xs text-slate-500 truncate mt-1">
                        –≠—Ç–∞–ø: {product.currentStep.title}
                      </p>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-3 shrink-0">
                  <Badge variant={STATUS_COLORS[product.status] || 'neutral'}>
                    {STATUS_LABELS[product.status] || product.status}
                  </Badge>
                  <ChevronRight size={20} className="text-slate-600" />
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Profile/ProfilePage.tsx
================================================================================



import { useState } from 'react'
import { useNavigate } from 'react-router-dom'
import {
  User,
  Mail,
  Shield,
  LogOut,
  Bell,
  Moon,
  Smartphone,
  Download,
  CheckCircle,
  Info,
  ChevronRight,
  RefreshCw
} from 'lucide-react'
import { Card, Button, Badge } from '../../components/ui'
import { useAuth } from 'react-oidc-context'
import { USER_ROLES } from '../../config'

export const ProfilePage = () => {
  const navigate = useNavigate()
  const auth = useAuth()


  const user = auth.user?.profile ? {
    name: auth.user.profile.given_name || '',
    surname: auth.user.profile.family_name || '',
    login: auth.user.profile.preferred_username || auth.user.profile.email || '',
    email: auth.user.profile.email || '',
    role: (auth.user.profile as any).realm_access?.roles?.[0] || 'USER',
    img: (auth.user.profile as any).picture,
  } : null

  const authMethod = 'keycloak'
  const logout = () => auth.signoutRedirect()

  const [installPrompt, setInstallPrompt] = useState<any>(null)
  const [isInstalled, setIsInstalled] = useState(false)


  useState(() => {

    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
      setIsInstalled(true)
    }


    const handleBeforeInstall = (e: any) => {
      e.preventDefault()
      setInstallPrompt(e)
    }

    window.addEventListener('beforeinstallprompt', handleBeforeInstall)

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstall)
    }
  })

  const handleInstall = async () => {
    if (!installPrompt) return

    installPrompt.prompt()
    const { outcome } = await installPrompt.userChoice

    if (outcome === 'accepted') {
      setIsInstalled(true)
      setInstallPrompt(null)
    }
  }

  const handleLogout = () => {
    if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
      logout()
      navigate('/login')
    }
  }

  const handleRefreshApp = () => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        registrations.forEach((registration) => {
          registration.update()
        })
      })
    }
    window.location.reload()
  }

  return (
    <div className="max-w-xl mx-auto space-y-4 animate-fadeIn">

      <div>
        <h1 className="text-2xl font-bold">–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <p className="text-slate-400 text-sm">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
      </div>


      <Card className="p-6">
        <div className="flex items-center gap-4">
          <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center border border-primary/20">
            {user?.img ? (
              <img src={user.img} alt="" className="w-full h-full rounded-2xl object-cover" />
            ) : (
              <User size={28} className="text-primary" />
            )}
          </div>
          <div className="flex-1 min-w-0">
            <h2 className="text-xl font-bold truncate">
              {user?.surname} {user?.name}
            </h2>
            <p className="text-slate-400 truncate">@{user?.login}</p>
            <Badge variant="primary" className="mt-2">
              {USER_ROLES[user?.role || ''] || user?.role}
            </Badge>
          </div>
        </div>


        <div className="mt-4 pt-4 border-t border-slate-700/50">
          <div className="flex items-center gap-2 text-sm text-slate-400">
            <Shield size={14} />
            <span>
              –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: {authMethod === 'keycloak' ? 'SSO (Keycloak)' : '–õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å'}
            </span>
          </div>
        </div>
      </Card>


      <Card className="divide-y divide-slate-700/50">
        <div className="p-4 flex items-center gap-4">
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <User size={18} className="text-slate-400" />
          </div>
          <div className="flex-1">
            <p className="text-sm text-slate-400">–õ–æ–≥–∏–Ω</p>
            <p className="font-medium">{user?.login}</p>
          </div>
        </div>

        {user?.team && (
          <div className="p-4 flex items-center gap-4">
            <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
              <Shield size={18} className="text-slate-400" />
            </div>
            <div className="flex-1">
              <p className="text-sm text-slate-400">–ö–æ–º–∞–Ω–¥–∞</p>
              <p className="font-medium">{user.team.title}</p>
            </div>
          </div>
        )}

        {user?.section && (
          <div className="p-4 flex items-center gap-4">
            <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
              <Info size={18} className="text-slate-400" />
            </div>
            <div className="flex-1">
              <p className="text-sm text-slate-400">–£—á–∞—Å—Ç–æ–∫</p>
              <p className="font-medium">{user.section.title}</p>
            </div>
          </div>
        )}
      </Card>


      {user?.abilities && user.abilities.length > 0 && (
        <Card className="p-4">
          <h3 className="font-semibold mb-3 flex items-center gap-2">
            <Shield size={18} className="text-primary" />
            –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
          </h3>
          <div className="flex flex-wrap gap-2">
            {user.abilities.map((ability) => (
              <Badge key={ability} variant="neutral">
                {ability}
              </Badge>
            ))}
          </div>
        </Card>
      )}


      {!isInstalled && (
        <Card className="p-4 bg-primary/10 border-primary/20">
          <div className="flex items-center gap-4">
            <div className="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center shrink-0">
              <Smartphone size={24} className="text-primary" />
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="font-semibold">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
              <p className="text-sm text-slate-400">
                –î–æ–±–∞–≤—å—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
              </p>
            </div>
            <Button
              onClick={handleInstall}
              disabled={!installPrompt}
              icon={<Download size={18} />}
            >
              <span className="hidden sm:inline">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</span>
            </Button>
          </div>
        </Card>
      )}

      {isInstalled && (
        <Card className="p-4 bg-success/10 border-success/20">
          <div className="flex items-center gap-3 text-success">
            <CheckCircle size={20} />
            <span className="font-medium">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>
          </div>
        </Card>
      )}


      <Card className="divide-y divide-slate-700/50">
        <button className="w-full p-4 flex items-center gap-4 hover:bg-surface-light/50 transition-colors">
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <Bell size={18} className="text-slate-400" />
          </div>
          <div className="flex-1 text-left">
            <p className="font-medium">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
            <p className="text-sm text-slate-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
          </div>
          <ChevronRight size={20} className="text-slate-600" />
        </button>

        <button className="w-full p-4 flex items-center gap-4 hover:bg-surface-light/50 transition-colors">
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <Moon size={18} className="text-slate-400" />
          </div>
          <div className="flex-1 text-left">
            <p className="font-medium">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</p>
            <p className="text-sm text-slate-500">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</p>
          </div>
          <ChevronRight size={20} className="text-slate-600" />
        </button>

        <button
          onClick={handleRefreshApp}
          className="w-full p-4 flex items-center gap-4 hover:bg-surface-light/50 transition-colors"
        >
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <RefreshCw size={18} className="text-slate-400" />
          </div>
          <div className="flex-1 text-left">
            <p className="font-medium">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
            <p className="text-sm text-slate-500">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</p>
          </div>
          <ChevronRight size={20} className="text-slate-600" />
        </button>
      </Card>


      <Card className="p-4">
        <div className="text-center text-sm text-slate-500">
          <p>MES Kryptonit PWA v2.0.0</p>
          <p className="mt-1">¬© 2024 –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
        </div>
      </Card>


      <Button
        variant="danger"
        fullWidth
        size="lg"
        icon={<LogOut size={18} />}
        onClick={handleLogout}
      >
        –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
      </Button>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Rankings/RankingsPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import {
  Trophy,
  Users,
  TrendingUp,
  TrendingDown,
  Medal,
  Crown,
  RefreshCw
} from 'lucide-react'
import { Card, Tabs, Badge, Loader, EmptyState } from '../../components/ui'
import { useAuth } from 'react-oidc-context'
import { api, getErrorMessage } from '../../api/client'
import type { UserRanking, TeamRanking, UserStats } from '../../types'

type Period = 'day' | 'week' | 'month' | 'all'

export const RankingsPage = () => {
  const auth = useAuth()
  const user = auth.user?.profile ? {
    id: auth.user.profile.sub,
  } : null

  const [tab, setTab] = useState<'users' | 'teams'>('users')
  const [period, setPeriod] = useState<Period>('week')
  const [userRankings, setUserRankings] = useState<UserRanking[]>([])
  const [teamRankings, setTeamRankings] = useState<TeamRanking[]>([])
  const [myStats, setMyStats] = useState<UserStats | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    loadRankings()
  }, [tab, period])

  const loadRankings = async () => {
    try {
      setLoading(true)


      setUserRankings([])
      setTeamRankings([])
      setMyStats(null)

      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const getRankIcon = (rank: number) => {
    if (rank === 1) return <Crown size={20} className="text-yellow-400" />
    if (rank === 2) return <Medal size={20} className="text-slate-300" />
    if (rank === 3) return <Medal size={20} className="text-amber-600" />
    return <span className="text-slate-500 font-mono text-sm">#{rank}</span>
  }

  const periodTabs = [
    { key: 'day', label: '–î–µ–Ω—å' },
    { key: 'week', label: '–ù–µ–¥–µ–ª—è' },
    { key: 'month', label: '–ú–µ—Å—è—Ü' },
    { key: 'all', label: '–í—Å—ë –≤—Ä–µ–º—è' },
  ]

  return (
    <div className="space-y-4 animate-fadeIn">

      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">–†–µ–π—Ç–∏–Ω–≥–∏</h1>
          <p className="text-slate-400 text-sm">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
        </div>
        <button
          onClick={loadRankings}
          className="p-2 hover:bg-surface-light rounded-lg transition-colors"
        >
          <RefreshCw size={20} className={`text-slate-400 ${loading ? 'animate-spin' : ''}`} />
        </button>
      </div>


      {myStats && tab === 'users' && (
        <Card className="p-5 bg-gradient-to-br from-primary/10 to-primary/5 border-primary/20">
          <div className="flex items-center gap-4 mb-4">
            <div className="w-14 h-14 rounded-2xl bg-primary/20 flex items-center justify-center">
              <Trophy size={28} className="text-primary" />
            </div>
            <div>
              <p className="text-sm text-slate-400">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥</p>
              <p className="text-3xl font-bold">#{myStats.rank}</p>
            </div>
            <div className="ml-auto text-right">
              <p className="text-sm text-slate-400">–∏–∑ {myStats.totalUsers}</p>
              <p className="text-sm text-slate-500">—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
            </div>
          </div>

          <div className="grid grid-cols-4 gap-3">
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold text-primary">{myStats.todayOperations}</p>
              <p className="text-xs text-slate-500">–°–µ–≥–æ–¥–Ω—è</p>
            </div>
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold">{myStats.weekOperations}</p>
              <p className="text-xs text-slate-500">–ù–µ–¥–µ–ª—è</p>
            </div>
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold">{myStats.monthOperations}</p>
              <p className="text-xs text-slate-500">–ú–µ—Å—è—Ü</p>
            </div>
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold">{myStats.totalOperations}</p>
              <p className="text-xs text-slate-500">–í—Å–µ–≥–æ</p>
            </div>
          </div>
        </Card>
      )}


      <Tabs
        tabs={[
          { key: 'users', label: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', icon: <Users size={16} /> },
          { key: 'teams', label: '–ö–æ–º–∞–Ω–¥—ã', icon: <Trophy size={16} /> },
        ]}
        activeTab={tab}
        onChange={(key) => setTab(key as 'users' | 'teams')}
      />


      <div className="flex gap-2 overflow-x-auto pb-1">
        {periodTabs.map((p) => (
          <button
            key={p.key}
            onClick={() => setPeriod(p.key as Period)}
            className={`px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${
              period === p.key
                ? 'bg-primary text-white'
                : 'bg-surface-light text-slate-400 hover:text-white'
            }`}
          >
            {p.label}
          </button>
        ))}
      </div>


      {loading ? (
        <div className="flex justify-center py-12">
          <Loader text="–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤..." />
        </div>
      ) : error ? (
        <Card className="p-6 text-center">
          <p className="text-danger mb-4">{error}</p>
        </Card>
      ) : tab === 'users' ? (
        userRankings.length > 0 ? (
          <div className="space-y-2">
            {userRankings.map((item) => {
              const isMe = item.userId === user?.id
              return (
                <Card
                  key={item.userId}
                  className={`p-4 ${isMe ? 'border-primary/50 bg-primary/5' : ''}`}
                >
                  <div className="flex items-center gap-4">
                    <div className="w-10 h-10 flex items-center justify-center">
                      {getRankIcon(item.rank)}
                    </div>

                    <div className="w-10 h-10 rounded-full bg-surface-light flex items-center justify-center shrink-0">
                      <span className="text-sm font-bold">
                        {item.user?.surname?.charAt(0)}{item.user?.name?.charAt(0)}
                      </span>
                    </div>

                    <div className="flex-1 min-w-0">
                      <p className={`font-medium truncate ${isMe ? 'text-primary' : ''}`}>
                        {item.user?.surname} {item.user?.name}
                        {isMe && <span className="text-xs text-slate-500 ml-2">(–≤—ã)</span>}
                      </p>
                      <p className="text-sm text-slate-500">
                        {item.operations} –æ–ø–µ—Ä–∞—Ü–∏–π
                      </p>
                    </div>

                    <div className="text-right shrink-0">
                      <p className="font-bold text-lg">{item.score}</p>
                      {item.trend !== 0 && (
                        <div className={`flex items-center justify-end gap-1 text-xs ${
                          item.trend > 0 ? 'text-success' : 'text-danger'
                        }`}>
                          {item.trend > 0 ? <TrendingUp size={12} /> : <TrendingDown size={12} />}
                          {Math.abs(item.trend)}%
                        </div>
                      )}
                    </div>
                  </div>
                </Card>
              )
            })}
          </div>
        ) : (
          <EmptyState
            icon={<Trophy size={48} />}
            title="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
            description="–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
          />
        )
      ) : (
        teamRankings.length > 0 ? (
          <div className="space-y-2">
            {teamRankings.map((item) => (
              <Card key={item.teamId} className="p-4">
                <div className="flex items-center gap-4">
                  <div className="w-10 h-10 flex items-center justify-center">
                    {getRankIcon(item.rank)}
                  </div>

                  <div className="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center shrink-0">
                    <Users size={18} className="text-primary" />
                  </div>

                  <div className="flex-1 min-w-0">
                    <p className="font-medium truncate">{item.team?.title || '–ö–æ–º–∞–Ω–¥–∞'}</p>
                    <p className="text-sm text-slate-500">
                      {item.memberCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Ä¢ {item.operations} –æ–ø–µ—Ä–∞—Ü–∏–π
                    </p>
                  </div>

                  <div className="text-right shrink-0">
                    <p className="font-bold text-lg">{item.score}</p>
                  </div>
                </div>
              </Card>
            ))}
          </div>
        ) : (
          <EmptyState
            icon={<Users size={48} />}
            title="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
            description="–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"
          />
        )
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Tasks/TasksPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import {
  ListTodo,
  Plus,
  Search,
  Filter,
  CheckCircle2,
  Clock,
  AlertCircle,
  ChevronRight
} from 'lucide-react'
import { Card, Input, Button, Badge, Tabs, EmptyState, Loader } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { useDebounce } from '../../hooks'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { Task } from '../../types'

export const TasksPage = () => {
  const [tasks, setTasks] = useState<Task[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [search, setSearch] = useState('')
  const [activeTab, setActiveTab] = useState('my')

  const debouncedSearch = useDebounce(search, 300)

  useEffect(() => {
    loadTasks()
  }, [debouncedSearch, activeTab])

  const loadTasks = async () => {
    try {
      setLoading(true)

      const params: Record<string, any> = { limit: 50 }
      if (debouncedSearch) params.search = debouncedSearch
      if (activeTab === 'my') params.assignedToMe = true
      if (activeTab === 'active') params.status = 'IN_PROGRESS,PENDING'
      if (activeTab === 'completed') params.status = 'COMPLETED'

      const { data } = await api.get('/tasks', { params })
      setTasks(Array.isArray(data) ? data : data.rows || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'COMPLETED':
        return <CheckCircle2 size={16} className="text-success" />
      case 'IN_PROGRESS':
        return <Clock size={16} className="text-primary" />
      case 'PENDING':
        return <AlertCircle size={16} className="text-warning" />
      default:
        return <Clock size={16} className="text-slate-500" />
    }
  }

  const getPriorityColor = (priority: number): 'danger' | 'warning' | 'neutral' => {
    if (priority >= 3) return 'danger'
    if (priority >= 2) return 'warning'
    return 'neutral'
  }

  const tabs = [
    { key: 'my', label: '–ú–æ–∏', icon: <ListTodo size={16} /> },
    { key: 'active', label: '–ê–∫—Ç–∏–≤–Ω—ã–µ' },
    { key: 'completed', label: '–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ' },
    { key: 'all', label: '–í—Å–µ' },
  ]

  return (
    <div className="space-y-4 animate-fadeIn">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">–ó–∞–¥–∞—á–∏</h1>
          <p className="text-slate-400 text-sm">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</p>
        </div>
        <Button icon={<Plus size={18} />}>
          –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
        </Button>
      </div>


      <Card className="p-3">
        <div className="flex gap-3">
          <div className="flex-1">
            <Input
              placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..."
              icon={<Search size={18} />}
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
          </div>
          <Button variant="outline" icon={<Filter size={18} />}>
            <span className="hidden sm:inline">–§–∏–ª—å—Ç—Ä—ã</span>
          </Button>
        </div>
      </Card>


      <Tabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />


      {loading ? (
        <div className="flex justify-center py-12">
          <Loader text="–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á..." />
        </div>
      ) : error ? (
        <Card className="p-6 text-center">
          <p className="text-danger mb-4">{error}</p>
          <Button variant="outline" onClick={loadTasks}>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</Button>
        </Card>
      ) : tasks.length === 0 ? (
        <EmptyState
          icon={<ListTodo size={48} />}
          title="–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          description={search ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å' : '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á'}
          action={
            <Button icon={<Plus size={18} />}>
              –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
            </Button>
          }
        />
      ) : (
        <div className="space-y-2">
          {tasks.map((task) => (
            <Card key={task.id} hover className="p-4">
              <div className="flex items-center gap-4">
                <div className="shrink-0">
                  {getStatusIcon(task.status)}
                </div>

                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <p className={`font-medium truncate ${
                      task.status === 'COMPLETED' ? 'text-slate-500 line-through' : ''
                    }`}>
                      {task.title}
                    </p>
                    {task.priority >= 2 && (
                      <Badge variant={getPriorityColor(task.priority)} size="sm">
                        {task.priority >= 3 ? '–°—Ä–æ—á–Ω–æ' : '–í–∞–∂–Ω–æ'}
                      </Badge>
                    )}
                  </div>

                  <div className="flex items-center gap-3 text-sm text-slate-500">
                    {task.project && (
                      <span className="truncate">{task.project.title}</span>
                    )}
                    {task.dueDate && (
                      <>
                        <span>‚Ä¢</span>
                        <span className={new Date(task.dueDate) < new Date() && task.status !== 'COMPLETED' ? 'text-danger' : ''}>
                          {new Date(task.dueDate).toLocaleDateString('ru-RU', {
                            day: 'numeric',
                            month: 'short'
                          })}
                        </span>
                      </>
                    )}
                    {task.assignee && (
                      <>
                        <span>‚Ä¢</span>
                        <span className="truncate">{task.assignee.surname}</span>
                      </>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-3 shrink-0">
                  <Badge variant={STATUS_COLORS[task.status] || 'neutral'}>
                    {STATUS_LABELS[task.status] || task.status}
                  </Badge>
                  <ChevronRight size={18} className="text-slate-600" />
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Warehouse/BoxDetailPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import { ArrowLeft, Package, MapPin, Clock, QrCode, Plus, Minus, History, Edit } from 'lucide-react'
import { Card, Button, Badge, Loader, Modal, Input } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { InventoryBox, WarehouseMovement } from '../../types'

export const BoxDetailPage = () => {
  const { id } = useParams<{ id: string }>()
  const navigate = useNavigate()

  const [box, setBox] = useState<InventoryBox | null>(null)
  const [movements, setMovements] = useState<WarehouseMovement[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const [showMovementModal, setShowMovementModal] = useState(false)
  const [movementType, setMovementType] = useState<'IN' | 'OUT'>('OUT')
  const [movementQty, setMovementQty] = useState('')
  const [movementReason, setMovementReason] = useState('')
  const [submitting, setSubmitting] = useState(false)

  useEffect(() => {
    if (id) loadBox()
  }, [id])

  const loadBox = async () => {
    try {
      setLoading(true)
      const [boxRes, movementsRes] = await Promise.all([
        api.get(`/warehouse/boxes/${id}`),
        api.get(`/warehouse/boxes/${id}/movements`, { params: { limit: 10 } }),
      ])
      setBox(boxRes.data)
      setMovements(movementsRes.data?.rows || movementsRes.data || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const handleMovement = async () => {
    if (!movementQty || !box) return
    try {
      setSubmitting(true)
      await api.post(`/warehouse/boxes/${id}/movements`, {
        type: movementType,
        quantity: parseInt(movementQty),
        reason: movementReason || undefined,
      })
      setShowMovementModal(false)
      setMovementQty('')
      setMovementReason('')
      loadBox()
    } catch (err) {
      alert(getErrorMessage(err))
    } finally {
      setSubmitting(false)
    }
  }

  const openMovementModal = (type: 'IN' | 'OUT') => {
    setMovementType(type)
    setShowMovementModal(true)
  }

  if (loading) return <div className="flex justify-center py-12"><Loader text="–ó–∞–≥—Ä—É–∑–∫–∞..." /></div>

  if (error || !box) {
    return (
      <div className="text-center py-12">
        <p className="text-danger mb-4">{error || '–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}</p>
        <Button variant="outline" onClick={() => navigate('/warehouse')}>–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</Button>
      </div>
    )
  }

  return (
    <div className="space-y-4 animate-fadeIn">
      <div className="flex items-center gap-4">
        <Button variant="ghost" icon={<ArrowLeft size={20} />} onClick={() => navigate('/warehouse')} />
        <div className="flex-1 min-w-0">
          <h1 className="text-xl font-bold truncate">{box.label}</h1>
          <p className="text-slate-400 text-sm truncate">{box.qrCode}</p>
        </div>
        <Button variant="ghost" icon={<Edit size={18} />}><span className="hidden sm:inline">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span></Button>
      </div>

      <Card className="p-5">
        <div className="flex items-center gap-4 mb-6">
          <div className="w-16 h-16 rounded-2xl bg-primary/20 flex items-center justify-center">
            <Package size={32} className="text-primary" />
          </div>
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-1">
              <span className="text-3xl font-bold">{box.quantity}</span>
              <span className="text-slate-400">{box.unit}</span>
            </div>
            <Badge variant={STATUS_COLORS[box.status] || 'neutral'}>{STATUS_LABELS[box.status] || box.status}</Badge>
          </div>
        </div>
        <div className="flex gap-3">
          <Button variant="outline" className="flex-1" icon={<Minus size={18} />} onClick={() => openMovementModal('OUT')}>–°–ø–∏—Å–∞—Ç—å</Button>
          <Button className="flex-1" icon={<Plus size={18} />} onClick={() => openMovementModal('IN')}>–î–æ–±–∞–≤–∏—Ç—å</Button>
        </div>
      </Card>

      <Card className="p-5">
        <h2 className="font-semibold mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <div className="space-y-4">
          <div className="flex items-center gap-3">
            <QrCode size={18} className="text-slate-500 shrink-0" />
            <div className="min-w-0"><p className="text-sm text-slate-400">QR-–∫–æ–¥</p><p className="font-medium truncate">{box.qrCode}</p></div>
          </div>
          {box.partNumber && (
            <div className="flex items-center gap-3">
              <Package size={18} className="text-slate-500 shrink-0" />
              <div className="min-w-0"><p className="text-sm text-slate-400">–ê—Ä—Ç–∏–∫—É–ª</p><p className="font-medium truncate">{box.partNumber}</p></div>
            </div>
          )}
          {box.section && (
            <div className="flex items-center gap-3">
              <MapPin size={18} className="text-slate-500 shrink-0" />
              <div className="min-w-0"><p className="text-sm text-slate-400">–°–µ–∫—Ü–∏—è</p><p className="font-medium truncate">{box.section.title}</p></div>
            </div>
          )}
          <div className="flex items-center gap-3">
            <Clock size={18} className="text-slate-500 shrink-0" />
            <div className="min-w-0">
              <p className="text-sm text-slate-400">–û–±–Ω–æ–≤–ª–µ–Ω–æ</p>
              <p className="font-medium">{new Date(box.updatedAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' })}</p>
            </div>
          </div>
        </div>
      </Card>

      <Card className="p-5">
        <h2 className="font-semibold mb-4 flex items-center gap-2"><History size={18} className="text-slate-500" />–ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏–π</h2>
        {movements.length > 0 ? (
          <div className="space-y-3">
            {movements.map((m) => (
              <div key={m.id} className="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-0">
                <div className="flex items-center gap-3">
                  <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${m.type === 'IN' ? 'bg-success/20' : 'bg-danger/20'}`}>
                    {m.type === 'IN' ? <Plus size={16} className="text-success" /> : <Minus size={16} className="text-danger" />}
                  </div>
                  <div>
                    <p className="font-medium">{m.type === 'IN' ? '+' : '-'}{m.quantity} {box.unit}</p>
                    <p className="text-xs text-slate-500">{m.user?.surname} {m.user?.name}</p>
                  </div>
                </div>
                <p className="text-xs text-slate-500">{new Date(m.createdAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</p>
              </div>
            ))}
          </div>
        ) : (
          <p className="text-slate-500 text-center py-4">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
        )}
      </Card>

      <Modal isOpen={showMovementModal} onClose={() => setShowMovementModal(false)} title={movementType === 'IN' ? '–ü—Ä–∏—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'} size="sm">
        <div className="space-y-4">
          <Input label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" type="number" value={movementQty} onChange={(e) => setMovementQty(e.target.value)} placeholder={`–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (${box.unit})`} min="1" autoFocus />
          <Input label="–ü—Ä–∏—á–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value={movementReason} onChange={(e) => setMovementReason(e.target.value)} placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É" />
          <div className="flex gap-3 pt-2">
            <Button variant="ghost" className="flex-1" onClick={() => setShowMovementModal(false)}>–û—Ç–º–µ–Ω–∞</Button>
            <Button variant={movementType === 'IN' ? 'success' : 'danger'} className="flex-1" onClick={handleMovement} loading={submitting} disabled={!movementQty || parseInt(movementQty) <= 0}>{movementType === 'IN' ? '–î–æ–±–∞–≤–∏—Ç—å' : '–°–ø–∏—Å–∞—Ç—å'}</Button>
          </div>
        </div>
      </Modal>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Warehouse/WarehousePage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { Search, Package, Plus, Filter, AlertTriangle, RefreshCw } from 'lucide-react'
import { Card, Input, Button, Badge, EmptyState, Loader } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { useDebounce } from '../../hooks'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { InventoryBox } from '../../types'

export const WarehousePage = () => {
  const navigate = useNavigate()
  const [boxes, setBoxes] = useState<InventoryBox[]>([])
  const [loading, setLoading] = useState(true)
  const [refreshing, setRefreshing] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [search, setSearch] = useState('')

  const debouncedSearch = useDebounce(search, 300)

  useEffect(() => {
    loadBoxes()
  }, [debouncedSearch])

  const loadBoxes = async (isRefresh = false) => {
    try {
      if (isRefresh) setRefreshing(true)
      else setLoading(true)

      const params: Record<string, string | number> = { limit: 50 }
      if (debouncedSearch) params.search = debouncedSearch

      const { data } = await api.get('/warehouse/boxes', { params })
      setBoxes(Array.isArray(data) ? data : data.rows || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'))
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }

  const getStatusBadge = (status: string, quantity: number, minQuantity?: number) => {
    if (minQuantity && quantity <= minQuantity) {
      return <Badge variant="danger" dot>–ö—Ä–∏—Ç–∏—á–Ω–æ</Badge>
    }
    return <Badge variant={STATUS_COLORS[status] || 'neutral'}>{STATUS_LABELS[status] || status}</Badge>
  }

  return (
    <div className="space-y-4 animate-fadeIn">
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">–°–∫–ª–∞–¥</h1>
          <p className="text-slate-400 text-sm">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏</p>
        </div>
        <div className="flex gap-2">
          <Button variant="ghost" icon={<RefreshCw size={18} className={refreshing ? 'animate-spin' : ''} />} onClick={() => loadBoxes(true)} disabled={refreshing}>
            <span className="hidden sm:inline">–û–±–Ω–æ–≤–∏—Ç—å</span>
          </Button>
          <Button icon={<Plus size={18} />}><span className="hidden sm:inline">–ù–æ–≤–∞—è –∫–æ—Ä–æ–±–∫–∞</span></Button>
        </div>
      </div>

      <Card className="p-3">
        <div className="flex gap-3">
          <div className="flex-1">
            <Input placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é, QR –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª—É..." icon={<Search size={18} />} value={search} onChange={(e) => setSearch(e.target.value)} />
          </div>
          <Button variant="outline" icon={<Filter size={18} />}><span className="hidden sm:inline">–§–∏–ª—å—Ç—Ä—ã</span></Button>
        </div>
      </Card>

      {error && (
        <Card className="p-4 bg-danger/10 border-danger/20">
          <div className="flex items-center gap-3 text-danger">
            <AlertTriangle size={20} />
            <span>{error}</span>
            <Button variant="ghost" size="sm" onClick={() => loadBoxes()}>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</Button>
          </div>
        </Card>
      )}

      {loading ? (
        <div className="flex justify-center py-12"><Loader text="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..." /></div>
      ) : boxes.length === 0 ? (
        <EmptyState icon={<Package size={48} />} title="–ö–æ—Ä–æ–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" description={search ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å' : '–ù–∞ —Å–∫–ª–∞–¥–µ –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ—Ä–æ–±–æ–∫'} action={search ? <Button variant="outline" onClick={() => setSearch('')}>–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫</Button> : undefined} />
      ) : (
        <div className="grid gap-3">
          {boxes.map((box) => (
            <Card key={box.id} hover className="p-4" onClick={() => navigate(`/warehouse/${box.id}`)}>
              <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-4 min-w-0">
                  <div className="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center shrink-0">
                    <Package size={24} className="text-primary" />
                  </div>
                  <div className="min-w-0">
                    <p className="font-semibold truncate">{box.label}</p>
                    <div className="flex items-center gap-2 text-sm text-slate-400">
                      <span className="truncate">{box.qrCode}</span>
                      {box.partNumber && <><span>‚Ä¢</span><span className="truncate">{box.partNumber}</span></>}
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-4 shrink-0">
                  <div className="text-right hidden sm:block">
                    <p className="font-bold text-lg">{box.quantity}</p>
                    <p className="text-xs text-slate-500">{box.unit}</p>
                  </div>
                  {getStatusBadge(box.status, box.quantity, box.minQuantity)}
                </div>
              </div>
              <div className="flex items-center justify-between mt-3 pt-3 border-t border-slate-700/50 sm:hidden">
                <span className="text-slate-400">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span className="font-bold">{box.quantity} {box.unit}</span>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/types/index.ts
================================================================================



export interface User {
  id: number
  login: string
  name: string
  surname: string
  role: string
  abilities: string[]
  teamId?: number
  sectionId?: number
  team?: Team
  section?: Section
  img?: string | null
}

export interface Team {
  id: number
  title: string
  leaderId?: number
}

export interface Section {
  id: number
  title: string
}


export interface InventoryBox {
  id: number
  qrCode: string
  label: string
  partNumber?: string
  quantity: number
  unit: string
  status: string
  minQuantity?: number
  sectionId?: number
  section?: Section
  createdAt: string
  updatedAt: string
}

export interface WarehouseMovement {
  id: number
  boxId: number
  userId: number
  type: 'IN' | 'OUT' | 'TRANSFER' | 'ADJUSTMENT'
  quantity: number
  reason?: string
  createdAt: string
  user?: User
  box?: InventoryBox
}


export interface Product {
  id: number
  serialNumber: string
  productTypeId: number
  productType?: ProductType
  status: string
  currentStepId?: number
  currentStep?: ProductionStep
  assignedUserId?: number
  assignedUser?: User
  createdAt: string
  updatedAt: string
}

export interface ProductType {
  id: number
  code: string
  name: string
  description?: string
  steps?: ProductionStep[]
}

export interface ProductionStep {
  id: number
  productTypeId: number
  title: string
  description?: string
  order: number
  checklistItems?: ChecklistItem[]
}

export interface ChecklistItem {
  id: number
  stepId: number
  title: string
  type: 'checkbox' | 'text' | 'number' | 'select' | 'photo' | 'serial'
  required: boolean
  options?: string[]
  order: number
}

export interface ChecklistResponse {
  id: number
  productId: number
  stepId: number
  itemId: number
  value: string
  userId: number
  createdAt: string
}


export interface Task {
  id: number
  title: string
  description?: string
  status: string
  priority: number
  projectId?: number
  project?: Project
  assigneeId?: number
  assignee?: User
  creatorId: number
  creator?: User
  dueDate?: string
  completedAt?: string
  createdAt: string
  updatedAt: string
}

export interface Project {
  id: number
  title: string
  description?: string
  status: string
}


export interface UserRanking {
  userId: number
  user: User
  rank: number
  score: number
  operations: number
  trend: number
}

export interface TeamRanking {
  teamId: number
  team: Team
  rank: number
  score: number
  operations: number
  memberCount: number
}

export interface UserStats {
  totalOperations: number
  todayOperations: number
  weekOperations: number
  monthOperations: number
  avgPerDay: number
  rank: number
  totalUsers: number
}


export interface PaginatedResponse<T> {
  rows: T[]
  count: number
  page?: number
  limit?: number
}

export interface ApiError {
  message: string
  error?: string
  statusCode?: number
}


export interface ScanResult {
  product: Product
  currentStep?: ProductionStep
  nextStep?: ProductionStep
  canProceed: boolean
  message?: string
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/vite-env.d.ts
================================================================================




================================================================================
FILE: QMS-Mobile/mes-pwa/tailwind.config.js
================================================================================


export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          DEFAULT: '#3b82f6',
          dark: '#2563eb',
          light: '#60a5fa',
        },
        surface: {
          DEFAULT: '#1e293b',
          light: '#334155',
          hover: '#3f4f63',
        },
        background: '#0f172a',
        success: '#10b981',
        warning: '#f59e0b',
        danger: '#ef4444',
      },
      animation: {
        'fadeIn': 'fadeIn 0.2s ease-out',
        'slideUp': 'slideUp 0.3s ease-out',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideUp: {
          '0%': { opacity: '0', transform: 'translateY(10px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
      },
    },
  },
  plugins: [],
}

================================================================================
FILE: QMS-Mobile/mes-pwa/tsconfig.json
================================================================================

{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}

================================================================================
FILE: QMS-Mobile/mes-pwa/tsconfig.node.json
================================================================================

{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}

================================================================================
FILE: QMS-Mobile/mes-pwa/vite.config.ts
================================================================================

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: [
        'favicon.svg',
        'favicon.ico',
        'robots.txt',
        'icon-192.png',
        'icon-512.png',
        'apple-touch-icon.png'
      ],
      manifest: {
        name: 'MES Kryptonit',
        short_name: 'MES',
        description: '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º —Å–µ—Ä–≤–µ—Ä–æ–≤',
        theme_color: '#0f172a',
        background_color: '#0f172a',
        display: 'standalone',
        orientation: 'portrait',
        scope: '/',
        start_url: '/',
        lang: 'ru',
        categories: ['business', 'productivity'],
        icons: [
          {
            src: '/icon-192.png',
            sizes: '192x192',
            type: 'image/png',
            purpose: 'any'
          },
          {
            src: '/icon-512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable'
          }
        ],
        shortcuts: [
          {
            name: '–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å',
            short_name: '–°–∫–∞–Ω',
            url: '/production/scan',
            icons: [{ src: '/icon-192.png', sizes: '192x192' }]
          },
          {
            name: '–°–∫–ª–∞–¥',
            short_name: '–°–∫–ª–∞–¥',
            url: '/warehouse',
            icons: [{ src: '/icon-192.png', sizes: '192x192' }]
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https?:\/\/.*\/api\/.*/i,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 60 * 60
              },
              cacheableResponse: {
                statuses: [0, 200]
              },
              networkTimeoutSeconds: 10
            }
          },
          {
            urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp)$/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'images-cache',
              expiration: {
                maxEntries: 50,
                maxAgeSeconds: 60 * 60 * 24 * 30
              }
            }
          },
          {
            urlPattern: /\.(?:woff|woff2|ttf|eot)$/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'fonts-cache',
              expiration: {
                maxEntries: 10,
                maxAgeSeconds: 60 * 60 * 24 * 365
              }
            }
          }
        ],
        navigateFallbackDenylist: [/^\/realms/]
      },
      devOptions: {
        enabled: false
      }
    })
  ],
  server: {
    host: '0.0.0.0',
    port: 3000,
    strictPort: true,
    proxy: {
      '/api': {
        target: 'http://localhost:5001',
        changeOrigin: true,
        secure: false
      }
    },
    cors: true
  },
  preview: {
    host: '0.0.0.0',
    port: 3000,
    strictPort: true
  },
  build: {
    outDir: 'dist',
    sourcemap: false,
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true
      }
    },
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor-react': ['react', 'react-dom', 'react-router-dom'],
          'vendor-auth': ['oidc-client-ts', 'react-oidc-context'],
          'vendor-ui': ['lucide-react'],
          'vendor-http': ['axios']
        }
      }
    },
    chunkSizeWarningLimit: 500
  },
  resolve: {
    alias: {
      '@': '/src',
      '@components': '/src/components',
      '@pages': '/src/pages',
      '@api': '/src/api',
      '@hooks': '/src/hooks',
      '@config': '/src/config',
      '@types': '/src/types'
    }
  },
  define: {
    __APP_VERSION__: JSON.stringify('2.0.0')
  }
})
================================================================================
FILE: QMS-Server-master/_backup_20260210_123659/General.js
================================================================================











const sequelize = require("../../db");
const { DataTypes } = require("sequelize");



const User = sequelize.define("user", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  login: { type: DataTypes.STRING, unique: true },
  password: { type: DataTypes.STRING },
  role: { type: DataTypes.STRING, defaultValue: "USER" },
  name: { type: DataTypes.STRING },
  surname: { type: DataTypes.STRING },
  img: { type: DataTypes.STRING },
});

const PC = sequelize.define("PC", {
  id: { type: DataTypes.SMALLINT, primaryKey: true, autoIncrement: true },
  ip: { type: DataTypes.STRING, unique: true, allowNull: false },
  pc_name: { type: DataTypes.STRING, allowNull: false },
  cabinet: { type: DataTypes.STRING },
});

const Session = sequelize.define("session", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  online: { type: DataTypes.BOOLEAN },
  PCId: {
    type: DataTypes.SMALLINT,
    allowNull: true,
    references: {
      model: "PCs",
      key: "id",
    },
  },
});



const AuditLog = sequelize.define("audit_log", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  userId: { type: DataTypes.INTEGER, allowNull: true },
  action: { type: DataTypes.STRING, allowNull: false },
  entity: { type: DataTypes.STRING, allowNull: true },
  entityId: { type: DataTypes.STRING, allowNull: true },
  description: { type: DataTypes.TEXT, allowNull: true },
  metadata: { type: DataTypes.JSON, allowNull: true },

  
  chainIndex: {
    type: DataTypes.BIGINT,
    allowNull: true,
    
    comment: "–ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –≤ hash-—Ü–µ–ø–æ—á–∫–µ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π)",
  },
  prevHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
    comment: "SHA-256 —Ö–µ—à –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–ø–∏—Å–∏ –≤ —Ü–µ–ø–æ—á–∫–µ",
  },
  currentHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
    comment: "SHA-256 —Ö–µ—à —Ç–µ–∫—É—â–µ–π –∑–∞–ø–∏—Å–∏ (–≤–∫–ª—é—á–∞—è prevHash)",
  },
  dataHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
    comment: "SHA-256 —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ chain-–ø–æ–ª–µ–π) ‚Äî –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π",
  },

  
  signedBy: {
    type: DataTypes.INTEGER,
    allowNull: true,
    comment: "userId –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–≤—à–µ–≥–æ –∑–∞–ø–∏—Å—å",
  },
  signedAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },

  
  severity: {
    type: DataTypes.ENUM("INFO", "WARNING", "CRITICAL", "SECURITY"),
    allowNull: false,
    defaultValue: "INFO",
    comment: "–£—Ä–æ–≤–µ–Ω—å –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ –¥–ª—è QMS –æ—Ç—á—ë—Ç–æ–≤",
  },
});



const Role = sequelize.define("role", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  name: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const Ability = sequelize.define("ability", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  code: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const RoleAbility = sequelize.define("role_ability", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
});

module.exports = {
  User,
  PC,
  Session,
  AuditLog,
  Role,
  Ability,
  RoleAbility,
};

================================================================================
FILE: QMS-Server-master/_backup_20260210_123659/index.js
================================================================================


const Router = require("express");
const router = new Router();


const userRouter = require("./userRouter");
const sessionRouter = require("./sessionRouter");
const pcRouter = require("./pcRouter");


const rbacRouter = require("./rbacRouter");
const structureRouter = require("./structureRouter");
const auditRouter = require("./auditRouter");


const warehouseRouter = require("./warehouseRouter");


const assemblyRouter = require("./assemblyRouter");
const assemblyRecipeRouter = require("./assemblyRecipeRouter");


const taskRouter = require("./taskRouter");
const projectRouter = require("./projectRouter");


const fcRouter = require("./fcRouter");
const ELRS915_Router = require("./ELRS915_Router");
const ELRS2_4_Router = require("./ELRS2_4_Router");
const coralB_router = require("./CoralBRouter");
const passportsExportRouter = require("./passportsExportRoutes");

const defectRouter = require("./defectRouter");
const defectRouter915 = require("./defectRouter915");
const defectRouter2_4 = require("./defectRouter2_4");
const defectRouter_CoralB = require("./defectRouterCoralB");


const beryllRouter = require("./beryllRouter");
const beryllExtendedRouter = require("./beryllExtendedRouter");


const defectSystemRouter = require("./defectSystemRouter");

const productionOutputRouter = require("./productionOutputRouter");


const documentRouter = require("./documentRouter");
const ncCapaRouter = require("./ncCapaRouter");


router.use("/users", userRouter);
router.use("/sessions", sessionRouter);
router.use("/pcs", pcRouter);


router.use("/rbac", rbacRouter);
router.use("/structure", structureRouter);
router.use("/audit", auditRouter);


router.use("/warehouse", warehouseRouter);


router.use("/assembly", assemblyRouter);
router.use("/assembly/recipes", assemblyRecipeRouter);


router.use("/tasks", taskRouter);
router.use("/projects", projectRouter);


router.use("/fcs", fcRouter);
router.use("/ELRS915", ELRS915_Router);
router.use("/ELRS2-4", ELRS2_4_Router);
router.use("/Coral-B", coralB_router);


router.use("/defectsFC", defectRouter);
router.use("/defects915", defectRouter915);
router.use("/defects2-4", defectRouter2_4);
router.use("/defects-Coral-B", defectRouter_CoralB);


router.use("/beryll", beryllRouter);
router.use("/beryll", beryllExtendedRouter);
router.use("/beryll/export/passports", passportsExportRouter);


router.use("/defects", defectSystemRouter);

router.use("/production", productionOutputRouter);


router.use("/documents", documentRouter);

router.use("/nc", ncCapaRouter);

module.exports = router;

================================================================================
FILE: QMS-Server-master/config/config.js
================================================================================

require('dotenv').config();

const base = {
  username: process.env.DB_USER || 'qms',
  password: process.env.DB_PASSWORD || 'qms_dev_2026',
  database: process.env.DB_NAME || 'asvo_qms',
  host: process.env.DB_HOST || '127.0.0.1',
  port: Number(process.env.DB_PORT || 5434),
  dialect: 'postgres',
  logging: false,
  dialectOptions: {
    
    connectionTimeoutMillis: 5000,
  },
};

module.exports = {
  development: { ...base },
  test: { ...base },
  production: { ...base },
};

================================================================================
FILE: QMS-Server-master/controllers/ProjectController.js
================================================================================

const { Project, User } = require("../models/index");
const ApiError = require("../error/ApiError");

class ProjectController {
  async create(req, res, next) {
    try {
      const { title, description } = req.body;
      if (!title) return next(ApiError.badRequest("–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"));

      const project = await Project.create({
        title,
        description,
        createdById: req.user.id
      });
      return res.json(project);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }

  async getAll(req, res, next) {
    try {
      const projects = await Project.findAll({
        order: [["createdAt", "DESC"]],
        include: [{ model: User, as: "author", attributes: ["name", "surname"] }]
      });
      return res.json(projects);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }

  async delete(req, res, next) {
    try {
        await Project.destroy({ where: { id: req.params.id } });
        return res.json({ message: "Deleted" });
    } catch(e) { next(ApiError.internal(e.message)); }
  }
}

module.exports = new ProjectController();

================================================================================
FILE: QMS-Server-master/controllers/TaskController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../error/ApiError");
const sequelize = require("../db");

const {
  ProductionTask,
  WarehouseBox,
  Section,
  Team,
  User,
  Project
} = require("../models/index");

class TaskController {

  async createTask(req, res, next) {
    try {
      const {
        title,
        originType,
        originId,
        targetQty,
        unit,
        dueDate,
        priority,
        comment,
        responsibleId,
        sectionId,
        projectId
      } = req.body;

      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏–∏"));
      }

      if (!title || !targetQty) {
        return next(ApiError.badRequest("–ù—É–∂–Ω—ã title –∏ targetQty"));
      }

      const task = await ProductionTask.create({
        title,
        originType: originType || null,
        originId: originId || null,
        targetQty,
        unit: unit || "—à—Ç",
        dueDate: dueDate || null,
        priority: priority || null,
        comment: comment || null,
        status: "NEW",
        createdById: req.user.id,
        responsibleId: responsibleId || null,
        sectionId: sectionId || null,
        projectId: projectId || null
      });

      return res.json(task);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getTasks(req, res, next) {
    try {
      let { page = 1, limit = 50, status, search, originType } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 50;
      const offset = (page - 1) * limit;

      const where = {};
      if (status) where.status = status;
      if (originType) where.originType = originType;
      if (search) {
        const s = String(search).trim();
        where[Op.or] = [
          { title: { [Op.iLike]: `%${s}%` } },
          { comment: { [Op.iLike]: `%${s}%` } },
        ];
      }

      const { rows, count } = await ProductionTask.findAndCountAll({
        where,
        limit,
        offset,
        order: [
          ["priority", "DESC"],
          ["dueDate", "ASC"],
          ["id", "ASC"],
        ],
        include: [
            {
                model: User,
                as: "responsible",
                attributes: ["id", "name", "surname"]
            },
            {
                model: Section,
                as: "targetSection",
                attributes: ["id", "title"]
            },
            {
                model: Project,
                as: "project",
                attributes: ["id", "title"]
            },
            {
                model: User,
                as: "createdBy",
                attributes: ["id", "name", "surname"]
            }
        ]
      });


      for (const task of rows) {
        let stats = {
          total: 0,
          done: 0,
          inWork: 0,
          onStock: 0
        };


        if (task.originType && task.originId) {
          const boxes = await WarehouseBox.findAll({
            attributes: ['status', 'quantity'],
            where: {
              originType: task.originType,
              originId: task.originId,
              status: { [Op.notIn]: ["SCRAP"] },
            },
          });

          for (const box of boxes) {
            const qty = Number(box.quantity) || 0;
            stats.total += qty;

            const st = box.status;
            if (st === 'DONE' || st === 'SHIPPED') {
              stats.done += qty;
            } else if (st === 'ON_STOCK') {
              stats.onStock += qty;
            } else {

              stats.inWork += qty;
            }
          }
        }

        const progressPercent = task.targetQty > 0
            ? Math.min(100, Math.round((stats.done / task.targetQty) * 100))
            : 0;


        task.setDataValue("stats", stats);
        task.setDataValue("progressPercent", progressPercent);
        task.setDataValue("totalFound", stats.total);
      }

      return res.json({ rows, count, page, limit });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getTaskById(req, res, next) {
    try {
      const { id } = req.params;
      const task = await ProductionTask.findByPk(id, {
        include: [
            { model: User, as: "responsible", attributes: ["id", "name", "surname"] },
            { model: Section, as: "targetSection", attributes: ["id", "title"] },
            { model: Project, as: "project", attributes: ["id", "title"] }
        ]
      });

      if (!task) {
        return next(ApiError.notFound("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      let boxes = [];
      let breakdown = [];
      let totalQty = 0;


      if (task.originType && task.originId) {
        boxes = await WarehouseBox.findAll({
          where: {
            originType: task.originType,
            originId: task.originId,
            status: { [Op.notIn]: ["SCRAP"] },
          },
          include: [
            {
              model: Section,
              as: "currentSection",
              attributes: ["id", "title"],
            },
            {
              model: Team,
              as: "currentTeam",
              attributes: ["id", "title"],
            },
          ],
          order: [["id", "ASC"]],
        });

        const map = {};

        for (const box of boxes) {
          const qty = box.quantity || 0;
          totalQty += qty;

          const key = `${box.status}|${box.currentSectionId || "null"}`;

          if (!map[key]) {
            map[key] = {
              status: box.status,
              sectionId: box.currentSectionId || null,
              sectionTitle: box.currentSection ? box.currentSection.title : null,
              qty: 0,
            };
          }
          map[key].qty += qty;
        }

        breakdown = Object.values(map);
      }

      return res.json({
        task,
        totalQty,
        breakdown,
        boxes,
      });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async updateFullTask(req, res, next) {
    try {
      const { id } = req.params;
      const {
        title, targetQty, unit, dueDate, priority, comment,
        responsibleId, sectionId, projectId, status
      } = req.body;

      const task = await ProductionTask.findByPk(id);
      if (!task) return next(ApiError.notFound("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));

      await task.update({
        title: title !== undefined ? title : task.title,
        targetQty: targetQty !== undefined ? targetQty : task.targetQty,
        unit: unit !== undefined ? unit : task.unit,
        dueDate: dueDate !== undefined ? dueDate : task.dueDate,
        priority: priority !== undefined ? priority : task.priority,
        comment: comment !== undefined ? comment : task.comment,
        responsibleId: responsibleId !== undefined ? (responsibleId || null) : task.responsibleId,
        sectionId: sectionId !== undefined ? (sectionId || null) : task.sectionId,
        projectId: projectId !== undefined ? (projectId || null) : task.projectId,
        status: status !== undefined ? status : task.status
      });

      return res.json(task);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }


  async updateTaskStatus(req, res, next) {
    try {
      const { id } = req.params;
      const { status } = req.body;

      const task = await ProductionTask.findByPk(id);
      if (!task) return next(ApiError.notFound("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));

      task.status = status;
      await task.save();

      return res.json(task);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }


  async deleteTask(req, res, next) {
    try {
        const { id } = req.params;
        const deleted = await ProductionTask.destroy({ where: { id } });
        if (!deleted) return next(ApiError.notFound("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
        return res.json({ message: "–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞" });
    } catch(e) {
        next(ApiError.internal(e.message));
    }
  }
}

module.exports = new TaskController();

================================================================================
FILE: QMS-Server-master/controllers/auditController.js
================================================================================
















const { AuditLog, User } = require("../models/index");
const ApiError = require("../error/ApiError");
const { Op } = require("sequelize");
const { verifyChain, quickVerify, generateInspectionReport } = require("../utils/auditVerifier");

class AuditController {
  




  async getLogs(req, res, next) {
    try {
      let { page, limit, action, entity, userId, dateFrom, dateTo, severity, search } = req.query;

      page = Number(page) || 1;
      limit = Math.min(Number(limit) || 50, 200);
      const offset = page * limit - limit;

      const where = {};

      if (action) {
        where.action = { [Op.like]: `%${action}%` };
      }

      if (entity) {
        where.entity = entity;
      }

      if (userId) {
        const parsedUserId = Number(userId);
        if (!Number.isNaN(parsedUserId)) {
          where.userId = parsedUserId;
        }
      }

      
      if (severity) {
        where.severity = severity;
      }

      
      if (search) {
        where.description = { [Op.iLike]: `%${search}%` };
      }

      if (dateFrom || dateTo) {
        where.createdAt = {};
        if (dateFrom) where.createdAt[Op.gte] = new Date(dateFrom);
        if (dateTo) {
          const to = new Date(dateTo);
          to.setDate(to.getDate() + 1);
          where.createdAt[Op.lt] = to;
        }
      }

      const logs = await AuditLog.findAndCountAll({
        where,
        include: [
          {
            model: User,
            as: "User",
            attributes: ["id", "login", "name", "surname"],
            required: false,
          },
        ],
        order: [["createdAt", "DESC"]],
        limit,
        offset,
      });

      return res.json(logs);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  



  async getOne(req, res, next) {
    try {
      const { id } = req.params;
      const record = await AuditLog.findByPk(id, {
        include: [
          {
            model: User,
            as: "User",
            attributes: ["id", "login", "name", "surname"],
            required: false,
          },
        ],
      });

      if (!record) {
        return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –∞—É–¥–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      
      let chainContext = null;
      if (record.chainIndex) {
        const [prev, next_] = await Promise.all([
          AuditLog.findOne({
            where: { chainIndex: Number(record.chainIndex) - 1 },
            attributes: ["id", "chainIndex", "currentHash", "action", "createdAt"],
            raw: true,
          }),
          AuditLog.findOne({
            where: { chainIndex: Number(record.chainIndex) + 1 },
            attributes: ["id", "chainIndex", "prevHash", "action", "createdAt"],
            raw: true,
          }),
        ]);

        
        const prevLinkValid = prev
          ? prev.currentHash === record.prevHash
          : record.prevHash === "0".repeat(64);

        const nextLinkValid = next_
          ? next_.prevHash === record.currentHash
          : true; 

        chainContext = {
          previous: prev,
          next: next_,
          prevLinkValid,
          nextLinkValid,
          chainValid: prevLinkValid && nextLinkValid,
        };
      }

      return res.json({
        ...record.toJSON(),
        chainContext,
      });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  




  async quickVerify(req, res, next) {
    try {
      const count = Math.min(Number(req.query.count) || 100, 1000);
      const report = await quickVerify(count);
      return res.json(report);
    } catch (e) {
      next(ApiError.internal(`–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${e.message}`));
    }
  }

  




  async fullVerify(req, res, next) {
    try {
      const { fromIndex, toIndex } = req.query;
      const report = await verifyChain({
        fromIndex: fromIndex ? Number(fromIndex) : undefined,
        toIndex: toIndex ? Number(toIndex) : undefined,
      });
      return res.json(report);
    } catch (e) {
      next(ApiError.internal(`–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${e.message}`));
    }
  }

  




  async inspectionReport(req, res, next) {
    try {
      const report = await generateInspectionReport();
      return res.json(report);
    } catch (e) {
      next(ApiError.internal(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞: ${e.message}`));
    }
  }

  



  async getStats(req, res, next) {
    try {
      const { days = 30 } = req.query;
      const since = new Date(Date.now() - Number(days) * 24 * 60 * 60 * 1000);

      const [bySeverity, byEntity, byAction, total, chainedTotal] = await Promise.all([
        
        AuditLog.findAll({
          attributes: ["severity", [require("sequelize").fn("COUNT", "*"), "count"]],
          where: { createdAt: { [Op.gte]: since } },
          group: ["severity"],
          raw: true,
        }),
        
        AuditLog.findAll({
          attributes: ["entity", [require("sequelize").fn("COUNT", "*"), "count"]],
          where: { createdAt: { [Op.gte]: since }, entity: { [Op.ne]: null } },
          group: ["entity"],
          order: [[require("sequelize").fn("COUNT", "*"), "DESC"]],
          limit: 10,
          raw: true,
        }),
        
        AuditLog.findAll({
          attributes: ["action", [require("sequelize").fn("COUNT", "*"), "count"]],
          where: { createdAt: { [Op.gte]: since } },
          group: ["action"],
          order: [[require("sequelize").fn("COUNT", "*"), "DESC"]],
          limit: 10,
          raw: true,
        }),
        
        AuditLog.count({ where: { createdAt: { [Op.gte]: since } } }),
        
        AuditLog.count({
          where: {
            createdAt: { [Op.gte]: since },
            chainIndex: { [Op.ne]: null },
          },
        }),
      ]);

      return res.json({
        period: { days: Number(days), since: since.toISOString() },
        total,
        chainedTotal,
        chainCoverage: total > 0 ? Math.round((chainedTotal / total) * 100) : 0,
        bySeverity,
        byEntity,
        byAction,
      });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new AuditController();

================================================================================
FILE: QMS-Server-master/controllers/documentController.js
================================================================================






















const ApiError = require("../error/ApiError");
const DocumentService = require("../services/DocumentService");

class DocumentController {
  

  async getAll(req, res, next) {
    try {
      const { page, limit, status, type, category, search, ownerId } = req.query;
      const result = await DocumentService.getDocuments({
        page: Number(page) || 1,
        limit: Number(limit) || 20,
        status,
        type,
        category,
        search,
        ownerId: ownerId ? Number(ownerId) : undefined,
      });
      return res.json(result);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async getOne(req, res, next) {
    try {
      const doc = await DocumentService.getDocumentDetail(Number(req.params.id));
      if (!doc) return next(ApiError.notFound("–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      return res.json(doc);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async getStats(req, res, next) {
    try {
      const stats = await DocumentService.getStats();
      return res.json(stats);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async getPending(req, res, next) {
    try {
      const approvals = await DocumentService.getPendingApprovals(req.user.id);
      return res.json(approvals);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async getOverdue(req, res, next) {
    try {
      const docs = await DocumentService.getOverdueReviews();
      return res.json(docs);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  

  async create(req, res, next) {
    try {
      const { title, type, category, description, isoSection, tags, reviewCycleMonths } = req.body;

      if (!title || !type) {
        return next(ApiError.badRequest("–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: title, type"));
      }

      const result = await DocumentService.createDocument(req, {
        title, type, category, description, isoSection, tags, reviewCycleMonths,
      });

      return res.status(201).json(result);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  

  async createVersion(req, res, next) {
    try {
      const { changeDescription } = req.body;
      const version = await DocumentService.createNewVersion(
        req,
        Number(req.params.id),
        { changeDescription }
      );
      return res.status(201).json(version);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async uploadFile(req, res, next) {
    try {
      if (!req.files || !req.files.file) {
        return next(ApiError.badRequest("–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"));
      }

      const version = await DocumentService.uploadVersionFile(
        req,
        Number(req.params.id),
        req.files.file
      );

      return res.json(version);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  

  async submitForReview(req, res, next) {
    try {
      const { approvalChain } = req.body;
      if (!approvalChain || !Array.isArray(approvalChain)) {
        return next(ApiError.badRequest("approvalChain –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–º–∞—Å—Å–∏–≤)"));
      }

      const version = await DocumentService.submitForReview(
        req,
        Number(req.params.id),
        approvalChain
      );

      return res.json(version);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async decide(req, res, next) {
    try {
      const { decision, comment } = req.body;
      if (!decision) {
        return next(ApiError.badRequest("decision –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω: APPROVED, REJECTED, RETURNED"));
      }

      const approval = await DocumentService.makeDecision(
        req,
        Number(req.params.id),
        { decision, comment }
      );

      return res.json(approval);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async makeEffective(req, res, next) {
    try {
      const version = await DocumentService.makeEffective(req, Number(req.params.id));
      return res.json(version);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  

  async distribute(req, res, next) {
    try {
      const { userIds } = req.body;
      if (!userIds || !Array.isArray(userIds)) {
        return next(ApiError.badRequest("userIds –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–º–∞—Å—Å–∏–≤)"));
      }

      const distributions = await DocumentService.distribute(
        req,
        Number(req.params.id),
        userIds
      );

      return res.json(distributions);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async acknowledge(req, res, next) {
    try {
      const dist = await DocumentService.acknowledge(req, Number(req.params.id));
      return res.json(dist);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new DocumentController();

================================================================================
FILE: QMS-Server-master/controllers/ncCapaController.js
================================================================================






const ApiError = require("../error/ApiError");
const NcCapaService = require("../services/NcCapaService");

class NcCapaController {
  
  async getNcList(req, res, next) {
    try {
      const result = await NcCapaService.getNCList(req.query);
      return res.json(result);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async getNcOne(req, res, next) {
    try {
      const nc = await NcCapaService.getNCDetail(Number(req.params.id));
      if (!nc) return next(ApiError.notFound("NC –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      return res.json(nc);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async createNc(req, res, next) {
    try {
      const nc = await NcCapaService.createNC(req, req.body);
      return res.status(201).json(nc);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async updateNc(req, res, next) {
    try {
      const nc = await NcCapaService.updateNC(req, Number(req.params.id), req.body);
      return res.json(nc);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async closeNc(req, res, next) {
    try {
      const nc = await NcCapaService.closeNC(req, Number(req.params.id), req.body);
      return res.json(nc);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  
  async getCapaList(req, res, next) {
    try {
      const result = await NcCapaService.getCAPAList(req.query);
      return res.json(result);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async getCapaOne(req, res, next) {
    try {
      const capa = await NcCapaService.getCAPADetail(Number(req.params.id));
      if (!capa) return next(ApiError.notFound("CAPA –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      return res.json(capa);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async createCapa(req, res, next) {
    try {
      const capa = await NcCapaService.createCAPA(req, req.body);
      return res.status(201).json(capa);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async updateCapaStatus(req, res, next) {
    try {
      const capa = await NcCapaService.updateCAPAStatus(req, Number(req.params.id), req.body);
      return res.json(capa);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async addCapaAction(req, res, next) {
    try {
      const action = await NcCapaService.addCapaAction(req, Number(req.params.id), req.body);
      return res.status(201).json(action);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async updateCapaAction(req, res, next) {
    try {
      const action = await NcCapaService.updateCapaAction(req, Number(req.params.id), req.body);
      return res.json(action);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async verifyEffectiveness(req, res, next) {
    try {
      const v = await NcCapaService.verifyCapaEffectiveness(req, Number(req.params.id), req.body);
      return res.json(v);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  
  async getStats(req, res, next) {
    try {
      const stats = await NcCapaService.getStats();
      return res.json(stats);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }
}

module.exports = new NcCapaController();

================================================================================
FILE: QMS-Server-master/controllers/pcController.js
================================================================================

const { PC } = require("../models/index");
const ApiError = require("../error/ApiError");

class PCController {

  async getPCs(req, res, next) {
    try {

      const pcAll = await PC.findAll();


      if (!pcAll) {
        return res.json([]);
      }


      pcAll.sort((a, b) => {
        const nameA = (a.pc_name || "").toString();
        const nameB = (b.pc_name || "").toString();


        const numA = parseInt(nameA.replace(/\D/g, ""), 10);
        const numB = parseInt(nameB.replace(/\D/g, ""), 10);

        const hasNumA = !isNaN(numA);
        const hasNumB = !isNaN(numB);


        if (hasNumA && hasNumB) {
          if (numA !== numB) return numA - numB;
        }


        if (hasNumA && !hasNumB) return -1;
        if (!hasNumA && hasNumB) return 1;


        return nameA.localeCompare(nameB);
      });

      return res.json(pcAll);
    } catch (e) {
      console.error("üî• –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ü–ö:", e);
      next(ApiError.internal("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ü–ö: " + e.message));
    }
  }

  async postPC(req, res, next) {
    try {
      const { ip, pc_name, cabinet } = req.body;
      const pc = await PC.create({ ip, pc_name, cabinet });
      return res.json(pc);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updatePC(req, res, next) {
    try {
      const { id, ip, pc_name, cabinet } = req.body;
      await PC.update({ ip, pc_name, cabinet }, { where: { id } });
      const pc = await PC.findAll({ where: { id } });
      return res.json(pc[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deletePC(req, res, next) {
    try {
      const id = req.params.id;
      await PC.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new PCController();

================================================================================
FILE: QMS-Server-master/controllers/rbacController.js
================================================================================

const { Role, Ability, RoleAbility } = require("../models/index");
const ApiError = require("../error/ApiError");

class RbacController {

    async getRoles(req, res, next) {
        try {
            const roles = await Role.findAll({
                include: [{
                    model: Ability,
                    as: "abilities",
                    through: { attributes: [] }
                }],
                order: [['id', 'ASC']]
            });
            return res.json(roles);
        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }


    async getAbilities(req, res, next) {
        try {
            const abilities = await Ability.findAll({
                order: [['code', 'ASC']]
            });
            return res.json(abilities);
        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }


    async updateRoleAbilities(req, res, next) {
        try {
            const { roleId } = req.params;
            const { abilityIds } = req.body;

            const role = await Role.findByPk(roleId);
            if (!role) {
                return next(ApiError.badRequest("–†–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }


            await role.setAbilities(abilityIds);

            return res.json({ message: "–ü—Ä–∞–≤–∞ —Ä–æ–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã" });
        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }
}

module.exports = new RbacController();

================================================================================
FILE: QMS-Server-master/controllers/riskController.js
================================================================================

const { RiskRegister, RiskAssessment, RiskMitigation } = require("../models/definitions/Risk");
const { User } = require("../models/definitions/General");
const RiskMatrixService = require("../services/RiskMatrixService");
const { logAudit } = require("../utils/auditLogger");
const { Op } = require("sequelize");





const getAll = async (req, res) => {
  try {
    const { category, status, riskClass, ownerId, page = 1, limit = 50 } = req.query;
    const where = {};

    if (category) where.category = category;
    if (status) where.status = status;
    if (riskClass) where.initialRiskClass = riskClass;
    if (ownerId) where.ownerId = ownerId;

    const offset = (page - 1) * limit;
    const { count, rows } = await RiskRegister.findAndCountAll({
      where,
      include: [
        { model: RiskAssessment, as: "assessments", limit: 1, order: [["assessmentDate", "DESC"]] },
        { model: RiskMitigation, as: "mitigations" },
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
      ],
      order: [["initialRiskLevel", "DESC"], ["createdAt", "DESC"]],
      limit: parseInt(limit),
      offset,
    });

    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("Risk getAll error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getOne = async (req, res) => {
  try {
    const risk = await RiskRegister.findByPk(req.params.id, {
      include: [
        { model: RiskAssessment, as: "assessments", order: [["assessmentDate", "DESC"]] },
        { model: RiskMitigation, as: "mitigations", order: [["createdAt", "ASC"]] },
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
      ],
    });

    if (!risk) return res.status(404).json({ error: "–†–∏—Å–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω" });
    res.json(risk);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

const create = async (req, res) => {
  try {
    const { title, description, category, initialProbability, initialSeverity, ownerId, relatedEntity, relatedEntityId, isoClause } = req.body;

    
    const count = await RiskRegister.count();
    const riskNumber = RiskMatrixService.generateRiskNumber(count + 1);

    
    const { level, riskClass } = RiskMatrixService.calculate(initialProbability, initialSeverity);

    const risk = await RiskRegister.create({
      riskNumber,
      title,
      description,
      category,
      initialProbability,
      initialSeverity,
      initialRiskLevel: level,
      initialRiskClass: riskClass,
      ownerId,
      relatedEntity,
      relatedEntityId,
      isoClause,
      status: "IDENTIFIED",
    });

    
    await RiskAssessment.create({
      riskRegisterId: risk.id,
      assessorId: req.user?.id || 1,
      probability: initialProbability,
      severity: initialSeverity,
      riskLevel: level,
      riskClass,
      assessmentType: "INITIAL",
      rationale: `–ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∏—Å–∫–∞: ${title}`,
    });

    await logAudit(req, "risk.create", "risk_register", risk.id, { riskNumber, riskClass });
    res.status(201).json(risk);
  } catch (e) {
    console.error("Risk create error:", e);
    res.status(500).json({ error: e.message });
  }
};

const update = async (req, res) => {
  try {
    const risk = await RiskRegister.findByPk(req.params.id);
    if (!risk) return res.status(404).json({ error: "–†–∏—Å–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω" });

    const updateData = { ...req.body };
    
    
    if (updateData.initialProbability && updateData.initialSeverity) {
      const { level, riskClass } = RiskMatrixService.calculate(updateData.initialProbability, updateData.initialSeverity);
      updateData.initialRiskLevel = level;
      updateData.initialRiskClass = riskClass;
    }

    await risk.update(updateData);
    await logAudit(req, "risk.update", "risk_register", risk.id, updateData);
    res.json(risk);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};





const addAssessment = async (req, res) => {
  try {
    const { probability, severity, detectability, rationale, assessmentType } = req.body;
    const risk = await RiskRegister.findByPk(req.params.id);
    if (!risk) return res.status(404).json({ error: "–†–∏—Å–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω" });

    const { level, riskClass } = RiskMatrixService.calculate(probability, severity);

    const assessment = await RiskAssessment.create({
      riskRegisterId: risk.id,
      assessorId: req.user?.id || 1,
      probability,
      severity,
      detectability,
      riskLevel: level,
      riskClass,
      rationale,
      assessmentType: assessmentType || "PERIODIC",
    });

    
    if (assessmentType === "POST_MITIGATION") {
      await RiskMatrixService.recalculateRisk(risk, { probability, severity, isResidual: true });
      risk.status = RiskMatrixService.isAcceptable(riskClass) ? "ACCEPTED" : "MITIGATED";
      await risk.save();
    }

    await logAudit(req, "risk.assess", "risk_register", risk.id, { riskClass, level });
    res.status(201).json(assessment);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};





const addMitigation = async (req, res) => {
  try {
    const risk = await RiskRegister.findByPk(req.params.id);
    if (!risk) return res.status(404).json({ error: "–†–∏—Å–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω" });

    const mitigation = await RiskMitigation.create({
      riskRegisterId: risk.id,
      ...req.body,
      status: "PLANNED",
    });

    if (risk.status === "IDENTIFIED") {
      risk.status = "ASSESSED";
      await risk.save();
    }

    await logAudit(req, "risk.mitigation.add", "risk_register", risk.id, { mitigationType: req.body.mitigationType });
    res.status(201).json(mitigation);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

const completeMitigation = async (req, res) => {
  try {
    const mitigation = await RiskMitigation.findByPk(req.params.mitigationId);
    if (!mitigation) return res.status(404).json({ error: "–ú–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" });

    mitigation.status = "COMPLETED";
    mitigation.completedDate = new Date();
    await mitigation.save();

    await logAudit(req, "risk.mitigation.complete", "risk_mitigation", mitigation.id);
    res.json(mitigation);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

const verifyMitigation = async (req, res) => {
  try {
    const mitigation = await RiskMitigation.findByPk(req.params.mitigationId);
    if (!mitigation) return res.status(404).json({ error: "–ú–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" });

    mitigation.status = "VERIFIED";
    mitigation.verifiedBy = req.user?.id || 1;
    mitigation.verifiedAt = new Date();
    mitigation.verificationNotes = req.body.notes;
    await mitigation.save();

    
    const risk = await RiskRegister.findByPk(mitigation.riskRegisterId, {
      include: [{ model: RiskMitigation, as: "mitigations" }],
    });
    
    const allVerified = risk.mitigations.every(m => m.status === "VERIFIED");
    if (allVerified) {
      risk.status = "MITIGATED";
      await risk.save();
    }

    await logAudit(req, "risk.mitigation.verify", "risk_mitigation", mitigation.id);
    res.json(mitigation);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};





const acceptRisk = async (req, res) => {
  try {
    const risk = await RiskRegister.findByPk(req.params.id);
    if (!risk) return res.status(404).json({ error: "–†–∏—Å–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω" });

    risk.status = "ACCEPTED";
    risk.acceptanceDecision = req.body.decision;
    risk.acceptedBy = req.user?.id || 1;
    risk.acceptedAt = new Date();
    await risk.save();

    await logAudit(req, "risk.accept", "risk_register", risk.id, { severity: "WARNING" });
    res.json(risk);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};





const getMatrix = async (req, res) => {
  try {
    const matrix = RiskMatrixService.getMatrix();
    const labels = RiskMatrixService.getScaleLabels();

    
    const risks = await RiskRegister.findAll({
      attributes: ["initialProbability", "initialSeverity"],
      where: { status: { [Op.notIn]: ["CLOSED"] } },
    });

    const cellCounts = {};
    risks.forEach(r => {
      const key = `${r.initialProbability}-${r.initialSeverity}`;
      cellCounts[key] = (cellCounts[key] || 0) + 1;
    });

    res.json({ matrix, labels, cellCounts });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

const getStats = async (req, res) => {
  try {
    const total = await RiskRegister.count();
    const byClass = {};
    for (const cls of ["LOW", "MEDIUM", "HIGH", "CRITICAL"]) {
      byClass[cls] = await RiskRegister.count({ where: { initialRiskClass: cls, status: { [Op.ne]: "CLOSED" } } });
    }
    const byStatus = {};
    for (const s of ["IDENTIFIED", "ASSESSED", "MITIGATED", "ACCEPTED", "CLOSED", "MONITORING"]) {
      byStatus[s] = await RiskRegister.count({ where: { status: s } });
    }

    const overdue = await RiskRegister.count({
      where: { reviewDate: { [Op.lt]: new Date() }, status: { [Op.notIn]: ["CLOSED", "ACCEPTED"] } },
    });

    res.json({ total, byClass, byStatus, overdue });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

module.exports = {
  getAll, getOne, create, update,
  addAssessment,
  addMitigation, completeMitigation, verifyMitigation,
  acceptRisk,
  getMatrix, getStats,
};

================================================================================
FILE: QMS-Server-master/controllers/sessionController.js
================================================================================

const { Session, PC } = require("../models/index");
const ApiError = require("../error/ApiError");
const { logAudit } = require("../utils/auditLogger");

class SessionController {
  async getSessions(req, res, next) {
    try {
      const sessionAll = await Session.findAll();
      return res.json(sessionAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async postSession(req, res, next) {
    try {
      const { online, userId, PCId } = req.body;

      const newSession = await Session.create({
        online,
        userId,
        PCId: PCId || null,
      });

      await logAudit({
        req,
        userId,
        action: "SESSION_CREATE",
        entity: "SESSION",
        entityId: newSession.id,
        description: `–°–æ–∑–¥–∞–Ω–∞ —Å–µ—Å—Å–∏—è –≤—Ä—É—á–Ω—É—é (userId=${userId}, PCId=${PCId || 'PERSONAL'}, online=${online})`,
        metadata: { userId, PCId, online },
      });

      return res.json(newSession);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async setOnlineSession(req, res, next) {
    try {

      const { online, PCId, userId: bodyUserId } = req.body;

      const currentUserId = (req.user && req.user.id) || bodyUserId;

      if (typeof online === "undefined" || !currentUserId) {
        return next(
          ApiError.badRequest(
            "–ù–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: online, userId"
          )
        );
      }


      if (online === true) {
        await Session.update(
            { online: false },
            {
                where: {
                    userId: currentUserId,
                    online: true
                }
            }
        );
      }


      let session;

      if (PCId) {

          session = await Session.findOne({
            where: { userId: currentUserId, PCId },
          });
      } else {

          session = await Session.findOne({
            where: { userId: currentUserId, PCId: null },
          });
      }

      if (session) {
        await session.update({ online });
      } else {
        session = await Session.create({
          online,
          userId: currentUserId,
          PCId: PCId || null,
        });
      }


      let pcName = "–õ–∏—á–Ω—ã–π –Ω–æ—É—Ç–±—É–∫";
      let pcIp = "Dynamic";

      if (PCId) {
        try {
          const pc = await PC.findByPk(PCId);
          if (pc) {
            pcName = pc.pc_name;
            pcIp = pc.ip;
          }
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –ü–ö –¥–ª—è –∞—É–¥–∏—Ç–∞:", err);
        }
      }

      const action = online ? "LOGIN" : "LOGOUT";
      const humanPc = pcName;
      const descr = online
        ? `–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${humanPc}${pcIp !== "Dynamic" ? ` (${pcIp})` : ""}`
        : `–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${humanPc}`;

      await logAudit({
        req,
        userId: currentUserId,
        action,
        entity: "SESSION",
        entityId: session.id,
        description: descr,
        metadata: {
          PCId: PCId || "PERSONAL",
          pcName,
          pcIp,
          online,
          userId: currentUserId,
        },
      });

      return res.json(session);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteSession(req, res, next) {
    try {
      const id = req.params.id;
      const session = await Session.findByPk(id);

      await Session.destroy({ where: { id } });

      await logAudit({
        req,
        userId: session ? session.userId : undefined,
        action: "SESSION_DELETE",
        entity: "SESSION",
        entityId: id,
        description: "–°–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º",
        metadata: session
          ? { userId: session.userId, PCId: session.PCId }
          : { sessionId: id },
      });

      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async setOfflineSession(req, res, next) {
    try {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();


      if (
        (hours === 23 && minutes >= 59) ||
        hours === 0 ||
        (hours === 1 && minutes <= 1)
      ) {
        const [updated] = await Session.update(
          { online: false },
          { where: { online: true } }
        );

        await logAudit({
          req,
          action: "SESSION_AUTO_OFF",
          entity: "SESSION",
          description: `–ù–æ—á–Ω–æ–π —Å–±—Ä–æ—Å —Å–µ—Å—Å–∏–π. –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ offline: ${updated}`,
          metadata: { updatedCount: updated },
        });

        return res.json("–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —Å–±—Ä–æ—à–µ–Ω—ã");
      } else {
        return res.json("–°–µ–π—á–∞—Å –Ω–µ –≤—Ä–µ–º—è –¥–ª—è —Å–±—Ä–æ—Å–∞");
      }
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async offlineSessionManual(req, res, next) {
    try {
      const [updated] = await Session.update(
        { online: false },
        { where: { online: true } }
      );

      await logAudit({
        req,
        action: "SESSION_FORCE_OFF",
        entity: "SESSION",
        description: `–†—É—á–Ω–æ–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π. –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ offline: ${updated}`,
        metadata: { updatedCount: updated },
      });

      return res.json("–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —Å–±—Ä–æ—à–µ–Ω—ã");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new SessionController();

================================================================================
FILE: QMS-Server-master/controllers/structureController.js
================================================================================

const { Section, Team, User } = require("../models/index");
const ApiError = require("../error/ApiError");
const { logAudit } = require("../utils/auditLogger");
const { Op } = require("sequelize");

class StructureController {

  async getFullStructure(req, res, next) {
    try {
      const structure = await Section.findAll({
        include: [
          {
            model: User,
            as: "manager",
            attributes: ["id", "name", "surname", "img"],
          },
          {
            model: Team,
            as: "teams",
            include: [
              {
                model: User,
                as: "teamLead",
                attributes: ["id", "name", "surname", "img"],
              },
              {
                model: User,
                attributes: ["id", "name", "surname", "img"],
              },

              {
                model: Section,
                as: "section",
                attributes: ["id", "title"],
              },
            ],
          },
        ],
        order: [["id", "ASC"]],
      });
      return res.json(structure);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async getUnassignedUsers(req, res, next) {
    try {
      const users = await User.findAll({
        where: {
          teamId: { [Op.is]: null },
          role: { [Op.notIn]: ["SUPER_ADMIN"] }
        },
        attributes: ["id", "name", "surname", "login", "role", "img"],
        order: [["surname", "ASC"]]
      });
      return res.json(users);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async createSection(req, res, next) {
    try {
      const { title } = req.body;
      const section = await Section.create({ title });

      await logAudit({
        req,
        action: "SECTION_CREATE",
        entity: "Section",
        entityId: section.id,
        description: `–°–æ–∑–¥–∞–Ω —É—á–∞—Å—Ç–æ–∫ "${title}"`,
      });

      return res.json(section);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async createTeam(req, res, next) {
    try {
      const { title, sectionId } = req.body;

      const team = await Team.create({ title, sectionId });

      await logAudit({
        req,
        action: "TEAM_CREATE",
        entity: "Team",
        entityId: team.id,
        description: `–°–æ–∑–¥–∞–Ω–∞ –±—Ä–∏–≥–∞–¥–∞ "${title}" –≤ —É—á–∞—Å—Ç–∫–µ ${sectionId}`,
      });

      return res.json(team);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async assignSectionManager(req, res, next) {
    try {
      const { sectionId, userId } = req.body;

      const section = await Section.findByPk(sectionId);
      if (!section) {
        return next(ApiError.notFound("–£—á–∞—Å—Ç–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await section.update({ managerId: userId });

      await logAudit({
        req,
        action: "SECTION_MANAGER_ASSIGN",
        entity: "Section",
        entityId: sectionId,
        description: `–ù–∞–∑–Ω–∞—á–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä ${userId} –Ω–∞ —É—á–∞—Å—Ç–æ–∫ ${sectionId}`,
      });

      return res.json(section);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async assignTeamLead(req, res, next) {
    try {
      const { teamId, userId } = req.body;

      const team = await Team.findByPk(teamId);
      if (!team) {
        return next(ApiError.notFound("–ë—Ä–∏–≥–∞–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      await team.update({ teamLeadId: userId });

      await logAudit({
        req,
        action: "TEAM_LEAD_ASSIGN",
        entity: "Team",
        entityId: teamId,
        description: `–ù–∞–∑–Ω–∞—á–µ–Ω –±—Ä–∏–≥–∞–¥–∏—Ä ${userId} –Ω–∞ –±—Ä–∏–≥–∞–¥—É ${teamId}`,
      });

      return res.json(team);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async addMemberToTeam(req, res, next) {
    try {
      const { teamId, userId } = req.body;

      const user = await User.findByPk(userId);
      if (!user) {
        return next(ApiError.notFound("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await user.update({ teamId });

      await logAudit({
        req,
        action: "USER_TEAM_ASSIGN",
        entity: "User",
        entityId: userId,
        description: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±—Ä–∏–≥–∞–¥—É ${teamId}`,
      });

      return res.json(user);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async removeMemberFromTeam(req, res, next) {
    try {
      const { userId } = req.body;

      const user = await User.findByPk(userId);
      if (!user) {
        return next(ApiError.notFound("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const previousTeamId = user.teamId;
      await user.update({ teamId: null });

      await logAudit({
        req,
        action: "USER_TEAM_REMOVE",
        entity: "User",
        entityId: userId,
        description: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É–¥–∞–ª—ë–Ω –∏–∑ –±—Ä–∏–≥–∞–¥—ã ${previousTeamId}`,
      });

      return res.json(user);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new StructureController();

================================================================================
FILE: QMS-Server-master/controllers/userController.js
================================================================================

const ApiError = require("../error/ApiError");
const { User, Session } = require("../models/index");
const jwt = require("jsonwebtoken");
const uuid = require("uuid");
const path = require("path");

const generateJWT = (id, login, role, name, surname, img) => {
  return jwt.sign(
    { id, login, role, name, surname, img },
    process.env.SECRET_KEY,
    {
      expiresIn: "5h",
    }
  );
};


const checkAccess = (req, targetUserId) => {

  const isSelf = req.user.id === Number(targetUserId);


  const hasManageRights = req.user.abilities && req.user.abilities.includes('users.manage');


  const isSuperAdmin = req.user.role === 'SUPER_ADMIN';


  if (!isSelf && !hasManageRights && !isSuperAdmin) {
      throw ApiError.forbidden("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —á—É–∂–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é");
  }
};

class UserController {

  async getUsers(req, res, next) {
    try {
      const usersAll = await User.findAll({
        order: [["name", "ASC"]],
      });
      return res.json(usersAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async getCurrentUser(req, res, next) {
    try {
      const id = req.params.id;


      checkAccess(req, id);

      const user = await User.findOne({
        where: { id },
      });
      return res.json(user);
    } catch (e) {

      if (e instanceof ApiError) return next(e);
      next(ApiError.badRequest(e.message));
    }
  }


  async updateUser(req, res, next) {
    try {
      const { id, password, name, surname } = req.body;


      checkAccess(req, id);


      const updateData = { name, surname };


      if (password && password.trim() !== "") {
        updateData.password = password;
      }

      await User.update(updateData, { where: { id } });
      const user = await User.findAll({ where: { id } });
      return res.json(user[0]);
    } catch (e) {
      if (e instanceof ApiError) return next(e);
      next(ApiError.badRequest(e.message));
    }
  }


  async updateUserImg(req, res, next) {
    try {
      const { id } = req.body;


      checkAccess(req, id);

      const { img } = req.files;
      let fileName = uuid.v4() + ".jpg";
      img.mv(path.resolve(__dirname, "..", "static", fileName));

      await User.update({ img: fileName }, { where: { id } });

      const user = await User.findAll({ where: { id } });
      return res.json(user[0]);
    } catch (e) {
      if (e instanceof ApiError) return next(e);
      next(ApiError.badRequest(e.message));
    }
  }

  async registration(req, res, next) {
    try {
      const { login, password, role, name, surname } = req.body;

      if (!login || !password) {
        return next(ApiError.badRequest("–Ω–µ—Ç –ª–æ–≥–∏–Ω–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—è –≤ –∑–∞–ø—Ä–æ—Å–µ"));
      }
      const candidate = await User.findOne({ where: { login } });
      if (candidate) {
        return next(
          ApiError.badRequest("–¢–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ –µ—Å—Ç—å")
        );
      }

      const user = await User.create({ login, password, role, name, surname });
      const token = generateJWT(
        user.id,
        user.login,
        user.role,
        user.name,
        user.surname,
        null
      );
      return res.json({ token });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async login(req, res, next) {
    try {
      const { login, password } = req.body;

      if (!login || !password) {
        return next(ApiError.badRequest("–Ω–µ—Ç –ª–æ–≥–∏–Ω–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—è –≤ –∑–∞–ø—Ä–æ—Å–µ"));
      }
      const currentUser = await User.findOne({ where: { login } });
      if (!currentUser) {
        return next(ApiError.internal("–¢–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç"));
      }

      if (currentUser.password != password) {
        return next(ApiError.internal("–Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"));
      }

      const isAciveSession = await Session.findAll({
        where: { userId: currentUser.id, online: true },
      });

      if (isAciveSession.length >= 1) {
        await Session.update(
          { online: false },
          { where: { userId: currentUser.id, online: true } }
        );
      }

      const token = generateJWT(
        currentUser.id,
        currentUser.login,
        currentUser.role,
        currentUser.name,
        currentUser.surname,
        currentUser.img
      );
      return res.json({ token });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async check(req, res, next) {
    const token = generateJWT(
      req.user.id,
      req.user.login,
      req.user.role,
      req.user.name,
      req.user.surname,
      req.user.img
    );
    res.json({ token });
  }


  async deleteUser(req, res, next) {
    try {
      const id = req.params.id;
      const deleteUser = await User.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new UserController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/AlertsController.js
================================================================================

const { Op } = require("sequelize");
const { WarehouseBox, InventoryLimit } = require("../../models/index");
const sequelize = require("../../db");
const ApiError = require("../../error/ApiError");

class AlertsController {
  async getAlerts(req, res, next) {
    try {
      const limits = await InventoryLimit.findAll();

      const balances = await WarehouseBox.findAll({
        attributes: [
          "label",
          "originType",
          "originId",
          [sequelize.fn("SUM", sequelize.col("quantity")), "total"],
        ],
        where: {
          status: {
            [Op.notIn]: ["SCRAP", "SHIPPED"],
          },
        },
        group: ["label", "originType", "originId"],
      });

      const alerts = [];

      for (const limit of limits) {
        let currentQty = 0;

        const foundBalance = balances.find(
          (b) =>
            b.label === limit.label &&
            b.originType === limit.originType &&
            (limit.originId == null || b.originId === limit.originId)
        );

        if (foundBalance) {
          currentQty = Number(foundBalance.get("total")) || 0;
        }

        if (currentQty < limit.minQuantity) {
          alerts.push({
            id: limit.id,
            label: limit.label,
            min: limit.minQuantity,
            current: currentQty,
            deficit: limit.minQuantity - currentQty,
          });
        }
      }

      res.json(alerts);
    } catch (e) {
      console.error("Alerts Error:", e);
      next(ApiError.internal(e.message));
    }
  }

  async getAllLimits(req, res, next) {
    try {
      const limits = await InventoryLimit.findAll({
        order: [["label", "ASC"]],
      });
      res.json(limits);
    } catch (e) {
      console.error("Get Limits Error:", e);
      next(ApiError.internal(e.message));
    }
  }

  async setLimit(req, res, next) {
    try {
      const { label, originType, originId, min } = req.body;

      let whereClause = {};
      if (originId && originType) {
        whereClause = { originId, originType };
      } else {
        whereClause = { label };
      }

      let limit = await InventoryLimit.findOne({ where: whereClause });

      if (limit) {
        if (min <= 0) {
          await limit.destroy();
          return res.json({ message: "–õ–∏–º–∏—Ç —É–¥–∞–ª–µ–Ω" });
        }
        await limit.update({ minQuantity: min, label });
      } else if (min > 0) {
        limit = await InventoryLimit.create({
          label,
          originType,
          originId,
          minQuantity: min,
        });
      }

      res.json(limit);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new AlertsController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/AnalyticsController.js
================================================================================



const { Op } = require("sequelize");
const { WarehouseBox, WarehouseMovement, User, Team, Project } = require("../../models/index");
const { ProductionOutput, OUTPUT_STATUSES } = require("../../models/ProductionOutput");
const sequelize = require("../../db");
const ApiError = require("../../error/ApiError");

let BoardDefect = null;
let DefectCategory = null;
try {
  const defectModels = require("../../models/definitions/Defect");
  BoardDefect = defectModels.BoardDefect;
  DefectCategory = defectModels.DefectCategory;
} catch (e) {
  console.log("[Analytics] –ú–æ–¥–µ–ª–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
}

function calculateDateRange(period, customStartDate, customEndDate) {
  const now = new Date();
  let startDate = new Date(now);
  let endDate = new Date(now);

  startDate.setHours(0, 0, 0, 0);
  endDate.setHours(23, 59, 59, 999);

  switch (period) {
    case 'day':
      break;
    case 'week':
      const dayOfWeek = startDate.getDay() || 7;
      startDate.setDate(startDate.getDate() - (dayOfWeek - 1));
      break;
    case 'month':
      startDate.setDate(1);
      break;
    case 'year':
      startDate.setMonth(0, 1);
      break;
    case 'all':
      startDate = new Date('2020-01-01');
      break;
    case 'custom':
      if (customStartDate) {
        startDate = new Date(customStartDate);
        startDate.setHours(0, 0, 0, 0);
      }
      if (customEndDate) {
        endDate = new Date(customEndDate);
        endDate.setHours(23, 59, 59, 999);
      }
      break;
    default:
      const defaultDay = startDate.getDay() || 7;
      startDate.setDate(startDate.getDate() - (defaultDay - 1));
  }

  return { startDate, endDate };
}

function generateDateRange(startDate, endDate) {
  const dates = [];
  const current = new Date(startDate);
  current.setHours(0, 0, 0, 0);

  const end = new Date(endDate);
  end.setHours(0, 0, 0, 0);

  while (current <= end) {
    dates.push(current.toISOString().split('T')[0]);
    current.setDate(current.getDate() + 1);
  }

  return dates;
}

class AnalyticsController {

  async getDashboardStats(req, res, next) {
    try {
      const {
        period = 'week',
        startDate: customStart,
        endDate: customEnd,
        projectId
      } = req.query;

      const { startDate, endDate } = calculateDateRange(period, customStart, customEnd);
      const startDateStr = startDate.toISOString().split('T')[0];
      const endDateStr = endDate.toISOString().split('T')[0];

      const parsedProjectId = projectId ? Number(projectId) : null;

      console.log(`>>> [Analytics] –ø–µ—Ä–∏–æ–¥=${period}, –ø—Ä–æ–µ–∫—Ç=${parsedProjectId || '–≤—Å–µ'}, —Å ${startDateStr} –ø–æ ${endDateStr}`);

      const now = new Date();
      const todayStart = new Date(now);
      todayStart.setHours(0, 0, 0, 0);

      const yesterdayStart = new Date(todayStart);
      yesterdayStart.setDate(yesterdayStart.getDate() - 1);

      const warehouseDateCondition = period === 'all'
        ? { [Op.gte]: startDate }
        : { [Op.gte]: startDate, [Op.lte]: endDate };

      const productionDateCondition = period === 'all'
        ? { [Op.gte]: startDateStr }
        : { [Op.gte]: startDateStr, [Op.lte]: endDateStr };

      const productionProjectCondition = parsedProjectId
        ? { projectId: parsedProjectId }
        : {};


      const stockStats = await WarehouseBox.findOne({
        attributes: [
          [sequelize.fn("SUM", sequelize.col("quantity")), "totalItems"],
          [sequelize.fn("COUNT", sequelize.col("id")), "totalBoxes"],
        ],
        where: { status: "ON_STOCK" },
        raw: true
      });


      const periodWarehouse = parsedProjectId ? null : await WarehouseMovement.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("goodQty")), "goodQty"]],
        where: {
          performedAt: warehouseDateCondition,
          performedById: { [Op.ne]: null },
          goodQty: { [Op.gt]: 0 }
        },
        raw: true
      });


      const periodProduction = await ProductionOutput.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("approvedQty")), "approvedQty"]],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });


      const todayWarehouse = parsedProjectId ? null : await WarehouseMovement.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("goodQty")), "goodQty"]],
        where: {
          performedAt: { [Op.gte]: todayStart },
          performedById: { [Op.ne]: null },
          goodQty: { [Op.gt]: 0 }
        },
        raw: true
      });

      const todayProduction = await ProductionOutput.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("approvedQty")), "approvedQty"]],
        where: {
          date: todayStart.toISOString().split('T')[0],
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });


      const yesterdayWarehouse = parsedProjectId ? null : await WarehouseMovement.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("goodQty")), "goodQty"]],
        where: {
          performedAt: { [Op.gte]: yesterdayStart, [Op.lt]: todayStart },
          performedById: { [Op.ne]: null },
          goodQty: { [Op.gt]: 0 }
        },
        raw: true
      });

      const yesterdayProduction = await ProductionOutput.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("approvedQty")), "approvedQty"]],
        where: {
          date: yesterdayStart.toISOString().split('T')[0],
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });


      let periodDefects = 0;
      let defectTypes = [];

      if (BoardDefect) {
        try {
          periodDefects = await BoardDefect.count({
            where: { detectedAt: warehouseDateCondition }
          });

          if (DefectCategory && periodDefects > 0) {
            try {
              const defectsByCategory = await BoardDefect.findAll({
                attributes: [
                  "categoryId",
                  [sequelize.fn("COUNT", sequelize.col("board_defect.id")), "count"]
                ],
                where: { detectedAt: warehouseDateCondition },
                include: [{
                  model: DefectCategory,
                  as: "category",
                  attributes: ["title"],
                  required: false
                }],
                group: ["categoryId", "category.id"],
                raw: false
              });

              defectTypes = defectsByCategory
                .filter(d => d.dataValues.count > 0)
                .map(d => ({
                  name: d.category?.title || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
                  value: Number(d.dataValues.count) || 0
                }));
            } catch (e) {
              console.log("[Analytics] –û—à–∏–±–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:", e.message);
            }
          }

          if (defectTypes.length === 0 && periodDefects > 0) {
            defectTypes = [{ name: "–î–µ—Ñ–µ–∫—Ç—ã", value: periodDefects }];
          }
        } catch (e) {
          console.log("[Analytics] –û—à–∏–±–∫–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤:", e.message);
        }
      }


      let warehouseUsers = [];
      if (!parsedProjectId) {
        warehouseUsers = await WarehouseMovement.findAll({
          attributes: [[sequelize.fn("DISTINCT", sequelize.col("performedById")), "userId"]],
          where: {
            performedAt: warehouseDateCondition,
            performedById: { [Op.ne]: null }
          },
          raw: true
        });
      }

      const productionUsers = await ProductionOutput.findAll({
        attributes: [[sequelize.fn("DISTINCT", sequelize.col("userId")), "userId"]],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });

      const allUserIds = new Set([
        ...warehouseUsers.map(u => u.userId),
        ...productionUsers.map(u => u.userId)
      ]);
      const activeUsers = allUserIds.size;


      let todayWarehouseUsers = [];
      if (!parsedProjectId) {
        todayWarehouseUsers = await WarehouseMovement.findAll({
          attributes: [[sequelize.fn("DISTINCT", sequelize.col("performedById")), "userId"]],
          where: {
            performedAt: { [Op.gte]: todayStart },
            performedById: { [Op.ne]: null }
          },
          raw: true
        });
      }

      const todayProductionUsers = await ProductionOutput.findAll({
        attributes: [[sequelize.fn("DISTINCT", sequelize.col("userId")), "userId"]],
        where: {
          date: todayStart.toISOString().split('T')[0],
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });

      const todayUserIds = new Set([
        ...todayWarehouseUsers.map(u => u.userId),
        ...todayProductionUsers.map(u => u.userId)
      ]);
      const activeUsersToday = todayUserIds.size;


      let chartByDay = [];
      if (!parsedProjectId) {
        chartByDay = await WarehouseMovement.findAll({
          attributes: [
            [sequelize.fn("DATE", sequelize.col("performedAt")), "date"],
            [sequelize.fn("SUM", sequelize.col("goodQty")), "output"],
          ],
          where: {
            performedAt: warehouseDateCondition,
            performedById: { [Op.ne]: null },
            goodQty: { [Op.gt]: 0 }
          },
          group: [sequelize.fn("DATE", sequelize.col("performedAt"))],
          order: [[sequelize.fn("DATE", sequelize.col("performedAt")), "ASC"]],
          raw: true
        });
      }

      const productionByDayRaw = await ProductionOutput.findAll({
        attributes: [
          "date",
          [sequelize.fn("SUM", sequelize.col("approvedQty")), "output"],
        ],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        group: ["date"],
        order: [["date", "ASC"]],
        raw: true
      });

      const daysMap = new Map();

      chartByDay.forEach(row => {
        const dateKey = row.date;
        if (!daysMap.has(dateKey)) daysMap.set(dateKey, { output: 0 });
        daysMap.get(dateKey).output += Number(row.output) || 0;
      });

      productionByDayRaw.forEach(row => {
        const dateKey = row.date;
        if (!daysMap.has(dateKey)) daysMap.set(dateKey, { output: 0 });
        daysMap.get(dateKey).output += Number(row.output) || 0;
      });

      const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      const allDates = generateDateRange(startDate, endDate);

      let filteredDates = allDates;
      let skipFactor = 1;

      if (allDates.length > 90) {
        skipFactor = Math.ceil(allDates.length / 90);
        filteredDates = allDates.filter((_, idx) => idx % skipFactor === 0);
      }

      const productionByDay = filteredDates.map(date => {
        const d = new Date(date);
        const dayOfWeek = d.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

        let output = 0;
        if (skipFactor > 1) {
          const idx = allDates.indexOf(date);
          for (let i = 0; i < skipFactor && idx + i < allDates.length; i++) {
            output += daysMap.get(allDates[idx + i])?.output || 0;
          }
        } else {
          output = daysMap.get(date)?.output || 0;
        }

        return {
          date,
          name: dayNames[dayOfWeek],
          fullDate: date,
          output,
          isWeekend
        };
      });


      let warehouseByUser = [];
      if (!parsedProjectId) {
        warehouseByUser = await WarehouseMovement.findAll({
          attributes: [
            "performedById",
            [sequelize.fn("SUM", sequelize.col("goodQty")), "output"],
          ],
          where: {
            performedAt: warehouseDateCondition,
            performedById: { [Op.ne]: null },
            goodQty: { [Op.gt]: 0 }
          },
          group: ["performedById"],
          raw: true
        });
      }


      const productionByUser = await ProductionOutput.findAll({
        attributes: [
          "userId",
          [sequelize.fn("SUM", sequelize.col("approvedQty")), "output"],
        ],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        group: ["userId"],
        raw: true
      });


      const userOutputMap = new Map();

      warehouseByUser.forEach(row => {
        const userId = row.performedById;
        if (!userOutputMap.has(userId)) {
          userOutputMap.set(userId, { output: 0 });
        }
        userOutputMap.get(userId).output += Number(row.output) || 0;
      });

      productionByUser.forEach(row => {
        const userId = row.userId;
        if (!userOutputMap.has(userId)) {
          userOutputMap.set(userId, { output: 0 });
        }
        userOutputMap.get(userId).output += Number(row.output) || 0;
      });


      const allUserIdsList = [...userOutputMap.keys()].filter(id => id != null);

      let usersData = [];
      if (allUserIdsList.length > 0) {
        usersData = await User.findAll({
          attributes: ["id", "name", "surname", "teamId"],
          where: { id: { [Op.in]: allUserIdsList } },
          include: [{
            model: Team,
            attributes: ["id", "title"],
            required: false
          }],
          raw: false
        });
      }


      const userDataMap = new Map();
      usersData.forEach(u => {
        const plain = u.get({ plain: true });

        const teamData = plain.Team || plain.team || null;
        userDataMap.set(plain.id, {
          name: plain.name,
          surname: plain.surname,
          teamId: plain.teamId,
          team: teamData
        });
      });

      console.log(`>>> [Analytics] –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${usersData.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);


      let usersWithTeams = 0;
      userDataMap.forEach((data) => {
        if (data.team) usersWithTeams++;
      });
      console.log(`>>> [Analytics] –ò–∑ –Ω–∏—Ö —Å –±—Ä–∏–≥–∞–¥–∞–º–∏: ${usersWithTeams}`);


      const formattedTopUsers = Array.from(userOutputMap.entries())
        .map(([userId, data]) => {
          const user = userDataMap.get(userId);
          return {
            id: userId,
            name: user
              ? `${user.surname || ''} ${(user.name || '')[0] || ''}.`.trim()
              : `ID: ${userId}`,
            output: data.output
          };
        })
        .filter(u => u.output > 0)
        .sort((a, b) => b.output - a.output)
        .slice(0, 5);


      const teamsMap = new Map();


      const teamIds = new Set();
      userDataMap.forEach((data) => {
        if (data.teamId) teamIds.add(data.teamId);
      });


      let teamsData = new Map();
      if (teamIds.size > 0) {
        const teams = await Team.findAll({
          attributes: ["id", "title"],
          where: { id: { [Op.in]: [...teamIds] } },
          raw: true
        });
        teams.forEach(t => teamsData.set(t.id, t));
      }


      userOutputMap.forEach((data, userId) => {
        const user = userDataMap.get(userId);
        const teamId = user?.teamId;

        if (teamId) {
          const team = user.team || teamsData.get(teamId);

          if (team) {
            if (!teamsMap.has(teamId)) {
              teamsMap.set(teamId, {
                id: teamId,
                name: team.title,
                output: 0,
                members: new Set()
              });
            }
            const t = teamsMap.get(teamId);
            t.output += data.output;
            t.members.add(userId);
          }
        }
      });

      const teamStats = Array.from(teamsMap.values())
        .map(t => ({ id: t.id, name: t.name, output: t.output, members: t.members.size }))
        .sort((a, b) => b.output - a.output)
        .slice(0, 5);

      console.log(`>>> [Analytics] –ë—Ä–∏–≥–∞–¥ —Å –¥–∞–Ω–Ω—ã–º–∏: ${teamStats.length}`);


      const periodOutput = (Number(periodWarehouse?.goodQty) || 0) + (Number(periodProduction?.approvedQty) || 0);
      const todayOutput = (Number(todayWarehouse?.goodQty) || 0) + (Number(todayProduction?.approvedQty) || 0);
      const yesterdayOutput = (Number(yesterdayWarehouse?.goodQty) || 0) + (Number(yesterdayProduction?.approvedQty) || 0);

      const defectRate = (periodOutput + periodDefects) > 0
        ? Number(((periodDefects / (periodOutput + periodDefects)) * 100).toFixed(1))
        : 0;

      const daysDiff = Math.max(1, Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)));


      let projectName = null;
      if (parsedProjectId) {
        const project = await Project.findByPk(parsedProjectId, { attributes: ["title"] });
        projectName = project?.title || null;
      }

      res.json({
        period,
        projectId: parsedProjectId,
        projectName,
        startDate: startDate.toISOString(),
        endDate: endDate.toISOString(),
        daysInPeriod: daysDiff,

        periodOutput,
        periodDefects,
        defectRate,

        todayOutput,
        yesterdayOutput,

        activeUsers,
        activeUsersToday,

        stock: {
          totalItems: Number(stockStats?.totalItems) || 0,
          totalBoxes: Number(stockStats?.totalBoxes) || 0
        },

        productionByDay,
        defectTypes,
        topUsers: formattedTopUsers,
        teamStats,

        generatedAt: new Date().toISOString()
      });

    } catch (e) {
      console.error("Analytics Dashboard Error:", e);
      next(ApiError.internal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: " + e.message));
    }
  }
}

module.exports = new AnalyticsController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/BoxController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../error/ApiError");
const {
  WarehouseBox,
  WarehouseMovement,
  WarehouseDocument,
  Supply,
  Section,
  Team,
  User,
  PrintHistory
} = require("../../models/index");
const { logAudit } = require("../../utils/auditLogger");
const sequelize = require("../../db");
const PdfService = require("../../services/PdfService");

const generateShortCode = () =>
  Math.floor(100000 + Math.random() * 900000).toString();

class BoxController {


  async createSingleBox(req, res, next) {
    try {
      const { supplyId, sectionId, itemName, quantity, unit, kitNumber, comment } = req.body;

      if (!itemName) {
        return next(ApiError.badRequest("–ù–µ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"));
      }
      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"));
      }

      const uniqueSuffix = Date.now().toString(36);
      const qrCode = `KRYPTO-${uniqueSuffix.toUpperCase()}`;
      const shortCode = generateShortCode();

      const box = await WarehouseBox.create({
        supplyId: supplyId || null,
        currentSectionId: sectionId || null,
        label: itemName,
        quantity: quantity || 1,
        unit: unit || "—à—Ç",
        kitNumber: kitNumber || null,
        qrCode,
        shortCode,
        notes: comment || null,
        status: "ON_STOCK",
        acceptedById: req.user.id,
        acceptedAt: new Date(),
      });

      await logAudit({
        req,
        action: "WAREHOUSE_BOX_CREATE",
        entity: "WarehouseBox",
        entityId: String(box.id),
        description: `–°–æ–∑–¥–∞–Ω–∞ –∫–æ—Ä–æ–±–∫–∞ ${itemName} (${shortCode})`,
        metadata: { supplyId, sectionId, itemName, quantity },
      });

      return res.json(box);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async createBoxesBatch(req, res, next) {
    try {
      const {
        label,
        projectName,
        batchName,
        originType,
        originId,
        quantity = 1,
        itemsPerBox = 1,
        unit = "—à—Ç",
        status = "ON_STOCK",
        currentSectionId = null,
        currentTeamId = null,
        notes,
      } = req.body;

      if (!label) {
        return next(ApiError.badRequest("–ù–µ –∑–∞–¥–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ (label)"));
      }

      const qty = Number(quantity);
      if (qty <= 0 || qty > 1000) {
        return next(
          ApiError.badRequest(
            "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–∏–∫–µ—Ç–æ–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 1000",
          ),
        );
      }

      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"));
      }

      const acceptedById = req.user.id;
      const now = new Date();
      const boxesData = [];

      for (let i = 0; i < qty; i++) {
        const suffix = String(i + 1).padStart(3, "0");
        const qrCode = `BOX-${Date.now()}-${suffix}-${Math.random()
          .toString(36)
          .substr(2, 3)
          .toUpperCase()}`;
        const shortCode = generateShortCode();

        boxesData.push({
          qrCode,
          shortCode,
          label,
          originType: originType || "OTHER",
          originId: originId || null,
          projectName: projectName || null,
          batchName: batchName || null,
          quantity: itemsPerBox,
          unit,
          acceptedAt: now,
          acceptedById,
          status,
          currentSectionId,
          currentTeamId,
          notes: notes || null,
        });
      }

      const created = await WarehouseBox.bulkCreate(boxesData, {
        returning: true,
      });

      await logAudit({
        req,
        action: "WAREHOUSE_BATCH",
        entity: "WarehouseBox",
        description: `–°–æ–∑–¥–∞–Ω–∞ –ø–∞—Ä—Ç–∏—è: ${qty} –º–µ—Å—Ç –ø–æ ${itemsPerBox} ${unit}`,
        metadata: { label, batchName },
      });

      return res.json({ boxes: created });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getBoxes(req, res, next) {
    try {
      const {
        page = 1,
        limit = 50,
        search,
        ...filters
      } = req.query;

      const where = { ...filters };

      Object.keys(where).forEach((key) => {
        if (where[key] === undefined || where[key] === "") {
          delete where[key];
        }
      });

      if (search) {
        const s = String(search).trim();
        where[Op.or] = [
          { qrCode: { [Op.iLike]: `%${s}%` } },
          { shortCode: s },
          { label: { [Op.iLike]: `%${s}%` } },
          { batchName: { [Op.iLike]: `%${s}%` } },
        ];
      }

      const pageNum = Number(page) || 1;
      const limitNum = Number(limit) || 50;
      const offset = (pageNum - 1) * limitNum;

      const { rows, count } = await WarehouseBox.findAndCountAll({
        where,
        limit: limitNum,
        offset,
        order: [["id", "DESC"]],
        include: [
          {
            model: User,
            as: "acceptedBy",
            attributes: ["id", "login", "name", "surname"],
          },
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      res.json({ rows, count, page: pageNum, limit: limitNum });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getBoxById(req, res, next) {
    try {
      const { id } = req.params;

      const box = await WarehouseBox.findByPk(id, {
        include: [
          {
            model: User,
            as: "acceptedBy",
            attributes: ["id", "login", "name", "surname"],
          },
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      if (!box) {
        return next(ApiError.notFound("–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      const movements = await WarehouseMovement.findAll({
        where: { boxId: box.id },
        order: [["performedAt", "DESC"]],
        include: [
          { model: Section, as: "fromSection", attributes: ["id", "title"] },
          { model: Section, as: "toSection", attributes: ["id", "title"] },
          { model: Team, as: "fromTeam", attributes: ["id", "title"] },
          { model: Team, as: "toTeam", attributes: ["id", "title"] },
          {
            model: User,
            as: "performedBy",
            attributes: ["id", "name", "surname"],
          },
        ],
      });

      const documents = await WarehouseDocument.findAll({
        where: { boxId: box.id },
        order: [["date", "DESC"]],
      });

      return res.json({ box, movements, documents });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getBoxByQr(req, res, next) {
    try {
      const encoded = req.params.qr;
      const qrCode = decodeURIComponent(encoded);

      const box = await WarehouseBox.findOne({
        where: { qrCode },
        include: [
          {
            model: User,
            as: "acceptedBy",
            attributes: ["id", "login", "name", "surname"],
          },
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      if (!box) {
        return next(ApiError.notFound("–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      const movements = await WarehouseMovement.findAll({
        where: { boxId: box.id },
        order: [["performedAt", "DESC"]],
      });

      const documents = await WarehouseDocument.findAll({
        where: { boxId: box.id },
        order: [["date", "DESC"]],
      });

      return res.json({ box, movements, documents });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async exportCsv(req, res, next) {
    try {
      const { ids } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return next(ApiError.badRequest("–ù–µ –ø–µ—Ä–µ–¥–∞–Ω—ã ID –∫–æ—Ä–æ–±–æ–∫"));
      }

      const boxes = await WarehouseBox.findAll({
        where: { id: { [Op.in]: ids } },
        include: [{ model: Section, as: "currentSection" }],
        order: [["id", "ASC"]],
      });

      if (!boxes || boxes.length === 0) {
        return next(ApiError.badRequest("–ö–æ—Ä–æ–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"));
      }

      let csv = "\uFEFF";
      csv += "ID;ShortCode;Label;Quantity;Unit;Section;QRCode\n";

      boxes.forEach((b) => {
        const section = b.currentSection ? b.currentSection.title : "";
        const row = [
          b.id,
          b.shortCode || "",
          b.label,
          b.quantity,
          b.unit,
          section,
          b.qrCode,
        ]
          .map((field) => `"${String(field).replace(/"/g, '""')}"`)
          .join(";");

        csv += row + "\n";
      });

      res.header("Content-Type", "text/csv; charset=utf-8");
      res.attachment("labels.csv");
      return res.send(csv);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async printLabelsPdf(req, res, next) {
    try {
      const { ids } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return next(ApiError.badRequest("–ù–µ –ø–µ—Ä–µ–¥–∞–Ω—ã ID –∫–æ—Ä–æ–±–æ–∫"));
      }

      const boxes = await WarehouseBox.findAll({
        where: { id: { [Op.in]: ids } },
        order: [["id", "ASC"]],
      });

      if (!boxes.length) {
        return next(ApiError.badRequest("–ö–æ—Ä–æ–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"));
      }

      const pdfBuffer = await PdfService.generateLabels(boxes);

      res.set({
        "Content-Type": "application/pdf",
        "Content-Length": pdfBuffer.length,
        "Content-Disposition": `attachment; filename="labels_${Date.now()}.pdf"`,
      });

      return res.send(pdfBuffer);
    } catch (e) {
      console.error("PDF Gen Error:", e);
      next(ApiError.internal("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: " + e.message));
    }
  }


  async updateBatch(req, res, next) {
    try {
      const { ids, updates } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return next(ApiError.badRequest("–ù–µ –≤—ã–±—Ä–∞–Ω—ã –∫–æ—Ä–æ–±–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"));
      }

      const allowedFields = ['label', 'quantity', 'unit', 'status', 'batchName', 'projectName', 'notes'];
      const cleanUpdates = {};

      Object.keys(updates).forEach(key => {
        if (allowedFields.includes(key) && updates[key] !== undefined && updates[key] !== "") {
          cleanUpdates[key] = updates[key];
        }
      });

      if (Object.keys(cleanUpdates).length === 0) {
        return next(ApiError.badRequest("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"));
      }

      await WarehouseBox.update(cleanUpdates, {
        where: { id: { [Op.in]: ids } }
      });

      await logAudit({
        req,
        action: "WAREHOUSE_BOX_BATCH_UPDATE",
        entity: "WarehouseBox",
        description: `–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${ids.length} –∫–æ—Ä–æ–±–æ–∫`,
        metadata: { ids, updates: cleanUpdates }
      });

      return res.json({ message: "–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ" });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async printSpecialLabel(req, res, next) {
    try {
      const {
        template = "VIDEO_KIT",
        customLayout,
        printCount = 1,
        code,
        rotate,
        widthMm,
        heightMm,
        ...restData
      } = req.body;

      const labelsData = [];
      const count = Math.max(1, Number(printCount));

      let startCodeStr = String(code).trim();

      if (/^\d+$/.test(startCodeStr)) {
          const originalLength = startCodeStr.length;
          const startBigInt = BigInt(startCodeStr);

          for (let i = 0; i < count; i++) {
              const nextVal = startBigInt + BigInt(i);
              const nextCodeStr = nextVal.toString().padStart(originalLength, '0');
              const infoString = `${restData.productName} - ${restData.quantity} ${restData.unit} (ID: ${nextCodeStr})`;

              labelsData.push({
                  ...restData,
                  code: nextCodeStr,
                  qrCode: nextCodeStr,
                  bottomQr: infoString,
                  rotate: rotate,
                  currentIndex: i + 1,
                  totalCount: count
              });
          }
      } else {
          const infoString = `${restData.productName} - ${restData.quantity} ${restData.unit} (ID: ${startCodeStr})`;

          for (let i = 0; i < count; i++) {
              labelsData.push({
                  ...restData,
                  code: startCodeStr,
                  qrCode: startCodeStr,
                  bottomQr: infoString,
                  rotate: rotate,
                  currentIndex: i + 1,
                  totalCount: count
              });
          }
      }

      const options = {
          widthMm: Number(widthMm) || 105,
          heightMm: Number(heightMm) || 60
      };

      let pdfBuffer;


      if (template === "VIDEO_KIT") {
          pdfBuffer = await PdfService.generateVideoTransmitterLabelBatch(labelsData, options);
      } else if (template === "CUSTOM" && customLayout && customLayout.length > 0) {

          pdfBuffer = await PdfService.generateCustomLabelBatch(labelsData, customLayout, options);
      } else {
          pdfBuffer = await PdfService.generateSimpleZebraBatch(labelsData, options);
      }


      const userId = req.user ? req.user.id : null;
      let endCodeStr = startCodeStr;

      if (labelsData.length > 0) {
          startCodeStr = labelsData[0].code;
          endCodeStr = labelsData[labelsData.length - 1].code;
      }

      await PrintHistory.create({
          template,
          labelName: restData.productName || "–≠—Ç–∏–∫–µ—Ç–∫–∞",
          startCode: startCodeStr,
          endCode: endCodeStr,
          quantity: count,
          params: {
            ...restData,
            widthMm,
            heightMm,
            rotate,
            customLayout: template === "CUSTOM" ? customLayout : undefined
          },
          createdById: userId
      });

      res.set({
        "Content-Type": "application/pdf",
        "Content-Length": pdfBuffer.length,
        "Content-Disposition": `inline; filename="zebra_label_${template}.pdf"`,
      });

      return res.send(pdfBuffer);
    } catch (e) {
      console.error("Print Special Error:", e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new BoxController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/DocumentController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../error/ApiError");
const { WarehouseDocument, User } = require("../../models/index");

class DocumentController {
  async createDocument(req, res, next) {
    try {
      const { boxId, number, type, date, fileUrl, comment } = req.body;

      if (!number) {
        return next(ApiError.badRequest("–ù—É–∂–µ–Ω –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞"));
      }

      const doc = await WarehouseDocument.create({
        boxId: boxId || null,
        number,
        type: type || null,
        date: date || null,
        fileUrl: fileUrl || null,
        comment: comment || null,
        createdById: req.user.id,
      });

      return res.json(doc);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getDocuments(req, res, next) {
    try {
      let { page = 1, limit = 50, search, type } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 50;

      const where = {};
      if (type) where.type = type;
      if (search) where.number = { [Op.iLike]: `%${search}%` };

      const offset = (page - 1) * limit;

      const data = await WarehouseDocument.findAndCountAll({
        where,
        limit,
        offset,
        order: [["date", "DESC"]],
        include: [
          {
            model: User,
            as: "createdBy",
            attributes: ["name", "surname"],
          },
        ],
      });

      return res.json({
        rows: data.rows,
        count: data.count,
        page,
        limit,
      });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new DocumentController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/HistoryController.js
================================================================================

const { PrintHistory, User } = require("../../models/index");
const { Op } = require("sequelize");
const ApiError = require("../../error/ApiError");

class HistoryController {
    async getPrintHistory(req, res, next) {
        try {
            let { page = 1, limit = 50, search, template, dateFrom, dateTo } = req.query;
            page = Number(page) || 1;
            limit = Number(limit) || 50;
            const offset = (page - 1) * limit;

            const where = {};

            if (template) where.template = template;

            if (search) {
                const s = String(search).trim();
                where[Op.or] = [
                    { labelName: { [Op.iLike]: `%${s}%` } },
                    { startCode: { [Op.iLike]: `%${s}%` } },
                    { endCode: { [Op.iLike]: `%${s}%` } }
                ];
            }

            if (dateFrom || dateTo) {
                where.createdAt = {};
                if (dateFrom) where.createdAt[Op.gte] = new Date(dateFrom);
                if (dateTo) {
                    const to = new Date(dateTo);
                    to.setDate(to.getDate() + 1);
                    where.createdAt[Op.lt] = to;
                }
            }

            const history = await PrintHistory.findAndCountAll({
                where,
                limit,
                offset,
                order: [["createdAt", "DESC"]],
                include: [
                    {
                        model: User,
                        as: "createdBy",
                        attributes: ["id", "name", "surname"]
                    }
                ]
            });

            return res.json({
                rows: history.rows,
                count: history.count,
                page,
                limit
            });

        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }
}

module.exports = new HistoryController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/MovementController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../error/ApiError");
const {
  WarehouseBox,
  WarehouseMovement,
  WarehouseDocument,
  Supply,
  Section,
  Team,
  User,
} = require("../../models/index");
const { logAudit } = require("../../utils/auditLogger");
const sequelize = require("../../db");

class MovementController {

  async moveSingle(req, res, next) {
    const t = await sequelize.transaction();
    try {
      const {
        boxId,
        operation,
        toSectionId,
        toTeamId,
        statusAfter,
        deltaQty = 0,
        goodQty = null,
        scrapQty = null,
        comment,
        documentId,
      } = req.body;

      if (!boxId || !operation) {
        await t.rollback();
        return next(ApiError.badRequest("–ù–µ —É–∫–∞–∑–∞–Ω boxId –∏–ª–∏ operation"));
      }

      const box = await WarehouseBox.findByPk(boxId, { transaction: t });
      if (!box) {
        await t.rollback();
        return next(ApiError.notFound("–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      const fromSectionId = box.currentSectionId;
      const fromTeamId = box.currentTeamId;

      let newQty = box.quantity;
      const delta = Number(deltaQty) || 0;

      if (delta !== 0) {
        newQty = box.quantity + delta;
        if (newQty < 0) {
          await t.rollback();
          return next(ApiError.badRequest("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º"));
        }
        box.quantity = newQty;
      }

      if (toSectionId !== undefined) box.currentSectionId = toSectionId || null;
      if (toTeamId !== undefined) box.currentTeamId = toTeamId || null;
      if (statusAfter) box.status = statusAfter;

      await box.save({ transaction: t });

      const movement = await WarehouseMovement.create(
        {
          boxId: box.id,
          documentId: documentId || null,
          fromSectionId,
          toSectionId: toSectionId || null,
          fromTeamId,
          toTeamId: toTeamId || null,
          operation,
          statusAfter: box.status,
          deltaQty: delta,
          goodQty: goodQty !== undefined ? goodQty : null,
          scrapQty: scrapQty !== undefined ? scrapQty : null,
          performedAt: new Date(),
          comment: comment || null,
          performedById: req.user ? req.user.id : null,
        },
        { transaction: t }
      );

      await logAudit({
        req,
        action: "WAREHOUSE_MOVE",
        entity: "WarehouseMovement",
        entityId: String(movement.id),
        description: `–û–ø–µ—Ä–∞—Ü–∏—è ${operation} —Å –∫–æ—Ä–æ–±–∫–æ–π #${box.id}`,
        metadata: {
          boxId: box.id,
          fromSectionId,
          toSectionId,
          deltaQty: delta,
        },
      });

      await t.commit();

      const reloadedBox = await WarehouseBox.findByPk(box.id, {
        include: [
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      return res.json({ box: reloadedBox, movement });
    } catch (e) {
      await t.rollback();
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async moveBatch(req, res, next) {
    const t = await sequelize.transaction();
    try {
      const { docNumber, items } = req.body;

      if (!items || !Array.isArray(items) || items.length === 0) {
        await t.rollback();
        return next(ApiError.badRequest("–ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π"));
      }

      let document = null;
      if (docNumber) {
        document = await WarehouseDocument.create(
          {
            boxId: null,
            number: docNumber,
            type: "MOVEMENT",
            date: new Date(),
            fileUrl: null,
            comment: null,
            createdById: req.user ? req.user.id : null,
          },
          { transaction: t }
        );
      }

      const documentId = document ? document.id : null;

      const movements = [];
      const updatedBoxes = [];

      for (const raw of items) {
        const boxId = raw.boxId || (raw.box && raw.box.id);
        if (!boxId) {
          await t.rollback();
          return next(ApiError.badRequest("–í –æ–¥–Ω–æ–º –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç boxId"));
        }

        const {
          operation,
          toSectionId,
          toTeamId,
          statusAfter,
          deltaQty = 0,
          goodQty = null,
          scrapQty = null,
          comment,
        } = raw;

        const box = await WarehouseBox.findByPk(boxId, { transaction: t });
        if (!box) {
          await t.rollback();
          return next(ApiError.notFound(`–ö–æ—Ä–æ–±–∫–∞ ${boxId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`));
        }

        const fromSectionId = box.currentSectionId;
        const fromTeamId = box.currentTeamId;
        const delta = Number(deltaQty) || 0;

        if (delta !== 0) {
          const newQty = box.quantity + delta;
          if (newQty < 0) {
            await t.rollback();
            return next(
              ApiError.badRequest(`–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –∫–æ—Ä–æ–±–∫–∏ ${boxId}`)
            );
          }
          box.quantity = newQty;
        }

        if (toSectionId !== undefined) box.currentSectionId = toSectionId || null;
        if (toTeamId !== undefined) box.currentTeamId = toTeamId || null;
        if (statusAfter) box.status = statusAfter;

        await box.save({ transaction: t });

        const movement = await WarehouseMovement.create(
          {
            boxId: box.id,
            documentId,
            fromSectionId,
            toSectionId: toSectionId || null,
            fromTeamId,
            toTeamId: toTeamId || null,
            operation,
            statusAfter: box.status,
            deltaQty: delta,
            goodQty: goodQty !== undefined ? goodQty : null,
            scrapQty: scrapQty !== undefined ? scrapQty : null,
            performedAt: new Date(),
            comment: comment || null,
            performedById: req.user ? req.user.id : null,
          },
          { transaction: t }
        );

        movements.push(movement);
        updatedBoxes.push(box);
      }

      await logAudit({
        req,
        action: "WAREHOUSE_MOVE_BATCH",
        entity: "WarehouseMovement",
        description: `–ü–∞–∫–µ—Ç–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ, –æ–ø–µ—Ä–∞—Ü–∏–π: ${movements.length}`,
        metadata: {
          docNumber: docNumber || null,
          count: movements.length,
        },
      });

      await t.commit();

      return res.json({
        message: "–û–ø–µ—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã",
        count: movements.length,
        document: document || null,
      });
    } catch (e) {
      await t.rollback();
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getMovements(req, res, next) {
    try {
      let { page = 1, limit = 50, boxId, fromDate, toDate } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 50;

      const where = {};
      if (boxId) where.boxId = boxId;

      if (fromDate || toDate) {
        where.performedAt = {};
        if (fromDate) where.performedAt[Op.gte] = new Date(fromDate);
        if (toDate) where.performedAt[Op.lte] = new Date(toDate);
      }

      const offset = (page - 1) * limit;

      const { rows, count } = await WarehouseMovement.findAndCountAll({
        where,
        limit,
        offset,
        order: [["performedAt", "DESC"]],
        include: [
          { model: Section, as: "fromSection", attributes: ["id", "title"] },
          { model: Section, as: "toSection", attributes: ["id", "title"] },
          { model: Team, as: "fromTeam", attributes: ["id", "title"] },
          { model: Team, as: "toTeam", attributes: ["id", "title"] },
          {
            model: User,
            as: "performedBy",
            attributes: ["id", "name", "surname"],
          },
        ],
      });

      return res.json({ rows, count, page, limit });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getBalance(req, res, next) {
    try {
      const balances = await WarehouseBox.findAll({
        attributes: [
          "label",
          "originType",
          "originId",
          "unit",
          [sequelize.fn("SUM", sequelize.col("quantity")), "totalQuantity"],
          [sequelize.fn("COUNT", sequelize.col("id")), "boxCount"],
        ],
        where: {
          status: {
            [Op.notIn]: ["SCRAP", "SHIPPED"],
          },
        },
        group: ["label", "originType", "originId", "unit"],
        order: [["label", "ASC"]],
      });

      return res.json(balances);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new MovementController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/SupplyController.js
================================================================================

const ApiError = require("../../error/ApiError");
const { Supply, WarehouseBox, Section } = require("../../models/index");
const { logAudit } = require("../../utils/auditLogger");

class SupplyController {
  async createSupply(req, res, next) {
    try {
      const { supplier, docNumber, expectedDate, comment } = req.body;

      const supply = await Supply.create({
        supplier: supplier || null,
        docNumber: docNumber || null,
        expectedDate: expectedDate || null,
        comment: comment || null,
        status: "NEW",
      });

      await logAudit({
        req,
        action: "SUPPLY_CREATE",
        entity: "Supply",
        entityId: String(supply.id),
        description: `–ü–æ—Å—Ç–∞–≤–∫–∞ ${docNumber || `#${supply.id}`}`,
      });

      return res.json(supply);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getSupplies(req, res, next) {
    try {
      const supplies = await Supply.findAll({
        order: [["createdAt", "DESC"]],
      });
      return res.json(supplies);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async exportCsv(req, res, next) {
    try {
      const { id } = req.params;

      const boxes = await WarehouseBox.findAll({
        where: { supplyId: id },
        include: [{ model: Section, as: "currentSection" }],
        order: [["id", "ASC"]],
      });

      if (!boxes || boxes.length === 0) {
        return next(ApiError.badRequest("–ù–µ—Ç –∫–æ—Ä–æ–±–æ–∫ –≤ —ç—Ç–æ–π –ø–æ—Å—Ç–∞–≤–∫–µ"));
      }

      let csvContent = "\uFEFF";
      csvContent += "ID;ShortCode;Label;Quantity;Unit;Section;QRCode\n";

      boxes.forEach((box) => {
        const section = box.currentSection ? box.currentSection.title : "";
        const row = [
          box.id,
          box.shortCode || "",
          box.label,
          box.quantity,
          box.unit,
          section,
          box.qrCode,
        ]
          .map((field) => `"${String(field).replace(/"/g, '""')}"`)
          .join(";");

        csvContent += row + "\n";
      });

      res.header("Content-Type", "text/csv; charset=utf-8");
      res.attachment(`supply_${id}_labels.csv`);
      return res.send(csvContent);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new SupplyController();

================================================================================
FILE: QMS-Server-master/db.js
================================================================================

const {Sequelize} = require('sequelize')

module.exports = new Sequelize(
    process.env.DB_NAME,
    process.env.DB_USER,
    process.env.DB_PASSWORD,
    {
        dialect: 'postgres',
        host: process.env.DB_HOST,
        port: process.env.DB_PORT

    }
)
================================================================================
FILE: QMS-Server-master/docker-compose.yml
================================================================================

services:
  postgres:
    image: postgres:16-alpine
    container_name: asvo-qms-db
    environment:
      POSTGRES_DB: asvo_qms
      POSTGRES_USER: qms
      POSTGRES_PASSWORD: qms_dev_2026
    command: ["postgres","-c","listen_addresses=0.0.0.0"]
    ports:
      - "127.0.0.1:5434:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped
volumes:
  pgdata:

================================================================================
FILE: QMS-Server-master/error/ApiError.js
================================================================================

class ApiError extends Error {
  constructor(status, message) {
    super();
    this.status = status;
    this.message = message;
  }


  static badRequest(message) {
    return new ApiError(400, message);
  }


  static notFound(message) {
    return new ApiError(404, message);
  }


  static internal(message) {
    return new ApiError(500, message);
  }


  static forbidden(message) {
    return new ApiError(403, message);
  }


  static unauthorized(message) {
    return new ApiError(401, message);
  }
}

module.exports = ApiError;

================================================================================
FILE: QMS-Server-master/fonts/README.md
================================================================================

# MES-Kryptonit-Server-master

================================================================================
FILE: QMS-Server-master/index.js
================================================================================

require("dotenv").config();
const express = require("express");
const sequelize = require("./db");
const models = require("./models/index");
const cors = require("cors");
const fileUpload = require("express-fileupload");
const router = require("./routes/index");
const errorHandler = require("./middleware/ErrorHandlingMiddleware");
const path = require("path");

const PORT = process.env.PORT || 5000;
const app = express();

app.use(express.json());

const corsOptions = {
  origin: "*",
  credentials: true,
  optionSuccessStatus: 200,
};

app.use(cors(corsOptions));
app.use(express.static(path.resolve(__dirname, "static")));
app.use(fileUpload({}));


app.use("/api", router);


app.use(errorHandler);

const initInitialData = async () => {
  try {
    console.log(">>> [RBAC] –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Ä–æ–ª–µ–π –∏ –ø—Ä–∞–≤...");


    const permissions = [

      { code: "rbac.manage", description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –∏ –º–∞—Ç—Ä–∏—Ü–µ–π –ø—Ä–∞–≤" },
      { code: "users.manage", description: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º" },


      { code: "warehouse.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Å—Ç–∞—Ç–∫–æ–≤" },
      { code: "warehouse.manage", description: "–ü—Ä–∏–µ–º–∫–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–æ–±–æ–∫, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ" },
      { code: "labels.print", description: "–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–æ–∫" },

      
      { code: "dms.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–µ—Å—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" },
      { code: "dms.create", description: "–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" },
      { code: "dms.approve", description: "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" },
      { code: "dms.manage", description: "–í–≤–µ–¥–µ–Ω–∏–µ –≤ –¥–µ–π—Å—Ç–≤–∏–µ, —Ä–∞—Å—Å—ã–ª–∫–∞" },
      
      { code: "qms.audit.view", description: "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞—É–¥–∏—Ç-–ª–æ–≥" },
      { code: "qms.audit.verify", description: "–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è hash-chain" },
      { code: "qms.audit.report", description: "–û—Ç—á—ë—Ç—ã –¥–ª—è –∏–Ω—Å–ø–µ–∫—Ü–∏–∏" },
      
      { code: "nc.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π" },
      { code: "nc.create", description: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è NC" },
      { code: "nc.manage", description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NC" },
      
      { code: "capa.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä CAPA" },
      { code: "capa.create", description: "–°–æ–∑–¥–∞–Ω–∏–µ CAPA" },
      { code: "capa.manage", description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ CAPA" },
      { code: "capa.verify", description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ CAPA" },
    ];


    for (const p of permissions) {
      await models.Ability.findOrCreate({ where: { code: p.code }, defaults: p });
    }


    const rolesData = {
      SUPER_ADMIN: "–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø (DevOps/Admin)",
      QC_ENGINEER: "–ò–Ω–∂–µ–Ω–µ—Ä –û–¢–ö",
      WAREHOUSE_MASTER: "–ö–ª–∞–¥–æ–≤—â–∏–∫",
    };

    for (const [name, desc] of Object.entries(rolesData)) {
      await models.Role.findOrCreate({
        where: { name },
        defaults: { description: desc }
      });
    }


    const assign = async (roleName, slugs) => {
      const role = await models.Role.findOne({ where: { name: roleName } });
      if (!role) return;

      let abilities;
      if (slugs === '*') {

        abilities = await models.Ability.findAll();
      } else {
        abilities = await models.Ability.findAll({ where: { code: slugs } });
      }

      if (abilities.length) {
        await role.setAbilities(abilities);
      }
    };


    await assign("SUPER_ADMIN", '*');

    await assign("WAREHOUSE_MASTER", [
      "warehouse.view", "warehouse.manage", "labels.print"
    ]);

    await assign("QC_ENGINEER", [
      "warehouse.view",
      "nc.view", "nc.create", "nc.manage",
      "capa.view", "capa.create", "capa.manage", "capa.verify",
      "qms.audit.view",
    ]);

    console.log(">>> [RBAC] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.");
  } catch (e) {
    console.error(">>> [RBAC] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
  }
};

const start = async () => {
  try {
    await sequelize.authenticate();



    await initInitialData();

    app.listen(PORT, () => console.log(`Server started on port ${PORT}`));
  } catch (e) {
    console.log(e);
  }
};

start();

================================================================================
FILE: QMS-Server-master/jest.config.js
================================================================================

module.exports = {
  testEnvironment: 'node',
  coveragePathIgnorePatterns: [
    "/node_modules/"
  ]
};
================================================================================
FILE: QMS-Server-master/middleware/ErrorHandlingMiddleware.js
================================================================================

const ApiError = require("../error/ApiError");

module.exports = function (err, req, res, next) {

    const time = new Date().toISOString().replace('T', ' ').substring(0, 19);
    console.error(`\x1b[31m[${time}] ERROR:\x1b[0m ${req.method} ${req.url}`);


    if (!(err instanceof ApiError)) {
        console.error(err);
    } else {
        console.error(`ApiError: ${err.message}`);
    }


    if (err instanceof ApiError) {
        return res.status(err.status).json({
            message: err.message,
            errors: err.errors
        });
    }


    if (err.name === 'UnauthorizedError' || err.status === 401) {
        return res.status(401).json({
            message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (Invalid Token)"
        });
    }
    if (err.name === 'InvalidTokenError') {
        return res.status(401).json({
            message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç–µ–∫"
        });
    }
    if (err.status === 403) {
        return res.status(403).json({
            message: "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (Forbidden)"
        });
    }


    if (err.name === 'SequelizeUniqueConstraintError') {

        return res.status(409).json({
            message: "–ó–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
            details: err.errors.map(e => e.message)
        });
    }

    if (err.name === 'SequelizeValidationError') {
        return res.status(400).json({
            message: "–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö",
            details: err.errors.map(e => e.message)
        });
    }

    if (err.name === 'SequelizeConnectionError') {
        return res.status(503).json({
            message: "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
        });
    }


    return res.status(500).json({
        message: "–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
        error: process.env.NODE_ENV === 'development' ? err.message : undefined
    });
};

================================================================================
FILE: QMS-Server-master/middleware/authMiddleware.js
================================================================================

const { auth } = require('express-oauth2-jwt-bearer');

const checkJwt = auth({
  audience: 'account',
  issuerBaseURL: 'http://keycloak.local/realms/MES-Realm',
  tokenSigningAlg: 'RS256'
});

module.exports = checkJwt;

================================================================================
FILE: QMS-Server-master/middleware/checkAbilityMiddleware.js
================================================================================

const ApiError = require("../error/ApiError");

module.exports = function (requiredSlug) {
    return function (req, res, next) {
        if (req.method === "OPTIONS") return next();

        try {
            const user = req.user;
            if (!user) return next(ApiError.unauthorized("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"));


            if (user.role === 'SUPER_ADMIN') {
                return next();
            }


            if (user.abilities && user.abilities.includes(requiredSlug)) {
                return next();
            }

            return next(ApiError.forbidden(`–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∞–≤–æ: ${requiredSlug}`));

        } catch (e) {
            return next(ApiError.internal("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤"));
        }
    };
};

================================================================================
FILE: QMS-Server-master/middleware/checkRoleMiddleware.js
================================================================================

module.exports = function (role) {
  return function (req, res, next) {
    if (req.method === "OPTIONS") {
      return next();
    }

    try {
      if (!req.user) {
        return res.status(401).json({ message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (Backend Error)" });
      }

      if (req.user.role !== role) {
        return res.status(403).json({
            message: `–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å ${role}, —É –≤–∞—Å ${req.user.role}`
        });
      }

      next();
    } catch (e) {
      console.error("CheckRole Error:", e);
      return res.status(500).json({ message: "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏" });
    }
  };
};

================================================================================
FILE: QMS-Server-master/middleware/syncUserMiddleware.js
================================================================================



const { User, Role, Ability } = require('../models/index');

module.exports = async function (req, res, next) {


    if (req.method === "OPTIONS") return next();

    try {

        if (!req.auth || !req.auth.payload) {
            console.error("‚ùå –û–®–ò–ë–ö–ê: authMiddleware –Ω–µ –ø–µ—Ä–µ–¥–∞–ª payload. –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω.");
            return res.status(401).json({ message: "Invalid token payload" });
        }

        const payload = req.auth.payload;


        const keycloakUUID = payload.sub;


        const login = payload.preferred_username || payload.nickname || payload.email;

        if (!login) {
            console.error("‚ùå –û–®–ò–ë–ö–ê: –í —Ç–æ–∫–µ–Ω–µ –Ω–µ—Ç –ø–æ–ª—è login (preferred_username/nickname/email).");
            return res.status(500).json({ message: "Token structure error: missing username" });
        }

        const name = payload.given_name || login;
        const surname = payload.family_name || '';


        const kcRoles = payload.realm_access?.roles || [];


        const priorityRoles = [
            "SUPER_ADMIN",
            "PRODUCTION_CHIEF",
            "TECHNOLOGIST",
            "WAREHOUSE_MASTER",
            "QC_ENGINEER",
            "FIRMWARE_OPERATOR",
            "ASSEMBLER"
        ];


        const mainRole = priorityRoles.find(r => kcRoles.includes(r)) || "ASSEMBLER";


        let user = await User.findOne({ where: { login } });

        if (!user) {
            console.log(`‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${login} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–µ–º —Å —Ä–æ–ª—å—é ${mainRole}...`);
            try {
                user = await User.create({
                    login,
                    name,
                    surname,
                    role: mainRole,
                    password: 'sso_managed_account',
                    img: null
                });
                console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω. ID: ${user.id}`);
            } catch (dbError) {
                console.error("‚ùå –û–®–ò–ë–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:", dbError);
                return res.status(500).json({ message: "DB Error during user creation" });
            }
        } else {

            if (user.role !== mainRole) {
                console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${login}: ${user.role} -> ${mainRole}`);
                user.role = mainRole;
                await user.save();
            }
        }


        let abilities = [];
        try {
            const roleEntity = await Role.findOne({
                where: { name: mainRole },
                include: [{
                    model: Ability,
                    as: "abilities",
                    through: { attributes: [] }
                }]
            });

            if (roleEntity && roleEntity.abilities) {
                abilities = roleEntity.abilities.map(ab => ab.code);
            }
        } catch (e) {
            console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∞–≤ (abilities):", e.message);
        }


        req.user = {
            id: user.id,
            login: user.login,
            name: user.name,
            surname: user.surname,
            role: user.role,
            roles: kcRoles,
            abilities: abilities,
            keycloakId: keycloakUUID
        };

        next();

    } catch (e) {
        console.error("üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ syncUserMiddleware:", e);
        return res.status(500).json({ message: "Sync Middleware Crash", error: e.message });
    }
};

================================================================================
FILE: QMS-Server-master/migrations/20250126-add-structure-manager-fields.js
================================================================================

'use strict';


module.exports = {
  async up(queryInterface, Sequelize) {
    console.log('üöÄ –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è managerId –∏ teamLeadId...');


    await queryInterface.addColumn('production_section', 'managerId', {
      type: Sequelize.INTEGER,
      allowNull: true,
      references: {
        model: 'users',
        key: 'id'
      },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    }).then(() => console.log('‚úÖ managerId –¥–æ–±–∞–≤–ª–µ–Ω –≤ production_section'))
      .catch(() => console.log('‚ö†Ô∏è managerId —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ production_section'));


    await queryInterface.addColumn('production_team', 'teamLeadId', {
      type: Sequelize.INTEGER,
      allowNull: true,
      references: {
        model: 'users',
        key: 'id'
      },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    }).then(() => console.log('‚úÖ teamLeadId –¥–æ–±–∞–≤–ª–µ–Ω –≤ production_team'))
      .catch(() => console.log('‚ö†Ô∏è teamLeadId —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ production_team'));

    console.log('üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.removeColumn('production_section', 'managerId')
      .catch(() => console.log('managerId –Ω–µ –Ω–∞–π–¥–µ–Ω'));

    await queryInterface.removeColumn('production_team', 'teamLeadId')
      .catch(() => console.log('teamLeadId –Ω–µ –Ω–∞–π–¥–µ–Ω'));
  }
};

================================================================================
FILE: QMS-Server-master/migrations/20260209-create-core.js
================================================================================

"use strict";

module.exports = {
  async up(queryInterface, Sequelize) {
    const t = await queryInterface.sequelize.transaction();
    try {
      const has = async (name) => {
        const r = await queryInterface.sequelize.query(
          `SELECT to_regclass('public.${name}') AS t`,
          { type: Sequelize.QueryTypes.SELECT, transaction: t }
        );
        return !!r?.[0]?.t;
      };

      
      if (!(await has("abilities"))) {
        await queryInterface.createTable(
          "abilities",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            code: { type: Sequelize.STRING(128), allowNull: false, unique: true },
            description: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      if (!(await has("roles"))) {
        await queryInterface.createTable(
          "roles",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            code: { type: Sequelize.STRING(128), allowNull: false, unique: true },
            name: { type: Sequelize.STRING(255), allowNull: false },
            description: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      if (!(await has("role_abilities"))) {
        await queryInterface.createTable(
          "role_abilities",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            roleId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "roles", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            abilityId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "abilities", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );

        await queryInterface.addIndex(
          "role_abilities",
          ["roleId", "abilityId"],
          { unique: true, name: "uq_role_abilities_role_ability", transaction: t }
        );
      }

      
      if (!(await has("production_section"))) {
        await queryInterface.createTable(
          "production_section",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            name: { type: Sequelize.STRING(255), allowNull: false },
            description: { type: Sequelize.TEXT, allowNull: true },
            managerId: { type: Sequelize.INTEGER, allowNull: true }, 
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      if (!(await has("production_team"))) {
        await queryInterface.createTable(
          "production_team",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            name: { type: Sequelize.STRING(255), allowNull: false },
            sectionId: { type: Sequelize.INTEGER, allowNull: true }, 
            teamLeadId: { type: Sequelize.INTEGER, allowNull: true }, 
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("users"))) {
        await queryInterface.createTable(
          "users",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            email: { type: Sequelize.STRING(255), allowNull: true, unique: true },
            login: { type: Sequelize.STRING(255), allowNull: true, unique: true },
            password: { type: Sequelize.STRING(255), allowNull: true },
            roleId: {
              type: Sequelize.INTEGER,
              allowNull: true,
              references: { model: "roles", key: "id" },
              onDelete: "SET NULL",
              onUpdate: "CASCADE",
            },
            teamId: {
              type: Sequelize.INTEGER,
              allowNull: true,
              references: { model: "production_team", key: "id" },
              onDelete: "SET NULL",
              onUpdate: "CASCADE",
            },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("pcs"))) {
        await queryInterface.createTable(
          "pcs",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            name: { type: Sequelize.STRING(255), allowNull: true },
            ip: { type: Sequelize.STRING(64), allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      if (!(await has("sessions"))) {
        await queryInterface.createTable(
          "sessions",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            userId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "users", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            PCId: {
              type: Sequelize.INTEGER,
              allowNull: true,
              references: { model: "pcs", key: "id" },
              onDelete: "SET NULL",
              onUpdate: "CASCADE",
            },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("audit_logs"))) {
        await queryInterface.createTable(
          "audit_logs",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            userId: {
              type: Sequelize.INTEGER,
              allowNull: true,
              references: { model: "users", key: "id" },
              onDelete: "SET NULL",
              onUpdate: "CASCADE",
            },
            entity: { type: Sequelize.STRING(255), allowNull: true },
            entityId: { type: Sequelize.STRING(255), allowNull: true },
            action: { type: Sequelize.STRING(255), allowNull: true },
            message: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      
      
      
      
      

      await t.commit();
      console.log("‚úÖ [CORE] –±–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã");
    } catch (e) {
      await t.rollback();
      throw e;
    }
  },

  async down(queryInterface, Sequelize) {
    const t = await queryInterface.sequelize.transaction();
    try {
      await queryInterface.dropTable("audit_logs", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("sessions", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("pcs", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("users", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("production_team", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("production_section", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("role_abilities", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("roles", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("abilities", { transaction: t }).catch(() => {});
      await t.commit();
    } catch (e) {
      await t.rollback();
      throw e;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260210-audit-hashchain.js
================================================================================

"use strict";









module.exports = {
  async up(queryInterface, Sequelize) {
    
    const reg = await queryInterface.sequelize.query(
      `SELECT to_regclass('public.audit_logs') AS t`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    if (!reg?.[0]?.t) {
      console.log("‚ö†Ô∏è [audit-hashchain] –¢–∞–±–ª–∏—Ü–∞ public.audit_logs –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é");
      return;
    }

    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      const table = await queryInterface.describeTable("audit_logs");

      
      if (!table.chainIndex) {
        await queryInterface.addColumn(
          "audit_logs",
          "chainIndex",
          {
            type: Sequelize.BIGINT,
            allowNull: true, 
            unique: true,
          },
          { transaction }
        );
      }

      if (!table.prevHash) {
        await queryInterface.addColumn(
          "audit_logs",
          "prevHash",
          {
            type: Sequelize.STRING(64),
            allowNull: true,
          },
          { transaction }
        );
      }

      if (!table.currentHash) {
        await queryInterface.addColumn(
          "audit_logs",
          "currentHash",
          {
            type: Sequelize.STRING(64),
            allowNull: true,
          },
          { transaction }
        );
      }

      if (!table.dataHash) {
        await queryInterface.addColumn(
          "audit_logs",
          "dataHash",
          {
            type: Sequelize.STRING(64),
            allowNull: true,
          },
          { transaction }
        );
      }

      
      if (!table.signedBy) {
        await queryInterface.addColumn(
          "audit_logs",
          "signedBy",
          {
            type: Sequelize.INTEGER,
            allowNull: true,
            comment: "userId –∫—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–ø–∏—Å—å (—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å)",
          },
          { transaction }
        );
      }

      if (!table.signedAt) {
        await queryInterface.addColumn(
          "audit_logs",
          "signedAt",
          {
            type: Sequelize.DATE,
            allowNull: true,
          },
          { transaction }
        );
      }

      
      if (!table.severity) {
        await queryInterface.addColumn(
          "audit_logs",
          "severity",
          {
            type: Sequelize.ENUM("INFO", "WARNING", "CRITICAL", "SECURITY"),
            allowNull: false,
            defaultValue: "INFO",
          },
          { transaction }
        );
      }

      
      
      const indexes = await queryInterface.sequelize.query(
        `SELECT indexname FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'audit_logs'`,
        { type: Sequelize.QueryTypes.SELECT, transaction }
      );
      const idx = new Set((indexes || []).map((r) => r.indexname));

      if (!idx.has("idx_audit_chain_index")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["chainIndex"],
          {
            name: "idx_audit_chain_index",
            unique: true,
            
            where: { chainIndex: { [Sequelize.Op.ne]: null } },
            transaction,
          }
        );
      }

      if (!idx.has("idx_audit_current_hash")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["currentHash"],
          { name: "idx_audit_current_hash", transaction }
        );
      }

      if (!idx.has("idx_audit_severity")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["severity"],
          { name: "idx_audit_severity", transaction }
        );
      }

      if (!idx.has("idx_audit_entity_lookup")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["entity", "entityId"],
          { name: "idx_audit_entity_lookup", transaction }
        );
      }

      if (!idx.has("idx_audit_created_at")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["createdAt"],
          { name: "idx_audit_created_at", transaction }
        );
      }

      await transaction.commit();
      console.log("‚úÖ [audit-hashchain] –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },

  async down(queryInterface, Sequelize) {
    
    const reg = await queryInterface.sequelize.query(
      `SELECT to_regclass('public.audit_logs') AS t`,
      { type: Sequelize.QueryTypes.SELECT }
    );
    if (!reg?.[0]?.t) {
      console.log("‚ö†Ô∏è [audit-hashchain] –¢–∞–±–ª–∏—Ü–∞ public.audit_logs –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî down –ø—Ä–æ–ø—É—Å–∫–∞–µ–º");
      return;
    }

    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      const indexes = await queryInterface.sequelize.query(
        `SELECT indexname FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'audit_logs'`,
        { type: Sequelize.QueryTypes.SELECT, transaction }
      );
      const idx = new Set((indexes || []).map((r) => r.indexname));

      if (idx.has("idx_audit_created_at")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_created_at", { transaction });
      }
      if (idx.has("idx_audit_entity_lookup")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_entity_lookup", { transaction });
      }
      if (idx.has("idx_audit_severity")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_severity", { transaction });
      }
      if (idx.has("idx_audit_current_hash")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_current_hash", { transaction });
      }
      if (idx.has("idx_audit_chain_index")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_chain_index", { transaction });
      }

      
      const table = await queryInterface.describeTable("audit_logs");

      if (table.severity) {
        await queryInterface.removeColumn("audit_logs", "severity", { transaction });
      }
      if (table.signedAt) {
        await queryInterface.removeColumn("audit_logs", "signedAt", { transaction });
      }
      if (table.signedBy) {
        await queryInterface.removeColumn("audit_logs", "signedBy", { transaction });
      }
      if (table.dataHash) {
        await queryInterface.removeColumn("audit_logs", "dataHash", { transaction });
      }
      if (table.currentHash) {
        await queryInterface.removeColumn("audit_logs", "currentHash", { transaction });
      }
      if (table.prevHash) {
        await queryInterface.removeColumn("audit_logs", "prevHash", { transaction });
      }
      if (table.chainIndex) {
        await queryInterface.removeColumn("audit_logs", "chainIndex", { transaction });
      }

      
      
      await queryInterface.sequelize.query(
        'DROP TYPE IF EXISTS "enum_audit_logs_severity";',
        { transaction }
      );

      await transaction.commit();
      console.log("‚úÖ [audit-hashchain] Down –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260210-create-dms.js
================================================================================

"use strict";















module.exports = {
  async up(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      await queryInterface.createTable("documents", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true,
        },
        code: {
          type: Sequelize.STRING(50),
          allowNull: false,
          unique: true,
          comment: "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞: –°–¢–û-–°–ú–ö-001, –†–ò-–ü–†-003 –∏ —Ç.–¥.",
        },
        title: {
          type: Sequelize.STRING(500),
          allowNull: false,
        },
        type: {
          type: Sequelize.ENUM(
            "POLICY",           
            "MANUAL",           
            "PROCEDURE",        
            "WORK_INSTRUCTION", 
            "FORM",             
            "RECORD",           
            "SPECIFICATION",    
            "PLAN",             
            "EXTERNAL",         
            "OTHER"
          ),
          allowNull: false,
        },
        category: {
          type: Sequelize.STRING(100),
          allowNull: true,
          comment: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ, –ó–∞–∫—É–ø–∫–∏, –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏ –∏ —Ç.–¥.",
        },
        description: {
          type: Sequelize.TEXT,
          allowNull: true,
        },
        status: {
          type: Sequelize.ENUM(
            "DRAFT",      
            "REVIEW",     
            "APPROVED",   
            "EFFECTIVE",  
            "REVISION",   
            "OBSOLETE",   
            "CANCELLED"   
          ),
          allowNull: false,
          defaultValue: "DRAFT",
        },
        currentVersionId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          comment: "FK –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–µ–π—Å—Ç–≤—É—é—â—É—é –≤–µ—Ä—Å–∏—é",
        },
        ownerId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
          comment: "–í–ª–∞–¥–µ–ª–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å)",
        },
        reviewCycleMonths: {
          type: Sequelize.INTEGER,
          allowNull: true,
          defaultValue: 12,
          comment: "–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞ –≤ –º–µ—Å—è—Ü–∞—Ö",
        },
        nextReviewDate: {
          type: Sequelize.DATEONLY,
          allowNull: true,
          comment: "–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞–Ω–æ–≤–æ–≥–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞",
        },
        effectiveDate: {
          type: Sequelize.DATEONLY,
          allowNull: true,
          comment: "–î–∞—Ç–∞ –≤–≤–µ–¥–µ–Ω–∏—è –≤ –¥–µ–π—Å—Ç–≤–∏–µ",
        },
        obsoleteDate: {
          type: Sequelize.DATEONLY,
          allowNull: true,
        },
        replacedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "documents", key: "id" },
          comment: "–ö–∞–∫–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –∑–∞–º–µ–Ω—ë–Ω (–µ—Å–ª–∏ OBSOLETE)",
        },
        
        isoSection: {
          type: Sequelize.STRING(20),
          allowNull: true,
          comment: "–†–∞–∑–¥–µ–ª ISO 13485: 4.2, 7.5.1 –∏ —Ç.–¥.",
        },
        tags: {
          type: Sequelize.ARRAY(Sequelize.STRING),
          allowNull: true,
          defaultValue: [],
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("document_versions", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true,
        },
        documentId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "documents", key: "id" },
          onDelete: "CASCADE",
        },
        version: {
          type: Sequelize.STRING(20),
          allowNull: false,
          comment: "–ù–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏: 1.0, 1.1, 2.0",
        },
        versionNumber: {
          type: Sequelize.INTEGER,
          allowNull: false,
          comment: "–ß–∏—Å–ª–æ–≤–æ–π –Ω–æ–º–µ—Ä –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (1, 2, 3...)",
        },
        status: {
          type: Sequelize.ENUM("DRAFT", "REVIEW", "APPROVED", "EFFECTIVE", "SUPERSEDED", "REJECTED"),
          allowNull: false,
          defaultValue: "DRAFT",
        },
        changeDescription: {
          type: Sequelize.TEXT,
          allowNull: true,
          comment: "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π",
        },
        fileUrl: {
          type: Sequelize.STRING(1000),
          allowNull: true,
          comment: "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–æ–∫—É–º–µ–Ω—Ç–∞",
        },
        fileName: {
          type: Sequelize.STRING(500),
          allowNull: true,
        },
        fileSize: {
          type: Sequelize.INTEGER,
          allowNull: true,
        },
        fileMimeType: {
          type: Sequelize.STRING(100),
          allowNull: true,
        },
        fileHash: {
          type: Sequelize.STRING(64),
          allowNull: true,
          comment: "SHA-256 —Ö–µ—à —Ñ–∞–π–ª–∞ ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–º–µ–Ω—ã",
        },
        
        content: {
          type: Sequelize.TEXT,
          allowNull: true,
          comment: "–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–¥–ª—è —Ñ–æ—Ä–º, —à–∞–±–ª–æ–Ω–æ–≤)",
        },
        createdById: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        approvedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
        },
        approvedAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        effectiveAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        supersededAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("document_approvals", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true,
        },
        versionId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "document_versions", key: "id" },
          onDelete: "CASCADE",
        },
        step: {
          type: Sequelize.INTEGER,
          allowNull: false,
          defaultValue: 1,
          comment: "–ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —à–∞–≥–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è",
        },
        role: {
          type: Sequelize.ENUM(
            "REVIEWER",       
            "APPROVER",       
            "QUALITY_OFFICER" 
          ),
          allowNull: false,
        },
        assignedToId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        decision: {
          type: Sequelize.ENUM("PENDING", "APPROVED", "REJECTED", "RETURNED"),
          allowNull: false,
          defaultValue: "PENDING",
        },
        comment: {
          type: Sequelize.TEXT,
          allowNull: true,
        },
        decidedAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        dueDate: {
          type: Sequelize.DATEONLY,
          allowNull: true,
          comment: "–°—Ä–æ–∫ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è",
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("document_distributions", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true,
        },
        versionId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "document_versions", key: "id" },
          onDelete: "CASCADE",
        },
        userId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        distributedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.NOW,
        },
        acknowledged: {
          type: Sequelize.BOOLEAN,
          allowNull: false,
          defaultValue: false,
          comment: "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ",
        },
        acknowledgedAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.addIndex("documents", ["code"], { unique: true, transaction });
      await queryInterface.addIndex("documents", ["status"], { transaction });
      await queryInterface.addIndex("documents", ["type"], { transaction });
      await queryInterface.addIndex("documents", ["ownerId"], { transaction });
      await queryInterface.addIndex("documents", ["nextReviewDate"], { transaction });

      await queryInterface.addIndex("document_versions", ["documentId", "versionNumber"], {
        unique: true, transaction,
      });
      await queryInterface.addIndex("document_versions", ["status"], { transaction });

      await queryInterface.addIndex("document_approvals", ["versionId", "step"], { transaction });
      await queryInterface.addIndex("document_approvals", ["assignedToId", "decision"], { transaction });

      await queryInterface.addIndex("document_distributions", ["versionId", "userId"], {
        unique: true, transaction,
      });
      await queryInterface.addIndex("document_distributions", ["userId", "acknowledged"], { transaction });

      await transaction.commit();
      console.log("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è DMS –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: documents, document_versions, document_approvals, document_distributions");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },

  async down(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();
    try {
      await queryInterface.dropTable("document_distributions", { transaction });
      await queryInterface.dropTable("document_approvals", { transaction });
      await queryInterface.dropTable("document_versions", { transaction });
      await queryInterface.dropTable("documents", { transaction });

      
      for (const type of [
        "enum_documents_type",
        "enum_documents_status",
        "enum_document_versions_status",
        "enum_document_approvals_role",
        "enum_document_approvals_decision",
      ]) {
        await queryInterface.sequelize.query(`DROP TYPE IF EXISTS "${type}";`, { transaction });
      }

      await transaction.commit();
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260210-create-nc-capa.js
================================================================================

"use strict";

















module.exports = {
  async up(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      await queryInterface.createTable("nonconformities", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        number: {
          type: Sequelize.STRING(20),
          allowNull: false,
          unique: true,
          comment: "–ù–æ–º–µ—Ä NC: NC-0001, NC-0002...",
        },
        title: { type: Sequelize.STRING(500), allowNull: false },
        description: { type: Sequelize.TEXT, allowNull: false },
        source: {
          type: Sequelize.ENUM(
            "INCOMING_INSPECTION",  
            "IN_PROCESS",           
            "FINAL_INSPECTION",     
            "CUSTOMER_COMPLAINT",   
            "INTERNAL_AUDIT",       
            "EXTERNAL_AUDIT",       
            "SUPPLIER",             
            "FIELD_RETURN",         
            "OTHER"
          ),
          allowNull: false,
        },
        classification: {
          type: Sequelize.ENUM("CRITICAL", "MAJOR", "MINOR"),
          allowNull: false,
          defaultValue: "MINOR",
        },
        status: {
          type: Sequelize.ENUM(
            "OPEN",           
            "INVESTIGATING",  
            "DISPOSITION",    
            "IMPLEMENTING",   
            "VERIFICATION",   
            "CLOSED",         
            "REOPENED"        
          ),
          allowNull: false,
          defaultValue: "OPEN",
        },
        disposition: {
          type: Sequelize.ENUM(
            "USE_AS_IS",          
            "REWORK",             
            "REPAIR",             
            "SCRAP",              
            "RETURN_TO_SUPPLIER", 
            "CONCESSION",         
            "OTHER"
          ),
          allowNull: true,
          comment: "–†–µ—à–µ–Ω–∏–µ –ø–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏",
        },
        dispositionJustification: {
          type: Sequelize.TEXT,
          allowNull: true,
          comment: "–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è USE_AS_IS)",
        },

        
        productType: { type: Sequelize.STRING(100), allowNull: true },
        productSerialNumber: { type: Sequelize.STRING(100), allowNull: true },
        lotNumber: { type: Sequelize.STRING(100), allowNull: true },
        processName: { type: Sequelize.STRING(200), allowNull: true },
        supplierName: { type: Sequelize.STRING(200), allowNull: true },
        warehouseBoxId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          comment: "–°–≤—è–∑—å —Å warehouse_box (–µ—Å–ª–∏ NC –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Å–∫–ª–∞–¥–∞)",
        },
        documentId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          comment: "–°–≤—è–∑—å —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –°–ú–ö (–µ—Å–ª–∏ NC –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É)",
        },

        
        totalQty: { type: Sequelize.INTEGER, allowNull: true, comment: "–û–±—â–µ–µ –∫–æ–ª-–≤–æ –≤ –ø–∞—Ä—Ç–∏–∏" },
        defectQty: { type: Sequelize.INTEGER, allowNull: true, comment: "–ö–æ–ª-–≤–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö" },

        
        rootCause: { type: Sequelize.TEXT, allowNull: true },
        rootCauseMethod: {
          type: Sequelize.STRING(50),
          allowNull: true,
          comment: "–ú–µ—Ç–æ–¥ –∞–Ω–∞–ª–∏–∑–∞: 5WHY, FISHBONE, FMEA –∏ —Ç.–¥.",
        },
        immediateAction: { type: Sequelize.TEXT, allowNull: true, comment: "–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ" },

        
        reportedById: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        assignedToId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
        },
        closedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
        },

        
        detectedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        dueDate: { type: Sequelize.DATEONLY, allowNull: true },
        closedAt: { type: Sequelize.DATE, allowNull: true },

        
        capaRequired: {
          type: Sequelize.BOOLEAN,
          allowNull: false,
          defaultValue: false,
          comment: "–¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ CAPA (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è CRITICAL)",
        },

        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("nc_attachments", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        nonconformityId: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "nonconformities", key: "id" }, onDelete: "CASCADE",
        },
        fileUrl: { type: Sequelize.STRING(1000), allowNull: false },
        fileName: { type: Sequelize.STRING(500), allowNull: false },
        fileSize: { type: Sequelize.INTEGER, allowNull: true },
        fileMimeType: { type: Sequelize.STRING(100), allowNull: true },
        description: { type: Sequelize.STRING(500), allowNull: true },
        uploadedById: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "users", key: "id" },
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("capas", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        number: {
          type: Sequelize.STRING(20),
          allowNull: false,
          unique: true,
          comment: "–ù–æ–º–µ—Ä: CAPA-0001",
        },
        type: {
          type: Sequelize.ENUM("CORRECTIVE", "PREVENTIVE"),
          allowNull: false,
        },
        title: { type: Sequelize.STRING(500), allowNull: false },
        description: { type: Sequelize.TEXT, allowNull: true },
        status: {
          type: Sequelize.ENUM(
            "INITIATED",      
            "INVESTIGATING",  
            "PLANNING",       
            "PLAN_APPROVED",  
            "IMPLEMENTING",   
            "VERIFYING",      
            "EFFECTIVE",      
            "INEFFECTIVE",    
            "CLOSED"          
          ),
          allowNull: false,
          defaultValue: "INITIATED",
        },
        priority: {
          type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH", "URGENT"),
          allowNull: false,
          defaultValue: "MEDIUM",
        },

        
        nonconformityId: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: "nonconformities", key: "id" },
          comment: "–ü–µ—Ä–≤–∏—á–Ω–∞—è NC, –ø–æ—Ä–æ–¥–∏–≤—à–∞—è CAPA",
        },

        
        rootCauseAnalysis: { type: Sequelize.TEXT, allowNull: true },
        rootCauseMethod: { type: Sequelize.STRING(50), allowNull: true },

        
        initiatedById: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "users", key: "id" },
        },
        assignedToId: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: "users", key: "id" },
        },
        approvedById: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: "users", key: "id" },
        },

        
        dueDate: { type: Sequelize.DATEONLY, allowNull: true },
        planApprovedAt: { type: Sequelize.DATE, allowNull: true },
        implementedAt: { type: Sequelize.DATE, allowNull: true },
        closedAt: { type: Sequelize.DATE, allowNull: true },

        
        effectivenessCheckDate: {
          type: Sequelize.DATEONLY, allowNull: true,
          comment: "–î–∞—Ç–∞ –ø–ª–∞–Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (30/60/90 –¥–Ω–µ–π)",
        },
        effectivenessCheckDays: {
          type: Sequelize.INTEGER, allowNull: true, defaultValue: 90,
          comment: "–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä—è—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
        },

        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("capa_actions", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        capaId: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "capas", key: "id" }, onDelete: "CASCADE",
        },
        order: { type: Sequelize.INTEGER, allowNull: false, defaultValue: 1 },
        description: { type: Sequelize.TEXT, allowNull: false },
        assignedToId: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: "users", key: "id" },
        },
        status: {
          type: Sequelize.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "CANCELLED"),
          allowNull: false,
          defaultValue: "PLANNED",
        },
        dueDate: { type: Sequelize.DATEONLY, allowNull: true },
        completedAt: { type: Sequelize.DATE, allowNull: true },
        result: { type: Sequelize.TEXT, allowNull: true },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("capa_verifications", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        capaId: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "capas", key: "id" }, onDelete: "CASCADE",
        },
        verifiedById: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "users", key: "id" },
        },
        isEffective: { type: Sequelize.BOOLEAN, allowNull: false },
        evidence: { type: Sequelize.TEXT, allowNull: true, comment: "–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏" },
        comment: { type: Sequelize.TEXT, allowNull: true },
        verifiedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.addIndex("nonconformities", ["number"], { unique: true, transaction });
      await queryInterface.addIndex("nonconformities", ["status"], { transaction });
      await queryInterface.addIndex("nonconformities", ["source"], { transaction });
      await queryInterface.addIndex("nonconformities", ["classification"], { transaction });
      await queryInterface.addIndex("nonconformities", ["assignedToId"], { transaction });
      await queryInterface.addIndex("nonconformities", ["reportedById"], { transaction });
      await queryInterface.addIndex("nonconformities", ["detectedAt"], { transaction });

      await queryInterface.addIndex("capas", ["number"], { unique: true, transaction });
      await queryInterface.addIndex("capas", ["status"], { transaction });
      await queryInterface.addIndex("capas", ["type"], { transaction });
      await queryInterface.addIndex("capas", ["nonconformityId"], { transaction });
      await queryInterface.addIndex("capas", ["assignedToId"], { transaction });
      await queryInterface.addIndex("capas", ["effectivenessCheckDate"], { transaction });

      await queryInterface.addIndex("capa_actions", ["capaId", "order"], { transaction });
      await queryInterface.addIndex("capa_verifications", ["capaId"], { transaction });

      await transaction.commit();
      console.log("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è NC/CAPA –≤—ã–ø–æ–ª–Ω–µ–Ω–∞");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },

  async down(queryInterface) {
    const transaction = await queryInterface.sequelize.transaction();
    try {
      await queryInterface.dropTable("capa_verifications", { transaction });
      await queryInterface.dropTable("capa_actions", { transaction });
      await queryInterface.dropTable("capas", { transaction });
      await queryInterface.dropTable("nc_attachments", { transaction });
      await queryInterface.dropTable("nonconformities", { transaction });

      for (const type of [
        "enum_nonconformities_source", "enum_nonconformities_classification",
        "enum_nonconformities_status", "enum_nonconformities_disposition",
        "enum_capas_type", "enum_capas_status", "enum_capas_priority",
        "enum_capa_actions_status",
      ]) {
        await queryInterface.sequelize.query(`DROP TYPE IF EXISTS "${type}";`, { transaction });
      }
      await transaction.commit();
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260210-create-rbac.js
================================================================================

"use strict";

module.exports = {
  async up(queryInterface, Sequelize) {
    const t = await queryInterface.sequelize.transaction();
    try {
      const has = async (name) => {
        const r = await queryInterface.sequelize.query(
          `SELECT to_regclass('public.${name}') AS t`,
          { type: Sequelize.QueryTypes.SELECT, transaction: t }
        );
        return !!r?.[0]?.t;
      };

      
      if (!(await has("abilities"))) {
        await queryInterface.createTable(
          "abilities",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            code: { type: Sequelize.STRING(128), allowNull: false, unique: true },
            description: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("roles"))) {
        await queryInterface.createTable(
          "roles",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            code: { type: Sequelize.STRING(128), allowNull: false, unique: true },
            name: { type: Sequelize.STRING(255), allowNull: false },
            description: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("role_abilities"))) {
        await queryInterface.createTable(
          "role_abilities",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            roleId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "roles", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            abilityId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "abilities", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );

        await queryInterface.addIndex(
          "role_abilities",
          ["roleId", "abilityId"],
          { unique: true, name: "uq_role_abilities_role_ability", transaction: t }
        );
      }

      await t.commit();
      console.log("‚úÖ [RBAC] tables created");
    } catch (e) {
      await t.rollback();
      throw e;
    }
  },

  async down(queryInterface, Sequelize) {
    const t = await queryInterface.sequelize.transaction();
    try {
      await queryInterface.dropTable("role_abilities", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("roles", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("abilities", { transaction: t }).catch(() => {});
      await t.commit();
    } catch (e) {
      await t.rollback();
      throw e;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211-p1p2-all-modules.js
================================================================================

"use strict";










module.exports = {
  async up(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      
      

      await queryInterface.createTable("risk_registers", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        riskNumber: { type: Sequelize.STRING, unique: true, allowNull: false },
        title: { type: Sequelize.STRING(500), allowNull: false },
        description: { type: Sequelize.TEXT },
        category: { type: Sequelize.ENUM("PRODUCT", "PROCESS", "SUPPLIER", "REGULATORY", "INFRASTRUCTURE", "HUMAN", "CYBER"), allowNull: false },
        relatedEntity: { type: Sequelize.STRING },
        relatedEntityId: { type: Sequelize.INTEGER },
        initialProbability: { type: Sequelize.INTEGER, allowNull: false },
        initialSeverity: { type: Sequelize.INTEGER, allowNull: false },
        initialRiskLevel: { type: Sequelize.INTEGER },
        initialRiskClass: { type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL") },
        residualProbability: { type: Sequelize.INTEGER },
        residualSeverity: { type: Sequelize.INTEGER },
        residualRiskLevel: { type: Sequelize.INTEGER },
        residualRiskClass: { type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL") },
        status: { type: Sequelize.ENUM("IDENTIFIED", "ASSESSED", "MITIGATED", "ACCEPTED", "CLOSED", "MONITORING"), defaultValue: "IDENTIFIED" },
        acceptanceDecision: { type: Sequelize.TEXT },
        acceptedBy: { type: Sequelize.INTEGER },
        acceptedAt: { type: Sequelize.DATE },
        ownerId: { type: Sequelize.INTEGER },
        reviewDate: { type: Sequelize.DATE },
        isoClause: { type: Sequelize.STRING },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("risk_assessments", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        riskRegisterId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "risk_registers", key: "id" } },
        assessmentDate: { type: Sequelize.DATE, allowNull: false },
        assessorId: { type: Sequelize.INTEGER, allowNull: false },
        probability: { type: Sequelize.INTEGER, allowNull: false },
        severity: { type: Sequelize.INTEGER, allowNull: false },
        detectability: { type: Sequelize.INTEGER },
        riskLevel: { type: Sequelize.INTEGER },
        riskClass: { type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL") },
        rationale: { type: Sequelize.TEXT },
        assessmentType: { type: Sequelize.ENUM("INITIAL", "PERIODIC", "POST_MITIGATION", "POST_INCIDENT"), defaultValue: "INITIAL" },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("risk_mitigations", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        riskRegisterId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "risk_registers", key: "id" } },
        mitigationType: { type: Sequelize.ENUM("DESIGN", "PROTECTIVE", "INFORMATION", "PROCESS_CONTROL", "TRAINING", "MONITORING"), allowNull: false },
        description: { type: Sequelize.TEXT, allowNull: false },
        responsibleId: { type: Sequelize.INTEGER },
        plannedDate: { type: Sequelize.DATE },
        completedDate: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "VERIFIED", "INEFFECTIVE"), defaultValue: "PLANNED" },
        verifiedBy: { type: Sequelize.INTEGER },
        verifiedAt: { type: Sequelize.DATE },
        verificationNotes: { type: Sequelize.TEXT },
        capaId: { type: Sequelize.INTEGER },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("suppliers", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        code: { type: Sequelize.STRING, unique: true, allowNull: false },
        name: { type: Sequelize.STRING(500), allowNull: false },
        legalName: { type: Sequelize.STRING(500) },
        inn: { type: Sequelize.STRING(12) },
        address: { type: Sequelize.TEXT },
        contactPerson: { type: Sequelize.STRING },
        phone: { type: Sequelize.STRING },
        email: { type: Sequelize.STRING },
        website: { type: Sequelize.STRING },
        category: { type: Sequelize.ENUM("RAW_MATERIAL", "COMPONENT", "SERVICE", "EQUIPMENT", "PACKAGING", "SOFTWARE", "SUBCONTRACTOR"), allowNull: false },
        criticality: { type: Sequelize.ENUM("CRITICAL", "MAJOR", "MINOR"), defaultValue: "MAJOR" },
        qualificationStatus: { type: Sequelize.ENUM("PENDING", "QUALIFIED", "CONDITIONAL", "DISQUALIFIED", "SUSPENDED"), defaultValue: "PENDING" },
        qualifiedAt: { type: Sequelize.DATE },
        qualifiedBy: { type: Sequelize.INTEGER },
        nextEvaluationDate: { type: Sequelize.DATE },
        hasCertISO9001: { type: Sequelize.BOOLEAN, defaultValue: false },
        hasCertISO13485: { type: Sequelize.BOOLEAN, defaultValue: false },
        certExpiryDate: { type: Sequelize.DATE },
        overallScore: { type: Sequelize.FLOAT },
        notes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("supplier_evaluations", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        supplierId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "suppliers", key: "id" } },
        evaluationDate: { type: Sequelize.DATE, allowNull: false },
        evaluatorId: { type: Sequelize.INTEGER, allowNull: false },
        evaluationType: { type: Sequelize.ENUM("INITIAL", "PERIODIC", "POST_INCIDENT", "REQUALIFICATION"), defaultValue: "PERIODIC" },
        qualityScore: { type: Sequelize.INTEGER },
        deliveryScore: { type: Sequelize.INTEGER },
        documentationScore: { type: Sequelize.INTEGER },
        communicationScore: { type: Sequelize.INTEGER },
        priceScore: { type: Sequelize.INTEGER },
        complianceScore: { type: Sequelize.INTEGER },
        totalScore: { type: Sequelize.FLOAT },
        decision: { type: Sequelize.ENUM("APPROVED", "CONDITIONALLY_APPROVED", "REJECTED", "SUSPENDED") },
        conditions: { type: Sequelize.TEXT },
        comments: { type: Sequelize.TEXT },
        totalOrders: { type: Sequelize.INTEGER, defaultValue: 0 },
        defectiveOrders: { type: Sequelize.INTEGER, defaultValue: 0 },
        lateDeliveries: { type: Sequelize.INTEGER, defaultValue: 0 },
        ncCount: { type: Sequelize.INTEGER, defaultValue: 0 },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("supplier_audits", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        supplierId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "suppliers", key: "id" } },
        auditDate: { type: Sequelize.DATE, allowNull: false },
        auditorId: { type: Sequelize.INTEGER, allowNull: false },
        auditType: { type: Sequelize.ENUM("ON_SITE", "REMOTE", "DOCUMENT"), defaultValue: "ON_SITE" },
        scope: { type: Sequelize.TEXT },
        findings: { type: Sequelize.TEXT },
        findingsCount: { type: Sequelize.INTEGER, defaultValue: 0 },
        majorFindings: { type: Sequelize.INTEGER, defaultValue: 0 },
        minorFindings: { type: Sequelize.INTEGER, defaultValue: 0 },
        result: { type: Sequelize.ENUM("PASS", "CONDITIONAL", "FAIL") },
        nextAuditDate: { type: Sequelize.DATE },
        reportUrl: { type: Sequelize.STRING },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("audit_plans", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        year: { type: Sequelize.INTEGER, allowNull: false },
        title: { type: Sequelize.STRING, allowNull: false },
        approvedBy: { type: Sequelize.INTEGER },
        approvedAt: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("DRAFT", "APPROVED", "IN_PROGRESS", "COMPLETED"), defaultValue: "DRAFT" },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("audit_schedules", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        auditPlanId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "audit_plans", key: "id" } },
        auditNumber: { type: Sequelize.STRING, unique: true, allowNull: false },
        title: { type: Sequelize.STRING, allowNull: false },
        scope: { type: Sequelize.TEXT },
        isoClause: { type: Sequelize.STRING },
        plannedDate: { type: Sequelize.DATE, allowNull: false },
        actualDate: { type: Sequelize.DATE },
        leadAuditorId: { type: Sequelize.INTEGER },
        auditeeId: { type: Sequelize.INTEGER },
        status: { type: Sequelize.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "CANCELLED", "OVERDUE"), defaultValue: "PLANNED" },
        criteria: { type: Sequelize.TEXT },
        conclusion: { type: Sequelize.TEXT },
        reportUrl: { type: Sequelize.STRING },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("audit_findings", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        auditScheduleId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "audit_schedules", key: "id" } },
        findingNumber: { type: Sequelize.STRING, allowNull: false },
        type: { type: Sequelize.ENUM("MAJOR_NC", "MINOR_NC", "OBSERVATION", "OPPORTUNITY", "POSITIVE"), allowNull: false },
        isoClause: { type: Sequelize.STRING },
        description: { type: Sequelize.TEXT, allowNull: false },
        evidence: { type: Sequelize.TEXT },
        nonconformityId: { type: Sequelize.INTEGER },
        capaId: { type: Sequelize.INTEGER },
        responsibleId: { type: Sequelize.INTEGER },
        dueDate: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("OPEN", "ACTION_REQUIRED", "CORRECTED", "VERIFIED", "CLOSED"), defaultValue: "OPEN" },
        closedBy: { type: Sequelize.INTEGER },
        closedAt: { type: Sequelize.DATE },
        closureNotes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("training_plans", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        title: { type: Sequelize.STRING, allowNull: false },
        description: { type: Sequelize.TEXT },
        year: { type: Sequelize.INTEGER, allowNull: false },
        status: { type: Sequelize.ENUM("DRAFT", "APPROVED", "IN_PROGRESS", "COMPLETED"), defaultValue: "DRAFT" },
        approvedBy: { type: Sequelize.INTEGER },
        approvedAt: { type: Sequelize.DATE },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("training_records", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        userId: { type: Sequelize.INTEGER, allowNull: false },
        trainerId: { type: Sequelize.INTEGER },
        trainingPlanId: { type: Sequelize.INTEGER, references: { model: "training_plans", key: "id" } },
        title: { type: Sequelize.STRING, allowNull: false },
        description: { type: Sequelize.TEXT },
        type: { type: Sequelize.ENUM("ONBOARDING", "PROCEDURE", "EQUIPMENT", "GMP", "SAFETY", "REGULATORY", "SOFTWARE", "RETRAINING"), allowNull: false },
        relatedDocumentId: { type: Sequelize.INTEGER },
        trainingDate: { type: Sequelize.DATE, allowNull: false },
        duration: { type: Sequelize.FLOAT },
        assessmentMethod: { type: Sequelize.ENUM("TEST", "PRACTICAL", "OBSERVATION", "SELF_STUDY", "NONE"), defaultValue: "NONE" },
        assessmentScore: { type: Sequelize.FLOAT },
        passed: { type: Sequelize.BOOLEAN },
        confirmedBy: { type: Sequelize.INTEGER },
        confirmedAt: { type: Sequelize.DATE },
        certificateUrl: { type: Sequelize.STRING },
        expiryDate: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("PLANNED", "COMPLETED", "FAILED", "EXPIRED"), defaultValue: "PLANNED" },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("competency_matrices", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        userId: { type: Sequelize.INTEGER, allowNull: false },
        processName: { type: Sequelize.STRING, allowNull: false },
        level: { type: Sequelize.ENUM("NONE", "AWARENESS", "TRAINED", "COMPETENT", "EXPERT"), defaultValue: "NONE" },
        requiredLevel: { type: Sequelize.ENUM("NONE", "AWARENESS", "TRAINED", "COMPETENT", "EXPERT"), defaultValue: "TRAINED" },
        lastTrainingDate: { type: Sequelize.DATE },
        nextTrainingDate: { type: Sequelize.DATE },
        notes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("equipment", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        inventoryNumber: { type: Sequelize.STRING, unique: true, allowNull: false },
        name: { type: Sequelize.STRING, allowNull: false },
        manufacturer: { type: Sequelize.STRING },
        model: { type: Sequelize.STRING },
        serialNumber: { type: Sequelize.STRING },
        type: { type: Sequelize.ENUM("MEASURING", "TEST", "PRODUCTION", "MONITORING", "IT"), allowNull: false },
        location: { type: Sequelize.STRING },
        responsibleId: { type: Sequelize.INTEGER },
        measuringRange: { type: Sequelize.STRING },
        accuracy: { type: Sequelize.STRING },
        resolution: { type: Sequelize.STRING },
        calibrationType: { type: Sequelize.ENUM("VERIFICATION", "CALIBRATION", "VALIDATION", "NONE"), defaultValue: "NONE" },
        calibrationInterval: { type: Sequelize.INTEGER },
        lastCalibrationDate: { type: Sequelize.DATE },
        nextCalibrationDate: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("IN_SERVICE", "OUT_OF_SERVICE", "IN_CALIBRATION", "OVERDUE", "DECOMMISSIONED"), defaultValue: "IN_SERVICE" },
        commissionedDate: { type: Sequelize.DATE },
        decommissionedDate: { type: Sequelize.DATE },
        decommissionReason: { type: Sequelize.TEXT },
        certificateUrl: { type: Sequelize.STRING },
        notes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("calibration_records", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        equipmentId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "equipment", key: "id" } },
        calibrationDate: { type: Sequelize.DATE, allowNull: false },
        performedBy: { type: Sequelize.STRING },
        performedById: { type: Sequelize.INTEGER },
        type: { type: Sequelize.ENUM("VERIFICATION", "CALIBRATION", "ADJUSTMENT"), allowNull: false },
        result: { type: Sequelize.ENUM("PASS", "FAIL", "ADJUSTED", "OUT_OF_TOLERANCE"), allowNull: false },
        measuredValues: { type: Sequelize.JSON },
        certificateNumber: { type: Sequelize.STRING },
        certificateUrl: { type: Sequelize.STRING },
        nextCalibrationDate: { type: Sequelize.DATE },
        impactAssessment: { type: Sequelize.TEXT },
        ncCreated: { type: Sequelize.BOOLEAN, defaultValue: false },
        nonconformityId: { type: Sequelize.INTEGER },
        notes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("management_reviews", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        reviewNumber: { type: Sequelize.STRING, unique: true, allowNull: false },
        title: { type: Sequelize.STRING, allowNull: false },
        reviewDate: { type: Sequelize.DATE, allowNull: false },
        periodFrom: { type: Sequelize.DATE, allowNull: false },
        periodTo: { type: Sequelize.DATE, allowNull: false },
        chairpersonId: { type: Sequelize.INTEGER },
        participants: { type: Sequelize.JSON },
        status: { type: Sequelize.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "APPROVED"), defaultValue: "PLANNED" },
        inputData: { type: Sequelize.JSON },
        outputData: { type: Sequelize.JSON },
        conclusion: { type: Sequelize.TEXT },
        qmsEffectiveness: { type: Sequelize.ENUM("EFFECTIVE", "PARTIALLY_EFFECTIVE", "INEFFECTIVE") },
        minutesUrl: { type: Sequelize.STRING },
        approvedBy: { type: Sequelize.INTEGER },
        approvedAt: { type: Sequelize.DATE },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("review_actions", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        managementReviewId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "management_reviews", key: "id" } },
        description: { type: Sequelize.TEXT, allowNull: false },
        responsibleId: { type: Sequelize.INTEGER },
        deadline: { type: Sequelize.DATE },
        priority: { type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH"), defaultValue: "MEDIUM" },
        category: { type: Sequelize.ENUM("IMPROVEMENT", "RESOURCE", "TRAINING", "PROCESS_CHANGE", "POLICY", "INFRASTRUCTURE") },
        status: { type: Sequelize.ENUM("OPEN", "IN_PROGRESS", "COMPLETED", "OVERDUE", "CANCELLED"), defaultValue: "OPEN" },
        completedAt: { type: Sequelize.DATE },
        completionNotes: { type: Sequelize.TEXT },
        capaId: { type: Sequelize.INTEGER },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      
      
      await queryInterface.addIndex("risk_registers", ["status"], { name: "idx_risk_status", transaction });
      await queryInterface.addIndex("risk_registers", ["initialRiskClass"], { name: "idx_risk_class", transaction });
      await queryInterface.addIndex("risk_registers", ["ownerId"], { name: "idx_risk_owner", transaction });
      await queryInterface.addIndex("suppliers", ["qualificationStatus"], { name: "idx_supplier_status", transaction });
      await queryInterface.addIndex("suppliers", ["category"], { name: "idx_supplier_category", transaction });
      await queryInterface.addIndex("equipment", ["status"], { name: "idx_equip_status", transaction });
      await queryInterface.addIndex("equipment", ["nextCalibrationDate"], { name: "idx_equip_next_cal", transaction });
      await queryInterface.addIndex("training_records", ["userId"], { name: "idx_training_user", transaction });
      await queryInterface.addIndex("competency_matrices", ["userId", "processName"], { name: "idx_competency_user_process", unique: true, transaction });

      await transaction.commit();
      console.log("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è P1+P2 –º–æ–¥—É–ª–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: 17 —Ç–∞–±–ª–∏—Ü —Å–æ–∑–¥–∞–Ω–æ");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },

  async down(queryInterface) {
    const transaction = await queryInterface.sequelize.transaction();
    try {
      const tables = [
        "review_actions", "management_reviews",
        "calibration_records", "equipment",
        "competency_matrices", "training_records", "training_plans",
        "audit_findings", "audit_schedules", "audit_plans",
        "supplier_audits", "supplier_evaluations", "suppliers",
        "risk_mitigations", "risk_assessments", "risk_registers",
      ];
      for (const t of tables) {
        await queryInterface.dropTable(t, { transaction, cascade: true });
      }
      await transaction.commit();
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/seeders/20260121-seed-defect-categories.js
================================================================================

'use strict';


module.exports = {
  async up(queryInterface, Sequelize) {
    const now = new Date();


    const ALL_BOARDS = ["FC", "ELRS_915", "ELRS_2_4", "CORAL_B", "SMARAGD"];
    const SMALL_BOARDS = ["FC", "ELRS_915", "ELRS_2_4", "CORAL_B"];
    const RF_BOARDS = ["ELRS_915", "ELRS_2_4", "CORAL_B"];
    const SMARAGD_ONLY = ["SMARAGD"];

    await queryInterface.bulkInsert('defect_categories', [


      {
        code: 'SOLDER_DEFECT',
        title: '–î–µ—Ñ–µ–∫—Ç –ø–∞–π–∫–∏',
        description: '–•–æ–ª–æ–¥–Ω–∞—è –ø–∞–π–∫–∞, –ø–µ—Ä–µ–º—ã—á–∫–∏, –Ω–µ–ø—Ä–æ–ø–∞–π, —à–∞—Ä–∏–∫–∏ –ø—Ä–∏–ø–æ—è',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'VISUAL_DAMAGE',
        title: '–í–∏–∑—É–∞–ª—å–Ω—ã–π –¥–µ—Ñ–µ–∫—Ç',
        description: '–¶–∞—Ä–∞–ø–∏–Ω—ã, —Å–∫–æ–ª—ã, —Ç—Ä–µ—â–∏–Ω—ã –Ω–∞ –ø–ª–∞—Ç–µ –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö',
        severity: 'MINOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'COMPONENT_DAMAGE',
        title: '–ü–æ–≤—Ä–µ–∂–¥—ë–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç',
        description: '–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–µ –∏–ª–∏ —Ç–µ—Ä–º–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'COMPONENT_MISSING',
        title: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç',
        description: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –æ—Ç–≤–∞–ª–∏–ª—Å—è',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'WRONG_COMPONENT',
        title: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç',
        description: '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ —Ç–æ–≥–æ –Ω–æ–º–∏–Ω–∞–ª–∞ –∏–ª–∏ —Ç–∏–ø–∞',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'ESD_DAMAGE',
        title: '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ ESD',
        description: '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ–º',
        severity: 'CRITICAL',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'TEST_FAIL',
        title: '–ù–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–µ—Å—Ç—ã',
        description: '–ü—Ä–æ–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        code: 'FIRMWARE_FAIL',
        title: '–ù–µ –ø—Ä–æ—à–∏–≤–∞–µ—Ç—Å—è',
        description: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—à–∏–≤–∫–µ firmware, –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ç–æ—Ä–æ–º',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'NO_SERIAL',
        title: '–ù–µ—Ç —Å–µ—Ä–∏–π–Ω–∏–∫–∞',
        description: '–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
        severity: 'MINOR',
        applicableTypes: JSON.stringify(["FC"]),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'USB_FAIL',
        title: '–ù–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ USB',
        description: '–ü–ª–∞—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ USB',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        code: 'RF_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–¥–∏–æ—á–∞—Å—Ç—å—é',
        description: '–°–ª–∞–±—ã–π —Å–∏–≥–Ω–∞–ª, –Ω–µ—Ç —Å–≤—è–∑–∏, –ø–æ–º–µ—Ö–∏',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(RF_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'ANTENNA_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –∞–Ω—Ç–µ–Ω–Ω–æ–π',
        description: '–î–µ—Ñ–µ–∫—Ç —Ä–∞–∑—ä—ë–º–∞ –∞–Ω—Ç–µ–Ω–Ω—ã –∏–ª–∏ —Å–∞–º–æ–π –∞–Ω—Ç–µ–Ω–Ω—ã',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(RF_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'BINDING_FAIL',
        title: '–ù–µ –±–∏–Ω–¥–∏—Ç—Å—è',
        description: '–ù–µ —É–¥–∞—ë—Ç—Å—è —Å–≤—è–∑–∞—Ç—å –ø—Ä–∏—ë–º–Ω–∏–∫ —Å –ø–µ—Ä–µ–¥–∞—Ç—á–∏–∫–æ–º',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(RF_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        code: 'HDD_SSD_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–∏—Å–∫–æ–º',
        description: '–î–∏—Å–∫ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è, –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'DISPLAY_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–∏—Å–ø–ª–µ–µ–º',
        description: '–ë–∏—Ç—ã–µ –ø–∏–∫—Å–µ–ª–∏, –ø–æ–ª–æ—Å—ã, –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è, –∑–∞—Å–≤–µ—Ç—ã',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'KEYBOARD_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π',
        description: '–ù–µ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–ª–∞–≤–∏—à–∏, –∑–∞–ª–∏–ø–∞–Ω–∏–µ, –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'CABLE_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞–±–µ–ª–µ–º/—à–ª–µ–π—Ñ–æ–º',
        description: '–ü–æ–≤—Ä–µ–∂–¥—ë–Ω –∏–ª–∏ –Ω–µ–∏—Å–ø—Ä–∞–≤–µ–Ω –∫–∞–±–µ–ª—å, —à–ª–µ–π—Ñ',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'BOARD_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–ª–∞—Ç–æ–π',
        description: '–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–∞ –ø–ª–∞—Ç–∞ (–ø—Ä–∏—Å–µ–ª–µ–∫—Ç–æ—Ä, –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∏ —Ç.–¥.)',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'POWER_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ –ø–∏—Ç–∞–Ω–∏—è',
        description: '–ù–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è, –ø—Ä–æ–±–ª–µ–º–∞ —Å –ë–ü –∏–ª–∏ –±–∞—Ç–∞—Ä–µ–µ–π',
        severity: 'CRITICAL',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'MEMORY_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–∞–º—è—Ç—å—é',
        description: '–û–ó–£ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–ª–∏ —Å –æ—à–∏–±–∫–∞–º–∏',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'NETWORK_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é',
        description: '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç Ethernet –∏–ª–∏ WiFi',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        code: 'OTHER',
        title: '–ü—Ä–æ—á–µ–µ',
        description: '–î—Ä—É–≥–∏–µ –¥–µ—Ñ–µ–∫—Ç—ã, –Ω–µ –ø–æ–ø–∞–¥–∞—é—â–∏–µ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
        severity: 'MINOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
    ]);
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.bulkDelete('defect_categories', null, {});
  }
};

================================================================================
FILE: QMS-Server-master/models/definitions/Document.js
================================================================================















const sequelize = require("../../db");
const { DataTypes } = require("sequelize");





const DOCUMENT_TYPES = {
  POLICY: "POLICY",
  MANUAL: "MANUAL",
  PROCEDURE: "PROCEDURE",
  WORK_INSTRUCTION: "WORK_INSTRUCTION",
  FORM: "FORM",
  RECORD: "RECORD",
  SPECIFICATION: "SPECIFICATION",
  PLAN: "PLAN",
  EXTERNAL: "EXTERNAL",
  OTHER: "OTHER",
};

const DOCUMENT_STATUSES = {
  DRAFT: "DRAFT",
  REVIEW: "REVIEW",
  APPROVED: "APPROVED",
  EFFECTIVE: "EFFECTIVE",
  REVISION: "REVISION",
  OBSOLETE: "OBSOLETE",
  CANCELLED: "CANCELLED",
};

const VERSION_STATUSES = {
  DRAFT: "DRAFT",
  REVIEW: "REVIEW",
  APPROVED: "APPROVED",
  EFFECTIVE: "EFFECTIVE",
  SUPERSEDED: "SUPERSEDED",
  REJECTED: "REJECTED",
};

const APPROVAL_ROLES = {
  REVIEWER: "REVIEWER",
  APPROVER: "APPROVER",
  QUALITY_OFFICER: "QUALITY_OFFICER",
};

const APPROVAL_DECISIONS = {
  PENDING: "PENDING",
  APPROVED: "APPROVED",
  REJECTED: "REJECTED",
  RETURNED: "RETURNED",
};


const TYPE_CODE_PREFIX = {
  POLICY: "–ü–ö",         
  MANUAL: "–†–ö",         
  PROCEDURE: "–°–¢–û",     
  WORK_INSTRUCTION: "–†–ò", 
  FORM: "–§",            
  RECORD: "–ó–ü",         
  SPECIFICATION: "–°–ü",  
  PLAN: "–ü–õ",           
  EXTERNAL: "–í–ù",       
  OTHER: "–î–û–ö",         
};





const Document = sequelize.define("document", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  code: {
    type: DataTypes.STRING(50),
    allowNull: false,
    unique: true,
    validate: {
      notEmpty: true,
    },
  },
  title: {
    type: DataTypes.STRING(500),
    allowNull: false,
    validate: {
      notEmpty: true,
      len: [3, 500],
    },
  },
  type: {
    type: DataTypes.ENUM(...Object.values(DOCUMENT_TYPES)),
    allowNull: false,
  },
  category: {
    type: DataTypes.STRING(100),
    allowNull: true,
  },
  description: {
    type: DataTypes.TEXT,
    allowNull: true,
  },
  status: {
    type: DataTypes.ENUM(...Object.values(DOCUMENT_STATUSES)),
    allowNull: false,
    defaultValue: DOCUMENT_STATUSES.DRAFT,
  },
  currentVersionId: {
    type: DataTypes.INTEGER,
    allowNull: true,
  },
  ownerId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  reviewCycleMonths: {
    type: DataTypes.INTEGER,
    allowNull: true,
    defaultValue: 12,
  },
  nextReviewDate: {
    type: DataTypes.DATEONLY,
    allowNull: true,
  },
  effectiveDate: {
    type: DataTypes.DATEONLY,
    allowNull: true,
  },
  obsoleteDate: {
    type: DataTypes.DATEONLY,
    allowNull: true,
  },
  replacedById: {
    type: DataTypes.INTEGER,
    allowNull: true,
  },
  isoSection: {
    type: DataTypes.STRING(20),
    allowNull: true,
  },
  tags: {
    type: DataTypes.ARRAY(DataTypes.STRING),
    allowNull: true,
    defaultValue: [],
  },
});

const DocumentVersion = sequelize.define("document_version", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  documentId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  version: {
    type: DataTypes.STRING(20),
    allowNull: false,
  },
  versionNumber: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  status: {
    type: DataTypes.ENUM(...Object.values(VERSION_STATUSES)),
    allowNull: false,
    defaultValue: VERSION_STATUSES.DRAFT,
  },
  changeDescription: {
    type: DataTypes.TEXT,
    allowNull: true,
  },
  fileUrl: {
    type: DataTypes.STRING(1000),
    allowNull: true,
  },
  fileName: {
    type: DataTypes.STRING(500),
    allowNull: true,
  },
  fileSize: {
    type: DataTypes.INTEGER,
    allowNull: true,
  },
  fileMimeType: {
    type: DataTypes.STRING(100),
    allowNull: true,
  },
  fileHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
  },
  content: {
    type: DataTypes.TEXT,
    allowNull: true,
  },
  createdById: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  approvedById: {
    type: DataTypes.INTEGER,
    allowNull: true,
  },
  approvedAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
  effectiveAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
  supersededAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
});

const DocumentApproval = sequelize.define("document_approval", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  versionId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  step: {
    type: DataTypes.INTEGER,
    allowNull: false,
    defaultValue: 1,
  },
  role: {
    type: DataTypes.ENUM(...Object.values(APPROVAL_ROLES)),
    allowNull: false,
  },
  assignedToId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  decision: {
    type: DataTypes.ENUM(...Object.values(APPROVAL_DECISIONS)),
    allowNull: false,
    defaultValue: APPROVAL_DECISIONS.PENDING,
  },
  comment: {
    type: DataTypes.TEXT,
    allowNull: true,
  },
  decidedAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
  dueDate: {
    type: DataTypes.DATEONLY,
    allowNull: true,
  },
});

const DocumentDistribution = sequelize.define("document_distribution", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  versionId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  userId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  distributedAt: {
    type: DataTypes.DATE,
    allowNull: false,
    defaultValue: DataTypes.NOW,
  },
  acknowledged: {
    type: DataTypes.BOOLEAN,
    allowNull: false,
    defaultValue: false,
  },
  acknowledgedAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
});





function setupDocumentAssociations({ User }) {
  
  Document.belongsTo(User, { foreignKey: "ownerId", as: "owner" });
  User.hasMany(Document, { foreignKey: "ownerId", as: "ownedDocuments" });

  
  Document.belongsTo(Document, { foreignKey: "replacedById", as: "replacedBy" });
  Document.hasMany(Document, { foreignKey: "replacedById", as: "replacements" });

  
  Document.hasMany(DocumentVersion, { foreignKey: "documentId", as: "versions", onDelete: "CASCADE" });
  DocumentVersion.belongsTo(Document, { foreignKey: "documentId", as: "document" });

  
  Document.belongsTo(DocumentVersion, { foreignKey: "currentVersionId", as: "currentVersion" });

  
  DocumentVersion.belongsTo(User, { foreignKey: "createdById", as: "createdBy" });
  DocumentVersion.belongsTo(User, { foreignKey: "approvedById", as: "approvedBy" });

  
  DocumentVersion.hasMany(DocumentApproval, { foreignKey: "versionId", as: "approvals", onDelete: "CASCADE" });
  DocumentApproval.belongsTo(DocumentVersion, { foreignKey: "versionId", as: "version" });

  
  DocumentApproval.belongsTo(User, { foreignKey: "assignedToId", as: "assignedTo" });

  
  DocumentVersion.hasMany(DocumentDistribution, { foreignKey: "versionId", as: "distributions", onDelete: "CASCADE" });
  DocumentDistribution.belongsTo(DocumentVersion, { foreignKey: "versionId", as: "version" });

  
  DocumentDistribution.belongsTo(User, { foreignKey: "userId", as: "user" });
  User.hasMany(DocumentDistribution, { foreignKey: "userId", as: "documentDistributions" });
}



module.exports = {
  Document,
  DocumentVersion,
  DocumentApproval,
  DocumentDistribution,
  setupDocumentAssociations,

  
  DOCUMENT_TYPES,
  DOCUMENT_STATUSES,
  VERSION_STATUSES,
  APPROVAL_ROLES,
  APPROVAL_DECISIONS,
  TYPE_CODE_PREFIX,
};

================================================================================
FILE: QMS-Server-master/models/definitions/Equipment.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");





const Equipment = sequelize.define("equipment", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  inventoryNumber: { type: DataTypes.STRING, unique: true, allowNull: false, comment: "–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä" },
  name: { type: DataTypes.STRING, allowNull: false },
  manufacturer: { type: DataTypes.STRING },
  model: { type: DataTypes.STRING },
  serialNumber: { type: DataTypes.STRING, allowNull: true },
  
  type: {
    type: DataTypes.ENUM(
      "MEASURING",       
      "TEST",            
      "PRODUCTION",      
      "MONITORING",      
      "IT"               
    ),
    allowNull: false
  },
  
  
  location: { type: DataTypes.STRING, comment: "–£—á–∞—Å—Ç–æ–∫/—Ü–µ—Ö/–ø–æ–º–µ—â–µ–Ω–∏–µ" },
  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  
  
  measuringRange: { type: DataTypes.STRING, allowNull: true, comment: "–î–∏–∞–ø–∞–∑–æ–Ω –∏–∑–º–µ—Ä–µ–Ω–∏–π" },
  accuracy: { type: DataTypes.STRING, allowNull: true, comment: "–¢–æ—á–Ω–æ—Å—Ç—å/–ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å" },
  resolution: { type: DataTypes.STRING, allowNull: true },
  
  
  calibrationType: { type: DataTypes.ENUM("VERIFICATION", "CALIBRATION", "VALIDATION", "NONE"), defaultValue: "NONE" },
  calibrationInterval: { type: DataTypes.INTEGER, allowNull: true, comment: "–ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–µ—Å—è—Ü–∞—Ö" },
  lastCalibrationDate: { type: DataTypes.DATE, allowNull: true },
  nextCalibrationDate: { type: DataTypes.DATE, allowNull: true },
  
  
  status: {
    type: DataTypes.ENUM("IN_SERVICE", "OUT_OF_SERVICE", "IN_CALIBRATION", "OVERDUE", "DECOMMISSIONED"),
    defaultValue: "IN_SERVICE"
  },
  
  commissionedDate: { type: DataTypes.DATE, allowNull: true },
  decommissionedDate: { type: DataTypes.DATE, allowNull: true },
  decommissionReason: { type: DataTypes.TEXT, allowNull: true },
  
  certificateUrl: { type: DataTypes.STRING, allowNull: true },
  notes: { type: DataTypes.TEXT },
});

const CalibrationRecord = sequelize.define("calibration_record", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  equipmentId: { type: DataTypes.INTEGER, allowNull: false },
  
  calibrationDate: { type: DataTypes.DATE, allowNull: false },
  performedBy: { type: DataTypes.STRING, comment: "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫" },
  performedById: { type: DataTypes.INTEGER, allowNull: true },
  
  type: { type: DataTypes.ENUM("VERIFICATION", "CALIBRATION", "ADJUSTMENT"), allowNull: false },
  
  
  result: { type: DataTypes.ENUM("PASS", "FAIL", "ADJUSTED", "OUT_OF_TOLERANCE"), allowNull: false },
  
  measuredValues: { type: DataTypes.JSON, allowNull: true, comment: "–ò–∑–º–µ—Ä–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: [{reference, measured, deviation}]" },
  
  certificateNumber: { type: DataTypes.STRING, allowNull: true },
  certificateUrl: { type: DataTypes.STRING, allowNull: true },
  
  nextCalibrationDate: { type: DataTypes.DATE, allowNull: true },
  
  
  impactAssessment: { type: DataTypes.TEXT, allowNull: true, comment: "–û—Ü–µ–Ω–∫–∞ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ä–∞–Ω–µ–µ –ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω–Ω—É—é –ø—Ä–æ–¥—É–∫—Ü–∏—é" },
  ncCreated: { type: DataTypes.BOOLEAN, defaultValue: false, comment: "–°–æ–∑–¥–∞–Ω–æ –ª–∏ NC –ø—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ" },
  nonconformityId: { type: DataTypes.INTEGER, allowNull: true },
  
  notes: { type: DataTypes.TEXT },
});


Equipment.hasMany(CalibrationRecord, { as: "calibrations", foreignKey: "equipmentId" });
CalibrationRecord.belongsTo(Equipment, { foreignKey: "equipmentId" });

module.exports = { Equipment, CalibrationRecord };

================================================================================
FILE: QMS-Server-master/models/definitions/General.js
================================================================================











const sequelize = require("../../db");
const { DataTypes } = require("sequelize");



const User = sequelize.define("user", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  login: { type: DataTypes.STRING, unique: true },
  password: { type: DataTypes.STRING },
  role: { type: DataTypes.STRING, defaultValue: "USER" },
  name: { type: DataTypes.STRING },
  surname: { type: DataTypes.STRING },
  img: { type: DataTypes.STRING },
});

const PC = sequelize.define("PC", {
  id: { type: DataTypes.SMALLINT, primaryKey: true, autoIncrement: true },
  ip: { type: DataTypes.STRING, unique: true, allowNull: false },
  pc_name: { type: DataTypes.STRING, allowNull: false },
  cabinet: { type: DataTypes.STRING },
});

const Session = sequelize.define("session", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  online: { type: DataTypes.BOOLEAN },
  PCId: {
    type: DataTypes.SMALLINT,
    allowNull: true,
    references: {
      model: "PCs",
      key: "id",
    },
  },
});



const AuditLog = sequelize.define("audit_log", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  userId: { type: DataTypes.INTEGER, allowNull: true },
  action: { type: DataTypes.STRING, allowNull: false },
  entity: { type: DataTypes.STRING, allowNull: true },
  entityId: { type: DataTypes.STRING, allowNull: true },
  description: { type: DataTypes.TEXT, allowNull: true },
  metadata: { type: DataTypes.JSON, allowNull: true },

  
  chainIndex: {
    type: DataTypes.BIGINT,
    allowNull: true,
    
    comment: "–ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –≤ hash-—Ü–µ–ø–æ—á–∫–µ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π)",
  },
  prevHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
    comment: "SHA-256 —Ö–µ—à –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–ø–∏—Å–∏ –≤ —Ü–µ–ø–æ—á–∫–µ",
  },
  currentHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
    comment: "SHA-256 —Ö–µ—à —Ç–µ–∫—É—â–µ–π –∑–∞–ø–∏—Å–∏ (–≤–∫–ª—é—á–∞—è prevHash)",
  },
  dataHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
    comment: "SHA-256 —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ chain-–ø–æ–ª–µ–π) ‚Äî –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π",
  },

  
  signedBy: {
    type: DataTypes.INTEGER,
    allowNull: true,
    comment: "userId –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–≤—à–µ–≥–æ –∑–∞–ø–∏—Å—å",
  },
  signedAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },

  
  severity: {
    type: DataTypes.ENUM("INFO", "WARNING", "CRITICAL", "SECURITY"),
    allowNull: false,
    defaultValue: "INFO",
    comment: "–£—Ä–æ–≤–µ–Ω—å –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ –¥–ª—è QMS –æ—Ç—á—ë—Ç–æ–≤",
  },
});



const Role = sequelize.define("role", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  name: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const Ability = sequelize.define("ability", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  code: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const RoleAbility = sequelize.define("role_ability", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
});

module.exports = {
  User,
  PC,
  Session,
  AuditLog,
  Role,
  Ability,
  RoleAbility,
};

================================================================================
FILE: QMS-Server-master/models/definitions/InternalAudit.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");





const AuditPlan = sequelize.define("audit_plan", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  year: { type: DataTypes.INTEGER, allowNull: false },
  title: { type: DataTypes.STRING, allowNull: false, comment: "–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–æ–¥–æ–≤–æ–π –ø–ª–∞–Ω –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∞—É–¥–∏—Ç–æ–≤ 2026" },
  approvedBy: { type: DataTypes.INTEGER, allowNull: true },
  approvedAt: { type: DataTypes.DATE, allowNull: true },
  status: { type: DataTypes.ENUM("DRAFT", "APPROVED", "IN_PROGRESS", "COMPLETED"), defaultValue: "DRAFT" },
});

const AuditSchedule = sequelize.define("audit_schedule", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  auditPlanId: { type: DataTypes.INTEGER, allowNull: false },
  
  auditNumber: { type: DataTypes.STRING, unique: true, allowNull: false, comment: "IA-YYYY-NNN" },
  title: { type: DataTypes.STRING, allowNull: false },
  scope: { type: DataTypes.TEXT, comment: "–û–±–ª–∞—Å—Ç—å –∞—É–¥–∏—Ç–∞: –ø—Ä–æ—Ü–µ—Å—Å, –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ, –ø—É–Ω–∫—Ç—ã ISO" },
  isoClause: { type: DataTypes.STRING, comment: "–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –ø—É–Ω–∫—Ç—ã ISO 13485" },
  
  plannedDate: { type: DataTypes.DATE, allowNull: false },
  actualDate: { type: DataTypes.DATE, allowNull: true },
  
  leadAuditorId: { type: DataTypes.INTEGER, allowNull: true },
  auditeeId: { type: DataTypes.INTEGER, allowNull: true, comment: "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–π –ø—Ä–æ—Ü–µ—Å—Å" },
  
  status: {
    type: DataTypes.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "CANCELLED", "OVERDUE"),
    defaultValue: "PLANNED"
  },
  
  criteria: { type: DataTypes.TEXT, comment: "–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∞—É–¥–∏—Ç–∞" },
  conclusion: { type: DataTypes.TEXT, comment: "–û–±—â–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ" },
  reportUrl: { type: DataTypes.STRING, allowNull: true },
});

const AuditFinding = sequelize.define("audit_finding", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  auditScheduleId: { type: DataTypes.INTEGER, allowNull: false },
  
  findingNumber: { type: DataTypes.STRING, allowNull: false, comment: "AF-YYYY-NNN" },
  
  type: {
    type: DataTypes.ENUM("MAJOR_NC", "MINOR_NC", "OBSERVATION", "OPPORTUNITY", "POSITIVE"),
    allowNull: false,
    comment: "MAJOR_NC=–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ, MINOR_NC=–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ, OBSERVATION=–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ"
  },
  
  isoClause: { type: DataTypes.STRING, comment: "–ù–∞—Ä—É—à–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç ISO" },
  description: { type: DataTypes.TEXT, allowNull: false },
  evidence: { type: DataTypes.TEXT, comment: "–û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–µ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞" },
  
  
  nonconformityId: { type: DataTypes.INTEGER, allowNull: true, comment: "–°–≤—è–∑—å —Å NC –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω" },
  capaId: { type: DataTypes.INTEGER, allowNull: true, comment: "–°–≤—è–∑—å —Å CAPA –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω" },
  
  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  dueDate: { type: DataTypes.DATE, allowNull: true },
  
  status: {
    type: DataTypes.ENUM("OPEN", "ACTION_REQUIRED", "CORRECTED", "VERIFIED", "CLOSED"),
    defaultValue: "OPEN"
  },
  
  closedBy: { type: DataTypes.INTEGER, allowNull: true },
  closedAt: { type: DataTypes.DATE, allowNull: true },
  closureNotes: { type: DataTypes.TEXT, allowNull: true },
});


AuditPlan.hasMany(AuditSchedule, { as: "audits", foreignKey: "auditPlanId" });
AuditSchedule.belongsTo(AuditPlan, { foreignKey: "auditPlanId" });

AuditSchedule.hasMany(AuditFinding, { as: "findings", foreignKey: "auditScheduleId" });
AuditFinding.belongsTo(AuditSchedule, { foreignKey: "auditScheduleId" });

module.exports = { AuditPlan, AuditSchedule, AuditFinding };

================================================================================
FILE: QMS-Server-master/models/definitions/ManagementReview.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");





const ManagementReview = sequelize.define("management_review", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  reviewNumber: { type: DataTypes.STRING, unique: true, allowNull: false, comment: "MR-YYYY-NN" },
  title: { type: DataTypes.STRING, allowNull: false },
  
  reviewDate: { type: DataTypes.DATE, allowNull: false },
  periodFrom: { type: DataTypes.DATE, allowNull: false, comment: "–ù–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞" },
  periodTo: { type: DataTypes.DATE, allowNull: false, comment: "–ö–æ–Ω–µ—Ü –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞" },
  
  chairpersonId: { type: DataTypes.INTEGER, allowNull: true, comment: "–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å (–æ–±—ã—á–Ω–æ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä)" },
  participants: { type: DataTypes.JSON, allowNull: true, comment: "–ú–∞—Å—Å–∏–≤ {userId, name, role}" },
  
  status: { type: DataTypes.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "APPROVED"), defaultValue: "PLANNED" },
  
  
  inputData: {
    type: DataTypes.JSON,
    allowNull: true,
    comment: `{
      auditResults: { total, findings, closed },
      customerFeedback: { complaints, satisfaction },
      processPerformance: { ncStats, capaStats },
      productConformity: { defectRate, yieldRate },
      preventiveActions: { count, effective },
      previousActions: { completed, pending },
      regulatoryChanges: [],
      recommendations: []
    }`
  },
  
  
  outputData: {
    type: DataTypes.JSON,
    allowNull: true,
    comment: `{
      decisions: [{ description, responsible, deadline }],
      resourceNeeds: [],
      improvementActions: [],
      policyChanges: [],
      qualityObjectives: []
    }`
  },
  
  
  conclusion: { type: DataTypes.TEXT, comment: "–û–±—â–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –°–ú–ö" },
  qmsEffectiveness: { type: DataTypes.ENUM("EFFECTIVE", "PARTIALLY_EFFECTIVE", "INEFFECTIVE"), allowNull: true },
  
  
  minutesUrl: { type: DataTypes.STRING, allowNull: true, comment: "–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–≤–µ—â–∞–Ω–∏—è" },
  
  approvedBy: { type: DataTypes.INTEGER, allowNull: true },
  approvedAt: { type: DataTypes.DATE, allowNull: true },
});


const ReviewAction = sequelize.define("review_action", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  managementReviewId: { type: DataTypes.INTEGER, allowNull: false },
  
  description: { type: DataTypes.TEXT, allowNull: false },
  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  deadline: { type: DataTypes.DATE, allowNull: true },
  
  priority: { type: DataTypes.ENUM("LOW", "MEDIUM", "HIGH"), defaultValue: "MEDIUM" },
  category: {
    type: DataTypes.ENUM("IMPROVEMENT", "RESOURCE", "TRAINING", "PROCESS_CHANGE", "POLICY", "INFRASTRUCTURE"),
    allowNull: true
  },
  
  status: { type: DataTypes.ENUM("OPEN", "IN_PROGRESS", "COMPLETED", "OVERDUE", "CANCELLED"), defaultValue: "OPEN" },
  completedAt: { type: DataTypes.DATE, allowNull: true },
  completionNotes: { type: DataTypes.TEXT, allowNull: true },
  
  
  capaId: { type: DataTypes.INTEGER, allowNull: true },
});


ManagementReview.hasMany(ReviewAction, { as: "actions", foreignKey: "managementReviewId" });
ReviewAction.belongsTo(ManagementReview, { foreignKey: "managementReviewId" });

module.exports = { ManagementReview, ReviewAction };

================================================================================
FILE: QMS-Server-master/models/definitions/NcCapa.js
================================================================================







const sequelize = require("../../db");
const { DataTypes } = require("sequelize");



const NC_SOURCES = {
  INCOMING_INSPECTION: "INCOMING_INSPECTION",
  IN_PROCESS: "IN_PROCESS",
  FINAL_INSPECTION: "FINAL_INSPECTION",
  CUSTOMER_COMPLAINT: "CUSTOMER_COMPLAINT",
  INTERNAL_AUDIT: "INTERNAL_AUDIT",
  EXTERNAL_AUDIT: "EXTERNAL_AUDIT",
  SUPPLIER: "SUPPLIER",
  FIELD_RETURN: "FIELD_RETURN",
  OTHER: "OTHER",
};

const NC_CLASSIFICATIONS = { CRITICAL: "CRITICAL", MAJOR: "MAJOR", MINOR: "MINOR" };

const NC_STATUSES = {
  OPEN: "OPEN", INVESTIGATING: "INVESTIGATING", DISPOSITION: "DISPOSITION",
  IMPLEMENTING: "IMPLEMENTING", VERIFICATION: "VERIFICATION", CLOSED: "CLOSED", REOPENED: "REOPENED",
};

const NC_DISPOSITIONS = {
  USE_AS_IS: "USE_AS_IS", REWORK: "REWORK", REPAIR: "REPAIR", SCRAP: "SCRAP",
  RETURN_TO_SUPPLIER: "RETURN_TO_SUPPLIER", CONCESSION: "CONCESSION", OTHER: "OTHER",
};

const CAPA_TYPES = { CORRECTIVE: "CORRECTIVE", PREVENTIVE: "PREVENTIVE" };
const CAPA_STATUSES = {
  INITIATED: "INITIATED", INVESTIGATING: "INVESTIGATING", PLANNING: "PLANNING",
  PLAN_APPROVED: "PLAN_APPROVED", IMPLEMENTING: "IMPLEMENTING", VERIFYING: "VERIFYING",
  EFFECTIVE: "EFFECTIVE", INEFFECTIVE: "INEFFECTIVE", CLOSED: "CLOSED",
};
const CAPA_PRIORITIES = { LOW: "LOW", MEDIUM: "MEDIUM", HIGH: "HIGH", URGENT: "URGENT" };
const CAPA_ACTION_STATUSES = { PLANNED: "PLANNED", IN_PROGRESS: "IN_PROGRESS", COMPLETED: "COMPLETED", CANCELLED: "CANCELLED" };



const Nonconformity = sequelize.define("nonconformity", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  number: { type: DataTypes.STRING(20), allowNull: false, unique: true },
  title: { type: DataTypes.STRING(500), allowNull: false },
  description: { type: DataTypes.TEXT, allowNull: false },
  source: { type: DataTypes.ENUM(...Object.values(NC_SOURCES)), allowNull: false },
  classification: { type: DataTypes.ENUM(...Object.values(NC_CLASSIFICATIONS)), allowNull: false, defaultValue: "MINOR" },
  status: { type: DataTypes.ENUM(...Object.values(NC_STATUSES)), allowNull: false, defaultValue: "OPEN" },
  disposition: { type: DataTypes.ENUM(...Object.values(NC_DISPOSITIONS)), allowNull: true },
  dispositionJustification: { type: DataTypes.TEXT, allowNull: true },
  productType: { type: DataTypes.STRING(100), allowNull: true },
  productSerialNumber: { type: DataTypes.STRING(100), allowNull: true },
  lotNumber: { type: DataTypes.STRING(100), allowNull: true },
  processName: { type: DataTypes.STRING(200), allowNull: true },
  supplierName: { type: DataTypes.STRING(200), allowNull: true },
  warehouseBoxId: { type: DataTypes.INTEGER, allowNull: true },
  documentId: { type: DataTypes.INTEGER, allowNull: true },
  totalQty: { type: DataTypes.INTEGER, allowNull: true },
  defectQty: { type: DataTypes.INTEGER, allowNull: true },
  rootCause: { type: DataTypes.TEXT, allowNull: true },
  rootCauseMethod: { type: DataTypes.STRING(50), allowNull: true },
  immediateAction: { type: DataTypes.TEXT, allowNull: true },
  reportedById: { type: DataTypes.INTEGER, allowNull: false },
  assignedToId: { type: DataTypes.INTEGER, allowNull: true },
  closedById: { type: DataTypes.INTEGER, allowNull: true },
  detectedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  dueDate: { type: DataTypes.DATEONLY, allowNull: true },
  closedAt: { type: DataTypes.DATE, allowNull: true },
  capaRequired: { type: DataTypes.BOOLEAN, allowNull: false, defaultValue: false },
});

const NcAttachment = sequelize.define("nc_attachment", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  nonconformityId: { type: DataTypes.INTEGER, allowNull: false },
  fileUrl: { type: DataTypes.STRING(1000), allowNull: false },
  fileName: { type: DataTypes.STRING(500), allowNull: false },
  fileSize: { type: DataTypes.INTEGER, allowNull: true },
  fileMimeType: { type: DataTypes.STRING(100), allowNull: true },
  description: { type: DataTypes.STRING(500), allowNull: true },
  uploadedById: { type: DataTypes.INTEGER, allowNull: false },
});

const Capa = sequelize.define("capa", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  number: { type: DataTypes.STRING(20), allowNull: false, unique: true },
  type: { type: DataTypes.ENUM(...Object.values(CAPA_TYPES)), allowNull: false },
  title: { type: DataTypes.STRING(500), allowNull: false },
  description: { type: DataTypes.TEXT, allowNull: true },
  status: { type: DataTypes.ENUM(...Object.values(CAPA_STATUSES)), allowNull: false, defaultValue: "INITIATED" },
  priority: { type: DataTypes.ENUM(...Object.values(CAPA_PRIORITIES)), allowNull: false, defaultValue: "MEDIUM" },
  nonconformityId: { type: DataTypes.INTEGER, allowNull: true },
  rootCauseAnalysis: { type: DataTypes.TEXT, allowNull: true },
  rootCauseMethod: { type: DataTypes.STRING(50), allowNull: true },
  initiatedById: { type: DataTypes.INTEGER, allowNull: false },
  assignedToId: { type: DataTypes.INTEGER, allowNull: true },
  approvedById: { type: DataTypes.INTEGER, allowNull: true },
  dueDate: { type: DataTypes.DATEONLY, allowNull: true },
  planApprovedAt: { type: DataTypes.DATE, allowNull: true },
  implementedAt: { type: DataTypes.DATE, allowNull: true },
  closedAt: { type: DataTypes.DATE, allowNull: true },
  effectivenessCheckDate: { type: DataTypes.DATEONLY, allowNull: true },
  effectivenessCheckDays: { type: DataTypes.INTEGER, allowNull: true, defaultValue: 90 },
});

const CapaAction = sequelize.define("capa_action", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  capaId: { type: DataTypes.INTEGER, allowNull: false },
  order: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 1 },
  description: { type: DataTypes.TEXT, allowNull: false },
  assignedToId: { type: DataTypes.INTEGER, allowNull: true },
  status: { type: DataTypes.ENUM(...Object.values(CAPA_ACTION_STATUSES)), allowNull: false, defaultValue: "PLANNED" },
  dueDate: { type: DataTypes.DATEONLY, allowNull: true },
  completedAt: { type: DataTypes.DATE, allowNull: true },
  result: { type: DataTypes.TEXT, allowNull: true },
});

const CapaVerification = sequelize.define("capa_verification", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  capaId: { type: DataTypes.INTEGER, allowNull: false },
  verifiedById: { type: DataTypes.INTEGER, allowNull: false },
  isEffective: { type: DataTypes.BOOLEAN, allowNull: false },
  evidence: { type: DataTypes.TEXT, allowNull: true },
  comment: { type: DataTypes.TEXT, allowNull: true },
  verifiedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
});



function setupNcCapaAssociations({ User, Document }) {
  
  Nonconformity.belongsTo(User, { foreignKey: "reportedById", as: "reportedBy" });
  Nonconformity.belongsTo(User, { foreignKey: "assignedToId", as: "assignedTo" });
  Nonconformity.belongsTo(User, { foreignKey: "closedById", as: "closedBy" });

  
  Nonconformity.hasMany(NcAttachment, { foreignKey: "nonconformityId", as: "attachments", onDelete: "CASCADE" });
  NcAttachment.belongsTo(Nonconformity, { foreignKey: "nonconformityId", as: "nonconformity" });
  NcAttachment.belongsTo(User, { foreignKey: "uploadedById", as: "uploadedBy" });

  
  Nonconformity.hasMany(Capa, { foreignKey: "nonconformityId", as: "capas" });
  Capa.belongsTo(Nonconformity, { foreignKey: "nonconformityId", as: "nonconformity" });

  
  if (Document) {
    Nonconformity.belongsTo(Document, { foreignKey: "documentId", as: "document" });
  }

  
  Capa.belongsTo(User, { foreignKey: "initiatedById", as: "initiatedBy" });
  Capa.belongsTo(User, { foreignKey: "assignedToId", as: "assignedTo" });
  Capa.belongsTo(User, { foreignKey: "approvedById", as: "approvedBy" });

  
  Capa.hasMany(CapaAction, { foreignKey: "capaId", as: "actions", onDelete: "CASCADE" });
  CapaAction.belongsTo(Capa, { foreignKey: "capaId", as: "capa" });
  CapaAction.belongsTo(User, { foreignKey: "assignedToId", as: "assignedTo" });

  
  Capa.hasMany(CapaVerification, { foreignKey: "capaId", as: "verifications", onDelete: "CASCADE" });
  CapaVerification.belongsTo(Capa, { foreignKey: "capaId", as: "capa" });
  CapaVerification.belongsTo(User, { foreignKey: "verifiedById", as: "verifiedBy" });
}

module.exports = {
  Nonconformity, NcAttachment, Capa, CapaAction, CapaVerification,
  setupNcCapaAssociations,
  NC_SOURCES, NC_CLASSIFICATIONS, NC_STATUSES, NC_DISPOSITIONS,
  CAPA_TYPES, CAPA_STATUSES, CAPA_PRIORITIES, CAPA_ACTION_STATUSES,
};

================================================================================
FILE: QMS-Server-master/models/definitions/Project.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");

const Project = sequelize.define("project", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false, unique: true },
  description: { type: DataTypes.TEXT, allowNull: true },
  status: { type: DataTypes.STRING, defaultValue: "ACTIVE" },
  createdById: { type: DataTypes.INTEGER, allowNull: false },
});

module.exports = { Project };
================================================================================
FILE: QMS-Server-master/models/definitions/Risk.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");






const RiskRegister = sequelize.define("risk_register", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  
  riskNumber: { 
    type: DataTypes.STRING, 
    unique: true, 
    allowNull: false,
    comment: "–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –Ω–æ–º–µ—Ä: RISK-YYYY-NNN"
  },
  title: { type: DataTypes.STRING(500), allowNull: false },
  description: { type: DataTypes.TEXT },
  
  
  category: { 
    type: DataTypes.ENUM(
      "PRODUCT",        
      "PROCESS",        
      "SUPPLIER",       
      "REGULATORY",     
      "INFRASTRUCTURE", 
      "HUMAN",          
      "CYBER"           
    ),
    allowNull: false 
  },
  
  
  relatedEntity: { type: DataTypes.STRING, allowNull: true, comment: "–¢–∏–ø: product, process, supplier, document" },
  relatedEntityId: { type: DataTypes.INTEGER, allowNull: true },
  
  
  initialProbability: { type: DataTypes.INTEGER, allowNull: false, validate: { min: 1, max: 5 }, comment: "1=–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ, 5=–ß–∞—Å—Ç–æ–µ" },
  initialSeverity: { type: DataTypes.INTEGER, allowNull: false, validate: { min: 1, max: 5 }, comment: "1=–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ, 5=–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–æ–µ" },
  initialRiskLevel: { type: DataTypes.INTEGER, allowNull: true, comment: "probability √ó severity (–∞–≤—Ç–æ—Ä–∞—Å—á—ë—Ç)" },
  initialRiskClass: { type: DataTypes.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL"), allowNull: true },
  
  
  residualProbability: { type: DataTypes.INTEGER, allowNull: true, validate: { min: 1, max: 5 } },
  residualSeverity: { type: DataTypes.INTEGER, allowNull: true, validate: { min: 1, max: 5 } },
  residualRiskLevel: { type: DataTypes.INTEGER, allowNull: true },
  residualRiskClass: { type: DataTypes.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL"), allowNull: true },
  
  
  status: {
    type: DataTypes.ENUM("IDENTIFIED", "ASSESSED", "MITIGATED", "ACCEPTED", "CLOSED", "MONITORING"),
    defaultValue: "IDENTIFIED"
  },
  acceptanceDecision: { type: DataTypes.TEXT, allowNull: true, comment: "–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–∏—è –æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ —Ä–∏—Å–∫–∞" },
  acceptedBy: { type: DataTypes.INTEGER, allowNull: true },
  acceptedAt: { type: DataTypes.DATE, allowNull: true },
  
  
  ownerId: { type: DataTypes.INTEGER, allowNull: true, comment: "–í–ª–∞–¥–µ–ª–µ—Ü —Ä–∏—Å–∫–∞" },
  reviewDate: { type: DataTypes.DATE, allowNull: true, comment: "–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞" },
  
  
  isoClause: { type: DataTypes.STRING, allowNull: true, comment: "–ü—É–Ω–∫—Ç ISO 13485/14971" },
});





const RiskAssessment = sequelize.define("risk_assessment", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  riskRegisterId: { type: DataTypes.INTEGER, allowNull: false },
  
  assessmentDate: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  assessorId: { type: DataTypes.INTEGER, allowNull: false, comment: "–ö—Ç–æ –ø—Ä–æ–≤–æ–¥–∏–ª –æ—Ü–µ–Ω–∫—É" },
  
  probability: { type: DataTypes.INTEGER, allowNull: false, validate: { min: 1, max: 5 } },
  severity: { type: DataTypes.INTEGER, allowNull: false, validate: { min: 1, max: 5 } },
  detectability: { type: DataTypes.INTEGER, allowNull: true, validate: { min: 1, max: 5 }, comment: "–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ–º–æ—Å—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è FMEA)" },
  riskLevel: { type: DataTypes.INTEGER, allowNull: true },
  riskClass: { type: DataTypes.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL"), allowNull: true },
  
  rationale: { type: DataTypes.TEXT, comment: "–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏" },
  assessmentType: { type: DataTypes.ENUM("INITIAL", "PERIODIC", "POST_MITIGATION", "POST_INCIDENT"), defaultValue: "INITIAL" },
});





const RiskMitigation = sequelize.define("risk_mitigation", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  riskRegisterId: { type: DataTypes.INTEGER, allowNull: false },
  
  mitigationType: {
    type: DataTypes.ENUM(
      "DESIGN",          
      "PROTECTIVE",      
      "INFORMATION",     
      "PROCESS_CONTROL", 
      "TRAINING",        
      "MONITORING"       
    ),
    allowNull: false
  },
  
  description: { type: DataTypes.TEXT, allowNull: false },
  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  
  plannedDate: { type: DataTypes.DATE, allowNull: true },
  completedDate: { type: DataTypes.DATE, allowNull: true },
  
  status: {
    type: DataTypes.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "VERIFIED", "INEFFECTIVE"),
    defaultValue: "PLANNED"
  },
  
  verifiedBy: { type: DataTypes.INTEGER, allowNull: true },
  verifiedAt: { type: DataTypes.DATE, allowNull: true },
  verificationNotes: { type: DataTypes.TEXT, allowNull: true },
  
  
  capaId: { type: DataTypes.INTEGER, allowNull: true },
});





RiskRegister.hasMany(RiskAssessment, { as: "assessments", foreignKey: "riskRegisterId" });
RiskAssessment.belongsTo(RiskRegister, { foreignKey: "riskRegisterId" });

RiskRegister.hasMany(RiskMitigation, { as: "mitigations", foreignKey: "riskRegisterId" });
RiskMitigation.belongsTo(RiskRegister, { foreignKey: "riskRegisterId" });

module.exports = {
  RiskRegister,
  RiskAssessment,
  RiskMitigation,
};

================================================================================
FILE: QMS-Server-master/models/definitions/Structure.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");

const Section = sequelize.define("production_section", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false, unique: true },
  description: { type: DataTypes.STRING },
  managerId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: 'users',
      key: 'id'
    }
  },
});

const Team = sequelize.define("production_team", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false },
  sectionId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    field: "productionSectionId",
  },
  teamLeadId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: 'users',
      key: 'id'
    }
  },
});

module.exports = {
  Section,
  Team,
};

================================================================================
FILE: QMS-Server-master/models/definitions/Supplier.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");





const Supplier = sequelize.define("supplier", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  
  code: { type: DataTypes.STRING, unique: true, allowNull: false, comment: "–ö–æ–¥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: SUP-NNN" },
  name: { type: DataTypes.STRING(500), allowNull: false },
  legalName: { type: DataTypes.STRING(500), allowNull: true, comment: "–ü–æ–ª–Ω–æ–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" },
  inn: { type: DataTypes.STRING(12), allowNull: true, comment: "–ò–ù–ù" },
  
  
  address: { type: DataTypes.TEXT },
  contactPerson: { type: DataTypes.STRING },
  phone: { type: DataTypes.STRING },
  email: { type: DataTypes.STRING },
  website: { type: DataTypes.STRING },
  
  
  category: {
    type: DataTypes.ENUM(
      "RAW_MATERIAL",    
      "COMPONENT",       
      "SERVICE",         
      "EQUIPMENT",       
      "PACKAGING",       
      "SOFTWARE",        
      "SUBCONTRACTOR"    
    ),
    allowNull: false
  },
  
  criticality: {
    type: DataTypes.ENUM("CRITICAL", "MAJOR", "MINOR"),
    defaultValue: "MAJOR",
    comment: "–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å: –≤–ª–∏—è–µ—Ç –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∏"
  },
  
  
  qualificationStatus: {
    type: DataTypes.ENUM("PENDING", "QUALIFIED", "CONDITIONAL", "DISQUALIFIED", "SUSPENDED"),
    defaultValue: "PENDING"
  },
  qualifiedAt: { type: DataTypes.DATE, allowNull: true },
  qualifiedBy: { type: DataTypes.INTEGER, allowNull: true },
  
  nextEvaluationDate: { type: DataTypes.DATE, allowNull: true, comment: "–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–π –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—Ü–µ–Ω–∫–∏" },
  
  
  hasCertISO9001: { type: DataTypes.BOOLEAN, defaultValue: false },
  hasCertISO13485: { type: DataTypes.BOOLEAN, defaultValue: false },
  certExpiryDate: { type: DataTypes.DATE, allowNull: true },
  
  
  overallScore: { type: DataTypes.FLOAT, allowNull: true, comment: "–û–±—â–∏–π –±–∞–ª–ª 0-100" },
  
  notes: { type: DataTypes.TEXT },
});





const SupplierEvaluation = sequelize.define("supplier_evaluation", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplierId: { type: DataTypes.INTEGER, allowNull: false },
  
  evaluationDate: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  evaluatorId: { type: DataTypes.INTEGER, allowNull: false },
  evaluationType: {
    type: DataTypes.ENUM("INITIAL", "PERIODIC", "POST_INCIDENT", "REQUALIFICATION"),
    defaultValue: "PERIODIC"
  },
  
  
  qualityScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "–ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏/—É—Å–ª—É–≥" },
  deliveryScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "–°–æ–±–ª—é–¥–µ–Ω–∏–µ —Å—Ä–æ–∫–æ–≤" },
  documentationScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "–ü–æ–ª–Ω–æ—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏" },
  communicationScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –∏ –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å" },
  priceScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω–∞/–∫–∞—á–µ—Å—Ç–≤–æ" },
  complianceScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º" },
  
  totalScore: { type: DataTypes.FLOAT, allowNull: true, comment: "–°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—ã–π –±–∞–ª–ª" },
  
  
  decision: {
    type: DataTypes.ENUM("APPROVED", "CONDITIONALLY_APPROVED", "REJECTED", "SUSPENDED"),
    allowNull: true
  },
  conditions: { type: DataTypes.TEXT, allowNull: true, comment: "–£—Å–ª–æ–≤–∏—è –ø—Ä–∏ —É—Å–ª–æ–≤–Ω–æ–º –æ–¥–æ–±—Ä–µ–Ω–∏–∏" },
  comments: { type: DataTypes.TEXT },
  
  
  totalOrders: { type: DataTypes.INTEGER, defaultValue: 0 },
  defectiveOrders: { type: DataTypes.INTEGER, defaultValue: 0 },
  lateDeliveries: { type: DataTypes.INTEGER, defaultValue: 0 },
  ncCount: { type: DataTypes.INTEGER, defaultValue: 0, comment: "–ß–∏—Å–ª–æ NC –∑–∞ –ø–µ—Ä–∏–æ–¥" },
});





const SupplierAudit = sequelize.define("supplier_audit", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplierId: { type: DataTypes.INTEGER, allowNull: false },
  
  auditDate: { type: DataTypes.DATE, allowNull: false },
  auditorId: { type: DataTypes.INTEGER, allowNull: false },
  auditType: { type: DataTypes.ENUM("ON_SITE", "REMOTE", "DOCUMENT"), defaultValue: "ON_SITE" },
  
  scope: { type: DataTypes.TEXT, comment: "–û–±–ª–∞—Å—Ç—å –∞—É–¥–∏—Ç–∞" },
  findings: { type: DataTypes.TEXT, comment: "–ó–∞–º–µ—á–∞–Ω–∏—è" },
  
  findingsCount: { type: DataTypes.INTEGER, defaultValue: 0 },
  majorFindings: { type: DataTypes.INTEGER, defaultValue: 0 },
  minorFindings: { type: DataTypes.INTEGER, defaultValue: 0 },
  
  result: { type: DataTypes.ENUM("PASS", "CONDITIONAL", "FAIL"), allowNull: true },
  nextAuditDate: { type: DataTypes.DATE, allowNull: true },
  
  reportUrl: { type: DataTypes.STRING, allowNull: true },
});





Supplier.hasMany(SupplierEvaluation, { as: "evaluations", foreignKey: "supplierId" });
SupplierEvaluation.belongsTo(Supplier, { foreignKey: "supplierId" });

Supplier.hasMany(SupplierAudit, { as: "audits", foreignKey: "supplierId" });
SupplierAudit.belongsTo(Supplier, { foreignKey: "supplierId" });

module.exports = {
  Supplier,
  SupplierEvaluation,
  SupplierAudit,
};

================================================================================
FILE: QMS-Server-master/models/definitions/Training.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");





const TrainingPlan = sequelize.define("training_plan", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false },
  description: { type: DataTypes.TEXT },
  year: { type: DataTypes.INTEGER, allowNull: false },
  status: { type: DataTypes.ENUM("DRAFT", "APPROVED", "IN_PROGRESS", "COMPLETED"), defaultValue: "DRAFT" },
  approvedBy: { type: DataTypes.INTEGER, allowNull: true },
  approvedAt: { type: DataTypes.DATE, allowNull: true },
});

const TrainingRecord = sequelize.define("training_record", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  userId: { type: DataTypes.INTEGER, allowNull: false, comment: "–ö–æ–≥–æ –æ–±—É—á–∞–ª–∏" },
  trainerId: { type: DataTypes.INTEGER, allowNull: true, comment: "–ö—Ç–æ –æ–±—É—á–∞–ª" },
  trainingPlanId: { type: DataTypes.INTEGER, allowNull: true },
  
  title: { type: DataTypes.STRING, allowNull: false },
  description: { type: DataTypes.TEXT },
  
  type: {
    type: DataTypes.ENUM(
      "ONBOARDING",      
      "PROCEDURE",       
      "EQUIPMENT",       
      "GMP",             
      "SAFETY",          
      "REGULATORY",      
      "SOFTWARE",        
      "RETRAINING"       
    ),
    allowNull: false
  },
  
  
  relatedDocumentId: { type: DataTypes.INTEGER, allowNull: true, comment: "–î–æ–∫—É–º–µ–Ω—Ç, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –æ–±—É—á–∞–ª–∏" },
  
  trainingDate: { type: DataTypes.DATE, allowNull: false },
  duration: { type: DataTypes.FLOAT, allowNull: true, comment: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —á–∞—Å–∞—Ö" },
  
  
  assessmentMethod: { type: DataTypes.ENUM("TEST", "PRACTICAL", "OBSERVATION", "SELF_STUDY", "NONE"), defaultValue: "NONE" },
  assessmentScore: { type: DataTypes.FLOAT, allowNull: true, comment: "–ë–∞–ª–ª 0-100" },
  passed: { type: DataTypes.BOOLEAN, allowNull: true },
  
  
  confirmedBy: { type: DataTypes.INTEGER, allowNull: true, comment: "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–≤—à–∏–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å" },
  confirmedAt: { type: DataTypes.DATE, allowNull: true },
  
  certificateUrl: { type: DataTypes.STRING, allowNull: true },
  
  
  expiryDate: { type: DataTypes.DATE, allowNull: true, comment: "–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ" },
  
  status: { type: DataTypes.ENUM("PLANNED", "COMPLETED", "FAILED", "EXPIRED"), defaultValue: "PLANNED" },
});


const CompetencyMatrix = sequelize.define("competency_matrix", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  userId: { type: DataTypes.INTEGER, allowNull: false },
  processName: { type: DataTypes.STRING, allowNull: false, comment: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞/–æ–ø–µ—Ä–∞—Ü–∏–∏" },
  
  level: {
    type: DataTypes.ENUM("NONE", "AWARENESS", "TRAINED", "COMPETENT", "EXPERT"),
    defaultValue: "NONE",
    comment: "–£—Ä–æ–≤–µ–Ω—å –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏"
  },
  
  requiredLevel: {
    type: DataTypes.ENUM("NONE", "AWARENESS", "TRAINED", "COMPETENT", "EXPERT"),
    defaultValue: "TRAINED",
    comment: "–¢—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏"
  },
  
  lastTrainingDate: { type: DataTypes.DATE, allowNull: true },
  nextTrainingDate: { type: DataTypes.DATE, allowNull: true },
  
  notes: { type: DataTypes.TEXT, allowNull: true },
});


TrainingPlan.hasMany(TrainingRecord, { as: "records", foreignKey: "trainingPlanId" });
TrainingRecord.belongsTo(TrainingPlan, { foreignKey: "trainingPlanId" });

module.exports = { TrainingPlan, TrainingRecord, CompetencyMatrix };

================================================================================
FILE: QMS-Server-master/models/definitions/Warehouse.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");


const Supply = sequelize.define("supply", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplier: { type: DataTypes.STRING, allowNull: true },
  docNumber: { type: DataTypes.STRING, allowNull: true },
  status: { type: DataTypes.STRING, defaultValue: "NEW" },
  comment: { type: DataTypes.TEXT, allowNull: true },
  expectedDate: { type: DataTypes.DATEONLY, allowNull: true },
  receivedAt: { type: DataTypes.DATE, defaultValue: DataTypes.NOW },
});


const WarehouseBox = sequelize.define("warehouse_box", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplyId: { type: DataTypes.INTEGER, allowNull: true },


  qrCode: { type: DataTypes.STRING, unique: true, allowNull: false },
  shortCode: { type: DataTypes.STRING, unique: true, allowNull: true },


  label: { type: DataTypes.STRING, allowNull: false },


  originType: { type: DataTypes.STRING, allowNull: true },
  originId: { type: DataTypes.INTEGER, allowNull: true },


  quantity: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 1 },
  unit: { type: DataTypes.STRING, allowNull: false, defaultValue: "—à—Ç" },


  parentBoxId: { type: DataTypes.INTEGER, allowNull: true },


  kitNumber: { type: DataTypes.STRING, allowNull: true },
  projectName: { type: DataTypes.STRING, allowNull: true },
  batchName: { type: DataTypes.STRING, allowNull: true },


  status: { type: DataTypes.STRING, allowNull: false, defaultValue: "ON_STOCK" },
  notes: { type: DataTypes.TEXT, allowNull: true },


  currentSectionId: { type: DataTypes.INTEGER, allowNull: true },
  currentTeamId: { type: DataTypes.INTEGER, allowNull: true },

  acceptedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  acceptedById: { type: DataTypes.INTEGER, allowNull: false },
});


const WarehouseMovement = sequelize.define("warehouse_movement", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  boxId: { type: DataTypes.INTEGER, allowNull: false },
  documentId: { type: DataTypes.INTEGER, allowNull: true },

  fromSectionId: { type: DataTypes.INTEGER, allowNull: true },
  fromTeamId: { type: DataTypes.INTEGER, allowNull: true },
  toSectionId: { type: DataTypes.INTEGER, allowNull: true },
  toTeamId: { type: DataTypes.INTEGER, allowNull: true },

  operation: { type: DataTypes.STRING, allowNull: false },
  statusAfter: { type: DataTypes.STRING, allowNull: true },

  deltaQty: { type: DataTypes.INTEGER, allowNull: true, defaultValue: 0 },
  goodQty: { type: DataTypes.INTEGER, allowNull: true },
  scrapQty: { type: DataTypes.INTEGER, allowNull: true },

  performedById: { type: DataTypes.INTEGER, allowNull: false },
  performedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  comment: { type: DataTypes.TEXT, allowNull: true },
});


const WarehouseDocument = sequelize.define("warehouse_document", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  boxId: { type: DataTypes.INTEGER, allowNull: true },
  number: { type: DataTypes.STRING, allowNull: false },
  type: { type: DataTypes.STRING, allowNull: true },
  date: { type: DataTypes.DATEONLY, allowNull: true },
  fileUrl: { type: DataTypes.STRING, allowNull: true },
  comment: { type: DataTypes.TEXT, allowNull: true },
  createdById: { type: DataTypes.INTEGER, allowNull: false },
});


const InventoryLimit = sequelize.define("inventory_limit", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  originType: { type: DataTypes.STRING, allowNull: true },
  originId: { type: DataTypes.INTEGER, allowNull: true },
  label: { type: DataTypes.STRING, allowNull: true },
  minQuantity: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
});


const ProductionTask = sequelize.define("production_task", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },

  title: { type: DataTypes.STRING, allowNull: false },


  originType: { type: DataTypes.STRING, allowNull: true },
  originId: { type: DataTypes.INTEGER, allowNull: true },

  targetQty: { type: DataTypes.INTEGER, allowNull: false },
  unit: { type: DataTypes.STRING, allowNull: false, defaultValue: "—à—Ç" },

  dueDate: { type: DataTypes.DATEONLY, allowNull: true },

  status: { type: DataTypes.STRING, allowNull: false, defaultValue: "NEW" },
  priority: { type: DataTypes.INTEGER, allowNull: true },

  comment: { type: DataTypes.TEXT, allowNull: true },

  createdById: { type: DataTypes.INTEGER, allowNull: false },


  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  sectionId: { type: DataTypes.INTEGER, allowNull: true },
  projectId: { type: DataTypes.INTEGER, allowNull: true },
});


const PrintHistory = sequelize.define("print_history", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  template: { type: DataTypes.STRING, allowNull: false },

  labelName: { type: DataTypes.STRING },
  startCode: { type: DataTypes.STRING },
  endCode: { type: DataTypes.STRING },

  quantity: { type: DataTypes.INTEGER },


  params: { type: DataTypes.JSONB },

  createdById: { type: DataTypes.INTEGER, allowNull: true },
  createdAt: { type: DataTypes.DATE, defaultValue: DataTypes.NOW }
});

module.exports = {
  Supply,
  WarehouseBox,
  WarehouseMovement,
  WarehouseDocument,
  InventoryLimit,
  ProductionTask,
  PrintHistory
};

================================================================================
FILE: QMS-Server-master/models/index.js
================================================================================


const { User, PC, Session, AuditLog, Role, Ability, RoleAbility } = require("./definitions/General");
const { Section, Team } = require("./definitions/Structure");

const {
  Supply, WarehouseBox, WarehouseMovement,
  WarehouseDocument, InventoryLimit, ProductionTask,
  PrintHistory
} = require("./definitions/Warehouse");

const { Project } = require("./definitions/Project");

const {
  Document,
  DocumentVersion,
  DocumentApproval,
  DocumentDistribution,
  setupDocumentAssociations,
  DOCUMENT_TYPES,
  DOCUMENT_STATUSES,
  VERSION_STATUSES,
  APPROVAL_ROLES,
  APPROVAL_DECISIONS,
} = require("./definitions/Document");

const {
  Nonconformity,
  NcAttachment,
  Capa,
  CapaAction,
  CapaVerification,
  setupNcCapaAssociations,
  NC_SOURCES,
  NC_CLASSIFICATIONS,
  NC_STATUSES,
  NC_DISPOSITIONS,
  CAPA_TYPES,
  CAPA_STATUSES,
  CAPA_PRIORITIES,
  CAPA_ACTION_STATUSES,
} = require("./definitions/NcCapa");


const { RiskRegister, RiskAssessment, RiskMitigation } = require("./definitions/Risk");


const { Supplier, SupplierEvaluation, SupplierAudit } = require("./definitions/Supplier");


const { AuditPlan, AuditSchedule, AuditFinding } = require("./definitions/InternalAudit");


const { TrainingPlan, TrainingRecord, CompetencyMatrix } = require("./definitions/Training");


const { Equipment, CalibrationRecord } = require("./definitions/Equipment");


const { ManagementReview, ReviewAction } = require("./definitions/ManagementReview");






User.hasMany(Session);
Session.belongsTo(User);

Session.belongsTo(PC, { foreignKey: "PCId", as: "pc" });
PC.hasMany(Session, { foreignKey: "PCId", as: "sessions" });

AuditLog.belongsTo(User, { foreignKey: "userId", as: "User" });
User.hasMany(AuditLog, { foreignKey: "userId", as: "auditLogs" });

User.belongsTo(Team, { foreignKey: "teamId" });
Team.hasMany(User, { foreignKey: "teamId" });

Team.belongsTo(Section, { foreignKey: "sectionId", as: "section" });
Section.hasMany(Team, { foreignKey: "sectionId", as: "teams" });

Team.belongsTo(User, { foreignKey: "teamLeadId", as: "teamLead" });

Section.belongsTo(User, { foreignKey: "managerId", as: "manager" });
User.hasMany(Section, { foreignKey: "managerId", as: "managedSections" });

Role.belongsToMany(Ability, { through: RoleAbility, foreignKey: "roleId", as: "abilities" });
Ability.belongsToMany(Role, { through: RoleAbility, foreignKey: "abilityId", as: "roles" });
User.belongsTo(Role, { foreignKey: "roleId", as: "userRole" });






Supply.hasMany(WarehouseBox, { foreignKey: "supplyId", as: "boxes" });
WarehouseBox.belongsTo(Supply, { foreignKey: "supplyId", as: "supply" });

User.hasMany(WarehouseBox, { foreignKey: "acceptedById", as: "acceptedBoxes" });
WarehouseBox.belongsTo(User, { foreignKey: "acceptedById", as: "acceptedBy" });

WarehouseBox.belongsTo(Section, { foreignKey: "currentSectionId", as: "currentSection" });
Section.hasMany(WarehouseBox, { foreignKey: "currentSectionId", as: "boxes" });

WarehouseBox.hasMany(WarehouseMovement, { foreignKey: "boxId", as: "movements" });
WarehouseMovement.belongsTo(WarehouseBox, { foreignKey: "boxId", as: "box" });

WarehouseMovement.belongsTo(User, { foreignKey: "performedById", as: "performedBy" });
WarehouseMovement.belongsTo(Section, { foreignKey: "fromSectionId", as: "fromSection" });
WarehouseMovement.belongsTo(Section, { foreignKey: "toSectionId", as: "toSection" });






ProductionTask.belongsTo(User, { foreignKey: "responsibleId", as: "responsible" });
ProductionTask.belongsTo(User, { foreignKey: "createdById", as: "createdBy" });
ProductionTask.belongsTo(Section, { foreignKey: "targetSectionId", as: "targetSection" });
ProductionTask.belongsTo(Project, { foreignKey: "projectId", as: "project" });

Project.belongsTo(User, { foreignKey: "createdById", as: "author" });
User.hasMany(Project, { foreignKey: "createdById", as: "projects" });







User.hasMany(RiskRegister, { as: "ownedRisks", foreignKey: "ownerId" });
RiskRegister.belongsTo(User, { as: "owner", foreignKey: "ownerId" });


User.hasMany(TrainingRecord, { as: "trainings", foreignKey: "userId" });
TrainingRecord.belongsTo(User, { as: "trainee", foreignKey: "userId" });


User.hasMany(Equipment, { as: "responsibleEquipment", foreignKey: "responsibleId" });
Equipment.belongsTo(User, { as: "responsible", foreignKey: "responsibleId" });


Document.belongsTo(User, { as: "author", foreignKey: "authorId" });
Document.belongsTo(User, { as: "approver", foreignKey: "currentApproverId" });


if (typeof setupDocumentAssociations === "function") {
  setupDocumentAssociations({ User, Document, DocumentVersion, DocumentApproval, DocumentDistribution });
}
if (typeof setupNcCapaAssociations === "function") {
  setupNcCapaAssociations({ User, Nonconformity, NcAttachment, Capa, CapaAction, CapaVerification });
}






module.exports = {
  User, PC, Session, AuditLog, Role, Ability, RoleAbility,

  Section, Team,

  Supply, WarehouseBox, WarehouseMovement,
  WarehouseDocument, InventoryLimit,
  ProductionTask, Project, PrintHistory,

  
  Document,
  DocumentVersion,
  DocumentApproval,
  DocumentDistribution,
  DOCUMENT_TYPES,
  DOCUMENT_STATUSES,
  VERSION_STATUSES,
  APPROVAL_ROLES,
  APPROVAL_DECISIONS,

  Nonconformity,
  NcAttachment,
  Capa,
  CapaAction,
  CapaVerification,
  NC_SOURCES,
  NC_CLASSIFICATIONS,
  NC_STATUSES,
  NC_DISPOSITIONS,
  CAPA_TYPES,
  CAPA_STATUSES,
  CAPA_PRIORITIES,
  CAPA_ACTION_STATUSES,

  RiskRegister, RiskAssessment, RiskMitigation,
  Supplier, SupplierEvaluation, SupplierAudit,
  AuditPlan, AuditSchedule, AuditFinding,
  TrainingPlan, TrainingRecord, CompetencyMatrix,
  Equipment, CalibrationRecord,
  ManagementReview, ReviewAction,
};

================================================================================
FILE: QMS-Server-master/package.json
================================================================================

{
  "name": "fc-server",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "dev": "nodemon index.js",
    "start": "node index.js",
    "test": "cross-env NODE_ENV=test jest --detectOpenHandles",
    "test:watch": "cross-env NODE_ENV=test jest --watch",
    "test:coverage": "cross-env NODE_ENV=test jest --coverage"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "axios": "^1.13.2",
    "cors": "^2.8.5",
    "dotenv": "^16.4.7",
    "exceljs": "^4.4.0",
    "express": "^4.21.2",
    "express-fileupload": "^1.5.1",
    "express-oauth2-jwt-bearer": "^1.7.1",
    "jsonwebtoken": "^9.0.2",
    "multer": "^2.0.2",
    "node-ssh": "^13.2.1",
    "pdfmake": "^0.2.20",
    "pg": "^8.13.1",
    "pg-hstore": "^2.3.4",
    "sequelize": "^6.37.5",
    "uuid": "^11.1.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "cross-env": "^7.0.3",
    "jest": "^29.7.0",
    "nodemon": "^3.1.9",
    "sequelize-cli": "^6.6.5",
    "supertest": "^6.3.3"
  }
}

================================================================================
FILE: QMS-Server-master/routes/auditRouter.js
================================================================================




















const Router = require("express");
const router = new Router();
const auditController = require("../controllers/auditController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");


const protect = [authMiddleware, syncUserMiddleware, checkAbility("rbac.manage")];


const protectQmsAudit = [authMiddleware, syncUserMiddleware, checkAbility("qms.audit.verify")];
const protectQmsReport = [authMiddleware, syncUserMiddleware, checkAbility("qms.audit.report")];


router.get("/", ...protect, auditController.getLogs);


router.get("/stats", ...protect, auditController.getStats);
router.get("/verify", ...protectQmsAudit, auditController.quickVerify);
router.get("/verify/full", ...protectQmsAudit, auditController.fullVerify);
router.get("/report", ...protectQmsReport, auditController.inspectionReport);
router.get("/:id", ...protect, auditController.getOne);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/documentRouter.js
================================================================================

















const Router = require("express");
const router = new Router();
const documentController = require("../controllers/documentController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/",        ...protect, checkAbility("dms.view"), documentController.getAll);
router.get("/stats",   ...protect, checkAbility("dms.view"), documentController.getStats);
router.get("/pending", ...protect, documentController.getPending); 
router.get("/overdue", ...protect, checkAbility("dms.manage"), documentController.getOverdue);
router.get("/:id",     ...protect, checkAbility("dms.view"), documentController.getOne);


router.post("/",                       ...protect, checkAbility("dms.create"), documentController.create);
router.post("/:id/versions",          ...protect, checkAbility("dms.create"), documentController.createVersion);
router.post("/versions/:id/upload",   ...protect, checkAbility("dms.create"), documentController.uploadFile);


router.post("/versions/:id/submit",   ...protect, checkAbility("dms.create"), documentController.submitForReview);
router.post("/approvals/:id/decide",  ...protect, documentController.decide); 


router.post("/versions/:id/effective",  ...protect, checkAbility("dms.manage"), documentController.makeEffective);
router.post("/versions/:id/distribute", ...protect, checkAbility("dms.manage"), documentController.distribute);


router.post("/distributions/:id/ack", ...protect, documentController.acknowledge);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/index.js
================================================================================


const Router = require("express");
const router = new Router();

const userRouter = require("./userRouter");
const sessionRouter = require("./sessionRouter");
const pcRouter = require("./pcRouter");

const rbacRouter = require("./rbacRouter");
const structureRouter = require("./structureRouter");
const auditRouter = require("./auditRouter");

const warehouseRouter = require("./warehouseRouter");

const taskRouter = require("./taskRouter");
const projectRouter = require("./projectRouter");


const documentRouter = require("./documentRouter");
const ncCapaRouter = require("./ncCapaRouter");
const riskRouter = require("./riskRouter");




router.use("/users", userRouter);
router.use("/sessions", sessionRouter);
router.use("/pcs", pcRouter);

router.use("/rbac", rbacRouter);
router.use("/structure", structureRouter);
router.use("/audit", auditRouter);




router.use("/warehouse", warehouseRouter);

router.use("/tasks", taskRouter);
router.use("/projects", projectRouter);





router.use("/documents", documentRouter);

router.use("/nc", ncCapaRouter);

router.use("/risks", riskRouter);








module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/ncCapaRouter.js
================================================================================









const Router = require("express");
const router = new Router();
const ctrl = require("../controllers/ncCapaController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/stats", ...protect, checkAbility("nc.view"), ctrl.getStats);


router.get("/",          ...protect, checkAbility("nc.view"),   ctrl.getNcList);
router.get("/:id",       ...protect, checkAbility("nc.view"),   ctrl.getNcOne);
router.post("/",         ...protect, checkAbility("nc.create"), ctrl.createNc);
router.put("/:id",       ...protect, checkAbility("nc.manage"), ctrl.updateNc);
router.post("/:id/close",...protect, checkAbility("nc.manage"), ctrl.closeNc);


router.get("/capa",             ...protect, checkAbility("capa.view"),   ctrl.getCapaList);
router.get("/capa/:id",         ...protect, checkAbility("capa.view"),   ctrl.getCapaOne);
router.post("/capa",            ...protect, checkAbility("capa.create"), ctrl.createCapa);
router.put("/capa/:id/status",  ...protect, checkAbility("capa.manage"), ctrl.updateCapaStatus);
router.post("/capa/:id/actions",...protect, checkAbility("capa.manage"), ctrl.addCapaAction);
router.put("/capa/actions/:id", ...protect, checkAbility("capa.manage"), ctrl.updateCapaAction);
router.post("/capa/:id/verify", ...protect, checkAbility("capa.verify"), ctrl.verifyEffectiveness);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/pcRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const PCController = require("../controllers/pcController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/", ...protect, PCController.getPCs);


router.post("/", ...protect, checkAbility("users.manage"), PCController.postPC);
router.put("/", ...protect, checkAbility("users.manage"), PCController.updatePC);
router.delete("/:id", ...protect, checkAbility("users.manage"), PCController.deletePC);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/projectRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const controller = require("../controllers/ProjectController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post(
    "/",
    ...protect,
    checkAbility("recipe.manage"),
    controller.create
);


router.get(
    "/",
    ...protect,
    controller.getAll
);


router.delete(
    "/:id",
    ...protect,
    checkAbility("recipe.manage"),
    controller.delete
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/rbacRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const rbacController = require("../controllers/rbacController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");


const protect = [
    authMiddleware,
    syncUserMiddleware,
    checkAbility("rbac.manage")
];

router.get("/roles", ...protect, rbacController.getRoles);
router.get("/abilities", ...protect, rbacController.getAbilities);
router.post("/role/:roleId", ...protect, rbacController.updateRoleAbilities);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/riskRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const riskController = require("../controllers/riskController");
const authMiddleware = require("../middleware/authMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");


router.get("/",          authMiddleware, checkAbility("risk.read"),    riskController.getAll);
router.get("/matrix",    authMiddleware, checkAbility("risk.read"),    riskController.getMatrix);
router.get("/stats",     authMiddleware, checkAbility("risk.read"),    riskController.getStats);
router.get("/:id",       authMiddleware, checkAbility("risk.read"),    riskController.getOne);
router.post("/",         authMiddleware, checkAbility("risk.create"),  riskController.create);
router.put("/:id",       authMiddleware, checkAbility("risk.update"),  riskController.update);


router.post("/:id/assess",    authMiddleware, checkAbility("risk.assess"),  riskController.addAssessment);
router.post("/:id/accept",    authMiddleware, checkAbility("risk.accept"),  riskController.acceptRisk);


router.post("/:id/mitigation",                         authMiddleware, checkAbility("risk.update"),   riskController.addMitigation);
router.put("/mitigation/:mitigationId/complete",        authMiddleware, checkAbility("risk.update"),   riskController.completeMitigation);
router.put("/mitigation/:mitigationId/verify",          authMiddleware, checkAbility("risk.verify"),   riskController.verifyMitigation);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/sessionRouter.js
================================================================================

const Router = require("express");
const router = new Router();

const SessionController = require("../controllers/sessionController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post("/", ...protect, SessionController.postSession);
router.put("/", ...protect, SessionController.setOnlineSession);


router.get("/", ...protect, SessionController.getSessions);


router.get(
    "/offlineAll",
    ...protect,
    checkAbility("users.manage"),
    SessionController.setOfflineSession
);

router.get("/offAll", ...protect, checkAbility("users.manage"), SessionController.offlineSessionManual);
router.delete("/:id", ...protect, checkAbility("users.manage"), SessionController.deleteSession);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/structureRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const structureController = require("../controllers/structureController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/", ...protect, structureController.getFullStructure);
router.get("/users/unassigned", ...protect, checkAbility("users.manage"), structureController.getUnassignedUsers);


router.post("/section", ...protect, checkAbility("users.manage"), structureController.createSection);
router.post("/team", ...protect, checkAbility("users.manage"), structureController.createTeam);


router.put("/section/manager", ...protect, checkAbility("users.manage"), structureController.assignSectionManager);
router.put("/team/lead", ...protect, checkAbility("users.manage"), structureController.assignTeamLead);
router.put("/user/assign", ...protect, checkAbility("users.manage"), structureController.addMemberToTeam);
router.put("/user/remove", ...protect, checkAbility("users.manage"), structureController.removeMemberFromTeam);

module.exports = router;
================================================================================
FILE: QMS-Server-master/routes/taskRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const TaskController = require("../controllers/TaskController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/", ...protect, TaskController.getTasks);
router.get("/:id", ...protect, TaskController.getTaskById);

router.post("/", ...protect, checkAbility("users.manage"), TaskController.createTask);
router.delete("/:id", ...protect, checkAbility("users.manage"), TaskController.deleteTask);
router.put("/:id", ...protect, checkAbility("users.manage"), TaskController.updateFullTask);

router.patch("/:id/status", ...protect, checkAbility("assembly.execute"), TaskController.updateTaskStatus);

module.exports = router;
================================================================================
FILE: QMS-Server-master/routes/userRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const userController = require("../controllers/userController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/auth", ...protect, (req, res) => {
    return res.json(req.user);
});

router.get("/", ...protect, userController.getUsers);

router.get("/:id", ...protect, userController.getCurrentUser);
router.put("/", ...protect, userController.updateUser); 
router.patch("/", ...protect, userController.updateUserImg);

router.delete("/:id", ...protect, checkAbility("users.manage"), userController.deleteUser);

module.exports = router;
================================================================================
FILE: QMS-Server-master/routes/warehouseRouter.js
================================================================================

const Router = require("express");
const router = new Router();

const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const SupplyController = require("../controllers/warehouse/SupplyController");
const BoxController = require("../controllers/warehouse/BoxController");
const MovementController = require("../controllers/warehouse/MovementController");
const DocumentController = require("../controllers/warehouse/DocumentController");
const AnalyticsController = require("../controllers/warehouse/AnalyticsController");
const AlertsController = require("../controllers/warehouse/AlertsController");
const RankingsController = require("../controllers/RankingsController");
const HistoryController = require("../controllers/warehouse/HistoryController");

const protect = [authMiddleware, syncUserMiddleware];


router.post("/supplies", ...protect, checkAbility("warehouse.manage"), SupplyController.createSupply);
router.get("/supplies", ...protect, checkAbility("warehouse.view"), SupplyController.getSupplies);
router.get("/supplies/:id/export-csv", ...protect, checkAbility("warehouse.view"), SupplyController.exportCsv);


router.post("/boxes", ...protect, checkAbility("warehouse.manage"), BoxController.createSingleBox);
router.post("/boxes/batch", ...protect, checkAbility("warehouse.manage"), BoxController.createBoxesBatch);


router.put("/boxes/batch", ...protect, checkAbility("warehouse.manage"), BoxController.updateBatch);


router.get("/boxes", ...protect, checkAbility("warehouse.view"), BoxController.getBoxes);
router.get("/boxes/:id", ...protect, checkAbility("warehouse.view"), BoxController.getBoxById);
router.get("/boxes/by-qr/:qr", ...protect, checkAbility("warehouse.view"), BoxController.getBoxByQr);


router.post("/boxes/export", ...protect, checkAbility("warehouse.view"), BoxController.exportCsv);
router.post("/boxes/print-pdf", ...protect, checkAbility("labels.print"), BoxController.printLabelsPdf);


router.post("/boxes/print-special", ...protect, checkAbility("labels.print"), BoxController.printSpecialLabel);


router.get("/print-history", ...protect, checkAbility("labels.print"), HistoryController.getPrintHistory);


router.post("/movements", ...protect, checkAbility("warehouse.manage"), MovementController.moveSingle);
router.post("/movements/batch", ...protect, checkAbility("warehouse.manage"), MovementController.moveBatch);
router.get("/movements", ...protect, checkAbility("warehouse.view"), MovementController.getMovements);


router.get("/balance", ...protect, checkAbility("warehouse.view"), MovementController.getBalance);


router.post("/documents", ...protect, checkAbility("warehouse.manage"), DocumentController.createDocument);
router.get("/documents", ...protect, checkAbility("warehouse.view"), DocumentController.getDocuments);


router.get("/analytics/dashboard", ...protect, checkAbility("analytics.view"), AnalyticsController.getDashboardStats);

router.get("/rankings", ...protect, checkAbility("analytics.view"), RankingsController.getStats);


router.get("/alerts", ...protect, checkAbility("warehouse.view"), AlertsController.getAlerts);
router.get("/limits", ...protect, checkAbility("warehouse.view"), AlertsController.getAllLimits);
router.post("/limits", ...protect, checkAbility("warehouse.manage"), AlertsController.setLimit);

router.get("/rankings/user/:userId", ...protect, RankingsController.getUserDetails);


module.exports = router;

================================================================================
FILE: QMS-Server-master/run-migration.js
================================================================================



require("dotenv").config();
const { Sequelize } = require("sequelize");

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASSWORD,
  {
    dialect: "postgres",
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    logging: console.log
  }
);

async function runMigration() {
  try {
    console.log("üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...");
    await sequelize.authenticate();
    console.log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫:", process.env.DB_NAME);

    console.log("\nüöÄ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏: –î–µ—Ñ–µ–∫—Ç—ã + –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n");


    console.log("üìä –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ beryll_servers...");


    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "lastPingAt" TIMESTAMP;
    `).catch(e => console.log("  - lastPingAt:", e.message));


    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_servers_pingstatus') THEN
          CREATE TYPE "enum_beryll_servers_pingstatus" AS ENUM ('ONLINE', 'OFFLINE', 'UNKNOWN');
        END IF;
      END$$;
    `).catch(e => console.log("  - ENUM pingStatus:", e.message));


    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "pingStatus" "enum_beryll_servers_pingstatus" DEFAULT 'UNKNOWN';
    `).catch(e => console.log("  - pingStatus:", e.message));


    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "pingLatency" FLOAT;
    `).catch(e => console.log("  - pingLatency:", e.message));

    console.log("‚úÖ –ü–æ–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã\n");


    console.log("üí¨ –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É beryll_defect_comments...");

    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_defect_comments_defectcategory') THEN
          CREATE TYPE "enum_beryll_defect_comments_defectcategory" AS ENUM ('HARDWARE', 'SOFTWARE', 'ASSEMBLY', 'COMPONENT', 'OTHER');
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_defect_comments_priority') THEN
          CREATE TYPE "enum_beryll_defect_comments_priority" AS ENUM ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL');
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_defect_comments_status') THEN
          CREATE TYPE "enum_beryll_defect_comments_status" AS ENUM ('NEW', 'IN_PROGRESS', 'RESOLVED', 'WONT_FIX');
        END IF;
      END$$;
    `);

    await sequelize.query(`
      CREATE TABLE IF NOT EXISTS beryll_defect_comments (
        id SERIAL PRIMARY KEY,
        "serverId" INTEGER NOT NULL REFERENCES beryll_servers(id) ON UPDATE CASCADE ON DELETE CASCADE,
        "userId" INTEGER NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        text TEXT NOT NULL,
        "defectCategory" "enum_beryll_defect_comments_defectcategory" DEFAULT 'OTHER',
        priority "enum_beryll_defect_comments_priority" DEFAULT 'MEDIUM',
        status "enum_beryll_defect_comments_status" NOT NULL DEFAULT 'NEW',
        "resolvedById" INTEGER REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        "resolvedAt" TIMESTAMP,
        resolution TEXT,
        "createdAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        "updatedAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
      );
    `);


    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_server ON beryll_defect_comments("serverId");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_status ON beryll_defect_comments(status);`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_category ON beryll_defect_comments("defectCategory");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_priority ON beryll_defect_comments(priority);`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_created ON beryll_defect_comments("createdAt");`);

    console.log("‚úÖ –¢–∞–±–ª–∏—Ü–∞ beryll_defect_comments —Å–æ–∑–¥–∞–Ω–∞\n");


    console.log("üìé –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É beryll_defect_files...");

    await sequelize.query(`
      CREATE TABLE IF NOT EXISTS beryll_defect_files (
        id SERIAL PRIMARY KEY,
        "commentId" INTEGER NOT NULL REFERENCES beryll_defect_comments(id) ON UPDATE CASCADE ON DELETE CASCADE,
        "originalName" VARCHAR(255) NOT NULL,
        "fileName" VARCHAR(255) NOT NULL,
        "filePath" VARCHAR(500) NOT NULL,
        "mimeType" VARCHAR(100),
        "fileSize" INTEGER,
        "uploadedById" INTEGER REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        "createdAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
      );
    `);

    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_files_comment ON beryll_defect_files("commentId");`);

    console.log("‚úÖ –¢–∞–±–ª–∏—Ü–∞ beryll_defect_files —Å–æ–∑–¥–∞–Ω–∞\n");


    console.log("üìù –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ action —Ç–∏–ø—ã –≤ –∏—Å—Ç–æ—Ä–∏—é...");

    const newActions = [
      'DEFECT_COMMENT_ADDED',
      'DEFECT_STATUS_CHANGED',
      'DEFECT_COMMENT_DELETED',
      'DEFECT_FILE_UPLOADED',
      'DEFECT_FILE_DELETED'
    ];

    for (const action of newActions) {
      await sequelize.query(`
        DO $$
        BEGIN
          ALTER TYPE "enum_beryll_history_action" ADD VALUE IF NOT EXISTS '${action}';
        EXCEPTION
          WHEN duplicate_object THEN NULL;
        END$$;
      `).catch(e => console.log(`  - ${action}: —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`));
    }

    console.log("‚úÖ Action —Ç–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã\n");


    const fs = require("fs");
    const path = require("path");
    const uploadsDir = path.join(__dirname, "uploads/beryll/defects");

    if (!fs.existsSync(uploadsDir)) {
      fs.mkdirSync(uploadsDir, { recursive: true });
      console.log("üìÅ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞:", uploadsDir);
    } else {
      console.log("üìÅ –ü–∞–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", uploadsDir);
    }

    console.log("\n" + "=".repeat(50));
    console.log("‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!");
    console.log("=".repeat(50));


    const [tables] = await sequelize.query(`
      SELECT table_name FROM information_schema.tables
      WHERE table_schema = 'public' AND table_name LIKE 'beryll%'
      ORDER BY table_name;
    `);
    console.log("\nüìã –¢–∞–±–ª–∏—Ü—ã Beryll:");
    tables.forEach(t => console.log("  -", t.table_name));

  } catch (error) {
    console.error("\n‚ùå –û–®–ò–ë–ö–ê –ú–ò–ì–†–ê–¶–ò–ò:", error.message);
    console.error(error);
    process.exit(1);
  } finally {
    await sequelize.close();
    console.log("\nüîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
  }
}

runMigration();

================================================================================
FILE: QMS-Server-master/scripts/backfill-audit-hashes.js
================================================================================



















require("dotenv").config();
const sequelize = require("../db");
const { AuditLog } = require("../models/index");
const { computeDataHash, computeChainHash, GENESIS_HASH } = require("../utils/hashChainLogger");

const BATCH_SIZE = 100;

async function backfill() {
  console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  console.log("  ASVO-QMS: Backfill hash-chain –¥–ª—è audit_logs");
  console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");

  
  const unchainedCount = await AuditLog.count({
    where: { chainIndex: null },
  });

  const chainedCount = await AuditLog.count({
    where: { chainIndex: { [sequelize.Sequelize.Op.ne]: null } },
  });

  console.log(`–ó–∞–ø–∏—Å–µ–π –±–µ–∑ hash-chain: ${unchainedCount}`);
  console.log(`–ó–∞–ø–∏—Å–µ–π —Å hash-chain:   ${chainedCount}`);

  if (unchainedCount === 0) {
    console.log("\n‚úÖ –í—Å–µ –∑–∞–ø–∏—Å–∏ —É–∂–µ –∏–º–µ—é—Ç hash-chain. –ù–µ—á–µ–≥–æ –¥–µ–ª–∞—Ç—å.");
    process.exit(0);
  }

  
  let startChainIndex = 1;
  let prevHash = GENESIS_HASH;

  if (chainedCount > 0) {
    const lastChained = await AuditLog.findOne({
      where: { chainIndex: { [sequelize.Sequelize.Op.ne]: null } },
      order: [["chainIndex", "DESC"]],
      attributes: ["chainIndex", "currentHash"],
      raw: true,
    });

    if (lastChained) {
      startChainIndex = Number(lastChained.chainIndex) + 1;
      prevHash = lastChained.currentHash;
      console.log(`–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–µ–ø–æ—á–∫—É —Å chainIndex=${startChainIndex}`);
    }
  }

  console.log(`\n–ù–∞—á–∏–Ω–∞–µ–º backfill —Å chainIndex=${startChainIndex}...\n`);

  
  let processed = 0;
  let currentChainIndex = startChainIndex;
  let currentPrevHash = prevHash;
  const startTime = Date.now();

  while (true) {
    
    const records = await AuditLog.findAll({
      where: { chainIndex: null },
      order: [["createdAt", "ASC"], ["id", "ASC"]],
      limit: BATCH_SIZE,
      raw: true,
    });

    if (records.length === 0) break;

    
    const transaction = await sequelize.transaction();

    try {
      for (const record of records) {
        const dataHash = computeDataHash({
          userId: record.userId,
          action: record.action,
          entity: record.entity,
          entityId: record.entityId,
          description: record.description,
          metadata: record.metadata,
          createdAt: record.createdAt,
        });

        const currentHash = computeChainHash(currentChainIndex, currentPrevHash, dataHash);

        await AuditLog.update(
          {
            chainIndex: currentChainIndex,
            prevHash: currentPrevHash,
            currentHash,
            dataHash,
            severity: record.severity || "INFO",
          },
          {
            where: { id: record.id },
            transaction,
          }
        );

        currentPrevHash = currentHash;
        currentChainIndex++;
        processed++;
      }

      await transaction.commit();

      
      const percent = Math.round((processed / unchainedCount) * 100);
      const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      const rate = Math.round(processed / (elapsed || 1));
      process.stdout.write(
        `\r  [${percent}%] ${processed}/${unchainedCount} –∑–∞–ø–∏—Å–µ–π | ${elapsed}s | ${rate} –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫`
      );
    } catch (error) {
      await transaction.rollback();
      console.error(`\n\n‚ùå –û—à–∏–±–∫–∞ –Ω–∞ –∑–∞–ø–∏—Å–∏ #${processed + 1}:`, error.message);
      process.exit(1);
    }
  }

  const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);

  console.log(`\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
  console.log(`  ‚úÖ Backfill –∑–∞–≤–µ—Ä—à—ë–Ω!`);
  console.log(`  –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processed} –∑–∞–ø–∏—Å–µ–π`);
  console.log(`  –í—Ä–µ–º—è: ${totalTime}s`);
  console.log(`  chainIndex: ${startChainIndex} ‚Üí ${currentChainIndex - 1}`);
  console.log(`  –ü–æ—Å–ª–µ–¥–Ω–∏–π hash: ${currentPrevHash.substring(0, 16)}...`);
  console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`);

  
  console.log("–ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é...");
  const { quickVerify } = require("../utils/auditVerifier");
  const report = await quickVerify(Math.min(processed, 100));

  if (report.valid) {
    console.log(`‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞: ${report.validRecords}/${report.totalRecords} –∑–∞–ø–∏—Å–µ–π –û–ö`);
  } else {
    console.log(`‚ùå –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏: ${report.invalidRecords} –Ω–∞—Ä—É—à–µ–Ω–∏–π`);
    report.errors.forEach((e) => {
      console.log(`   chainIndex=${e.chainIndex}: ${e.errors.join("; ")}`);
    });
  }

  process.exit(0);
}

backfill().catch((err) => {
  console.error("Fatal error:", err);
  process.exit(1);
});

================================================================================
FILE: QMS-Server-master/scripts/cleanup-mes-legacy.sh
================================================================================

#!/bin/bash




















set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${YELLOW}  ASVO-QMS: –û—á–∏—Å—Ç–∫–∞ –æ—Ç –¥—Ä–æ–Ω/Beryll —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏              ${NC}"
echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo ""


if [ ! -d "QMS-Server-master" ] && [ ! -d "QMS-Client-main" ]; then
  echo -e "${RED}–û—à–∏–±–∫–∞: –∑–∞–ø—É—Å–∫–∞–π –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ (–≥–¥–µ –ª–µ–∂–∞—Ç QMS-Server-master –∏ QMS-Client-main)${NC}"
  exit 1
fi

DELETED=0

delete_if_exists() {
  if [ -e "$1" ]; then
    rm -rf "$1"
    echo -e "  ${RED}‚úï${NC} $1"
    ((DELETED++))
  fi
}




echo -e "\n${GREEN}[1/8] –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã...${NC}"


delete_if_exists "QMS-Server-master/controllers/beryll"


delete_if_exists "QMS-Server-master/controllers/fcController.js"
delete_if_exists "QMS-Server-master/controllers/coralB_Controller.js"
delete_if_exists "QMS-Server-master/controllers/ELRS2_4_Controller.js"
delete_if_exists "QMS-Server-master/controllers/ELRS915_Controller.js"
delete_if_exists "QMS-Server-master/controllers/RankingsController.js"




echo -e "\n${GREEN}[2/8] –°–µ—Ä–≤–µ—Ä–Ω—ã–µ —Ä–æ—É—Ç—ã...${NC}"

delete_if_exists "QMS-Server-master/routes/beryllRouter.js"
delete_if_exists "QMS-Server-master/routes/beryllExtendedRouter.js"
delete_if_exists "QMS-Server-master/routes/beryll"
delete_if_exists "QMS-Server-master/routes/fcRouter.js"
delete_if_exists "QMS-Server-master/routes/CoralBRouter.js"
delete_if_exists "QMS-Server-master/routes/ELRS2_4_Router.js"
delete_if_exists "QMS-Server-master/routes/ELRS915_Router.js"
delete_if_exists "QMS-Server-master/routes/defectRouter915.js"
delete_if_exists "QMS-Server-master/routes/defectRouter2_4.js"
delete_if_exists "QMS-Server-master/routes/defectRouterCoralB.js"
delete_if_exists "QMS-Server-master/routes/passportsExportRoutes.js"




echo -e "\n${GREEN}[3/8] –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –º–æ–¥–µ–ª–∏...${NC}"

delete_if_exists "QMS-Server-master/models/BeryllExtended.js"
delete_if_exists "QMS-Server-master/models/definitions/Beryll.js"
delete_if_exists "QMS-Server-master/models/definitions/BeryllExtended.js"
delete_if_exists "QMS-Server-master/models/definitions/ComponentModels.js"
delete_if_exists "QMS-Server-master/models/definitions/YadroIntegration.js"




echo -e "\n${GREEN}[4/8] Beryll-–º–∏–≥—Ä–∞—Ü–∏–∏ (–ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –∞—Ä—Ö–∏–≤)...${NC}"

mkdir -p "QMS-Server-master/migrations/_archive_beryll"
for f in QMS-Server-master/migrations/*beryll* QMS-Server-master/migrations/*Beryll* QMS-Server-master/migrations/*Yadro* QMS-Server-master/migrations/*yadro*; do
  if [ -e "$f" ]; then
    mv "$f" "QMS-Server-master/migrations/_archive_beryll/"
    echo -e "  ${YELLOW}‚Üí${NC} $f ‚Üí _archive_beryll/"
    ((DELETED++))
  fi
done




echo -e "\n${GREEN}[5/8] –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ API...${NC}"

delete_if_exists "QMS-Client-main/src/api/beryll"
delete_if_exists "QMS-Client-main/src/api/beryllApi.ts"
delete_if_exists "QMS-Client-main/src/api/beryllExtendedApi.ts"
delete_if_exists "QMS-Client-main/src/api/coralBApi.ts"
delete_if_exists "QMS-Client-main/src/api/elrsApi.ts"
delete_if_exists "QMS-Client-main/src/api/fcApi.ts"
delete_if_exists "QMS-Client-main/src/api/firmwareApi.ts"
delete_if_exists "QMS-Client-main/src/api/firmwareControlApi.ts"
delete_if_exists "QMS-Client-main/src/api/mqttApi.ts"
delete_if_exists "QMS-Client-main/src/api/rankingsApi.ts"




echo -e "\n${GREEN}[6/8] –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...${NC}"


delete_if_exists "QMS-Client-main/src/pages/Beryll"
delete_if_exists "QMS-Client-main/src/pages/beryll"


delete_if_exists "QMS-Client-main/src/pages/Firmware"
delete_if_exists "QMS-Client-main/src/pages/FirmwareOld"


delete_if_exists "QMS-Client-main/src/pages/BetaFlight"


delete_if_exists "QMS-Client-main/src/pages/MqttCheck"


delete_if_exists "QMS-Client-main/src/pages/Rankings"


delete_if_exists "QMS-Client-main/src/pages/Tables/CoralBs"
delete_if_exists "QMS-Client-main/src/pages/Tables/ELRS24s"
delete_if_exists "QMS-Client-main/src/pages/Tables/ELRS915s"
delete_if_exists "QMS-Client-main/src/pages/Tables/FlightController"


delete_if_exists "QMS-Client-main/src/pages/Admin/CreateModals/CreateCoralB.tsx"
delete_if_exists "QMS-Client-main/src/pages/Admin/CreateModals/CreateELRS.tsx"
delete_if_exists "QMS-Client-main/src/pages/Admin/CreateModals/CreateFC.tsx"


delete_if_exists "QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminDefect_Coral_B_categories.tsx"




echo -e "\n${GREEN}[7/8] –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, —Å—Ç–æ—Ä—ã, —Ç–∏–ø—ã...${NC}"


delete_if_exists "QMS-Client-main/src/components/beryll"


delete_if_exists "QMS-Client-main/src/store/Coral_B_store.ts"
delete_if_exists "QMS-Client-main/src/store/ELRS_915_and_2_4_store.ts"
delete_if_exists "QMS-Client-main/src/store/FC_store.ts"


delete_if_exists "QMS-Client-main/src/types/BoardsForFlashModel.ts"
delete_if_exists "QMS-Client-main/src/types/beryll"




echo -e "\n${GREEN}[8/8] –ú–æ–±–∏–ª—å–Ω–æ–µ PWA ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞...${NC}"


if grep -rql "beryll\|firmware\|betaflight\|mqtt\|coral\|elrs" QMS-Mobile/mes-pwa/src/ 2>/dev/null; then
  echo -e "  ${YELLOW}‚ö† –í PWA –Ω–∞–π–¥–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ ‚Äî –Ω—É–∂–Ω–∞ —Ä—É—á–Ω–∞—è –ø—Ä–∞–≤–∫–∞:${NC}"
  grep -rn "beryll\|firmware\|betaflight\|mqtt\|coral\|elrs" QMS-Mobile/mes-pwa/src/ 2>/dev/null || true
else
  echo -e "  ${GREEN}‚úì${NC} PWA —á–∏—Å—Ç ‚Äî –¥—Ä–æ–Ω-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ –Ω–µ—Ç"
fi





echo -e "\n${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${GREEN}  ‚úÖ –£–¥–∞–ª–µ–Ω–æ/–ø–µ—Ä–µ–º–µ—â–µ–Ω–æ: ${DELETED} —Ñ–∞–π–ª–æ–≤/–∫–∞—Ç–∞–ª–æ–≥–æ–≤${NC}"
echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

echo -e "\n${YELLOW}‚ö† –†–£–ß–ù–ê–Ø –î–û–†–ê–ë–û–¢–ö–ê (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):${NC}"
echo ""
echo -e "  1. ${RED}QMS-Server-master/routes/index.js${NC}"
echo -e "     –£–¥–∞–ª–∏ —Å—Ç—Ä–æ–∫–∏ —Å require –∏ router.use –¥–ª—è:"
echo -e "     fcRouter, CoralBRouter, ELRS915_Router, ELRS2_4_Router,"
echo -e "     defectRouter915, defectRouter2_4, defectRouterCoralB,"
echo -e "     beryllRouter, passportsExportRoutes"
echo ""
echo -e "  2. ${RED}QMS-Server-master/models/index.js${NC}"
echo -e "     –£–¥–∞–ª–∏ require –¥–ª—è: Beryll, BeryllExtended, ComponentModels, YadroIntegration"
echo -e "     –£–¥–∞–ª–∏ –≤—Å–µ associations –¥–ª—è Beryll* –º–æ–¥–µ–ª–µ–π"
echo ""
echo -e "  3. ${RED}QMS-Server-master/index.js${NC}"
echo -e "     –£–¥–∞–ª–∏: require('./routes/beryllExtendedRouter')"
echo -e "     –£–¥–∞–ª–∏: require('./controllers/beryll').initChecklistTemplates"
echo -e "     –£–¥–∞–ª–∏: app.use('/api/beryll', beryllExtendedRouter)"
echo ""
echo -e "  4. ${RED}QMS-Client-main/src/App.tsx${NC}"
echo -e "     –£–¥–∞–ª–∏ –∏–º–ø–æ—Ä—Ç—ã –∏ <Route> –¥–ª—è:"
echo -e "     Beryll*, Firmware*, BetaFlight, MqttCheck, Rankings,"
echo -e "     CoralBs, ELRS*, FlightController, CreateFC/ELRS/CoralB"
echo ""
echo -e "  5. ${RED}QMS-Client-main/src/utils/consts.ts${NC}"
echo -e "     –£–¥–∞–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü"
echo ""
echo -e "  6. –ü—Ä–æ–≤–µ—Ä—å —Å–±–æ—Ä–∫—É:"
echo -e "     cd QMS-Server-master && npm start"
echo -e "     cd QMS-Client-main && npm run build"
echo ""
echo -e "${GREEN}–ì–æ—Ç–æ–≤–æ! –ö–æ–¥–æ–≤–∞—è –±–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞ –æ—Ç –¥—Ä–æ–Ω/Beryll —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏.${NC}"

================================================================================
FILE: QMS-Server-master/scripts/import_nov_dec_2025.js
================================================================================



require('dotenv').config();

const { Sequelize, DataTypes, Op } = require("sequelize");


const sequelize = new Sequelize(
    process.env.DB_NAME || 'flight_controller_database',
    process.env.DB_USER || 'postgres',
    process.env.DB_PASSWORD || '',
    {
        host: process.env.DB_HOST || 'localhost',
        port: process.env.DB_PORT || 5432,
        dialect: 'postgres',
        logging: false
    }
);


const User = sequelize.define("user", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING },
    surname: { type: DataTypes.STRING },
}, {
    tableName: "users",
    timestamps: false
});

const OperationType = sequelize.define("operation_type", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING(100), allowNull: false },
    code: { type: DataTypes.STRING(50), allowNull: true },
    description: { type: DataTypes.TEXT, allowNull: true },
    unit: { type: DataTypes.STRING(20), allowNull: false, defaultValue: '—à—Ç' },
    normMinutes: { type: DataTypes.FLOAT, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    isActive: { type: DataTypes.BOOLEAN, defaultValue: true },
    sortOrder: { type: DataTypes.INTEGER, defaultValue: 0 }
}, {
    tableName: "operation_types",
    timestamps: true
});

const ProductionOutput = sequelize.define("production_output", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    date: { type: DataTypes.DATEONLY, allowNull: false },
    userId: { type: DataTypes.INTEGER, allowNull: false },
    teamId: { type: DataTypes.INTEGER, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    projectId: { type: DataTypes.INTEGER, allowNull: true },
    taskId: { type: DataTypes.INTEGER, allowNull: true },
    operationTypeId: { type: DataTypes.INTEGER, allowNull: true },
    claimedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    approvedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    rejectedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    status: { type: DataTypes.STRING(20), allowNull: false, defaultValue: 'approved' },
    approvedById: { type: DataTypes.INTEGER, allowNull: true },
    approvedAt: { type: DataTypes.DATE, allowNull: true },
    createdById: { type: DataTypes.INTEGER, allowNull: true },
    comment: { type: DataTypes.TEXT, allowNull: true },
    rejectReason: { type: DataTypes.TEXT, allowNull: true }
}, {
    tableName: "production_outputs",
    timestamps: true
});


const IMPORT_DATA = [

  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2025-11-01", "quantity": 175, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2025-11-05", "quantity": 180, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2025-11-01", "quantity": 60, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2025-11-05", "quantity": 180, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2025-11-01", "quantity": 50, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2025-11-05", "quantity": 210, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2025-11-01", "quantity": 200, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2025-11-05", "quantity": 260, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-11-01", "quantity": 120, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-11-05", "quantity": 120, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2025-11-01", "quantity": 170, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2025-11-05", "quantity": 200, "month_name": "–ù–æ—è–±—Ä—å 2025"},


  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2025-12-01", "quantity": 20, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2025-12-01", "quantity": 60, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2025-12-01", "quantity": 20, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2025-12-01", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-12-01", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-12-12", "quantity": 100, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2025-12-01", "quantity": 260, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2025-12-02", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö–∏—Ä—Å–∞–Ω–æ–≤ –û–ª–µ–≥ (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-01", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö–∏—Ä—Å–∞–Ω–æ–≤ –û–ª–µ–≥ (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–û–≤—Å—è–Ω–Ω–∏–∫–æ–≤ –ê–Ω–¥—Ä–µ–π (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-01", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–û–≤—Å—è–Ω–Ω–∏–∫–æ–≤ –ê–Ω–¥—Ä–µ–π (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2025-12-01", "quantity": 220, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2025-12-02", "quantity": 100, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-01", "quantity": 160, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-11", "quantity": 60, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-12", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2025-12-01", "quantity": 300, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2025-12-01", "quantity": 280, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2025-12-02", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
];


const NAME_VARIANTS = {

  "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è": ["–ó–µ–ª–µ–Ω–æ–≤–∞", "–ê–Ω–∞—Å—Ç–∞—Å–∏—è"],
  "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å": ["–ú–æ—Ä–æ–∑–æ–≤", "–î–µ–Ω–∏—Å"],
  "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥": ["–ö—Ä—ã–ª–æ–≤", "–û–ª–µ–≥"],
  "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π": ["–¢–∞—Ä–∞—Å–æ–≤", "–ê–ª–µ–∫—Å–µ–π"],
  "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞": ["–°–∞–ø—Ä–∏–Ω–∞", "–ï–ª–µ–Ω–∞"],
  "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω": ["–°—ã—Å–æ–µ–≤", "–ò–≤–∞–Ω"],

  "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å": ["–ú–∏—à–∏–Ω", "–ò–≥–æ—Ä—å"],
  "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π": ["–ò—à–∏–Ω", "–ê–ª–µ–∫—Å–µ–π"],
  "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä": ["–ë–æ–≥–æ–º–æ–ª–æ–≤", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä"],
  "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä": ["–ó–∏–∞—Ç–¥–∏–Ω–æ–≤", "–ê—Ä—Ç—É—Ä"],
  "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω": ["–î—Ä–æ–≥–∞–Ω", "–í–ª–∞–¥–∏—Å–ª–∞–≤"],
  "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π": ["–°–∞—É—Ç–∏–Ω", "–î–º–∏—Ç—Ä–∏–π"],


};


async function findOrCreateOperationType() {
    let opType = await OperationType.findOne({
        where: { code: "THERMAL_CALIBRATION" }
    });

    if (!opType) {
        opType = await OperationType.create({
            name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞",
            code: "THERMAL_CALIBRATION",
            description: "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤ (–∏–º–ø–æ—Ä—Ç –∏–∑ Excel)",
            unit: "—à—Ç",
            isActive: true
        });
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: ${opType.name} (ID: ${opType.id})`);
    } else {
        console.log(`‚ÑπÔ∏è  –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${opType.name} (ID: ${opType.id})`);
    }

    return opType;
}

async function findUserByName(fullName) {
    const variants = NAME_VARIANTS[fullName];
    if (!variants) {
        return null;
    }

    const [surname, name] = variants;


    let user = await User.findOne({
        where: { surname, name }
    });

    if (!user) {

        user = await User.findOne({
            where: {
                [Op.and]: [
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('surname')),
                        surname.toLowerCase()
                    ),
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('name')),
                        name.toLowerCase()
                    )
                ]
            }
        });
    }

    return user;
}

async function importData() {
    try {

        await sequelize.authenticate();
        console.log("üì¶ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
        console.log(`   –ë–∞–∑–∞: ${process.env.DB_NAME || 'flight_controller_database'}`);
        console.log(`   –•–æ—Å—Ç: ${process.env.DB_HOST || 'localhost'}\n`);


        const operationType = await findOrCreateOperationType();
        const operationTypeId = operationType.id;


        const stats = {
            total: IMPORT_DATA.length,
            success: 0,
            skipped: 0,
            userNotFound: [],
            duplicates: 0,
            byMonth: {}
        };


        const userCache = new Map();

        console.log("\nüîÑ –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç –ù–æ—è–±—Ä—å-–î–µ–∫–∞–±—Ä—å 2025...\n");

        for (const record of IMPORT_DATA) {
            const { employee, date, quantity, month_name } = record;


            let userId = userCache.get(employee);

            if (userId === undefined) {
                const user = await findUserByName(employee);
                if (user) {
                    userId = user.id;
                    userCache.set(employee, userId);
                    console.log(`üë§ –ù–∞–π–¥–µ–Ω: ${employee} -> ID ${userId}`);
                } else {
                    userCache.set(employee, null);
                    if (!stats.userNotFound.includes(employee)) {
                        stats.userNotFound.push(employee);
                        console.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω: ${employee}`);
                    }
                }
            }

            if (!userId) {
                stats.skipped++;
                continue;
            }


            const existing = await ProductionOutput.findOne({
                where: {
                    userId,
                    date,
                    operationTypeId,
                    claimedQty: quantity
                }
            });

            if (existing) {
                stats.duplicates++;
                continue;
            }


            await ProductionOutput.create({
                date,
                userId,
                operationTypeId,
                claimedQty: quantity,
                approvedQty: quantity,
                status: 'approved',
                comment: `–ò–º–ø–æ—Ä—Ç –∏–∑ Excel (${month_name})`
            });

            stats.success++;
            stats.byMonth[month_name] = (stats.byMonth[month_name] || 0) + 1;
        }


        console.log("\n" + "=".repeat(50));
        console.log("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ú–ü–û–†–¢–ê:");
        console.log("=".repeat(50));
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${stats.success}`);
        console.log(`‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${stats.skipped}`);
        console.log(`üîÑ –î—É–±–ª–∏–∫–∞—Ç—ã: ${stats.duplicates}`);

        console.log(`\nüìÖ –ü–æ –º–µ—Å—è—Ü–∞–º:`);
        for (const [month, count] of Object.entries(stats.byMonth)) {
            console.log(`   ${month}: ${count} –∑–∞–ø–∏—Å–µ–π`);
        }

        if (stats.userNotFound.length > 0) {
            console.log(`\n‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (${stats.userNotFound.length}):`);
            stats.userNotFound.forEach(name => console.log(`   - ${name}`));
        }

        console.log("\n‚ú® –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!");

    } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", error);
    } finally {
        await sequelize.close();
    }
}


importData();

================================================================================
FILE: QMS-Server-master/scripts/import_production_outputs.js
================================================================================



require('dotenv').config();

const { Sequelize, DataTypes, Op } = require("sequelize");


const sequelize = new Sequelize(
    process.env.DB_NAME || 'flight_controller_database',
    process.env.DB_USER || 'postgres',
    process.env.DB_PASSWORD || '',
    {
        host: process.env.DB_HOST || 'localhost',
        port: process.env.DB_PORT || 5432,
        dialect: 'postgres',
        logging: false
    }
);


const User = sequelize.define("user", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING },
    surname: { type: DataTypes.STRING },
}, {
    tableName: "users",
    timestamps: false
});

const OperationType = sequelize.define("operation_type", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING(100), allowNull: false },
    code: { type: DataTypes.STRING(50), allowNull: true },
    description: { type: DataTypes.TEXT, allowNull: true },
    unit: { type: DataTypes.STRING(20), allowNull: false, defaultValue: '—à—Ç' },
    normMinutes: { type: DataTypes.FLOAT, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    isActive: { type: DataTypes.BOOLEAN, defaultValue: true },
    sortOrder: { type: DataTypes.INTEGER, defaultValue: 0 }
}, {
    tableName: "operation_types",
    timestamps: true
});

const ProductionOutput = sequelize.define("production_output", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    date: { type: DataTypes.DATEONLY, allowNull: false },
    userId: { type: DataTypes.INTEGER, allowNull: false },
    teamId: { type: DataTypes.INTEGER, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    projectId: { type: DataTypes.INTEGER, allowNull: true },
    taskId: { type: DataTypes.INTEGER, allowNull: true },
    operationTypeId: { type: DataTypes.INTEGER, allowNull: true },
    claimedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    approvedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    rejectedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    status: { type: DataTypes.STRING(20), allowNull: false, defaultValue: 'approved' },
    approvedById: { type: DataTypes.INTEGER, allowNull: true },
    approvedAt: { type: DataTypes.DATE, allowNull: true },
    createdById: { type: DataTypes.INTEGER, allowNull: true },
    comment: { type: DataTypes.TEXT, allowNull: true },
    rejectReason: { type: DataTypes.TEXT, allowNull: true }
}, {
    tableName: "production_outputs",
    timestamps: true
});


const IMPORT_DATA = [
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2025-12-01", "quantity": 20, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2025-12-01", "quantity": 60, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2025-12-01", "quantity": 20, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2025-12-01", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-12-01", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-12-12", "quantity": 100, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2025-12-01", "quantity": 260, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2025-12-02", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö–∏—Ä—Å–∞–Ω–æ–≤ –û–ª–µ–≥ (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-01", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö–∏—Ä—Å–∞–Ω–æ–≤ –û–ª–µ–≥ (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–û–≤—Å—è–Ω–Ω–∏–∫–æ–≤ –ê–Ω–¥—Ä–µ–π (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-01", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–û–≤—Å—è–Ω–Ω–∏–∫–æ–≤ –ê–Ω–¥—Ä–µ–π (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2025-12-01", "quantity": 220, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2025-12-02", "quantity": 100, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-01", "quantity": 160, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-09", "quantity": 60, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-12", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2025-12-01", "quantity": 300, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2025-12-01", "quantity": 280, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2025-12-02", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2026-01-13", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2026-01-14", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2026-01-15", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2026-01-16", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-13", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-14", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-16", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-19", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-20", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-13", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-14", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-15", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-16", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-19", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-20", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-13", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-14", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-15", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-16", "quantity": 260, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-19", "quantity": 300, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-13", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-14", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-15", "quantity": 260, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-16", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-19", "quantity": 260, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-20", "quantity": 140, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-21", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-13", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-14", "quantity": 140, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-15", "quantity": 170, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-16", "quantity": 170, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-19", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-20", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-21", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-13", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-14", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-15", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-16", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-19", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-13", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-14", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-16", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-19", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-20", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-13", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-14", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-15", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-16", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-19", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-20", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-21", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-14", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-16", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-19", "quantity": 170, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-20", "quantity": 170, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-13", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-14", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-15", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-16", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-19", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-20", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-21", "quantity": 60, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-13", "quantity": 50, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-14", "quantity": 230, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-16", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-19", "quantity": 150, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-20", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-13", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-14", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-15", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-16", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-19", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-21", "quantity": 60, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-13", "quantity": 60, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-14", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-16", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-19", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–®–∞—Ç–∏–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-13", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–®–∞—Ç–∏–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-14", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–®–∞—Ç–∏–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-15", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-13", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-14", "quantity": 140, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-15", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-16", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-19", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-21", "quantity": 140, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-13", "quantity": 50, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-14", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-15", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-16", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-19", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-13", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-14", "quantity": 300, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-16", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-19", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-13", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-14", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-15", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-16", "quantity": 340, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-19", "quantity": 400, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-20", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"}
];


const NAME_VARIANTS = {
  "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª": ["–ë–∞–ª–∞—à–∞–π—Ç–∏—Å", "–ö–∏—Ä–∏–ª–ª"],
  "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä": ["–ë–æ–≥–æ–º–æ–ª–æ–≤", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä"],
  "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω": ["–î—Ä–æ–≥–∞–Ω", "–í–ª–∞–¥–∏—Å–ª–∞–≤"],
  "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π": ["–î—É—Ä—è–≥–∏–Ω", "–ê–Ω–¥—Ä–µ–π"],
  "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è": ["–ó–µ–ª–µ–Ω–æ–≤–∞", "–ê–Ω–∞—Å—Ç–∞—Å–∏—è"],
  "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä": ["–ó–∏–∞—Ç–¥–∏–Ω–æ–≤", "–ê—Ä—Ç—É—Ä"],
  "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤": ["–í–∞—Å–∏–ª—å–µ–≤", "–ò–æ—Å–∏—Ñ"],
  "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π": ["–ò—à–∏–Ω", "–ê–ª–µ–∫—Å–µ–π"],
  "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π": ["–ö—Ä–∏–≤–æ—à–µ–∏–Ω", "–ì—Ä–∏–≥–æ—Ä–∏–π"],
  "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥": ["–ö—Ä—ã–ª–æ–≤", "–û–ª–µ–≥"],
  "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å": ["–ú–∏—à–∏–Ω", "–ò–≥–æ—Ä—å"],
  "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å": ["–ú–æ—Ä–æ–∑–æ–≤", "–î–µ–Ω–∏—Å"],
  "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º": ["–ú–æ—Ö–æ–≤", "–ê—Ä—Ç–µ–º"],
  "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞": ["–°–∞–ø—Ä–∏–Ω–∞", "–ï–ª–µ–Ω–∞"],
  "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π": ["–°–∞—É—Ç–∏–Ω", "–î–º–∏—Ç—Ä–∏–π"],
  "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω": ["–°—ã—Å–æ–µ–≤", "–ò–≤–∞–Ω"],
  "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π": ["–¢–∞—Ä–∞—Å–æ–≤", "–ê–ª–µ–∫—Å–µ–π"],
  "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä": ["–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä"],
  "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π": ["–ß–∏—Ä–∫–∞", "–î–º–∏—Ç—Ä–∏–π"],
  "–®–∞—Ç–∏–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä": ["–®–∞—Ç–∏–ª–æ–≤", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä"],


};


async function findOrCreateOperationType() {
    let opType = await OperationType.findOne({
        where: { code: "THERMAL_CALIBRATION" }
    });

    if (!opType) {
        opType = await OperationType.create({
            name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞",
            code: "THERMAL_CALIBRATION",
            description: "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤ (–∏–º–ø–æ—Ä—Ç –∏–∑ Excel)",
            unit: "—à—Ç",
            isActive: true
        });
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: ${opType.name} (ID: ${opType.id})`);
    } else {
        console.log(`‚ÑπÔ∏è  –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${opType.name} (ID: ${opType.id})`);
    }

    return opType;
}

async function findUserByName(fullName) {
    const variants = NAME_VARIANTS[fullName];
    if (!variants) {
        return null;
    }

    const [surname, name] = variants;


    let user = await User.findOne({
        where: { surname, name }
    });

    if (!user) {

        user = await User.findOne({
            where: {
                [Op.and]: [
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('surname')),
                        surname.toLowerCase()
                    ),
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('name')),
                        name.toLowerCase()
                    )
                ]
            }
        });
    }

    return user;
}

async function importData() {
    try {

        await sequelize.authenticate();
        console.log("üì¶ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
        console.log(`   –ë–∞–∑–∞: ${process.env.DB_NAME || 'flight_controller_database'}`);
        console.log(`   –•–æ—Å—Ç: ${process.env.DB_HOST || 'localhost'}\n`);


        const operationType = await findOrCreateOperationType();
        const operationTypeId = operationType.id;


        const stats = {
            total: IMPORT_DATA.length,
            success: 0,
            skipped: 0,
            userNotFound: [],
            duplicates: 0
        };


        const userCache = new Map();

        console.log("\nüîÑ –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç...\n");

        for (const record of IMPORT_DATA) {
            const { employee, date, quantity } = record;


            let userId = userCache.get(employee);

            if (userId === undefined) {
                const user = await findUserByName(employee);
                if (user) {
                    userId = user.id;
                    userCache.set(employee, userId);
                    console.log(`üë§ –ù–∞–π–¥–µ–Ω: ${employee} -> ID ${userId}`);
                } else {
                    userCache.set(employee, null);
                    if (!stats.userNotFound.includes(employee)) {
                        stats.userNotFound.push(employee);
                        console.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω: ${employee}`);
                    }
                }
            }

            if (!userId) {
                stats.skipped++;
                continue;
            }


            const existing = await ProductionOutput.findOne({
                where: {
                    userId,
                    date,
                    operationTypeId,
                    claimedQty: quantity
                }
            });

            if (existing) {
                stats.duplicates++;
                continue;
            }


            await ProductionOutput.create({
                date,
                userId,
                operationTypeId,
                claimedQty: quantity,
                approvedQty: quantity,
                status: 'approved',
                comment: `–ò–º–ø–æ—Ä—Ç –∏–∑ Excel (${record.month_name})`
            });

            stats.success++;
        }


        console.log("\n" + "=".repeat(50));
        console.log("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ú–ü–û–†–¢–ê:");
        console.log("=".repeat(50));
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${stats.success}`);
        console.log(`‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${stats.skipped}`);
        console.log(`üîÑ –î—É–±–ª–∏–∫–∞—Ç—ã: ${stats.duplicates}`);

        if (stats.userNotFound.length > 0) {
            console.log(`\n‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (${stats.userNotFound.length}):`);
            stats.userNotFound.forEach(name => console.log(`   - ${name}`));
        }

        console.log("\n‚ú® –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!");

    } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", error);
    } finally {
        await sequelize.close();
    }
}


importData();

================================================================================
FILE: QMS-Server-master/scripts/import_thermal_outputs_2.js
================================================================================



require('dotenv').config();

const { Sequelize, DataTypes, Op } = require("sequelize");


const sequelize = new Sequelize(
    process.env.DB_NAME || 'flight_controller_database',
    process.env.DB_USER || 'postgres',
    process.env.DB_PASSWORD || '',
    {
        host: process.env.DB_HOST || 'localhost',
        port: process.env.DB_PORT || 5432,
        dialect: 'postgres',
        logging: false
    }
);


const User = sequelize.define("user", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING },
    surname: { type: DataTypes.STRING },
}, {
    tableName: "users",
    timestamps: false
});

const OperationType = sequelize.define("operation_type", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING(100), allowNull: false },
    code: { type: DataTypes.STRING(50), allowNull: true },
    description: { type: DataTypes.TEXT, allowNull: true },
    unit: { type: DataTypes.STRING(20), allowNull: false, defaultValue: '—à—Ç' },
    normMinutes: { type: DataTypes.FLOAT, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    isActive: { type: DataTypes.BOOLEAN, defaultValue: true },
    sortOrder: { type: DataTypes.INTEGER, defaultValue: 0 }
}, {
    tableName: "operation_types",
    timestamps: true
});

const ProductionOutput = sequelize.define("production_output", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    date: { type: DataTypes.DATEONLY, allowNull: false },
    userId: { type: DataTypes.INTEGER, allowNull: false },
    teamId: { type: DataTypes.INTEGER, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    projectId: { type: DataTypes.INTEGER, allowNull: true },
    taskId: { type: DataTypes.INTEGER, allowNull: true },
    operationTypeId: { type: DataTypes.INTEGER, allowNull: true },
    claimedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    approvedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    rejectedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    status: { type: DataTypes.STRING(20), allowNull: false, defaultValue: 'approved' },
    approvedById: { type: DataTypes.INTEGER, allowNull: true },
    approvedAt: { type: DataTypes.DATE, allowNull: true },
    createdById: { type: DataTypes.INTEGER, allowNull: true },
    comment: { type: DataTypes.TEXT, allowNull: true },
    rejectReason: { type: DataTypes.TEXT, allowNull: true }
}, {
    tableName: "production_outputs",
    timestamps: true
});


const OPERATION_TYPES = {
    THERMAL_CALIBRATION: {
        name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞",
        code: "THERMAL_CALIBRATION",
        description: "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤",
        unit: "—à—Ç"
    },
    THERMAL_DEFECT_CHECK: {
        name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –æ—Ç–±—Ä–∞–∫–æ–≤–∫–∞",
        code: "THERMAL_DEFECT_CHECK",
        description: "–û—Ç–±–æ—Ä –±—Ä–∞–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤",
        unit: "—à—Ç"
    },
    THERMAL_FIRMWARE: {
        name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –ø—Ä–æ—à–∏–≤–∫–∞",
        code: "THERMAL_FIRMWARE",
        description: "–ü–µ—Ä–µ–ø—Ä–æ—à–∏–≤–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤ –Ω–∞ 94-—é –ø—Ä–æ—à–∏–≤–∫—É",
        unit: "—à—Ç"
    },
    THERMAL_RESTORE: {
        name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ",
        code: "THERMAL_RESTORE",
        description: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤",
        unit: "—à—Ç"
    }
};


const IMPORT_DATA = [

  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-12", "quantity": 120, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-13", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-14", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-15", "quantity": 120, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-16", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-19", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-20", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-21", "quantity": 20, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-12", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-13", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-14", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-15", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-16", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-19", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-21", "quantity": 170, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-12", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-13", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-14", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-15", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-16", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-19", "quantity": 90, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-21", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-13", "quantity": 36, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-14", "quantity": 20, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-15", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-16", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-19", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-20", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-14", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-15", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-19", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-20", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-21", "quantity": 20, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},

  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-22", "quantity": 10, "operation": "THERMAL_FIRMWARE", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},

  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-22", "quantity": 20, "operation": "THERMAL_RESTORE", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"}
];


const NAME_VARIANTS = {
  "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª": ["–ì–µ–∫–º–∞–Ω", "–ö–∏—Ä–∏–ª–ª"],
  "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä": ["–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ", "–ê—Ä—Ç—É—Ä"],
  "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π": ["–ó–µ–ª–µ–Ω–æ–≤", "–î–º–∏—Ç—Ä–∏–π"],
  "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π": ["–õ–∞—Ç—ã—à", "–ù–∏–∫–æ–ª–∞–π"],
  "–°–≤–∏—Å—Ç—É–Ω–æ–≤ –°–µ—Ä–≥–µ–π": ["–°–≤–∏—Å—Ç—É–Ω–æ–≤", "–°–µ—Ä–≥–µ–π"],
  "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤": ["–£—à–∞–∫–æ–≤", "–°–≤—è—Ç–æ—Å–ª–∞–≤"],
};


async function findOrCreateOperationTypes() {
    const opTypeIds = {};

    for (const [code, data] of Object.entries(OPERATION_TYPES)) {
        let opType = await OperationType.findOne({
            where: { code }
        });

        if (!opType) {
            opType = await OperationType.create({
                name: data.name,
                code: data.code,
                description: data.description,
                unit: data.unit,
                isActive: true
            });
            console.log(`‚úÖ –°–æ–∑–¥–∞–Ω —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: ${opType.name} (ID: ${opType.id})`);
        } else {
            console.log(`‚ÑπÔ∏è  –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${opType.name} (ID: ${opType.id})`);
        }

        opTypeIds[code] = opType.id;
    }

    return opTypeIds;
}

async function findUserByName(fullName) {
    const variants = NAME_VARIANTS[fullName];
    if (!variants) {
        return null;
    }

    const [surname, name] = variants;


    let user = await User.findOne({
        where: { surname, name }
    });

    if (!user) {

        user = await User.findOne({
            where: {
                [Op.and]: [
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('surname')),
                        surname.toLowerCase()
                    ),
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('name')),
                        name.toLowerCase()
                    )
                ]
            }
        });
    }

    return user;
}

async function importData() {
    try {

        await sequelize.authenticate();
        console.log("üì¶ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
        console.log(`   –ë–∞–∑–∞: ${process.env.DB_NAME || 'flight_controller_database'}`);
        console.log(`   –•–æ—Å—Ç: ${process.env.DB_HOST || 'localhost'}\n`);


        const operationTypeIds = await findOrCreateOperationTypes();


        const stats = {
            total: IMPORT_DATA.length,
            success: 0,
            skipped: 0,
            userNotFound: [],
            duplicates: 0,
            byOperation: {}
        };


        const userCache = new Map();

        console.log("\nüîÑ –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç...\n");

        for (const record of IMPORT_DATA) {
            const { employee, date, quantity, operation } = record;


            const operationTypeId = operationTypeIds[operation];
            if (!operationTypeId) {
                console.log(`‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: ${operation}`);
                stats.skipped++;
                continue;
            }


            let userId = userCache.get(employee);

            if (userId === undefined) {
                const user = await findUserByName(employee);
                if (user) {
                    userId = user.id;
                    userCache.set(employee, userId);
                    console.log(`üë§ –ù–∞–π–¥–µ–Ω: ${employee} -> ID ${userId}`);
                } else {
                    userCache.set(employee, null);
                    if (!stats.userNotFound.includes(employee)) {
                        stats.userNotFound.push(employee);
                        console.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω: ${employee}`);
                    }
                }
            }

            if (!userId) {
                stats.skipped++;
                continue;
            }


            const existing = await ProductionOutput.findOne({
                where: {
                    userId,
                    date,
                    operationTypeId,
                    claimedQty: quantity
                }
            });

            if (existing) {
                stats.duplicates++;
                continue;
            }


            await ProductionOutput.create({
                date,
                userId,
                operationTypeId,
                claimedQty: quantity,
                approvedQty: quantity,
                status: 'approved',
                comment: `–ò–º–ø–æ—Ä—Ç –∏–∑ Excel - –¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä—ã (${record.month_name})`
            });

            stats.success++;
            stats.byOperation[operation] = (stats.byOperation[operation] || 0) + quantity;
        }


        console.log("\n" + "=".repeat(50));
        console.log("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ú–ü–û–†–¢–ê:");
        console.log("=".repeat(50));
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${stats.success}`);
        console.log(`‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${stats.skipped}`);
        console.log(`üîÑ –î—É–±–ª–∏–∫–∞—Ç—ã: ${stats.duplicates}`);

        console.log(`\nüìà –ü–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º:`);
        for (const [op, total] of Object.entries(stats.byOperation)) {
            const opName = OPERATION_TYPES[op]?.name || op;
            console.log(`   ${opName}: ${total} —à—Ç`);
        }

        if (stats.userNotFound.length > 0) {
            console.log(`\n‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (${stats.userNotFound.length}):`);
            stats.userNotFound.forEach(name => console.log(`   - ${name}`));
        }

        console.log("\n‚ú® –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!");

    } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", error);
    } finally {
        await sequelize.close();
    }
}


importData();

================================================================================
FILE: QMS-Server-master/scripts/run-migration-components.js
================================================================================



require("dotenv").config();
const { Sequelize } = require("sequelize");

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASSWORD,
  {
    host: process.env.DB_HOST || "localhost",
    port: process.env.DB_PORT || 5432,
    dialect: "postgres",
    logging: console.log
  }
);

async function runMigration() {
  try {
    console.log("üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...");
    await sequelize.authenticate();
    console.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫: ${process.env.DB_NAME}\n`);

    console.log("üöÄ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏: –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤\n");


    console.log("üì¶ –°–æ–∑–¥–∞—ë–º ENUM —Ç–∏–ø–æ–≤ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö...");
    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_component_type') THEN
          CREATE TYPE "enum_beryll_component_type" AS ENUM (
            'CPU', 'RAM', 'SSD', 'HDD', 'NVME',
            'NIC', 'MOTHERBOARD', 'PSU', 'GPU',
            'RAID', 'BMC', 'OTHER'
          );
        END IF;
      END$$;
    `);


    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_component_status') THEN
          CREATE TYPE "enum_beryll_component_status" AS ENUM (
            'OK', 'WARNING', 'CRITICAL', 'UNKNOWN'
          );
        END IF;
      END$$;
    `);
    console.log("‚úÖ ENUM —Ç–∏–ø—ã —Å–æ–∑–¥–∞–Ω—ã\n");


    console.log("üíæ –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É beryll_server_components...");
    await sequelize.query(`
      CREATE TABLE IF NOT EXISTS beryll_server_components (
        id SERIAL PRIMARY KEY,
        "serverId" INTEGER NOT NULL REFERENCES beryll_servers(id) ON UPDATE CASCADE ON DELETE CASCADE,

        -- –¢–∏–ø –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        "componentType" "enum_beryll_component_type" NOT NULL,
        "slot" VARCHAR(50),

        -- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –∏ –º–æ–¥–µ–ª—å
        "manufacturer" VARCHAR(255),
        "model" VARCHAR(255),
        "serialNumber" VARCHAR(255),
        "partNumber" VARCHAR(255),

        -- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–æ–±—â–∏–µ)
        "capacity" VARCHAR(50),
        "capacityBytes" BIGINT,

        -- –î–ª—è CPU
        "cores" INTEGER,
        "threads" INTEGER,
        "speedMHz" INTEGER,
        "architecture" VARCHAR(50),

        -- –î–ª—è RAM
        "memoryType" VARCHAR(50),
        "speedMT" INTEGER,
        "rank" INTEGER,

        -- –î–ª—è –¥–∏—Å–∫–æ–≤
        "mediaType" VARCHAR(50),
        "interface" VARCHAR(50),
        "firmwareVersion" VARCHAR(100),

        -- –î–ª—è NIC
        "macAddress" VARCHAR(17),
        "linkSpeed" VARCHAR(50),

        -- –°—Ç–∞—Ç—É—Å –∏ –∑–¥–æ—Ä–æ–≤—å–µ
        "status" "enum_beryll_component_status" DEFAULT 'UNKNOWN',
        "health" VARCHAR(50),
        "healthRollup" VARCHAR(50),

        -- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ BMC (JSON)
        "rawData" JSONB,

        -- –ú–µ—Ç–∞
        "fetchedAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        "fetchedById" INTEGER REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        "createdAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        "updatedAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
      );
    `);


    console.log("üìá –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å—ã...");
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_components_server ON beryll_server_components("serverId");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_components_type ON beryll_server_components("componentType");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_components_serial ON beryll_server_components("serialNumber");`);
    console.log("‚úÖ –¢–∞–±–ª–∏—Ü–∞ beryll_server_components —Å–æ–∑–¥–∞–Ω–∞\n");


    console.log("üìù –î–æ–±–∞–≤–ª—è–µ–º action —Ç–∏–ø COMPONENTS_FETCHED...");
    await sequelize.query(`
      DO $$
      BEGIN
        ALTER TYPE "enum_beryll_history_action" ADD VALUE IF NOT EXISTS 'COMPONENTS_FETCHED';
      EXCEPTION
        WHEN duplicate_object THEN NULL;
      END$$;
    `);
    console.log("‚úÖ Action —Ç–∏–ø –¥–æ–±–∞–≤–ª–µ–Ω\n");


    console.log("üîß –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ bmcAddress –≤ beryll_servers...");
    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "bmcAddress" VARCHAR(255);
    `);
    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "lastComponentsFetchAt" TIMESTAMP;
    `);
    console.log("‚úÖ –ü–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã\n");

    console.log("==================================================");
    console.log("‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!");
    console.log("==================================================\n");


    const [tables] = await sequelize.query(`
      SELECT table_name FROM information_schema.tables
      WHERE table_schema = 'public' AND table_name LIKE 'beryll%'
      ORDER BY table_name;
    `);
    console.log("üìã –¢–∞–±–ª–∏—Ü—ã Beryll:");
    tables.forEach(t => console.log(`  - ${t.table_name}`));

  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:", error.message);
    console.error(error);
  } finally {
    await sequelize.close();
    console.log("\nüîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
  }
}

runMigration();

================================================================================
FILE: QMS-Server-master/seeders/20260123-beryll-abilities.js
================================================================================



"use strict";

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const now = new Date();


    const abilities = [

      {
        code: "beryll_component_view",
        description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_component_manage",
        description:
          "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—ë–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ, —Å–ø–∏—Å–∞–Ω–∏–µ)",
        createdAt: now,
        updatedAt: now,
      },


      {
        code: "beryll_defect_view",
        description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π –æ –±—Ä–∞–∫–µ",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_defect_create",
        description: "–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –æ –±—Ä–∞–∫–µ",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_defect_manage",
        description:
          "–ü–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –æ –±—Ä–∞–∫–µ (workflow, —Ä–µ–º–æ–Ω—Ç)",
        createdAt: now,
        updatedAt: now,
      },


      {
        code: "beryll_yadro_view",
        description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫ –≤ –Ø–¥—Ä–æ",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_yadro_manage",
        description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –≤ –Ø–¥—Ä–æ",
        createdAt: now,
        updatedAt: now,
      },


      {
        code: "beryll_substitute_view",
        description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—É–ª–∞ –ø–æ–¥–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_substitute_manage",
        description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–º–µ–Ω–Ω—ã–º–∏ —Å–µ—Ä–≤–µ—Ä–∞–º–∏",
        createdAt: now,
        updatedAt: now,
      },


      {
        code: "beryll_admin",
        description: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ Beryll (SLA, —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)",
        createdAt: now,
        updatedAt: now,
      },
    ];


    const existingAbilities = await queryInterface.sequelize.query(
      `SELECT code FROM abilities WHERE code LIKE 'beryll_%'`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    const existingCodes = new Set(existingAbilities.map((a) => a.code));
    const newAbilities = abilities.filter((a) => !existingCodes.has(a.code));

    if (newAbilities.length > 0) {
      await queryInterface.bulkInsert("abilities", newAbilities);
      console.log(`‚úÖ Added ${newAbilities.length} new abilities`);
    } else {
      console.log("‚ÑπÔ∏è All abilities already exist");
    }


    const adminRole = await queryInterface.sequelize.query(
      `SELECT id FROM roles WHERE name = 'admin' LIMIT 1`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    if (adminRole.length > 0) {
      const adminRoleId = adminRole[0].id;

      const insertedAbilities = await queryInterface.sequelize.query(
        `SELECT id, code FROM abilities WHERE code LIKE 'beryll_%'`,
        { type: Sequelize.QueryTypes.SELECT }
      );

      const existingRoleAbilities = await queryInterface.sequelize.query(
        `SELECT "abilityId" FROM role_abilities WHERE "roleId" = ${adminRoleId}`,
        { type: Sequelize.QueryTypes.SELECT }
      );

      const existingAbilityIds = new Set(
        existingRoleAbilities.map((ra) => ra.abilityId)
      );

      const roleAbilities = insertedAbilities
        .filter((a) => !existingAbilityIds.has(a.id))
        .map((ability) => ({
          roleId: adminRoleId,
          abilityId: ability.id,
          createdAt: now,
          updatedAt: now,
        }));

      if (roleAbilities.length > 0) {
        await queryInterface.bulkInsert("role_abilities", roleAbilities);
        console.log(
          `‚úÖ Linked ${roleAbilities.length} abilities to admin role`
        );
      }
    }


    const techRole = await queryInterface.sequelize.query(
      `SELECT id FROM roles WHERE name IN ('technologist', 'technolog', '—Ç–µ—Ö–Ω–æ–ª–æ–≥') LIMIT 1`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    if (techRole.length > 0) {
      const techRoleId = techRole[0].id;

      const techAbilities = await queryInterface.sequelize.query(
        `SELECT id FROM abilities WHERE code IN (
          'beryll_component_view',
          'beryll_defect_view',
          'beryll_defect_create',
          'beryll_defect_manage',
          'beryll_yadro_view',
          'beryll_substitute_view'
        )`,
        { type: Sequelize.QueryTypes.SELECT }
      );

      const existingTechAbilities = await queryInterface.sequelize.query(
        `SELECT "abilityId" FROM role_abilities WHERE "roleId" = ${techRoleId}`,
        { type: Sequelize.QueryTypes.SELECT }
      );

      const existingTechAbilityIds = new Set(
        existingTechAbilities.map((ra) => ra.abilityId)
      );

      const techRoleAbilities = techAbilities
        .filter((a) => !existingTechAbilityIds.has(a.id))
        .map((ability) => ({
          roleId: techRoleId,
          abilityId: ability.id,
          createdAt: now,
          updatedAt: now,
        }));

      if (techRoleAbilities.length > 0) {
        await queryInterface.bulkInsert("role_abilities", techRoleAbilities);
        console.log(
          `‚úÖ Linked ${techRoleAbilities.length} abilities to technologist role`
        );
      }
    }
  },

  down: async (queryInterface, Sequelize) => {

    await queryInterface.sequelize.query(`
      DELETE FROM role_abilities
      WHERE "abilityId" IN (
        SELECT id FROM abilities WHERE code LIKE 'beryll_%'
      )
    `);


    await queryInterface.bulkDelete("abilities", {
      code: {
        [Sequelize.Op.like]: "beryll_%",
      },
    });
  },
};

================================================================================
FILE: QMS-Server-master/seeders/20260123-component-catalog.js
================================================================================



"use strict";

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const now = new Date();

    const catalogData = [


      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E",
        revision: "1E-",
        partNumber: "MBDX86780001E",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          memorySlots: 16,
          maxMemory: "4TB"
        }),
        serialNumberPattern: "^MBD[A-Z0-9]+$",
        isActive: true,
        notes: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞ VegamanS220v8 Rev 1E-",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E1",
        revision: "1E1-",
        partNumber: "MBDX86780001E1",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          memorySlots: 16,
          maxMemory: "4TB"
        }),
        serialNumberPattern: "^MBD[A-Z0-9]+$",
        isActive: true,
        notes: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞ VegamanS220v8 Rev 1E1-",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E+",
        revision: "1E+",
        partNumber: "MBDX86780001E+",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          memorySlots: 16,
          maxMemory: "4TB"
        }),
        serialNumberPattern: "^MBD[A-Z0-9]+$",
        isActive: true,
        notes: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞ VegamanS220v8 Rev 1E+",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "SSD",
        manufacturer: "Intel",
        model: "SSDSC2KB960G8",
        revision: null,
        partNumber: "SSDSC2KB960G8",
        specifications: JSON.stringify({
          capacity: "960GB",
          interface: "SATA 6Gb/s",
          formFactor: "2.5\"",
          type: "TLC",
          readSpeed: "560 MB/s",
          writeSpeed: "510 MB/s"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Intel SSD D3-S4510 Series 960GB",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Samsung",
        model: "MZ-QL27T60",
        revision: null,
        partNumber: "MZ-QL27T60",
        specifications: JSON.stringify({
          capacity: "7.68TB",
          interface: "NVMe PCIe 4.0",
          formFactor: "U.2",
          type: "TLC",
          readSpeed: "7000 MB/s",
          writeSpeed: "3500 MB/s"
        }),
        serialNumberPattern: "^S[A-Z0-9]+$",
        isActive: true,
        notes: "Samsung PM9A3 7.68TB NVMe",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "M393A8G40AB2-CWEC0",
        revision: "2245",
        partNumber: "KR M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MHz",
          ecc: true,
          registered: true,
          voltage: "1.2V"
        }),
        serialNumberPattern: "^Y1[A-Z0-9]+$",
        isActive: true,
        notes: "Samsung DDR4 64GB RDIMM ECC",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "M393A8G40BB4-CWE",
        revision: null,
        partNumber: "M393A8G40BB4-CWE",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MHz",
          ecc: true,
          registered: true,
          voltage: "1.2V"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Samsung DDR4 64GB RDIMM ECC (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "HDD",
        manufacturer: "Seagate",
        model: "ST16000NM001G",
        revision: null,
        partNumber: "ST16000NM001G",
        specifications: JSON.stringify({
          capacity: "16TB",
          interface: "SATA 6Gb/s",
          formFactor: "3.5\"",
          rpm: 7200,
          cache: "256MB"
        }),
        serialNumberPattern: "^ZRT[A-Z0-9]+$",
        isActive: true,
        notes: "Seagate Exos X16 16TB",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "HDD",
        manufacturer: "Seagate",
        model: "STL015",
        revision: null,
        partNumber: "STL015",
        specifications: JSON.stringify({
          capacity: "15TB",
          interface: "SAS 12Gb/s",
          formFactor: "3.5\"",
          rpm: 7200
        }),
        serialNumberPattern: "^Y1P[A-Z0-9]+$",
        isActive: true,
        notes: "Seagate SAS 15TB",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "PSU",
        manufacturer: "Aspower",
        model: "U1A-D11200-DRB",
        revision: null,
        partNumber: "U1A-D11200-DRB",
        specifications: JSON.stringify({
          power: "1200W",
          efficiency: "80+ Platinum",
          formFactor: "1U",
          redundant: true,
          hotSwap: true
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è 1200W 1U Redundant",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "CPU",
        manufacturer: "Intel",
        model: "Xeon Gold 6338",
        revision: null,
        partNumber: "CD8068904572501",
        specifications: JSON.stringify({
          cores: 32,
          threads: 64,
          baseClock: "2.0 GHz",
          turboClock: "3.2 GHz",
          tdp: "205W",
          socket: "LGA4189"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Intel Xeon Gold 6338 32-Core",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "CPU",
        manufacturer: "Intel",
        model: "Xeon Platinum 8380",
        revision: null,
        partNumber: "CD8068904572601",
        specifications: JSON.stringify({
          cores: 40,
          threads: 80,
          baseClock: "2.3 GHz",
          turboClock: "3.4 GHz",
          tdp: "270W",
          socket: "LGA4189"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Intel Xeon Platinum 8380 40-Core",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "NIC",
        manufacturer: "Intel",
        model: "X710-DA4",
        revision: null,
        partNumber: "X710DA4FHBLK",
        specifications: JSON.stringify({
          ports: 4,
          speed: "10GbE",
          connector: "SFP+",
          pcie: "x8 Gen3"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Intel X710 4x10GbE SFP+",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "MCX516A-CDAT",
        revision: null,
        partNumber: "MCX516A-CDAT",
        specifications: JSON.stringify({
          ports: 2,
          speed: "100GbE",
          connector: "QSFP28",
          pcie: "x16 Gen4"
        }),
        serialNumberPattern: "^MT[A-Z0-9]+$",
        isActive: true,
        notes: "Mellanox ConnectX-5 2x100GbE",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "RAID",
        manufacturer: "Broadcom",
        model: "MegaRAID 9460-16i",
        revision: null,
        partNumber: "05-50011-00",
        specifications: JSON.stringify({
          ports: 16,
          interface: "SAS/SATA",
          cache: "4GB",
          raidLevels: "0,1,5,6,10,50,60"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Broadcom MegaRAID 9460-16i",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "BMC",
        manufacturer: "ASPEED",
        model: "AST2600",
        revision: null,
        partNumber: "AST2600A3",
        specifications: JSON.stringify({
          type: "BMC SoC",
          processor: "ARM Cortex-A7 Dual Core",
          memory: "1GB DDR4"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "ASPEED AST2600 BMC",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "FAN",
        manufacturer: "Delta",
        model: "GFB0412EHS",
        revision: null,
        partNumber: "GFB0412EHS",
        specifications: JSON.stringify({
          size: "40x40x56mm",
          rpm: "15000",
          cfm: "24.5",
          voltage: "12V"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Delta –≤—ã—Å–æ–∫–æ—Å–∫–æ—Ä–æ—Å—Ç–Ω–æ–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "BACKPLANE",
        manufacturer: "Yadro",
        model: "BP-SAS-12",
        revision: null,
        partNumber: "BP-SAS-12",
        specifications: JSON.stringify({
          slots: 12,
          interface: "SAS/SATA",
          formFactor: "3.5\""
        }),
        serialNumberPattern: "^BP[A-Z0-9]+$",
        isActive: true,
        notes: "Backplane –Ω–∞ 12 –¥–∏—Å–∫–æ–≤ 3.5\"",
        createdAt: now,
        updatedAt: now
      }
    ];

    await queryInterface.bulkInsert("component_catalog", catalogData);

    console.log(`‚úÖ Seeded ${catalogData.length} component catalog entries`);
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.bulkDelete("component_catalog", null, {});
  }
};

================================================================================
FILE: QMS-Server-master/seeders/20260123-sla-config.js
================================================================================



"use strict";

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const now = new Date();

    const slaConfigs = [


      {
        name: "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é",
        defectType: null,
        priority: null,
        maxDiagnosisHours: 24,
        maxRepairHours: 72,
        maxTotalHours: 168,
        escalationAfterHours: 48,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        name: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
        defectType: null,
        priority: "CRITICAL",
        maxDiagnosisHours: 4,
        maxRepairHours: 24,
        maxTotalHours: 48,
        escalationAfterHours: 8,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
        defectType: null,
        priority: "HIGH",
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 96,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
        defectType: null,
        priority: "MEDIUM",
        maxDiagnosisHours: 24,
        maxRepairHours: 72,
        maxTotalHours: 168,
        escalationAfterHours: 48,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
        defectType: null,
        priority: "LOW",
        maxDiagnosisHours: 48,
        maxRepairHours: 120,
        maxTotalHours: 336,
        escalationAfterHours: 96,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        name: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞",
        defectType: "MOTHERBOARD",
        priority: null,
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 120,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å",
        defectType: "RAM",
        priority: null,
        maxDiagnosisHours: 4,
        maxRepairHours: 24,
        maxTotalHours: 72,
        escalationAfterHours: 16,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–ñ—ë—Å—Ç–∫–∏–π –¥–∏—Å–∫",
        defectType: "HDD",
        priority: null,
        maxDiagnosisHours: 4,
        maxRepairHours: 24,
        maxTotalHours: 72,
        escalationAfterHours: 16,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "SSD –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å",
        defectType: "SSD",
        priority: null,
        maxDiagnosisHours: 4,
        maxRepairHours: 24,
        maxTotalHours: 72,
        escalationAfterHours: 16,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è",
        defectType: "PSU",
        priority: null,
        maxDiagnosisHours: 2,
        maxRepairHours: 8,
        maxTotalHours: 24,
        escalationAfterHours: 4,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä",
        defectType: "FAN",
        priority: null,
        maxDiagnosisHours: 2,
        maxRepairHours: 4,
        maxTotalHours: 24,
        escalationAfterHours: 4,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞",
        defectType: "NIC",
        priority: null,
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 96,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä",
        defectType: "RAID",
        priority: null,
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 120,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "BMC –º–æ–¥—É–ª—å",
        defectType: "BMC",
        priority: null,
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 120,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        name: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞ - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π",
        defectType: "MOTHERBOARD",
        priority: "CRITICAL",
        maxDiagnosisHours: 2,
        maxRepairHours: 24,
        maxTotalHours: 48,
        escalationAfterHours: 4,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "RAM - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π",
        defectType: "RAM",
        priority: "CRITICAL",
        maxDiagnosisHours: 1,
        maxRepairHours: 8,
        maxTotalHours: 24,
        escalationAfterHours: 2,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "PSU - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π",
        defectType: "PSU",
        priority: "CRITICAL",
        maxDiagnosisHours: 1,
        maxRepairHours: 4,
        maxTotalHours: 8,
        escalationAfterHours: 2,
        isActive: true,
        createdAt: now,
        updatedAt: now
      }
    ];

    await queryInterface.bulkInsert("sla_config", slaConfigs);

    console.log(`‚úÖ Seeded ${slaConfigs.length} SLA configurations`);
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.bulkDelete("sla_config", null, {});
  }
};

================================================================================
FILE: QMS-Server-master/seeders/20260201-vegman-component-revisions.js
================================================================================

"use strict";


module.exports = {
  up: async (queryInterface, Sequelize) => {
    const now = new Date();


    const existing = await queryInterface.sequelize.query(
      `SELECT COUNT(*) as cnt FROM component_catalog WHERE notes LIKE '%VegmanS220v8%'`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    if (existing[0]?.cnt > 0) {
      console.log("‚ö†Ô∏è  –†–µ–≤–∏–∑–∏–∏ VegmanS220v8 —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...");
      return;
    }

    const catalogData = [


      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E",
        revision: "1E-",
        partNumber: "MBDX86780001E",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          serverModel: "Vegman S220"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ú–∞—Ç. –ø–ª–∞—Ç–∞ —Ä–µ–≤–∏–∑–∏—è 1E-",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E1",
        revision: "1E1-",
        partNumber: "MBDX86780001E1",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          serverModel: "Vegman R220"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ú–∞—Ç. –ø–ª–∞—Ç–∞ —Ä–µ–≤–∏–∑–∏—è 1E1-",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001D",
        revision: "1D",
        partNumber: "MBDX86780001D",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          serverModel: "–°–µ—Ä–≤–µ—Ä –•2-262",
          variants: ["1E+", "1D+", "1D-"]
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ú–∞—Ç. –ø–ª–∞—Ç–∞ —Ä–µ–≤–∏–∑–∏—è 1D (—Ç–∏–ø—ã: 1E+, 1D+, 1D-)",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.20",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.20",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.21",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.21",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.AV",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.AV",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.22",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.22",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.B3",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.B3",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.B6",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.B6",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.B7",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.B7",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "RAID",
        manufacturer: "Broadcom",
        model: "–¢–∏–ø 1",
        revision: null,
        partNumber: null,
        specifications: JSON.stringify({ raidType: "–¢–∏–ø 1" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî RAID-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¢–∏–ø 1 (Broadcom)",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAID",
        manufacturer: null,
        model: "–¢–∏–ø 2",
        revision: null,
        partNumber: null,
        specifications: JSON.stringify({ raidType: "–¢–∏–ø 2" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî RAID-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¢–∏–ø 2",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "FAN",
        manufacturer: null,
        model: "–¢–∏–ø 1",
        revision: null,
        partNumber: null,
        specifications: JSON.stringify({ coolerType: "–¢–∏–ø 1" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ö—É–ª–µ—Ä—ã CPU –¢–∏–ø 1",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "FAN",
        manufacturer: null,
        model: "–¢–∏–ø 2",
        revision: null,
        partNumber: null,
        specifications: JSON.stringify({ coolerType: "–¢–∏–ø 2" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ö—É–ª–µ—Ä—ã CPU –¢–∏–ø 2",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "BACKPLANE",
        manufacturer: "Yadro",
        model: "BPLSAS780002C",
        revision: null,
        partNumber: "BPLSAS780002C",
        specifications: JSON.stringify({
          slots: 12,
          interface: "SAS",
          backplanePresent: true
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî Backplane 12 –¥–∏—Å–∫–æ–≤ (Backplane: +)",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "BACKPLANE",
        manufacturer: "Yadro",
        model: "BPLSAS780001A1",
        revision: null,
        partNumber: "BPLSAS780001A1",
        specifications: JSON.stringify({
          slots: 12,
          interface: "SAS",
          backplanePresent: false
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî Backplane 12 –¥–∏—Å–∫–æ–≤ (Backplane: -)",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "BMC",
        manufacturer: "Yadro",
        model: "IOBBMC740001A1",
        revision: null,
        partNumber: "IOBBMC740001A1",
        specifications: JSON.stringify({ bmcType: "A1" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî BMC IOBBMC740001A1",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "BMC",
        manufacturer: "Yadro",
        model: "IOBBMC740001C",
        revision: null,
        partNumber: "IOBBMC740001C",
        specifications: JSON.stringify({ bmcType: "C" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî BMC IOBBMC740001C",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "SSD",
        manufacturer: "Intel",
        model: "SSDSC2KB960G8",
        revision: null,
        partNumber: "SSDSC2KB960G8",
        specifications: JSON.stringify({
          capacity: "960GB",
          interface: "SATA",
          formFactor: "2.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Intel SSDSC2KB960G8",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Samsung",
        model: "MZ-QL27T60",
        revision: null,
        partNumber: "MZ-QL27T60",
        specifications: JSON.stringify({
          capacity: "7.68TB",
          interface: "NVMe",
          formFactor: "U.2"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Samsung MZ-QL27T60",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Micron",
        model: "MTFDHAL6T4TDR-1AT1ZABYY",
        revision: null,
        partNumber: "MTFDHAL6T4TDR-1AT1ZABYY",
        specifications: JSON.stringify({
          capacity: "6.4TB",
          interface: "NVMe"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Micron MTFDHAL6T4TDR-1AT1ZABYY",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Micron",
        model: "MTFDKCB7T6TDZ",
        revision: null,
        partNumber: "MTFDKCB7T6TDZ",
        specifications: JSON.stringify({
          capacity: "7.68TB",
          interface: "NVMe"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Micron MTFDKCB7T6TDZ",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Samsung",
        model: "MZ-7KH9600",
        revision: null,
        partNumber: "MZ-7KH9600",
        specifications: JSON.stringify({
          capacity: "960GB",
          interface: "SATA",
          formFactor: "2.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Samsung MZ-7KH9600",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Intel",
        model: "SSDSC2KB960GZ",
        revision: null,
        partNumber: "SSDSC2KB960GZ",
        specifications: JSON.stringify({
          capacity: "960GB",
          interface: "SATA",
          formFactor: "2.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Intel SSDSC2KB960GZ",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "HDD",
        manufacturer: "Seagate",
        model: "STL015",
        revision: null,
        partNumber: "STL015",
        specifications: JSON.stringify({
          interface: "SAS",
          formFactor: "3.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî HDD Seagate STL015",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "HDD",
        manufacturer: "Seagate",
        model: "STL009",
        revision: null,
        partNumber: "STL009",
        specifications: JSON.stringify({
          interface: "SAS",
          formFactor: "3.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî HDD Seagate STL009",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "PSU",
        manufacturer: "Aspower",
        model: "U1A-D11200-DRB",
        revision: null,
        partNumber: "U1A-D11200-DRB",
        specifications: JSON.stringify({
          wattage: "1200W",
          efficiency: "80+ Platinum"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ë–ü Aspower U1A-D11200-DRB",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "PSU",
        manufacturer: "AcBel",
        model: "R1CA2122A",
        revision: null,
        partNumber: "R1CA2122A",
        specifications: JSON.stringify({
          wattage: "1200W"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ë–ü AcBel R1CA2122A",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2245",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2245",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2249",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2249",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2248",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2248",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2320",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2320",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2250",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2250",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2312",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2312",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2251",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2251",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2306",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2306",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2308",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2308",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2305",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2305",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2310",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2310",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWE",
        revision: "2250",
        partNumber: "M393A8G40AB2-CWE",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2250 (CWE)",
        createdAt: now,
        updatedAt: now
      }
    ];


    for (const entry of catalogData) {
      try {
        const exists = await queryInterface.sequelize.query(
          `SELECT id FROM component_catalog
           WHERE type = :type
           AND (manufacturer = :manufacturer OR (manufacturer IS NULL AND :manufacturer IS NULL))
           AND model = :model`,
          {
            replacements: {
              type: entry.type,
              manufacturer: entry.manufacturer,
              model: entry.model
            },
            type: Sequelize.QueryTypes.SELECT
          }
        );

        if (exists.length === 0) {
          await queryInterface.bulkInsert("component_catalog", [entry]);
          console.log(`  ‚úÖ ${entry.type}: ${entry.manufacturer || ''} ${entry.model} (rev: ${entry.revision || '-'})`);
        } else {

          await queryInterface.sequelize.query(
            `UPDATE component_catalog SET revision = :revision, notes = :notes, "updatedAt" = NOW()
             WHERE id = :id`,
            {
              replacements: {
                revision: entry.revision,
                notes: entry.notes,
                id: exists[0].id
              }
            }
          );
          console.log(`  üîÑ ${entry.type}: ${entry.manufacturer || ''} ${entry.model} ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–æ`);
        }
      } catch (err) {
        console.error(`  ‚ùå ${entry.type}: ${entry.model} ‚Äî ${err.message}`);
      }
    }

    console.log(`\n‚úÖ Seeded VegmanS220v8 component revisions (${catalogData.length} entries)`);
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.bulkDelete("component_catalog", {
      notes: { [Sequelize.Op.like]: "%VegmanS220v8%" }
    });
    console.log("‚úÖ Removed VegmanS220v8 component revisions");
  }
};

================================================================================
FILE: QMS-Server-master/seeders/beryllSeeder.js
================================================================================

const {
  BeryllChecklistTemplate,
  CHECKLIST_GROUPS
} = require("../models/definitions/Beryll");


async function seedBeryllChecklistTemplates() {
  try {

    const count = await BeryllChecklistTemplate.count();
    if (count > 0) {
      console.log(`‚úÖ [Beryll] –®–∞–±–ª–æ–Ω—ã —á–µ–∫-–ª–∏—Å—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç (${count} —à—Ç.)`);
      return { created: false, count };
    }


    const templates = [

      {
        groupCode: CHECKLIST_GROUPS.VISUAL,
        title: '–í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞',
        description: '–ü—Ä–æ–≤–µ—Å—Ç–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è), –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ',
        fileCode: null,
        requiresFile: false,
        sortOrder: 100,
        isRequired: true,
        estimatedMinutes: 10,
        isActive: true
      },


      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–°–∫—Ä–∏–Ω –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏',
        description: '–°–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞',
        fileCode: 'sn_on2',
        requiresFile: true,
        sortOrder: 200,
        isRequired: true,
        estimatedMinutes: 5,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç RAID (cachevault)',
        description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏ cachevault',
        fileCode: 'sn_cachevault2',
        requiresFile: true,
        sortOrder: 210,
        isRequired: true,
        estimatedMinutes: 15,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–°—Ç—Ä–µ—Å—Å —Ç–µ—Å—Ç 3 (60 –º–∏–Ω)',
        description: '–ü—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ 60 –º–∏–Ω—É—Ç',
        fileCode: 'sn_gtk32',
        requiresFile: true,
        sortOrder: 220,
        isRequired: true,
        estimatedMinutes: 60,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç SSD + —Å–∫—Ä–∏–Ω RAID',
        description: '–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å SSD –∏ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç RAID',
        fileCode: 'sn_raid2',
        requiresFile: true,
        sortOrder: 230,
        isRequired: true,
        estimatedMinutes: 20,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç HDD, SSD + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤',
        description: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HDD –∏ SSD, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤',
        fileCode: null,
        requiresFile: false,
        sortOrder: 240,
        isRequired: true,
        estimatedMinutes: 30,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ (0, 3, 6)',
        description: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ 0, 3, 6 + —Å–∫—Ä–∏–Ω',
        fileCode: 'sn_dimm2',
        requiresFile: true,
        sortOrder: 250,
        isRequired: true,
        estimatedMinutes: 30,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ (11, 12)',
        description: '–í—ã—è–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞, –∑–∞—è–≤–∫–∞ –≤ –Ø–¥—Ä–æ, –æ—Ç–º–µ—Ç–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –±—Ä–∞–∫–∞',
        fileCode: 'sn_dimm2FAIL2',
        requiresFile: false,
        sortOrder: 260,
        isRequired: false,
        estimatedMinutes: 20,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤',
        description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤',
        fileCode: null,
        requiresFile: false,
        sortOrder: 270,
        isRequired: true,
        estimatedMinutes: 5,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–í—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –æ–±—â–∏–π –¥–∏—Å–∫',
        description: '–í—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤',
        fileCode: null,
        requiresFile: false,
        sortOrder: 280,
        isRequired: true,
        estimatedMinutes: 10,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–°–∫—Ä–∏–Ω BIOS, BMC [dts, die]',
        description: '–í–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ + —Å–∫—Ä–∏–Ω –∏–∑ BIOS, BMC',
        fileCode: 'sn_Bios2',
        requiresFile: true,
        sortOrder: 290,
        isRequired: true,
        estimatedMinutes: 10,
        isActive: true
      },


      {
        groupCode: CHECKLIST_GROUPS.QC_PRIMARY,
        title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤ (–û–¢–ö)',
        description: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤',
        fileCode: null,
        requiresFile: false,
        sortOrder: 300,
        isRequired: true,
        estimatedMinutes: 15,
        isActive: true
      },


      {
        groupCode: CHECKLIST_GROUPS.BURN_IN,
        title: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–æ–Ω',
        description: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–æ–Ω (burn-in)',
        fileCode: null,
        requiresFile: false,
        sortOrder: 400,
        isRequired: true,
        estimatedMinutes: 1440,
        isActive: true
      },


      {
        groupCode: CHECKLIST_GROUPS.QC_FINAL,
        title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–æ–Ω–∞ (–û–¢–ö)',
        description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–æ–Ω–∞',
        fileCode: null,
        requiresFile: false,
        sortOrder: 500,
        isRequired: true,
        estimatedMinutes: 10,
        isActive: true
      }
    ];

    await BeryllChecklistTemplate.bulkCreate(templates);
    console.log(`‚úÖ [Beryll] –°–æ–∑–¥–∞–Ω–æ ${templates.length} —à–∞–±–ª–æ–Ω–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞`);

    return { created: true, count: templates.length };

  } catch (e) {
    console.error('‚ùå [Beryll] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —à–∞–±–ª–æ–Ω–æ–≤:', e.message);
    return { created: false, error: e.message };
  }
}

module.exports = { seedBeryllChecklistTemplates };

================================================================================
FILE: QMS-Server-master/services/DocumentService.js
================================================================================
















const crypto = require("crypto");
const path = require("path");
const fs = require("fs").promises;
const { Op } = require("sequelize");
const sequelize = require("../db");

const {
  Document,
  DocumentVersion,
  DocumentApproval,
  DocumentDistribution,
  DOCUMENT_STATUSES,
  VERSION_STATUSES,
  APPROVAL_DECISIONS,
  TYPE_CODE_PREFIX,
} = require("../models/definitions/Document");
const { User } = require("../models/index");
const { logDocumentCreate, logDocumentApproval, logDocumentEffective, logAudit, AUDIT_ACTIONS } = require("../utils/hashChainLogger");


const DOCS_STORAGE = process.env.DOCS_STORAGE_PATH || path.join(__dirname, "..", "static", "documents");

class DocumentService {
  
  
  

  



  async createDocument(req, { title, type, category, description, isoSection, tags, reviewCycleMonths }) {
    const transaction = await sequelize.transaction();

    try {
      
      const prefix = TYPE_CODE_PREFIX[type] || "–î–û–ö";
      const lastDoc = await Document.findOne({
        where: { type },
        order: [["id", "DESC"]],
        attributes: ["code"],
        transaction,
      });

      let number = 1;
      if (lastDoc && lastDoc.code) {
        const match = lastDoc.code.match(/(\d+)$/);
        if (match) number = parseInt(match[1]) + 1;
      }

      const code = `${prefix}-–°–ú–ö-${String(number).padStart(3, "0")}`;

      
      const document = await Document.create(
        {
          code,
          title,
          type,
          category: category || null,
          description: description || null,
          status: DOCUMENT_STATUSES.DRAFT,
          ownerId: req.user.id,
          isoSection: isoSection || null,
          tags: tags || [],
          reviewCycleMonths: reviewCycleMonths || 12,
        },
        { transaction }
      );

      
      const version = await DocumentVersion.create(
        {
          documentId: document.id,
          version: "1.0",
          versionNumber: 1,
          status: VERSION_STATUSES.DRAFT,
          changeDescription: "–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è",
          createdById: req.user.id,
        },
        { transaction }
      );

      
      await document.update({ currentVersionId: version.id }, { transaction });

      await transaction.commit();

      
      await logDocumentCreate(req, document);

      return { document, version };
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  



  async uploadVersionFile(req, versionId, file) {
    const version = await DocumentVersion.findByPk(versionId);
    if (!version) throw new Error("–í–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    if (version.status !== VERSION_STATUSES.DRAFT) {
      throw new Error("–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞");
    }

    
    const docDir = path.join(DOCS_STORAGE, String(version.documentId));
    await fs.mkdir(docDir, { recursive: true });

    
    const ext = path.extname(file.name);
    const safeFileName = `v${version.versionNumber}_${Date.now()}${ext}`;
    const filePath = path.join(docDir, safeFileName);

    
    await fs.writeFile(filePath, file.data);

    
    const fileHash = crypto
      .createHash("sha256")
      .update(file.data)
      .digest("hex");

    
    await version.update({
      fileUrl: `/documents/${version.documentId}/${safeFileName}`,
      fileName: file.name,
      fileSize: file.size,
      fileMimeType: file.mimetype,
      fileHash,
    });

    
    await logAudit({
      req,
      action: AUDIT_ACTIONS.DOCUMENT_VERSION_CREATE,
      entity: "DocumentVersion",
      entityId: version.id,
      description: `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª –¥–ª—è –≤–µ—Ä—Å–∏–∏ ${version.version}: ${file.name}`,
      metadata: { fileHash, fileSize: file.size },
    });

    return version;
  }

  
  
  

  





  async submitForReview(req, versionId, approvalChain) {
    const transaction = await sequelize.transaction();

    try {
      const version = await DocumentVersion.findByPk(versionId, {
        include: [{ model: Document, as: "document" }],
        transaction,
      });

      if (!version) throw new Error("–í–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
      if (version.status !== VERSION_STATUSES.DRAFT) {
        throw new Error("–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–Ω–æ–≤–∏–∫");
      }

      
      if (!approvalChain || approvalChain.length === 0) {
        throw new Error("–¶–µ–ø–æ—á–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π");
      }

      
      for (let i = 0; i < approvalChain.length; i++) {
        const { userId, role, dueDate } = approvalChain[i];

        await DocumentApproval.create(
          {
            versionId: version.id,
            step: i + 1,
            role,
            assignedToId: userId,
            decision: APPROVAL_DECISIONS.PENDING,
            dueDate: dueDate || null,
          },
          { transaction }
        );
      }

      
      await version.update({ status: VERSION_STATUSES.REVIEW }, { transaction });
      await version.document.update({ status: DOCUMENT_STATUSES.REVIEW }, { transaction });

      await transaction.commit();

      
      await logAudit({
        req,
        action: AUDIT_ACTIONS.DOCUMENT_SUBMIT_REVIEW,
        entity: "DocumentVersion",
        entityId: version.id,
        description: `–î–æ–∫—É–º–µ–Ω—Ç ${version.document.code} v${version.version} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ`,
        metadata: {
          approvers: approvalChain.map((a) => a.userId),
          steps: approvalChain.length,
        },
      });

      return version;
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  




  async makeDecision(req, approvalId, { decision, comment }) {
    const transaction = await sequelize.transaction();

    try {
      const approval = await DocumentApproval.findByPk(approvalId, {
        include: [
          {
            model: DocumentVersion,
            as: "version",
            include: [{ model: Document, as: "document" }],
          },
        ],
        transaction,
      });

      if (!approval) throw new Error("–®–∞–≥ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω");
      if (approval.assignedToId !== req.user.id) {
        throw new Error("–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç–µ–ª–µ–º");
      }
      if (approval.decision !== APPROVAL_DECISIONS.PENDING) {
        throw new Error("–†–µ—à–µ–Ω–∏–µ —É–∂–µ –ø—Ä–∏–Ω—è—Ç–æ");
      }

      
      if (approval.step > 1) {
        const prevSteps = await DocumentApproval.findAll({
          where: {
            versionId: approval.versionId,
            step: { [Op.lt]: approval.step },
          },
          transaction,
        });

        const allPrevApproved = prevSteps.every(
          (s) => s.decision === APPROVAL_DECISIONS.APPROVED
        );

        if (!allPrevApproved) {
          throw new Error("–ü—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã");
        }
      }

      
      await approval.update(
        {
          decision,
          comment: comment || null,
          decidedAt: new Date(),
        },
        { transaction }
      );

      const version = approval.version;
      const doc = version.document;

      if (decision === APPROVAL_DECISIONS.REJECTED || decision === APPROVAL_DECISIONS.RETURNED) {
        
        await version.update({ status: VERSION_STATUSES.REJECTED }, { transaction });
        await doc.update({ status: DOCUMENT_STATUSES.DRAFT }, { transaction });
      } else if (decision === APPROVAL_DECISIONS.APPROVED) {
        
        const allApprovals = await DocumentApproval.findAll({
          where: { versionId: version.id },
          transaction,
        });

        const allApproved = allApprovals.every(
          (a) => a.decision === APPROVAL_DECISIONS.APPROVED
        );

        if (allApproved) {
          
          await version.update(
            {
              status: VERSION_STATUSES.APPROVED,
              approvedById: req.user.id,
              approvedAt: new Date(),
            },
            { transaction }
          );
          await doc.update({ status: DOCUMENT_STATUSES.APPROVED }, { transaction });
        }
      }

      await transaction.commit();

      
      await logDocumentApproval(req, doc, version, decision, { comment });

      return approval;
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  



  async makeEffective(req, versionId) {
    const transaction = await sequelize.transaction();

    try {
      const version = await DocumentVersion.findByPk(versionId, {
        include: [{ model: Document, as: "document" }],
        transaction,
      });

      if (!version) throw new Error("–í–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
      if (version.status !== VERSION_STATUSES.APPROVED) {
        throw new Error("–¢–æ–ª—å–∫–æ —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤ –¥–µ–π—Å—Ç–≤–∏–µ");
      }

      const doc = version.document;

      
      if (doc.currentVersionId && doc.currentVersionId !== version.id) {
        const oldVersion = await DocumentVersion.findByPk(doc.currentVersionId, { transaction });
        if (oldVersion && oldVersion.status === VERSION_STATUSES.EFFECTIVE) {
          await oldVersion.update(
            {
              status: VERSION_STATUSES.SUPERSEDED,
              supersededAt: new Date(),
            },
            { transaction }
          );
        }
      }

      
      const now = new Date();
      await version.update(
        { status: VERSION_STATUSES.EFFECTIVE, effectiveAt: now },
        { transaction }
      );

      
      const nextReview = new Date(now);
      nextReview.setMonth(nextReview.getMonth() + (doc.reviewCycleMonths || 12));

      await doc.update(
        {
          status: DOCUMENT_STATUSES.EFFECTIVE,
          currentVersionId: version.id,
          effectiveDate: now,
          nextReviewDate: nextReview,
        },
        { transaction }
      );

      await transaction.commit();

      
      await logDocumentEffective(req, doc, version);

      return version;
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  



  async createNewVersion(req, documentId, { changeDescription }) {
    const transaction = await sequelize.transaction();

    try {
      const doc = await Document.findByPk(documentId, {
        include: [{ model: DocumentVersion, as: "versions" }],
        transaction,
      });

      if (!doc) throw new Error("–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

      
      const existingDraft = doc.versions.find(
        (v) => v.status === VERSION_STATUSES.DRAFT || v.status === VERSION_STATUSES.REVIEW
      );
      if (existingDraft) {
        throw new Error(`–£–∂–µ –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: ${existingDraft.version} (${existingDraft.status})`);
      }

      const maxVersionNum = Math.max(...doc.versions.map((v) => v.versionNumber), 0);
      const newVersionNum = maxVersionNum + 1;

      const version = await DocumentVersion.create(
        {
          documentId: doc.id,
          version: `${newVersionNum}.0`,
          versionNumber: newVersionNum,
          status: VERSION_STATUSES.DRAFT,
          changeDescription: changeDescription || null,
          createdById: req.user.id,
        },
        { transaction }
      );

      
      if (doc.status === DOCUMENT_STATUSES.EFFECTIVE) {
        await doc.update({ status: DOCUMENT_STATUSES.REVISION }, { transaction });
      }

      await transaction.commit();

      
      await logAudit({
        req,
        action: AUDIT_ACTIONS.DOCUMENT_VERSION_CREATE,
        entity: "DocumentVersion",
        entityId: version.id,
        description: `–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è ${doc.code} v${version.version}`,
        metadata: { documentId: doc.id, changeDescription },
      });

      return version;
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  


  async distribute(req, versionId, userIds) {
    const version = await DocumentVersion.findByPk(versionId, {
      include: [{ model: Document, as: "document" }],
    });

    if (!version) throw new Error("–í–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    if (version.status !== VERSION_STATUSES.EFFECTIVE) {
      throw new Error("–†–∞—Å—Å—ã–ª–∫–∞ –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–π—Å—Ç–≤—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏");
    }

    const distributions = [];
    for (const userId of userIds) {
      const [dist, created] = await DocumentDistribution.findOrCreate({
        where: { versionId, userId },
        defaults: { distributedAt: new Date() },
      });
      distributions.push(dist);
    }

    
    await logAudit({
      req,
      action: AUDIT_ACTIONS.DOCUMENT_DISTRIBUTE,
      entity: "Document",
      entityId: version.document.id,
      description: `–î–æ–∫—É–º–µ–Ω—Ç ${version.document.code} —Ä–∞–∑–æ—Å–ª–∞–Ω ${userIds.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º`,
      metadata: { userIds, versionId },
    });

    return distributions;
  }

  


  async acknowledge(req, distributionId) {
    const dist = await DocumentDistribution.findByPk(distributionId);
    if (!dist) throw new Error("–ó–∞–ø–∏—Å—å —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    if (dist.userId !== req.user.id) throw new Error("–ù–µ–ª—å–∑—è –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞ –¥—Ä—É–≥–æ–≥–æ");
    if (dist.acknowledged) throw new Error("–£–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ");

    await dist.update({
      acknowledged: true,
      acknowledgedAt: new Date(),
    });

    
    await logAudit({
      req,
      action: AUDIT_ACTIONS.DOCUMENT_ACKNOWLEDGE,
      entity: "DocumentDistribution",
      entityId: dist.id,
      description: `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º`,
      metadata: { versionId: dist.versionId },
    });

    return dist;
  }

  
  
  

  


  async getDocuments({ page = 1, limit = 20, status, type, category, search, ownerId }) {
    const where = {};
    if (status) where.status = status;
    if (type) where.type = type;
    if (category) where.category = category;
    if (ownerId) where.ownerId = ownerId;
    if (search) {
      where[Op.or] = [
        { title: { [Op.iLike]: `%${search}%` } },
        { code: { [Op.iLike]: `%${search}%` } },
        { description: { [Op.iLike]: `%${search}%` } },
      ];
    }

    return Document.findAndCountAll({
      where,
      include: [
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
        {
          model: DocumentVersion,
          as: "currentVersion",
          attributes: ["id", "version", "status", "effectiveAt"],
        },
      ],
      order: [["updatedAt", "DESC"]],
      limit: Math.min(limit, 100),
      offset: (page - 1) * limit,
    });
  }

  


  async getDocumentDetail(documentId) {
    return Document.findByPk(documentId, {
      include: [
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
        {
          model: DocumentVersion,
          as: "versions",
          order: [["versionNumber", "DESC"]],
          include: [
            { model: User, as: "createdBy", attributes: ["id", "name", "surname"] },
            { model: User, as: "approvedBy", attributes: ["id", "name", "surname"] },
            {
              model: DocumentApproval,
              as: "approvals",
              order: [["step", "ASC"]],
              include: [
                { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
              ],
            },
            {
              model: DocumentDistribution,
              as: "distributions",
              include: [
                { model: User, as: "user", attributes: ["id", "name", "surname"] },
              ],
            },
          ],
        },
      ],
    });
  }

  


  async getPendingApprovals(userId) {
    return DocumentApproval.findAll({
      where: {
        assignedToId: userId,
        decision: APPROVAL_DECISIONS.PENDING,
      },
      include: [
        {
          model: DocumentVersion,
          as: "version",
          include: [
            {
              model: Document,
              as: "document",
              attributes: ["id", "code", "title", "type"],
            },
            { model: User, as: "createdBy", attributes: ["id", "name", "surname"] },
          ],
        },
      ],
      order: [["dueDate", "ASC NULLS LAST"], ["createdAt", "ASC"]],
    });
  }

  


  async getOverdueReviews() {
    return Document.findAll({
      where: {
        status: DOCUMENT_STATUSES.EFFECTIVE,
        nextReviewDate: { [Op.lt]: new Date() },
      },
      include: [
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
      ],
      order: [["nextReviewDate", "ASC"]],
    });
  }

  


  async getStats() {
    const [byStatus, byType, overdueCount, pendingApprovalsCount] = await Promise.all([
      Document.findAll({
        attributes: ["status", [sequelize.fn("COUNT", "*"), "count"]],
        group: ["status"],
        raw: true,
      }),
      Document.findAll({
        attributes: ["type", [sequelize.fn("COUNT", "*"), "count"]],
        group: ["type"],
        raw: true,
      }),
      Document.count({
        where: {
          status: DOCUMENT_STATUSES.EFFECTIVE,
          nextReviewDate: { [Op.lt]: new Date() },
        },
      }),
      DocumentApproval.count({
        where: { decision: APPROVAL_DECISIONS.PENDING },
      }),
    ]);

    return { byStatus, byType, overdueCount, pendingApprovalsCount };
  }
}

module.exports = new DocumentService();

================================================================================
FILE: QMS-Server-master/services/ExcelImportService.js
================================================================================



const XLSX = require("xlsx");
const path = require("path");
const fs = require("fs");
const { sequelize } = require("../../models/index");

class ExcelImportService {


    async importServerComponents(filePath, options = {}) {
        const { dryRun = false, skipExisting = true } = options;

        const workbook = XLSX.readFile(filePath);
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const results = {
            servers: [],
            components: [],
            errors: [],
            skipped: []
        };

        const {
            BeryllServer,
            BeryllServerComponent,
            ComponentInventory,
            ComponentCatalog
        } = require("../../models/index");


        for (let i = 2; i < data.length; i++) {
            const row = data[i];
            if (!row || !row[0]) continue;

            try {
                const serverSerial = String(row[0]).trim();


                let server = await BeryllServer.findOne({
                    where: { apkSerialNumber: serverSerial }
                });

                if (!server) {
                    if (!dryRun) {
                        server = await BeryllServer.create({
                            apkSerialNumber: serverSerial,
                            status: "NEW"
                        });
                    }
                    results.servers.push({ serial: serverSerial, action: "created" });
                } else {
                    results.servers.push({ serial: serverSerial, action: "exists" });
                }


                const components = [];


                for (let j = 1; j <= 12; j++) {
                    const serialYadro = row[j] ? String(row[j]).trim() : null;
                    if (serialYadro) {
                        components.push({
                            type: "HDD",
                            serialNumberYadro: serialYadro,
                            serialNumber: serialYadro,
                            slot: `HDD_${j}`
                        });
                    }
                }


                for (let j = 13; j <= 24; j++) {
                    const serialYadro = row[j] ? String(row[j]).trim() : null;
                    if (serialYadro) {
                        components.push({
                            type: "RAM",
                            serialNumberYadro: serialYadro,
                            serialNumber: serialYadro,
                            slot: `DIMM_${j - 12}`
                        });
                    }
                }


                for (let j = 25; j <= 28; j++) {
                    const serialYadro = row[j] ? String(row[j]).trim() : null;
                    if (serialYadro) {
                        components.push({
                            type: "SSD",
                            serialNumberYadro: serialYadro,
                            serialNumber: serialYadro,
                            slot: `SSD_${j - 24}`
                        });
                    }
                }


                const psu1Yadro = row[29] ? String(row[29]).trim() : null;
                const psu1Manuf = row[30] ? String(row[30]).trim() : null;
                if (psu1Yadro || psu1Manuf) {
                    components.push({
                        type: "PSU",
                        serialNumberYadro: psu1Yadro,
                        serialNumber: psu1Manuf || psu1Yadro,
                        slot: "PSU_1"
                    });
                }


                const psu2Yadro = row[31] ? String(row[31]).trim() : null;
                const psu2Manuf = row[32] ? String(row[32]).trim() : null;
                if (psu2Yadro || psu2Manuf) {
                    components.push({
                        type: "PSU",
                        serialNumberYadro: psu2Yadro,
                        serialNumber: psu2Manuf || psu2Yadro,
                        slot: "PSU_2"
                    });
                }


                for (const comp of components) {
                    try {

                        const existingInventory = await ComponentInventory.findOne({
                            where: {
                                serialNumber: comp.serialNumber
                            }
                        });

                        if (existingInventory) {
                            if (skipExisting) {
                                results.skipped.push({
                                    server: serverSerial,
                                    component: comp,
                                    reason: "duplicate"
                                });
                                continue;
                            }
                        }

                        if (!dryRun) {

                            const inventoryRecord = await ComponentInventory.create({
                                type: comp.type,
                                serialNumber: comp.serialNumber,
                                serialNumberYadro: comp.serialNumberYadro,
                                status: "IN_USE",
                                condition: "NEW",
                                currentServerId: server?.id
                            });


                            if (server) {
                                await BeryllServerComponent.create({
                                    serverId: server.id,
                                    type: comp.type,
                                    serialNumberYadro: comp.serialNumberYadro,
                                    serialNumberManuf: comp.serialNumber !== comp.serialNumberYadro ? comp.serialNumber : null,
                                    slot: comp.slot,
                                    inventoryId: inventoryRecord.id,
                                    installedAt: new Date()
                                });
                            }
                        }

                        results.components.push({
                            server: serverSerial,
                            type: comp.type,
                            serial: comp.serialNumber,
                            action: "created"
                        });

                    } catch (compError) {
                        results.errors.push({
                            server: serverSerial,
                            component: comp,
                            error: compError.message
                        });
                    }
                }

            } catch (rowError) {
                results.errors.push({
                    row: i + 1,
                    error: rowError.message
                });
            }
        }

        return results;
    }


    async importDefectRecords(filePath, options = {}) {
        const { dryRun = false } = options;

        const workbook = XLSX.readFile(filePath);
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const results = {
            records: [],
            errors: [],
            skipped: []
        };

        const {
            BeryllServer,
            BeryllDefectRecord,
            UserAlias,
            User
        } = require("../../models/index");


        const headers = data[0];
        const colIndex = this.findColumnIndexes(headers, {
            ticketNumber: ["‚Ññ –∑–∞—è–≤–∫–∏", "–∑–∞—è–≤–∫–∞", "ticket"],
            serverSerial: ["S/N —Å–µ—Ä–≤–µ—Ä", "—Å–µ—Ä–∏–π–Ω—ã–π", "server"],
            clusterCode: ["–∫–ª–∞—Å—Ç–µ—Ä", "cluster"],
            defectDate: ["–¥–∞—Ç–∞", "date"],
            problemDescription: ["–æ–ø–∏—Å–∞–Ω–∏–µ", "–ø—Ä–æ–±–ª–µ–º–∞", "description"],
            partType: ["—Ç–∏–ø –¥–µ—Ç–∞–ª–∏", "–¥–µ—Ç–∞–ª—å", "part"],
            defectSerial: ["S/N –±—Ä–∞–∫–æ–≤–æ–π", "–±—Ä–∞–∫–æ–≤–∞—è"],
            replacementSerial: ["S/N –∑–∞–º–µ–Ω–∞", "–∑–∞–º–µ–Ω–∞"],
            status: ["—Å—Ç–∞—Ç—É—Å", "status"],
            diagnostician: ["–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫", "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å"]
        });


        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            if (!row || row.every(cell => !cell)) continue;

            try {
                const ticketNumber = this.getCellValue(row, colIndex.ticketNumber);
                const serverSerial = this.getCellValue(row, colIndex.serverSerial);

                if (!serverSerial) {
                    results.skipped.push({ row: i + 1, reason: "no server serial" });
                    continue;
                }


                const server = await BeryllServer.findOne({
                    where: { apkSerialNumber: serverSerial }
                });

                if (!server) {
                    results.errors.push({ row: i + 1, error: `Server not found: ${serverSerial}` });
                    continue;
                }


                if (ticketNumber) {
                    const existing = await BeryllDefectRecord.findOne({
                        where: { yadroTicketNumber: ticketNumber }
                    });

                    if (existing) {
                        results.skipped.push({ row: i + 1, reason: "duplicate ticket" });
                        continue;
                    }
                }


                let detectedAt = new Date();
                const dateValue = this.getCellValue(row, colIndex.defectDate);
                if (dateValue) {
                    if (typeof dateValue === "number") {

                        detectedAt = this.excelDateToJS(dateValue);
                    } else {
                        detectedAt = new Date(dateValue);
                    }
                }


                let diagnosticianId = null;
                const diagnosticianName = this.getCellValue(row, colIndex.diagnostician);
                if (diagnosticianName) {
                    const user = await UserAlias.findUserByAlias(diagnosticianName);
                    if (user) {
                        diagnosticianId = user.id;
                    }
                }


                const partTypeRaw = this.getCellValue(row, colIndex.partType);
                const repairPartType = this.mapPartType(partTypeRaw);


                const statusRaw = this.getCellValue(row, colIndex.status);
                const status = this.mapStatus(statusRaw);

                if (!dryRun) {
                    const record = await BeryllDefectRecord.create({
                        serverId: server.id,
                        yadroTicketNumber: ticketNumber || null,
                        clusterCode: this.getCellValue(row, colIndex.clusterCode) || null,
                        detectedAt,
                        problemDescription: this.getCellValue(row, colIndex.problemDescription) || null,
                        repairPartType,
                        defectPartSerialYadro: this.getCellValue(row, colIndex.defectSerial) || null,
                        replacementPartSerialYadro: this.getCellValue(row, colIndex.replacementSerial) || null,
                        status,
                        diagnosticianId
                    });

                    results.records.push({
                        id: record.id,
                        ticketNumber,
                        server: serverSerial
                    });
                } else {
                    results.records.push({
                        ticketNumber,
                        server: serverSerial,
                        dryRun: true
                    });
                }

            } catch (rowError) {
                results.errors.push({
                    row: i + 1,
                    error: rowError.message
                });
            }
        }

        return results;
    }


    findColumnIndexes(headers, mappings) {
        const indexes = {};

        for (const [key, searchTerms] of Object.entries(mappings)) {
            indexes[key] = null;

            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i] || "").toLowerCase().trim();

                for (const term of searchTerms) {
                    if (header.includes(term.toLowerCase())) {
                        indexes[key] = i;
                        break;
                    }
                }

                if (indexes[key] !== null) break;
            }
        }

        return indexes;
    }

    getCellValue(row, index) {
        if (index === null || index === undefined) return null;
        const value = row[index];
        if (value === null || value === undefined) return null;
        return String(value).trim();
    }

    excelDateToJS(excelDate) {


        const msPerDay = 24 * 60 * 60 * 1000;
        const excelEpoch = new Date(1899, 11, 30);
        return new Date(excelEpoch.getTime() + excelDate * msPerDay);
    }

    mapPartType(raw) {
        if (!raw) return null;

        const normalized = raw.toLowerCase().trim();

        const mappings = {
            "–º–ø": "MOTHERBOARD",
            "–º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è": "MOTHERBOARD",
            "motherboard": "MOTHERBOARD",
            "–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è": "RAM",
            "ram": "RAM",
            "–ø–∞–º—è—Ç—å": "RAM",
            "dimm": "RAM",
            "hdd": "HDD",
            "–∂—ë—Å—Ç–∫–∏–π": "HDD",
            "–∂–µ—Å—Ç–∫–∏–π": "HDD",
            "–¥–∏—Å–∫": "HDD",
            "ssd": "SSD",
            "—Ç–≤–µ—Ä–¥–æ—Ç–µ–ª—å–Ω—ã–π": "SSD",
            "nvme": "SSD",
            "–±–ø": "PSU",
            "–±–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è": "PSU",
            "psu": "PSU",
            "–≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä": "FAN",
            "fan": "FAN",
            "–∫—É–ª–µ—Ä": "FAN",
            "—Å–µ—Ç—å": "NIC",
            "—Å–µ—Ç–µ–≤–∞—è": "NIC",
            "nic": "NIC",
            "ethernet": "NIC",
            "raid": "RAID",
            "–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä": "RAID",
            "bmc": "BMC",
            "backplane": "BACKPLANE",
            "–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä": "CPU",
            "cpu": "CPU"
        };

        for (const [keyword, type] of Object.entries(mappings)) {
            if (normalized.includes(keyword)) {
                return type;
            }
        }

        return null;
    }

    mapStatus(raw) {
        if (!raw) return "NEW";

        const normalized = raw.toLowerCase().trim();

        const mappings = {
            "–Ω–æ–≤—ã–π": "NEW",
            "new": "NEW",
            "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "DIAGNOSING",
            "diagnosing": "DIAGNOSING",
            "–æ–∂–∏–¥–∞–Ω–∏–µ": "WAITING_PARTS",
            "waiting": "WAITING_PARTS",
            "—Ä–µ–º–æ–Ω—Ç": "REPAIRING",
            "repair": "REPAIRING",
            "–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω": "SENT_TO_YADRO",
            "—è–¥—Ä–æ": "SENT_TO_YADRO",
            "–≤–æ–∑–≤—Ä–∞—Ç": "RETURNED",
            "returned": "RETURNED",
            "—Ä–µ—à—ë–Ω": "RESOLVED",
            "—Ä–µ—à–µ–Ω": "RESOLVED",
            "resolved": "RESOLVED",
            "–∑–∞–∫—Ä—ã—Ç": "CLOSED",
            "closed": "CLOSED"
        };

        for (const [keyword, status] of Object.entries(mappings)) {
            if (normalized.includes(keyword)) {
                return status;
            }
        }

        return "NEW";
    }
}

module.exports = new ExcelImportService();

================================================================================
FILE: QMS-Server-master/services/NcCapaService.js
================================================================================






const { Op } = require("sequelize");
const sequelize = require("../db");
const {
  Nonconformity, NcAttachment, Capa, CapaAction, CapaVerification,
  NC_STATUSES, CAPA_STATUSES,
} = require("../models/definitions/NcCapa");
const { User } = require("../models/index");
const { logNonconformity, logCapa } = require("../utils/auditLogger");

class NcCapaService {
  

  async createNC(req, data) {
    const t = await sequelize.transaction();
    try {
      const lastNc = await Nonconformity.findOne({ order: [["id", "DESC"]], attributes: ["id"], transaction: t });
      const num = (lastNc?.id || 0) + 1;
      const number = `NC-${String(num).padStart(4, "0")}`;

      
      const capaRequired = data.classification === "CRITICAL" ? true : (data.capaRequired || false);

      const nc = await Nonconformity.create({
        ...data,
        number,
        status: NC_STATUSES.OPEN,
        reportedById: req.user.id,
        detectedAt: data.detectedAt || new Date(),
        capaRequired,
      }, { transaction: t });

      await t.commit();
      await logNonconformity(req, nc, "create");
      return nc;
    } catch (e) { await t.rollback(); throw e; }
  }

  async updateNC(req, id, data) {
    const nc = await Nonconformity.findByPk(id);
    if (!nc) throw new Error("NC –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    if (nc.status === NC_STATUSES.CLOSED) throw new Error("–ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫—Ä—ã—Ç—É—é NC");

    const oldStatus = nc.status;
    await nc.update(data);

    if (data.status && data.status !== oldStatus) {
      const actionMap = {
        INVESTIGATING: "investigate",
        DISPOSITION: "disposition",
        CLOSED: "close",
        REOPENED: "reopen",
      };
      await logNonconformity(req, nc, actionMap[data.status] || "update");
    } else {
      await logNonconformity(req, nc, "update");
    }

    return nc;
  }

  async closeNC(req, id, { closingComment }) {
    const t = await sequelize.transaction();
    try {
      const nc = await Nonconformity.findByPk(id, { transaction: t });
      if (!nc) throw new Error("NC –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

      
      if (nc.capaRequired) {
        const openCapas = await Capa.count({
          where: { nonconformityId: id, status: { [Op.notIn]: ["CLOSED", "EFFECTIVE"] } },
          transaction: t,
        });
        if (openCapas > 0) throw new Error(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å: ${openCapas} CAPA –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã`);
      }

      await nc.update({
        status: NC_STATUSES.CLOSED,
        closedById: req.user.id,
        closedAt: new Date(),
      }, { transaction: t });

      await t.commit();
      await logNonconformity(req, nc, "close", { closingComment });
      return nc;
    } catch (e) { await t.rollback(); throw e; }
  }

  async getNCList({ page = 1, limit = 20, status, source, classification, assignedToId, search, dateFrom, dateTo }) {
    const where = {};
    if (status) where.status = status;
    if (source) where.source = source;
    if (classification) where.classification = classification;
    if (assignedToId) where.assignedToId = assignedToId;
    if (search) {
      where[Op.or] = [
        { number: { [Op.iLike]: `%${search}%` } },
        { title: { [Op.iLike]: `%${search}%` } },
        { description: { [Op.iLike]: `%${search}%` } },
      ];
    }
    if (dateFrom || dateTo) {
      where.detectedAt = {};
      if (dateFrom) where.detectedAt[Op.gte] = new Date(dateFrom);
      if (dateTo) where.detectedAt[Op.lte] = new Date(dateTo);
    }

    return Nonconformity.findAndCountAll({
      where,
      include: [
        { model: User, as: "reportedBy", attributes: ["id", "name", "surname"] },
        { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
      ],
      order: [["detectedAt", "DESC"]],
      limit: Math.min(limit, 100),
      offset: (page - 1) * limit,
    });
  }

  async getNCDetail(id) {
    return Nonconformity.findByPk(id, {
      include: [
        { model: User, as: "reportedBy", attributes: ["id", "name", "surname"] },
        { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
        { model: User, as: "closedBy", attributes: ["id", "name", "surname"] },
        { model: NcAttachment, as: "attachments", include: [{ model: User, as: "uploadedBy", attributes: ["id", "name", "surname"] }] },
        {
          model: Capa, as: "capas",
          attributes: ["id", "number", "type", "status", "title", "dueDate"],
          include: [{ model: User, as: "assignedTo", attributes: ["id", "name", "surname"] }],
        },
      ],
    });
  }

  

  async createCAPA(req, data) {
    const t = await sequelize.transaction();
    try {
      const lastCapa = await Capa.findOne({ order: [["id", "DESC"]], attributes: ["id"], transaction: t });
      const num = (lastCapa?.id || 0) + 1;
      const number = `CAPA-${String(num).padStart(4, "0")}`;

      
      let effectivenessCheckDate = null;
      const checkDays = data.effectivenessCheckDays || 90;
      if (data.dueDate) {
        const d = new Date(data.dueDate);
        d.setDate(d.getDate() + checkDays);
        effectivenessCheckDate = d;
      }

      const capa = await Capa.create({
        ...data,
        number,
        status: CAPA_STATUSES.INITIATED,
        initiatedById: req.user.id,
        effectivenessCheckDate,
        effectivenessCheckDays: checkDays,
      }, { transaction: t });

      
      if (data.actions?.length) {
        for (let i = 0; i < data.actions.length; i++) {
          await CapaAction.create({
            capaId: capa.id,
            order: i + 1,
            ...data.actions[i],
          }, { transaction: t });
        }
      }

      await t.commit();
      await logCapa(req, capa, "create");
      return capa;
    } catch (e) { await t.rollback(); throw e; }
  }

  async updateCAPAStatus(req, id, { status, comment }) {
    const capa = await Capa.findByPk(id);
    if (!capa) throw new Error("CAPA –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

    const updates = { status };
    const actionMap = {
      PLAN_APPROVED: "planApprove",
      IMPLEMENTING: "implement",
      VERIFYING: "verify",
      CLOSED: "close",
    };

    if (status === "PLAN_APPROVED") {
      updates.approvedById = req.user.id;
      updates.planApprovedAt = new Date();
    } else if (status === "IMPLEMENTING") {
      updates.implementedAt = new Date();
    } else if (status === "CLOSED") {
      updates.closedAt = new Date();
    }

    await capa.update(updates);
    await logCapa(req, capa, actionMap[status] || "update", { comment });
    return capa;
  }

  async addCapaAction(req, capaId, data) {
    const capa = await Capa.findByPk(capaId);
    if (!capa) throw new Error("CAPA –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

    const maxOrder = await CapaAction.max("order", { where: { capaId } }) || 0;
    return CapaAction.create({ capaId, order: maxOrder + 1, ...data });
  }

  async updateCapaAction(req, actionId, data) {
    const action = await CapaAction.findByPk(actionId);
    if (!action) throw new Error("–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
    if (data.status === "COMPLETED") data.completedAt = new Date();
    return action.update(data);
  }

  async verifyCapaEffectiveness(req, capaId, { isEffective, evidence, comment }) {
    const t = await sequelize.transaction();
    try {
      const capa = await Capa.findByPk(capaId, { transaction: t });
      if (!capa) throw new Error("CAPA –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

      const verification = await CapaVerification.create({
        capaId,
        verifiedById: req.user.id,
        isEffective,
        evidence,
        comment,
      }, { transaction: t });

      await capa.update({
        status: isEffective ? CAPA_STATUSES.EFFECTIVE : CAPA_STATUSES.INEFFECTIVE,
      }, { transaction: t });

      await t.commit();
      await logCapa(req, capa, "effectivenessCheck", { isEffective });
      return verification;
    } catch (e) { await t.rollback(); throw e; }
  }

  async getCAPAList({ page = 1, limit = 20, status, type, priority, assignedToId, search }) {
    const where = {};
    if (status) where.status = status;
    if (type) where.type = type;
    if (priority) where.priority = priority;
    if (assignedToId) where.assignedToId = assignedToId;
    if (search) {
      where[Op.or] = [
        { number: { [Op.iLike]: `%${search}%` } },
        { title: { [Op.iLike]: `%${search}%` } },
      ];
    }

    return Capa.findAndCountAll({
      where,
      include: [
        { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
        { model: User, as: "initiatedBy", attributes: ["id", "name", "surname"] },
        { model: Nonconformity, as: "nonconformity", attributes: ["id", "number", "title", "classification"] },
      ],
      order: [["createdAt", "DESC"]],
      limit: Math.min(limit, 100),
      offset: (page - 1) * limit,
    });
  }

  async getCAPADetail(id) {
    return Capa.findByPk(id, {
      include: [
        { model: User, as: "initiatedBy", attributes: ["id", "name", "surname"] },
        { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
        { model: User, as: "approvedBy", attributes: ["id", "name", "surname"] },
        { model: Nonconformity, as: "nonconformity" },
        {
          model: CapaAction, as: "actions", order: [["order", "ASC"]],
          include: [{ model: User, as: "assignedTo", attributes: ["id", "name", "surname"] }],
        },
        {
          model: CapaVerification, as: "verifications", order: [["verifiedAt", "DESC"]],
          include: [{ model: User, as: "verifiedBy", attributes: ["id", "name", "surname"] }],
        },
      ],
    });
  }

  

  async getStats() {
    const [ncByStatus, ncBySource, ncByClassification, capaByStatus, capaByType, overdueNc, overdueCapa] = await Promise.all([
      Nonconformity.findAll({ attributes: ["status", [sequelize.fn("COUNT", "*"), "count"]], group: ["status"], raw: true }),
      Nonconformity.findAll({ attributes: ["source", [sequelize.fn("COUNT", "*"), "count"]], group: ["source"], raw: true }),
      Nonconformity.findAll({ attributes: ["classification", [sequelize.fn("COUNT", "*"), "count"]], group: ["classification"], raw: true }),
      Capa.findAll({ attributes: ["status", [sequelize.fn("COUNT", "*"), "count"]], group: ["status"], raw: true }),
      Capa.findAll({ attributes: ["type", [sequelize.fn("COUNT", "*"), "count"]], group: ["type"], raw: true }),
      Nonconformity.count({ where: { status: { [Op.notIn]: ["CLOSED"] }, dueDate: { [Op.lt]: new Date() } } }),
      Capa.count({ where: { status: { [Op.notIn]: ["CLOSED", "EFFECTIVE"] }, dueDate: { [Op.lt]: new Date() } } }),
    ]);

    return { ncByStatus, ncBySource, ncByClassification, capaByStatus, capaByType, overdueNc, overdueCapa };
  }
}

module.exports = new NcCapaService();

================================================================================
FILE: QMS-Server-master/services/PdfService.js
================================================================================

const PdfPrinter = require("pdfmake");
const fs = require("fs");
const path = require("path");


const possibleFontPaths = [
    path.join(__dirname, '..', 'node_modules', 'pdfmake', 'fonts', 'Roboto'),
    path.join(__dirname, '..', 'node_modules', 'pdfmake', 'src', 'fonts', 'Roboto'),
    path.join(__dirname, '..', 'fonts'),
];

function findFontDir() {
    for (const dir of possibleFontPaths) {
        const testFile = path.join(dir, 'Roboto-Regular.ttf');
        if (fs.existsSync(testFile)) return dir;
    }
    console.error("‚ùå [PdfService] –®—Ä–∏—Ñ—Ç—ã Roboto –Ω–µ –Ω–∞–π–¥–µ–Ω—ã! –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ.");
    return null;
}

const fontDir = findFontDir();
const fonts = fontDir ? {
    Roboto: {
        normal: path.join(fontDir, 'Roboto-Regular.ttf'),
        bold: path.join(fontDir, 'Roboto-Medium.ttf'),
        italics: path.join(fontDir, 'Roboto-Italic.ttf'),
        bolditalics: path.join(fontDir, 'Roboto-MediumItalic.ttf')
    }
} : {
    Roboto: { normal: 'Helvetica', bold: 'Helvetica-Bold', italics: 'Helvetica-Oblique', bolditalics: 'Helvetica-BoldOblique' }
};

const printer = new PdfPrinter(fonts);

class PdfService {

    _createPdf(docDefinition) {
        return new Promise((resolve, reject) => {
            try {
                const pdfDoc = printer.createPdfKitDocument(docDefinition);
                const chunks = [];
                pdfDoc.on('data', (chunk) => chunks.push(chunk));
                pdfDoc.on('end', () => resolve(Buffer.concat(chunks)));
                pdfDoc.on('error', (err) => {
                    console.error("PDFMake Stream Error:", err);
                    reject(err);
                });
                pdfDoc.end();
            } catch (err) {
                reject(err);
            }
        });
    }


    async generateLabels(boxes) {
        return this._createPdf({
            content: [{ text: '–§—É–Ω–∫—Ü–∏—è generateLabels –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏', fontSize: 15 }]
        });
    }


    async generateVideoTransmitterLabelBatch(labelsArray, options = {}) {
        if (!fontDir) console.warn("–í–Ω–∏–º–∞–Ω–∏–µ: –®—Ä–∏—Ñ—Ç—ã Roboto –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, PDF –º–æ–∂–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∏–Ω–∞—á–µ.");

        const pageWidthMm = options.widthMm || 140;
        const pageHeightMm = options.heightMm || 90;
        const pageWidthPt = pageWidthMm * 2.835;
        const pageHeightPt = pageHeightMm * 2.835;
        const lineWidth = (pageWidthPt - 20) * 0.60;
        const pageMargins = [5, 5, 5, 5];

        const docDefinition = {
            pageSize: { width: pageWidthPt, height: pageHeightPt },
            pageMargins: pageMargins,
            content: [],
            defaultStyle: { font: 'Roboto', fontSize: 10 }
        };

        labelsArray.forEach((data, index) => {
            const labelContent = [
                {
                    table: {
                        widths: ['35%', '65%'],
                        body: [
                            [
                                {
                                    text: data.code || '',
                                    fontSize: 12,
                                    bold: true,
                                    margin: [2, 10, 0, 0],
                                    border: [false, false, false, false]
                                },
                                {
                                    qr: data.qrCode || 'EMPTY',
                                    fit: 65,
                                    alignment: 'right',
                                    margin: [0, 0, 2, 5],
                                    border: [false, false, false, false]
                                }
                            ],
                            [
                                {
                                    text: data.productName || '–ò–∑–¥–µ–ª–∏–µ',
                                    colSpan: 2,
                                    fontSize: 12,
                                    bold: true,
                                    alignment: 'center',
                                    margin: [0, 2],
                                    fillColor: '#F0F0F0'
                                },
                                {}
                            ],
                            [
                                {
                                    text: data.id || '',
                                    fontSize: 24,
                                    bold: true,
                                    alignment: 'center',
                                    margin: [0, 8, 0, 0]
                                },
                                {
                                    stack: [
                                        { text: data.date || '', alignment: 'center', fontSize: 9, margin: [0, 0, 0, 2] },
                                        { canvas: [{ type: 'line', x1: 0, y1: 0, x2: lineWidth, y2: 0, lineWidth: 0.5, lineColor: '#000' }] },
                                        { text: `${data.quantity || ''} ${data.unit || ''}`, alignment: 'center', fontSize: 16, bold: true, margin: [0, 2, 0, 0] }
                                    ],
                                    margin: [0, 0]
                                }
                            ],
                            [
                                {
                                    text: data.contract || '',
                                    colSpan: 2,
                                    fontSize: 7,
                                    alignment: 'center',
                                    margin: [0, 2],
                                    fillColor: '#F0F0F0'
                                },
                                {}
                            ],
                            [
                                {
                                    qr: data.bottomQr || 'ERROR',
                                    fit: 75,
                                    alignment: 'center',
                                    margin: [0, 5, 0, 0],
                                    border: [false, false, false, false]
                                },
                                {
                                    text: '',
                                    border: [false, false, false, false]
                                }
                            ]
                        ]
                    },
                    layout: {
                        hLineWidth: (i, node) => {
                            if (i === 0 || i === node.table.body.length) return 0;
                            return 1;
                        },
                        vLineWidth: (i, node) => {
                            if (i === 0 || i === node.table.widths.length) return 0;
                            return 1;
                        },
                        hLineColor: '#000',
                        vLineColor: '#000',
                        paddingLeft: (i) => 5,
                        paddingRight: (i) => 5,
                        paddingTop: (i) => 2,
                        paddingBottom: (i) => 2
                    },
                    margin: [0, 0, 0, 0]
                }
            ];

            docDefinition.content.push(labelContent);

            if (index < labelsArray.length - 1) {
                docDefinition.content.push({ text: '', pageBreak: 'after' });
            }
        });

        return this._createPdf(docDefinition);
    }


    async generateSimpleZebraBatch(labelsArray, options = {}) {
        if (!fontDir && !options.suppressWarning) console.warn("–®—Ä–∏—Ñ—Ç—ã Roboto –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è Simple —à–∞–±–ª–æ–Ω–∞.");

        const pageWidthMm = options.widthMm || 140;
        const pageHeightMm = options.heightMm || 90;
        const pageWidthPt = pageWidthMm * 2.835;
        const pageHeightPt = pageHeightMm * 2.835;

        const docDefinition = {
            pageSize: { width: pageWidthPt, height: pageHeightPt },
            pageMargins: [10, 10, 10, 10],
            content: [],
            defaultStyle: { font: 'Roboto', fontSize: 12 }
        };

        labelsArray.forEach((data, index) => {
            const content = [
                { text: data.productName, fontSize: 16, bold: true, alignment: 'center', margin: [0, 0, 0, 15] },
                {
                    columns: [
                        { qr: data.bottomQr || data.code, fit: 80, alignment: 'center' },
                        {
                            stack: [
                                { text: 'ID / –ü–∞—Ä—Ç–∏—è:', fontSize: 10, color: 'gray' },
                                { text: data.code, fontSize: 14, bold: true, margin: [0, 0, 0, 10] },
                                { text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:', fontSize: 10, color: 'gray' },
                                { text: `${data.quantity} ${data.unit}`, fontSize: 18, bold: true },
                                { text: data.date, fontSize: 10, margin: [0, 5, 0, 0] }
                            ],
                            alignment: 'left',
                            margin: [10, 0, 0, 0]
                        }
                    ]
                }
            ];

            docDefinition.content.push(content);

            if (index < labelsArray.length - 1) {
                docDefinition.content.push({ text: '', pageBreak: 'after' });
            }
        });

        return this._createPdf(docDefinition);
    }


    async generateCustomLabelBatch(labelsArray, customLayout, options = {}) {
        const pageWidthMm = options.widthMm || 100;
        const pageHeightMm = options.heightMm || 60;
        const pageWidthPt = pageWidthMm * 2.835;
        const pageHeightPt = pageHeightMm * 2.835;
        const MM_TO_PT = 2.835;

        const docDefinition = {
            pageSize: { width: pageWidthPt, height: pageHeightPt },
            pageMargins: [0, 0, 0, 0],
            content: [],
            defaultStyle: { font: 'Roboto', fontSize: 10 }
        };


        const replaceVars = (text, data) => {
            if (!text) return '';
            return text
                .replace(/\{\{code\}\}/g, data.code || '')
                .replace(/\{\{name\}\}/g, data.productName || '')
                .replace(/\{\{productName\}\}/g, data.productName || '')
                .replace(/\{\{id\}\}/g, data.id || '')
                .replace(/\{\{date\}\}/g, data.date || '')
                .replace(/\{\{serial\}\}/g, data.code || '')
                .replace(/\{\{contract\}\}/g, data.contract || '')
                .replace(/\{\{batch\}\}/g, data.batch || '')
                .replace(/\{\{qty\}\}/g, String(data.quantity || ''))
                .replace(/\{\{quantity\}\}/g, String(data.quantity || ''))
                .replace(/\{\{unit\}\}/g, data.unit || '')
                .replace(/\{\{price\}\}/g, data.price || '')
                .replace(/\{\{weight\}\}/g, data.weight || '')
                .replace(/\{\{url\}\}/g, `https://mes.local/item/${data.code}`)
                .replace(/\{\{full_info\}\}/g, data.bottomQr || '')
                .replace(/\{\{quantity_unit\}\}/g, `${data.quantity || ''} ${data.unit || ''}`)
                .replace(/\{\{current\}\}/g, String(data.currentIndex || 1))
                .replace(/\{\{total\}\}/g, String(data.totalCount || 1));
        };


        const STANDARD_ICONS = {

            fragile: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M15 5 L15 18 Q15 28 25 28 Q35 28 35 18 L35 5" fill="none" stroke="#000" stroke-width="2.5"/><line x1="25" y1="28" x2="25" y2="40" stroke="#000" stroke-width="2.5"/><line x1="15" y1="40" x2="35" y2="40" stroke="#000" stroke-width="2.5"/><line x1="12" y1="45" x2="38" y2="45" stroke="#000" stroke-width="2.5"/></svg>',


            keep_dry: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 8 Q10 8 8 22 L25 22 L25 38 Q25 42 30 40" fill="none" stroke="#000" stroke-width="2.5"/><path d="M25 8 Q40 8 42 22 L25 22" fill="none" stroke="#000" stroke-width="2.5"/><circle cx="14" cy="32" r="2" fill="#000"/><circle cx="22" cy="38" r="2" fill="#000"/><circle cx="36" cy="35" r="2" fill="#000"/></svg>',


            this_side_up: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 5 L35 18 L29 18 L29 24 L21 24 L21 18 L15 18 Z" fill="none" stroke="#000" stroke-width="2"/><path d="M25 26 L35 39 L29 39 L29 45 L21 45 L21 39 L15 39 Z" fill="none" stroke="#000" stroke-width="2"/></svg>',


            keep_frozen: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="5" width="10" height="30" rx="5" fill="none" stroke="#000" stroke-width="2"/><circle cx="25" cy="40" r="7" fill="none" stroke="#000" stroke-width="2"/><circle cx="25" cy="40" r="4" fill="#000"/><line x1="25" y1="38" x2="25" y2="15" stroke="#000" stroke-width="3"/></svg>',


            keep_away_heat: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><circle cx="25" cy="15" r="6" fill="none" stroke="#000" stroke-width="2"/><line x1="25" y1="5" x2="25" y2="8" stroke="#000" stroke-width="2"/><line x1="25" y1="22" x2="25" y2="25" stroke="#000" stroke-width="2"/><line x1="15" y1="15" x2="18" y2="15" stroke="#000" stroke-width="2"/><line x1="32" y1="15" x2="35" y2="15" stroke="#000" stroke-width="2"/><path d="M5 45 L5 32 L25 25 L45 32 L45 45" fill="none" stroke="#000" stroke-width="2"/></svg>',


            do_not_stack: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="28" width="30" height="18" fill="none" stroke="#000" stroke-width="2"/><rect x="14" y="12" width="22" height="14" fill="none" stroke="#000" stroke-width="2"/><line x1="5" y1="5" x2="45" y2="45" stroke="#000" stroke-width="3"/></svg>',


            warning: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 5 L45 42 L5 42 Z" fill="none" stroke="#000" stroke-width="2.5"/><line x1="25" y1="18" x2="25" y2="30" stroke="#000" stroke-width="3"/><circle cx="25" cy="36" r="2" fill="#000"/></svg>'
        };


        for (let labelIndex = 0; labelIndex < labelsArray.length; labelIndex++) {
            const data = labelsArray[labelIndex];
            const pageContent = [];


            for (const el of customLayout) {
                const xPt = el.x * MM_TO_PT;
                const yPt = el.y * MM_TO_PT;
                const widthPt = el.width * MM_TO_PT;
                const heightPt = (el.height || 10) * MM_TO_PT;


                if (el.type === 'TEXT') {
                    const textContent = replaceVars(el.content || '', data);
                    pageContent.push({
                        text: textContent,
                        fontSize: el.fontSize || 10,
                        bold: el.isBold || false,
                        alignment: el.align || 'left',
                        absolutePosition: { x: xPt, y: yPt },
                        width: widthPt
                    });
                }


                if (el.type === 'QR') {
                    const qrContent = replaceVars(el.content || '{{code}}', data);
                    const qrSize = Math.min(widthPt, heightPt);
                    pageContent.push({
                        qr: qrContent || 'EMPTY',
                        fit: qrSize,
                        absolutePosition: { x: xPt, y: yPt }
                    });
                }


                if (el.type === 'COUNTER') {
                    const counterText = replaceVars(el.counterFormat || '{{current}} / {{total}}', data);
                    pageContent.push({
                        text: counterText,
                        fontSize: el.fontSize || 14,
                        bold: el.isBold || false,
                        alignment: el.align || 'left',
                        absolutePosition: { x: xPt, y: yPt },
                        width: widthPt
                    });
                }


                if (el.type === 'LINE') {
                    const isHorizontal = el.width >= (el.height || 1);
                    const lineWidth = el.strokeWidth ? el.strokeWidth * MM_TO_PT : 1;

                    if (isHorizontal) {
                        pageContent.push({
                            canvas: [{
                                type: 'line',
                                x1: 0, y1: 0,
                                x2: widthPt, y2: 0,
                                lineWidth: lineWidth,
                                lineColor: 'black'
                            }],
                            absolutePosition: { x: xPt, y: yPt }
                        });
                    } else {
                        pageContent.push({
                            canvas: [{
                                type: 'line',
                                x1: 0, y1: 0,
                                x2: 0, y2: heightPt,
                                lineWidth: lineWidth,
                                lineColor: 'black'
                            }],
                            absolutePosition: { x: xPt, y: yPt }
                        });
                    }
                }


                if (el.type === 'RECTANGLE') {
                    const lineWidth = el.strokeWidth ? el.strokeWidth * MM_TO_PT : 1;
                    pageContent.push({
                        canvas: [{
                            type: 'rect',
                            x: 0, y: 0,
                            w: widthPt,
                            h: heightPt,
                            lineWidth: lineWidth,
                            lineColor: 'black'
                        }],
                        absolutePosition: { x: xPt, y: yPt }
                    });
                }


                if (el.type === 'IMAGE' && el.imageUrl) {
                    try {
                        pageContent.push({
                            image: el.imageUrl,
                            width: widthPt,
                            height: heightPt,
                            absolutePosition: { x: xPt, y: yPt }
                        });
                    } catch (imgErr) {
                        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', imgErr.message);
                    }
                }


                if (el.type === 'ICON') {
                    if (el.imageUrl) {

                        try {
                            pageContent.push({
                                image: el.imageUrl,
                                width: widthPt,
                                height: heightPt,
                                absolutePosition: { x: xPt, y: yPt }
                            });
                        } catch (imgErr) {
                            console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∏–∫–æ–Ω–∫–∏:', imgErr.message);
                        }
                    } else if (el.iconType && STANDARD_ICONS[el.iconType]) {

                        try {
                            pageContent.push({
                                svg: STANDARD_ICONS[el.iconType],
                                width: widthPt,
                                height: heightPt,
                                absolutePosition: { x: xPt, y: yPt }
                            });
                        } catch (svgErr) {

                            pageContent.push({
                                text: el.content || el.iconType || '?',
                                fontSize: 8,
                                absolutePosition: { x: xPt, y: yPt }
                            });
                        }
                    }
                }
            }


            if (pageContent.length > 0) {
                docDefinition.content.push({
                    stack: pageContent,
                    unbreakable: true
                });
            }


            if (labelIndex < labelsArray.length - 1) {
                docDefinition.content.push({ text: '', pageBreak: 'after' });
            }
        }

        return this._createPdf(docDefinition);
    }
}

module.exports = new PdfService();

================================================================================
FILE: QMS-Server-master/services/RiskMatrixService.js
================================================================================














const RISK_THRESHOLDS = {
  LOW: { min: 1, max: 4 },
  MEDIUM: { min: 5, max: 9 },
  HIGH: { min: 10, max: 15 },
  CRITICAL: { min: 16, max: 25 },
};

const PROBABILITY_LABELS = {
  1: "–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–µ (< 1 —Ä–∞–∑ –≤ 10 –ª–µ—Ç)",
  2: "–ú–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ–µ (1 —Ä–∞–∑ –≤ 5-10 –ª–µ—Ç)",
  3: "–í–æ–∑–º–æ–∂–Ω–æ–µ (1 —Ä–∞–∑ –≤ 1-5 –ª–µ—Ç)",
  4: "–í–µ—Ä–æ—è—Ç–Ω–æ–µ (1 —Ä–∞–∑ –≤ –≥–æ–¥)",
  5: "–ß–∞—Å—Ç–æ–µ (> 1 —Ä–∞–∑–∞ –≤ –≥–æ–¥)",
};

const SEVERITY_LABELS = {
  1: "–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ (–Ω–µ—Ç –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞)",
  2: "–ù–µ—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ (–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç)",
  3: "–°–µ—Ä—å—ë–∑–Ω–æ–µ (—Ç—Ä–∞–≤–º–∞, —Ç—Ä–µ–±—É—é—â–∞—è –ª–µ—á–µ–Ω–∏—è)",
  4: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ (—Ç—è–∂—ë–ª–∞—è —Ç—Ä–∞–≤–º–∞ / –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å)",
  5: "–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–æ–µ (—Å–º–µ—Ä—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞)",
};

class RiskMatrixService {
  


  static calculate(probability, severity) {
    const level = probability * severity;
    const riskClass = this.classify(level);
    return { level, riskClass };
  }

  


  static classify(level) {
    if (level <= RISK_THRESHOLDS.LOW.max) return "LOW";
    if (level <= RISK_THRESHOLDS.MEDIUM.max) return "MEDIUM";
    if (level <= RISK_THRESHOLDS.HIGH.max) return "HIGH";
    return "CRITICAL";
  }

  



  static calculateRPN(severity, probability, detectability) {
    return severity * probability * (detectability || 1);
  }

  



  static isAcceptable(riskClass) {
    return riskClass === "LOW" || riskClass === "MEDIUM";
  }

  


  static getMatrix() {
    const matrix = [];
    for (let p = 5; p >= 1; p--) {
      const row = [];
      for (let s = 1; s <= 5; s++) {
        const { level, riskClass } = this.calculate(p, s);
        row.push({ probability: p, severity: s, level, riskClass });
      }
      matrix.push(row);
    }
    return matrix;
  }

  


  static generateRiskNumber(sequenceNumber) {
    const year = new Date().getFullYear();
    const num = String(sequenceNumber).padStart(3, "0");
    return `RISK-${year}-${num}`;
  }

  


  static getScaleLabels() {
    return {
      probability: PROBABILITY_LABELS,
      severity: SEVERITY_LABELS,
      thresholds: RISK_THRESHOLDS,
    };
  }

  


  static async recalculateRisk(riskRecord, { probability, severity, isResidual = false }) {
    const { level, riskClass } = this.calculate(probability, severity);

    if (isResidual) {
      riskRecord.residualProbability = probability;
      riskRecord.residualSeverity = severity;
      riskRecord.residualRiskLevel = level;
      riskRecord.residualRiskClass = riskClass;
    } else {
      riskRecord.initialProbability = probability;
      riskRecord.initialSeverity = severity;
      riskRecord.initialRiskLevel = level;
      riskRecord.initialRiskClass = riskClass;
    }

    await riskRecord.save();
    return { level, riskClass };
  }
}

module.exports = RiskMatrixService;

================================================================================
FILE: QMS-Server-master/services/SupplierScoringService.js
================================================================================


















const WEIGHTS = {
  qualityScore: 0.30,
  deliveryScore: 0.20,
  documentationScore: 0.20,
  communicationScore: 0.10,
  priceScore: 0.10,
  complianceScore: 0.10,
};

const DECISION_THRESHOLDS = {
  APPROVED: 80,
  CONDITIONALLY_APPROVED: 60,
  
};


const EVALUATION_PERIODS = {
  CRITICAL: 6,   
  MAJOR: 12,     
  MINOR: 24,     
};

class SupplierScoringService {
  


  static calculateScore(scores) {
    let total = 0;
    let weightSum = 0;

    for (const [field, weight] of Object.entries(WEIGHTS)) {
      const value = scores[field];
      if (value !== null && value !== undefined) {
        total += value * weight;
        weightSum += weight;
      }
    }

    
    return weightSum > 0 ? Math.round((total / weightSum) * 10) : 0;
  }

  


  static determineDecision(score) {
    if (score >= DECISION_THRESHOLDS.APPROVED) return "APPROVED";
    if (score >= DECISION_THRESHOLDS.CONDITIONALLY_APPROVED) return "CONDITIONALLY_APPROVED";
    return "REJECTED";
  }

  


  static getNextEvaluationDate(criticality) {
    const months = EVALUATION_PERIODS[criticality] || 12;
    const next = new Date();
    next.setMonth(next.getMonth() + months);
    return next;
  }

  


  static calculateDeliveryMetrics(supplies) {
    const total = supplies.length;
    if (total === 0) return { totalOrders: 0, defectiveOrders: 0, lateDeliveries: 0, defectRate: 0 };

    const defective = supplies.filter(s => s.hasDefects || s.status === "REJECTED").length;
    const late = supplies.filter(s => {
      if (!s.expectedDate || !s.actualDate) return false;
      return new Date(s.actualDate) > new Date(s.expectedDate);
    }).length;

    return {
      totalOrders: total,
      defectiveOrders: defective,
      lateDeliveries: late,
      defectRate: Math.round((defective / total) * 100),
      onTimeRate: Math.round(((total - late) / total) * 100),
    };
  }

  


  static getConfig() {
    return {
      weights: WEIGHTS,
      thresholds: DECISION_THRESHOLDS,
      evaluationPeriods: EVALUATION_PERIODS,
    };
  }
}

module.exports = SupplierScoringService;

================================================================================
FILE: QMS-Server-master/static/defect-records/2/1769537183976_README.md
================================================================================

# MES Kryptonit PWA

Progressive Web Application –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º MES Kryptonit.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **PWA** ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω, —Ä–∞–±–æ—Ç–∞ –æ—Ñ–ª–∞–π–Ω
- **Keycloak SSO** ‚Äî –µ–¥–∏–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π SSO
- **–õ–æ–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω** ‚Äî fallback –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –ª–æ–≥–∏–Ω—É/–ø–∞—Ä–æ–ª—é
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö, –ø–ª–∞–Ω—à–µ—Ç–∞—Ö, –ü–ö
- **–¢—ë–º–Ω–∞—è —Ç–µ–º–∞** ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π

## üì± –ú–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| –ì–ª–∞–≤–Ω–∞—è | Dashboard —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –±—ã—Å—Ç—Ä—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ |
| –°–∫–ª–∞–¥ | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏, –ø—Ä–∏—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ |
| –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ | –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —á–µ–∫–ª–∏—Å—Ç—ã, –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ |
| –ó–∞–¥–∞—á–∏ | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ |
| –†–µ–π—Ç–∏–Ω–≥–∏ | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –∫–æ–º–∞–Ω–¥ |
| –ü—Ä–æ—Ñ–∏–ª—å | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ PWA |

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `src/config/index.ts`:

```typescript
export const config = {
  // API –±—ç–∫–µ–Ω–¥–∞ MES (—á–µ—Ä–µ–∑ Vite –ø—Ä–æ–∫—Å–∏)
  API_URL: '/api',
  
  // Keycloak
  KEYCLOAK: {
    URL: 'http://10.11.0.16:8080',
    REALM: 'MES-Realm',
    CLIENT_ID: 'mes-web-client',
  },
  
  // –ü—Ä—è–º–æ–π URL API
  API_DIRECT_URL: 'http://10.11.0.16:5001',
}
```

## üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Node.js 18+
- npm –∏–ª–∏ yarn

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd mes-pwa
npm install
```

### –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
npm run dev
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ `http://localhost:3000` –∏ `http://<–≤–∞—à-ip>:3000`.

### Production —Å–±–æ—Ä–∫–∞

```bash
npm run build
```

–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –ø–æ—è–≤—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ `dist/`.

### –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–±–æ—Ä–∫–∏

```bash
npm run preview
```

## üåê –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: Vite Preview (–ø—Ä–æ—Å—Ç–æ–π)

```bash
npm run preview -- --host
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Nginx (production)

```nginx
server {
    listen 3000;
    server_name _;
    root /var/www/mes-pwa/dist;
    index index.html;

    # PWA assets
    location /assets {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Service Worker
    location /sw.js {
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # API Proxy
    location /api {
        proxy_pass http://10.11.0.16:5001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: Docker

```dockerfile
FROM node:18-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]
```

## üîß Keycloak –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç `mes-web-client` –≤ Keycloak
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞:
   - **Client Protocol:** openid-connect
   - **Access Type:** public
   - **Valid Redirect URIs:** `http://10.11.0.16:3000/*`
   - **Web Origins:** `http://10.11.0.16:3000`
   - **Standard Flow:** Enabled
   - **Direct Access Grants:** Disabled

3. –î–æ–±–∞–≤—å—Ç–µ mappers –¥–ª—è —Ä–æ–ª–µ–π –≤ token

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
mes-pwa/
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ favicon.svg
‚îÇ   ‚îú‚îÄ‚îÄ icon-192.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-512.png
‚îÇ   ‚îú‚îÄ‚îÄ robots.txt
‚îÇ   ‚îî‚îÄ‚îÄ silent-check-sso.html
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts          # Axios –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ keycloak.ts        # Keycloak –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Layout.tsx     # –ì–ª–∞–≤–Ω—ã–π layout
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.tsx      # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useDebounce.ts     # Custom hooks
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Home/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Production/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Profile/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Rankings/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Tasks/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Warehouse/
‚îÇ   ‚îú‚îÄ‚îÄ store/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ authStore.ts       # Zustand store
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # TypeScript —Ç–∏–ø—ã
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx
‚îÇ   ‚îú‚îÄ‚îÄ index.css
‚îÇ   ‚îî‚îÄ‚îÄ main.tsx
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tailwind.config.js
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ vite.config.ts
```

## üì≤ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PWA

### Android
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Chrome
2. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω" –∏–ª–∏ –∏–∫–æ–Ω–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ

### iOS
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Safari
2. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" ‚Üí "–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π"

### Desktop
1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Chrome/Edge
2. –ù–∞–∂–º–∏—Ç–µ –∏–∫–æ–Ω–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ

## üîå API Endpoints

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–∂–∏–¥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ endpoints –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:

```
POST   /api/users/login           # –õ–æ–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω
GET    /api/users/auth            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
GET    /api/warehouse/boxes       # –°–ø–∏—Å–æ–∫ –∫–æ—Ä–æ–±–æ–∫
GET    /api/warehouse/boxes/:id   # –î–µ—Ç–∞–ª–∏ –∫–æ—Ä–æ–±–∫–∏
POST   /api/warehouse/boxes/:id/movements  # –î–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
GET    /api/products              # –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
POST   /api/products/scan         # –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
POST   /api/products/:id/complete-step     # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞
GET    /api/production-steps/:id  # –î–µ—Ç–∞–ª–∏ —ç—Ç–∞–ø–∞
GET    /api/tasks                 # –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
GET    /api/rankings/users        # –†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
GET    /api/rankings/teams        # –†–µ–π—Ç–∏–Ω–≥ –∫–æ–º–∞–Ω–¥
GET    /api/rankings/my-stats     # –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```

## üêõ Troubleshooting

### –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç Keycloak SSO
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL Keycloak –≤ –∫–æ–Ω—Ñ–∏–≥–µ
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç `mes-web-client` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Keycloak

### –û—à–∏–±–∫–∞ CORS –ø—Ä–∏ API –∑–∞–ø—Ä–æ—Å–∞—Ö
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Vite proxy –Ω–∞—Å—Ç—Ä–æ–µ–Ω (dev —Ä–µ–∂–∏–º)
- –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Nginx proxy

### PWA –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ HTTPS (–∏–ª–∏ localhost)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ manifest.json –≤ DevTools ‚Üí Application

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

================================================================================
FILE: QMS-Server-master/static/defect-records/2/1769579757522_README.md
================================================================================

# MABON ‚Äî Luxury Porcelain & Sculpture

–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω –¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–æ–≥–æ —Ñ–∞—Ä—Ñ–æ—Ä–∞ –∏ —Å–∫—É–ª—å–ø—Ç—É—Ä. React + Node.js + PostgreSQL.

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Mabon_Luxury/
‚îú‚îÄ‚îÄ src/                    # Frontend (React + TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ components/         # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ pages/              # –°—Ç—Ä–∞–Ω–∏—Ü—ã
‚îÇ   ‚îú‚îÄ‚îÄ context/            # React –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ api/                # API –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ mabon-backend/          # Backend (Node.js + Express)
‚îÇ   ‚îú‚îÄ‚îÄ controllers/        # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ models/             # Sequelize –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ routes/             # –†–æ—É—Ç—ã API
‚îÇ   ‚îú‚îÄ‚îÄ middleware/         # JWT, —Ä–æ–ª–∏, –æ—à–∏–±–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ static/             # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ docker-compose.yml      # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ nginx.conf              # Nginx –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
‚îî‚îÄ‚îÄ Dockerfile              # Frontend —Å–±–æ—Ä–∫–∞
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker)

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫

```bash
git clone <repo-url>
cd Mabon_Luxury

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d --build
```

### 2. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ

- **–°–∞–π—Ç:** http://localhost:3001
- **API:** http://localhost:5000/api

### 3. –í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω

- **Email:** `admin@mabon.local`
- **–ü–∞—Ä–æ–ª—å:** `Mabon_Super_Secret_2025!`

---

## üíª –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–±–µ–∑ Docker)

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 20+
- PostgreSQL 15+
- npm –∏–ª–∏ yarn

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞—Ç—å –ë–î
psql -U postgres -c "CREATE DATABASE mabon;"
```

### 2. Backend

```bash
cd mabon-backend

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env (—Å–º. —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ)
cp .env.example .env
nano .env

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
npm run dev
```

Backend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:5000

### 3. Frontend

```bash
# –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
npm install

# –ó–∞–ø—É—Å—Ç–∏—Ç—å dev-—Å–µ—Ä–≤–µ—Ä
npm run dev
```

Frontend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:5173

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Backend: `mabon-backend/.env`

```env
# ===== –°–ï–†–í–ï–† =====
PORT=5000

# ===== –ë–ê–ó–ê –î–ê–ù–ù–´–• =====
DB_HOST=localhost          # –î–ª—è Docker: db
DB_PORT=5432               # –õ–æ–∫–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å 5435
DB_NAME=mabon
DB_USER=postgres
DB_PASSWORD=your_password  # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ =====
JWT_SECRET=your_jwt_secret_min_32_chars    # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï
SECRET_KEY=your_secret_key_min_32_chars    # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== CORS =====
CORS_ORIGINS=http://localhost:5173,http://localhost:3000

# ===== YOOKASSA (–û–ü–õ–ê–¢–ê) =====
YOOKASSA_SHOP_ID=123456                    # –í–∞—à Shop ID
YOOKASSA_SECRET_KEY=test_xxxxx             # –¢–µ—Å—Ç–æ–≤—ã–π –∏–ª–∏ –±–æ–µ–≤–æ–π –∫–ª—é—á

# ===== –ê–î–ú–ò–ù (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ) =====
ADMIN_EMAIL=admin@mabon.local
ADMIN_PASSWORD=Strong_Password_123!        # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== SEQUELIZE =====
DB_SYNC_ALTER=true         # true –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, false –¥–ª—è –ø—Ä–æ–¥–∞
```

### Frontend: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
VITE_API_BASE_URL=http://localhost:5000
```

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

```env
VITE_API_BASE_URL=https://api.your-domain.com
```

---

## üåê –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

### –í–∞—Ä–∏–∞–Ω—Ç 1: Docker Compose –Ω–∞ VPS

#### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker –∏ Docker Compose
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
```

#### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–π—Ç–µ `docker-compose.prod.yml`:

```yaml
services:
  db:
    image: postgres:15-alpine
    container_name: mabon_db
    restart: always
    environment:
      POSTGRES_USER: mabon_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # –ò–∑ .env
      POSTGRES_DB: mabon
    volumes:
      - postgres_data:/var/lib/postgresql/data

  backend:
    build: ./mabon-backend
    container_name: mabon_backend
    restart: always
    depends_on:
      - db
    environment:
      PORT: 5000
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: mabon
      DB_USER: mabon_user
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY: ${SECRET_KEY}
      CORS_ORIGINS: https://your-domain.com
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      DB_SYNC_ALTER: "false"
    volumes:
      - ./mabon-backend/static:/app/static

  frontend:
    build:
      context: .
      args:
        VITE_API_BASE_URL: https://your-domain.com
    container_name: mabon_frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"

volumes:
  postgres_data:
```

#### 3. –°–æ–∑–¥–∞–π—Ç–µ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```env
DB_PASSWORD=SuperSecurePassword123!
JWT_SECRET=your_very_long_jwt_secret_at_least_32_characters
SECRET_KEY=your_very_long_secret_key_at_least_32_characters
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxx
ADMIN_EMAIL=admin@your-domain.com
ADMIN_PASSWORD=AdminSecurePassword456!
```

#### 4. –ó–∞–ø—É—Å–∫

```bash
docker-compose -f docker-compose.prod.yml up -d --build
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

#### Backend –Ω–∞ VPS / Cloud Run / Railway

```bash
cd mabon-backend
npm install --production
npm start
```

#### Frontend –Ω–∞ Vercel / Netlify / Cloudflare Pages

```bash
npm run build
# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–ø–∫—É dist/
```

---

## üîê –ß—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|----------|--------|
| `DB_PASSWORD` | –ü–∞—Ä–æ–ª—å –ë–î | `Kj8#mNp$2qLx` |
| `JWT_SECRET` | –°–µ–∫—Ä–µ—Ç –¥–ª—è JWT —Ç–æ–∫–µ–Ω–æ–≤ (–º–∏–Ω. 32 —Å–∏–º–≤–æ–ª–∞) | `a1b2c3d4e5f6g7h8i9j0...` |
| `SECRET_KEY` | –û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á | `x9y8z7w6v5u4t3s2r1q0...` |
| `ADMIN_PASSWORD` | –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | `Admin$ecure2025!` |
| `YOOKASSA_SECRET_KEY` | –ë–æ–µ–≤–æ–π –∫–ª—é—á –ÆKassa | `live_xxxxxxxxxxxx` |
| `CORS_ORIGINS` | –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã | `https://mabon.ru` |

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–ª—é—á–µ–π

```bash
# JWT_SECRET –∏ SECRET_KEY
openssl rand -base64 32

# –ò–ª–∏ —á–µ—Ä–µ–∑ Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## üìù API Endpoints

### –ü—É–±–ª–∏—á–Ω—ã–µ

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/product` | –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ |
| GET | `/api/product/:id` | –¢–æ–≤–∞—Ä –ø–æ ID |
| GET | `/api/author` | –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤ |
| GET | `/api/author/:id` | –ê–≤—Ç–æ—Ä –ø–æ ID |
| GET | `/api/arttype` | –¢–∏–ø—ã –∏—Å–∫—É—Å—Å—Ç–≤–∞ |
| GET | `/api/review/product/:id` | –û—Ç–∑—ã–≤—ã —Ç–æ–≤–∞—Ä–∞ |

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/api/user/registration` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è |
| POST | `/api/user/login` | –í—Ö–æ–¥ |
| GET | `/api/user/auth` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ |

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Ç—Ä–µ–±—É–µ—Ç JWT)

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/cart` | –ö–æ—Ä–∑–∏–Ω–∞ |
| POST | `/api/cart` | –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É |
| DELETE | `/api/cart/:id` | –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã |
| GET | `/api/wishlist` | –ò–∑–±—Ä–∞–Ω–Ω–æ–µ |
| POST | `/api/order` | –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ |
| GET | `/api/order/my` | –ú–æ–∏ –∑–∞–∫–∞–∑—ã |

### –ê–¥–º–∏–Ω (—Ç—Ä–µ–±—É–µ—Ç JWT + —Ä–æ–ª—å ADMIN)

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/api/product` | –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä |
| PUT | `/api/product/:id` | –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä |
| DELETE | `/api/product/:id` | –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä |
| GET | `/api/order` | –í—Å–µ –∑–∞–∫–∞–∑—ã |
| PUT | `/api/order/:id` | –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ |

---

## üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ÆKassa

### –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ [–ÆKassa](https://yookassa.ru/)
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
3. –£–∫–∞–∂–∏—Ç–µ –≤ `.env`:

```env
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=test_xxxxxxxxxxxxxxxx
```

### –ë–æ–µ–≤–æ–π —Ä–µ–∂–∏–º

1. –ü—Ä–æ–π–¥–∏—Ç–µ –º–æ–¥–µ—Ä–∞—Ü–∏—é –≤ –ÆKassa
2. –ó–∞–º–µ–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á –Ω–∞ –±–æ–µ–≤–æ–π:

```env
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxxxxx
```

### Webhook –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç—ã

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:

```
URL: https://your-domain.com/api/yookassa/webhook
–ú–µ—Ç–æ–¥: POST
```

---

## üõ† –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose up -d --build

# –õ–æ–≥–∏
docker-compose logs -f backend
docker-compose logs -f frontend

# –ó–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î
docker exec -it mabon_db psql -U postgres -d mabon

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker-compose restart backend

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è volumes)
docker-compose down -v
```

---

## üêõ –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### CORS –æ—à–∏–±–∫–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ `CORS_ORIGINS` –≤ `.env` ‚Äî –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–º–µ–Ω —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.

### –ù–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–¥–º–∏–Ω

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `ADMIN_EMAIL` –∏ `ADMIN_PASSWORD` –∑–∞–¥–∞–Ω—ã –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.

### –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DB_HOST` (–¥–ª—è Docker: `db`, –ª–æ–∫–∞–ª—å–Ω–æ: `localhost`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç (`5432` –≤ Docker, –º–æ–∂–µ—Ç –±—ã—Ç—å `5435` –ª–æ–∫–∞–ª—å–Ω–æ)

### –ö–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ volume –¥–ª—è static —Ñ–∞–π–ª–æ–≤:

```yaml
volumes:
  - ./mabon-backend/static:/app/static
```

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
================================================================================
FILE: QMS-Server-master/static/defect-records/2/1769580241363_README.md
================================================================================

# MABON ‚Äî Luxury Porcelain & Sculpture

–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω –¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–æ–≥–æ —Ñ–∞—Ä—Ñ–æ—Ä–∞ –∏ —Å–∫—É–ª—å–ø—Ç—É—Ä. React + Node.js + PostgreSQL.

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Mabon_Luxury/
‚îú‚îÄ‚îÄ src/                    # Frontend (React + TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ components/         # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ pages/              # –°—Ç—Ä–∞–Ω–∏—Ü—ã
‚îÇ   ‚îú‚îÄ‚îÄ context/            # React –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ api/                # API –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ mabon-backend/          # Backend (Node.js + Express)
‚îÇ   ‚îú‚îÄ‚îÄ controllers/        # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ models/             # Sequelize –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ routes/             # –†–æ—É—Ç—ã API
‚îÇ   ‚îú‚îÄ‚îÄ middleware/         # JWT, —Ä–æ–ª–∏, –æ—à–∏–±–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ static/             # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ docker-compose.yml      # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ nginx.conf              # Nginx –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
‚îî‚îÄ‚îÄ Dockerfile              # Frontend —Å–±–æ—Ä–∫–∞
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker)

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫

```bash
git clone <repo-url>
cd Mabon_Luxury

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d --build
```

### 2. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ

- **–°–∞–π—Ç:** http://localhost:3001
- **API:** http://localhost:5000/api

### 3. –í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω

- **Email:** `admin@mabon.local`
- **–ü–∞—Ä–æ–ª—å:** `Mabon_Super_Secret_2025!`

---

## üíª –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–±–µ–∑ Docker)

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 20+
- PostgreSQL 15+
- npm –∏–ª–∏ yarn

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞—Ç—å –ë–î
psql -U postgres -c "CREATE DATABASE mabon;"
```

### 2. Backend

```bash
cd mabon-backend

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env (—Å–º. —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ)
cp .env.example .env
nano .env

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
npm run dev
```

Backend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:5000

### 3. Frontend

```bash
# –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
npm install

# –ó–∞–ø—É—Å—Ç–∏—Ç—å dev-—Å–µ—Ä–≤–µ—Ä
npm run dev
```

Frontend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:5173

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Backend: `mabon-backend/.env`

```env
# ===== –°–ï–†–í–ï–† =====
PORT=5000

# ===== –ë–ê–ó–ê –î–ê–ù–ù–´–• =====
DB_HOST=localhost          # –î–ª—è Docker: db
DB_PORT=5432               # –õ–æ–∫–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å 5435
DB_NAME=mabon
DB_USER=postgres
DB_PASSWORD=your_password  # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ =====
JWT_SECRET=your_jwt_secret_min_32_chars    # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï
SECRET_KEY=your_secret_key_min_32_chars    # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== CORS =====
CORS_ORIGINS=http://localhost:5173,http://localhost:3000

# ===== YOOKASSA (–û–ü–õ–ê–¢–ê) =====
YOOKASSA_SHOP_ID=123456                    # –í–∞—à Shop ID
YOOKASSA_SECRET_KEY=test_xxxxx             # –¢–µ—Å—Ç–æ–≤—ã–π –∏–ª–∏ –±–æ–µ–≤–æ–π –∫–ª—é—á

# ===== –ê–î–ú–ò–ù (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ) =====
ADMIN_EMAIL=admin@mabon.local
ADMIN_PASSWORD=Strong_Password_123!        # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== SEQUELIZE =====
DB_SYNC_ALTER=true         # true –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, false –¥–ª—è –ø—Ä–æ–¥–∞
```

### Frontend: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
VITE_API_BASE_URL=http://localhost:5000
```

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

```env
VITE_API_BASE_URL=https://api.your-domain.com
```

---

## üåê –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

### –í–∞—Ä–∏–∞–Ω—Ç 1: Docker Compose –Ω–∞ VPS

#### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker –∏ Docker Compose
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
```

#### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–π—Ç–µ `docker-compose.prod.yml`:

```yaml
services:
  db:
    image: postgres:15-alpine
    container_name: mabon_db
    restart: always
    environment:
      POSTGRES_USER: mabon_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # –ò–∑ .env
      POSTGRES_DB: mabon
    volumes:
      - postgres_data:/var/lib/postgresql/data

  backend:
    build: ./mabon-backend
    container_name: mabon_backend
    restart: always
    depends_on:
      - db
    environment:
      PORT: 5000
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: mabon
      DB_USER: mabon_user
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY: ${SECRET_KEY}
      CORS_ORIGINS: https://your-domain.com
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      DB_SYNC_ALTER: "false"
    volumes:
      - ./mabon-backend/static:/app/static

  frontend:
    build:
      context: .
      args:
        VITE_API_BASE_URL: https://your-domain.com
    container_name: mabon_frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"

volumes:
  postgres_data:
```

#### 3. –°–æ–∑–¥–∞–π—Ç–µ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```env
DB_PASSWORD=SuperSecurePassword123!
JWT_SECRET=your_very_long_jwt_secret_at_least_32_characters
SECRET_KEY=your_very_long_secret_key_at_least_32_characters
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxx
ADMIN_EMAIL=admin@your-domain.com
ADMIN_PASSWORD=AdminSecurePassword456!
```

#### 4. –ó–∞–ø—É—Å–∫

```bash
docker-compose -f docker-compose.prod.yml up -d --build
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

#### Backend –Ω–∞ VPS / Cloud Run / Railway

```bash
cd mabon-backend
npm install --production
npm start
```

#### Frontend –Ω–∞ Vercel / Netlify / Cloudflare Pages

```bash
npm run build
# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–ø–∫—É dist/
```

---

## üîê –ß—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|----------|--------|
| `DB_PASSWORD` | –ü–∞—Ä–æ–ª—å –ë–î | `Kj8#mNp$2qLx` |
| `JWT_SECRET` | –°–µ–∫—Ä–µ—Ç –¥–ª—è JWT —Ç–æ–∫–µ–Ω–æ–≤ (–º–∏–Ω. 32 —Å–∏–º–≤–æ–ª–∞) | `a1b2c3d4e5f6g7h8i9j0...` |
| `SECRET_KEY` | –û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á | `x9y8z7w6v5u4t3s2r1q0...` |
| `ADMIN_PASSWORD` | –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | `Admin$ecure2025!` |
| `YOOKASSA_SECRET_KEY` | –ë–æ–µ–≤–æ–π –∫–ª—é—á –ÆKassa | `live_xxxxxxxxxxxx` |
| `CORS_ORIGINS` | –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã | `https://mabon.ru` |

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–ª—é—á–µ–π

```bash
# JWT_SECRET –∏ SECRET_KEY
openssl rand -base64 32

# –ò–ª–∏ —á–µ—Ä–µ–∑ Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## üìù API Endpoints

### –ü—É–±–ª–∏—á–Ω—ã–µ

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/product` | –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ |
| GET | `/api/product/:id` | –¢–æ–≤–∞—Ä –ø–æ ID |
| GET | `/api/author` | –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤ |
| GET | `/api/author/:id` | –ê–≤—Ç–æ—Ä –ø–æ ID |
| GET | `/api/arttype` | –¢–∏–ø—ã –∏—Å–∫—É—Å—Å—Ç–≤–∞ |
| GET | `/api/review/product/:id` | –û—Ç–∑—ã–≤—ã —Ç–æ–≤–∞—Ä–∞ |

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/api/user/registration` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è |
| POST | `/api/user/login` | –í—Ö–æ–¥ |
| GET | `/api/user/auth` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ |

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Ç—Ä–µ–±—É–µ—Ç JWT)

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/cart` | –ö–æ—Ä–∑–∏–Ω–∞ |
| POST | `/api/cart` | –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É |
| DELETE | `/api/cart/:id` | –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã |
| GET | `/api/wishlist` | –ò–∑–±—Ä–∞–Ω–Ω–æ–µ |
| POST | `/api/order` | –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ |
| GET | `/api/order/my` | –ú–æ–∏ –∑–∞–∫–∞–∑—ã |

### –ê–¥–º–∏–Ω (—Ç—Ä–µ–±—É–µ—Ç JWT + —Ä–æ–ª—å ADMIN)

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/api/product` | –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä |
| PUT | `/api/product/:id` | –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä |
| DELETE | `/api/product/:id` | –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä |
| GET | `/api/order` | –í—Å–µ –∑–∞–∫–∞–∑—ã |
| PUT | `/api/order/:id` | –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ |

---

## üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ÆKassa

### –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ [–ÆKassa](https://yookassa.ru/)
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
3. –£–∫–∞–∂–∏—Ç–µ –≤ `.env`:

```env
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=test_xxxxxxxxxxxxxxxx
```

### –ë–æ–µ–≤–æ–π —Ä–µ–∂–∏–º

1. –ü—Ä–æ–π–¥–∏—Ç–µ –º–æ–¥–µ—Ä–∞—Ü–∏—é –≤ –ÆKassa
2. –ó–∞–º–µ–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á –Ω–∞ –±–æ–µ–≤–æ–π:

```env
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxxxxx
```

### Webhook –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç—ã

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:

```
URL: https://your-domain.com/api/yookassa/webhook
–ú–µ—Ç–æ–¥: POST
```

---

## üõ† –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose up -d --build

# –õ–æ–≥–∏
docker-compose logs -f backend
docker-compose logs -f frontend

# –ó–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î
docker exec -it mabon_db psql -U postgres -d mabon

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker-compose restart backend

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è volumes)
docker-compose down -v
```

---

## üêõ –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### CORS –æ—à–∏–±–∫–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ `CORS_ORIGINS` –≤ `.env` ‚Äî –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–º–µ–Ω —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.

### –ù–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–¥–º–∏–Ω

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `ADMIN_EMAIL` –∏ `ADMIN_PASSWORD` –∑–∞–¥–∞–Ω—ã –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.

### –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DB_HOST` (–¥–ª—è Docker: `db`, –ª–æ–∫–∞–ª—å–Ω–æ: `localhost`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç (`5432` –≤ Docker, –º–æ–∂–µ—Ç –±—ã—Ç—å `5435` –ª–æ–∫–∞–ª—å–Ω–æ)

### –ö–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ volume –¥–ª—è static —Ñ–∞–π–ª–æ–≤:

```yaml
volumes:
  - ./mabon-backend/static:/app/static
```

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
================================================================================
FILE: QMS-Server-master/tests/controllers/box.test.js
================================================================================

const BoxController = require('../../controllers/warehouse/BoxController');
const { WarehouseBox } = require('../../models/index');
const { logAudit } = require('../../utils/auditLogger');

jest.mock('../../models/index');
jest.mock('../../utils/auditLogger');

describe('BoxController - createBoxesBatch', () => {
    let req, res, next;

    beforeEach(() => {
        req = {
            body: {
                label: 'Test Item',
                quantity: 10,
                itemsPerBox: 5,
                unit: '—à—Ç'
            },
            user: { id: 1 }
        };
        res = { json: jest.fn() };
        next = jest.fn();
        jest.clearAllMocks();
    });

    test('–î–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—é –∫–æ—Ä–æ–±–æ–∫ (Bulk Create)', async () => {
        WarehouseBox.bulkCreate.mockResolvedValue([
            { id: 1, label: 'Test Item' },
            { id: 2, label: 'Test Item' }
        ]);

        await BoxController.createBoxesBatch(req, res, next);

        expect(WarehouseBox.bulkCreate).toHaveBeenCalled();

        const callArgs = WarehouseBox.bulkCreate.mock.calls[0][0];
        expect(callArgs).toHaveLength(10);
        expect(callArgs[0]).toMatchObject({
            label: 'Test Item',
            quantity: 5,
            acceptedById: 1
        });

        expect(logAudit).toHaveBeenCalledWith(expect.objectContaining({
            action: 'WAREHOUSE_BATCH'
        }));

        expect(res.json).toHaveBeenCalled();
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ > 1000', async () => {
        req.body.quantity = 1001;

        await BoxController.createBoxesBatch(req, res, next);

        expect(next).toHaveBeenCalled();


        const error = next.mock.calls[0][0];


        expect(error.status).toBe(400);
        expect(error.message).toContain('–æ—Ç 1 –¥–æ 1000');
    });
});

================================================================================
FILE: QMS-Server-master/tests/controllers/movement.test.js
================================================================================

const MovementController = require('../../controllers/warehouse/MovementController');
const { WarehouseBox, WarehouseMovement } = require('../../models/index');


jest.mock('../../db', () => {
    return {
        transaction: jest.fn(async () => ({
            commit: jest.fn(),
            rollback: jest.fn()
        })),
        define: jest.fn(() => ({
            belongsTo: jest.fn(),
            hasMany: jest.fn(),
            hasOne: jest.fn(),
            belongsToMany: jest.fn()
        })),
        fn: jest.fn(),
        col: jest.fn(),
        authenticate: jest.fn(),
        sync: jest.fn()
    };
});


jest.mock('../../models/index', () => ({
    WarehouseBox: {
        findByPk: jest.fn()
    },
    WarehouseMovement: {
        create: jest.fn()
    },
    WarehouseDocument: {
        create: jest.fn()
    },
    Section: {},
    Team: {},
    User: {},
    Supply: {}
}));

jest.mock('../../utils/auditLogger', () => ({
    logAudit: jest.fn()
}));

describe('MovementController - moveSingle', () => {
    let req, res, next;

    beforeEach(() => {
        req = {
            body: {
                boxId: 1,
                operation: 'MOVE',
                toSectionId: 5,
                deltaQty: 0
            },
            user: { id: 1 }
        };
        res = {
            json: jest.fn(),
            status: jest.fn().mockReturnThis()
        };
        next = jest.fn();
        jest.clearAllMocks();
    });

    test('–î–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–æ—Ä–æ–±–∫—É –Ω–∞ –¥—Ä—É–≥–æ–π —É—á–∞—Å—Ç–æ–∫', async () => {

        const mockBox = {
            id: 1,
            currentSectionId: 1,
            quantity: 10,
            status: 'ON_STOCK',
            save: jest.fn().mockResolvedValue(true)
        };


        WarehouseBox.findByPk.mockResolvedValue(mockBox);

        WarehouseMovement.create.mockResolvedValue({ id: 100 });

        await MovementController.moveSingle(req, res, next);


        expect(mockBox.currentSectionId).toBe(5);

        expect(mockBox.save).toHaveBeenCalled();

        expect(WarehouseMovement.create).toHaveBeenCalledWith(
            expect.objectContaining({
                boxId: 1,
                toSectionId: 5,
                operation: 'MOVE'
            }),
            expect.any(Object)
        );
        expect(res.json).toHaveBeenCalled();
    });

    test('–î–æ–ª–∂–µ–Ω –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∏—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º', async () => {
        req.body.operation = 'CONSUME';
        req.body.deltaQty = -50;

        const mockBox = {
            id: 1,
            quantity: 10,
            save: jest.fn()
        };
        WarehouseBox.findByPk.mockResolvedValue(mockBox);

        await MovementController.moveSingle(req, res, next);


        expect(mockBox.save).not.toHaveBeenCalled();

        expect(next).toHaveBeenCalled();

        const error = next.mock.calls[0][0];
        expect(error.message).toContain('–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 404, –µ—Å–ª–∏ –∫–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', async () => {
        WarehouseBox.findByPk.mockResolvedValue(null);

        await MovementController.moveSingle(req, res, next);

        expect(next).toHaveBeenCalled();
        const error = next.mock.calls[0][0];
        expect(error.status).toBe(404);
        expect(error.message).toBe('–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    });
});

================================================================================
FILE: QMS-Server-master/tests/controllers/supply.test.js
================================================================================

const request = require('supertest');
const express = require('express');
const bodyParser = require('body-parser');
const SupplyController = require('../../controllers/warehouse/SupplyController');
const { Supply } = require('../../models/index');


jest.mock('../../models/index');
jest.mock('../../utils/auditLogger', () => ({
    logAudit: jest.fn()
}));

const app = express();
app.use(bodyParser.json());

app.use((req, res, next) => {
    req.user = { id: 1, role: 'WAREHOUSE_MASTER' };
    next();
});
app.post('/api/warehouse/supplies', SupplyController.createSupply);

describe('SupplyController Integration', () => {
    test('POST /supplies - –î–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É', async () => {
        const mockSupply = { id: 1, docNumber: 'TEST-123', status: 'NEW' };


        Supply.create.mockResolvedValue(mockSupply);

        const res = await request(app)
            .post('/api/warehouse/supplies')
            .send({
                docNumber: 'TEST-123',
                supplier: 'OOO Test',
                comment: 'Test supply'
            });

        expect(res.status).toBe(200);
        expect(res.body.docNumber).toBe('TEST-123');
        expect(Supply.create).toHaveBeenCalled();
    });
});

================================================================================
FILE: QMS-Server-master/tests/middleware/checkAbility.test.js
================================================================================

const checkAbility = require('../../middleware/checkAbilityMiddleware');
const ApiError = require('../../error/ApiError');

describe('checkAbilityMiddleware', () => {
    let mockReq, mockRes, mockNext;

    beforeEach(() => {
        mockReq = { method: 'GET', user: {} };
        mockRes = {};
        mockNext = jest.fn();
    });

    test('–î–æ–ª–∂–µ–Ω –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å SUPER_ADMIN –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤', () => {
        mockReq.user = { role: 'SUPER_ADMIN', abilities: [] };
        const middleware = checkAbility('warehouse.view');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledTimes(1);
        expect(mockNext).toHaveBeenCalledWith();
    });

    test('–î–æ–ª–∂–µ–Ω –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω—É–∂–Ω—ã–º –ø—Ä–∞–≤–æ–º', () => {
        mockReq.user = { role: 'USER', abilities: ['warehouse.view', 'other.ability'] };
        const middleware = checkAbility('warehouse.view');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledWith();
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É 403 (Forbidden), –µ—Å–ª–∏ –ø—Ä–∞–≤–∞ –Ω–µ—Ç', () => {
        mockReq.user = { role: 'USER', abilities: ['other.ability'] };
        const middleware = checkAbility('warehouse.view');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledTimes(1);
        const errorArg = mockNext.mock.calls[0][0];
        expect(errorArg).toBeInstanceOf(ApiError);
        expect(errorArg.status).toBe(403);
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É 401, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç (–Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω)', () => {
        mockReq.user = null;
        const middleware = checkAbility('any.right');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledTimes(1);
        expect(mockNext.mock.calls[0][0].status).toBe(401);
    });
});

================================================================================
FILE: QMS-Server-master/tests/middleware/syncUser.test.js
================================================================================

const syncUserMiddleware = require('../../middleware/syncUserMiddleware');
const { User, Role } = require('../../models/index');


jest.mock('../../models/index', () => ({
    User: {
        findOne: jest.fn(),
        create: jest.fn(),
        update: jest.fn()
    },
    Role: {
        findOne: jest.fn()
    },
    Ability: {}
}));

describe('syncUserMiddleware', () => {
    let req, res, next;

    beforeEach(() => {
        req = {
            auth: {
                payload: {
                    sub: 'keycloak-uuid-123',
                    preferred_username: 'testuser',
                    given_name: 'Ivan',
                    family_name: 'Ivanov',
                    realm_access: { roles: ['WAREHOUSE_MASTER'] }
                }
            }
        };
        res = { status: jest.fn().mockReturnThis(), json: jest.fn() };
        next = jest.fn();
        jest.clearAllMocks();
    });

    test('–î–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç', async () => {

        User.findOne.mockResolvedValue(null);


        const createdUser = {
            id: 10,
            login: 'testuser',
            role: 'WAREHOUSE_MASTER',
            save: jest.fn()
        };
        User.create.mockResolvedValue(createdUser);


        Role.findOne.mockResolvedValue({ abilities: [{ code: 'warehouse.view' }] });

        await syncUserMiddleware(req, res, next);


        expect(User.create).toHaveBeenCalledWith(expect.objectContaining({
            login: 'testuser',
            role: 'WAREHOUSE_MASTER'
        }));
        expect(req.user).toBeDefined();
        expect(req.user.id).toBe(10);
        expect(req.user.abilities).toContain('warehouse.view');
        expect(next).toHaveBeenCalled();
    });

    test('–î–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', async () => {

        const mockSave = jest.fn();
        const existingUser = {
            id: 20,
            login: 'testuser',
            role: 'ASSEMBLER',
            save: mockSave
        };


        User.findOne.mockResolvedValue(existingUser);
        Role.findOne.mockResolvedValue({ abilities: [] });

        await syncUserMiddleware(req, res, next);


        expect(existingUser.role).toBe('WAREHOUSE_MASTER');

        expect(mockSave).toHaveBeenCalled();
        expect(next).toHaveBeenCalled();
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 500 –ø—Ä–∏ –æ—à–∏–±–∫–µ –ë–î', async () => {
        User.findOne.mockRejectedValue(new Error('DB Connection failed'));

        await syncUserMiddleware(req, res, next);

        expect(res.status).toHaveBeenCalledWith(500);
        expect(next).not.toHaveBeenCalled();
    });
});

================================================================================
FILE: QMS-Server-master/utils/auditLogger.js
================================================================================






















const crypto = require("crypto");
const { AuditLog } = require("../models/index");
const sequelize = require("../db");





const AUDIT_ACTIONS = {
  
  SESSION_START: "SESSION_START",
  SESSION_END: "SESSION_END",
  SESSION_DELETE: "SESSION_DELETE",
  SESSION_AUTO_OFF: "SESSION_AUTO_OFF",
  SESSION_FORCE_OFF: "SESSION_FORCE_OFF",

  
  WAREHOUSE_MOVE: "WAREHOUSE_MOVE",
  WAREHOUSE_MOVE_BATCH: "WAREHOUSE_MOVE_BATCH",
  BOX_CREATE: "BOX_CREATE",
  BOX_UPDATE: "BOX_UPDATE",
  BOX_DELETE: "BOX_DELETE",
  BOX_SPLIT: "BOX_SPLIT",
  BOX_MERGE: "BOX_MERGE",
  SUPPLY_CREATE: "SUPPLY_CREATE",
  SUPPLY_UPDATE: "SUPPLY_UPDATE",
  SUPPLY_RECEIVE: "SUPPLY_RECEIVE",

  
  COMPONENT_CREATE: "COMPONENT_CREATE",
  COMPONENT_UPDATE: "COMPONENT_UPDATE",
  COMPONENT_DELETE: "COMPONENT_DELETE",
  COMPONENT_SYNC: "COMPONENT_SYNC",
  COMPONENT_REPLACE: "COMPONENT_REPLACE",
  COMPONENT_TRANSFER: "COMPONENT_TRANSFER",
  COMPONENT_BATCH_ADD: "COMPONENT_BATCH_ADD",

  
  PRODUCTION_ENTRY_CREATE: "PRODUCTION_ENTRY_CREATE",
  PRODUCTION_ENTRY_UPDATE: "PRODUCTION_ENTRY_UPDATE",
  PRODUCTION_ENTRY_APPROVE: "PRODUCTION_ENTRY_APPROVE",
  PRODUCTION_ENTRY_REJECT: "PRODUCTION_ENTRY_REJECT",
  PRODUCTION_ENTRY_DELETE: "PRODUCTION_ENTRY_DELETE",
  PRODUCT_ASSEMBLE: "PRODUCT_ASSEMBLE",
  PRODUCT_QC_PASS: "PRODUCT_QC_PASS",
  PRODUCT_QC_FAIL: "PRODUCT_QC_FAIL",

  
  SECTION_CREATE: "SECTION_CREATE",
  SECTION_UPDATE: "SECTION_UPDATE",
  SECTION_DELETE: "SECTION_DELETE",
  TEAM_CREATE: "TEAM_CREATE",
  TEAM_UPDATE: "TEAM_UPDATE",
  TEAM_DELETE: "TEAM_DELETE",

  
  ROLE_CREATE: "ROLE_CREATE",
  ROLE_UPDATE: "ROLE_UPDATE",
  ROLE_DELETE: "ROLE_DELETE",
  ABILITY_CREATE: "ABILITY_CREATE",
  ABILITY_DELETE: "ABILITY_DELETE",
  ROLE_ABILITY_GRANT: "ROLE_ABILITY_GRANT",
  ROLE_ABILITY_REVOKE: "ROLE_ABILITY_REVOKE",

  
  USER_CREATE: "USER_CREATE",
  USER_UPDATE: "USER_UPDATE",
  USER_DELETE: "USER_DELETE",
  USER_ROLE_CHANGE: "USER_ROLE_CHANGE",

  
  EXPORT_PASSPORT: "EXPORT_PASSPORT",
  EXPORT_DEFECTS: "EXPORT_DEFECTS",
  EXPORT_REPORT: "EXPORT_REPORT",

  
  SETTINGS_UPDATE: "SETTINGS_UPDATE",
  SYSTEM_EVENT: "SYSTEM_EVENT",

  

  
  DOCUMENT_CREATE: "DOCUMENT_CREATE",
  DOCUMENT_UPDATE: "DOCUMENT_UPDATE",
  DOCUMENT_DELETE: "DOCUMENT_DELETE",
  DOCUMENT_VERSION_CREATE: "DOCUMENT_VERSION_CREATE",
  DOCUMENT_SUBMIT_REVIEW: "DOCUMENT_SUBMIT_REVIEW",
  DOCUMENT_APPROVE: "DOCUMENT_APPROVE",
  DOCUMENT_REJECT: "DOCUMENT_REJECT",
  DOCUMENT_MAKE_EFFECTIVE: "DOCUMENT_MAKE_EFFECTIVE",
  DOCUMENT_OBSOLETE: "DOCUMENT_OBSOLETE",
  DOCUMENT_DISTRIBUTE: "DOCUMENT_DISTRIBUTE",
  DOCUMENT_ACKNOWLEDGE: "DOCUMENT_ACKNOWLEDGE",

  
  NC_CREATE: "NC_CREATE",
  NC_UPDATE: "NC_UPDATE",
  NC_INVESTIGATE: "NC_INVESTIGATE",
  NC_DISPOSITION: "NC_DISPOSITION",
  NC_CLOSE: "NC_CLOSE",
  NC_REOPEN: "NC_REOPEN",

  
  CAPA_CREATE: "CAPA_CREATE",
  CAPA_UPDATE: "CAPA_UPDATE",
  CAPA_PLAN_APPROVE: "CAPA_PLAN_APPROVE",
  CAPA_IMPLEMENT: "CAPA_IMPLEMENT",
  CAPA_VERIFY: "CAPA_VERIFY",
  CAPA_CLOSE: "CAPA_CLOSE",
  CAPA_EFFECTIVENESS_CHECK: "CAPA_EFFECTIVENESS_CHECK",

  
  AUDIT_PLAN_CREATE: "AUDIT_PLAN_CREATE",
  AUDIT_CONDUCT: "AUDIT_CONDUCT",
  AUDIT_FINDING_CREATE: "AUDIT_FINDING_CREATE",
  AUDIT_REPORT_APPROVE: "AUDIT_REPORT_APPROVE",

  
  RISK_CREATE: "RISK_CREATE",
  RISK_UPDATE: "RISK_UPDATE",
  RISK_ASSESS: "RISK_ASSESS",
  RISK_MITIGATE: "RISK_MITIGATE",

  
  SUPPLIER_CREATE: "SUPPLIER_CREATE",
  SUPPLIER_EVALUATE: "SUPPLIER_EVALUATE",
  SUPPLIER_APPROVE: "SUPPLIER_APPROVE",
  SUPPLIER_SUSPEND: "SUPPLIER_SUSPEND",

  
  TRAINING_COMPLETE: "TRAINING_COMPLETE",
  COMPETENCY_ASSIGN: "COMPETENCY_ASSIGN",

  
  EQUIPMENT_CALIBRATE: "EQUIPMENT_CALIBRATE",
  EQUIPMENT_OVERDUE: "EQUIPMENT_OVERDUE",

  
  MANAGEMENT_REVIEW_CREATE: "MANAGEMENT_REVIEW_CREATE",
  MANAGEMENT_REVIEW_CLOSE: "MANAGEMENT_REVIEW_CLOSE",
};





const AUDIT_ENTITIES = {
  
  SESSION: "SESSION",
  WAREHOUSE_MOVEMENT: "WarehouseMovement",
  INVENTORY_BOX: "InventoryBox",
  SUPPLY: "Supply",
  WAREHOUSE_DOCUMENT: "WarehouseDocument",
  COMPONENT_INVENTORY: "ComponentInventory",
  COMPONENT_HISTORY: "ComponentHistory",
  COMPONENT_CATALOG: "ComponentCatalog",
  PRODUCTION_ENTRY: "ProductionEntry",
  PRODUCTION_OUTPUT: "ProductionOutput",
  ASSEMBLED_PRODUCT: "AssembledProduct",
  SECTION: "Section",
  TEAM: "Team",
  ROLE: "Role",
  ABILITY: "Ability",
  ROLE_ABILITY: "RoleAbility",
  USER: "User",

  
  DOCUMENT: "Document",
  DOCUMENT_VERSION: "DocumentVersion",
  DOCUMENT_APPROVAL: "DocumentApproval",
  NONCONFORMITY: "Nonconformity",
  CAPA: "Capa",
  CAPA_ACTION: "CapaAction",
  RISK: "Risk",
  RISK_ASSESSMENT: "RiskAssessment",
  SUPPLIER: "Supplier",
  SUPPLIER_EVALUATION: "SupplierEvaluation",
  INTERNAL_AUDIT: "InternalAudit",
  AUDIT_FINDING: "AuditFinding",
  TRAINING_RECORD: "TrainingRecord",
  EQUIPMENT: "Equipment",
  CALIBRATION: "CalibrationRecord",
  MANAGEMENT_REVIEW: "ManagementReview",
};





const SEVERITY_MAP = {
  
  DOCUMENT_APPROVE: "CRITICAL",
  DOCUMENT_MAKE_EFFECTIVE: "CRITICAL",
  NC_CREATE: "CRITICAL",
  NC_DISPOSITION: "CRITICAL",
  CAPA_CLOSE: "CRITICAL",
  PRODUCT_QC_PASS: "CRITICAL",
  PRODUCT_QC_FAIL: "CRITICAL",
  SUPPLIER_APPROVE: "CRITICAL",
  SUPPLIER_SUSPEND: "CRITICAL",
  EQUIPMENT_OVERDUE: "CRITICAL",
  MANAGEMENT_REVIEW_CLOSE: "CRITICAL",

  
  DOCUMENT_REJECT: "WARNING",
  NC_REOPEN: "WARNING",
  PRODUCTION_ENTRY_REJECT: "WARNING",
  RISK_ASSESS: "WARNING",

  
  USER_ROLE_CHANGE: "SECURITY",
  ROLE_ABILITY_GRANT: "SECURITY",
  ROLE_ABILITY_REVOKE: "SECURITY",
  SESSION_FORCE_OFF: "SECURITY",
  ROLE_CREATE: "SECURITY",
  ROLE_DELETE: "SECURITY",
};

function getSeverity(action) {
  return SEVERITY_MAP[action] || "INFO";
}





const GENESIS_HASH = "0".repeat(64);





function computeDataHash({ userId, action, entity, entityId, description, metadata, createdAt }) {
  const payload = JSON.stringify({
    userId: userId ?? null,
    action: action || "",
    entity: entity || "",
    entityId: entityId === undefined || entityId === null ? "" : String(entityId),
    description: description || "",
    metadata: metadata || {},
    createdAt: createdAt || new Date().toISOString(),
  });

  return crypto.createHash("sha256").update(payload, "utf8").digest("hex");
}





function computeChainHash(chainIndex, prevHash, dataHash) {
  const payload = `${chainIndex}:${prevHash}:${dataHash}`;
  return crypto.createHash("sha256").update(payload, "utf8").digest("hex");
}





async function getLastChainEntry(transaction) {
  const [results] = await sequelize.query(
    `SELECT "chainIndex", "currentHash" 
     FROM audit_logs 
     WHERE "chainIndex" IS NOT NULL 
     ORDER BY "chainIndex" DESC 
     LIMIT 1
     FOR UPDATE`,
    { transaction, type: sequelize.QueryTypes.SELECT }
  );

  if (results) {
    return {
      chainIndex: Number(results.chainIndex),
      currentHash: results.currentHash,
    };
  }

  return { chainIndex: 0, currentHash: GENESIS_HASH };
}
























async function logAudit({
  req,
  userId,
  action,
  entity,
  entityId,
  description,
  metadata,
  severity,
}) {
  if (!action) {
    console.warn("[HashChainLogger] –ü–æ–ø—ã—Ç–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è action");
    return null;
  }

  
  const transaction = await sequelize.transaction({
    isolationLevel: "SERIALIZABLE", 
  });

  try {
    
    let finalUserId = null;
    if (req && req.user && req.user.id) {
      finalUserId = req.user.id;
    } else if (userId) {
      finalUserId = userId;
    }

    
    let meta = metadata || {};
    if (req) {
      const ipHeader = req.headers["x-forwarded-for"];
      const ip =
        (typeof ipHeader === "string" ? ipHeader.split(",")[0] : null) ||
        req.connection?.remoteAddress ||
        req.ip ||
        null;

      meta = {
        ...meta,
        ip,
        userAgent: req.headers["user-agent"] || null,
      };
    }

    
    const normalizedEntityId =
      entityId === undefined || entityId === null ? null : String(entityId);

    
    const now = new Date();
    const dataHash = computeDataHash({
      userId: finalUserId,
      action,
      entity: entity || null,
      entityId: normalizedEntityId,
      description: description || null,
      metadata: Object.keys(meta).length > 0 ? meta : null,
      createdAt: now.toISOString(),
    });

    
    const lastEntry = await getLastChainEntry(transaction);
    const newChainIndex = lastEntry.chainIndex + 1;
    const prevHash = lastEntry.currentHash;

    
    const currentHash = computeChainHash(newChainIndex, prevHash, dataHash);

    
    const finalSeverity = severity || getSeverity(action);

    
    const record = await AuditLog.create(
      {
        userId: finalUserId,
        action,
        entity: entity || null,
        entityId: normalizedEntityId,
        description: description || null,
        metadata: Object.keys(meta).length > 0 ? meta : null,
        chainIndex: newChainIndex,
        prevHash,
        currentHash,
        dataHash,
        severity: finalSeverity,
        createdAt: now,
      },
      { transaction }
    );

    await transaction.commit();
    return record;
  } catch (error) {
    await transaction.rollback();
    console.error("[HashChainLogger] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞:", error);

    
    try {
      return await AuditLog.create({
        userId:
          (req && req.user && req.user.id) || userId || null,
        action,
        entity: entity || null,
        entityId:
          entityId === undefined || entityId === null
            ? null
            : String(entityId),
        description: `[CHAIN_ERROR] ${description || ""}`,
        metadata: { ...(metadata || {}), chainError: error.message },
        severity: severity || getSeverity(action),
      });
    } catch (fallbackError) {
      console.error("[HashChainLogger] CRITICAL: –î–∞–∂–µ fallback-–∑–∞–ø–∏—Å—å –Ω–µ —É–¥–∞–ª–∞—Å—å:", fallbackError);
      return null;
    }
  }
}







async function logWarehouseMove(req, movement, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.WAREHOUSE_MOVE,
    entity: AUDIT_ENTITIES.WAREHOUSE_MOVEMENT,
    entityId: movement.id,
    description: `–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ: ${movement.operation}, –∫–æ–ª-–≤–æ: ${movement.deltaQty || 0}`,
    metadata: {
      boxId: movement.boxId,
      operation: movement.operation,
      fromSectionId: movement.fromSectionId,
      toSectionId: movement.toSectionId,
      deltaQty: movement.deltaQty,
      ...metadata,
    },
  });
}



async function logProductionEntry(req, entry, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.PRODUCTION_ENTRY_CREATE,
    approve: AUDIT_ACTIONS.PRODUCTION_ENTRY_APPROVE,
    reject: AUDIT_ACTIONS.PRODUCTION_ENTRY_REJECT,
    update: AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    delete: AUDIT_ACTIONS.PRODUCTION_ENTRY_DELETE,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    entity: AUDIT_ENTITIES.PRODUCTION_ENTRY,
    entityId: entry.id,
    description: `–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å #${entry.id}: ${action}`,
    metadata: {
      entryId: entry.id,
      quantity: entry.quantity,
      productId: entry.productId,
      ...metadata,
    },
  });
}



async function logComponentSync(req, serverId, result, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.COMPONENT_SYNC,
    entity: AUDIT_ENTITIES.COMPONENT_INVENTORY,
    entityId: serverId,
    description: `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ #${serverId}`,
    metadata: {
      serverId,
      mode: result.mode,
      added: result.actions?.added?.length || 0,
      updated: result.actions?.updated?.length || 0,
      preserved: result.actions?.preserved?.length || 0,
      ...metadata,
    },
  });
}



async function logExport(req, exportType, description, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.EXPORT_REPORT,
    entity: null,
    entityId: null,
    description: description || `–≠–∫—Å–ø–æ—Ä—Ç: ${exportType}`,
    metadata: { exportType, ...metadata },
  });
}







async function logDocumentCreate(req, doc, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.DOCUMENT_CREATE,
    entity: AUDIT_ENTITIES.DOCUMENT,
    entityId: doc.id,
    description: `–°–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç: ${doc.code} "${doc.title}"`,
    metadata: { code: doc.code, type: doc.type, ...metadata },
  });
}

async function logDocumentApproval(req, doc, version, decision, metadata = {}) {
  const action =
    decision === "APPROVED"
      ? AUDIT_ACTIONS.DOCUMENT_APPROVE
      : AUDIT_ACTIONS.DOCUMENT_REJECT;

  return logAudit({
    req,
    action,
    entity: AUDIT_ENTITIES.DOCUMENT_APPROVAL,
    entityId: doc.id,
    description: `–î–æ–∫—É–º–µ–Ω—Ç ${doc.code} v${version.version}: ${decision}`,
    metadata: {
      documentId: doc.id,
      versionId: version.id,
      versionNumber: version.version,
      decision,
      ...metadata,
    },
  });
}

async function logDocumentEffective(req, doc, version, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.DOCUMENT_MAKE_EFFECTIVE,
    entity: AUDIT_ENTITIES.DOCUMENT,
    entityId: doc.id,
    description: `–î–æ–∫—É–º–µ–Ω—Ç ${doc.code} v${version.version} –≤–≤–µ–¥—ë–Ω –≤ –¥–µ–π—Å—Ç–≤–∏–µ`,
    metadata: {
      documentId: doc.id,
      versionId: version.id,
      ...metadata,
    },
  });
}



async function logNonconformity(req, nc, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.NC_CREATE,
    update: AUDIT_ACTIONS.NC_UPDATE,
    investigate: AUDIT_ACTIONS.NC_INVESTIGATE,
    disposition: AUDIT_ACTIONS.NC_DISPOSITION,
    close: AUDIT_ACTIONS.NC_CLOSE,
    reopen: AUDIT_ACTIONS.NC_REOPEN,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.NC_UPDATE,
    entity: AUDIT_ENTITIES.NONCONFORMITY,
    entityId: nc.id,
    description: `NC-${String(nc.id).padStart(4, "0")}: ${action}`,
    metadata: {
      ncNumber: nc.number,
      source: nc.source,
      classification: nc.classification,
      ...metadata,
    },
  });
}



async function logCapa(req, capa, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.CAPA_CREATE,
    update: AUDIT_ACTIONS.CAPA_UPDATE,
    planApprove: AUDIT_ACTIONS.CAPA_PLAN_APPROVE,
    implement: AUDIT_ACTIONS.CAPA_IMPLEMENT,
    verify: AUDIT_ACTIONS.CAPA_VERIFY,
    close: AUDIT_ACTIONS.CAPA_CLOSE,
    effectivenessCheck: AUDIT_ACTIONS.CAPA_EFFECTIVENESS_CHECK,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.CAPA_UPDATE,
    entity: AUDIT_ENTITIES.CAPA,
    entityId: capa.id,
    description: `CAPA-${String(capa.id).padStart(4, "0")}: ${action}`,
    metadata: {
      capaNumber: capa.number,
      type: capa.type,
      ...metadata,
    },
  });
}





module.exports = {
  
  logAudit,
  AUDIT_ACTIONS,
  AUDIT_ENTITIES,
  GENESIS_HASH,

  
  computeDataHash,
  computeChainHash,

  
  logWarehouseMove,
  logComponentSync,
  logProductionEntry,
  logExport,

  
  logDocumentCreate,
  logDocumentApproval,
  logDocumentEffective,
  logNonconformity,
  logCapa,

  
  getSeverity,
};

================================================================================
FILE: QMS-Server-master/utils/auditVerifier.js
================================================================================



















const { AuditLog } = require("../models/index");
const { computeDataHash, computeChainHash, GENESIS_HASH } = require("./hashChainLogger");
const { Op } = require("sequelize");







































async function verifyChain({ fromIndex, toIndex, batchSize = 1000 } = {}) {
  const startTime = Date.now();
  const errors = [];
  let totalRecords = 0;
  let validRecords = 0;
  let unchainedRecords = 0;
  let firstChainIndex = null;
  let lastChainIndex = null;

  
  unchainedRecords = await AuditLog.count({
    where: { chainIndex: null },
  });

  
  const where = { chainIndex: { [Op.ne]: null } };
  if (fromIndex !== undefined) {
    where.chainIndex[Op.gte] = fromIndex;
  }
  if (toIndex !== undefined) {
    where.chainIndex[Op.lte] = toIndex;
  }

  
  let offset = 0;
  let prevHash = null; 
  let prevChainIndex = null;

  
  if (fromIndex && fromIndex > 1) {
    const prevRecord = await AuditLog.findOne({
      where: { chainIndex: fromIndex - 1 },
      attributes: ["currentHash", "chainIndex"],
    });

    if (prevRecord) {
      prevHash = prevRecord.currentHash;
      prevChainIndex = Number(prevRecord.chainIndex);
    } else {
      
      prevHash = null;
      prevChainIndex = fromIndex - 2; 
    }
  }

  while (true) {
    const records = await AuditLog.findAll({
      where,
      order: [["chainIndex", "ASC"]],
      limit: batchSize,
      offset,
      raw: true,
    });

    if (records.length === 0) break;

    for (const record of records) {
      totalRecords++;
      const ci = Number(record.chainIndex);

      if (firstChainIndex === null) firstChainIndex = ci;
      lastChainIndex = ci;

      const recordErrors = [];

      
      if (prevChainIndex !== null && ci !== prevChainIndex + 1) {
        recordErrors.push(
          `–ü—Ä–æ–ø—É—Å–∫ –≤ —Ü–µ–ø–æ—á–∫–µ: –æ–∂–∏–¥–∞–ª—Å—è chainIndex=${prevChainIndex + 1}, –ø–æ–ª—É—á–µ–Ω ${ci}`
        );
      }

      
      const expectedDataHash = computeDataHash({
        userId: record.userId,
        action: record.action,
        entity: record.entity,
        entityId: record.entityId,
        description: record.description,
        metadata: record.metadata,
        createdAt: record.createdAt,
      });

      if (record.dataHash !== expectedDataHash) {
        recordErrors.push(
          `dataHash –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç: stored=${record.dataHash?.substring(0, 12)}..., computed=${expectedDataHash.substring(0, 12)}...`
        );
      }

      
      if (prevHash !== null && record.prevHash !== prevHash) {
        recordErrors.push(
          `prevHash —Ä–∞–∑—Ä—ã–≤: stored=${record.prevHash?.substring(0, 12)}..., expected=${prevHash.substring(0, 12)}...`
        );
      } else if (prevHash === null && ci === 1 && record.prevHash !== GENESIS_HASH) {
        recordErrors.push(
          `Genesis –∑–∞–ø–∏—Å—å –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å prevHash=${"0".repeat(12)}...`
        );
      }

      
      const expectedCurrentHash = computeChainHash(
        ci,
        record.prevHash,
        record.dataHash
      );

      if (record.currentHash !== expectedCurrentHash) {
        recordErrors.push(
          `currentHash –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç: stored=${record.currentHash?.substring(0, 12)}..., computed=${expectedCurrentHash.substring(0, 12)}...`
        );
      }

      
      if (recordErrors.length > 0) {
        errors.push({
          chainIndex: ci,
          recordId: record.id,
          valid: false,
          errors: recordErrors,
        });
      } else {
        validRecords++;
      }

      
      prevHash = record.currentHash;
      prevChainIndex = ci;
    }

    offset += batchSize;
  }

  const durationMs = Date.now() - startTime;

  return {
    valid: errors.length === 0,
    totalRecords,
    validRecords,
    invalidRecords: errors.length,
    unchainedRecords,
    firstChainIndex,
    lastChainIndex,
    errors: errors.slice(0, 100), 
    verifiedAt: new Date().toISOString(),
    durationMs,
  };
}








async function quickVerify(count = 100) {
  const lastRecord = await AuditLog.findOne({
    where: { chainIndex: { [Op.ne]: null } },
    order: [["chainIndex", "DESC"]],
    attributes: ["chainIndex"],
    raw: true,
  });

  if (!lastRecord) {
    return {
      valid: true,
      totalRecords: 0,
      validRecords: 0,
      invalidRecords: 0,
      unchainedRecords: 0,
      firstChainIndex: null,
      lastChainIndex: null,
      errors: [],
      verifiedAt: new Date().toISOString(),
      durationMs: 0,
    };
  }

  const fromIndex = Math.max(1, Number(lastRecord.chainIndex) - count + 1);
  return verifyChain({ fromIndex });
}






async function generateInspectionReport() {
  const fullReport = await verifyChain();

  
  const severityStats = await AuditLog.findAll({
    attributes: [
      "severity",
      [require("sequelize").fn("COUNT", "*"), "count"],
    ],
    where: { chainIndex: { [Op.ne]: null } },
    group: ["severity"],
    raw: true,
  });

  
  const monthlyStats = await AuditLog.findAll({
    attributes: [
      [require("sequelize").fn("DATE_TRUNC", "month", require("sequelize").col("createdAt")), "month"],
      [require("sequelize").fn("COUNT", "*"), "count"],
    ],
    where: {
      chainIndex: { [Op.ne]: null },
      createdAt: { [Op.gte]: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000) },
    },
    group: [require("sequelize").fn("DATE_TRUNC", "month", require("sequelize").col("createdAt"))],
    order: [[require("sequelize").fn("DATE_TRUNC", "month", require("sequelize").col("createdAt")), "ASC"]],
    raw: true,
  });

  return {
    system: "ASVO-QMS",
    standard: "–ì–û–°–¢ ISO 13485-2017 ¬ß4.2.5",
    generatedAt: new Date().toISOString(),
    chainIntegrity: fullReport,
    severityDistribution: severityStats,
    monthlyActivity: monthlyStats,
    conclusion: fullReport.valid
      ? "–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç-—Ç—Ä–µ–π–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –†–∞–∑—Ä—ã–≤–æ–≤ –≤ hash-—Ü–µ–ø–æ—á–∫–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ."
      : `–í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${fullReport.invalidRecords} –Ω–∞—Ä—É—à–µ–Ω–∏–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ.`,
  };
}

module.exports = {
  verifyChain,
  quickVerify,
  generateInspectionReport,
};

================================================================================
FILE: QMS-Server-master/utils/hashChainLogger.js
================================================================================






















const crypto = require("crypto");
const { AuditLog } = require("../models/index");
const sequelize = require("../db");





const AUDIT_ACTIONS = {
  
  SESSION_START: "SESSION_START",
  SESSION_END: "SESSION_END",
  SESSION_DELETE: "SESSION_DELETE",
  SESSION_AUTO_OFF: "SESSION_AUTO_OFF",
  SESSION_FORCE_OFF: "SESSION_FORCE_OFF",

  
  WAREHOUSE_MOVE: "WAREHOUSE_MOVE",
  WAREHOUSE_MOVE_BATCH: "WAREHOUSE_MOVE_BATCH",
  BOX_CREATE: "BOX_CREATE",
  BOX_UPDATE: "BOX_UPDATE",
  BOX_DELETE: "BOX_DELETE",
  BOX_SPLIT: "BOX_SPLIT",
  BOX_MERGE: "BOX_MERGE",
  SUPPLY_CREATE: "SUPPLY_CREATE",
  SUPPLY_UPDATE: "SUPPLY_UPDATE",
  SUPPLY_RECEIVE: "SUPPLY_RECEIVE",

  
  COMPONENT_CREATE: "COMPONENT_CREATE",
  COMPONENT_UPDATE: "COMPONENT_UPDATE",
  COMPONENT_DELETE: "COMPONENT_DELETE",
  COMPONENT_SYNC: "COMPONENT_SYNC",
  COMPONENT_REPLACE: "COMPONENT_REPLACE",
  COMPONENT_TRANSFER: "COMPONENT_TRANSFER",
  COMPONENT_BATCH_ADD: "COMPONENT_BATCH_ADD",

  
  PRODUCTION_ENTRY_CREATE: "PRODUCTION_ENTRY_CREATE",
  PRODUCTION_ENTRY_UPDATE: "PRODUCTION_ENTRY_UPDATE",
  PRODUCTION_ENTRY_APPROVE: "PRODUCTION_ENTRY_APPROVE",
  PRODUCTION_ENTRY_REJECT: "PRODUCTION_ENTRY_REJECT",
  PRODUCTION_ENTRY_DELETE: "PRODUCTION_ENTRY_DELETE",
  PRODUCT_ASSEMBLE: "PRODUCT_ASSEMBLE",
  PRODUCT_QC_PASS: "PRODUCT_QC_PASS",
  PRODUCT_QC_FAIL: "PRODUCT_QC_FAIL",

  
  SECTION_CREATE: "SECTION_CREATE",
  SECTION_UPDATE: "SECTION_UPDATE",
  SECTION_DELETE: "SECTION_DELETE",
  TEAM_CREATE: "TEAM_CREATE",
  TEAM_UPDATE: "TEAM_UPDATE",
  TEAM_DELETE: "TEAM_DELETE",

  
  ROLE_CREATE: "ROLE_CREATE",
  ROLE_UPDATE: "ROLE_UPDATE",
  ROLE_DELETE: "ROLE_DELETE",
  ABILITY_CREATE: "ABILITY_CREATE",
  ABILITY_DELETE: "ABILITY_DELETE",
  ROLE_ABILITY_GRANT: "ROLE_ABILITY_GRANT",
  ROLE_ABILITY_REVOKE: "ROLE_ABILITY_REVOKE",

  
  USER_CREATE: "USER_CREATE",
  USER_UPDATE: "USER_UPDATE",
  USER_DELETE: "USER_DELETE",
  USER_ROLE_CHANGE: "USER_ROLE_CHANGE",

  
  EXPORT_PASSPORT: "EXPORT_PASSPORT",
  EXPORT_DEFECTS: "EXPORT_DEFECTS",
  EXPORT_REPORT: "EXPORT_REPORT",

  
  SETTINGS_UPDATE: "SETTINGS_UPDATE",
  SYSTEM_EVENT: "SYSTEM_EVENT",

  

  
  DOCUMENT_CREATE: "DOCUMENT_CREATE",
  DOCUMENT_UPDATE: "DOCUMENT_UPDATE",
  DOCUMENT_DELETE: "DOCUMENT_DELETE",
  DOCUMENT_VERSION_CREATE: "DOCUMENT_VERSION_CREATE",
  DOCUMENT_SUBMIT_REVIEW: "DOCUMENT_SUBMIT_REVIEW",
  DOCUMENT_APPROVE: "DOCUMENT_APPROVE",
  DOCUMENT_REJECT: "DOCUMENT_REJECT",
  DOCUMENT_MAKE_EFFECTIVE: "DOCUMENT_MAKE_EFFECTIVE",
  DOCUMENT_OBSOLETE: "DOCUMENT_OBSOLETE",
  DOCUMENT_DISTRIBUTE: "DOCUMENT_DISTRIBUTE",
  DOCUMENT_ACKNOWLEDGE: "DOCUMENT_ACKNOWLEDGE",

  
  NC_CREATE: "NC_CREATE",
  NC_UPDATE: "NC_UPDATE",
  NC_INVESTIGATE: "NC_INVESTIGATE",
  NC_DISPOSITION: "NC_DISPOSITION",
  NC_CLOSE: "NC_CLOSE",
  NC_REOPEN: "NC_REOPEN",

  
  CAPA_CREATE: "CAPA_CREATE",
  CAPA_UPDATE: "CAPA_UPDATE",
  CAPA_PLAN_APPROVE: "CAPA_PLAN_APPROVE",
  CAPA_IMPLEMENT: "CAPA_IMPLEMENT",
  CAPA_VERIFY: "CAPA_VERIFY",
  CAPA_CLOSE: "CAPA_CLOSE",
  CAPA_EFFECTIVENESS_CHECK: "CAPA_EFFECTIVENESS_CHECK",

  
  AUDIT_PLAN_CREATE: "AUDIT_PLAN_CREATE",
  AUDIT_CONDUCT: "AUDIT_CONDUCT",
  AUDIT_FINDING_CREATE: "AUDIT_FINDING_CREATE",
  AUDIT_REPORT_APPROVE: "AUDIT_REPORT_APPROVE",

  
  RISK_CREATE: "RISK_CREATE",
  RISK_UPDATE: "RISK_UPDATE",
  RISK_ASSESS: "RISK_ASSESS",
  RISK_MITIGATE: "RISK_MITIGATE",

  
  SUPPLIER_CREATE: "SUPPLIER_CREATE",
  SUPPLIER_EVALUATE: "SUPPLIER_EVALUATE",
  SUPPLIER_APPROVE: "SUPPLIER_APPROVE",
  SUPPLIER_SUSPEND: "SUPPLIER_SUSPEND",

  
  TRAINING_COMPLETE: "TRAINING_COMPLETE",
  COMPETENCY_ASSIGN: "COMPETENCY_ASSIGN",

  
  EQUIPMENT_CALIBRATE: "EQUIPMENT_CALIBRATE",
  EQUIPMENT_OVERDUE: "EQUIPMENT_OVERDUE",

  
  MANAGEMENT_REVIEW_CREATE: "MANAGEMENT_REVIEW_CREATE",
  MANAGEMENT_REVIEW_CLOSE: "MANAGEMENT_REVIEW_CLOSE",
};





const AUDIT_ENTITIES = {
  
  SESSION: "SESSION",
  WAREHOUSE_MOVEMENT: "WarehouseMovement",
  INVENTORY_BOX: "InventoryBox",
  SUPPLY: "Supply",
  WAREHOUSE_DOCUMENT: "WarehouseDocument",
  COMPONENT_INVENTORY: "ComponentInventory",
  COMPONENT_HISTORY: "ComponentHistory",
  COMPONENT_CATALOG: "ComponentCatalog",
  PRODUCTION_ENTRY: "ProductionEntry",
  PRODUCTION_OUTPUT: "ProductionOutput",
  ASSEMBLED_PRODUCT: "AssembledProduct",
  SECTION: "Section",
  TEAM: "Team",
  ROLE: "Role",
  ABILITY: "Ability",
  ROLE_ABILITY: "RoleAbility",
  USER: "User",

  
  DOCUMENT: "Document",
  DOCUMENT_VERSION: "DocumentVersion",
  DOCUMENT_APPROVAL: "DocumentApproval",
  NONCONFORMITY: "Nonconformity",
  CAPA: "Capa",
  CAPA_ACTION: "CapaAction",
  RISK: "Risk",
  RISK_ASSESSMENT: "RiskAssessment",
  SUPPLIER: "Supplier",
  SUPPLIER_EVALUATION: "SupplierEvaluation",
  INTERNAL_AUDIT: "InternalAudit",
  AUDIT_FINDING: "AuditFinding",
  TRAINING_RECORD: "TrainingRecord",
  EQUIPMENT: "Equipment",
  CALIBRATION: "CalibrationRecord",
  MANAGEMENT_REVIEW: "ManagementReview",
};





const SEVERITY_MAP = {
  
  DOCUMENT_APPROVE: "CRITICAL",
  DOCUMENT_MAKE_EFFECTIVE: "CRITICAL",
  NC_CREATE: "CRITICAL",
  NC_DISPOSITION: "CRITICAL",
  CAPA_CLOSE: "CRITICAL",
  PRODUCT_QC_PASS: "CRITICAL",
  PRODUCT_QC_FAIL: "CRITICAL",
  SUPPLIER_APPROVE: "CRITICAL",
  SUPPLIER_SUSPEND: "CRITICAL",
  EQUIPMENT_OVERDUE: "CRITICAL",
  MANAGEMENT_REVIEW_CLOSE: "CRITICAL",

  
  DOCUMENT_REJECT: "WARNING",
  NC_REOPEN: "WARNING",
  PRODUCTION_ENTRY_REJECT: "WARNING",
  RISK_ASSESS: "WARNING",

  
  USER_ROLE_CHANGE: "SECURITY",
  ROLE_ABILITY_GRANT: "SECURITY",
  ROLE_ABILITY_REVOKE: "SECURITY",
  SESSION_FORCE_OFF: "SECURITY",
  ROLE_CREATE: "SECURITY",
  ROLE_DELETE: "SECURITY",
};

function getSeverity(action) {
  return SEVERITY_MAP[action] || "INFO";
}





const GENESIS_HASH = "0".repeat(64);





function computeDataHash({ userId, action, entity, entityId, description, metadata, createdAt }) {
  const payload = JSON.stringify({
    userId: userId ?? null,
    action: action || "",
    entity: entity || "",
    entityId: entityId === undefined || entityId === null ? "" : String(entityId),
    description: description || "",
    metadata: metadata || {},
    createdAt: createdAt || new Date().toISOString(),
  });

  return crypto.createHash("sha256").update(payload, "utf8").digest("hex");
}





function computeChainHash(chainIndex, prevHash, dataHash) {
  const payload = `${chainIndex}:${prevHash}:${dataHash}`;
  return crypto.createHash("sha256").update(payload, "utf8").digest("hex");
}





async function getLastChainEntry(transaction) {
  const [results] = await sequelize.query(
    `SELECT "chainIndex", "currentHash" 
     FROM audit_logs 
     WHERE "chainIndex" IS NOT NULL 
     ORDER BY "chainIndex" DESC 
     LIMIT 1
     FOR UPDATE`,
    { transaction, type: sequelize.QueryTypes.SELECT }
  );

  if (results) {
    return {
      chainIndex: Number(results.chainIndex),
      currentHash: results.currentHash,
    };
  }

  return { chainIndex: 0, currentHash: GENESIS_HASH };
}
























async function logAudit({
  req,
  userId,
  action,
  entity,
  entityId,
  description,
  metadata,
  severity,
}) {
  if (!action) {
    console.warn("[HashChainLogger] –ü–æ–ø—ã—Ç–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è action");
    return null;
  }

  
  const transaction = await sequelize.transaction({
    isolationLevel: "SERIALIZABLE", 
  });

  try {
    
    let finalUserId = null;
    if (req && req.user && req.user.id) {
      finalUserId = req.user.id;
    } else if (userId) {
      finalUserId = userId;
    }

    
    let meta = metadata || {};
    if (req) {
      const ipHeader = req.headers["x-forwarded-for"];
      const ip =
        (typeof ipHeader === "string" ? ipHeader.split(",")[0] : null) ||
        req.connection?.remoteAddress ||
        req.ip ||
        null;

      meta = {
        ...meta,
        ip,
        userAgent: req.headers["user-agent"] || null,
      };
    }

    
    const normalizedEntityId =
      entityId === undefined || entityId === null ? null : String(entityId);

    
    const now = new Date();
    const dataHash = computeDataHash({
      userId: finalUserId,
      action,
      entity: entity || null,
      entityId: normalizedEntityId,
      description: description || null,
      metadata: Object.keys(meta).length > 0 ? meta : null,
      createdAt: now.toISOString(),
    });

    
    const lastEntry = await getLastChainEntry(transaction);
    const newChainIndex = lastEntry.chainIndex + 1;
    const prevHash = lastEntry.currentHash;

    
    const currentHash = computeChainHash(newChainIndex, prevHash, dataHash);

    
    const finalSeverity = severity || getSeverity(action);

    
    const record = await AuditLog.create(
      {
        userId: finalUserId,
        action,
        entity: entity || null,
        entityId: normalizedEntityId,
        description: description || null,
        metadata: Object.keys(meta).length > 0 ? meta : null,
        chainIndex: newChainIndex,
        prevHash,
        currentHash,
        dataHash,
        severity: finalSeverity,
        createdAt: now,
      },
      { transaction }
    );

    await transaction.commit();
    return record;
  } catch (error) {
    await transaction.rollback();
    console.error("[HashChainLogger] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞:", error);

    
    try {
      return await AuditLog.create({
        userId:
          (req && req.user && req.user.id) || userId || null,
        action,
        entity: entity || null,
        entityId:
          entityId === undefined || entityId === null
            ? null
            : String(entityId),
        description: `[CHAIN_ERROR] ${description || ""}`,
        metadata: { ...(metadata || {}), chainError: error.message },
        severity: severity || getSeverity(action),
      });
    } catch (fallbackError) {
      console.error("[HashChainLogger] CRITICAL: –î–∞–∂–µ fallback-–∑–∞–ø–∏—Å—å –Ω–µ —É–¥–∞–ª–∞—Å—å:", fallbackError);
      return null;
    }
  }
}







async function logWarehouseMove(req, movement, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.WAREHOUSE_MOVE,
    entity: AUDIT_ENTITIES.WAREHOUSE_MOVEMENT,
    entityId: movement.id,
    description: `–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ: ${movement.operation}, –∫–æ–ª-–≤–æ: ${movement.deltaQty || 0}`,
    metadata: {
      boxId: movement.boxId,
      operation: movement.operation,
      fromSectionId: movement.fromSectionId,
      toSectionId: movement.toSectionId,
      deltaQty: movement.deltaQty,
      ...metadata,
    },
  });
}



async function logProductionEntry(req, entry, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.PRODUCTION_ENTRY_CREATE,
    approve: AUDIT_ACTIONS.PRODUCTION_ENTRY_APPROVE,
    reject: AUDIT_ACTIONS.PRODUCTION_ENTRY_REJECT,
    update: AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    delete: AUDIT_ACTIONS.PRODUCTION_ENTRY_DELETE,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    entity: AUDIT_ENTITIES.PRODUCTION_ENTRY,
    entityId: entry.id,
    description: `–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å #${entry.id}: ${action}`,
    metadata: {
      entryId: entry.id,
      quantity: entry.quantity,
      productId: entry.productId,
      ...metadata,
    },
  });
}



async function logComponentSync(req, serverId, result, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.COMPONENT_SYNC,
    entity: AUDIT_ENTITIES.COMPONENT_INVENTORY,
    entityId: serverId,
    description: `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ #${serverId}`,
    metadata: {
      serverId,
      mode: result.mode,
      added: result.actions?.added?.length || 0,
      updated: result.actions?.updated?.length || 0,
      preserved: result.actions?.preserved?.length || 0,
      ...metadata,
    },
  });
}



async function logExport(req, exportType, description, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.EXPORT_REPORT,
    entity: null,
    entityId: null,
    description: description || `–≠–∫—Å–ø–æ—Ä—Ç: ${exportType}`,
    metadata: { exportType, ...metadata },
  });
}







async function logDocumentCreate(req, doc, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.DOCUMENT_CREATE,
    entity: AUDIT_ENTITIES.DOCUMENT,
    entityId: doc.id,
    description: `–°–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç: ${doc.code} "${doc.title}"`,
    metadata: { code: doc.code, type: doc.type, ...metadata },
  });
}

async function logDocumentApproval(req, doc, version, decision, metadata = {}) {
  const action =
    decision === "APPROVED"
      ? AUDIT_ACTIONS.DOCUMENT_APPROVE
      : AUDIT_ACTIONS.DOCUMENT_REJECT;

  return logAudit({
    req,
    action,
    entity: AUDIT_ENTITIES.DOCUMENT_APPROVAL,
    entityId: doc.id,
    description: `–î–æ–∫—É–º–µ–Ω—Ç ${doc.code} v${version.version}: ${decision}`,
    metadata: {
      documentId: doc.id,
      versionId: version.id,
      versionNumber: version.version,
      decision,
      ...metadata,
    },
  });
}

async function logDocumentEffective(req, doc, version, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.DOCUMENT_MAKE_EFFECTIVE,
    entity: AUDIT_ENTITIES.DOCUMENT,
    entityId: doc.id,
    description: `–î–æ–∫—É–º–µ–Ω—Ç ${doc.code} v${version.version} –≤–≤–µ–¥—ë–Ω –≤ –¥–µ–π—Å—Ç–≤–∏–µ`,
    metadata: {
      documentId: doc.id,
      versionId: version.id,
      ...metadata,
    },
  });
}



async function logNonconformity(req, nc, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.NC_CREATE,
    update: AUDIT_ACTIONS.NC_UPDATE,
    investigate: AUDIT_ACTIONS.NC_INVESTIGATE,
    disposition: AUDIT_ACTIONS.NC_DISPOSITION,
    close: AUDIT_ACTIONS.NC_CLOSE,
    reopen: AUDIT_ACTIONS.NC_REOPEN,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.NC_UPDATE,
    entity: AUDIT_ENTITIES.NONCONFORMITY,
    entityId: nc.id,
    description: `NC-${String(nc.id).padStart(4, "0")}: ${action}`,
    metadata: {
      ncNumber: nc.number,
      source: nc.source,
      classification: nc.classification,
      ...metadata,
    },
  });
}



async function logCapa(req, capa, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.CAPA_CREATE,
    update: AUDIT_ACTIONS.CAPA_UPDATE,
    planApprove: AUDIT_ACTIONS.CAPA_PLAN_APPROVE,
    implement: AUDIT_ACTIONS.CAPA_IMPLEMENT,
    verify: AUDIT_ACTIONS.CAPA_VERIFY,
    close: AUDIT_ACTIONS.CAPA_CLOSE,
    effectivenessCheck: AUDIT_ACTIONS.CAPA_EFFECTIVENESS_CHECK,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.CAPA_UPDATE,
    entity: AUDIT_ENTITIES.CAPA,
    entityId: capa.id,
    description: `CAPA-${String(capa.id).padStart(4, "0")}: ${action}`,
    metadata: {
      capaNumber: capa.number,
      type: capa.type,
      ...metadata,
    },
  });
}





module.exports = {
  
  logAudit,
  AUDIT_ACTIONS,
  AUDIT_ENTITIES,
  GENESIS_HASH,

  
  computeDataHash,
  computeChainHash,

  
  logWarehouseMove,
  logComponentSync,
  logProductionEntry,
  logExport,

  
  logDocumentCreate,
  logDocumentApproval,
  logDocumentEffective,
  logNonconformity,
  logCapa,

  
  getSeverity,
};

================================================================================
FILE: README.md
================================================================================

# QMS
# QMS

================================================================================
FILE: dump_project_full.py
================================================================================

#!/usr/bin/env python3



from __future__ import annotations 

import io 
import os 
import tokenize 
from pathlib import Path 



PROJECT_DIR =Path .cwd ().resolve ()

DUMP_BASENAME_PREFIX ="project_dump_core"
DUMP_EXTENSION =".txt"



STRIP_COMMENTS_IN_DUMP =True 

KEEP_PY_DOCSTRINGS =False 


def get_next_output_file (project_dir :Path )->Path :

    base_file =project_dir /f"{DUMP_BASENAME_PREFIX}{DUMP_EXTENSION}"
    if not base_file .exists ():
        return base_file 

    max_version =1 

    for p in project_dir .glob (f"{DUMP_BASENAME_PREFIX}_*{DUMP_EXTENSION}"):
        stem =p .stem 
        parts =stem .split ("_")
        if not parts :
            continue 
        last =parts [-1 ]
        try :
            num =int (last )
        except ValueError :
            continue 
        if num >max_version :
            max_version =num 

    next_version =max_version +1 
    return project_dir /f"{DUMP_BASENAME_PREFIX}_{next_version}{DUMP_EXTENSION}"



ALLOWED_ROOT_FILES ={
"README.md",
"index.html",
"package.json",
"eslint.config.js",
"vite.config.ts",
"tsconfig.json",
"tsconfig.app.json",
"tsconfig.node.json",
}


ALLOWED_EXT ={

".ts",".tsx",".js",".jsx",".css",".md",".json",".jsonc",".html",

".yml",".yaml",

".sh",

".py",

".tf",".tfvars",

".cfg",".lock",
}


EXCLUDED_DIRS ={

".git",".idea",".vscode",


"node_modules","dist","build",".next",".nuxt",
"coverage",".turbo",".cache",


".venv","venv","env",".env",
"__pycache__",
"Lib","site-packages","Scripts",
".pytest_cache",".mypy_cache",
".tox",".eggs",


".terraform",
}


EXCLUDED_FILES :set [str ]={
"package-lock.json",
}


EXCLUDED_EXT ={
".map",".svg",".png",".jpg",".jpeg",".gif",".ico",".webp",
".bmp",".pdf",".mp4",".mp3",".wav",
".woff",".woff2",".ttf",".eot",
".pyc",".pyo",".pyd",".whl",
}


UNWANTED_RELATIVE_PATHS ={
"MES-Kryptonit-Client-main/package-lock.json",
"MES-Kryptonit-Server-master/package-lock.json",
"MES-Kryptonit-Client-main/README.md",
"MES-Kryptonit-Client-main/src/components/Test/Test.tsx",
}


MAX_FILE_SIZE_BYTES =400_000 
MAX_LINES_PER_FILE =2000 


def is_excluded_dir (name :str )->bool :
    return name in EXCLUDED_DIRS or name .endswith (".egg-info")


def should_keep_root_file (p :Path )->bool :
    return p .name in ALLOWED_ROOT_FILES 


def is_dump_file (path :Path )->bool :

    return (
    path .suffix ==DUMP_EXTENSION 
    and path .stem .startswith (DUMP_BASENAME_PREFIX )
    )


def should_keep (path :Path )->bool :

    if is_dump_file (path ):
        return False 

    try :
        rel =path .relative_to (PROJECT_DIR ).as_posix ()
    except ValueError :
        rel =path .as_posix ()

    if rel in UNWANTED_RELATIVE_PATHS :
        return False 

    if any (part in EXCLUDED_DIRS for part in path .parts ):
        return False 

    if path .name in EXCLUDED_FILES :
        return False 

    if path .suffix .lower ()in EXCLUDED_EXT :
        return False 

    if path .parent ==PROJECT_DIR and should_keep_root_file (path ):
        return True 

    if path .suffix .lower ()in ALLOWED_EXT :
        return True 

    return False 


def gather_files ()->list [Path ]:
    files :list [Path ]=[]
    for root ,dirs ,filenames in os .walk (PROJECT_DIR ):
        dirs [:]=[d for d in dirs if not is_excluded_dir (d )]
        for fn in filenames :
            p =Path (root )/fn 
            if not p .is_file ():
                continue 
            if should_keep (p ):
                files .append (p )
    return sorted (files ,key =lambda x :x .relative_to (PROJECT_DIR ).as_posix ())






def _strip_html_comments (text :str )->str :

    out :list [str ]=[]
    i =0 
    n =len (text )
    while i <n :
        if text .startswith ("<!--",i ):
            j =text .find ("-->",i +4 )
            if j ==-1 :
                out .extend ("\n"for ch in text [i :]if ch =="\n")
                break 
            seg =text [i :j +3 ]
            out .extend ("\n"for ch in seg if ch =="\n")
            i =j +3 
        else :
            out .append (text [i ])
            i +=1 
    return "".join (out )


def _strip_hash_line_comments (text :str ,*,keep_shebang :bool =True )->str :

    out_lines :list [str ]=[]
    lines =text .splitlines (keepends =True )

    for idx ,line in enumerate (lines ):
        if keep_shebang and idx ==0 and line .startswith ("#!"):
            out_lines .append (line )
            continue 

        in_s =False 
        in_d =False 
        i =0 
        while i <len (line ):
            ch =line [i ]
            if ch =="'"and not in_d :
                in_s =not in_s 
                i +=1 
                continue 
            if ch =='"'and not in_s :
                in_d =not in_d 
                i +=1 
                continue 
            if ch =="#"and not in_s and not in_d :

                if i ==0 or line [i -1 ].isspace ():
                    nl ="\n"if line .endswith ("\n")else ""
                    out_lines .append (line [:i ].rstrip ()+nl )
                    break 
            i +=1 
        else :
            out_lines .append (line )

    return "".join (out_lines )


def _strip_c_like_comments (text :str )->str :

    CODE ,SQ ,DQ ,BT ,LINE ,BLOCK =range (6 )
    state =CODE 
    out :list [str ]=[]
    i =0 
    n =len (text )
    esc =False 

    while i <n :
        ch =text [i ]
        nxt =text [i +1 ]if i +1 <n else ""

        if state ==CODE :
            if ch =="/"and nxt =="/":
                state =LINE 
                i +=2 
                continue 
            if ch =="/"and nxt =="*":
                state =BLOCK 
                i +=2 
                continue 
            if ch =="'":
                state =SQ 
                out .append (ch )
                esc =False 
                i +=1 
                continue 
            if ch =='"':
                state =DQ 
                out .append (ch )
                esc =False 
                i +=1 
                continue 
            if ch =="`":
                state =BT 
                out .append (ch )
                esc =False 
                i +=1 
                continue 

            out .append (ch )
            i +=1 
            continue 

        if state ==LINE :
            if ch =="\n":
                out .append ("\n")
                state =CODE 
            i +=1 
            continue 

        if state ==BLOCK :
            if ch =="\n":
                out .append ("\n")
                i +=1 
                continue 
            if ch =="*"and nxt =="/":
                state =CODE 
                i +=2 
                continue 
            i +=1 
            continue 


        out .append (ch )
        if esc :
            esc =False 
        else :
            if ch =="\\":
                esc =True 
            else :
                if state ==SQ and ch =="'":
                    state =CODE 
                elif state ==DQ and ch =='"':
                    state =CODE 
                elif state ==BT and ch =="`":
                    state =CODE 
        i +=1 

    return "".join (out )


def _strip_python (text :str ,*,keep_docstrings :bool )->str :

    shebang =""
    rest =text 
    if text .startswith ("#!"):
        first ,_ ,remainder =text .partition ("\n")
        shebang =first +"\n"
        rest =remainder 

    try :
        tokgen =tokenize .generate_tokens (io .StringIO (rest ).readline )
    except Exception :
        return shebang +_strip_hash_line_comments (rest ,keep_shebang =False )

    out_tokens :list [tuple [int ,str ]]=[]
    prev_type =tokenize .INDENT 
    at_block_start =True 

    for tok in tokgen :
        ttype =tok .type 
        tstr =tok .string 

        if ttype ==tokenize .COMMENT :
            continue 

        if (not keep_docstrings )and ttype ==tokenize .STRING and at_block_start and prev_type in (
        tokenize .INDENT ,tokenize .NEWLINE ,tokenize .NL ,tokenize .DEDENT ,tokenize .ENCODING 
        ):

            prev_type =ttype 
            at_block_start =False 
            continue 

        out_tokens .append ((ttype ,tstr ))

        if ttype ==tokenize .INDENT :
            at_block_start =True 
        elif ttype not in (tokenize .NL ,tokenize .NEWLINE ,tokenize .ENDMARKER ,tokenize .ENCODING ):
            at_block_start =False 

        prev_type =ttype 

    return shebang +tokenize .untokenize (out_tokens )


def strip_comments_for_file (path :Path ,content :str )->str :
    if not STRIP_COMMENTS_IN_DUMP :
        return content 

    ext =path .suffix .lower ()

    if ext ==".py":
        return _strip_python (content ,keep_docstrings =KEEP_PY_DOCSTRINGS )

    if ext in {".html",".htm",".md"}:
        return _strip_html_comments (content )

    if ext in {".yml",".yaml",".sh"}:
        return _strip_hash_line_comments (content ,keep_shebang =True )

    if ext in {".tf",".tfvars"}:
        content =_strip_c_like_comments (content )
        content =_strip_hash_line_comments (content ,keep_shebang =False )
        return content 

    if ext in {".ts",".tsx",".js",".jsx",".css",".json",".jsonc",".cfg",".lock"}:
        return _strip_c_like_comments (content )

    return content 


def read_file_safely (p :Path )->tuple [str ,bool ]:

    truncated =False 
    try :
        size =p .stat ().st_size 
        if size >MAX_FILE_SIZE_BYTES :
            return (
            f"[–ü—Ä–æ–ø—É—â–µ–Ω–æ: —Ñ–∞–π–ª {size} –±–∞–π—Ç –±–æ–ª—å—à–µ –ª–∏–º–∏—Ç–∞ {MAX_FILE_SIZE_BYTES}]\n",
            True ,
            )

        with p .open ("r",encoding ="utf-8",errors ="replace")as f :
            lines =f .readlines ()

        if len (lines )>MAX_LINES_PER_FILE :
            truncated =True 
            lines =lines [:MAX_LINES_PER_FILE ]
            lines .append (f"\n[... –æ–±—Ä–µ–∑–∞–Ω–æ –¥–æ {MAX_LINES_PER_FILE} —Å—Ç—Ä–æ–∫ ...]\n")

        content ="".join (lines )


        content =strip_comments_for_file (p ,content )

        return content ,truncated 
    except Exception as e :
        return f"[–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}]\n",True 


def main ():
    print (f"–°—Ç–∞—Ä—Ç—É—é —Å–±–æ—Ä–∫—É –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞: {PROJECT_DIR}")

    output_file =get_next_output_file (PROJECT_DIR )
    print (f"–§–∞–π–ª –¥–∞–º–ø–∞: {output_file.name}")

    files =gather_files ()

    toc_lines =["PROJECT CORE FILES OVERVIEW\n","="*80 +"\n"]
    for f in files :
        toc_lines .append (f"- {f.relative_to(PROJECT_DIR).as_posix()}\n")
    toc_lines .append ("\n\n")

    with output_file .open ("w",encoding ="utf-8")as out :
        out .writelines (toc_lines )

        for f in files :
            rel =f .relative_to (PROJECT_DIR ).as_posix ()
            out .write ("="*80 +"\n")
            out .write (f"FILE: {rel}\n")
            out .write ("="*80 +"\n\n")

            content ,_truncated =read_file_safely (f )
            out .write (content )
            out .write ("\n")

    print (f"–ì–æ—Ç–æ–≤–æ: {output_file}")
    print (f"–§–∞–π–ª–æ–≤ —Å–æ–±—Ä–∞–Ω–æ: {len(files)}")

    if STRIP_COMMENTS_IN_DUMP :
        print ("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –¥–∞–º–ø–µ: –£–î–ê–õ–ï–ù–´ (–∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω—ã).")
    else :
        print ("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –¥–∞–º–ø–µ: –ù–ï —Ç—Ä–æ–≥–∞–ª.")


if __name__ =="__main__":
    main ()

================================================================================
FILE: integrate-qms.sh
================================================================================

#!/bin/bash





set -e
cd ~/Documents/ASVO-QMS

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${YELLOW}  ASVO-QMS: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π (Audit, DMS, NC, CAPA)     ${NC}"
echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"

SERVER="QMS-Server-master"
CLIENT="QMS-Client-main"


echo -e "\n${GREEN}[1/5] –ë—ç–∫–∞–ø—ã...${NC}"
for f in models/index.js routes/index.js index.js; do
  if [ -f "$SERVER/$f" ] && [ ! -f "$SERVER/$f.pre-qms" ]; then
    cp "$SERVER/$f" "$SERVER/$f.pre-qms"
    echo -e "  ‚úì $f ‚Üí $f.pre-qms"
  fi
done


echo -e "\n${GREEN}[2/5] models/index.js...${NC}"
MODELS_FILE="$SERVER/models/index.js"

if ! grep -q "definitions/Document" "$MODELS_FILE"; then
  sed -i '/require("\.\/ProductionOutput")/a\
\
\
const {\
    Document,\
    DocumentVersion,\
    DocumentApproval,\
    DocumentDistribution,\
    setupDocumentAssociations,\
    DOCUMENT_TYPES,\
    DOCUMENT_STATUSES,\
    VERSION_STATUSES,\
    APPROVAL_ROLES,\
    APPROVAL_DECISIONS,\
} = require("./definitions/Document");\
\
\
const {\
    Nonconformity,\
    NcAttachment,\
    Capa,\
    CapaAction,\
    CapaVerification,\
    setupNcCapaAssociations,\
    NC_SOURCES,\
    NC_CLASSIFICATIONS,\
    NC_STATUSES,\
    NC_DISPOSITIONS,\
    CAPA_TYPES,\
    CAPA_STATUSES,\
    CAPA_PRIORITIES,\
    CAPA_ACTION_STATUSES,\
} = require("./definitions/NcCapa");' "$MODELS_FILE"
  echo -e "  ‚úì –ò–º–ø–æ—Ä—Ç—ã Document + NcCapa"
fi

if ! grep -q "setupDocumentAssociations" "$MODELS_FILE"; then
  sed -i '/^module\.exports = {/i\
\
// QMS: Document Management System\
setupDocumentAssociations({ User });\
\
// QMS: NC + CAPA\
setupNcCapaAssociations({ User, Document });' "$MODELS_FILE"
  echo -e "  ‚úì Associations"
fi

if ! grep -q "CAPA_ACTION_STATUSES" "$MODELS_FILE"; then
  sed -i '/^};$/i\
\
\
    // QMS: Document Management System\
    Document,\
    DocumentVersion,\
    DocumentApproval,\
    DocumentDistribution,\
    DOCUMENT_TYPES,\
    DOCUMENT_STATUSES,\
    VERSION_STATUSES,\
    APPROVAL_ROLES,\
    APPROVAL_DECISIONS,\
\
    // QMS: NC + CAPA\
    Nonconformity,\
    NcAttachment,\
    Capa,\
    CapaAction,\
    CapaVerification,\
    NC_SOURCES,\
    NC_CLASSIFICATIONS,\
    NC_STATUSES,\
    NC_DISPOSITIONS,\
    CAPA_TYPES,\
    CAPA_STATUSES,\
    CAPA_PRIORITIES,\
    CAPA_ACTION_STATUSES,' "$MODELS_FILE"
  echo -e "  ‚úì –≠–∫—Å–ø–æ—Ä—Ç—ã –≤ module.exports"
fi


echo -e "\n${GREEN}[3/5] routes/index.js...${NC}"
ROUTES_FILE="$SERVER/routes/index.js"

if ! grep -q "documentRouter" "$ROUTES_FILE"; then
  sed -i '/const productionOutputRouter/a\
\
// QMS –º–æ–¥—É–ª–∏\
const documentRouter = require("./documentRouter");\
const ncCapaRouter = require("./ncCapaRouter");' "$ROUTES_FILE"
  echo -e "  ‚úì require documentRouter + ncCapaRouter"
fi

if ! grep -q '"/documents"' "$ROUTES_FILE"; then
  sed -i '/router\.use("\/production", productionOutputRouter);/a\
\
// QMS: Document Management System\
router.use("/documents", documentRouter);\
// QMS: Nonconformity + CAPA\
router.use("/nc", ncCapaRouter);' "$ROUTES_FILE"
  echo -e "  ‚úì router.use /documents + /nc"
fi


echo -e "\n${GREEN}[4/5] Abilities –≤ index.js...${NC}"
INDEX_FILE="$SERVER/index.js"

if ! grep -q "dms.view" "$INDEX_FILE"; then
  sed -i '/beryll\.manage/a\
\
      // QMS: DMS\
      { code: "dms.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–µ—Å—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" },\
      { code: "dms.create", description: "–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" },\
      { code: "dms.approve", description: "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤" },\
      { code: "dms.manage", description: "–í–≤–µ–¥–µ–Ω–∏–µ –≤ –¥–µ–π—Å—Ç–≤–∏–µ, —Ä–∞—Å—Å—ã–ª–∫–∞" },\
      // QMS: Audit\
      { code: "qms.audit.view", description: "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞—É–¥–∏—Ç-–ª–æ–≥" },\
      { code: "qms.audit.verify", description: "–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è hash-chain" },\
      { code: "qms.audit.report", description: "–û—Ç—á—ë—Ç—ã –¥–ª—è –∏–Ω—Å–ø–µ–∫—Ü–∏–∏" },\
      // QMS: NC\
      { code: "nc.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π" },\
      { code: "nc.create", description: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è NC" },\
      { code: "nc.manage", description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NC" },\
      // QMS: CAPA\
      { code: "capa.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä CAPA" },\
      { code: "capa.create", description: "–°–æ–∑–¥–∞–Ω–∏–µ CAPA" },\
      { code: "capa.manage", description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ CAPA" },\
      { code: "capa.verify", description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ CAPA" },' "$INDEX_FILE"
  echo -e "  ‚úì 14 abilities –¥–æ–±–∞–≤–ª–µ–Ω—ã"
fi


echo -e "\n${GREEN}[5/5] hashChainLogger ‚Üí auditLogger...${NC}"
if [ -f "$SERVER/utils/hashChainLogger.js" ]; then
  [ -f "$SERVER/utils/auditLogger.js" ] && cp "$SERVER/utils/auditLogger.js" "$SERVER/utils/auditLogger.js.original"
  mv "$SERVER/utils/hashChainLogger.js" "$SERVER/utils/auditLogger.js"
  echo -e "  ‚úì –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω (–≤—Å–µ require —Å–æ–≤–º–µ—Å—Ç–∏–º—ã)"
else
  echo -e "  ‚Üí –£–∂–µ –≥–æ—Ç–æ–≤–æ"
fi


echo -e "\n${YELLOW}‚ïê‚ïê‚ïê –ü–†–û–í–ï–†–ö–ê ‚ïê‚ïê‚ïê${NC}"

check() { [ "$1" = "true" ] && echo -e "  ${GREEN}‚úì${NC} $2" || echo -e "  ${RED}‚úï${NC} $2"; }

check "$(grep -q 'setupDocumentAssociations' $MODELS_FILE && echo true)" "models: DMS associations"
check "$(grep -q 'setupNcCapaAssociations' $MODELS_FILE && echo true)" "models: NC/CAPA associations"
check "$(grep -q 'documentRouter' $ROUTES_FILE && echo true)" "routes: /documents"
check "$(grep -q 'ncCapaRouter' $ROUTES_FILE && echo true)" "routes: /nc"
check "$(grep -q 'dms.view' $INDEX_FILE && echo true)" "index: DMS abilities"
check "$(grep -q 'capa.verify' $INDEX_FILE && echo true)" "index: CAPA abilities"
check "$([ -f $SERVER/utils/auditVerifier.js ] && echo true)" "utils: auditVerifier.js"
check "$([ -f $SERVER/services/DocumentService.js ] && echo true)" "services: DocumentService.js"
check "$([ -f $SERVER/services/NcCapaService.js ] && echo true)" "services: NcCapaService.js"
check "$([ -f $CLIENT/src/api/qmsApi.ts ] && echo true)" "client: qmsApi.ts"
check "$([ -f $CLIENT/src/pages/QMS/QmsDashboardPage.tsx ] && echo true)" "client: QmsDashboardPage"

echo -e "\n${GREEN}‚úÖ –ì–æ—Ç–æ–≤–æ!${NC} –î–∞–ª—å—à–µ:
  cd $SERVER
  git diff --stat
  npx sequelize-cli db:migrate
  node scripts/backfill-audit-hashes.js
  npm run dev
"

================================================================================
FILE: remove_comments.py
================================================================================

#!/usr/bin/env python3


import os 
import argparse 
from pathlib import Path 
from enum import Enum ,auto 
from typing import Optional 


class State (Enum ):
    CODE =auto ()
    STRING_SINGLE =auto ()
    STRING_DOUBLE =auto ()
    TEMPLATE_STRING =auto ()
    TEMPLATE_EXPR =auto ()
    REGEX =auto ()
    LINE_COMMENT =auto ()
    BLOCK_COMMENT =auto ()


class CommentRemover :




    REGEX_PREV_TOKENS ={
    '(',')','[',']','{','}',',',';',':','=','!','&','|','?',
    '~','^','<','>','+','-','*','%','\n','\r'
    }


    REGEX_KEYWORDS ={
    'return','case','throw','in','instanceof','typeof',
    'void','delete','new','else','do','yield','await'
    }

    def __init__ (self ,content :str ):
        self .content =content 
        self .length =len (content )
        self .pos =0 
        self .result :list [str ]=[]


        self .last_significant_char ='\n'
        self .last_significant_word =''

    def peek (self ,offset :int =0 )->str :
        idx =self .pos +offset 
        return self .content [idx ]if idx <self .length else ''

    def peek_str (self ,length :int )->str :
        return self .content [self .pos :self .pos +length ]

    def advance (self ,count :int =1 )->str :
        s =self .content [self .pos :self .pos +count ]
        self .pos +=count 
        return s 

    def update_last_significant (self ,char :str )->None :

        if char .isalnum ()or char =='_':
            self .last_significant_word +=char 
            return 



        if char .isspace ():
            return 

        self .last_significant_char =char 
        self .last_significant_word =''

    def can_start_regex (self )->bool :
        if self .last_significant_char in self .REGEX_PREV_TOKENS :
            return True 
        if self .last_significant_word in self .REGEX_KEYWORDS :
            return True 
        return False 

    def is_triple_slash_directive (self )->bool :

        if self .peek_str (3 )!='///':
            return False 

        i =self .pos +3 
        rest =[]
        while i <self .length and self .content [i ]!='\n':
            rest .append (self .content [i ])
            i +=1 

        rest_stripped =''.join (rest ).strip ()
        return (
        rest_stripped .startswith ('<')
        and (
        'reference'in rest_stripped 
        or 'amd-module'in rest_stripped 
        or 'amd-dependency'in rest_stripped 
        )
        )

    def is_jsx_comment_start (self )->bool :

        i =self .pos -1 
        while i >=0 and self .content [i ]in ' \t\r\n':
            i -=1 
        return i >=0 and self .content [i ]=='{'

    def remove_trailing_jsx_brace (self )->None :

        while self .result and self .result [-1 ]in ' \t':
            self .result .pop ()
        if self .result and self .result [-1 ]=='{':
            self .result .pop ()
            while self .result and self .result [-1 ]in ' \t':
                self .result .pop ()

    def process_string (self ,quote :str )->None :

        self .result .append (self .advance ())

        while self .pos <self .length :
            ch =self .peek ()
            if ch =='\\'and self .pos +1 <self .length :
                self .result .append (self .advance (2 ))
            elif ch ==quote :
                self .result .append (self .advance ())
                return 
            elif ch =='\n':

                self .result .append (self .advance ())
                return 
            else :
                self .result .append (self .advance ())

    def process_template_string (self )->None :

        self .result .append (self .advance ())

        while self .pos <self .length :
            ch =self .peek ()

            if ch =='\\'and self .pos +1 <self .length :
                self .result .append (self .advance (2 ))
                continue 

            if ch =='`':
                self .result .append (self .advance ())
                return 

            if self .peek_str (2 )=='${':
                self .result .append (self .advance (2 ))

                self .process_template_expression ()
                continue 

            self .result .append (self .advance ())

    def process_template_expression (self )->None :

        brace_depth =1 

        while self .pos <self .length and brace_depth >0 :
            ch =self .peek ()
            two =self .peek_str (2 )

            if ch =='{':
                brace_depth +=1 
                self .result .append (self .advance ())
                self .update_last_significant ('{')
                continue 

            if ch =='}':
                brace_depth -=1 
                self .result .append (self .advance ())
                self .update_last_significant ('}')
                continue 

            if ch =='"':
                self .process_string ('"')

                self .last_significant_char ='"'
                self .last_significant_word =''
                continue 

            if ch =="'":
                self .process_string ("'")
                self .last_significant_char ="'"
                self .last_significant_word =''
                continue 

            if ch =='`':
                self .process_template_string ()
                self .last_significant_char ='`'
                self .last_significant_word =''
                continue 

            if two =='//':
                self .skip_line_comment ()
                self .last_significant_char ='\n'
                self .last_significant_word =''
                continue 

            if two =='/*':
                newlines =self .skip_block_comment (is_jsx =False )
                self .result .append ('\n'*newlines )

                self .last_significant_word =''
                continue 

            if ch =='/':
                if self .can_start_regex ():
                    nxt =self .peek (1 )

                    if nxt not in ('/','*',' ','\t','\n',''):


                        if nxt !='=':
                            self .process_regex ()
                            self .last_significant_char ='/'
                            self .last_significant_word =''
                            continue 

                self .result .append (self .advance ())
                self .update_last_significant ('/')
                continue 

            self .result .append (self .advance ())
            self .update_last_significant (ch )

    def process_regex (self )->None :

        self .result .append (self .advance ())

        in_class =False 

        while self .pos <self .length :
            ch =self .peek ()

            if ch =='\\'and self .pos +1 <self .length :
                self .result .append (self .advance (2 ))
                continue 

            if ch =='['and not in_class :
                in_class =True 
                self .result .append (self .advance ())
                continue 

            if ch ==']'and in_class :
                in_class =False 
                self .result .append (self .advance ())
                continue 

            if ch =='/'and not in_class :
                self .result .append (self .advance ())

                while self .pos <self .length and self .peek ().isalpha ():
                    self .result .append (self .advance ())
                return 

            if ch =='\n':

                return 

            self .result .append (self .advance ())

    def skip_line_comment (self )->None :

        self .advance (2 )
        while self .pos <self .length and self .peek ()!='\n':
            self .advance ()
        if self .pos <self .length :
            self .result .append (self .advance ())

    def skip_block_comment (self ,is_jsx :bool =False )->int :

        self .advance (2 )
        newlines =0 

        while self .pos <self .length :
            if self .peek_str (2 )=='*/':
                self .advance (2 )
                break 
            if self .peek ()=='\n':
                newlines +=1 
            self .advance ()

        if is_jsx :

            while self .pos <self .length and self .peek ()in ' \t':
                self .advance ()

            if self .peek ()=='}':
                self .advance ()

        return newlines 

    def process (self )->str :
        while self .pos <self .length :
            ch =self .peek ()
            two =self .peek_str (2 )


            if ch =='"':
                self .process_string ('"')
                self .last_significant_char ='"'
                self .last_significant_word =''
                continue 

            if ch =="'":
                self .process_string ("'")
                self .last_significant_char ="'"
                self .last_significant_word =''
                continue 


            if ch =='`':
                self .process_template_string ()
                self .last_significant_char ='`'
                self .last_significant_word =''
                continue 


            if self .is_triple_slash_directive ():
                while self .pos <self .length and self .peek ()!='\n':
                    self .result .append (self .advance ())
                if self .pos <self .length :
                    self .result .append (self .advance ())
                self .last_significant_char ='\n'
                self .last_significant_word =''
                continue 


            if two =='//':
                self .skip_line_comment ()
                self .last_significant_char ='\n'
                self .last_significant_word =''
                continue 


            if two =='/*':
                is_jsx =self .is_jsx_comment_start ()
                if is_jsx :
                    self .remove_trailing_jsx_brace ()
                newlines =self .skip_block_comment (is_jsx =is_jsx )
                self .result .append ('\n'*newlines )

                self .last_significant_word =''
                continue 


            if ch =='/':
                if self .can_start_regex ():
                    nxt =self .peek (1 )

                    if nxt not in ('=','/','*',' ','\t','\n',''):

                        if nxt !='=':
                            self .process_regex ()
                            self .last_significant_char ='/'
                            self .last_significant_word =''
                            continue 


                self .result .append (self .advance ())
                self .update_last_significant ('/')
                continue 


            self .result .append (self .advance ())
            self .update_last_significant (ch )

        return ''.join (self .result )


def remove_comments (content :str )->str :
    remover =CommentRemover (content )
    return remover .process ()


def clean_empty_lines (content :str )->str :

    lines =content .split ('\n')
    cleaned =[]
    empty_count =0 

    for line in lines :
        if line .strip ()=='':
            empty_count +=1 
            if empty_count <=2 :
                cleaned .append (line )
        else :
            empty_count =0 
            cleaned .append (line )

    return '\n'.join (cleaned )


def process_file (filepath :Path ,dry_run :bool =False ,verbose :bool =True )->tuple [bool ,int ]:

    try :
        with open (filepath ,'r',encoding ='utf-8')as f :
            original =f .read ()
    except UnicodeDecodeError :
        if verbose :
            print (f"  ‚ö†Ô∏è  –ü—Ä–æ–ø—É—Å–∫ (–Ω–µ UTF-8): {filepath}")
        return False ,0 
    except Exception as e :
        if verbose :
            print (f"  ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {filepath}: {e}")
        return False ,0 

    cleaned =remove_comments (original )
    cleaned =clean_empty_lines (cleaned )


    cleaned ='\n'.join (line .rstrip ()for line in cleaned .split ('\n'))


    cleaned =cleaned .rstrip ()+'\n'if cleaned .strip ()else ''

    diff =len (original )-len (cleaned )

    if diff >0 :
        if not dry_run :
            with open (filepath ,'w',encoding ='utf-8')as f :
                f .write (cleaned )
        return True ,diff 

    return False ,0 


def find_code_files (root_dir :Path ,extensions :set [str ])->list [Path ]:
    files =[]

    skip_dirs ={
    'node_modules','.git','dist','build','.next',
    '__pycache__','.vscode','.idea','coverage'
    }

    for root ,dirs ,filenames in os .walk (root_dir ):
        dirs [:]=[d for d in dirs if d not in skip_dirs ]

        for filename in filenames :
            ext =Path (filename ).suffix .lower ()
            if ext in extensions :
                files .append (Path (root )/filename )

    return files 


def main ()->int :
    parser =argparse .ArgumentParser (
    description ='–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–∑ JS/TS —Ñ–∞–π–ª–æ–≤ (v2 ‚Äî regex/template/triple-slash/JSX)',
    formatter_class =argparse .RawDescriptionHelpFormatter ,
    epilog ="""
–ü—Ä–∏–º–µ—Ä—ã:
  python remove_comments_v2.py ./src                    # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞–ø–∫—É
  python remove_comments_v2.py ./src --dry-run          # –¢–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å
  python remove_comments_v2.py ./src/App.tsx            # –û–¥–∏–Ω —Ñ–∞–π–ª
  python remove_comments_v2.py ./src --ext .ts .tsx     # –¢–æ–ª—å–∫–æ TS
        """
    )

    parser .add_argument ('path',type =str ,help ='–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏')
    parser .add_argument ('--dry-run','-d',action ='store_true',
    help ='–ù–µ –∏–∑–º–µ–Ω—è—Ç—å —Ñ–∞–π–ª—ã, —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å')
    parser .add_argument ('--quiet','-q',action ='store_true',
    help ='–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥')
    parser .add_argument ('--ext',nargs ='+',
    default =['.js','.jsx','.ts','.tsx','.mjs','.cjs'],
    help ='–†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤')

    args =parser .parse_args ()

    target =Path (args .path )
    extensions =set (args .ext )
    verbose =not args .quiet 

    if not target .exists ():
        print (f"‚ùå –ü—É—Ç—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {target}")
        return 1 

    if target .is_file ():
        files =[target ]
    else :
        files =find_code_files (target ,extensions )

    if not files :
        print (f"‚ö†Ô∏è  –§–∞–π–ª—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ {extensions} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        return 0 

    if verbose :
        mode ="üîç DRY-RUN"if args .dry_run else "üîß –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï"
        print (f"\n{mode}")
        print (f"üìÅ –ü—É—Ç—å: {target}")
        print (f"üìÑ –§–∞–π–ª–æ–≤: {len(files)}")
        print ("-"*50 )

    modified_count =0 
    total_saved =0 

    for filepath in sorted (files ):
        changed ,saved =process_file (filepath ,dry_run =args .dry_run ,verbose =verbose )
        if changed :
            modified_count +=1 
            total_saved +=saved 
            if verbose :
                rel =filepath .relative_to (target )if target .is_dir ()else filepath .name 
                print (f"  ‚úÖ {rel} (-{saved} –±–∞–π—Ç)")

    if verbose :
        print ("-"*50 )
        print (f"üìä –ò–∑–º–µ–Ω–µ–Ω–æ: {modified_count} —Ñ–∞–π–ª(–æ–≤)")
        print (f"üíæ –°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ: {total_saved:,} –±–∞–π—Ç")

    return 0 


if __name__ =='__main__':
    raise SystemExit (main ())

