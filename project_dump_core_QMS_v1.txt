PROJECT CORE FILES OVERVIEW
================================================================================
- QMS-Client-main/index.html
- QMS-Client-main/package.json
- QMS-Client-main/postcss.config.js
- QMS-Client-main/src/App.css
- QMS-Client-main/src/App.tsx
- QMS-Client-main/src/api/assemblyApi.ts
- QMS-Client-main/src/api/assemblyRecipesApi.ts
- QMS-Client-main/src/api/auditApi.ts
- QMS-Client-main/src/api/beryll/beryllExtendedApi.ts
- QMS-Client-main/src/api/beryll/componentsAPI.ts
- QMS-Client-main/src/api/beryll/defectExportApi.ts
- QMS-Client-main/src/api/beryll/defectsAndMonitoringAPI.ts
- QMS-Client-main/src/api/beryllApi.ts
- QMS-Client-main/src/api/beryllExtendedApi.ts
- QMS-Client-main/src/api/coralBApi.ts
- QMS-Client-main/src/api/defectApi.ts
- QMS-Client-main/src/api/elrsApi.ts
- QMS-Client-main/src/api/fcApi.ts
- QMS-Client-main/src/api/firmwareApi.ts
- QMS-Client-main/src/api/firmwareControlApi.ts
- QMS-Client-main/src/api/index.ts
- QMS-Client-main/src/api/labelTemplatesApi.ts
- QMS-Client-main/src/api/mqttApi.ts
- QMS-Client-main/src/api/passportsExportApi.ts
- QMS-Client-main/src/api/product_componentApi.ts
- QMS-Client-main/src/api/productionApi.ts
- QMS-Client-main/src/api/projectsApi.ts
- QMS-Client-main/src/api/rankingsApi.ts
- QMS-Client-main/src/api/rbacApi.ts
- QMS-Client-main/src/api/structureApi.ts
- QMS-Client-main/src/api/tasksApi.ts
- QMS-Client-main/src/api/userApi.ts
- QMS-Client-main/src/api/warehouseApi.ts
- QMS-Client-main/src/components/AppRouter.tsx
- QMS-Client-main/src/components/DefectExportButton.tsx
- QMS-Client-main/src/components/Footer/Footer.tsx
- QMS-Client-main/src/components/Header/DateTimeDisplay.tsx
- QMS-Client-main/src/components/Header/Header.tsx
- QMS-Client-main/src/components/Modal/ConfirmModal.tsx
- QMS-Client-main/src/components/Modal/Modal.tsx
- QMS-Client-main/src/components/RepairPartTypeSelect.tsx
- QMS-Client-main/src/components/beryll/BMCSyncPanel.tsx
- QMS-Client-main/src/components/beryll/DefectComments.tsx
- QMS-Client-main/src/components/beryll/MonitoringDashboard.tsx
- QMS-Client-main/src/components/beryll/PassportsExportModal.tsx
- QMS-Client-main/src/components/beryll/ServerComponents.tsx
- QMS-Client-main/src/components/beryll/ServerComponentsManager.tsx
- QMS-Client-main/src/components/common/Preloader.tsx
- QMS-Client-main/src/components/common/PreloaderMini.tsx
- QMS-Client-main/src/components/widgets/ProductionWidget.tsx
- QMS-Client-main/src/hooks/useBetaflyData.ts
- QMS-Client-main/src/index.css
- QMS-Client-main/src/main.tsx
- QMS-Client-main/src/pages/Admin/AdminDefectCategoriesPage.tsx
- QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminDefectCategories.tsx
- QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminDefect_2_4_Categories.tsx
- QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminDefect_915_Categories.tsx
- QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminDefect_Coral_B_categories.tsx
- QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminEditDefectCategory.tsx
- QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminOneDefect.tsx
- QMS-Client-main/src/pages/Admin/AdminPCs/AdminEditPC.tsx
- QMS-Client-main/src/pages/Admin/AdminPCs/AdminOnePC.tsx
- QMS-Client-main/src/pages/Admin/AdminPCs/AdminPCs.tsx
- QMS-Client-main/src/pages/Admin/AdminPanel.tsx
- QMS-Client-main/src/pages/Admin/AdminProd_Components/AdmProdComponents.tsx
- QMS-Client-main/src/pages/Admin/AdminProd_Components/AdmProdEditComponent.tsx
- QMS-Client-main/src/pages/Admin/AdminProd_Components/AdmProdOneComponent.tsx
- QMS-Client-main/src/pages/Admin/AdminProducts/AdmProdStatuses/AdmProdEditStatus.tsx
- QMS-Client-main/src/pages/Admin/AdminProducts/AdmProdStatuses/AdmProdOneStatus.tsx
- QMS-Client-main/src/pages/Admin/AdminProducts/AdmProdStatuses/AdmProdStatuses.tsx
- QMS-Client-main/src/pages/Admin/AdminProducts/AdminEditProduct.tsx
- QMS-Client-main/src/pages/Admin/AdminProducts/AdminOneProduct.tsx
- QMS-Client-main/src/pages/Admin/AdminProducts/AdminProducts.tsx
- QMS-Client-main/src/pages/Admin/AdminUsers/AdminEditUser.tsx
- QMS-Client-main/src/pages/Admin/AdminUsers/AdminOneUser.tsx
- QMS-Client-main/src/pages/Admin/AdminUsers/AdminUsers.tsx
- QMS-Client-main/src/pages/Admin/AssemblyRecipes/RecipeConstructorPage.tsx
- QMS-Client-main/src/pages/Admin/AssemblyRecipes/RecipeExecutionPage.tsx
- QMS-Client-main/src/pages/Admin/Audit/AuditLogPage.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreateCoralB.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreateDefect.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreateELRS.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreateFC.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreatePC.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreateProdComponents.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreateProdStatus.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreateProduct.tsx
- QMS-Client-main/src/pages/Admin/Main/AdminCard.tsx
- QMS-Client-main/src/pages/Admin/Main/BoardsSection.tsx
- QMS-Client-main/src/pages/Admin/Main/DefectCategoriesSection.tsx
- QMS-Client-main/src/pages/Admin/Main/ProductsSection.tsx
- QMS-Client-main/src/pages/Admin/Main/StructureSection.tsx
- QMS-Client-main/src/pages/Admin/Main/UsersSection.tsx
- QMS-Client-main/src/pages/Admin/Main/WarehouseSection.tsx
- QMS-Client-main/src/pages/Admin/RBAC/AdminRightsPage.tsx
- QMS-Client-main/src/pages/Admin/Structure/StructurePage.tsx
- QMS-Client-main/src/pages/Admin/Warehouse/WarehousePage.tsx
- QMS-Client-main/src/pages/Analytics/ProductionDashboard.tsx
- QMS-Client-main/src/pages/Assembly/AssemblyRecipePage.tsx
- QMS-Client-main/src/pages/Assembly/AssemblyRoutesPage.tsx
- QMS-Client-main/src/pages/Assembly/AssemblyWorkPage.tsx
- QMS-Client-main/src/pages/AssemblyRecipes/AssembledProductsPage.tsx
- QMS-Client-main/src/pages/AssemblyRecipes/RecipeConstructorPage.tsx
- QMS-Client-main/src/pages/AssemblyRecipes/RecipeExecutionPage.tsx
- QMS-Client-main/src/pages/AssemblyRecipes/components/ProductPassportModal.tsx
- QMS-Client-main/src/pages/Beryll/BeryllMonitoringPage.tsx
- QMS-Client-main/src/pages/Beryll/BeryllPage.tsx
- QMS-Client-main/src/pages/Beryll/ComponentRevisionsPage.tsx
- QMS-Client-main/src/pages/Beryll/components/ServerChecklistSection.tsx
- QMS-Client-main/src/pages/Beryll/pages/BatchDetailPage.tsx
- QMS-Client-main/src/pages/Beryll/pages/ServerDetailPage.tsx
- QMS-Client-main/src/pages/Beryll/tabs/AnalyticsTab.tsx
- QMS-Client-main/src/pages/Beryll/tabs/ArchiveTab.tsx
- QMS-Client-main/src/pages/Beryll/tabs/BatchesTab.tsx
- QMS-Client-main/src/pages/Beryll/tabs/ClustersTab.tsx
- QMS-Client-main/src/pages/Beryll/tabs/DefectRecordsTab.tsx
- QMS-Client-main/src/pages/Beryll/tabs/HistoryTab.tsx
- QMS-Client-main/src/pages/Beryll/tabs/RacksTab.tsx
- QMS-Client-main/src/pages/Beryll/tabs/ServersTab.tsx
- QMS-Client-main/src/pages/Beryll/tabs/SettingsTab.tsx
- QMS-Client-main/src/pages/BetaFlight/Betaflight.tsx
- QMS-Client-main/src/pages/Defects/DefectDetailPage.tsx
- QMS-Client-main/src/pages/Defects/DefectsPage.tsx
- QMS-Client-main/src/pages/Defects/components/AddRepairActionModal.tsx
- QMS-Client-main/src/pages/Defects/components/CreateDefectModal.tsx
- QMS-Client-main/src/pages/Firmware/Firmware2_4.tsx
- QMS-Client-main/src/pages/Firmware/Firmware915_002.tsx
- QMS-Client-main/src/pages/Firmware/Firmware915_019.tsx
- QMS-Client-main/src/pages/Firmware/FirmwareCoralB/FIrmwareCoralB.tsx
- QMS-Client-main/src/pages/Firmware/FirmwareCoralB/FirmCoralBPortCard.tsx
- QMS-Client-main/src/pages/Firmware/FrimwareFC/FirmwareFC.tsx
- QMS-Client-main/src/pages/Firmware/FrimwareFC/FirmwareFCControl.tsx
- QMS-Client-main/src/pages/Firmware/FrimwareFC/MiniBetafly.tsx
- QMS-Client-main/src/pages/Firmware/FrimwareFC/PortCard.tsx
- QMS-Client-main/src/pages/FirmwareOld/FirmwareOld.tsx
- QMS-Client-main/src/pages/InputDefect/InputDefect.tsx
- QMS-Client-main/src/pages/KnowledgeBase/KnowledgeBase.tsx
- QMS-Client-main/src/pages/Login/Login.tsx
- QMS-Client-main/src/pages/Login/Registration.tsx
- QMS-Client-main/src/pages/MqttCheck/MqttCheckESC.tsx
- QMS-Client-main/src/pages/MqttCheck/MqttCheckFC.tsx
- QMS-Client-main/src/pages/PCs/OnePC.tsx
- QMS-Client-main/src/pages/PCs/SelectPC.tsx
- QMS-Client-main/src/pages/Production/ProductionPage.tsx
- QMS-Client-main/src/pages/Production/tabs/ProductionApproval.tsx
- QMS-Client-main/src/pages/Production/tabs/ProductionEntry.tsx
- QMS-Client-main/src/pages/Production/tabs/ProductionJournal.tsx
- QMS-Client-main/src/pages/Production/tabs/ProductionMatrix.tsx
- QMS-Client-main/src/pages/Production/tabs/ProductionSettings.tsx
- QMS-Client-main/src/pages/Profile/Profile.tsx
- QMS-Client-main/src/pages/Rankings/RankingsChartsPage.tsx
- QMS-Client-main/src/pages/Rankings/RankingsPage.tsx
- QMS-Client-main/src/pages/StartPage/StartPage.tsx
- QMS-Client-main/src/pages/StartPage/StartPage_archive.tsx
- QMS-Client-main/src/pages/Tables/CoralBs/CoralBList.tsx
- QMS-Client-main/src/pages/Tables/CoralBs/CoralBs.tsx
- QMS-Client-main/src/pages/Tables/CoralBs/CpralB_boardItem.tsx
- QMS-Client-main/src/pages/Tables/CoralBs/DateFilterForCoralB.tsx
- QMS-Client-main/src/pages/Tables/CoralBs/FilterCoralB.tsx
- QMS-Client-main/src/pages/Tables/CoralBs/PagesCoralB.tsx
- QMS-Client-main/src/pages/Tables/ELRS24s/ELRS24s.tsx
- QMS-Client-main/src/pages/Tables/ELRS24s/Elrs24BoardItem.tsx
- QMS-Client-main/src/pages/Tables/ELRS24s/Elrs24List.tsx
- QMS-Client-main/src/pages/Tables/ELRS915s/DateFilterForELRS.tsx
- QMS-Client-main/src/pages/Tables/ELRS915s/ELRS915s.tsx
- QMS-Client-main/src/pages/Tables/ELRS915s/Elrs915BoardItem.tsx
- QMS-Client-main/src/pages/Tables/ELRS915s/Elrs915List.tsx
- QMS-Client-main/src/pages/Tables/ELRS915s/FilterElrs.tsx
- QMS-Client-main/src/pages/Tables/ELRS915s/PagesELRS.tsx
- QMS-Client-main/src/pages/Tables/FlightController/DateFilter.tsx
- QMS-Client-main/src/pages/Tables/FlightController/FCItem.tsx
- QMS-Client-main/src/pages/Tables/FlightController/FCList.tsx
- QMS-Client-main/src/pages/Tables/FlightController/FCs.tsx
- QMS-Client-main/src/pages/Tables/FlightController/FilterFC.tsx
- QMS-Client-main/src/pages/Tables/FlightController/Pages.tsx
- QMS-Client-main/src/pages/Tasks/ProjectsList.tsx
- QMS-Client-main/src/pages/Tasks/TasksList.tsx
- QMS-Client-main/src/pages/Tasks/TasksPage.tsx
- QMS-Client-main/src/pages/Users/OneUser.tsx
- QMS-Client-main/src/pages/Users/Users.tsx
- QMS-Client-main/src/pages/Warehouse/AnalyticsPage.tsx
- QMS-Client-main/src/pages/Warehouse/InventoryPage.tsx
- QMS-Client-main/src/pages/Warehouse/WarehousePage.tsx
- QMS-Client-main/src/pages/Warehouse/__tests__/utils.test.ts
- QMS-Client-main/src/pages/Warehouse/components/LabelConstructor.tsx
- QMS-Client-main/src/pages/Warehouse/components/LabelPreview.tsx
- QMS-Client-main/src/pages/Warehouse/components/ProjectDashboard.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/VideoTransmittersLabel.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseBalance.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseDocs.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseIntake.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseLabels.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseMoves.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehousePrintHistory.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseSettings.tsx
- QMS-Client-main/src/pages/Warehouse/utils.ts
- QMS-Client-main/src/pages/beryll/ComponentInventoryPage.tsx
- QMS-Client-main/src/pages/beryll/DefectRecordDetails.tsx
- QMS-Client-main/src/pages/beryll/DefectRecordModal.tsx
- QMS-Client-main/src/pages/beryll/DefectRecordsPage.tsx
- QMS-Client-main/src/pages/beryll/SubstituteServersPage.tsx
- QMS-Client-main/src/pages/beryll/YadroTicketsPage.tsx
- QMS-Client-main/src/routes.ts
- QMS-Client-main/src/setupTests.ts
- QMS-Client-main/src/store/Coral_B_store.ts
- QMS-Client-main/src/store/ELRS_915_and_2_4_store.ts
- QMS-Client-main/src/store/FCStore.ts
- QMS-Client-main/src/store/Firmware915.ts
- QMS-Client-main/src/store/FirmwareCoralB.ts
- QMS-Client-main/src/store/FirmwareFC.ts
- QMS-Client-main/src/store/ProductStore.ts
- QMS-Client-main/src/store/StructureStore.ts
- QMS-Client-main/src/store/UserStore.ts
- QMS-Client-main/src/store/__tests__/UserStore.test.ts
- QMS-Client-main/src/types/AssemblyModels.ts
- QMS-Client-main/src/types/AuditLogModel.ts
- QMS-Client-main/src/types/BoardsForFlashModel.ts
- QMS-Client-main/src/types/ComponentModel.ts
- QMS-Client-main/src/types/DefectModel.ts
- QMS-Client-main/src/types/DefectTypes.ts
- QMS-Client-main/src/types/PCModel.ts
- QMS-Client-main/src/types/ProductModel.ts
- QMS-Client-main/src/types/SessionModel.ts
- QMS-Client-main/src/types/UserModel.ts
- QMS-Client-main/src/types/WarehouseModels.ts
- QMS-Client-main/src/types/beryll/components.ts
- QMS-Client-main/src/types/beryll/defectsAndMonitoring.ts
- QMS-Client-main/src/utils/consts.ts
- QMS-Client-main/src/utils/constsModalType.ts
- QMS-Client-main/src/vite-env.d.ts
- QMS-Client-main/tailwind.config.js
- QMS-Client-main/tsconfig.json
- QMS-Client-main/tsconfig.node.json
- QMS-Client-main/vite.config.ts
- QMS-Client-main/vitest.config.ts
- QMS-Mobile/mes-pwa/deploy.sh
- QMS-Mobile/mes-pwa/index.html
- QMS-Mobile/mes-pwa/package.json
- QMS-Mobile/mes-pwa/postcss.config.js
- QMS-Mobile/mes-pwa/public/silent-check-sso.html
- QMS-Mobile/mes-pwa/src/App.tsx
- QMS-Mobile/mes-pwa/src/api/client.ts
- QMS-Mobile/mes-pwa/src/components/common/Layout.tsx
- QMS-Mobile/mes-pwa/src/components/ui/index.tsx
- QMS-Mobile/mes-pwa/src/config/index.ts
- QMS-Mobile/mes-pwa/src/hooks/index.ts
- QMS-Mobile/mes-pwa/src/index.css
- QMS-Mobile/mes-pwa/src/main.tsx
- QMS-Mobile/mes-pwa/src/pages/Auth/LoginPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Home/HomePage.tsx
- QMS-Mobile/mes-pwa/src/pages/Production/ChecklistPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Production/ProductScanPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Production/ProductionPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Profile/ProfilePage.tsx
- QMS-Mobile/mes-pwa/src/pages/Rankings/RankingsPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Tasks/TasksPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Warehouse/BoxDetailPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Warehouse/WarehousePage.tsx
- QMS-Mobile/mes-pwa/src/types/index.ts
- QMS-Mobile/mes-pwa/src/vite-env.d.ts
- QMS-Mobile/mes-pwa/tailwind.config.js
- QMS-Mobile/mes-pwa/tsconfig.json
- QMS-Mobile/mes-pwa/tsconfig.node.json
- QMS-Mobile/mes-pwa/vite.config.ts
- QMS-Server-master/config/config.js
- QMS-Server-master/controllers/ELRS2_4_Controller.js
- QMS-Server-master/controllers/ELRS915_Controller.js
- QMS-Server-master/controllers/ProjectController.js
- QMS-Server-master/controllers/RankingsController.js
- QMS-Server-master/controllers/TaskController.js
- QMS-Server-master/controllers/assemblyController.js
- QMS-Server-master/controllers/assemblyRecipeController.js
- QMS-Server-master/controllers/auditController.js
- QMS-Server-master/controllers/beryll/ApprovalController.js
- QMS-Server-master/controllers/beryll/CatalogExtendedController.js
- QMS-Server-master/controllers/beryll/ComponentsExtendedController.js
- QMS-Server-master/controllers/beryll/config/beryll.config.js
- QMS-Server-master/controllers/beryll/controllers/ArchiveController.js
- QMS-Server-master/controllers/beryll/controllers/BatchController.js
- QMS-Server-master/controllers/beryll/controllers/ChecklistController.js
- QMS-Server-master/controllers/beryll/controllers/ClusterController.js
- QMS-Server-master/controllers/beryll/controllers/ComponentInventoryController.js
- QMS-Server-master/controllers/beryll/controllers/ComponentsController.js
- QMS-Server-master/controllers/beryll/controllers/DefectExportController.js
- QMS-Server-master/controllers/beryll/controllers/DefectMonitoringController.js
- QMS-Server-master/controllers/beryll/controllers/DefectRecordController.js
- QMS-Server-master/controllers/beryll/controllers/DhcpController.js
- QMS-Server-master/controllers/beryll/controllers/FileController.js
- QMS-Server-master/controllers/beryll/controllers/HistoryController.js
- QMS-Server-master/controllers/beryll/controllers/ImportController.js
- QMS-Server-master/controllers/beryll/controllers/PassportController.js
- QMS-Server-master/controllers/beryll/controllers/PingController.js
- QMS-Server-master/controllers/beryll/controllers/RackController.js
- QMS-Server-master/controllers/beryll/controllers/ServerController.js
- QMS-Server-master/controllers/beryll/controllers/StatsController.js
- QMS-Server-master/controllers/beryll/controllers/YadroController.js
- QMS-Server-master/controllers/beryll/index.js
- QMS-Server-master/controllers/beryll/passportsExportController.js
- QMS-Server-master/controllers/beryll/services/ApprovalService.js
- QMS-Server-master/controllers/beryll/services/ArchiveService.js
- QMS-Server-master/controllers/beryll/services/BatchService.js
- QMS-Server-master/controllers/beryll/services/ChecklistService.js
- QMS-Server-master/controllers/beryll/services/ClusterService.js
- QMS-Server-master/controllers/beryll/services/ComponentInventoryService.js
- QMS-Server-master/controllers/beryll/services/DefectExportService.js
- QMS-Server-master/controllers/beryll/services/DefectMonitoringService.js
- QMS-Server-master/controllers/beryll/services/DefectRecordFileService.js
- QMS-Server-master/controllers/beryll/services/DefectRecordService.js
- QMS-Server-master/controllers/beryll/services/DhcpService.js
- QMS-Server-master/controllers/beryll/services/FileService.js
- QMS-Server-master/controllers/beryll/services/HistoryService.js
- QMS-Server-master/controllers/beryll/services/OpenBMCService.js
- QMS-Server-master/controllers/beryll/services/PassportService.js
- QMS-Server-master/controllers/beryll/services/RackService.js
- QMS-Server-master/controllers/beryll/services/ServerService.js
- QMS-Server-master/controllers/beryll/services/StatsService.js
- QMS-Server-master/controllers/beryll/services/UnifiedPassportsExportService.js
- QMS-Server-master/controllers/beryll/utils/dhcpParser.js
- QMS-Server-master/controllers/beryll/utils/helpers.js
- QMS-Server-master/controllers/coralB_Controller.js
- QMS-Server-master/controllers/defect2_4Controller.js
- QMS-Server-master/controllers/defect915Controller.js
- QMS-Server-master/controllers/defectController.js
- QMS-Server-master/controllers/defectSystemController.js
- QMS-Server-master/controllers/defect_CoralB_Controller.js
- QMS-Server-master/controllers/fcController.js
- QMS-Server-master/controllers/pcController.js
- QMS-Server-master/controllers/productionOutputController.js
- QMS-Server-master/controllers/rbacController.js
- QMS-Server-master/controllers/sessionController.js
- QMS-Server-master/controllers/structureController.js
- QMS-Server-master/controllers/userController.js
- QMS-Server-master/controllers/warehouse/AlertsController.js
- QMS-Server-master/controllers/warehouse/AnalyticsController.js
- QMS-Server-master/controllers/warehouse/BoxController.js
- QMS-Server-master/controllers/warehouse/DocumentController.js
- QMS-Server-master/controllers/warehouse/HistoryController.js
- QMS-Server-master/controllers/warehouse/MovementController.js
- QMS-Server-master/controllers/warehouse/SupplyController.js
- QMS-Server-master/db.js
- QMS-Server-master/error/ApiError.js
- QMS-Server-master/fonts/README.md
- QMS-Server-master/index.js
- QMS-Server-master/jest.config.js
- QMS-Server-master/middleware/ErrorHandlingMiddleware.js
- QMS-Server-master/middleware/authMiddleware.js
- QMS-Server-master/middleware/checkAbilityMiddleware.js
- QMS-Server-master/middleware/checkRoleMiddleware.js
- QMS-Server-master/middleware/syncUserMiddleware.js
- QMS-Server-master/migrations/20250121-beryll-defects-monitoring.js
- QMS-Server-master/migrations/20250121000001-create-beryll-extended.js
- QMS-Server-master/migrations/20250126-add-structure-manager-fields.js
- QMS-Server-master/migrations/20260116-beryll-extension.js
- QMS-Server-master/migrations/20260121-create-defect-system.js
- QMS-Server-master/migrations/20260123-complete-business-logic-fix.js
- QMS-Server-master/migrations/20260126180000-add-serialNumberYadro-to-beryll-components.js
- QMS-Server-master/migrations/run-migration-components.js
- QMS-Server-master/migrations/seeders/20260121-seed-defect-categories.js
- QMS-Server-master/models/BeryllExtended.js
- QMS-Server-master/models/ProductionOutput.js
- QMS-Server-master/models/beryll/BeryllDefectRecordFile.js
- QMS-Server-master/models/definitions/Assembly.js
- QMS-Server-master/models/definitions/Beryll.js
- QMS-Server-master/models/definitions/BeryllExtended.js
- QMS-Server-master/models/definitions/ComponentModels.js
- QMS-Server-master/models/definitions/Defect.js
- QMS-Server-master/models/definitions/General.js
- QMS-Server-master/models/definitions/Production.js
- QMS-Server-master/models/definitions/Project.js
- QMS-Server-master/models/definitions/Structure.js
- QMS-Server-master/models/definitions/Warehouse.js
- QMS-Server-master/models/definitions/YadroIntegration.js
- QMS-Server-master/models/index.js
- QMS-Server-master/package.json
- QMS-Server-master/routes/CoralBRouter.js
- QMS-Server-master/routes/ELRS2_4_Router.js
- QMS-Server-master/routes/ELRS915_Router.js
- QMS-Server-master/routes/assemblyRecipeRouter.js
- QMS-Server-master/routes/assemblyRouter.js
- QMS-Server-master/routes/auditRouter.js
- QMS-Server-master/routes/beryll/beryllExtendedRoutes.js
- QMS-Server-master/routes/beryll/importRoutes.js
- QMS-Server-master/routes/beryllExtendedRouter.js
- QMS-Server-master/routes/beryllRouter.js
- QMS-Server-master/routes/defectRouter.js
- QMS-Server-master/routes/defectRouter2_4.js
- QMS-Server-master/routes/defectRouter915.js
- QMS-Server-master/routes/defectRouterCoralB.js
- QMS-Server-master/routes/defectSystemRouter.js
- QMS-Server-master/routes/fcRouter.js
- QMS-Server-master/routes/index.js
- QMS-Server-master/routes/passportsExportRoutes.js
- QMS-Server-master/routes/pcRouter.js
- QMS-Server-master/routes/productRouter.js
- QMS-Server-master/routes/productionOutputRouter.js
- QMS-Server-master/routes/projectRouter.js
- QMS-Server-master/routes/rbacRouter.js
- QMS-Server-master/routes/sessionRouter.js
- QMS-Server-master/routes/structureRouter.js
- QMS-Server-master/routes/taskRouter.js
- QMS-Server-master/routes/userRouter.js
- QMS-Server-master/routes/warehouseRouter.js
- QMS-Server-master/run-migration.js
- QMS-Server-master/scripts/import_nov_dec_2025.js
- QMS-Server-master/scripts/import_production_outputs.js
- QMS-Server-master/scripts/import_thermal_outputs_2.js
- QMS-Server-master/seeders/20260123-beryll-abilities.js
- QMS-Server-master/seeders/20260123-component-catalog.js
- QMS-Server-master/seeders/20260123-sla-config.js
- QMS-Server-master/seeders/20260201-vegman-component-revisions.js
- QMS-Server-master/seeders/beryllSeeder.js
- QMS-Server-master/services/ExcelImportService.js
- QMS-Server-master/services/PdfService.js
- QMS-Server-master/static/defect-records/2/1769537183976_README.md
- QMS-Server-master/static/defect-records/2/1769579757522_README.md
- QMS-Server-master/static/defect-records/2/1769580241363_README.md
- QMS-Server-master/tests/controllers/box.test.js
- QMS-Server-master/tests/controllers/movement.test.js
- QMS-Server-master/tests/controllers/supply.test.js
- QMS-Server-master/tests/middleware/checkAbility.test.js
- QMS-Server-master/tests/middleware/syncUser.test.js
- QMS-Server-master/utils/auditLogger.js
- dump_project_full.py
- remove_comments.py


================================================================================
FILE: QMS-Client-main/index.html
================================================================================

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MES-Kryptonit</title>
    <link rel="icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/apple-touch-icon-180x180.png" sizes="180x180" />
    <link rel="mask-icon" href="/public/maskable-icon-512x512.png" color="#FFFFFF">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: QMS-Client-main/package.json
================================================================================

{
  "name": "MES-Kryptonit",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview",
    "generate-pwa-assets": "pwa-assets-generator --preset minimal src/assets/images/logo.svg",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "coverage": "vitest run --coverage"
  },
  "dependencies": {
    "@headlessui/react": "^2.0.4",
    "@heroicons/react": "^2.1.3",
    "@sendgrid/mail": "^8.1.3",
    "@skbkontur/react-ui": "^5.0.10",
    "@types/axios": "^0.14.0",
    "@types/node": "^20.12.12",
    "axios": "^1.6.8",
    "clsx": "^2.1.1",
    "dayjs": "^1.11.13",
    "jwt-decode": "^4.0.0",
    "lucide-react": "^0.562.0",
    "mobx": "^6.13.5",
    "mobx-react-lite": "^4.1.0",
    "oidc-client-ts": "^3.4.1",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-hot-toast": "^2.6.0",
    "react-oidc-context": "^3.3.0",
    "react-qr-code": "^2.0.15",
    "react-router-dom": "^6.22.3",
    "react-use": "^17.6.0",
    "recharts": "^3.5.1",
    "socket.io-client": "^4.8.1"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^6.4.5",
    "@testing-library/react": "^14.3.1",
    "@types/react": "^18.3.2",
    "@types/react-dom": "^18.3.0",
    "@types/w3c-web-serial": "^1.0.8",
    "@typescript-eslint/eslint-plugin": "^7.2.0",
    "@typescript-eslint/parser": "^7.2.0",
    "@vite-pwa/assets-generator": "^0.2.4",
    "@vitejs/plugin-react": "^4.2.1",
    "@vitejs/plugin-react-swc": "^4.2.2",
    "@vitest/ui": "^1.6.0",
    "autoprefixer": "^10.4.19",
    "eslint": "^8.57.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.6",
    "jsdom": "^24.1.0",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.3",
    "typescript": "^5.4.5",
    "vite": "^5.2.0",
    "vite-plugin-pwa": "^0.20.0",
    "vitest": "^1.6.0"
  }
}

================================================================================
FILE: QMS-Client-main/postcss.config.js
================================================================================

export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: QMS-Client-main/src/App.css
================================================================================

* {
  margin: 0;
  padding: 0;
}

.App {
  text-align: center;
}

.img {
  background-color: burlywood;
  width: 300px;
  height: 300px;
}
.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}
================================================================================
FILE: QMS-Client-main/src/App.tsx
================================================================================

import "./App.css";
import { Header } from "components/Header/Header";
import background from "assets/images/backGroundTest1.svg";
import { AppRouter } from "components/AppRouter";
import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState, useRef } from "react";
import { Context, getSavedPath, clearSavedPath } from "./main";
import { Preloader } from "./components/common/Preloader";
import { useAuth } from "react-oidc-context";
import { useNavigate, useLocation } from "react-router-dom";
import { SELECT_PC_ROUTE } from "./utils/consts";
import { check } from "./api/userApi";
import { ShieldCheck, Lock, Unlock, Cpu, Activity, X, Sparkles } from "lucide-react";
import { Toaster } from 'react-hot-toast';

const App = observer(() => {
  const auth = useAuth();
  const context = useContext(Context);
  const navigate = useNavigate();
  const location = useLocation();

  const [isUserLoading, setIsUserLoading] = useState(auth.isAuthenticated);

  const [showNotification, setShowNotification] = useState(false);
  const [notificationStep, setNotificationStep] = useState(1);


  const hasRestoredPath = useRef(false);


  const initialPathRef = useRef<string | null>(null);

  useEffect(() => {

    if (initialPathRef.current === null) {
      const currentPath = window.location.pathname + window.location.search;

      const hasOidcParams = window.location.search.includes('code=') ||
                            window.location.search.includes('state=');
      if (currentPath !== "/" && !hasOidcParams) {
        initialPathRef.current = currentPath;
      }
    }
  }, []);

  if (!context) throw new Error("Context required");
  const { user } = context;


  useEffect(() => {
    const timer1 = setTimeout(() => {
        setNotificationStep(1);
        setShowNotification(true);
    }, 1000);

    const timer2 = setTimeout(() => {
        setShowNotification(false);
    }, 5000);

    const timer3 = setTimeout(() => {
        setNotificationStep(2);
        setShowNotification(true);
    }, 5500);

    return () => {
        clearTimeout(timer1);
        clearTimeout(timer2);
        clearTimeout(timer3);
    };
  }, []);


  useEffect(() => {
    if (auth.isAuthenticated && auth.user) {
      localStorage.setItem('token', auth.user.access_token);
      setIsUserLoading(true);

      check()
        .then((userData) => {
            user.setUser(userData);
            user.setIsAuth(true);


            const pcId = localStorage.getItem('pcID');


            if (!hasRestoredPath.current) {
              hasRestoredPath.current = true;


              const savedPath = getSavedPath();
              const targetPath = initialPathRef.current || savedPath;


              if (savedPath) {
                clearSavedPath();
              }


              const currentPath = location.pathname;

              if (targetPath && targetPath !== "/" && targetPath !== currentPath) {

                console.log(`[App] –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å: ${targetPath}`);
                navigate(targetPath, { replace: true });
              } else if (!pcId && currentPath !== SELECT_PC_ROUTE && currentPath === "/") {


                console.log(`[App] –ù–µ—Ç pcID, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≤—ã–±–æ—Ä –ü–ö`);
                navigate(SELECT_PC_ROUTE, { replace: true });
              }

            }
        })
        .catch((err) => {
            console.error("‚ùå Failed to fetch user profile:", err);
        })
        .finally(() => setIsUserLoading(false));

    } else if (!auth.isLoading && !auth.isAuthenticated) {
      user.resetUser();
      localStorage.removeItem('token');
      localStorage.removeItem('userID');
      setIsUserLoading(false);
      hasRestoredPath.current = false;
      initialPathRef.current = null;
    }
  }, [auth.isAuthenticated, auth.user, user, navigate, location.pathname]);


  if (auth.isLoading || isUserLoading) {
    return <Preloader />;
  }


  if (!auth.isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 relative overflow-hidden font-sans">


        <div className="absolute inset-0 z-0">
            <div className="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]"></div>
            <div className="absolute left-0 right-0 top-0 -z-10 m-auto h-[310px] w-[310px] rounded-full bg-blue-400 opacity-20 blur-[100px]"></div>
            <div className="absolute right-0 bottom-0 -z-10 h-[310px] w-[310px] rounded-full bg-emerald-400 opacity-20 blur-[100px]"></div>
        </div>


        <div
            className={`absolute top-8 right-8 z-50 transition-all duration-700 transform ${showNotification ? 'translate-x-0 opacity-100' : 'translate-x-20 opacity-0'}`}
        >
            <div className="bg-white/90 backdrop-blur-md p-4 rounded-2xl shadow-2xl border border-white/60 max-w-xs relative group cursor-default hover:scale-105 transition-transform duration-300">
                <button
                    onClick={() => setShowNotification(false)}
                    className="absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition"
                >
                    <X size={14} />
                </button>

                <div className="flex gap-3">

                    <div className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-md transition-colors duration-500 ${notificationStep === 1 ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : 'bg-gradient-to-br from-blue-500 to-indigo-600'}`}>
                        {notificationStep === 1 ? 'üòá' : 'üëã'}
                    </div>

                    <div>

                        {notificationStep === 1 && (
                            <div className="animate-fadeIn">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="font-bold text-sm text-slate-800">–ú—ã —Å—Ç–∞–ª–∏ –ª—É—á—à–µ!</span>
                                </div>
                                <p className="text-xs text-slate-600 leading-relaxed">
                                    –° –≤–µ—Ä—Å–∏–µ–π <span className="font-bold text-orange-600">2.0</span> —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–ª–æ –µ—â–µ —É–¥–æ–±–Ω–µ–µ –∏ –ø—Ä–∏—è—Ç–Ω–µ–µ.
                                </p>
                            </div>
                        )}


                        {notificationStep === 2 && (
                            <div className="animate-fadeIn">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="font-bold text-sm text-slate-800">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MES</span>
                                    <span className="text-[10px] text-slate-400 bg-slate-100 px-1.5 rounded-full">v2.1</span>
                                </div>
                                <p className="text-xs text-slate-600 leading-relaxed">
                                    <span className="font-semibold text-indigo-600">–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</span> üòä <br/>
                                    –í–∫–ª—é—á–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ (RBAC).
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>


        <div className="relative z-10 bg-white/80 backdrop-blur-xl p-8 md:p-12 rounded-3xl shadow-2xl border border-white/50 max-w-md w-full mx-4 flex flex-col items-center transition-all duration-500 hover:shadow-blue-200/50">

           <div className="relative w-20 h-20 bg-gradient-to-br from-blue-600 to-emerald-500 rounded-2xl flex items-center justify-center shadow-lg mb-6 transform rotate-3 hover:rotate-0 transition-transform duration-300 group">
              <Cpu className="text-white w-10 h-10 group-hover:animate-pulse" strokeWidth={1.5} />
              <div className="absolute inset-0 bg-white opacity-20 rounded-2xl animate-ping"></div>
           </div>

           <h1 className="text-3xl font-bold text-slate-800 mb-2 tracking-tight">MES Kryptonit</h1>
           <p className="text-slate-500 mb-8 text-center text-sm">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º</p>

           <button
             onClick={() => auth.signinRedirect()}
             className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5 group"
           >
             <ShieldCheck className="w-5 h-5 group-hover:animate-bounce" />
             <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Keycloak</span>
           </button>

           <div className="mt-8 flex items-center gap-2 text-xs text-slate-400">
              <Lock size={12} />
              <span>–ó–∞—â–∏—â–µ–Ω–æ SSO –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π</span>
           </div>
        </div>


        <div className="absolute bottom-6 text-center text-xs text-slate-400">
          <p>¬© 2024 MES Kryptonit ‚Ä¢ –í–µ—Ä—Å–∏—è 2.1</p>
        </div>
      </div>
    );
  }


  return (
    <div
      style={{ backgroundImage: `url(${background})` }}
      className="bg-cover bg-no-repeat bg-center min-h-screen flex flex-col"
    >
      <Toaster
        position="top-right"
        toastOptions={{
          duration: 4000,
          style: {
            background: '#1e293b',
            color: '#fff',
            borderRadius: '12px',
          },
        }}
      />
      <Header />
      <main className="flex-1 overflow-auto pb-4 pt-14">
        <AppRouter />
      </main>
    </div>
  );
});

export default App;

================================================================================
FILE: QMS-Client-main/src/api/assemblyApi.ts
================================================================================

import { $authHost } from "./index";
import {
  AssemblyRouteModel,
  SaveAssemblyRouteDto,
} from "src/types/AssemblyModels";

export interface FetchAssemblyRoutesParams {
  search?: string;
  productName?: string;
  isActive?: boolean;
}

export const fetchAssemblyRoutes = async (
  params?: FetchAssemblyRoutesParams
) => {
  const { data } = await $authHost.get("api/assembly/routes", {
    params: {
      ...params,
      isActive:
        typeof params?.isActive === "boolean"
          ? String(params.isActive)
          : undefined,
    },
  });
  return data as AssemblyRouteModel[];
};

export const fetchAssemblyRouteById = async (id: number) => {
  const { data } = await $authHost.get(`api/assembly/routes/${id}`);
  return data as AssemblyRouteModel;
};

export const createAssemblyRoute = async (payload: SaveAssemblyRouteDto) => {
  const { data } = await $authHost.post("api/assembly/routes", payload);
  return data as AssemblyRouteModel;
};

export const updateAssemblyRoute = async (
  id: number,
  payload: SaveAssemblyRouteDto
) => {
  const { data } = await $authHost.put(`api/assembly/routes/${id}`, payload);
  return data as AssemblyRouteModel;
};

export const deleteAssemblyRoute = async (id: number) => {
  const { data } = await $authHost.delete(`api/assembly/routes/${id}`);
  return data as { message: string };
};

================================================================================
FILE: QMS-Client-main/src/api/assemblyRecipesApi.ts
================================================================================

import { $authHost } from "./index";


export interface RecipeStep {
    id?: number;
    order: number;
    title: string;
    description?: string;
    componentId?: number;
    quantity: number;
}

export interface AssemblyRecipe {
    id: number;
    projectId: number;
    title: string;
    steps: RecipeStep[];
}

export interface AssemblyProcess {
    id: number;
    boxId: number;
    recipeId: number;
    completedSteps: number[];
    status: "IN_PROGRESS" | "COMPLETED";
    startTime: string;
    endTime: string;
}


export const fetchRecipeByProject = async (projectId: number) => {
    const { data } = await $authHost.get(`api/assembly/recipes/project/${projectId}`);
    return data as AssemblyRecipe;
};

export const createOrUpdateRecipe = async (projectId: number, title: string, steps: RecipeStep[]) => {
    const { data } = await $authHost.post(`api/assembly/recipes`, { projectId, title, steps });
    return data;
};


export const startAssemblyProcess = async (qrCode: string, projectId: number) => {
    const { data } = await $authHost.post(`api/assembly/recipes/process/start`, { qrCode, projectId });
    return data as { process: AssemblyProcess, recipe: AssemblyRecipe };
};

export const updateProcessStep = async (processId: number, stepIndex: number, isDone: boolean) => {
    const { data } = await $authHost.put(`api/assembly/recipes/process/${processId}/step`, { stepIndex, isDone });
    return data as AssemblyProcess;
};

export const finishAssemblyProcess = async (processId: number) => {
    const { data } = await $authHost.post(`api/assembly/recipes/process/${processId}/finish`);
    return data;
};


export const fetchAssembledHistory = async (params: { projectId?: number, search?: string }) => {
    const { data } = await $authHost.get(`api/assembly/recipes/history/list`, { params });
    return data;
};

export const fetchAssemblyPassport = async (processId: number) => {
    const { data } = await $authHost.get(`api/assembly/recipes/history/${processId}/passport`);
    return data;
};

export const updateAssemblyPassport = async (processId: number, completedSteps: number[]) => {
    const { data } = await $authHost.put(`api/assembly/recipes/history/${processId}`, { completedSteps });
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/auditApi.ts
================================================================================

import { $authHost } from "./index";
import { AuditLogModel } from "src/types/AuditLogModel";

export interface AuditLogFilter {
  page?: number;
  limit?: number;
  userId?: number;
  action?: string;
  entity?: string;
  dateFrom?: string;
  dateTo?: string;
}

export interface AuditLogResponse {
  count: number;
  rows: AuditLogModel[];
}

export const fetchAuditLogs = async (
  params: AuditLogFilter
): Promise<AuditLogResponse> => {
  const { data } = await $authHost.get<AuditLogResponse>("api/audit", {
    params,
  });
  return data;
};

================================================================================
FILE: QMS-Client-main/src/api/beryll/beryllExtendedApi.ts
================================================================================



import { $authHost } from "../index";


export type RackStatus = "ACTIVE" | "MAINTENANCE" | "DECOMMISSIONED";

export interface BeryllRack {
  id: number;
  name: string;
  location: string | null;
  totalUnits: number;
  networkSubnet: string | null;
  gateway: string | null;
  status: RackStatus;
  notes: string | null;
  metadata: Record<string, any>;
  createdAt: string;
  updatedAt: string;

  filledUnits?: number;
  totalUnitsCount?: number;
  occupancyPercent?: number;
  units?: BeryllRackUnit[];
}

export interface BeryllRackUnit {
  id: number;
  rackId: number;
  serverId: number | null;
  unitNumber: number;
  hostname: string | null;
  mgmtMacAddress: string | null;
  mgmtIpAddress: string | null;
  dataMacAddress: string | null;
  dataIpAddress: string | null;
  accessLogin: string | null;
  accessPassword: string | null;
  notes: string | null;
  installedAt: string | null;
  installedById: number | null;
  placedAt: string | null;
  placedById: number | null;

  dhcpIpAddress: string | null;
  dhcpMacAddress: string | null;
  dhcpHostname: string | null;
  dhcpLeaseActive: boolean | null;
  dhcpLastSync: string | null;
  createdAt: string;
  updatedAt: string;

  rack?: BeryllRack;
  server?: {
    id: number;
    ipAddress: string;
    apkSerialNumber: string;
    hostname: string;
    status: string;
    macAddress?: string;
  };
  installedBy?: { id: number; login: string; name: string; surname: string };
  placedBy?: { id: number; login: string; name: string; surname: string };
}


export type ShipmentStatus = "FORMING" | "READY" | "SHIPPED" | "IN_TRANSIT" | "DELIVERED" | "ACCEPTED";

export interface BeryllShipment {
  id: number;
  name: string;
  destinationCity: string | null;
  destinationAddress: string | null;
  contactPerson: string | null;
  contactPhone: string | null;
  expectedCount: number;
  status: ShipmentStatus;
  plannedShipDate: string | null;
  actualShipDate: string | null;
  deliveredAt: string | null;
  acceptedAt: string | null;
  waybillNumber: string | null;
  carrier: string | null;
  notes: string | null;
  createdById: number | null;
  metadata: Record<string, any>;
  createdAt: string;
  updatedAt: string;

  createdBy?: { id: number; login: string; name: string; surname: string };
  clusters?: BeryllCluster[];
  clustersCount?: number;
  totalServers?: number;
  completionPercent?: number;
}


export type ClusterStatus = "FORMING" | "READY" | "SHIPPED" | "DEPLOYED";
export type ServerRole = "MASTER" | "WORKER" | "STORAGE" | "GATEWAY";

export interface BeryllCluster {
  id: number;
  name: string;
  description: string | null;
  shipmentId: number | null;
  expectedCount: number;
  status: ClusterStatus;
  configVersion: string | null;
  notes: string | null;
  createdById: number | null;
  metadata: Record<string, any>;
  createdAt: string;
  updatedAt: string;

  shipment?: BeryllShipment;
  createdBy?: { id: number; login: string; name: string; surname: string };
  clusterServers?: BeryllClusterServer[];
  serversCount?: number;
  masterCount?: number;
  workerCount?: number;
  completionPercent?: number;
}

export interface BeryllClusterServer {
  id: number;
  clusterId: number;
  serverId: number;
  role: ServerRole;
  orderNumber: number | null;
  clusterHostname: string | null;
  clusterIpAddress: string | null;
  notes: string | null;
  addedAt: string;
  addedById: number | null;
  createdAt: string;
  updatedAt: string;

  cluster?: BeryllCluster;
  server?: {
    id: number;
    ipAddress: string;
    apkSerialNumber: string;
    hostname: string;
    status: string;
    macAddress?: string;
  };
  addedBy?: { id: number; login: string; name: string; surname: string };
}


export type DefectRecordStatus =
  | "NEW"
  | "DIAGNOSING"
  | "WAITING_PARTS"
  | "REPAIRING"
  | "SENT_TO_YADRO"
  | "RETURNED"
  | "RESOLVED"
  | "REPEATED"
  | "CLOSED";

export type RepairPartType =
  | "RAM"
  | "MOTHERBOARD"
  | "CPU"
  | "HDD"
  | "SSD"
  | "PSU"
  | "FAN"
  | "RAID"
  | "NIC"
  | "BACKPLANE"
  | "BMC"
  | "CABLE"
  | "OTHER";

export interface BeryllDefectRecord {
  id: number;
  serverId: number;
  yadroTicketNumber: string | null;
  hasSPISI: boolean;
  clusterCode: string | null;
  problemDescription: string;
  detectedAt: string;
  detectedById: number | null;
  diagnosticianId: number | null;
  repairPartType: RepairPartType | null;
  defectPartSerialYadro: string | null;
  defectPartSerialManuf: string | null;
  replacementPartSerialYadro: string | null;
  replacementPartSerialManuf: string | null;
  repairDetails: string | null;
  status: DefectRecordStatus;
  isRepeatedDefect: boolean;
  repeatedDefectReason: string | null;
  repeatedDefectDate: string | null;
  sentToYadroRepair: boolean;
  sentToYadroAt: string | null;
  returnedFromYadro: boolean;
  returnedFromYadroAt: string | null;
  substituteServerSerial: string | null;
  resolvedAt: string | null;
  resolvedById: number | null;
  resolution: string | null;
  notes: string | null;
  metadata: Record<string, any>;
  createdAt: string;
  updatedAt: string;

  server?: {
    id: number;
    apkSerialNumber: string;
    hostname: string;
    ipAddress: string;
    status?: string;
  };
  detectedBy?: { id: number; login: string; name: string; surname: string };
  diagnostician?: { id: number; login: string; name: string; surname: string };
  resolvedBy?: { id: number; login: string; name: string; surname: string };
  files?: BeryllDefectRecordFile[];
}

export interface BeryllDefectRecordFile {
  id: number;
  defectRecordId: number;
  originalName: string;
  fileName: string;
  fileSize: number;
  mimeType: string | null;
  uploadedById: number | null;
  createdAt: string;
  uploadedBy?: { id: number; login: string; name: string; surname: string };
}

export interface DefectRecordStats {
  total: number;
  byStatus: Record<string, number>;
  byPartType: Record<string, number>;
  repeatedCount: number;
  repeatedPercent: number;
  sentToYadroCount: number;
  topDiagnosticians: Array<{
    user: { id: number; login: string; name: string; surname: string };
    count: number;
  }>;
  byMonth: Array<{ month: string; count: number }>;
}


export interface DhcpSearchResult {
  found: boolean;
  ipAddress?: string;
  macAddress?: string;
  hostname?: string;
  leaseActive?: boolean;
  leaseStart?: string;
  leaseEnd?: string;
  error?: string;
}


interface HistoryRecord {
  id: number;
  entityType: string;
  entityId: number;
  action: string;
  userId: number | null;
  comment: string | null;
  changes: Record<string, any> | null;
  metadata: Record<string, any> | null;
  createdAt: string;
  user?: { id: number; login: string; name: string; surname: string };
}

interface PaginatedResponse<T> {
  count: number;
  rows: T[];
  page: number;
  totalPages: number;
}


export const getRacks = async (params?: {
  status?: RackStatus;
  search?: string;
  includeUnits?: boolean;
}): Promise<BeryllRack[]> => {
  const { data } = await $authHost.get("/api/beryll/racks", { params });
  return data;
};

export const getRackById = async (id: number): Promise<BeryllRack> => {
  const { data } = await $authHost.get(`/api/beryll/racks/${id}`);
  return data;
};

export const createRack = async (rack: {
  name: string;
  location?: string;
  totalUnits?: number;
  networkSubnet?: string;
  gateway?: string;
  notes?: string;
}): Promise<BeryllRack> => {
  const { data } = await $authHost.post("/api/beryll/racks", rack);
  return data;
};

export const updateRack = async (
  id: number,
  rack: Partial<BeryllRack>
): Promise<BeryllRack> => {
  const { data } = await $authHost.put(`/api/beryll/racks/${id}`, rack);
  return data;
};

export const deleteRack = async (id: number): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.delete(`/api/beryll/racks/${id}`);
  return data;
};

export const getRackHistory = async (
  id: number,
  params?: { limit?: number; offset?: number }
): Promise<PaginatedResponse<HistoryRecord>> => {
  const { data } = await $authHost.get(`/api/beryll/racks/${id}/history`, { params });
  return data;
};

export const getRackSummary = async (rackId: number): Promise<any> => {
  const { data } = await $authHost.get(`/api/beryll/racks/${rackId}/summary`);
  return data;
};

export const syncRackWithDhcp = async (rackId: number): Promise<{
  success: boolean;
  message: string;
  synced: number;
  total: number;
}> => {
  const { data } = await $authHost.post(`/api/beryll/racks/${rackId}/sync-dhcp`);
  return data;
};

export const getFreeUnits = async (rackId: number): Promise<BeryllRackUnit[]> => {
  const { data } = await $authHost.get(`/api/beryll/racks/${rackId}/free-units`);
  return data;
};

export const getUnitsByServerStatus = async (rackId: number, status: string): Promise<BeryllRackUnit[]> => {
  const { data } = await $authHost.get(`/api/beryll/racks/${rackId}/units-by-status`, { params: { status } });
  return data;
};

export const installServerInRack = async (
  rackId: number,
  unitNumber: number,
  params: {
    serverId: number;
    hostname?: string;
    mgmtMacAddress?: string;
    mgmtIpAddress?: string;
    dataMacAddress?: string;
    dataIpAddress?: string;
    accessLogin?: string;
    accessPassword?: string;
    notes?: string;
  }
): Promise<BeryllRackUnit> => {
  const { data } = await $authHost.post(
    `/api/beryll/racks/${rackId}/units/${unitNumber}/install`,
    params
  );
  return data;
};

export const placeServerInRack = async (
  rackId: number,
  unitNumber: number,
  serverId: number
): Promise<BeryllRackUnit> => {
  const { data } = await $authHost.post(
    `/api/beryll/racks/${rackId}/units/${unitNumber}/place`,
    { serverId }
  );
  return data;
};

export const removeServerFromRack = async (
  rackId: number,
  unitNumber: number
): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.post(`/api/beryll/racks/${rackId}/units/${unitNumber}/remove`);
  return data;
};

export const updateRackUnit = async (
  unitId: number,
  params: Partial<BeryllRackUnit>
): Promise<BeryllRackUnit> => {
  const { data } = await $authHost.put(`/api/beryll/rack-units/${unitId}`, params);
  return data;
};

export const moveServerInRack = async (params: {
  fromRackId: number;
  fromUnit: number;
  toRackId: number;
  toUnit: number;
}): Promise<BeryllRackUnit> => {
  const { data } = await $authHost.post("/api/beryll/rack-units/move", params);
  return data;
};

export const findServerRackLocation = async (
  serverId: number
): Promise<BeryllRackUnit | { found: false }> => {
  const { data } = await $authHost.get(`/api/beryll/servers/${serverId}/rack-location`);
  return data;
};


export const createServer = async (serverData: {
  apkSerialNumber?: string;
  serialNumber?: string;
  macAddress?: string;
  hostname?: string;
  batchId?: number;
  notes?: string;
  searchDhcp?: boolean;
}): Promise<any> => {
  const { data } = await $authHost.post("/api/beryll/servers/create", serverData);
  return data;
};


export const createAndPlaceServer = async (serverData: {
  apkSerialNumber?: string;
  serialNumber?: string;
  macAddress?: string;
  hostname?: string;
  batchId?: number;
  notes?: string;
  searchDhcp?: boolean;
  rackId?: number;
  unitNumber?: number;
  unitData?: {
    hostname?: string;
    mgmtMacAddress?: string;
    mgmtIpAddress?: string;
    dataMacAddress?: string;
    dataIpAddress?: string;
    accessLogin?: string;
    accessPassword?: string;
    notes?: string;
  };
}): Promise<any> => {
  const { data } = await $authHost.post("/api/beryll/servers/create-and-place", serverData);
  return data;
};


export const findIpByMac = async (mac: string): Promise<DhcpSearchResult> => {
  const { data } = await $authHost.get(`/api/beryll/dhcp/find-ip/${encodeURIComponent(mac)}`);
  return data;
};


export const findServerInDhcp = async (serial: string): Promise<DhcpSearchResult> => {
  const { data } = await $authHost.get(`/api/beryll/dhcp/find-server/${encodeURIComponent(serial)}`);
  return data;
};


export const getShipments = async (params?: {
  status?: ShipmentStatus;
  search?: string;
  city?: string;
}): Promise<BeryllShipment[]> => {
  const { data } = await $authHost.get("/api/beryll/shipments", { params });
  return data;
};

export const getShipmentById = async (id: number): Promise<BeryllShipment> => {
  const { data } = await $authHost.get(`/api/beryll/shipments/${id}`);
  return data;
};

export const createShipment = async (shipment: {
  name: string;
  destinationCity?: string;
  destinationAddress?: string;
  contactPerson?: string;
  contactPhone?: string;
  expectedCount?: number;
  plannedShipDate?: string;
  waybillNumber?: string;
  carrier?: string;
  notes?: string;
}): Promise<BeryllShipment> => {
  const { data } = await $authHost.post("/api/beryll/shipments", shipment);
  return data;
};

export const updateShipment = async (
  id: number,
  shipment: Partial<BeryllShipment>
): Promise<BeryllShipment> => {
  const { data } = await $authHost.put(`/api/beryll/shipments/${id}`, shipment);
  return data;
};

export const deleteShipment = async (id: number): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.delete(`/api/beryll/shipments/${id}`);
  return data;
};

export const getShipmentHistory = async (
  id: number,
  params?: { limit?: number; offset?: number }
): Promise<PaginatedResponse<HistoryRecord>> => {
  const { data } = await $authHost.get(`/api/beryll/shipments/${id}/history`, { params });
  return data;
};


export const getClusters = async (params?: {
  status?: ClusterStatus;
  shipmentId?: number | "null";
  search?: string;
}): Promise<BeryllCluster[]> => {
  const { data } = await $authHost.get("/api/beryll/clusters", { params });
  return data;
};

export const getClusterById = async (id: number): Promise<BeryllCluster> => {
  const { data } = await $authHost.get(`/api/beryll/clusters/${id}`);
  return data;
};

export const createCluster = async (cluster: {
  name: string;
  description?: string;
  shipmentId?: number;
  expectedCount?: number;
  configVersion?: string;
  notes?: string;
}): Promise<BeryllCluster> => {
  const { data } = await $authHost.post("/api/beryll/clusters", cluster);
  return data;
};

export const updateCluster = async (
  id: number,
  cluster: Partial<BeryllCluster>
): Promise<BeryllCluster> => {
  const { data } = await $authHost.put(`/api/beryll/clusters/${id}`, cluster);
  return data;
};

export const deleteCluster = async (id: number): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.delete(`/api/beryll/clusters/${id}`);
  return data;
};

export const getClusterHistory = async (
  id: number,
  params?: { limit?: number; offset?: number }
): Promise<PaginatedResponse<HistoryRecord>> => {
  const { data } = await $authHost.get(`/api/beryll/clusters/${id}/history`, { params });
  return data;
};

export const addServerToCluster = async (
  clusterId: number,
  params: {
    serverId: number;
    role?: ServerRole;
    orderNumber?: number;
    clusterHostname?: string;
    clusterIpAddress?: string;
    notes?: string;
  }
): Promise<BeryllClusterServer> => {
  const { data } = await $authHost.post(`/api/beryll/clusters/${clusterId}/servers`, params);
  return data;
};

export const addServersToCluster = async (
  clusterId: number,
  params: {
    serverIds: number[];
    role?: ServerRole;
  }
): Promise<{ added: number; results: Array<{ serverId: number; success: boolean; id?: number; error?: string }> }> => {
  const { data } = await $authHost.post(`/api/beryll/clusters/${clusterId}/servers/bulk`, params);
  return data;
};

export const removeServerFromCluster = async (
  clusterId: number,
  serverId: number
): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.delete(`/api/beryll/clusters/${clusterId}/servers/${serverId}`);
  return data;
};

export const updateClusterServer = async (
  id: number,
  params: Partial<BeryllClusterServer>
): Promise<BeryllClusterServer> => {
  const { data } = await $authHost.put(`/api/beryll/cluster-servers/${id}`, params);
  return data;
};

export const getUnassignedServers = async (params?: {
  status?: string;
  batchId?: number;
  search?: string;
  limit?: number;
}): Promise<Array<{ id: number; apkSerialNumber: string; hostname: string; ipAddress: string; status: string }>> => {
  const { data } = await $authHost.get("/api/beryll/servers/unassigned", { params });
  return data;
};

export const getServerClusters = async (serverId: number): Promise<BeryllClusterServer[]> => {
  const { data } = await $authHost.get(`/api/beryll/servers/${serverId}/clusters`);
  return data;
};


export const getDefectRecords = async (params?: {
  serverId?: number;
  status?: DefectRecordStatus;
  repairPartType?: RepairPartType;
  diagnosticianId?: number;
  isRepeatedDefect?: boolean;
  dateFrom?: string;
  dateTo?: string;
  search?: string;
  limit?: number;
  offset?: number;
}): Promise<PaginatedResponse<BeryllDefectRecord>> => {
  const { data } = await $authHost.get("/api/beryll/defect-records", { params });
  return data;
};

export const getDefectRecordById = async (id: number): Promise<BeryllDefectRecord> => {
  const { data } = await $authHost.get(`/api/beryll/defect-records/${id}`);
  return data;
};

export const getServerDefectRecords = async (
  serverId: number,
  params?: { status?: DefectRecordStatus; limit?: number; offset?: number }
): Promise<PaginatedResponse<BeryllDefectRecord>> => {
  const { data } = await $authHost.get(`/api/beryll/servers/${serverId}/defect-records`, { params });
  return data;
};

export const createDefectRecord = async (record: {
  serverId: number;
  problemDescription: string;
  yadroTicketNumber?: string;
  hasSPISI?: boolean;
  clusterCode?: string;
  detectedAt?: string;
  diagnosticianId?: number;
  repairPartType?: RepairPartType;
  defectPartSerialYadro?: string;
  defectPartSerialManuf?: string;
  replacementPartSerialYadro?: string;
  replacementPartSerialManuf?: string;
  repairDetails?: string;
  notes?: string;
}): Promise<BeryllDefectRecord> => {
  const { data } = await $authHost.post("/api/beryll/defect-records", record);
  return data;
};

export const updateDefectRecord = async (
  id: number,
  record: Partial<BeryllDefectRecord>
): Promise<BeryllDefectRecord> => {
  const { data } = await $authHost.put(`/api/beryll/defect-records/${id}`, record);
  return data;
};

export const deleteDefectRecord = async (id: number): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.delete(`/api/beryll/defect-records/${id}`);
  return data;
};

export const changeDefectRecordStatus = async (
  id: number,
  status: DefectRecordStatus,
  comment?: string
): Promise<BeryllDefectRecord> => {
  const { data } = await $authHost.put(`/api/beryll/defect-records/${id}/status`, { status, comment });
  return data;
};

export const sendDefectToYadro = async (
  id: number,
  params?: { substituteServerSerial?: string; notes?: string }
): Promise<BeryllDefectRecord> => {
  const { data } = await $authHost.post(`/api/beryll/defect-records/${id}/send-to-yadro`, params);
  return data;
};

export const returnDefectFromYadro = async (
  id: number,
  params?: { notes?: string }
): Promise<BeryllDefectRecord> => {
  const { data } = await $authHost.post(`/api/beryll/defect-records/${id}/return-from-yadro`, params);
  return data;
};

export const resolveDefectRecord = async (
  id: number,
  resolution?: string
): Promise<BeryllDefectRecord> => {
  const { data } = await $authHost.post(`/api/beryll/defect-records/${id}/resolve`, { resolution });
  return data;
};

export const markDefectAsRepeated = async (
  id: number,
  reason?: string
): Promise<BeryllDefectRecord> => {
  const { data } = await $authHost.post(`/api/beryll/defect-records/${id}/mark-repeated`, { reason });
  return data;
};

export const getDefectRecordHistory = async (
  id: number,
  params?: { limit?: number; offset?: number }
): Promise<PaginatedResponse<HistoryRecord>> => {
  const { data } = await $authHost.get(`/api/beryll/defect-records/${id}/history`, { params });
  return data;
};

export const getDefectRecordStats = async (params?: {
  dateFrom?: string;
  dateTo?: string;
  serverId?: number;
}): Promise<DefectRecordStats> => {
  const { data } = await $authHost.get("/api/beryll/defect-records-stats", { params });
  return data;
};


export const getRepairPartTypes = async (): Promise<Array<{ value: RepairPartType; label: string }>> => {
  const { data } = await $authHost.get("/api/beryll/defect-records/part-types");
  return data;
};

export const getDefectStatuses = async (): Promise<Array<{ value: DefectRecordStatus; label: string }>> => {
  const { data } = await $authHost.get("/api/beryll/defect-records/statuses");
  return data;
};


export const uploadDefectRecordFile = async (
  defectRecordId: number,
  file: File
): Promise<{ success: boolean; file: BeryllDefectRecordFile }> => {
  const formData = new FormData();
  formData.append("file", file);
  const { data } = await $authHost.post(
    `/api/beryll/defect-records/${defectRecordId}/files`,
    formData,
    { headers: { "Content-Type": "multipart/form-data" } }
  );
  return data;
};

export const downloadDefectRecordFile = async (fileId: number): Promise<Blob> => {
  const { data } = await $authHost.get(`/api/beryll/defect-record-files/${fileId}`, {
    responseType: "blob"
  });
  return data;
};

export const deleteDefectRecordFile = async (fileId: number): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.delete(`/api/beryll/defect-record-files/${fileId}`);
  return data;
};

================================================================================
FILE: QMS-Client-main/src/api/beryll/componentsAPI.ts
================================================================================



import { $authHost } from "../index";
import type {
  ComponentsResponse,
  BMCCheckResponse,
  FetchComponentsResponse,
  ServerComponent
} from "../../types/beryll/components";

const BASE_URL = "/api/beryll";


export async function checkBMC(serverId: number): Promise<BMCCheckResponse> {
  const { data } = await $authHost.get(`${BASE_URL}/servers/${serverId}/bmc/check`);
  return data;
}


export async function fetchComponents(serverId: number): Promise<FetchComponentsResponse> {
  const { data } = await $authHost.post(`${BASE_URL}/servers/${serverId}/components/fetch`);
  return data;
}


export async function getServerComponents(serverId: number): Promise<ComponentsResponse> {
  const { data } = await $authHost.get(`${BASE_URL}/servers/${serverId}/components`);
  return data;
}


export async function getComponentById(componentId: number): Promise<ServerComponent> {
  const { data } = await $authHost.get(`${BASE_URL}/components/${componentId}`);
  return data;
}


export async function deleteServerComponents(serverId: number): Promise<{ success: boolean; message: string }> {
  const { data } = await $authHost.delete(`${BASE_URL}/servers/${serverId}/components`);
  return data;
}


export async function updateBMCAddress(
  serverId: number,
  bmcAddress: string
): Promise<{ success: boolean; bmcAddress: string }> {
  const { data } = await $authHost.put(`${BASE_URL}/servers/${serverId}/bmc-address`, { bmcAddress });
  return data;
}


export type SyncMode = 'compare' | 'force' | 'merge';

export interface BMCCompareResponse {
  success: boolean;
  mode: 'compare';
  hasDiscrepancies: boolean;
  summary: {
    total: { inDb: number; inBmc: number };
    matched: number;
    missingInBmc: number;
    newInBmc: number;
    mismatches: number;
  };
  details: {
    matched: Array<{ dbComponent: ServerComponent; bmcComponent: any }>;
    missingInBmc: Array<{ dbComponent: ServerComponent; isManual: boolean; reason: string }>;
    newInBmc: Array<{ bmcComponent: any; reason: string }>;
    mismatches: Array<{
      dbComponent: ServerComponent;
      bmcComponent: any;
      differences: Array<{ field: string; db: string | null; bmc: string | null }>;
    }>;
  };
  message?: string;
}

export interface BMCForceResponse {
  success: boolean;
  mode: 'force';
  message: string;
  manualPreserved: number;
  components: ServerComponent[];
}

export interface BMCMergeResponse {
  success: boolean;
  mode: 'merge';
  message: string;
  actions: {
    updated: Array<{ id: number; serialNumber: string | null; changes: any[] }>;
    added: ServerComponent[];
    preserved: ServerComponent[];
    flaggedForReview: Array<{ id: number; serialNumber: string | null; reason: string }>;
  };
}

export type BMCSyncResponse = BMCCompareResponse | BMCForceResponse | BMCMergeResponse;


export async function compareWithBMC(serverId: number): Promise<BMCCompareResponse> {
  const { data } = await $authHost.get(`${BASE_URL}/servers/${serverId}/components/compare`);
  return data;
}


export async function syncComponentsWithBMC(
  serverId: number,
  mode: SyncMode = 'compare',
  preserveManual: boolean = true
): Promise<BMCSyncResponse> {
  const { data } = await $authHost.post<BMCSyncResponse>(
    `${BASE_URL}/servers/${serverId}/components/fetch`,
    { mode, preserveManual }
  );
  return data;
}


export async function resolveDiscrepancy(
  serverId: number,
  componentId: number,
  resolution: 'keep' | 'delete'
): Promise<{ success: boolean; action: 'kept' | 'deleted'; component?: ServerComponent }> {
  const { data } = await $authHost.put(
    `${BASE_URL}/servers/${serverId}/components/${componentId}/resolve-discrepancy`,
    { resolution }
  );
  return data;
}


export function isCompareResponse(response: BMCSyncResponse): response is BMCCompareResponse {
  return response.mode === 'compare';
}

export function isMergeResponse(response: BMCSyncResponse): response is BMCMergeResponse {
  return response.mode === 'merge';
}

export function isForceResponse(response: BMCSyncResponse): response is BMCForceResponse {
  return response.mode === 'force';
}


export interface AddComponentData {
  componentType: string;
  name?: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  serialNumberYadro?: string;
  partNumber?: string;
  slot?: string;
  status?: string;
  capacity?: number;
  speed?: string;
  firmwareVersion?: string;
  metadata?: Record<string, any>;
}


export async function addServerComponent(
  serverId: number,
  componentData: AddComponentData
): Promise<{ success: boolean; component: ServerComponent; message: string }> {
  const { data } = await $authHost.post(
    `${BASE_URL}/servers/${serverId}/components`,
    componentData
  );
  return data;
}


export async function addServerComponentsBatch(
  serverId: number,
  components: AddComponentData[]
): Promise<{ success: boolean; components: ServerComponent[]; count: number }> {
  const { data } = await $authHost.post(
    `${BASE_URL}/servers/${serverId}/components/batch`,
    { components }
  );
  return data;
}


export interface UpdateComponentData {
  name?: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  serialNumberYadro?: string;
  partNumber?: string;
  slot?: string;
  status?: string;
  firmwareVersion?: string;
  capacity?: number;
  speed?: string;
  metadata?: Record<string, any>;
}


export async function updateServerComponent(
  componentId: number,
  updates: UpdateComponentData
): Promise<{ success: boolean; component: ServerComponent; message: string }> {
  const { data } = await $authHost.put(
    `${BASE_URL}/components/${componentId}`,
    updates
  );
  return data;
}


export async function updateComponentSerials(
  componentId: number,
  serials: { serialNumber?: string; serialNumberYadro?: string }
): Promise<{ success: boolean; component: ServerComponent }> {
  const { data } = await $authHost.patch(
    `${BASE_URL}/components/${componentId}/serials`,
    serials
  );
  return data;
}


export interface ReplaceComponentData {
  newSerialNumber?: string;
  newSerialNumberYadro?: string;
  newManufacturer?: string;
  newModel?: string;
  newPartNumber?: string;
  reason?: string;
  defectRecordId?: number;
  inventoryComponentId?: number;
}


export async function replaceServerComponent(
  componentId: number,
  replacementData: ReplaceComponentData
): Promise<{
  success: boolean;
  oldComponent: ServerComponent;
  newComponent: ServerComponent;
  historyId: number;
  message: string
}> {
  const { data } = await $authHost.post(
    `${BASE_URL}/components/${componentId}/replace`,
    replacementData
  );
  return data;
}


export async function deleteComponent(
  componentId: number,
  reason?: string
): Promise<{ success: boolean; message: string }> {
  const { data } = await $authHost.delete(
    `${BASE_URL}/components/${componentId}`,
    { data: { reason } }
  );
  return data;
}


export interface ComponentSearchParams {
  serialNumber?: string;
  serialNumberYadro?: string;
  componentType?: string;
  serverId?: number;
}


export async function findComponentBySerial(
  params: ComponentSearchParams
): Promise<{ found: boolean; component?: ServerComponent; server?: any }> {
  const { data } = await $authHost.get(`${BASE_URL}/components/search`, { params });
  return data;
}


export async function scanYadroSerial(
  serialNumberYadro: string
): Promise<{
  found: boolean;
  component?: ServerComponent;
  server?: { id: number; apkSerialNumber: string; hostname?: string };
  suggestions?: ServerComponent[];
}> {
  const { data } = await $authHost.get(
    `${BASE_URL}/components/scan`,
    { params: { serialNumberYadro } }
  );
  return data;
}


export interface ComponentHistoryEntry {
  id: number;
  action: 'ADDED' | 'UPDATED' | 'REPLACED' | 'REMOVED' | 'SERIAL_CHANGED';
  componentId: number;
  serverId: number;
  userId: number;
  userName?: string;
  oldValue?: Record<string, any>;
  newValue?: Record<string, any>;
  reason?: string;
  performedAt: string;
}


export async function getComponentHistory(
  componentId: number
): Promise<{ history: ComponentHistoryEntry[] }> {
  const { data } = await $authHost.get(`${BASE_URL}/components/${componentId}/history`);
  return data;
}


export async function getServerComponentsHistory(
  serverId: number,
  params?: { from?: string; to?: string; limit?: number }
): Promise<{ history: ComponentHistoryEntry[] }> {
  const { data } = await $authHost.get(
    `${BASE_URL}/servers/${serverId}/components/history`,
    { params }
  );
  return data;
}


export async function checkSerialUniqueness(
  serialNumber: string,
  serialNumberYadro?: string,
  excludeComponentId?: number
): Promise<{
  unique: boolean;
  conflictsWith?: { componentId: number; serverId: number; serverSerial: string }
}> {
  const { data } = await $authHost.post(`${BASE_URL}/components/check-serial`, {
    serialNumber,
    serialNumberYadro,
    excludeComponentId
  });
  return data;
}


export async function validateComponent(
  serverId: number,
  componentData: AddComponentData
): Promise<{
  valid: boolean;
  errors?: string[];
  warnings?: string[]
}> {
  const { data } = await $authHost.post(
    `${BASE_URL}/servers/${serverId}/components/validate`,
    componentData
  );
  return data;
}


export async function importComponentsFromExcel(
  serverId: number,
  file: File,
  options?: { skipExisting?: boolean; dryRun?: boolean }
): Promise<{
  success: boolean;
  imported: number;
  skipped: number;
  errors: { row: number; error: string }[];
  dryRun: boolean;
}> {
  const formData = new FormData();
  formData.append('file', file);
  if (options?.skipExisting) formData.append('skipExisting', 'true');
  if (options?.dryRun) formData.append('dryRun', 'true');

  const { data } = await $authHost.post(
    `${BASE_URL}/servers/${serverId}/components/import`,
    formData,
    { headers: { 'Content-Type': 'multipart/form-data' } }
  );
  return data;
}


export async function exportComponentsToExcel(
  serverId: number
): Promise<Blob> {
  const { data } = await $authHost.get(
    `${BASE_URL}/servers/${serverId}/components/export`,
    { responseType: 'blob' }
  );
  return data;
}

================================================================================
FILE: QMS-Client-main/src/api/beryll/defectExportApi.ts
================================================================================



import { apiClient } from "../apiClient";

export interface DefectExportParams {
    status?: string;
    dateFrom?: string;
    dateTo?: string;
    serverId?: number;
    search?: string;
}


export const exportDefectsToExcel = async (params: DefectExportParams = {}): Promise<Blob> => {
    const response = await apiClient.get("/beryll/extended/defects/export", {
        params,
        responseType: "blob"
    });
    return response.data;
};


export const exportDefectStatsToExcel = async (): Promise<Blob> => {
    const response = await apiClient.get("/beryll/extended/defects/export/stats", {
        responseType: "blob"
    });
    return response.data;
};


export const downloadBlob = (blob: Blob, filename: string): void => {
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    link.remove();
    window.URL.revokeObjectURL(url);
};


export const downloadDefectsExcel = async (params: DefectExportParams = {}): Promise<void> => {
    const blob = await exportDefectsToExcel(params);
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
    downloadBlob(blob, `–ë—Ä–∞–∫_—Å–µ—Ä–≤–µ—Ä–æ–≤_${date}.xlsx`);
};


export const downloadDefectStatsExcel = async (): Promise<void> => {
    const blob = await exportDefectStatsToExcel();
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
    downloadBlob(blob, `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_–±—Ä–∞–∫–∞_${date}.xlsx`);
};

================================================================================
FILE: QMS-Client-main/src/api/beryll/defectsAndMonitoringAPI.ts
================================================================================



import { $authHost } from "../index";
import type {
  DefectComment,
  DefectStats,
  DefectCategory,
  DefectPriority,
  DefectStatus,
  MonitoringStats,
  PingAllResult,
  ServerPingResult
} from "../../types/beryll/defectsAndMonitoring";


interface GetDefectsParams {
  status?: DefectStatus;
  category?: DefectCategory;
  limit?: number;
  offset?: number;
}

interface GetDefectsResponse {
  count: number;
  rows: DefectComment[];
  page: number;
  totalPages: number;
}

export const getServerDefects = async (
  serverId: number,
  params?: GetDefectsParams
): Promise<GetDefectsResponse> => {
  const { data } = await $authHost.get(`/api/beryll/servers/${serverId}/defects`, { params });
  return data;
};

export const getDefectById = async (defectId: number): Promise<DefectComment> => {
  const { data } = await $authHost.get(`/api/beryll/defects/${defectId}`);
  return data;
};

interface CreateDefectParams {
  text: string;
  defectCategory?: DefectCategory;
  priority?: DefectPriority;
}

export const createDefect = async (
  serverId: number,
  params: CreateDefectParams
): Promise<DefectComment> => {
  const { data } = await $authHost.post(`/api/beryll/servers/${serverId}/defects`, params);
  return data;
};

interface UpdateDefectParams {
  text?: string;
  defectCategory?: DefectCategory;
  priority?: DefectPriority;
  status?: DefectStatus;
  resolution?: string;
}

export const updateDefect = async (
  defectId: number,
  params: UpdateDefectParams
): Promise<DefectComment> => {
  const { data } = await $authHost.put(`/api/beryll/defects/${defectId}`, params);
  return data;
};

export const deleteDefect = async (defectId: number): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.delete(`/api/beryll/defects/${defectId}`);
  return data;
};

interface ResolveDefectParams {
  resolution?: string;
  status?: 'RESOLVED' | 'WONT_FIX';
}

export const resolveDefect = async (
  defectId: number,
  params?: ResolveDefectParams
): Promise<DefectComment> => {
  const { data } = await $authHost.put(`/api/beryll/defects/${defectId}/resolve`, params || {});
  return data;
};

export const uploadDefectFile = async (
  defectId: number,
  file: File
): Promise<{ success: boolean; file: { id: number; fileName: string; originalName: string; fileSize: number } }> => {
  const formData = new FormData();
  formData.append("file", file);
  const { data } = await $authHost.post(`/api/beryll/defects/${defectId}/files`, formData, {
    headers: { "Content-Type": "multipart/form-data" }
  });
  return data;
};

export const downloadDefectFile = async (fileId: number): Promise<Blob> => {
  const { data } = await $authHost.get(`/api/beryll/defects/files/${fileId}`, {
    responseType: "blob"
  });
  return data;
};

export const deleteDefectFile = async (fileId: number): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.delete(`/api/beryll/defects/files/${fileId}`);
  return data;
};

interface GetDefectStatsParams {
  serverId?: number;
  batchId?: number;
  dateFrom?: string;
  dateTo?: string;
}

export const getDefectStats = async (params?: GetDefectStatsParams): Promise<DefectStats> => {
  const { data } = await $authHost.get("/api/beryll/defects-stats", { params });
  return data;
};


export const getMonitoringStats = async (): Promise<MonitoringStats> => {
  const { data } = await $authHost.get("/api/beryll/monitoring/stats");
  return data;
};

export const getCachedStatus = async (): Promise<PingAllResult> => {
  const { data } = await $authHost.get("/api/beryll/monitoring/status");
  return data;
};

export const pingServer = async (serverId: number): Promise<ServerPingResult> => {
  const { data } = await $authHost.get(`/api/beryll/monitoring/ping/${serverId}`);
  return data;
};

interface PingAllParams {
  batchId?: number;
  status?: string;
  forceRefresh?: boolean;
}

export const pingAllServers = async (params?: PingAllParams): Promise<PingAllResult> => {
  const { data } = await $authHost.post("/api/beryll/monitoring/ping-all", null, { params });
  return data;
};

interface GetServersByPingParams {
  batchId?: number;
  limit?: number;
  offset?: number;
}

interface GetServersResponse {
  count: number;
  rows: any[];
  page: number;
  totalPages: number;
}

export const getOnlineServers = async (params?: GetServersByPingParams): Promise<GetServersResponse> => {
  const { data } = await $authHost.get("/api/beryll/monitoring/servers/online", { params });
  return data;
};

export const getOfflineServers = async (params?: GetServersByPingParams): Promise<GetServersResponse> => {
  const { data } = await $authHost.get("/api/beryll/monitoring/servers/offline", { params });
  return data;
};

export const clearMonitoringCache = async (): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.post("/api/beryll/monitoring/clear-cache");
  return data;
};

================================================================================
FILE: QMS-Client-main/src/api/beryllApi.ts
================================================================================



import { $authHost } from "./index";


export type ServerStatus = "NEW" | "IN_WORK" | "CLARIFYING" | "DEFECT" | "DONE" | "ARCHIVED";
export type BatchStatus = "ACTIVE" | "COMPLETED" | "CANCELLED";
export type ChecklistGroup = "VISUAL" | "TESTING" | "QC_PRIMARY" | "BURN_IN" | "QC_FINAL";
export type PingStatus = "ONLINE" | "OFFLINE" | "UNKNOWN";
export type HistoryAction =
  | "CREATED" | "TAKEN" | "RELEASED" | "STATUS_CHANGED" | "NOTE_ADDED"
  | "CHECKLIST_COMPLETED" | "BATCH_ASSIGNED" | "BATCH_REMOVED" | "DELETED"
  | "ARCHIVED" | "UNARCHIVED" | "FILE_UPLOADED" | "FILE_DELETED" | "SERIAL_ASSIGNED";

export interface BeryllServerUser {
  id: number;
  login: string;
  name: string | null;
  surname: string | null;
}

export interface BeryllChecklistFile {
  id: number;
  serverChecklistId: number;
  fileName: string;
  originalName: string;
  mimetype?: string;
  fileSize: number;
  uploadedById: number;
  uploadedAt: string;
  createdAt?: string;
  uploadedBy?: BeryllServerUser;
}

export interface BeryllChecklistTemplate {
  id: number;
  title: string;
  description: string | null;
  sortOrder: number;
  isRequired: boolean;
  estimatedMinutes: number;
  groupCode: ChecklistGroup;
  fileCode: string | null;
  requiresFile: boolean;
  isActive: boolean;
  createdAt: string;
  updatedAt?: string;
}

export interface BeryllBatch {
  id: number;
  title: string;
  supplier: string | null;
  deliveryDate: string | null;
  expectedCount: number | null;
  notes: string | null;
  status: BatchStatus;
  createdById: number | null;
  createdBy?: BeryllServerUser | null;
  createdAt: string;
}

export interface BeryllServerChecklist {
  id: number;
  serverId: number;
  checklistTemplateId: number;
  completed: boolean;
  completedById: number | null;
  completedAt: string | null;
  notes: string | null;
  template?: BeryllChecklistTemplate;
  completedBy?: BeryllServerUser | null;
  files?: BeryllChecklistFile[];
}

export interface BeryllHistoryItem {
  id: number;
  serverId: number | null;
  serverIp: string | null;
  serverHostname: string | null;
  userId: number | null;
  action: HistoryAction;
  fromStatus: string | null;
  toStatus: string | null;
  checklistItemId: number | null;
  comment: string | null;
  metadata: Record<string, any> | null;
  durationMinutes: number | null;
  createdAt: string;
  user?: BeryllServerUser | null;
  server?: { id: number; ipAddress: string; hostname: string | null } | null;
}

export interface BeryllServer {
  id: number;
  ipAddress: string | null;
  macAddress: string | null;
  hostname: string | null;
  serialNumber: string | null;
  apkSerialNumber: string | null;
  status: ServerStatus;
  batchId: number | null;
  assignedToId: number | null;
  assignedAt: string | null;
  notes: string | null;
  leaseStart: string | null;
  leaseEnd: string | null;
  leaseActive: boolean;
  lastSyncAt: string | null;
  completedAt: string | null;
  archivedAt: string | null;
  archivedById: number | null;
  burnInStartAt: string | null;
  burnInEndAt: string | null;
  createdAt: string;
  updatedAt: string;
  assignedTo?: BeryllServerUser | null;
  archivedBy?: BeryllServerUser | null;
  batch?: { id: number; title: string; status: BatchStatus } | null;
  checklists?: BeryllServerChecklist[];
  history?: BeryllHistoryItem[];
}

export interface BeryllStats {
  total: number;
  active: number;
  byStatus: Record<ServerStatus, number>;
}

export interface BeryllAnalytics {
  overview: {
    totalServers: number;
    activeServers: number;
    byStatus: Record<ServerStatus, number>;
  };
  dailyCompleted: Array<{ date: string; count: number }>;
  topPerformers: Array<{
    userId: number;
    completedCount: number;
    avgDuration: number | null;
    user: BeryllServerUser;
  }>;
  avgProcessingTime: number | null;
  activeBatches: Array<{
    id: number;
    title: string;
    status: BatchStatus;
    serverCount: number;
    completedCount: number;
  }>;
}

export interface SyncResult {
  success: boolean;
  message: string;
  results: {
    created: number;
    updated: number;
    total: number;
  };
}

export interface HistoryResponse {
  count: number;
  rows: BeryllHistoryItem[];
  page: number;
  totalPages: number;
}

export interface ArchivedServersResponse {
  servers: BeryllServer[];
  total: number;
  page: number;
  totalPages: number;
}


export interface ServerPingResult {
  serverId: number;
  ipAddress: string;
  hostname: string;
  serialNumber?: string;
  apkSerialNumber?: string;
  serverStatus?: string;
  batchId?: number;
  online: boolean;
  latency: number | null;
  error: string | null;
  checkedAt: string;
}

export interface MonitoringStats {
  byStatus: Record<PingStatus, number>;
  total: number;
  online: number;
  offline: number;
  unknown: number;
  staleServers: number;
  avgLatency: string | null;
  lastFullScan: string | null;
}

export interface PingAllResult {
  total: number;
  online: number;
  offline: number;
  checkedAt: string;
  cached?: boolean;
  servers: ServerPingResult[];
}


export const STATUS_LABELS: Record<ServerStatus, string> = {
  NEW: "–ù–æ–≤—ã–π",
  IN_WORK: "–í —Ä–∞–±–æ—Ç–µ",
  CLARIFYING: "–£—Ç–æ—á–Ω—è–µ—Ç—Å—è",
  DEFECT: "–ë—Ä–∞–∫",
  DONE: "–ì–æ—Ç–æ–≤–æ",
  ARCHIVED: "–í –∞—Ä—Ö–∏–≤–µ"
};

export const STATUS_COLORS: Record<ServerStatus, string> = {
  NEW: "bg-gray-100 text-gray-700 border-gray-300",
  IN_WORK: "bg-blue-100 text-blue-700 border-blue-300",
  CLARIFYING: "bg-yellow-100 text-yellow-700 border-yellow-300",
  DEFECT: "bg-red-100 text-red-700 border-red-300",
  DONE: "bg-green-100 text-green-700 border-green-300",
  ARCHIVED: "bg-purple-100 text-purple-700 border-purple-300"
};

export const CHECKLIST_GROUP_LABELS: Record<ChecklistGroup, string> = {
  VISUAL: "1. –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Å–º–æ—Ç—Ä",
  TESTING: "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏",
  QC_PRIMARY: "3. –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è (–û–¢–ö) ‚Äî –ø–µ—Ä–≤–∏—á–Ω–∞—è",
  BURN_IN: "4. –ò—Å–ø—ã—Ç–∞—Ç–µ–ª—å–Ω–∞—è",
  QC_FINAL: "5. –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è (–û–¢–ö) ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–∞—è"
};

export const CHECKLIST_GROUP_NUMBERS: Record<ChecklistGroup, number> = {
  VISUAL: 1,
  TESTING: 2,
  QC_PRIMARY: 3,
  BURN_IN: 4,
  QC_FINAL: 5
};

export const BATCH_STATUS_LABELS: Record<BatchStatus, string> = {
  ACTIVE: "–ê–∫—Ç–∏–≤–Ω–∞",
  COMPLETED: "–ó–∞–≤–µ—Ä—à–µ–Ω–∞",
  CANCELLED: "–û—Ç–º–µ–Ω–µ–Ω–∞"
};

export const BATCH_STATUS_COLORS: Record<BatchStatus, string> = {
  ACTIVE: "bg-blue-100 text-blue-700",
  COMPLETED: "bg-green-100 text-green-700",
  CANCELLED: "bg-gray-100 text-gray-500"
};

export const HISTORY_ACTION_LABELS: Record<HistoryAction, string> = {
  CREATED: "–°–æ–∑–¥–∞–Ω",
  TAKEN: "–í–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É",
  RELEASED: "–û—Å–≤–æ–±–æ–∂–¥—ë–Ω",
  STATUS_CHANGED: "–ò–∑–º–µ–Ω—ë–Ω —Å—Ç–∞—Ç—É—Å",
  NOTE_ADDED: "–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ",
  CHECKLIST_COMPLETED: "–í—ã–ø–æ–ª–Ω–µ–Ω —ç—Ç–∞–ø",
  BATCH_ASSIGNED: "–ü—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–∞—Ä—Ç–∏–∏",
  BATCH_REMOVED: "–û—Ç–≤—è–∑–∞–Ω –æ—Ç –ø–∞—Ä—Ç–∏–∏",
  DELETED: "–£–¥–∞–ª—ë–Ω",
  ARCHIVED: "–ü–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ –∞—Ä—Ö–∏–≤",
  UNARCHIVED: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –∞—Ä—Ö–∏–≤–∞",
  FILE_UPLOADED: "–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª",
  FILE_DELETED: "–£–¥–∞–ª—ë–Ω —Ñ–∞–π–ª",
  SERIAL_ASSIGNED: "–ü—Ä–∏—Å–≤–æ–µ–Ω —Å–µ—Ä–∏–π–Ω–∏–∫"
};


export const formatDuration = (minutes: number | null): string => {
  if (!minutes) return "-";
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  if (hours === 0) return `${mins}–º`;
  return `${hours}—á ${mins}–º`;
};

export const formatDateTime = (date: string | null): string => {
  if (!date) return "-";
  return new Date(date).toLocaleString("ru-RU", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit"
  });
};

export const formatDate = (date: string | null): string => {
  if (!date) return "-";
  return new Date(date).toLocaleDateString("ru-RU", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric"
  });
};

export const getStatusProgress = (stats: Record<ServerStatus, number> | undefined): number => {
  if (!stats) return 0;
  const total = Object.values(stats).reduce((a, b) => a + b, 0);
  if (total === 0) return 0;
  return Math.round((stats.DONE / total) * 100);
};


export const syncWithDhcp = async (): Promise<SyncResult> => {
  const { data } = await $authHost.post<SyncResult>("/api/beryll/sync");
  return data;
};


export const getServers = async (params?: {
  status?: ServerStatus;
  search?: string;
  onlyActive?: boolean;
  batchId?: number | "null";
  assignedToId?: number;
}): Promise<BeryllServer[]> => {
  const { data } = await $authHost.get<BeryllServer[]>("/api/beryll/servers", { params });
  return data;
};

export const getStats = async (): Promise<BeryllStats> => {
  const { data } = await $authHost.get<BeryllStats>("/api/beryll/stats");
  return data;
};

export const getAnalytics = async (params?: {
  dateFrom?: string;
  dateTo?: string;
}): Promise<BeryllAnalytics> => {
  const { data } = await $authHost.get<BeryllAnalytics>("/api/beryll/analytics", { params });
  return data;
};

export const getServerById = async (id: number): Promise<BeryllServer> => {
  const { data } = await $authHost.get<BeryllServer>(`/api/beryll/servers/${id}`);
  return data;
};

export const takeServer = async (id: number): Promise<BeryllServer> => {
  const { data } = await $authHost.post<BeryllServer>(`/api/beryll/servers/${id}/take`);
  return data;
};

export const releaseServer = async (id: number): Promise<BeryllServer> => {
  const { data } = await $authHost.post<BeryllServer>(`/api/beryll/servers/${id}/release`);
  return data;
};

export const updateServerStatus = async (
  id: number,
  status: ServerStatus,
  notes?: string
): Promise<BeryllServer> => {
  const { data } = await $authHost.put<BeryllServer>(`/api/beryll/servers/${id}/status`, {
    status,
    notes
  });
  return data;
};

export const updateServerNotes = async (
  id: number,
  notes: string
): Promise<BeryllServer> => {
  const { data } = await $authHost.put<BeryllServer>(`/api/beryll/servers/${id}/notes`, { notes });
  return data;
};

export const deleteServer = async (id: number): Promise<{ success: boolean }> => {
  const { data } = await $authHost.delete(`/api/beryll/servers/${id}`);
  return data;
};


export const getCachedStatus = async (): Promise<PingAllResult> => {
  const { data } = await $authHost.get<PingAllResult>("/api/beryll/monitoring/status");
  return data;
};


export const pingServer = async (serverId: number): Promise<ServerPingResult> => {
  const { data } = await $authHost.get<ServerPingResult>(`/api/beryll/monitoring/ping/${serverId}`);
  return data;
};


export const pingAllServers = async (params?: { forceRefresh?: boolean }): Promise<PingAllResult> => {
  const { data } = await $authHost.post<PingAllResult>("/api/beryll/monitoring/ping-all", null, { params });
  return data;
};


export const getMonitoringStats = async (): Promise<MonitoringStats> => {
  const { data } = await $authHost.get<MonitoringStats>("/api/beryll/monitoring/stats");
  return data;
};


export const getOnlineServers = async (params?: {
  page?: number;
  limit?: number;
}): Promise<{ servers: ServerPingResult[]; total: number }> => {
  const { data } = await $authHost.get("/api/beryll/monitoring/online", { params });
  return data;
};


export const getOfflineServers = async (params?: {
  page?: number;
  limit?: number;
}): Promise<{ servers: ServerPingResult[]; total: number }> => {
  const { data } = await $authHost.get("/api/beryll/monitoring/offline", { params });
  return data;
};


export const getChecklistTemplates = async (
  includeInactive = false
): Promise<BeryllChecklistTemplate[]> => {
  const { data } = await $authHost.get<BeryllChecklistTemplate[]>(
    "/api/beryll/checklists/templates",
    { params: { includeInactive } }
  );
  return data;
};


export const createChecklistTemplate = async (template: {
  title: string;
  description?: string;
  sortOrder?: number;
  isRequired?: boolean;
  estimatedMinutes?: number;
  groupCode?: ChecklistGroup;
  fileCode?: string;
  requiresFile?: boolean;
}): Promise<BeryllChecklistTemplate> => {
  const { data } = await $authHost.post<BeryllChecklistTemplate>(
    "/api/beryll/checklists/templates",
    template
  );
  return data;
};


export const updateChecklistTemplate = async (
  id: number,
  template: Partial<BeryllChecklistTemplate>
): Promise<BeryllChecklistTemplate> => {
  const { data } = await $authHost.put<BeryllChecklistTemplate>(
    `/api/beryll/checklists/templates/${id}`,
    template
  );
  return data;
};


export const deleteChecklistTemplate = async (
  id: number,
  hardDelete = false
): Promise<{ success: boolean }> => {
  const { data } = await $authHost.delete(
    `/api/beryll/checklists/templates/${id}`,
    { params: { hardDelete } }
  );
  return data;
};


export const restoreChecklistTemplate = async (
  id: number
): Promise<BeryllChecklistTemplate> => {
  const { data } = await $authHost.post<BeryllChecklistTemplate>(
    `/api/beryll/checklists/templates/${id}/restore`
  );
  return data;
};


export const reorderChecklistTemplates = async (
  orderedIds: number[]
): Promise<{ success: boolean }> => {
  const { data } = await $authHost.put(
    "/api/beryll/checklists/templates/reorder",
    { orderedIds }
  );
  return data;
};


export const getServerChecklist = async (
  serverId: number
): Promise<BeryllServerChecklist[]> => {
  const { data } = await $authHost.get<BeryllServerChecklist[]>(
    `/api/beryll/servers/${serverId}/checklist`
  );
  return data;
};


export const toggleChecklistItem = async (
  serverId: number,
  checklistId: number,
  completed: boolean,
  notes?: string
): Promise<BeryllServerChecklist> => {
  const { data } = await $authHost.put<BeryllServerChecklist>(
    `/api/beryll/servers/${serverId}/checklist/${checklistId}`,
    { completed, notes }
  );
  return data;
};


export const uploadChecklistFile = async (
  serverId: number,
  checklistId: number,
  file: File
): Promise<BeryllChecklistFile> => {
  const formData = new FormData();
  formData.append("file", file, file.name);


  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    const baseURL = import.meta.env.VITE_API_URL || "";
    const url = `${baseURL}/api/beryll/servers/${serverId}/checklist/${checklistId}/file`;

    xhr.open("POST", url, true);


    const token = localStorage.getItem("token");
    if (token) {
      xhr.setRequestHeader("Authorization", `Bearer ${token}`);
    }

    xhr.onload = function() {
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          const data = JSON.parse(xhr.responseText);
          resolve(data);
        } catch (e) {
          resolve({ success: true } as any);
        }
      } else {
        try {
          const error = JSON.parse(xhr.responseText);
          reject(new Error(error.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"));
        } catch (e) {
          reject(new Error("–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"));
        }
      }
    };

    xhr.onerror = function() {
      reject(new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"));
    };


    xhr.send(formData);
  });
};


export const getServerFiles = async (serverId: number): Promise<BeryllChecklistFile[]> => {
  const { data } = await $authHost.get<BeryllChecklistFile[]>(`/api/beryll/servers/${serverId}/files`);
  return data;
};


export const downloadFile = (fileId: number): string => {
  const baseUrl = import.meta.env.VITE_API_URL || '';
  return `${baseUrl}/api/beryll/files/${fileId}`;
};


export const deleteChecklistFile = async (
  fileId: number
): Promise<{ success: boolean }> => {
  const { data } = await $authHost.delete(`/api/beryll/checklists/files/${fileId}`);
  return data;
};


export const getBatches = async (params?: {
  status?: BatchStatus;
  search?: string;
}): Promise<BeryllBatch[]> => {
  const { data } = await $authHost.get<BeryllBatch[]>("/api/beryll/batches", { params });
  return data;
};

export const getBatchById = async (id: number): Promise<BeryllBatch> => {
  const { data } = await $authHost.get<BeryllBatch>(`/api/beryll/batches/${id}`);
  return data;
};

export const createBatch = async (batch: {
  title: string;
  supplier?: string;
  deliveryDate?: string;
  expectedCount?: number;
  notes?: string;
}): Promise<BeryllBatch> => {
  const { data } = await $authHost.post<BeryllBatch>("/api/beryll/batches", batch);
  return data;
};

export const updateBatch = async (
  id: number,
  batch: Partial<BeryllBatch>
): Promise<BeryllBatch> => {
  const { data } = await $authHost.put<BeryllBatch>(`/api/beryll/batches/${id}`, batch);
  return data;
};

export const deleteBatch = async (id: number): Promise<{ success: boolean }> => {
  const { data } = await $authHost.delete(`/api/beryll/batches/${id}`);
  return data;
};

export const assignServersToBatch = async (
  serverIds: number[],
  batchId: number
): Promise<{ success: boolean; assigned: number }> => {
  const { data } = await $authHost.post(`/api/beryll/batches/${batchId}/assign`, { serverIds });
  return data;
};

export const removeServersFromBatch = async (
  batchId: number,
  serverIds: number[]
): Promise<{ success: boolean; removed: number }> => {
  const { data } = await $authHost.post(`/api/beryll/batches/${batchId}/remove`, { serverIds });
  return data;
};


export const getHistory = async (params?: {
  serverId?: number;
  userId?: number;
  action?: HistoryAction;
  dateFrom?: string;
  dateTo?: string;
  page?: number;
  limit?: number;
}): Promise<HistoryResponse> => {
  const { data } = await $authHost.get<HistoryResponse>("/api/beryll/history", { params });
  return data;
};


export const getArchivedServers = async (params?: {
  search?: string;
  batchId?: number | "null";
  page?: number;
  limit?: number;
}): Promise<ArchivedServersResponse> => {
  const { data } = await $authHost.get<ArchivedServersResponse>("/api/beryll/archive", { params });
  return data;
};

export const archiveServer = async (id: number): Promise<{ success: boolean; message: string }> => {
  const { data } = await $authHost.post(`/api/beryll/servers/${id}/archive`);
  return data;
};


export const unarchiveServer = async (id: number): Promise<BeryllServer> => {
  const { data } = await $authHost.post<BeryllServer>(`/api/beryll/servers/${id}/unarchive`);
  return data;
};


export const updateApkSerialNumber = async (
  id: number,
  apkSerialNumber: string
): Promise<{ success: boolean; apkSerialNumber: string }> => {
  const { data } = await $authHost.put(`/api/beryll/servers/${id}/apk-serial`, { apkSerialNumber });
  return data;
};


export const downloadPassport = (serverId: number): string => {
  return `/api/beryll/servers/${serverId}/passport`;
};

export const generatePassport = async (serverId: number): Promise<Blob> => {
  const { data } = await $authHost.get(`/api/beryll/servers/${serverId}/passport`, {
    responseType: "blob"
  });
  return data;
};


export interface ExportPassportsOptions {
  serverIds?: number[];
  batchId?: number | string | null;
  status?: string;
  dateFrom?: string;
  dateTo?: string;
  search?: string;
  includeArchived?: boolean;
}

export const exportPassports = async (options: ExportPassportsOptions = {}): Promise<Blob> => {
  const { data } = await $authHost.post("/api/beryll/export/passports", options, {
    responseType: "blob"
  });
  return data;
};

export const exportSelectedPassports = async (serverIds: number[]): Promise<Blob> => {
  const { data } = await $authHost.post("/api/beryll/export/passports/selected", { serverIds }, {
    responseType: "blob"
  });
  return data;
};

export const exportBatchPassports = async (batchId: number | string): Promise<Blob> => {
  const { data } = await $authHost.get(`/api/beryll/export/passports/batch/${batchId}`, {
    responseType: "blob"
  });
  return data;
};


export default {

  syncWithDhcp,

  getServers,
  getStats,
  getAnalytics,
  getServerById,
  takeServer,
  releaseServer,
  updateServerStatus,
  updateServerNotes,
  deleteServer,

  getCachedStatus,
  pingServer,
  pingAllServers,
  getMonitoringStats,
  getOnlineServers,
  getOfflineServers,

  getChecklistTemplates,
  createChecklistTemplate,
  updateChecklistTemplate,
  deleteChecklistTemplate,
  restoreChecklistTemplate,
  reorderChecklistTemplates,

  getServerChecklist,
  toggleChecklistItem,

  uploadChecklistFile,
  getServerFiles,
  downloadFile,
  deleteChecklistFile,

  getBatches,
  getBatchById,
  createBatch,
  updateBatch,
  deleteBatch,
  assignServersToBatch,
  removeServersFromBatch,

  getHistory,

  getArchivedServers,
  archiveServer,
  unarchiveServer,

  updateApkSerialNumber,

  downloadPassport,
  generatePassport,

  exportPassports,
  exportSelectedPassports,
  exportBatchPassports,

  formatDuration,
  formatDateTime,
  formatDate,
  getStatusProgress
};

================================================================================
FILE: QMS-Client-main/src/api/beryllExtendedApi.ts
================================================================================



import { apiClient } from "../apiClient";


export interface ComponentCatalog {
  id: number;
  type: string;
  manufacturer: string | null;
  model: string;
  revision: string | null;
  partNumber: string | null;
  specifications: Record<string, any>;
  serialNumberPattern: string | null;
  isActive: boolean;
  notes: string | null;
}

export interface ComponentInventory {
  id: number;
  catalogId: number | null;
  type: string;
  serialNumber: string;
  serialNumberYadro: string | null;
  manufacturer: string | null;
  model: string | null;
  status: InventoryStatus;
  condition: ComponentCondition;
  location: string | null;
  currentServerId: number | null;
  reservedForDefectId: number | null;
  purchaseDate: string | null;
  warrantyExpires: string | null;
  lastTestedAt: string | null;
  metadata: Record<string, any>;
  notes: string | null;
  catalog?: ComponentCatalog;
  currentServer?: { id: number; apkSerialNumber: string; hostname: string };
}

export interface ComponentHistory {
  id: number;
  serverComponentId: number | null;
  inventoryComponentId: number | null;
  action: string;
  fromServerId: number | null;
  toServerId: number | null;
  fromLocation: string | null;
  toLocation: string | null;
  relatedDefectId: number | null;
  yadroTicketNumber: string | null;
  performedById: number | null;
  performedAt: string;
  metadata: Record<string, any>;
  notes: string | null;
  performedBy?: { id: number; name: string; surname: string };
}

export interface DefectRecord {
  id: number;
  serverId: number;
  yadroTicketNumber: string | null;
  hasSPISI: boolean;
  clusterCode: string | null;
  problemDescription: string | null;
  detectedAt: string;
  detectedById: number | null;
  diagnosticianId: number | null;
  resolvedAt: string | null;
  resolvedById: number | null;
  repairPartType: string | null;
  defectPartSerialYadro: string | null;
  defectPartSerialManuf: string | null;
  replacementPartSerialYadro: string | null;
  replacementPartSerialManuf: string | null;
  status: DefectRecordStatus;
  isRepeatedDefect: boolean;
  previousDefectId: number | null;
  repeatedDefectReason: string | null;
  substituteServerId: number | null;
  substituteServerSerial: string | null;
  sentToYadroRepair: boolean;
  sentToYadroAt: string | null;
  returnedFromYadro: boolean;
  returnedFromYadroAt: string | null;
  resolution: string | null;
  repairDetails: string | null;
  slaDeadline: string | null;
  diagnosisStartedAt: string | null;
  diagnosisCompletedAt: string | null;
  repairStartedAt: string | null;
  repairCompletedAt: string | null;
  totalDowntimeMinutes: number | null;
  notes: string | null;
  server?: { id: number; ipAddress: string; apkSerialNumber: string; hostname: string; status: string };
  detectedBy?: { id: number; name: string; surname: string };
  diagnostician?: { id: number; name: string; surname: string };
  resolvedBy?: { id: number; name: string; surname: string };
  substituteServer?: { id: number; apkSerialNumber: string; hostname: string };
  previousDefect?: DefectRecord;
  yadroLogs?: YadroTicketLog[];
}

export interface YadroTicketLog {
  id: number;
  ticketNumber: string;
  defectRecordId: number | null;
  serverId: number | null;
  requestType: YadroRequestType;
  status: YadroLogStatus;
  componentType: string | null;
  sentComponentSerialYadro: string | null;
  sentComponentSerialManuf: string | null;
  receivedComponentSerialYadro: string | null;
  receivedComponentSerialManuf: string | null;
  sentAt: string | null;
  receivedAt: string | null;
  problemDescription: string | null;
  yadroResponse: string | null;
  notes: string | null;
  server?: { id: number; apkSerialNumber: string; hostname: string };
  defectRecord?: DefectRecord;
}

export interface SubstituteServer {
  id: number;
  serverId: number;
  status: SubstituteStatus;
  currentDefectId: number | null;
  issuedAt: string | null;
  issuedToUserId: number | null;
  returnedAt: string | null;
  usageCount: number;
  notes: string | null;
  server?: { id: number; apkSerialNumber: string; hostname: string; ipAddress: string };
  issuedTo?: { id: number; name: string; surname: string };
}

export interface SlaConfig {
  id: number;
  name: string;
  defectType: string | null;
  priority: string | null;
  maxDiagnosisHours: number;
  maxRepairHours: number;
  maxTotalHours: number;
  escalationAfterHours: number | null;
  isActive: boolean;
}

export interface UserAlias {
  id: number;
  userId: number;
  alias: string;
  source: string | null;
  isActive: boolean;
  user?: { id: number; name: string; surname: string; login: string };
}


export type InventoryStatus = "AVAILABLE" | "RESERVED" | "IN_USE" | "IN_REPAIR" | "DEFECTIVE" | "SCRAPPED" | "RETURNED";
export type ComponentCondition = "NEW" | "REFURBISHED" | "USED" | "DAMAGED";
export type DefectRecordStatus = "NEW" | "DIAGNOSING" | "WAITING_PARTS" | "REPAIRING" | "SENT_TO_YADRO" | "RETURNED" | "RESOLVED" | "REPEATED" | "CLOSED";
export type YadroRequestType = "COMPONENT_REPAIR" | "COMPONENT_EXCHANGE" | "WARRANTY_CLAIM" | "CONSULTATION";
export type YadroLogStatus = "SENT" | "IN_PROGRESS" | "COMPLETED" | "RECEIVED" | "CLOSED";
export type SubstituteStatus = "AVAILABLE" | "IN_USE" | "MAINTENANCE" | "RETIRED";


export const inventoryApi = {

  getCatalog: (type?: string) =>
    apiClient.get<ComponentCatalog[]>("/beryll/extended/inventory/catalog", { params: { type } }),

  createCatalogEntry: (data: Partial<ComponentCatalog>) =>
    apiClient.post<{ catalog: ComponentCatalog; created: boolean }>("/beryll/extended/inventory/catalog", data),

  updateCatalogEntry: (id: number, data: Partial<ComponentCatalog>) =>
    apiClient.put<ComponentCatalog>(`/beryll/extended/inventory/catalog/${id}`, data),


  getAll: (params: {
    type?: string;
    status?: InventoryStatus;
    condition?: ComponentCondition;
    manufacturer?: string;
    model?: string;
    search?: string;
    serverId?: number;
    location?: string;
    warrantyExpired?: boolean;
    limit?: number;
    offset?: number;
  }) => apiClient.get<{ rows: ComponentInventory[]; count: number }>("/beryll/extended/inventory", { params }),

  getById: (id: number) =>
    apiClient.get<ComponentInventory>(`/beryll/extended/inventory/${id}`),

  getBySerial: (serial: string) =>
    apiClient.get<ComponentInventory>(`/beryll/extended/inventory/serial/${serial}`),

  getAvailableByType: (type: string, count?: number) =>
    apiClient.get<ComponentInventory[]>(`/beryll/extended/inventory/available/${type}`, { params: { count } }),

  getStats: () =>
    apiClient.get<{
      byType: Record<string, Record<string, number>>;
      totals: { total: number; available: number; inUse: number; defective: number; inRepair: number };
      warrantyExpiringSoon: number;
    }>("/beryll/extended/inventory/stats"),

  getWarrantyExpiring: (days?: number) =>
    apiClient.get<ComponentInventory[]>("/beryll/extended/inventory/warranty-expiring", { params: { days } }),

  getHistory: (id: number) =>
    apiClient.get<ComponentHistory[]>(`/beryll/extended/inventory/${id}/history`),


  create: (data: {
    type: string;
    serialNumber: string;
    serialNumberYadro?: string;
    manufacturer?: string;
    model?: string;
    condition?: ComponentCondition;
    location?: string;
    purchaseDate?: string;
    warrantyExpires?: string;
    notes?: string;
  }) => apiClient.post<ComponentInventory>("/beryll/extended/inventory", data),

  bulkCreate: (items: Array<{
    type: string;
    serialNumber: string;
    serialNumberYadro?: string;
    manufacturer?: string;
    model?: string;
    condition?: ComponentCondition;
    location?: string;
  }>) => apiClient.post<{ success: Array<{ serialNumber: string; id: number }>; errors: Array<{ serialNumber: string; error: string }> }>("/beryll/extended/inventory/bulk", { items }),


  reserve: (id: number, defectId: number) =>
    apiClient.post<ComponentInventory>(`/beryll/extended/inventory/${id}/reserve`, { defectId }),

  release: (id: number, notes?: string) =>
    apiClient.post<ComponentInventory>(`/beryll/extended/inventory/${id}/release`, { notes }),

  installToServer: (id: number, serverId: number, defectId?: number) =>
    apiClient.post<ComponentInventory>(`/beryll/extended/inventory/${id}/install`, { serverId, defectId }),

  removeFromServer: (id: number, reason?: string, defectId?: number) =>
    apiClient.post<ComponentInventory>(`/beryll/extended/inventory/${id}/remove`, { reason, defectId }),

  sendToYadro: (id: number, ticketNumber: string) =>
    apiClient.post<ComponentInventory>(`/beryll/extended/inventory/${id}/send-to-yadro`, { ticketNumber }),

  returnFromYadro: (id: number, condition?: ComponentCondition) =>
    apiClient.post<ComponentInventory>(`/beryll/extended/inventory/${id}/return-from-yadro`, { condition }),

  scrap: (id: number, reason: string) =>
    apiClient.post<ComponentInventory>(`/beryll/extended/inventory/${id}/scrap`, { reason }),

  updateLocation: (id: number, location: string) =>
    apiClient.post<ComponentInventory>(`/beryll/extended/inventory/${id}/location`, { location }),

  markTested: (id: number, passed: boolean, notes?: string) =>
    apiClient.post<ComponentInventory>(`/beryll/extended/inventory/${id}/test`, { passed, notes }),
};


export const defectRecordApi = {

  getPartTypes: () =>
    apiClient.get<Array<{ value: string; label: string }>>("/beryll/extended/defects/part-types"),

  getStatuses: () =>
    apiClient.get<Array<{ value: string; label: string }>>("/beryll/extended/defects/statuses"),

  getStats: (params?: { dateFrom?: string; dateTo?: string; serverId?: number }) =>
    apiClient.get<{
      byStatus: Array<{ status: string; count: string }>;
      byType: Array<{ repairPartType: string; count: string }>;
      repeatedCount: number;
      slaBreachedCount: number;
      avgRepairTimeMinutes: number;
      avgRepairTimeHours: number;
    }>("/beryll/extended/defects/stats", { params }),


  getAll: (params: {
    serverId?: number;
    status?: DefectRecordStatus;
    repairPartType?: string;
    diagnosticianId?: number;
    isRepeatedDefect?: boolean;
    dateFrom?: string;
    dateTo?: string;
    search?: string;
    slaBreached?: boolean;
    limit?: number;
    offset?: number;
  }) => apiClient.get<{ rows: DefectRecord[]; count: number }>("/beryll/extended/defects", { params }),

  getById: (id: number) =>
    apiClient.get<DefectRecord>(`/beryll/extended/defects/${id}`),

  create: (data: {
    serverId: number;
    yadroTicketNumber?: string;
    hasSPISI?: boolean;
    clusterCode?: string;
    problemDescription?: string;
    repairPartType?: string;
    defectPartSerialYadro?: string;
    defectPartSerialManuf?: string;
    notes?: string;
    priority?: TicketPriority;
  }) => apiClient.post<DefectRecord>("/beryll/extended/defects", data),


  startDiagnosis: (id: number) =>
    apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/start-diagnosis`),

  completeDiagnosis: (id: number, data: {
    repairPartType?: string;
    defectPartSerialYadro?: string;
    defectPartSerialManuf?: string;
    problemDescription?: string;
    notes?: string;
  }) => apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/complete-diagnosis`, data),

  setWaitingParts: (id: number, notes?: string) =>
    apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/waiting-parts`, { notes }),

  reserveComponent: (id: number, inventoryId: number) =>
    apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/reserve-component`, { inventoryId }),

  startRepair: (id: number) =>
    apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/start-repair`),

  performReplacement: (id: number, data: {
    replacementPartSerialYadro?: string;
    replacementPartSerialManuf?: string;
    replacementInventoryId?: number;
    repairDetails?: string;
  }) => apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/perform-replacement`, data),

  sendToYadro: (id: number, data: {
    ticketNumber?: string;
    subject?: string;
    description?: string;
    trackingNumber?: string;
  }) => apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/send-to-yadro`, data),

  returnFromYadro: (id: number, data: {
    resolution?: string;
    replacementSerialYadro?: string;
    replacementSerialManuf?: string;
    condition?: ComponentCondition;
  }) => apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/return-from-yadro`, data),

  issueSubstitute: (id: number, substituteServerId?: number) =>
    apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/issue-substitute`, { substituteServerId }),

  returnSubstitute: (id: number) =>
    apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/return-substitute`),

  resolve: (id: number, data: { resolution: string; notes?: string }) =>
    apiClient.post<DefectRecord>(`/beryll/extended/defects/${id}/resolve`, data),
};


export const yadroApi = {

  getRequestTypes: () =>
    apiClient.get<Array<{ value: string; label: string }>>("/beryll/extended/yadro/request-types"),

  getLogStatuses: () =>
    apiClient.get<Array<{ value: string; label: string }>>("/beryll/extended/yadro/log-statuses"),


  getAllLogs: (params: {
    status?: YadroLogStatus;
    requestType?: YadroRequestType;
    defectRecordId?: number;
    serverId?: number;
    dateFrom?: string;
    dateTo?: string;
    search?: string;
    limit?: number;
    offset?: number;
  }) => apiClient.get<{ rows: YadroTicketLog[]; count: number }>("/beryll/extended/yadro/logs", { params }),

  getOpenLogs: () =>
    apiClient.get<YadroTicketLog[]>("/beryll/extended/yadro/logs/open"),

  getLogStats: (params?: { dateFrom?: string; dateTo?: string }) =>
    apiClient.get<Array<{ status: string; requestType: string; componentType: string; count: string }>>("/beryll/extended/yadro/logs/stats", { params }),

  getLogById: (id: number) =>
    apiClient.get<YadroTicketLog>(`/beryll/extended/yadro/logs/${id}`),


  createLog: (data: {
    ticketNumber: string;
    defectRecordId?: number;
    serverId?: number;
    requestType?: YadroRequestType;
    componentType?: string;
    sentComponentSerialYadro?: string;
    sentComponentSerialManuf?: string;
    sentAt?: string;
    problemDescription?: string;
    notes?: string;
  }) => apiClient.post<YadroTicketLog>("/beryll/extended/yadro/logs", data),


  updateLogStatus: (id: number, data: {
    status: YadroLogStatus;
    yadroResponse?: string;
    receivedComponentSerialYadro?: string;
    receivedComponentSerialManuf?: string;
    notes?: string;
  }) => apiClient.put<YadroTicketLog>(`/beryll/extended/yadro/logs/${id}/status`, data),
};


export const substituteApi = {
  getAll: (status?: SubstituteStatus) =>
    apiClient.get<SubstituteServer[]>("/beryll/extended/substitutes", { params: { status } }),

  getAvailable: () =>
    apiClient.get<SubstituteServer[]>("/beryll/extended/substitutes/available"),

  getStats: () =>
    apiClient.get<{
      total: number;
      available: number;
      inUse: number;
      maintenance: number;
      avgUsageCount: number;
    }>("/beryll/extended/substitutes/stats"),

  addToPool: (serverId: number, notes?: string) =>
    apiClient.post<SubstituteServer>("/beryll/extended/substitutes", { serverId, notes }),

  removeFromPool: (id: number) =>
    apiClient.delete(`/beryll/extended/substitutes/${id}`),

  issue: (id: number, defectId: number) =>
    apiClient.post<SubstituteServer>(`/beryll/extended/substitutes/${id}/issue`, { defectId }),

  return: (id: number) =>
    apiClient.post<SubstituteServer>(`/beryll/extended/substitutes/${id}/return`),

  setMaintenance: (id: number, notes?: string) =>
    apiClient.post<SubstituteServer>(`/beryll/extended/substitutes/${id}/maintenance`, { notes }),
};


export const slaApi = {
  getAll: () =>
    apiClient.get<SlaConfig[]>("/beryll/extended/sla"),

  create: (data: Partial<SlaConfig>) =>
    apiClient.post<SlaConfig>("/beryll/extended/sla", data),

  update: (id: number, data: Partial<SlaConfig>) =>
    apiClient.put<SlaConfig>(`/beryll/extended/sla/${id}`, data),

  delete: (id: number) =>
    apiClient.delete(`/beryll/extended/sla/${id}`),
};


export const aliasApi = {
  getAll: (userId?: number) =>
    apiClient.get<UserAlias[]>("/beryll/extended/aliases", { params: { userId } }),

  findUserByAlias: (alias: string) =>
    apiClient.get<{ id: number; name: string; surname: string; login: string }>(`/beryll/extended/aliases/find/${encodeURIComponent(alias)}`),

  create: (userId: number, alias: string, source?: string) =>
    apiClient.post<UserAlias>("/beryll/extended/aliases", { userId, alias, source }),

  delete: (id: number) =>
    apiClient.delete(`/beryll/extended/aliases/${id}`),

  generateForUser: (userId: number) =>
    apiClient.post<UserAlias[]>(`/beryll/extended/aliases/generate/${userId}`),
};

================================================================================
FILE: QMS-Client-main/src/api/coralBApi.ts
================================================================================

import { $host, $authHost } from "./index"


export const createCategoryDefectCoral_B = async (title: string, description: string) => {
    const { data } = await $authHost.post('api/defects-Coral-B', { title, description })
    return data
}
export const fetchCategoryDefectCoral_B = async () => {
    const { data } = await $host.get('api/defects-Coral-B',)
    return data
}
export const updateCategoryDefectCoral_B = async (id: number, title: string, description: string) => {
    const { data } = await $authHost.put('api/defects-Coral-B', { id, title, description })
    return data
}
export const deleteCategoryDefectCoral_B = async (id: number) => {
    const { data } = await $authHost.delete(`api/defects-Coral-B/${id}`)
    return data
}


export const createCoral_B_Board = async (serial: string | null,
    firmware: boolean, SAW_filter: boolean, firmwareVersion: string | null, sessionId: number, categoryDefectCoralBId: number) => {
    const { data } = await $authHost.post('api/Coral-B', { serial, firmware, SAW_filter, firmwareVersion, sessionId, categoryDefectCoralBId })
    return data
}
export const fetchCoral_B = async (serial: string | null, firmware: boolean | null, SAW_filter: boolean | null, firmwareVersion: string | null, PCId: number | null, userId: number | null, categoryDefectCoralBId: number | null, date: string | null, limit: number, page: number) => {
    const { data } = await $host.get('api/Coral-B', {
        params: {
            serial, firmware, SAW_filter, firmwareVersion, PCId, userId, categoryDefectCoralBId, date, limit, page
        }
    })
    return data
}
export const createManydefectsCoral_B_boards = async (count: number, SAW_filter: boolean, sessionId: number, categoryDefectCoralBId: number) => {
    const { data } = await $authHost.post('api/Coral_B/addManyDefectCoralB', {
        count, SAW_filter, sessionId, categoryDefectCoralBId
    })
    return data
}
export const deleteCoral_BbyID = async (id: number) => {
    const { data } = await $authHost.delete(`api/Coral-B/byDBid/${id}`)
    return data
}

export const deleteManydefects_Coral_B_boards = async (count: number, SAW_filter: boolean, categoryDefectCoralBId: number) => {
    const { data } = await $authHost.post('api/Coral-B/deleteManyDefectCoralB', {
        count, SAW_filter, categoryDefectCoralBId
    })
    return data
}

================================================================================
FILE: QMS-Client-main/src/api/defectApi.ts
================================================================================

import { $authHost } from "./index";
import {
  DefectCategory,
  CreateDefectCategoryDto,
  UpdateDefectCategoryDto,
  BoardDefect,
  CreateDefectDto,
  DefectsResponse,
  DefectDetailResponse,
  RepairAction,
  CreateRepairActionDto,
  MarkRepairedDto,
  MarkScrappedDto,
  DefectStatistics,
  BoardType,
  DefectStatus
} from "../types/DefectTypes";


export const fetchDefectCategories = async (
  boardType?: BoardType,
  activeOnly: boolean = true
): Promise<DefectCategory[]> => {
  const params = new URLSearchParams();
  if (boardType) params.append("boardType", boardType);
  if (activeOnly) params.append("activeOnly", "true");

  const { data } = await $authHost.get(`/api/defects/categories?${params}`);
  return data;
};

export const createDefectCategory = async (
  dto: CreateDefectCategoryDto
): Promise<DefectCategory> => {
  const { data } = await $authHost.post("/api/defects/categories", dto);
  return data;
};

export const updateDefectCategory = async (
  id: number,
  dto: UpdateDefectCategoryDto
): Promise<DefectCategory> => {
  const { data } = await $authHost.put(`/api/defects/categories/${id}`, dto);
  return data;
};

export const deleteDefectCategory = async (id: number): Promise<void> => {
  await $authHost.delete(`/api/defects/categories/${id}`);
};


export interface FetchDefectsParams {
  page?: number;
  limit?: number;
  status?: DefectStatus | "ACTIVE";
  boardType?: BoardType;
  categoryId?: number;
  search?: string;
  startDate?: string;
  endDate?: string;
}

export const fetchDefects = async (
  params: FetchDefectsParams = {}
): Promise<DefectsResponse> => {
  const searchParams = new URLSearchParams();

  if (params.page) searchParams.append("page", String(params.page));
  if (params.limit) searchParams.append("limit", String(params.limit));
  if (params.status) searchParams.append("status", params.status);
  if (params.boardType) searchParams.append("boardType", params.boardType);
  if (params.categoryId) searchParams.append("categoryId", String(params.categoryId));
  if (params.search) searchParams.append("search", params.search);
  if (params.startDate) searchParams.append("startDate", params.startDate);
  if (params.endDate) searchParams.append("endDate", params.endDate);

  const { data } = await $authHost.get(`/api/defects?${searchParams}`);
  return data;
};

export const fetchDefectById = async (id: number): Promise<DefectDetailResponse> => {
  const { data } = await $authHost.get(`/api/defects/${id}`);
  return data;
};

export const createDefect = async (dto: CreateDefectDto): Promise<BoardDefect> => {
  const { data } = await $authHost.post("/api/defects", dto);
  return data;
};

export const updateDefectStatus = async (
  id: number,
  status: DefectStatus,
  finalResult?: string
): Promise<BoardDefect> => {
  const { data } = await $authHost.patch(`/api/defects/${id}/status`, {
    status,
    finalResult
  });
  return data;
};


export const fetchRepairHistory = async (defectId: number): Promise<RepairAction[]> => {
  const { data } = await $authHost.get(`/api/defects/${defectId}/repairs`);
  return data;
};

export const addRepairAction = async (
  defectId: number,
  dto: CreateRepairActionDto
): Promise<RepairAction> => {
  const { data } = await $authHost.post(`/api/defects/${defectId}/repairs`, dto);
  return data;
};


export const markDefectRepaired = async (
  id: number,
  dto?: MarkRepairedDto
): Promise<{ message: string; defect: BoardDefect }> => {
  const { data } = await $authHost.post(`/api/defects/${id}/repaired`, dto || {});
  return data;
};

export const markDefectScrapped = async (
  id: number,
  dto?: MarkScrappedDto
): Promise<{ message: string; defect: BoardDefect }> => {
  const { data } = await $authHost.post(`/api/defects/${id}/scrap`, dto || {});
  return data;
};

export const verifyDefectRepair = async (
  id: number
): Promise<{ message: string; defect: BoardDefect }> => {
  const { data } = await $authHost.post(`/api/defects/${id}/verify`);
  return data;
};


export interface FetchStatisticsParams {
  startDate?: string;
  endDate?: string;
  boardType?: BoardType;
}

export const fetchDefectStatistics = async (
  params: FetchStatisticsParams = {}
): Promise<DefectStatistics> => {
  const searchParams = new URLSearchParams();

  if (params.startDate) searchParams.append("startDate", params.startDate);
  if (params.endDate) searchParams.append("endDate", params.endDate);
  if (params.boardType) searchParams.append("boardType", params.boardType);

  const { data } = await $authHost.get(`/api/defects/statistics?${searchParams}`);
  return data;
};

================================================================================
FILE: QMS-Client-main/src/api/elrsApi.ts
================================================================================

import { $host, $authHost } from "./index"


export const createCategoryDefect915 = async (title: string, description: string) => {
    const { data } = await $authHost.post('api/defects915', { title, description })
    return data
}
export const fetchCategoryDefect915 = async () => {
    const { data } = await $host.get('api/defects915',)
    return data
}
export const updateCategoryDefect915 = async (id: number, title: string, description: string) => {
    const { data } = await $authHost.put('api/defects915', { id, title, description })
    return data
}
export const deleteCategoryDefect915 = async (id: number) => {
    const { data } = await $authHost.delete(`api/defects915/${id}`)
    return data
}


export const createCategoryDefect24 = async (title: string, description: string) => {
    const { data } = await $authHost.post('api/defects2-4', { title, description })
    return data
}
export const fetchCategoryDefect24 = async () => {
    const { data } = await $host.get('api/defects2-4',)
    return data
}
export const updateCategoryDefect24 = async (id: number, title: string, description: string) => {
    const { data } = await $authHost.put('api/defects2-4', { id, title, description })
    return data
}
export const deleteCategoryDefect24 = async (id: number) => {
    const { data } = await $authHost.delete(`api/defects2-4/${id}`)
    return data
}


export const create915Board = async (MAC_address: string | null,
    firmware: boolean, sessionId: number, categoryDefect915Id: number, firmwareVersion: string | null) => {
    const { data } = await $authHost.post('api/ELRS915', { MAC_address, firmware, sessionId, categoryDefect915Id, firmwareVersion })
    return data
}

export const fetch915 = async (MAC_address: string | null, firmware: boolean | null, PCId: number | null, userId: number | null, categoryDefect915Id: number | null, firmwareVersion: string | null, date: string | null, limit: number, page: number) => {
    const { data } = await $host.get('api/ELRS915', {
        params: {
            MAC_address, firmware, PCId, userId, categoryDefect915Id, firmwareVersion, date, limit, page
        }
    })
    return data
}
export const createManyDefects915boards = async (count: number,
    sessionId: number, categoryDefect915Id: number) => {
    const { data } = await $authHost.post('api/ELRS915/addManyDefect915', {
        count, sessionId, categoryDefect915Id
    })
    return data
}
export const delete915byID = async (id: number) => {
    const { data } = await $authHost.delete(`api/ELRS915/byDBid/${id}`)
    return data
}

export const deleteManyDefects915boards = async (count: number, categoryDefect915Id: number) => {
    const { data } = await $authHost.post('api/ELRS915/deleteManyDefect915', {
        count, categoryDefect915Id
    })
    return data
}


export const create2_4Board = async (MAC_address: string | null,
    firmware: boolean, sessionId: number, categoryDefect24Id: number) => {
    const { data } = await $authHost.post('api/ELRS2-4', { MAC_address, firmware, sessionId, categoryDefect24Id })
    return data
}
export const fetch2_4 = async (MAC_address: string | null, firmware: boolean | null, PCId: number | null, userId: number | null, categoryDefect24Id: number | null, date: string | null, limit: number, page: number) => {
    const { data } = await $host.get('api/ELRS2-4', {
        params: {
            MAC_address, firmware, PCId, userId, categoryDefect24Id, date, limit, page
        }
    })
    return data
}
export const createManyDefects2_4boards = async (count: number,
    sessionId: number, categoryDefect24Id: number) => {
    const { data } = await $authHost.post('api/ELRS2-4/addManyDefect2-4', {
        count, sessionId, categoryDefect24Id
    })
    return data
}
export const delete2_4byID = async (id: number) => {
    const { data } = await $authHost.delete(`api/ELRS2-4/byDBid/${id}`)
    return data
}

export const deleteManyDefects2_4boards = async (count: number, categoryDefect24Id: number) => {
    const { data } = await $authHost.post('api/ELRS2-4/deleteManyDefect2-4', {
        count, categoryDefect24Id
    })
    return data
}

================================================================================
FILE: QMS-Client-main/src/api/fcApi.ts
================================================================================

import { jwtDecode } from "jwt-decode"
import { $host, $authHost } from "./index"


export const createPC = async (ip: string, pc_name: string, cabinet: string) => {
    const { data } = await $authHost.post('api/pcs', { ip, pc_name, cabinet })
    return data
}


export const fetchPC = async () => {
    const { data } = await $authHost.get('api/pcs')
    return data
}

export const updatePC = async (id: number, ip: string, pc_name: string, cabinet: string) => {
    const { data } = await $authHost.put('api/pcs', { id, ip, pc_name, cabinet })
    return data
}
export const deletePC = async (id: number) => {
    const { data } = await $authHost.delete(`api/pcs/${id}`)
    return data
}


export const setSessionOnline = async (online: boolean, userId: number, PCId: number | null) => {
    const { data } = await $authHost.put('api/sessions', { online, userId, PCId })


    if (PCId === null) {
        localStorage.setItem('pcID', 'PERSONAL');
    } else {
        localStorage.setItem('pcID', String(PCId));
    }

    localStorage.setItem('sessionID', String(data.id))
    return data
}

export const fetchSession = async () => {
    const { data } = await $authHost.get('api/sessions')
    return data
}


export const createCategoryDefect = async (title: string, description: string) => {
    const { data } = await $authHost.post('api/defectsFC', { title, description })
    return data
}
export const fetchCategoryDefect = async () => {
    const { data } = await $host.get('api/defectsFC',)
    return data
}
export const updateCategoryDefect = async (id: number, title: string, description: string) => {
    const { data } = await $authHost.put('api/defectsFC', { id, title, description })
    return data
}
export const deleteCategoryDefect = async (id: number) => {
    const { data } = await $authHost.delete(`api/defectsFC/${id}`)
    return data
}


export const fetchUsers = async () => {
    const { data } = await $authHost.get('api/users',)
    return data
}

export const check = async () => {
    const { data } = await $authHost.get('api/user/auth')
    localStorage.setItem('token', data.token)

    return jwtDecode(data.token)
}


export const createFC = async (unique_device_id: string | null,
    firmware: boolean, sessionId: number, categoryDefectId: number) => {
    const { data } = await $authHost.post('api/fcs', { unique_device_id, firmware, sessionId, categoryDefectId })
    return data
}
export const fetchFC = async (unique_device_id: string | null, firmware: boolean | null, PCId: number | null, userId: number | null, categoryDefectId: number | null, stand_test: boolean | null, startDate: string | null, endDate:string | null, limit: number, page: number) => {
    const { data } = await $host.get('api/fcs', {
        params: {
            unique_device_id, firmware, PCId, userId, categoryDefectId, stand_test, startDate, endDate, limit, page
        }
    })
    return data
}
export const createManyDefectsFC = async (count: number,
    sessionId: number, categoryDefectId: number) => {
    const { data } = await $authHost.post('api/fcs/addManyDefectFC', {
        count, sessionId, categoryDefectId
    })
    return data
}
export const deleteFCbyID = async (id: number) => {
    const { data } = await $authHost.delete(`api/fcs/byDBid/${id}`)
    return data
}

export const deleteManyDefectsFC = async (count: number, categoryDefectId: number) => {
    const { data } = await $authHost.post('api/fcs/deleteManyDefectFC', {
        count, categoryDefectId
    })
    return data
}

export const changeStandTestResult = async (unique_device_id: string, sessionId: number, stand_test: boolean) => {
    const { data } = await $authHost.put('api/fcs/update-stand-test', {
        unique_device_id, sessionId, stand_test
    })
    return data
}

================================================================================
FILE: QMS-Client-main/src/api/firmwareApi.ts
================================================================================

import axios from 'axios';


const firmwareAxios = axios.create({
  baseURL: "http://0.0.0.0:8000",
});
const miniBetaflyAxios = axios.create({
  baseURL: "http://localhost:3003",
});

const firmwareCoralB = axios.create({
  baseURL: "http://localhost:3333"
})


export const getSerialId = async (id: number, signal?: AbortSignal) => {
  const { data } = await firmwareAxios.get(`get-FC-ID/${id}`, { signal });
  return data;
};

export const uploadFont = async (id: number, signal?: AbortSignal) => {
  const { data } = await firmwareAxios.get(`upload-font/${id}`, { signal });
  return data;
};

export const startWork = async () => {
  await miniBetaflyAxios.get('startWork')
}
export const stopWork = async () => {
  await miniBetaflyAxios.get('stopWork')
}


export const getMAC915 = async (id: number, signal?: AbortSignal) => {
  const { data } = await firmwareAxios.get(`get-mac-915/${id}`, { signal });
  return data;
};
export const eraseFlash915 = async (id: number, signal?: AbortSignal) => {
  const { data } = await firmwareAxios.get(`erase-flash-915/${id}`, { signal });
  return data;
};

export const uploadFlash915_002 = async (id: number, signal?: AbortSignal) => {
  const { data } = await firmwareAxios.get(`upload-flash-915-002/${id}`, { signal });
  return data;
};
export const uploadFlash915_019 = async (id: number, signal?: AbortSignal) => {
  const { data } = await firmwareAxios.get(`upload-flash-915-019/${id}`, { signal });
  return data;
};

export const transferToMode915 = async (signal?: AbortSignal) => {
  const { data } = await firmwareAxios.get(`transfer-to-mode-915`, { signal });
  return data;
};


export const uploadFlash2_4 = async (id: number, signal?: AbortSignal) => {
  const { data } = await firmwareAxios.get(`upload-flash-2-4/${id}`, { signal });
  return data;
};


export const sendCommand = async (command: string) => {
  const { data } = await firmwareCoralB.post(`/send-command`, {command});
  return data;
}
export const checkConnection = async () => {
  const { data } = await firmwareCoralB.get(`/data`);
  return data;
};
export const fetchData = async () => {
  const { data } = await firmwareCoralB.get(`/data`);
  return data;
};
export const clearLogs = async () => {
  const { data } = await firmwareCoralB.post(`/clear-logs`);
  return data;
};

================================================================================
FILE: QMS-Client-main/src/api/firmwareControlApi.ts
================================================================================

import { $firmware_control_host } from "."

export const startCoralBFirm = async () => {
    const { data } = await $firmware_control_host.get('api/on-app',)
    return data
}
export const stopCoralBFirm = async () => {
    const { data } = await $firmware_control_host.get('api/off-app',)
    return data
}
================================================================================
FILE: QMS-Client-main/src/api/index.ts
================================================================================

import axios from 'axios';


const $host = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
});

const $authHost = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
});

const $mqttHost = axios.create({
  baseURL: import.meta.env.VITE_MQTT_API_URL,
});

const $product_components_Host = axios.create({
  baseURL: import.meta.env.VITE_PRODUCT_COMPONENT_API_URL,
});

const $firmware_control_host = axios.create({
  baseURL: import.meta.env.VITE_FIRMWARE_CONTROL,
});


const authInterceptor = (config: any) => {
  const token = localStorage.getItem('token');

  if (token && token !== "undefined" && token !== "null") {
    config.headers.authorization = `Bearer ${token}`;
  }
  return config;
};

$authHost.interceptors.request.use(authInterceptor);
$product_components_Host.interceptors.request.use(authInterceptor);

export {
  $host,
  $authHost,
  $mqttHost,
  $product_components_Host,
  $firmware_control_host
};

================================================================================
FILE: QMS-Client-main/src/api/labelTemplatesApi.ts
================================================================================

import { $authHost } from "./index";


export type LabelElementType = "TEXT" | "QR" | "LINE" | "RECTANGLE";

export interface LabelElement {
    id: string;
    type: LabelElementType;


    x: number;
    y: number;
    width: number;
    height: number;


    fontSize?: number;
    content: string;
    dataSource: "STATIC" | "VARIABLE";
    align?: "left" | "center" | "right";
    isBold?: boolean;


    strokeWidth?: number;
}


export interface LabelTemplateModel {
    id: number;
    name: string;
    width: number;
    height: number;
    layout: LabelElement[];
    createdAt?: string;
}


export const fetchLabelTemplates = async () => {


    return new Promise<LabelTemplateModel[]>((resolve) => {
        const stored = localStorage.getItem("db_label_templates_mock");
        resolve(stored ? JSON.parse(stored) : []);
    });
};


export const createLabelTemplate = async (name: string, width: number, height: number, layout: LabelElement[]) => {


    const stored = JSON.parse(localStorage.getItem("db_label_templates_mock") || "[]");

    const newTemplate: LabelTemplateModel = {
        id: Date.now(),
        name,
        width,
        height,
        layout,
        createdAt: new Date().toISOString()
    };

    localStorage.setItem("db_label_templates_mock", JSON.stringify([...stored, newTemplate]));
    return newTemplate;
};


export const deleteLabelTemplate = async (id: number) => {


    const stored = JSON.parse(localStorage.getItem("db_label_templates_mock") || "[]");
    const filtered = stored.filter((t: LabelTemplateModel) => t.id !== id);
    localStorage.setItem("db_label_templates_mock", JSON.stringify(filtered));
};

================================================================================
FILE: QMS-Client-main/src/api/mqttApi.ts
================================================================================

import { $mqttHost } from "./index";


export const mqttGetStatus = async () => {
    try {
        const { data } = await $mqttHost.get(`status`);
        return data;
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:", error);
        return [];
    }
};

export const startTestFC = async (id: string) => {
    const { data } = await $mqttHost.get(`startTest/${id}`)
    return data
}

export const reloadTestFC = async (id: string) => {
    const { data } = await $mqttHost.get(`reload/${id}`)
    return data
}


export const mqttGetStatusESC = async () => {
    try {
        const { data } = await $mqttHost.get(`statusESC`);
        return data;
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:", error);
        return [];
    }
};

export const startTestESC = async (id: string) => {
    const { data } = await $mqttHost.get(`startTestESC/${id}`)
    return data
}

export const reloadTestESC = async (id: string) => {
    const { data } = await $mqttHost.get(`reloadESC/${id}`)
    return data
}

================================================================================
FILE: QMS-Client-main/src/api/passportsExportApi.ts
================================================================================



import { $authHost } from "./index";

const BASE_URL = "api/beryll/export/passports";


export interface ExportOptions {
  serverIds?: number[];
  batchId?: number | string | null;
  status?: string;
  dateFrom?: string;
  dateTo?: string;
  search?: string;
  includeArchived?: boolean;
}

export interface ComponentsSummary {
  total: number;
  hdd: number;
  ssd: number;
  ram: number;
  psu: number;
  motherboard: number;
  bmc: number;
  nic: number;
  raid: number;
}

export interface ServerPreview {
  id: number;
  apkSerialNumber: string;
  serialNumber?: string;
  status: string;
  batchName: string | null;
  createdAt: string;
  componentsSummary: ComponentsSummary;
  completeness: number;
}

export interface MissingComponent {
  serverId: number;
  apkSerialNumber: string;
  missing: string[];
}

export interface ExportStats {
  totalServers: number;
  totalComponents: number;
  byComponentType: Record<string, number>;
  byBatch: Record<string, number>;
  byStatus: Record<string, number>;
  missingComponents: MissingComponent[];
}

export interface PreviewResponse {
  success: boolean;
  total: number;
  showing: number;
  preview: ServerPreview[];
}

export interface StatsResponse {
  success: boolean;
  stats: ExportStats;
}


export async function exportPassports(options: ExportOptions = {}): Promise<Blob> {
  const response = await $authHost.post(BASE_URL, options, {
    responseType: "blob"
  });
  return response.data;
}


export async function getExportStats(options: ExportOptions = {}): Promise<StatsResponse> {
  const params: Record<string, string> = {};

  if (options.batchId !== undefined && options.batchId !== null) {
    params.batchId = String(options.batchId);
  }
  if (options.status) params.status = options.status;
  if (options.dateFrom) params.dateFrom = options.dateFrom;
  if (options.dateTo) params.dateTo = options.dateTo;
  if (options.search) params.search = options.search;
  if (options.includeArchived) params.includeArchived = "true";

  const { data } = await $authHost.get<StatsResponse>(`${BASE_URL}/stats`, { params });
  return data;
}


export async function getExportPreview(
  options: ExportOptions = {},
  limit = 10
): Promise<PreviewResponse> {
  const params: Record<string, string | number> = { limit };

  if (options.batchId !== undefined && options.batchId !== null) {
    params.batchId = String(options.batchId);
  }
  if (options.status) params.status = options.status;
  if (options.dateFrom) params.dateFrom = options.dateFrom;
  if (options.dateTo) params.dateTo = options.dateTo;
  if (options.search) params.search = options.search;
  if (options.includeArchived) params.includeArchived = "true";

  const { data } = await $authHost.get<PreviewResponse>(`${BASE_URL}/preview`, { params });
  return data;
}


export async function exportSinglePassport(serverId: number): Promise<Blob> {
  const response = await $authHost.get(`${BASE_URL}/single/${serverId}`, {
    responseType: "blob"
  });
  return response.data;
}


export async function exportSelectedPassports(serverIds: number[]): Promise<Blob> {
  const response = await $authHost.post(
    `${BASE_URL}/selected`,
    { serverIds },
    { responseType: "blob" }
  );
  return response.data;
}


export async function exportBatchPassports(batchId: number | string): Promise<Blob> {
  const response = await $authHost.get(`${BASE_URL}/batch/${batchId}`, {
    responseType: "blob"
  });
  return response.data;
}


export function downloadBlob(blob: Blob, filename: string): void {
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.setAttribute("download", filename);
  document.body.appendChild(link);
  link.click();
  link.remove();
  window.URL.revokeObjectURL(url);
}


export function generateFilename(options: {
  prefix?: string;
  batchId?: number | string | null;
  status?: string;
  count?: number;
}): string {
  const timestamp = new Date().toISOString().split("T")[0];
  let filename = options.prefix || "–°–æ—Å—Ç–∞–≤_—Å–µ—Ä–≤–µ—Ä–æ–≤";

  if (options.batchId) {
    filename += options.batchId === "null"
      ? "_–±–µ–∑_–ø–∞—Ä—Ç–∏–∏"
      : `_–ø–∞—Ä—Ç–∏—è_${options.batchId}`;
  }

  if (options.status) {
    filename += `_${options.status}`;
  }

  if (options.count) {
    filename += `_${options.count}—à—Ç`;
  }

  filename += `_${timestamp}.xlsx`;

  return filename;
}


export async function exportAndDownload(
  options: ExportOptions = {},
  filenameOptions?: Parameters<typeof generateFilename>[0]
): Promise<void> {
  const blob = await exportPassports(options);
  const filename = generateFilename(filenameOptions || {});
  downloadBlob(blob, filename);
}


export async function exportSelectedAndDownload(serverIds: number[]): Promise<void> {
  const blob = await exportSelectedPassports(serverIds);
  const filename = generateFilename({
    prefix: "–°–æ—Å—Ç–∞–≤_—Å–µ—Ä–≤–µ—Ä–æ–≤_–≤—ã–±—Ä–∞–Ω–Ω—ã–µ",
    count: serverIds.length
  });
  downloadBlob(blob, filename);
}


export async function exportBatchAndDownload(batchId: number | string): Promise<void> {
  const blob = await exportBatchPassports(batchId);
  const filename = generateFilename({ batchId });
  downloadBlob(blob, filename);
}

export default {
  exportPassports,
  getExportStats,
  getExportPreview,
  exportSinglePassport,
  exportSelectedPassports,
  exportBatchPassports,
  downloadBlob,
  generateFilename,
  exportAndDownload,
  exportSelectedAndDownload,
  exportBatchAndDownload
};

================================================================================
FILE: QMS-Client-main/src/api/product_componentApi.ts
================================================================================

import { $product_components_Host } from ".";


export const createStatus = async (title: string) => {
    const { data } = await $product_components_Host.post('api/product_statuses', { title })
    return data;
}
export const fetchStatuses = async () => {
    const { data } = await $product_components_Host.get('api/product_statuses')
    return data
}
export const fetchStatusById = async (id: number) => {
    const { data } = await $product_components_Host.get(`api/product_statuses/${id}`)
    return data
}
export const updateStatus = async (id: number, title: string) => {
    const { data } = await $product_components_Host.put(`api/product_statuses/${id}`, { title })
    return data
}
export const deleteStatus = async (id: number) => {
    const { data } = await $product_components_Host.delete(`api/product_statuses/${id}`)
    return data
}


export const createComponentRef = async (title: string, article: string, quantity: number) => {
    const { data } = await $product_components_Host.post('api/reference/components', { title, article, quantity })
    return data;
}
export const fetchComponentsRef = async () => {
    const { data } = await $product_components_Host.get('api/reference/components')
    return data;
}
export const fetchComponentRefById = async (id: number) => {
    const { data } = await $product_components_Host.get(`api/reference/components/${id}`)
    return data;
}
export const updateComponentRef = async (id: number, title: string, article: string, quantity: number) => {
    const { data } = await $product_components_Host.put(`api/reference/components/${id}`, { title, article, quantity })
    return data;
}
export const deleteComponentRef = async (id: number) => {
    const { data } = await $product_components_Host.delete(`api/reference/components/${id}`)
    return data;
}

export const updateComponentRefImg = async (id: number, file: FormData) => {
    const { data } = await $product_components_Host.put(`api/component_image/${id}`, file)
    return data
}
export const deleteComponentRefImg = async (id: number) => {
    const { data } = await $product_components_Host.get(`api/component_image/${id}`)
    return data
}


export const createComponent = async (title: string, article: string, quantity: number) => {
    const { data } = await $product_components_Host.post('api/components', { title, article, quantity })
    return data;
}
export const fetchComponents = async () => {
    const { data } = await $product_components_Host.get('api/components')
    return data;
}
export const fetchComponentById = async (id: number) => {
    const { data } = await $product_components_Host.get(`api/components/${id}`)
    return data;
}
export const updateComponent = async (id: number, title: string, article: string, quantity: number) => {
    const { data } = await $product_components_Host.put(`api/components/${id}`, { title, article, quantity })
    return data;
}
export const deleteComponent = async (id: number) => {
    const { data } = await $product_components_Host.delete(`api/components/${id}`)
    return data;
}


export const createProduct = async (title: string, status_id: number) => {
    const { data } = await $product_components_Host.post('api/products', { title, status_id })
    return data;
}
export const fetchProducts = async () => {
    const { data } = await $product_components_Host.get('api/products')
    return data;
}
export const fetchProductById = async (id: number) => {
    const { data } = await $product_components_Host.get(`api/products/${id}`)
    return data;
}
export const updateProduct = async (id: number, title: string, status_id: number) => {
    const { data } = await $product_components_Host.put(`api/products/${id}`, { title, status_id })
    return data;
}
export const deleteProduct = async (id: number) => {
    const { data } = await $product_components_Host.delete(`api/products/${id}`)
    return data;
}


export const createProductReference = async (title: string, status_id: number) => {
    const { data } = await $product_components_Host.post('api/reference/products', { title, status_id })
    return data;
}
export const fetchProductsReference = async () => {
    const { data } = await $product_components_Host.get('api/reference/products')
    return data;
}
export const fetchProductReferenceById = async (id: number) => {
    const { data } = await $product_components_Host.get(`api/reference/products/${id}`)
    return data;
}
export const updateProductReference = async (id: number, title: string, status_id: number) => {
    const { data } = await $product_components_Host.put(`api/reference/products/${id}`, { title, status_id })
    return data;
}
export const deleteProductReference = async (id: number) => {
    const { data } = await $product_components_Host.delete(`api/reference/products/${id}`)
    return data;
}


export const createProd_Comp = async (component_id: number, product_id: number, required_quantity: number) => {
    const { data } = await $product_components_Host.post('api/product_components', { component_id, product_id, required_quantity })
    return data;
}
export const fetchProd_Comp = async (product_id: number | null) => {
    const { data } = await $product_components_Host.get('api/product_components', {
        params: { product_id }
    })
    return data;
}
export const fetchProd_CompById = async (id: number) => {
    const { data } = await $product_components_Host.get(`api/product_components/${id}`)
    return data;
}

export const updateProd_Comp = async (id: number, component_id: number, product_id: number, required_quantity: number) => {
    const { data } = await $product_components_Host.put(`api/product_components/${id}`, { component_id, product_id, required_quantity })
    return data;
}
export const deleteProd_Comp = async (id: number) => {
    const { data } = await $product_components_Host.delete(`api/product_components/${id}`)
    return data;
}
export const deleteProd_Comp_ByProductId = async (product_id: number | null) => {
    const { data } = await $product_components_Host.delete('api/product_components', {
        params: { product_id }
    })
    return data;
}

================================================================================
FILE: QMS-Client-main/src/api/productionApi.ts
================================================================================



import { $authHost } from "./index";


export interface OperationType {
    id: number;
    name: string;
    code: string | null;
    description: string | null;
    unit: string;
    normMinutes: number | null;
    sectionId: number | null;
    section?: { id: number; title: string } | null;
    isActive: boolean;
    sortOrder: number;
}

export interface ProductionOutput {
    id: number;
    date: string;
    userId: number;
    teamId: number | null;
    sectionId: number | null;
    projectId: number | null;
    taskId: number | null;
    operationTypeId: number | null;
    claimedQty: number;
    approvedQty: number;
    rejectedQty: number;
    status: 'pending' | 'approved' | 'rejected' | 'adjusted';
    approvedById: number | null;
    approvedAt: string | null;
    createdById: number | null;
    comment: string | null;
    rejectReason: string | null;


    user?: { id: number; name: string; surname: string; img?: string };
    approvedBy?: { id: number; name: string; surname: string };
    createdBy?: { id: number; name: string; surname: string };
    operationType?: { id: number; name: string; code: string; unit: string };
    team?: { id: number; title: string };
    section?: { id: number; title: string };
    project?: { id: number; title: string };
    task?: { id: number; title: string };
}

export interface OutputsListResponse {
    rows: ProductionOutput[];
    count: number;
    page: number;
    limit: number;
    totalPages: number;
}

export interface TeamMember {
    id: number;
    name: string;
    surname: string;
    img?: string;
    teamId: number | null;
    team?: { id: number; title: string };
}

export interface MatrixUser {
    userId: number;
    name: string;
    surname: string;
    days: Record<string, number>;
    total: number;
}

export interface MatrixResponse {
    period: { dateFrom: string; dateTo: string };
    dates: string[];
    matrix: MatrixUser[];
}


export const fetchOperationTypes = async (params?: {
    includeInactive?: boolean;
    sectionId?: number
}): Promise<OperationType[]> => {
    const { data } = await $authHost.get("api/production/operation-types", { params });
    return data;
};

export const createOperationType = async (payload: {
    name: string;
    code?: string;
    description?: string;
    unit?: string;
    normMinutes?: number;
    sectionId?: number;
    sortOrder?: number;
}): Promise<OperationType> => {
    const { data } = await $authHost.post("api/production/operation-types", payload);
    return data;
};

export const updateOperationType = async (
    id: number,
    payload: Partial<OperationType>
): Promise<OperationType> => {
    const { data } = await $authHost.put(`api/production/operation-types/${id}`, payload);
    return data;
};

export const deleteOperationType = async (id: number): Promise<{ message: string; deleted?: boolean; deactivated?: boolean }> => {
    const { data } = await $authHost.delete(`api/production/operation-types/${id}`);
    return data;
};


export const fetchOutputs = async (params?: {
    page?: number;
    limit?: number;
    userId?: number;
    teamId?: number;
    sectionId?: number;
    projectId?: number;
    taskId?: number;
    operationTypeId?: number;
    status?: string;
    dateFrom?: string;
    dateTo?: string;
}): Promise<OutputsListResponse> => {
    const { data } = await $authHost.get("api/production/outputs", { params });
    return data;
};

export const fetchOutputById = async (id: number): Promise<ProductionOutput> => {
    const { data } = await $authHost.get(`api/production/outputs/${id}`);
    return data;
};

export const createOutput = async (payload: {
    date: string;
    userId: number;
    projectId?: number | null;
    taskId?: number | null;
    operationTypeId?: number | null;
    claimedQty: number;
    comment?: string;
}): Promise<ProductionOutput> => {
    const { data } = await $authHost.post("api/production/outputs", payload);
    return data;
};

export const updateOutput = async (id: number, payload: {
    date?: string;
    projectId?: number | null;
    taskId?: number | null;
    operationTypeId?: number | null;
    claimedQty?: number;
    comment?: string;
}): Promise<ProductionOutput> => {
    const { data } = await $authHost.put(`api/production/outputs/${id}`, payload);
    return data;
};

export const deleteOutput = async (id: number): Promise<{ message: string }> => {
    const { data } = await $authHost.delete(`api/production/outputs/${id}`);
    return data;
};


export const fetchPendingOutputs = async (params?: {
    teamId?: number;
    sectionId?: number;
    dateFrom?: string;
    dateTo?: string;
}): Promise<ProductionOutput[]> => {
    const { data } = await $authHost.get("api/production/pending", { params });
    return data;
};

export const approveOutputs = async (
    ids: number[],
    adjustments?: Record<number, number>
): Promise<{ results: Array<{ id: number; status?: string; approvedQty?: number; error?: string }> }> => {
    const { data } = await $authHost.post("api/production/approve", { ids, adjustments });
    return data;
};

export const rejectOutputs = async (
    ids: number[],
    reason?: string
): Promise<{ results: Array<{ id: number; status?: string; error?: string }> }> => {
    const { data } = await $authHost.post("api/production/reject", { ids, reason });
    return data;
};


export const fetchUserSummary = async (userId: number, params?: {
    dateFrom?: string;
    dateTo?: string;
}): Promise<{
    userId: number;
    period: { dateFrom: string; dateTo: string };
    stats: Array<{ status: string; totalClaimed: number; totalApproved: number; recordCount: number }>;
    byOperation: Array<{ operationTypeId: number; total: number; operationType?: { name: string; code: string; unit: string } }>;
    byDay: Array<{ date: string; total: number }>;
}> => {
    const { data } = await $authHost.get(`api/production/summary/${userId}`, { params });
    return data;
};

export const fetchMatrix = async (params?: {
    teamId?: number;
    sectionId?: number;
    projectId?: number;
    operationTypeId?: number;
    dateFrom?: string;
    dateTo?: string;
}): Promise<MatrixResponse> => {
    const { data } = await $authHost.get("api/production/matrix", { params });
    return data;
};


export const fetchMyTeamMembers = async (): Promise<TeamMember[]> => {
    const { data } = await $authHost.get("api/production/my-team");
    return data;
};


export const OUTPUT_STATUS_LABELS: Record<string, string> = {
    pending: '–û–∂–∏–¥–∞–µ—Ç',
    approved: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
    rejected: '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ',
    adjusted: '–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ'
};

export const OUTPUT_STATUS_COLORS: Record<string, string> = {
    pending: 'bg-yellow-100 text-yellow-800',
    approved: 'bg-green-100 text-green-800',
    rejected: 'bg-red-100 text-red-800',
    adjusted: 'bg-blue-100 text-blue-800'
};

export const formatUserName = (user?: { name: string; surname: string } | null): string => {
    if (!user) return '‚Äî';
    return `${user.surname} ${user.name?.[0] || ''}.`;
};

export const formatDate = (dateStr: string): string => {
    const d = new Date(dateStr);
    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
};

export const formatShortDate = (dateStr: string): string => {
    const d = new Date(dateStr);
    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
};

export const getDayOfWeek = (dateStr: string): string => {
    const d = new Date(dateStr);
    return d.toLocaleDateString('ru-RU', { weekday: 'short' });
};

================================================================================
FILE: QMS-Client-main/src/api/projectsApi.ts
================================================================================

import { $authHost } from "./index";

export interface ProjectModel {
    id: number;
    title: string;
    description: string;
    status: string;
    createdAt: string;
    author?: { name: string; surname: string };
}

export const fetchProjects = async () => {
    const { data } = await $authHost.get("api/projects");
    return data as ProjectModel[];
};

export const createProject = async (title: string, description: string) => {
    const { data } = await $authHost.post("api/projects", { title, description });
    return data;
};

export const deleteProject = async (id: number) => {
    await $authHost.delete(`api/projects/${id}`);
};
================================================================================
FILE: QMS-Client-main/src/api/rankingsApi.ts
================================================================================

import { $authHost } from "./index";


export type Period = "day" | "week" | "month" | "year" | "all" | "custom";


export interface SparklinePoint {
  date: string;
  value: number;
}


export interface DailyChange {
  change: number;
  percent: number;
  today: number;
  yesterday: number;
}

export interface RankingUser {
  id: number;
  name: string;
  surname: string;
  avatar: string | null;

  teamName: string;
  teamId: number | null;
  sectionName: string;
  sectionId: number | null;
  teamLeadName: string;

  warehouseOutput: number;
  productionOutput: number;

  output: number;
  defects: number;
  efficiency: number;
  place: number;


  sparkline: SparklinePoint[];
  dailyChange: DailyChange;
}

export interface RankingTeam {
  id: number;
  title: string;
  section: string;
  sectionId: number | null;
  teamLead: string;

  totalOutput: number;
  warehouseOutput: number;
  productionOutput: number;
  avgEfficiency: number;
  membersCount: number;
  progress: number;
  sparkline: SparklinePoint[];
}

export interface RankingSection {
  id: number;
  title: string;
  totalOutput: number;
  teamsCount: number;
  membersCount: number;
  avgOutput: number;
  sparkline: SparklinePoint[];
}

export interface RankingTotals {
  totalOutput: number;
  warehouseOutput: number;
  productionOutput: number;
  totalDefects: number;
  usersCount: number;
  teamsCount: number;
  sectionsCount: number;
}

export interface RankingResponse {
  users: RankingUser[];
  teams: RankingTeam[];
  sections: RankingSection[];
  totals: RankingTotals;
  period: string;
  projectId: number | null;
  projectName: string | null;
  startDate: string;
  endDate: string;
}

export interface UserDailyStats {
  date: string;
  warehouse: number;
  production: number;
  total: number;
}

export interface UserDetailsResponse {
  user: {
    id: number;
    name: string;
    surname: string;
    avatar: string | null;
    team: string | null;
    section: string | null;
  };
  period: string;
  projectId: number | null;
  projectName: string | null;
  startDate: string;
  endDate: string;
  dailyStats: UserDailyStats[];
  byOperation: {
    operation: string;
    code: string;
    total: number;
  }[];
  totals: {
    warehouse: number;
    production: number;
    total: number;
  };
}

export interface RankingsParams {
  period?: Period;
  startDate?: string;
  endDate?: string;
  projectId?: string | number;
}


export const fetchRankings = async (
  params: RankingsParams | Period = "week"
): Promise<RankingResponse> => {
  const queryParams: RankingsParams = typeof params === "string"
    ? { period: params }
    : params;

  const { data } = await $authHost.get("/api/warehouse/rankings", {
    params: queryParams
  });
  return data;
};


export const fetchUserRankingDetails = async (
  userId: number,
  params: RankingsParams | Period = "week"
): Promise<UserDetailsResponse> => {
  const queryParams: RankingsParams = typeof params === "string"
    ? { period: params }
    : params;

  const { data } = await $authHost.get(`/api/warehouse/rankings/user/${userId}`, {
    params: queryParams
  });
  return data;
};


export const fetchRankingsHistory = async (
  userId: number,
  periods: number = 7
): Promise<{ date: string; output: number }[]> => {
  const { data } = await $authHost.get(`/api/warehouse/rankings/history/${userId}`, {
    params: { periods }
  });
  return data;
};

================================================================================
FILE: QMS-Client-main/src/api/rbacApi.ts
================================================================================

import { $authHost } from "./index";

export interface AbilityModel {
    id: number;
    code: string;
    description: string;
}

export interface RoleModel {
    id: number;
    name: string;
    description: string;
    abilities: AbilityModel[];
}

export const fetchAllRoles = async () => {
    const { data } = await $authHost.get("api/rbac/roles");
    return data as RoleModel[];
};

export const fetchAllAbilities = async () => {
    const { data } = await $authHost.get("api/rbac/abilities");
    return data as AbilityModel[];
};

export const updateRoleAbilities = async (roleId: number, abilityIds: number[]) => {
    const { data } = await $authHost.post(`api/rbac/role/${roleId}`, { abilityIds });
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/structureApi.ts
================================================================================

import { $authHost } from "src/api";
import { userGetModel } from "src/types/UserModel";

export const fetchStructure = async () => {
    const { data } = await $authHost.get("api/structure");
    return data;
};


export const fetchUnassignedUsers = async () => {
    const { data } = await $authHost.get("api/structure/users/unassigned");
    return data as userGetModel[];
};

export const createSection = async (title: string) => {
    const { data } = await $authHost.post("api/structure/section", { title });
    return data;
};

export const createTeam = async (title: string, sectionId: number) => {
    const { data } = await $authHost.post("api/structure/team", { title, sectionId });
    return data;
};

export const assignSectionManager = async (sectionId: number, userId: number) => {
    const { data } = await $authHost.put("api/structure/section/manager", { sectionId, userId });
    return data;
};

export const assignTeamLead = async (teamId: number, userId: number) => {
    const { data } = await $authHost.put("api/structure/team/lead", { teamId, userId });
    return data;
};

export const addUserToTeam = async (teamId: number, userId: number) => {
    const { data } = await $authHost.put("api/structure/user/assign", { teamId, userId });
    return data;
};

export const removeUserFromTeam = async (userId: number) => {
    const { data } = await $authHost.put("api/structure/user/remove", { userId });
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/tasksApi.ts
================================================================================

import { $authHost } from "./index";
import { InventoryBoxModel } from "src/types/WarehouseModels";

export interface TaskStats {
  total: number;
  done: number;
  inWork: number;
  onStock: number;
}

export interface ProductionTask {
  id: number;
  title: string;
  originType?: string | null;
  originId?: number | null;
  targetQty: number;
  unit: string;
  dueDate?: string | null;
  status: string;
  priority?: number | null;
  comment?: string | null;

  responsibleId?: number | null;
  sectionId?: number | null;
  projectId?: number | null;

  responsible?: { id: number; name: string; surname: string } | null;
  targetSection?: { id: number; title: string } | null;
  project?: { id: number; title: string } | null;

  stats?: TaskStats;
  progressPercent?: number;
}

export interface TaskListResponse {
  rows: ProductionTask[];
  count: number;
  page: number;
  limit: number;
}

export interface TaskBreakdownItem {
  status: string;
  sectionId: number | null;
  sectionTitle: string | null;
  qty: number;
}

export interface TaskDetailResponse {
  task: ProductionTask;
  totalQty: number;
  breakdown: TaskBreakdownItem[];
  boxes: InventoryBoxModel[];
}

export const createTask = async (payload: {
  title: string;
  originType?: string;
  originId?: number;
  targetQty: number;
  unit: string;
  dueDate?: string;
  priority?: number;
  comment?: string;
  responsibleId?: number;
  sectionId?: number;
  projectId?: number;
}) => {
  const { data } = await $authHost.post("api/tasks", payload);
  return data as ProductionTask;
};

export const fetchTasks = async (params?: {
  page?: number;
  limit?: number;
  status?: string;
  search?: string;
  originType?: string;
}) => {
  const { data } = await $authHost.get("api/tasks", { params });
  return data as TaskListResponse;
};

export const fetchTaskById = async (id: number) => {
  const { data } = await $authHost.get(`api/tasks/${id}`);
  return data as TaskDetailResponse;
};

export const updateTaskStatus = async (id: number, status: string) => {
  const { data } = await $authHost.patch(`api/tasks/${id}/status`, { status });
  return data as ProductionTask;
};

export const updateTask = async (id: number, payload: any) => {
    const { data } = await $authHost.put(`api/tasks/${id}`, payload);
    return data as ProductionTask;
};

export const deleteTask = async (id: number) => {
    const { data } = await $authHost.delete(`api/tasks/${id}`);
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/userApi.ts
================================================================================

import { $authHost, $host } from "./index"
import { userModel } from "src/types/UserModel"

export const login = async (login: string, password: string) => {
    const { data } = await $host.post("api/users/login", { login, password })
    localStorage.setItem("token", data.token)
    return data
}

export const registration = async (login: string, password: string, name: string, surname: string) => {
    const { data } = await $host.post("api/users/registration", { login, password, name, surname })
    localStorage.setItem("token", data.token)
    return data
}

export const check = async () => {
    const { data } = await $authHost.get("api/users/auth")
    if (data && data.id) {
        localStorage.setItem("userID", String(data.id))
    }
    return data as userModel
}

export const fetchCurrentUser = async (id: number) => {
    const { data } = await $authHost.get(`api/users/${id}`)
    return data
}

export const updateUser = async (id: number, password: string, name: string, surname: string) => {
    const { data } = await $authHost.put("api/users", { id, password, name, surname })
    return data
}

export const updateUserImg = async (idAndImg: FormData) => {
    const { data } = await $authHost.patch("api/users", idAndImg)
    return data
}

export const deleteUser = async (id: number) => {
    const { data } = await $authHost.delete(`api/users/${id}`)
    return data
}

export const getUsers = async () => {
    const { data } = await $authHost.get("api/users")
    return data
}
================================================================================
FILE: QMS-Client-main/src/api/warehouseApi.ts
================================================================================

import { $authHost } from "./index";
import {
  SupplyModel,
  InventoryBoxModel,
  WarehouseMovement,
  WarehouseDocument,
  StockBalanceItem
} from "src/types/WarehouseModels";

export interface SupplyCreateDto {
  supplier?: string;
  docNumber?: string;
  expectedDate?: string;
  comment?: string;
}

export interface BoxCreateDto {
  supplyId: number;
  sectionId: number;
  itemName: string;
  quantity: number;
  unit: string;
  kitNumber?: string;
  comment?: string;
}

export interface CreateBoxesBatchPayload {
  label: string;
  projectName?: string;
  batchName?: string;
  originType?: string;
  originId?: number | null;
  quantity: number;
  itemsPerBox: number;
  unit: string;
  status?: string;
  currentSectionId?: number | null;
  currentTeamId?: number | null;
  notes?: string;
}

export interface FetchBoxesParams {
  page?: number;
  limit?: number;
  search?: string;
  batchName?: string;
  projectName?: string;
  originType?: string;
  status?: string;
  sectionId?: number;
  teamId?: number;
  supplyId?: number;
}

export interface MoveBoxPayload {
  boxId: number;
  toSectionId?: number | null;
  toTeamId?: number | null;
  operation: string;
  statusAfter?: string;
  comment?: string;
  goodQty?: number;
  scrapQty?: number;
  deltaQty?: number;
}

export interface BatchMovePayload {
    movements: Array<{
        boxId: number;
        operation: string;
        toSectionId?: number | null;
        toTeamId?: number | null;
        statusAfter?: string;
        deltaQty?: number;
        goodQty?: number;
        scrapQty?: number;
        comment?: string;
    }>;
    documentData?: {
        createNew: boolean;
        number?: string;
        type?: string;
        comment?: string;
        documentId?: number;
    };
}

export interface FetchDocumentsParams {
  page?: number;
  limit?: number;
  search?: string;
  type?: string;
  boxId?: number;
  dateFrom?: string;
  dateTo?: string;
}

export interface CreateDocumentPayload {
  boxId?: number | null;
  number: string;
  type?: string;
  date?: string;
  fileUrl?: string;
  comment?: string;
}

export interface InventoryLimitModel {
    id: number;
    label: string;
    originType?: string;
    originId?: number;
    minQuantity: number;
}

export interface StockAlertModel {
    id: number;
    label: string;
    min: number;
    current: number;
    deficit: number;
}

export interface RankingResponse {
    users: {
        id: number;
        name: string;
        surname: string;
        teamName: string;
        avatar: string | null;
        output: number;
        defects: number;
        efficiency: number;
        place: number;
    }[];
    teams: {
        id: number;
        title: string;
        section: string;
        teamLead: string;
        totalOutput: number;
        avgEfficiency: number;
        progress: number;
        membersCount: number;
    }[];
}


export const createSupply = async (data: SupplyCreateDto): Promise<SupplyModel> => {
  const { data: response } = await $authHost.post('api/warehouse/supplies', data);
  return response;
};

export const fetchSupplies = async (): Promise<SupplyModel[]> => {
  const { data } = await $authHost.get('api/warehouse/supplies');
  return data;
};

export const createBox = async (data: BoxCreateDto): Promise<InventoryBoxModel> => {
  const { data: response } = await $authHost.post('api/warehouse/boxes/single', data);
  return response;
};

export const createBoxesBatch = async (payload: CreateBoxesBatchPayload) => {
  const { data } = await $authHost.post("api/warehouse/boxes/batch", payload);
  return data as { boxes: InventoryBoxModel[] };
};

export const updateBoxesBatch = async (ids: number[], updates: Partial<InventoryBoxModel>) => {
    const { data } = await $authHost.put("api/warehouse/boxes/batch", { ids, updates });
    return data;
};

export const fetchBoxes = async (params: FetchBoxesParams): Promise<any> => {
  const { data } = await $authHost.get("api/warehouse/boxes", { params });
  if (Array.isArray(data)) return data;
  return data as { rows: InventoryBoxModel[]; count: number; page: number; limit: number };
};

export const fetchBoxById = async (id: number) => {
  const { data } = await $authHost.get(`api/warehouse/boxes/${id}`);
  return data as {
    box: InventoryBoxModel;
    movements: WarehouseMovement[];
    documents: WarehouseDocument[];
  };
};

export const fetchBoxByQr = async (qrCode: string) => {
  const encoded = encodeURIComponent(qrCode);
  const { data } = await $authHost.get(`api/warehouse/boxes/by-qr/${encoded}`);
  return data as {
    box: InventoryBoxModel;
    movements: WarehouseMovement[];
    documents: WarehouseDocument[];
  };
};


export const fetchStockBalance = async () => {
    const { data } = await $authHost.get("api/warehouse/balance");
    return data as StockBalanceItem[];
};


export const fetchDashboardStats = async () => {
    const { data } = await $authHost.get("api/warehouse/analytics/dashboard");
    return data;
};

export const fetchAlerts = async () => {
    const { data } = await $authHost.get("api/warehouse/alerts");
    return data as StockAlertModel[];
};

export const fetchAllLimits = async () => {
    const { data } = await $authHost.get("api/warehouse/limits");
    return data as InventoryLimitModel[];
};

export const saveLimit = async (payload: { label: string, min: number, originType?: string, originId?: number }) => {
    const { data } = await $authHost.post("api/warehouse/limits", payload);
    return data;
};


export const moveBox = async (payload: MoveBoxPayload) => {
  const { data } = await $authHost.post("api/warehouse/movements", payload);
  return data as { box: InventoryBoxModel; movement: WarehouseMovement };
};

export const moveBoxesBatch = async (payload: BatchMovePayload) => {
    const { data } = await $authHost.post("api/warehouse/movements/batch", payload);
    return data;
};


export const downloadBoxesExcel = async (ids: number[]) => {
  const { data } = await $authHost.post(
    "api/warehouse/boxes/export",
    { ids },
    { responseType: 'blob' }
  );
  const url = window.URL.createObjectURL(new Blob([data]));
  const link = document.createElement('a');
  link.href = url;
  const date = new Date().toISOString().split('T')[0];
  link.setAttribute('download', `labels_export_${date}.csv`);
  document.body.appendChild(link); link.click(); link.remove();
};

export const printBoxesPdf = async (ids: number[]) => {
  const { data } = await $authHost.post(
    "api/warehouse/boxes/print-pdf",
    { ids },
    { responseType: 'blob' }
  );
  const url = window.URL.createObjectURL(new Blob([data], { type: 'application/pdf' }));
  const link = document.createElement('a');
  link.href = url;
  const date = new Date().toISOString().split('T')[0];
  link.setAttribute('download', `labels_print_${date}.pdf`);
  document.body.appendChild(link); link.click(); link.remove();
};

export const printSpecialLabel = async (data: any) => {
  const response = await $authHost.post("api/warehouse/boxes/print-special", data, {
    responseType: 'blob'
  });

  const url = window.URL.createObjectURL(new Blob([response.data], { type: 'application/pdf' }));

  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = url;
  document.body.appendChild(iframe);

  iframe.onload = () => {
      iframe.contentWindow?.print();
  };
};


export const fetchPrintHistory = async (params: {
    page?: number;
    limit?: number;
    search?: string;
    template?: string;
    dateFrom?: string;
    dateTo?: string;
}) => {
    const { data } = await $authHost.get("api/warehouse/print-history", { params });
    return data as { rows: any[]; count: number; page: number; limit: number };
};


export const fetchDocuments = async (params: FetchDocumentsParams) => {
  const { data } = await $authHost.get("api/warehouse/documents", { params });
  return data as { rows: WarehouseDocument[]; count: number; page: number; limit: number };
};

export const createDocument = async (payload: CreateDocumentPayload) => {
  const { data } = await $authHost.post("api/warehouse/documents", payload);
  return data as WarehouseDocument;
};

export const exportLabelsCsv = async (supplyId: number): Promise<Blob> => {
  const { data } = await $authHost.get(`api/warehouse/supplies/${supplyId}/export-csv`, {
    responseType: 'blob',
  });
  return data;
};

export const fetchRankings = async (period: 'day' | 'week' | 'month') => {
    const { data } = await $authHost.get("api/warehouse/rankings", {
        params: { period }
    });
    return data as RankingResponse;
};

================================================================================
FILE: QMS-Client-main/src/components/AppRouter.tsx
================================================================================

import { useContext } from "react";
import { Navigate, Route, Routes, useLocation } from "react-router-dom";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import { adminRoutes, authRoutes, publicRoutes } from "src/routes";
import { START_ROUTE } from "src/utils/consts";

export const AppRouter: React.FC = observer(() => {
  const context = useContext(Context);
  const location = useLocation();

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { user } = context;

  return (


    <div key={location.pathname} className="animate-slide-in-up w-full h-full">
      <Routes>


        {user.isAuth && user.can('admin.access') &&
          adminRoutes.map(({ path, Component }) => {


              if (path.includes('/users') && !user.can('users.manage')) return null;


              if (path.includes('/warehouse') && !user.can('warehouse.manage')) return null;

              return <Route key={path} path={path} element={<Component />} />;
          })
        }


        {user.isAuth &&
          authRoutes.map(({ path, Component }) => {


              if (path.includes('/warehouse') && !user.can('warehouse.view')) return null;


              if (path.includes('/firmware') && !user.can('firmware.flash')) return null;


              if (path.includes('/assembly') && !user.can('assembly.execute')) return null;


              if (path.includes('/beryll') && !user.can('beryll.view')) return null;


              if ((path.includes('/flight-controller') || path.includes('/elrs') || path.includes('/coral'))
                  && !user.can('devices.view')) return null;


              if (path.includes('/rankings') && !user.can('analytics.view')) return null;

              return <Route key={path} path={path} element={<Component />} />;
          })
        }


        {publicRoutes.map(({ path, Component }) => (
          <Route key={path} path={path} element={<Component />} />
        ))}


        <Route path="*" element={<Navigate to={START_ROUTE} />} />
      </Routes>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/components/DefectExportButton.tsx
================================================================================



import React, { useState, useRef, useEffect } from "react";
import { Download, ChevronDown, FileSpreadsheet, BarChart3, Loader2 } from "lucide-react";
import toast from "react-hot-toast";
import {
    downloadDefectsExcel,
    downloadDefectStatsExcel,
    DefectExportParams
} from "../../../api/beryll/defectExportApi";

interface Props {

    currentFilters?: DefectExportParams;

    className?: string;
}

const DefectExportButton: React.FC<Props> = ({ currentFilters, className = "" }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [loading, setLoading] = useState<string | null>(null);
    const dropdownRef = useRef<HTMLDivElement>(null);


    useEffect(() => {
        const handleClickOutside = (event: MouseEvent) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
                setIsOpen(false);
            }
        };

        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleExportAll = async () => {
        setLoading("all");
        try {
            await downloadDefectsExcel({});
            toast.success("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω");
        } catch (error: any) {
            console.error("Export error:", error);
            toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞");
        } finally {
            setLoading(null);
            setIsOpen(false);
        }
    };

    const handleExportFiltered = async () => {
        if (!currentFilters) {
            toast.error("–§–∏–ª—å—Ç—Ä—ã –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã");
            return;
        }

        setLoading("filtered");
        try {
            await downloadDefectsExcel(currentFilters);
            toast.success("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω");
        } catch (error: any) {
            console.error("Export error:", error);
            toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞");
        } finally {
            setLoading(null);
            setIsOpen(false);
        }
    };

    const handleExportStats = async () => {
        setLoading("stats");
        try {
            await downloadDefectStatsExcel();
            toast.success("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞");
        } catch (error: any) {
            console.error("Export error:", error);
            toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞");
        } finally {
            setLoading(null);
            setIsOpen(false);
        }
    };

    const hasFilters = currentFilters && (
        currentFilters.status ||
        currentFilters.dateFrom ||
        currentFilters.dateTo ||
        currentFilters.serverId ||
        currentFilters.search
    );

    return (
        <div className={`relative ${className}`} ref={dropdownRef}>

            <button
                onClick={() => setIsOpen(!isOpen)}
                disabled={!!loading}
                className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg
                           hover:bg-green-700 transition-colors disabled:opacity-50"
            >
                {loading ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                ) : (
                    <Download className="w-4 h-4" />
                )}
                <span>–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</span>
                <ChevronDown className={`w-4 h-4 transition-transform ${isOpen ? "rotate-180" : ""}`} />
            </button>


            {isOpen && (
                <div className="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg
                                border border-gray-200 py-1 z-50">

                    <button
                        onClick={handleExportAll}
                        disabled={!!loading}
                        className="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50
                                   text-left transition-colors disabled:opacity-50"
                    >
                        <FileSpreadsheet className="w-5 h-5 text-green-600" />
                        <div>
                            <div className="font-medium text-gray-900">–í—Å–µ –∑–∞–ø–∏—Å–∏</div>
                            <div className="text-xs text-gray-500">–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤</div>
                        </div>
                        {loading === "all" && <Loader2 className="w-4 h-4 animate-spin ml-auto" />}
                    </button>


                    <button
                        onClick={handleExportFiltered}
                        disabled={!!loading || !hasFilters}
                        className={`w-full flex items-center gap-3 px-4 py-3 text-left
                                    transition-colors disabled:opacity-50
                                    ${hasFilters ? "hover:bg-gray-50" : "cursor-not-allowed"}`}
                    >
                        <FileSpreadsheet className="w-5 h-5 text-blue-600" />
                        <div>
                            <div className="font-medium text-gray-900">–° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏</div>
                            <div className="text-xs text-gray-500">
                                {hasFilters
                                    ? "–¢–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏"
                                    : "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã"}
                            </div>
                        </div>
                        {loading === "filtered" && <Loader2 className="w-4 h-4 animate-spin ml-auto" />}
                    </button>

                    <div className="border-t border-gray-200 my-1" />


                    <button
                        onClick={handleExportStats}
                        disabled={!!loading}
                        className="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50
                                   text-left transition-colors disabled:opacity-50"
                    >
                        <BarChart3 className="w-5 h-5 text-purple-600" />
                        <div>
                            <div className="font-medium text-gray-900">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                            <div className="text-xs text-gray-500">–°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∏ —Ç–∏–ø–∞–º</div>
                        </div>
                        {loading === "stats" && <Loader2 className="w-4 h-4 animate-spin ml-auto" />}
                    </button>
                </div>
            )}
        </div>
    );
};

export default DefectExportButton;

================================================================================
FILE: QMS-Client-main/src/components/Footer/Footer.tsx
================================================================================

import Logo from "assets/images/logo.svg";
import PhoneIcon from "assets/icons/Phone.svg";
import MailIcon from "assets/icons/mail.svg";
import LogoVK from "assets/icons/logoVK.svg";
import LogoYT from "assets/icons/logoYOUT.svg";

export const Footer: React.FC = () => {
  return (
    <div className="flex justify-between items-center px-8 py-4 bg-white text-gray-800">
      <div className="flex items-center">
        <img src={Logo} alt="Logo" className="h-6 mr-2" />
        <div>
          <div>¬© 2018-2025 –ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç</div>
        </div>
      </div>

      <div className="flex flex-col items-center">
        <div className="flex items-center mb-1">
          <img src={PhoneIcon} alt="Phone" className="h-4 mr-2" />
          <div>+7 (499) 455 04 13</div>
        </div>
        <div className="flex items-center">
          <img src={MailIcon} alt="Mail" className="h-4 mr-2" />
          <div>office.npk@kryptonite.ru</div>
        </div>
      </div>

      <div className="flex items-center">
        <img src={LogoVK} alt="VK" className="h-8 mr-4" />
        <img src={LogoYT} alt="YouTube" className="h-8" />
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/Header/DateTimeDisplay.tsx
================================================================================

import { useState, useEffect } from 'react';

export const DateTimeDisplay = () => {
  const [currentTime, setCurrentTime] = useState(new Date());

  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);

    return () => clearInterval(timer);
  }, []);


  const formatDate = (date: Date) => {
    return date.toLocaleDateString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  };

  const formatTime = (date: Date) => {
    return date.toLocaleTimeString('ru-RU', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
  };

  return (
    <div className="flex flex-col items-end justify-center">
      <div className="text-xl font-semibold text-emerald-700 tracking-wide">
        {formatDate(currentTime)}
      </div>
      <div className="text-sm text-gray-600 font-medium bg-emerald-50 px-2 py-1 rounded-md">
        {formatTime(currentTime)}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/Header/Header.tsx
================================================================================


import React, { useContext, Fragment, useState, useEffect, useRef } from "react";
import Logo from "assets/images/logo.svg";
import { NavLink, useLocation } from "react-router-dom";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import { useAuth } from "react-oidc-context";
import { Menu, Transition } from "@headlessui/react";
import { setSessionOnline } from "src/api/fcApi";
import { DateTimeDisplay } from "./DateTimeDisplay";
import clsx from "clsx";


import {
  Shield, KeySquare, Database, BookText, Archive,
  ClipboardList, Package, Wrench, User, LogOut,
  ChevronDown, PackageCheck, Cpu, Radio, Activity,
  BarChart3, Trophy, PieChart, MonitorPlay, FileText,
  Menu as MenuIcon, CircuitBoard, LineChart,
  Server,
  AlertTriangle,
  Factory
} from "lucide-react";


import {
  ADMIN_ROUTE, INPUT_DEFECT_ROUTE, ASSEMBLED_PRODUCTS_ROUTE,
  FC_ROUTE, ELRS_915_ROUTE, ELRS_2_4_ROUTE, CORAL_B_ROUTE,
  KNOWLEDGE_BASE_ROUTE, ANALYTICS_DASHBOARD_ROUTE, RANKINGS_ROUTE,
  WAREHOUSE_ROUTE, TASKS_ROUTE, RECIPE_EXECUTION_ROUTE,
  RECIPE_CONSTRUCTOR_ROUTE, ASSEMBLY_ROUTE, ADMIN_ASSEMBLY_ROUTES_ROUTE,
  FIRMWARE_OLD_ROUTE, FIRMWARE_FC_ROUTE, FIRMWARE_915_002_ROUTE,
  FIRMWARE_915_019_ROUTE, FIRMWARE_2_4_ROUTE, FIRMWARE_Coral_B_ROUTE,
  MQTT_CHECK_FC_ROUTE, MQTT_CHECK_ESC_ROUTE, PROFILE_ROUTE, RANKINGS_CHARTS_ROUTE,
  BERYLL_ROUTE,
  BERYLL_MONITORING_ROUTE,
  BERYLL_REVISIONS_ROUTE,
  DEFECTS_ROUTE,
  PRODUCTION_ROUTE
} from "src/utils/consts";

type NavItem = {
  label: string;
  icon: React.ElementType;
  to?: string;
  permissions?: string[];
  children?: { label: string; to: string; icon?: React.ElementType }[];
};


export const HEADER_HEIGHT = 56;

export const Header: React.FC = observer(() => {
  const auth = useAuth();
  const context = useContext(Context);
  const location = useLocation();

  if (!context) throw new Error("Context required");
  const { user } = context;


  const [isVisible, setIsVisible] = useState(true);
  const [isAtTop, setIsAtTop] = useState(true);
  const lastScrollY = useRef(0);
  const scrollThreshold = 10;

  useEffect(() => {
    const handleScroll = () => {
      const currentScrollY = window.scrollY;


      setIsAtTop(currentScrollY < 5);


      const scrollDiff = currentScrollY - lastScrollY.current;

      if (Math.abs(scrollDiff) < scrollThreshold) {
        return;
      }

      if (scrollDiff > 0 && currentScrollY > HEADER_HEIGHT) {

        setIsVisible(false);
      } else {

        setIsVisible(true);
      }

      lastScrollY.current = currentScrollY;
    };

    window.addEventListener("scroll", handleScroll, { passive: true });
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);


  const logOut = async () => {
    try {
      const userId = Number(localStorage.getItem("userID"));
      const pcId = localStorage.getItem("pcID");
      const pcIdNum = pcId === "PERSONAL" ? null : Number(pcId);
      if (userId) await setSessionOnline(false, userId, pcIdNum);
    } catch (error) { console.error(error); }

    user.resetUser();
    localStorage.clear();
    sessionStorage.clear();
    await auth.signoutRedirect({ post_logout_redirect_uri: window.location.origin });
  };


  const navigation: NavItem[] = [

    {
      label: "–ó–∞–¥–∞—á–∏",
      icon: ClipboardList,
      to: TASKS_ROUTE,
    },
    {
      label: "–°–∫–ª–∞–¥",
      icon: Archive,
      to: WAREHOUSE_ROUTE,
      permissions: ["warehouse.view"]
    },
    {
      label: "–°–±–æ—Ä–∫–∞",
      icon: Package,
      permissions: ["assembly.execute", "recipe.manage"],
      children: [
        { label: "–¢–µ—Ä–º–∏–Ω–∞–ª –°–±–æ—Ä–∫–∏", to: RECIPE_EXECUTION_ROUTE, icon: MonitorPlay },
        { label: "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¢–ö", to: RECIPE_CONSTRUCTOR_ROUTE, icon: FileText },
        { label: "–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ (Legacy)", to: ASSEMBLY_ROUTE, icon: Wrench },
        { label: "–ú–∞—Ä—à—Ä—É—Ç—ã (Legacy)", to: ADMIN_ASSEMBLY_ROUTES_ROUTE, icon: Wrench },
      ]
    },


    {
      label: "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ",
      icon: Factory,
      to: PRODUCTION_ROUTE,
    },


    {
      label: "–ê–ü–ö –ë–µ—Ä–∏–ª–ª",
      icon: Server,
      permissions: ["beryll.view"],
      children: [
        { label: "–°–µ—Ä–≤–µ—Ä—ã", to: BERYLL_ROUTE, icon: Server },
        { label: "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥", to: BERYLL_MONITORING_ROUTE, icon: Activity },
        { label: "–†–µ–≤–∏–∑–∏–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö", to: BERYLL_REVISIONS_ROUTE, icon: CircuitBoard },
      ]
    },


    {
      label: "–£—á—ë—Ç –±—Ä–∞–∫–∞",
      icon: AlertTriangle,
      to: DEFECTS_ROUTE,
      permissions: ["defect.manage", "defect.view"]
    },


    {
      label: "–ò–Ω–∂–µ–Ω–µ—Ä–∏—è",
      icon: CircuitBoard,
      permissions: ["firmware.flash", "devices.view", "defect.manage"],
      children: [

        { label: "–ü—Ä–æ—à–∏–≤–∫–∞ FC", to: FIRMWARE_FC_ROUTE, icon: Cpu },
        { label: "–ü—Ä–æ—à–∏–≤–∫–∞ ELRS", to: FIRMWARE_915_019_ROUTE, icon: Radio },
        { label: "–ü—Ä–æ—à–∏–≤–∫–∞ Coral", to: FIRMWARE_Coral_B_ROUTE, icon: Activity },

        { label: "–¢–µ—Å—Ç FC (–°—Ç–µ–Ω–¥)", to: MQTT_CHECK_FC_ROUTE, icon: Activity },
        { label: "–¢–µ—Å—Ç ESC (–°—Ç–µ–Ω–¥)", to: MQTT_CHECK_ESC_ROUTE, icon: Activity },

        { label: "–ë–î: –ò–∑–¥–µ–ª–∏—è", to: ASSEMBLED_PRODUCTS_ROUTE, icon: PackageCheck },
        { label: "–ë–î: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã", to: FC_ROUTE, icon: Database },

        { label: "–í–≤–æ–¥ –±—Ä–∞–∫–∞", to: INPUT_DEFECT_ROUTE, icon: KeySquare },
      ]
    },


    {
      label: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞",
      icon: PieChart,
      permissions: ["analytics.view"],
      children: [
        { label: "–î–∞—à–±–æ—Ä–¥—ã", to: ANALYTICS_DASHBOARD_ROUTE, icon: BarChart3 },
        { label: "–ì—Ä–∞—Ñ–∏–∫–∏ –¥–∏–Ω–∞–º–∏–∫–∏", to: RANKINGS_CHARTS_ROUTE, icon: LineChart },
        { label: "–†–µ–π—Ç–∏–Ω–≥ (KPI)", to: RANKINGS_ROUTE, icon: Trophy },
      ]
    },


    {
      label: "–ê–¥–º–∏–Ω",
      icon: Shield,
      to: ADMIN_ROUTE,
      permissions: ["admin.access"]
    },
  ];


  const visibleNav = navigation.filter(item => {
      if (!item.permissions) return true;
      return item.permissions.some(p => user.can(p));
  });

  return (
    <div
      className={clsx(
        "fixed top-0 left-0 right-0 z-50 h-14",
        "bg-white/95 backdrop-blur-sm border-b border-gray-200 shadow-sm",
        "transition-transform duration-300 ease-in-out",

        !isVisible && "-translate-y-full",

        isAtTop && "shadow-none"
      )}
    >
      <div className="max-w-[1920px] mx-auto px-4 h-full flex justify-between items-center">


        <div className="flex items-center gap-6 min-w-max">
          <NavLink to="/" className="flex items-center gap-2 group">
            <img src={Logo} alt="Logo" className="h-7 w-auto group-hover:opacity-80 transition-opacity" />
            <span className="text-lg font-bold text-slate-800 tracking-tight leading-none">
              MES <span className="text-emerald-600">Kryptonit</span>
            </span>
          </NavLink>

          <div className="h-6 w-px bg-gray-200 hidden lg:block"></div>
        </div>


        {auth.isAuthenticated && (
          <nav className="hidden lg:flex items-center gap-1">
            {visibleNav.map((item, idx) => (
              <Fragment key={idx}>
                {item.children ? (
                  <Menu as="div" className="relative">
                    <Menu.Button className={({ open }) => clsx(
                        "flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all outline-none",
                        open ? "bg-slate-100 text-slate-900" : "text-slate-600 hover:bg-slate-50 hover:text-slate-900"
                    )}>
                      <item.icon size={16} />
                      <span>{item.label}</span>
                      <ChevronDown size={12} className="opacity-50" />
                    </Menu.Button>
                    <Transition
                      as={Fragment}
                      enter="transition ease-[cubic-bezier(0.16,1,0.3,1)] duration-200"
                      enterFrom="transform opacity-0 scale-95 -translate-y-2"
                      enterTo="transform opacity-100 scale-100 translate-y-0"
                      leave="transition ease-in duration-150"
                      leaveFrom="transform opacity-100 scale-100 translate-y-0"
                      leaveTo="transform opacity-0 scale-95 -translate-y-2"
                    >
                      <Menu.Items className="absolute left-0 mt-2 w-56 origin-top-left divide-y divide-gray-100 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                        <div className="p-1">
                          {item.children.map((sub, sIdx) => (
                            <Menu.Item key={sIdx}>
                              {({ active }) => (
                                <NavLink
                                  to={sub.to}
                                  className={clsx(
                                    "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm",
                                    active ? "bg-slate-100 text-indigo-700 font-medium" : "text-slate-700 hover:bg-slate-50"
                                  )}
                                >
                                  {sub.icon && <sub.icon size={14} className={active ? "text-indigo-600" : "text-slate-400"} />}
                                  {sub.label}
                                </NavLink>
                              )}
                            </Menu.Item>
                          ))}
                        </div>
                      </Menu.Items>
                    </Transition>
                  </Menu>
                ) : (
                  <NavLink
                    to={item.to!}
                    className={({ isActive }) => clsx(
                        "flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all",
                        isActive
                          ? "bg-slate-100 text-indigo-700 font-bold"
                          : "text-slate-600 hover:bg-slate-50 hover:text-slate-900"
                    )}
                  >
                    <item.icon size={16} />
                    <span>{item.label}</span>
                  </NavLink>
                )}
              </Fragment>
            ))}
          </nav>
        )}


        <div className="flex items-center gap-4 min-w-max">

          <NavLink to={KNOWLEDGE_BASE_ROUTE} title="–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π" className="p-2 text-slate-400 hover:text-indigo-600 transition">
             <BookText size={20}/>
          </NavLink>

          <div className="hidden xl:block text-right">
             <DateTimeDisplay />
          </div>

          {auth.isAuthenticated ? (
            <Menu as="div" className="relative ml-2">
                <Menu.Button className="flex items-center gap-2 pl-2 pr-1 py-1 rounded-full hover:bg-slate-100 transition border border-transparent hover:border-slate-200 group outline-none">
                    <div className="flex flex-col items-end leading-none mr-1">
                        <span className="text-xs font-bold text-slate-700">{user.user?.surname} {user.user?.name?.[0]}.</span>
                        <span className="text-[10px] text-slate-400">{user.user?.role}</span>
                    </div>
                    <div className="h-8 w-8 rounded-full bg-slate-200 overflow-hidden ring-2 ring-white shadow-sm">
                         {user.user?.img
                            ? <img src={`${import.meta.env.VITE_API_URL}/${user.user.img}`} alt="" className="h-full w-full object-cover"/>
                            : <div className="h-full w-full flex items-center justify-center text-slate-500 font-bold text-xs">{user.user?.name?.[0]}</div>
                         }
                    </div>
                </Menu.Button>

                <Transition
                  as={Fragment}
                  enter="transition ease-out duration-100"
                  enterFrom="transform opacity-0 scale-95"
                  enterTo="transform opacity-100 scale-100"
                  leave="transition ease-in duration-75"
                  leaveFrom="transform opacity-100 scale-100"
                  leaveTo="transform opacity-0 scale-95"
                >
                  <Menu.Items className="absolute right-0 mt-2 w-48 origin-top-right divide-y divide-gray-100 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                    <div className="p-1">
                      <Menu.Item>
                        {({ active }) => (
                          <NavLink
                            to={PROFILE_ROUTE}
                            className={clsx(
                              "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm",
                              active ? "bg-slate-100 text-indigo-700" : "text-slate-700"
                            )}
                          >
                            <User size={14} />
                            –ü—Ä–æ—Ñ–∏–ª—å
                          </NavLink>
                        )}
                      </Menu.Item>
                    </div>
                    <div className="p-1">
                      <Menu.Item>
                        {({ active }) => (
                          <button
                            onClick={logOut}
                            className={clsx(
                              "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm",
                              active ? "bg-red-50 text-red-700" : "text-slate-700"
                            )}
                          >
                            <LogOut size={14} />
                            –í—ã–π—Ç–∏
                          </button>
                        )}
                      </Menu.Item>
                    </div>
                  </Menu.Items>
                </Transition>
            </Menu>
          ) : null}
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/components/Modal/ConfirmModal.tsx
================================================================================

import React from "react";

interface ConfirmModalProps {
  isOpen: boolean;
  title?: string;
  message?: string;
  onConfirm: () => void;
  onCancel: () => void;
  confirmText?: string;
  cancelText?: string;
  confirmColor?: "red" | "green" | "blue";
}

export const ConfirmModal: React.FC<ConfirmModalProps> = ({
  isOpen,
  title = "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
  message = "–í—ã —É–≤–µ—Ä–µ–Ω—ã?",
  onConfirm,
  onCancel,
  confirmText = "‚úÖ –î–ê",
  cancelText = "‚ùå –û—Ç–º–µ–Ω–∞",
  confirmColor = "green"
}) => {
  if (!isOpen) return null;

  const confirmColorClasses = {
    red: "bg-red-600 hover:bg-red-700",
    green: "bg-emerald-600 hover:bg-emerald-700",
    blue: "bg-blue-600 hover:bg-blue-700"
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">

      <div
        className="absolute inset-0 bg-black/50"
        onClick={onCancel}
      />


      <div className="relative bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
        <div className="flex flex-col items-center justify-center text-center">
          {title && (
            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
          )}
          {message && (
            <p className="text-gray-600 mt-2">{message}</p>
          )}
          <div className="flex justify-center gap-4 mt-6 w-full">
            <button
              type="button"
              className={`flex-1 ${confirmColorClasses[confirmColor]} text-white py-3 rounded-lg transition font-semibold shadow-lg`}
              onClick={onConfirm}
            >
              {confirmText}
            </button>
            <button
              type="button"
              className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg"
              onClick={onCancel}
            >
              {cancelText}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ConfirmModal;

================================================================================
FILE: QMS-Client-main/src/components/Modal/Modal.tsx
================================================================================


import React, { useEffect } from "react";

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
  title?: string;
}

export const Modal: React.FC<ModalProps> = ({ isOpen, onClose, children, title }) => {

  useEffect(() => {
    if (!isOpen) return;

    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === "Escape") {
        onClose();
      }
    };

    document.addEventListener("keydown", handleKeyDown);


    document.body.style.overflow = "hidden";

    return () => {
      document.removeEventListener("keydown", handleKeyDown);
      document.body.style.overflow = "";
    };
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      onClick={onClose}
    >
      <div
        className="bg-white rounded-lg p-6 w-full max-w-lg relative max-h-[90vh] overflow-y-auto"
        onClick={(e) => e.stopPropagation()}
      >
        <button
          className="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl"
          onClick={onClose}
        >
          &times;
        </button>

        {title && (
          <h2 className="text-xl font-semibold mb-4 pr-8">{title}</h2>
        )}

        {children}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/RepairPartTypeSelect.tsx
================================================================================



import React, { useState, useEffect, useRef } from "react";
import { ChevronDown, Plus, X, Check, Loader2, Search } from "lucide-react";
import toast from "react-hot-toast";
import { getPartTypes, quickAddPartType, RepairPartType } from "../../api/repairPartTypeApi";

interface Props {
  value: string;
  onChange: (value: string, type?: RepairPartType) => void;
  placeholder?: string;
  disabled?: boolean;
  className?: string;
  error?: string;
}

const RepairPartTypeSelect: React.FC<Props> = ({
  value,
  onChange,
  placeholder = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ—Ç–∞–ª–∏",
  disabled = false,
  className = "",
  error
}) => {
  const [types, setTypes] = useState<RepairPartType[]>([]);
  const [loading, setLoading] = useState(true);
  const [isOpen, setIsOpen] = useState(false);
  const [search, setSearch] = useState("");
  const [showAddModal, setShowAddModal] = useState(false);
  const [newTypeLabel, setNewTypeLabel] = useState("");
  const [adding, setAdding] = useState(false);

  const containerRef = useRef<HTMLDivElement>(null);
  const searchRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    loadTypes();
  }, []);

  useEffect(() => {
    if (isOpen && searchRef.current) {
      setTimeout(() => searchRef.current?.focus(), 100);
    }
  }, [isOpen]);

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
        setIsOpen(false);
        setSearch("");
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const loadTypes = async () => {
    try {
      setLoading(true);
      const data = await getPartTypes();
      setTypes(data);
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤:", err);
    } finally {
      setLoading(false);
    }
  };

  const handleAddType = async () => {
    if (!newTypeLabel.trim()) return;

    try {
      setAdding(true);
      const result = await quickAddPartType(newTypeLabel.trim());

      if (result.created) {
        toast.success(`–¢–∏–ø "${result.type.label}" —Å–æ–∑–¥–∞–Ω`);
      }

      setTypes(prev => [...prev, result.type]);
      onChange(result.type.value, result.type);
      setShowAddModal(false);
      setNewTypeLabel("");
      setIsOpen(false);
    } catch (err: any) {
      toast.error(err.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setAdding(false);
    }
  };

  const handleSelect = (type: RepairPartType) => {
    onChange(type.value, type);
    setIsOpen(false);
    setSearch("");
  };

  const filtered = types.filter(t =>
    t.label.toLowerCase().includes(search.toLowerCase()) ||
    t.value.toLowerCase().includes(search.toLowerCase())
  );

  const selected = types.find(t => t.value === value);

  return (
    <div ref={containerRef} className={`relative ${className}`}>

      <button
        type="button"
        onClick={() => !disabled && setIsOpen(!isOpen)}
        disabled={disabled}
        className={`
          w-full px-3 py-2 text-left border rounded-lg text-sm
          flex items-center justify-between gap-2 transition-all
          ${disabled ? "bg-gray-100 cursor-not-allowed" : "bg-white hover:border-gray-400"}
          ${error ? "border-red-300" : "border-gray-300"}
          ${isOpen ? "ring-2 ring-blue-200 border-blue-400" : ""}
        `}
      >
        <span className={selected ? "text-gray-800" : "text-gray-400"}>
          {loading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : selected?.label || placeholder}
        </span>
        <ChevronDown size={18} className={`text-gray-400 transition-transform ${isOpen ? "rotate-180" : ""}`} />
      </button>

      {error && <p className="mt-1 text-xs text-red-500">{error}</p>}


      {isOpen && (
        <div className="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg overflow-hidden">

          <div className="p-2 border-b">
            <div className="relative">
              <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
              <input
                ref={searchRef}
                type="text"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                placeholder="–ü–æ–∏—Å–∫..."
                className="w-full pl-9 pr-3 py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200"
              />
            </div>
          </div>


          <div className="max-h-60 overflow-y-auto">
            {filtered.length > 0 ? (
              filtered.map(type => (
                <button
                  key={type.value}
                  type="button"
                  onClick={() => handleSelect(type)}
                  className={`
                    w-full px-3 py-2 text-left text-sm flex items-center justify-between
                    hover:bg-gray-50 ${type.value === value ? "bg-blue-50" : ""}
                  `}
                >
                  <span className={type.value === value ? "text-blue-700 font-medium" : ""}>
                    {type.label}
                  </span>
                  {type.value === value && <Check size={16} className="text-blue-600" />}
                </button>
              ))
            ) : (
              <div className="px-3 py-4 text-center text-sm text-gray-500">
                {search ? `"${search}" –Ω–µ –Ω–∞–π–¥–µ–Ω` : "–ù–µ—Ç —Ç–∏–ø–æ–≤"}
              </div>
            )}
          </div>


          <div className="p-2 border-t">
            <button
              type="button"
              onClick={() => {
                setShowAddModal(true);
                setNewTypeLabel(search);
              }}
              className="w-full px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg flex items-center justify-center gap-2"
            >
              <Plus size={16} />
              –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø
            </button>
          </div>
        </div>
      )}


      {showAddModal && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 p-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold">–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –¥–µ—Ç–∞–ª–∏</h3>
              <button onClick={() => setShowAddModal(false)} className="p-1 hover:bg-gray-100 rounded">
                <X size={20} />
              </button>
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
              <input
                type="text"
                value={newTypeLabel}
                onChange={(e) => setNewTypeLabel(e.target.value)}
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–∏—Ç–∞–Ω–∏—è"
                autoFocus
                onKeyDown={(e) => e.key === "Enter" && handleAddType()}
                className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200"
              />
            </div>

            <div className="flex gap-2">
              <button
                onClick={() => setShowAddModal(false)}
                className="flex-1 py-2 border rounded-lg hover:bg-gray-50"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleAddType}
                disabled={adding || !newTypeLabel.trim()}
                className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center gap-2"
              >
                {adding ? <Loader2 size={16} className="animate-spin" /> : <Plus size={16} />}
                –î–æ–±–∞–≤–∏—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default RepairPartTypeSelect;

================================================================================
FILE: QMS-Client-main/src/components/beryll/BMCSyncPanel.tsx
================================================================================

import React, { useState, useCallback } from 'react';
import {
  AlertTriangle,
  RefreshCw,
  Check,
  X,
  Server,
  HardDrive,
  Cpu,
  MemoryStick,
  Plus,
  Minus,
  ArrowLeftRight,
  ChevronDown,
  ChevronUp
} from 'lucide-react';
import { toast } from 'react-toastify';
import { $authHost } from '../../http';

interface ComponentDifference {
  field: string;
  db: string | null;
  bmc: string | null;
}

interface ComparisonMismatch {
  dbComponent: ServerComponent;
  bmcComponent: BMCComponent;
  differences: ComponentDifference[];
}

interface ComparisonMissing {
  dbComponent: ServerComponent;
  isManual: boolean;
  reason: string;
}

interface ComparisonNew {
  bmcComponent: BMCComponent;
  reason: string;
}

interface ComparisonResult {
  success: boolean;
  hasDiscrepancies: boolean;
  mode: string;
  summary: {
    total: { inDb: number; inBmc: number };
    matched: number;
    missingInBmc: number;
    newInBmc: number;
    mismatches: number;
  };
  details: {
    matched: { dbComponent: ServerComponent; bmcComponent: BMCComponent }[];
    missingInBmc: ComparisonMissing[];
    newInBmc: ComparisonNew[];
    mismatches: ComparisonMismatch[];
  };
  message?: string;
}

interface ServerComponent {
  id: number;
  componentType: string;
  name: string;
  serialNumber: string | null;
  model: string | null;
  slot: string | null;
  status: string;
  dataSource: string;
  bmcDiscrepancy?: boolean;
  bmcDiscrepancyReason?: string;
}

interface BMCComponent {
  componentType: string;
  name?: string;
  serialNumber: string | null;
  model: string | null;
  slot: string | null;
  status: string;
  manufacturer?: string;
}

interface BMCSyncPanelProps {
  serverId: number;
  onSyncComplete: () => void;
}

const COMPONENT_ICONS: Record<string, React.ReactNode> = {
  CPU: <Cpu className="w-4 h-4" />,
  RAM: <MemoryStick className="w-4 h-4" />,
  HDD: <HardDrive className="w-4 h-4" />,
  SSD: <HardDrive className="w-4 h-4" />,
  default: <Server className="w-4 h-4" />
};

const getComponentIcon = (type: string) => {
  return COMPONENT_ICONS[type] || COMPONENT_ICONS.default;
};

export const BMCSyncPanel: React.FC<BMCSyncPanelProps> = ({ serverId, onSyncComplete }) => {
  const [loading, setLoading] = useState(false);
  const [comparison, setComparison] = useState<ComparisonResult | null>(null);
  const [expanded, setExpanded] = useState({
    missingInBmc: true,
    newInBmc: true,
    mismatches: true,
    matched: false
  });


  const handleCompare = useCallback(async () => {
    setLoading(true);
    try {
      const { data } = await $authHost.post(`/api/beryll/servers/${serverId}/components/fetch`, {
        mode: 'compare'
      });
      setComparison(data);

      if (data.hasDiscrepancies) {
        toast.warning(`–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è —Å BMC`);
      } else {
        toast.success('–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ');
      }
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å BMC');
    } finally {
      setLoading(false);
    }
  }, [serverId]);


  const handleForceSync = useCallback(async (preserveManual: boolean) => {
    if (!confirm(preserveManual
      ? '–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å BMC? –í—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.'
      : '–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –í–°–ï –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å BMC? –í–∫–ª—é—á–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é!')) {
      return;
    }

    setLoading(true);
    try {
      const { data } = await $authHost.post(`/api/beryll/servers/${serverId}/components/fetch`, {
        mode: 'force',
        preserveManual
      });
      toast.success(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${data.components?.length || 0} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤`);
      setComparison(null);
      onSyncComplete();
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
    } finally {
      setLoading(false);
    }
  }, [serverId, onSyncComplete]);


  const handleMerge = useCallback(async () => {
    setLoading(true);
    try {
      const { data } = await $authHost.post(`/api/beryll/servers/${serverId}/components/fetch`, {
        mode: 'merge'
      });

      const { actions } = data;
      toast.success(
        `–°–ª–∏—è–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${actions.updated.length}, –¥–æ–±–∞–≤–ª–µ–Ω–æ ${actions.added.length}`
      );

      if (actions.flaggedForReview.length > 0) {
        toast.warning(`${actions.flaggedForReview.length} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç(–æ–≤) —Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏`);
      }

      setComparison(null);
      onSyncComplete();
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ —Å–ª–∏—è–Ω–∏—è');
    } finally {
      setLoading(false);
    }
  }, [serverId, onSyncComplete]);

  const toggleSection = (section: keyof typeof expanded) => {
    setExpanded(prev => ({ ...prev, [section]: !prev[section] }));
  };

  return (
    <div className="bg-white rounded-lg border border-gray-200 p-4">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-medium flex items-center gap-2">
          <Server className="w-5 h-5 text-blue-600" />
          –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å BMC
        </h3>

        <button
          onClick={handleCompare}
          disabled={loading}
          className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
        >
          <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
          –°—Ä–∞–≤–Ω–∏—Ç—å —Å BMC
        </button>
      </div>

      {comparison && (
        <div className="space-y-4">

          <div className={`p-3 rounded-lg ${comparison.hasDiscrepancies ? 'bg-amber-50 border border-amber-200' : 'bg-green-50 border border-green-200'}`}>
            <div className="flex items-center gap-2 mb-2">
              {comparison.hasDiscrepancies ? (
                <AlertTriangle className="w-5 h-5 text-amber-600" />
              ) : (
                <Check className="w-5 h-5 text-green-600" />
              )}
              <span className="font-medium">
                {comparison.hasDiscrepancies ? '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è' : '–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã'}
              </span>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
              <div className="bg-white/50 rounded p-2">
                <div className="text-gray-500">–í –ë–î</div>
                <div className="font-medium">{comparison.summary.total.inDb}</div>
              </div>
              <div className="bg-white/50 rounded p-2">
                <div className="text-gray-500">–í BMC</div>
                <div className="font-medium">{comparison.summary.total.inBmc}</div>
              </div>
              <div className="bg-white/50 rounded p-2">
                <div className="text-gray-500">–°–æ–≤–ø–∞–¥–∞—é—Ç</div>
                <div className="font-medium text-green-600">{comparison.summary.matched}</div>
              </div>
              <div className="bg-white/50 rounded p-2">
                <div className="text-gray-500">–ù–µ—Ç –≤ BMC</div>
                <div className="font-medium text-amber-600">{comparison.summary.missingInBmc}</div>
              </div>
              <div className="bg-white/50 rounded p-2">
                <div className="text-gray-500">–ù–æ–≤—ã–µ –≤ BMC</div>
                <div className="font-medium text-blue-600">{comparison.summary.newInBmc}</div>
              </div>
            </div>
          </div>


          {comparison.details.missingInBmc.length > 0 && (
            <div className="border border-amber-200 rounded-lg">
              <button
                onClick={() => toggleSection('missingInBmc')}
                className="w-full flex items-center justify-between p-3 bg-amber-50 rounded-t-lg"
              >
                <span className="flex items-center gap-2 font-medium text-amber-800">
                  <Minus className="w-4 h-4" />
                  –ù–µ—Ç –≤ BMC ({comparison.details.missingInBmc.length})
                </span>
                {expanded.missingInBmc ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
              </button>

              {expanded.missingInBmc && (
                <div className="p-3 space-y-2">
                  {comparison.details.missingInBmc.map((item, idx) => (
                    <div key={idx} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                      <div className="flex items-center gap-2">
                        {getComponentIcon(item.dbComponent.componentType)}
                        <div>
                          <div className="font-medium">{item.dbComponent.name}</div>
                          <div className="text-xs text-gray-500">
                            S/N: {item.dbComponent.serialNumber || '–Ω/–¥'} | {item.reason}
                          </div>
                        </div>
                      </div>
                      {item.isManual && (
                        <span className="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded">
                          –†—É—á–Ω–æ–π –≤–≤–æ–¥
                        </span>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}


          {comparison.details.newInBmc.length > 0 && (
            <div className="border border-blue-200 rounded-lg">
              <button
                onClick={() => toggleSection('newInBmc')}
                className="w-full flex items-center justify-between p-3 bg-blue-50 rounded-t-lg"
              >
                <span className="flex items-center gap-2 font-medium text-blue-800">
                  <Plus className="w-4 h-4" />
                  –ù–æ–≤—ã–µ –≤ BMC ({comparison.details.newInBmc.length})
                </span>
                {expanded.newInBmc ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
              </button>

              {expanded.newInBmc && (
                <div className="p-3 space-y-2">
                  {comparison.details.newInBmc.map((item, idx) => (
                    <div key={idx} className="flex items-center gap-2 p-2 bg-gray-50 rounded">
                      {getComponentIcon(item.bmcComponent.componentType)}
                      <div>
                        <div className="font-medium">
                          {item.bmcComponent.manufacturer} {item.bmcComponent.model}
                        </div>
                        <div className="text-xs text-gray-500">
                          S/N: {item.bmcComponent.serialNumber || '–Ω/–¥'} | –°–ª–æ—Ç: {item.bmcComponent.slot || '–Ω/–¥'}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}


          {comparison.details.mismatches.length > 0 && (
            <div className="border border-orange-200 rounded-lg">
              <button
                onClick={() => toggleSection('mismatches')}
                className="w-full flex items-center justify-between p-3 bg-orange-50 rounded-t-lg"
              >
                <span className="flex items-center gap-2 font-medium text-orange-800">
                  <ArrowLeftRight className="w-4 h-4" />
                  –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ({comparison.details.mismatches.length})
                </span>
                {expanded.mismatches ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
              </button>

              {expanded.mismatches && (
                <div className="p-3 space-y-2">
                  {comparison.details.mismatches.map((item, idx) => (
                    <div key={idx} className="p-2 bg-gray-50 rounded">
                      <div className="flex items-center gap-2 mb-2">
                        {getComponentIcon(item.dbComponent.componentType)}
                        <span className="font-medium">{item.dbComponent.name}</span>
                        <span className="text-xs text-gray-500">S/N: {item.dbComponent.serialNumber}</span>
                      </div>
                      <div className="ml-6 space-y-1">
                        {item.differences.map((diff, dIdx) => (
                          <div key={dIdx} className="text-sm flex items-center gap-2">
                            <span className="text-gray-500 w-24">{diff.field}:</span>
                            <span className="text-red-600 line-through">{diff.db || '–ø—É—Å—Ç–æ'}</span>
                            <span>‚Üí</span>
                            <span className="text-green-600">{diff.bmc || '–ø—É—Å—Ç–æ'}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}


          {comparison.hasDiscrepancies && (
            <div className="flex flex-wrap gap-2 pt-4 border-t">
              <button
                onClick={handleMerge}
                disabled={loading}
                className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
              >
                <Check className="w-4 h-4" />
                –£–º–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ
              </button>

              <button
                onClick={() => handleForceSync(true)}
                disabled={loading}
                className="flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50"
              >
                <RefreshCw className="w-4 h-4" />
                –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä—É—á–Ω—ã–µ)
              </button>

              <button
                onClick={() => handleForceSync(false)}
                disabled={loading}
                className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50"
              >
                <X className="w-4 h-4" />
                –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å
              </button>
            </div>
          )}
        </div>
      )}
    </div>
  );
};


export const DiscrepancyBadge: React.FC<{
  hasDiscrepancy: boolean;
  reason?: string;
}> = ({ hasDiscrepancy, reason }) => {
  if (!hasDiscrepancy) return null;

  const reasonLabels: Record<string, string> = {
    NOT_FOUND_IN_BMC: '–ù–µ –Ω–∞–π–¥–µ–Ω –≤ BMC',
    REMOVED_FROM_BMC: '–£–¥–∞–ª—ë–Ω –∏–∑ BMC',
    DATA_MISMATCH: '–î–∞–Ω–Ω—ã–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è',
    SERIAL_CHANGED: '–ò–∑–º–µ–Ω—ë–Ω S/N'
  };

  return (
    <span
      className="inline-flex items-center gap-1 px-2 py-0.5 text-xs bg-amber-100 text-amber-800 rounded-full"
      title={reason ? reasonLabels[reason] || reason : '–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å BMC'}
    >
      <AlertTriangle className="w-3 h-3" />
      BMC
    </span>
  );
};

export default BMCSyncPanel;

================================================================================
FILE: QMS-Client-main/src/components/beryll/DefectComments.tsx
================================================================================



import React, { useState, useEffect, useCallback } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import {
  Plus, Trash2, Edit, CheckCircle, Paperclip, Download, RefreshCw, Filter, X, ChevronDown, ChevronUp
} from 'lucide-react';
import clsx from 'clsx';
import toast from 'react-hot-toast';

import {
  getServerDefects, createDefect, updateDefect, deleteDefect,
  resolveDefect, uploadDefectFile, downloadDefectFile, deleteDefectFile
} from '../../api/beryll/defectsAndMonitoringAPI';

import type {
  DefectComment, DefectCategory, DefectPriority, DefectStatus
} from '../../types/beryll/defectsAndMonitoring';

import {
  DEFECT_CATEGORY_LABELS, DEFECT_PRIORITY_LABELS, DEFECT_STATUS_LABELS,
  PRIORITY_COLORS, STATUS_COLORS
} from '../../types/beryll/defectsAndMonitoring';

interface Props {
  serverId: number;
}

export const DefectComments: React.FC<Props> = ({ serverId }) => {
  const [comments, setComments] = useState<DefectComment[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [statusFilter, setStatusFilter] = useState<DefectStatus | ''>('');
  const [categoryFilter, setCategoryFilter] = useState<DefectCategory | ''>('');
  const [showFilters, setShowFilters] = useState(false);

  const [addDialogOpen, setAddDialogOpen] = useState(false);
  const [editingComment, setEditingComment] = useState<DefectComment | null>(null);
  const [resolveDialogOpen, setResolveDialogOpen] = useState(false);
  const [resolvingComment, setResolvingComment] = useState<DefectComment | null>(null);

  const [formText, setFormText] = useState('');
  const [formCategory, setFormCategory] = useState<DefectCategory>('OTHER');
  const [formPriority, setFormPriority] = useState<DefectPriority>('MEDIUM');
  const [formResolution, setFormResolution] = useState('');
  const [formFile, setFormFile] = useState<File | null>(null);
  const [submitting, setSubmitting] = useState(false);

  const [expanded, setExpanded] = useState<Set<number>>(new Set());

  const loadComments = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const result = await getServerDefects(serverId, {
        status: statusFilter || undefined,
        category: categoryFilter || undefined,
        limit: 50
      });
      setComments(result.rows);
    } catch (e: any) {
      setError(e.response?.data?.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
    } finally {
      setLoading(false);
    }
  }, [serverId, statusFilter, categoryFilter]);

  useEffect(() => {
    loadComments();
  }, [loadComments]);

  const handleAdd = async () => {
    if (!formText.trim()) return;
    try {
      setSubmitting(true);
      const newComment = await createDefect(serverId, {
        text: formText.trim(),
        defectCategory: formCategory,
        priority: formPriority
      });

      if (formFile) {
        await uploadDefectFile(newComment.id, formFile);
      }

      setAddDialogOpen(false);
      resetForm();
      loadComments();
      toast.success('–î–µ—Ñ–µ–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
    } catch (e: any) {
      toast.error(e.response?.data?.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
    } finally {
      setSubmitting(false);
    }
  };

  const handleUpdate = async () => {
    if (!editingComment || !formText.trim()) return;
    try {
      setSubmitting(true);
      await updateDefect(editingComment.id, {
        text: formText.trim(),
        defectCategory: formCategory,
        priority: formPriority
      });
      setEditingComment(null);
      resetForm();
      loadComments();
      toast.success('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    } catch (e: any) {
      toast.error(e.response?.data?.message || '–û—à–∏–±–∫–∞');
    } finally {
      setSubmitting(false);
    }
  };

  const handleResolve = async () => {
    if (!resolvingComment) return;
    try {
      setSubmitting(true);
      await resolveDefect(resolvingComment.id, { resolution: formResolution || undefined });
      setResolveDialogOpen(false);
      setResolvingComment(null);
      setFormResolution('');
      loadComments();
      toast.success('–î–µ—Ñ–µ–∫—Ç —Ä–µ—à—ë–Ω');
    } catch (e: any) {
      toast.error(e.response?.data?.message || '–û—à–∏–±–∫–∞');
    } finally {
      setSubmitting(false);
    }
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;
    try {
      await deleteDefect(id);
      loadComments();
      toast.success('–£–¥–∞–ª–µ–Ω–æ');
    } catch (e: any) {
      toast.error(e.response?.data?.message || '–û—à–∏–±–∫–∞');
    }
  };

  const handleDownloadFile = async (fileId: number, fileName: string) => {
    try {
      const blob = await downloadDefectFile(fileId);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);
    } catch {
      toast.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
    }
  };

  const handleDeleteFile = async (fileId: number) => {
    if (!window.confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')) return;
    try {
      await deleteDefectFile(fileId);
      loadComments();
      toast.success('–§–∞–π–ª —É–¥–∞–ª—ë–Ω');
    } catch {
      toast.error('–û—à–∏–±–∫–∞');
    }
  };

  const resetForm = () => {
    setFormText('');
    setFormCategory('OTHER');
    setFormPriority('MEDIUM');
    setFormFile(null);
    setFormResolution('');
  };

  const openEdit = (comment: DefectComment) => {
    setEditingComment(comment);
    setFormText(comment.text);
    setFormCategory(comment.defectCategory);
    setFormPriority(comment.priority);
  };

  const openResolve = (comment: DefectComment) => {
    setResolvingComment(comment);
    setFormResolution('');
    setResolveDialogOpen(true);
  };

  const toggleExpand = (id: number) => {
    const newExpanded = new Set(expanded);
    if (newExpanded.has(id)) newExpanded.delete(id);
    else newExpanded.add(id);
    setExpanded(newExpanded);
  };

  const unresolvedCount = comments.filter(c => c.status === 'NEW' || c.status === 'IN_PROGRESS').length;

  return (
    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">

      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <h3 className="text-lg font-semibold text-slate-800">–î–µ—Ñ–µ–∫—Ç—ã</h3>
          {unresolvedCount > 0 && (
            <span className="bg-red-100 text-red-700 text-xs font-bold px-2 py-0.5 rounded-full">{unresolvedCount}</span>
          )}
        </div>
        <div className="flex items-center gap-2">
          <button onClick={() => setShowFilters(!showFilters)} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg">
            <Filter size={18} />
          </button>
          <button onClick={loadComments} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg">
            <RefreshCw size={18} />
          </button>
          <button onClick={() => setAddDialogOpen(true)} className="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700">
            <Plus size={16} /> –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>


      {showFilters && (
        <div className="flex gap-3 mb-4 p-3 bg-slate-50 rounded-lg">
          <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value as DefectStatus | '')} className="px-3 py-1.5 text-sm border border-slate-300 rounded-lg">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            {Object.entries(DEFECT_STATUS_LABELS).map(([key, label]) => <option key={key} value={key}>{label}</option>)}
          </select>
          <select value={categoryFilter} onChange={(e) => setCategoryFilter(e.target.value as DefectCategory | '')} className="px-3 py-1.5 text-sm border border-slate-300 rounded-lg">
            <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            {Object.entries(DEFECT_CATEGORY_LABELS).map(([key, label]) => <option key={key} value={key}>{label}</option>)}
          </select>
        </div>
      )}


      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 flex justify-between">
          <span>{error}</span>
          <button onClick={() => setError(null)}>‚úï</button>
        </div>
      )}


      {loading && <div className="h-1 bg-indigo-100 rounded overflow-hidden mb-4"><div className="h-full bg-indigo-500 animate-pulse w-1/2" /></div>}


      {comments.length === 0 && !loading ? (
        <p className="text-center text-slate-400 py-8">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ –¥–µ—Ñ–µ–∫—Ç–∞–º</p>
      ) : (
        <div className="space-y-3">
          {comments.map((comment) => (
            <div key={comment.id} className={clsx("border rounded-lg p-4 transition-all", comment.status === 'RESOLVED' ? "bg-slate-50 opacity-70" : "bg-white")}>

              <div className="flex flex-wrap items-center gap-2 mb-2">
                <span className="px-2 py-0.5 rounded text-xs font-medium text-white" style={{ backgroundColor: STATUS_COLORS[comment.status] }}>
                  {DEFECT_STATUS_LABELS[comment.status]}
                </span>
                <span className="px-2 py-0.5 rounded text-xs font-medium border" style={{ borderColor: PRIORITY_COLORS[comment.priority], color: PRIORITY_COLORS[comment.priority] }}>
                  {DEFECT_PRIORITY_LABELS[comment.priority]}
                </span>
                <span className="px-2 py-0.5 rounded text-xs font-medium border border-slate-300 text-slate-600">
                  {DEFECT_CATEGORY_LABELS[comment.defectCategory]}
                </span>
                {comment.files && comment.files.length > 0 && (
                  <span className="flex items-center gap-1 text-xs text-slate-500">
                    <Paperclip size={12} /> {comment.files.length}
                  </span>
                )}
              </div>


              <p className="text-sm text-slate-700 whitespace-pre-wrap mb-2">{comment.text}</p>


              <p className="text-xs text-slate-400 mb-2">
                {comment.author?.name} {comment.author?.surname} ‚Ä¢ {new Date(comment.createdAt).toLocaleString()}
              </p>


              {comment.files && comment.files.length > 0 && (
                <div className={clsx("overflow-hidden transition-all", expanded.has(comment.id) ? "max-h-40" : "max-h-0")}>
                  <div className="flex flex-wrap gap-2 pt-2 border-t border-slate-100">
                    {comment.files.map(file => (
                      <span key={file.id} className="inline-flex items-center gap-1 bg-slate-100 px-2 py-1 rounded text-xs">
                        <Paperclip size={12} />
                        <button onClick={() => handleDownloadFile(file.id, file.originalName)} className="hover:underline">{file.originalName}</button>
                        <button onClick={() => handleDeleteFile(file.id)} className="text-red-500 hover:text-red-700 ml-1">‚úï</button>
                      </span>
                    ))}
                  </div>
                </div>
              )}


              {comment.resolution && (
                <div className="mt-2 p-2 bg-emerald-50 border border-emerald-200 rounded text-xs text-emerald-700">
                  <strong>–†–µ—à–µ–Ω–∏–µ:</strong> {comment.resolution}
                </div>
              )}


              <div className="flex items-center gap-1 mt-3 pt-3 border-t border-slate-100">
                {comment.files && comment.files.length > 0 && (
                  <button onClick={() => toggleExpand(comment.id)} className="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded">
                    {expanded.has(comment.id) ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                  </button>
                )}
                {comment.status !== 'RESOLVED' && comment.status !== 'WONT_FIX' && (
                  <button onClick={() => openResolve(comment)} className="p-1.5 text-emerald-500 hover:text-emerald-700 hover:bg-emerald-50 rounded" title="–†–µ—à–∏—Ç—å">
                    <CheckCircle size={16} />
                  </button>
                )}
                <button onClick={() => openEdit(comment)} className="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                  <Edit size={16} />
                </button>
                <button onClick={() => handleDelete(comment.id)} className="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded" title="–£–¥–∞–ª–∏—Ç—å">
                  <Trash2 size={16} />
                </button>
              </div>
            </div>
          ))}
        </div>
      )}


      <Transition show={addDialogOpen} as={React.Fragment}>
        <Dialog onClose={() => setAddDialogOpen(false)} className="relative z-50">
          <Transition.Child as={React.Fragment} enter="ease-out duration-200" enterFrom="opacity-0" enterTo="opacity-100" leave="ease-in duration-150" leaveFrom="opacity-100" leaveTo="opacity-0">
            <div className="fixed inset-0 bg-black/30" />
          </Transition.Child>
          <div className="fixed inset-0 flex items-center justify-center p-4">
            <Transition.Child as={React.Fragment} enter="ease-out duration-200" enterFrom="opacity-0 scale-95" enterTo="opacity-100 scale-100" leave="ease-in duration-150" leaveFrom="opacity-100 scale-100" leaveTo="opacity-0 scale-95">
              <Dialog.Panel className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <Dialog.Title className="text-lg font-semibold mb-4">–ù–æ–≤—ã–π –¥–µ—Ñ–µ–∫—Ç</Dialog.Title>
                <textarea value={formText} onChange={(e) => setFormText(e.target.value)} placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞..." className="w-full border border-slate-300 rounded-lg p-3 text-sm mb-3 h-24 resize-none" />
                <div className="flex gap-3 mb-3">
                  <select value={formCategory} onChange={(e) => setFormCategory(e.target.value as DefectCategory)} className="flex-1 px-3 py-2 text-sm border border-slate-300 rounded-lg">
                    {Object.entries(DEFECT_CATEGORY_LABELS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
                  </select>
                  <select value={formPriority} onChange={(e) => setFormPriority(e.target.value as DefectPriority)} className="flex-1 px-3 py-2 text-sm border border-slate-300 rounded-lg">
                    {Object.entries(DEFECT_PRIORITY_LABELS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
                  </select>
                </div>
                <label className="flex items-center gap-2 px-3 py-2 border border-dashed border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 mb-4">
                  <Paperclip size={16} className="text-slate-400" />
                  <span className="text-sm text-slate-600">{formFile ? formFile.name : '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª'}</span>
                  <input type="file" className="hidden" onChange={(e) => setFormFile(e.target.files?.[0] || null)} />
                </label>
                <div className="flex justify-end gap-2">
                  <button onClick={() => { setAddDialogOpen(false); resetForm(); }} className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
                  <button onClick={handleAdd} disabled={!formText.trim() || submitting} className="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                    {submitting ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å'}
                  </button>
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </Dialog>
      </Transition>


      <Transition show={!!editingComment} as={React.Fragment}>
        <Dialog onClose={() => setEditingComment(null)} className="relative z-50">
          <Transition.Child as={React.Fragment} enter="ease-out duration-200" enterFrom="opacity-0" enterTo="opacity-100" leave="ease-in duration-150" leaveFrom="opacity-100" leaveTo="opacity-0">
            <div className="fixed inset-0 bg-black/30" />
          </Transition.Child>
          <div className="fixed inset-0 flex items-center justify-center p-4">
            <Transition.Child as={React.Fragment} enter="ease-out duration-200" enterFrom="opacity-0 scale-95" enterTo="opacity-100 scale-100" leave="ease-in duration-150" leaveFrom="opacity-100 scale-100" leaveTo="opacity-0 scale-95">
              <Dialog.Panel className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <Dialog.Title className="text-lg font-semibold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</Dialog.Title>
                <textarea value={formText} onChange={(e) => setFormText(e.target.value)} className="w-full border border-slate-300 rounded-lg p-3 text-sm mb-3 h-24 resize-none" />
                <div className="flex gap-3 mb-4">
                  <select value={formCategory} onChange={(e) => setFormCategory(e.target.value as DefectCategory)} className="flex-1 px-3 py-2 text-sm border border-slate-300 rounded-lg">
                    {Object.entries(DEFECT_CATEGORY_LABELS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
                  </select>
                  <select value={formPriority} onChange={(e) => setFormPriority(e.target.value as DefectPriority)} className="flex-1 px-3 py-2 text-sm border border-slate-300 rounded-lg">
                    {Object.entries(DEFECT_PRIORITY_LABELS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
                  </select>
                </div>
                <div className="flex justify-end gap-2">
                  <button onClick={() => { setEditingComment(null); resetForm(); }} className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
                  <button onClick={handleUpdate} disabled={!formText.trim() || submitting} className="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                    {submitting ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
                  </button>
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </Dialog>
      </Transition>


      <Transition show={resolveDialogOpen} as={React.Fragment}>
        <Dialog onClose={() => setResolveDialogOpen(false)} className="relative z-50">
          <Transition.Child as={React.Fragment} enter="ease-out duration-200" enterFrom="opacity-0" enterTo="opacity-100" leave="ease-in duration-150" leaveFrom="opacity-100" leaveTo="opacity-0">
            <div className="fixed inset-0 bg-black/30" />
          </Transition.Child>
          <div className="fixed inset-0 flex items-center justify-center p-4">
            <Transition.Child as={React.Fragment} enter="ease-out duration-200" enterFrom="opacity-0 scale-95" enterTo="opacity-100 scale-100" leave="ease-in duration-150" leaveFrom="opacity-100 scale-100" leaveTo="opacity-0 scale-95">
              <Dialog.Panel className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <Dialog.Title className="text-lg font-semibold mb-4">–†–µ—à–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç</Dialog.Title>
                <textarea value={formResolution} onChange={(e) => setFormResolution(e.target.value)} placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" className="w-full border border-slate-300 rounded-lg p-3 text-sm mb-4 h-20 resize-none" />
                <div className="flex justify-end gap-2">
                  <button onClick={() => setResolveDialogOpen(false)} className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
                  <button onClick={handleResolve} disabled={submitting} className="px-4 py-2 text-sm bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50">
                    {submitting ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–†–µ—à–µ–Ω–æ'}
                  </button>
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </Dialog>
      </Transition>
    </div>
  );
};

export default DefectComments;

================================================================================
FILE: QMS-Client-main/src/components/beryll/MonitoringDashboard.tsx
================================================================================

import React, { useState, useEffect, useCallback, useRef } from 'react';
import {
  RefreshCw, Play, Wifi, WifiOff, Gauge, Timer, CloudOff, Server
} from 'lucide-react';
import clsx from 'clsx';

import {
  getMonitoringStats, getCachedStatus, pingServer, pingAllServers
} from '../../api/beryll/defectsAndMonitoringAPI';

import type {
  MonitoringStats, ServerPingResult
} from '../../types/beryll/defectsAndMonitoring';

interface Props {
  autoRefresh?: boolean;
  refreshInterval?: number;
}

export const MonitoringDashboard: React.FC<Props> = ({
  autoRefresh = true,
  refreshInterval = 60
}) => {
  const [stats, setStats] = useState<MonitoringStats | null>(null);
  const [servers, setServers] = useState<ServerPingResult[]>([]);
  const [loading, setLoading] = useState(true);
  const [pinging, setPinging] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [tab, setTab] = useState<'all' | 'online' | 'offline'>('all');
  const [countdown, setCountdown] = useState(refreshInterval);

  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const countdownRef = useRef<NodeJS.Timeout | null>(null);

  const loadData = useCallback(async (forceRefresh = false) => {
    try {
      setLoading(true);
      setError(null);

      const [statsData, statusData] = await Promise.all([
        getMonitoringStats(),
        forceRefresh ? pingAllServers({ forceRefresh: true }) : getCachedStatus()
      ]);

      setStats(statsData);
      setServers(statusData.servers || []);
      setCountdown(refreshInterval);
    } catch (e: any) {
      setError(e.response?.data?.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
    } finally {
      setLoading(false);
    }
  }, [refreshInterval]);

  useEffect(() => {
    loadData();

    if (autoRefresh) {
      intervalRef.current = setInterval(() => loadData(), refreshInterval * 1000);
      countdownRef.current = setInterval(() => {
        setCountdown(prev => (prev > 0 ? prev - 1 : refreshInterval));
      }, 1000);
    }

    return () => {
      if (intervalRef.current) clearInterval(intervalRef.current);
      if (countdownRef.current) clearInterval(countdownRef.current);
    };
  }, [loadData, autoRefresh, refreshInterval]);

  const handlePingAll = async () => {
    try {
      setPinging(true);
      setError(null);
      await pingAllServers({ forceRefresh: true });
      await loadData();
    } catch (e: any) {
      setError(e.response?.data?.message || '–û—à–∏–±–∫–∞ –ø–∏–Ω–≥–∞');
    } finally {
      setPinging(false);
    }
  };

  const handlePingServer = async (serverId: number) => {
    try {
      const result = await pingServer(serverId);
      setServers(prev => prev.map(s => s.serverId === serverId ? result : s));
    } catch (e: any) {
      setError('–û—à–∏–±–∫–∞ –ø–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    }
  };

  const onlineServers = servers.filter(s => s.online);
  const offlineServers = servers.filter(s => !s.online);
  const filteredServers = tab === 'all' ? servers : tab === 'online' ? onlineServers : offlineServers;
  const onlinePercent = servers.length > 0 ? Math.round((onlineServers.length / servers.length) * 100) : 0;

  return (
    <div className="space-y-6">

      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-slate-800">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–æ–≤</h1>
        <div className="flex items-center gap-4">
          {autoRefresh && (
            <span className="flex items-center gap-2 text-sm text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full">
              <Timer size={14} />
              –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {countdown}—Å
            </span>
          )}
          <button
            onClick={handlePingAll}
            disabled={pinging}
            className={clsx(
              "flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all",
              pinging ? "bg-slate-200 text-slate-400 cursor-not-allowed" : "bg-indigo-600 text-white hover:bg-indigo-700"
            )}
          >
            {pinging ? <RefreshCw size={16} className="animate-spin" /> : <Play size={16} />}
            –ü–∏–Ω–≥ –≤—Å–µ—Ö
          </button>
        </div>
      </div>


      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center justify-between">
          <span>{error}</span>
          <button onClick={() => setError(null)} className="text-red-500 hover:text-red-700">‚úï</button>
        </div>
      )}


      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <p className="text-sm text-slate-500 mb-1">–í—Å–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–æ–≤</p>
          {loading ? <div className="h-9 w-16 bg-slate-200 animate-pulse rounded" /> : <p className="text-3xl font-bold text-slate-800">{stats?.total || servers.length}</p>}
        </div>

        <div className="bg-white rounded-xl shadow-sm border-l-4 border-l-emerald-500 border border-slate-200 p-5">
          <div className="flex items-center gap-2 mb-1">
            <Wifi size={16} className="text-emerald-500" />
            <p className="text-sm text-slate-500">–û–Ω–ª–∞–π–Ω</p>
          </div>
          {loading ? <div className="h-9 w-16 bg-slate-200 animate-pulse rounded" /> : <p className="text-3xl font-bold text-emerald-600">{stats?.online || onlineServers.length}</p>}
        </div>

        <div className="bg-white rounded-xl shadow-sm border-l-4 border-l-red-500 border border-slate-200 p-5">
          <div className="flex items-center gap-2 mb-1">
            <WifiOff size={16} className="text-red-500" />
            <p className="text-sm text-slate-500">–û—Ñ—Ñ–ª–∞–π–Ω</p>
          </div>
          {loading ? <div className="h-9 w-16 bg-slate-200 animate-pulse rounded" /> : <p className="text-3xl font-bold text-red-600">{stats?.offline || offlineServers.length}</p>}
        </div>

        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <div className="flex items-center gap-2 mb-1">
            <Gauge size={16} className="text-slate-400" />
            <p className="text-sm text-slate-500">–°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞</p>
          </div>
          {loading ? <div className="h-9 w-20 bg-slate-200 animate-pulse rounded" /> : <p className="text-3xl font-bold text-slate-800">{stats?.avgLatency ? `${stats.avgLatency} –º—Å` : '‚Äî'}</p>}
        </div>
      </div>


      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm text-slate-500">–°–µ—Ä–≤–µ—Ä–æ–≤ –æ–Ω–ª–∞–π–Ω</span>
          <span className="text-sm font-bold text-slate-700">{onlinePercent}%</span>
        </div>
        <div className="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
          <div
            className={clsx("h-full rounded-full transition-all duration-500", onlinePercent > 80 ? "bg-emerald-500" : onlinePercent > 50 ? "bg-yellow-500" : "bg-red-500")}
            style={{ width: `${onlinePercent}%` }}
          />
        </div>
      </div>


      {stats?.staleServers && stats.staleServers > 0 && (
        <div className="bg-amber-50 border border-amber-200 text-amber-700 px-4 py-3 rounded-lg flex items-center gap-2">
          <CloudOff size={18} />
          <span>{stats.staleServers} —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏—Å—å –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç</span>
        </div>
      )}


      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="flex border-b border-slate-200">
          {[
            { key: 'all', label: `–í—Å–µ (${servers.length})` },
            { key: 'online', label: `–û–Ω–ª–∞–π–Ω (${onlineServers.length})` },
            { key: 'offline', label: `–û—Ñ—Ñ–ª–∞–π–Ω (${offlineServers.length})` },
          ].map(t => (
            <button
              key={t.key}
              onClick={() => setTab(t.key as any)}
              className={clsx(
                "px-6 py-3 text-sm font-medium transition-all border-b-2 -mb-px",
                tab === t.key ? "border-indigo-600 text-indigo-600 bg-indigo-50/50" : "border-transparent text-slate-500 hover:text-slate-700"
              )}
            >
              {t.label}
            </button>
          ))}
        </div>

        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-slate-50 border-b border-slate-200">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">IP</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Hostname</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">–°–µ—Ä–∏–π–Ω—ã–π</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">–ó–∞–¥–µ—Ä–∂–∫–∞</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">–ü—Ä–æ–≤–µ—Ä–∫–∞</th>
                <th className="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase">‚ö°</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {loading ? (
                Array.from({ length: 5 }).map((_, i) => (
                  <tr key={i}>{Array.from({ length: 7 }).map((_, j) => <td key={j} className="px-4 py-3"><div className="h-5 bg-slate-200 animate-pulse rounded w-20" /></td>)}</tr>
                ))
              ) : filteredServers.length === 0 ? (
                <tr><td colSpan={7} className="px-4 py-12 text-center text-slate-400"><Server size={40} className="mx-auto mb-2 opacity-30" />–ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤</td></tr>
              ) : (
                filteredServers.map((server) => (
                  <tr key={server.serverId} className={clsx("transition-colors", server.online ? "bg-emerald-50/50 hover:bg-emerald-100/50" : "bg-red-50/50 hover:bg-red-100/50")}>
                    <td className="px-4 py-3">
                      <span className={clsx("inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium", server.online ? "bg-emerald-100 text-emerald-700" : "bg-red-100 text-red-700")}>
                        {server.online ? <Wifi size={12} /> : <WifiOff size={12} />}
                        {server.online ? 'Online' : 'Offline'}
                      </span>
                    </td>
                    <td className="px-4 py-3"><code className="text-sm text-slate-700 bg-slate-100 px-2 py-0.5 rounded">{server.ipAddress || '‚Äî'}</code></td>
                    <td className="px-4 py-3 text-sm text-slate-600">{server.hostname || '‚Äî'}</td>
                    <td className="px-4 py-3"><code className="text-sm text-slate-600">{server.apkSerialNumber || server.serialNumber || '‚Äî'}</code></td>
                    <td className="px-4 py-3">
                      {server.latency !== null ? (
                        <span className={clsx("inline-flex px-2 py-0.5 rounded text-xs font-medium", server.latency < 50 ? "bg-emerald-100 text-emerald-700" : server.latency < 200 ? "bg-yellow-100 text-yellow-700" : "bg-red-100 text-red-700")}>
                          {server.latency.toFixed(1)} –º—Å
                        </span>
                      ) : '‚Äî'}
                    </td>
                    <td className="px-4 py-3 text-xs text-slate-400">{server.checkedAt ? new Date(server.checkedAt).toLocaleTimeString() : '‚Äî'}</td>
                    <td className="px-4 py-3 text-right">
                      <button onClick={() => handlePingServer(server.serverId)} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded" title="–ü–∏–Ω–≥">
                        <RefreshCw size={16} />
                      </button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {stats?.lastFullScan && <p className="text-xs text-slate-400 text-center">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: {new Date(stats.lastFullScan).toLocaleString()}</p>}
    </div>
  );
};

export default MonitoringDashboard;

================================================================================
FILE: QMS-Client-main/src/components/beryll/PassportsExportModal.tsx
================================================================================



import React, { useState, useEffect, useCallback } from "react";
import { Dialog, Transition, Listbox } from "@headlessui/react";
import {
  Download,
  FileSpreadsheet,
  X,
  ChevronDown,
  Check,
  Loader2,
  AlertTriangle,
  HardDrive,
  MemoryStick,
  Cpu,
  Zap,
  Server,
  Network,
  Calendar,
  Search,
  Filter,
  Eye,
  BarChart3,
  CheckCircle,
  XCircle,
  Package,
  RefreshCw
} from "lucide-react";
import clsx from "clsx";
import { toast } from "react-hot-toast";
import passportsExportApi, {
  ExportOptions,
  ExportStats,
  ServerPreview,
  PreviewResponse,
  StatsResponse
} from "../../api/passportsExportApi";


interface Props {
  isOpen: boolean;
  onClose: () => void;
  batches: Array<{ id: number; name: string }>;
  initialBatchId?: number | null;
  selectedServerIds?: number[];
}

interface FilterState {
  batchId: number | string | null;
  status: string;
  dateFrom: string;
  dateTo: string;
  search: string;
  includeArchived: boolean;
}


const SERVER_STATUSES = [
  { value: "", label: "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" },
  { value: "NEW", label: "–ù–æ–≤—ã–π" },
  { value: "IN_PROGRESS", label: "–í —Ä–∞–±–æ—Ç–µ" },
  { value: "TESTING", label: "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" },
  { value: "READY", label: "–ì–æ—Ç–æ–≤" },
  { value: "SHIPPED", label: "–û—Ç–≥—Ä—É–∂–µ–Ω" },
  { value: "RETURNED", label: "–í–æ–∑–≤—Ä–∞—Ç" }
];

const COMPONENT_ICONS: Record<string, React.FC<{ className?: string; size?: number }>> = {
  HDD: HardDrive,
  SSD: HardDrive,
  NVME: HardDrive,
  RAM: MemoryStick,
  CPU: Cpu,
  PSU: Zap,
  MOTHERBOARD: Server,
  NIC: Network,
  BMC: Server,
  RAID: HardDrive
};


export const PassportsExportModal: React.FC<Props> = ({
  isOpen,
  onClose,
  batches,
  initialBatchId = null,
  selectedServerIds = []
}) => {

  const [filters, setFilters] = useState<FilterState>({
    batchId: initialBatchId,
    status: "",
    dateFrom: "",
    dateTo: "",
    search: "",
    includeArchived: false
  });


  const [stats, setStats] = useState<ExportStats | null>(null);
  const [preview, setPreview] = useState<ServerPreview[]>([]);
  const [totalServers, setTotalServers] = useState(0);


  const [loadingStats, setLoadingStats] = useState(false);
  const [loadingPreview, setLoadingPreview] = useState(false);
  const [exporting, setExporting] = useState(false);


  const [activeTab, setActiveTab] = useState<"preview" | "stats">("preview");


  const loadStats = useCallback(async () => {
    setLoadingStats(true);
    try {
      const response = await passportsExportApi.getExportStats(filters);
      setStats(response.stats);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
      toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É");
    } finally {
      setLoadingStats(false);
    }
  }, [filters]);

  const loadPreview = useCallback(async () => {
    setLoadingPreview(true);
    try {
      const response = await passportsExportApi.getExportPreview(filters, 20);
      setPreview(response.preview);
      setTotalServers(response.total);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞:", error);
      toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä");
    } finally {
      setLoadingPreview(false);
    }
  }, [filters]);


  useEffect(() => {
    if (isOpen) {
      loadPreview();
      loadStats();
    }
  }, [isOpen, filters, loadPreview, loadStats]);


  const handleExport = async () => {
    setExporting(true);
    try {
      await passportsExportApi.exportAndDownload(filters, {
        batchId: filters.batchId,
        status: filters.status || undefined
      });
      toast.success("–≠–∫—Å–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!");
      onClose();
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:", error);
      toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç");
    } finally {
      setExporting(false);
    }
  };

  const handleExportSelected = async () => {
    if (selectedServerIds.length === 0) {
      toast.error("–ù–µ –≤—ã–±—Ä–∞–Ω—ã —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞");
      return;
    }

    setExporting(true);
    try {
      await passportsExportApi.exportSelectedAndDownload(selectedServerIds);
      toast.success(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${selectedServerIds.length} —Å–µ—Ä–≤–µ—Ä–æ–≤`);
      onClose();
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:", error);
      toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç");
    } finally {
      setExporting(false);
    }
  };


  const updateFilter = <K extends keyof FilterState>(
    key: K,
    value: FilterState[K]
  ) => {
    setFilters(prev => ({ ...prev, [key]: value }));
  };

  const resetFilters = () => {
    setFilters({
      batchId: null,
      status: "",
      dateFrom: "",
      dateTo: "",
      search: "",
      includeArchived: false
    });
  };


  const batchOptions = [
    { id: null, name: "–í—Å–µ –ø–∞—Ä—Ç–∏–∏" },
    { id: "null", name: "–ë–µ–∑ –ø–∞—Ä—Ç–∏–∏" },
    ...batches
  ];

  const selectedBatch = batchOptions.find(b => b.id === filters.batchId) || batchOptions[0];
  const selectedStatus = SERVER_STATUSES.find(s => s.value === filters.status) || SERVER_STATUSES[0];

  return (
    <Transition appear show={isOpen} as={React.Fragment}>
      <Dialog as="div" className="relative z-50" onClose={onClose}>
        <Transition.Child
          as={React.Fragment}
          enter="ease-out duration-300"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-200"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className="fixed inset-0 bg-black/50" />
        </Transition.Child>

        <div className="fixed inset-0 overflow-y-auto">
          <div className="flex min-h-full items-center justify-center p-4">
            <Transition.Child
              as={React.Fragment}
              enter="ease-out duration-300"
              enterFrom="opacity-0 scale-95"
              enterTo="opacity-100 scale-100"
              leave="ease-in duration-200"
              leaveFrom="opacity-100 scale-100"
              leaveTo="opacity-0 scale-95"
            >
              <Dialog.Panel className="w-full max-w-5xl transform rounded-2xl bg-white shadow-2xl transition-all">

                <div className="flex items-center justify-between border-b border-slate-200 px-6 py-4">
                  <div className="flex items-center gap-3">
                    <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-100 text-emerald-600">
                      <FileSpreadsheet size={20} />
                    </div>
                    <div>
                      <Dialog.Title className="text-lg font-semibold text-slate-900">
                        –≠–∫—Å–ø–æ—Ä—Ç –ø–∞—Å–ø–æ—Ä—Ç–æ–≤ —Å–µ—Ä–≤–µ—Ä–æ–≤
                      </Dialog.Title>
                      <p className="text-sm text-slate-500">
                        –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É "–°–æ—Å—Ç–∞–≤ —Å–µ—Ä–≤–µ—Ä–æ–≤"
                      </p>
                    </div>
                  </div>
                  <button
                    onClick={onClose}
                    className="rounded-lg p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600"
                  >
                    <X size={20} />
                  </button>
                </div>


                <div className="border-b border-slate-200 bg-slate-50 px-6 py-4">
                  <div className="flex items-center gap-2 mb-3">
                    <Filter size={16} className="text-slate-500" />
                    <span className="text-sm font-medium text-slate-700">–§–∏–ª—å—Ç—Ä—ã</span>
                    <button
                      onClick={resetFilters}
                      className="ml-auto flex items-center gap-1 text-xs text-slate-500 hover:text-slate-700"
                    >
                      <RefreshCw size={12} />
                      –°–±—Ä–æ—Å–∏—Ç—å
                    </button>
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">

                    <Listbox
                      value={filters.batchId}
                      onChange={(v) => updateFilter("batchId", v)}
                    >
                      <div className="relative">
                        <Listbox.Label className="block text-xs font-medium text-slate-600 mb-1">
                          –ü–∞—Ä—Ç–∏—è
                        </Listbox.Label>
                        <Listbox.Button className="relative w-full cursor-pointer rounded-lg bg-white py-2 pl-3 pr-10 text-left border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                          <span className="block truncate">{selectedBatch.name}</span>
                          <span className="absolute inset-y-0 right-0 flex items-center pr-2">
                            <ChevronDown size={16} className="text-slate-400" />
                          </span>
                        </Listbox.Button>
                        <Transition
                          as={React.Fragment}
                          leave="transition ease-in duration-100"
                          leaveFrom="opacity-100"
                          leaveTo="opacity-0"
                        >
                          <Listbox.Options className="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-lg bg-white py-1 shadow-lg ring-1 ring-black/5 focus:outline-none text-sm">
                            {batchOptions.map((batch) => (
                              <Listbox.Option
                                key={String(batch.id)}
                                value={batch.id}
                                className={({ active }) =>
                                  clsx(
                                    "relative cursor-pointer select-none py-2 pl-10 pr-4",
                                    active ? "bg-emerald-50 text-emerald-900" : "text-slate-900"
                                  )
                                }
                              >
                                {({ selected }) => (
                                  <>
                                    <span className={clsx("block truncate", selected && "font-medium")}>
                                      {batch.name}
                                    </span>
                                    {selected && (
                                      <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-emerald-600">
                                        <Check size={16} />
                                      </span>
                                    )}
                                  </>
                                )}
                              </Listbox.Option>
                            ))}
                          </Listbox.Options>
                        </Transition>
                      </div>
                    </Listbox>


                    <Listbox
                      value={filters.status}
                      onChange={(v) => updateFilter("status", v)}
                    >
                      <div className="relative">
                        <Listbox.Label className="block text-xs font-medium text-slate-600 mb-1">
                          –°—Ç–∞—Ç—É—Å
                        </Listbox.Label>
                        <Listbox.Button className="relative w-full cursor-pointer rounded-lg bg-white py-2 pl-3 pr-10 text-left border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                          <span className="block truncate">{selectedStatus.label}</span>
                          <span className="absolute inset-y-0 right-0 flex items-center pr-2">
                            <ChevronDown size={16} className="text-slate-400" />
                          </span>
                        </Listbox.Button>
                        <Transition
                          as={React.Fragment}
                          leave="transition ease-in duration-100"
                          leaveFrom="opacity-100"
                          leaveTo="opacity-0"
                        >
                          <Listbox.Options className="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-lg bg-white py-1 shadow-lg ring-1 ring-black/5 focus:outline-none text-sm">
                            {SERVER_STATUSES.map((status) => (
                              <Listbox.Option
                                key={status.value}
                                value={status.value}
                                className={({ active }) =>
                                  clsx(
                                    "relative cursor-pointer select-none py-2 pl-10 pr-4",
                                    active ? "bg-emerald-50 text-emerald-900" : "text-slate-900"
                                  )
                                }
                              >
                                {({ selected }) => (
                                  <>
                                    <span className={clsx("block truncate", selected && "font-medium")}>
                                      {status.label}
                                    </span>
                                    {selected && (
                                      <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-emerald-600">
                                        <Check size={16} />
                                      </span>
                                    )}
                                  </>
                                )}
                              </Listbox.Option>
                            ))}
                          </Listbox.Options>
                        </Transition>
                      </div>
                    </Listbox>


                    <div>
                      <label className="block text-xs font-medium text-slate-600 mb-1">
                        –î–∞—Ç–∞ –æ—Ç
                      </label>
                      <div className="relative">
                        <Calendar size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                        <input
                          type="date"
                          value={filters.dateFrom}
                          onChange={(e) => updateFilter("dateFrom", e.target.value)}
                          className="w-full rounded-lg border border-slate-200 py-2 pl-9 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                        />
                      </div>
                    </div>


                    <div>
                      <label className="block text-xs font-medium text-slate-600 mb-1">
                        –î–∞—Ç–∞ –¥–æ
                      </label>
                      <div className="relative">
                        <Calendar size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                        <input
                          type="date"
                          value={filters.dateTo}
                          onChange={(e) => updateFilter("dateTo", e.target.value)}
                          className="w-full rounded-lg border border-slate-200 py-2 pl-9 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                        />
                      </div>
                    </div>
                  </div>


                  <div className="mt-3 flex items-center gap-4">
                    <div className="flex-1 relative">
                      <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                      <input
                        type="text"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É..."
                        value={filters.search}
                        onChange={(e) => updateFilter("search", e.target.value)}
                        className="w-full rounded-lg border border-slate-200 py-2 pl-9 pr-3 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                      />
                    </div>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={filters.includeArchived}
                        onChange={(e) => updateFilter("includeArchived", e.target.checked)}
                        className="rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                      />
                      <span className="text-sm text-slate-600">–í–∫–ª—é—á–∞—è –∞—Ä—Ö–∏–≤–Ω—ã–µ</span>
                    </label>
                  </div>
                </div>


                <div className="flex border-b border-slate-200">
                  <button
                    onClick={() => setActiveTab("preview")}
                    className={clsx(
                      "flex items-center gap-2 px-6 py-3 text-sm font-medium border-b-2 transition-colors",
                      activeTab === "preview"
                        ? "border-emerald-500 text-emerald-600"
                        : "border-transparent text-slate-500 hover:text-slate-700"
                    )}
                  >
                    <Eye size={16} />
                    –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                    {totalServers > 0 && (
                      <span className="ml-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs">
                        {totalServers}
                      </span>
                    )}
                  </button>
                  <button
                    onClick={() => setActiveTab("stats")}
                    className={clsx(
                      "flex items-center gap-2 px-6 py-3 text-sm font-medium border-b-2 transition-colors",
                      activeTab === "stats"
                        ? "border-emerald-500 text-emerald-600"
                        : "border-transparent text-slate-500 hover:text-slate-700"
                    )}
                  >
                    <BarChart3 size={16} />
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                  </button>
                </div>


                <div className="max-h-96 overflow-y-auto p-6">
                  {activeTab === "preview" ? (
                    <PreviewTab
                      preview={preview}
                      loading={loadingPreview}
                      total={totalServers}
                    />
                  ) : (
                    <StatsTab
                      stats={stats}
                      loading={loadingStats}
                    />
                  )}
                </div>


                <div className="flex items-center justify-between border-t border-slate-200 bg-slate-50 px-6 py-4">
                  <div className="text-sm text-slate-500">
                    {totalServers > 0 ? (
                      <>
                        –ù–∞–π–¥–µ–Ω–æ <span className="font-medium text-slate-700">{totalServers}</span> —Å–µ—Ä–≤–µ—Ä–æ–≤
                        {stats && (
                          <>, <span className="font-medium text-slate-700">{stats.totalComponents}</span> –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</>
                        )}
                      </>
                    ) : (
                      "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞"
                    )}
                  </div>

                  <div className="flex items-center gap-3">
                    <button
                      onClick={onClose}
                      className="rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50"
                    >
                      –û—Ç–º–µ–Ω–∞
                    </button>

                    {selectedServerIds.length > 0 && (
                      <button
                        onClick={handleExportSelected}
                        disabled={exporting}
                        className="flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-50"
                      >
                        {exporting ? (
                          <Loader2 size={16} className="animate-spin" />
                        ) : (
                          <Download size={16} />
                        )}
                        –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö ({selectedServerIds.length})
                      </button>
                    )}

                    <button
                      onClick={handleExport}
                      disabled={exporting || totalServers === 0}
                      className="flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700 disabled:opacity-50"
                    >
                      {exporting ? (
                        <Loader2 size={16} className="animate-spin" />
                      ) : (
                        <FileSpreadsheet size={16} />
                      )}
                      –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                    </button>
                  </div>
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </div>
      </Dialog>
    </Transition>
  );
};


const PreviewTab: React.FC<{
  preview: ServerPreview[];
  loading: boolean;
  total: number;
}> = ({ preview, loading, total }) => {
  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 size={24} className="animate-spin text-emerald-500" />
        <span className="ml-2 text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
      </div>
    );
  }

  if (preview.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-12 text-slate-500">
        <Package size={48} className="text-slate-300 mb-3" />
        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        <p className="text-sm">–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
      </div>
    );
  }

  return (
    <div className="space-y-2">
      {preview.length < total && (
        <p className="text-xs text-slate-500 mb-3">
          –ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ {preview.length} –∏–∑ {total} —Å–µ—Ä–≤–µ—Ä–æ–≤
        </p>
      )}

      {preview.map((server) => (
        <div
          key={server.id}
          className="flex items-center gap-4 rounded-lg border border-slate-200 bg-white p-4 hover:border-slate-300"
        >

          <div className="min-w-40">
            <p className="font-mono font-medium text-slate-900">{server.apkSerialNumber}</p>
            <p className="text-xs text-slate-500">
              {server.batchName || "–ë–µ–∑ –ø–∞—Ä—Ç–∏–∏"}
            </p>
          </div>


          <div className="min-w-24">
            <span className={clsx(
              "inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium",
              server.status === "READY" && "bg-green-100 text-green-700",
              server.status === "IN_PROGRESS" && "bg-blue-100 text-blue-700",
              server.status === "NEW" && "bg-slate-100 text-slate-700",
              server.status === "TESTING" && "bg-amber-100 text-amber-700",
              server.status === "SHIPPED" && "bg-purple-100 text-purple-700"
            )}>
              {server.status}
            </span>
          </div>


          <div className="flex-1 flex items-center gap-3">
            <ComponentBadge
              icon={HardDrive}
              label="HDD"
              count={server.componentsSummary.hdd}
              expected={12}
            />
            <ComponentBadge
              icon={HardDrive}
              label="SSD"
              count={server.componentsSummary.ssd}
              expected={4}
            />
            <ComponentBadge
              icon={MemoryStick}
              label="RAM"
              count={server.componentsSummary.ram}
              expected={12}
            />
            <ComponentBadge
              icon={Zap}
              label="PSU"
              count={server.componentsSummary.psu}
              expected={2}
            />
          </div>


          <div className="min-w-20 text-right">
            <div className={clsx(
              "text-lg font-semibold",
              server.completeness >= 90 && "text-green-600",
              server.completeness >= 50 && server.completeness < 90 && "text-amber-600",
              server.completeness < 50 && "text-red-600"
            )}>
              {server.completeness}%
            </div>
            <p className="text-xs text-slate-500">–ø–æ–ª–Ω–æ—Ç–∞</p>
          </div>
        </div>
      ))}
    </div>
  );
};


const ComponentBadge: React.FC<{
  icon: React.FC<{ className?: string; size?: number }>;
  label: string;
  count: number;
  expected: number;
}> = ({ icon: Icon, label, count, expected }) => {
  const isComplete = count >= expected;

  return (
    <div className={clsx(
      "flex items-center gap-1.5 rounded-full px-2 py-1 text-xs",
      isComplete ? "bg-green-50 text-green-700" : "bg-amber-50 text-amber-700"
    )}>
      <Icon size={12} />
      <span>{label}</span>
      <span className="font-medium">{count}/{expected}</span>
      {isComplete ? (
        <CheckCircle size={12} className="text-green-500" />
      ) : (
        <AlertTriangle size={12} className="text-amber-500" />
      )}
    </div>
  );
};


const StatsTab: React.FC<{
  stats: ExportStats | null;
  loading: boolean;
}> = ({ stats, loading }) => {
  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 size={24} className="animate-spin text-emerald-500" />
        <span className="ml-2 text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</span>
      </div>
    );
  }

  if (!stats) {
    return (
      <div className="flex flex-col items-center justify-center py-12 text-slate-500">
        <BarChart3 size={48} className="text-slate-300 mb-3" />
        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">

      <div className="grid grid-cols-3 gap-4">
        <StatCard
          label="–í—Å–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–æ–≤"
          value={stats.totalServers}
          icon={Server}
          color="emerald"
        />
        <StatCard
          label="–í—Å–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"
          value={stats.totalComponents}
          icon={Package}
          color="blue"
        />
        <StatCard
          label="–° –Ω–µ–ø–æ–ª–Ω–æ–π –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–µ–π"
          value={stats.missingComponents.length}
          icon={AlertTriangle}
          color={stats.missingComponents.length > 0 ? "amber" : "green"}
        />
      </div>


      <div>
        <h4 className="text-sm font-medium text-slate-700 mb-3">–ü–æ —Ç–∏–ø–∞–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</h4>
        <div className="grid grid-cols-4 gap-2">
          {Object.entries(stats.byComponentType).map(([type, count]) => {
            const Icon = COMPONENT_ICONS[type] || Server;
            return (
              <div
                key={type}
                className="flex items-center gap-2 rounded-lg bg-slate-50 px-3 py-2"
              >
                <Icon size={16} className="text-slate-500" />
                <span className="text-sm text-slate-600">{type}</span>
                <span className="ml-auto font-semibold text-slate-900">{count}</span>
              </div>
            );
          })}
        </div>
      </div>


      {Object.keys(stats.byBatch).length > 1 && (
        <div>
          <h4 className="text-sm font-medium text-slate-700 mb-3">–ü–æ –ø–∞—Ä—Ç–∏—è–º</h4>
          <div className="flex flex-wrap gap-2">
            {Object.entries(stats.byBatch).map(([batch, count]) => (
              <span
                key={batch}
                className="inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-sm text-blue-700"
              >
                {batch}: <span className="ml-1 font-semibold">{count}</span>
              </span>
            ))}
          </div>
        </div>
      )}


      {stats.missingComponents.length > 0 && (
        <div>
          <h4 className="text-sm font-medium text-amber-700 mb-3 flex items-center gap-2">
            <AlertTriangle size={16} />
            –°–µ—Ä–≤–µ—Ä—ã —Å –Ω–µ–ø–æ–ª–Ω–æ–π –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–µ–π ({stats.missingComponents.length})
          </h4>
          <div className="space-y-2 max-h-40 overflow-y-auto">
            {stats.missingComponents.slice(0, 10).map((item) => (
              <div
                key={item.serverId}
                className="flex items-center gap-3 rounded-lg bg-amber-50 px-3 py-2 text-sm"
              >
                <span className="font-mono font-medium text-amber-900">
                  {item.apkSerialNumber}
                </span>
                <span className="text-amber-700">
                  –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç: {item.missing.join(", ")}
                </span>
              </div>
            ))}
            {stats.missingComponents.length > 10 && (
              <p className="text-xs text-slate-500">
                ...–∏ –µ—â—ë {stats.missingComponents.length - 10}
              </p>
            )}
          </div>
        </div>
      )}
    </div>
  );
};


const StatCard: React.FC<{
  label: string;
  value: number;
  icon: React.FC<{ className?: string; size?: number }>;
  color: "emerald" | "blue" | "amber" | "green";
}> = ({ label, value, icon: Icon, color }) => {
  const colorClasses = {
    emerald: "bg-emerald-50 text-emerald-600",
    blue: "bg-blue-50 text-blue-600",
    amber: "bg-amber-50 text-amber-600",
    green: "bg-green-50 text-green-600"
  };

  return (
    <div className="rounded-xl border border-slate-200 bg-white p-4">
      <div className="flex items-center gap-3">
        <div className={clsx("rounded-lg p-2", colorClasses[color])}>
          <Icon size={20} />
        </div>
        <div>
          <p className="text-2xl font-bold text-slate-900">{value}</p>
          <p className="text-sm text-slate-500">{label}</p>
        </div>
      </div>
    </div>
  );
};

export default PassportsExportModal;

================================================================================
FILE: QMS-Client-main/src/components/beryll/ServerComponents.tsx
================================================================================



import React, { useState, useEffect, useCallback } from 'react';
import {
  Cpu, MemoryStick, HardDrive, Network, CircuitBoard, Zap, Server,
  RefreshCw, Download, ChevronDown, ChevronUp, Copy, AlertCircle,
  CheckCircle, AlertTriangle, HelpCircle, Trash2, Settings
} from 'lucide-react';
import clsx from 'clsx';
import toast from 'react-hot-toast';

import {
  checkBMC, fetchComponents, getServerComponents, deleteServerComponents
} from '../../api/beryll/componentsAPI';

import type {
  ComponentsResponse, ServerComponent, ComponentType, ComponentStatus
} from '../../types/beryll/components';

import {
  COMPONENT_TYPE_LABELS, COMPONENT_STATUS_LABELS, COMPONENT_STATUS_COLORS
} from '../../types/beryll/components';

interface Props {
  serverId: number;
  serverIp?: string;
}


const TypeIcon: Record<ComponentType, React.FC<{ className?: string }>> = {
  CPU: Cpu,
  RAM: MemoryStick,
  SSD: HardDrive,
  HDD: HardDrive,
  NVME: HardDrive,
  NIC: Network,
  MOTHERBOARD: CircuitBoard,
  PSU: Zap,
  GPU: CircuitBoard,
  RAID: HardDrive,
  BMC: Server,
  OTHER: Settings
};


const StatusIcon: React.FC<{ status: ComponentStatus; className?: string }> = ({ status, className }) => {
  switch (status) {
    case 'OK': return <CheckCircle className={clsx("text-emerald-500", className)} />;
    case 'WARNING': return <AlertTriangle className={clsx("text-amber-500", className)} />;
    case 'CRITICAL': return <AlertCircle className={clsx("text-red-500", className)} />;
    default: return <HelpCircle className={clsx("text-slate-400", className)} />;
  }
};

export const ServerComponents: React.FC<Props> = ({ serverId, serverIp }) => {
  const [data, setData] = useState<ComponentsResponse | null>(null);
  const [loading, setLoading] = useState(true);
  const [fetching, setFetching] = useState(false);
  const [checking, setChecking] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [bmcStatus, setBmcStatus] = useState<{ success: boolean; version?: string } | null>(null);


  const [expanded, setExpanded] = useState<Set<string>>(new Set(['CPU', 'RAM', 'storage']));

  const [expandedDetails, setExpandedDetails] = useState<Set<number>>(new Set());

  const loadComponents = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const result = await getServerComponents(serverId);
      setData(result);
    } catch (e: any) {
      if (e.response?.status !== 404) {
        setError(e.response?.data?.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
      }
    } finally {
      setLoading(false);
    }
  }, [serverId]);

  useEffect(() => {
    loadComponents();
  }, [loadComponents]);


  const handleCheckBMC = async () => {
    try {
      setChecking(true);
      const result = await checkBMC(serverId);
      setBmcStatus({ success: result.success, version: result.redfishVersion });
      if (result.success) {
        toast.success(`BMC –¥–æ—Å—Ç—É–ø–µ–Ω (Redfish ${result.redfishVersion})`);
      } else {
        toast.error(`BMC –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${result.error}`);
      }
    } catch (e: any) {
      toast.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ BMC');
      setBmcStatus({ success: false });
    } finally {
      setChecking(false);
    }
  };


  const handleFetch = async () => {
    try {
      setFetching(true);
      setError(null);
      const result = await fetchComponents(serverId);
      toast.success(result.message);
      await loadComponents();
    } catch (e: any) {
      toast.error(e.response?.data?.message || '–û—à–∏–±–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏');
      setError(e.response?.data?.message);
    } finally {
      setFetching(false);
    }
  };


  const handleDelete = async () => {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ? –ò—Ö –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–≥—Ä—É–∑–∏—Ç—å –∑–∞–Ω–æ–≤–æ.')) return;
    try {
      await deleteServerComponents(serverId);
      toast.success('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ —É–¥–∞–ª–µ–Ω—ã');
      setData(null);
    } catch (e: any) {
      toast.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
  };

  const toggleSection = (section: string) => {
    const newExpanded = new Set(expanded);
    if (newExpanded.has(section)) newExpanded.delete(section);
    else newExpanded.add(section);
    setExpanded(newExpanded);
  };

  const toggleDetails = (id: number) => {
    const newExpanded = new Set(expandedDetails);
    if (newExpanded.has(id)) newExpanded.delete(id);
    else newExpanded.add(id);
    setExpandedDetails(newExpanded);
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast.success('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
  };

  const hasComponents = data && data.components.length > 0;

  return (
    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">

      <div className="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-indigo-100 rounded-lg">
            <CircuitBoard className="w-5 h-5 text-indigo-600" />
          </div>
          <div>
            <h3 className="font-semibold text-slate-800">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</h3>
            {data?.server.lastComponentsFetchAt && (
              <p className="text-xs text-slate-400">
                –û–±–Ω–æ–≤–ª–µ–Ω–æ: {new Date(data.server.lastComponentsFetchAt).toLocaleString()}
              </p>
            )}
          </div>
        </div>

        <div className="flex items-center gap-2">

          <button
            onClick={handleCheckBMC}
            disabled={checking}
            className={clsx(
              "flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-lg transition-all",
              bmcStatus?.success
                ? "bg-emerald-100 text-emerald-700"
                : "bg-slate-100 text-slate-600 hover:bg-slate-200"
            )}
          >
            {checking ? (
              <RefreshCw size={14} className="animate-spin" />
            ) : (
              <Server size={14} />
            )}
            {bmcStatus?.success ? 'BMC OK' : '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å BMC'}
          </button>


          <button
            onClick={handleFetch}
            disabled={fetching}
            className={clsx(
              "flex items-center gap-1.5 px-4 py-1.5 text-sm font-medium rounded-lg transition-all",
              fetching
                ? "bg-slate-200 text-slate-400 cursor-not-allowed"
                : "bg-indigo-600 text-white hover:bg-indigo-700"
            )}
          >
            {fetching ? (
              <RefreshCw size={14} className="animate-spin" />
            ) : (
              <Download size={14} />
            )}
            {hasComponents ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–í—ã–≥—Ä—É–∑–∏—Ç—å —Å BMC'}
          </button>


          {hasComponents && (
            <button
              onClick={handleDelete}
              className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg"
              title="–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ"
            >
              <Trash2 size={16} />
            </button>
          )}
        </div>
      </div>


      {error && (
        <div className="mx-5 mt-4 p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg flex items-center gap-2">
          <AlertCircle size={16} />
          {error}
        </div>
      )}


      {loading && (
        <div className="p-8 flex items-center justify-center">
          <RefreshCw className="w-6 h-6 text-indigo-500 animate-spin" />
        </div>
      )}


      {!loading && !hasComponents && (
        <div className="p-8 text-center">
          <CircuitBoard className="w-12 h-12 text-slate-300 mx-auto mb-3" />
          <p className="text-slate-500 mb-2">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
          <p className="text-sm text-slate-400">
            –ù–∞–∂–º–∏—Ç–µ "–í—ã–≥—Ä—É–∑–∏—Ç—å —Å BMC" —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∂–µ–ª–µ–∑–µ
          </p>
        </div>
      )}


      {!loading && hasComponents && data && (
        <div>

          <div className="px-5 py-4 bg-slate-50 border-b border-slate-200 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <p className="text-xs text-slate-500">–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä</p>
              <p className="font-semibold text-slate-800">
                {data.summary.cpuCores} —è–¥–µ—Ä / {data.summary.cpuThreads} –ø–æ—Ç–æ–∫–æ–≤
              </p>
            </div>
            <div>
              <p className="text-xs text-slate-500">–ü–∞–º—è—Ç—å</p>
              <p className="font-semibold text-slate-800">{data.summary.totalRAM}</p>
            </div>
            <div>
              <p className="text-xs text-slate-500">–ù–∞–∫–æ–ø–∏—Ç–µ–ª–∏</p>
              <p className="font-semibold text-slate-800">{data.summary.totalStorage}</p>
            </div>
            <div>
              <p className="text-xs text-slate-500">–í—Å–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</p>
              <p className="font-semibold text-slate-800">{data.summary.totalComponents}</p>
            </div>
          </div>


          <div className="divide-y divide-slate-100">

            {data.grouped.CPU.length > 0 && (
              <ComponentSection
                title="–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã"
                icon={Cpu}
                components={data.grouped.CPU}
                expanded={expanded.has('CPU')}
                onToggle={() => toggleSection('CPU')}
                expandedDetails={expandedDetails}
                onToggleDetails={toggleDetails}
                onCopy={copyToClipboard}
                renderDetails={(c) => (
                  <>
                    <Detail label="–Ø–¥—Ä–∞" value={c.metadata?.cores?.toString()} />
                    <Detail label="–ü–æ—Ç–æ–∫–∏" value={c.metadata?.threads?.toString()} />
                    <Detail label="–ß–∞—Å—Ç–æ—Ç–∞" value={c.speedFormatted} />
                    <Detail label="–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞" value={c.metadata?.architecture} />
                  </>
                )}
              />
            )}


            {data.grouped.RAM.length > 0 && (
              <ComponentSection
                title="–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å"
                icon={MemoryStick}
                components={data.grouped.RAM}
                expanded={expanded.has('RAM')}
                onToggle={() => toggleSection('RAM')}
                expandedDetails={expandedDetails}
                onToggleDetails={toggleDetails}
                onCopy={copyToClipboard}
                renderDetails={(c) => (
                  <>
                    <Detail label="–û–±—ä—ë–º" value={c.capacityFormatted} />
                    <Detail label="–¢–∏–ø" value={c.metadata?.memoryType} />
                    <Detail label="–ß–∞—Å—Ç–æ—Ç–∞" value={c.speed ? `${c.speed} MT/s` : undefined} />
                    <Detail label="–†–∞–Ω–≥" value={c.metadata?.rank?.toString()} />
                  </>
                )}
              />
            )}


            {data.grouped.storage.length > 0 && (
              <ComponentSection
                title="–ù–∞–∫–æ–ø–∏—Ç–µ–ª–∏"
                icon={HardDrive}
                components={data.grouped.storage}
                expanded={expanded.has('storage')}
                onToggle={() => toggleSection('storage')}
                expandedDetails={expandedDetails}
                onToggleDetails={toggleDetails}
                onCopy={copyToClipboard}
                renderDetails={(c) => (
                  <>
                    <Detail label="–û–±—ä—ë–º" value={c.capacityFormatted} />
                    <Detail label="–¢–∏–ø" value={c.metadata?.mediaType} />
                    <Detail label="–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å" value={c.metadata?.interface} />
                    <Detail label="–ü—Ä–æ—à–∏–≤–∫–∞" value={c.firmwareVersion} />
                  </>
                )}
              />
            )}


            {data.grouped.NIC.length > 0 && (
              <ComponentSection
                title="–°–µ—Ç–µ–≤—ã–µ –∞–¥–∞–ø—Ç–µ—Ä—ã"
                icon={Network}
                components={data.grouped.NIC}
                expanded={expanded.has('NIC')}
                onToggle={() => toggleSection('NIC')}
                expandedDetails={expandedDetails}
                onToggleDetails={toggleDetails}
                onCopy={copyToClipboard}
                renderDetails={(c) => (
                  <>
                    <Detail label="MAC" value={c.metadata?.macAddress} copyable onCopy={copyToClipboard} />
                    <Detail label="–°–∫–æ—Ä–æ—Å—Ç—å" value={c.metadata?.linkSpeed} />
                  </>
                )}
              />
            )}


            {data.grouped.other.length > 0 && (
              <ComponentSection
                title="–î—Ä—É–≥–æ–µ"
                icon={Settings}
                components={data.grouped.other}
                expanded={expanded.has('other')}
                onToggle={() => toggleSection('other')}
                expandedDetails={expandedDetails}
                onToggleDetails={toggleDetails}
                onCopy={copyToClipboard}
                renderDetails={(c) => (
                  <>
                    <Detail label="–ü—Ä–æ—à–∏–≤–∫–∞" value={c.firmwareVersion} />
                  </>
                )}
              />
            )}
          </div>
        </div>
      )}
    </div>
  );
};


interface SectionProps {
  title: string;
  icon: React.FC<{ className?: string }>;
  components: ServerComponent[];
  expanded: boolean;
  onToggle: () => void;
  expandedDetails: Set<number>;
  onToggleDetails: (id: number) => void;
  onCopy: (text: string) => void;
  renderDetails: (component: ServerComponent) => React.ReactNode;
}

const ComponentSection: React.FC<SectionProps> = ({
  title, icon: Icon, components, expanded, onToggle,
  expandedDetails, onToggleDetails, onCopy, renderDetails
}) => (
  <div>
    <button
      onClick={onToggle}
      className="w-full px-5 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors"
    >
      <div className="flex items-center gap-3">
        <Icon className="w-5 h-5 text-slate-400" />
        <span className="font-medium text-slate-700">{title}</span>
        <span className="text-sm text-slate-400">({components.length})</span>
      </div>
      {expanded ? <ChevronUp size={18} className="text-slate-400" /> : <ChevronDown size={18} className="text-slate-400" />}
    </button>

    {expanded && (
      <div className="px-5 pb-4 space-y-2">
        {components.map((c) => (
          <div key={c.id} className="border border-slate-200 rounded-lg overflow-hidden">

            <div
              className="px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-slate-50"
              onClick={() => onToggleDetails(c.id)}
            >
              <div className="flex items-center gap-3 flex-1 min-w-0">
                <StatusIcon status={c.status} className="w-4 h-4 flex-shrink-0" />
                <div className="min-w-0">
                  <p className="font-medium text-slate-800 truncate">
                    {c.name || `${c.manufacturer || ''} ${c.model || COMPONENT_TYPE_LABELS[c.componentType]}`}
                  </p>
                  <p className="text-xs text-slate-500 truncate">
                    {c.slot && <span className="mr-2">–°–ª–æ—Ç: {c.slot}</span>}
                    {c.serialNumber && <span>S/N: {c.serialNumber}</span>}
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-2">

                {c.capacityFormatted && c.capacityFormatted !== '0 B' && (
                  <span className="text-sm font-medium text-slate-600 bg-slate-100 px-2 py-0.5 rounded">
                    {c.capacityFormatted}
                  </span>
                )}
                {expandedDetails.has(c.id) ? (
                  <ChevronUp size={16} className="text-slate-400" />
                ) : (
                  <ChevronDown size={16} className="text-slate-400" />
                )}
              </div>
            </div>


            {expandedDetails.has(c.id) && (
              <div className="px-4 py-3 bg-slate-50 border-t border-slate-200">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                  <Detail label="–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å" value={c.manufacturer} />
                  <Detail label="–ú–æ–¥–µ–ª—å" value={c.model} />
                  <Detail label="S/N" value={c.serialNumber} copyable onCopy={onCopy} />
                  <Detail label="P/N" value={c.partNumber} />
                  {renderDetails(c)}
                  <Detail label="–°—Ç–∞—Ç—É—Å" value={COMPONENT_STATUS_LABELS[c.status]} />
                  <Detail label="Health" value={c.metadata?.health} />
                </div>
              </div>
            )}
          </div>
        ))}
      </div>
    )}
  </div>
);


interface DetailProps {
  label: string;
  value?: string;
  copyable?: boolean;
  onCopy?: (text: string) => void;
}

const Detail: React.FC<DetailProps> = ({ label, value, copyable, onCopy }) => {
  if (!value) return null;
  return (
    <div>
      <p className="text-xs text-slate-500">{label}</p>
      <div className="flex items-center gap-1">
        <p className="text-slate-700 font-medium truncate">{value}</p>
        {copyable && onCopy && (
          <button
            onClick={(e) => { e.stopPropagation(); onCopy(value); }}
            className="p-0.5 text-slate-400 hover:text-slate-600"
          >
            <Copy size={12} />
          </button>
        )}
      </div>
    </div>
  );
};

export default ServerComponents;

================================================================================
FILE: QMS-Client-main/src/components/beryll/ServerComponentsManager.tsx
================================================================================

import React, { useState, useEffect, useCallback, useRef } from 'react';
import { createPortal } from 'react-dom';
import {
  Cpu, MemoryStick, HardDrive, Network, CircuitBoard, Zap, Server,
  RefreshCw, Download, ChevronDown, ChevronUp, Copy, AlertCircle,
  CheckCircle, AlertTriangle, HelpCircle, Trash2, Settings, Plus,
  Edit2, X, Save, ScanLine, ArrowRightLeft, Search, Package, GitMerge
} from 'lucide-react';
import clsx from 'clsx';
import toast from 'react-hot-toast';

import { $authHost } from '../../api/index';


const BASE_URL = "/api/beryll";

async function checkBMC(serverId: number) {
  const { data } = await $authHost.get(`${BASE_URL}/servers/${serverId}/bmc/check`);
  return data;
}


async function fetchComponentsFromBMC(
  serverId: number,
  mode: 'compare' | 'force' | 'merge' = 'compare',
  preserveManual: boolean = true
) {
  const { data } = await $authHost.post(
    `${BASE_URL}/servers/${serverId}/components/fetch`,
    { mode, preserveManual }
  );
  return data;
}

async function getServerComponents(serverId: number) {
  const { data } = await $authHost.get(`${BASE_URL}/servers/${serverId}/components`);
  return data;
}

async function addServerComponent(serverId: number, componentData: any) {
  const { data } = await $authHost.post(`${BASE_URL}/servers/${serverId}/components`, componentData);
  return data;
}

async function updateServerComponent(componentId: number, updates: any) {
  const { data } = await $authHost.put(`${BASE_URL}/components/${componentId}`, updates);
  return data;
}

async function updateComponentSerials(componentId: number, serials: { serialNumber?: string; serialNumberYadro?: string }) {
  const { data } = await $authHost.patch(`${BASE_URL}/components/${componentId}/serials`, serials);
  return data;
}

async function replaceServerComponent(componentId: number, replacementData: any) {
  const { data } = await $authHost.post(`${BASE_URL}/components/${componentId}/replace`, replacementData);
  return data;
}

async function deleteComponent(componentId: number, reason?: string) {
  const { data } = await $authHost.delete(`${BASE_URL}/components/${componentId}`, { data: { reason } });
  return data;
}


async function fetchCatalogByType(componentType: string) {
  const { data } = await $authHost.get(`${BASE_URL}/catalog`, {
    params: { type: componentType }
  });
  return data;
}


type ComponentType = 'CPU' | 'RAM' | 'HDD' | 'SSD' | 'NVME' | 'NIC' | 'MOTHERBOARD' | 'PSU' | 'GPU' | 'RAID' | 'BMC' | 'OTHER';
type ComponentStatus = 'OK' | 'WARNING' | 'CRITICAL' | 'UNKNOWN' | 'REPLACED';

interface ServerComponent {
  id: number;
  serverId: number;
  componentType: ComponentType;
  name: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  serialNumberYadro?: string;
  partNumber?: string;
  slot?: string;
  capacity?: number;
  speed?: string;
  status: ComponentStatus;
  healthPercent?: number;
  firmwareVersion?: string;
  metadata?: any;
}

interface ComponentsResponse {
  server: any;
  summary: {
    totalRAMBytes: number;
    totalStorageBytes: number;
    totalRAM: string;
    totalStorage: string;
    cpuCores: number;
    cpuThreads: number;
    totalComponents: number;
  };
  grouped: any;
  components: ServerComponent[];
}

interface BMCComparisonResult {
  success: boolean;
  mode: 'compare';
  hasDiscrepancies: boolean;
  summary: {
    total: { inDb: number; inBmc: number };
    matched: number;
    missingInBmc: number;
    newInBmc: number;
    mismatches: number;
  };
  details: {
    matched: any[];
    missingInBmc: any[];
    newInBmc: any[];
    mismatches: any[];
  };
  message?: string;
}

interface Props {
  serverId: number;
  serverIp?: string;
  apkSerialNumber?: string;
  readOnly?: boolean;
}


interface CatalogRevisionEntry {
  revision: string;
  label: string;
  manufacturer?: string;
  model?: string;
  partNumber?: string;
}

const COMPONENT_TYPES: { value: ComponentType; label: string }[] = [
  { value: 'CPU', label: '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä' },
  { value: 'RAM', label: '–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å' },
  { value: 'HDD', label: '–ñ—ë—Å—Ç–∫–∏–π –¥–∏—Å–∫' },
  { value: 'SSD', label: '–¢–≤–µ—Ä–¥–æ—Ç–µ–ª—å–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å' },
  { value: 'NVME', label: 'NVMe –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å' },
  { value: 'NIC', label: '–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞' },
  { value: 'MOTHERBOARD', label: '–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞' },
  { value: 'PSU', label: '–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è' },
  { value: 'GPU', label: '–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞' },
  { value: 'RAID', label: 'RAID-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä' },
  { value: 'BMC', label: 'BMC' },
  { value: 'OTHER', label: '–ü—Ä–æ—á–µ–µ' }
];

const COMPONENT_STATUS_LABELS: Record<ComponentStatus, string> = {
  OK: '–ò—Å–ø—Ä–∞–≤–µ–Ω',
  WARNING: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
  CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ',
  UNKNOWN: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
  REPLACED: '–ó–∞–º–µ–Ω—ë–Ω'
};

const COMPONENT_STATUS_COLORS: Record<ComponentStatus, string> = {
  OK: 'bg-emerald-100 text-emerald-700 border-emerald-300',
  WARNING: 'bg-amber-100 text-amber-700 border-amber-300',
  CRITICAL: 'bg-red-100 text-red-700 border-red-300',
  UNKNOWN: 'bg-slate-100 text-slate-500 border-slate-300',
  REPLACED: 'bg-violet-100 text-violet-700 border-violet-300'
};


const TypeIcon: Record<ComponentType, React.FC<{ className?: string; size?: number }>> = {
  CPU: Cpu,
  RAM: MemoryStick,
  SSD: HardDrive,
  HDD: HardDrive,
  NVME: HardDrive,
  NIC: Network,
  MOTHERBOARD: CircuitBoard,
  PSU: Zap,
  GPU: CircuitBoard,
  RAID: HardDrive,
  BMC: Server,
  OTHER: Settings
};


const StatusIcon: React.FC<{ status: ComponentStatus; className?: string }> = ({ status, className }) => {
  switch (status) {
    case 'OK': return <CheckCircle className={clsx('text-emerald-500', className)} size={18} />;
    case 'WARNING': return <AlertTriangle className={clsx('text-amber-500', className)} size={18} />;
    case 'CRITICAL': return <AlertCircle className={clsx('text-red-500', className)} size={18} />;
    case 'REPLACED': return <ArrowRightLeft className={clsx('text-violet-500', className)} size={18} />;
    default: return <HelpCircle className={clsx('text-slate-400', className)} size={18} />;
  }
};


function formatBytes(bytes: number | string | null | undefined): string {
  if (!bytes) return '‚Äî';
  const b = typeof bytes === 'string' ? parseInt(bytes) : bytes;
  if (isNaN(b) || b === 0) return '‚Äî';

  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(b) / Math.log(1024));
  return `${(b / Math.pow(1024, i)).toFixed(i > 2 ? 1 : 0)} ${units[i]}`;
}


const TYPE_PLACEHOLDERS: Record<ComponentType, {
  manufacturer: string;
  model: string;
  name: string;
  slot: string;
  capacity: string;
  speed: string;
}> = {
  CPU: {
    manufacturer: 'Intel, AMD',
    model: 'Xeon Gold 6348',
    name: 'Intel Xeon Gold 6348 2.6GHz',
    slot: 'CPU_1, CPU_2',
    capacity: '–Ø–¥—Ä–∞: 28',
    speed: '2.6 GHz'
  },
  RAM: {
    manufacturer: 'Samsung, Micron, SK Hynix',
    model: 'M393A8G40BB4-CWE',
    name: 'Samsung 64GB DDR4',
    slot: 'DIMM_A1, DIMM_B1',
    capacity: '64',
    speed: '3200 MT/s'
  },
  SSD: {
    manufacturer: 'Samsung, Intel, Micron',
    model: 'MZQL21T9HCJR',
    name: 'Samsung PM9A3 1.92TB',
    slot: 'SSD_1, SSD_2',
    capacity: '1920',
    speed: '6800 MB/s'
  },
  HDD: {
    manufacturer: 'Seagate, WD, Toshiba',
    model: 'ST18000NM000J',
    name: 'Seagate Exos X18 18TB',
    slot: 'HDD_1, HDD_2',
    capacity: '18000',
    speed: '7200 RPM'
  },
  NVME: {
    manufacturer: 'Samsung, Intel, Micron',
    model: 'MZQL21T9HCJR',
    name: 'Samsung PM9A3 NVMe 1.92TB',
    slot: 'NVME_1, M.2_1',
    capacity: '1920',
    speed: '6800 MB/s'
  },
  NIC: {
    manufacturer: 'Intel, Mellanox, Broadcom',
    model: 'E810-XXVDA2',
    name: 'Intel E810 25GbE',
    slot: 'PCI_1, OCP_1',
    capacity: '',
    speed: '25 Gbps'
  },
  MOTHERBOARD: {
    manufacturer: 'Supermicro, ASUS, Dell',
    model: 'X12SPL-F',
    name: 'Supermicro X12SPL-F',
    slot: '',
    capacity: '',
    speed: ''
  },
  PSU: {
    manufacturer: 'Delta, Lite-On, FSP',
    model: 'DPS-1200FB',
    name: 'Delta 1200W Platinum',
    slot: 'PSU_1, PSU_2',
    capacity: '1200',
    speed: ''
  },
  GPU: {
    manufacturer: 'NVIDIA, AMD',
    model: 'A100-SXM4-80GB',
    name: 'NVIDIA A100 80GB',
    slot: 'GPU_1, PCI_1',
    capacity: '80',
    speed: ''
  },
  RAID: {
    manufacturer: 'Broadcom, LSI, Dell',
    model: '9460-16i',
    name: 'Broadcom MegaRAID 9460-16i',
    slot: 'PCI_1, RAID_1',
    capacity: '',
    speed: '12 Gbps'
  },
  BMC: {
    manufacturer: 'ASPEED, Nuvoton',
    model: 'AST2600',
    name: 'ASPEED AST2600 BMC',
    slot: '',
    capacity: '',
    speed: ''
  },
  OTHER: {
    manufacturer: '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å',
    model: '–ú–æ–¥–µ–ª—å',
    name: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞',
    slot: '–°–ª–æ—Ç',
    capacity: '',
    speed: ''
  }
};


interface ComponentFormData {
  componentType: ComponentType;
  name: string;
  manufacturer: string;
  model: string;
  serialNumber: string;
  serialNumberYadro: string;
  partNumber: string;
  slot: string;
  status: ComponentStatus;
  revision?: string;
  capacity?: string;
  speed?: string;
}

interface ComponentModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (data: ComponentFormData) => Promise<void>;
  initialData?: Partial<ComponentFormData>;
  title: string;
  isReplacement?: boolean;
}

const ComponentModal: React.FC<ComponentModalProps> = ({
  isOpen, onClose, onSave, initialData, title, isReplacement
}) => {

  const [formData, setFormData] = useState<ComponentFormData>({
    componentType: 'RAM',
    name: '',
    manufacturer: '',
    model: '',
    serialNumber: '',
    serialNumberYadro: '',
    partNumber: '',
    slot: '',
    status: 'OK',
    revision: '',
    capacity: '',
    speed: ''
  });
  const [saving, setSaving] = useState(false);
  const yadroInputRef = useRef<HTMLInputElement>(null);


  const [catalogRevisions, setCatalogRevisions] = useState<CatalogRevisionEntry[]>([]);
  const [loadingRevisions, setLoadingRevisions] = useState(false);
  const [customRevision, setCustomRevision] = useState(false);

  useEffect(() => {
    if (initialData) {
      setFormData(prev => ({ ...prev, ...initialData }));
    } else {

      setFormData({
        componentType: 'RAM',
        name: '',
        manufacturer: '',
        model: '',
        serialNumber: '',
        serialNumberYadro: '',
        partNumber: '',
        slot: '',
        status: 'OK',
        revision: '',
        capacity: '',
        speed: ''
      });
    }
  }, [initialData, isOpen]);

  useEffect(() => {
    if (isOpen && yadroInputRef.current) {
      setTimeout(() => yadroInputRef.current?.focus(), 100);
    }
  }, [isOpen]);


  useEffect(() => {
    if (!isOpen || !formData.componentType) {
      setCatalogRevisions([]);
      setCustomRevision(false);
      return;
    }

    let cancelled = false;

    const fetchRevisions = async () => {
      setLoadingRevisions(true);
      try {
        const data = await fetchCatalogByType(formData.componentType);

        if (cancelled) return;


        const revMap = new Map<string, CatalogRevisionEntry>();
        for (const entry of data) {
          if (entry.revision) {
            const label = [
              entry.manufacturer || '',
              entry.model || '',
              `rev. ${entry.revision}`
            ].filter(Boolean).join(' ').trim();


            const key = `${entry.model || ''}__${entry.revision}`;
            if (!revMap.has(key)) {
              revMap.set(key, {
                revision: entry.revision,
                label,
                manufacturer: entry.manufacturer || undefined,
                model: entry.model || undefined,
                partNumber: entry.partNumber || undefined
              });
            }
          }
        }

        const revisions = Array.from(revMap.values())
          .sort((a, b) => {

            const modelCmp = (a.model || '').localeCompare(b.model || '');
            if (modelCmp !== 0) return modelCmp;
            return a.revision.localeCompare(b.revision, undefined, { numeric: true });
          });

        setCatalogRevisions(revisions);


        if (formData.revision) {
          const exists = revisions.some(r => r.revision === formData.revision);
          if (!exists && revisions.length > 0) {
            setCustomRevision(true);
          }
        }
      } catch (err) {
        console.error('Failed to load catalog revisions:', err);
        if (!cancelled) {
          setCatalogRevisions([]);
        }
      } finally {
        if (!cancelled) {
          setLoadingRevisions(false);
        }
      }
    };

    fetchRevisions();
    setCustomRevision(false);

    return () => { cancelled = true; };
  }, [isOpen, formData.componentType]);

  const handleChange = (field: keyof ComponentFormData, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };


  const handleRevisionSelect = (selectedRevision: string) => {
    if (selectedRevision === '__custom__') {
      setCustomRevision(true);
      handleChange('revision', '');
      return;
    }

    handleChange('revision', selectedRevision);


    if (selectedRevision) {
      const entry = catalogRevisions.find(r => r.revision === selectedRevision);
      if (entry) {
        setFormData(prev => ({
          ...prev,
          revision: selectedRevision,

          manufacturer: prev.manufacturer || entry.manufacturer || '',
          model: prev.model || entry.model || '',
          partNumber: prev.partNumber || entry.partNumber || ''
        }));
      }
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!formData.componentType) {
      toast.error('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–≥–æ');
      return;
    }

    if (!formData.serialNumberYadro && !formData.serialNumber) {
      toast.error('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä');
      return;
    }

    setSaving(true);
    try {
      await onSave(formData);
      onClose();
    } catch (err) {
      console.error('Save error:', err);
    } finally {
      setSaving(false);
    }
  };

  if (!isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm" style={{ zIndex: 9999 }}>
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
        <div className="px-6 py-4 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-violet-600">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {isReplacement ? (
                <ArrowRightLeft className="text-white/90" size={22} />
              ) : (
                <Plus className="text-white/90" size={22} />
              )}
              <h2 className="text-lg font-semibold text-white">{title}</h2>
            </div>
            <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-colors">
              <X className="text-white" size={20} />
            </button>
          </div>
        </div>


        <form onSubmit={handleSubmit} className="p-6 space-y-5 overflow-y-auto max-h-[calc(90vh-140px)]">
          <div className="p-4 bg-amber-50 border-2 border-amber-200 rounded-xl">
            <label className="flex items-center gap-2 text-sm font-semibold text-amber-800 mb-2">
              <ScanLine size={18} />
              –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä Yadro (–Ω–∞–∫–ª–µ–π–∫–∞)
            </label>
            <input
              ref={yadroInputRef}
              type="text"
              value={formData.serialNumberYadro}
              onChange={(e) => handleChange('serialNumberYadro', e.target.value)}
              className="w-full px-4 py-3 bg-white border-2 border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400 text-lg font-mono"
              placeholder="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ S/N Yadro"
              autoComplete="off"
            />
            <p className="mt-1.5 text-xs text-amber-600">
              –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Å –Ω–∞–∫–ª–µ–π–∫–∏ Yadro –Ω–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–º
            </p>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–¢–∏–ø –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–≥–æ *</label>
              <select
                value={formData.componentType}
                onChange={(e) => handleChange('componentType', e.target.value as ComponentType)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                disabled={isReplacement}
              >
                {COMPONENT_TYPES.map(t => (
                  <option key={t.value} value={t.value}>{t.label}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–°—Ç–∞—Ç—É—Å</label>
              <select
                value={formData.status}
                onChange={(e) => handleChange('status', e.target.value as ComponentStatus)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              >
                <option value="OK">–ò—Å–ø—Ä–∞–≤–µ–Ω</option>
                <option value="WARNING">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
                <option value="CRITICAL">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ</option>
                <option value="UNKNOWN">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</option>
              </select>
            </div>
          </div>


          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è</label>
              <input
                type="text"
                value={formData.serialNumber}
                onChange={(e) => handleChange('serialNumber', e.target.value)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono"
                placeholder="–ó–∞–≤–æ–¥—Å–∫–æ–π S/N"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–°–ª–æ—Ç / –ü–æ–∑–∏—Ü–∏—è</label>
              <input
                type="text"
                value={formData.slot}
                onChange={(e) => handleChange('slot', e.target.value)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder={TYPE_PLACEHOLDERS[formData.componentType]?.slot || '–°–ª–æ—Ç'}
              />
            </div>
          </div>


          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
              <input
                type="text"
                value={formData.manufacturer}
                onChange={(e) => handleChange('manufacturer', e.target.value)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder={TYPE_PLACEHOLDERS[formData.componentType]?.manufacturer || '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å'}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–ú–æ–¥–µ–ª—å</label>
              <input
                type="text"
                value={formData.model}
                onChange={(e) => handleChange('model', e.target.value)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder={TYPE_PLACEHOLDERS[formData.componentType]?.model || '–ú–æ–¥–µ–ª—å'}
              />
            </div>
          </div>


          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">Part Number (P/N)</label>
              <input
                type="text"
                value={formData.partNumber}
                onChange={(e) => handleChange('partNumber', e.target.value)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono"
                placeholder="–ê—Ä—Ç–∏–∫—É–ª"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => handleChange('name', e.target.value)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder={TYPE_PLACEHOLDERS[formData.componentType]?.name || '–ù–∞–∑–≤–∞–Ω–∏–µ'}
              />
            </div>
          </div>


          <div className="grid grid-cols-3 gap-4">


            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–†–µ–≤–∏–∑–∏—è</label>

              {loadingRevisions ? (

                <div className="w-full px-3 py-2.5 border border-slate-200 rounded-lg bg-slate-50 flex items-center gap-2 text-sm text-slate-400">
                  <RefreshCw size={14} className="animate-spin" />
                  –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
              ) : catalogRevisions.length > 0 && !customRevision ? (

                <div className="space-y-1">
                  <select
                    value={formData.revision || ''}
                    onChange={(e) => handleRevisionSelect(e.target.value)}
                    className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                  >
                    <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≤–∏–∑–∏—é ‚Äî</option>
                    {catalogRevisions.map((r, idx) => (
                      <option key={`${r.revision}-${idx}`} value={r.revision}>
                        {r.label}
                      </option>
                    ))}
                    <option value="__custom__">‚úèÔ∏è –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é...</option>
                  </select>
                </div>
              ) : (

                <div className="space-y-1">
                  <input
                    type="text"
                    value={formData.revision}
                    onChange={(e) => handleChange('revision', e.target.value)}
                    className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Rev.A, Rev.1.0..."
                  />
                  {catalogRevisions.length > 0 && (
                    <button
                      type="button"
                      onClick={() => { setCustomRevision(false); handleChange('revision', ''); }}
                      className="text-xs text-indigo-600 hover:text-indigo-700 hover:underline transition-colors"
                    >
                      ‚Üê –í—ã–±—Ä–∞—Ç—å –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
                    </button>
                  )}
                </div>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–û–±—ä—ë–º (GB)</label>
              <input
                type="text"
                value={formData.capacity}
                onChange={(e) => handleChange('capacity', e.target.value)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder={TYPE_PLACEHOLDERS[formData.componentType]?.capacity || '–û–±—ä—ë–º'}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1.5">–ß–∞—Å—Ç–æ—Ç–∞ / –°–∫–æ—Ä–æ—Å—Ç—å</label>
              <input
                type="text"
                value={formData.speed}
                onChange={(e) => handleChange('speed', e.target.value)}
                className="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder={TYPE_PLACEHOLDERS[formData.componentType]?.speed || '–°–∫–æ—Ä–æ—Å—Ç—å'}
              />
            </div>
          </div>
        </form>


        <div className="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
          <button
            type="button"
            onClick={onClose}
            className="px-5 py-2.5 text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors font-medium"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            onClick={handleSubmit}
            disabled={saving}
            className="px-5 py-2.5 text-white bg-gradient-to-r from-indigo-600 to-violet-600 rounded-lg hover:from-indigo-700 hover:to-violet-700 transition-all font-medium flex items-center gap-2 disabled:opacity-50"
          >
            {saving ? (
              <>
                <RefreshCw size={18} className="animate-spin" />
                –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
              </>
            ) : (
              <>
                <Save size={18} />
                {isReplacement ? '–ó–∞–º–µ–Ω–∏—Ç—å' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
              </>
            )}
          </button>
        </div>
      </div>
    </div>,
    document.body
  );
};


interface EditSerialsModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (serials: { serialNumber: string; serialNumberYadro: string }) => Promise<void>;
  component: ServerComponent;
}

const EditSerialsModal: React.FC<EditSerialsModalProps> = ({
  isOpen, onClose, onSave, component
}) => {
  const [serialNumber, setSerialNumber] = useState(component.serialNumber || '');
  const [serialNumberYadro, setSerialNumberYadro] = useState(component.serialNumberYadro || '');
  const [saving, setSaving] = useState(false);
  const yadroInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    setSerialNumber(component.serialNumber || '');
    setSerialNumberYadro(component.serialNumberYadro || '');
  }, [component]);

  useEffect(() => {
    if (isOpen && yadroInputRef.current) {
      setTimeout(() => yadroInputRef.current?.focus(), 100);
    }
  }, [isOpen]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!serialNumber && !serialNumberYadro) {
      toast.error('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä');
      return;
    }

    setSaving(true);
    try {
      await onSave({ serialNumber, serialNumberYadro });
      onClose();
    } catch (err) {
      console.error('Save serials error:', err);
    } finally {
      setSaving(false);
    }
  };

  if (!isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm" style={{ zIndex: 9999 }}>
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

        <div className="px-6 py-4 border-b border-slate-200 bg-gradient-to-r from-emerald-600 to-teal-600">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <ScanLine className="text-white/90" size={22} />
              <div>
                <h2 className="text-lg font-semibold text-white">–ò–∑–º–µ–Ω–∏—Ç—å —Å–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞</h2>
                <p className="text-sm text-white/70">{component.name}</p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-colors">
              <X className="text-white" size={20} />
            </button>
          </div>
        </div>


        <form onSubmit={handleSubmit} className="p-6 space-y-5">

          <div className="p-3 bg-slate-50 rounded-lg text-sm">
            <p className="text-slate-600">
              <span className="font-medium">–¢–∏–ø:</span> {COMPONENT_TYPES.find(t => t.value === component.componentType)?.label || component.componentType}
              {component.slot && <span className="ml-3"><span className="font-medium">–°–ª–æ—Ç:</span> {component.slot}</span>}
            </p>
          </div>


          <div className="p-4 bg-amber-50 border-2 border-amber-200 rounded-xl">
            <label className="flex items-center gap-2 text-sm font-semibold text-amber-800 mb-2">
              <ScanLine size={18} />
              S/N Yadro (–Ω–∞–∫–ª–µ–π–∫–∞)
            </label>
            <input
              ref={yadroInputRef}
              type="text"
              value={serialNumberYadro}
              onChange={(e) => setSerialNumberYadro(e.target.value)}
              className="w-full px-4 py-3 bg-white border-2 border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400 text-lg font-mono"
              placeholder="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ"
              autoComplete="off"
            />
          </div>


          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1.5">
              S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è (–∑–∞–≤–æ–¥—Å–∫–æ–π)
            </label>
            <input
              type="text"
              value={serialNumber}
              onChange={(e) => setSerialNumber(e.target.value)}
              className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono"
              placeholder="–ó–∞–≤–æ–¥—Å–∫–æ–π —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä"
            />
          </div>
        </form>


        <div className="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
          <button
            type="button"
            onClick={onClose}
            className="px-5 py-2.5 text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors font-medium"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            onClick={handleSubmit}
            disabled={saving}
            className="px-5 py-2.5 text-white bg-gradient-to-r from-emerald-600 to-teal-600 rounded-lg hover:from-emerald-700 hover:to-teal-700 transition-all font-medium flex items-center gap-2 disabled:opacity-50"
          >
            {saving ? (
              <>
                <RefreshCw size={18} className="animate-spin" />
                –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
              </>
            ) : (
              <>
                <Save size={18} />
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </>
            )}
          </button>
        </div>
      </div>
    </div>,
    document.body
  );
};


interface SyncModeModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSelectMode: (mode: 'force' | 'merge', preserveManual: boolean) => void;
  comparisonResult: BMCComparisonResult | null;
  syncing: boolean;
}

const SyncModeModal: React.FC<SyncModeModalProps> = ({
  isOpen, onClose, onSelectMode, comparisonResult, syncing
}) => {
  if (!isOpen || !comparisonResult) return null;

  const totalDiscrepancies =
    (comparisonResult.summary?.missingInBmc || 0) +
    (comparisonResult.summary?.newInBmc || 0) +
    (comparisonResult.summary?.mismatches || 0);

  return createPortal(
    <div className="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" style={{ zIndex: 9999 }}>
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative overflow-hidden">

        <div className="flex items-center gap-3 px-6 py-4 border-b bg-amber-50">
          <AlertTriangle className="w-6 h-6 text-amber-600 flex-shrink-0" />
          <div className="flex-1">
            <h3 className="font-semibold text-gray-800">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è</h3>
            <p className="text-sm text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å BMC</p>
          </div>
          <button
            onClick={onClose}
            disabled={syncing}
            className="p-2 hover:bg-amber-100 rounded-lg transition-colors disabled:opacity-50"
          >
            <X className="w-5 h-5 text-gray-500" />
          </button>
        </div>


        <div className="px-6 py-4">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <div className="text-center p-3 bg-gray-50 rounded-lg">
              <div className="text-xl font-bold text-gray-700">
                {comparisonResult.summary?.total?.inDb || 0}
              </div>
              <div className="text-xs text-gray-500">–í –±–∞–∑–µ</div>
            </div>
            <div className="text-center p-3 bg-gray-50 rounded-lg">
              <div className="text-xl font-bold text-gray-700">
                {comparisonResult.summary?.total?.inBmc || 0}
              </div>
              <div className="text-xs text-gray-500">–í BMC</div>
            </div>
            <div className="text-center p-3 bg-green-50 rounded-lg">
              <div className="text-xl font-bold text-green-600">
                {comparisonResult.summary?.matched || 0}
              </div>
              <div className="text-xs text-gray-500">–°–æ–≤–ø–∞–¥–∞—é—Ç</div>
            </div>
            <div className="text-center p-3 bg-amber-50 rounded-lg">
              <div className="text-xl font-bold text-amber-600">
                {totalDiscrepancies}
              </div>
              <div className="text-xs text-gray-500">–†–∞–∑–ª–∏—á–∏–π</div>
            </div>
          </div>


          <div className="space-y-2 text-sm mb-4 p-3 bg-slate-50 rounded-lg">
            {comparisonResult.summary?.newInBmc > 0 && (
              <div className="flex items-center gap-2 text-blue-600">
                <Plus size={14} />
                <span>–ù–æ–≤—ã—Ö –≤ BMC: <strong>{comparisonResult.summary.newInBmc}</strong></span>
              </div>
            )}
            {comparisonResult.summary?.missingInBmc > 0 && (
              <div className="flex items-center gap-2 text-amber-600">
                <AlertTriangle size={14} />
                <span>–ù–µ—Ç –≤ BMC: <strong>{comparisonResult.summary.missingInBmc}</strong></span>
              </div>
            )}
            {comparisonResult.summary?.mismatches > 0 && (
              <div className="flex items-center gap-2 text-orange-600">
                <ArrowRightLeft size={14} />
                <span>–†–∞–∑–ª–∏—á–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö: <strong>{comparisonResult.summary.mismatches}</strong></span>
              </div>
            )}
          </div>
        </div>


        <div className="px-6 py-4 border-t bg-gray-50 space-y-3">

          <button
            onClick={() => onSelectMode('merge', true)}
            disabled={syncing}
            className="w-full flex items-center justify-center gap-3 px-4 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 disabled:opacity-50 font-medium transition-colors shadow-lg shadow-green-200"
          >
            <GitMerge className="w-5 h-5" />
            <div className="text-left">
              <div>–£–º–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ</div>
              <div className="text-xs font-normal opacity-80">–î–æ–±–∞–≤–∏—Ç –Ω–æ–≤—ã–µ, –æ–±–Ω–æ–≤–∏—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ</div>
            </div>
          </button>


          <button
            onClick={() => onSelectMode('force', true)}
            disabled={syncing}
            className="w-full flex items-center justify-center gap-3 px-4 py-2.5 bg-amber-600 text-white rounded-xl hover:bg-amber-700 disabled:opacity-50 transition-colors"
          >
            <RefreshCw className="w-5 h-5" />
            <div className="text-left">
              <div>–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å</div>
              <div className="text-xs font-normal opacity-80">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä—É—á–Ω—ã–µ –∑–∞–ø–∏—Å–∏</div>
            </div>
          </button>


          <button
            onClick={() => onSelectMode('force', false)}
            disabled={syncing}
            className="w-full flex items-center justify-center gap-3 px-4 py-2 border-2 border-red-300 text-red-600 rounded-xl hover:bg-red-50 disabled:opacity-50 transition-colors"
          >
            <Trash2 className="w-5 h-5" />
            <div className="text-left">
              <div>–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å</div>
              <div className="text-xs font-normal opacity-70">–£–¥–∞–ª–∏—Ç—å —Ä—É—á–Ω—ã–µ –∑–∞–ø–∏—Å–∏</div>
            </div>
          </button>


          <button
            onClick={onClose}
            disabled={syncing}
            className="w-full px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-xl transition-colors"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
        </div>


        {syncing && (
          <div className="absolute inset-0 bg-white/90 flex flex-col items-center justify-center rounded-2xl">
            <RefreshCw className="w-8 h-8 text-indigo-600 animate-spin mb-3" />
            <p className="text-gray-600 font-medium">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</p>
          </div>
        )}
      </div>
    </div>,
    document.body
  );
};


interface ComponentCardProps {
  component: ServerComponent;
  onEdit: (component: ServerComponent) => void;
  onEditSerials: (component: ServerComponent) => void;
  onReplace: (component: ServerComponent) => void;
  onDelete: (component: ServerComponent) => void;
  readOnly?: boolean;
}

const ComponentCard: React.FC<ComponentCardProps> = ({
  component, onEdit, onEditSerials, onReplace, onDelete, readOnly
}) => {
  const [expanded, setExpanded] = useState(false);
  const Icon = TypeIcon[component.componentType] || Settings;

  const copySerial = (serial: string, type: string) => {
    navigator.clipboard.writeText(serial);
    toast.success(`${type} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω`);
  };

  return (
    <div className="bg-white border border-slate-200 rounded-xl overflow-hidden hover:shadow-md transition-shadow">

      <div
        className="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-slate-50"
        onClick={() => setExpanded(!expanded)}
      >
        <div className="flex items-center gap-3 flex-1 min-w-0">
          <StatusIcon status={component.status} className="flex-shrink-0" />
          <Icon className="text-slate-500 flex-shrink-0" size={20} />
          <div className="flex-1 min-w-0">
            <div className="font-medium text-slate-900 truncate">
              {component.name || `${component.manufacturer || ''} ${component.model || ''}`}
            </div>
            <div className="text-xs text-slate-500 flex items-center gap-2 flex-wrap">
              {component.slot && (
                <span className="px-1.5 py-0.5 bg-slate-100 rounded text-slate-600">
                  {component.slot}
                </span>
              )}
              {component.serialNumberYadro && (
                <span className="text-amber-600 font-mono">Yadro: {component.serialNumberYadro}</span>
              )}
              {component.serialNumber && component.serialNumber !== component.serialNumberYadro && (
                <span className="font-mono">S/N: {component.serialNumber}</span>
              )}
            </div>
          </div>
        </div>

        <div className="flex items-center gap-2">
          {component.serialNumberYadro && (
            <span className="px-2 py-1 bg-amber-100 text-amber-700 text-xs font-medium rounded-lg flex items-center gap-1">
              <Package size={12} />
              Yadro
            </span>
          )}
          <span className={clsx(
            'px-2 py-1 text-xs font-medium rounded-lg border',
            COMPONENT_STATUS_COLORS[component.status]
          )}>
            {COMPONENT_STATUS_LABELS[component.status]}
          </span>
          {expanded ? <ChevronUp size={18} className="text-slate-400" /> : <ChevronDown size={18} className="text-slate-400" />}
        </div>
      </div>


      {expanded && (
        <div className="px-4 py-4 border-t border-slate-100 bg-slate-50/50">
          <div className="grid grid-cols-2 lg:grid-cols-3 gap-4 text-sm">

            <div className="col-span-2 lg:col-span-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
              <label className="text-xs font-medium text-amber-700 flex items-center gap-1 mb-1">
                <Package size={12} />
                S/N Yadro (–Ω–∞–∫–ª–µ–π–∫–∞)
              </label>
              <div className="flex items-center gap-2">
                <span className="font-mono text-amber-900 text-base">
                  {component.serialNumberYadro || '‚Äî –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî'}
                </span>
                {component.serialNumberYadro && (
                  <button
                    onClick={(e) => { e.stopPropagation(); copySerial(component.serialNumberYadro!, 'S/N Yadro'); }}
                    className="p-1 hover:bg-amber-100 rounded"
                    title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
                  >
                    <Copy size={14} className="text-amber-600" />
                  </button>
                )}
              </div>
            </div>

            <div>
              <label className="text-xs text-slate-500">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
              <p className="font-medium text-slate-800">{component.manufacturer || '‚Äî'}</p>
            </div>
            <div>
              <label className="text-xs text-slate-500">–ú–æ–¥–µ–ª—å</label>
              <p className="font-medium text-slate-800">{component.model || '‚Äî'}</p>
            </div>
            <div>
              <label className="text-xs text-slate-500">S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è</label>
              <div className="flex items-center gap-1">
                <span className="font-mono text-slate-800">{component.serialNumber || '‚Äî'}</span>
                {component.serialNumber && (
                  <button
                    onClick={(e) => { e.stopPropagation(); copySerial(component.serialNumber!, 'S/N'); }}
                    className="p-1 hover:bg-slate-100 rounded"
                  >
                    <Copy size={12} className="text-slate-400" />
                  </button>
                )}
              </div>
            </div>
            <div>
              <label className="text-xs text-slate-500">P/N</label>
              <p className="font-mono text-slate-800">{component.partNumber || '‚Äî'}</p>
            </div>
            {component.metadata?.revision && (
              <div>
                <label className="text-xs text-slate-500">–†–µ–≤–∏–∑–∏—è</label>
                <p className="font-medium text-slate-800">{component.metadata.revision}</p>
              </div>
            )}
            {component.capacity && (
              <div>
                <label className="text-xs text-slate-500">–û–±—ä—ë–º</label>
                <p className="font-medium text-slate-800">{formatBytes(component.capacity)}</p>
              </div>
            )}
            {component.speed && (
              <div>
                <label className="text-xs text-slate-500">–ß–∞—Å—Ç–æ—Ç–∞</label>
                <p className="font-medium text-slate-800">{component.speed}</p>
              </div>
            )}
            {component.metadata?.rank && (
              <div>
                <label className="text-xs text-slate-500">–†–∞–Ω–≥</label>
                <p className="font-medium text-slate-800">{component.metadata.rank}</p>
              </div>
            )}
            {component.metadata?.memoryType && (
              <div>
                <label className="text-xs text-slate-500">–¢–∏–ø –ø–∞–º—è—Ç–∏</label>
                <p className="font-medium text-slate-800">{component.metadata.memoryType}</p>
              </div>
            )}
          </div>


          {!readOnly && (
            <div className="flex flex-wrap justify-end gap-2 mt-4 pt-3 border-t border-slate-200">
              <button
                onClick={(e) => { e.stopPropagation(); onEditSerials(component); }}
                className="px-3 py-1.5 text-sm text-emerald-600 hover:bg-emerald-50 rounded-lg flex items-center gap-1.5 transition-colors"
                title="–ë—ã—Å—Ç—Ä–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–µ—Ä–∏–π–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤"
              >
                <ScanLine size={14} />
                –ò–∑–º–µ–Ω–∏—Ç—å S/N
              </button>
              <button
                onClick={(e) => { e.stopPropagation(); onEdit(component); }}
                className="px-3 py-1.5 text-sm text-indigo-600 hover:bg-indigo-50 rounded-lg flex items-center gap-1.5 transition-colors"
              >
                <Edit2 size={14} />
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
              </button>
              <button
                onClick={(e) => { e.stopPropagation(); onReplace(component); }}
                className="px-3 py-1.5 text-sm text-amber-600 hover:bg-amber-50 rounded-lg flex items-center gap-1.5 transition-colors"
              >
                <ArrowRightLeft size={14} />
                –ó–∞–º–µ–Ω–∞
              </button>
              <button
                onClick={(e) => { e.stopPropagation(); onDelete(component); }}
                className="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-1.5 transition-colors"
              >
                <Trash2 size={14} />
                –£–¥–∞–ª–∏—Ç—å
              </button>
            </div>
          )}
        </div>
      )}
    </div>
  );
};


const ServerComponentsManager: React.FC<Props> = ({
  serverId, serverIp, apkSerialNumber, readOnly = false
}) => {
  const [loading, setLoading] = useState(true);
  const [data, setData] = useState<ComponentsResponse | null>(null);
  const [fetchingFromBmc, setFetchingFromBmc] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');


  const [showAddModal, setShowAddModal] = useState(false);
  const [editingComponent, setEditingComponent] = useState<ServerComponent | null>(null);
  const [editingSerialsComponent, setEditingSerialsComponent] = useState<ServerComponent | null>(null);
  const [replacingComponent, setReplacingComponent] = useState<ServerComponent | null>(null);
  const [confirmDelete, setConfirmDelete] = useState<ServerComponent | null>(null);


  const [syncModalOpen, setSyncModalOpen] = useState(false);
  const [comparisonResult, setComparisonResult] = useState<BMCComparisonResult | null>(null);
  const [syncing, setSyncing] = useState(false);


  const [typeFilter, setTypeFilter] = useState<ComponentType | 'ALL'>('ALL');


  const loadComponents = useCallback(async () => {
    setLoading(true);
    try {
      const response = await getServerComponents(serverId);
      setData(response);
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö');
    } finally {
      setLoading(false);
    }
  }, [serverId]);

  useEffect(() => {
    loadComponents();
  }, [loadComponents]);


  const handleFetchFromBmc = async () => {
    setFetchingFromBmc(true);
    try {

      const result = await fetchComponentsFromBMC(serverId, 'compare');

      const dbCount = result.summary?.total?.inDb || 0;
      const bmcCount = result.summary?.total?.inBmc || 0;


      if (dbCount === 0 && bmcCount > 0) {
        const syncResult = await fetchComponentsFromBMC(serverId, 'force', true);
        toast.success(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${syncResult.components?.length || bmcCount} –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö —Å BMC`);
        await loadComponents();
        return;
      }


      if (result.hasDiscrepancies && dbCount > 0) {
        setComparisonResult(result);
        setSyncModalOpen(true);
      } else if (bmcCount > 0) {

        const syncResult = await fetchComponentsFromBMC(serverId, 'force', true);
        toast.success(syncResult.message || `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${syncResult.components?.length || 0} –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö`);
        await loadComponents();
      } else {

        toast.info('BMC –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö');
      }
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏ —Å BMC');
    } finally {
      setFetchingFromBmc(false);
    }
  };


  const handleSyncWithMode = async (mode: 'force' | 'merge', preserveManual: boolean) => {
    setSyncing(true);
    try {
      const result = await fetchComponentsFromBMC(serverId, mode, preserveManual);

      if (mode === 'merge') {
        const { actions } = result;
        toast.success(
          `–°–ª–∏—è–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${actions?.updated?.length || 0}, –¥–æ–±–∞–≤–ª–µ–Ω–æ ${actions?.added?.length || 0}`
        );
        if (actions?.flaggedForReview?.length > 0) {
          toast.warning(`${actions.flaggedForReview.length} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç(–æ–≤) —Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏`);
        }
      } else {
        toast.success(result.message || `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${result.components?.length || 0} –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö`);
      }

      setSyncModalOpen(false);
      setComparisonResult(null);
      await loadComponents();
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
    } finally {
      setSyncing(false);
    }
  };


  const handleCloseSyncModal = () => {
    if (!syncing) {
      setSyncModalOpen(false);
      setComparisonResult(null);
    }
  };


  const handleAddComponent = async (formData: ComponentFormData) => {
    try {
      await addServerComponent(serverId, {
        componentType: formData.componentType,
        name: formData.name || `${formData.manufacturer || ''} ${formData.model || formData.componentType}`.trim(),
        manufacturer: formData.manufacturer,
        model: formData.model,
        serialNumber: formData.serialNumber,
        serialNumberYadro: formData.serialNumberYadro,
        partNumber: formData.partNumber,
        slot: formData.slot,
        status: formData.status,
        capacity: formData.capacity ? parseInt(formData.capacity) * 1024 * 1024 * 1024 : undefined,
        speed: formData.speed,
        metadata: formData.revision ? { revision: formData.revision } : undefined
      });
      toast.success('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
      await loadComponents();
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
      throw err;
    }
  };


  const handleEditComponent = async (formData: ComponentFormData) => {
    if (!editingComponent) return;

    try {
      const existingMetadata = (editingComponent as any).metadata || {};
      await updateServerComponent(editingComponent.id, {
        name: formData.name,
        manufacturer: formData.manufacturer,
        model: formData.model,
        serialNumber: formData.serialNumber,
        serialNumberYadro: formData.serialNumberYadro,
        partNumber: formData.partNumber,
        slot: formData.slot,
        status: formData.status,
        metadata: {
          ...existingMetadata,
          revision: formData.revision || null
        }
      });
      toast.success('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
      setEditingComponent(null);
      await loadComponents();
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
      throw err;
    }
  };


  const handleEditSerials = async (serials: { serialNumber: string; serialNumberYadro: string }) => {
    if (!editingSerialsComponent) return;

    try {
      await updateComponentSerials(editingSerialsComponent.id, {
        serialNumber: serials.serialNumber || undefined,
        serialNumberYadro: serials.serialNumberYadro || undefined
      });
      toast.success('–°–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
      setEditingSerialsComponent(null);
      await loadComponents();
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
      throw err;
    }
  };


  const handleReplaceComponent = async (formData: ComponentFormData) => {
    if (!replacingComponent) return;

    try {
      await replaceServerComponent(replacingComponent.id, {
        newSerialNumber: formData.serialNumber,
        newSerialNumberYadro: formData.serialNumberYadro,
        newManufacturer: formData.manufacturer,
        newModel: formData.model,
        newPartNumber: formData.partNumber,
        reason: '–ó–∞–º–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–≥–æ'
      });
      toast.success('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –∑–∞–º–µ–Ω–µ–Ω–æ');
      setReplacingComponent(null);
      await loadComponents();
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ –∑–∞–º–µ–Ω—ã');
      throw err;
    }
  };


  const handleDeleteComponent = async () => {
    if (!confirmDelete) return;

    try {
      await deleteComponent(confirmDelete.id);
      toast.success('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ —É–¥–∞–ª–µ–Ω–æ');
      setConfirmDelete(null);
      await loadComponents();
    } catch (err: any) {
      toast.error(err.response?.data?.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
  };


  const filteredComponents = data?.components?.filter(c => {
    const matchesType = typeFilter === 'ALL' || c.componentType === typeFilter;
    const matchesSearch = !searchQuery ||
      c.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      c.serialNumber?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      c.serialNumberYadro?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      c.manufacturer?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      c.model?.toLowerCase().includes(searchQuery.toLowerCase());
    return matchesType && matchesSearch;
  }) || [];


  const groupedComponents = filteredComponents.reduce((acc, c) => {
    const type = c.componentType;
    if (!acc[type]) acc[type] = [];
    acc[type].push(c);
    return acc;
  }, {} as Record<string, ServerComponent[]>);

  return (
    <div className="space-y-6">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h2 className="text-xl font-bold text-slate-900 flex items-center gap-2">
            <Package className="text-indigo-600" />
            –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
          </h2>
          {data?.summary && (
            <p className="text-sm text-slate-500 mt-1">
              –í—Å–µ–≥–æ: {data.summary.totalComponents} ‚Ä¢
              RAM: {data.summary.totalRAM} ‚Ä¢
              –ù–∞–∫–æ–ø–∏—Ç–µ–ª–∏: {data.summary.totalStorage}
            </p>
          )}
        </div>

        <div className="flex items-center gap-2">
          {!readOnly && (
            <>
              <button
                onClick={() => setShowAddModal(true)}
                className="px-4 py-2 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-lg hover:from-indigo-700 hover:to-violet-700 transition-all font-medium flex items-center gap-2 shadow-lg shadow-indigo-200"
              >
                <Plus size={18} />
                –î–æ–±–∞–≤–∏—Ç—å
              </button>
              <button
                onClick={handleFetchFromBmc}
                disabled={fetchingFromBmc}
                className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium flex items-center gap-2 disabled:opacity-50"
              >
                {fetchingFromBmc ? (
                  <RefreshCw size={18} className="animate-spin" />
                ) : (
                  <Download size={18} />
                )}
                BMC
              </button>
            </>
          )}
          <button
            onClick={loadComponents}
            disabled={loading}
            className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
            title="–û–±–Ω–æ–≤–∏—Ç—å"
          >
            <RefreshCw size={20} className={loading ? 'animate-spin' : ''} />
          </button>
        </div>
      </div>


      <div className="flex flex-col sm:flex-row gap-3">
        <div className="relative flex-1">
          <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="–ü–æ–∏—Å–∫ –ø–æ S/N, –º–æ–¥–µ–ª–∏, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—é..."
            className="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          />
        </div>
        <select
          value={typeFilter}
          onChange={(e) => setTypeFilter(e.target.value as ComponentType | 'ALL')}
          className="px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
        >
          <option value="ALL">–í—Å–µ —Ç–∏–ø—ã</option>
          {COMPONENT_TYPES.map(t => (
            <option key={t.value} value={t.value}>{t.label}</option>
          ))}
        </select>
      </div>


      {loading && (
        <div className="flex items-center justify-center py-12">
          <RefreshCw size={32} className="text-indigo-600 animate-spin" />
        </div>
      )}


      {!loading && filteredComponents.length === 0 && (
        <div className="text-center py-12 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200">
          <Package size={48} className="mx-auto text-slate-300 mb-3" />
          <p className="text-slate-500 mb-4">
            {searchQuery ? '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã'}
          </p>
          {!readOnly && !searchQuery && (
            <div className="flex items-center justify-center gap-3">
              <button
                onClick={() => setShowAddModal(true)}
                className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium inline-flex items-center gap-2"
              >
                <Plus size={18} />
                –î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
              </button>
              <button
                onClick={handleFetchFromBmc}
                disabled={fetchingFromBmc}
                className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium inline-flex items-center gap-2 disabled:opacity-50"
              >
                {fetchingFromBmc ? (
                  <RefreshCw size={18} className="animate-spin" />
                ) : (
                  <Download size={18} />
                )}
                –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å BMC
              </button>
            </div>
          )}
        </div>
      )}


      {!loading && Object.keys(groupedComponents).length > 0 && (
        <div className="space-y-6">
          {Object.entries(groupedComponents).map(([type, components]) => {
            const TypeIconComp = TypeIcon[type as ComponentType] || Settings;
            const typeLabel = COMPONENT_TYPES.find(t => t.value === type)?.label || type;

            return (
              <div key={type}>
                <h3 className="flex items-center gap-2 text-sm font-semibold text-slate-700 mb-3">
                  <TypeIconComp size={18} />
                  {typeLabel}
                  <span className="px-2 py-0.5 bg-slate-100 text-slate-500 rounded-full text-xs">
                    {components.length}
                  </span>
                </h3>
                <div className="space-y-2">
                  {components.map(component => (
                    <ComponentCard
                      key={component.id}
                      component={component}
                      onEdit={setEditingComponent}
                      onEditSerials={setEditingSerialsComponent}
                      onReplace={setReplacingComponent}
                      onDelete={setConfirmDelete}
                      readOnly={readOnly}
                    />
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      )}


      <ComponentModal
        isOpen={showAddModal}
        onClose={() => setShowAddModal(false)}
        onSave={handleAddComponent}
        title="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ"
      />


      <ComponentModal
        isOpen={!!editingComponent}
        onClose={() => setEditingComponent(null)}
        onSave={handleEditComponent}
        initialData={editingComponent ? {
          componentType: editingComponent.componentType,
          name: editingComponent.name || '',
          manufacturer: editingComponent.manufacturer || '',
          model: editingComponent.model || '',
          serialNumber: editingComponent.serialNumber || '',
          serialNumberYadro: editingComponent.serialNumberYadro || '',
          partNumber: editingComponent.partNumber || '',
          slot: editingComponent.slot || '',
          status: editingComponent.status,
          revision: (editingComponent as any).metadata?.revision || ''
        } : undefined}
        title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ"
      />


      <ComponentModal
        isOpen={!!replacingComponent}
        onClose={() => setReplacingComponent(null)}
        onSave={handleReplaceComponent}
        initialData={replacingComponent ? {
          componentType: replacingComponent.componentType,
          name: '',
          manufacturer: '',
          model: '',
          serialNumber: '',
          serialNumberYadro: '',
          partNumber: '',
          slot: replacingComponent.slot || '',
          status: 'OK'
        } : undefined}
        title={`–ó–∞–º–µ–Ω–∞: ${replacingComponent?.name || ''}`}
        isReplacement
      />


      {editingSerialsComponent && (
        <EditSerialsModal
          isOpen={!!editingSerialsComponent}
          onClose={() => setEditingSerialsComponent(null)}
          onSave={handleEditSerials}
          component={editingSerialsComponent}
        />
      )}


      <SyncModeModal
        isOpen={syncModalOpen}
        onClose={handleCloseSyncModal}
        onSelectMode={handleSyncWithMode}
        comparisonResult={comparisonResult}
        syncing={syncing}
      />


      {confirmDelete && createPortal(
        <div className="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm" style={{ zIndex: 9999 }}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div className="flex items-center gap-3 text-red-600 mb-4">
              <AlertCircle size={24} />
              <h3 className="text-lg font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            </div>
            <p className="text-slate-600 mb-6">
              –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ{' '}
              <strong>{confirmDelete.name}</strong>?
            </p>
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setConfirmDelete(null)}
                className="px-4 py-2 text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleDeleteComponent}
                className="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors"
              >
                –£–¥–∞–ª–∏—Ç—å
              </button>
            </div>
          </div>
        </div>,
        document.body
      )}
    </div>
  );
};

export default ServerComponentsManager;

================================================================================
FILE: QMS-Client-main/src/components/common/Preloader.tsx
================================================================================

export const Preloader: React.FC = () => {
  return (
    <div className="flex justify-center items-center h-64">
      <div className="w-8 h-8 border-4 border-t-4 border-red-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/common/PreloaderMini.tsx
================================================================================

export const PreloaderMini: React.FC = () => {
  return (
    <div className="w-full h-full">
      <div className="w-8 h-8 border-4 border-t-4 border-red-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/widgets/ProductionWidget.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  Factory, TrendingUp, Package, Wrench, Calendar,
  ChevronRight, Loader2, Award
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { fetchUserSummary, fetchOutputs, ProductionOutput } from "src/api/productionApi";
import { PRODUCTION_ROUTE } from "src/utils/consts";

interface Props {
  userId: number;
}

interface TodaySummary {
  total: number;
  pending: number;
  approved: number;
  byOperation: { name: string; qty: number }[];
}


export const ProductionWidget: React.FC<Props> = ({ userId }) => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [summary, setSummary] = useState<TodaySummary>({
    total: 0,
    pending: 0,
    approved: 0,
    byOperation: []
  });
  const [recentEntries, setRecentEntries] = useState<ProductionOutput[]>([]);

  useEffect(() => {
    const loadData = async () => {
      if (!userId) return;

      setLoading(true);
      try {
        const today = new Date().toISOString().split("T")[0];


        const res = await fetchOutputs({
          userId,
          dateFrom: today,
          dateTo: today,
          limit: 10
        });

        const entries = res.rows;
        setRecentEntries(entries.slice(0, 3));


        let total = 0;
        let pending = 0;
        let approved = 0;
        const opsMap = new Map<string, number>();

        entries.forEach(e => {
          const qty = e.status === "APPROVED" ? (e.approvedQty || 0) : e.quantity;
          total += qty;

          if (e.status === "PENDING") pending += e.quantity;
          if (e.status === "APPROVED") approved += (e.approvedQty || 0);

          const opName = e.operationType?.name || "–î—Ä—É–≥–æ–µ";
          opsMap.set(opName, (opsMap.get(opName) || 0) + qty);
        });

        setSummary({
          total,
          pending,
          approved,
          byOperation: [...opsMap.entries()]
            .map(([name, qty]) => ({ name, qty }))
            .sort((a, b) => b.qty - a.qty)
            .slice(0, 3)
        });

      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã—Ä–∞–±–æ—Ç–∫–∏:", e);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, [userId]);

  if (loading) {
    return (
      <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <div className="flex items-center justify-center py-8">
          <Loader2 className="animate-spin text-emerald-500" size={24} />
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">

      <div className="px-6 py-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Factory size={24} />
            <div>
              <h3 className="font-bold text-lg">–ú–æ—è –≤—ã—Ä–∞–±–æ—Ç–∫–∞</h3>
              <p className="text-emerald-100 text-sm">–°–µ–≥–æ–¥–Ω—è</p>
            </div>
          </div>
          <div className="text-right">
            <div className="text-3xl font-black">{summary.total}</div>
            <div className="text-emerald-100 text-xs">–µ–¥–∏–Ω–∏—Ü</div>
          </div>
        </div>
      </div>


      <div className="px-6 py-4 border-b border-gray-100">
        <div className="flex gap-4">
          <div className="flex-1 text-center">
            <div className="text-2xl font-bold text-emerald-600">{summary.approved}</div>
            <div className="text-xs text-gray-500">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</div>
          </div>
          {summary.pending > 0 && (
            <div className="flex-1 text-center">
              <div className="text-2xl font-bold text-yellow-600">{summary.pending}</div>
              <div className="text-xs text-gray-500">–û–∂–∏–¥–∞–µ—Ç</div>
            </div>
          )}
        </div>
      </div>


      {summary.byOperation.length > 0 && (
        <div className="px-6 py-4 border-b border-gray-100">
          <p className="text-xs text-gray-400 mb-2 uppercase font-medium">–ü–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º</p>
          <div className="space-y-2">
            {summary.byOperation.map((op, idx) => (
              <div key={idx} className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Wrench size={14} className="text-gray-400" />
                  <span className="text-sm text-gray-700">{op.name}</span>
                </div>
                <span className="font-semibold text-gray-800">{op.qty}</span>
              </div>
            ))}
          </div>
        </div>
      )}


      {recentEntries.length > 0 && (
        <div className="px-6 py-4 border-b border-gray-100">
          <p className="text-xs text-gray-400 mb-2 uppercase font-medium">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</p>
          <div className="space-y-2">
            {recentEntries.map(entry => (
              <div
                key={entry.id}
                className={`flex items-center justify-between text-sm p-2 rounded-lg ${
                  entry.status === "APPROVED" ? "bg-emerald-50" : "bg-yellow-50"
                }`}
              >
                <div>
                  <span className="font-medium text-gray-800">
                    {entry.productType?.name}
                  </span>
                  <span className="text-gray-400 mx-1">‚Ä¢</span>
                  <span className="text-gray-500">{entry.operationType?.name}</span>
                </div>
                <span className={`font-bold ${
                  entry.status === "APPROVED" ? "text-emerald-600" : "text-yellow-600"
                }`}>
                  {entry.status === "APPROVED" ? entry.approvedQty : entry.quantity}
                </span>
              </div>
            ))}
          </div>
        </div>
      )}


      {summary.total === 0 && (
        <div className="px-6 py-8 text-center">
          <Package size={40} className="mx-auto text-gray-300 mb-2" />
          <p className="text-gray-500 text-sm">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</p>
          <p className="text-gray-400 text-xs mt-1">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –æ –≤—ã—Ä–∞–±–æ—Ç–∫–µ</p>
        </div>
      )}


      <button
        onClick={() => navigate(PRODUCTION_ROUTE)}
        className="w-full px-6 py-3 bg-gray-50 hover:bg-gray-100 transition flex items-center justify-center gap-2 text-gray-600 font-medium"
      >
        –ü–µ—Ä–µ–π—Ç–∏ –≤ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
        <ChevronRight size={18} />
      </button>
    </div>
  );
};


export const ProductionWidgetCompact: React.FC<Props> = ({ userId }) => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [todayTotal, setTodayTotal] = useState(0);
  const [weekTotal, setWeekTotal] = useState(0);

  useEffect(() => {
    const loadData = async () => {
      if (!userId) return;

      setLoading(true);
      try {
        const today = new Date().toISOString().split("T")[0];


        const todayRes = await fetchOutputs({
          userId,
          dateFrom: today,
          dateTo: today,
          status: "APPROVED"
        });

        const todaySum = todayRes.rows.reduce((sum, e) => sum + (e.approvedQty || 0), 0);
        setTodayTotal(todaySum);


        const weekStart = new Date();
        const day = weekStart.getDay() || 7;
        weekStart.setDate(weekStart.getDate() - day + 1);

        const weekRes = await fetchOutputs({
          userId,
          dateFrom: weekStart.toISOString().split("T")[0],
          dateTo: today,
          status: "APPROVED"
        });

        const weekSum = weekRes.rows.reduce((sum, e) => sum + (e.approvedQty || 0), 0);
        setWeekTotal(weekSum);

      } catch (e) {
        console.error(e);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, [userId]);

  return (
    <button
      onClick={() => navigate(PRODUCTION_ROUTE)}
      className="w-full bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-4 text-white text-left hover:shadow-lg transition group"
    >
      <div className="flex items-center justify-between mb-3">
        <Factory size={20} />
        <ChevronRight size={18} className="opacity-0 group-hover:opacity-100 transition" />
      </div>

      {loading ? (
        <Loader2 className="animate-spin" size={20} />
      ) : (
        <>
          <div className="text-3xl font-black mb-1">{todayTotal}</div>
          <div className="text-emerald-100 text-sm">—Å–µ–≥–æ–¥–Ω—è</div>

          <div className="mt-3 pt-3 border-t border-white/20 flex items-center gap-2">
            <TrendingUp size={14} />
            <span className="text-sm">{weekTotal} –∑–∞ –Ω–µ–¥–µ–ª—é</span>
          </div>
        </>
      )}
    </button>
  );
};


export const ProductionLeaderboardWidget: React.FC = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [leaders, setLeaders] = useState<any[]>([]);

  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      try {


        setLeaders([]);
      } catch (e) {
        console.error(e);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, []);

  if (loading) {
    return (
      <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <Loader2 className="animate-spin text-emerald-500 mx-auto" size={24} />
      </div>
    );
  }

  return (
    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
      <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Award className="text-yellow-500" size={20} />
          <h3 className="font-bold text-gray-800">–õ–∏–¥–µ—Ä—ã –¥–Ω—è</h3>
        </div>
        <span className="text-xs text-gray-400">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</span>
      </div>

      {leaders.length > 0 ? (
        <div className="divide-y divide-gray-100">
          {leaders.map((user, idx) => (
            <div key={user.id} className="px-6 py-3 flex items-center gap-3">
              <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                idx === 0 ? "bg-yellow-100 text-yellow-700" :
                idx === 1 ? "bg-gray-200 text-gray-600" :
                idx === 2 ? "bg-orange-100 text-orange-700" :
                "bg-gray-100 text-gray-500"
              }`}>
                {idx + 1}
              </div>
              <div className="flex-1">
                <p className="font-medium text-gray-800 text-sm">
                  {user.surname} {user.name}
                </p>
                <p className="text-xs text-gray-400">{user.teamName}</p>
              </div>
              <div className="text-right">
                <p className="font-bold text-emerald-600">{user.output}</p>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div className="px-6 py-8 text-center text-gray-500 text-sm">
          –î–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–µ –ø–æ—Å—Ç—É–ø–∏–ª–∏
        </div>
      )}

      <button
        onClick={() => navigate(PRODUCTION_ROUTE)}
        className="w-full px-6 py-3 bg-gray-50 hover:bg-gray-100 transition text-gray-600 text-sm font-medium"
      >
        –°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ
      </button>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/hooks/useBetaflyData.ts
================================================================================

import { useEffect, useRef, useState } from "react";

export interface BetaflyDevice {
  port: string;
  attitude?: { roll: number; pitch: number; yaw: number };
  altitude?: { estAlt: number; vario: number };
  analog?: { amperage: number; vbat?: number; rssi?: number };
  timestamp?: number;
}

export function useBetaflyData(socketKey: number) {
  const [devices, setDevices] = useState<BetaflyDevice[]>([]);
  const [deviceHighlight, setDeviceHighlight] = useState<{ [key: string]: "green" | "red" }>({});
  const [checking, setChecking] = useState(false);

  const devicesRef = useRef<BetaflyDevice[]>([]);
  const timeouts = useRef<Record<string, NodeJS.Timeout>>({});
  const checkTimer = useRef<NodeJS.Timeout | null>(null);


  useEffect(() => {
    const ws = new WebSocket("ws://localhost:8090");


    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

     const incomingDevices: BetaflyDevice[] = Array.isArray(data.devices)
          ? data.devices
          : data.port
          ? [data]
          : [];

        if (incomingDevices.length > 0) {
          setDevices((prev) => {
            const updated = [...prev];

            incomingDevices.forEach((incoming) => {
              const idx = updated.findIndex((d) => d.port === incoming.port);
              if (idx >= 0) {
                updated[idx] = incoming;
              } else {
                updated.push(incoming);
              }


              if (timeouts.current[incoming.port]) {
                clearTimeout(timeouts.current[incoming.port]);
              }


              timeouts.current[incoming.port] = setTimeout(() => {
                setDevices((current) =>
                  current.filter((d) => d.port !== incoming.port)
                );
              }, 2000);
            });

            devicesRef.current = updated;
            return updated;
          });
        }

      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WS:", err);
      }
    };

    ws.onerror = (err) => {
      console.error("–û—à–∏–±–∫–∞ WebSocket:", err);
    };

    return () => {
      ws.close();
      Object.values(timeouts.current).forEach(clearTimeout);

    };
  }, [socketKey]);


  const startChecking = () => {
    if (checking === true) return;

    setChecking(true);
    setDeviceHighlight({});
    if (checkTimer.current) clearTimeout(checkTimer.current);


    checkTimer.current = setTimeout(() => {
            const latestDevices = devicesRef.current;

      setDeviceHighlight(() => {
        const result: { [key: string]: "green" | "red" } = {};
        latestDevices.forEach((d) => {
          const hasDataAttitude =
            (d.attitude?.roll ?? 0) !== 0 ||
            (d.attitude?.pitch ?? 0) !== 0 ||
            (d.attitude?.yaw ?? 0) !== 0;

          const hasDataAnalog = (d.analog?.amperage ?? 0) !== 0;
          const hasDataAltitude = (d.altitude?.estAlt ?? 0) !== 0;

          const hasData = hasDataAttitude && hasDataAnalog && hasDataAltitude;
          result[d.port] = hasData ? "green" : "red";

          console.log(`Port ${d.port} ‚Üí hasData=${hasData}`);
        });
        return result;
      });
      setChecking(false);
    }, 5000);
  };


  const resetDeviceHiglicht = () => setDeviceHighlight({})


  return { devices, deviceHighlight, startChecking, resetDeviceHiglicht };
}

================================================================================
FILE: QMS-Client-main/src/index.css
================================================================================


@font-face {
  font-family: 'GOST type A';
  src: url('/fonts/GOST-type-A.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: 'GOST type B';
  src: url('/fonts/GOST-type-B.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}


@tailwind base;
@tailwind components;
@tailwind utilities;


@media print {
  .print-area {
    page-break-inside: avoid;
  }

  
  .no-print {
    display: none !important;
  }
}
================================================================================
FILE: QMS-Client-main/src/main.tsx
================================================================================

import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App.tsx";
import "./index.css";
import { BrowserRouter } from "react-router-dom";
import { AuthProvider } from "react-oidc-context";
import UserStore from "./store/UserStore.ts";
import FlightControllerStore from "./store/FCStore.ts";
import FirmwareFCStore from "./store/FirmwareFC.ts";
import Firmware915Store from "./store/Firmware915.ts";
import ELRSStore from "./store/ELRS_915_and_2_4_store.ts";
import ProductStore from "./store/ProductStore.ts";
import FirmwareCoralBStore from "./store/FirmwareCoralB.ts";
import CoralBStore from "./store/Coral_B_store.ts";
import StructureStore from "./store/StructureStore.ts";


interface IContext {
  user: UserStore;
  flightController: FlightControllerStore;
  elrsStore: ELRSStore;
  coralBStore: CoralBStore;
  firmwareFC: FirmwareFCStore;
  firmware915: Firmware915Store;
  firmwareCoralB: FirmwareCoralBStore;
  product_component: ProductStore;
  structureStore: StructureStore;
}

export const Context = React.createContext<IContext | null>(null);


const REDIRECT_PATH_KEY = "mes_redirect_path";


const saveCurrentPath = () => {
  const currentPath = window.location.pathname + window.location.search;


  const hasOidcParams = window.location.search.includes('code=') ||
                        window.location.search.includes('state=');

  if (currentPath !== "/" &&
      !currentPath.includes("/login") &&
      !hasOidcParams) {
    sessionStorage.setItem(REDIRECT_PATH_KEY, currentPath);
  }
};


export const getSavedPath = (): string | null => {
  return sessionStorage.getItem(REDIRECT_PATH_KEY);
};


export const clearSavedPath = () => {
  sessionStorage.removeItem(REDIRECT_PATH_KEY);
};


saveCurrentPath();


const oidcConfig = {
  authority: "http://keycloak.local/realms/MES-Realm",
  client_id: "mes-client",
  redirect_uri: window.location.origin + "/",
  post_logout_redirect_uri: window.location.origin + "/",
  response_type: "code",


  onSigninCallback: () => {

    const savedPath = getSavedPath();


    const cleanUrl = savedPath || "/";

    window.history.replaceState({}, document.title, cleanUrl);


  }
};


ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <AuthProvider {...oidcConfig}>
      <BrowserRouter>
        <Context.Provider
          value={{
            user: new UserStore(),
            flightController: new FlightControllerStore(),
            elrsStore: new ELRSStore(),
            coralBStore: new CoralBStore(),
            firmwareFC: new FirmwareFCStore(),
            firmware915: new Firmware915Store(),
            firmwareCoralB: new FirmwareCoralBStore(),
            product_component: new ProductStore(),
            structureStore: new StructureStore(),
          }}
        >
          <App />
        </Context.Provider>
      </BrowserRouter>
    </AuthProvider>
  </React.StrictMode>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminDefectCategoriesPage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  Settings,
  Plus,
  Edit2,
  Trash2,
  X,
  Check,
  AlertTriangle,
  RefreshCw
} from "lucide-react";
import {
  fetchDefectCategories,
  createDefectCategory,
  updateDefectCategory,
  deleteDefectCategory
} from "src/api/defectApi";
import {
  DefectCategory,
  BoardType,
  BOARD_TYPE_SHORT,
  SEVERITY_LABELS,
  SEVERITY_COLORS
} from "src/types/DefectTypes";

const ALL_BOARD_TYPES: BoardType[] = ["FC", "ELRS_915", "ELRS_2_4", "CORAL_B", "SMARAGD"];

export const AdminDefectCategoriesPage: React.FC = () => {
  const [categories, setCategories] = useState<DefectCategory[]>([]);
  const [loading, setLoading] = useState(false);


  const [filterType, setFilterType] = useState<BoardType | "">("");
  const [showInactive, setShowInactive] = useState(false);


  const [showModal, setShowModal] = useState(false);
  const [editingCategory, setEditingCategory] = useState<DefectCategory | null>(null);


  const [formCode, setFormCode] = useState("");
  const [formTitle, setFormTitle] = useState("");
  const [formDescription, setFormDescription] = useState("");
  const [formSeverity, setFormSeverity] = useState<"CRITICAL" | "MAJOR" | "MINOR">("MAJOR");
  const [formTypes, setFormTypes] = useState<BoardType[]>([]);
  const [formActive, setFormActive] = useState(true);

  const [saving, setSaving] = useState(false);
  const [error, setError] = useState("");


  const loadCategories = async () => {
    setLoading(true);
    try {
      const data = await fetchDefectCategories(undefined, !showInactive);
      setCategories(data);
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadCategories();
  }, [showInactive]);


  const filteredCategories = filterType
    ? categories.filter(c => c.applicableTypes?.includes(filterType))
    : categories;


  const openCreate = () => {
    setEditingCategory(null);
    setFormCode("");
    setFormTitle("");
    setFormDescription("");
    setFormSeverity("MAJOR");
    setFormTypes([]);
    setFormActive(true);
    setError("");
    setShowModal(true);
  };


  const openEdit = (category: DefectCategory) => {
    setEditingCategory(category);
    setFormCode(category.code);
    setFormTitle(category.title);
    setFormDescription(category.description || "");
    setFormSeverity(category.severity);
    setFormTypes(category.applicableTypes || []);
    setFormActive(category.isActive);
    setError("");
    setShowModal(true);
  };


  const handleSave = async () => {
    if (!formCode.trim()) {
      setError("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥");
      return;
    }
    if (!formTitle.trim()) {
      setError("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
      return;
    }
    if (formTypes.length === 0) {
      setError("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø –ø—Ä–æ–¥—É–∫—Ü–∏–∏");
      return;
    }

    setSaving(true);
    setError("");

    try {
      if (editingCategory) {
        await updateDefectCategory(editingCategory.id, {
          code: formCode.trim().toUpperCase(),
          title: formTitle.trim(),
          description: formDescription.trim() || undefined,
          severity: formSeverity,
          applicableTypes: formTypes,
          isActive: formActive
        });
      } else {
        await createDefectCategory({
          code: formCode.trim().toUpperCase(),
          title: formTitle.trim(),
          description: formDescription.trim() || undefined,
          severity: formSeverity,
          applicableTypes: formTypes
        });
      }

      setShowModal(false);
      loadCategories();
    } catch (e: any) {
      setError(e.response?.data?.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
    } finally {
      setSaving(false);
    }
  };


  const handleDelete = async (id: number) => {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é? –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã ‚Äî –±—É–¥–µ—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.")) {
      return;
    }

    try {
      await deleteDefectCategory(id);
      loadCategories();
    } catch (e) {
      console.error(e);
    }
  };


  const toggleFormType = (type: BoardType) => {
    if (formTypes.includes(type)) {
      setFormTypes(formTypes.filter(t => t !== type));
    } else {
      setFormTypes([...formTypes, type]);
    }
  };


  const selectAllTypes = () => {
    setFormTypes([...ALL_BOARD_TYPES]);
  };

  return (
    <div className="min-h-screen bg-gray-50/50 p-6 pb-20">
      <div className="max-w-6xl mx-auto">


        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-purple-500 rounded-2xl shadow-lg shadow-purple-200 text-white">
              <Settings size={32} />
            </div>
            <div>
              <h1 className="text-3xl font-bold text-gray-800">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤</h1>
              <p className="text-gray-500 font-medium">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π</p>
            </div>
          </div>

          <button
            onClick={openCreate}
            className="flex items-center gap-2 px-5 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-semibold shadow-lg shadow-purple-200 transition-all"
          >
            <Plus size={20} />
            –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
          </button>
        </div>


        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6 flex items-center gap-4">
          <span className="text-sm text-gray-500 font-medium">–§–∏–ª—å—Ç—Ä—ã:</span>

          <select
            value={filterType}
            onChange={e => setFilterType(e.target.value as BoardType | "")}
            className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
          >
            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
            {ALL_BOARD_TYPES.map(type => (
              <option key={type} value={type}>{BOARD_TYPE_SHORT[type]}</option>
            ))}
          </select>

          <label className="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              checked={showInactive}
              onChange={e => setShowInactive(e.target.checked)}
              className="w-4 h-4 rounded border-gray-300 text-purple-500"
            />
            <span className="text-sm text-gray-600">–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</span>
          </label>

          <div className="flex-1"></div>

          <button
            onClick={loadCategories}
            className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg"
          >
            <RefreshCw size={18} className={loading ? "animate-spin" : ""} />
          </button>
        </div>


        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <table className="w-full">
            <thead className="bg-gray-50 border-b border-gray-200">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö–æ–¥</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ü—Ä–∏–º–µ–Ω–∏–º–æ –∫</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                <th className="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {filteredCategories.map(category => (
                <tr
                  key={category.id}
                  className={`hover:bg-gray-50 ${!category.isActive ? "opacity-50" : ""}`}
                >
                  <td className="px-4 py-3 font-mono text-sm text-gray-600">
                    {category.code}
                  </td>
                  <td className="px-4 py-3">
                    <div className="font-medium">{category.title}</div>
                    {category.description && (
                      <div className="text-xs text-gray-500 mt-0.5 truncate max-w-xs">
                        {category.description}
                      </div>
                    )}
                  </td>
                  <td className="px-4 py-3">
                    <span className={`px-2 py-1 rounded text-xs font-medium ${SEVERITY_COLORS[category.severity]}`}>
                      {SEVERITY_LABELS[category.severity]}
                    </span>
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex flex-wrap gap-1">
                      {category.applicableTypes?.map(type => (
                        <span
                          key={type}
                          className="px-2 py-0.5 bg-gray-100 rounded text-xs"
                        >
                          {BOARD_TYPE_SHORT[type as BoardType]}
                        </span>
                      ))}
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    {category.isActive ? (
                      <span className="flex items-center gap-1 text-green-600 text-sm">
                        <Check size={14} /> –ê–∫—Ç–∏–≤–Ω–∞
                      </span>
                    ) : (
                      <span className="flex items-center gap-1 text-gray-400 text-sm">
                        <X size={14} /> –ù–µ–∞–∫—Ç–∏–≤–Ω–∞
                      </span>
                    )}
                  </td>
                  <td className="px-4 py-3 text-right">
                    <button
                      onClick={() => openEdit(category)}
                      className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg mr-1"
                      title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                    >
                      <Edit2 size={16} />
                    </button>
                    <button
                      onClick={() => handleDelete(category.id)}
                      className="p-2 text-red-500 hover:bg-red-50 rounded-lg"
                      title="–£–¥–∞–ª–∏—Ç—å"
                    >
                      <Trash2 size={16} />
                    </button>
                  </td>
                </tr>
              ))}

              {filteredCategories.length === 0 && (
                <tr>
                  <td colSpan={6} className="px-4 py-12 text-center text-gray-500">
                    <AlertTriangle className="mx-auto mb-2 text-gray-300" size={32} />
                    <p>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>


      {showModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

            <div className="bg-purple-500 text-white px-6 py-4 flex items-center justify-between">
              <h2 className="text-lg font-bold">
                {editingCategory ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" : "–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è"}
              </h2>
              <button
                onClick={() => setShowModal(false)}
                className="p-2 hover:bg-white/20 rounded-lg transition-all"
              >
                <X size={20} />
              </button>
            </div>


            <div className="p-6">
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    –ö–æ–¥ *
                  </label>
                  <input
                    type="text"
                    value={formCode}
                    onChange={e => setFormCode(e.target.value.toUpperCase())}
                    placeholder="SOLDER_DEFECT"
                    className="w-full px-4 py-3 border border-gray-300 rounded-xl font-mono uppercase"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å *
                  </label>
                  <select
                    value={formSeverity}
                    onChange={e => setFormSeverity(e.target.value as any)}
                    className="w-full px-4 py-3 border border-gray-300 rounded-xl"
                  >
                    <option value="CRITICAL">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                    <option value="MAJOR">–°–µ—Ä—å—ë–∑–Ω—ã–π</option>
                    <option value="MINOR">–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π</option>
                  </select>
                </div>
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  –ù–∞–∑–≤–∞–Ω–∏–µ *
                </label>
                <input
                  type="text"
                  value={formTitle}
                  onChange={e => setFormTitle(e.target.value)}
                  placeholder="–î–µ—Ñ–µ–∫—Ç –ø–∞–π–∫–∏"
                  className="w-full px-4 py-3 border border-gray-300 rounded-xl"
                />
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  –û–ø–∏—Å–∞–Ω–∏–µ
                </label>
                <textarea
                  value={formDescription}
                  onChange={e => setFormDescription(e.target.value)}
                  rows={2}
                  placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."
                  className="w-full px-4 py-3 border border-gray-300 rounded-xl resize-none"
                />
              </div>

              <div className="mb-4">
                <div className="flex items-center justify-between mb-2">
                  <label className="text-sm font-medium text-gray-700">
                    –ü—Ä–∏–º–µ–Ω–∏–º–æ –∫ *
                  </label>
                  <button
                    onClick={selectAllTypes}
                    className="text-xs text-purple-500 hover:text-purple-600"
                  >
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                  </button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {ALL_BOARD_TYPES.map(type => (
                    <button
                      key={type}
                      onClick={() => toggleFormType(type)}
                      className={`px-3 py-2 border-2 rounded-lg text-sm font-medium transition-all ${
                        formTypes.includes(type)
                          ? "border-purple-500 bg-purple-50 text-purple-700"
                          : "border-gray-200 text-gray-600 hover:border-gray-300"
                      }`}
                    >
                      {BOARD_TYPE_SHORT[type]}
                    </button>
                  ))}
                </div>
              </div>

              {editingCategory && (
                <div className="mb-4">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={formActive}
                      onChange={e => setFormActive(e.target.checked)}
                      className="w-4 h-4 rounded border-gray-300 text-purple-500"
                    />
                    <span className="text-sm text-gray-700">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–∞</span>
                  </label>
                </div>
              )}

              {error && (
                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm">
                  {error}
                </div>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => setShowModal(false)}
                  className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50"
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
                <button
                  onClick={handleSave}
                  disabled={saving}
                  className="flex-1 py-3 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-300 text-white rounded-xl font-semibold"
                >
                  {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminDefectCategories.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect } from "react";
import {
  deleteCategoryDefect,
  fetchCategoryDefect,
  updateCategoryDefect,
} from "src/api/fcApi";
import { Context } from "src/main";
import { defectModelFull } from "src/types/DefectModel";
import { AdminOneDefect } from "./AdminOneDefect";

export const AdminDefectCategories: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { flightController } = context;

  const updateDefectCategoriesList = async () => {
    fetchCategoryDefect().then((data) =>
      flightController.setDefectCategories(data)
    );
  };

  useEffect(() => {
    updateDefectCategoriesList();
  }, []);

  const deleteCurrentDefectCategories = async (id: number) => {
    try {
      await deleteCategoryDefect(id);
      updateDefectCategoriesList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ FC:", error);
    }
  };

  const updateCurrentDefect = async (
    ID: number,
    currentTitle: string,
    currentDescription: string
  ) => {
    await updateCategoryDefect(ID, currentTitle, currentDescription);
    updateDefectCategoriesList();
  };

  let defectCategoriesALL = flightController.defectCategories.map(
    (defect: defectModelFull) => (
      <AdminOneDefect
        key={defect.id}
        title={defect.title}
        description={defect.description}
        ID={defect.id}
        updateCurrentDefect={updateCurrentDefect}
        updateDefectCategoriesList={() => updateDefectCategoriesList()}
        deleteDefectCategory={() => deleteCurrentDefectCategories(defect.id)}
      />
    )
  );

  return (
    <div className="p-4  bg-gray-100/80 shadow-lg rounded-lg h-screen overflow-y-auto">
      <h2 className="text-xl font-bold text-gray-900 mb-4 border-b-2 pb-2">
        –°–ø–∏—Å–æ–∫ –ö–∞—Ç–µ–≥–æ—Ä–∏–π –±—Ä–∞–∫–∞ FC
      </h2>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
        {defectCategoriesALL}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminDefect_2_4_Categories.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect } from "react";
import {
  deleteCategoryDefect24,
  fetchCategoryDefect24,
  updateCategoryDefect24,
} from "src/api/elrsApi";
import { Context } from "src/main";
import { defectModelFull } from "src/types/DefectModel";
import { AdminOneDefect } from "./AdminOneDefect";

export const AdminDefect_2_4_Categories: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { elrsStore } = context;

  const updateDefectCategoriesList = async () => {
    fetchCategoryDefect24().then((data) =>
      elrsStore.setDefect_2_4_Categories(data)
    );
  };

  useEffect(() => {
    updateDefectCategoriesList();
  }, []);

  const deleteCurrentDefectCategories = async (id: number) => {
    try {
      await deleteCategoryDefect24(id);
      updateDefectCategoriesList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ 2,4:", error);
    }
  };

  const updateCurrentDefect = async (
    ID: number,
    currentTitle: string,
    currentDescription: string
  ) => {
    await updateCategoryDefect24(ID, currentTitle, currentDescription);
    updateDefectCategoriesList();
  };

  let defectCategoriesALL = elrsStore.defect_2_4_Categories.map(
    (defect: defectModelFull) => (
      <AdminOneDefect
        key={defect.id}
        title={defect.title}
        description={defect.description}
        ID={defect.id}
        updateCurrentDefect={updateCurrentDefect}
        updateDefectCategoriesList={() => updateDefectCategoriesList()}
        deleteDefectCategory={() => deleteCurrentDefectCategories(defect.id)}
      />
    )
  );

  return (
    <div className="p-4  bg-gray-100/80 shadow-lg rounded-lg h-screen overflow-y-auto">
      <h2 className="text-xl font-bold text-gray-900 mb-4 border-b-2 pb-2">
        –°–ø–∏—Å–æ–∫ –ö–∞—Ç–µ–≥–æ—Ä–∏–π –±—Ä–∞–∫–∞ –ø—Ä–∏–µ–º–Ω–∏–∫–æ–≤ 2,4
      </h2>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
        {defectCategoriesALL}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminDefect_915_Categories.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect } from "react";
import {
  deleteCategoryDefect915,
  fetchCategoryDefect915,
  updateCategoryDefect915,
} from "src/api/elrsApi";
import { Context } from "src/main";
import { defectModelFull } from "src/types/DefectModel";
import { AdminOneDefect } from "./AdminOneDefect";

export const AdminDefect_915_Categories: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { elrsStore } = context;

  const updateDefectCategoriesList = async () => {
    fetchCategoryDefect915().then((data) =>
      elrsStore.setDefect_915_Categories(data)
    );
  };

  useEffect(() => {
    updateDefectCategoriesList();
  }, []);

  const deleteCurrentDefectCategories = async (id: number) => {
    try {
      await deleteCategoryDefect915(id);
      updateDefectCategoriesList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ 915:", error);
    }
  };

  const updateCurrentDefect = async (
    ID: number,
    currentTitle: string,
    currentDescription: string
  ) => {
    await updateCategoryDefect915(ID, currentTitle, currentDescription);
    updateDefectCategoriesList();
  };

  let defectCategoriesALL = elrsStore.defect_915_Categories.map(
    (defect: defectModelFull) => (
      <AdminOneDefect
        key={defect.id}
        title={defect.title}
        description={defect.description}
        ID={defect.id}
        updateCurrentDefect={updateCurrentDefect}
        updateDefectCategoriesList={() => updateDefectCategoriesList()}
        deleteDefectCategory={() => deleteCurrentDefectCategories(defect.id)}
      />
    )
  );

  return (
    <div className="p-4  bg-gray-100/80 shadow-lg rounded-lg h-screen overflow-y-auto">
      <h2 className="text-xl font-bold text-gray-900 mb-4 border-b-2 pb-2">
        –°–ø–∏—Å–æ–∫ –ö–∞—Ç–µ–≥–æ—Ä–∏–π –±—Ä–∞–∫–∞ –ø—Ä–∏–µ–º–Ω–∏–∫–æ–≤ 915
      </h2>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
        {defectCategoriesALL}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminDefect_Coral_B_categories.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect } from "react";
import { Context } from "src/main";
import { defectModelFull } from "src/types/DefectModel";
import { AdminOneDefect } from "./AdminOneDefect";
import {
  deleteCategoryDefectCoral_B,
  fetchCategoryDefectCoral_B,
  updateCategoryDefectCoral_B,
} from "src/api/coralBApi";
import { BookOpenCheck } from "lucide-react";

export const AdminDefect_Coral_B_categories: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { coralBStore } = context;

  const updateDefectCategoriesList = async () => {
    fetchCategoryDefectCoral_B().then((data) =>
      coralBStore.setDefect_coral_B_categories(data)
    );
  };

  useEffect(() => {
    updateDefectCategoriesList();
  }, []);

  const deleteCurrentDefectCategories = async (id: number) => {
    try {
      await deleteCategoryDefectCoral_B(id);
      updateDefectCategoriesList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ Coral B:", error);
    }
  };

  const updateCurrentDefect = async (
    ID: number,
    currentTitle: string,
    currentDescription: string
  ) => {
    await updateCategoryDefectCoral_B(ID, currentTitle, currentDescription);
    updateDefectCategoriesList();
  };

  let defectCategoriesALL = coralBStore.defect_coral_B_categories.map(
    (defect: defectModelFull) => (
      <AdminOneDefect
        key={defect.id}
        title={defect.title}
        description={defect.description}
        ID={defect.id}
        updateCurrentDefect={updateCurrentDefect}
        updateDefectCategoriesList={() => updateDefectCategoriesList()}
        deleteDefectCategory={() => deleteCurrentDefectCategories(defect.id)}
      />
    )
  );

  return (
    <div className="p-6 bg-gradient-to-br from-gray-50/80 to-gray-100/80 min-h-screen">
      <div className="max-w-7xl mx-auto">
        <div className="mb-8 bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
          <h2 className="text-2xl font-bold text-gray-800 flex items-center">
            <BookOpenCheck className="mr-3 text-blue-500" size={24} />
            –°–ø–∏—Å–æ–∫ –ö–∞—Ç–µ–≥–æ—Ä–∏–π –±—Ä–∞–∫–∞ Coral B
          </h2>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {defectCategoriesALL}
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminEditDefectCategory.tsx
================================================================================

import { useState } from "react";

interface AdminEditDefectProps {
  updateDefectCategoriesList: () => void;
  title: string;
  description: string;
  ID: number;
  updateCurrentDefect: (
    ID: number,
    currentTitle: string,
    currentDescription: string
  ) => void;
}

export const AdminEditDefectCategory: React.FC<AdminEditDefectProps> = ({
  updateDefectCategoriesList,
  updateCurrentDefect,

  title,
  description,
  ID,
}) => {
  const [currentDescription, setCurrentDescription] = useState(description);
  const [currentTitle, setCurrentTitle] = useState(title);

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const editCategoryDefect = () => {
    try {
      updateCurrentDefect(ID, currentTitle, currentDescription);

      setCurrentDescription("");
      setCurrentTitle("");
      setSuccessMessage("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –±—Ä–∞–∫–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞");
      setErrorMessage("");
      updateDefectCategoriesList();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–ò–∑–º–µ–Ω–∏—Ç—å –ö–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞</h2>
      <form>
        <input
          type="text"
          placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±—Ä–∞–∫–∞"
          className="w-full p-2 border rounded-lg mb-2"
          value={currentTitle}
          onChange={(e) => setCurrentTitle(e.target.value)}
        />
        <input
          type="text"
          placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
          className="w-full p-2 border rounded-lg mb-2"
          value={currentDescription}
          onChange={(e) => setCurrentDescription(e.target.value)}
        />

        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          –ò–∑–º–µ–Ω–∏—Ç—å
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">–ò–∑–º–µ–Ω–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞?</p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  editCategoryDefect();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –∏–∑–º–µ–Ω–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminDefectCategory/AdminOneDefect.tsx
================================================================================

import { Pencil, Trash2 } from "lucide-react";
import { useState } from "react";
import { Modal } from "src/components/Modal/Modal";
import { AdminEditDefectCategory } from "./AdminEditDefectCategory";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";

interface AdminOneDefect {
  title: string;
  description: string;
  ID: number;
  updateDefectCategoriesList: () => void;
  deleteDefectCategory: () => void;
  updateCurrentDefect: (
    ID: number,
    currentTitle: string,
    currentDescription: string
  ) => void;
}

export const AdminOneDefect: React.FC<AdminOneDefect> = ({
  title,
  description,
  ID,
  updateDefectCategoriesList,
  deleteDefectCategory,
  updateCurrentDefect,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  return (
    <div className="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-lg border border-gray-200 hover:border-blue-300 relative group">

      <div className="p-5 pb-3 bg-gradient-to-r from-blue-50 to-white">
        <div className="flex justify-between items-start">
          <div>
            <h3 className="text-xl font-bold text-gray-800 truncate pr-10">
              {title}
            </h3>
            <p className="text-gray-600">
              <span className="font-semibold">–û–ø–∏—Å–∞–Ω–∏–µ:</span> {description}
            </p>
            <span className="text-sm text-gray-500">id: {ID}</span>
          </div>

          <div className="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <button
              onClick={() => openModal("defectEdit")}
              className="p-2 bg-white text-blue-600 rounded-full hover:bg-blue-50 transition-all shadow-md hover:shadow-lg"
              title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
            >
              <Pencil size={16} />
            </button>
            <button
              disabled={ID === 1}
              onClick={() => openModal("defectDelete")}
              className="p-2 bg-white text-red-600 rounded-full hover:bg-red-50 transition-all shadow-md hover:shadow-lg"
              title="–£–¥–∞–ª–∏—Ç—å"
            >
              <Trash2 size={16} />
            </button>
          </div>
        </div>
      </div>

      <Modal isOpen={modalType === "defectDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞ ${title} ?`}
          actionConfirm={deleteDefectCategory}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "defectEdit"} onClose={closeModal}>
        <AdminEditDefectCategory
          ID={ID}
          title={title}
          description={description}
          updateDefectCategoriesList={updateDefectCategoriesList}
          updateCurrentDefect={updateCurrentDefect}
        />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPCs/AdminEditPC.tsx
================================================================================

import { useState } from "react";
import { updatePC } from "src/api/fcApi";

interface AdminEditPCProps {
  updatePCList: () => void;
  PCname: string;
  IP: string;
  Cabinet: string;
  ID: number;
}

export const AdminEditPC: React.FC<AdminEditPCProps> = ({
  updatePCList,

  IP,
  PCname,
  Cabinet,
  ID,
}) => {
  const [ip, SetIp] = useState(IP);
  const [pc_name, SetPc_name] = useState(PCname);
  const [cabinet, SetCabinet] = useState(Cabinet);

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const editPC = async () => {
    try {
      await updatePC(ID, ip, pc_name, cabinet);

      SetIp("");
      SetPc_name("");
      SetCabinet("");
      setSuccessMessage("–ö–æ–º–ø—å—é—Ç–µ—Ä —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω");
      setErrorMessage("");
      updatePCList();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä</h2>
      <form>
        <input
          type="text"
          placeholder="–ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞"
          className="w-full p-2 border rounded-lg mb-2"
          value={pc_name}
          onChange={(e) => SetPc_name(e.target.value)}
        />
        <input
          type="text"
          placeholder="IP-–∞–¥—Ä–µ—Å"
          className="w-full p-2 border rounded-lg mb-2"
          value={ip}
          onChange={(e) => SetIp(e.target.value)}
        />
        <input
          type="text"
          placeholder="–ö–∞–±–∏–Ω–µ—Ç"
          className="w-full p-2 border rounded-lg mb-2"
          value={cabinet}
          onChange={(e) => SetCabinet(e.target.value)}
        />
        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          –ò–∑–º–µ–Ω–∏—Ç—å
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">–ò–∑–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä?</p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  editPC();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –∏–∑–º–µ–Ω–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPCs/AdminOnePC.tsx
================================================================================

import { Pencil, Trash2 } from "lucide-react";
import { useState } from "react";
import { Modal } from "src/components/Modal/Modal";
import { AdminEditPC } from "./AdminEditPC";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";

interface OnePCProps {
  deleteComputer: () => void;
  updatePCList: () => void;
  PCname: string;
  IP: string;
  cabinet: string;
  ID: number;
}

export const AdminOnePC: React.FC<OnePCProps> = ({
  deleteComputer,
  updatePCList,
  PCname,
  IP,
  cabinet,
  ID,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  return (
    <div className="bg-white p-4 rounded-lg shadow-lg border-l-4 border-blue-500 transition duration-300 hover:shadow-xl relative">
      <h3 className="text-xl font-bold text-gray-800 mb-2">–ò–º—è –ø–∫: {PCname}</h3>
      <p className="text-gray-600">
        <span className="font-semibold">IP:</span> {IP}
      </p>
      <p className="text-gray-600">
        <span className="font-semibold">–ö–∞–±–∏–Ω–µ—Ç:</span> {cabinet}
      </p>


      <div className="absolute top-4 right-4 flex space-x-2">
        <button
          onClick={() => openModal("computerEdit")}
          className="p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition"
        >
          <Pencil size={18} />
        </button>
        <button
          className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition"
          onClick={() => openModal("computerDelete")}
        >
          <Trash2 size={18} />
        </button>
      </div>

      <Modal isOpen={modalType === "computerDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä ${PCname} ?`}
          actionConfirm={deleteComputer}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "computerEdit"} onClose={closeModal}>
        <AdminEditPC
          ID={ID}
          PCname={PCname}
          IP={IP}
          Cabinet={cabinet}
          updatePCList={updatePCList}
        />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPCs/AdminPCs.tsx
================================================================================

import { useContext, useEffect } from "react";
import { deletePC, fetchPC } from "src/api/fcApi";
import { Context } from "src/main";
import { AdminOnePC } from "./AdminOnePC";
import { pcModelFull } from "src/types/PCModel";
import { observer } from "mobx-react-lite";

export const AdminPCs: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { flightController } = context;

  const updatePCList = async () => {
    fetchPC().then((data) => flightController.setPCs(data));
  };

  useEffect(() => {
    updatePCList();
  }, []);

  const deleteComputer = async (id: number) => {
    try {
      await deletePC(id);
      updatePCList()
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–ø–∞:", error);
    }
  };

  let PCs = flightController.PCs.map((el: pcModelFull) => (
    <AdminOnePC
      deleteComputer={() => deleteComputer(el.id)}
      updatePCList = {()=> updatePCList()}
      key={el.id}
      ID={el.id}
      PCname={el.pc_name}
      IP={el.ip}
      cabinet={el.cabinet}
    />
  ));

  return (
    <div className="p-4  bg-gray-100/80 shadow-lg rounded-lg h-screen overflow-y-auto">
      <h2 className="text-xl font-bold text-gray-900 mb-4 border-b-2 pb-2">
        –°–ø–∏—Å–æ–∫ –ü–ö
      </h2>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
        {PCs}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPanel.tsx
================================================================================

import React, { useState, useContext } from "react";
import { observer } from "mobx-react-lite";
import { useNavigate } from "react-router-dom";
import clsx from "clsx";

import { Context } from "src/main";


import {
  Shield,
  Users,
  Network,
  Package,
  Box,
  Layers,
  Cpu,
  Radio,
  Activity,
  Database,
  History,
  Plus,
  ArrowUpRight,
  AlertTriangle,
  Settings,
} from "lucide-react";


import { createCategoryDefect } from "src/api/fcApi";
import { createCategoryDefect24, createCategoryDefect915 } from "src/api/elrsApi";
import { createCategoryDefectCoral_B } from "src/api/coralBApi";


import { CreateDefect } from "./CreateModals/CreateDefect";
import { CreatePC } from "./CreateModals/CreatePC";
import { CreateFC } from "./CreateModals/CreateFC";
import { CreateBoard } from "./CreateModals/CreateELRS";
import { CreateProdStatus } from "./CreateModals/CreateProdStatus";
import { CreateProduct } from "./CreateModals/CreateProduct";
import { CreateProdComp } from "./CreateModals/CreateProdComponents";
import { CreateCoralB } from "./CreateModals/CreateCoralB";
import { Modal } from "src/components/Modal/Modal";


import {
  ADMIN_RBAC_ROUTE,
  ADMIN_USERS_ROUTE,
  STRUCTURE_ROUTE,
  AUDIT_LOG_ROUTE,
  ADMIN_WAREHOUSE_ROUTE,
  ADMIN_PRODUCTS_ROUTE,
  ADMIN_COMPONENTS_ROUTE,
  FC_ROUTE,
  ELRS_915_ROUTE,
  ELRS_2_4_ROUTE,
  CORAL_B_ROUTE,
  ADMIN_DEFECTS_FC_CATEGORIES_ROUTE,

  ADMIN_DEFECT_CATEGORIES_ROUTE,
} from "src/utils/consts";


import {
  CREATE_BOARD_24,
  CREATE_BOARD_915,
  CREATE_BOARD_CORAL_B,
  CREATE_BOARD_FC,
  CREATE_COMPONENT,
  CREATE_COMPUTER,
  CREATE_DEFECT_24,
  CREATE_DEFECT_915,
  CREATE_DEFECT_CORAL_B,
  CREATE_DEFECT_FC,
  CREATE_PRODUCT,
  CREATE_PRODUCT_STATUSES,
} from "src/utils/constsModalType";


interface BentoItemProps {
  title: string;
  subtitle?: string;
  icon: React.ElementType;
  link: string;
  className?: string;
  colorClass?: string;
  iconColorClass?: string;
  onAdd?: () => void;
}

const BentoItem: React.FC<BentoItemProps> = ({
  title,
  subtitle,
  icon: Icon,
  link,
  className,
  colorClass = "bg-white hover:border-indigo-300",
  iconColorClass = "text-indigo-600 bg-indigo-50",
  onAdd,
}) => {
  const navigate = useNavigate();

  return (
    <div
      onClick={() => navigate(link)}
      className={clsx(
        "relative p-6 rounded-3xl border border-transparent shadow-sm transition-all duration-300 cursor-pointer group overflow-hidden flex flex-col justify-between hover:shadow-xl hover:-translate-y-1",
        colorClass,
        className
      )}
    >

      <div className="absolute -right-6 -top-6 w-24 h-24 bg-current opacity-5 rounded-full pointer-events-none group-hover:scale-150 transition-transform duration-500" />

      <div className="flex justify-between items-start z-10">
        <div className={clsx("p-3 rounded-2xl", iconColorClass)}>
          <Icon size={28} strokeWidth={1.5} />
        </div>


        <div className="p-2 rounded-full text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity">
          <ArrowUpRight size={20} />
        </div>
      </div>

      <div className="mt-4 z-10">
        <h3 className="text-xl font-bold tracking-tight mb-1">{title}</h3>
        {subtitle && (
          <p className="text-sm opacity-70 font-medium leading-tight">
            {subtitle}
          </p>
        )}
      </div>


      {onAdd && (
        <button
          onClick={(e) => {
            e.stopPropagation();
            onAdd();
          }}
          className="absolute bottom-4 right-4 p-2 bg-white/90 backdrop-blur-sm border border-slate-200 rounded-xl text-slate-600 shadow-sm hover:bg-indigo-600 hover:text-white hover:border-indigo-600 transition-all z-20"
          title="–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ"
        >
          <Plus size={20} />
        </button>
      )}
    </div>
  );
};


export const AdminPanel: React.FC = observer(() => {
  const { user } = useContext(Context)!;
  const navigate = useNavigate();
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);


  const createDefectFC = async (title: string, description: string) => {
    await createCategoryDefect(title, description);
  };

  const createDefect915 = async (title: string, description: string) => {
    await createCategoryDefect915(title, description);
  };

  const createDefect24 = async (title: string, description: string) => {
    await createCategoryDefect24(title, description);
  };

  const createDefectCoralB = async (title: string, description: string) => {
    await createCategoryDefectCoral_B(title, description);
  };

  const canManageUsers =
    user.can("users.manage") || user.can("admin.users_manage");

  return (
    <div className="p-6 max-w-[1600px] mx-auto min-h-screen">
      <div className="mb-8">
        <h1 className="text-4xl font-extrabold text-slate-900 tracking-tight">
          –¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        </h1>
        <p className="text-slate-500 mt-2 text-lg">
          –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, —Å–∫–ª–∞–¥–∞ –∏ –¥–æ—Å—Ç—É–ø–∞
        </p>
      </div>


      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 auto-rows-[180px]">

        {(canManageUsers || user.can("rbac.manage")) && (
          <div className="md:col-span-2 row-span-2 bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden group shadow-2xl">
            <div className="absolute top-0 right-0 w-96 h-96 bg-indigo-500 rounded-full blur-[100px] opacity-20 -mr-20 -mt-20 pointer-events-none" />

            <div className="relative z-10 flex flex-col h-full justify-between">
              <div className="flex justify-between items-start">
                <div className="p-4 bg-white/10 backdrop-blur-md rounded-2xl border border-white/10">
                  <Shield size={40} className="text-emerald-400" />
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => openModal(CREATE_COMPUTER)}
                    className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-xl text-sm font-bold transition backdrop-blur-sm border border-white/5"
                  >
                    + –ü–ö
                  </button>
                </div>
              </div>

              <div>
                <h2 className="text-3xl font-bold mb-2">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
                <p className="text-slate-400 mb-6 max-w-md">
                  –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–≤–æ–π –º–æ–¥–µ–ª—å—é (RBAC), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–∞–±–æ—á–∏–º–∏
                  —Å—Ç–∞–Ω—Ü–∏—è–º–∏.
                </p>

                <div className="flex gap-3 flex-wrap">

                  <button
                    onClick={() => navigate(ADMIN_RBAC_ROUTE)}
                    className="flex items-center gap-2 px-5 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold transition shadow-lg shadow-indigo-900/50"
                  >
                    <Settings size={18} /> –î–æ—Å—Ç—É–ø (RBAC)
                  </button>
                  <button
                    onClick={() => navigate(ADMIN_USERS_ROUTE)}
                    className="flex items-center gap-2 px-5 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold transition"
                  >
                    <Users size={18} /> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                  </button>
                  <button
                    onClick={() => navigate(AUDIT_LOG_ROUTE)}
                    className="flex items-center gap-2 px-5 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl font-bold transition"
                  >
                    <History size={18} /> –ê—É–¥–∏—Ç
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}


        {user.can("admin.structure_manage") && (
          <BentoItem
            title="–°—Ç—Ä—É–∫—Ç—É—Ä–∞"
            subtitle="–¶–µ—Ö–∞, —É—á–∞—Å—Ç–∫–∏ –∏ –±—Ä–∏–≥–∞–¥—ã"
            icon={Network}
            link={STRUCTURE_ROUTE}
            className="md:col-span-2"
            colorClass="bg-gradient-to-br from-indigo-50 to-blue-50 border border-blue-100 hover:shadow-lg"
            iconColorClass="bg-blue-100 text-blue-600"
          />
        )}


        {user.can("warehouse.manage") && (
          <BentoItem
            title="WMS –°–∫–ª–∞–¥"
            subtitle="–ü–æ—Å—Ç–∞–≤–∫–∏ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ"
            icon={Package}
            link={ADMIN_WAREHOUSE_ROUTE}
            colorClass="bg-white border-slate-200 hover:border-emerald-400"
            iconColorClass="bg-emerald-50 text-emerald-600"
          />
        )}


        {user.can("recipe.manage") && (
          <BentoItem
            title="–ü—Ä–æ–¥—É–∫—Ü–∏—è"
            subtitle="–ò–∑–¥–µ–ª–∏—è –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã"
            icon={Box}
            link={ADMIN_PRODUCTS_ROUTE}
            onAdd={() => openModal(CREATE_PRODUCT)}
            colorClass="bg-white border-slate-200 hover:border-purple-400"
            iconColorClass="bg-purple-50 text-purple-600"
          />
        )}


        {user.can("recipe.manage") && (
          <BentoItem
            title="–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ"
            subtitle="–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –¥–µ—Ç–∞–ª–µ–π"
            icon={Layers}
            link={ADMIN_COMPONENTS_ROUTE}
            onAdd={() => openModal(CREATE_COMPONENT)}
          />
        )}


        {(user.can("devices.view") || user.can("firmware.flash")) && (
          <>
            <div className="md:col-span-4 mt-4 mb-2">
              <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider ml-1">
                –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –±—Ä–∞–∫
              </h3>
            </div>

            <BentoItem
              title="Flight Controller"
              subtitle="–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ FC"
              icon={Cpu}
              link={FC_ROUTE}
              onAdd={() => openModal(CREATE_BOARD_FC)}
              iconColorClass="bg-orange-50 text-orange-600"
            />

            <BentoItem
              title="ELRS 915"
              subtitle="–ü—Ä–∏–µ–º–Ω–∏–∫–∏ 915 MHz"
              icon={Radio}
              link={ELRS_915_ROUTE}
              onAdd={() => openModal(CREATE_BOARD_915)}
              iconColorClass="bg-sky-50 text-sky-600"
            />

            <BentoItem
              title="ELRS 2.4"
              subtitle="–ü—Ä–∏–µ–º–Ω–∏–∫–∏ 2.4 GHz"
              icon={Activity}
              link={ELRS_2_4_ROUTE}
              onAdd={() => openModal(CREATE_BOARD_24)}
              iconColorClass="bg-blue-50 text-blue-600"
            />

            <BentoItem
              title="Coral B"
              subtitle="–ü–ª–∞—Ç—ã –≤–∏–¥–µ–æ"
              icon={Database}
              link={CORAL_B_ROUTE}
              onAdd={() => openModal(CREATE_BOARD_CORAL_B)}
              iconColorClass="bg-rose-50 text-rose-600"
            />
          </>
        )}


        {user.can("defect.manage") && (
          <div className="md:col-span-4 grid grid-cols-1 md:grid-cols-4 gap-4 mt-2">
            <div

              onClick={() => navigate(ADMIN_DEFECTS_FC_CATEGORIES_ROUTE)}
              className="flex items-center gap-3 p-4 rounded-2xl border border-dashed border-slate-300 hover:border-red-400 hover:bg-red-50 transition cursor-pointer text-slate-600 hover:text-red-700"
            >
              <AlertTriangle size={20} />
              <span className="font-bold text-sm">–ë—Ä–∞–∫ FC</span>
            </div>


            <div
              onClick={() => navigate(ADMIN_DEFECT_CATEGORIES_ROUTE)}
              className="flex items-center gap-3 p-4 rounded-2xl border border-dashed border-slate-300 hover:border-amber-400 hover:bg-amber-50 transition cursor-pointer text-slate-600 hover:text-amber-700"
            >
              <Settings size={20} />
              <span className="font-bold text-sm">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤</span>
            </div>

          </div>
        )}
      </div>


      <Modal isOpen={modalType === CREATE_DEFECT_FC} onClose={closeModal}>
        <CreateDefect createDefect={createDefectFC} />
      </Modal>

      <Modal isOpen={modalType === CREATE_DEFECT_915} onClose={closeModal}>
        <CreateDefect createDefect={createDefect915} />
      </Modal>

      <Modal isOpen={modalType === CREATE_DEFECT_24} onClose={closeModal}>
        <CreateDefect createDefect={createDefect24} />
      </Modal>

      <Modal isOpen={modalType === CREATE_DEFECT_CORAL_B} onClose={closeModal}>
        <CreateDefect createDefect={createDefectCoralB} />
      </Modal>

      <Modal isOpen={modalType === CREATE_BOARD_FC} onClose={closeModal}>
        <CreateFC />
      </Modal>

      <Modal isOpen={modalType === CREATE_BOARD_915} onClose={closeModal}>
        <CreateBoard BoardName="–ø—Ä–∏–µ–º–Ω–∏–∫915" />
      </Modal>

      <Modal isOpen={modalType === CREATE_BOARD_24} onClose={closeModal}>
        <CreateBoard BoardName="–ø—Ä–∏–µ–º–Ω–∏–∫2.4" />
      </Modal>

      <Modal isOpen={modalType === CREATE_BOARD_CORAL_B} onClose={closeModal}>
        <CreateCoralB />
      </Modal>

      <Modal isOpen={modalType === CREATE_COMPUTER} onClose={closeModal}>
        <CreatePC />
      </Modal>

      <Modal
        isOpen={modalType === CREATE_PRODUCT_STATUSES}
        onClose={closeModal}
      >
        <CreateProdStatus />
      </Modal>

      <Modal isOpen={modalType === CREATE_PRODUCT} onClose={closeModal}>
        <CreateProduct />
      </Modal>

      <Modal isOpen={modalType === CREATE_COMPONENT} onClose={closeModal}>
        <CreateProdComp />
      </Modal>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminProd_Components/AdmProdComponents.tsx
================================================================================

import { observer } from "mobx-react-lite"
import { useContext, useEffect } from "react";
import { deleteComponentRef, fetchComponentsRef } from "src/api/product_componentApi";
import { Context } from "src/main";
import { componentModel } from "src/types/ComponentModel";
import { AdminProdOneComponent } from "./AdmProdOneComponent";

export const AdmProdComponents: React.FC = observer(() => {

      const context = useContext(Context);
      if (!context) {
        throw new Error("Context must be used within a Provider");
      }
      const { product_component } = context;

  const updateComponentsList = async () => {
    fetchComponentsRef().then((data) =>
      product_component.setReferencesComponents(data.data)
    );
  };

   useEffect(() => {
      updateComponentsList();
    }, []);


  const deleteComponent = async (id: number) => {
    try {
      await deleteComponentRef(id);
      updateComponentsList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑–¥–µ–ª–∏—è:", error);
    }
  };


 let components = product_component.referencesComponents?.map((component: componentModel) => (
    <AdminProdOneComponent
    deleteComponent={() => deleteComponent(component.id)}
    updateComponentsList = {()=> updateComponentsList()}
    key={component.id}
    component={component}

    />
  )  )


    return (
        <div className="p-4  bg-gray-100/80 shadow-lg rounded-lg h-screen overflow-y-auto">
        <h2 className="text-xl font-bold text-gray-900 mb-4 border-b-2 pb-2">
         –°–ø–∏—Å–æ–∫ –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö
       </h2>
       <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 p-6">
         {components}
       </div>
     </div>
    )
})

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminProd_Components/AdmProdEditComponent.tsx
================================================================================

import { useState } from "react";
import { updateComponentRef } from "src/api/product_componentApi";
import { componentModel } from "src/types/ComponentModel";

interface AdminEditComponentProps {
  updateComponentsList: () => void;
  component: componentModel;
  ID: number;
}

export const AdmProdEditComponent: React.FC<AdminEditComponentProps> = ({
  updateComponentsList,
  component,
  ID,
}) => {
  const [newComponentTitle, SetNewComponentTitle] = useState(component.title);
  const [newComponentArticle, SetNewComponentArticle] = useState(
    component.article
  );
  const [newComponentQuantity, SetNewComponentQuantity] = useState(
    component.quantity
  );

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const editComponent = async () => {
    try {
      await updateComponentRef(
        ID,
        newComponentTitle,
        newComponentArticle,
        newComponentQuantity
      );

      setSuccessMessage("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      updateComponentsList();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">
        –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç {component.title}
      </h2>
      <form>
        <p>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</p>
        <input
          type="text"
          placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è"
          className="w-full p-2 border rounded-lg mb-2"
          value={newComponentTitle}
          onChange={(e) => SetNewComponentTitle(e.target.value)}
        />
        <p>–ê—Ä—Ç–∏–∫—É–ª</p>
        <input
          type="text"
          placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è"
          className="w-full p-2 border rounded-lg mb-2"
          value={newComponentArticle}
          onChange={(e) => SetNewComponentArticle(e.target.value)}
        />
        <p>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</p>
        <input
          type="number"
          placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è"
          className="w-full p-2 border rounded-lg mb-2"
          value={newComponentQuantity}
          onChange={(e) => SetNewComponentQuantity(Number(e.target.value))}
        />

        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => editComponent()}
        >
          –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ
        </button>

        {successMessage && (
          <div className="mt-4 text-green-500 font-medium">
            {successMessage}
          </div>
        )}
        {errorMessage && (
          <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
        )}
      </form>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminProd_Components/AdmProdOneComponent.tsx
================================================================================

import { ImageIcon, Pencil, Trash2, Upload } from "lucide-react";
import { ChangeEvent, useState } from "react";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { componentModel } from "src/types/ComponentModel";
import { AdmProdEditComponent } from "./AdmProdEditComponent";
import {
  deleteComponentRefImg,
  updateComponentRefImg,
} from "src/api/product_componentApi";

interface OneComponentProps {
  deleteComponent: () => void;
  updateComponentsList: () => void;
  component: componentModel;
}

export const AdminProdOneComponent: React.FC<OneComponentProps> = ({
  deleteComponent,
  updateComponentsList,
  component,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  const [isAvatarEditVisible, setAvatarEditVisible] = useState(false);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleImageUpload = async () => {
    if (!selectedFile) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏");
      return;
    }

    const formData = new FormData();
    formData.append("file", selectedFile);

    try {
      await updateComponentRefImg(component.id, formData);
      updateComponentsList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }
  };

  const handleDeleteImg = async () => {
    try {
      await deleteComponentRefImg(component.id);
      updateComponentsList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }
  };

  return (
    <div className="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl shadow-lg border-l-4 border-blue-500 transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 relative overflow-hidden group">
      {" "}

      <div className="absolute inset-0 bg-gradient-to-br from-blue-50 to-white opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
      <div className="absolute top-0 right-0 w-16 h-16 bg-blue-500 opacity-10 rounded-bl-full"></div>

      <div className="relative z-10">

        <div className="mb-4 pr-10">
          {" "}
          <p className="text-sm font-medium text-gray-500 ">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</p>
          <h3 className="text-2xl font-bold text-gray-800 mb-1 truncate">
            {component.title}
          </h3>
          <div className="flex items-center gap-2">
            <p className="text-sm font-medium text-gray-500">–ê—Ä—Ç–∏–∫—É–ª</p>
            <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">
              {component.article}
            </span>
          </div>
        </div>


        <div className="mb-6">
          <p className="text-sm font-medium text-gray-500">
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫ –≤ —É–ø–∞–∫–æ–≤–∫–µ
          </p>
          <div className="flex items-center gap-2">
            <span className="text-xl font-bold text-gray-800">
              {component.quantity}
            </span>
            <span className="text-gray-400">—à—Ç.</span>
          </div>
        </div>


        {component.image.length > 1 ? (
          <div className="relative w-full h-48 rounded-xl overflow-hidden bg-white shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 group">
            <img
              src={`${import.meta.env.VITE_PRODUCT_COMPONENT_API_URL}/static/${
                component.image
              }`}
              alt={component.title}
              className="w-full h-full object-contain p-4"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/5 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
            <button
              className="absolute top-2 right-2 p-2 bg-white/80 rounded-full backdrop-blur-sm shadow-sm hover:bg-white transition-all"
              onClick={handleDeleteImg}
            >
              <Trash2 className="w-4 h-4 text-gray-600" />
            </button>
          </div>
        ) : (
          <div className="relative w-full h-48 rounded-xl bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-dashed border-gray-200 hover:border-purple-300 transition-all duration-300 overflow-hidden">
            <div className="absolute inset-0 flex flex-col items-center justify-center p-6 text-center">
              <div className="relative w-16 h-16 mb-4 text-gray-300 group-hover:text-purple-400 transition-colors duration-300">
                <ImageIcon size={64} strokeWidth={1.5} />
              </div>
              <span className="text-sm font-medium text-gray-500 mb-1">
                –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
              </span>
            </div>
          </div>
        )}


        <div className="absolute top-4 right-4 flex space-x-2">
          <button
            onClick={() => openModal("componentEdit")}
            className="p-2 bg-yellow-400 text-white rounded-full shadow-md hover:bg-yellow-500 transition transform hover:scale-110"
            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
          >
            <Pencil size={18} />
          </button>
          <button
            className="p-2 bg-red-400 text-white rounded-full shadow-md hover:bg-red-500 transition transform hover:scale-110"
            onClick={() => openModal("componentDelete")}
            title="–£–¥–∞–ª–∏—Ç—å"
          >
            <Trash2 size={18} />
          </button>
        </div>

        {isAvatarEditVisible ? (
          <div className="w-full max-w-xs space-y-4 mt-4">
            <div className="relative">
              <label className="block w-full px-4 py-2 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                <span className="text-sm font-medium text-gray-700">
                  –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –Ω–µ –±–æ–ª–µ–µ 5–ú–ë
                </span>
                <input
                  type="file"
                  onChange={handleFileChange}
                  className="rounded-lg w-full shadow-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </label>
            </div>
            <div className="flex space-x-3">
              <button
                className="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white font-medium rounded-lg hover:opacity-90 transition-opacity duration-200 shadow-sm"
                onClick={handleImageUpload}
              >
                –ó–∞–≥—Ä—É–∑–∏—Ç—å
              </button>
              <button
                className="px-4 py-2 bg-gray-100 text-gray-600 font-medium rounded-lg hover:bg-gray-200 transition-colors duration-200"
                onClick={() => setAvatarEditVisible(false)}
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        ) : (
          <button
            className="mt-3 px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white text-sm font-medium rounded-lg hover:shadow-md transition-all duration-200 shadow-sm"
            onClick={() => setAvatarEditVisible(true)}
          >
            <span className="flex items-center">
              <Upload className="w-4 h-4 mr-2" />
              –ò–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            </span>
          </button>
        )}
      </div>

      <Modal isOpen={modalType === "componentDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`–£–¥–∞–ª–∏—Ç—å –∏–∑–¥–µ–ª–∏–µ ${component.title}?`}
          actionConfirm={deleteComponent}
          onClose={closeModal}
        />
      </Modal>
      <Modal isOpen={modalType === "componentEdit"} onClose={closeModal}>
        <AdmProdEditComponent
          ID={component.id}
          component={component}
          updateComponentsList={updateComponentsList}
        />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminProducts/AdmProdStatuses/AdmProdEditStatus.tsx
================================================================================

import { useState } from "react";
import { updateStatus } from "src/api/product_componentApi";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";

interface AdmProdEditStatusProps {
    updateStatusList: () => void;
    title: string;
    ID: number;
  }

export const AdmProdEditStatus: React.FC<AdmProdEditStatusProps> = ({updateStatusList,title,ID}) => {


  const [newTitle, setNewTitle] = useState(title);

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);


  const editStatus = async () => {
    try {
      await updateStatus(ID, newTitle)
      setNewTitle("");
      closeModal();
      setSuccessMessage("–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω");

      setErrorMessage("");
      updateStatusList();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–∑–¥–µ–ª–∏—è</h2>
      <form>
        <input
          type="text"
          placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"
          className="w-full p-2 border rounded-lg mb-2"
          value={newTitle}
          onChange={(e) => setNewTitle(e.target.value)}
        />

        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => openModal("statusEdit")}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>

      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      <Modal isOpen={modalType === "statusEdit"} onClose={closeModal}>
        <ConfirmModal
          title1={`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å ${title} –Ω–∞ –Ω–æ–≤—ã–π: ${newTitle}?`}
          actionConfirm={editStatus}
          onClose={closeModal}
        />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminProducts/AdmProdStatuses/AdmProdOneStatus.tsx
================================================================================

import { Pencil, Trash2 } from "lucide-react";
import { useState } from "react";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { AdmProdEditStatus } from "./AdmProdEditStatus";

interface OneStatusProps {
  deleteStatus: () => void;
  updateStatusList: () => void;
  title: string;
  ID: number;
}

export const AdmProdOneStatus: React.FC<OneStatusProps> = ({
  deleteStatus,
  updateStatusList,
  title,
  ID,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  return (
    <div className="bg-white p-4 rounded-lg shadow-lg border-l-4 border-blue-500 transition duration-300 hover:shadow-xl relative">
      <h3 className="text-xl font-bold text-gray-800 mb-2 mr-16">
        –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: <br></br>
        {title}
      </h3>
      <p>id: {ID}</p>


      <div className="absolute top-4 right-4 flex space-x-2">
        <button
          onClick={() => openModal("computerEdit")}
          className="p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition"
        >
          <Pencil size={18} />
        </button>
        <button
          className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition"
          onClick={() => openModal("statusDelete")}
        >
          <Trash2 size={18} />
        </button>
      </div>

      <Modal isOpen={modalType === "statusDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å ${title} ?`}
          actionConfirm={deleteStatus}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "computerEdit"} onClose={closeModal}>
        <AdmProdEditStatus
          updateStatusList={updateStatusList}
          title={title}
          ID={ID}
          key={ID}
        />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminProducts/AdmProdStatuses/AdmProdStatuses.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect } from "react";
import { deleteStatus, fetchStatuses } from "src/api/product_componentApi";
import { Context } from "src/main";
import { productStatusModel } from "src/types/ProductModel";
import { AdmProdOneStatus } from "./AdmProdOneStatus";

export const AdmProdStatuses = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { product_component } = context;

  const updateStatusList = async () => {
    fetchStatuses().then((data) =>
      product_component.setProductStatus(data.data)
    );
  };

  useEffect(() => {
    updateStatusList();
  }, []);

  const deleteProdStatus = async (id: number) => {
    try {
      await deleteStatus(id);
      updateStatusList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:", error);
    }
  };

  let statuses = product_component.productStatus?.map(
    (status: productStatusModel) => (
      <AdmProdOneStatus
        deleteStatus={() => deleteProdStatus(status.id)}
        updateStatusList={() => updateStatusList()}
        key={status.id}
        title={status.title}
        ID={status.id}
      />
    )
  );

  return (
    <div className="p-4  bg-gray-100/80 shadow-lg rounded-lg h-screen overflow-y-auto">
      <h2 className="text-xl font-bold text-gray-900 mb-4 border-b-2 pb-2">
        –°–ø–∏—Å–æ–∫ –°—Ç–∞—Ç—É—Å–æ–≤ –ò–∑–¥–µ–ª–∏–π
      </h2>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
        {statuses}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminProducts/AdminEditProduct.tsx
================================================================================

import {
  AlertCircle,
  CheckCircle2,
  Edit3,
  List,
  MinusCircle,
  PackageOpen,
  PackageX,
  Plus,
  PlusCircle,
  Save,
  Trash2,
} from "lucide-react";
import { useContext, useEffect, useState } from "react";
import {
  createProd_Comp,
  deleteProd_Comp,
  updateProd_Comp,
  updateProductReference,
} from "src/api/product_componentApi";
import { Context } from "src/main";
import { connectionProduct_ComponentModel } from "src/types/ComponentModel";

interface AdminEditPCProps {
  updateProductsList: () => void;
  updateComponentsData: () => void;
  componentsData: connectionProduct_ComponentModel[];
  productTitle: string;
  ID: number;
}

export const AdminEditProduct: React.FC<AdminEditPCProps> = ({
  updateProductsList,
  updateComponentsData,
  componentsData,
  productTitle,
  ID,
}) => {
  const context = useContext(Context);
  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { product_component } = context;

  const [newProductTitle, SetNewProductTitle] = useState(productTitle);

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const getIdOfConnectComp = () => {
    return componentsData.map((conection) => conection.Component.id);
  };

  let actualComponents =
    product_component.referencesComponents === null
      ? []
      : product_component.referencesComponents?.filter(
          (component) => !getIdOfConnectComp().includes(component.id)
        );

  useEffect(() => {
    updateComponentsData();
  }, []);

  const editProductTitle = async () => {
    try {
      await updateProductReference(ID, newProductTitle, 1);

      setSuccessMessage("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      updateProductsList();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  const editQuantity = async (
    connectionID: number,
    component_id: number,
    product_id: number,
    plus: boolean,
    quantity: number
  ) => {
    const newQuantity = plus ? quantity + 1 : quantity - 1;
    try {
      await updateProd_Comp(
        connectionID,
        component_id,
        product_id,
        newQuantity
      );

      updateComponentsData();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  const deleteOneConnection = async (id: number) => {
    try {
      await deleteProd_Comp(id);
      updateComponentsData();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  const addComptoProd = async (
    component_id: number,
    product_id: number,
    required_quantity: number
  ) => {
    try {
      await createProd_Comp(component_id, product_id, required_quantity);
      updateComponentsData();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <>
      <div className="max-w-4xl mx-auto p-6 bg-white rounded-xl shadow-md">
        <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
          <Edit3 className="mr-2 text-blue-500" size={24} />
          –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:{" "}
          <span className="text-blue-600 ml-2">{productTitle}</span>
        </h2>

        <form className="space-y-6">

          <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <label className="block text-sm font-medium text-gray-700 mb-1">
              –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è
            </label>
            <div className="flex space-x-2">
              <input
                type="text"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                value={newProductTitle}
                onChange={(e) => SetNewProductTitle(e.target.value)}
              />
              <button
                type="button"
                onClick={() => editProductTitle()}
                className="px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center shadow-md"
              >
                <Save className="mr-2" size={18} />
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
            </div>
          </div>


          {successMessage && (
            <div className="p-3 bg-green-50 text-green-700 rounded-lg border border-green-200 flex items-center">
              <CheckCircle2 className="mr-2 text-green-500" size={18} />
              {successMessage}
            </div>
          )}
          {errorMessage && (
            <div className="p-3 bg-red-50 text-red-700 rounded-lg border border-red-200 flex items-center">
              <AlertCircle className="mr-2 text-red-500" size={18} />
              {errorMessage}
            </div>
          )}


          <div className="space-y-6">

            <div>
              <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <List className="mr-2 text-blue-500" size={20} />
                –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ –≤ –∏–∑–¥–µ–ª–∏–∏
              </h3>

              {componentsData.length > 0 ? (
                <div className="overflow-hidden rounded-xl border border-gray-200 shadow-sm">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          –ö–æ–ª-–≤–æ
                        </th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ
                        </th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          –í —É–ø–∞–∫–æ–≤–∫–µ
                        </th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {componentsData.map((connect) => (
                        <tr
                          key={connect.id}
                          className="hover:bg-gray-50 transition-colors"
                        >
                          <td className="px-4 py-3 whitespace-nowrap">
                            <div className="flex items-center justify-center space-x-2">
                              <button
                                title="–£–º–µ–Ω—å—à–∏—Ç—å"
                                type="button"
                                onClick={() =>
                                  editQuantity(
                                    connect.id,
                                    connect.component_id,
                                    connect.product_id,
                                    false,
                                    connect.required_quantity
                                  )
                                }
                                className="p-1 text-red-500 hover:text-red-700 transition"
                              >
                                <MinusCircle size={20} />
                              </button>
                              <span className="font-medium">
                                {connect.required_quantity}
                              </span>
                              <button
                                title="–£–≤–µ–ª–∏—á–∏—Ç—å"
                                type="button"
                                onClick={() =>
                                  editQuantity(
                                    connect.id,
                                    connect.component_id,
                                    connect.product_id,
                                    true,
                                    connect.required_quantity
                                  )
                                }
                                className="p-1 text-green-500 hover:text-green-700 transition"
                              >
                                <PlusCircle size={20} />
                              </button>
                            </div>
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex items-center">
                              <span className="font-medium">
                                {connect.Component.title}
                              </span>
                            </div>
                          </td>
                          <td className="px-4 py-3 text-gray-500">
                            {connect.Component.quantity} —à—Ç.
                          </td>
                          <td className="px-4 py-3 text-right">
                            <button
                              type="button"
                              onClick={() => deleteOneConnection(connect.id)}
                              className="p-2 text-red-500 hover:text-red-700 transition"
                              title="–£–¥–∞–ª–∏—Ç—å"
                            >
                              <Trash2 size={18} />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ) : (
                <div className="text-center py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                  <PackageOpen className="mx-auto text-gray-400" size={32} />
                  <p className="mt-2 text-gray-500">
                    –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö
                  </p>
                </div>
              )}
            </div>


            <div>
              <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <Plus className="mr-2 text-blue-500" size={20} />
                –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ
              </h3>

              {actualComponents?.length > 0 ? (
                <div className="overflow-hidden rounded-xl border border-gray-200 shadow-sm">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ
                        </th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          –í —É–ø–∞–∫–æ–≤–∫–µ
                        </th>
                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                          –î–æ–±–∞–≤–∏—Ç—å
                        </th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {actualComponents.map((component) => (
                        <tr
                          key={component.id}
                          className="hover:bg-gray-50 transition-colors"
                        >
                          <td className="px-4 py-3">
                            <div className="flex items-center">
                              <span className="font-medium">
                                {component.title}
                              </span>
                            </div>
                          </td>
                          <td className="px-4 py-3 text-gray-500">
                            {component.quantity} —à—Ç.
                          </td>
                          <td className="px-4 py-3 text-right">
                            <button
                              type="button"
                              onClick={() => addComptoProd(component.id, ID, 1)}
                              className="p-2 text-green-500 hover:text-green-700 transition"
                              title="–î–æ–±–∞–≤–∏—Ç—å"
                            >
                              <PlusCircle size={20} />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ) : (
                <div className="text-center py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                  <PackageX className="mx-auto text-gray-400" size={32} />
                  <p className="mt-2 text-gray-500">
                    –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö
                  </p>
                </div>
              )}
            </div>
          </div>
        </form>
      </div>
    </>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminProducts/AdminOneProduct.tsx
================================================================================

import { List, PackageOpen, Pencil, Trash2 } from "lucide-react";
import { useEffect, useState } from "react";
import { Modal } from "src/components/Modal/Modal";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { fetchProd_Comp } from "src/api/product_componentApi";
import {
  connectionProduct_ComponentModel,
} from "src/types/ComponentModel";
import { AdminEditProduct } from "./AdminEditProduct";

interface OneProductProps {
  deleteProduct: () => void;
  updateProductsList: () => void;
  title: string;
  ID: number;
}

export const AdminOneProduct: React.FC<OneProductProps> = ({
  deleteProduct,
  updateProductsList,
  title,
  ID,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  const [componentsData, setComponentsData] = useState<
    connectionProduct_ComponentModel[]
  >([]);

  const updateComponentsData = async () => {
    fetchProd_Comp(ID).then((data) => setComponentsData(data.data));
  };

  useEffect(() => {
    updateComponentsData();
  }, []);

  return (
    <div className="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-lg border border-gray-200 hover:border-blue-300 relative group">

  <div className="p-5 pb-3 bg-gradient-to-r from-blue-50 to-white">
    <div className="flex justify-between items-start">
      <div>
        <h3 className="text-xl font-bold text-gray-800 truncate pr-10">
          {title}
        </h3>
        <span className="text-sm text-gray-500">–ò–∑–¥–µ–ª–∏–µ</span>
      </div>

      <div className="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
        <button
          onClick={() => openModal("productEdit")}
          className="p-2 bg-white text-blue-600 rounded-full hover:bg-blue-50 transition-all shadow-md hover:shadow-lg"
          title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
        >
          <Pencil size={16} />
        </button>
        <button
          onClick={() => openModal("productDelete")}
          className="p-2 bg-white text-red-600 rounded-full hover:bg-red-50 transition-all shadow-md hover:shadow-lg"
          title="–£–¥–∞–ª–∏—Ç—å"
        >
          <Trash2 size={16} />
        </button>
      </div>
    </div>
  </div>


  <div className="px-5 py-3">
    <div className="flex items-center text-sm font-medium text-gray-500 mb-3">
      <List className="mr-2" size={16} />
      –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö
    </div>

    {componentsData.length > 0 ? (
      <div className="overflow-hidden rounded-lg border border-gray-200">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
              <th className="px-4 py-2">–£–ø–∞–∫–æ–≤–æ–∫</th>
              <th className="px-4 py-2">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</th>
              <th className="px-4 py-2">–í —É–ø–∞–∫–æ–≤–∫–µ</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 bg-white">
            {componentsData.map((connect) => (
              <tr key={connect.id} className="hover:bg-gray-50 transition-colors">
                <td className="px-4 py-3 text-sm font-medium text-gray-900">
                  {connect.required_quantity}
                </td>
                <td className="px-4 py-3">
                  <div className="flex items-center">
                    <div className="flex-shrink-0 h-10 w-10 mr-3 bg-gray-100 rounded-md overflow-hidden">
                      <img
                        src={`${import.meta.env.VITE_PRODUCT_COMPONENT_API_URL}/static/${connect.Component.image}`}
                        alt={connect.Component.title}
                        className="h-full w-full object-contain"
                        onError={(e) => {
                          e.currentTarget.onerror = null;
                          e.currentTarget.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23e5e7eb"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>';
                        }}
                      />
                    </div>
                    <div className="text-sm font-medium text-gray-900">
                      {connect.Component.title}
                    </div>
                  </div>
                </td>
                <td className="px-4 py-3 text-sm text-gray-500">
                  {connect.Component.quantity} —à—Ç.
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    ) : (
      <div className="text-center py-6 bg-gray-50 rounded-lg">
        <PackageOpen size={24} className="mx-auto text-gray-300 mb-2" />
        <p className="text-gray-500">–ù–µ—Ç –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö</p>
      </div>
    )}
  </div>

      <Modal isOpen={modalType === "productDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`–£–¥–∞–ª–∏—Ç—å –∏–∑–¥–µ–ª–∏–µ ${title} ?`}
          actionConfirm={deleteProduct}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "productEdit"} onClose={closeModal}>
        <AdminEditProduct
          ID={ID}
          productTitle={title}
          updateComponentsData={updateComponentsData}
          componentsData={componentsData}
          updateProductsList={updateProductsList}
        />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminProducts/AdminProducts.tsx
================================================================================

import { useContext, useEffect } from "react";
import { Context } from "src/main";

import { observer } from "mobx-react-lite";
import {
  deleteProductReference,
  fetchComponentsRef,
  fetchProductsReference,
} from "src/api/product_componentApi";
import { productModel } from "src/types/ProductModel";
import { AdminOneProduct } from "./AdminOneProduct";
import { Box } from "lucide-react";

export const AdminProducts: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { product_component } = context;

  const updateProductsList = async () => {
    fetchProductsReference().then((data) =>
      product_component.setReferencesProducts(data.data)
    );
  };

  const updateComponentsList = async () => {
    fetchComponentsRef().then((data) =>
      product_component.setReferencesComponents(data.data)
    );
  };

  useEffect(() => {
    updateProductsList();
    updateComponentsList();
  }, []);

  const deleteProduct = async (id: number) => {
    try {
      await deleteProductReference(id);
      updateProductsList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑–¥–µ–ª–∏—è:", error);
    }
  };

  let products = product_component.referencesProducts?.map(
    (product: productModel) => (
      <AdminOneProduct
        deleteProduct={() => deleteProduct(product.id)}
        updateProductsList={() => updateProductsList()}
        key={product.id}
        ID={product.id}
        title={product.title}
      />
    )
  );

  return (
    <div className="p-6 bg-gradient-to-br from-gray-50/80 to-gray-100/80 min-h-screen">
      <div className="max-w-7xl mx-auto">
        <div className="mb-8 bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
          <h2 className="text-2xl font-bold text-gray-800 flex items-center">
            <Box className="mr-3 text-blue-500" size={24} />
            –°–ø–∏—Å–æ–∫ –ò–∑–¥–µ–ª–∏–π
          </h2>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {products}
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminUsers/AdminEditUser.tsx
================================================================================

import { UserIcon } from "lucide-react";
import { ChangeEvent, useEffect, useState } from "react";
import { fetchCurrentUser, updateUser, updateUserImg } from "src/api/userApi";

interface AdminEditUserModel {
  updateUsersList: () => void;
  ID: number;
}

export const AdminEditUser: React.FC<AdminEditUserModel> = ({
  updateUsersList,
  ID,
}) => {
  const [currentUser, setCurrentUser] = useState({
    id: 0,
    login: "",
    password: "",
    role: "",
    name: "",
    surname: "",
    createdAt: "",
    updatedAt: "",
    img: "",
  });

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [isAvatarEditVisible, setAvatarEditVisible] = useState(false);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleAvatarUpload = async () => {
    if (!selectedFile) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏");
      return;
    }

    const formData = new FormData();
    formData.append("id", String(currentUser.id));
    formData.append("img", selectedFile);

    try {
      await updateUserImg(formData);
      setAvatarEditVisible(false);
      setSuccessMessage("—É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      refetchUser();
      updateUsersList()
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }
  };

  const refetchUser = () => {
    fetchCurrentUser(ID).then((data) => setCurrentUser(data));
  };

  useEffect(() => {
    fetchCurrentUser(ID).then((data) => setCurrentUser(data));
  }, []);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setCurrentUser((prevUser) => ({
      ...prevUser,
      [name]: value,
    }));
  };

  const handleSave = async () => {
    try {
      await updateUser(
        currentUser.id,
        currentUser.password,
        currentUser.name,
        currentUser.surname
      );
      setSuccessMessage("—É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      refetchUser();
      updateUsersList();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }
  };

  return (
    <div className="p-8 max-w-2xl mx-auto bg-gradient-to-br from-blue-50 to-purple-50 shadow-2xl rounded-3xl transform transition-all">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 text-center">
        –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      </h1>


      <div className="flex flex-col items-center mb-8">
        <div className="relative w-32 h-32 rounded-full overflow-hidden shadow-lg border-4 border-white hover:border-purple-500 transition-all duration-300">
          {currentUser.img ? (
            <img
              src={import.meta.env.VITE_API_URL + "/" + currentUser.img}
              alt=""
              className="w-full h-full object-cover"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center bg-blue-50">
              <UserIcon className="text-blue-600 w-16 h-16" />
            </div>
          )}
        </div>
      </div>


      {isAvatarEditVisible ? (
        <div className="flex flex-col items-center mb-8">
          <input
            type="file"
            onChange={handleFileChange}
            className="mb-4 p-2 bg-white rounded-lg shadow-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={handleAvatarUpload}
          >
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
          </button>
        </div>
      ) : (
        <div className="flex justify-center mb-8">
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={() => setAvatarEditVisible(true)}
          >
            –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
          </button>
        </div>
      )}


      <div className="space-y-6 bg-white p-8 rounded-2xl shadow-xl">

        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–õ–æ–≥–∏–Ω:</span>{" "}
          <span className="text-gray-900">{currentUser.login}</span>
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–ü–∞—Ä–æ–ª—å:</span>{" "}
          <input
            type="password"
            name="password"
            value={currentUser.password}
            onChange={handleInputChange}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–†–æ–ª—å:</span>{" "}
          <span className="text-gray-900">{currentUser.role}</span>
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–ò–º—è:</span>{" "}
          <input
            name="name"
            value={currentUser.name}
            onChange={handleInputChange}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">–§–∞–º–∏–ª–∏—è:</span>{" "}
          <input
            name="surname"
            value={currentUser.surname}
            onChange={handleInputChange}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </p>
      </div>


      <div className="mt-8 flex justify-center space-x-4">
        <button
          onClick={handleSave}
          className="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
        >
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button
          onClick={() => {
            refetchUser();
          }}
          className="bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
        >
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminUsers/AdminOneUser.tsx
================================================================================

import {
  UserIcon,
  ShieldCheck,
  MonitorDot,
  User,
  Pencil,
  Trash2,
} from "lucide-react";
import { useState } from "react";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { AdminEditUser } from "./AdminEditUser";

interface AdminOneUserProps {
  updateUsersList: () => void;
  deleteUser: () => void;
  ID: number;
  login: string;
  role: string;
  name: string;
  surName: string;
  img: string | null;
  active: boolean;
  pcName: string | undefined;
  pcIP: string | undefined;
}

export const AdminOneUser: React.FC<AdminOneUserProps> = ({
  updateUsersList,
  deleteUser,
  ID,
  login,
  role,
  name,
  surName,
  img,
  active,
  pcName,
  pcIP,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  return (
    <div className="bg-white shadow-md rounded-xl p-4 flex items-center gap-4 border-l-4 border-blue-500 transition duration-300 hover:shadow-lg overflow-hidden flex-wrap relative">

      {img ? (
        <div className="relative w-24 h-24 rounded-full overflow-hidden shadow-2xl border-4 border-white hover:border-purple-500 transition-all duration-300 transform hover:scale-105 group">
          <img
            src={import.meta.env.VITE_API_URL + "/" + img}
            alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
            className="w-full h-full object-cover"
          />
        </div>
      ) : (
        <div className="bg-gradient-to-br from-blue-100 to-purple-100 p-3 rounded-full w-24 h-24 flex items-center justify-center shadow-lg transform transition-all hover:scale-105 duration-300">
          <UserIcon className="text-blue-600 w-12 h-12" />
        </div>
      )}


      <div className="flex-1">
        <h3 className="text-2xl font-bold text-gray-900">
          {name} {surName}
        </h3>
        <p className="text-gray-600 text-sm mt-1">{login}</p>
      </div>


      {active ? (
        <div className="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-full shadow-sm">
          <div className="relative">
            <MonitorDot className="text-green-600 w-6 h-6" />

            <div className="absolute inset-0 flex items-center justify-center">
              <div className="w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
            </div>
          </div>
          <p className="text-sm font-medium text-green-800">
            {pcName} ({pcIP}) ‚Äì Online
          </p>
        </div>
      ) : (
        <div className="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-full shadow-sm">
          <MonitorDot className="text-red-600 w-6 h-6" />
          <p className="text-sm font-medium text-red-800">Offline</p>
        </div>
      )}


      <div className="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-purple-50 px-4 py-2 rounded-full shadow-sm">
        {role === "ADMIN" ? (
          <ShieldCheck className="text-green-600 w-6 h-6" />
        ) : (
          <User className="text-blue-600 w-6 h-6" />
        )}
        <span className="text-gray-700 font-medium">{role}</span>
      </div>


      <div className="absolute top-4 right-4 flex space-x-2 z-10">
        <button
          onClick={() => openModal("userEdit")}
          className="p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition transform hover:scale-110"
        >
          <Pencil size={18} />
        </button>
        <button
          className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition transform hover:scale-110"
          onClick={() => openModal("userDelete")}
        >
          <Trash2 size={18} />
        </button>
      </div>

      <Modal isOpen={modalType === "userDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${name} ${surName} ?`}
          actionConfirm={deleteUser}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "userEdit"} onClose={closeModal}>
        <AdminEditUser ID={ID} updateUsersList={updateUsersList} />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminUsers/AdminUsers.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect } from "react";
import { fetchPC, fetchSession, fetchUsers } from "src/api/fcApi";
import { Context } from "src/main";
import { AdminOneUser } from "./AdminOneUser";
import { userGetModel } from "src/types/UserModel";
import { SessionModelFull } from "src/types/SessionModel";
import { deleteUser } from "src/api/userApi";

export const AdminUsers: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { flightController } = context;

  const updateUsersList = async () => {
    fetchUsers().then((data) => flightController.setUsers(data));
    fetchSession().then((data) => flightController.setSessions(data));
    fetchPC().then((data) => flightController.setPCs(data));
  };

  useEffect(() => {
    updateUsersList();
  }, []);

  const getActiveSession = () => {
    return flightController.sessions.filter(
      (session: SessionModelFull) => session.online === true
    );
  };

  const getUsersOnlineID = () => {
    return (

      getActiveSession().map((session: SessionModelFull) => session.userId)
    );
  };

  const isOnline = (id: number) => {
    return getUsersOnlineID().includes(id);
  };

  const getCurrentPCName = (userId: number) => {
    const currentSession = getActiveSession().find(
      (session) => session.userId === userId
    );
    const currentPC = flightController.PCs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    return currentPC;
  };

  const deleteCurrentUser = async (id: number) => {
    try {
      await deleteUser(id);
      updateUsersList();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —é–∑–µ—Ä–∞:", error);
    }
  };

  let allUsers = flightController.users.map((user: userGetModel) => (
    <AdminOneUser
      key={user.id}
      ID={user.id}
      login={user.login}
      role={user.role}
      name={user.name}
      surName={user.surname}
      img={user.img}
      active={isOnline(user.id)}
      pcName={getCurrentPCName(user.id)?.pc_name}
      pcIP={getCurrentPCName(user.id)?.ip}
      updateUsersList={() => updateUsersList()}
      deleteUser={() => deleteCurrentUser(user.id)}
    />
  ));
  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
        üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {allUsers}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AssemblyRecipes/RecipeConstructorPage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { createOrUpdateRecipe, fetchRecipeByProject, RecipeStep } from "src/api/assemblyRecipesApi";
import {
    Save, Plus, Trash2, Layers, ArrowDown,
    FileText, CheckSquare, Settings, AlertCircle
} from "lucide-react";
import toast from "react-hot-toast";

export const RecipeConstructorPage: React.FC = () => {
    const [projects, setProjects] = useState<ProjectModel[]>([]);
    const [selectedProjectId, setSelectedProjectId] = useState<string>("");

    const [recipeTitle, setRecipeTitle] = useState("");
    const [steps, setSteps] = useState<RecipeStep[]>([
        { order: 1, title: "", quantity: 1, description: "" }
    ]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        fetchProjects().then(setProjects);
    }, []);

    useEffect(() => {
        if (!selectedProjectId) return;

        const loadExisting = async () => {
            try {
                const recipe = await fetchRecipeByProject(Number(selectedProjectId));
                if (recipe) {
                    setRecipeTitle(recipe.title);
                    setSteps(recipe.steps.length > 0 ? recipe.steps : [{ order: 1, title: "", quantity: 1 }]);
                    toast.success("–†–µ—Ü–µ–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω");
                } else {
                    const proj = projects.find(p => p.id === Number(selectedProjectId));
                    setRecipeTitle(proj ? `–°–±–æ—Ä–∫–∞: ${proj.title}` : "");
                    setSteps([{ order: 1, title: "", quantity: 1 }]);
                }
            } catch (e) {
                console.error(e);
            }
        };
        loadExisting();
    }, [selectedProjectId, projects]);

    const handleAddStep = () => {
        setSteps([...steps, {
            order: steps.length + 1,
            title: "",
            quantity: 1,
            description: ""
        }]);
    };

    const handleRemoveStep = (index: number) => {
        if (steps.length === 1) return;
        const newSteps = steps.filter((_, i) => i !== index).map((s, i) => ({ ...s, order: i + 1 }));
        setSteps(newSteps);
    };

    const handleChangeStep = (index: number, field: keyof RecipeStep, value: any) => {
        const newSteps = [...steps];
        newSteps[index] = { ...newSteps[index], [field]: value };
        setSteps(newSteps);
    };

    const handleSave = async () => {
        if (!selectedProjectId) return toast.error("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç");
        if (!recipeTitle) return toast.error("–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞");
        if (steps.some(s => !s.title)) return toast.error("–£ –≤—Å–µ—Ö —à–∞–≥–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ");

        setLoading(true);
        try {
            await createOrUpdateRecipe(Number(selectedProjectId), recipeTitle, steps);
            toast.success("–†–µ—Ü–µ–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-gray-50/50 p-8 pb-20">
            <div className="max-w-5xl mx-auto">

                <div className="flex items-center gap-4 mb-8">
                    <div className="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 text-white">
                        <Settings size={32} />
                    </div>
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¢–µ—Ö–∫–∞—Ä—Ç</h1>
                        <p className="text-gray-500 font-medium">–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—à–∞–≥–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è —Å–±–æ—Ä–∫–∏</p>
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

                    <div className="lg:col-span-1 space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 sticky top-6">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <Layers size={18} className="text-indigo-500"/> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                            </h3>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ü—Ä–æ–µ–∫—Ç</label>
                                    <select
                                        className="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                        value={selectedProjectId}
                                        onChange={e => setSelectedProjectId(e.target.value)}
                                    >
                                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
                                        {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞</label>
                                    <input
                                        className="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="–ù–∞–ø—Ä. –°–±–æ—Ä–∫–∞ –∫–æ—Ä–ø—É—Å–∞ v2.0"
                                        value={recipeTitle}
                                        onChange={e => setRecipeTitle(e.target.value)}
                                    />
                                </div>

                                <div className="pt-4 border-t border-gray-100">
                                    <button
                                        onClick={handleSave}
                                        disabled={loading}
                                        className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition flex justify-center items-center gap-2 disabled:opacity-50"
                                    >
                                        <Save size={18}/> {loading ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div className="lg:col-span-2 space-y-4">
                        {steps.map((step, index) => (
                            <div key={index} className="group relative bg-white p-5 rounded-2xl shadow-sm border border-gray-200 hover:border-indigo-300 transition-all">
                                <div className="absolute -left-3 top-6 w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-xs border-2 border-white shadow-sm">
                                    {index + 1}
                                </div>

                                <div className="flex gap-4 mb-3">
                                    <div className="flex-1">
                                        <label className="text-[10px] font-bold text-gray-400 uppercase">–î–µ–π—Å—Ç–≤–∏–µ / –ö–æ–º–ø–æ–Ω–µ–Ω—Ç</label>
                                        <input
                                            className="w-full p-2 border-b border-gray-200 focus:border-indigo-500 outline-none font-bold text-gray-800"
                                            placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"
                                            value={step.title}
                                            onChange={e => handleChangeStep(index, "title", e.target.value)}
                                        />
                                    </div>
                                    <div className="w-24">
                                        <label className="text-[10px] font-bold text-gray-400 uppercase">–ö–æ–ª-–≤–æ</label>
                                        <input
                                            type="number" min="1"
                                            className="w-full p-2 border-b border-gray-200 focus:border-indigo-500 outline-none text-center font-mono"
                                            value={step.quantity}
                                            onChange={e => handleChangeStep(index, "quantity", Number(e.target.value))}
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[10px] font-bold text-gray-400 uppercase">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–î–µ—Ç–∞–ª–∏)</label>
                                    <textarea
                                        className="w-full p-2 bg-gray-50 rounded-lg text-sm border-0 focus:ring-1 focus:ring-indigo-300 resize-none h-20"
                                        placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è –¥–ª—è —Å–±–æ—Ä—â–∏–∫–∞..."
                                        value={step.description}
                                        onChange={e => handleChangeStep(index, "description", e.target.value)}
                                    />
                                </div>

                                <button
                                    onClick={() => handleRemoveStep(index)}
                                    className="absolute top-4 right-4 p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition opacity-0 group-hover:opacity-100"
                                >
                                    <Trash2 size={18}/>
                                </button>

                                {index < steps.length - 1 && (
                                    <div className="absolute -bottom-7 left-1/2 -translate-x-1/2 text-gray-300">
                                        <ArrowDown size={16}/>
                                    </div>
                                )}
                            </div>
                        ))}

                        <button
                            onClick={handleAddStep}
                            className="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-500 font-bold hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 transition flex justify-center items-center gap-2"
                        >
                            <Plus size={20}/> –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AssemblyRecipes/RecipeExecutionPage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { startAssemblyProcess, updateProcessStep, finishAssemblyProcess, AssemblyRecipe, AssemblyProcess } from "src/api/assemblyRecipesApi";
import {
    QrCode, Play, CheckCircle2, Circle, Flag,
    Box, MonitorPlay, AlertTriangle
} from "lucide-react";
import { Modal } from "src/components/Modal/Modal";
import toast from "react-hot-toast";

export const RecipeExecutionPage: React.FC = () => {

    const [projects, setProjects] = useState<ProjectModel[]>([]);
    const [selectedProjectId, setSelectedProjectId] = useState<string>("");


    const [recipe, setRecipe] = useState<AssemblyRecipe | null>(null);
    const [process, setProcess] = useState<AssemblyProcess | null>(null);
    const [loading, setLoading] = useState(false);

    const [isScanOpen, setScanOpen] = useState(false);
    const [qrCode, setQrCode] = useState("");

    useEffect(() => {
        fetchProjects().then(setProjects);
    }, []);

    const handleStartSession = async () => {
        if (!selectedProjectId) return toast.error("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç");
        if (!qrCode.trim()) return toast.error("–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR");

        setLoading(true);
        try {
            const res = await startAssemblyProcess(qrCode, Number(selectedProjectId));
            setRecipe(res.recipe);
            setProcess(res.process);
            setScanOpen(false);
            toast.success("–°–±–æ—Ä–∫–∞ –Ω–∞—á–∞—Ç–∞");
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞");
        } finally {
            setLoading(false);
        }
    };

    const handleStepToggle = async (index: number) => {
        if (!process) return;

        const isCompleted = process.completedSteps.includes(index);

        try {
            const updatedProcess = await updateProcessStep(process.id, index, !isCompleted);
            setProcess(updatedProcess);
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —à–∞–≥–∞");
        }
    };

    const handleFinish = async () => {
        if (!process || !recipe) return;

        const allDone = recipe.steps.length === process.completedSteps.length;
        if (!allDone) {
            if(!window.confirm("–í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ –≤—Å–µ —à–∞–≥–∏ –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ. –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?")) return;
        }

        try {
            await finishAssemblyProcess(process.id);
            toast.success("–ò–∑–¥–µ–ª–∏–µ —Å–æ–±—Ä–∞–Ω–æ!");
            setProcess(null);
            setRecipe(null);
            setQrCode("");
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è");
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 flex flex-col">
            <div className="bg-white shadow-sm border-b px-6 py-4 flex justify-between items-center">
                <div className="flex items-center gap-3">
                    <div className="bg-emerald-100 p-2 rounded-lg text-emerald-700">
                        <MonitorPlay size={24} />
                    </div>
                    <div>
                        <h1 className="text-xl font-bold text-gray-800">–¢–µ—Ä–º–∏–Ω–∞–ª –°–±–æ—Ä–∫–∏</h1>
                        <p className="text-xs text-gray-500">–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</p>
                    </div>
                </div>

                {!process && (
                    <div className="flex gap-3">
                        <select
                            className="p-2.5 border rounded-xl bg-gray-50 text-sm font-medium w-64"
                            value={selectedProjectId}
                            onChange={e => setSelectedProjectId(e.target.value)}
                        >
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
                            {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                        </select>
                        <button
                            onClick={() => setScanOpen(true)}
                            disabled={!selectedProjectId}
                            className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-xl font-bold shadow-lg transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <QrCode size={18}/> –ù–∞—á–∞—Ç—å —Å–±–æ—Ä–∫—É
                        </button>
                    </div>
                )}

                {process && (
                    <button onClick={() => { if(confirm("–í—ã–π—Ç–∏ –±–µ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è?")) { setProcess(null); setRecipe(null); } }} className="text-red-500 text-sm font-bold hover:underline">
                        –û—Ç–º–µ–Ω–∞ / –í—ã—Ö–æ–¥
                    </button>
                )}
            </div>

            {!process ? (
                <div className="flex-1 flex flex-col items-center justify-center text-gray-400 p-10">
                    <Box size={64} className="mb-4 opacity-20"/>
                    <h2 className="text-xl font-semibold">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</h2>
                    <p className="text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ—Ä–ø—É—Å –∏–∑–¥–µ–ª–∏—è</p>
                </div>
            ) : (
                <div className="flex-1 p-6 grid grid-cols-12 gap-6 h-[calc(100vh-80px)]">

                    <div className="col-span-3 bg-white rounded-2xl shadow-sm border border-gray-200 p-4 flex flex-col overflow-y-auto">
                        <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">–ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
                        <div className="space-y-3">
                            {recipe?.steps.map((step, idx) => {
                                const isDone = process.completedSteps.includes(idx);
                                return (
                                    <div key={idx} className={`flex items-center gap-3 p-3 rounded-xl transition-all ${isDone ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-transparent opacity-60'}`}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${isDone ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                            {idx + 1}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className={`text-sm font-bold truncate ${isDone ? 'text-green-800' : 'text-gray-700'}`}>{step.title}</div>
                                        </div>
                                        {isDone && <CheckCircle2 size={16} className="text-green-500"/>}
                                    </div>
                                )
                            })}
                        </div>
                    </div>


                    <div className="col-span-9 flex flex-col gap-4 h-full">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">{recipe?.title}</h2>
                                <p className="text-indigo-600 font-mono text-sm mt-1">ID –ò–∑–¥–µ–ª–∏—è: {qrCode || "..."}</p>
                            </div>
                            <div className="text-right">
                                <div className="text-3xl font-black text-gray-900">
                                    {process.completedSteps.length} <span className="text-gray-400 text-xl font-medium">/ {recipe?.steps.length}</span>
                                </div>
                                <div className="text-xs text-gray-500 uppercase font-bold">–í—ã–ø–æ–ª–Ω–µ–Ω–æ —à–∞–≥–æ–≤</div>
                            </div>
                        </div>

                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-gray-200 p-6 overflow-y-auto custom-scrollbar">
                            <div className="space-y-4">
                                {recipe?.steps.map((step, idx) => {
                                    const isDone = process.completedSteps.includes(idx);
                                    return (
                                        <div
                                            key={idx}
                                            onClick={() => handleStepToggle(idx)}
                                            className={`
                                                relative cursor-pointer border-2 rounded-2xl p-5 transition-all duration-200 flex justify-between items-center group
                                                ${isDone ? 'border-green-500 bg-green-50/50 shadow-sm' : 'border-gray-100 hover:border-indigo-400 hover:shadow-md bg-white'}
                                            `}
                                        >
                                            <div className="flex items-start gap-5">
                                                <div className={`mt-1 w-12 h-12 rounded-2xl flex items-center justify-center text-xl font-bold transition-colors ${isDone ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-500 group-hover:bg-indigo-100 group-hover:text-indigo-600'}`}>
                                                    {idx + 1}
                                                </div>
                                                <div>
                                                    <h3 className={`text-lg font-bold ${isDone ? 'text-green-800' : 'text-gray-800'}`}>
                                                        {step.title}
                                                        {step.quantity > 1 && <span className="ml-2 text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded text-sm">x{step.quantity}</span>}
                                                    </h3>
                                                    {step.description && <p className="text-gray-500 mt-1">{step.description}</p>}
                                                </div>
                                            </div>

                                            <div className="pr-4">
                                                {isDone
                                                    ? <CheckCircle2 size={32} className="text-green-500 fill-green-100"/>
                                                    : <Circle size={32} className="text-gray-300 group-hover:text-indigo-400"/>
                                                }
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>

                        <div className="flex justify-end pt-2">
                            <button
                                onClick={handleFinish}
                                className="bg-gradient-to-r from-emerald-500 to-green-600 text-white px-10 py-4 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl hover:scale-[1.01] transition flex items-center gap-3"
                            >
                                <Flag size={24}/> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–±–æ—Ä–∫—É
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <Modal isOpen={isScanOpen} onClose={() => setScanOpen(false)}>
                <div className="p-8 text-center">
                    <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <QrCode size={32}/>
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                    <p className="text-gray-500 mb-6">–ù–∞–≤–µ–¥–∏—Ç–µ —Å–∫–∞–Ω–µ—Ä –Ω–∞ QR –∫–æ–¥ –∫–æ—Ä–ø—É—Å–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID</p>

                    <input
                        autoFocus
                        value={qrCode}
                        onChange={e => setQrCode(e.target.value)}
                        onKeyDown={e => e.key === 'Enter' && handleStartSession()}
                        className="w-full text-center text-2xl font-mono p-4 border-2 border-indigo-100 rounded-xl focus:border-indigo-600 outline-none mb-6"
                        placeholder="SCAN HERE"
                    />

                    <button
                        onClick={handleStartSession}
                        disabled={loading}
                        className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700 transition"
                    >
                        {loading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"}
                    </button>
                </div>
            </Modal>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Audit/AuditLogPage.tsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { fetchAuditLogs } from "api/auditApi";
import { Preloader } from "src/components/common/Preloader";
import {
  History, Search, LogIn, Building2, Shield, Server,
  AlertTriangle, Warehouse, Cpu, Factory, MoreHorizontal,
  Download, RefreshCw
} from "lucide-react";
import { AuditLogModel } from "types/AuditLogModel";
import { fetchUsers } from "src/api/fcApi";
import { userGetModel } from "src/types/UserModel";


type AuditTab =
  | "ALL"
  | "SESSIONS"
  | "STRUCTURE"
  | "ACCESS"
  | "SERVERS"
  | "DEFECTS"
  | "WAREHOUSE"
  | "COMPONENTS"
  | "PRODUCTION"
  | "OTHER";


const TABS: { id: AuditTab; label: string; icon: React.ElementType; description: string }[] = [
  { id: "ALL", label: "–í—Å–µ —Å–æ–±—ã—Ç–∏—è", icon: History, description: "–í—Å–µ –∑–∞–ø–∏—Å–∏ –∂—É—Ä–Ω–∞–ª–∞" },
  { id: "SESSIONS", label: "–°–µ—Å—Å–∏–∏", icon: LogIn, description: "–í—Ö–æ–¥ –∏ –≤—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" },
  { id: "SERVERS", label: "–°–µ—Ä–≤–µ—Ä—ã", icon: Server, description: "Beryll: —Å–µ—Ä–≤–µ—Ä—ã, –ø–∞—Ä—Ç–∏–∏, —Å—Ç–æ–π–∫–∏, –∫–ª–∞—Å—Ç–µ—Ä—ã" },
  { id: "DEFECTS", label: "–ë—Ä–∞–∫", icon: AlertTriangle, description: "–î–µ—Ñ–µ–∫—Ç—ã —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –ø–ª–∞—Ç" },
  { id: "WAREHOUSE", label: "–°–∫–ª–∞–¥", icon: Warehouse, description: "–°–∫–ª–∞–¥—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏" },
  { id: "COMPONENTS", label: "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã", icon: Cpu, description: "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–µ—Ä–≤–µ—Ä–æ–≤" },
  { id: "PRODUCTION", label: "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ", icon: Factory, description: "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏" },
  { id: "STRUCTURE", label: "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", icon: Building2, description: "–£—á–∞—Å—Ç–∫–∏ –∏ –±—Ä–∏–≥–∞–¥—ã" },
  { id: "ACCESS", label: "–ü—Ä–∞–≤–∞", icon: Shield, description: "–†–æ–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è" },
  { id: "OTHER", label: "–ü—Ä–æ—á–µ–µ", icon: MoreHorizontal, description: "–û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è" },
];


const ENTITY_TAB_MAP: Record<string, AuditTab> = {

  SESSION: "SESSIONS",


  Section: "STRUCTURE",
  Team: "STRUCTURE",


  Role: "ACCESS",
  Ability: "ACCESS",
  RoleAbility: "ACCESS",


  BeryllServer: "SERVERS",
  BeryllBatch: "SERVERS",
  BeryllRack: "SERVERS",
  BeryllCluster: "SERVERS",
  BeryllShipment: "SERVERS",
  Server: "SERVERS",
  Batch: "SERVERS",
  Rack: "SERVERS",
  Cluster: "SERVERS",


  BeryllDefectRecord: "DEFECTS",
  DefectRecord: "DEFECTS",
  BoardDefect: "DEFECTS",
  RepairAction: "DEFECTS",
  RepairHistory: "DEFECTS",
  DefectCategory: "DEFECTS",
  YadroTicketLog: "DEFECTS",
  Defect: "DEFECTS",


  WarehouseMovement: "WAREHOUSE",
  InventoryBox: "WAREHOUSE",
  Supply: "WAREHOUSE",
  WarehouseDocument: "WAREHOUSE",
  Warehouse: "WAREHOUSE",
  Box: "WAREHOUSE",


  ComponentInventory: "COMPONENTS",
  ComponentHistory: "COMPONENTS",
  ComponentCatalog: "COMPONENTS",
  ServerComponent: "COMPONENTS",
  Component: "COMPONENTS",


  ProductionEntry: "PRODUCTION",
  ProductionOutput: "PRODUCTION",
  AssembledProduct: "PRODUCTION",
  Recipe: "PRODUCTION",
  RecipeStep: "PRODUCTION",
  Production: "PRODUCTION",
};


const ACTION_COLORS: Record<string, string> = {
  CREATE: "bg-green-100 text-green-800",
  CREATED: "bg-green-100 text-green-800",
  UPDATE: "bg-blue-100 text-blue-800",
  UPDATED: "bg-blue-100 text-blue-800",
  DELETE: "bg-red-100 text-red-800",
  DELETED: "bg-red-100 text-red-800",
  SESSION_START: "bg-emerald-100 text-emerald-800",
  SESSION_END: "bg-amber-100 text-amber-800",
  SESSION_DELETE: "bg-red-100 text-red-800",
  SESSION_AUTO_OFF: "bg-gray-100 text-gray-800",
  SESSION_FORCE_OFF: "bg-orange-100 text-orange-800",
  WAREHOUSE_MOVE: "bg-purple-100 text-purple-800",
  WAREHOUSE_MOVE_BATCH: "bg-purple-100 text-purple-800",
  DEFECT_RESOLVED: "bg-green-100 text-green-800",
  DEFECT_CREATED: "bg-red-100 text-red-800",
  COMPONENT_SYNC: "bg-cyan-100 text-cyan-800",
  EXPORT: "bg-indigo-100 text-indigo-800",
};


export const AuditLogPage: React.FC = () => {
  const [logs, setLogs] = useState<AuditLogModel[]>([]);
  const [page, setPage] = useState(1);
  const [limit] = useState(50);
  const [totalCount, setTotalCount] = useState(0);

  const [dateFrom, setDateFrom] = useState<string>("");
  const [dateTo, setDateTo] = useState<string>("");
  const [actionFilter, setActionFilter] = useState<string>("");
  const [entityFilter, setEntityFilter] = useState<string>("");

  const [searchText, setSearchText] = useState<string>("");
  const [activeTab, setActiveTab] = useState<AuditTab>("ALL");

  const [selectedUserId, setSelectedUserId] = useState<string>("");
  const [users, setUsers] = useState<userGetModel[]>([]);

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);


  useEffect(() => {
    const loadUsers = async () => {
      try {
        const data = await fetchUsers();
        setUsers(data);
      } catch (e) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –∂—É—Ä–Ω–∞–ª–∞", e);
      }
    };
    loadUsers();
  }, []);


  useEffect(() => {
    const load = async () => {
      setLoading(true);
      setError(null);
      try {
        const userIdParam =
          selectedUserId && selectedUserId !== "ALL"
            ? Number(selectedUserId)
            : undefined;

        const { count, rows } = await fetchAuditLogs({
          page,
          limit,
          action: actionFilter || undefined,
          entity: entityFilter || undefined,
          dateFrom: dateFrom || undefined,
          dateTo: dateTo || undefined,
          userId: userIdParam,
        });

        setLogs(rows);
        setTotalCount(count);
      } catch (e: any) {
        console.error(e);
        setError(e?.response?.data?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞");
      } finally {
        setLoading(false);
      }
    };

    load();
  }, [page, limit, actionFilter, entityFilter, dateFrom, dateTo, selectedUserId]);


  const actions = useMemo(() => {
    const set = new Set<string>();
    logs.forEach((log) => {
      if (log.action) set.add(log.action);
    });
    return Array.from(set).sort();
  }, [logs]);


  const entities = useMemo(() => {
    const set = new Set<string>();
    logs.forEach((log) => {
      if (log.entity) set.add(log.entity);
    });
    return Array.from(set).sort();
  }, [logs]);


  const totalPages = useMemo(
    () => Math.max(1, Math.ceil(totalCount / limit)),
    [totalCount, limit]
  );


  const getLogTab = (log: AuditLogModel): AuditTab => {
    if (log.entity && ENTITY_TAB_MAP[log.entity]) {
      return ENTITY_TAB_MAP[log.entity];
    }

    if (log.action?.startsWith("SESSION_")) return "SESSIONS";
    if (log.action?.startsWith("WAREHOUSE_")) return "WAREHOUSE";
    if (log.action?.startsWith("DEFECT_")) return "DEFECTS";
    if (log.action?.startsWith("COMPONENT_")) return "COMPONENTS";
    if (log.action?.startsWith("SERVER_") || log.action?.startsWith("BERYLL_")) return "SERVERS";
    if (log.action?.startsWith("PRODUCTION_")) return "PRODUCTION";
    return "OTHER";
  };


  const filteredLogs = useMemo(() => {
    const query = searchText.toLowerCase();
    let data = logs;


    if (activeTab !== "ALL") {
      data = data.filter((log) => getLogTab(log) === activeTab);
    }


    if (query) {
      data = data.filter((log) => {
        const description = (log.description || "").toLowerCase();
        const action = (log.action || "").toLowerCase();
        const entity = (log.entity || "").toLowerCase();
        const user = `${log.User?.name || ""} ${log.User?.surname || ""} ${log.User?.login || ""}`
          .trim()
          .toLowerCase();

        return (
          description.includes(query) ||
          action.includes(query) ||
          entity.includes(query) ||
          user.includes(query)
        );
      });
    }

    return data;
  }, [logs, searchText, activeTab]);


  const tabStats = useMemo(() => {
    const stats: Record<AuditTab, number> = {
      ALL: logs.length,
      SESSIONS: 0,
      STRUCTURE: 0,
      ACCESS: 0,
      SERVERS: 0,
      DEFECTS: 0,
      WAREHOUSE: 0,
      COMPONENTS: 0,
      PRODUCTION: 0,
      OTHER: 0,
    };

    logs.forEach((log) => {
      const tab = getLogTab(log);
      stats[tab]++;
    });

    return stats;
  }, [logs]);


  const getActionBadgeClass = (action: string): string => {
    if (ACTION_COLORS[action]) return ACTION_COLORS[action];
    if (action.includes("CREATE") || action.includes("ADD")) return ACTION_COLORS.CREATE;
    if (action.includes("UPDATE") || action.includes("EDIT")) return ACTION_COLORS.UPDATE;
    if (action.includes("DELETE") || action.includes("REMOVE")) return ACTION_COLORS.DELETE;
    return "bg-gray-100 text-gray-700";
  };


  const handleExport = () => {
    const headers = ["–í—Ä–µ–º—è", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "–î–µ–π—Å—Ç–≤–∏–µ", "–°—É—â–Ω–æ—Å—Ç—å", "–û–ø–∏—Å–∞–Ω–∏–µ"];
    const rows = filteredLogs.map((log) => [
      new Date(log.createdAt).toLocaleString("ru-RU"),
      log.User ? `${log.User.name} ${log.User.surname}` : "–°–∏—Å—Ç–µ–º–∞",
      log.action || "",
      log.entity || "",
      log.description || "",
    ]);

    const csv = [headers, ...rows]
      .map((row) => row.map((cell) => `"${cell}"`).join(","))
      .join("\n");

    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `audit_log_${new Date().toISOString().split("T")[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="px-4 py-6 max-w-[1800px] mx-auto">

      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
            <History className="w-5 h-5 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</h1>
            <p className="text-sm text-gray-500">–ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ MES Kryptonit</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={() => window.location.reload()}
            className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
            title="–û–±–Ω–æ–≤–∏—Ç—å"
          >
            <RefreshCw className="w-5 h-5" />
          </button>
          <button
            onClick={handleExport}
            className="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
          >
            <Download className="w-4 h-4" />
            –≠–∫—Å–ø–æ—Ä—Ç
          </button>
        </div>
      </div>


      <div className="mb-4 flex flex-wrap gap-2">
        {TABS.map((tab) => {
          const Icon = tab.icon;
          const count = tabStats[tab.id];
          const isActive = activeTab === tab.id;

          return (
            <button
              key={tab.id}
              type="button"
              onClick={() => {
                setActiveTab(tab.id);
                setPage(1);
              }}
              title={tab.description}
              className={[
                "flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium border transition-all",
                isActive
                  ? "bg-blue-600 text-white border-blue-600 shadow-sm"
                  : "bg-white text-gray-600 border-gray-200 hover:bg-gray-50 hover:border-gray-300",
              ].join(" ")}
            >
              <Icon className="w-4 h-4" />
              {tab.label}
              {count > 0 && (
                <span
                  className={[
                    "px-1.5 py-0.5 rounded-full text-xs",
                    isActive ? "bg-blue-500 text-white" : "bg-gray-100 text-gray-600",
                  ].join(" ")}
                >
                  {count}
                </span>
              )}
            </button>
          );
        })}
      </div>


      <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">

          <div className="lg:col-span-2">
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–ü–æ–∏—Å–∫</label>
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
              <input
                type="text"
                value={searchText}
                onChange={(e) => setSearchText(e.target.value)}
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é, –¥–µ–π—Å—Ç–≤–∏—é, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é..."
                className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–î–∞—Ç–∞ —Å</label>
            <input
              type="date"
              value={dateFrom}
              onChange={(e) => {
                setDateFrom(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–î–∞—Ç–∞ –ø–æ</label>
            <input
              type="date"
              value={dateTo}
              onChange={(e) => {
                setDateTo(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
            <select
              value={selectedUserId}
              onChange={(e) => {
                setSelectedUserId(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">–í—Å–µ</option>
              {users.map((u) => (
                <option key={u.id} value={u.id}>
                  {u.name} {u.surname}
                </option>
              ))}
            </select>
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">–î–µ–π—Å—Ç–≤–∏–µ</label>
            <select
              value={actionFilter}
              onChange={(e) => {
                setActionFilter(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">–í—Å–µ</option>
              {actions.map((a) => (
                <option key={a} value={a}>
                  {a}
                </option>
              ))}
            </select>
          </div>
        </div>
      </div>


      {loading && <Preloader />}


      {error && (
        <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
          <strong>–û—à–∏–±–∫–∞:</strong> {error}
        </div>
      )}


      {!loading && (
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div className="overflow-x-auto">
            <table className="min-w-full text-left text-sm">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-40">
                    –í—Ä–µ–º—è
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-48">
                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-40">
                    –î–µ–π—Å—Ç–≤–∏–µ
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-36">
                    –°—É—â–Ω–æ—Å—Ç—å
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">
                    –û–ø–∏—Å–∞–Ω–∏–µ
                  </th>
                </tr>
              </thead>
              <tbody>
                {filteredLogs.length === 0 && (
                  <tr>
                    <td colSpan={5} className="px-4 py-12 text-center text-gray-400">
                      <History className="w-12 h-12 mx-auto mb-3 opacity-30" />
                      <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                    </td>
                  </tr>
                )}

                {filteredLogs.map((log) => (
                  <tr
                    key={log.id}
                    className="border-b last:border-b-0 hover:bg-gray-50 transition-colors"
                  >
                    <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                      {new Date(log.createdAt).toLocaleString("ru-RU", {
                        day: "2-digit",
                        month: "2-digit",
                        year: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </td>

                    <td className="px-4 py-3 text-sm">
                      {log.User ? (
                        <div>
                          <div className="font-medium text-gray-800">
                            {log.User.name} {log.User.surname}
                          </div>
                          <div className="text-xs text-gray-400">{log.User.login}</div>
                        </div>
                      ) : (
                        <span className="text-gray-400 italic">–°–∏—Å—Ç–µ–º–∞</span>
                      )}
                    </td>

                    <td className="px-4 py-3">
                      <span
                        className={`inline-block px-2 py-1 rounded text-xs font-medium ${getActionBadgeClass(
                          log.action || ""
                        )}`}
                      >
                        {log.action}
                      </span>
                    </td>

                    <td className="px-4 py-3 text-sm text-gray-600">
                      {log.entity && (
                        <span className="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs">
                          {log.entity}
                          {log.entityId && <span className="text-gray-400 ml-1">#{log.entityId}</span>}
                        </span>
                      )}
                    </td>

                    <td className="px-4 py-3 text-sm text-gray-600">
                      {log.description || <span className="text-gray-300 italic">‚Äî</span>}


                      {log.metadata && (
                        <div className="mt-1 flex flex-wrap gap-1">
                          {log.metadata.pcName && (
                            <span className="text-xs bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded">
                              –ü–ö: {log.metadata.pcName}
                            </span>
                          )}
                          {log.metadata.ip && (
                            <span className="text-xs bg-gray-50 text-gray-500 px-1.5 py-0.5 rounded">
                              IP: {log.metadata.ip}
                            </span>
                          )}
                          {log.metadata.serverSerial && (
                            <span className="text-xs bg-purple-50 text-purple-600 px-1.5 py-0.5 rounded">
                              S/N: {log.metadata.serverSerial}
                            </span>
                          )}
                          {log.metadata.count !== undefined && (
                            <span className="text-xs bg-amber-50 text-amber-600 px-1.5 py-0.5 rounded">
                              –ö–æ–ª-–≤–æ: {log.metadata.count}
                            </span>
                          )}
                        </div>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>


          {totalPages > 1 && (
            <div className="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
              <div className="text-sm text-gray-500">
                –ü–æ–∫–∞–∑–∞–Ω–æ {filteredLogs.length} –∏–∑ {totalCount} –∑–∞–ø–∏—Å–µ–π
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setPage((p) => Math.max(1, p - 1))}
                  disabled={page === 1}
                  className="px-3 py-1 border border-gray-200 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition-colors"
                >
                  –ù–∞–∑–∞–¥
                </button>
                <span className="text-sm text-gray-600">
                  {page} / {totalPages}
                </span>
                <button
                  onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
                  disabled={page === totalPages}
                  className="px-3 py-1 border border-gray-200 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition-colors"
                >
                  –í–ø–µ—Ä—ë–¥
                </button>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default AuditLogPage;

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreateCoralB.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState } from "react";
import {
  createCoral_B_Board,
  fetchCategoryDefectCoral_B,
} from "src/api/coralBApi";
import { Context } from "src/main";

export const CreateCoralB: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { coralBStore } = context;

  useEffect(() => {
    fetchCategoryDefectCoral_B().then((data) =>
      coralBStore.setDefect_coral_B_categories(data)
    );
  }, []);

  const [uniqId, SetUniqId] = useState<string | null>("");
  const [firmwareVersion, setFirmwareVersion] = useState<string | null>("");
  const [firmwareState, setFirmwareState] = useState("");
  const [SAWState, setSAWState] = useState("");

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const addCoralB = async () => {
    const defectCategoryId = Number(coralBStore.selectedDefect?.id ?? 1);
    const sessionId = Number(localStorage.getItem("sessionID"));
    const valueFIRM = firmwareState === "true" ? true : false;
    const valueSAW = SAWState === "true" ? true : false;
    try {
      await createCoral_B_Board(
        uniqId,
        valueFIRM,
        valueSAW,
        firmwareVersion,
        sessionId,
        defectCategoryId
      );

      setSuccessMessage(" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω");
      setErrorMessage("");
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
    }
    coralBStore.resetSelectedDefect();
  };

  const categotiesDefects = coralBStore.defect_coral_B_categories.map((el) => (
    <option
      onClick={() => {
        coralBStore.setSelectedDefect(el);
        console.log(coralBStore.selectedDefect);
      }}
      key={el.id}
      value={el.id}
    >
      {el.title}
    </option>
  ));

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å Coral B</h2>
      <form>
        <div className="flex flex-col items-center space-y-2 p-4 border rounded-lg shadow-md w-full">
          <input
            type="text"
            placeholder="serial"
            className={`w-full p-2 border rounded-lg transition duration-200 ${
              uniqId === null
                ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                : ""
            }`}
            value={uniqId ?? ""}
            onChange={(e) => SetUniqId(e.target.value)}
            disabled={uniqId === null}
          />

          <button
            type="button"
            onClick={() => SetUniqId(uniqId === null ? "" : null)}
            className={`w-full p-2 rounded-lg font-medium text-white transition duration-200 ${
              uniqId === null ? "bg-red-700" : "bg-red-500 hover:bg-red-600"
            }`}
          >
            {uniqId === null ? "serial –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚úì" : "serial –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}
          </button>
        </div>


        <select
          value={firmwareState}
          onChange={(e) => setFirmwareState(e.target.value)}
          className="w-full p-2 border rounded-lg mb-2"
        >
          <option value="" disabled>
            –ü–ª–∞—Ç–∞ –ø—Ä–æ—à–∏—Ç–∞—è?
          </option>
          <option value="true">–î–∞</option>
          <option value="false">–ù–µ—Ç</option>
        </select>


        <div className="flex flex-col items-center space-y-2 p-4 border rounded-lg shadow-md w-full">
          <input
            type="text"
            placeholder="–≤–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏"
            className={`w-full p-2 border rounded-lg transition duration-200 ${
              firmwareVersion === null
                ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                : ""
            }`}
            value={firmwareVersion ?? ""}
            onChange={(e) => setFirmwareVersion(e.target.value)}
            disabled={firmwareVersion === null}
          />

          <button
            type="button"
            onClick={() => setFirmwareVersion(firmwareVersion === null ? "" : null)}
            className={`w-full p-2 rounded-lg font-medium text-white transition duration-200 ${
              firmwareVersion === null ? "bg-red-700" : "bg-red-500 hover:bg-red-600"
            }`}
          >
            {firmwareVersion === null ? "–≤–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚úì" : "–≤–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}
          </button>
        </div>


        <select
          value={SAWState}
          onChange={(e) => setSAWState(e.target.value)}
          className="w-full p-2 border rounded-lg mb-2"
        >
          <option value="" disabled>
            –ü–ª–∞—Ç–∞ c –ü–ê–í
          </option>
          <option value="true">—Å –ü–ê–í</option>
          <option value="false">–±–µ–∑ –ü–ê–í</option>
        </select>


        <select
          className="w-full p-2 border rounded-lg mb-2"
          onChange={(e) => {
            const selectedDefect = coralBStore.defect_coral_B_categories.find(
              (defect) => defect.id === Number(e.target.value)
            );
            if (selectedDefect) coralBStore.setSelectedDefect(selectedDefect);
          }}
        >
          <option value="" disabled>
            –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞
          </option>
          {categotiesDefects}
        </select>

        <button
          className="w-full bg-emerald-600 text-white py-2 rounded-lg hover:bg-emerald-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}
      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">–î–æ–±–∞–≤–∏—Ç—å —ç—Ç—É –ø–ª–∞—Ç—É –≤ –±–∞–∑—É?</p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  addCoralB();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreateDefect.tsx
================================================================================

import { useState } from "react";

interface CreateDefectModel {
  createDefect: (title: string, description: string) => void;
}
export const CreateDefect: React.FC<CreateDefectModel> = ({ createDefect }) => {
  const [title, SetTitle] = useState("");
  const [description, SetDescription] = useState("");

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const addCategoryDefect = async () => {
    try {
      await createDefect(title, description);
      SetTitle("");
      SetDescription("");

      setSuccessMessage("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–µ—Ñ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
      setErrorMessage("");
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞</h2>
      <form>
        <input
          type="text"
          placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
          className="w-full p-2 border rounded-lg mb-2"
          value={title}
          onChange={(e) => SetTitle(e.target.value)}
        />
        <textarea
          placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
          className="w-full p-2 border rounded-lg mb-2"
          value={description}
          onChange={(e) => SetDescription(e.target.value)}
        />
        <button
          type="button"
          className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition"
          onClick={() => setConfirm(true)}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>

      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">
              –î–æ–±–∞–≤–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞ –≤ –±–∞–∑—É?
            </p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  addCategoryDefect();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreateELRS.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState } from "react";
import {
  create2_4Board,
  create915Board,
  fetchCategoryDefect24,
  fetchCategoryDefect915,
} from "src/api/elrsApi";
import { Context } from "src/main";

interface CreateBoardModel {
  BoardName: string;
}

export const CreateBoard: React.FC<CreateBoardModel> = observer(
  ({ BoardName }) => {
    const context = useContext(Context);

    if (!context) {
      throw new Error("Context must be used within a Provider");
    }

    const { elrsStore } = context;

    useEffect(() => {
      if (BoardName === "–ø—Ä–∏–µ–º–Ω–∏–∫915") {
        fetchCategoryDefect915().then((data) =>
          elrsStore.setDefect_915_Categories(data)
        );
      } else {
        fetchCategoryDefect24().then((data) =>
          elrsStore.setDefect_2_4_Categories(data)
        );
      }
    }, []);

    const [uniqId, SetUniqId] = useState<string | null>("");
    const [firmwareState, setFirmwareState] = useState("");
    const [firmwareVersion, setFirmwareVersion] = useState("");

    const [errorMessage, setErrorMessage] = useState("");
    const [successMessage, setSuccessMessage] = useState("");

    const [confirm, setConfirm] = useState(false);

    const addFC = async () => {
      const defectCategoryId = Number(elrsStore.selectedDefect?.id ?? 1);
      const sessionId = Number(localStorage.getItem("sessionID"));
      const valueFIRM = firmwareState === "true" ? true : false;
      try {
        if (BoardName === "–ø—Ä–∏–µ–º–Ω–∏–∫915") {
          await create915Board(uniqId, valueFIRM, sessionId, defectCategoryId, firmwareVersion === "" ? null : firmwareVersion);
        } else {
          await create2_4Board(uniqId, valueFIRM, sessionId, defectCategoryId);
        }
        setSuccessMessage(" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω");
        setErrorMessage("");
      } catch (error: any) {
        setErrorMessage(
          `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.message}`
        );
        setSuccessMessage("");
      }
      elrsStore.resetSelectedDefect();

    };

    const categoties915 = elrsStore.defect_915_Categories.map((el) => (
      <option
        onClick={() => {
          elrsStore.setSelectedDefect(el);
          console.log(elrsStore.selectedDefect);
        }}
        key={el.id}
        value={el.id}
      >
        {el.title}
      </option>
    ));

    const categoties24 = elrsStore.defect_2_4_Categories.map((el) => (
      <option
        onClick={() => {
          elrsStore.setSelectedDefect(el);
          console.log(elrsStore.selectedDefect);
        }}
        key={el.id}
        value={el.id}
      >
        {el.title}
      </option>
    ));

    return (
      <div>
        <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å {BoardName}</h2>
        <form>
          <div className="flex flex-col items-center space-y-2 p-4 border rounded-lg shadow-md w-full">
            <input
              type="text"
              placeholder="MAC-address "
              className={`w-full p-2 border rounded-lg transition duration-200 ${uniqId === null
                ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                : ""
                }`}
              value={uniqId ?? ""}
              onChange={(e) => SetUniqId(e.target.value)}
              disabled={uniqId === null}
            />


            <button
              type="button"
              onClick={() => SetUniqId(uniqId === null ? "" : null)}
              className={`w-full p-2 rounded-lg font-medium text-white transition duration-200 ${uniqId === null ? "bg-red-700" : "bg-red-500 hover:bg-red-600"
                }`}
            >
              {uniqId === null
                ? "MAC-address –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚úì"
                : "MAC-address –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}
            </button>
          </div>


          <select
            value={firmwareState}
            onChange={(e) => setFirmwareState(e.target.value)}
            className="w-full p-2 border rounded-lg mb-2"
          >
            <option value="" disabled>
              –ü–ª–∞—Ç–∞ –ø—Ä–æ—à–∏—Ç–∞—è?
            </option>
            <option value="true">–î–∞</option>
            <option value="false">–ù–µ—Ç</option>
          </select>


          {(BoardName === "–ø—Ä–∏–µ–º–Ω–∏–∫915") &&
            <input
              type="text"
              placeholder="–í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏"
              className={`w-full p-2 border rounded-lg transition duration-200`}
              value={firmwareVersion}
              onChange={(e) => setFirmwareVersion(e.target.value)}
            />
          }


          <select
            className="w-full p-2 border rounded-lg mb-2"
            onChange={(e) => {
              if (BoardName === "–ø—Ä–∏–µ–º–Ω–∏–∫915") {
                const selectedDefect = elrsStore.defect_915_Categories.find(
                  (defect) => defect.id === Number(e.target.value)
                );
                if (selectedDefect) elrsStore.setSelectedDefect(selectedDefect);
              } else {
                const selectedDefect = elrsStore.defect_2_4_Categories.find(
                  (defect) => defect.id === Number(e.target.value)
                );
                if (selectedDefect) elrsStore.setSelectedDefect(selectedDefect);
              }
            }}
          >
            <option value="" disabled>
              –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞
            </option>
            {BoardName === "–ø—Ä–∏–µ–º–Ω–∏–∫915" ? categoties915 : categoties24}
          </select>

          <button
            className="w-full bg-emerald-600 text-white py-2 rounded-lg hover:bg-emerald-700 transition"
            type="button"
            onClick={() => setConfirm(true)}
          >
            –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </form>
        {successMessage && (
          <div className="mt-4 text-green-500 font-medium">
            {successMessage}
          </div>
        )}
        {errorMessage && (
          <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
        )}
        {confirm && (
          <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
            <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
              <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
              <p className="text-gray-600 mt-2">
                –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ –±–∞–∑—É?
              </p>

              <div className="flex justify-between mt-6">
                <button
                  type="button"
                  className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                  onClick={() => {
                    addFC();
                    setConfirm(false);
                  }}
                >
                  ‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å
                </button>
                <button
                  type="button"
                  className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                  onClick={() => setConfirm(false)}
                >
                  ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreateFC.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState } from "react";
import { createFC, fetchCategoryDefect } from "src/api/fcApi";
import { Context } from "src/main";

export const CreateFC: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { flightController } = context;

  useEffect(() => {
    fetchCategoryDefect().then((data) =>
      flightController.setDefectCategories(data)
    );
  }, []);

  const [uniqId, SetUniqId] = useState<string | null>("");
  const [firmwareState, setFirmwareState] = useState("");

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const addFC = async () => {
    const defectCategoryId = Number(flightController.selectedDefect?.id ?? 1);
    const sessionId = Number(localStorage.getItem("sessionID"));
    const valueFIRM = firmwareState === "true" ? true : false;
    try {
      await createFC(uniqId, valueFIRM, sessionId, defectCategoryId);
      setSuccessMessage("FC —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω");
      setErrorMessage("");
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
    }
    flightController.resetSelectedDefect();
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å FC</h2>
      <form>
        <div className="flex flex-col items-center space-y-2 p-4 border rounded-lg shadow-md w-full">
          <input
            type="text"
            placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä FC"
            className={`w-full p-2 border rounded-lg transition duration-200 ${
              uniqId === null
                ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                : ""
            }`}
            value={uniqId ?? ""}
            onChange={(e) => SetUniqId(e.target.value)}
            disabled={uniqId === null}
          />

          <button
            type="button"
            onClick={() => SetUniqId(uniqId === null ? "" : null)}
            className={`w-full p-2 rounded-lg font-medium text-white transition duration-200 ${
              uniqId === null ? "bg-red-700" : "bg-red-500 hover:bg-red-600"
            }`}
          >
            {uniqId === null
              ? "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚úì"
              : "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}
          </button>
        </div>


        <select
          value={firmwareState}
          onChange={(e) => setFirmwareState(e.target.value)}
          className="w-full p-2 border rounded-lg mb-2"
        >
          <option value="" disabled>
            –ü–ª–∞—Ç–∞ –ø—Ä–æ—à–∏—Ç–∞—è?
          </option>
          <option value="true">–î–∞</option>
          <option value="false">–ù–µ—Ç</option>
        </select>


        <select
          className="w-full p-2 border rounded-lg mb-2"
          onChange={(e) => {
            const selectedDefect = flightController.defectCategories.find(
              (defect) => defect.id === Number(e.target.value)
            );
            if (selectedDefect)
              flightController.setSelectedDefect(selectedDefect);
          }}
        >
          <option value="" disabled>
            –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞
          </option>
          {flightController.defectCategories.map((el) => (
            <option
              onClick={() => {
                flightController.setSelectedDefect(el);
                console.log(flightController.selectedDefect);
              }}
              key={el.id}
              value={el.id}
            >
              {el.title}
            </option>
          ))}
        </select>

        <button
          className="w-full bg-emerald-600 text-white py-2 rounded-lg hover:bg-emerald-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}
      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">
              –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ –±–∞–∑—É?
            </p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  addFC();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreatePC.tsx
================================================================================

import { useState } from "react";
import { createPC } from "src/api/fcApi";

export const CreatePC = () => {
  const [ip, SetIp] = useState("");
  const [pc_name, SetPc_name] = useState("");
  const [cabinet, SetCabinet] = useState("");

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const addPC = async () => {
    try {
      await createPC(ip, pc_name, cabinet);

      SetIp("");
      SetPc_name("");
      SetCabinet("");
      setSuccessMessage("–ö–æ–º–ø—å—é—Ç–µ—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω");
      setErrorMessage("");
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä</h2>
      <form>
        <input
          type="text"
          placeholder="–ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞"
          className="w-full p-2 border rounded-lg mb-2"
          value={pc_name}
          onChange={(e) => SetPc_name(e.target.value)}
        />
        <input
          type="text"
          placeholder="IP-–∞–¥—Ä–µ—Å"
          className="w-full p-2 border rounded-lg mb-2"
          value={ip}
          onChange={(e) => SetIp(e.target.value)}
        />
        <input
          type="text"
          placeholder="–ö–∞–±–∏–Ω–µ—Ç"
          className="w-full p-2 border rounded-lg mb-2"
          value={cabinet}
          onChange={(e) => SetCabinet(e.target.value)}
        />
        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">
              –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä –≤ –±–∞–∑—É?
            </p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  addPC();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreateProdComponents.tsx
================================================================================

import { useState } from "react";
import { createComponentRef } from "src/api/product_componentApi";

export const CreateProdComp: React.FC = () => {
  const [title, SetTitle] = useState("");
  const [quantity, SetQuantity] = useState(0);
  const [article, SetArticle] = useState("");

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const addComponent = async () => {
    try {
      await createComponentRef(title, article, quantity);
      SetTitle("");
      SetQuantity(0);
      SetArticle("");
      setSuccessMessage("–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ");
      setErrorMessage("");
    } catch (error: any) {
        setSuccessMessage("");
        setErrorMessage('!–û—à–∏–±–∫–∞')
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.error}`
      );
      console.log(error);
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ</h2>
      <form>
        <input
          type="text"
          placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"
          className="w-full p-2 border rounded-lg mb-2"
          value={title}
          onChange={(e) => SetTitle(e.target.value)}
        />
        <input
          type="text"
          placeholder="–ê—Ä—Ç–∏–∫—É–ª"
          className="w-full p-2 border rounded-lg mb-2"
          value={article}
          onChange={(e) => SetArticle(e.target.value)}
        />
        <p className="text-sm text-gray-600">
                    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ
                  </p>
        <input
          type="number"
          placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ"
          className="w-full p-2 border rounded-lg mb-2"
          value={quantity}
          onChange={(e) => SetQuantity(Number(e.target.value))}
        />
        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">
              –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ {title} –≤ –±–∞–∑—É?
            </p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  addComponent();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreateProdStatus.tsx
================================================================================

import { useState } from "react";
import { createStatus } from "src/api/product_componentApi";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";

export const CreateProdStatus: React.FC = () => {
  const [title, setTitle] = useState("");

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  const addStatus = async () => {
    try {
      await createStatus(title);

      setTitle("");
      closeModal();
      setSuccessMessage("–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω");

      setErrorMessage("");
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–∑–¥–µ–ª–∏—è</h2>
      <form>
        <input
          type="text"
          placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"
          className="w-full p-2 border rounded-lg mb-2"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
        />

        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => openModal("statusAdd")}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>

      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      <Modal isOpen={modalType === "statusAdd"} onClose={closeModal}>
        <ConfirmModal
          title1={`–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å ${title} ?`}
          actionConfirm={addStatus}
          onClose={closeModal}
        />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreateProduct.tsx
================================================================================

import { useState } from "react";
import { createProductReference } from "src/api/product_componentApi";

export const CreateProduct: React.FC = () => {
  const [title, SetTitle] = useState("");


  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);


  const addProduct = async () => {
    try {
        await createProductReference(title,1)
      SetTitle("");
      setSuccessMessage("–ò–∑–¥–µ–ª–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ");
      setErrorMessage("");
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∏–∑–¥–µ–ª–∏–µ</h2>
      <form>
        <input
          type="text"
          placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"
          className="w-full p-2 border rounded-lg mb-2"
          value={title}
          onChange={(e) => SetTitle(e.target.value)}
        />
        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p className="text-gray-600 mt-2">
              –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ –∏–∑–¥–µ–ª–∏–µ {title} –≤ –±–∞–∑—É?
            </p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  addProduct();
                  setConfirm(false);
                }}
              >
                ‚úÖ –î–∞, –¥–æ–±–∞–≤–∏—Ç—å
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ‚ùå –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/AdminCard.tsx
================================================================================

import { NavLink } from "react-router-dom";

type AdminCardProps = {
  image: string | React.ReactNode;
  title: string;
  description: string;
  onAdd?: () => void;
  editLink: string;
};

export const AdminCard = ({
  image,
  title,
  description,
  onAdd,
  editLink,
}: AdminCardProps) => (
  <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer">
    <div className="flex items-center gap-4">
      {typeof image === "string" ? (
        <img src={image} alt={title} className="w-12 h-12" />
      ) : (
        image
      )}
      <div>
        <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
        <p className="text-sm text-gray-600">{description}</p>
      </div>
    </div>
    <div className="mt-4 flex gap-2">
      {onAdd && (
        <button
          className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition"
          onClick={onAdd}
        >
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      )}
      <NavLink
        to={editLink}
        className="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition"
      >
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
      </NavLink>
    </div>
  </div>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/BoardsSection.tsx
================================================================================

import { AdminCard } from "./AdminCard";

import ELRS915Image from "assets/images/radiomaster-bandit-br3-expresslrs-915mhz-03.png";
import FCImage from "assets/images/FC2.png";
import ELRS24Image from "assets/images/24v1.png";
import CoralB1 from "assets/images/CoralB1.png";

import {
  CORAL_B_ROUTE,
  ELRS_2_4_ROUTE,
  ELRS_915_ROUTE,
  FC_ROUTE,
} from "src/utils/consts";
import {
  CREATE_BOARD_24,
  CREATE_BOARD_915,
  CREATE_BOARD_CORAL_B,
  CREATE_BOARD_FC,
} from "src/utils/constsModalType";

type BoardsSectionProps = {
  openModal: (type: string) => void;
};

export const BoardsSection: React.FC<BoardsSectionProps> = ({ openModal }) => (
  <div className="w-full max-w-4xl mt-8">
    <h2 className="text-xl font-semibold text-gray-700 mb-4">–ü–ª–∞—Ç—ã</h2>
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <AdminCard
        image={FCImage}
        title="FC"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ FC"
        onAdd={() => openModal(CREATE_BOARD_FC)}
        editLink={FC_ROUTE}
      />
      <AdminCard
        image={ELRS915Image}
        title="ELRS 915"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ elrs 915"
        onAdd={() => openModal(CREATE_BOARD_915)}
        editLink={ELRS_915_ROUTE}
      />
      <AdminCard
        image={ELRS24Image}
        title="ELRS 2.4"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ elrs 2.4"
        onAdd={() => openModal(CREATE_BOARD_24)}
        editLink={ELRS_2_4_ROUTE}
      />
      <AdminCard
        image={CoralB1}
        title="Coral B"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Coral B"
        onAdd={() => openModal(CREATE_BOARD_CORAL_B)}
        editLink={CORAL_B_ROUTE}
      />
    </div>
  </div>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/DefectCategoriesSection.tsx
================================================================================

import { AdminCard } from "./AdminCard";

import ELRS915Image from "assets/images/radiomaster-bandit-br3-expresslrs-915mhz-03.png";
import FCImage from "assets/images/FC2.png";
import ELRS24Image from "assets/images/24v1.png";
import CoralB1 from "assets/images/CoralB1.png";

import {
  ADMIN_DEFECTS_FC_CATEGORIES_ROUTE,
  ADMIN_DEFECTS_915_CATEGORIES_ROUTE,
  ADMIN_DEFECTS_2_4_CATEGORIES_ROUTE,
  ADMIN_DEFECTS_CORAL_B_CATEGORIES_ROUTE,
} from "src/utils/consts";
import {
  CREATE_DEFECT_24,
  CREATE_DEFECT_915,
  CREATE_DEFECT_CORAL_B,
  CREATE_DEFECT_FC,
} from "src/utils/constsModalType";

type DefectCategoriesSectionProps = {
  openModal: (type: string) => void;
};

export const DefectCategoriesSection: React.FC<
  DefectCategoriesSectionProps
> = ({ openModal }) => (
  <div className="w-full max-w-4xl">
    <h2 className="text-xl font-semibold text-gray-700 mb-4">
      –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞
    </h2>
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <AdminCard
        image={FCImage}
        title="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ FC"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –±—Ä–∞–∫–∞ –¥–ª—è FC"
        onAdd={() => openModal(CREATE_DEFECT_FC)}
        editLink={ADMIN_DEFECTS_FC_CATEGORIES_ROUTE}
      />
      <AdminCard
        image={ELRS915Image}
        title="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ 915"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –±—Ä–∞–∫–∞ –¥–ª—è 915"
        onAdd={() => openModal(CREATE_DEFECT_915)}
        editLink={ADMIN_DEFECTS_915_CATEGORIES_ROUTE}
      />
      <AdminCard
        image={ELRS24Image}
        title="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ 2.4"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –±—Ä–∞–∫–∞ –¥–ª—è 2.4"
        onAdd={() => openModal(CREATE_DEFECT_24)}
        editLink={ADMIN_DEFECTS_2_4_CATEGORIES_ROUTE}
      />
      <AdminCard
        image={CoralB1}
        title="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ Coral B"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –±—Ä–∞–∫–∞ –¥–ª—è Coral B"
        onAdd={() => openModal(CREATE_DEFECT_CORAL_B)}
        editLink={ADMIN_DEFECTS_CORAL_B_CATEGORIES_ROUTE}
      />
    </div>
  </div>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/ProductsSection.tsx
================================================================================

import {
  ADMIN_COMPONENTS_ROUTE,
  ADMIN_PRODUCTS_ROUTE,
  ADMIN_PRODUCTS_STATUSES_ROUTE,
} from "src/utils/consts";
import { AdminCard } from "./AdminCard";
import ProductImage from "assets/images/ProductBox.jpg";
import StatusImg from "assets/images/statuses.png";
import ComponentsImg from "assets/images/components.jpg";
import {
  CREATE_COMPONENT,
  CREATE_PRODUCT,
  CREATE_PRODUCT_STATUSES,
} from "src/utils/constsModalType";

type ProductsSectionProps = {
  openModal: (type: string) => void;
};

export const ProductsSection: React.FC<ProductsSectionProps> = ({
  openModal,
}) => (
  <div className="w-full max-w-4xl mt-8">
    <h2 className="text-xl font-semibold text-gray-700 mb-4">
      –ò–∑–¥–µ–ª–∏—è –∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ
    </h2>
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <AdminCard
        image={ProductImage}
        title="–ò–∑–¥–µ–ª–∏—è"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è–º–∏"
        onAdd={() => openModal(CREATE_PRODUCT)}
        editLink={ADMIN_PRODUCTS_ROUTE}
      />
      <AdminCard
        image={StatusImg}
        title=" –°—Ç–∞—Ç—É—Å—ã –∏–∑–¥–µ–ª–∏–π"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏"
        onAdd={() => openModal(CREATE_PRODUCT_STATUSES)}
        editLink={ADMIN_PRODUCTS_STATUSES_ROUTE}
      />
      <AdminCard
        image={ComponentsImg}
        title=" –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–º–∏"
        onAdd={() => openModal(CREATE_COMPONENT)}
        editLink={ADMIN_COMPONENTS_ROUTE}
      />
    </div>
  </div>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/StructureSection.tsx
================================================================================

import React from "react";
import { AdminCard } from "./AdminCard";
import { Network } from "lucide-react";
import { STRUCTURE_ROUTE } from "src/utils/consts";

export const StructureSection: React.FC = () => {
  return (
    <div className="w-full max-w-4xl mt-8">
      <h2 className="text-xl font-semibold text-gray-700 mb-4">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <AdminCard
          image={<Network className="w-12 h-12 text-indigo-600" />}
          title="–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ò–µ—Ä–∞—Ä—Ö–∏—è"
          description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞–º–∏, –±—Ä–∏–≥–∞–¥–∞–º–∏ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö"
          editLink={STRUCTURE_ROUTE}
        />
      </div>
    </div>
  );
};
================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/UsersSection.tsx
================================================================================

import { ADMIN_PCs_ROUTE, ADMIN_USERS_ROUTE, AUDIT_LOG_ROUTE } from "src/utils/consts";
import { AdminCard } from "./AdminCard";
import ComputerImage from "assets/images/pc.png";
import { Users, History } from "lucide-react";
import { CREATE_COMPUTER } from "src/utils/constsModalType";

type UsersSectionProps = {
  openModal: (type: string) => void;
};

export const UsersSection: React.FC<UsersSectionProps> = ({ openModal }) => (
  <div className="w-full max-w-4xl mt-8">
    <h2 className="text-xl font-semibold text-gray-700 mb-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ö–æ–Ω—Ç—Ä–æ–ª—å</h2>

    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <AdminCard
        image={ComputerImage}
        title="–ö–æ–º–ø—å—é—Ç–µ—Ä—ã"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–ö"
        onAdd={() => openModal(CREATE_COMPUTER)}
        editLink={ADMIN_PCs_ROUTE}
      />
      <AdminCard
        image={<Users className="w-12 h-12 text-purple-600" />}
        title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
        description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"
        onAdd={() => alert("–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å—É—Ç—Å–≤—É–µ—Ç, —Ä–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")}
        editLink={ADMIN_USERS_ROUTE}
      />

      <AdminCard
        image={<History className="w-12 h-12 text-amber-600" />}
        title="–ñ—É—Ä–Ω–∞–ª –ê—É–¥–∏—Ç–∞"
        description="–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        editLink={AUDIT_LOG_ROUTE}
      />
    </div>
  </div>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/WarehouseSection.tsx
================================================================================

import React from "react";
import { AdminCard } from "./AdminCard";
import { Package } from "lucide-react";
import { ADMIN_WAREHOUSE_ROUTE } from "src/utils/consts";

export const WarehouseSection: React.FC = () => {
  return (
    <div className="w-full max-w-4xl mt-8">
      <h2 className="text-xl font-semibold text-gray-700 mb-4">
        –°–∫–ª–∞–¥ –∏ –ø—Ä–∏—ë–º–∫–∞
      </h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <AdminCard
          image={<Package className="w-12 h-12 text-emerald-600" />}
          title="–ü—Ä–∏—ë–º–∫–∞ –∏ —Å–∫–ª–∞–¥"
          description="–ü–æ—Å—Ç–∞–≤–∫–∏, –∫–æ—Ä–æ–±–∫–∏ –∏ —ç—Ç–∏–∫–µ—Ç–∫–∏"
          editLink={ADMIN_WAREHOUSE_ROUTE}
        />
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/RBAC/AdminRightsPage.tsx
================================================================================

import React, { useEffect, useState, useMemo } from "react";
import { observer } from "mobx-react-lite";
import {
    fetchAllRoles,
    fetchAllAbilities,
    updateRoleAbilities,
    RoleModel,
    AbilityModel
} from "src/api/rbacApi";
import { fetchUsers } from "src/api/fcApi";
import { userGetModel } from "src/types/UserModel";
import {
    Shield, Save, CheckSquare, Square,
    Loader2, Users, Key, Search, User,
    ChevronDown, ChevronRight, Filter, X,
    CheckCircle2, AlertCircle
} from "lucide-react";
import toast from "react-hot-toast";


interface AbilityGroup {
    prefix: string;
    label: string;
    abilities: AbilityModel[];
    isExpanded: boolean;
}


const GROUP_LABELS: Record<string, string> = {
    warehouse: "–°–∫–ª–∞–¥",
    recipe: "–¢–µ—Ö–∫–∞—Ä—Ç—ã",
    rbac: "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞",
    roles: "–†–æ–ª–∏",
    users: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
    assembly: "–°–±–æ—Ä–∫–∞",
    firmware: "–ü—Ä–æ—à–∏–≤–∫–∞",
    devices: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
    analytics: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞",
    beryll: "–ê–ü–ö –ë–µ—Ä–∏–ª–ª",
    defect: "–î–µ—Ñ–µ–∫—Ç—ã/–ë—Ä–∞–∫",
    admin: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ",
    production: "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ",
    tasks: "–ó–∞–¥–∞—á–∏",
    mit: "–†—É—á–Ω–æ–π –≤–≤–æ–¥",
};


export const AdminRightsPage: React.FC = observer(() => {

    const [viewMode, setViewMode] = useState<"USERS" | "MATRIX">("USERS");
    const [loading, setLoading] = useState(false);


    const [roles, setRoles] = useState<RoleModel[]>([]);
    const [abilities, setAbilities] = useState<AbilityModel[]>([]);
    const [users, setUsers] = useState<userGetModel[]>([]);


    const [matrix, setMatrix] = useState<Record<number, Set<number>>>({});
    const [originalMatrix, setOriginalMatrix] = useState<Record<number, Set<number>>>({});
    const [savingId, setSavingId] = useState<number | null>(null);
    const [savingAll, setSavingAll] = useState(false);


    const [userSearch, setUserSearch] = useState("");
    const [abilitySearch, setAbilitySearch] = useState("");


    const [expandedGroups, setExpandedGroups] = useState<Set<string>>(new Set());
    const [compactMode, setCompactMode] = useState(false);


    useEffect(() => {
        loadData();
    }, []);

    const loadData = async () => {
        setLoading(true);
        try {
            const [rolesData, abilitiesData, usersData] = await Promise.all([
                fetchAllRoles(),
                fetchAllAbilities(),
                fetchUsers()
            ]);

            setRoles(rolesData);
            setAbilities(abilitiesData);
            setUsers(usersData);


            const initialMatrix: Record<number, Set<number>> = {};
            rolesData.forEach(role => {
                const abilityIds = new Set(role.abilities.map(a => a.id));
                initialMatrix[role.id] = abilityIds;
            });
            setMatrix(initialMatrix);
            setOriginalMatrix(JSON.parse(JSON.stringify(
                Object.fromEntries(
                    Object.entries(initialMatrix).map(([k, v]) => [k, Array.from(v)])
                )
            )));


            const prefixes = new Set(abilitiesData.map(a => a.code.split('.')[0]));
            setExpandedGroups(prefixes);

        } catch (e) {
            console.error(e);
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏");
        } finally {
            setLoading(false);
        }
    };


    const groupedAbilities = useMemo(() => {
        const groups: Record<string, AbilityModel[]> = {};

        abilities.forEach(ability => {
            const prefix = ability.code.split('.')[0];
            if (!groups[prefix]) groups[prefix] = [];
            groups[prefix].push(ability);
        });


        const filtered: AbilityGroup[] = Object.entries(groups)
            .map(([prefix, abs]) => ({
                prefix,
                label: GROUP_LABELS[prefix] || prefix,
                abilities: abs.filter(a =>
                    !abilitySearch ||
                    a.code.toLowerCase().includes(abilitySearch.toLowerCase()) ||
                    a.description.toLowerCase().includes(abilitySearch.toLowerCase())
                ),
                isExpanded: expandedGroups.has(prefix)
            }))
            .filter(g => g.abilities.length > 0)
            .sort((a, b) => a.label.localeCompare(b.label));

        return filtered;
    }, [abilities, abilitySearch, expandedGroups]);


    const visibleAbilities = useMemo(() => {
        const result: { ability: AbilityModel; groupPrefix: string; isFirstInGroup: boolean; groupLabel: string; groupSize: number }[] = [];

        groupedAbilities.forEach(group => {
            if (group.isExpanded) {
                group.abilities.forEach((ability, idx) => {
                    result.push({
                        ability,
                        groupPrefix: group.prefix,
                        isFirstInGroup: idx === 0,
                        groupLabel: group.label,
                        groupSize: group.abilities.length
                    });
                });
            }
        });

        return result;
    }, [groupedAbilities]);


    const togglePermission = (roleId: number, abilityId: number) => {
        const role = roles.find(r => r.id === roleId);
        if (role?.name === 'SUPER_ADMIN') {
            toast('–ü—Ä–∞–≤–∞ –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∞ –Ω–µ–∏–∑–º–µ–Ω–Ω—ã', { icon: 'üîí' });
            return;
        }

        setMatrix(prev => {
            const roleAbilities = new Set(prev[roleId]);
            if (roleAbilities.has(abilityId)) {
                roleAbilities.delete(abilityId);
            } else {
                roleAbilities.add(abilityId);
            }
            return { ...prev, [roleId]: roleAbilities };
        });
    };


    const toggleGroupForRole = (roleId: number, groupPrefix: string) => {
        const role = roles.find(r => r.id === roleId);
        if (role?.name === 'SUPER_ADMIN') {
            toast('–ü—Ä–∞–≤–∞ –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∞ –Ω–µ–∏–∑–º–µ–Ω–Ω—ã', { icon: 'üîí' });
            return;
        }

        const groupAbilities = abilities.filter(a => a.code.startsWith(groupPrefix + '.'));
        const groupIds = groupAbilities.map(a => a.id);

        setMatrix(prev => {
            const roleAbilities = new Set(prev[roleId]);
            const allChecked = groupIds.every(id => roleAbilities.has(id));

            if (allChecked) {

                groupIds.forEach(id => roleAbilities.delete(id));
            } else {

                groupIds.forEach(id => roleAbilities.add(id));
            }
            return { ...prev, [roleId]: roleAbilities };
        });
    };


    const hasChanges = (roleId: number): boolean => {
        const current = matrix[roleId] || new Set();
        const original = new Set(originalMatrix[roleId] || []);

        if (current.size !== original.size) return true;
        for (const id of current) {
            if (!original.has(id)) return true;
        }
        return false;
    };


    const changedRolesCount = useMemo(() => {
        return roles.filter(r => hasChanges(r.id)).length;
    }, [roles, matrix, originalMatrix]);


    const saveRole = async (roleId: number) => {
        setSavingId(roleId);
        try {
            const abilityIds = Array.from(matrix[roleId] || []);
            await updateRoleAbilities(roleId, abilityIds);
            toast.success("–ü—Ä–∞–≤–∞ —Ä–æ–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã");


            setOriginalMatrix(prev => ({
                ...prev,
                [roleId]: abilityIds
            }));


            const updatedRoles = roles.map(r => {
                if (r.id === roleId) {
                    const newAbilities = abilities.filter(a => abilityIds.includes(a.id));
                    return { ...r, abilities: newAbilities };
                }
                return r;
            });
            setRoles(updatedRoles);
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        } finally {
            setSavingId(null);
        }
    };

    const saveAllChanges = async () => {
        const changedRoles = roles.filter(r => hasChanges(r.id));
        if (changedRoles.length === 0) return;

        setSavingAll(true);
        let successCount = 0;
        let errorCount = 0;

        for (const role of changedRoles) {
            try {
                const abilityIds = Array.from(matrix[role.id] || []);
                await updateRoleAbilities(role.id, abilityIds);

                setOriginalMatrix(prev => ({
                    ...prev,
                    [role.id]: abilityIds
                }));
                successCount++;
            } catch (e) {
                errorCount++;
            }
        }

        setSavingAll(false);

        if (errorCount === 0) {
            toast.success(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${successCount} —Ä–æ–ª–µ–π`);
        } else {
            toast.error(`–û—à–∏–±–∫–∏: ${errorCount} –∏–∑ ${changedRoles.length}`);
        }


        loadData();
    };


    const getUserAbilities = (userRoleName: string) => {
        if (userRoleName === 'SUPER_ADMIN') return abilities;
        const roleObj = roles.find(r => r.name === userRoleName);
        return roleObj ? roleObj.abilities : [];
    };

    const filteredUsers = users.filter(u =>
        u.login.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.name?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.surname?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.role.toLowerCase().includes(userSearch.toLowerCase())
    );


    const toggleGroup = (prefix: string) => {
        setExpandedGroups(prev => {
            const next = new Set(prev);
            if (next.has(prefix)) {
                next.delete(prefix);
            } else {
                next.add(prefix);
            }
            return next;
        });
    };

    const expandAllGroups = () => {
        const allPrefixes = new Set(abilities.map(a => a.code.split('.')[0]));
        setExpandedGroups(allPrefixes);
    };

    const collapseAllGroups = () => {
        setExpandedGroups(new Set());
    };


    if (loading && roles.length === 0) {
        return (
            <div className="flex justify-center p-20">
                <Loader2 className="animate-spin text-indigo-600" size={32}/>
            </div>
        );
    }

    return (
        <div className="p-6 bg-gray-50 min-h-screen">
            <div className="max-w-full mx-auto">


                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div className="flex items-center gap-4">
                        <div className="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 text-white">
                            <Shield size={32} />
                        </div>
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800">–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞</h1>
                            <p className="text-gray-500 font-medium">RBAC: –†–æ–ª–∏ –∏ –ø–æ–ª–Ω–æ–º–æ—á–∏—è</p>
                        </div>
                    </div>


                    <div className="bg-white p-1 rounded-xl shadow-sm border border-gray-200 flex">
                        <button
                            onClick={() => setViewMode("USERS")}
                            className={`px-6 py-2 rounded-lg font-bold transition flex items-center gap-2 ${
                                viewMode === "USERS"
                                    ? "bg-indigo-50 text-indigo-700 shadow-sm"
                                    : "text-gray-500 hover:bg-gray-50"
                            }`}
                        >
                            <Users size={18} /> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                        </button>
                        <button
                            onClick={() => setViewMode("MATRIX")}
                            className={`px-6 py-2 rounded-lg font-bold transition flex items-center gap-2 ${
                                viewMode === "MATRIX"
                                    ? "bg-indigo-50 text-indigo-700 shadow-sm"
                                    : "text-gray-500 hover:bg-gray-50"
                            }`}
                        >
                            <Key size={18} /> –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤
                        </button>
                    </div>
                </div>


                {viewMode === "USERS" && (
                    <div className="space-y-4 animate-fade-in">

                        <div className="relative max-w-md">
                            <Search className="absolute left-3 top-2.5 text-gray-400 w-5 h-5"/>
                            <input
                                value={userSearch}
                                onChange={e => setUserSearch(e.target.value)}
                                className="w-full pl-10 pr-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="–ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞..."
                            />
                        </div>

                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                                    <tr>
                                        <th className="p-4">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                        <th className="p-4">–†–æ–ª—å (Keycloak)</th>
                                        <th className="p-4">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∞</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filteredUsers.map(user => {
                                        const effectiveAbilities = getUserAbilities(user.role);
                                        return (
                                            <tr key={user.id} className="hover:bg-indigo-50/30 transition">
                                                <td className="p-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 overflow-hidden border border-gray-200">
                                                            {user.img ? (
                                                                <img src={user.img} alt="" className="w-full h-full object-cover"/>
                                                            ) : (
                                                                <User size={20}/>
                                                            )}
                                                        </div>
                                                        <div>
                                                            <div className="font-semibold text-gray-800">
                                                                {user.surname} {user.name}
                                                            </div>
                                                            <div className="text-xs text-gray-400">{user.login}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="p-4">
                                                    <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold">
                                                        {user.role}
                                                    </span>
                                                </td>
                                                <td className="p-4">
                                                    <div className="flex flex-wrap gap-1 max-w-xl">
                                                        {effectiveAbilities.length > 0 ? effectiveAbilities.map(ab => (
                                                            <span
                                                                key={ab.id}
                                                                className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-[10px] border border-gray-200"
                                                                title={ab.code}
                                                            >
                                                                {ab.description}
                                                            </span>
                                                        )) : (
                                                            <span className="text-gray-400 text-sm italic">–ù–µ—Ç –ø—Ä–∞–≤</span>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {filteredUsers.length === 0 && (
                                <div className="p-8 text-center text-gray-400">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                            )}
                        </div>
                    </div>
                )}


                {viewMode === "MATRIX" && (
                    <div className="space-y-4 animate-fade-in">


                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <div className="flex flex-wrap items-center gap-4">

                                <div className="relative flex-1 min-w-[200px] max-w-md">
                                    <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4"/>
                                    <input
                                        value={abilitySearch}
                                        onChange={e => setAbilitySearch(e.target.value)}
                                        className="w-full pl-9 pr-8 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∞–≤–∞..."
                                    />
                                    {abilitySearch && (
                                        <button
                                            onClick={() => setAbilitySearch("")}
                                            className="absolute right-2 top-2.5 text-gray-400 hover:text-gray-600"
                                        >
                                            <X size={16}/>
                                        </button>
                                    )}
                                </div>


                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={expandAllGroups}
                                        className="px-3 py-2 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition"
                                    >
                                        –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
                                    </button>
                                    <button
                                        onClick={collapseAllGroups}
                                        className="px-3 py-2 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition"
                                    >
                                        –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
                                    </button>
                                </div>


                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={compactMode}
                                        onChange={e => setCompactMode(e.target.checked)}
                                        className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                    />
                                    <span className="text-sm text-gray-600">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º</span>
                                </label>


                                <div className="ml-auto flex items-center gap-4 text-sm text-gray-500">
                                    <span>{roles.length} —Ä–æ–ª–µ–π</span>
                                    <span>{abilities.length} –ø—Ä–∞–≤</span>
                                    <span>{groupedAbilities.length} –≥—Ä—É–ø–ø</span>
                                </div>
                            </div>
                        </div>


                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full border-collapse">
                                    <thead>
                                        <tr>

                                            <th className={`
                                                ${compactMode ? 'p-2 min-w-[160px]' : 'p-4 min-w-[220px]'}
                                                text-left bg-gray-50 border-b border-r
                                                sticky left-0 z-20
                                                shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}>
                                                <div className="text-xs text-gray-400 font-normal uppercase mb-1">–†–æ–ª—å</div>
                                                <div className="font-bold text-gray-800">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏</div>
                                            </th>


                                            {groupedAbilities.map(group => (
                                                <th
                                                    key={group.prefix}
                                                    colSpan={group.isExpanded ? group.abilities.length : 1}
                                                    className={`
                                                        ${compactMode ? 'p-1' : 'p-2'}
                                                        text-center bg-gray-100 border-b border-r
                                                        ${!group.isExpanded ? 'cursor-pointer hover:bg-gray-200' : ''}
                                                    `}
                                                    onClick={() => !group.isExpanded && toggleGroup(group.prefix)}
                                                >
                                                    <div className="flex items-center justify-center gap-1">
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); toggleGroup(group.prefix); }}
                                                            className="p-1 hover:bg-gray-200 rounded transition"
                                                        >
                                                            {group.isExpanded
                                                                ? <ChevronDown size={14} className="text-gray-500"/>
                                                                : <ChevronRight size={14} className="text-gray-500"/>
                                                            }
                                                        </button>
                                                        <span className="font-bold text-gray-700 text-xs uppercase">
                                                            {group.label}
                                                        </span>
                                                        <span className="text-[10px] text-gray-400 ml-1">
                                                            ({group.abilities.length})
                                                        </span>
                                                    </div>
                                                </th>
                                            ))}


                                            <th className={`
                                                ${compactMode ? 'p-2 min-w-[70px]' : 'p-4 min-w-[100px]'}
                                                bg-gray-50 border-b
                                                sticky right-0 z-20
                                                shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}>
                                                <div className="text-xs text-gray-500 font-bold">–°–æ—Ö—Ä.</div>
                                            </th>
                                        </tr>


                                        <tr>
                                            <th className={`
                                                ${compactMode ? 'p-1' : 'p-2'}
                                                bg-gray-50 border-b border-r
                                                sticky left-0 z-20
                                                shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}></th>

                                            {groupedAbilities.map(group => (
                                                group.isExpanded ? (
                                                    group.abilities.map(ab => (
                                                        <th
                                                            key={ab.id}
                                                            className={`
                                                                ${compactMode ? 'p-1 min-w-[80px]' : 'p-2 min-w-[110px]'}
                                                                text-center bg-gray-50 border-b border-r align-top
                                                            `}
                                                        >
                                                            <div className={`
                                                                ${compactMode ? 'text-[8px]' : 'text-[10px]'}
                                                                text-gray-400 font-mono mb-0.5 truncate
                                                            `} title={ab.code}>
                                                                .{ab.code.split('.')[1]}
                                                            </div>
                                                            <div className={`
                                                                ${compactMode ? 'text-[9px]' : 'text-xs'}
                                                                font-semibold text-gray-600 leading-tight
                                                            `} title={ab.description}>
                                                                {compactMode
                                                                    ? ab.description.slice(0, 12) + (ab.description.length > 12 ? '‚Ä¶' : '')
                                                                    : ab.description
                                                                }
                                                            </div>
                                                        </th>
                                                    ))
                                                ) : (
                                                    <th key={group.prefix + '-collapsed'} className="p-1 bg-gray-50 border-b border-r">
                                                        <div className="text-[10px] text-gray-400 italic">—Å–≤—ë—Ä–Ω—É—Ç–æ</div>
                                                    </th>
                                                )
                                            ))}

                                            <th className={`
                                                ${compactMode ? 'p-1' : 'p-2'}
                                                bg-gray-50 border-b
                                                sticky right-0 z-20
                                                shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}></th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        {roles.map(role => {
                                            const isChanged = hasChanges(role.id);
                                            const isSuperAdmin = role.name === 'SUPER_ADMIN';

                                            return (
                                                <tr
                                                    key={role.id}
                                                    className={`
                                                        hover:bg-indigo-50/30 transition group
                                                        ${isChanged ? 'bg-amber-50/50' : ''}
                                                    `}
                                                >

                                                    <td className={`
                                                        ${compactMode ? 'p-2' : 'p-4'}
                                                        border-r border-b bg-white
                                                        sticky left-0 z-10
                                                        group-hover:bg-indigo-50/30
                                                        ${isChanged ? 'bg-amber-50/50 group-hover:bg-amber-100/50' : ''}
                                                        shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                                    `}>
                                                        <div className={`font-bold text-gray-800 ${compactMode ? 'text-xs' : 'text-sm'}`}>
                                                            {role.description}
                                                        </div>
                                                        <div className={`text-indigo-500 font-mono mt-0.5 ${compactMode ? 'text-[10px]' : 'text-xs'}`}>
                                                            {role.name}
                                                        </div>
                                                        {isChanged && (
                                                            <div className="flex items-center gap-1 mt-1 text-amber-600">
                                                                <AlertCircle size={12}/>
                                                                <span className="text-[10px]">–ò–∑–º–µ–Ω–µ–Ω–æ</span>
                                                            </div>
                                                        )}
                                                    </td>


                                                    {groupedAbilities.map(group => (
                                                        group.isExpanded ? (
                                                            group.abilities.map(ab => {
                                                                const isChecked = isSuperAdmin || matrix[role.id]?.has(ab.id);
                                                                return (
                                                                    <td
                                                                        key={ab.id}
                                                                        onClick={() => togglePermission(role.id, ab.id)}
                                                                        className={`
                                                                            ${compactMode ? 'p-1' : 'p-2'}
                                                                            border-r border-b text-center
                                                                            ${isSuperAdmin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer'}
                                                                            transition-colors
                                                                            ${isChecked ? 'bg-indigo-50/50' : ''}
                                                                            ${!isSuperAdmin && 'hover:bg-indigo-100/50'}
                                                                        `}
                                                                    >
                                                                        <div className="flex justify-center">
                                                                            {isChecked
                                                                                ? <CheckSquare size={compactMode ? 16 : 20} className="text-indigo-600"/>
                                                                                : <Square size={compactMode ? 16 : 20} className="text-gray-300"/>
                                                                            }
                                                                        </div>
                                                                    </td>
                                                                );
                                                            })
                                                        ) : (

                                                            <td
                                                                key={group.prefix + '-collapsed'}
                                                                onClick={() => !isSuperAdmin && toggleGroupForRole(role.id, group.prefix)}
                                                                className={`
                                                                    ${compactMode ? 'p-1' : 'p-2'}
                                                                    border-r border-b text-center
                                                                    ${isSuperAdmin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer hover:bg-indigo-100/50'}
                                                                    transition-colors
                                                                `}
                                                                title="–ö–ª–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ–π –≥—Ä—É–ø–ø—ã"
                                                            >
                                                                {(() => {
                                                                    const groupAbilities = abilities.filter(a => a.code.startsWith(group.prefix + '.'));
                                                                    const checkedCount = isSuperAdmin
                                                                        ? groupAbilities.length
                                                                        : groupAbilities.filter(a => matrix[role.id]?.has(a.id)).length;
                                                                    const total = groupAbilities.length;

                                                                    return (
                                                                        <div className={`
                                                                            font-mono font-bold
                                                                            ${checkedCount === total ? 'text-green-600' :
                                                                              checkedCount === 0 ? 'text-gray-400' : 'text-amber-600'}
                                                                            ${compactMode ? 'text-xs' : 'text-sm'}
                                                                        `}>
                                                                            {checkedCount}/{total}
                                                                        </div>
                                                                    );
                                                                })()}
                                                            </td>
                                                        )
                                                    ))}


                                                    <td className={`
                                                        ${compactMode ? 'p-1' : 'p-2'}
                                                        border-b bg-white
                                                        sticky right-0 z-10
                                                        group-hover:bg-indigo-50/30
                                                        ${isChanged ? 'bg-amber-50/50 group-hover:bg-amber-100/50' : ''}
                                                        shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                                    `}>
                                                        <button
                                                            onClick={() => saveRole(role.id)}
                                                            disabled={!isChanged || savingId === role.id || isSuperAdmin}
                                                            className={`
                                                                p-2 rounded-lg transition-all flex items-center justify-center
                                                                ${isChanged && !isSuperAdmin
                                                                    ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md'
                                                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                                }
                                                            `}
                                                            title={isSuperAdmin ? '–ü—Ä–∞–≤–∞ –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∞ –Ω–µ–∏–∑–º–µ–Ω–Ω—ã' : isChanged ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π'}
                                                        >
                                                            {savingId === role.id
                                                                ? <Loader2 size={16} className="animate-spin"/>
                                                                : <Save size={16}/>
                                                            }
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>


                        <div className="flex flex-wrap items-center gap-6 text-xs text-gray-500 px-2">
                            <div className="flex items-center gap-2">
                                <CheckSquare size={16} className="text-indigo-600"/>
                                <span>–ü—Ä–∞–≤–æ –≤–∫–ª—é—á–µ–Ω–æ</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <Square size={16} className="text-gray-300"/>
                                <span>–ü—Ä–∞–≤–æ –≤—ã–∫–ª—é—á–µ–Ω–æ</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 bg-amber-100 rounded"/>
                                <span>–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="font-mono text-green-600 font-bold">3/3</span>
                                <span>–í—Å–µ –ø—Ä–∞–≤–∞ –≥—Ä—É–ø–ø—ã (–≤ —Å–≤—ë—Ä–Ω—É—Ç–æ–º –≤–∏–¥–µ)</span>
                            </div>
                        </div>
                    </div>
                )}


                {viewMode === "MATRIX" && changedRolesCount > 0 && (
                    <div className="fixed bottom-6 right-6 z-50 animate-bounce-in">
                        <button
                            onClick={saveAllChanges}
                            disabled={savingAll}
                            className="
                                flex items-center gap-3 px-6 py-4
                                bg-gradient-to-r from-indigo-600 to-purple-600
                                text-white font-bold rounded-2xl
                                shadow-2xl shadow-indigo-500/40
                                hover:from-indigo-700 hover:to-purple-700
                                transition-all transform hover:scale-105
                                disabled:opacity-70 disabled:cursor-not-allowed
                            "
                        >
                            {savingAll ? (
                                <>
                                    <Loader2 size={24} className="animate-spin"/>
                                    <span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
                                </>
                            ) : (
                                <>
                                    <Save size={24}/>
                                    <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</span>
                                    <span className="
                                        ml-2 px-2 py-1
                                        bg-white/20 rounded-full
                                        text-sm font-mono
                                    ">
                                        {changedRolesCount}
                                    </span>
                                </>
                            )}
                        </button>
                    </div>
                )}
            </div>


            <style>{`
                @keyframes fade-in {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes bounce-in {
                    0% { opacity: 0; transform: scale(0.8) translateY(20px); }
                    50% { transform: scale(1.05) translateY(-5px); }
                    100% { opacity: 1; transform: scale(1) translateY(0); }
                }
                .animate-fade-in {
                    animation: fade-in 0.3s ease-out;
                }
                .animate-bounce-in {
                    animation: bounce-in 0.4s ease-out;
                }
            `}</style>
        </div>
    );
});

export default AdminRightsPage;

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Structure/StructurePage.tsx
================================================================================

import React, { useContext, useEffect, useState } from "react";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import {
  Network,
  Users,
  Plus,
  ChevronRight,
  ChevronDown,
  Crown,
  UserCheck,
  UserPlus,
  Trash2,
  Layers,
  UserX,
  ArrowRight
} from "lucide-react";
import {
  fetchStructure,
  createSection,
  createTeam,
  assignSectionManager,
  assignTeamLead,
  addUserToTeam,
  removeUserFromTeam,
  fetchUnassignedUsers,
} from "src/api/structureApi";
import { fetchUsers } from "src/api/fcApi";
import { Modal } from "src/components/Modal/Modal";
import { userGetModel } from "src/types/UserModel";
import toast from "react-hot-toast";

type Tab = "HIERARCHY" | "UNASSIGNED";

export const StructurePage: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { structureStore } = context;


  const [activeTab, setActiveTab] = useState<Tab>("HIERARCHY");
  const [expandedSections, setExpandedSections] = useState<number[]>([]);
  const [allUsers, setAllUsers] = useState<userGetModel[]>([]);
  const [unassignedUsers, setUnassignedUsers] = useState<userGetModel[]>([]);


  const [modalType, setModalType] = useState<"CREATE_SECTION" | "CREATE_TEAM" | "SELECT_USER" | null>(null);
  const [targetId, setTargetId] = useState<number | null>(null);
  const [actionType, setActionType] = useState<"MANAGER" | "LEAD" | "MEMBER" | null>(null);
  const [inputTitle, setInputTitle] = useState("");
  const [userSearch, setUserSearch] = useState("");


  const [assigningUserId, setAssigningUserId] = useState<number | null>(null);
  const [selectedSectionId, setSelectedSectionId] = useState<number | "">("");
  const [selectedTeamId, setSelectedTeamId] = useState<number | "">("");

  const loadData = async () => {
    try {
      const structData = await fetchStructure();
      structureStore.setSections(structData);

      const usersData = await fetchUsers();
      setAllUsers(usersData);


      try {
        const unassigned = await fetchUnassignedUsers();
        setUnassignedUsers(unassigned);
      } catch (e) {
        console.warn("API –¥–ª—è –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ –∏–ª–∏ –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É");
      }
    } catch (e) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
    }
  };

  useEffect(() => {
    void loadData();
  }, []);


  const handleCreateSection = async () => {
    if (!inputTitle.trim()) return;
    await createSection(inputTitle.trim());
    setInputTitle("");
    closeModal();
    await loadData();
    toast.success("–£—á–∞—Å—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω");
  };

  const handleCreateTeam = async () => {
    if (!targetId || !inputTitle.trim()) return;
    await createTeam(inputTitle.trim(), targetId);
    setInputTitle("");
    closeModal();
    await loadData();
    if (!expandedSections.includes(targetId)) {
      setExpandedSections((prev) => [...prev, targetId]);
    }
    toast.success("–ë—Ä–∏–≥–∞–¥–∞ —Å–æ–∑–¥–∞–Ω–∞");
  };

  const handleUserSelect = async (userId: number) => {
    if (!targetId || !actionType) return;

    try {
      if (actionType === "MANAGER") {
        await assignSectionManager(targetId, userId);
      } else if (actionType === "LEAD") {
        await assignTeamLead(targetId, userId);
      } else if (actionType === "MEMBER") {
        await addUserToTeam(targetId, userId);
      }
      toast.success("–£—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ");
    } catch (e) {
      toast.error("–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è");
    }

    closeModal();
    await loadData();
  };

  const handleRemoveMember = async (userId: number) => {
    if(!window.confirm("–£–±—Ä–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –±—Ä–∏–≥–∞–¥—ã?")) return;
    try {
      await removeUserFromTeam(userId);
      await loadData();
      toast.success("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω");
    } catch (e) {
      toast.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    }
  };


  const handleQuickAssign = async () => {
    if (!assigningUserId || !selectedTeamId) return;
    try {
        await addUserToTeam(Number(selectedTeamId), assigningUserId);
        toast.success("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω!");


        setAssigningUserId(null);
        setSelectedSectionId("");
        setSelectedTeamId("");

        await loadData();
    } catch (e) {
        toast.error("–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏");
    }
  };


  const openUserSelect = (id: number, type: "MANAGER" | "LEAD" | "MEMBER") => {
    setTargetId(id);
    setActionType(type);
    setUserSearch("");
    setModalType("SELECT_USER");
  };

  const openCreateTeam = (sectionId: number) => {
    setTargetId(sectionId);
    setInputTitle("");
    setModalType("CREATE_TEAM");
  };

  const closeModal = () => {
    setModalType(null);
    setTargetId(null);
    setActionType(null);
  };

  const toggleSection = (id: number) => {
    setExpandedSections((prev) =>
      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id],
    );
  };

  const filteredUsers = allUsers.filter((user) => {
    const query = userSearch.trim().toLowerCase();
    if (!query) return true;
    return `${user.name} ${user.surname} ${user.login}`.toLowerCase().includes(query);
  });


  const availableTeamsForQuickAssign = structureStore.sections
      .find(s => s.id === Number(selectedSectionId))?.production_teams || [];

  return (
    <div className="min-h-screen bg-gray-50 p-8 pb-20">
      <div className="max-w-6xl mx-auto">


        <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center">
              <Network className="w-6 h-6 text-indigo-600" />
            </div>
            <div>
              <h1 className="text-2xl font-bold text-gray-800">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</h1>
              <p className="text-sm text-gray-500">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–µ–π –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º</p>
            </div>
          </div>

          <div className="bg-white p-1 rounded-xl border border-gray-200 shadow-sm flex gap-1">
              <button
                onClick={() => setActiveTab("HIERARCHY")}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'HIERARCHY' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}
              >
                  <Layers size={16}/> –ò–µ—Ä–∞—Ä—Ö–∏—è
              </button>
              <button
                onClick={() => setActiveTab("UNASSIGNED")}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'UNASSIGNED' ? 'bg-orange-50 text-orange-600' : 'text-gray-500 hover:text-gray-700'}`}
              >
                  <UserX size={16}/> –ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ
                  {unassignedUsers.length > 0 && (
                    <span className="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-1">
                        {unassignedUsers.length}
                    </span>
                  )}
              </button>
          </div>
        </div>


        {activeTab === "HIERARCHY" && (
            <div className="space-y-6 animate-fade-in">
                <div className="flex justify-end">
                    <button
                        type="button"
                        onClick={() => { setInputTitle(""); setModalType("CREATE_SECTION"); }}
                        className="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold shadow hover:bg-blue-700 transition"
                    >
                        <Plus size={18} /> –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–æ–∫
                    </button>
                </div>

                {structureStore.sections.map((section) => (
                    <div key={section.id} className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">

                        <div className="p-5 bg-gray-50 flex items-center justify-between gap-4 border-b border-gray-200 group">
                            <div className="flex items-center gap-4 cursor-pointer flex-1" onClick={() => toggleSection(section.id)}>
                                <button className="text-gray-400 hover:text-blue-600 transition">
                                    {expandedSections.includes(section.id) ? <ChevronDown size={20} /> : <ChevronRight size={20} />}
                                </button>
                                <div>
                                    <h2 className="font-semibold text-lg text-gray-800 flex items-center gap-2">{section.title}</h2>
                                    <div className="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                        <Crown size={14} className="text-yellow-600" /> –ù–∞—á–∞–ª—å–Ω–∏–∫:
                                        {section.manager ? (
                                            <span
                                                className="font-bold text-gray-700 underline decoration-dotted cursor-pointer hover:text-blue-600"
                                                onClick={(e) => { e.stopPropagation(); openUserSelect(section.id, "MANAGER"); }}
                                            >
                                                {section.manager.name} {section.manager.surname}
                                            </span>
                                        ) : (
                                            <button
                                                onClick={(e) => { e.stopPropagation(); openUserSelect(section.id, "MANAGER"); }}
                                                className="text-red-500 text-xs font-bold border border-red-200 bg-red-50 px-2 py-0.5 rounded hover:bg-red-100"
                                            >
                                                + –ù–ê–ó–ù–ê–ß–ò–¢–¨
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2 items-center">
                                <span className="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded-full border border-blue-100">–ë—Ä–∏–≥–∞–¥: {section.production_teams?.length || 0}</span>
                                <button onClick={() => openCreateTeam(section.id)} className="p-2 text-gray-500 hover:text-blue-600 bg-white rounded-lg border hover:border-blue-300 transition flex items-center gap-2 text-sm font-medium">
                                    <Plus size={16} /> –ë—Ä–∏–≥–∞–¥–∞
                                </button>
                            </div>
                        </div>


                        {expandedSections.includes(section.id) && (
                            <div className="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white">
                                {section.production_teams?.length > 0 ? (
                                    section.production_teams.map((team) => (
                                        <div key={team.id} className="border rounded-xl p-4 bg-gray-50/60 hover:bg-gray-50 transition shadow-sm">
                                            <div className="flex justify-between items-start mb-3 pb-2 border-b border-dashed border-gray-300">
                                                <div>
                                                    <h3 className="font-bold text-lg text-gray-700 flex items-center gap-2">
                                                        <Users size={18} className="text-blue-500" /> {team.title}
                                                    </h3>
                                                    <div className="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                                        <UserCheck size={12} /> –°—Ç–∞—Ä—à–∏–π:
                                                        {team.teamLead ? (
                                                            <button onClick={() => openUserSelect(team.id, "LEAD")} className="font-medium text-gray-800 cursor-pointer hover:text-blue-600 border-b border-dotted border-gray-400 ml-1">
                                                                {team.teamLead.name} {team.teamLead.surname}
                                                            </button>
                                                        ) : (
                                                            <button onClick={() => openUserSelect(team.id, "LEAD")} className="text-blue-600 font-bold hover:underline ml-1">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="space-y-2 min-h-[50px]">
                                                {team.users?.map((member) => (
                                                    <div key={member.id} className="flex items-center justify-between text-sm text-gray-600 bg-white border border-gray-200 p-2 rounded-lg shadow-sm">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs font-bold text-indigo-600">{member.name[0]}</div>
                                                            <span>{member.name} {member.surname}</span>
                                                        </div>
                                                        <button onClick={() => handleRemoveMember(member.id)} className="p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-50 transition" title="–£–±—Ä–∞—Ç—å –∏–∑ –±—Ä–∏–≥–∞–¥—ã">
                                                            <Trash2 size={14} />
                                                        </button>
                                                    </div>
                                                ))}
                                                <button onClick={() => openUserSelect(team.id, "MEMBER")} className="w-full py-2 text-xs font-bold text-blue-500 border border-dashed border-blue-300 rounded-lg hover:bg-blue-50 transition flex items-center justify-center gap-1">
                                                    <UserPlus size={14} /> –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="col-span-full text-center py-8 text-gray-400 border-2 border-dashed rounded-xl">–í —ç—Ç–æ–º —É—á–∞—Å—Ç–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–∏–≥–∞–¥. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</div>
                                )}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        )}


        {activeTab === "UNASSIGNED" && (
            <div className="animate-fade-in bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="p-6 border-b border-gray-100 bg-orange-50/30">
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <UserX className="text-orange-500"/> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±–µ–∑ –±—Ä–∏–≥–∞–¥—ã
                    </h2>
                    <p className="text-gray-500 text-sm mt-1">
                        –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –Ω–∏ –∫ –æ–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–π –µ–¥–∏–Ω–∏—Ü–µ.
                        –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∏—Ö –ø—Ä—è–º–æ –∑–¥–µ—Å—å.
                    </p>
                </div>

                <div className="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {unassignedUsers.length === 0 && (
                        <div className="col-span-full text-center py-20">
                            <div className="inline-flex p-4 bg-green-50 rounded-full mb-3"><UserCheck size={32} className="text-green-500"/></div>
                            <h3 className="text-lg font-bold text-gray-700">–í—Å–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã!</h3>
                            <p className="text-gray-400">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –±—Ä–∏–≥–∞–¥–µ.</p>
                        </div>
                    )}

                    {unassignedUsers.map(user => (
                        <div key={user.id} className={`p-4 border rounded-xl transition-all ${assigningUserId === user.id ? 'bg-indigo-50 border-indigo-300 ring-2 ring-indigo-100 shadow-md' : 'bg-white border-gray-200 shadow-sm hover:shadow-md'}`}>
                            <div className="flex justify-between items-center mb-3">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold overflow-hidden border border-gray-300">
                                        {user.img ? <img src={`${import.meta.env.VITE_API_URL}/${user.img}`} className="w-full h-full object-cover"/> : user.name[0]}
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">{user.name} {user.surname}</div>
                                        <div className="text-xs text-gray-500">{user.login} ‚Ä¢ {user.role}</div>
                                    </div>
                                </div>

                                {assigningUserId !== user.id && (
                                    <button
                                        onClick={() => { setAssigningUserId(user.id); setSelectedSectionId(""); setSelectedTeamId(""); }}
                                        className="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 text-xs font-bold rounded-lg hover:border-indigo-500 hover:text-indigo-600 transition"
                                    >
                                        –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                    </button>
                                )}
                            </div>


                            {assigningUserId === user.id && (
                                <div className="pt-3 border-t border-indigo-200 flex flex-col gap-2 animate-fade-in">
                                    <div className="space-y-2">
                                        <div>
                                            <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">–£—á–∞—Å—Ç–æ–∫</label>
                                            <select
                                                className="w-full p-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none"
                                                value={selectedSectionId}
                                                onChange={e => { setSelectedSectionId(Number(e.target.value)); setSelectedTeamId(""); }}
                                            >
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                                                {structureStore.sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">–ë—Ä–∏–≥–∞–¥–∞</label>
                                            <select
                                                className="w-full p-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none disabled:bg-gray-100 disabled:text-gray-400"
                                                value={selectedTeamId}
                                                onChange={e => setSelectedTeamId(Number(e.target.value))}
                                                disabled={!selectedSectionId}
                                            >
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                                                {availableTeamsForQuickAssign.map(t => <option key={t.id} value={t.id}>{t.title}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-2 mt-2">
                                        <button onClick={() => setAssigningUserId(null)} className="px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-200 rounded font-medium">–û—Ç–º–µ–Ω–∞</button>
                                        <button
                                            onClick={handleQuickAssign}
                                            disabled={!selectedTeamId}
                                            className="px-4 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-1 shadow-sm transition"
                                        >
                                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å <ArrowRight size={12}/>
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        )}


        <Modal isOpen={modalType === "CREATE_SECTION"} onClose={closeModal}>
          <div className="p-4">
            <h2 className="text-lg font-semibold mb-3">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</h2>
            <input
              className="w-full border rounded px-3 py-2 mb-3 text-sm"
              placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞"
              value={inputTitle}
              onChange={(e) => setInputTitle(e.target.value)}
            />
            <div className="flex justify-end gap-2">
              <button onClick={closeModal} className="px-3 py-1.5 text-sm rounded border border-gray-300 bg-white hover:bg-gray-50">–û—Ç–º–µ–Ω–∞</button>
              <button onClick={handleCreateSection} className="px-3 py-1.5 text-sm rounded bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300" disabled={!inputTitle.trim()}>–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </div>
        </Modal>

        <Modal isOpen={modalType === "CREATE_TEAM"} onClose={closeModal}>
          <div className="p-4">
            <h2 className="text-lg font-semibold mb-3">–ù–æ–≤–∞—è –±—Ä–∏–≥–∞–¥–∞</h2>
            <input
              className="w-full border rounded px-3 py-2 mb-3 text-sm"
              placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–∏–≥–∞–¥—ã"
              value={inputTitle}
              onChange={(e) => setInputTitle(e.target.value)}
            />
            <div className="flex justify-end gap-2">
              <button onClick={closeModal} className="px-3 py-1.5 text-sm rounded border border-gray-300 bg-white hover:bg-gray-50">–û—Ç–º–µ–Ω–∞</button>
              <button onClick={handleCreateTeam} className="px-3 py-1.5 text-sm rounded bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300" disabled={!inputTitle.trim()}>–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </div>
        </Modal>

        <Modal isOpen={modalType === "SELECT_USER"} onClose={closeModal}>
          <div className="p-4 h-[500px] flex flex-col">
            <h2 className="text-lg font-semibold mb-3">
              {actionType === "MANAGER" && "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ —É—á–∞—Å—Ç–∫–∞"}
              {actionType === "LEAD" && "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—à–µ–≥–æ –±—Ä–∏–≥–∞–¥—ã"}
              {actionType === "MEMBER" && "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ –±—Ä–∏–≥–∞–¥—É"}
            </h2>
            <input className="w-full p-2 border rounded mb-2 text-sm" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –ª–æ–≥–∏–Ω—É" value={userSearch} onChange={(e) => setUserSearch(e.target.value)} />
            <div className="overflow-y-auto flex-1 space-y-2 pr-1 custom-scrollbar">
              {filteredUsers.map((user) => (
                <button key={user.id} type="button" onClick={() => handleUserSelect(user.id)} className="w-full flex flex-col items-start px-3 py-2 border border-gray-200 rounded-lg bg-white hover:bg-blue-50 hover:border-blue-300 text-left transition">
                  <span className="font-medium text-gray-700">{user.name} {user.surname}</span>
                  <span className="text-xs text-gray-400">{user.login}</span>
                </button>
              ))}
            </div>
          </div>
        </Modal>

      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Warehouse/WarehousePage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  createSupply,
  fetchSupplies,
  createBox,
  fetchBoxes,
  exportLabelsCsv,
  BoxCreateDto,
  SupplyCreateDto,
} from "src/api/warehouseApi";

import { SupplyModel, InventoryBoxModel } from "src/types/WarehouseModels";
import { fetchStructure } from "src/api/structureApi";

type SectionShort = {
  id: number;
  title: string;
};

export const WarehousePage: React.FC = () => {
  const [supplies, setSupplies] = useState<SupplyModel[]>([]);
  const [selectedSupplyId, setSelectedSupplyId] = useState<number | null>(null);
  const [boxes, setBoxes] = useState<InventoryBoxModel[]>([]);
  const [sections, setSections] = useState<SectionShort[]>([]);


  const [supplier, setSupplier] = useState("");
  const [docNumber, setDocNumber] = useState("");
  const [expectedDate, setExpectedDate] = useState("");
  const [supplyComment, setSupplyComment] = useState("");


  const [sectionId, setSectionId] = useState<number | "">("");
  const [itemName, setItemName] = useState("");
  const [quantity, setQuantity] = useState<number>(1);
  const [unit, setUnit] = useState("—à—Ç");
  const [kitNumber, setKitNumber] = useState("");
  const [boxComment, setBoxComment] = useState("");

  const loadSupplies = async () => {
    const data = await fetchSupplies();
    setSupplies(data);
    if (!selectedSupplyId && data.length > 0) {
      setSelectedSupplyId(data[0].id);
    }
  };

  const loadBoxes = async (supplyId: number) => {
    const data = await fetchBoxes({ supplyId });
    setBoxes(data);
  };

  const loadSections = async () => {
    const structData = await fetchStructure();
    const shorts: SectionShort[] = structData.map((s: any) => ({
      id: s.id,
      title: s.title,
    }));
    setSections(shorts);
  };

  useEffect(() => {
    void loadSupplies();
    void loadSections();
  }, []);

  useEffect(() => {
    if (selectedSupplyId) {
      void loadBoxes(selectedSupplyId);
    } else {
      setBoxes([]);
    }
  }, [selectedSupplyId]);

  const handleCreateSupply = async () => {
    const payload: SupplyCreateDto = {
      supplier: supplier.trim() || undefined,
      docNumber: docNumber.trim() || undefined,
      expectedDate: expectedDate || undefined,
      comment: supplyComment.trim() || undefined,
    };

    const created = await createSupply(payload);
    setSupplier("");
    setDocNumber("");
    setExpectedDate("");
    setSupplyComment("");
    await loadSupplies();
    setSelectedSupplyId(created.id);
  };

  const handleCreateBox = async () => {
    if (!selectedSupplyId) {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é.");
      return;
    }
    if (!sectionId) {
      alert("–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–æ–∫.");
      return;
    }
    if (!itemName.trim()) {
      alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–∑–¥–µ–ª–∏—è / –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–≥–æ.");
      return;
    }

    const payload: BoxCreateDto = {
      supplyId: selectedSupplyId,
      sectionId: Number(sectionId),
      itemName: itemName.trim(),
      quantity: quantity || 1,
      unit: unit.trim() || "—à—Ç",
      kitNumber: kitNumber.trim() || undefined,
      comment: boxComment.trim() || undefined,
    };

    await createBox(payload);
    setItemName("");
    setQuantity(1);
    setUnit("—à—Ç");
    setKitNumber("");
    setBoxComment("");
    await loadBoxes(selectedSupplyId);
  };

  const handleExportCsv = async () => {
    if (!selectedSupplyId) {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤–∫—É.");
      return;
    }
    const blob = await exportLabelsCsv(selectedSupplyId);
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `kryptonit_labels_supply_${selectedSupplyId}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  };

  const currentSupply = supplies.find((s) => s.id === selectedSupplyId);

  return (
    <div className="p-6 bg-gray-100/80 min-h-screen">
      <h1 className="text-2xl font-bold text-gray-800 mb-4">
        –°–∫–ª–∞–¥ –∏ –ø—Ä–∏—ë–º–∫–∞
      </h1>
      <p className="text-gray-600 mb-6">
        –ó–¥–µ—Å—å –ø—Ä–∏–Ω–∏–º–∞–µ–º –∏–∑–¥–µ–ª–∏—è –∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ, —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ –∫–æ—Ä–æ–±–∫–∞–º –∏
        –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç—Ç–∏–∫–µ—Ç–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º ¬´–ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç¬ª.
      </p>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">

        <div className="xl:col-span-1 bg-white rounded-lg shadow p-4">
          <h2 className="text-lg font-semibold mb-3">–ü–æ—Å—Ç–∞–≤–∫–∏</h2>

          <div className="space-y-3 max-h-[420px] overflow-y-auto">
            {supplies.map((s) => (
              <button
                key={s.id}
                onClick={() => setSelectedSupplyId(s.id)}
                className={`w-full text-left border rounded-md p-3 mb-1 transition ${
                  selectedSupplyId === s.id
                    ? "bg-emerald-50 border-emerald-400"
                    : "bg-gray-50 hover:bg-gray-100 border-gray-200"
                }`}
              >
                <div className="text-sm text-gray-500">
                  #{s.id} ‚Ä¢ {new Date(s.createdAt).toLocaleDateString()}
                </div>
                <div className="font-semibold">
                  {s.supplier || "–ë–µ–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"}
                </div>
                <div className="text-sm text-gray-600">
                  –î–æ–∫—É–º–µ–Ω—Ç: {s.docNumber || "‚Äî"}
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  –°—Ç–∞—Ç—É—Å: {s.status}
                </div>
              </button>
            ))}

            {supplies.length === 0 && (
              <div className="text-sm text-gray-500">
                –ü–æ—Å—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é.
              </div>
            )}
          </div>

          <div className="mt-4 border-t pt-4">
            <h3 className="text-md font-semibold mb-2">–ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞</h3>
            <div className="space-y-2">
              <input
                className="w-full border rounded px-2 py-1 text-sm"
                placeholder="–ü–æ—Å—Ç–∞–≤—â–∏–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
                value={supplier}
                onChange={(e) => setSupplier(e.target.value)}
              />
              <input
                className="w-full border rounded px-2 py-1 text-sm"
                placeholder="–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞"
                value={docNumber}
                onChange={(e) => setDocNumber(e.target.value)}
              />
              <input
                type="date"
                className="w-full border rounded px-2 py-1 text-sm"
                value={expectedDate}
                onChange={(e) => setExpectedDate(e.target.value)}
              />
              <textarea
                className="w-full border rounded px-2 py-1 text-sm"
                placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                value={supplyComment}
                onChange={(e) => setSupplyComment(e.target.value)}
                rows={2}
              />
              <button
                onClick={handleCreateSupply}
                className="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold py-2 rounded"
              >
                –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É
              </button>
            </div>
          </div>
        </div>


        <div className="xl:col-span-2 space-y-6">
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="text-lg font-semibold mb-3">
              –ö–æ—Ä–æ–±–∫–∏ –≤ –ø–æ—Å—Ç–∞–≤–∫–µ{" "}
              {currentSupply
                ? `#${currentSupply.id} (${currentSupply.supplier || "‚Äî"})`
                : "‚Äî"}
            </h2>

            <div className="flex flex-col md:flex-row gap-4 mb-4">
              <div className="flex-1 space-y-2">
                <label className="text-sm text-gray-700">
                  –£—á–∞—Å—Ç–æ–∫, –∫—É–¥–∞ –ø–æ–π–¥—ë—Ç –∫–æ—Ä–æ–±–∫–∞
                </label>
                <select
                  className="w-full border rounded px-2 py-1 text-sm"
                  value={sectionId}
                  onChange={(e) =>
                    setSectionId(
                      e.target.value ? Number(e.target.value) : ""
                    )
                  }
                >
                  <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                  {sections.map((s) => (
                    <option key={s.id} value={s.id}>
                      {s.title}
                    </option>
                  ))}
                </select>

                <label className="text-sm text-gray-700">
                  –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–±–µ–∑ ¬´–ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç¬ª)
                </label>
                <input
                  className="w-full border rounded px-2 py-1 text-sm"
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: FC 2.4 –ì–ì—Ü, –ø–∞—Ä—Ç–∏—è 01"
                  value={itemName}
                  onChange={(e) => setItemName(e.target.value)}
                />

                <div className="flex gap-2">
                  <div className="flex-1">
                    <label className="text-sm text-gray-700">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input
                      type="number"
                      min={1}
                      className="w-full border rounded px-2 py-1 text-sm"
                      value={quantity}
                      onChange={(e) =>
                        setQuantity(Number(e.target.value) || 1)
                      }
                    />
                  </div>
                  <div className="w-28">
                    <label className="text-sm text-gray-700">–ï–¥. –∏–∑–º</label>
                    <input
                      className="w-full border rounded px-2 py-1 text-sm"
                      value={unit}
                      onChange={(e) => setUnit(e.target.value)}
                    />
                  </div>
                </div>

                <label className="text-sm text-gray-700">
                  –ù–æ–º–µ—Ä –∫–æ–º–ø–ª–µ–∫—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                </label>
                <input
                  className="w-full border rounded px-2 py-1 text-sm"
                  placeholder="–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –≤–æ–∑—å–º—ë—Ç—Å—è –Ω–æ–º–µ—Ä –∫–æ—Ä–æ–±–∫–∏"
                  value={kitNumber}
                  onChange={(e) => setKitNumber(e.target.value)}
                />

                <label className="text-sm text-gray-700">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea
                  className="w-full border rounded px-2 py-1 text-sm"
                  rows={2}
                  value={boxComment}
                  onChange={(e) => setBoxComment(e.target.value)}
                />
              </div>

              <div className="w-full md:w-52 flex flex-col justify-between">
                <div className="border rounded-lg p-3 bg-gray-50 text-sm text-gray-700 mb-3">
                  <div className="font-semibold mb-1">
                    –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —ç—Ç–∏–∫–µ—Ç–∫–∏
                  </div>
                  <div className="text-xs text-gray-500">–ò–º—è:</div>
                  <div className="font-medium">
                    {sectionId && itemName
                      ? `–ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç ${itemName.trim()}${
                          sections.find((s) => s.id === sectionId)
                            ? ` / ${
                                sections.find((s) => s.id === sectionId)?.title
                              }`
                            : ""
                        }`
                      : "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ —É—á–∞—Å—Ç–æ–∫"}
                  </div>
                  <div className="mt-2 text-xs text-gray-500">
                    –ö–æ–ª-–≤–æ: {quantity} {unit}
                  </div>
                </div>

                <button
                  onClick={handleCreateBox}
                  className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold py-2 rounded"
                >
                  –î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–æ–±–∫—É
                </button>

                <button
                  onClick={handleExportCsv}
                  className="w-full mt-2 border border-emerald-500 text-emerald-700 hover:bg-emerald-50 text-sm font-semibold py-2 rounded"
                >
                  –í—ã–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏ (CSV –¥–ª—è Excel)
                </button>
              </div>
            </div>

            <div className="mt-4">
              <div className="overflow-x-auto max-h-[380px] border rounded-lg">
                <table className="min-w-full text-sm">
                  <thead className="bg-gray-100 sticky top-0">
                    <tr>
                      <th className="px-2 py-1 border-b">–ö–æ—Ä–æ–±–∫–∞</th>
                      <th className="px-2 py-1 border-b">–ò–º—è —ç—Ç–∏–∫–µ—Ç–∫–∏</th>
                      <th className="px-2 py-1 border-b">–£—á–∞—Å—Ç–æ–∫</th>
                      <th className="px-2 py-1 border-b">–ö–æ–ª-–≤–æ</th>
                      <th className="px-2 py-1 border-b">–®—Ç—Ä–∏—Ö/QR –∫–æ–¥</th>
                    </tr>
                  </thead>
                  <tbody>
                    {boxes.map((b) => (
                      <tr key={b.id} className="hover:bg-gray-50">
                        <td className="px-2 py-1 border-b">
                          {b.boxNumber || `#${b.id}`}
                        </td>
                        <td className="px-2 py-1 border-b">{b.displayName}</td>
                        <td className="px-2 py-1 border-b">
                          {b.section?.title || "‚Äî"}
                        </td>
                        <td className="px-2 py-1 border-b">
                          {b.quantity} {b.unit}
                        </td>
                        <td className="px-2 py-1 border-b">{b.labelCode}</td>
                      </tr>
                    ))}

                    {boxes.length === 0 && (
                      <tr>
                        <td
                          colSpan={5}
                          className="px-2 py-3 text-center text-gray-500"
                        >
                          –î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ—Å—Ç–∞–≤–∫–∏ –∫–æ—Ä–æ–±–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
              {boxes.length > 0 && (
                <div className="mt-2 text-xs text-gray-500">
                  –í—Å–µ–≥–æ –∫–æ—Ä–æ–±–æ–∫: {boxes.length}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default WarehousePage;

================================================================================
FILE: QMS-Client-main/src/pages/Analytics/ProductionDashboard.tsx
================================================================================

import React, { useState, useEffect, useMemo } from "react";
import {
  Users, AlertTriangle, CheckCircle,
  TrendingUp, TrendingDown, Calendar, BarChart3, Loader2,
  Package, Factory, Boxes, RefreshCw, Clock, CalendarDays, FolderKanban
} from "lucide-react";
import {
  AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,
  PieChart, Pie, Cell, BarChart, Bar
} from 'recharts';
import { $authHost } from "src/api";
import { fetchProjects } from "src/api/projectsApi";
import dayjs from "dayjs";
import clsx from "clsx";

const COLORS = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#8b5cf6', '#06b6d4'];

type Period = "day" | "week" | "month" | "year" | "all" | "custom";

interface ProjectOption {
  id: number;
  title: string;
  code?: string;
}

interface DashboardData {
  period: string;
  projectId: number | null;
  projectName: string | null;
  startDate: string;
  endDate: string;
  daysInPeriod: number;
  periodOutput: number;
  periodDefects: number;
  defectRate: number;
  todayOutput: number;
  yesterdayOutput: number;
  activeUsers: number;
  activeUsersToday: number;
  stock: { totalItems: number; totalBoxes: number };
  productionByDay: { date: string; name: string; fullDate: string; output: number; isWeekend?: boolean }[];
  defectTypes: { name: string; value: number }[];
  topUsers: { id: number; name: string; output: number }[];
  teamStats: { id: number; name: string; output: number; members: number }[];
  generatedAt: string;
}

const PERIOD_LABELS: Record<Period, string> = {
  day: "–°–µ–≥–æ–¥–Ω—è",
  week: "–ù–µ–¥–µ–ª—è",
  month: "–ú–µ—Å—è—Ü",
  year: "–ì–æ–¥",
  all: "–í—Å—ë –≤—Ä–µ–º—è",
  custom: "–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π"
};

export const ProductionDashboard: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [data, setData] = useState<DashboardData | null>(null);
  const [error, setError] = useState<string | null>(null);


  const [projects, setProjects] = useState<ProjectOption[]>([]);
  const [selectedProjectId, setSelectedProjectId] = useState<string>("");


  const [period, setPeriod] = useState<Period>("week");
  const [customStart, setCustomStart] = useState(dayjs().subtract(7, 'day').format('YYYY-MM-DD'));
  const [customEnd, setCustomEnd] = useState(dayjs().format('YYYY-MM-DD'));
  const [showCustomPicker, setShowCustomPicker] = useState(false);


  useEffect(() => {
    fetchProjects()
      .then(setProjects)
      .catch(e => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:", e));
  }, []);


  const loadDashboard = async (selectedPeriod: Period = period, projectId: string = selectedProjectId) => {
    setLoading(true);
    setError(null);

    try {
      let url = `api/warehouse/analytics/dashboard?period=${selectedPeriod}`;

      if (selectedPeriod === 'custom') {
        url += `&startDate=${customStart}&endDate=${customEnd}`;
      }

      if (projectId) {
        url += `&projectId=${projectId}`;
      }

      console.log("[Dashboard] –ó–∞–≥—Ä—É–∑–∫–∞:", url);
      const response = await $authHost.get(url);
      console.log("[Dashboard] –î–∞–Ω–Ω—ã–µ:", response.data);
      setData(response.data);
    } catch (e: any) {
      console.error("[Dashboard] –û—à–∏–±–∫–∞:", e);
      setError(e.response?.data?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadDashboard(period, selectedProjectId);
  }, [period, selectedProjectId]);


  const handlePeriodChange = (newPeriod: Period) => {
    if (newPeriod === 'custom') {
      setShowCustomPicker(true);
    } else {
      setShowCustomPicker(false);
    }
    setPeriod(newPeriod);
  };


  const handleProjectChange = (projectId: string) => {
    setSelectedProjectId(projectId);
  };


  const applyCustomPeriod = () => {
    loadDashboard('custom', selectedProjectId);
  };


  const outputChange = useMemo(() => {
    if (!data) return { value: 0, isPositive: true };
    const change = data.todayOutput - data.yesterdayOutput;
    const percent = data.yesterdayOutput > 0
      ? Math.round((change / data.yesterdayOutput) * 100)
      : (data.todayOutput > 0 ? 100 : 0);
    return { value: percent, isPositive: percent >= 0 };
  }, [data]);

  const DEFECT_NORM = 2.0;
  const isDefectOverNorm = (data?.defectRate || 0) > DEFECT_NORM;


  const selectedProjectName = useMemo(() => {
    if (!selectedProjectId) return "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã";
    const project = projects.find(p => p.id === Number(selectedProjectId));
    return project?.title || "–ü—Ä–æ–µ–∫—Ç";
  }, [selectedProjectId, projects]);

  if (loading && !data) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="animate-spin text-indigo-600 mx-auto mb-4" size={48} />
          <p className="text-slate-500 font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
      </div>
    );
  }

  if (error && !data) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center">
        <div className="text-center">
          <AlertTriangle className="text-red-500 mx-auto mb-4" size={48} />
          <p className="text-red-600 font-medium mb-4">{error}</p>
          <button
            onClick={() => loadDashboard()}
            className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
          >
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-6 pb-20 font-sans text-gray-700">


      <div className="max-w-7xl mx-auto mb-6">
        <div className="flex items-center justify-between flex-wrap gap-4">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 text-white">
              <BarChart3 size={32}/>
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-slate-900">–î–∞—à–±–æ—Ä–¥ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h1>
              <p className="text-slate-500 font-medium">
                {selectedProjectId ? data?.projectName || selectedProjectName : "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã"}
              </p>
            </div>
          </div>

          <div className="flex items-center gap-4">
            {data?.generatedAt && (
              <div className="flex items-center gap-2 text-sm text-slate-400">
                <Clock size={16} />
                {dayjs(data.generatedAt).format("HH:mm:ss")}
              </div>
            )}
            <button
              onClick={() => loadDashboard()}
              disabled={loading}
              className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-xl text-slate-600 hover:bg-slate-50 transition shadow-sm disabled:opacity-50"
            >
              <RefreshCw size={18} className={loading ? "animate-spin" : ""} />
              –û–±–Ω–æ–≤–∏—Ç—å
            </button>
          </div>
        </div>
      </div>


      <div className="max-w-7xl mx-auto mb-6">
        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">


            <div className="flex items-center gap-3">
              <FolderKanban size={20} className="text-emerald-500" />
              <span className="font-medium text-slate-700">–ü—Ä–æ–µ–∫—Ç:</span>
              <select
                value={selectedProjectId}
                onChange={(e) => handleProjectChange(e.target.value)}
                disabled={loading}
                className="px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-w-[200px]"
              >
                <option value="">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                {projects.map(p => (
                  <option key={p.id} value={p.id}>{p.title}</option>
                ))}
              </select>
            </div>


            <div className="flex items-center gap-2 flex-wrap">
              <CalendarDays size={20} className="text-indigo-500" />
              <span className="font-medium text-slate-700">–ü–µ—Ä–∏–æ–¥:</span>

              <div className="flex bg-slate-100 p-1 rounded-xl">
                {(["day", "week", "month", "year", "all", "custom"] as Period[]).map(p => (
                  <button
                    key={p}
                    onClick={() => handlePeriodChange(p)}
                    disabled={loading}
                    className={clsx(
                      "px-3 py-1.5 rounded-lg text-sm font-medium transition",
                      period === p
                        ? "bg-indigo-600 text-white shadow-md"
                        : "text-slate-600 hover:bg-slate-200",
                      loading && "opacity-50 cursor-not-allowed"
                    )}
                  >
                    {PERIOD_LABELS[p]}
                  </button>
                ))}
              </div>
            </div>
          </div>


          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mt-4 pt-4 border-t border-slate-100">

            {showCustomPicker && (
              <div className="flex items-center gap-3">
                <input
                  type="date"
                  value={customStart}
                  onChange={e => setCustomStart(e.target.value)}
                  className="px-3 py-2 border border-slate-200 rounded-lg text-sm"
                />
                <span className="text-slate-400">‚Äî</span>
                <input
                  type="date"
                  value={customEnd}
                  onChange={e => setCustomEnd(e.target.value)}
                  className="px-3 py-2 border border-slate-200 rounded-lg text-sm"
                />
                <button
                  onClick={applyCustomPeriod}
                  disabled={loading}
                  className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 disabled:opacity-50"
                >
                  –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
              </div>
            )}


            {data && (
              <div className="text-sm text-slate-500 ml-auto">
                {dayjs(data.startDate).format("DD.MM.YYYY")} ‚Äî {dayjs(data.endDate).format("DD.MM.YYYY")}
                <span className="text-slate-400 ml-2">({data.daysInPeriod} –¥–Ω.)</span>
              </div>
            )}
          </div>
        </div>
      </div>


      <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">


        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition-shadow">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-sm font-bold text-slate-400 uppercase">–í—ã–ø—É—Å–∫ ({PERIOD_LABELS[period]})</p>
              <h3 className="text-4xl font-black text-slate-800 mt-2">
                {data?.periodOutput.toLocaleString() || 0}
              </h3>
            </div>
            <div className="p-2 bg-emerald-50 text-emerald-600 rounded-xl">
              <CheckCircle size={24}/>
            </div>
          </div>
          <div className="mt-4 text-xs text-slate-500 font-medium">
            –°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å: <span className="text-slate-800 font-bold">
              {data ? Math.round(data.periodOutput / data.daysInPeriod).toLocaleString() : 0}
            </span>
          </div>
        </div>


        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition-shadow">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-sm font-bold text-slate-400 uppercase">–°–µ–≥–æ–¥–Ω—è</p>
              <h3 className="text-4xl font-black text-slate-800 mt-2">
                {data?.todayOutput.toLocaleString() || 0}
              </h3>
            </div>
            <div className="p-2 bg-blue-50 text-blue-600 rounded-xl">
              <Boxes size={24}/>
            </div>
          </div>
          <div className={`mt-4 flex items-center text-xs font-bold w-max px-2 py-1 rounded-lg ${
            outputChange.isPositive
              ? "text-emerald-600 bg-emerald-50"
              : "text-red-600 bg-red-50"
          }`}>
            {outputChange.isPositive ? <TrendingUp size={14} className="mr-1"/> : <TrendingDown size={14} className="mr-1"/>}
            {outputChange.isPositive ? "+" : ""}{outputChange.value}% –∫ –≤—á–µ—Ä–∞ ({data?.yesterdayOutput || 0})
          </div>
        </div>


        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition-shadow">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-sm font-bold text-slate-400 uppercase">–ë—Ä–∞–∫ ({PERIOD_LABELS[period]})</p>
              <h3 className={`text-4xl font-black mt-2 ${
                isDefectOverNorm ? "text-red-500" : "text-emerald-500"
              }`}>
                {data?.defectRate || 0}%
              </h3>
            </div>
            <div className={`p-2 rounded-xl ${
              isDefectOverNorm ? "bg-red-50 text-red-600" : "bg-emerald-50 text-emerald-600"
            }`}>
              <AlertTriangle size={24}/>
            </div>
          </div>
          <div className={`mt-4 text-xs font-bold w-max px-2 py-1 rounded-lg ${
            isDefectOverNorm ? "text-red-600 bg-red-50" : "text-emerald-600 bg-emerald-50"
          }`}>
            {data?.periodDefects || 0} —à—Ç. {isDefectOverNorm ? `(–≤—ã—à–µ ${DEFECT_NORM}%)` : "‚Äî –≤ –Ω–æ—Ä–º–µ"}
          </div>
        </div>


        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition-shadow">
          <div className="flex justify-between items-start">
            <div>
              <p className="text-sm font-bold text-slate-400 uppercase">–ü–µ—Ä—Å–æ–Ω–∞–ª</p>
              <h3 className="text-4xl font-black text-slate-800 mt-2">
                {data?.activeUsersToday || 0}
                <span className="text-xl text-slate-300">/{data?.activeUsers || 0}</span>
              </h3>
            </div>
            <div className="p-2 bg-purple-50 text-purple-600 rounded-xl">
              <Users size={24}/>
            </div>
          </div>
          <div className="mt-4 text-xs text-slate-500 font-medium flex items-center gap-2">
            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
            –°–µ–≥–æ–¥–Ω—è / –∑–∞ –ø–µ—Ä–∏–æ–¥
          </div>
        </div>
      </div>


      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">


        <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
            <Calendar size={20} className="text-indigo-500"/> –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
            {selectedProjectId && <span className="text-sm font-normal text-slate-400">({selectedProjectName})</span>}
          </h3>
          <div className="h-80 w-full">
            {data?.productionByDay && data.productionByDay.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={data.productionByDay}>
                  <defs>
                    <linearGradient id="colorOutput" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#6366f1" stopOpacity={0.3}/>
                      <stop offset="95%" stopColor="#6366f1" stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9"/>
                  <XAxis
                    dataKey={data.productionByDay.length > 14 ? "fullDate" : "name"}
                    axisLine={false}
                    tickLine={false}
                    tick={(props: any) => {
                      const { x, y, payload } = props;
                      const item = data.productionByDay.find(d =>
                        d.name === payload.value || d.fullDate === payload.value
                      );
                      const isWeekend = item?.isWeekend;
                      return (
                        <text
                          x={x}
                          y={y + 12}
                          textAnchor="middle"
                          fill={isWeekend ? '#f87171' : '#94a3b8'}
                          fontSize={11}
                          fontWeight={isWeekend ? 600 : 400}
                        >
                          {payload.value}
                        </text>
                      );
                    }}
                    interval={data.productionByDay.length > 14 ? Math.floor(data.productionByDay.length / 7) : 0}
                  />
                  <YAxis axisLine={false} tickLine={false} tick={{fill: '#94a3b8'}}/>
                  <Tooltip
                    contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)'}}
                    content={({ active, payload, label }) => {
                      if (!active || !payload?.length) return null;
                      const item = data.productionByDay.find(d =>
                        d.name === label || d.fullDate === label
                      );
                      return (
                        <div className="bg-white p-3 rounded-xl shadow-lg border border-slate-100">
                          <p className="text-sm font-bold text-slate-700">
                            {item?.fullDate} ({item?.name})
                            {item?.isWeekend && <span className="ml-2 text-xs text-red-400">–≤—ã—Ö–æ–¥–Ω–æ–π</span>}
                          </p>
                          <p className="text-lg font-black text-indigo-600">
                            {payload[0].value?.toLocaleString()} –µ–¥.
                          </p>
                        </div>
                      );
                    }}
                  />
                  <Area
                    type="monotone"
                    dataKey="output"
                    stroke="#6366f1"
                    strokeWidth={2}
                    fillOpacity={1}
                    fill="url(#colorOutput)"
                    dot={(props: any) => {
                      const item = data.productionByDay.find(d => d.fullDate === props.payload.fullDate);
                      if (item?.isWeekend && item?.output === 0) {
                        return (
                          <circle
                            cx={props.cx}
                            cy={props.cy}
                            r={3}
                            fill="#f87171"
                            stroke="#fff"
                            strokeWidth={1}
                          />
                        );
                      }
                      return null;
                    }}
                  />
                </AreaChart>
              </ResponsiveContainer>
            ) : (
              <div className="h-full flex items-center justify-center text-slate-400">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥
              </div>
            )}
          </div>
        </div>


        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
            <AlertTriangle size={20} className="text-red-500"/> –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤
          </h3>
          <div className="h-64 w-full relative">
            {data?.defectTypes && data.defectTypes.length > 0 ? (
              <>
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={data.defectTypes}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={80}
                      paddingAngle={5}
                      dataKey="value"
                    >
                      {data.defectTypes.map((_, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none">
                  <span className="text-2xl font-bold text-slate-800">
                    {data.periodDefects}
                  </span>
                  <p className="text-xs text-slate-400">–¥–µ—Ñ–µ–∫—Ç–æ–≤</p>
                </div>
              </>
            ) : (
              <div className="h-full flex items-center justify-center text-emerald-500">
                <CheckCircle size={48} className="mr-2" />
                <span>–ù–µ—Ç –¥–µ—Ñ–µ–∫—Ç–æ–≤</span>
              </div>
            )}
          </div>
          {data?.defectTypes && data.defectTypes.length > 0 && (
            <div className="space-y-2 mt-4">
              {data.defectTypes.map((type, idx) => (
                <div key={idx} className="flex justify-between items-center text-sm">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full" style={{backgroundColor: COLORS[idx % COLORS.length]}}></div>
                    <span className="text-slate-600">{type.name}</span>
                  </div>
                  <span className="font-bold text-slate-800">{type.value}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>


      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">


        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
            <Users size={20} className="text-purple-500"/> –¢–æ–ø-5 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            {selectedProjectId && <span className="text-sm font-normal text-slate-400">({selectedProjectName})</span>}
          </h3>
          <div className="h-64">
            {data?.topUsers && data.topUsers.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={data.topUsers} layout="vertical">
                  <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke="#f1f5f9"/>
                  <XAxis type="number" axisLine={false} tickLine={false} tick={{fill: '#94a3b8'}}/>
                  <YAxis
                    type="category"
                    dataKey="name"
                    axisLine={false}
                    tickLine={false}
                    tick={{fill: '#64748b', fontSize: 12}}
                    width={120}
                  />
                  <Tooltip
                    contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)'}}
                    formatter={(value: number) => [value.toLocaleString(), '–í—ã—Ä–∞–±–æ—Ç–∫–∞']}
                  />
                  <Bar dataKey="output" fill="#8b5cf6" radius={[0, 4, 4, 0]} />
                </BarChart>
              </ResponsiveContainer>
            ) : (
              <div className="h-full flex items-center justify-center text-slate-400">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
              </div>
            )}
          </div>
        </div>


        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
            <Factory size={20} className="text-emerald-500"/> –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –±—Ä–∏–≥–∞–¥
          </h3>
          <div className="space-y-4">
            {data?.teamStats && data.teamStats.length > 0 ? (
              data.teamStats.map((team, idx) => {
                const maxOutput = Math.max(...data.teamStats.map(t => t.output));
                const percent = maxOutput > 0 ? (team.output / maxOutput) * 100 : 0;

                return (
                  <div key={team.id || idx}>
                    <div className="flex justify-between items-center mb-1">
                      <span className="text-sm font-medium text-slate-700">{team.name}</span>
                      <span className="text-sm font-bold text-slate-800">{team.output.toLocaleString()}</span>
                    </div>
                    <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full transition-all duration-500"
                        style={{ width: `${percent}%` }}
                      />
                    </div>
                    <div className="text-xs text-slate-400 mt-1">{team.members} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                  </div>
                );
              })
            ) : (
              <div className="h-40 flex items-center justify-center text-slate-400">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –±—Ä–∏–≥–∞–¥–∞–º
              </div>
            )}
          </div>
        </div>
      </div>


      <div className="max-w-7xl mx-auto mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">


        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <div className="flex justify-between items-center">
            <div>
              <p className="text-sm font-bold text-slate-400 uppercase">–ù–∞ —Å–∫–ª–∞–¥–µ (–æ–±—â–µ–µ)</p>
              <h3 className="text-3xl font-black text-slate-800 mt-2">
                {data?.stock.totalItems.toLocaleString() || 0}
              </h3>
            </div>
            <div className="p-2 bg-amber-50 text-amber-600 rounded-xl">
              <Package size={24}/>
            </div>
          </div>
          <div className="mt-2 text-xs text-slate-500">
            {data?.stock.totalBoxes || 0} –∫–æ—Ä–æ–±–æ–∫
          </div>
        </div>


        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <div className="flex justify-between items-center">
            <div>
              <p className="text-sm font-bold text-slate-400 uppercase">–î–µ—Ñ–µ–∫—Ç–æ–≤ ({PERIOD_LABELS[period]})</p>
              <h3 className={`text-3xl font-black mt-2 ${
                (data?.periodDefects || 0) > 0 ? "text-red-500" : "text-emerald-500"
              }`}>
                {data?.periodDefects.toLocaleString() || 0}
              </h3>
            </div>
            <div className={`p-2 rounded-xl ${
              (data?.periodDefects || 0) > 0 ? "bg-red-50 text-red-600" : "bg-emerald-50 text-emerald-600"
            }`}>
              <AlertTriangle size={24}/>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Assembly/AssemblyRecipePage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchProjects } from "src/api/projectsApi";
import { $authHost } from "src/api";
import { CheckCircle2, Circle, QrCode, Play, Flag } from "lucide-react";
import { Modal } from "src/components/Modal/Modal";
import toast from "react-hot-toast";


interface Step { id: number; order: number; componentName: string; quantity: number; instruction: string; }
interface Recipe { id: number; title: string; steps: Step[]; }
interface Process { id: number; completedSteps: number[]; status: string; }

export const AssemblyRecipePage: React.FC = () => {
    const [projects, setProjects] = useState<any[]>([]);
    const [selectedProjectId, setSelectedProjectId] = useState<string>("");
    const [recipe, setRecipe] = useState<Recipe | null>(null);
    const [process, setProcess] = useState<Process | null>(null);


    const [isStartModalOpen, setStartModalOpen] = useState(false);
    const [qrCode, setQrCode] = useState("");


    useEffect(() => {
        fetchProjects().then(setProjects);
    }, []);


    useEffect(() => {
        if (!selectedProjectId) return;
        $authHost.get(`api/assembly/recipe/project/${selectedProjectId}`)
            .then(res => setRecipe(res.data))
            .catch(() => {
                setRecipe(null);
                toast.error("–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞");
            });
    }, [selectedProjectId]);


    const handleStart = async () => {
        try {
            const { data } = await $authHost.post('api/assembly/recipe/start', {
                qrCode,
                projectId: selectedProjectId
            });
            setProcess(data.process);
            setStartModalOpen(false);
            setQrCode("");
            toast.success("–°–±–æ—Ä–∫–∞ –Ω–∞—á–∞—Ç–∞!");
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞");
        }
    };


    const toggleStep = async (stepId: number) => {
        if (!process) return;
        try {
            const { data } = await $authHost.post('api/assembly/recipe/step', {
                processId: process.id,
                stepId
            });
            setProcess(data);
        } catch (e) {
            console.error(e);
        }
    };


    const handleFinish = async () => {
        if (!process || !recipe) return;


        const allDone = recipe.steps.every(s => process.completedSteps.includes(s.id));
        if (!allDone) {
            if (!window.confirm("–ù–µ –≤—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! –¢–æ—á–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å?")) return;
        }

        try {
            await $authHost.post('api/assembly/recipe/finish', { processId: process.id });
            toast.success("–°–±–æ—Ä–∫–∞ –∏–∑–¥–µ–ª–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
            setProcess(null);
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è");
        }
    };


    return (
        <div className="min-h-screen bg-gray-50 p-6 flex flex-col">


            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 flex justify-between items-center">
                <div className="flex items-center gap-4">
                    <h1 className="text-2xl font-bold text-gray-800">–†—É—á–Ω–∞—è —Å–±–æ—Ä–∫–∞</h1>
                    <select
                        className="p-2 border rounded-lg bg-gray-50"
                        value={selectedProjectId}
                        onChange={e => setSelectedProjectId(e.target.value)}
                        disabled={!!process}
                    >
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
                        {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                    </select>
                </div>

                {!process && (
                    <button
                        disabled={!recipe}
                        onClick={() => setStartModalOpen(true)}
                        className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <QrCode size={20}/> –ù–∞—á–∞—Ç—å —Å–±–æ—Ä–∫—É (–°–∫–∞–Ω ID)
                    </button>
                )}
            </div>


            {recipe && process && (
                <div className="flex flex-1 gap-6 h-full">


                    <div className="w-24 bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col items-center gap-2 overflow-y-auto">
                        <div className="text-xs font-bold text-gray-400 mb-2 uppercase">–°—Ç–∞—Ç—É—Å</div>
                        {recipe.steps.map((step, idx) => {
                            const isDone = process.completedSteps.includes(step.id);
                            return (
                                <div
                                    key={step.id}
                                    className={`w-12 h-12 rounded-lg flex items-center justify-center text-lg font-bold transition-all duration-300 ${
                                        isDone
                                        ? "bg-green-500 text-white shadow-green-200 shadow-md scale-110"
                                        : "bg-red-100 text-red-400 border border-red-200"
                                    }`}
                                >
                                    {idx + 1}
                                </div>
                            );
                        })}
                    </div>


                    <div className="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col">
                        <h2 className="text-xl font-bold text-gray-800 mb-4 pb-4 border-b">{recipe.title}</h2>

                        <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                            {recipe.steps.map((step, idx) => {
                                const isDone = process.completedSteps.includes(step.id);
                                return (
                                    <div
                                        key={step.id}
                                        onClick={() => toggleStep(step.id)}
                                        className={`flex items-center justify-between p-4 rounded-xl border-2 cursor-pointer transition-all ${
                                            isDone
                                            ? "border-green-500 bg-green-50"
                                            : "border-gray-100 hover:border-indigo-200 hover:bg-gray-50"
                                        }`}
                                    >
                                        <div className="flex items-center gap-4">
                                            <div className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-600">
                                                {idx + 1}
                                            </div>
                                            <div>
                                                <div className="font-bold text-lg text-gray-800">
                                                    {step.componentName}
                                                    {step.quantity > 1 && <span className="text-indigo-600 ml-2">x{step.quantity}</span>}
                                                </div>
                                                {step.instruction && <div className="text-sm text-gray-500">{step.instruction}</div>}
                                            </div>
                                        </div>

                                        <button className={`p-3 rounded-full transition-all ${isDone ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400'}`}>
                                            {isDone ? <CheckCircle2 size={24}/> : <Circle size={24}/>}
                                        </button>
                                    </div>
                                );
                            })}
                        </div>


                        <div className="mt-6 pt-4 border-t flex justify-end">
                            <button
                                onClick={handleFinish}
                                className="bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-4 px-12 rounded-xl shadow-lg flex items-center gap-3 transition transform active:scale-95"
                            >
                                <Flag size={24}/> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–±–æ—Ä–∫—É
                            </button>
                        </div>
                    </div>
                </div>
            )}


            <Modal isOpen={isStartModalOpen} onClose={() => setStartModalOpen(false)}>
                <div className="p-6">
                    <h2 className="text-xl font-bold mb-4">–ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ –∏–∑–¥–µ–ª–∏—è</h2>
                    <p className="text-gray-500 mb-4">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –∫–æ—Ä–ø—É—Å–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID</p>
                    <input
                        autoFocus
                        value={qrCode}
                        onChange={e => setQrCode(e.target.value)}
                        onKeyDown={e => e.key === 'Enter' && handleStart()}
                        placeholder="QR –∫–æ–¥..."
                        className="w-full p-4 border-2 border-indigo-200 rounded-xl text-xl mb-4 focus:border-indigo-500 outline-none"
                    />
                    <button onClick={handleStart} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">
                        <Play className="inline mr-2"/> –ü–æ–µ—Ö–∞–ª–∏
                    </button>
                </div>
            </Modal>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Assembly/AssemblyRoutesPage.tsx
================================================================================

import React, { useEffect, useMemo, useState } from "react";
import { observer } from "mobx-react-lite";
import {
  fetchAssemblyRoutes,
  createAssemblyRoute,
  updateAssemblyRoute,
  deleteAssemblyRoute,
} from "src/api/assemblyApi";
import type {
  AssemblyRouteModel,
  SaveAssemblyRouteDto,
} from "src/types/AssemblyModels";
import { fetchStructure } from "src/api/structureApi";
import type { SectionModel, TeamModel } from "src/store/StructureStore";
import {
  Network,
  Plus,
  Trash2,
  Save,
  RefreshCw,
  Settings2,
  Cpu,
  Hammer,
  Search,
  CheckCircle2,
  Package,
  ArrowRight,
  Info,
  Copy,
  BookOpen
} from "lucide-react";

const getOperationStyle = (op: string) => {
  switch (op) {
    case "ASSEMBLY":
      return { icon: <Hammer size={16} />, color: "bg-blue-100 text-blue-700 border-blue-200", label: "–°–±–æ—Ä–∫–∞" };
    case "FIRMWARE":
      return { icon: <Cpu size={16} />, color: "bg-purple-100 text-purple-700 border-purple-200", label: "–ü—Ä–æ—à–∏–≤–∫–∞" };
    case "QUALITY":
      return { icon: <CheckCircle2 size={16} />, color: "bg-green-100 text-green-700 border-green-200", label: "–û–¢–ö" };
    case "PACKING":
      return { icon: <Package size={16} />, color: "bg-orange-100 text-orange-700 border-orange-200", label: "–£–ø–∞–∫–æ–≤–∫–∞" };
    case "CALIBRATION":
    case "FOCUS":
      return { icon: <Settings2 size={16} />, color: "bg-indigo-100 text-indigo-700 border-indigo-200", label: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞" };
    default:
      return { icon: <ArrowRight size={16} />, color: "bg-gray-100 text-gray-700 border-gray-200", label: "–î–µ–π—Å—Ç–≤–∏–µ" };
  }
};

export const AssemblyRoutesPage: React.FC = observer(() => {
  const [routes, setRoutes] = useState<AssemblyRouteModel[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedId, setSelectedId] = useState<number | null>(null);
  const [search, setSearch] = useState("");
  const [showHelp, setShowHelp] = useState(false);

  const [sections, setSections] = useState<SectionModel[]>([]);
  const [structureLoading, setStructureLoading] = useState(false);


  const [title, setTitle] = useState("");
  const [productName, setProductName] = useState("");
  const [description, setDescription] = useState("");
  const [isActive, setIsActive] = useState(true);

  type StepForm = {
    id?: number;
    order: number;
    title: string;
    operation: string;
    sectionId?: number | "";
    teamId?: number | "";
    description?: string;
  };

  const [steps, setSteps] = useState<StepForm[]>([]);

  const allTeams: TeamModel[] = useMemo(
    () => sections.flatMap((s) => s.production_teams || []),
    [sections]
  );

  const loadRoutes = async () => {
    setLoading(true);
    try {
      const data = await fetchAssemblyRoutes({
        search: search.trim() || undefined,
      });
      setRoutes(data);
    } catch (e) {
      console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã —Å–±–æ—Ä–∫–∏", e);
    } finally {
      setLoading(false);
    }
  };

  const loadStructure = async () => {
    setStructureLoading(true);
    try {
      const data = await fetchStructure();
      setSections(data);
    } catch (e) {
      console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Å–±–æ—Ä–∫–∏", e);
    } finally {
      setStructureLoading(false);
    }
  };

  useEffect(() => {
    void loadRoutes();
    void loadStructure();
  }, []);

  const resetForm = () => {
    setSelectedId(null);
    setTitle("");
    setProductName("");
    setDescription("");
    setIsActive(true);
    setSteps([]);
  };

  const handleSelectRoute = (route: AssemblyRouteModel) => {
    setSelectedId(route.id);
    setTitle(route.title);
    setProductName(route.productName || "");
    setDescription(route.description || "");
    setIsActive(route.isActive);

    const sortedSteps = [...(route.steps || [])].sort(
      (a, b) => a.order - b.order
    );

    setSteps(
      sortedSteps.map((s) => ({
        id: s.id,
        order: s.order,
        title: s.title,
        operation: s.operation,
        sectionId: s.sectionId ?? "",
        teamId: s.teamId ?? "",
        description: s.description || "",
      }))
    );
  };

  const handleAddStep = () => {
    const maxOrder = steps.reduce((max, s) => Math.max(max, s.order), 0);
    setSteps((prev) => [
      ...prev,
      {
        order: maxOrder + 1,
        title: `–ù–æ–≤—ã–π —ç—Ç–∞–ø ${maxOrder + 1}`,
        operation: "ASSEMBLY",
        sectionId: "",
        teamId: "",
        description: "",
      },
    ]);
  };


  const applyTemplate = () => {
    if (steps.length > 0 && !window.confirm("–≠—Ç–æ –æ—á–∏—Å—Ç–∏—Ç —Ç–µ–∫—É—â–∏–µ —à–∞–≥–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) return;

    setTitle("–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç: –î—Ä–æ–Ω v1");
    setProductName("Drone-X-2025");
    setDescription("–¢–∏–ø–æ–≤–æ–π –º–∞—Ä—à—Ä—É—Ç —Å–±–æ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–¥–µ–ª–∏—è");
    setSteps([
      { order: 1, title: "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ —Ä–∞–º—ã", operation: "ASSEMBLY", sectionId: "", teamId: "", description: "–°–±–æ—Ä–∫–∞ –ª—É—á–µ–π, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—Ç–æ—Ä–æ–≤" },
      { order: 2, title: "–ú–æ–Ω—Ç–∞–∂ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏", operation: "ASSEMBLY", sectionId: "", teamId: "", description: "–ü–∞–π–∫–∞ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–æ–≤, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ FC" },
      { order: 3, title: "–ü—Ä–æ—à–∏–≤–∫–∞ –ø–æ–ª–µ—Ç–Ω–∏–∫–∞", operation: "FIRMWARE", sectionId: "", teamId: "", description: "–ó–∞–ª–∏–≤–∫–∞ Inav/Betaflight, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç–æ–≤" },
      { order: 4, title: "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å–µ–Ω—Å–æ—Ä–æ–≤", operation: "CALIBRATION", sectionId: "", teamId: "", description: "–ê–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä, –∫–æ–º–ø–∞—Å" },
      { order: 5, title: "–§–∏–Ω–∞–ª—å–Ω—ã–π –û–¢–ö", operation: "QUALITY", sectionId: "", teamId: "", description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–±—Ä–æ—Å—Ç–µ–Ω–¥–æ–º –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Å–º–æ—Ç—Ä" },
      { order: 6, title: "–£–ø–∞–∫–æ–≤–∫–∞ –≤ –∫–µ–π—Å", operation: "PACKING", sectionId: "", teamId: "", description: "–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –ó–ò–ü –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π" },
    ]);
  };

  const handleStepChange = (
    index: number,
    field: keyof StepForm,
    value: any
  ) => {
    setSteps((prev) =>
      prev.map((s, i) => (i === index ? { ...s, [field]: value } : s))
    );
  };

  const handleRemoveStep = (index: number) => {
    setSteps((prev) => prev.filter((_, i) => i !== index));
  };

  const handleSaveRoute = async () => {
    if (!title.trim()) {
      alert("–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞");
      return;
    }

    const payload: SaveAssemblyRouteDto = {
      title: title.trim(),
      productName: productName.trim() || undefined,
      description: description.trim() || undefined,
      isActive,
      steps: steps
        .slice()
        .sort((a, b) => a.order - b.order)
        .map((s, index) => ({
          id: s.id,
          order: index + 1,
          title: s.title.trim() || `–®–∞–≥ ${index + 1}`,
          operation: s.operation.trim() || "MOVE",
          sectionId:
            s.sectionId === "" ? undefined : Number(s.sectionId || undefined),
          teamId: s.teamId === "" ? undefined : Number(s.teamId || undefined),
          description: s.description?.trim() || undefined,
        })),
    };

    try {
      if (selectedId) {
        await updateAssemblyRoute(selectedId, payload);
      } else {
        await createAssemblyRoute(payload);
      }
      await loadRoutes();
      resetForm();
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞", e);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞");
    }
  };

  const handleDeleteRoute = async () => {
    if (!selectedId) return;
    if (!window.confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç?")) return;

    try {
      await deleteAssemblyRoute(selectedId);
      await loadRoutes();
      resetForm();
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞", e);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞");
    }
  };

  return (
    <div className="p-6 bg-gray-50 min-h-screen">

      <div className="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
        <div className="flex items-center gap-3">
          <div className="bg-white p-2 rounded-xl shadow-sm border border-gray-200">
             <Network className="w-8 h-8 text-indigo-600" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">
              –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã
            </h1>
            <p className="text-gray-500 text-sm">
              –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
            </p>
          </div>
        </div>

        <div className="flex gap-3">
           <button
             onClick={() => setShowHelp(!showHelp)}
             className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
           >
             <BookOpen size={18} />
             {showHelp ? "–°–∫—Ä—ã—Ç—å —Å–ø—Ä–∞–≤–∫—É" : "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?"}
           </button>

           <button
              onClick={applyTemplate}
              className="flex items-center gap-2 px-4 py-2 bg-indigo-50 border border-indigo-200 text-indigo-700 rounded-lg hover:bg-indigo-100 transition"
            >
              <Copy size={18} />
              –ü—Ä–∏–º–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∞
            </button>
        </div>
      </div>


      {showHelp && (
        <div className="mb-6 bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-xl border border-indigo-100 shadow-sm animate-fade-in">
           <h3 className="font-semibold text-indigo-900 flex items-center gap-2 mb-2">
             <Info size={18}/> –ó–∞—á–µ–º –Ω—É–∂–Ω—ã –º–∞—Ä—à—Ä—É—Ç—ã?
           </h3>
           <ul className="list-disc list-inside text-sm text-indigo-800 space-y-1 ml-2">
             <li>–ú–∞—Ä—à—Ä—É—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–¥ –∏–∑–¥–µ–ª–∏–µ–º (–æ—Ç —Å–±–æ—Ä–∫–∏ –¥–æ —É–ø–∞–∫–æ–≤–∫–∏).</li>
             <li>–ö–æ–≥–¥–∞ —Å–±–æ—Ä—â–∏–∫ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –∫–æ—Ä–æ–±–∫—É, —Å–∏—Å—Ç–µ–º–∞ —Å–º–æ—Ç—Ä–∏—Ç, –∫–∞–∫–æ–π —à–∞–≥ —Å–ª–µ–¥—É—é—â–∏–π, –∏ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å.</li>
             <li>–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞–∂–¥—ã–π —à–∞–≥ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É <strong>–£—á–∞—Å—Ç–∫—É</strong> (—Ü–µ—Ö—É) –∏–ª–∏ <strong>–ë—Ä–∏–≥–∞–¥–µ</strong>.</li>
             <li><strong>–¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π</strong> (ASSEMBLY, FIRMWARE) –≤–∞–∂–Ω—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—à–∏–≤–∫—É –Ω–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å, –µ—Å–ª–∏ —Å–±–æ—Ä–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞).</li>
           </ul>
        </div>
      )}

      <div className="grid grid-cols-1 xl:grid-cols-12 gap-6">


        <div className="xl:col-span-4 space-y-4">
           <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 h-[calc(100vh-200px)] flex flex-col">
              <div className="flex justify-between items-center mb-4">
                 <h2 className="font-semibold text-gray-700">–í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã</h2>
                 <button onClick={resetForm} className="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1">
                    <Plus size={16}/> –°–æ–∑–¥–∞—Ç—å
                 </button>
              </div>

              <div className="relative mb-4">
                  <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4" />
                  <input
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    placeholder="–ü–æ–∏—Å–∫..."
                    className="w-full pl-9 pr-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  />
              </div>

              <div className="flex-1 overflow-y-auto pr-1 space-y-2 custom-scrollbar">
                {loading ? (
                   <div className="text-center py-10 text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                ) : routes.length === 0 ? (
                   <div className="text-center py-10 text-gray-400 text-sm">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤</div>
                ) : (
                   routes.map((r) => (
                     <div
                       key={r.id}
                       onClick={() => handleSelectRoute(r)}
                       className={`group p-3 rounded-lg border cursor-pointer transition-all hover:shadow-md ${
                         selectedId === r.id
                           ? "bg-indigo-50 border-indigo-500 ring-1 ring-indigo-500"
                           : "bg-white border-gray-200 hover:border-indigo-300"
                       }`}
                     >
                        <div className="flex justify-between items-start">
                           <span className="font-semibold text-gray-800 group-hover:text-indigo-700">{r.title}</span>
                           {r.isActive ? (
                              <span className="w-2 h-2 rounded-full bg-green-500 mt-2" title="–ê–∫—Ç–∏–≤–µ–Ω"></span>
                           ) : (
                              <span className="w-2 h-2 rounded-full bg-gray-300 mt-2" title="–ß–µ—Ä–Ω–æ–≤–∏–∫"></span>
                           )}
                        </div>
                        {r.productName && (
                          <div className="text-xs text-gray-500 mt-1 flex items-center gap-1">
                             <Package size={12}/> {r.productName}
                          </div>
                        )}
                        <div className="text-xs text-gray-400 mt-2">
                           {r.steps?.length || 0} —ç—Ç–∞–ø–æ–≤
                        </div>
                     </div>
                   ))
                )}
              </div>
           </div>
        </div>


        <div className="xl:col-span-8">
           <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">

              <div className="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                 <div>
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                      {selectedId ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞" : "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞"}
                    </h2>
                    <span className="text-xs text-gray-400 uppercase tracking-wider font-semibold">
                      ID: {selectedId || "NEW"}
                    </span>
                 </div>
                 {selectedId && (
                   <button
                     onClick={handleDeleteRoute}
                     className="p-2 text-red-500 bg-red-50 hover:bg-red-100 rounded-lg transition"
                     title="–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"
                   >
                     <Trash2 size={20} />
                   </button>
                 )}
              </div>


              <div className="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                  <div className="md:col-span-2">
                     <label className="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</label>
                     <input
                       value={title}
                       onChange={(e) => setTitle(e.target.value)}
                       className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       placeholder="–ü—Ä–∏–º–µ—Ä: –°–±–æ—Ä–∫–∞ FC v2 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)"
                     />
                  </div>
                  <div>
                     <label className="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∏–∑–¥–µ–ª–∏—é</label>
                     <input
                       value={productName}
                       onChange={(e) => setProductName(e.target.value)}
                       className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: FC-2025-PRO"
                     />
                  </div>
                  <div className="flex items-end">
                     <label className="flex items-center gap-3 cursor-pointer p-2 border border-gray-200 rounded-lg w-full hover:bg-gray-50 transition">
                        <input
                          type="checkbox"
                          checked={isActive}
                          onChange={(e) => setIsActive(e.target.checked)}
                          className="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500"
                        />
                        <span className="text-sm text-gray-700 font-medium">–ú–∞—Ä—à—Ä—É—Ç –∞–∫—Ç–∏–≤–µ–Ω</span>
                     </label>
                  </div>
                  <div className="md:col-span-2">
                     <label className="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                     <textarea
                       value={description}
                       onChange={(e) => setDescription(e.target.value)}
                       rows={2}
                       className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                       placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π..."
                     />
                  </div>
              </div>


              <div className="mb-4 flex justify-between items-center">
                 <h3 className="text-lg font-bold text-gray-800">–≠—Ç–∞–ø—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h3>
                 <button
                    onClick={handleAddStep}
                    className="flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition shadow-sm"
                 >
                    <Plus size={16}/> –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥
                 </button>
              </div>

              <div className="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-200 max-h-[600px] overflow-y-auto custom-scrollbar">
                 {steps.length === 0 && (
                    <div className="text-center py-8 text-gray-400 flex flex-col items-center">
                       <Settings2 size={48} className="opacity-20 mb-2"/>
                       <p>–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —à–∞–≥–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∞–±–ª–æ–Ω.</p>
                    </div>
                 )}

                 {steps
                   .sort((a, b) => a.order - b.order)
                   .map((s, index) => {
                     const style = getOperationStyle(s.operation);
                     return (
                       <div key={index} className="relative pl-8">

                          {index !== steps.length - 1 && (
                             <div className="absolute left-[15px] top-8 bottom-[-16px] w-0.5 bg-gray-300"></div>
                          )}


                          <div className="absolute left-0 top-0 w-8 h-8 rounded-full bg-white border-2 border-indigo-500 text-indigo-700 flex items-center justify-center font-bold text-sm shadow-sm z-10">
                             {index + 1}
                          </div>


                          <div className="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                             <div className="flex flex-wrap gap-3 mb-3">

                                <div className="flex-1 min-w-[140px]">
                                   <label className="text-xs font-semibold text-gray-500 uppercase">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
                                   <div className="relative mt-1">
                                      <div className={`absolute left-2 top-2.5 pointer-events-none ${style.color.split(' ')[1]}`}>
                                         {style.icon}
                                      </div>
                                      <select
                                        value={s.operation}
                                        onChange={(e) => handleStepChange(index, "operation", e.target.value)}
                                        className={`w-full pl-9 pr-2 py-2 border rounded-lg text-sm font-medium appearance-none cursor-pointer focus:ring-2 focus:ring-indigo-500 ${style.color}`}
                                      >
                                         <option value="ASSEMBLY">–°–±–æ—Ä–∫–∞</option>
                                         <option value="FIRMWARE">–ü—Ä–æ—à–∏–≤–∫–∞</option>
                                         <option value="CALIBRATION">–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</option>
                                         <option value="FOCUS">–§–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞</option>
                                         <option value="QUALITY">–û–¢–ö (–ö–æ–Ω—Ç—Ä–æ–ª—å)</option>
                                         <option value="PACKING">–£–ø–∞–∫–æ–≤–∫–∞</option>
                                         <option value="MOVE">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</option>
                                      </select>
                                   </div>
                                </div>

                                <div className="flex-[2] min-w-[200px]">
                                   <label className="text-xs font-semibold text-gray-500 uppercase">–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞</label>
                                   <input
                                     value={s.title}
                                     onChange={(e) => handleStepChange(index, "title", e.target.value)}
                                     className="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                                     placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–Ω—Ç–∞–∂ –ø–ª–∞—Ç—ã"
                                   />
                                </div>

                                <div className="w-auto flex items-end">
                                   <button
                                     onClick={() => handleRemoveStep(index)}
                                     className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"
                                     title="–£–¥–∞–ª–∏—Ç—å —à–∞–≥"
                                   >
                                      <Trash2 size={18}/>
                                   </button>
                                </div>
                             </div>

                             <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                   <label className="text-xs text-gray-500">–£—á–∞—Å—Ç–æ–∫</label>
                                   <select
                                     value={s.sectionId ?? ""}
                                     onChange={(e) => handleStepChange(index, "sectionId", e.target.value)}
                                     className="w-full mt-1 px-2 py-1.5 border border-gray-200 rounded-md text-xs bg-gray-50"
                                   >
                                      <option value="">–õ—é–±–æ–π / –ù–µ –≤–∞–∂–Ω–æ</option>
                                      {sections.map((sec) => (
                                         <option key={sec.id} value={sec.id}>{sec.title}</option>
                                      ))}
                                   </select>
                                </div>
                                <div>
                                   <label className="text-xs text-gray-500">–ë—Ä–∏–≥–∞–¥–∞</label>
                                   <select
                                     value={s.teamId ?? ""}
                                     onChange={(e) => handleStepChange(index, "teamId", e.target.value)}
                                     className="w-full mt-1 px-2 py-1.5 border border-gray-200 rounded-md text-xs bg-gray-50"
                                   >
                                      <option value="">–õ—é–±–∞—è</option>
                                      {allTeams.map((t) => (
                                         <option key={t.id} value={t.id}>{t.title}</option>
                                      ))}
                                   </select>
                                </div>
                                <div className="md:col-span-2">
                                   <input
                                     value={s.description || ""}
                                     onChange={(e) => handleStepChange(index, "description", e.target.value)}
                                     placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
                                     className="w-full px-2 py-1.5 border-b border-gray-200 text-xs focus:border-indigo-500 focus:outline-none text-gray-600 placeholder-gray-400"
                                   />
                                </div>
                             </div>
                          </div>
                       </div>
                     );
                   })}
              </div>


              <div className="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                 <button
                   onClick={handleSaveRoute}
                   className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:from-indigo-700 hover:to-blue-700 transition transform active:scale-95"
                 >
                    <Save size={20}/>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
                 </button>
              </div>
           </div>
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Assembly/AssemblyWorkPage.tsx
================================================================================

import React, { useEffect, useMemo, useState } from "react";
import {
  fetchBoxById,
  fetchBoxByQr,
  moveBox,
  WarehouseBox,
  WarehouseMovement,
} from "src/api/warehouseApi";
import { fetchAssemblyRoutes } from "src/api/assemblyApi";
import type { AssemblyRouteModel } from "src/types/AssemblyModels";
import { fetchStructure } from "src/api/structureApi";
import type { SectionModel, TeamModel } from "src/store/StructureStore";
import {
  Box as BoxIcon,
  Search,
  Loader2,
  History,
  MapPin,
  User,
  Wrench,
  CheckCircle2,
  AlertTriangle,
  ArrowRight,
  PlayCircle,
  PackageCheck
} from "lucide-react";
import toast from "react-hot-toast";

const formatDateTime = (iso?: string | null) => {
  if (!iso) return "-";
  return new Date(iso).toLocaleString("ru-RU", {
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
  });
};

export const AssemblyWorkPage: React.FC = () => {

  const [code, setCode] = useState("");
  const [scanLoading, setScanLoading] = useState(false);

  const [box, setBox] = useState<WarehouseBox | null>(null);
  const [movements, setMovements] = useState<WarehouseMovement[]>([]);
  const [route, setRoute] = useState<AssemblyRouteModel | null>(null);

  const [sections, setSections] = useState<SectionModel[]>([]);
  const allTeams: TeamModel[] = useMemo(
    () => sections.flatMap((s) => s.production_teams || []),
    [sections]
  );

  const [selectedStepOrder, setSelectedStepOrder] = useState<number | "">("");
  const [operation, setOperation] = useState("ASSEMBLY");
  const [toSectionId, setToSectionId] = useState<number | "">("");
  const [toTeamId, setToTeamId] = useState<number | "">("");
  const [statusAfter, setStatusAfter] = useState("IN_WORK");

  const [goodQty, setGoodQty] = useState<number | "">("");
  const [scrapQty, setScrapQty] = useState<number | "">("");
  const [comment, setComment] = useState("");

  const [saveLoading, setSaveLoading] = useState(false);

  useEffect(() => {
    fetchStructure().then(setSections).catch(console.error);
  }, []);

  const autoSelectNextStep = (currentBox: WarehouseBox, history: WarehouseMovement[], currentRoute: AssemblyRouteModel) => {
    if (!currentRoute.steps || currentRoute.steps.length === 0) return;

    const sortedSteps = [...currentRoute.steps].sort((a, b) => a.order - b.order);

    let lastCompletedOrder = 0;

    for (let i = 0; i < sortedSteps.length; i++) {
        const step = sortedSteps[i];
        const isDone = history.some(m => m.operation === step.operation);
        if (isDone) lastCompletedOrder = step.order;
    }


    const nextStep = sortedSteps.find(s => s.order > lastCompletedOrder);

    if (nextStep) {
        setSelectedStepOrder(nextStep.order);
        setOperation(nextStep.operation);
        setToSectionId(nextStep.sectionId ?? "");
        setToTeamId(nextStep.teamId ?? "");
        setGoodQty(currentBox.quantity);
        setScrapQty(0);
        setStatusAfter(nextStep.order === sortedSteps[sortedSteps.length - 1].order ? "DONE" : "IN_WORK");
    } else {
        setSelectedStepOrder("");
        setOperation("MOVE");
        setStatusAfter("ON_STOCK");
        setGoodQty(currentBox.quantity);
    }
  };

  const loadBox = async () => {
    const raw = code.trim();
    if (!raw) return toast.error("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ QR");

    setScanLoading(true);
    setBox(null);
    setMovements([]);
    setRoute(null);

    try {
      let data;
      if (/^\d+$/.test(raw)) {
        data = await fetchBoxById(Number(raw));
      } else {
        data = await fetchBoxByQr(raw);
      }

      setBox(data.box);
      setMovements(data.movements);

      if (data.box.projectName) {
        const routes = await fetchAssemblyRoutes({
          productName: data.box.projectName,
          isActive: true,
        });
        if (routes.length > 0) {
          setRoute(routes[0]);
          autoSelectNextStep(data.box, data.movements, routes[0]);
        } else {
            toast("–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º", { icon: '‚ÑπÔ∏è' });
        }
      }
    } catch (e: any) {
      console.error(e);
      toast.error(e?.response?.data?.message || "–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    } finally {
      setScanLoading(false);
    }
  };

  const handleStepSelect = (order: number | "") => {
    setSelectedStepOrder(order);
    if (!route || order === "") return;
    const step = route.steps?.find((s) => s.order === order);
    if (!step) return;

    setOperation(step.operation || "ASSEMBLY");
    setToSectionId(step.sectionId ?? "");
    setToTeamId(step.teamId ?? "");
  };

  const handleSaveOperation = async () => {
    if (!box) return;


    const gQty = Number(goodQty) || 0;
    const sQty = Number(scrapQty) || 0;

    if (gQty + sQty > box.quantity) {
        return toast.error(`–ù–µ–ª—å–∑—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å (${box.quantity})`);
    }
    if (gQty + sQty === 0 && operation !== "MOVE") {
       if(!window.confirm("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ 0. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) return;
    }

    setSaveLoading(true);
    try {
      await moveBox({
        boxId: box.id,
        operation,
        statusAfter: statusAfter || undefined,
        toSectionId: toSectionId === "" ? undefined : Number(toSectionId),
        toTeamId: toTeamId === "" ? undefined : Number(toTeamId),
        comment: comment.trim() || undefined,
        goodQty: gQty,
        scrapQty: sQty,
      });

      toast.success("–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞");
      loadBox();
    } catch (e: any) {
      toast.error(e?.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    } finally {
      setSaveLoading(false);
    }
  };

  const isStepCompleted = (op: string) => {
      return movements.some(m => m.operation === op);
  };

  return (
    <div className="p-4 sm:p-6 bg-gray-50 min-h-screen">


      <div className="flex items-center gap-3 mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
        <div className="p-2 bg-emerald-100 rounded-lg text-emerald-600">
            <BoxIcon size={24} />
        </div>
        <div>
          <h1 className="text-xl font-bold text-gray-800">–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ —Å–±–æ—Ä–∫–∏</h1>
          <p className="text-gray-500 text-sm">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ —Å–ª–µ–¥—É–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç—É</p>
        </div>
      </div>


      <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
        <div className="flex flex-col sm:flex-row gap-4 items-end">
          <div className="flex-1 w-full">
            <label className="block text-xs font-bold text-gray-700 uppercase mb-1">
              –ù–æ–º–µ—Ä –∫–æ—Ä–æ–±–∫–∏ –∏–ª–∏ QR-–∫–æ–¥
            </label>
            <div className="relative">
              <Search className="w-5 h-5 text-gray-400 absolute left-3 top-3" />
              <input
                value={code}
                onChange={(e) => setCode(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && void loadBox()}
                placeholder="–ö–ª–∏–∫–Ω–∏—Ç–µ —Å—é–¥–∞ –∏ —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ..."
                className="w-full border-2 border-gray-200 rounded-xl pl-10 pr-4 py-2.5 text-lg focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition"
                autoFocus
              />
            </div>
          </div>
          <button
            onClick={loadBox}
            disabled={scanLoading || !code}
            className="w-full sm:w-auto px-6 py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 disabled:opacity-50 transition flex items-center justify-center gap-2 shadow-lg shadow-emerald-100"
          >
            {scanLoading ? <Loader2 className="animate-spin" /> : <Search size={20}/>}
            –ù–∞–π—Ç–∏
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div className="lg:col-span-1 space-y-6">
          <div className={`bg-white rounded-xl shadow-sm border p-5 transition-all ${box ? 'border-emerald-500 ring-1 ring-emerald-500' : 'border-gray-200'}`}>
            <h2 className="text-sm font-bold text-gray-500 uppercase mb-3 flex items-center gap-2">
              <BoxIcon size={16} /> –¢–µ–∫—É—â–∞—è –∫–æ—Ä–æ–±–∫–∞
            </h2>

            {!box ? (
              <div className="text-center py-8 text-gray-400 text-sm">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ–¥.
              </div>
            ) : (
              <div className="space-y-3">
                <div>
                    <div className="text-xs text-gray-400">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                    <div className="font-bold text-gray-800 text-lg leading-tight">{box.label}</div>
                </div>
                <div className="flex justify-between">
                    <div>
                        <div className="text-xs text-gray-400">ID / –ö–æ–¥</div>
                        <div className="font-mono text-sm bg-gray-100 px-2 py-0.5 rounded">{box.id}</div>
                    </div>
                    <div className="text-right">
                        <div className="text-xs text-gray-400">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                        <div className="font-bold text-emerald-600 text-xl">{box.quantity} {box.unit}</div>
                    </div>
                </div>
                <div className="pt-3 border-t border-dashed border-gray-200 text-xs text-gray-600 space-y-1">
                    <div className="flex items-center gap-2"><MapPin size={12}/> {box.currentSection?.title || "–ë–µ–∑ —É—á–∞—Å—Ç–∫–∞"} / {box.currentTeam?.title || "–ë–µ–∑ –±—Ä–∏–≥–∞–¥—ã"}</div>
                    <div className="flex items-center gap-2"><ArrowRight size={12}/> –°—Ç–∞—Ç—É—Å: <span className="font-bold">{box.status}</span></div>
                    {box.projectName && <div className="mt-1 font-medium text-indigo-600">–ü—Ä–æ–µ–∫—Ç: {box.projectName}</div>}
                </div>
              </div>
            )}
          </div>


          {box && (
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h2 className="text-sm font-bold text-gray-500 uppercase mb-3 flex items-center gap-2">
                  <Wrench size={16} /> –ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞
                </h2>

                {!route ? (
                    <div className="p-3 bg-yellow-50 text-yellow-700 text-sm rounded-lg flex items-start gap-2">
                        <AlertTriangle size={16} className="mt-0.5"/>
                        –ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ—Å—Ç—É–ø–µ–Ω —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º.
                    </div>
                ) : (
                    <div className="space-y-2 max-h-[400px] overflow-y-auto pr-1">
                        <div className="text-xs font-bold text-indigo-600 mb-2">{route.title}</div>
                        {(route.steps || []).sort((a,b)=>a.order-b.order).map((s) => {
                            const completed = isStepCompleted(s.operation);
                            const active = selectedStepOrder === s.order;
                            return (
                                <div
                                    key={s.id}
                                    onClick={() => handleStepSelect(s.order)}
                                    className={`
                                        relative p-3 rounded-lg border text-sm cursor-pointer transition-all
                                        ${completed ? 'bg-green-50 border-green-200 text-green-800' : ''}
                                        ${active ? 'ring-2 ring-indigo-500 border-indigo-500 bg-indigo-50' : 'hover:bg-gray-50 border-gray-200'}
                                    `}
                                >
                                    <div className="flex justify-between items-center">
                                        <span className="font-bold flex items-center gap-2">
                                            {completed ? <CheckCircle2 size={16}/> : <span className="w-4 h-4 rounded-full border-2 border-gray-300 text-[9px] flex items-center justify-center">{s.order}</span>}
                                            {s.title}
                                        </span>
                                        {active && <span className="text-[10px] bg-indigo-600 text-white px-1.5 py-0.5 rounded">Current</span>}
                                    </div>
                                    <div className="text-xs opacity-70 mt-1 pl-6">{s.operation}</div>
                                </div>
                            )
                        })}
                    </div>
                )}
              </div>
          )}
        </div>

        <div className="lg:col-span-2 space-y-6">

            <div className={`bg-white rounded-xl shadow-lg border p-6 transition-all ${box ? 'opacity-100 translate-y-0' : 'opacity-50 translate-y-2 pointer-events-none'}`}>
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <PlayCircle className="text-indigo-600"/> –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                    </h2>
                    {route && selectedStepOrder && (
                        <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">
                            –®–∞–≥ #{selectedStepOrder}
                        </span>
                    )}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
                            <select
                                value={operation}
                                onChange={e => setOperation(e.target.value)}
                                className="w-full p-2.5 border rounded-lg bg-gray-50 font-medium"
                            >
                                <option value="ASSEMBLY">–°–±–æ—Ä–∫–∞ (ASSEMBLY)</option>
                                <option value="FIRMWARE">–ü—Ä–æ—à–∏–≤–∫–∞ (FIRMWARE)</option>
                                <option value="QUALITY">–û–¢–ö (QUALITY)</option>
                                <option value="PACKING">–£–ø–∞–∫–æ–≤–∫–∞ (PACKING)</option>
                                <option value="MOVE">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ (MOVE)</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å</label>
                            <select
                                value={statusAfter}
                                onChange={e => setStatusAfter(e.target.value)}
                                className="w-full p-2.5 border rounded-lg bg-white"
                            >
                                <option value="IN_WORK">–í —Ä–∞–±–æ—Ç–µ</option>
                                <option value="DONE">–ì–æ—Ç–æ–≤–æ (–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø)</option>
                                <option value="ON_STOCK">–ù–∞ —Å–∫–ª–∞–¥</option>
                                <option value="SCRAP">–ë—Ä–∞–∫</option>
                            </select>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                             <div>
                                 <label className="block text-[10px] font-bold text-gray-400 uppercase mb-1">–£—á–∞—Å—Ç–æ–∫</label>
                                 <select value={toSectionId} onChange={e => setToSectionId(Number(e.target.value))} className="w-full p-2 border rounded-lg text-sm">
                                     <option value="">(–¢–µ–∫—É—â–∏–π)</option>
                                     {sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                 </select>
                             </div>
                             <div>
                                 <label className="block text-[10px] font-bold text-gray-400 uppercase mb-1">–ë—Ä–∏–≥–∞–¥–∞</label>
                                 <select value={toTeamId} onChange={e => setToTeamId(Number(e.target.value))} className="w-full p-2 border rounded-lg text-sm">
                                     <option value="">(–¢–µ–∫—É—â–∞—è)</option>
                                     {allTeams.map(t => <option key={t.id} value={t.id}>{t.title}</option>)}
                                 </select>
                             </div>
                        </div>
                    </div>

                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                        <div className="flex justify-between items-center">
                             <label className="text-sm font-bold text-gray-700">–†–µ–∑—É–ª—å—Ç–∞—Ç</label>
                             <button
                                onClick={() => { setGoodQty(box?.quantity || 0); setScrapQty(0); }}
                                className="text-xs text-blue-600 hover:underline font-medium"
                             >
                                –í–∑—è—Ç—å –º–∞–∫—Å–∏–º—É–º ({box?.quantity || 0})
                             </button>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-emerald-600 uppercase mb-1">–ì–æ–¥–Ω—ã—Ö</label>
                                <input
                                    type="number" min={0}
                                    value={goodQty} onChange={e => setGoodQty(Number(e.target.value))}
                                    className="w-full p-3 border-2 border-emerald-100 rounded-xl text-xl font-bold text-center focus:border-emerald-500 outline-none"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-red-600 uppercase mb-1">–ë—Ä–∞–∫</label>
                                <input
                                    type="number" min={0}
                                    value={scrapQty} onChange={e => setScrapQty(Number(e.target.value))}
                                    className="w-full p-3 border-2 border-red-100 rounded-xl text-xl font-bold text-center focus:border-red-500 outline-none text-red-600"
                                />
                            </div>
                        </div>

                        <input
                            value={comment} onChange={e => setComment(e.target.value)}
                            placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø—Ä–∏—á–∏–Ω–∞ –±—Ä–∞–∫–∞, —Å–µ—Ä–∏–π–Ω–∏–∫...)"
                            className="w-full p-2 border border-gray-300 rounded-lg text-sm"
                        />
                    </div>
                </div>

                <button
                    onClick={handleSaveOperation}
                    disabled={saveLoading}
                    className="w-full py-4 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-bold rounded-xl shadow-lg transform active:scale-[0.99] transition flex justify-center items-center gap-2 text-lg"
                >
                    {saveLoading ? <Loader2 className="animate-spin"/> : <PackageCheck size={24}/>}
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                </button>
            </div>


            {movements.length > 0 && (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                    <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><History size={18}/> –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                    <div className="space-y-0 relative">

                        <div className="absolute left-3 top-2 bottom-2 w-0.5 bg-gray-200"></div>

                        {movements.map((m) => (
                            <div key={m.id} className="relative pl-8 py-3 group">
                                <div className="absolute left-[9px] top-5 w-2 h-2 rounded-full bg-gray-400 border-2 border-white ring-2 ring-gray-100 group-hover:bg-indigo-500 transition"></div>
                                <div className="flex justify-between items-start bg-gray-50 p-3 rounded-lg border border-gray-100 group-hover:border-indigo-200 transition">
                                    <div>
                                        <div className="font-bold text-gray-800 text-sm">{m.operation}</div>
                                        <div className="text-xs text-gray-500 flex items-center gap-1 mt-1">
                                            <User size={10}/> {m.performedBy?.surname} {m.performedBy?.name}
                                        </div>
                                        {m.comment && <div className="text-xs text-gray-600 italic mt-1 bg-white px-1 rounded border inline-block">"{m.comment}"</div>}
                                    </div>
                                    <div className="text-right">
                                        <div className="text-[10px] font-mono text-gray-400">{formatDateTime(m.performedAt)}</div>
                                        <div className="mt-1">
                                            {m.goodQty ? <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded mr-1">+{m.goodQty} OK</span> : null}
                                            {m.scrapQty ? <span className="text-xs font-bold text-red-600 bg-red-50 px-1.5 py-0.5 rounded">-{m.scrapQty} BAD</span> : null}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/AssemblyRecipes/AssembledProductsPage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchAssembledHistory } from "src/api/assemblyRecipesApi";
import { fetchProjects } from "src/api/projectsApi";
import { ProductPassportModal } from "./components/ProductPassportModal";
import { Search, Database, FileText, Filter, AlertTriangle, CheckCircle2 } from "lucide-react";

export const AssembledProductsPage: React.FC = () => {
    const [history, setHistory] = useState<any[]>([]);
    const [projects, setProjects] = useState<any[]>([]);
    const [loading, setLoading] = useState(false);


    const [selectedProjectId, setSelectedProjectId] = useState<string>("");
    const [search, setSearch] = useState("");
    const [showDefectsOnly, setShowDefectsOnly] = useState(false);


    const [selectedProcessId, setSelectedProcessId] = useState<number | null>(null);

    useEffect(() => {
        fetchProjects().then(setProjects);
    }, []);

    useEffect(() => {
        loadData();
    }, [selectedProjectId]);

    const loadData = async () => {
        setLoading(true);
        try {
            const data = await fetchAssembledHistory({
                projectId: selectedProjectId ? Number(selectedProjectId) : undefined,
                search: search || undefined
            });
            setHistory(data);
        } finally {
            setLoading(false);
        }
    };


    const filteredHistory = showDefectsOnly
        ? history.filter(item => item.hasDefects)
        : history;

    return (
        <div className="min-h-screen bg-gray-50/50 p-6 pb-20">
            <div className="max-w-7xl mx-auto">


                <div className="flex items-center gap-4 mb-6">
                    <div className="p-3 bg-blue-600 rounded-2xl shadow-lg shadow-blue-200 text-white">
                        <Database size={32} />
                    </div>
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">–ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö –°–±–æ—Ä–∫–∏</h1>
                        <p className="text-gray-500 font-medium">–†–µ–µ—Å—Ç—Ä –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –∏ –ø–∞—Å–ø–æ—Ä—Ç–∞ –∏–∑–¥–µ–ª–∏–π</p>
                    </div>
                </div>


                <div className="flex gap-2 mb-4 border-b border-gray-200 pb-1">
                    <button
                        onClick={() => setShowDefectsOnly(false)}
                        className={`px-4 py-2 rounded-t-lg text-sm font-bold transition-all relative top-[1px] flex items-center gap-2 ${!showDefectsOnly ? 'bg-white text-blue-600 border border-gray-200 border-b-white z-10' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                        <CheckCircle2 size={16}/> –í—Å–µ –∏–∑–¥–µ–ª–∏—è
                    </button>
                    <button
                        onClick={() => setShowDefectsOnly(true)}
                        className={`px-4 py-2 rounded-t-lg text-sm font-bold transition-all relative top-[1px] flex items-center gap-2 ${showDefectsOnly ? 'bg-white text-red-600 border border-gray-200 border-b-white z-10' : 'text-gray-500 hover:text-red-500'}`}
                    >
                        <AlertTriangle size={16}/> –° –ø—Ä–æ–ø—É—Å–∫–∞–º–∏ (–ë—Ä–∞–∫)
                        {history.filter(h => h.hasDefects).length > 0 && (
                            <span className="bg-red-100 text-red-600 text-xs px-1.5 rounded-full">
                                {history.filter(h => h.hasDefects).length}
                            </span>
                        )}
                    </button>
                </div>


                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 flex flex-wrap gap-4 items-center">
                    <div className="flex items-center gap-2 flex-1 min-w-[200px]">
                        <Search className="text-gray-400" size={20}/>
                        <input
                            className="w-full p-2 border-b-2 border-gray-100 focus:border-blue-500 outline-none transition text-sm"
                            placeholder="–ü–æ–∏—Å–∫ –ø–æ ID / QR..."
                            value={search}
                            onChange={e => setSearch(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && loadData()}
                        />
                    </div>

                    <div className="flex items-center gap-2">
                        <Filter className="text-gray-400" size={20}/>
                        <select
                            className="p-2 border rounded-lg bg-gray-50 text-sm font-medium outline-none focus:ring-2 focus:ring-blue-100"
                            value={selectedProjectId}
                            onChange={e => setSelectedProjectId(e.target.value)}
                        >
                            <option value="">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                            {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                        </select>
                    </div>

                    <button onClick={loadData} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition text-sm">
                        –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>


                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table className="w-full text-left border-collapse">
                        <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                            <tr>
                                <th className="p-4">–°—Ç–∞—Ç—É—Å</th>
                                <th className="p-4">ID –ò–∑–¥–µ–ª–∏—è (QR)</th>
                                <th className="p-4">–ü—Ä–æ–µ–∫—Ç</th>
                                <th className="p-4">–°–±–æ—Ä—â–∏–∫</th>
                                <th className="p-4">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</th>
                                <th className="p-4 text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {loading ? (
                                <tr><td colSpan={6} className="p-10 text-center text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                            ) : filteredHistory.length === 0 ? (
                                <tr><td colSpan={6} className="p-10 text-center text-gray-400">–ò–∑–¥–µ–ª–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>
                            ) : (
                                filteredHistory.map(item => (
                                    <tr key={item.id} className={`hover:bg-blue-50/30 transition ${item.hasDefects ? 'bg-red-50/30' : ''}`}>
                                        <td className="p-4">
                                            {item.hasDefects
                                                ? <span className="inline-flex items-center gap-1 px-2 py-1 rounded text-[10px] font-bold bg-red-100 text-red-600 uppercase"><AlertTriangle size={12}/> –ü—Ä–æ–ø—É—Å–∫–∏</span>
                                                : <span className="inline-flex items-center gap-1 px-2 py-1 rounded text-[10px] font-bold bg-green-100 text-green-600 uppercase"><CheckCircle2 size={12}/> OK</span>
                                            }
                                        </td>
                                        <td className="p-4 font-mono font-bold text-indigo-600">{item.qrCode}</td>
                                        <td className="p-4 font-medium text-gray-800">{item.projectTitle}</td>
                                        <td className="p-4 text-sm text-gray-600">{item.assembler}</td>
                                        <td className="p-4 text-sm text-gray-500">
                                            {new Date(item.endTime).toLocaleString("ru-RU")}
                                        </td>
                                        <td className="p-4 text-right">
                                            <button
                                                onClick={() => setSelectedProcessId(item.id)}
                                                className="inline-flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-sm font-bold text-gray-700 hover:bg-gray-50 hover:border-blue-300 hover:text-blue-600 transition shadow-sm"
                                            >
                                                <FileText size={16}/> –ü–∞—Å–ø–æ—Ä—Ç
                                            </button>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>


            <ProductPassportModal
                processId={selectedProcessId}
                onClose={() => {
                    setSelectedProcessId(null);

                    if (showDefectsOnly) loadData();
                }}
            />
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/AssemblyRecipes/RecipeConstructorPage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { createOrUpdateRecipe, fetchRecipeByProject, RecipeStep } from "src/api/assemblyRecipesApi";
import {
    Save, Plus, Trash2, Layers,
    ArrowUp, ArrowDown, CopyPlus,
    Settings, FileText
} from "lucide-react";
import toast from "react-hot-toast";

export const RecipeConstructorPage: React.FC = () => {
    const [projects, setProjects] = useState<ProjectModel[]>([]);
    const [selectedProjectId, setSelectedProjectId] = useState<string>("");

    const [recipeTitle, setRecipeTitle] = useState("");
    const [steps, setSteps] = useState<RecipeStep[]>([
        { order: 1, title: "", quantity: 1, description: "" }
    ]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        fetchProjects().then(setProjects);
    }, []);

    useEffect(() => {
        if (!selectedProjectId) return;
        const loadExisting = async () => {
            try {
                const recipe = await fetchRecipeByProject(Number(selectedProjectId));
                if (recipe) {
                    setRecipeTitle(recipe.title);
                    setSteps(recipe.steps.sort((a, b) => a.order - b.order));
                    toast.success("–†–µ—Ü–µ–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω");
                } else {
                    const proj = projects.find(p => p.id === Number(selectedProjectId));
                    setRecipeTitle(proj ? `–°–±–æ—Ä–∫–∞: ${proj.title}` : "");
                    setSteps([{ order: 1, title: "", quantity: 1 }]);
                }
            } catch (e) { console.error(e); }
        };
        loadExisting();
    }, [selectedProjectId, projects]);


    const handleAddStepToEnd = () => {
        setSteps([...steps, {
            order: steps.length + 1,
            title: "",
            quantity: 1,
            description: ""
        }]);
    };


    const handleInsertStepAfter = (index: number) => {
        const newSteps = [...steps];
        const newStep: RecipeStep = { order: 0, title: "", quantity: 1, description: "" };

        newSteps.splice(index + 1, 0, newStep);

        updateOrders(newSteps);
    };


    const handleRemoveStep = (index: number) => {
        if (steps.length === 1) return toast.error("–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–≥");
        const newSteps = steps.filter((_, i) => i !== index);
        updateOrders(newSteps);
    };


    const handleMoveStep = (index: number, direction: 'up' | 'down') => {
        const newSteps = [...steps];

        if (direction === 'up') {
            if (index === 0) return;
            [newSteps[index], newSteps[index - 1]] = [newSteps[index - 1], newSteps[index]];
        } else {
            if (index === newSteps.length - 1) return;
            [newSteps[index], newSteps[index + 1]] = [newSteps[index + 1], newSteps[index]];
        }

        updateOrders(newSteps);
    };


    const updateOrders = (newSteps: RecipeStep[]) => {
        const ordered = newSteps.map((s, i) => ({ ...s, order: i + 1 }));
        setSteps(ordered);
    };

    const handleChangeStep = (index: number, field: keyof RecipeStep, value: any) => {
        const newSteps = [...steps];
        newSteps[index] = { ...newSteps[index], [field]: value };
        setSteps(newSteps);
    };

    const handleSave = async () => {
        if (!selectedProjectId) return toast.error("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç");
        if (!recipeTitle) return toast.error("–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞");
        if (steps.some(s => !s.title.trim())) return toast.error("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤");

        setLoading(true);
        try {
            await createOrUpdateRecipe(Number(selectedProjectId), recipeTitle, steps);
            toast.success("–†–µ—Ü–µ–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
        } catch (e: any) {
            console.error(e);
            const errorText = e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è";
            toast.error(errorText);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-gray-50/50 p-8 pb-20">
            <div className="max-w-6xl mx-auto">


                <div className="flex items-center gap-4 mb-8">
                    <div className="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 text-white">
                        <Settings size={32} />
                    </div>
                    <div>
                        <h1 className="text-3xl font-bold text-gray-800">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¢–µ—Ö–∫–∞—Ä—Ç</h1>
                        <p className="text-gray-500 font-medium">–°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–æ–≤ —Å–±–æ—Ä–∫–∏</p>
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">


                    <div className="lg:col-span-4 space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 sticky top-6">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <Layers size={18} className="text-indigo-500"/> –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                            </h3>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ü—Ä–æ–µ–∫—Ç</label>
                                    <select
                                        className="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition cursor-pointer"
                                        value={selectedProjectId}
                                        onChange={e => setSelectedProjectId(e.target.value)}
                                    >
                                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
                                        {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞</label>
                                    <input
                                        className="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="–ù–∞–ø—Ä. –°–±–æ—Ä–∫–∞ –∫–æ—Ä–ø—É—Å–∞ v2.0"
                                        value={recipeTitle}
                                        onChange={e => setRecipeTitle(e.target.value)}
                                    />
                                </div>

                                <div className="pt-4 border-t border-gray-100">
                                    <button
                                        onClick={handleSave}
                                        disabled={loading}
                                        className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition flex justify-center items-center gap-2 disabled:opacity-50"
                                    >
                                        <Save size={18}/> {loading ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div className="lg:col-span-8 space-y-6">
                        {steps.map((step, index) => (
                            <div key={index} className="relative">

                                <div className="group bg-white p-5 rounded-2xl shadow-sm border border-gray-200 hover:border-indigo-300 hover:shadow-md transition-all">


                                    <div className="flex justify-between items-start mb-4">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 bg-indigo-100 text-indigo-700 rounded-lg flex items-center justify-center font-bold text-sm">
                                                {index + 1}
                                            </div>
                                            <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">–®–∞–≥ —Å–±–æ—Ä–∫–∏</span>
                                        </div>


                                        <div className="flex bg-gray-50 rounded-lg p-1 border border-gray-100 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                            <button
                                                onClick={() => handleMoveStep(index, 'up')}
                                                disabled={index === 0}
                                                className="p-1.5 text-gray-500 hover:text-indigo-600 hover:bg-white rounded-md disabled:opacity-30 transition"
                                                title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö"
                                            >
                                                <ArrowUp size={16}/>
                                            </button>
                                            <button
                                                onClick={() => handleMoveStep(index, 'down')}
                                                disabled={index === steps.length - 1}
                                                className="p-1.5 text-gray-500 hover:text-indigo-600 hover:bg-white rounded-md disabled:opacity-30 transition"
                                                title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑"
                                            >
                                                <ArrowDown size={16}/>
                                            </button>
                                            <div className="w-px bg-gray-300 mx-1 my-1"></div>
                                            <button
                                                onClick={() => handleRemoveStep(index)}
                                                className="p-1.5 text-gray-500 hover:text-red-600 hover:bg-white rounded-md transition"
                                                title="–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–≥"
                                            >
                                                <Trash2 size={16}/>
                                            </button>
                                        </div>
                                    </div>


                                    <div className="flex gap-4 mb-3">
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">–î–µ–π—Å—Ç–≤–∏–µ / –ö–æ–º–ø–æ–Ω–µ–Ω—Ç</label>
                                            <input
                                                className="w-full p-2.5 border border-gray-200 rounded-lg focus:border-indigo-500 outline-none font-medium text-gray-800 focus:ring-2 focus:ring-indigo-100 transition"
                                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞—Ç—É FC"
                                                value={step.title}
                                                onChange={e => handleChangeStep(index, "title", e.target.value)}
                                            />
                                        </div>
                                        <div className="w-24">
                                            <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">–ö–æ–ª-–≤–æ</label>
                                            <input
                                                type="number" min="1"
                                                className="w-full p-2.5 border border-gray-200 rounded-lg focus:border-indigo-500 outline-none text-center font-bold text-gray-800"
                                                value={step.quantity}
                                                onChange={e => handleChangeStep(index, "quantity", Number(e.target.value))}
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–î–µ—Ç–∞–ª–∏)</label>
                                        <textarea
                                            className="w-full p-2.5 bg-gray-50 rounded-lg text-sm border border-transparent focus:bg-white focus:border-indigo-300 focus:ring-2 focus:ring-indigo-100 outline-none resize-none h-16 transition"
                                            placeholder="–£—Ç–æ—á–Ω–µ–Ω–∏—è: –∫–∞–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π —Å—Ç–∞–≤–∏—Ç—å, –º–æ–º–µ–Ω—Ç –∑–∞—Ç—è–∂–∫–∏..."
                                            value={step.description}
                                            onChange={e => handleChangeStep(index, "description", e.target.value)}
                                        />
                                    </div>
                                </div>


                                <div className="h-8 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity group/insert">
                                    <div className="w-full h-px bg-indigo-100 group-hover/insert:bg-indigo-300 transition-colors"></div>
                                    <button
                                        onClick={() => handleInsertStepAfter(index)}
                                        className="absolute bg-white border border-indigo-200 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm hover:bg-indigo-50 hover:border-indigo-400 transition transform hover:scale-105 flex items-center gap-1"
                                    >
                                        <CopyPlus size={14}/> –í—Å—Ç–∞–≤–∏—Ç—å —à–∞–≥ —Å—é–¥–∞
                                    </button>
                                </div>
                            </div>
                        ))}

                        <button
                            onClick={handleAddStepToEnd}
                            className="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-500 font-bold hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 transition flex justify-center items-center gap-2"
                        >
                            <Plus size={20}/> –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥ –≤ –∫–æ–Ω–µ—Ü
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/AssemblyRecipes/RecipeExecutionPage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { startAssemblyProcess, updateProcessStep, finishAssemblyProcess, AssemblyRecipe, AssemblyProcess } from "src/api/assemblyRecipesApi";
import {
    QrCode, CheckCircle2, Circle, Flag,
    Box, MonitorPlay
} from "lucide-react";
import { Modal } from "src/components/Modal/Modal";
import toast from "react-hot-toast";

export const RecipeExecutionPage: React.FC = () => {

    const [projects, setProjects] = useState<ProjectModel[]>([]);
    const [selectedProjectId, setSelectedProjectId] = useState<string>("");


    const [recipe, setRecipe] = useState<AssemblyRecipe | null>(null);
    const [process, setProcess] = useState<AssemblyProcess | null>(null);
    const [loading, setLoading] = useState(false);


    const [isScanOpen, setScanOpen] = useState(false);
    const [qrCode, setQrCode] = useState("");

    useEffect(() => {
        fetchProjects().then(setProjects);
    }, []);


    const handleStartSession = async () => {
        if (!selectedProjectId) return toast.error("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç");
        if (!qrCode.trim()) return toast.error("–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR");

        setLoading(true);
        try {
            const res = await startAssemblyProcess(qrCode, Number(selectedProjectId));
            setRecipe(res.recipe);
            setProcess(res.process);
            setScanOpen(false);
            toast.success("–°–±–æ—Ä–∫–∞ –Ω–∞—á–∞—Ç–∞");
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞");
        } finally {
            setLoading(false);
        }
    };


    const handleStepToggle = async (index: number) => {
        if (!process) return;


        const isCompleted = process.completedSteps.includes(index);

        try {
            const updatedProcess = await updateProcessStep(process.id, index, !isCompleted);
            setProcess(updatedProcess);
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —à–∞–≥–∞");
        }
    };


    const handleFinish = async () => {
        if (!process || !recipe) return;

        const allDone = recipe.steps.length === process.completedSteps.length;
        if (!allDone) {
            if(!window.confirm("–í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ –≤—Å–µ —à–∞–≥–∏ –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ. –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?")) return;
        }

        try {
            await finishAssemblyProcess(process.id);
            toast.success("–ò–∑–¥–µ–ª–∏–µ —Å–æ–±—Ä–∞–Ω–æ!");

            setProcess(null);
            setRecipe(null);
            setQrCode("");
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è");
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 flex flex-col">

            <div className="bg-white shadow-sm border-b px-6 py-4 flex justify-between items-center">
                <div className="flex items-center gap-3">
                    <div className="bg-emerald-100 p-2 rounded-lg text-emerald-700">
                        <MonitorPlay size={24} />
                    </div>
                    <div>
                        <h1 className="text-xl font-bold text-gray-800">–¢–µ—Ä–º–∏–Ω–∞–ª –°–±–æ—Ä–∫–∏</h1>
                        <p className="text-xs text-gray-500">–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</p>
                    </div>
                </div>

                {!process && (
                    <div className="flex gap-3">
                        <select
                            className="p-2.5 border rounded-xl bg-gray-50 text-sm font-medium w-64"
                            value={selectedProjectId}
                            onChange={e => setSelectedProjectId(e.target.value)}
                        >
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
                            {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                        </select>
                        <button
                            onClick={() => setScanOpen(true)}
                            disabled={!selectedProjectId}
                            className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-xl font-bold shadow-lg transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <QrCode size={18}/> –ù–∞—á–∞—Ç—å —Å–±–æ—Ä–∫—É
                        </button>
                    </div>
                )}

                {process && (
                    <button onClick={() => { if(confirm("–í—ã–π—Ç–∏ –±–µ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è?")) { setProcess(null); setRecipe(null); } }} className="text-red-500 text-sm font-bold hover:underline">
                        –û—Ç–º–µ–Ω–∞ / –í—ã—Ö–æ–¥
                    </button>
                )}
            </div>


            {!process ? (
                <div className="flex-1 flex flex-col items-center justify-center text-gray-400 p-10">
                    <Box size={64} className="mb-4 opacity-20"/>
                    <h2 className="text-xl font-semibold">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</h2>
                    <p className="text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ—Ä–ø—É—Å –∏–∑–¥–µ–ª–∏—è</p>
                </div>
            ) : (
                <div className="flex-1 p-6 grid grid-cols-12 gap-6 h-[calc(100vh-80px)]">


                    <div className="col-span-3 bg-white rounded-2xl shadow-sm border border-gray-200 p-4 flex flex-col overflow-y-auto">
                        <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">–ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
                        <div className="space-y-3">
                            {recipe?.steps.map((step, idx) => {
                                const isDone = process.completedSteps.includes(idx);
                                return (
                                    <div key={idx} className={`flex items-center gap-3 p-3 rounded-xl transition-all ${isDone ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-transparent opacity-60'}`}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${isDone ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                            {idx + 1}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className={`text-sm font-bold truncate ${isDone ? 'text-green-800' : 'text-gray-700'}`}>{step.title}</div>
                                        </div>
                                        {isDone && <CheckCircle2 size={16} className="text-green-500"/>}
                                    </div>
                                )
                            })}
                        </div>
                    </div>


                    <div className="col-span-9 flex flex-col gap-4 h-full">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">{recipe?.title}</h2>
                                <p className="text-indigo-600 font-mono text-sm mt-1">ID –ò–∑–¥–µ–ª–∏—è: {qrCode || "..."}</p>
                            </div>
                            <div className="text-right">
                                <div className="text-3xl font-black text-gray-900">
                                    {process.completedSteps.length} <span className="text-gray-400 text-xl font-medium">/ {recipe?.steps.length}</span>
                                </div>
                                <div className="text-xs text-gray-500 uppercase font-bold">–í—ã–ø–æ–ª–Ω–µ–Ω–æ —à–∞–≥–æ–≤</div>
                            </div>
                        </div>

                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-gray-200 p-6 overflow-y-auto custom-scrollbar">
                            <div className="space-y-4">
                                {recipe?.steps.map((step, idx) => {
                                    const isDone = process.completedSteps.includes(idx);
                                    return (
                                        <div
                                            key={idx}
                                            onClick={() => handleStepToggle(idx)}
                                            className={`
                                                relative cursor-pointer border-2 rounded-2xl p-5 transition-all duration-200 flex justify-between items-center group
                                                ${isDone ? 'border-green-500 bg-green-50/50 shadow-sm' : 'border-gray-100 hover:border-indigo-400 hover:shadow-md bg-white'}
                                            `}
                                        >
                                            <div className="flex items-start gap-5">
                                                <div className={`mt-1 w-12 h-12 rounded-2xl flex items-center justify-center text-xl font-bold transition-colors ${isDone ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-500 group-hover:bg-indigo-100 group-hover:text-indigo-600'}`}>
                                                    {idx + 1}
                                                </div>
                                                <div>
                                                    <h3 className={`text-lg font-bold ${isDone ? 'text-green-800' : 'text-gray-800'}`}>
                                                        {step.title}
                                                        {step.quantity > 1 && <span className="ml-2 text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded text-sm">x{step.quantity}</span>}
                                                    </h3>
                                                    {step.description && <p className="text-gray-500 mt-1">{step.description}</p>}
                                                </div>
                                            </div>

                                            <div className="pr-4">
                                                {isDone
                                                    ? <CheckCircle2 size={32} className="text-green-500 fill-green-100"/>
                                                    : <Circle size={32} className="text-gray-300 group-hover:text-indigo-400"/>
                                                }
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>


                        <div className="flex justify-end pt-2">
                            <button
                                onClick={handleFinish}
                                className="bg-gradient-to-r from-emerald-500 to-green-600 text-white px-10 py-4 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl hover:scale-[1.01] transition flex items-center gap-3"
                            >
                                <Flag size={24}/> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–±–æ—Ä–∫—É
                            </button>
                        </div>
                    </div>
                </div>
            )}


            <Modal isOpen={isScanOpen} onClose={() => setScanOpen(false)}>
                <div className="p-8 text-center">
                    <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <QrCode size={32}/>
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                    <p className="text-gray-500 mb-6">–ù–∞–≤–µ–¥–∏—Ç–µ —Å–∫–∞–Ω–µ—Ä –Ω–∞ QR –∫–æ–¥ –∫–æ—Ä–ø—É—Å–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID</p>

                    <input
                        autoFocus
                        value={qrCode}
                        onChange={e => setQrCode(e.target.value)}
                        onKeyDown={e => e.key === 'Enter' && handleStartSession()}
                        className="w-full text-center text-2xl font-mono p-4 border-2 border-indigo-100 rounded-xl focus:border-indigo-600 outline-none mb-6"
                        placeholder="SCAN HERE"
                    />

                    <button
                        onClick={handleStartSession}
                        disabled={loading}
                        className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700 transition"
                    >
                        {loading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"}
                    </button>
                </div>
            </Modal>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/AssemblyRecipes/components/ProductPassportModal.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchAssemblyPassport, updateAssemblyPassport } from "src/api/assemblyRecipesApi";
import { CheckCircle2, XCircle, User, Calendar, Box, Activity, X, MapPin, Edit, Save } from "lucide-react";
import { Modal } from "src/components/Modal/Modal";
import toast from "react-hot-toast";

interface Props {
    processId: number | null;
    onClose: () => void;
}

export const ProductPassportModal: React.FC<Props> = ({ processId, onClose }) => {
    const [data, setData] = useState<any>(null);
    const [loading, setLoading] = useState(false);


    const [isEditing, setIsEditing] = useState(false);
    const [editedSteps, setEditedSteps] = useState<number[]>([]);

    useEffect(() => {
        if (processId) {
            setLoading(true);
            fetchAssemblyPassport(processId)
                .then(res => {
                    setData(res);
                    setEditedSteps(res.process.completedSteps || []);
                })
                .catch(console.error)
                .finally(() => setLoading(false));
        } else {
            setData(null);
            setIsEditing(false);
        }
    }, [processId]);

    const handleSave = async () => {
        if(!data) return;
        try {
            await updateAssemblyPassport(data.process.id, editedSteps);
            toast.success("–ü–∞—Å–ø–æ—Ä—Ç –æ–±–Ω–æ–≤–ª–µ–Ω");
            setIsEditing(false);

            setData({ ...data, process: { ...data.process, completedSteps: editedSteps } });
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
    };

    const toggleStep = (index: number) => {
        if (editedSteps.includes(index)) {
            setEditedSteps(editedSteps.filter(i => i !== index));
        } else {
            setEditedSteps([...editedSteps, index]);
        }
    };

    if (!processId) return null;

    return (
        <Modal isOpen={!!processId} onClose={onClose}>

            <div className="bg-white rounded-2xl w-full max-w-3xl h-[85vh] flex flex-col overflow-hidden shadow-2xl">


                <div className="flex justify-between items-center px-6 py-4 border-b border-gray-100 bg-gray-50 shrink-0">
                    <div className="flex items-center gap-3">
                        <div className="p-2 bg-white rounded-lg shadow-sm text-indigo-600 border border-indigo-100">
                            <Box size={24}/>
                        </div>
                        <div>
                            <h2 className="text-xl font-bold text-gray-800">–ü–∞—Å–ø–æ—Ä—Ç –ò–∑–¥–µ–ª–∏—è</h2>
                            <p className="text-xs text-gray-500 font-mono">ID: {data?.process?.box?.qrCode || "Loading..."}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                        {data && !isEditing && (
                            <button onClick={() => setIsEditing(true)} className="flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition text-sm font-bold shadow-sm">
                                <Edit size={16}/> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        )}
                        {isEditing && (
                            <button onClick={handleSave} className="flex items-center gap-2 px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-bold shadow-sm">
                                <Save size={16}/> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                        )}
                        <button onClick={onClose} className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-lg transition">
                            <X size={20}/>
                        </button>
                    </div>
                </div>


                <div className="flex-1 overflow-y-auto p-6 custom-scrollbar bg-white">
                    {loading ? (
                        <div className="flex justify-center items-center h-full text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                    ) : data ? (
                        <>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                <div className="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                                    <p className="text-[10px] text-indigo-400 uppercase font-bold mb-1">–ü—Ä–æ–µ–∫—Ç / –†–µ—Ü–µ–ø—Ç</p>
                                    <div className="font-bold text-gray-800 text-sm mb-0.5">{data.process.recipe.project.title}</div>
                                    <div className="text-xs text-gray-500">{data.process.recipe.title}</div>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                    <p className="text-[10px] text-gray-400 uppercase font-bold mb-1 flex items-center gap-1"><User size={10}/> –°–±–æ—Ä—â–∏–∫</p>
                                    <div className="font-bold text-gray-800 text-sm">{data.user ? `${data.user.surname} ${data.user.name}` : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</div>
                                    <div className="text-xs text-gray-500 mt-0.5 flex items-center gap-1">
                                        <MapPin size={10}/> {data.user?.structure || "‚Äî"}
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                    <p className="text-[10px] text-gray-400 uppercase font-bold mb-1 flex items-center gap-1"><Calendar size={10}/> –ó–∞–≤–µ—Ä—à–µ–Ω–æ</p>
                                    <div className="font-bold text-gray-800 text-sm">
                                        {new Date(data.process.endTime).toLocaleDateString()}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-0.5">
                                        {new Date(data.process.endTime).toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>


                            <div className="mb-2 flex items-center justify-between">
                                <h3 className="text-sm font-bold text-gray-700 uppercase flex items-center gap-2">
                                    <Activity size={16} className="text-indigo-500"/> –ö–∞—Ä—Ç–∞ —Å–±–æ—Ä–∫–∏
                                </h3>
                                {isEditing && <span className="text-xs text-orange-600 font-bold animate-pulse">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>}
                            </div>

                            <div className="space-y-3 relative pl-4 border-l-2 border-gray-100 ml-2 pb-4">
                                {data.steps.map((step: any, index: number) => {

                                    const isDone = isEditing
                                        ? editedSteps.includes(index)
                                        : data.process.completedSteps.includes(index);

                                    return (
                                        <div key={step.id} className="relative pl-6">

                                            <div
                                                className={`absolute -left-[21px] top-1/2 -translate-y-1/2 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10
                                                ${isDone ? 'bg-green-500' : 'bg-red-500'}`}
                                            ></div>

                                            <div
                                                onClick={() => isEditing && toggleStep(index)}
                                                className={`
                                                    flex justify-between items-center p-3 rounded-xl border transition-all
                                                    ${isEditing ? 'cursor-pointer hover:border-indigo-300 hover:shadow-md' : ''}
                                                    ${isDone ? 'bg-white border-gray-200' : 'bg-red-50 border-red-200'}
                                                `}
                                            >
                                                <div>
                                                    <div className={`text-sm font-bold ${isDone ? 'text-gray-800' : 'text-red-700'}`}>
                                                        <span className="mr-2 text-gray-400 font-mono">{index + 1}.</span>
                                                        {step.title}
                                                    </div>
                                                    {step.description && <div className="text-xs text-gray-500 mt-0.5 ml-5">{step.description}</div>}
                                                </div>

                                                <div>
                                                    {isDone
                                                        ? <div className="flex items-center gap-2 text-green-600 text-xs font-bold bg-green-50 px-2 py-1 rounded"><CheckCircle2 size={16}/> OK</div>
                                                        : <div className="flex items-center gap-2 text-red-600 text-xs font-bold bg-white px-2 py-1 rounded border border-red-100"><XCircle size={16}/> MISS</div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </>
                    ) : (
                        <div className="p-10 text-center text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞</div>
                    )}
                </div>
            </div>
        </Modal>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/BeryllMonitoringPage.tsx
================================================================================



import React from "react";
import { useNavigate } from "react-router-dom";
import { ArrowLeft, Activity } from "lucide-react";
import { MonitoringDashboard } from "src/components/beryll/MonitoringDashboard";
import { BERYLL_ROUTE } from "src/utils/consts";

const BeryllMonitoringPage: React.FC = () => {
  const navigate = useNavigate();

  return (
    <div className="min-h-screen bg-gray-100">

      <div className="bg-white shadow">
        <div className="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between py-4">
            <div className="flex items-center gap-3">

              <button
                onClick={() => navigate(BERYLL_ROUTE)}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                title="–ù–∞–∑–∞–¥ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º"
              >
                <ArrowLeft className="w-5 h-5 text-gray-600" />
              </button>

              <div className="p-2.5 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg">
                <Activity className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-xl font-bold text-gray-900">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–æ–≤</h1>
                <p className="text-sm text-gray-500">–°—Ç–∞—Ç—É—Å –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
              </div>
            </div>
          </div>
        </div>
      </div>


      <div className="max-w-full mx-auto p-4 sm:p-6 lg:p-8">
        <MonitoringDashboard
          autoRefresh={true}
          refreshInterval={60}
        />
      </div>
    </div>
  );
};

export default BeryllMonitoringPage;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/BeryllPage.tsx
================================================================================



import React, { useState, useEffect } from "react";
import { useSearchParams } from "react-router-dom";
import toast from "react-hot-toast";
import {
  Server, Package, Boxes, AlertTriangle, BarChart3,
  Archive, Settings, HardDrive, RefreshCw, Wifi
} from "lucide-react";


import ServersTab from "./tabs/ServersTab";
import BatchesTab from "./tabs/BatchesTab";
import AnalyticsTab from "./tabs/AnalyticsTab";
import ArchiveTab from "./tabs/ArchiveTab";
import SettingsTab from "./tabs/SettingsTab";


import RacksTab from "./tabs/RacksTab";
import ClustersTab from "./tabs/ClustersTab";
import DefectRecordsTab from "./tabs/DefectRecordsTab";


import { syncWithDhcp } from "src/api/beryllApi";


const TABS = [
  { id: "servers", label: "–°–µ—Ä–≤–µ—Ä—ã", icon: Server },
  { id: "batches", label: "–ü–∞—Ä—Ç–∏–∏", icon: Package },
  { id: "racks", label: "–°—Ç–æ–π–∫–∏", icon: HardDrive },
  { id: "clusters", label: "–ö–ª–∞—Å—Ç–µ—Ä—ã", icon: Boxes },
  { id: "defects", label: "–£—á—ë—Ç –±—Ä–∞–∫–∞", icon: AlertTriangle },
  { id: "analytics", label: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞", icon: BarChart3 },
  { id: "archive", label: "–ê—Ä—Ö–∏–≤", icon: Archive },
  { id: "settings", label: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", icon: Settings },
] as const;

type TabId = typeof TABS[number]["id"];


const LAST_SYNC_KEY = "beryll_last_dhcp_sync";

const BeryllPage: React.FC = () => {
  const [searchParams, setSearchParams] = useSearchParams();
  const [activeTab, setActiveTab] = useState<TabId>(() => {
    const tabFromUrl = searchParams.get("tab") as TabId;
    return TABS.some(t => t.id === tabFromUrl) ? tabFromUrl : "servers";
  });


  const [syncing, setSyncing] = useState(false);
  const [lastSyncTime, setLastSyncTime] = useState<string | null>(() => {
    return localStorage.getItem(LAST_SYNC_KEY);
  });


  useEffect(() => {
    const tabFromUrl = searchParams.get("tab") as TabId;
    if (tabFromUrl && TABS.some(t => t.id === tabFromUrl) && tabFromUrl !== activeTab) {
      setActiveTab(tabFromUrl);
    }
  }, [searchParams]);

  const handleTabChange = (tabId: TabId) => {
    setActiveTab(tabId);
    setSearchParams({ tab: tabId });
  };


  const formatSyncTime = (isoString: string): string => {
    const date = new Date(isoString);
    return date.toLocaleTimeString("ru-RU", {
      hour: "2-digit",
      minute: "2-digit"
    });
  };


  const handleSyncDhcp = async () => {
    setSyncing(true);
    try {
      const result = await syncWithDhcp();


      const now = new Date().toISOString();
      localStorage.setItem(LAST_SYNC_KEY, now);
      setLastSyncTime(now);

      if (result.success) {
        toast.success(
          `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–æ–∑–¥–∞–Ω–æ: ${result.results.created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${result.results.updated}`,
          { duration: 4000 }
        );
      } else {
        toast.error(result.message || "–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏");
      }
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å DHCP");
      console.error("DHCP Sync Error:", e);
    } finally {
      setSyncing(false);
    }
  };


  const renderTabContent = () => {
    switch (activeTab) {
      case "servers":
        return <ServersTab />;
      case "batches":
        return <BatchesTab />;
      case "racks":
        return <RacksTab />;
      case "clusters":
        return <ClustersTab />;
      case "defects":
        return <DefectRecordsTab />;
      case "analytics":
        return <AnalyticsTab />;
      case "archive":
        return <ArchiveTab />;
      case "settings":
        return <SettingsTab />;
      default:
        return <ServersTab />;
    }
  };

  return (
    <div className="min-h-screen bg-gray-100">

      <div className="bg-white shadow">
        <div className="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between py-4">
            <div className="flex items-center gap-3">
              <div className="p-2.5 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg">
                <Server className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-xl font-bold text-gray-900">–ê–ü–ö –ë–µ—Ä–∏–ª–ª</h1>
                <p className="text-sm text-gray-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–æ–≤</p>
              </div>
            </div>


            <div className="flex items-center gap-3">

              {lastSyncTime && (
                <div className="flex items-center gap-1.5 text-sm text-gray-500">
                  <Wifi className="w-4 h-4 text-green-500" />
                  <span className="hidden sm:inline">–°–∏–Ω—Ö—Ä:</span>
                  <span>{formatSyncTime(lastSyncTime)}</span>
                </div>
              )}


              <button
                onClick={handleSyncDhcp}
                disabled={syncing}
                className={`
                  flex items-center gap-2 px-4 py-2.5 rounded-xl font-medium text-sm
                  transition-all duration-200 shadow-sm
                  ${syncing
                    ? "bg-gray-100 text-gray-400 cursor-not-allowed"
                    : "bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:from-indigo-700 hover:to-purple-700 hover:shadow-md"
                  }
                `}
              >
                <RefreshCw className={`w-4 h-4 ${syncing ? "animate-spin" : ""}`} />
                {syncing ? "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è..." : "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å DHCP"}
              </button>
            </div>
          </div>
        </div>
      </div>


      <div className="bg-white border-b sticky top-0 z-40 shadow-sm">
        <div className="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
          <nav className="flex space-x-1 overflow-x-auto scrollbar-hide" aria-label="Tabs">
            {TABS.map((tab) => {
              const Icon = tab.icon;
              const isActive = activeTab === tab.id;

              return (
                <button
                  key={tab.id}
                  onClick={() => handleTabChange(tab.id)}
                  className={`
                    flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap
                    transition-all duration-200 ease-out
                    ${isActive
                      ? "border-indigo-500 text-indigo-600 bg-indigo-50/50"
                      : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50"
                    }
                  `}
                >
                  <Icon
                    size={18}
                    className={`transition-transform duration-200 ${isActive ? "scale-110" : ""}`}
                  />
                  {tab.label}

                  {tab.id === "defects" && (
                    <span className="ml-1 px-1.5 py-0.5 text-xs bg-red-100 text-red-600 rounded-full animate-pulse">
                      !
                    </span>
                  )}
                </button>
              );
            })}
          </nav>
        </div>
      </div>


      <div className="max-w-full mx-auto">
        {renderTabContent()}
      </div>
    </div>
  );
};

export default BeryllPage;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/ComponentRevisionsPage.tsx
================================================================================


import React, { useState, useEffect, useMemo, useCallback } from "react";
import { useNavigate } from "react-router-dom";
import toast from "react-hot-toast";
import {
  ArrowLeft,
  Plus,
  Pencil,
  Trash2,
  ChevronDown,
  ChevronRight,
  Search,
  Cpu,
  HardDrive,
  MemoryStick,
  Fan,
  CircuitBoard,
  Server,
  Zap,
  Package,
  Settings,
  X,
  Save,
  Loader2,
  Eye,
  EyeOff,
  Info,
  ListFilter
} from "lucide-react";
import { BERYLL_ROUTE } from "src/utils/consts";


interface ComponentCatalog {
  id: number;
  type: string;
  manufacturer: string | null;
  model: string;
  revision: string | null;
  partNumber: string | null;
  specifications: Record<string, any> | null;
  serialNumberPattern: string | null;
  isActive: boolean;
  notes: string | null;
  createdAt: string;
  updatedAt: string;
}

type ComponentType =
  | "CPU" | "RAM" | "HDD" | "SSD" | "NVME" | "NIC"
  | "MOTHERBOARD" | "PSU" | "GPU" | "RAID" | "BMC"
  | "FAN" | "CHASSIS" | "BACKPLANE" | "CABLE" | "OTHER";


const COMPONENT_TYPE_LABELS: Record<string, string> = {
  MOTHERBOARD: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞",
  CPU: "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä",
  RAM: "–ü–ª–∞–Ω–∫–∏ –ø–∞–º—è—Ç–∏",
  HDD: "HDD –¥–∏—Å–∫–∏",
  SSD: "SSD –¥–∏—Å–∫–∏",
  NVME: "NVMe –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–∏",
  NIC: "–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞",
  PSU: "–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è",
  GPU: "–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞",
  RAID: "RAID-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä",
  BMC: "BMC",
  FAN: "–ö—É–ª–µ—Ä—ã",
  BACKPLANE: "Backplane",
  CHASSIS: "–ö–æ—Ä–ø—É—Å",
  CABLE: "–ö–∞–±–µ–ª–∏",
  OTHER: "–ü—Ä–æ—á–µ–µ"
};

const COMPONENT_TYPE_ICONS: Record<string, React.ReactNode> = {
  MOTHERBOARD: <CircuitBoard size={18} />,
  CPU: <Cpu size={18} />,
  RAM: <MemoryStick size={18} />,
  HDD: <HardDrive size={18} />,
  SSD: <HardDrive size={18} />,
  NVME: <HardDrive size={18} />,
  NIC: <Settings size={18} />,
  PSU: <Zap size={18} />,
  GPU: <Cpu size={18} />,
  RAID: <Server size={18} />,
  BMC: <CircuitBoard size={18} />,
  FAN: <Fan size={18} />,
  BACKPLANE: <Package size={18} />,
  CHASSIS: <Server size={18} />,
  CABLE: <Package size={18} />,
  OTHER: <Package size={18} />
};

const COMPONENT_TYPE_COLORS: Record<string, string> = {
  MOTHERBOARD: "bg-emerald-50 text-emerald-700 border-emerald-200",
  CPU: "bg-blue-50 text-blue-700 border-blue-200",
  RAM: "bg-violet-50 text-violet-700 border-violet-200",
  HDD: "bg-amber-50 text-amber-700 border-amber-200",
  SSD: "bg-orange-50 text-orange-700 border-orange-200",
  NVME: "bg-red-50 text-red-700 border-red-200",
  NIC: "bg-cyan-50 text-cyan-700 border-cyan-200",
  PSU: "bg-yellow-50 text-yellow-700 border-yellow-200",
  GPU: "bg-pink-50 text-pink-700 border-pink-200",
  RAID: "bg-indigo-50 text-indigo-700 border-indigo-200",
  BMC: "bg-teal-50 text-teal-700 border-teal-200",
  FAN: "bg-sky-50 text-sky-700 border-sky-200",
  BACKPLANE: "bg-lime-50 text-lime-700 border-lime-200",
  CHASSIS: "bg-stone-50 text-stone-700 border-stone-200",
  CABLE: "bg-gray-50 text-gray-700 border-gray-200",
  OTHER: "bg-slate-50 text-slate-700 border-slate-200"
};


const TYPE_ORDER: string[] = [
  "MOTHERBOARD", "CPU", "RAM", "SSD", "HDD", "NVME",
  "NIC", "RAID", "BMC", "PSU", "FAN", "BACKPLANE",
  "GPU", "CHASSIS", "CABLE", "OTHER"
];

const ALL_TYPES: ComponentType[] = [
  "CPU", "RAM", "HDD", "SSD", "NVME", "NIC",
  "MOTHERBOARD", "PSU", "GPU", "RAID", "BMC",
  "FAN", "CHASSIS", "BACKPLANE", "CABLE", "OTHER"
];


import { $authHost } from "src/api/index";

const catalogApi = {

  getAll: async (): Promise<ComponentCatalog[]> => {
    const { data } = await $authHost.get("api/beryll/catalog");
    return data;
  },


  create: async (entry: Partial<ComponentCatalog>): Promise<{ catalog: ComponentCatalog; created: boolean }> => {
    const { data } = await $authHost.post("api/beryll/catalog", entry);
    return data;
  },


  update: async (id: number, entry: Partial<ComponentCatalog>): Promise<ComponentCatalog> => {
    const { data } = await $authHost.put(`api/beryll/catalog/${id}`, entry);
    return data;
  },


  delete: async (id: number): Promise<void> => {
    await $authHost.delete(`api/beryll/catalog/${id}`);
  }
};


interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
  maxWidth?: string;
}

const Modal: React.FC<ModalProps> = ({ isOpen, onClose, title, children, maxWidth = "max-w-lg" }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4" onClick={onClose}>
      <div className="fixed inset-0 bg-black/40 backdrop-blur-sm" />
      <div
        className={`relative bg-white rounded-2xl shadow-2xl w-full ${maxWidth} max-h-[90vh] overflow-hidden`}
        onClick={(e) => e.stopPropagation()}
      >

        <div className="flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-indigo-50 to-purple-50">
          <h2 className="text-lg font-bold text-gray-800">{title}</h2>
          <button
            onClick={onClose}
            className="p-2 rounded-lg hover:bg-white/60 transition text-gray-500 hover:text-gray-700"
          >
            <X size={18} />
          </button>
        </div>

        <div className="overflow-y-auto max-h-[calc(90vh-70px)]">
          {children}
        </div>
      </div>
    </div>
  );
};


interface CatalogFormData {
  type: string;
  manufacturer: string;
  model: string;
  revision: string;
  partNumber: string;
  notes: string;
  specifications: string;
}

const emptyCatalogForm: CatalogFormData = {
  type: "",
  manufacturer: "",
  model: "",
  revision: "",
  partNumber: "",
  notes: "",
  specifications: "{}"
};

interface CatalogFormProps {
  initialData?: CatalogFormData;
  presetType?: string;
  onSubmit: (data: CatalogFormData) => Promise<void>;
  onCancel: () => void;
  submitLabel: string;
  loading: boolean;
}

const CatalogForm: React.FC<CatalogFormProps> = ({
  initialData,
  presetType,
  onSubmit,
  onCancel,
  submitLabel,
  loading
}) => {
  const [form, setForm] = useState<CatalogFormData>(
    initialData || { ...emptyCatalogForm, type: presetType || "" }
  );
  const [showSpecs, setShowSpecs] = useState(false);

  const handleChange = (field: keyof CatalogFormData, value: string) => {
    setForm((prev) => ({ ...prev, [field]: value }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form.type) {
      toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–≥–æ");
      return;
    }
    if (!form.model) {
      toast.error("–£–∫–∞–∂–∏—Ç–µ –º–æ–¥–µ–ª—å");
      return;
    }
    await onSubmit(form);
  };

  return (
    <form onSubmit={handleSubmit} className="p-6 space-y-4">

      <div>
        <label className="block text-sm font-medium text-gray-600 mb-1">
          –¢–∏–ø –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–≥–æ <span className="text-red-500">*</span>
        </label>
        <select
          value={form.type}
          onChange={(e) => handleChange("type", e.target.value)}
          disabled={!!presetType}
          className="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition disabled:bg-gray-50 disabled:text-gray-500"
        >
          <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø ‚Äî</option>
          {ALL_TYPES.map((t) => (
            <option key={t} value={t}>
              {COMPONENT_TYPE_LABELS[t] || t}
            </option>
          ))}
        </select>
      </div>


      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-600 mb-1">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
          <input
            type="text"
            value={form.manufacturer}
            onChange={(e) => handleChange("manufacturer", e.target.value)}
            placeholder="Samsung, Intel, Yadro..."
            className="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-600 mb-1">
            –ú–æ–¥–µ–ª—å <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            value={form.model}
            onChange={(e) => handleChange("model", e.target.value)}
            placeholder="–ú–æ–¥–µ–ª—å / –∞—Ä—Ç–∏–∫—É–ª"
            className="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"
          />
        </div>
      </div>


      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-600 mb-1">–†–µ–≤–∏–∑–∏—è</label>
          <input
            type="text"
            value={form.revision}
            onChange={(e) => handleChange("revision", e.target.value)}
            placeholder="Rev.20, 2245, 1E1-..."
            className="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-600 mb-1">Part Number</label>
          <input
            type="text"
            value={form.partNumber}
            onChange={(e) => handleChange("partNumber", e.target.value)}
            placeholder="–ê—Ä—Ç–∏–∫—É–ª –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è"
            className="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"
          />
        </div>
      </div>


      <div>
        <label className="block text-sm font-medium text-gray-600 mb-1">–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea
          value={form.notes}
          onChange={(e) => handleChange("notes", e.target.value)}
          placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."
          rows={2}
          className="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition resize-none"
        />
      </div>


      <div>
        <button
          type="button"
          onClick={() => setShowSpecs(!showSpecs)}
          className="flex items-center gap-1.5 text-xs text-gray-500 hover:text-indigo-600 transition"
        >
          {showSpecs ? <EyeOff size={14} /> : <Eye size={14} />}
          {showSpecs ? "–°–∫—Ä—ã—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏" : "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (JSON)"}
        </button>
        {showSpecs && (
          <textarea
            value={form.specifications}
            onChange={(e) => handleChange("specifications", e.target.value)}
            rows={4}
            className="w-full mt-2 px-3 py-2.5 border border-gray-200 rounded-xl text-xs font-mono focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition resize-none bg-gray-50"
          />
        )}
      </div>


      <div className="flex items-center justify-end gap-3 pt-2">
        <button
          type="button"
          onClick={onCancel}
          className="px-4 py-2.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-xl transition"
        >
          –û—Ç–º–µ–Ω–∞
        </button>
        <button
          type="submit"
          disabled={loading}
          className="flex items-center gap-2 px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 rounded-xl shadow-md hover:shadow-lg transition disabled:opacity-50"
        >
          {loading ? <Loader2 size={16} className="animate-spin" /> : <Save size={16} />}
          {submitLabel}
        </button>
      </div>
    </form>
  );
};


interface RevisionCardProps {
  entry: ComponentCatalog;
  onEdit: (entry: ComponentCatalog) => void;
  onDelete: (entry: ComponentCatalog) => void;
}

const RevisionCard: React.FC<RevisionCardProps> = ({ entry, onEdit, onDelete }) => {
  const specs = entry.specifications || {};
  const specKeys = Object.keys(specs).filter(
    (k) => !["serverModel", "variants"].includes(k)
  );

  return (
    <div className="group relative bg-white border border-gray-100 rounded-xl p-4 hover:border-indigo-200 hover:shadow-sm transition-all duration-200">

      <div className="flex items-start justify-between gap-3">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 flex-wrap">
            <span className="font-semibold text-sm text-gray-800 truncate">
              {entry.manufacturer ? `${entry.manufacturer} ` : ""}
              {entry.model}
            </span>
            {entry.revision && (
              <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700">
                rev. {entry.revision}
              </span>
            )}
          </div>


          {entry.partNumber && (
            <div className="mt-1 text-xs text-gray-400">
              P/N: {entry.partNumber}
            </div>
          )}


          {specKeys.length > 0 && (
            <div className="mt-2 flex flex-wrap gap-1.5">
              {specKeys.slice(0, 4).map((key) => (
                <span
                  key={key}
                  className="inline-flex items-center px-2 py-0.5 rounded-md text-xs bg-gray-50 text-gray-600 border border-gray-100"
                >
                  {key}: {String(specs[key])}
                </span>
              ))}
              {specKeys.length > 4 && (
                <span className="text-xs text-gray-400">+{specKeys.length - 4}</span>
              )}
            </div>
          )}


          {entry.notes && (
            <div className="mt-1.5 text-xs text-gray-400 truncate" title={entry.notes}>
              {entry.notes}
            </div>
          )}
        </div>


        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
          <button
            onClick={() => onEdit(entry)}
            className="p-1.5 rounded-lg hover:bg-indigo-50 text-gray-400 hover:text-indigo-600 transition"
            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
          >
            <Pencil size={14} />
          </button>
          <button
            onClick={() => onDelete(entry)}
            className="p-1.5 rounded-lg hover:bg-red-50 text-gray-400 hover:text-red-600 transition"
            title="–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å"
          >
            <Trash2 size={14} />
          </button>
        </div>
      </div>
    </div>
  );
};


interface TypeSectionProps {
  type: string;
  entries: ComponentCatalog[];
  isExpanded: boolean;
  onToggle: () => void;
  onAddRevision: (type: string) => void;
  onEdit: (entry: ComponentCatalog) => void;
  onDelete: (entry: ComponentCatalog) => void;
}

const TypeSection: React.FC<TypeSectionProps> = ({
  type,
  entries,
  isExpanded,
  onToggle,
  onAddRevision,
  onEdit,
  onDelete
}) => {
  const label = COMPONENT_TYPE_LABELS[type] || type;
  const icon = COMPONENT_TYPE_ICONS[type] || <Package size={18} />;
  const colorClass = COMPONENT_TYPE_COLORS[type] || COMPONENT_TYPE_COLORS.OTHER;

  return (
    <div className="border border-gray-100 rounded-2xl overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow duration-200">

      <button
        onClick={onToggle}
        className="w-full flex items-center justify-between px-5 py-4 hover:bg-gray-50/50 transition"
      >
        <div className="flex items-center gap-3">
          <div className={`flex items-center justify-center w-9 h-9 rounded-xl border ${colorClass}`}>
            {icon}
          </div>
          <div className="text-left">
            <div className="font-semibold text-gray-800">{label}</div>
            <div className="text-xs text-gray-400 mt-0.5">
              {entries.length} {entries.length === 1 ? "—Ä–µ–≤–∏–∑–∏—è" : entries.length < 5 ? "—Ä–µ–≤–∏–∑–∏–∏" : "—Ä–µ–≤–∏–∑–∏–π"}
            </div>
          </div>
        </div>

        <div className="flex items-center gap-2">

          <div className="hidden sm:flex items-center gap-1 mr-2">
            {entries.slice(0, 5).map((e) => (
              <span
                key={e.id}
                className="inline-flex px-1.5 py-0.5 text-[10px] font-medium rounded bg-gray-100 text-gray-500 max-w-[80px] truncate"
                title={`${e.manufacturer || ""} ${e.model} ${e.revision ? `(${e.revision})` : ""}`}
              >
                {e.revision || e.model.slice(0, 12)}
              </span>
            ))}
            {entries.length > 5 && (
              <span className="text-[10px] text-gray-400">+{entries.length - 5}</span>
            )}
          </div>
          {isExpanded ? (
            <ChevronDown size={18} className="text-gray-400" />
          ) : (
            <ChevronRight size={18} className="text-gray-400" />
          )}
        </div>
      </button>


      {isExpanded && (
        <div className="border-t border-gray-100 px-5 pb-4 pt-3">

          <div className="mb-3">
            <button
              onClick={() => onAddRevision(type)}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition"
            >
              <Plus size={14} />
              –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≤–∏–∑–∏—é
            </button>
          </div>


          <div className="grid gap-2">
            {entries.map((entry) => (
              <RevisionCard
                key={entry.id}
                entry={entry}
                onEdit={onEdit}
                onDelete={onDelete}
              />
            ))}
          </div>

          {entries.length === 0 && (
            <div className="text-center py-6 text-sm text-gray-400">
              –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ä–µ–≤–∏–∑–∏—é.
            </div>
          )}
        </div>
      )}
    </div>
  );
};


const ComponentRevisionsPage: React.FC = () => {
  const navigate = useNavigate();


  const [catalog, setCatalog] = useState<ComponentCatalog[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);


  const [expandedTypes, setExpandedTypes] = useState<Set<string>>(new Set());
  const [searchQuery, setSearchQuery] = useState("");
  const [filterType, setFilterType] = useState<string>("");


  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [editingEntry, setEditingEntry] = useState<ComponentCatalog | null>(null);
  const [deletingEntry, setDeletingEntry] = useState<ComponentCatalog | null>(null);
  const [presetType, setPresetType] = useState<string>("");


  const loadCatalog = useCallback(async () => {
    try {
      setLoading(true);
      const data = await catalogApi.getAll();
      setCatalog(data.filter((d) => d.isActive));
    } catch (error: any) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞");
      console.error("loadCatalog error:", error);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadCatalog();
  }, [loadCatalog]);


  const grouped = useMemo(() => {
    let filtered = catalog;


    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      filtered = filtered.filter(
        (c) =>
          (c.manufacturer || "").toLowerCase().includes(q) ||
          c.model.toLowerCase().includes(q) ||
          (c.revision || "").toLowerCase().includes(q) ||
          (c.partNumber || "").toLowerCase().includes(q) ||
          (c.notes || "").toLowerCase().includes(q)
      );
    }


    if (filterType) {
      filtered = filtered.filter((c) => c.type === filterType);
    }


    const map = new Map<string, ComponentCatalog[]>();
    for (const entry of filtered) {
      const list = map.get(entry.type) || [];
      list.push(entry);
      map.set(entry.type, list);
    }


    const result: Array<{ type: string; entries: ComponentCatalog[] }> = [];
    for (const type of TYPE_ORDER) {
      const entries = map.get(type);
      if (entries && entries.length > 0) {
        result.push({ type, entries });
      }
    }

    for (const [type, entries] of map) {
      if (!TYPE_ORDER.includes(type)) {
        result.push({ type, entries });
      }
    }

    return result;
  }, [catalog, searchQuery, filterType]);


  const availableTypes = useMemo(() => {
    return [...new Set(catalog.map((c) => c.type))].sort();
  }, [catalog]);


  const toggleType = (type: string) => {
    setExpandedTypes((prev) => {
      const next = new Set(prev);
      if (next.has(type)) {
        next.delete(type);
      } else {
        next.add(type);
      }
      return next;
    });
  };

  const expandAll = () => {
    setExpandedTypes(new Set(grouped.map((g) => g.type)));
  };

  const collapseAll = () => {
    setExpandedTypes(new Set());
  };


  const handleAddRevision = (type: string) => {
    setPresetType(type);
    setShowCreateModal(true);
  };

  const handleCreate = async (formData: CatalogFormData) => {
    setSaving(true);
    try {
      let specs = {};
      try {
        specs = JSON.parse(formData.specifications || "{}");
      } catch {

      }

      const { created } = await catalogApi.create({
        type: formData.type as ComponentType,
        manufacturer: formData.manufacturer || null,
        model: formData.model,
        revision: formData.revision || null,
        partNumber: formData.partNumber || null,
        notes: formData.notes || null,
        specifications: specs
      });

      if (created) {
        toast.success("–†–µ–≤–∏–∑–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞");
      } else {
        toast.success("–ó–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
      }

      setShowCreateModal(false);
      setPresetType("");
      await loadCatalog();


      setExpandedTypes((prev) => new Set([...prev, formData.type]));
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è");
    } finally {
      setSaving(false);
    }
  };


  const handleEdit = (entry: ComponentCatalog) => {
    setEditingEntry(entry);
    setShowEditModal(true);
  };

  const handleUpdate = async (formData: CatalogFormData) => {
    if (!editingEntry) return;
    setSaving(true);
    try {
      let specs = {};
      try {
        specs = JSON.parse(formData.specifications || "{}");
      } catch {

      }

      await catalogApi.update(editingEntry.id, {
        type: formData.type as ComponentType,
        manufacturer: formData.manufacturer || null,
        model: formData.model,
        revision: formData.revision || null,
        partNumber: formData.partNumber || null,
        notes: formData.notes || null,
        specifications: specs
      });

      toast.success("–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
      setShowEditModal(false);
      setEditingEntry(null);
      await loadCatalog();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
    } finally {
      setSaving(false);
    }
  };


  const handleDeleteClick = (entry: ComponentCatalog) => {
    setDeletingEntry(entry);
    setShowDeleteConfirm(true);
  };

  const handleDeleteConfirm = async () => {
    if (!deletingEntry) return;
    setSaving(true);
    try {
      await catalogApi.delete(deletingEntry.id);
      toast.success("–ó–∞–ø–∏—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
      setShowDeleteConfirm(false);
      setDeletingEntry(null);
      await loadCatalog();
    } catch (error: any) {

      try {
        await catalogApi.update(deletingEntry.id, { isActive: false } as any);
        toast.success("–ó–∞–ø–∏—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        setShowDeleteConfirm(false);
        setDeletingEntry(null);
        await loadCatalog();
      } catch (err2: any) {
        toast.error(err2.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
      }
    } finally {
      setSaving(false);
    }
  };


  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 via-white to-indigo-50/30">

      <div className="sticky top-0 z-30 bg-white/80 backdrop-blur-xl border-b border-gray-100">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center gap-4">
              <button
                onClick={() => navigate(BERYLL_ROUTE)}
                className="p-2 rounded-xl hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition"
              >
                <ArrowLeft size={20} />
              </button>
              <div>
                <h1 className="text-lg font-bold text-gray-900">
                  –†–µ–≤–∏–∑–∏–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö
                </h1>
                <p className="text-xs text-gray-400">
                  VegmanS220v8 ‚Äî —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –º–æ–¥–µ–ª–µ–π –∏ —Ä–µ–≤–∏–∑–∏–π
                </p>
              </div>
            </div>

            <button
              onClick={() => {
                setPresetType("");
                setShowCreateModal(true);
              }}
              className="flex items-center gap-2 px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 rounded-xl shadow-md hover:shadow-lg transition"
            >
              <Plus size={16} />
              <span className="hidden sm:inline">–ù–æ–≤–æ–µ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ</span>
            </button>
          </div>
        </div>
      </div>


      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">

          <div className="relative flex-1">
            <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–æ–¥–µ–ª–∏, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—é, —Ä–µ–≤–∏–∑–∏–∏..."
              className="w-full pl-9 pr-4 py-2.5 text-sm border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 transition bg-white"
            />
            {searchQuery && (
              <button
                onClick={() => setSearchQuery("")}
                className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
              >
                <X size={14} />
              </button>
            )}
          </div>


          <div className="relative">
            <ListFilter size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
            <select
              value={filterType}
              onChange={(e) => setFilterType(e.target.value)}
              className="pl-9 pr-8 py-2.5 text-sm border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 transition bg-white appearance-none"
            >
              <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
              {availableTypes.map((t) => (
                <option key={t} value={t}>
                  {COMPONENT_TYPE_LABELS[t] || t}
                </option>
              ))}
            </select>
          </div>


          <div className="flex gap-1">
            <button
              onClick={expandAll}
              className="px-3 py-2.5 text-xs text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 border border-gray-200 rounded-xl transition"
              title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë"
            >
              –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å
            </button>
            <button
              onClick={collapseAll}
              className="px-3 py-2.5 text-xs text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 border border-gray-200 rounded-xl transition"
              title="–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë"
            >
              –°–≤–µ—Ä–Ω—É—Ç—å
            </button>
          </div>
        </div>


        <div className="mt-3 flex items-center gap-4 text-xs text-gray-400">
          <span>
            –í—Å–µ–≥–æ: <strong className="text-gray-600">{catalog.length}</strong> –∑–∞–ø–∏—Å–µ–π
          </span>
          <span>
            –¢–∏–ø–æ–≤: <strong className="text-gray-600">{availableTypes.length}</strong>
          </span>
          {searchQuery && (
            <span>
              –ù–∞–π–¥–µ–Ω–æ: <strong className="text-indigo-600">
                {grouped.reduce((sum, g) => sum + g.entries.length, 0)}
              </strong>
            </span>
          )}
        </div>
      </div>


      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        {loading ? (
          <div className="flex items-center justify-center py-20">
            <Loader2 size={32} className="animate-spin text-indigo-400" />
            <span className="ml-3 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...</span>
          </div>
        ) : grouped.length === 0 ? (
          <div className="text-center py-20">
            <Package size={48} className="mx-auto text-gray-300 mb-4" />
            <h3 className="text-lg font-medium text-gray-600">
              {searchQuery || filterType
                ? "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
                : "–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç"
              }
            </h3>
            <p className="mt-1 text-sm text-gray-400">
              {searchQuery || filterType
                ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞"
                : "–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ"
              }
            </p>
            {!searchQuery && !filterType && (
              <button
                onClick={() => setShowCreateModal(true)}
                className="mt-4 inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-xl transition"
              >
                <Plus size={16} />
                –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ
              </button>
            )}
          </div>
        ) : (
          <div className="grid gap-3">
            {grouped.map(({ type, entries }) => (
              <TypeSection
                key={type}
                type={type}
                entries={entries}
                isExpanded={expandedTypes.has(type)}
                onToggle={() => toggleType(type)}
                onAddRevision={handleAddRevision}
                onEdit={handleEdit}
                onDelete={handleDeleteClick}
              />
            ))}
          </div>
        )}
      </div>


      <Modal
        isOpen={showCreateModal}
        onClose={() => {
          setShowCreateModal(false);
          setPresetType("");
        }}
        title={presetType
          ? `–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≤–∏–∑–∏—é ‚Äî ${COMPONENT_TYPE_LABELS[presetType] || presetType}`
          : "–ù–æ–≤–æ–µ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ"
        }
      >
        <CatalogForm
          presetType={presetType || undefined}
          onSubmit={handleCreate}
          onCancel={() => {
            setShowCreateModal(false);
            setPresetType("");
          }}
          submitLabel="–î–æ–±–∞–≤–∏—Ç—å"
          loading={saving}
        />
      </Modal>


      <Modal
        isOpen={showEditModal}
        onClose={() => {
          setShowEditModal(false);
          setEditingEntry(null);
        }}
        title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
      >
        {editingEntry && (
          <CatalogForm
            initialData={{
              type: editingEntry.type,
              manufacturer: editingEntry.manufacturer || "",
              model: editingEntry.model,
              revision: editingEntry.revision || "",
              partNumber: editingEntry.partNumber || "",
              notes: editingEntry.notes || "",
              specifications: JSON.stringify(editingEntry.specifications || {}, null, 2)
            }}
            onSubmit={handleUpdate}
            onCancel={() => {
              setShowEditModal(false);
              setEditingEntry(null);
            }}
            submitLabel="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
            loading={saving}
          />
        )}
      </Modal>


      <Modal
        isOpen={showDeleteConfirm}
        onClose={() => {
          setShowDeleteConfirm(false);
          setDeletingEntry(null);
        }}
        title="–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å?"
        maxWidth="max-w-sm"
      >
        <div className="p-6">
          {deletingEntry && (
            <>
              <div className="flex items-start gap-3 mb-4">
                <div className="flex-shrink-0 w-10 h-10 rounded-full bg-red-50 flex items-center justify-center">
                  <Trash2 size={18} className="text-red-500" />
                </div>
                <div>
                  <p className="text-sm text-gray-700">
                    –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å?
                  </p>
                  <p className="mt-1 text-sm font-medium text-gray-900">
                    {deletingEntry.manufacturer ? `${deletingEntry.manufacturer} ` : ""}
                    {deletingEntry.model}
                    {deletingEntry.revision ? ` (rev. ${deletingEntry.revision})` : ""}
                  </p>
                  <p className="mt-1 text-xs text-gray-400">
                    –ó–∞–ø–∏—Å—å —Å—Ç–∞–Ω–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –∏ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
                  </p>
                </div>
              </div>

              <div className="flex items-center justify-end gap-3">
                <button
                  onClick={() => {
                    setShowDeleteConfirm(false);
                    setDeletingEntry(null);
                  }}
                  className="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-xl transition"
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
                <button
                  onClick={handleDeleteConfirm}
                  disabled={saving}
                  className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-xl shadow transition disabled:opacity-50"
                >
                  {saving ? <Loader2 size={14} className="animate-spin" /> : <Trash2 size={14} />}
                  –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                </button>
              </div>
            </>
          )}
        </div>
      </Modal>


      <div className="fixed bottom-4 right-4 z-20">
        <div className="group relative">
          <button className="w-10 h-10 rounded-full bg-white shadow-lg border border-gray-200 flex items-center justify-center text-gray-400 hover:text-indigo-500 hover:border-indigo-200 transition">
            <Info size={18} />
          </button>
          <div className="invisible group-hover:visible opacity-0 group-hover:opacity-100 absolute bottom-12 right-0 w-72 bg-white rounded-xl shadow-xl border border-gray-100 p-4 text-xs text-gray-500 transition-all duration-200">
            <p className="font-semibold text-gray-700 mb-1">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–µ–≤–∏–∑–∏–π</p>
            <p>–ó–¥–µ—Å—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –º–æ–¥–µ–ª–∏ –∏ —Ä–µ–≤–∏–∑–∏–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</p>
            <p className="mt-2">–î–∞–Ω–Ω—ã–µ –∏–∑ —ç—Ç–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ¬´–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ¬ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–µ—Ä–≤–µ—Ä–∞).</p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ComponentRevisionsPage;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/components/ServerChecklistSection.tsx
================================================================================

import { useState, useRef, useEffect, useCallback } from "react";
import { createPortal } from "react-dom";
import {
  CheckCircle2,
  Circle,
  Camera,
  Upload,
  Trash2,
  Download,
  Image as ImageIcon,
  FileText,
  RefreshCw,
  ChevronDown,
  ChevronUp,
  AlertTriangle,
  Eye,
  X,
  ZoomIn,
  ZoomOut,
  RotateCw,
  Loader2
} from "lucide-react";
import {
  BeryllServerChecklist,
  BeryllChecklistFile,
  ChecklistGroup,
  CHECKLIST_GROUP_LABELS,
  toggleChecklistItem,
  uploadChecklistFile,
  deleteChecklistFile
} from "src/api/beryllApi";
import { $authHost } from "src/api/index";

interface ServerChecklistSectionProps {
  serverId: number;
  checklists: BeryllServerChecklist[];
  onUpdate: () => void;
  readOnly?: boolean;
}

export const ServerChecklistSection: React.FC<ServerChecklistSectionProps> = ({
  serverId,
  checklists,
  onUpdate,
  readOnly = false
}) => {
  const DEV = import.meta.env.DEV;
  const dlog = (...args: any[]) => {
    if (DEV) console.log(...args);
  };
  const derr = (...args: any[]) => {
    if (DEV) console.error(...args);
  };

  const [expandedGroups, setExpandedGroups] = useState<Set<ChecklistGroup>>(
    new Set(["VISUAL", "TESTING", "QC_PRIMARY", "BURN_IN", "QC_FINAL"])
  );
  const [uploadingId, setUploadingId] = useState<number | null>(null);
  const [togglingId, setTogglingId] = useState<number | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [activeUploadId, setActiveUploadId] = useState<number | null>(null);

  const [previewFile, setPreviewFile] = useState<BeryllChecklistFile | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
  const [previewLoading, setPreviewLoading] = useState(false);
  const [previewError, setPreviewError] = useState<string | null>(null);
  const [zoom, setZoom] = useState(1);
  const [rotation, setRotation] = useState(0);

  const handleClosePreview = useCallback(() => {
    dlog("=== handleClosePreview called ===");

    if (previewUrl) URL.revokeObjectURL(previewUrl);
    setPreviewFile(null);
    setPreviewUrl(null);
    setPreviewError(null);
    setZoom(1);
    setRotation(0);
  }, [previewUrl]);

  useEffect(() => {
    return () => {
      if (previewUrl) URL.revokeObjectURL(previewUrl);
    };
  }, [previewUrl]);


  useEffect(() => {
    if (!previewFile) return;

    const scrollY = window.scrollY;
    const body = document.body;

    body.style.position = "fixed";
    body.style.top = `-${scrollY}px`;
    body.style.left = "0";
    body.style.right = "0";
    body.style.width = "100%";

    return () => {
      const top = body.style.top;

      body.style.position = "";
      body.style.top = "";
      body.style.left = "";
      body.style.right = "";
      body.style.width = "";

      const restoreY = top ? -parseInt(top, 10) : scrollY;
      window.scrollTo(0, restoreY);
    };
  }, [previewFile]);


  useEffect(() => {
    if (!previewFile) return;

    const onKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        e.preventDefault();
        handleClosePreview();
      }
    };

    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
  }, [previewFile, handleClosePreview]);

  const groupedChecklists = checklists.reduce((acc, item) => {
    const group = item.template?.groupCode || "TESTING";
    if (!acc[group]) acc[group] = [];
    acc[group].push(item);
    return acc;
  }, {} as Record<ChecklistGroup, BeryllServerChecklist[]>);

  const groupOrder: ChecklistGroup[] = ["VISUAL", "TESTING", "QC_PRIMARY", "BURN_IN", "QC_FINAL"];

  const toggleGroup = (group: ChecklistGroup) => {
    const newExpanded = new Set(expandedGroups);
    if (newExpanded.has(group)) newExpanded.delete(group);
    else newExpanded.add(group);
    setExpandedGroups(newExpanded);
  };

  const handleToggle = async (
    checklistId: number,
    currentCompleted: boolean,
    requiresFile: boolean,
    hasFiles: boolean
  ) => {
    if (readOnly) return;

    if (!currentCompleted && requiresFile && !hasFiles) {
      alert("–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç/–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ");
      return;
    }

    setTogglingId(checklistId);
    try {
      await toggleChecklistItem(serverId, checklistId, !currentCompleted);
      onUpdate();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setTogglingId(null);
    }
  };

  const handleUploadClick = (checklistId: number) => {
    setActiveUploadId(checklistId);
    fileInputRef.current?.click();
  };

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !activeUploadId) return;

    const allowedTypes = ["image/jpeg", "image/png", "image/gif", "image/webp", "application/pdf"];
    if (!allowedTypes.includes(file.type)) {
      alert("–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, PNG, GIF, WEBP) –∏ PDF");
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      alert("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 5 –ú–ë");
      return;
    }

    setUploadingId(activeUploadId);
    try {
      await uploadChecklistFile(serverId, activeUploadId, file);
      onUpdate();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞");
    } finally {
      setUploadingId(null);
      setActiveUploadId(null);
      if (fileInputRef.current) fileInputRef.current.value = "";
    }
  };

  const handleDeleteFile = async (fileId: number, checklistCompleted: boolean) => {
    if (readOnly) return;

    const message = checklistCompleted
      ? "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ñ–∞–π–ª–∞ —Å–Ω–∏–º–µ—Ç –æ—Ç–º–µ—Ç–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?"
      : "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?";

    if (!confirm(message)) return;

    try {
      await deleteChecklistFile(fileId);
      onUpdate();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞");
    }
  };

  const handleDownloadFile = async (fileId: number, originalName: string) => {
    dlog("=== handleDownloadFile called ===", { fileId, originalName });

    try {
      const response = await $authHost.get(`/api/beryll/files/${fileId}?download=true`, {
        responseType: "blob"
      });

      const url = URL.createObjectURL(response.data);
      const a = document.createElement("a");
      a.href = url;
      a.download = originalName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e: any) {
      derr("Download error:", e);
      alert("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞");
    }
  };

  const handleOpenPreview = async (file: BeryllChecklistFile) => {
    dlog("=== handleOpenPreview called ===", file);

    setPreviewFile(file);
    setPreviewLoading(true);
    setPreviewError(null);
    setZoom(1);
    setRotation(0);

    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
      setPreviewUrl(null);
    }

    try {
      dlog("Fetching file...", `/api/beryll/files/${file.id}`);

      const response = await $authHost.get(`/api/beryll/files/${file.id}`, {
        responseType: "blob"
      });

      dlog("Response received:", response);

      const url = URL.createObjectURL(response.data);
      dlog("Blob URL created:", url);
      setPreviewUrl(url);
    } catch (e: any) {
      derr("Preview error:", e);
      setPreviewError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
    } finally {
      setPreviewLoading(false);
    }
  };

  const handleZoomIn = () => setZoom((prev) => Math.min(prev + 0.25, 3));
  const handleZoomOut = () => setZoom((prev) => Math.max(prev - 0.25, 0.5));
  const handleRotate = () => setRotation((prev) => (prev + 90) % 360);

  const totalCount = checklists.length;
  const completedCount = checklists.filter((c) => c.completed).length;
  const requiredCount = checklists.filter((c) => c.template?.isRequired).length;
  const requiredCompletedCount = checklists.filter((c) => c.template?.isRequired && c.completed).length;

  const isImageFile = (file: BeryllChecklistFile) => {
    return (
      file.mimetype?.startsWith("image/") ||
      ["jpg", "jpeg", "png", "gif", "webp"].some((ext) =>
        file.originalName?.toLowerCase().endsWith(`.${ext}`)
      )
    );
  };

  const formatFileSize = (bytes?: number) => {
    if (!bytes) return "0 KB";
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  };

  return (
    <div className="space-y-4">
      <input
        ref={fileInputRef}
        type="file"
        accept="image/*,application/pdf"
        className="hidden"
        onChange={handleFileChange}
      />

      <div className="flex items-center justify-between">
        <div>
          <h3 className="font-semibold text-gray-800">–ß–µ–∫-–ª–∏—Å—Ç —Ä–∞–±–æ—Ç</h3>
          <p className="text-sm text-gray-500">
            –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {completedCount} –∏–∑ {totalCount}
            {requiredCount > 0 && (
              <span className="ml-2 text-amber-600">
                (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö: {requiredCompletedCount}/{requiredCount})
              </span>
            )}
          </p>
        </div>

        <div className="flex items-center gap-3">
          <div className="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
            <div
              className="h-full bg-green-500 transition-all duration-300"
              style={{ width: `${totalCount > 0 ? (completedCount / totalCount) * 100 : 0}%` }}
            />
          </div>
          <span className="text-sm font-medium text-gray-600">
            {totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0}%
          </span>
        </div>
      </div>

      <div className="space-y-3">
        {groupOrder.map((groupCode) => {
          const groupItems = groupedChecklists[groupCode];
          if (!groupItems || groupItems.length === 0) return null;

          const isExpanded = expandedGroups.has(groupCode);
          const groupCompleted = groupItems.filter((i) => i.completed).length;
          const groupTotal = groupItems.length;

          return (
            <div key={groupCode} className="bg-white rounded-xl border border-gray-200 overflow-hidden">
              <button
                type="button"
                onClick={() => toggleGroup(groupCode)}
                className="w-full px-4 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
              >
                <div className="flex items-center gap-3">
                  <span className="font-medium text-gray-700">{CHECKLIST_GROUP_LABELS[groupCode]}</span>
                  <span
                    className={`text-xs px-2 py-0.5 rounded-full ${
                      groupCompleted === groupTotal
                        ? "bg-green-100 text-green-700"
                        : "bg-gray-200 text-gray-600"
                    }`}
                  >
                    {groupCompleted}/{groupTotal}
                  </span>
                </div>
                {isExpanded ? (
                  <ChevronUp className="w-4 h-4 text-gray-400" />
                ) : (
                  <ChevronDown className="w-4 h-4 text-gray-400" />
                )}
              </button>

              {isExpanded && (
                <div className="divide-y divide-gray-100">
                  {groupItems.map((item) => {
                    const template = item.template;
                    const requiresFile = template?.requiresFile || false;
                    const hasFiles = item.files && item.files.length > 0;
                    const canComplete = !requiresFile || hasFiles;

                    return (
                      <div key={item.id} className="p-4">
                        <div className="flex items-start gap-3">
                          <button
                            type="button"
                            onClick={() =>
                              handleToggle(
                                item.checklistTemplateId,
                                item.completed,
                                requiresFile,
                                !!hasFiles
                              )
                            }
                            disabled={readOnly || togglingId === item.checklistTemplateId}
                            className={`mt-0.5 shrink-0 ${readOnly ? "cursor-default" : "cursor-pointer"}`}
                          >
                            {togglingId === item.checklistTemplateId ? (
                              <RefreshCw className="w-5 h-5 text-indigo-500 animate-spin" />
                            ) : item.completed ? (
                              <CheckCircle2 className="w-5 h-5 text-green-500" />
                            ) : (
                              <Circle
                                className={`w-5 h-5 ${
                                  !canComplete ? "text-amber-400" : "text-gray-300"
                                }`}
                              />
                            )}
                          </button>

                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 flex-wrap">
                              <span
                                className={`font-medium ${
                                  item.completed ? "text-gray-500 line-through" : "text-gray-800"
                                }`}
                              >
                                {template?.title}
                              </span>

                              {template?.isRequired && (
                                <span className="px-1.5 py-0.5 bg-red-100 text-red-600 text-[10px] rounded font-medium">
                                  –û–ë–Ø–ó.
                                </span>
                              )}

                              {requiresFile && (
                                <span
                                  className={`px-1.5 py-0.5 text-[10px] rounded font-medium flex items-center gap-1 ${
                                    hasFiles
                                      ? "bg-green-100 text-green-700"
                                      : "bg-amber-100 text-amber-700"
                                  }`}
                                >
                                  <Camera className="w-3 h-3" />
                                  {hasFiles ? "–°–∫—Ä–∏–Ω –∑–∞–≥—Ä—É–∂–µ–Ω" : "–ù—É–∂–µ–Ω —Å–∫—Ä–∏–Ω"}
                                </span>
                              )}
                            </div>

                            {template?.description && (
                              <p className="text-sm text-gray-500 mt-1">{template.description}</p>
                            )}

                            {item.completed && item.completedBy && (
                              <p className="text-xs text-gray-400 mt-1">
                                –í—ã–ø–æ–ª–Ω–∏–ª: {item.completedBy.name || item.completedBy.login}
                                {item.completedAt && <> –≤ {new Date(item.completedAt).toLocaleString("ru-RU")}</>}
                              </p>
                            )}

                            {hasFiles && (
                              <div className="mt-3 flex flex-wrap gap-2">
                                {item.files!.map((file) => (
                                  <div
                                    key={file.id}
                                    className="group relative flex items-center gap-2 px-3 py-2 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-colors"
                                  >
                                    {isImageFile(file) ? (
                                      <ImageIcon className="w-4 h-4 text-indigo-500 shrink-0" />
                                    ) : (
                                      <FileText className="w-4 h-4 text-red-500 shrink-0" />
                                    )}

                                    <span
                                      className="text-sm text-gray-700 max-w-[120px] truncate"
                                      title={file.originalName}
                                    >
                                      {file.originalName}
                                    </span>

                                    <div className="flex items-center gap-1 ml-1">
                                      {isImageFile(file) && (
                                        <button
                                          type="button"
                                          onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            dlog("üëÅ Eye button clicked for file:", file.id, file.originalName);
                                            handleOpenPreview(file);
                                          }}
                                          className="p-1 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"
                                          title="–ü—Ä–æ—Å–º–æ—Ç—Ä"
                                        >
                                          <Eye className="w-4 h-4" />
                                        </button>
                                      )}

                                      <button
                                        type="button"
                                        onClick={(e) => {
                                          e.preventDefault();
                                          e.stopPropagation();
                                          dlog("‚¨á Download button clicked for file:", file.id, file.originalName);
                                          handleDownloadFile(file.id, file.originalName);
                                        }}
                                        className="p-1 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded transition-colors"
                                        title="–°–∫–∞—á–∞—Ç—å"
                                      >
                                        <Download className="w-4 h-4" />
                                      </button>

                                      {!readOnly && (
                                        <button
                                          type="button"
                                          onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            handleDeleteFile(file.id, item.completed);
                                          }}
                                          className="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                                          title="–£–¥–∞–ª–∏—Ç—å"
                                        >
                                          <Trash2 className="w-4 h-4" />
                                        </button>
                                      )}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}

                            {requiresFile && !hasFiles && !item.completed && (
                              <div className="mt-2 flex items-center gap-2 text-amber-600 text-sm">
                                <AlertTriangle className="w-4 h-4" />
                                –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞
                              </div>
                            )}
                          </div>

                          {!readOnly && (
                            <button
                              type="button"
                              onClick={() => handleUploadClick(item.checklistTemplateId)}
                              disabled={uploadingId === item.checklistTemplateId}
                              className={`px-3 py-1.5 text-sm rounded-lg flex items-center gap-1.5 transition-colors ${
                                requiresFile && !hasFiles
                                  ? "bg-amber-100 text-amber-700 hover:bg-amber-200"
                                  : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                              }`}
                            >
                              {uploadingId === item.checklistTemplateId ? (
                                <RefreshCw className="w-4 h-4 animate-spin" />
                              ) : (
                                <Upload className="w-4 h-4" />
                              )}
                              –°–∫—Ä–∏–Ω
                            </button>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })}
      </div>

      {previewFile &&
        createPortal(
          <div
            className="fixed inset-0 bg-black/90 flex flex-col"
            style={{ zIndex: 9999 }}
            onClick={handleClosePreview}
          >
            <div
              className="flex items-center justify-between px-4 py-3 bg-black/50 backdrop-blur-sm"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center gap-3 text-white">
                <ImageIcon className="w-5 h-5 text-indigo-400" />
                <div>
                  <p className="font-medium">{previewFile.originalName}</p>
                  <p className="text-sm text-gray-400">{formatFileSize(previewFile.fileSize)}</p>
                </div>
              </div>

              <div className="flex items-center gap-2">
                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleZoomOut();
                  }}
                  disabled={zoom <= 0.5}
                  className="p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-lg transition-colors disabled:opacity-30"
                  title="–£–º–µ–Ω—å—à–∏—Ç—å"
                >
                  <ZoomOut className="w-5 h-5" />
                </button>

                <span className="text-white/70 text-sm min-w-[60px] text-center">
                  {Math.round(zoom * 100)}%
                </span>

                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleZoomIn();
                  }}
                  disabled={zoom >= 3}
                  className="p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-lg transition-colors disabled:opacity-30"
                  title="–£–≤–µ–ª–∏—á–∏—Ç—å"
                >
                  <ZoomIn className="w-5 h-5" />
                </button>

                <div className="w-px h-6 bg-white/20 mx-2" />

                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleRotate();
                  }}
                  className="p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-lg transition-colors"
                  title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å"
                >
                  <RotateCw className="w-5 h-5" />
                </button>

                <div className="w-px h-6 bg-white/20 mx-2" />

                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDownloadFile(previewFile.id, previewFile.originalName);
                  }}
                  className="p-2 text-white/70 hover:text-green-400 hover:bg-green-400/10 rounded-lg transition-colors"
                  title="–°–∫–∞—á–∞—Ç—å"
                >
                  <Download className="w-5 h-5" />
                </button>

                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleClosePreview();
                  }}
                  className="p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-lg transition-colors ml-2"
                  title="–ó–∞–∫—Ä—ã—Ç—å (Esc)"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>
            </div>

            <div
              className="flex-1 flex items-center justify-center overflow-hidden p-4"
              onClick={(e) => e.stopPropagation()}
            >
              {previewLoading && (
                <div className="flex flex-col items-center gap-3 text-white">
                  <Loader2 className="w-10 h-10 animate-spin text-indigo-400" />
                  <span className="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
              )}

              {previewError && (
                <div className="flex flex-col items-center gap-3 text-center">
                  <div className="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center">
                    <X className="w-8 h-8 text-red-400" />
                  </div>
                  <p className="text-white font-medium">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                  <p className="text-gray-400 text-sm">{previewError}</p>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.stopPropagation();
                      handleOpenPreview(previewFile);
                    }}
                    className="mt-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors"
                  >
                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                  </button>
                </div>
              )}

              {previewUrl && !previewLoading && (
                <img
                  src={previewUrl}
                  alt={previewFile.originalName}
                  className="block object-contain select-none"
                  style={{
                    maxWidth: "96vw",
                    maxHeight: "calc(100dvh - 120px)",
                    transform: `scale(${zoom}) rotate(${rotation}deg)`,
                    transformOrigin: "center center"
                  }}
                  draggable={false}
                />
              )}
            </div>

            <div className="text-center py-2 text-gray-500 text-sm bg-black/50">
              –ù–∞–∂–º–∏—Ç–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ –∏–ª–∏ Esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
            </div>
          </div>,
          document.body
        )}
    </div>
  );
};

export default ServerChecklistSection;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/pages/BatchDetailPage.tsx
================================================================================

import { useState, useEffect, useContext } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { observer } from "mobx-react-lite";
import {
  Package,
  ArrowLeft,
  RefreshCw,
  Calendar,
  Building2,
  Server,
  CheckCircle2,
  Clock,
  XCircle,
  HelpCircle,
  Edit,
  Save,
  X,
  Plus,
  Trash2,
  User,
  ExternalLink
} from "lucide-react";
import { Context } from "src/main";
import {
  getBatchById,
  updateBatch,
  getServers,
  assignServersToBatch,
  removeServersFromBatch,
  BeryllBatch,
  BeryllServer,
  ServerStatus,
  BatchStatus,
  STATUS_LABELS,
  STATUS_COLORS,
  BATCH_STATUS_LABELS,
  BATCH_STATUS_COLORS,
  formatDate,
  formatDateTime,
  getStatusProgress
} from "src/api/beryllApi";

export const BatchDetailPage: React.FC = observer(() => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const context = useContext(Context);
  const currentUser = context?.user?.user;

  const [batch, setBatch] = useState<BeryllBatch | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);


  const [editing, setEditing] = useState(false);
  const [formData, setFormData] = useState({
    title: "",
    supplier: "",
    deliveryDate: "",
    expectedCount: 0,
    notes: ""
  });


  const [showAddModal, setShowAddModal] = useState(false);
  const [availableServers, setAvailableServers] = useState<BeryllServer[]>([]);
  const [selectedServersToAdd, setSelectedServersToAdd] = useState<number[]>([]);
  const [loadingServers, setLoadingServers] = useState(false);

  const loadBatch = async () => {
    if (!id) return;
    setLoading(true);
    try {
      const data = await getBatchById(parseInt(id));
      setBatch(data);
      setFormData({
        title: data.title,
        supplier: data.supplier || "",
        deliveryDate: data.deliveryDate || "",
        expectedCount: data.expectedCount || 0,
        notes: data.notes || ""
      });
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
    } finally {
      setLoading(false);
    }
  };

  const loadAvailableServers = async () => {
    setLoadingServers(true);
    try {
      const servers = await getServers({ batchId: "null" });
      setAvailableServers(servers);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤:", e);
    } finally {
      setLoadingServers(false);
    }
  };

  useEffect(() => {
    loadBatch();
  }, [id]);

  const handleSave = async () => {
    if (!batch || !formData.title.trim()) {
      alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏");
      return;
    }

    setSaving(true);
    try {
      await updateBatch(batch.id, formData);
      setEditing(false);
      await loadBatch();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    } finally {
      setSaving(false);
    }
  };

  const handleStatusChange = async (newStatus: BatchStatus) => {
    if (!batch) return;

    if (newStatus === "COMPLETED" && !confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–∞—Ä—Ç–∏—é?")) return;
    if (newStatus === "CANCELLED" && !confirm("–û—Ç–º–µ–Ω–∏—Ç—å –ø–∞—Ä—Ç–∏—é?")) return;

    try {
      await updateBatch(batch.id, { status: newStatus });
      await loadBatch();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };

  const handleAddServers = async () => {
    if (!batch || selectedServersToAdd.length === 0) return;

    try {
      await assignServersToBatch(batch.id, selectedServersToAdd);
      setShowAddModal(false);
      setSelectedServersToAdd([]);
      await loadBatch();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };

  const handleRemoveServer = async (serverId: number) => {
    if (!batch || !confirm("–û—Ç–≤—è–∑–∞—Ç—å —Å–µ—Ä–≤–µ—Ä –æ—Ç –ø–∞—Ä—Ç–∏–∏?")) return;

    try {
      await removeServersFromBatch(batch.id, [serverId]);
      await loadBatch();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };

  const openAddModal = async () => {
    setShowAddModal(true);
    await loadAvailableServers();
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <RefreshCw className="w-8 h-8 animate-spin text-indigo-500" />
      </div>
    );
  }

  if (!batch) {
    return (
      <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center">
        <Package className="w-16 h-16 text-gray-300 mb-4" />
        <p className="text-gray-500 text-lg">–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p>
        <button
          onClick={() => navigate("/beryll")}
          className="mt-4 text-indigo-600 hover:underline"
        >
          –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
        </button>
      </div>
    );
  }

  const progress = getStatusProgress(batch.stats);
  const totalServers = batch.servers?.length || 0;
  const doneServers = batch.stats?.DONE || 0;

  return (
    <div className="min-h-screen bg-gray-50 p-4 lg:p-6">

      <div className="mb-6">
        <button
          onClick={() => navigate("/beryll")}
          className="flex items-center gap-2 text-gray-500 hover:text-gray-700 mb-4"
        >
          <ArrowLeft className="w-4 h-4" />
          –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </button>

        <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-purple-100 rounded-xl">
              <Package className="w-8 h-8 text-purple-600" />
            </div>
            <div>
              <div className="flex items-center gap-3">
                {editing ? (
                  <input
                    type="text"
                    value={formData.title}
                    onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                    className="text-2xl font-bold text-gray-800 border-b-2 border-indigo-500 focus:outline-none bg-transparent"
                  />
                ) : (
                  <h1 className="text-2xl font-bold text-gray-800">
                    {batch.title}
                  </h1>
                )}
                <span className={`px-3 py-1 rounded-full text-sm font-medium ${BATCH_STATUS_COLORS[batch.status]}`}>
                  {BATCH_STATUS_LABELS[batch.status]}
                </span>
              </div>
              {batch.supplier && (
                <p className="text-gray-500 mt-1 flex items-center gap-1">
                  <Building2 className="w-4 h-4" />
                  {batch.supplier}
                </p>
              )}
            </div>
          </div>


          <div className="flex items-center gap-2">
            {editing ? (
              <>
                <button
                  onClick={() => {
                    setEditing(false);
                    setFormData({
                      title: batch.title,
                      supplier: batch.supplier || "",
                      deliveryDate: batch.deliveryDate || "",
                      expectedCount: batch.expectedCount || 0,
                      notes: batch.notes || ""
                    });
                  }}
                  className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
                <button
                  onClick={handleSave}
                  disabled={saving}
                  className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
                >
                  <Save className="w-4 h-4" />
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
              </>
            ) : (
              <>
                <button
                  onClick={() => setEditing(true)}
                  className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                >
                  <Edit className="w-4 h-4" />
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>

                {batch.status === "ACTIVE" && (
                  <button
                    onClick={() => handleStatusChange("COMPLETED")}
                    className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                  >
                    <CheckCircle2 className="w-4 h-4" />
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å
                  </button>
                )}
              </>
            )}
          </div>
        </div>
      </div>

      <div className="grid lg:grid-cols-3 gap-6">

        <div className="lg:col-span-2 space-y-6">

          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-semibold text-gray-800">–ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
              <span className="text-2xl font-bold text-indigo-600">{progress}%</span>
            </div>


            <div className="w-full h-4 bg-gray-100 rounded-full overflow-hidden mb-4">
              <div
                className="h-full bg-gradient-to-r from-indigo-500 to-indigo-600 transition-all duration-500"
                style={{ width: `${progress}%` }}
              />
            </div>


            <div className="grid grid-cols-5 gap-2">
              {Object.entries(STATUS_LABELS).map(([status, label]) => {
                const count = batch.stats?.[status as ServerStatus] || 0;
                return (
                  <div key={status} className={`p-3 rounded-lg text-center ${STATUS_COLORS[status as ServerStatus]}`}>
                    <div className="text-xl font-bold">{count}</div>
                    <div className="text-xs opacity-80">{label}</div>
                  </div>
                );
              })}
            </div>
          </div>


          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div className="p-4 border-b border-gray-100 flex items-center justify-between">
              <h2 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
                <Server className="w-5 h-5 text-gray-400" />
                –°–µ—Ä–≤–µ—Ä—ã ({totalServers})
              </h2>

              {batch.status === "ACTIVE" && (
                <button
                  onClick={openAddModal}
                  className="flex items-center gap-1 px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                >
                  <Plus className="w-4 h-4" />
                  –î–æ–±–∞–≤–∏—Ç—å
                </button>
              )}
            </div>

            {!batch.servers || batch.servers.length === 0 ? (
              <div className="text-center py-12 text-gray-400">
                <Server className="w-12 h-12 mx-auto mb-3 opacity-50" />
                <p>–°–µ—Ä–≤–µ—Ä—ã –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã</p>
                {batch.status === "ACTIVE" && (
                  <button
                    onClick={openAddModal}
                    className="mt-4 text-indigo-600 hover:underline"
                  >
                    –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—ã
                  </button>
                )}
              </div>
            ) : (
              <div className="divide-y divide-gray-100 max-h-96 overflow-y-auto">
                {batch.servers.map((server) => (
                  <div
                    key={server.id}
                    className="p-4 hover:bg-gray-50 flex items-center justify-between"
                  >
                    <div className="flex items-center gap-4">
                      <span className={`w-2 h-2 rounded-full ${
                        server.status === "DONE" ? "bg-green-500" :
                        server.status === "IN_WORK" ? "bg-blue-500" :
                        server.status === "DEFECT" ? "bg-red-500" :
                        "bg-gray-300"
                      }`} />

                      <div>
                        <button
                          onClick={() => navigate(`/beryll/server/${server.id}`)}
                          className="font-mono font-medium text-indigo-600 hover:underline"
                        >
                          {server.ipAddress}
                        </button>
                        {server.hostname && (
                          <div className="text-xs text-gray-500 font-mono">
                            {server.hostname}
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="flex items-center gap-4">
                      <span className={`px-2 py-0.5 rounded text-xs font-medium ${STATUS_COLORS[server.status]}`}>
                        {STATUS_LABELS[server.status]}
                      </span>

                      {server.assignedTo && (
                        <span className="text-xs text-gray-500 flex items-center gap-1">
                          <User className="w-3 h-3" />
                          {server.assignedTo.surname}
                        </span>
                      )}

                      <div className="flex items-center gap-1">
                        <button
                          onClick={() => navigate(`/beryll/server/${server.id}`)}
                          className="p-1 text-gray-400 hover:text-indigo-600"
                        >
                          <ExternalLink className="w-4 h-4" />
                        </button>

                        {batch.status === "ACTIVE" && (
                          <button
                            onClick={() => handleRemoveServer(server.id)}
                            className="p-1 text-gray-400 hover:text-red-600"
                          >
                            <X className="w-4 h-4" />
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>


        <div className="space-y-6">

          <div className="bg-white rounded-xl border border-gray-200 p-4 space-y-4">
            <h3 className="font-semibold text-gray-800">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>


            <div>
              <label className="block text-xs text-gray-500 mb-1">–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏</label>
              {editing ? (
                <input
                  type="date"
                  value={formData.deliveryDate}
                  onChange={(e) => setFormData({ ...formData, deliveryDate: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                />
              ) : (
                <div className="flex items-center gap-2 text-gray-800">
                  <Calendar className="w-4 h-4 text-gray-400" />
                  {batch.deliveryDate ? formatDate(batch.deliveryDate) : "-"}
                </div>
              )}
            </div>


            <div>
              <label className="block text-xs text-gray-500 mb-1">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
              {editing ? (
                <input
                  type="text"
                  value={formData.supplier}
                  onChange={(e) => setFormData({ ...formData, supplier: e.target.value })}
                  placeholder="–û–û–û –í–µ–≥–º–∞–Ω"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                />
              ) : (
                <div className="flex items-center gap-2 text-gray-800">
                  <Building2 className="w-4 h-4 text-gray-400" />
                  {batch.supplier || "-"}
                </div>
              )}
            </div>


            <div>
              <label className="block text-xs text-gray-500 mb-1">–û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª-–≤–æ</label>
              {editing ? (
                <input
                  type="number"
                  value={formData.expectedCount}
                  onChange={(e) => setFormData({ ...formData, expectedCount: parseInt(e.target.value) || 0 })}
                  min="0"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                />
              ) : (
                <div className="text-gray-800">
                  {batch.expectedCount || "-"}
                  {batch.expectedCount && totalServers > 0 && (
                    <span className="text-sm text-gray-500 ml-2">
                      (—Ñ–∞–∫—Ç: {totalServers})
                    </span>
                  )}
                </div>
              )}
            </div>


            {batch.createdBy && (
              <div>
                <label className="block text-xs text-gray-500 mb-1">–°–æ–∑–¥–∞–ª</label>
                <div className="text-gray-800">
                  {batch.createdBy.surname} {batch.createdBy.name}
                </div>
              </div>
            )}


            <div className="pt-4 border-t border-gray-100 space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-500">–°–æ–∑–¥–∞–Ω–∞</span>
                <span className="text-gray-800">{formatDateTime(batch.createdAt)}</span>
              </div>
              {batch.completedAt && (
                <div className="flex justify-between">
                  <span className="text-gray-500">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                  <span className="text-gray-800">{formatDateTime(batch.completedAt)}</span>
                </div>
              )}
            </div>
          </div>


          <div className="bg-white rounded-xl border border-gray-200 p-4">
            <h3 className="font-semibold text-gray-800 mb-3">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</h3>
            {editing ? (
              <textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                rows={4}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none"
                placeholder="–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ..."
              />
            ) : (
              <p className={`text-sm ${batch.notes ? "text-gray-600" : "text-gray-400 italic"}`}>
                {batch.notes || "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"}
              </p>
            )}
          </div>
        </div>
      </div>


      {showAddModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl">
            <div className="p-4 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-800">
                –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—ã –≤ –ø–∞—Ä—Ç–∏—é
              </h3>
              <p className="text-sm text-gray-500">
                –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä—ã –±–µ–∑ –ø–∞—Ä—Ç–∏–∏
              </p>
            </div>

            <div className="p-4 max-h-96 overflow-y-auto">
              {loadingServers ? (
                <div className="flex items-center justify-center py-8">
                  <RefreshCw className="w-6 h-6 animate-spin text-indigo-500" />
                </div>
              ) : availableServers.length === 0 ? (
                <p className="text-center text-gray-400 py-8">
                  –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
                </p>
              ) : (
                <div className="space-y-2">
                  {availableServers.map(server => (
                    <label
                      key={server.id}
                      className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors ${
                        selectedServersToAdd.includes(server.id)
                          ? "border-indigo-500 bg-indigo-50"
                          : "border-gray-200 hover:border-gray-300"
                      }`}
                    >
                      <input
                        type="checkbox"
                        checked={selectedServersToAdd.includes(server.id)}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setSelectedServersToAdd([...selectedServersToAdd, server.id]);
                          } else {
                            setSelectedServersToAdd(selectedServersToAdd.filter(id => id !== server.id));
                          }
                        }}
                        className="rounded border-gray-300"
                      />
                      <div className="flex-1">
                        <div className="font-mono font-medium text-gray-800">
                          {server.ipAddress}
                        </div>
                        {server.hostname && (
                          <div className="text-xs text-gray-500">{server.hostname}</div>
                        )}
                      </div>
                      <span className={`px-2 py-0.5 rounded text-xs ${STATUS_COLORS[server.status]}`}>
                        {STATUS_LABELS[server.status]}
                      </span>
                    </label>
                  ))}
                </div>
              )}
            </div>

            <div className="p-4 border-t border-gray-200 flex items-center justify-between">
              <span className="text-sm text-gray-500">
                –í—ã–±—Ä–∞–Ω–æ: {selectedServersToAdd.length}
              </span>
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    setShowAddModal(false);
                    setSelectedServersToAdd([]);
                  }}
                  className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
                <button
                  onClick={handleAddServers}
                  disabled={selectedServersToAdd.length === 0}
                  className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
                >
                  –î–æ–±–∞–≤–∏—Ç—å
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
});

export default BatchDetailPage;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/pages/ServerDetailPage.tsx
================================================================================

import { useState, useEffect, useContext, useRef } from "react";
import { createPortal } from "react-dom";
import { useParams, useNavigate } from "react-router-dom";
import { observer } from "mobx-react-lite";
import {
  Server,
  ArrowLeft,
  RefreshCw,
  Copy,
  Clock,
  User,
  CheckCircle2,
  XCircle,
  HelpCircle,
  Play,
  Square,
  Package,
  History,
  FileText,
  MessageSquare,
  Edit,
  Save,
  Network,
  Calendar,
  ArrowRight,
  ChevronDown,
  ChevronUp,
  Archive,
  FileSpreadsheet,
  Upload,
  Download,
  Tag,
  Camera,
  Image,
  Trash2,
  Eye,
  X,
  AlertCircle,
  File as FileIcon,
  Loader2,
  RotateCcw,
  UserMinus
} from "lucide-react";
import toast from "react-hot-toast";
import { Context } from "src/main";
import {
  getServerById,
  takeServer,
  releaseServer,
  updateServerStatus,
  updateServerNotes,
  toggleChecklistItem,
  updateApkSerialNumber,
  archiveServer,
  generatePassport,
  uploadChecklistFile,
  deleteChecklistFile,
  downloadFile,
  BeryllServer,
  BeryllServerChecklist,
  BeryllChecklistFile,
  ServerStatus,
  ChecklistGroup,
  STATUS_LABELS,
  STATUS_COLORS,
  HISTORY_ACTION_LABELS,
  CHECKLIST_GROUP_LABELS,
  formatDateTime,
  formatDuration
} from "src/api/beryllApi";
import { $authHost } from "src/api/index";

import { DefectComments } from '../../../components/beryll/DefectComments';
import ServerComponentsManager from '../../../components/beryll/ServerComponentsManager';


export const ServerDetailPage: React.FC = observer(() => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const context = useContext(Context);
  const currentUser = context?.user?.user;

  const [server, setServer] = useState<BeryllServer | null>(null);
  const [loading, setLoading] = useState(true);
  const [actionLoading, setActionLoading] = useState(false);


  const [editingNotes, setEditingNotes] = useState(false);
  const [notes, setNotes] = useState("");


  const [editingApkSerial, setEditingApkSerial] = useState(false);
  const [apkSerial, setApkSerial] = useState("");


  const [showChecklist, setShowChecklist] = useState(true);
  const [showHistory, setShowHistory] = useState(true);


  const fileInputRef = useRef<HTMLInputElement>(null);
  const [uploadingChecklistId, setUploadingChecklistId] = useState<number | null>(null);


  const [previewImage, setPreviewImage] = useState<string | null>(null);
  const [previewLoading, setPreviewLoading] = useState(false);


  const [uploadModal, setUploadModal] = useState<{
    open: boolean;
    checklistId: number | null;
    checklistTitle: string;
    file: File | null;
    preview: string | null;
    fileName: string;
  }>({
    open: false,
    checklistId: null,
    checklistTitle: "",
    file: null,
    preview: null,
    fileName: ""
  });


  const isSuperAdmin = currentUser?.role === "SUPER_ADMIN";

  const loadServer = async () => {
    if (!id) return;
    setLoading(true);
    try {
      const data = await getServerById(parseInt(id));
      setServer(data);
      setNotes(data.notes || "");
      setApkSerial(data.apkSerialNumber || "");
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadServer();
  }, [id]);


  useEffect(() => {
    return () => {
      if (previewImage) {
        URL.revokeObjectURL(previewImage);
      }
    };
  }, []);


  useEffect(() => {
    if (previewImage || previewLoading || uploadModal.open) {
      document.body.style.overflow = "hidden";
    } else {
      document.body.style.overflow = "";
    }
    return () => {
      document.body.style.overflow = "";
    };
  }, [previewImage, previewLoading, uploadModal.open]);


  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        if (previewImage) {
          handleClosePreview();
        } else if (uploadModal.open) {
          closeUploadModal();
        }
      }
    };

    document.addEventListener("keydown", handleKeyDown);
    return () => document.removeEventListener("keydown", handleKeyDown);
  }, [previewImage, uploadModal.open]);


  const handleTake = async () => {
    if (!server) return;
    setActionLoading(true);
    try {
      await takeServer(server.id);
      await loadServer();
      toast.success("–°–µ—Ä–≤–µ—Ä –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setActionLoading(false);
    }
  };


  const handleReturnToWork = async () => {
    if (!server) return;
    setActionLoading(true);
    try {
      await takeServer(server.id);
      await loadServer();
      toast.success("–°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ —Ä–∞–±–æ—Ç—É");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setActionLoading(false);
    }
  };


  const handleRelease = async () => {
    if (!server) return;
    setActionLoading(true);
    try {
      await releaseServer(server.id);
      await loadServer();
      toast.success("–°–µ—Ä–≤–µ—Ä –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setActionLoading(false);
    }
  };


  const handleForceRelease = async () => {
    if (!server) return;
    const assigneeName = server.assignedTo
      ? `${server.assignedTo.surname} ${server.assignedTo.name}`
      : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";

    if (!confirm(`–°–Ω—è—Ç—å —Å–µ—Ä–≤–µ—Ä —Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è ${assigneeName}?`)) {
      return;
    }

    setActionLoading(true);
    try {
      await releaseServer(server.id);
      await loadServer();
      toast.success("–°–µ—Ä–≤–µ—Ä —Å–Ω—è—Ç —Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setActionLoading(false);
    }
  };

  const handleStatusChange = async (status: ServerStatus) => {
    if (!server) return;
    setActionLoading(true);
    try {
      await updateServerStatus(server.id, status);
      await loadServer();
      toast.success(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ "${STATUS_LABELS[status]}"`);
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setActionLoading(false);
    }
  };

  const handleSaveNotes = async () => {
    if (!server) return;
    try {
      await updateServerNotes(server.id, notes);
      setEditingNotes(false);
      await loadServer();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };

  const handleToggleChecklist = async (checklistId: number, completed: boolean, requiresFile: boolean, hasFiles: boolean) => {
    if (!server) return;


    if (completed && requiresFile && !hasFiles) {
      toast.error("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞");
      return;
    }

    try {
      await toggleChecklistItem(server.id, checklistId, completed);
      await loadServer();
      toast.success(completed ? "–≠—Ç–∞–ø –≤—ã–ø–æ–ª–Ω–µ–Ω" : "–û—Ç–º–µ—Ç–∫–∞ —Å–Ω—è—Ç–∞");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };


  const handleSaveApkSerial = async () => {
    if (!server) return;
    if (!apkSerial.trim()) {
      alert("–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ê–ü–ö");
      return;
    }
    try {
      await updateApkSerialNumber(server.id, apkSerial.trim());
      setEditingApkSerial(false);
      await loadServer();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ä–∏–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞");
    }
  };


  const handleArchive = async () => {
    if (!server) return;
    if (!server.apkSerialNumber) {
      alert("–ü–µ—Ä–µ–¥ –∞—Ä—Ö–∏–≤–∞—Ü–∏–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏—Å–≤–æ–∏—Ç—å —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ê–ü–ö");
      return;
    }
    if (!confirm(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä ${server.apkSerialNumber} –≤ –∞—Ä—Ö–∏–≤?`)) return;

    setActionLoading(true);
    try {
      await archiveServer(server.id);
      await loadServer();
      alert("–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ –∞—Ä—Ö–∏–≤");
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏");
    } finally {
      setActionLoading(false);
    }
  };


  const handleDownloadPassport = async () => {
    if (!server) return;
    try {
      const blob = await generatePassport(server.id);
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `–ü–∞—Å–ø–æ—Ä—Ç_${server.apkSerialNumber || server.id}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞");
    }
  };


  const handleUploadClick = (checklistTemplateId: number, checklistTitle: string) => {
    setUploadingChecklistId(checklistTemplateId);


    const now = new Date();
    const defaultName = `${checklistTitle.replace(/[^a-z–∞-—è—ë0-9]/gi, "_")}_${now.toLocaleDateString("ru-RU").replace(/\./g, "-")}`;

    setUploadModal({
      open: true,
      checklistId: checklistTemplateId,
      checklistTitle,
      file: null,
      preview: null,
      fileName: defaultName
    });
  };


  const handleSelectFile = () => {
    fileInputRef.current?.click();
  };


  const openUploadModal = (checklistId: number, checklistTitle: string, file: File) => {
    const preview = file.type.startsWith("image/")
      ? URL.createObjectURL(file)
      : null;


    const now = new Date();
    const defaultName = `${checklistTitle.replace(/[^a-z–∞-—è—ë0-9]/gi, "_")}_${now.toLocaleDateString("ru-RU").replace(/\./g, "-")}`;

    setUploadModal({
      open: true,
      checklistId,
      checklistTitle,
      file,
      preview,
      fileName: defaultName
    });
  };


  const setFileToModal = (file: File) => {
    const preview = file.type.startsWith("image/")
      ? URL.createObjectURL(file)
      : null;


    if (uploadModal.preview) {
      URL.revokeObjectURL(uploadModal.preview);
    }

    setUploadModal(prev => ({
      ...prev,
      file,
      preview
    }));
  };


  const closeUploadModal = () => {
    if (uploadModal.preview) {
      URL.revokeObjectURL(uploadModal.preview);
    }
    setUploadModal({
      open: false,
      checklistId: null,
      checklistTitle: "",
      file: null,
      preview: null,
      fileName: ""
    });
    setUploadingChecklistId(null);
    if (fileInputRef.current) {
      fileInputRef.current.value = "";
    }
  };


  const confirmUpload = async () => {
    console.log("confirmUpload called", {
      server: !!server,
      file: uploadModal.file,
      checklistId: uploadModal.checklistId,
      fileName: uploadModal.fileName
    });

    if (!server || !uploadModal.file || !uploadModal.checklistId) {
      console.log("Missing required data", { server: !!server, file: !!uploadModal.file, checklistId: uploadModal.checklistId });
      toast.error("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω");
      return;
    }

    try {

      const ext = uploadModal.file.name.split(".").pop() || "png";
      const newFileName = `${uploadModal.fileName}.${ext}`;
      const renamedFile = new File([uploadModal.file], newFileName, { type: uploadModal.file.type });

      console.log("Uploading file:", {
        serverId: server.id,
        checklistId: uploadModal.checklistId,
        fileName: newFileName,
        fileType: renamedFile.type,
        fileSize: renamedFile.size
      });

      await uploadChecklistFile(server.id, uploadModal.checklistId, renamedFile);
      toast.success("–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω");
      closeUploadModal();
      await loadServer();
    } catch (e: any) {
      console.error("Upload error:", e);
      console.error("Error response:", e.response);
      toast.error(e.response?.data?.message || e.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞");
    }
  };


  useEffect(() => {
    const handlePaste = (e: ClipboardEvent) => {

      if (!uploadModal.open) return;


      const activeEl = document.activeElement;
      if (activeEl?.tagName === "INPUT" && (activeEl as HTMLInputElement).type === "text") {
        return;
      }

      const items = e.clipboardData?.items;
      if (!items) return;

      for (const item of items) {
        if (item.type.startsWith("image/")) {
          e.preventDefault();
          const file = item.getAsFile();
          if (file) {
            setFileToModal(file);
            toast.success("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ –∏–∑ –±—É—Ñ–µ—Ä–∞");
          }
          break;
        }
      }
    };

    document.addEventListener("paste", handlePaste);
    return () => document.removeEventListener("paste", handlePaste);
  }, [uploadModal.open, uploadModal.preview]);


  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;


    const allowedTypes = ["image/jpeg", "image/png", "image/gif", "image/webp", "application/pdf"];
    if (!allowedTypes.includes(file.type)) {
      toast.error("–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, PNG, GIF, WEBP) –∏ PDF");
      return;
    }


    if (file.size > 5 * 1024 * 1024) {
      toast.error("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ 5 –ú–ë");
      return;
    }

    setFileToModal(file);


    if (fileInputRef.current) {
      fileInputRef.current.value = "";
    }
  };


  const handleDeleteFile = async (fileId: number) => {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?")) return;

    try {
      await deleteChecklistFile(fileId);
      toast.success("–§–∞–π–ª —É–¥–∞–ª—ë–Ω");
      await loadServer();
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    }
  };


  const handleViewFile = async (fileId: number, mimetype?: string, originalName?: string) => {

    const isImage = mimetype?.startsWith("image/") ||
      (originalName && ["jpg", "jpeg", "png", "gif", "webp"].some(ext =>
        originalName.toLowerCase().endsWith(`.${ext}`)
      ));

    console.log("handleViewFile:", { fileId, mimetype, originalName, isImage });

    if (isImage) {

      if (previewImage) {
        URL.revokeObjectURL(previewImage);
        setPreviewImage(null);
      }

      setPreviewLoading(true);

      try {
        const response = await $authHost.get(`/api/beryll/files/${fileId}`, {
          responseType: 'blob'
        });
        const url = URL.createObjectURL(response.data);
        setPreviewImage(url);
      } catch (e: any) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", e);
        toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
      } finally {
        setPreviewLoading(false);
      }
    } else {

      try {
        const response = await $authHost.get(`/api/beryll/files/${fileId}`, {
          responseType: 'blob'
        });
        const url = URL.createObjectURL(response.data);
        window.open(url, "_blank");

        setTimeout(() => URL.revokeObjectURL(url), 1000);
      } catch (e: any) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", e);
        toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª");
      }
    }
  };


  const handleClosePreview = () => {
    if (previewImage) {
      URL.revokeObjectURL(previewImage);
    }
    setPreviewImage(null);
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast.success("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
  };

  const getStatusIcon = (status: ServerStatus) => {
    switch (status) {
      case "NEW": return <Clock className="w-4 h-4" />;
      case "IN_WORK": return <RefreshCw className="w-4 h-4" />;
      case "CLARIFYING": return <HelpCircle className="w-4 h-4" />;
      case "DEFECT": return <XCircle className="w-4 h-4" />;
      case "DONE": return <CheckCircle2 className="w-4 h-4" />;
      case "ARCHIVED": return <Archive className="w-4 h-4" />;
    }
  };

  const calculateWorkTime = () => {
    if (!server?.assignedAt) return null;
    const start = new Date(server.assignedAt);
    const end = server.completedAt ? new Date(server.completedAt) : new Date();
    return Math.round((end.getTime() - start.getTime()) / (1000 * 60));
  };


  const groupedChecklists = () => {
    if (!server?.checklists) return {};

    const groups: Record<string, BeryllServerChecklist[]> = {};

    server.checklists
      .sort((a, b) => (a.template?.sortOrder || 0) - (b.template?.sortOrder || 0))
      .forEach(item => {
        const groupCode = item.template?.groupCode || "OTHER";
        if (!groups[groupCode]) {
          groups[groupCode] = [];
        }
        groups[groupCode].push(item);
      });

    return groups;
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <RefreshCw className="w-8 h-8 animate-spin text-indigo-500" />
      </div>
    );
  }

  if (!server) {
    return (
      <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center">
        <Server className="w-16 h-16 text-gray-300 mb-4" />
        <p className="text-gray-500 text-lg">–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
        <button
          onClick={() => navigate("/beryll")}
          className="mt-4 text-indigo-600 hover:underline"
        >
          –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
        </button>
      </div>
    );
  }

  const workTime = calculateWorkTime();
  const isAssignedToMe = server.assignedToId === currentUser?.id;
  const canWork = server.status === "IN_WORK" && isAssignedToMe;


  const canReturnToWork = (server.status === "CLARIFYING" || server.status === "DEFECT") && isAssignedToMe;


  const canForceRelease = isSuperAdmin && server.assignedToId && server.assignedToId !== currentUser?.id;


  const canSuperAdminReturnToWork = isSuperAdmin &&
    (server.status === "CLARIFYING" || server.status === "DEFECT") &&
    server.assignedToId &&
    server.assignedToId !== currentUser?.id;


  const checklistTotal = server.checklists?.length || 0;
  const checklistCompleted = server.checklists?.filter(c => c.completed).length || 0;
  const groups = groupedChecklists();

  return (
    <div className="min-h-screen bg-gray-50 p-4 lg:p-6">

      <input
        ref={fileInputRef}
        type="file"
        accept="image/*,application/pdf"
        onChange={handleFileChange}
        className="hidden"
      />


      {(previewImage || previewLoading) && createPortal(
        <div
          className="fixed inset-0 bg-black/90 flex items-center justify-center"
          style={{ zIndex: 9999 }}
          onClick={handleClosePreview}
        >

          <div
            className="absolute top-0 left-0 right-0 flex items-center justify-between px-6 py-4 bg-gradient-to-b from-black/70 to-transparent"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="text-white">
              <p className="text-sm opacity-70">–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–∫—Ä–∏–Ω—à–æ—Ç–∞</p>
              <p className="text-xs opacity-50 mt-1">
                –ù–∞–∂–º–∏—Ç–µ <kbd className="px-1.5 py-0.5 bg-white/20 rounded text-xs">ESC</kbd> –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
              </p>
            </div>


            <button
              onClick={handleClosePreview}
              className="flex items-center gap-2 px-4 py-2.5 bg-white/10 hover:bg-white/20
                         backdrop-blur-sm rounded-lg text-white transition-all duration-200
                         border border-white/20 hover:border-white/40"
            >
              <X className="w-5 h-5" />
              <span className="font-medium">–ó–∞–∫—Ä—ã—Ç—å</span>
            </button>
          </div>


          <div className="flex items-center justify-center p-8 max-w-[90vw] max-h-[85vh]">
            {previewLoading ? (
              <div className="flex flex-col items-center gap-4 text-white">
                <Loader2 className="w-12 h-12 animate-spin text-indigo-400" />
                <span className="text-gray-300">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</span>
              </div>
            ) : previewImage ? (
              <img
                src={previewImage}
                alt="Preview"
                className="max-w-full max-h-[80vh] object-contain rounded-xl shadow-2xl"
                onClick={(e) => e.stopPropagation()}
              />
            ) : null}
          </div>


          <div
            className="absolute bottom-0 left-0 right-0 flex justify-center py-6 bg-gradient-to-t from-black/70 to-transparent"
            onClick={(e) => e.stopPropagation()}
          >
            <button
              onClick={handleClosePreview}
              className="px-6 py-3 bg-white/10 hover:bg-white/20 backdrop-blur-sm
                         rounded-xl text-white font-medium transition-all duration-200
                         border border-white/20 hover:border-white/40
                         flex items-center gap-2"
            >
              <X className="w-5 h-5" />
              –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä
            </button>
          </div>
        </div>,
        document.body
      )}


      {uploadModal.open && createPortal(
        <div
          className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4"
          style={{ zIndex: 9999 }}
          onClick={closeUploadModal}
        >
          <div
            className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col"
            onClick={(e) => e.stopPropagation()}
          >

            <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
              <div>
                <h3 className="text-xl font-semibold text-gray-800">
                  –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
                </h3>
                <p className="text-sm text-gray-500 mt-0.5">
                  –ù–∞–∂–º–∏—Ç–µ <kbd className="px-1.5 py-0.5 bg-gray-200 rounded text-xs font-mono">ESC</kbd> –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
                </p>
              </div>


              <button
                onClick={closeUploadModal}
                className="flex items-center gap-2 px-4 py-2.5 bg-gray-200 hover:bg-gray-300
                           rounded-lg text-gray-700 transition-all duration-200"
              >
                <X className="w-5 h-5" />
                <span className="font-medium">–ó–∞–∫—Ä—ã—Ç—å</span>
              </button>
            </div>


            <div className="flex-1 overflow-y-auto p-6">

              <div className="mb-6 p-4 bg-amber-50 rounded-xl border border-amber-200">
                <p className="text-amber-800">
                  <span className="font-semibold">–≠—Ç–∞–ø:</span> {uploadModal.checklistTitle}
                </p>
              </div>


              {!uploadModal.file ? (
                <div className="mb-6">
                  <div
                    className="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center
                               hover:border-indigo-400 hover:bg-indigo-50/50 transition-all duration-200 cursor-pointer"
                    onClick={handleSelectFile}
                  >
                    <Camera className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <p className="text-lg text-gray-700 font-medium mb-2">
                      –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∏–∑ –±—É—Ñ–µ—Ä–∞
                    </p>
                    <p className="text-sm text-gray-500 mb-4">
                      –ù–∞–∂–º–∏—Ç–µ —Å—é–¥–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <kbd className="px-2 py-1 bg-gray-100 rounded text-xs font-mono border">Ctrl+V</kbd>
                    </p>
                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        handleSelectFile();
                      }}
                      className="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700
                                 transition-colors font-medium shadow-lg hover:shadow-xl"
                    >
                      –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                    </button>
                  </div>
                  <p className="mt-3 text-sm text-gray-500 text-center">
                    JPG, PNG, GIF, WEBP –∏–ª–∏ PDF ‚Ä¢ –¥–æ 5 –ú–ë
                  </p>
                </div>
              ) : (
                <>

                  {uploadModal.preview && (
                    <div className="mb-6 border border-gray-200 rounded-xl overflow-hidden bg-gray-100 relative group">
                      <img
                        src={uploadModal.preview}
                        alt="Preview"
                        className="max-h-80 w-full object-contain"
                      />
                      <button
                        onClick={() => setUploadModal(prev => ({ ...prev, file: null, preview: null }))}
                        className="absolute top-3 right-3 p-2 bg-red-500 text-white rounded-lg
                                   opacity-0 group-hover:opacity-100 transition-opacity shadow-lg"
                        title="–£–¥–∞–ª–∏—Ç—å"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                  )}


                  {uploadModal.file && !uploadModal.preview && (
                    <div className="mb-6 p-5 border border-gray-200 rounded-xl bg-gray-50 flex items-center gap-4 relative group">
                      <FileIcon className="w-10 h-10 text-red-500" />
                      <div className="flex-1">
                        <p className="font-medium text-gray-800 text-lg">{uploadModal.file.name}</p>
                        <p className="text-sm text-gray-500">
                          {(uploadModal.file.size / 1024).toFixed(1)} –ö–ë
                        </p>
                      </div>
                      <button
                        onClick={() => setUploadModal(prev => ({ ...prev, file: null, preview: null }))}
                        className="p-2 bg-red-500 text-white rounded-lg opacity-0 group-hover:opacity-100
                                   transition-opacity shadow-lg"
                        title="–£–¥–∞–ª–∏—Ç—å"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                  )}


                  <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                    </label>
                    <input
                      type="text"
                      value={uploadModal.fileName}
                      onChange={(e) => setUploadModal(prev => ({ ...prev, fileName: e.target.value }))}
                      placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl text-lg
                                 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                      onKeyDown={(e) => {
                        if (e.key === "Enter" && uploadModal.file) {
                          confirmUpload();
                        }
                      }}
                    />
                    <p className="mt-2 text-sm text-gray-500">
                      –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    </p>
                  </div>
                </>
              )}
            </div>


            <div className="flex justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
              <button
                onClick={closeUploadModal}
                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300
                           transition-colors font-medium"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={confirmUpload}
                disabled={!uploadModal.file || !uploadModal.fileName.trim()}
                className="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700
                           transition-colors font-medium shadow-lg disabled:opacity-50
                           disabled:cursor-not-allowed flex items-center gap-2"
              >
                <Upload className="w-5 h-5" />
                –ó–∞–≥—Ä—É–∑–∏—Ç—å
              </button>
            </div>
          </div>
        </div>,
        document.body
      )}


      <div className="mb-6">
        <button
          onClick={() => navigate("/beryll")}
          className="flex items-center gap-2 text-gray-500 hover:text-gray-700 mb-4"
        >
          <ArrowLeft className="w-4 h-4" />
          –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </button>

        <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-indigo-100 rounded-xl">
              <Server className="w-8 h-8 text-indigo-600" />
            </div>
            <div>
              <div className="flex items-center gap-3">
                <h1 className="text-2xl font-bold text-gray-800">
                  {server.ipAddress}
                </h1>
                <button
                  onClick={() => copyToClipboard(server.ipAddress!)}
                  className="p-1 text-gray-400 hover:text-gray-600"
                  title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å IP"
                >
                  <Copy className="w-4 h-4" />
                </button>
                <span className={`px-3 py-1 rounded-full text-sm font-medium flex items-center gap-1.5 ${STATUS_COLORS[server.status]}`}>
                  {getStatusIcon(server.status)}
                  {STATUS_LABELS[server.status]}
                </span>
              </div>
              {server.hostname && (
                <p className="text-gray-500 mt-1 font-mono text-sm">
                  {server.hostname}
                </p>
              )}
            </div>
          </div>


          <div className="flex flex-wrap items-center gap-2">


            {server.status === "NEW" && (
              <button
                onClick={handleTake}
                disabled={actionLoading}
                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
              >
                <Play className="w-4 h-4" />
                –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
              </button>
            )}


            {canReturnToWork && (
              <button
                onClick={handleReturnToWork}
                disabled={actionLoading}
                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
              >
                <RotateCcw className="w-4 h-4" />
                –í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É
              </button>
            )}


            {canSuperAdminReturnToWork && (
              <button
                onClick={handleTake}
                disabled={actionLoading}
                className="flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:opacity-50"
                title={`–ó–∞–±—Ä–∞—Ç—å —Å–µ—Ä–≤–µ—Ä —É ${server.assignedTo?.surname} ${server.assignedTo?.name} –∏ –≤–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É`}
              >
                <RotateCcw className="w-4 h-4" />
                –ó–∞–±—Ä–∞—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É
              </button>
            )}


            {canWork && (
              <>
                <button
                  onClick={handleRelease}
                  disabled={actionLoading}
                  className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                >
                  <Square className="w-4 h-4" />
                  –û—Ç–ø—É—Å—Ç–∏—Ç—å
                </button>
                <button
                  onClick={() => handleStatusChange("DONE")}
                  disabled={actionLoading}
                  className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                >
                  <CheckCircle2 className="w-4 h-4" />
                  –ó–∞–≤–µ—Ä—à–∏—Ç—å
                </button>
              </>
            )}


            {canForceRelease && (
              <button
                onClick={handleForceRelease}
                disabled={actionLoading}
                className="flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 border border-red-200"
                title={`–°–Ω—è—Ç—å —Å–µ—Ä–≤–µ—Ä —Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è ${server.assignedTo?.surname} ${server.assignedTo?.name}`}
              >
                <UserMinus className="w-4 h-4" />
                –°–Ω—è—Ç—å —Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
              </button>
            )}

            <button
              onClick={handleDownloadPassport}
              className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
              title="–°–∫–∞—á–∞—Ç—å –ø–∞—Å–ø–æ—Ä—Ç"
            >
              <FileSpreadsheet className="w-4 h-4" />
              –ü–∞—Å–ø–æ—Ä—Ç
            </button>

            {server.status === "DONE" && (
              <button
                onClick={handleArchive}
                disabled={actionLoading || !server.apkSerialNumber}
                className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50"
                title={!server.apkSerialNumber ? "–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ê–ü–ö" : "–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –∞—Ä—Ö–∏–≤"}
              >
                <Archive className="w-4 h-4" />
                –í –∞—Ä—Ö–∏–≤
              </button>
            )}
          </div>
        </div>
      </div>

      <div className="grid lg:grid-cols-3 gap-6">

        <div className="lg:col-span-2 space-y-6">

          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <h2 className="text-lg font-semibold text-gray-800 mb-4">
              –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ
            </h2>


            <div className="mb-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Tag className="w-5 h-5 text-purple-600" />
                  <span className="font-medium text-purple-800">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ê–ü–ö</span>
                </div>
                {!editingApkSerial ? (
                  <button
                    onClick={() => setEditingApkSerial(true)}
                    className="text-sm text-purple-600 hover:underline"
                  >
                    {server.apkSerialNumber ? "–ò–∑–º–µ–Ω–∏—Ç—å" : "–ü—Ä–∏—Å–≤–æ–∏—Ç—å"}
                  </button>
                ) : null}
              </div>

              {editingApkSerial ? (
                <div className="mt-2 flex gap-2">
                  <input
                    type="text"
                    value={apkSerial}
                    onChange={(e) => setApkSerial(e.target.value)}
                    placeholder="BL020XX-2500XX"
                    className="flex-1 px-3 py-2 border border-purple-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-purple-500"
                  />
                  <button
                    onClick={handleSaveApkSerial}
                    className="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                  >
                    <Save className="w-4 h-4" />
                  </button>
                  <button
                    onClick={() => {
                      setEditingApkSerial(false);
                      setApkSerial(server.apkSerialNumber || "");
                    }}
                    className="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              ) : (
                <div className="mt-1 flex items-center gap-2">
                  {server.apkSerialNumber ? (
                    <>
                      <span className="text-xl font-bold font-mono text-purple-700">
                        {server.apkSerialNumber}
                      </span>
                      <button
                        onClick={() => copyToClipboard(server.apkSerialNumber!)}
                        className="p-1 text-purple-400 hover:text-purple-600"
                        title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
                      >
                        <Copy className="w-4 h-4" />
                      </button>
                    </>
                  ) : (
                    <span className="text-gray-400 italic">–ù–µ –ø—Ä–∏—Å–≤–æ–µ–Ω</span>
                  )}
                </div>
              )}

              {server.archivedAt && (
                <div className="mt-2 flex items-center gap-2 text-sm text-purple-600">
                  <Archive className="w-4 h-4" />
                  <span>–í –∞—Ä—Ö–∏–≤–µ —Å {formatDateTime(server.archivedAt)}</span>
                </div>
              )}
            </div>

            <div className="grid md:grid-cols-2 gap-4">
              <InfoRow
                icon={<Network className="w-4 h-4" />}
                label="MAC –∞–¥—Ä–µ—Å"
                value={server.macAddress || "-"}
                copyable
                onCopy={copyToClipboard}
              />
              <InfoRow
                icon={<FileText className="w-4 h-4" />}
                label="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä"
                value={server.serialNumber || "-"}
                copyable
                onCopy={copyToClipboard}
              />
              <InfoRow
                icon={<Package className="w-4 h-4" />}
                label="–ü–∞—Ä—Ç–∏—è"
                value={server.batch?.title || "–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω"}
                link={server.batch ? `/beryll/batch/${server.batch.id}` : undefined}
              />
              <InfoRow
                icon={<Calendar className="w-4 h-4" />}
                label="–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä."
                value={formatDateTime(server.lastSyncAt)}
              />
              <InfoRow
                icon={<User className="w-4 h-4" />}
                label="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å"
                value={server.assignedTo
                  ? `${server.assignedTo.surname} ${server.assignedTo.name}`
                  : "-"
                }
              />
              <InfoRow
                icon={<Clock className="w-4 h-4" />}
                label="–í—Ä–µ–º—è –≤ —Ä–∞–±–æ—Ç–µ"
                value={workTime ? formatDuration(workTime) : "-"}
              />
            </div>
          </div>


          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <button
              onClick={() => setShowChecklist(!showChecklist)}
              className="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50"
            >
              <div className="flex items-center gap-3">
                <CheckCircle2 className="w-5 h-5 text-gray-400" />
                <span className="font-semibold text-gray-800">
                  –ß–µ–∫-–ª–∏—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
                </span>
                <span className="text-sm text-gray-500">
                  ({checklistCompleted}/{checklistTotal})
                </span>

                {checklistTotal > 0 && (
                  <div className="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-green-500 transition-all"
                      style={{ width: `${(checklistCompleted / checklistTotal) * 100}%` }}
                    />
                  </div>
                )}
              </div>
              {showChecklist ? (
                <ChevronUp className="w-5 h-5 text-gray-400" />
              ) : (
                <ChevronDown className="w-5 h-5 text-gray-400" />
              )}
            </button>

            {showChecklist && (
              <div className="px-6 pb-4 border-t border-gray-100">
                {!server.checklists || server.checklists.length === 0 ? (
                  <p className="py-4 text-gray-400 text-center">
                    –ß–µ–∫-–ª–∏—Å—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
                  </p>
                ) : (
                  <div className="space-y-4 pt-4">
                    {Object.entries(groups).map(([groupCode, items]) => (
                      <div key={groupCode} className="space-y-2">

                        <h4 className="text-sm font-semibold text-gray-500 uppercase tracking-wide border-b border-gray-100 pb-2">
                          {CHECKLIST_GROUP_LABELS[groupCode as ChecklistGroup] || groupCode}
                        </h4>


                        <div className="space-y-2">
                          {items.map((item) => {
                            const requiresFile = item.template?.requiresFile || false;
                            const files = item.files || [];
                            const hasFiles = files.length > 0;

                            return (
                              <div
                                key={item.id || item.checklistTemplateId}
                                className={`p-3 rounded-lg border ${
                                  item.completed
                                    ? "bg-green-50 border-green-200"
                                    : requiresFile && !hasFiles
                                      ? "bg-amber-50 border-amber-200"
                                      : "bg-gray-50 border-gray-200"
                                }`}
                              >
                                <div className="flex items-start gap-3">

                                  <button
                                    onClick={() => handleToggleChecklist(
                                      item.checklistTemplateId,
                                      !item.completed,
                                      requiresFile,
                                      hasFiles
                                    )}
                                    disabled={!canWork}
                                    className={`mt-0.5 w-6 h-6 rounded-md border-2 flex-shrink-0 flex items-center justify-center transition-colors ${
                                      item.completed
                                        ? "bg-green-500 border-green-500 text-white"
                                        : canWork
                                          ? "border-gray-300 hover:border-indigo-500"
                                          : "border-gray-200 bg-gray-100"
                                    }`}
                                  >
                                    {item.completed && <CheckCircle2 className="w-4 h-4" />}
                                  </button>


                                  <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-2">
                                      <span className={`font-medium ${
                                        item.completed ? "text-green-700" : "text-gray-800"
                                      }`}>
                                        {item.template?.title}
                                      </span>


                                      {requiresFile && !item.completed && (
                                        <span className={`inline-flex items-center gap-1 px-2 py-0.5 text-xs rounded-full ${
                                          hasFiles
                                            ? "bg-green-100 text-green-700"
                                            : "bg-amber-100 text-amber-700"
                                        }`}>
                                          <Camera className="w-3 h-3" />
                                          {hasFiles ? "–°–∫—Ä–∏–Ω –∑–∞–≥—Ä—É–∂–µ–Ω" : "–ù—É–∂–µ–Ω —Å–∫—Ä–∏–Ω"}
                                        </span>
                                      )}
                                    </div>

                                    {item.template?.description && (
                                      <p className="text-xs text-gray-500 mt-0.5">
                                        {item.template.description}
                                      </p>
                                    )}


                                    {hasFiles && (
                                      <div className="flex flex-wrap gap-2 mt-2">
                                        {files.map((file) => (
                                          <div
                                            key={file.id}
                                            className="flex items-center gap-1 px-2 py-1 bg-white border border-gray-200 rounded text-xs"
                                          >
                                            {file.mimetype?.startsWith("image/") ||
                                             (file.originalName && ["jpg", "jpeg", "png", "gif", "webp"].some(ext =>
                                               file.originalName.toLowerCase().endsWith(`.${ext}`)
                                             )) ? (
                                              <Image className="w-3 h-3 text-blue-500" />
                                            ) : (
                                              <FileIcon className="w-3 h-3 text-red-500" />
                                            )}
                                            <span className="max-w-[100px] truncate" title={file.originalName}>
                                              {file.originalName}
                                            </span>
                                            <button
                                              onClick={() => handleViewFile(file.id, file.mimetype, file.originalName)}
                                              className="p-0.5 text-gray-400 hover:text-blue-600"
                                              title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å"
                                            >
                                              <Eye className="w-3 h-3" />
                                            </button>
                                            {canWork && (
                                              <button
                                                onClick={() => handleDeleteFile(file.id)}
                                                className="p-0.5 text-gray-400 hover:text-red-600"
                                                title="–£–¥–∞–ª–∏—Ç—å"
                                              >
                                                <Trash2 className="w-3 h-3" />
                                              </button>
                                            )}
                                          </div>
                                        ))}
                                      </div>
                                    )}


                                    {item.completed && item.completedBy && (
                                      <p className="text-xs text-green-600 mt-1">
                                        ‚úì {item.completedBy.surname} {item.completedBy.name?.charAt(0)}. ‚Äî {formatDateTime(item.completedAt)}
                                      </p>
                                    )}
                                  </div>


                                  {canWork && !item.completed && (
                                    <button
                                      onClick={() => handleUploadClick(item.checklistTemplateId, item.template?.title || "–°–∫—Ä–∏–Ω—à–æ—Ç")}
                                      className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm transition-colors ${
                                        requiresFile && !hasFiles
                                          ? "bg-amber-500 text-white hover:bg-amber-600"
                                          : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                                      }`}
                                      title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç (–∏–ª–∏ Ctrl+V)"
                                    >
                                      <Upload className="w-4 h-4" />
                                      <span className="hidden sm:inline">–°–∫—Ä–∏–Ω</span>
                                    </button>
                                  )}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>


          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <ServerComponentsManager
              serverId={server.id}
              serverIp={server.ipAddress}
              apkSerialNumber={server.apkSerialNumber}
              readOnly={server.status === "ARCHIVED"}
            />
          </div>


          <div className="lg:col-span-2">
            <DefectComments serverId={server.id} />
          </div>


          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <button
              onClick={() => setShowHistory(!showHistory)}
              className="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50"
            >
              <div className="flex items-center gap-3">
                <History className="w-5 h-5 text-gray-400" />
                <span className="font-semibold text-gray-800">
                  –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
                </span>
                <span className="text-sm text-gray-500">
                  ({server.history?.length || 0})
                </span>
              </div>
              {showHistory ? (
                <ChevronUp className="w-5 h-5 text-gray-400" />
              ) : (
                <ChevronDown className="w-5 h-5 text-gray-400" />
              )}
            </button>

            {showHistory && (
              <div className="px-6 pb-4 border-t border-gray-100">
                {!server.history || server.history.length === 0 ? (
                  <p className="py-4 text-gray-400 text-center">
                    –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞
                  </p>
                ) : (
                  <div className="relative">
                    <div className="absolute left-3 top-0 bottom-0 w-0.5 bg-gray-200" />

                    <div className="space-y-4 pt-4">
                      {server.history.map((item) => (
                        <div key={item.id} className="relative pl-8">
                          <div className="absolute left-0 w-6 h-6 rounded-full bg-white border-2 border-gray-300 flex items-center justify-center">
                            <div className="w-2 h-2 rounded-full bg-gray-400" />
                          </div>

                          <div className="flex items-start justify-between">
                            <div>
                              <div className="font-medium text-gray-800">
                                {HISTORY_ACTION_LABELS[item.action]}
                              </div>
                              {item.action === "STATUS_CHANGED" && (
                                <div className="flex items-center gap-1 text-sm text-gray-500 mt-0.5">
                                  <span>{STATUS_LABELS[item.fromStatus as ServerStatus] || item.fromStatus}</span>
                                  <ArrowRight className="w-3 h-3" />
                                  <span>{STATUS_LABELS[item.toStatus as ServerStatus] || item.toStatus}</span>
                                </div>
                              )}
                              {item.comment && (
                                <p className="text-sm text-gray-500 mt-1">
                                  {item.comment}
                                </p>
                              )}
                            </div>
                            <div className="text-right text-xs text-gray-400">
                              <div>{formatDateTime(item.createdAt)}</div>
                              {item.user && (
                                <div>{item.user.surname} {item.user.name?.charAt(0)}.</div>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>


        <div className="space-y-6">
          {canWork && (
            <div className="bg-white rounded-xl border border-gray-200 p-4">
              <h3 className="font-semibold text-gray-800 mb-3">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h3>
              <div className="grid grid-cols-2 gap-2">
                {(["CLARIFYING", "DEFECT"] as ServerStatus[]).map((status) => (
                  <button
                    key={status}
                    onClick={() => handleStatusChange(status)}
                    disabled={actionLoading}
                    className={`px-3 py-2 rounded-lg text-sm font-medium border ${STATUS_COLORS[status]} hover:opacity-80 transition-opacity`}
                  >
                    {STATUS_LABELS[status]}
                  </button>
                ))}
              </div>
            </div>
          )}

          <div className="bg-white rounded-xl border border-gray-200 p-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                <MessageSquare className="w-4 h-4 text-gray-400" />
                –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
              </h3>
              {!editingNotes && canWork && (
                <button
                  onClick={() => setEditingNotes(true)}
                  className="p-1 text-gray-400 hover:text-gray-600"
                >
                  <Edit className="w-4 h-4" />
                </button>
              )}
            </div>

            {editingNotes ? (
              <div>
                <textarea
                  value={notes}
                  onChange={(e) => setNotes(e.target.value)}
                  rows={4}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                  placeholder="–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ..."
                />
                <div className="flex justify-end gap-2 mt-2">
                  <button
                    onClick={() => {
                      setNotes(server.notes || "");
                      setEditingNotes(false);
                    }}
                    className="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                  <button
                    onClick={handleSaveNotes}
                    className="flex items-center gap-1 px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                  >
                    <Save className="w-3 h-3" />
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </button>
                </div>
              </div>
            ) : (
              <p className={`text-sm ${server.notes ? "text-gray-600" : "text-gray-400 italic"}`}>
                {server.notes || "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"}
              </p>
            )}
          </div>

          <div className="bg-white rounded-xl border border-gray-200 p-4">
            <h3 className="font-semibold text-gray-800 mb-3">DHCP Lease</h3>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-500">–°—Ç–∞—Ç—É—Å</span>
                <span className={server.leaseActive ? "text-green-600" : "text-red-600"}>
                  {server.leaseActive ? "–ê–∫—Ç–∏–≤–µ–Ω" : "–ù–µ–∞–∫—Ç–∏–≤–µ–Ω"}
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-500">–ù–∞—á–∞–ª–æ</span>
                <span className="text-gray-800">{formatDateTime(server.leaseStart)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-500">–û–∫–æ–Ω—á–∞–Ω–∏–µ</span>
                <span className="text-gray-800">{formatDateTime(server.leaseEnd)}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
});

interface InfoRowProps {
  icon: React.ReactNode;
  label: string;
  value: string;
  copyable?: boolean;
  link?: string;
  onCopy?: (text: string) => void;
}

const InfoRow: React.FC<InfoRowProps> = ({ icon, label, value, copyable, link, onCopy }) => {
  const navigate = useNavigate();

  const handleCopy = () => {
    navigator.clipboard.writeText(value);
    if (onCopy) {
      onCopy(value);
    } else {
      toast.success("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
    }
  };

  return (
    <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
      <div className="text-gray-400">{icon}</div>
      <div className="flex-1 min-w-0">
        <div className="text-xs text-gray-500">{label}</div>
        {link ? (
          <button
            onClick={() => navigate(link)}
            className="font-medium text-indigo-600 hover:underline truncate block"
          >
            {value}
          </button>
        ) : (
          <div className="font-medium text-gray-800 truncate">{value}</div>
        )}
      </div>
      {copyable && value !== "-" && (
        <button
          onClick={handleCopy}
          className="p-1 text-gray-400 hover:text-gray-600"
          title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
        >
          <Copy className="w-4 h-4" />
        </button>
      )}
    </div>
  );
};

export default ServerDetailPage;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/tabs/AnalyticsTab.tsx
================================================================================

import { useState, useEffect } from "react";
import {
  BarChart3,
  TrendingUp,
  Users,
  Clock,
  Server,
  CheckCircle2,
  XCircle,
  RefreshCw,
  Calendar,
  Award,
  Package
} from "lucide-react";
import {
  getAnalytics,
  BeryllAnalytics,
  STATUS_LABELS,
  formatDuration
} from "src/api/beryllApi";

export const AnalyticsTab: React.FC = () => {
  const [analytics, setAnalytics] = useState<BeryllAnalytics | null>(null);
  const [loading, setLoading] = useState(true);
  const [dateRange, setDateRange] = useState<"week" | "month" | "all">("week");

  const loadAnalytics = async () => {
    setLoading(true);
    try {
      const params: { dateFrom?: string; dateTo?: string } = {};

      const now = new Date();
      if (dateRange === "week") {
        const weekAgo = new Date(now);
        weekAgo.setDate(weekAgo.getDate() - 7);
        params.dateFrom = weekAgo.toISOString();
      } else if (dateRange === "month") {
        const monthAgo = new Date(now);
        monthAgo.setMonth(monthAgo.getMonth() - 1);
        params.dateFrom = monthAgo.toISOString();
      }

      const data = await getAnalytics(params);
      setAnalytics(data);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:", e);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadAnalytics();
  }, [dateRange]);

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <RefreshCw className="w-6 h-6 animate-spin text-indigo-500" />
        <span className="ml-2 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</span>
      </div>
    );
  }

  if (!analytics) {
    return (
      <div className="text-center py-12 text-gray-400">
        <BarChart3 className="w-12 h-12 mx-auto mb-3 opacity-50" />
        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É</p>
      </div>
    );
  }

  const { overview, dailyCompleted, topPerformers, avgProcessingTime, activeBatches } = analytics;


  const maxDaily = Math.max(...dailyCompleted.map(d => parseInt(String(d.count))), 1);

  return (
    <div className="space-y-6">

      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div className="flex items-center gap-3">
          <BarChart3 className="w-5 h-5 text-gray-400" />
          <h2 className="text-lg font-semibold text-gray-800">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
        </div>


        <div className="flex items-center gap-2">
          <Calendar className="w-4 h-4 text-gray-400" />
          <div className="flex bg-gray-100 rounded-lg p-1">
            {[
              { value: "week", label: "–ù–µ–¥–µ–ª—è" },
              { value: "month", label: "–ú–µ—Å—è—Ü" },
              { value: "all", label: "–í—Å—ë –≤—Ä–µ–º—è" }
            ].map((option) => (
              <button
                key={option.value}
                onClick={() => setDateRange(option.value as typeof dateRange)}
                className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${
                  dateRange === option.value
                    ? "bg-white text-indigo-600 shadow-sm"
                    : "text-gray-600 hover:text-gray-800"
                }`}
              >
                {option.label}
              </button>
            ))}
          </div>
        </div>
      </div>


      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <MetricCard
          icon={Server}
          label="–í—Å–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–æ–≤"
          value={overview.totalServers}
          color="bg-gray-100 text-gray-600"
        />
        <MetricCard
          icon={RefreshCw}
          label="–í —Ä–∞–±–æ—Ç–µ"
          value={overview.byStatus.IN_WORK || 0}
          color="bg-blue-100 text-blue-600"
        />
        <MetricCard
          icon={CheckCircle2}
          label="–ó–∞–≤–µ—Ä—à–µ–Ω–æ"
          value={overview.byStatus.DONE || 0}
          color="bg-green-100 text-green-600"
          trend={dailyCompleted.length > 1 ? `+${dailyCompleted[dailyCompleted.length - 1]?.count || 0} —Å–µ–≥–æ–¥–Ω—è` : undefined}
        />
        <MetricCard
          icon={Clock}
          label="–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è"
          value={avgProcessingTime ? formatDuration(avgProcessingTime) : "-"}
          color="bg-purple-100 text-purple-600"
          isText
        />
      </div>


      <div className="grid md:grid-cols-2 gap-6">

        <div className="bg-white rounded-xl border border-gray-200 p-4">
          <div className="flex items-center gap-2 mb-4">
            <TrendingUp className="w-5 h-5 text-gray-400" />
            <h3 className="font-semibold text-gray-800">–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</h3>
          </div>

          {dailyCompleted.length === 0 ? (
            <div className="text-center py-8 text-gray-400">
              –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
            </div>
          ) : (
            <div className="space-y-2">
              {dailyCompleted.map((day, index) => {
                const count = parseInt(String(day.count));
                const percentage = (count / maxDaily) * 100;
                const date = new Date(day.date).toLocaleDateString("ru-RU", {
                  day: "2-digit",
                  month: "short"
                });

                return (
                  <div key={index} className="flex items-center gap-3">
                    <span className="text-xs text-gray-500 w-16">{date}</span>
                    <div className="flex-1 h-6 bg-gray-100 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-gradient-to-r from-indigo-400 to-indigo-600 rounded-full transition-all duration-300 flex items-center justify-end pr-2"
                        style={{ width: `${Math.max(percentage, 10)}%` }}
                      >
                        {count > 0 && (
                          <span className="text-xs text-white font-medium">
                            {count}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>


        <div className="bg-white rounded-xl border border-gray-200 p-4">
          <div className="flex items-center gap-2 mb-4">
            <Users className="w-5 h-5 text-gray-400" />
            <h3 className="font-semibold text-gray-800">–¢–æ–ø –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</h3>
          </div>

          {topPerformers.length === 0 ? (
            <div className="text-center py-8 text-gray-400">
              –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
            </div>
          ) : (
            <div className="space-y-3">
              {topPerformers.slice(0, 5).map((performer, index) => (
                <div
                  key={performer.userId}
                  className="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50"
                >

                  <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                    index === 0 ? "bg-yellow-100 text-yellow-700" :
                    index === 1 ? "bg-gray-200 text-gray-700" :
                    index === 2 ? "bg-orange-100 text-orange-700" :
                    "bg-gray-100 text-gray-500"
                  }`}>
                    {index + 1}
                  </div>


                  <div className="flex-1 min-w-0">
                    <div className="font-medium text-gray-800 truncate">
                      {performer.user.surname} {performer.user.name}
                    </div>
                    <div className="text-xs text-gray-500">
                      {performer.user.login}
                    </div>
                  </div>


                  <div className="text-right">
                    <div className="font-bold text-indigo-600">
                      {performer.completedCount}
                    </div>
                    <div className="text-xs text-gray-500">
                      {performer.avgDuration
                        ? `~${formatDuration(Math.round(performer.avgDuration))}`
                        : "-"
                      }
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>


      {activeBatches.length > 0 && (
        <div className="bg-white rounded-xl border border-gray-200 p-4">
          <div className="flex items-center gap-2 mb-4">
            <Package className="w-5 h-5 text-gray-400" />
            <h3 className="font-semibold text-gray-800">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏</h3>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="text-left text-xs text-gray-500 uppercase border-b border-gray-100">
                  <th className="pb-3 font-medium">–ü–∞—Ä—Ç–∏—è</th>
                  <th className="pb-3 font-medium text-center">–°–µ—Ä–≤–µ—Ä–æ–≤</th>
                  <th className="pb-3 font-medium text-center">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</th>
                  <th className="pb-3 font-medium">–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-50">
                {activeBatches.map((batch) => {
                  const progress = batch.serverCount > 0
                    ? Math.round((batch.completedCount / batch.serverCount) * 100)
                    : 0;

                  return (
                    <tr key={batch.id} className="hover:bg-gray-50">
                      <td className="py-3">
                        <span className="font-medium text-gray-800">{batch.title}</span>
                      </td>
                      <td className="py-3 text-center text-gray-600">
                        {batch.serverCount}
                      </td>
                      <td className="py-3 text-center">
                        <span className="text-green-600 font-medium">
                          {batch.completedCount}
                        </span>
                      </td>
                      <td className="py-3">
                        <div className="flex items-center gap-2">
                          <div className="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div
                              className="h-full bg-indigo-500 rounded-full"
                              style={{ width: `${progress}%` }}
                            />
                          </div>
                          <span className="text-xs text-gray-500 w-10">
                            {progress}%
                          </span>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      )}


      <div className="bg-white rounded-xl border border-gray-200 p-4">
        <div className="flex items-center gap-2 mb-4">
          <BarChart3 className="w-5 h-5 text-gray-400" />
          <h3 className="font-semibold text-gray-800">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          {Object.entries(STATUS_LABELS).map(([status, label]) => {
            const count = overview.byStatus[status as keyof typeof overview.byStatus] || 0;
            const percentage = overview.totalServers > 0
              ? Math.round((count / overview.totalServers) * 100)
              : 0;

            const colors: Record<string, string> = {
              NEW: "bg-gray-100 text-gray-700",
              IN_WORK: "bg-blue-100 text-blue-700",
              CLARIFYING: "bg-yellow-100 text-yellow-700",
              DEFECT: "bg-red-100 text-red-700",
              DONE: "bg-green-100 text-green-700"
            };

            return (
              <div
                key={status}
                className={`p-4 rounded-xl ${colors[status]}`}
              >
                <div className="text-2xl font-bold">{count}</div>
                <div className="text-sm opacity-80">{label}</div>
                <div className="text-xs mt-1 opacity-60">{percentage}%</div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};


interface MetricCardProps {
  icon: React.ElementType;
  label: string;
  value: number | string;
  color: string;
  trend?: string;
  isText?: boolean;
}

const MetricCard: React.FC<MetricCardProps> = ({
  icon: Icon,
  label,
  value,
  color,
  trend,
  isText
}) => (
  <div className="bg-white rounded-xl border border-gray-200 p-4">
    <div className="flex items-start justify-between">
      <div className={`p-2 rounded-lg ${color}`}>
        <Icon className="w-5 h-5" />
      </div>
      {trend && (
        <span className="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded-full">
          {trend}
        </span>
      )}
    </div>
    <div className={`mt-3 ${isText ? "text-xl" : "text-2xl"} font-bold text-gray-800`}>
      {value}
    </div>
    <div className="text-sm text-gray-500">{label}</div>
  </div>
);

export default AnalyticsTab;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/tabs/ArchiveTab.tsx
================================================================================


import { useState, useEffect, useContext } from "react";
import { useNavigate } from "react-router-dom";
import { observer } from "mobx-react-lite";
import {
  Archive,
  Search,
  Server,
  RefreshCw,
  ExternalLink,
  Download,
  Package,
  User,
  Calendar,
  ChevronLeft,
  ChevronRight,
  FileSpreadsheet,
  Copy,
  RotateCcw,
  CheckSquare,
  Square,
  AlertTriangle,
  Clock,
  Info,
  Trash2
} from "lucide-react";
import { Context } from "src/main";
import {
  getArchivedServers,
  getBatches,
  generatePassport,
  unarchiveServer,
  deleteServer,
  BeryllServer,
  BeryllBatch,
  STATUS_LABELS,
  STATUS_COLORS,
  formatDateTime,
  formatDate
} from "src/api/beryllApi";

interface ArchiveTabProps {
  onStatsUpdate?: () => void;
}

export const ArchiveTab: React.FC<ArchiveTabProps> = observer(({ onStatsUpdate }) => {
  const navigate = useNavigate();
  const context = useContext(Context);
  const currentUser = context?.user?.user;

  const [servers, setServers] = useState<BeryllServer[]>([]);
  const [batches, setBatches] = useState<BeryllBatch[]>([]);
  const [loading, setLoading] = useState(true);
  const [actionLoading, setActionLoading] = useState<number | null>(null);


  const [search, setSearch] = useState("");
  const [batchFilter, setBatchFilter] = useState<number | "ALL">("ALL");


  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [total, setTotal] = useState(0);


  const [selectedServers, setSelectedServers] = useState<number[]>([]);
  const [showUnarchiveConfirm, setShowUnarchiveConfirm] = useState(false);

  const loadData = async () => {
    setLoading(true);
    try {
      const [archiveData, batchesData] = await Promise.all([
        getArchivedServers({
          search: search || undefined,
          batchId: batchFilter === "ALL" ? undefined : batchFilter,
          page,
          limit: 50
        }),
        getBatches({})
      ]);

      setServers(archiveData.servers);
      setTotal(archiveData.total);
      setTotalPages(archiveData.totalPages);
      setBatches(batchesData);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞:", e);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadData();
  }, [page, batchFilter]);

  useEffect(() => {
    const timer = setTimeout(() => {
      setPage(1);
      loadData();
    }, 300);
    return () => clearTimeout(timer);
  }, [search]);


  const handleDownloadPassport = async (server: BeryllServer) => {
    try {
      const blob = await generatePassport(server.id);
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `–ü–∞—Å–ø–æ—Ä—Ç_${server.apkSerialNumber || server.id}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞:", e);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞");
    }
  };

  const handleUnarchive = async (server: BeryllServer) => {
    if (!confirm(`–í–µ—Ä–Ω—É—Ç—å —Å–µ—Ä–≤–µ—Ä ${server.apkSerialNumber || server.ipAddress} –∏–∑ –∞—Ä—Ö–∏–≤–∞?`)) {
      return;
    }

    setActionLoading(server.id);
    try {
      await unarchiveServer(server.id);
      await loadData();
      onStatsUpdate?.();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è");
    } finally {
      setActionLoading(null);
    }
  };

  const handleBulkUnarchive = async () => {
    if (selectedServers.length === 0) return;

    setShowUnarchiveConfirm(false);
    const errors: string[] = [];

    for (const serverId of selectedServers) {
      setActionLoading(serverId);
      try {
        await unarchiveServer(serverId);
      } catch (e: any) {
        const server = servers.find(s => s.id === serverId);
        errors.push(`${server?.apkSerialNumber || serverId}: ${e.response?.data?.message || "–û—à–∏–±–∫–∞"}`);
      }
    }

    setActionLoading(null);
    setSelectedServers([]);
    await loadData();
    onStatsUpdate?.();

    if (errors.length > 0) {
      alert(`–û—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏:\n${errors.join("\n")}`);
    }
  };

  const handleDelete = async (server: BeryllServer) => {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä ${server.apkSerialNumber || server.ipAddress} –Ω–∞–≤—Å–µ–≥–¥–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
      return;
    }

    setActionLoading(server.id);
    try {
      await deleteServer(server.id);
      await loadData();
      onStatsUpdate?.();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    } finally {
      setActionLoading(null);
    }
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
  };


  const toggleSelectAll = () => {
    if (selectedServers.length === servers.length) {
      setSelectedServers([]);
    } else {
      setSelectedServers(servers.map(s => s.id));
    }
  };

  const toggleSelect = (id: number) => {
    setSelectedServers(prev =>
      prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]
    );
  };


  return (
    <div className="space-y-4">

      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-purple-100 rounded-lg">
            <Archive className="w-6 h-6 text-purple-600" />
          </div>
          <div>
            <h2 className="text-lg font-semibold text-gray-800">
              –ê—Ä—Ö–∏–≤ —Å–µ—Ä–≤–µ—Ä–æ–≤
            </h2>
            <p className="text-sm text-gray-500">
              –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã —Å –ø—Ä–∏—Å–≤–æ–µ–Ω–Ω—ã–º–∏ —Å–µ—Ä–∏–π–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
            </p>
          </div>
        </div>
        <div className="flex items-center gap-4">
          <div className="text-sm text-gray-500">
            –í—Å–µ–≥–æ –≤ –∞—Ä—Ö–∏–≤–µ: <span className="font-semibold text-purple-600">{total}</span>
          </div>
          <button
            onClick={loadData}
            disabled={loading}
            className="p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
            title="–û–±–Ω–æ–≤–∏—Ç—å"
          >
            <RefreshCw className={`w-5 h-5 ${loading ? "animate-spin" : ""}`} />
          </button>
        </div>
      </div>


      <div className="flex flex-col md:flex-row md:items-center gap-4">

        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
          <input
            type="text"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –ê–ü–ö, IP, hostname..."
            className="w-full pl-9 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
          />
        </div>


        <select
          value={batchFilter}
          onChange={(e) => {
            const val = e.target.value;
            setBatchFilter(val === "ALL" ? "ALL" : parseInt(val));
            setPage(1);
          }}
          className="px-3 py-2.5 border border-gray-300 rounded-lg text-sm bg-white"
        >
          <option value="ALL">–í—Å–µ –ø–∞—Ä—Ç–∏–∏</option>
          {batches.map(batch => (
            <option key={batch.id} value={batch.id}>{batch.title}</option>
          ))}
        </select>
      </div>


      {selectedServers.length > 0 && (
        <div className="flex items-center gap-4 p-3 bg-purple-50 rounded-lg border border-purple-200">
          <span className="text-sm font-medium text-purple-700">
            –í—ã–±—Ä–∞–Ω–æ: {selectedServers.length}
          </span>
          <button
            onClick={() => setShowUnarchiveConfirm(true)}
            className="flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition-colors"
          >
            <RotateCcw className="w-4 h-4" />
            –í–µ—Ä–Ω—É—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞
          </button>
          <button
            onClick={() => setSelectedServers([])}
            className="text-sm text-purple-600 hover:text-purple-800"
          >
            –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
          </button>
        </div>
      )}


      <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
        {loading ? (
          <div className="flex items-center justify-center py-16">
            <RefreshCw className="w-8 h-8 animate-spin text-purple-500" />
          </div>
        ) : servers.length === 0 ? (
          <div className="text-center py-16 text-gray-400">
            <Archive className="w-16 h-16 mx-auto mb-4 opacity-50" />
            <p className="text-lg font-medium">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</p>
            <p className="text-sm mt-1">
              –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã
            </p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="bg-purple-50 border-b border-gray-200">
                  <th className="p-3 text-left w-10">
                    <input
                      type="checkbox"
                      checked={selectedServers.length === servers.length && servers.length > 0}
                      onChange={toggleSelectAll}
                      className="rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                    />
                  </th>
                  <th className="p-3 text-left text-xs font-semibold text-purple-600 uppercase">
                    –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ê–ü–ö
                  </th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">
                    IP / Hostname
                  </th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">
                    –ü–∞—Ä—Ç–∏—è
                  </th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">
                    –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                  </th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">
                    –ó–∞–≤–µ—Ä—à—ë–Ω
                  </th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">
                    –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω
                  </th>
                  <th className="p-3 text-center text-xs font-semibold text-gray-500 uppercase">
                    –î–µ–π—Å—Ç–≤–∏—è
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {servers.map((server) => {
                  const isLoading = actionLoading === server.id;
                  const isSelected = selectedServers.includes(server.id);

                  return (
                    <tr
                      key={server.id}
                      className={`hover:bg-gray-50 transition-colors ${isSelected ? "bg-purple-50/50" : ""}`}
                    >

                      <td className="p-3">
                        <input
                          type="checkbox"
                          checked={isSelected}
                          onChange={() => toggleSelect(server.id)}
                          className="rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                        />
                      </td>


                      <td className="p-3">
                        <div className="flex items-center gap-2">
                          <span className="font-mono text-sm font-bold text-purple-700">
                            {server.apkSerialNumber || "-"}
                          </span>
                          {server.apkSerialNumber && (
                            <button
                              onClick={() => copyToClipboard(server.apkSerialNumber!)}
                              className="p-1 text-gray-400 hover:text-gray-600 rounded"
                              title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
                            >
                              <Copy className="w-3.5 h-3.5" />
                            </button>
                          )}
                        </div>
                        {server.serialNumber && server.serialNumber !== server.apkSerialNumber && (
                          <div className="text-xs text-gray-400 mt-0.5 font-mono">
                            SN: {server.serialNumber}
                          </div>
                        )}
                      </td>


                      <td className="p-3">
                        <div className="text-sm text-gray-600 font-mono">
                          {server.ipAddress || "-"}
                        </div>
                        {server.hostname && (
                          <div className="text-xs text-gray-400 font-mono">
                            {server.hostname}
                          </div>
                        )}
                      </td>


                      <td className="p-3">
                        {server.batch ? (
                          <button
                            onClick={() => navigate(`/beryll/batch/${server.batch!.id}`)}
                            className="text-sm text-indigo-600 hover:underline flex items-center gap-1"
                          >
                            <Package className="w-3.5 h-3.5" />
                            {server.batch.title}
                          </button>
                        ) : (
                          <span className="text-sm text-gray-400">-</span>
                        )}
                      </td>


                      <td className="p-3">
                        {server.assignedTo ? (
                          <div className="flex items-center gap-2">
                            <div className="w-7 h-7 rounded-full bg-green-100 flex items-center justify-center">
                              <User className="w-3.5 h-3.5 text-green-600" />
                            </div>
                            <span className="text-sm text-gray-700">
                              {server.assignedTo.surname} {server.assignedTo.name?.charAt(0)}.
                            </span>
                          </div>
                        ) : (
                          <span className="text-sm text-gray-400">-</span>
                        )}
                      </td>


                      <td className="p-3">
                        <div className="flex items-center gap-1.5 text-sm text-gray-600">
                          <Calendar className="w-3.5 h-3.5 text-gray-400" />
                          {server.completedAt ? formatDate(server.completedAt) : "-"}
                        </div>
                      </td>


                      <td className="p-3">
                        <div className="text-sm text-gray-500">
                          {server.archivedAt ? formatDateTime(server.archivedAt) : "-"}
                        </div>
                        {server.archivedBy && (
                          <div className="text-xs text-gray-400">
                            {server.archivedBy.surname}
                          </div>
                        )}
                      </td>


                      <td className="p-3">
                        <div className="flex items-center justify-center gap-1">

                          <button
                            onClick={() => navigate(`/beryll/server/${server.id}`)}
                            className="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                            title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"
                          >
                            <ExternalLink className="w-4 h-4" />
                          </button>


                          <button
                            onClick={() => handleDownloadPassport(server)}
                            className="p-1.5 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                            title="–°–∫–∞—á–∞—Ç—å –ø–∞—Å–ø–æ—Ä—Ç"
                          >
                            <FileSpreadsheet className="w-4 h-4" />
                          </button>


                          <button
                            onClick={() => handleUnarchive(server)}
                            disabled={isLoading}
                            className="p-1.5 text-purple-500 hover:text-purple-700 hover:bg-purple-50 rounded-lg transition-colors disabled:opacity-50"
                            title="–í–µ—Ä–Ω—É—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞"
                          >
                            {isLoading ? (
                              <RefreshCw className="w-4 h-4 animate-spin" />
                            ) : (
                              <RotateCcw className="w-4 h-4" />
                            )}
                          </button>


                          {currentUser?.role === "SUPER_ADMIN" && (
                            <button
                              onClick={() => handleDelete(server)}
                              disabled={isLoading}
                              className="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-50"
                              title="–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          )}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}


        {totalPages > 1 && (
          <div className="px-4 py-3 border-t border-gray-200 flex items-center justify-between bg-gray-50">
            <div className="text-sm text-gray-500">
              –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –∏–∑ {totalPages} ‚Ä¢ –í—Å–µ–≥–æ: {total}
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setPage(p => Math.max(1, p - 1))}
                disabled={page === 1}
                className="p-2 text-gray-500 hover:bg-white hover:shadow-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all"
              >
                <ChevronLeft className="w-4 h-4" />
              </button>
              <span className="px-3 py-1 bg-white rounded-lg text-sm font-medium text-gray-700 shadow-sm">
                {page}
              </span>
              <button
                onClick={() => setPage(p => Math.min(totalPages, p + 1))}
                disabled={page === totalPages}
                className="p-2 text-gray-500 hover:bg-white hover:shadow-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all"
              >
                <ChevronRight className="w-4 h-4" />
              </button>
            </div>
          </div>
        )}
      </div>


      <div className="p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-200">
        <div className="flex gap-3">
          <Info className="w-5 h-5 text-purple-500 shrink-0 mt-0.5" />
          <div className="text-sm text-purple-700">
            <p className="font-medium mb-2">–û–± –∞—Ä—Ö–∏–≤–µ</p>
            <ul className="space-y-1 text-purple-600">
              <li className="flex items-start gap-2">
                <span className="w-1.5 h-1.5 rounded-full bg-purple-400 mt-1.5 shrink-0" />
                –í –∞—Ä—Ö–∏–≤ –ø–æ–ø–∞–¥–∞—é—Ç —Å–µ—Ä–≤–µ—Ä—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ì–æ—Ç–æ–≤–æ" –∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–Ω—ã–º —Å–µ—Ä–∏–π–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –ê–ü–ö
              </li>
              <li className="flex items-start gap-2">
                <span className="w-1.5 h-1.5 rounded-full bg-purple-400 mt-1.5 shrink-0" />
                –ê—Ä—Ö–∏–≤–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç —Å–µ—Ç–∏ (–ø—Ä–æ–ø–∞–¥–∞–Ω–∏—è –∏–∑ DHCP)
              </li>
              <li className="flex items-start gap-2">
                <span className="w-1.5 h-1.5 rounded-full bg-purple-400 mt-1.5 shrink-0" />
                <span><strong>–ù–æ–≤–æ–µ:</strong> –°–µ—Ä–≤–µ—Ä—ã –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞ –∫–Ω–æ–ø–∫–æ–π <RotateCcw className="w-3.5 h-3.5 inline" /></span>
              </li>
              <li className="flex items-start gap-2">
                <span className="w-1.5 h-1.5 rounded-full bg-purple-400 mt-1.5 shrink-0" />
                –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –ø–∞—Å–ø–æ—Ä—Ç –≤ Excel
              </li>
            </ul>
          </div>
        </div>
      </div>


      {showUnarchiveConfirm && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div className="p-5 border-b border-gray-200">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-purple-100 rounded-lg">
                  <RotateCcw className="w-5 h-5 text-purple-600" />
                </div>
                <div>
                  <h3 className="text-lg font-semibold text-gray-800">
                    –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∞—Ä—Ö–∏–≤–∞
                  </h3>
                  <p className="text-sm text-gray-500">
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ
                  </p>
                </div>
              </div>
            </div>

            <div className="p-5">
              <p className="text-gray-600 mb-4">
                –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –≤–µ—Ä–Ω—É—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞ <strong>{selectedServers.length}</strong> {
                  selectedServers.length === 1 ? "—Å–µ—Ä–≤–µ—Ä" :
                  selectedServers.length < 5 ? "—Å–µ—Ä–≤–µ—Ä–∞" : "—Å–µ—Ä–≤–µ—Ä–æ–≤"
                }.
              </p>
              <div className="flex items-start gap-2 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                <AlertTriangle className="w-5 h-5 text-yellow-600 shrink-0" />
                <p className="text-sm text-yellow-700">
                  –°–µ—Ä–≤–µ—Ä—ã –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ —Å—Ç–∞—Ç—É—Å "–ì–æ—Ç–æ–≤–æ" –∏ –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–µ "–°–µ—Ä–≤–µ—Ä—ã".
                </p>
              </div>
            </div>

            <div className="p-4 border-t border-gray-200 flex justify-end gap-3">
              <button
                onClick={() => setShowUnarchiveConfirm(false)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleBulkUnarchive}
                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2"
              >
                <RotateCcw className="w-4 h-4" />
                –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
});

export default ArchiveTab;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/tabs/BatchesTab.tsx
================================================================================

import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import {
  Package,
  Plus,
  Search,
  RefreshCw,
  Calendar,
  Building2,
  Server,
  CheckCircle2,
  Clock,
  MoreVertical,
  Edit,
  Trash2,
  ExternalLink,
  XCircle
} from "lucide-react";
import {
  getBatches,
  createBatch,
  updateBatch,
  deleteBatch,
  BeryllBatch,
  BatchStatus,
  BATCH_STATUS_LABELS,
  BATCH_STATUS_COLORS,
  getStatusProgress,
  formatDate
} from "src/api/beryllApi";

export const BatchesTab: React.FC = () => {
  const navigate = useNavigate();

  const [batches, setBatches] = useState<BeryllBatch[]>([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState<BatchStatus | "ALL">("ALL");


  const [showModal, setShowModal] = useState(false);
  const [editingBatch, setEditingBatch] = useState<BeryllBatch | null>(null);
  const [formData, setFormData] = useState({
    title: "",
    supplier: "",
    deliveryDate: "",
    expectedCount: 0,
    notes: ""
  });
  const [saving, setSaving] = useState(false);

  const loadBatches = async () => {
    setLoading(true);
    try {
      const data = await getBatches({
        status: statusFilter === "ALL" ? undefined : statusFilter,
        search: search || undefined
      });
      setBatches(data);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–∏–π:", e);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadBatches();
  }, [statusFilter]);

  useEffect(() => {
    const timer = setTimeout(() => loadBatches(), 300);
    return () => clearTimeout(timer);
  }, [search]);

  const openCreateModal = () => {
    setEditingBatch(null);
    setFormData({
      title: "",
      supplier: "",
      deliveryDate: new Date().toISOString().split("T")[0],
      expectedCount: 0,
      notes: ""
    });
    setShowModal(true);
  };

  const openEditModal = (batch: BeryllBatch) => {
    setEditingBatch(batch);
    setFormData({
      title: batch.title,
      supplier: batch.supplier || "",
      deliveryDate: batch.deliveryDate || "",
      expectedCount: batch.expectedCount || 0,
      notes: batch.notes || ""
    });
    setShowModal(true);
  };

  const handleSave = async () => {
    if (!formData.title.trim()) {
      alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏");
      return;
    }

    setSaving(true);
    try {
      if (editingBatch) {
        await updateBatch(editingBatch.id, formData);
      } else {
        await createBatch(formData);
      }
      setShowModal(false);
      loadBatches();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (batch: BeryllBatch) => {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—Ç–∏—é "${batch.title}"? –°–µ—Ä–≤–µ—Ä—ã –±—É–¥—É—Ç –æ—Ç–≤—è–∑–∞–Ω—ã –æ—Ç –ø–∞—Ä—Ç–∏–∏.`)) {
      return;
    }

    try {
      await deleteBatch(batch.id);
      loadBatches();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    }
  };

  const handleStatusChange = async (batch: BeryllBatch, newStatus: BatchStatus) => {
    try {
      await updateBatch(batch.id, { status: newStatus });
      loadBatches();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };

  return (
    <div className="space-y-4">

      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div className="flex items-center gap-3">
          <Package className="w-5 h-5 text-gray-400" />
          <h2 className="text-lg font-semibold text-gray-800">–ü–∞—Ä—Ç–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤</h2>
        </div>

        <div className="flex items-center gap-2">

          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
            <input
              type="text"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              placeholder="–ü–æ–∏—Å–∫ –ø–∞—Ä—Ç–∏–π..."
              className="pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>


          <select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value as BatchStatus | "ALL")}
            className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
          >
            <option value="ALL">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            {Object.entries(BATCH_STATUS_LABELS).map(([value, label]) => (
              <option key={value} value={value}>{label}</option>
            ))}
          </select>


          <button
            onClick={openCreateModal}
            className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
          >
            <Plus className="w-4 h-4" />
            –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—é
          </button>
        </div>
      </div>


      {loading ? (
        <div className="flex items-center justify-center py-12">
          <RefreshCw className="w-6 h-6 animate-spin text-indigo-500" />
        </div>
      ) : batches.length === 0 ? (
        <div className="text-center py-12 text-gray-400">
          <Package className="w-12 h-12 mx-auto mb-3 opacity-50" />
          <p>–ü–∞—Ä—Ç–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
          <button
            onClick={openCreateModal}
            className="mt-4 text-indigo-600 hover:underline"
          >
            –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –ø–∞—Ä—Ç–∏—é
          </button>
        </div>
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {batches.map((batch) => {
            const progress = getStatusProgress(batch.stats);
            const totalServers = batch.totalCount || 0;
            const doneServers = batch.stats?.DONE || 0;

            return (
              <div
                key={batch.id}
                className="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-md transition-shadow"
              >

                <div className="p-4 border-b border-gray-100">
                  <div className="flex items-start justify-between">
                    <div className="flex-1 min-w-0">
                      <h3 className="font-semibold text-gray-800 truncate">
                        {batch.title}
                      </h3>
                      {batch.supplier && (
                        <div className="flex items-center gap-1 mt-1 text-sm text-gray-500">
                          <Building2 className="w-3 h-3" />
                          {batch.supplier}
                        </div>
                      )}
                    </div>


                    <span className={`px-2 py-1 text-xs font-medium rounded-full ${BATCH_STATUS_COLORS[batch.status]}`}>
                      {BATCH_STATUS_LABELS[batch.status]}
                    </span>
                  </div>


                  {batch.deliveryDate && (
                    <div className="flex items-center gap-1 mt-2 text-sm text-gray-500">
                      <Calendar className="w-3 h-3" />
                      {formatDate(batch.deliveryDate)}
                    </div>
                  )}
                </div>


                <div className="p-4">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-gray-600">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span className="text-sm font-medium text-gray-800">
                      {doneServers} / {totalServers}
                    </span>
                  </div>


                  <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-gradient-to-r from-indigo-500 to-indigo-600 transition-all duration-300"
                      style={{ width: `${progress}%` }}
                    />
                  </div>


                  {batch.stats && totalServers > 0 && (
                    <div className="flex gap-4 mt-3 text-xs">
                      <div className="flex items-center gap-1 text-gray-500">
                        <Clock className="w-3 h-3" />
                        {batch.stats.NEW || 0} –Ω–æ–≤—ã—Ö
                      </div>
                      <div className="flex items-center gap-1 text-blue-600">
                        <RefreshCw className="w-3 h-3" />
                        {batch.stats.IN_WORK || 0} –≤ —Ä–∞–±–æ—Ç–µ
                      </div>
                      <div className="flex items-center gap-1 text-green-600">
                        <CheckCircle2 className="w-3 h-3" />
                        {batch.stats.DONE || 0} –≥–æ—Ç–æ–≤–æ
                      </div>
                      {(batch.stats.DEFECT || 0) > 0 && (
                        <div className="flex items-center gap-1 text-red-600">
                          <XCircle className="w-3 h-3" />
                          {batch.stats.DEFECT} –±—Ä–∞–∫
                        </div>
                      )}
                    </div>
                  )}
                </div>


                <div className="px-4 py-3 bg-gray-50 border-t border-gray-100 flex items-center justify-between">
                  <button
                    onClick={() => navigate(`/beryll/batch/${batch.id}`)}
                    className="flex items-center gap-1 text-sm text-indigo-600 hover:text-indigo-700"
                  >
                    <ExternalLink className="w-4 h-4" />
                    –û—Ç–∫—Ä—ã—Ç—å
                  </button>

                  <div className="flex items-center gap-2">
                    {batch.status === "ACTIVE" && (
                      <button
                        onClick={() => handleStatusChange(batch, "COMPLETED")}
                        className="p-1.5 text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                        title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–∞—Ä—Ç–∏—é"
                      >
                        <CheckCircle2 className="w-4 h-4" />
                      </button>
                    )}
                    <button
                      onClick={() => openEditModal(batch)}
                      className="p-1.5 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors"
                      title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                    >
                      <Edit className="w-4 h-4" />
                    </button>
                    <button
                      onClick={() => handleDelete(batch)}
                      className="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                      title="–£–¥–∞–ª–∏—Ç—å"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}


      {showModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-md">
            <div className="p-4 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-800">
                {editingBatch ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏" : "–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏"}
              </h3>
            </div>

            <div className="p-4 space-y-4">

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏ *
                </label>
                <input
                  type="text"
                  value={formData.title}
                  onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ—Å—Ç–∞–≤–∫–∞-2026-01-15"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –ü–æ—Å—Ç–∞–≤—â–∏–∫
                </label>
                <input
                  type="text"
                  value={formData.supplier}
                  onChange={(e) => setFormData({ ...formData, supplier: e.target.value })}
                  placeholder="–û–û–û –í–µ–≥–º–∞–Ω"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏
                </label>
                <input
                  type="date"
                  value={formData.deliveryDate}
                  onChange={(e) => setFormData({ ...formData, deliveryDate: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª-–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤
                </label>
                <input
                  type="number"
                  value={formData.expectedCount}
                  onChange={(e) => setFormData({ ...formData, expectedCount: parseInt(e.target.value) || 0 })}
                  min="0"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
                </label>
                <textarea
                  value={formData.notes}
                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                  rows={3}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                />
              </div>
            </div>

            <div className="p-4 border-t border-gray-200 flex justify-end gap-3">
              <button
                onClick={() => setShowModal(false)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50"
              >
                {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default BatchesTab;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/tabs/ClustersTab.tsx
================================================================================



import React, { useState, useEffect } from "react";
import {
  Boxes, Plus, Search, Truck, Package, Server,
  ChevronDown, ChevronRight, Trash2, Edit, Users,
  MapPin, Calendar, CheckCircle, Clock, Send
} from "lucide-react";
import toast from "react-hot-toast";
import {
  getShipments, getShipmentById, createShipment, updateShipment, deleteShipment,
  getClusters, getClusterById, createCluster, updateCluster, deleteCluster,
  addServerToCluster, addServersToCluster, removeServerFromCluster, updateClusterServer,
  getUnassignedServers,
  BeryllShipment, BeryllCluster, BeryllClusterServer,
  ShipmentStatus, ClusterStatus, ServerRole
} from "../../../api/beryll/beryllExtendedApi";
import { Modal } from "../../../components/Modal/Modal";
import { ConfirmModal } from "../../../components/Modal/ConfirmModal";


const SHIPMENT_STATUS_CONFIG: Record<ShipmentStatus, { label: string; color: string; bg: string; icon: React.ReactNode }> = {
  FORMING: { label: "–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è", color: "text-blue-600", bg: "bg-blue-100", icon: <Package size={14} /> },
  READY: { label: "–ì–æ—Ç–æ–≤", color: "text-green-600", bg: "bg-green-100", icon: <CheckCircle size={14} /> },
  SHIPPED: { label: "–û—Ç–≥—Ä—É–∂–µ–Ω", color: "text-purple-600", bg: "bg-purple-100", icon: <Send size={14} /> },
  IN_TRANSIT: { label: "–í –ø—É—Ç–∏", color: "text-orange-600", bg: "bg-orange-100", icon: <Truck size={14} /> },
  DELIVERED: { label: "–î–æ—Å—Ç–∞–≤–ª–µ–Ω", color: "text-teal-600", bg: "bg-teal-100", icon: <MapPin size={14} /> },
  ACCEPTED: { label: "–ü—Ä–∏–Ω—è—Ç", color: "text-gray-600", bg: "bg-gray-100", icon: <CheckCircle size={14} /> }
};


const CLUSTER_STATUS_CONFIG: Record<ClusterStatus, { label: string; color: string; bg: string }> = {
  FORMING: { label: "–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è", color: "text-blue-600", bg: "bg-blue-100" },
  READY: { label: "–ì–æ—Ç–æ–≤", color: "text-green-600", bg: "bg-green-100" },
  SHIPPED: { label: "–û—Ç–≥—Ä—É–∂–µ–Ω", color: "text-purple-600", bg: "bg-purple-100" },
  DEPLOYED: { label: "–†–∞–∑–≤—ë—Ä–Ω—É—Ç", color: "text-gray-600", bg: "bg-gray-100" }
};


const SERVER_ROLE_CONFIG: Record<ServerRole, { label: string; color: string; bg: string }> = {
  MASTER: { label: "Master", color: "text-red-600", bg: "bg-red-100" },
  WORKER: { label: "Worker", color: "text-blue-600", bg: "bg-blue-100" },
  STORAGE: { label: "Storage", color: "text-green-600", bg: "bg-green-100" },
  GATEWAY: { label: "Gateway", color: "text-purple-600", bg: "bg-purple-100" }
};

type ViewMode = "shipments" | "clusters";

const ClustersTab: React.FC = () => {
  const [viewMode, setViewMode] = useState<ViewMode>("shipments");
  const [shipments, setShipments] = useState<BeryllShipment[]>([]);
  const [clusters, setClusters] = useState<BeryllCluster[]>([]);
  const [selectedShipment, setSelectedShipment] = useState<BeryllShipment | null>(null);
  const [selectedCluster, setSelectedCluster] = useState<BeryllCluster | null>(null);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");


  const [showCreateShipmentModal, setShowCreateShipmentModal] = useState(false);
  const [showEditShipmentModal, setShowEditShipmentModal] = useState(false);
  const [showCreateClusterModal, setShowCreateClusterModal] = useState(false);
  const [showEditClusterModal, setShowEditClusterModal] = useState(false);
  const [showAddServersModal, setShowAddServersModal] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState<{ type: "shipment" | "cluster"; id: number } | null>(null);


  const loadShipments = async () => {
    try {
      setLoading(true);
      const data = await getShipments({ search });
      setShipments(data);
    } catch (error: any) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤");
    } finally {
      setLoading(false);
    }
  };

  const loadClusters = async () => {
    try {
      setLoading(true);
      const data = await getClusters({ search });
      setClusters(data);
    } catch (error: any) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤");
    } finally {
      setLoading(false);
    }
  };

  const loadShipmentDetails = async (id: number) => {
    try {
      const data = await getShipmentById(id);
      setSelectedShipment(data);
    } catch (error) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–ª–µ–∫—Ç–∞");
    }
  };

  const loadClusterDetails = async (id: number) => {
    try {
      const data = await getClusterById(id);
      setSelectedCluster(data);
    } catch (error) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞");
    }
  };

  useEffect(() => {
    if (viewMode === "shipments") {
      loadShipments();
    } else {
      loadClusters();
    }
  }, [viewMode, search]);


  const ShipmentCard: React.FC<{ shipment: BeryllShipment }> = ({ shipment }) => {
    const statusConfig = SHIPMENT_STATUS_CONFIG[shipment.status];

    return (
      <div
        className={`
          p-4 border rounded-lg cursor-pointer hover:shadow-md transition-all
          ${selectedShipment?.id === shipment.id ? "border-blue-500 bg-blue-50" : "border-gray-200"}
        `}
        onClick={() => loadShipmentDetails(shipment.id)}
      >
        <div className="flex items-center justify-between mb-2">
          <h3 className="font-medium">{shipment.name}</h3>
          <span className={`flex items-center gap-1 text-xs px-2 py-1 rounded ${statusConfig.bg} ${statusConfig.color}`}>
            {statusConfig.icon}
            {statusConfig.label}
          </span>
        </div>

        {shipment.destinationCity && (
          <div className="text-sm text-gray-500 flex items-center gap-1 mb-2">
            <MapPin size={14} />
            {shipment.destinationCity}
          </div>
        )}

        <div className="flex items-center gap-4 text-xs text-gray-500">
          <span className="flex items-center gap-1">
            <Boxes size={12} />
            {shipment.clustersCount || 0} –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
          </span>
          <span className="flex items-center gap-1">
            <Server size={12} />
            {shipment.totalServers || 0} / {shipment.expectedCount} —Å–µ—Ä–≤–µ—Ä–æ–≤
          </span>
        </div>


        <div className="mt-3 h-2 bg-gray-200 rounded-full overflow-hidden">
          <div
            className={`h-full transition-all ${
              shipment.completionPercent === 100 ? "bg-green-500" : "bg-blue-500"
            }`}
            style={{ width: `${shipment.completionPercent || 0}%` }}
          />
        </div>
        <div className="text-xs text-right text-gray-500 mt-1">
          {shipment.completionPercent || 0}%
        </div>
      </div>
    );
  };


  const ClusterCard: React.FC<{ cluster: BeryllCluster }> = ({ cluster }) => {
    const statusConfig = CLUSTER_STATUS_CONFIG[cluster.status];

    return (
      <div
        className={`
          p-4 border rounded-lg cursor-pointer hover:shadow-md transition-all
          ${selectedCluster?.id === cluster.id ? "border-blue-500 bg-blue-50" : "border-gray-200"}
        `}
        onClick={() => loadClusterDetails(cluster.id)}
      >
        <div className="flex items-center justify-between mb-2">
          <h3 className="font-medium">{cluster.name}</h3>
          <span className={`text-xs px-2 py-1 rounded ${statusConfig.bg} ${statusConfig.color}`}>
            {statusConfig.label}
          </span>
        </div>

        {cluster.shipment && (
          <div className="text-sm text-gray-500 flex items-center gap-1 mb-2">
            <Truck size={14} />
            {cluster.shipment.name}
          </div>
        )}

        <div className="flex items-center gap-4 text-xs text-gray-500">
          <span className="flex items-center gap-1">
            <Server size={12} />
            {cluster.serversCount || 0} / {cluster.expectedCount}
          </span>
          {cluster.masterCount !== undefined && (
            <span className="text-red-600">M: {cluster.masterCount}</span>
          )}
          {cluster.workerCount !== undefined && (
            <span className="text-blue-600">W: {cluster.workerCount}</span>
          )}
        </div>


        <div className="mt-3 h-2 bg-gray-200 rounded-full overflow-hidden">
          <div
            className={`h-full transition-all ${
              cluster.completionPercent === 100 ? "bg-green-500" : "bg-blue-500"
            }`}
            style={{ width: `${cluster.completionPercent || 0}%` }}
          />
        </div>
      </div>
    );
  };


  const ShipmentDetails: React.FC<{ shipment: BeryllShipment }> = ({ shipment }) => {
    const statusConfig = SHIPMENT_STATUS_CONFIG[shipment.status];

    return (
      <div className="bg-white rounded-lg shadow">

        <div className="p-4 border-b flex items-center justify-between">
          <div>
            <div className="flex items-center gap-2">
              <h3 className="text-lg font-semibold">{shipment.name}</h3>
              <span className={`flex items-center gap-1 text-xs px-2 py-1 rounded ${statusConfig.bg} ${statusConfig.color}`}>
                {statusConfig.icon}
                {statusConfig.label}
              </span>
            </div>
            {shipment.destinationCity && (
              <p className="text-sm text-gray-500 flex items-center gap-1 mt-1">
                <MapPin size={14} />
                {shipment.destinationCity}
                {shipment.destinationAddress && ` ‚Äî ${shipment.destinationAddress}`}
              </p>
            )}
          </div>

          <div className="flex items-center gap-2">
            <button
              onClick={() => setShowEditShipmentModal(true)}
              className="p-2 hover:bg-gray-100 rounded-lg"
              title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
            >
              <Edit size={18} />
            </button>
            <button
              onClick={() => setShowDeleteConfirm({ type: "shipment", id: shipment.id })}
              className="p-2 hover:bg-red-100 text-red-500 rounded-lg"
              title="–£–¥–∞–ª–∏—Ç—å"
            >
              <Trash2 size={18} />
            </button>
          </div>
        </div>


        <div className="p-4 bg-gray-50 border-b grid grid-cols-4 gap-4 text-sm">
          <div>
            <span className="text-gray-500">–°–µ—Ä–≤–µ—Ä–æ–≤:</span>
            <span className="ml-2 font-medium">{shipment.totalServers} / {shipment.expectedCount}</span>
          </div>
          <div>
            <span className="text-gray-500">–ö–ª–∞—Å—Ç–µ—Ä–æ–≤:</span>
            <span className="ml-2 font-medium">{shipment.clustersCount}</span>
          </div>
          {shipment.plannedShipDate && (
            <div>
              <span className="text-gray-500">–ü–ª–∞–Ω –æ—Ç–≥—Ä—É–∑–∫–∏:</span>
              <span className="ml-2 font-medium">{new Date(shipment.plannedShipDate).toLocaleDateString()}</span>
            </div>
          )}
          {shipment.waybillNumber && (
            <div>
              <span className="text-gray-500">–¢–¢–ù:</span>
              <span className="ml-2 font-medium">{shipment.waybillNumber}</span>
            </div>
          )}
        </div>


        <div className="p-4">
          <div className="flex items-center justify-between mb-3">
            <h4 className="font-medium">–ö–ª–∞—Å—Ç–µ—Ä—ã</h4>
            <button
              onClick={() => {
                setShowCreateClusterModal(true);
              }}
              className="flex items-center gap-1 text-sm text-blue-600 hover:text-blue-800"
            >
              <Plus size={16} />
              –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä
            </button>
          </div>

          {shipment.clusters && shipment.clusters.length > 0 ? (
            <div className="grid grid-cols-2 gap-3">
              {shipment.clusters.map(cluster => (
                <div
                  key={cluster.id}
                  className="p-3 border rounded-lg hover:border-blue-400 cursor-pointer"
                  onClick={() => {
                    setViewMode("clusters");
                    loadClusterDetails(cluster.id);
                  }}
                >
                  <div className="flex items-center justify-between">
                    <span className="font-medium">{cluster.name}</span>
                    <span className={`text-xs px-2 py-0.5 rounded ${CLUSTER_STATUS_CONFIG[cluster.status].bg} ${CLUSTER_STATUS_CONFIG[cluster.status].color}`}>
                      {CLUSTER_STATUS_CONFIG[cluster.status].label}
                    </span>
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {cluster.clusterServers?.length || 0} —Å–µ—Ä–≤–µ—Ä–æ–≤
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-gray-500 text-center py-4">
              –ö–ª–∞—Å—Ç–µ—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
            </div>
          )}
        </div>


        {(shipment.contactPerson || shipment.contactPhone) && (
          <div className="px-4 pb-4">
            <div className="p-3 bg-blue-50 rounded-lg text-sm">
              <strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> {shipment.contactPerson} {shipment.contactPhone && `(${shipment.contactPhone})`}
            </div>
          </div>
        )}
      </div>
    );
  };


  const ClusterDetails: React.FC<{ cluster: BeryllCluster }> = ({ cluster }) => {
    const statusConfig = CLUSTER_STATUS_CONFIG[cluster.status];

    return (
      <div className="bg-white rounded-lg shadow">

        <div className="p-4 border-b flex items-center justify-between">
          <div>
            <div className="flex items-center gap-2">
              <h3 className="text-lg font-semibold">{cluster.name}</h3>
              <span className={`text-xs px-2 py-1 rounded ${statusConfig.bg} ${statusConfig.color}`}>
                {statusConfig.label}
              </span>
            </div>
            {cluster.description && (
              <p className="text-sm text-gray-500 mt-1">{cluster.description}</p>
            )}
          </div>

          <div className="flex items-center gap-2">
            <button
              onClick={() => setShowAddServersModal(true)}
              className="flex items-center gap-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              <Plus size={16} />
              –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—ã
            </button>
            <button
              onClick={() => setShowEditClusterModal(true)}
              className="p-2 hover:bg-gray-100 rounded-lg"
            >
              <Edit size={18} />
            </button>
            <button
              onClick={() => setShowDeleteConfirm({ type: "cluster", id: cluster.id })}
              className="p-2 hover:bg-red-100 text-red-500 rounded-lg"
            >
              <Trash2 size={18} />
            </button>
          </div>
        </div>


        <div className="p-4 bg-gray-50 border-b grid grid-cols-4 gap-4 text-sm">
          <div>
            <span className="text-gray-500">–°–µ—Ä–≤–µ—Ä–æ–≤:</span>
            <span className="ml-2 font-medium">{cluster.serversCount} / {cluster.expectedCount}</span>
          </div>
          {cluster.shipment && (
            <div>
              <span className="text-gray-500">–ö–æ–º–ø–ª–µ–∫—Ç:</span>
              <span className="ml-2 font-medium">{cluster.shipment.name}</span>
            </div>
          )}
          {cluster.configVersion && (
            <div>
              <span className="text-gray-500">–í–µ—Ä—Å–∏—è:</span>
              <span className="ml-2 font-medium">{cluster.configVersion}</span>
            </div>
          )}
        </div>


        <div className="p-4">
          <h4 className="font-medium mb-3">–°–µ—Ä–≤–µ—Ä—ã –∫–ª–∞—Å—Ç–µ—Ä–∞</h4>

          {cluster.clusterServers && cluster.clusterServers.length > 0 ? (
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-2 text-left">#</th>
                    <th className="px-3 py-2 text-left">S/N</th>
                    <th className="px-3 py-2 text-left">–†–æ–ª—å</th>
                    <th className="px-3 py-2 text-left">Hostname</th>
                    <th className="px-3 py-2 text-left">IP</th>
                    <th className="px-3 py-2 text-left">–°—Ç–∞—Ç—É—Å</th>
                    <th className="px-3 py-2 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {cluster.clusterServers.map((cs, index) => {
                    const roleConfig = SERVER_ROLE_CONFIG[cs.role];
                    return (
                      <tr key={cs.id} className="hover:bg-gray-50">
                        <td className="px-3 py-2 text-gray-500">{cs.orderNumber || index + 1}</td>
                        <td className="px-3 py-2 font-mono">
                          {cs.server?.apkSerialNumber || `#${cs.serverId}`}
                        </td>
                        <td className="px-3 py-2">
                          <span className={`text-xs px-2 py-0.5 rounded ${roleConfig.bg} ${roleConfig.color}`}>
                            {roleConfig.label}
                          </span>
                        </td>
                        <td className="px-3 py-2">{cs.clusterHostname || cs.server?.hostname || "‚Äî"}</td>
                        <td className="px-3 py-2">{cs.clusterIpAddress || "‚Äî"}</td>
                        <td className="px-3 py-2">{cs.server?.status || "‚Äî"}</td>
                        <td className="px-3 py-2 text-center">
                          <button
                            onClick={async () => {
                              if (confirm("–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞?")) {
                                try {
                                  await removeServerFromCluster(cluster.id, cs.serverId);
                                  toast.success("–°–µ—Ä–≤–µ—Ä —É–¥–∞–ª—ë–Ω –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞");
                                  loadClusterDetails(cluster.id);
                                } catch (error: any) {
                                  toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
                                }
                              }
                            }}
                            className="p-1 hover:bg-red-100 text-red-500 rounded"
                          >
                            <Trash2 size={14} />
                          </button>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          ) : (
            <div className="text-gray-500 text-center py-8">
              <Server size={32} className="mx-auto mb-2 text-gray-300" />
              <p>–°–µ—Ä–≤–µ—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
              <button
                onClick={() => setShowAddServersModal(true)}
                className="mt-2 text-blue-600 hover:text-blue-800"
              >
                –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—ã
              </button>
            </div>
          )}
        </div>
      </div>
    );
  };

  return (
    <div className="p-4">

      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-4">
          <h2 className="text-xl font-semibold flex items-center gap-2">
            <Boxes className="text-blue-600" />
            –ö–ª–∞—Å—Ç–µ—Ä—ã –∏ –ö–æ–º–ø–ª–µ–∫—Ç—ã
          </h2>


          <div className="flex bg-gray-100 rounded-lg p-1">
            <button
              onClick={() => { setViewMode("shipments"); setSelectedCluster(null); }}
              className={`px-4 py-1.5 rounded-md text-sm transition-colors ${
                viewMode === "shipments" ? "bg-white shadow text-blue-600" : "text-gray-600"
              }`}
            >
              <Truck size={16} className="inline mr-1" />
              –ö–æ–º–ø–ª–µ–∫—Ç—ã
            </button>
            <button
              onClick={() => { setViewMode("clusters"); setSelectedShipment(null); }}
              className={`px-4 py-1.5 rounded-md text-sm transition-colors ${
                viewMode === "clusters" ? "bg-white shadow text-blue-600" : "text-gray-600"
              }`}
            >
              <Boxes size={16} className="inline mr-1" />
              –ö–ª–∞—Å—Ç–µ—Ä—ã
            </button>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
            <input
              type="text"
              placeholder="–ü–æ–∏—Å–∫..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <button
            onClick={() => viewMode === "shipments" ? setShowCreateShipmentModal(true) : setShowCreateClusterModal(true)}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            <Plus size={18} />
            {viewMode === "shipments" ? "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç" : "–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä"}
          </button>
        </div>
      </div>

      <div className="flex gap-4">

        <div className="w-96 flex-shrink-0 space-y-3 max-h-[700px] overflow-y-auto">
          {loading ? (
            <div className="text-center text-gray-500 py-8">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          ) : viewMode === "shipments" ? (
            shipments.length === 0 ? (
              <div className="text-center text-gray-500 py-8">–ö–æ–º–ø–ª–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
            ) : (
              shipments.map(shipment => (
                <ShipmentCard key={shipment.id} shipment={shipment} />
              ))
            )
          ) : (
            clusters.length === 0 ? (
              <div className="text-center text-gray-500 py-8">–ö–ª–∞—Å—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
            ) : (
              clusters.map(cluster => (
                <ClusterCard key={cluster.id} cluster={cluster} />
              ))
            )
          )}
        </div>


        <div className="flex-1">
          {viewMode === "shipments" && selectedShipment ? (
            <ShipmentDetails shipment={selectedShipment} />
          ) : viewMode === "clusters" && selectedCluster ? (
            <ClusterDetails cluster={selectedCluster} />
          ) : (
            <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
              {viewMode === "shipments" ? (
                <>
                  <Truck size={48} className="mx-auto mb-4 text-gray-300" />
                  <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–ª–µ–∫—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                </>
              ) : (
                <>
                  <Boxes size={48} className="mx-auto mb-4 text-gray-300" />
                  <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                </>
              )}
            </div>
          )}
        </div>
      </div>


      <CreateShipmentModal
        isOpen={showCreateShipmentModal}
        onClose={() => setShowCreateShipmentModal(false)}
        onSuccess={() => {
          loadShipments();
          setShowCreateShipmentModal(false);
        }}
      />

      {selectedShipment && (
        <EditShipmentModal
          isOpen={showEditShipmentModal}
          shipment={selectedShipment}
          onClose={() => setShowEditShipmentModal(false)}
          onSuccess={() => {
            loadShipments();
            loadShipmentDetails(selectedShipment.id);
            setShowEditShipmentModal(false);
          }}
        />
      )}

      <CreateClusterModal
        isOpen={showCreateClusterModal}
        shipmentId={viewMode === "shipments" && selectedShipment ? selectedShipment.id : undefined}
        shipments={shipments}
        onClose={() => setShowCreateClusterModal(false)}
        onSuccess={() => {
          loadClusters();
          if (selectedShipment) loadShipmentDetails(selectedShipment.id);
          setShowCreateClusterModal(false);
        }}
      />

      {selectedCluster && (
        <>
          <EditClusterModal
            isOpen={showEditClusterModal}
            cluster={selectedCluster}
            shipments={shipments}
            onClose={() => setShowEditClusterModal(false)}
            onSuccess={() => {
              loadClusters();
              loadClusterDetails(selectedCluster.id);
              setShowEditClusterModal(false);
            }}
          />

          <AddServersModal
            isOpen={showAddServersModal}
            cluster={selectedCluster}
            onClose={() => setShowAddServersModal(false)}
            onSuccess={() => {
              loadClusterDetails(selectedCluster.id);
              setShowAddServersModal(false);
            }}
          />
        </>
      )}


      {showDeleteConfirm && (
        <ConfirmModal
          isOpen={true}
          title={showDeleteConfirm.type === "shipment" ? "–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç?" : "–£–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä?"}
          message="–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ"
          onConfirm={async () => {
            try {
              if (showDeleteConfirm.type === "shipment") {
                await deleteShipment(showDeleteConfirm.id);
                toast.success("–ö–æ–º–ø–ª–µ–∫—Ç —É–¥–∞–ª—ë–Ω");
                setSelectedShipment(null);
                loadShipments();
              } else {
                await deleteCluster(showDeleteConfirm.id);
                toast.success("–ö–ª–∞—Å—Ç–µ—Ä —É–¥–∞–ª—ë–Ω");
                setSelectedCluster(null);
                loadClusters();
              }
            } catch (error: any) {
              toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
            }
            setShowDeleteConfirm(null);
          }}
          onCancel={() => setShowDeleteConfirm(null)}
        />
      )}
    </div>
  );
};


const CreateShipmentModal: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}> = ({ isOpen, onClose, onSuccess }) => {
  const [form, setForm] = useState({
    name: "",
    destinationCity: "",
    destinationAddress: "",
    contactPerson: "",
    contactPhone: "",
    expectedCount: 80,
    plannedShipDate: "",
    waybillNumber: "",
    carrier: "",
    notes: ""
  });
  const [saving, setSaving] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form.name.trim()) {
      toast.error("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
      return;
    }

    try {
      setSaving(true);
      await createShipment(form);
      toast.success("–ö–æ–º–ø–ª–µ–∫—Ç —Å–æ–∑–¥–∞–Ω");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input
            type="text"
            value={form.name}
            onChange={(e) => setForm({ ...form, name: e.target.value })}
            placeholder="–ö–æ–º–ø–ª–µ–∫—Ç #1 ‚Äî –ú–æ—Å–∫–≤–∞"
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">–ì–æ—Ä–æ–¥</label>
            <input
              type="text"
              value={form.destinationCity}
              onChange={(e) => setForm({ ...form, destinationCity: e.target.value })}
              placeholder="–ú–æ—Å–∫–≤–∞"
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">–ö–æ–ª-–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤</label>
            <input
              type="number"
              value={form.expectedCount}
              onChange={(e) => setForm({ ...form, expectedCount: parseInt(e.target.value) || 80 })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <input
            type="text"
            value={form.destinationAddress}
            onChange={(e) => setForm({ ...form, destinationAddress: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
            <input
              type="text"
              value={form.contactPerson}
              onChange={(e) => setForm({ ...form, contactPerson: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input
              type="text"
              value={form.contactPhone}
              onChange={(e) => setForm({ ...form, contactPhone: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">–î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏ (–ø–ª–∞–Ω)</label>
            <input
              type="date"
              value={form.plannedShipDate}
              onChange={(e) => setForm({ ...form, plannedShipDate: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫</label>
            <input
              type="text"
              value={form.carrier}
              onChange={(e) => setForm({ ...form, carrier: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </div>

        <div className="flex justify-end gap-3 pt-4">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å"}
          </button>
        </div>
      </form>
    </Modal>
  );
};


const EditShipmentModal: React.FC<{
  isOpen: boolean;
  shipment: BeryllShipment;
  onClose: () => void;
  onSuccess: () => void;
}> = ({ isOpen, shipment, onClose, onSuccess }) => {
  const [form, setForm] = useState({ ...shipment });
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    setForm({ ...shipment });
  }, [shipment]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      setSaving(true);
      await updateShipment(shipment.id, form);
      toast.success("–ö–æ–º–ø–ª–µ–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input
            type="text"
            value={form.name}
            onChange={(e) => setForm({ ...form, name: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–°—Ç–∞—Ç—É—Å</label>
          <select
            value={form.status}
            onChange={(e) => setForm({ ...form, status: e.target.value as ShipmentStatus })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            {Object.entries(SHIPMENT_STATUS_CONFIG).map(([value, config]) => (
              <option key={value} value={value}>{config.label}</option>
            ))}
          </select>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">–ì–æ—Ä–æ–¥</label>
            <input
              type="text"
              value={form.destinationCity || ""}
              onChange={(e) => setForm({ ...form, destinationCity: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">–ö–æ–ª-–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤</label>
            <input
              type="number"
              value={form.expectedCount}
              onChange={(e) => setForm({ ...form, expectedCount: parseInt(e.target.value) || 80 })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </div>

        <div className="flex justify-end gap-3 pt-4">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
          </button>
        </div>
      </form>
    </Modal>
  );
};


const CreateClusterModal: React.FC<{
  isOpen: boolean;
  shipmentId?: number;
  shipments: BeryllShipment[];
  onClose: () => void;
  onSuccess: () => void;
}> = ({ isOpen, shipmentId, shipments, onClose, onSuccess }) => {
  const [form, setForm] = useState({
    name: "",
    description: "",
    shipmentId: shipmentId || null as number | null,
    expectedCount: 10,
    configVersion: "",
    notes: ""
  });
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    if (shipmentId) {
      setForm(f => ({ ...f, shipmentId }));
    }
  }, [shipmentId]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form.name.trim()) {
      toast.error("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
      return;
    }

    try {
      setSaving(true);
      await createCluster(form);
      toast.success("–ö–ª–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input
            type="text"
            value={form.name}
            onChange={(e) => setForm({ ...form, name: e.target.value })}
            placeholder="cl1, production-cluster..."
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–ö–æ–º–ø–ª–µ–∫—Ç</label>
          <select
            value={form.shipmentId || ""}
            onChange={(e) => setForm({ ...form, shipmentId: e.target.value ? parseInt(e.target.value) : null })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="">‚Äî –ë–µ–∑ –∫–æ–º–ø–ª–µ–∫—Ç–∞ ‚Äî</option>
            {shipments.map(s => (
              <option key={s.id} value={s.id}>{s.name}</option>
            ))}
          </select>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">–ö–æ–ª-–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤</label>
            <input
              type="number"
              value={form.expectedCount}
              onChange={(e) => setForm({ ...form, expectedCount: parseInt(e.target.value) || 10 })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">–í–µ—Ä—Å–∏—è –∫–æ–Ω—Ñ–∏–≥–∞</label>
            <input
              type="text"
              value={form.configVersion}
              onChange={(e) => setForm({ ...form, configVersion: e.target.value })}
              placeholder="v1.0"
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea
            value={form.description}
            onChange={(e) => setForm({ ...form, description: e.target.value })}
            rows={2}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>

        <div className="flex justify-end gap-3 pt-4">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å"}
          </button>
        </div>
      </form>
    </Modal>
  );
};


const EditClusterModal: React.FC<{
  isOpen: boolean;
  cluster: BeryllCluster;
  shipments: BeryllShipment[];
  onClose: () => void;
  onSuccess: () => void;
}> = ({ isOpen, cluster, shipments, onClose, onSuccess }) => {
  const [form, setForm] = useState({ ...cluster });
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    setForm({ ...cluster });
  }, [cluster]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      setSaving(true);
      await updateCluster(cluster.id, form);
      toast.success("–ö–ª–∞—Å—Ç–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input
            type="text"
            value={form.name}
            onChange={(e) => setForm({ ...form, name: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–°—Ç–∞—Ç—É—Å</label>
          <select
            value={form.status}
            onChange={(e) => setForm({ ...form, status: e.target.value as ClusterStatus })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            {Object.entries(CLUSTER_STATUS_CONFIG).map(([value, config]) => (
              <option key={value} value={value}>{config.label}</option>
            ))}
          </select>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–ö–æ–º–ø–ª–µ–∫—Ç</label>
          <select
            value={form.shipmentId || ""}
            onChange={(e) => setForm({ ...form, shipmentId: e.target.value ? parseInt(e.target.value) : null })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="">‚Äî –ë–µ–∑ –∫–æ–º–ø–ª–µ–∫—Ç–∞ ‚Äî</option>
            {shipments.map(s => (
              <option key={s.id} value={s.id}>{s.name}</option>
            ))}
          </select>
        </div>

        <div className="flex justify-end gap-3 pt-4">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
          </button>
        </div>
      </form>
    </Modal>
  );
};


const AddServersModal: React.FC<{
  isOpen: boolean;
  cluster: BeryllCluster;
  onClose: () => void;
  onSuccess: () => void;
}> = ({ isOpen, cluster, onClose, onSuccess }) => {
  const [servers, setServers] = useState<any[]>([]);
  const [selectedIds, setSelectedIds] = useState<number[]>([]);
  const [role, setRole] = useState<ServerRole>("WORKER");
  const [search, setSearch] = useState("");
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    if (isOpen) {
      loadServers();
    }
  }, [isOpen]);

  const loadServers = async () => {
    try {
      setLoading(true);
      const data = await getUnassignedServers({ status: "DONE", limit: 200 });
      setServers(data);
    } catch (error) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤");
    } finally {
      setLoading(false);
    }
  };

  const filteredServers = servers.filter(s =>
    !search ||
    s.apkSerialNumber?.toLowerCase().includes(search.toLowerCase()) ||
    s.hostname?.toLowerCase().includes(search.toLowerCase())
  );

  const toggleServer = (id: number) => {
    setSelectedIds(prev =>
      prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
    );
  };

  const handleSubmit = async () => {
    if (selectedIds.length === 0) {
      toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä—ã");
      return;
    }

    try {
      setSaving(true);
      const result = await addServersToCluster(cluster.id, { serverIds: selectedIds, role });
      toast.success(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${result.added} —Å–µ—Ä–≤–µ—Ä–æ–≤`);
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={`–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—ã –≤ ${cluster.name}`}>
      <div className="space-y-4">
        <div className="flex items-center gap-4">
          <div className="flex-1 relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
            <input
              type="text"
              placeholder="–ü–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="w-full pl-10 pr-4 py-2 border rounded-lg"
            />
          </div>

          <select
            value={role}
            onChange={(e) => setRole(e.target.value as ServerRole)}
            className="px-3 py-2 border rounded-lg"
          >
            {Object.entries(SERVER_ROLE_CONFIG).map(([value, config]) => (
              <option key={value} value={value}>{config.label}</option>
            ))}
          </select>
        </div>

        <div className="border rounded-lg max-h-80 overflow-y-auto">
          {loading ? (
            <div className="p-4 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          ) : filteredServers.length === 0 ? (
            <div className="p-4 text-center text-gray-500">–°–µ—Ä–≤–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
          ) : (
            filteredServers.map(server => (
              <div
                key={server.id}
                className={`
                  p-3 border-b last:border-b-0 cursor-pointer hover:bg-gray-50
                  ${selectedIds.includes(server.id) ? "bg-blue-50" : ""}
                `}
                onClick={() => toggleServer(server.id)}
              >
                <div className="flex items-center gap-3">
                  <input
                    type="checkbox"
                    checked={selectedIds.includes(server.id)}
                    onChange={() => {}}
                    className="w-4 h-4"
                  />
                  <div>
                    <div className="font-medium">{server.apkSerialNumber || `#${server.id}`}</div>
                    <div className="text-xs text-gray-500">{server.hostname} ‚Ä¢ {server.ipAddress}</div>
                  </div>
                </div>
              </div>
            ))
          )}
        </div>

        <div className="text-sm text-gray-500">
          –í—ã–±—Ä–∞–Ω–æ: {selectedIds.length}
        </div>

        <div className="flex justify-end gap-3 pt-4">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            onClick={handleSubmit}
            disabled={saving || selectedIds.length === 0}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ..." : `–î–æ–±–∞–≤–∏—Ç—å (${selectedIds.length})`}
          </button>
        </div>
      </div>
    </Modal>
  );
};

export default ClustersTab;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/tabs/DefectRecordsTab.tsx
================================================================================


import React, { useState, useEffect, useCallback } from "react";
import {
  AlertTriangle, Plus, Search, Filter, FileText, Download,
  Clock, CheckCircle, XCircle, Send, RotateCcw, Repeat,
  ChevronDown, Trash2, Edit, Paperclip, Eye, Calendar,
  Truck, Package, ChevronLeft, ChevronRight, RefreshCw,
  FileSpreadsheet, BarChart3, Loader2, X
} from "lucide-react";
import toast from "react-hot-toast";
import {
  getDefectRecords, getDefectRecordById, createDefectRecord, updateDefectRecord, deleteDefectRecord,
  changeDefectRecordStatus, sendDefectToYadro, returnDefectFromYadro, resolveDefectRecord,
  markDefectAsRepeated, getDefectRecordStats, uploadDefectRecordFile, downloadDefectRecordFile,
  deleteDefectRecordFile, getRepairPartTypes, getDefectStatuses,
  BeryllDefectRecord, DefectRecordStatus, RepairPartType, DefectRecordStats
} from "../../../api/beryll/beryllExtendedApi";
import { getServers } from "../../../api/beryllApi";
import { getUsers } from "../../../api/userApi";
import { Modal } from "../../../components/Modal/Modal";
import { ConfirmModal } from "../../../components/Modal/ConfirmModal";
import { $authHost } from "../../../api";


interface DefectExportParams {
  status?: string;
  dateFrom?: string;
  dateTo?: string;
  serverId?: number;
  search?: string;
}

const exportDefectsToExcel = async (params: DefectExportParams = {}): Promise<Blob> => {
  const response = await $authHost.get("api/beryll/defect-records/export", {
    params,
    responseType: "blob"
  });
  return response.data;
};

const exportDefectStatsToExcel = async (): Promise<Blob> => {
  const response = await $authHost.get("api/beryll/defect-records/export/stats", {
    responseType: "blob"
  });
  return response.data;
};

const downloadBlob = (blob: Blob, filename: string): void => {
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.setAttribute("download", filename);
  document.body.appendChild(link);
  link.click();
  link.remove();
  window.URL.revokeObjectURL(url);
};


function getServerDisplaySerial(record: BeryllDefectRecord): string {
  return record.serverSerial || record.server?.apkSerialNumber || `#${record.serverId}`;
}


const STATUS_CONFIG: Record<DefectRecordStatus, { label: string; color: string; bg: string; icon: React.ReactNode }> = {
  NEW: { label: "–ù–æ–≤—ã–π", color: "text-blue-600", bg: "bg-blue-100", icon: <Clock size={14} /> },
  DIAGNOSING: { label: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞", color: "text-purple-600", bg: "bg-purple-100", icon: <Eye size={14} /> },
  WAITING_PARTS: { label: "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π", color: "text-yellow-600", bg: "bg-yellow-100", icon: <Clock size={14} /> },
  REPAIRING: { label: "–í —Ä–µ–º–æ–Ω—Ç–µ", color: "text-orange-600", bg: "bg-orange-100", icon: <RotateCcw size={14} /> },
  SENT_TO_YADRO: { label: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –Ø–¥—Ä–æ", color: "text-indigo-600", bg: "bg-indigo-100", icon: <Send size={14} /> },
  RETURNED: { label: "–í–æ–∑–≤—Ä–∞—â—ë–Ω –∏–∑ –Ø–¥—Ä–æ", color: "text-cyan-600", bg: "bg-cyan-100", icon: <RotateCcw size={14} /> },
  RESOLVED: { label: "–†–µ—à—ë–Ω", color: "text-green-600", bg: "bg-green-100", icon: <CheckCircle size={14} /> },
  REPEATED: { label: "–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫", color: "text-red-600", bg: "bg-red-100", icon: <Repeat size={14} /> },
  CLOSED: { label: "–ó–∞–∫—Ä—ã—Ç", color: "text-gray-600", bg: "bg-gray-100", icon: <XCircle size={14} /> }
};


const PART_TYPE_LABELS: Record<RepairPartType, string> = {
  RAM: "–û–ó–£",
  MOTHERBOARD: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞",
  CPU: "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä",
  HDD: "HDD –¥–∏—Å–∫",
  SSD: "SSD –¥–∏—Å–∫",
  PSU: "–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è",
  FAN: "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä",
  RAID: "RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä",
  NIC: "–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞",
  BACKPLANE: "Backplane",
  BMC: "BMC –º–æ–¥—É–ª—å",
  CABLE: "–ö–∞–±–µ–ª—å",
  OTHER: "–î—Ä—É–≥–æ–µ"
};


interface ExportButtonProps {
  currentFilters?: DefectExportParams;
  className?: string;
}

const ExportButton: React.FC<ExportButtonProps> = ({ currentFilters, className = "" }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [loading, setLoading] = useState<string | null>(null);
  const dropdownRef = React.useRef<HTMLDivElement>(null);


  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleExportAll = async () => {
    setLoading("all");
    try {
      const blob = await exportDefectsToExcel({});
      const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      downloadBlob(blob, `–ë—Ä–∞–∫_—Å–µ—Ä–≤–µ—Ä–æ–≤_${date}.xlsx`);
      toast.success("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω");
    } catch (error: any) {
      console.error("Export error:", error);
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞");
    } finally {
      setLoading(null);
      setIsOpen(false);
    }
  };

  const handleExportFiltered = async () => {
    if (!currentFilters) {
      toast.error("–§–∏–ª—å—Ç—Ä—ã –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã");
      return;
    }
    setLoading("filtered");
    try {
      const blob = await exportDefectsToExcel(currentFilters);
      const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      downloadBlob(blob, `–ë—Ä–∞–∫_—Å–µ—Ä–≤–µ—Ä–æ–≤_—Ñ–∏–ª—å—Ç—Ä_${date}.xlsx`);
      toast.success("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω");
    } catch (error: any) {
      console.error("Export error:", error);
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞");
    } finally {
      setLoading(null);
      setIsOpen(false);
    }
  };

  const handleExportStats = async () => {
    setLoading("stats");
    try {
      const blob = await exportDefectStatsToExcel();
      const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      downloadBlob(blob, `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_–±—Ä–∞–∫–∞_${date}.xlsx`);
      toast.success("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞");
    } catch (error: any) {
      console.error("Export error:", error);
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞");
    } finally {
      setLoading(null);
      setIsOpen(false);
    }
  };

  const hasFilters = currentFilters && (
    currentFilters.status ||
    currentFilters.dateFrom ||
    currentFilters.dateTo ||
    currentFilters.search
  );

  return (
    <div className={`relative ${className}`} ref={dropdownRef}>
      <button
        onClick={() => setIsOpen(!isOpen)}
        disabled={!!loading}
        className="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50"
      >
        {loading ? (
          <Loader2 className="w-4 h-4 animate-spin" />
        ) : (
          <Download size={18} />
        )}
        <span>Excel</span>
        <ChevronDown className={`w-4 h-4 transition-transform ${isOpen ? "rotate-180" : ""}`} />
      </button>

      {isOpen && (
        <div className="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
          <button
            onClick={handleExportAll}
            disabled={!!loading}
            className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 text-left transition-colors disabled:opacity-50"
          >
            <FileSpreadsheet className="w-5 h-5 text-green-600" />
            <div>
              <div className="font-medium text-gray-900 text-sm">–í—Å–µ –∑–∞–ø–∏—Å–∏</div>
              <div className="text-xs text-gray-500">–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤</div>
            </div>
            {loading === "all" && <Loader2 className="w-4 h-4 animate-spin ml-auto" />}
          </button>

          <button
            onClick={handleExportFiltered}
            disabled={!!loading || !hasFilters}
            className={`w-full flex items-center gap-3 px-4 py-2.5 text-left transition-colors disabled:opacity-50 ${hasFilters ? "hover:bg-gray-50" : "cursor-not-allowed"}`}
          >
            <FileSpreadsheet className="w-5 h-5 text-blue-600" />
            <div>
              <div className="font-medium text-gray-900 text-sm">–° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏</div>
              <div className="text-xs text-gray-500">
                {hasFilters ? "–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏" : "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã"}
              </div>
            </div>
            {loading === "filtered" && <Loader2 className="w-4 h-4 animate-spin ml-auto" />}
          </button>

          <div className="border-t border-gray-200 my-1" />

          <button
            onClick={handleExportStats}
            disabled={!!loading}
            className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 text-left transition-colors disabled:opacity-50"
          >
            <BarChart3 className="w-5 h-5 text-purple-600" />
            <div>
              <div className="font-medium text-gray-900 text-sm">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
              <div className="text-xs text-gray-500">–°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∏ —Ç–∏–ø–∞–º</div>
            </div>
            {loading === "stats" && <Loader2 className="w-4 h-4 animate-spin ml-auto" />}
          </button>
        </div>
      )}
    </div>
  );
};


const DefectRecordsTab: React.FC = () => {
  const [records, setRecords] = useState<BeryllDefectRecord[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [page, setPage] = useState(1);
  const [selectedRecord, setSelectedRecord] = useState<BeryllDefectRecord | null>(null);
  const [stats, setStats] = useState<DefectRecordStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [showStats, setShowStats] = useState(false);


  const [filters, setFilters] = useState({
    search: "",
    status: "" as DefectRecordStatus | "",
    repairPartType: "" as RepairPartType | "",
    isRepeatedDefect: "" as "" | "true" | "false",
    dateFrom: "",
    dateTo: ""
  });
  const [showFilters, setShowFilters] = useState(false);


  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showStatusModal, setShowStatusModal] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);


  const [servers, setServers] = useState<any[]>([]);
  const [users, setUsers] = useState<any[]>([]);

  const LIMIT = 20;


  const getExportParams = useCallback((): DefectExportParams => {
    return {
      status: filters.status || undefined,
      dateFrom: filters.dateFrom || undefined,
      dateTo: filters.dateTo || undefined,
      search: filters.search || undefined
    };
  }, [filters]);


  const loadRecords = async () => {
    try {
      setLoading(true);
      const params: any = {
        limit: LIMIT,
        offset: (page - 1) * LIMIT
      };

      if (filters.search) params.search = filters.search;
      if (filters.status) params.status = filters.status;
      if (filters.repairPartType) params.repairPartType = filters.repairPartType;
      if (filters.isRepeatedDefect) params.isRepeatedDefect = filters.isRepeatedDefect;
      if (filters.dateFrom) params.dateFrom = filters.dateFrom;
      if (filters.dateTo) params.dateTo = filters.dateTo;

      const data = await getDefectRecords(params);
      setRecords(data.rows);
      setTotalCount(data.count);
    } catch (error: any) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π");
    } finally {
      setLoading(false);
    }
  };

  const loadStats = async () => {
    try {
      const data = await getDefectRecordStats();
      setStats(data);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
    }
  };

  const loadRecordDetails = async (id: number) => {
    try {
      const data = await getDefectRecordById(id);
      setSelectedRecord(data);
    } catch (error) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–∏");
    }
  };

  const loadServers = async () => {
    try {
      const data = await getServers({});
      setServers(data);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤:", error);
    }
  };

  const loadUsers = async () => {
    try {
      const data = await getUsers();
      setUsers(data);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", error);
    }
  };

  useEffect(() => {
    loadRecords();
  }, [page, filters]);

  useEffect(() => {
    loadStats();
    loadServers();
    loadUsers();
  }, []);

  const totalPages = Math.ceil(totalCount / LIMIT);


  const closeDetails = () => {
    setSelectedRecord(null);
  };


  const formatDate = (dateStr: string | null) => {
    if (!dateStr) return "‚Äî";
    return new Date(dateStr).toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric"
    });
  };

  const formatDateTime = (dateStr: string | null) => {
    if (!dateStr) return "‚Äî";
    return new Date(dateStr).toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  };


  const RecordRow: React.FC<{ record: BeryllDefectRecord }> = ({ record }) => {
    const statusConfig = STATUS_CONFIG[record.status];

    return (
      <tr
        className={`hover:bg-gray-50 cursor-pointer ${selectedRecord?.id === record.id ? "bg-blue-50" : ""} ${record.isRepeatedDefect ? "bg-red-50/30" : ""}`}
        onClick={() => loadRecordDetails(record.id)}
      >

        <td className="px-3 py-2 text-sm">
          <div className="font-mono text-blue-600">{record.yadroTicketNumber || "‚Äî"}</div>
          <div className="text-xs text-gray-400">#{record.id}</div>
        </td>


        <td className="px-3 py-2 text-sm">
          <div className="font-medium font-mono">{getServerDisplaySerial(record)}</div>
        </td>


        <td className="px-3 py-2 text-sm text-center">
          {record.hasSPISI ? (
            <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">–î–∞</span>
          ) : (
            <span className="text-gray-400">‚Äî</span>
          )}
        </td>


        <td className="px-3 py-2 text-sm">
          {record.clusterCode ? (
            <span className="font-mono text-xs bg-gray-100 px-2 py-0.5 rounded">{record.clusterCode}</span>
          ) : (
            <span className="text-gray-400">‚Äî</span>
          )}
        </td>


        <td className="px-3 py-2 text-sm max-w-[200px]">
          <div className="line-clamp-2" title={record.problemDescription}>{record.problemDescription}</div>
        </td>


        <td className="px-3 py-2 text-sm">
          {record.repairPartType ? (
            <span className="px-2 py-0.5 bg-gray-100 rounded text-xs">
              {PART_TYPE_LABELS[record.repairPartType]}
            </span>
          ) : (
            <span className="text-gray-400">‚Äî</span>
          )}
        </td>


        <td className="px-3 py-2 text-xs">
          {record.defectPartSerialYadro || record.defectPartSerialManuf ? (
            <div className="space-y-0.5">
              {record.defectPartSerialYadro && (
                <div className="font-mono text-red-600" title="S/N –Ø–¥—Ä–æ">{record.defectPartSerialYadro}</div>
              )}
              {record.defectPartSerialManuf && (
                <div className="font-mono text-gray-500" title="S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è">{record.defectPartSerialManuf}</div>
              )}
            </div>
          ) : (
            <span className="text-gray-400">‚Äî</span>
          )}
        </td>


        <td className="px-3 py-2 text-xs">
          {record.replacementPartSerialYadro || record.replacementPartSerialManuf ? (
            <div className="space-y-0.5">
              {record.replacementPartSerialYadro && (
                <div className="font-mono text-green-600" title="S/N –Ø–¥—Ä–æ">{record.replacementPartSerialYadro}</div>
              )}
              {record.replacementPartSerialManuf && (
                <div className="font-mono text-gray-500" title="S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è">{record.replacementPartSerialManuf}</div>
              )}
            </div>
          ) : (
            <span className="text-gray-400">‚Äî</span>
          )}
        </td>


        <td className="px-3 py-2">
          <span className={`inline-flex items-center gap-1 text-xs px-2 py-1 rounded ${statusConfig.bg} ${statusConfig.color}`}>
            {statusConfig.icon}
            {statusConfig.label}
          </span>
          {record.isRepeatedDefect && (
            <div className="text-xs text-red-500 mt-1 flex items-center gap-1">
              <Repeat size={10} />
              –ü–æ–≤—Ç–æ—Ä–Ω—ã–π
            </div>
          )}
        </td>


        <td className="px-3 py-2 text-sm text-gray-500">
          {formatDate(record.detectedAt)}
        </td>


        <td className="px-3 py-2 text-sm">
          {record.diagnostician ? (
            <span title={`${record.diagnostician.name || ""} ${record.diagnostician.surname || ""}`}>
              {record.diagnostician.surname || ""} {record.diagnostician.name?.[0] || ""}.
            </span>
          ) : (
            <span className="text-gray-400">‚Äî</span>
          )}
        </td>


        <td className="px-3 py-2 text-xs">
          {record.sentToYadroAt ? (
            <div className="space-y-0.5">
              <div className="flex items-center gap-1 text-indigo-600" title="–û—Ç–ø—Ä–∞–≤–ª–µ–Ω">
                <Truck size={12} />
                {formatDate(record.sentToYadroAt)}
              </div>
              {record.returnedFromYadroAt && (
                <div className="flex items-center gap-1 text-green-600" title="–í–æ–∑–≤—Ä–∞—â—ë–Ω">
                  <Package size={12} />
                  {formatDate(record.returnedFromYadroAt)}
                </div>
              )}
            </div>
          ) : (
            <span className="text-gray-400">‚Äî</span>
          )}
        </td>


        <td className="px-3 py-2 text-xs">
          {record.substituteServerSerial ? (
            <span className="font-mono bg-yellow-100 px-1.5 py-0.5 rounded text-yellow-800">
              {record.substituteServerSerial}
            </span>
          ) : (
            <span className="text-gray-400">‚Äî</span>
          )}
        </td>
      </tr>
    );
  };


  const StatsCard: React.FC<{ title: string; value: number | string; color?: string }> = ({ title, value, color = "text-gray-900" }) => (
    <div className="bg-white rounded-lg shadow p-4">
      <div className="text-sm text-gray-500">{title}</div>
      <div className={`text-2xl font-bold ${color}`}>{value}</div>
    </div>
  );

  return (
    <div className="p-4">

      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold flex items-center gap-2">
          <AlertTriangle className="text-red-500" />
          –£—á—ë—Ç –±—Ä–∞–∫–∞
        </h2>

        <div className="flex items-center gap-3">

          <ExportButton currentFilters={getExportParams()} />

          <button
            onClick={() => setShowStats(!showStats)}
            className={`px-3 py-2 rounded-lg border ${showStats ? "bg-blue-50 border-blue-300" : ""}`}
          >
            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          </button>

          <button
            onClick={() => setShowFilters(!showFilters)}
            className={`flex items-center gap-2 px-3 py-2 rounded-lg border ${showFilters ? "bg-blue-50 border-blue-300" : ""}`}
          >
            <Filter size={18} />
            –§–∏–ª—å—Ç—Ä—ã
          </button>

          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
            <input
              type="text"
              placeholder="–ü–æ–∏—Å–∫..."
              value={filters.search}
              onChange={(e) => setFilters({ ...filters, search: e.target.value })}
              className="pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <button
            onClick={() => setShowCreateModal(true)}
            className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            <Plus size={18} />
            –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
          </button>
        </div>
      </div>


      {showStats && stats && (
        <div className="grid grid-cols-6 gap-4 mb-4">
          <StatsCard title="–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π" value={stats.total} />
          <StatsCard title="–ù–æ–≤—ã—Ö" value={stats.byStatus.NEW || 0} color="text-blue-600" />
          <StatsCard title="–í —Ä–∞–±–æ—Ç–µ" value={(stats.byStatus.DIAGNOSING || 0) + (stats.byStatus.REPAIRING || 0)} color="text-orange-600" />
          <StatsCard title="–†–µ—à–µ–Ω–æ" value={stats.byStatus.RESOLVED || 0} color="text-green-600" />
          <StatsCard title="–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫" value={`${stats.repeatedCount} (${stats.repeatedPercent}%)`} color="text-red-600" />
          <StatsCard title="–í –Ø–¥—Ä–æ" value={stats.sentToYadroCount} color="text-indigo-600" />
        </div>
      )}


      {showFilters && (
        <div className="bg-gray-50 rounded-lg p-4 mb-4 grid grid-cols-6 gap-4">
          <div>
            <label className="block text-xs font-medium mb-1">–°—Ç–∞—Ç—É—Å</label>
            <select
              value={filters.status}
              onChange={(e) => setFilters({ ...filters, status: e.target.value as DefectRecordStatus | "" })}
              className="w-full px-3 py-2 border rounded-lg text-sm"
            >
              <option value="">–í—Å–µ</option>
              {Object.entries(STATUS_CONFIG).map(([value, config]) => (
                <option key={value} value={value}>{config.label}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-xs font-medium mb-1">–¢–∏–ø –¥–µ—Ç–∞–ª–∏</label>
            <select
              value={filters.repairPartType}
              onChange={(e) => setFilters({ ...filters, repairPartType: e.target.value as RepairPartType | "" })}
              className="w-full px-3 py-2 border rounded-lg text-sm"
            >
              <option value="">–í—Å–µ</option>
              {Object.entries(PART_TYPE_LABELS).map(([value, label]) => (
                <option key={value} value={value}>{label}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-xs font-medium mb-1">–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫</label>
            <select
              value={filters.isRepeatedDefect}
              onChange={(e) => setFilters({ ...filters, isRepeatedDefect: e.target.value as "" | "true" | "false" })}
              className="w-full px-3 py-2 border rounded-lg text-sm"
            >
              <option value="">–í—Å–µ</option>
              <option value="true">–î–∞</option>
              <option value="false">–ù–µ—Ç</option>
            </select>
          </div>

          <div>
            <label className="block text-xs font-medium mb-1">–î–∞—Ç–∞ –æ—Ç</label>
            <input
              type="date"
              value={filters.dateFrom}
              onChange={(e) => setFilters({ ...filters, dateFrom: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg text-sm"
            />
          </div>

          <div>
            <label className="block text-xs font-medium mb-1">–î–∞—Ç–∞ –¥–æ</label>
            <input
              type="date"
              value={filters.dateTo}
              onChange={(e) => setFilters({ ...filters, dateTo: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg text-sm"
            />
          </div>

          <div className="flex items-end">
            <button
              onClick={() => setFilters({ search: "", status: "", repairPartType: "", isRepeatedDefect: "", dateFrom: "", dateTo: "" })}
              className="px-4 py-2 text-sm text-gray-600 hover:text-gray-900"
            >
              –°–±—Ä–æ—Å–∏—Ç—å
            </button>
          </div>
        </div>
      )}

      <div className="flex gap-4">

        <div className="flex-1 bg-white rounded-lg shadow overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–ó–∞—è–≤–∫–∞</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–°–µ—Ä–≤–µ—Ä</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–°–ü–∏–°–ò</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–ö–ª–∞—Å—Ç–µ—Ä</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–ü—Ä–æ–±–ª–µ–º–∞</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–î–µ—Ç–∞–ª—å</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">S/N –±—Ä–∞–∫</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">S/N –∑–∞–º–µ–Ω–∞</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–°—Ç–∞—Ç—É—Å</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–î–∞—Ç–∞</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–î–∏–∞–≥–Ω–æ—Å—Ç</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–Ø–¥—Ä–æ</th>
                  <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 whitespace-nowrap">–ü–æ–¥–º–µ–Ω–∞</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {loading ? (
                  <tr>
                    <td colSpan={13} className="px-4 py-8 text-center text-gray-500">
                      <RefreshCw className="animate-spin mx-auto mb-2" size={24} />
                      –ó–∞–≥—Ä—É–∑–∫–∞...
                    </td>
                  </tr>
                ) : records.length === 0 ? (
                  <tr>
                    <td colSpan={13} className="px-4 py-8 text-center text-gray-500">–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                  </tr>
                ) : (
                  records.map(record => <RecordRow key={record.id} record={record} />)
                )}
              </tbody>
            </table>
          </div>


          {totalPages > 1 && (
            <div className="px-4 py-3 border-t flex items-center justify-between">
              <div className="text-sm text-gray-500">
                –ü–æ–∫–∞–∑–∞–Ω–æ {(page - 1) * LIMIT + 1} - {Math.min(page * LIMIT, totalCount)} –∏–∑ {totalCount}
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => setPage(p => Math.max(1, p - 1))}
                  disabled={page === 1}
                  className="px-3 py-1 border rounded disabled:opacity-50"
                >
                  <ChevronLeft size={16} />
                </button>
                <span className="px-3 py-1">{page} / {totalPages}</span>
                <button
                  onClick={() => setPage(p => Math.min(totalPages, p + 1))}
                  disabled={page === totalPages}
                  className="px-3 py-1 border rounded disabled:opacity-50"
                >
                  <ChevronRight size={16} />
                </button>
              </div>
            </div>
          )}
        </div>


        {selectedRecord && (
          <div className="w-96 flex-shrink-0">
            <RecordDetails
              record={selectedRecord}
              users={users}
              onUpdate={() => {
                loadRecordDetails(selectedRecord.id);
                loadRecords();
              }}
              onEdit={() => setShowEditModal(true)}
              onDelete={() => setShowDeleteConfirm(true)}
              onStatusChange={() => setShowStatusModal(true)}
              onClose={closeDetails}
            />
          </div>
        )}
      </div>


      <CreateRecordModal
        isOpen={showCreateModal}
        servers={servers}
        users={users}
        onClose={() => setShowCreateModal(false)}
        onSuccess={() => {
          loadRecords();
          loadStats();
          setShowCreateModal(false);
        }}
      />

      {selectedRecord && (
        <>
          <EditRecordModal
            isOpen={showEditModal}
            record={selectedRecord}
            servers={servers}
            users={users}
            onClose={() => setShowEditModal(false)}
            onSuccess={() => {
              loadRecordDetails(selectedRecord.id);
              loadRecords();
              setShowEditModal(false);
            }}
          />

          <StatusModal
            isOpen={showStatusModal}
            record={selectedRecord}
            onClose={() => setShowStatusModal(false)}
            onSuccess={() => {
              loadRecordDetails(selectedRecord.id);
              loadRecords();
              loadStats();
              setShowStatusModal(false);
            }}
          />


          <ConfirmModal
            isOpen={showDeleteConfirm}
            title="–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?"
            message="–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ"
            onConfirm={async () => {
              try {
                await deleteDefectRecord(selectedRecord.id);
                toast.success("–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞");
                setSelectedRecord(null);
                loadRecords();
                loadStats();
              } catch (error: any) {
                toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
              }
              setShowDeleteConfirm(false);
            }}
            onCancel={() => setShowDeleteConfirm(false)}
            confirmColor="red"
          />
        </>
      )}
    </div>
  );
};


const RecordDetails: React.FC<{
  record: BeryllDefectRecord;
  users: any[];
  onUpdate: () => void;
  onEdit: () => void;
  onDelete: () => void;
  onStatusChange: () => void;
  onClose: () => void;
}> = ({ record, users, onUpdate, onEdit, onDelete, onStatusChange, onClose }) => {
  const statusConfig = STATUS_CONFIG[record.status];
  const [uploading, setUploading] = useState(false);
  const [fileToDelete, setFileToDelete] = useState<{id: number; name: string} | null>(null);
  const fileInputRef = React.useRef<HTMLInputElement>(null);

  const formatDate = (dateStr: string | null) => {
    if (!dateStr) return "‚Äî";
    return new Date(dateStr).toLocaleDateString("ru-RU");
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      setUploading(true);
      await uploadDefectRecordFile(record.id, file);
      toast.success("–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω");
      onUpdate();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
    } finally {
      setUploading(false);

      if (fileInputRef.current) {
        fileInputRef.current.value = "";
      }
    }
  };

  const handleFileDownload = async (fileId: number, fileName: string) => {
    try {
      const blob = await downloadDefectRecordFile(fileId);
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (error) {
      toast.error("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è");
    }
  };

  const confirmDeleteFile = async () => {
    if (!fileToDelete) return;
    try {
      await deleteDefectRecordFile(fileToDelete.id);
      toast.success("–§–∞–π–ª —É–¥–∞–ª—ë–Ω");
      onUpdate();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    } finally {
      setFileToDelete(null);
    }
  };

  return (
    <div className="bg-white rounded-lg shadow">

      <div className="p-4 border-b">
        <div className="flex items-center justify-between mb-2">
          <span className={`inline-flex items-center gap-1 text-xs px-2 py-1 rounded ${statusConfig.bg} ${statusConfig.color}`}>
            {statusConfig.icon}
            {statusConfig.label}
          </span>
          <div className="flex items-center gap-1">
            <button onClick={onEdit} className="p-1.5 hover:bg-gray-100 rounded" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
              <Edit size={16} />
            </button>
            <button onClick={onDelete} className="p-1.5 hover:bg-red-100 text-red-500 rounded" title="–£–¥–∞–ª–∏—Ç—å">
              <Trash2 size={16} />
            </button>

            <button onClick={onClose} className="p-1.5 hover:bg-gray-100 rounded ml-2" title="–ó–∞–∫—Ä—ã—Ç—å">
              <X size={16} />
            </button>
          </div>
        </div>

        {record.yadroTicketNumber && (
          <div className="text-lg font-semibold">{record.yadroTicketNumber}</div>
        )}

        <div className="text-sm text-gray-500">
          –°–µ—Ä–≤–µ—Ä: <span className="font-mono">{getServerDisplaySerial(record)}</span>
        </div>
      </div>


      <div className="p-3 border-b bg-gray-50">
        <button
          onClick={onStatusChange}
          className="w-full px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700"
        >
          –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        </button>
      </div>


      <div className="p-4 space-y-3 text-sm max-h-[calc(100vh-400px)] overflow-y-auto">

        <div className="grid grid-cols-2 gap-2">
          <div>
            <div className="text-gray-500">–°–ü–∏–°–ò:</div>
            <div>{record.hasSPISI ? <span className="text-green-600 font-medium">–î–∞</span> : "–ù–µ—Ç"}</div>
          </div>
          {record.clusterCode && (
            <div>
              <div className="text-gray-500">–ö–ª–∞—Å—Ç–µ—Ä:</div>
              <div className="font-mono">{record.clusterCode}</div>
            </div>
          )}
        </div>

        <div>
          <div className="text-gray-500">–ü—Ä–æ–±–ª–µ–º–∞:</div>
          <div>{record.problemDescription}</div>
        </div>

        {record.repairPartType && (
          <div>
            <div className="text-gray-500">–¢–∏–ø –¥–µ—Ç–∞–ª–∏:</div>
            <div>{PART_TYPE_LABELS[record.repairPartType]}</div>
          </div>
        )}


        {(record.defectPartSerialYadro || record.defectPartSerialManuf) && (
          <div className="p-2 bg-red-50 rounded border border-red-100">
            <div className="text-red-600 font-medium text-xs mb-1">S/N –±—Ä–∞–∫–æ–≤–∞–Ω–Ω–æ–π –¥–µ—Ç–∞–ª–∏</div>
            {record.defectPartSerialYadro && (
              <div className="font-mono text-sm">–Ø–¥—Ä–æ: {record.defectPartSerialYadro}</div>
            )}
            {record.defectPartSerialManuf && (
              <div className="font-mono text-sm text-gray-600">–ü—Ä–æ–∏–∑–≤.: {record.defectPartSerialManuf}</div>
            )}
          </div>
        )}


        {(record.replacementPartSerialYadro || record.replacementPartSerialManuf) && (
          <div className="p-2 bg-green-50 rounded border border-green-100">
            <div className="text-green-600 font-medium text-xs mb-1">S/N –∑–∞–º–µ–Ω—ã</div>
            {record.replacementPartSerialYadro && (
              <div className="font-mono text-sm">–Ø–¥—Ä–æ: {record.replacementPartSerialYadro}</div>
            )}
            {record.replacementPartSerialManuf && (
              <div className="font-mono text-sm text-gray-600">–ü—Ä–æ–∏–∑–≤.: {record.replacementPartSerialManuf}</div>
            )}
          </div>
        )}

        {record.diagnosisResult && (
          <div>
            <div className="text-gray-500">–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</div>
            <div>{record.diagnosisResult}</div>
          </div>
        )}

        {record.repairDetails && (
          <div>
            <div className="text-gray-500">–î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞:</div>
            <div>{record.repairDetails}</div>
          </div>
        )}

        {record.notes && (
          <div>
            <div className="text-gray-500">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</div>
            <div>{record.notes}</div>
          </div>
        )}

        {record.isRepeatedDefect && (
          <div className="p-2 bg-red-50 rounded border border-red-200">
            <div className="text-red-600 font-medium flex items-center gap-1">
              <Repeat size={14} />
              –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫
            </div>
            {record.repeatedDefectReason && (
              <div className="text-sm mt-1">{record.repeatedDefectReason}</div>
            )}
            {record.repeatedDefectDate && (
              <div className="text-xs text-gray-500 mt-1">–î–∞—Ç–∞: {formatDate(record.repeatedDefectDate)}</div>
            )}
          </div>
        )}

        {record.sentToYadroRepair && (
          <div className="p-2 bg-indigo-50 rounded border border-indigo-200">
            <div className="text-indigo-600 font-medium flex items-center gap-1">
              <Truck size={14} />
              –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –Ø–¥—Ä–æ
            </div>
            {record.sentToYadroAt && (
              <div className="text-xs mt-1">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω: {formatDate(record.sentToYadroAt)}</div>
            )}
            {record.returnedFromYadroAt && (
              <div className="text-xs text-green-600">–í–æ–∑–≤—Ä–∞—â—ë–Ω: {formatDate(record.returnedFromYadroAt)}</div>
            )}
            {record.substituteServerSerial && (
              <div className="text-xs mt-1">
                <span className="text-gray-500">–ü–æ–¥–º–µ–Ω–Ω—ã–π:</span>{" "}
                <span className="font-mono">{record.substituteServerSerial}</span>
              </div>
            )}
          </div>
        )}

        {record.resolution && (
          <div className="p-2 bg-green-50 rounded border border-green-200">
            <div className="text-green-600 font-medium">–†–µ–∑–æ–ª—é—Ü–∏—è</div>
            <div className="text-sm">{record.resolution}</div>
          </div>
        )}

        <div className="pt-2 border-t text-xs text-gray-500 space-y-1">
          <div>–û–±–Ω–∞—Ä—É–∂–µ–Ω: {new Date(record.detectedAt).toLocaleString()}</div>
          {record.diagnostician && (
            <div>–î–∏–∞–≥–Ω–æ—Å—Ç: {record.diagnostician.name} {record.diagnostician.surname}</div>
          )}
          {record.resolvedAt && (
            <div>–†–µ—à—ë–Ω: {new Date(record.resolvedAt).toLocaleString()}</div>
          )}
        </div>
      </div>


      <div className="p-4 border-t">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm font-medium flex items-center gap-1">
            <Paperclip size={14} />
            –§–∞–π–ª—ã ({record.files?.length || 0})
          </span>
          <label className="text-sm text-blue-600 hover:text-blue-800 cursor-pointer">
            {uploading ? (
              <span className="flex items-center gap-1">
                <Loader2 size={14} className="animate-spin" />
                –ó–∞–≥—Ä—É–∑–∫–∞...
              </span>
            ) : (
              "+ –î–æ–±–∞–≤–∏—Ç—å"
            )}
            <input
              type="file"
              className="hidden"
              ref={fileInputRef}
              onChange={handleFileUpload}
              disabled={uploading}
            />
          </label>
        </div>

        {record.files && record.files.length > 0 && (
          <div className="space-y-1">
            {record.files.map(file => (
              <div key={file.id} className="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                <span className="truncate flex-1" title={file.originalName}>
                  {file.originalName}
                </span>
                <div className="flex items-center gap-1 ml-2">
                  <button
                    onClick={() => handleFileDownload(file.id, file.originalName)}
                    className="p-1 hover:bg-gray-200 rounded"
                    title="–°–∫–∞—á–∞—Ç—å"
                  >
                    <Download size={14} />
                  </button>
                  <button
                    onClick={() => setFileToDelete({ id: file.id, name: file.originalName })}
                    className="p-1 hover:bg-red-100 text-red-500 rounded"
                    title="–£–¥–∞–ª–∏—Ç—å"
                  >
                    <Trash2 size={14} />
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>


      <ConfirmModal
        isOpen={!!fileToDelete}
        title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?"
        message={`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${fileToDelete?.name}"?`}
        onConfirm={confirmDeleteFile}
        onCancel={() => setFileToDelete(null)}
        confirmColor="red"
      />
    </div>
  );
};


const CreateRecordModal: React.FC<{
  isOpen: boolean;
  servers: any[];
  users: any[];
  onClose: () => void;
  onSuccess: () => void;
}> = ({ isOpen, servers, users, onClose, onSuccess }) => {
  const [form, setForm] = useState({
    serverId: null as number | null,
    serverSerial: "",
    problemDescription: "",
    yadroTicketNumber: "",
    hasSPISI: false,
    clusterCode: "",
    diagnosticianId: null as number | null,
    repairPartType: "" as RepairPartType | "",
    defectPartSerialYadro: "",
    defectPartSerialManuf: "",
    replacementPartSerialYadro: "",
    replacementPartSerialManuf: "",
    diagnosisResult: "",
    notes: "",
    isRepeatedDefect: false,
    repeatedDefectReason: "",
    repeatedDefectDate: "",
    substituteServerSerial: "",
    sentToYadroAt: "",
    returnedFromYadroAt: ""
  });
  const [saving, setSaving] = useState(false);
  const [serverSearch, setServerSearch] = useState("");
  const [manualSerialMode, setManualSerialMode] = useState(false);

  const filteredServers = servers.filter(s =>
    !serverSearch ||
    s.apkSerialNumber?.toLowerCase().includes(serverSearch.toLowerCase()) ||
    s.hostname?.toLowerCase().includes(serverSearch.toLowerCase())
  );


  useEffect(() => {
    if (isOpen) {
      setForm({
        serverId: null,
        serverSerial: "",
        problemDescription: "",
        yadroTicketNumber: "",
        hasSPISI: false,
        clusterCode: "",
        diagnosticianId: null,
        repairPartType: "",
        defectPartSerialYadro: "",
        defectPartSerialManuf: "",
        replacementPartSerialYadro: "",
        replacementPartSerialManuf: "",
        diagnosisResult: "",
        notes: "",
        isRepeatedDefect: false,
        repeatedDefectReason: "",
        repeatedDefectDate: "",
        substituteServerSerial: "",
        sentToYadroAt: "",
        returnedFromYadroAt: ""
      });
      setServerSearch("");
      setManualSerialMode(false);
    }
  }, [isOpen]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();


    if (!form.serverId && !form.serverSerial.trim()) {
      toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é");
      return;
    }
    if (!form.problemDescription.trim()) {
      toast.error("–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É");
      return;
    }

    try {
      setSaving(true);
      await createDefectRecord({
        ...form,
        serverId: form.serverId || undefined,
        serverSerial: form.serverSerial || undefined,
        repairPartType: form.repairPartType || undefined,
        diagnosticianId: form.diagnosticianId || undefined,
        sentToYadroAt: form.sentToYadroAt ? new Date(form.sentToYadroAt).toISOString() : undefined,
        sentToYadroRepair: !!form.sentToYadroAt,
        returnedFromYadroAt: form.returnedFromYadroAt ? new Date(form.returnedFromYadroAt).toISOString() : undefined,
        returnedFromYadro: !!form.returnedFromYadroAt,
        repeatedDefectDate: form.repeatedDefectDate ? new Date(form.repeatedDefectDate).toISOString() : undefined
      });
      toast.success("–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ" size="xl">
      <form onSubmit={handleSubmit} className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
        <div className="grid grid-cols-2 gap-6">

          <div className="space-y-4">
            <h4 className="font-medium text-gray-700 border-b pb-2">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>


            <div>
              <div className="flex items-center justify-between mb-1">
                <label className="block text-sm font-medium">–°–µ—Ä–≤–µ—Ä *</label>
                <button
                  type="button"
                  onClick={() => {
                    setManualSerialMode(!manualSerialMode);
                    if (!manualSerialMode) {

                      setForm({ ...form, serverId: null });
                    } else {

                      setForm({ ...form, serverSerial: "" });
                    }
                  }}
                  className="text-xs text-blue-600 hover:text-blue-800"
                >
                  {manualSerialMode ? "‚Üê –í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞" : "–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é ‚Üí"}
                </button>
              </div>

              {manualSerialMode ? (

                <div>
                  <input
                    type="text"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞"
                    value={form.serverSerial}
                    onChange={(e) => setForm({ ...form, serverSerial: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg border-orange-300 bg-orange-50"
                  />
                  <p className="text-xs text-orange-600 mt-1">
                    –†—É—á–Ω–æ–π –≤–≤–æ–¥ ‚Äî —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –±–∞–∑–µ
                  </p>
                </div>
              ) : (

                <div>
                  <input
                    type="text"
                    placeholder="–ü–æ–∏—Å–∫ –ø–æ S/N, hostname..."
                    value={serverSearch}
                    onChange={(e) => setServerSearch(e.target.value)}
                    className="w-full px-3 py-2 border rounded-lg mb-2"
                  />
                  <div className="max-h-28 overflow-y-auto border rounded-lg">
                    {filteredServers.slice(0, 10).map(server => (
                      <div
                        key={server.id}
                        className={`p-2 cursor-pointer hover:bg-blue-50 border-b last:border-b-0 ${form.serverId === server.id ? "bg-blue-100" : ""}`}
                        onClick={() => setForm({
                          ...form,
                          serverId: server.id,
                          serverSerial: server.apkSerialNumber || ""
                        })}
                      >
                        <div className="font-medium font-mono">{server.apkSerialNumber || `#${server.id}`}</div>
                        <div className="text-xs text-gray-500">{server.hostname}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã *</label>
              <textarea
                value={form.problemDescription}
                onChange={(e) => setForm({ ...form, problemDescription: e.target.value })}
                rows={3}
                placeholder="ECC Error, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä..."
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">–ó–∞—è–≤–∫–∞ –Ø–¥—Ä–æ</label>
                <input
                  type="text"
                  value={form.yadroTicketNumber}
                  onChange={(e) => setForm({ ...form, yadroTicketNumber: e.target.value })}
                  placeholder="INC553187"
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">–ö–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞</label>
                <input
                  type="text"
                  value={form.clusterCode}
                  onChange={(e) => setForm({ ...form, clusterCode: e.target.value })}
                  placeholder="240008"
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">–¢–∏–ø –¥–µ—Ç–∞–ª–∏</label>
                <select
                  value={form.repairPartType}
                  onChange={(e) => setForm({ ...form, repairPartType: e.target.value as RepairPartType | "" })}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                  {Object.entries(PART_TYPE_LABELS).map(([value, label]) => (
                    <option key={value} value={value}>{label}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">–î–∏–∞–≥–Ω–æ—Å—Ç</label>
                <select
                  value={form.diagnosticianId || ""}
                  onChange={(e) => setForm({ ...form, diagnosticianId: e.target.value ? parseInt(e.target.value) : null })}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                  {users.map(user => (
                    <option key={user.id} value={user.id}>
                      {user.surname} {user.name} ({user.login})
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <div className="flex items-center gap-2">
              <input
                type="checkbox"
                id="hasSPISI"
                checked={form.hasSPISI}
                onChange={(e) => setForm({ ...form, hasSPISI: e.target.checked })}
              />
              <label htmlFor="hasSPISI" className="text-sm">–ù–∞–ª–∏—á–∏–µ –°–ü–∏–°–ò</label>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
              <textarea
                value={form.notes}
                onChange={(e) => setForm({ ...form, notes: e.target.value })}
                rows={2}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
          </div>


          <div className="space-y-4">
            <h4 className="font-medium text-gray-700 border-b pb-2">–î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞</h4>


            <div className="p-3 bg-red-50 rounded-lg border border-red-200">
              <div className="text-sm font-medium text-red-700 mb-2">S/N –±—Ä–∞–∫–æ–≤–∞–Ω–Ω–æ–π –¥–µ—Ç–∞–ª–∏</div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">S/N –Ø–¥—Ä–æ</label>
                  <input
                    type="text"
                    value={form.defectPartSerialYadro}
                    onChange={(e) => setForm({ ...form, defectPartSerialYadro: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è</label>
                  <input
                    type="text"
                    value={form.defectPartSerialManuf}
                    onChange={(e) => setForm({ ...form, defectPartSerialManuf: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
              </div>
            </div>


            <div className="p-3 bg-green-50 rounded-lg border border-green-200">
              <div className="text-sm font-medium text-green-700 mb-2">S/N –∑–∞–º–µ–Ω—ã</div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">S/N –Ø–¥—Ä–æ</label>
                  <input
                    type="text"
                    value={form.replacementPartSerialYadro}
                    onChange={(e) => setForm({ ...form, replacementPartSerialYadro: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è</label>
                  <input
                    type="text"
                    value={form.replacementPartSerialManuf}
                    onChange={(e) => setForm({ ...form, replacementPartSerialManuf: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</label>
              <textarea
                value={form.diagnosisResult}
                onChange={(e) => setForm({ ...form, diagnosisResult: e.target.value })}
                rows={2}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>


            <div className="p-3 bg-orange-50 rounded-lg border border-orange-200">
              <label className="flex items-center gap-2 cursor-pointer mb-2">
                <input
                  type="checkbox"
                  checked={form.isRepeatedDefect}
                  onChange={(e) => setForm({ ...form, isRepeatedDefect: e.target.checked })}
                />
                <span className="text-sm font-medium text-orange-700">–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫</span>
              </label>
              {form.isRepeatedDefect && (
                <div className="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <label className="block text-xs text-gray-600 mb-1">–ü—Ä–∏—á–∏–Ω–∞</label>
                    <input
                      type="text"
                      value={form.repeatedDefectReason}
                      onChange={(e) => setForm({ ...form, repeatedDefectReason: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-600 mb-1">–î–∞—Ç–∞</label>
                    <input
                      type="date"
                      value={form.repeatedDefectDate}
                      onChange={(e) => setForm({ ...form, repeatedDefectDate: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                    />
                  </div>
                </div>
              )}
            </div>


            <div>
              <label className="block text-sm font-medium mb-1">–°–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–¥–º–µ–Ω—ã (S/N)</label>
              <input
                type="text"
                value={form.substituteServerSerial}
                onChange={(e) => setForm({ ...form, substituteServerSerial: e.target.value })}
                placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ–¥–º–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>


            <div className="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
              <div className="text-sm font-medium text-indigo-700 mb-2">–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –Ø–¥—Ä–æ</div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                  <input
                    type="date"
                    value={form.sentToYadroAt}
                    onChange={(e) => setForm({ ...form, sentToYadroAt: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</label>
                  <input
                    type="date"
                    value={form.returnedFromYadroAt}
                    onChange={(e) => setForm({ ...form, returnedFromYadroAt: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50"
          >
            {saving ? "–°–æ–∑–¥–∞–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å"}
          </button>
        </div>
      </form>
    </Modal>
  );
};


const EditRecordModal: React.FC<{
  isOpen: boolean;
  record: BeryllDefectRecord;
  servers: any[];
  users: any[];
  onClose: () => void;
  onSuccess: () => void;
}> = ({ isOpen, record, servers, users, onClose, onSuccess }) => {
  const [form, setForm] = useState<any>({});
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    if (record) {
      setForm({
        ...record,
        sentToYadroAt: record.sentToYadroAt ? record.sentToYadroAt.split("T")[0] : "",
        returnedFromYadroAt: record.returnedFromYadroAt ? record.returnedFromYadroAt.split("T")[0] : "",
        repeatedDefectDate: record.repeatedDefectDate ? record.repeatedDefectDate.split("T")[0] : ""
      });
    }
  }, [record]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    try {
      setSaving(true);
      await updateDefectRecord(record.id, {
        ...form,
        sentToYadroAt: form.sentToYadroAt ? new Date(form.sentToYadroAt).toISOString() : null,
        sentToYadroRepair: !!form.sentToYadroAt,
        returnedFromYadroAt: form.returnedFromYadroAt ? new Date(form.returnedFromYadroAt).toISOString() : null,
        returnedFromYadro: !!form.returnedFromYadroAt,
        repeatedDefectDate: form.repeatedDefectDate ? new Date(form.repeatedDefectDate).toISOString() : null
      });
      toast.success("–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å" size="xl">
      <form onSubmit={handleSubmit} className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
        <div className="grid grid-cols-2 gap-6">

          <div className="space-y-4">

            <div>
              <label className="block text-sm font-medium mb-1">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞</label>
              <input
                type="text"
                value={form.serverSerial || ""}
                onChange={(e) => setForm({ ...form, serverSerial: e.target.value })}
                placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä"
                className="w-full px-3 py-2 border rounded-lg font-mono"
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</label>
              <textarea
                value={form.problemDescription || ""}
                onChange={(e) => setForm({ ...form, problemDescription: e.target.value })}
                rows={3}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">–ó–∞—è–≤–∫–∞ –Ø–¥—Ä–æ</label>
                <input
                  type="text"
                  value={form.yadroTicketNumber || ""}
                  onChange={(e) => setForm({ ...form, yadroTicketNumber: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">–ö–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞</label>
                <input
                  type="text"
                  value={form.clusterCode || ""}
                  onChange={(e) => setForm({ ...form, clusterCode: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">–¢–∏–ø –¥–µ—Ç–∞–ª–∏</label>
                <select
                  value={form.repairPartType || ""}
                  onChange={(e) => setForm({ ...form, repairPartType: e.target.value as RepairPartType })}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                  {Object.entries(PART_TYPE_LABELS).map(([value, label]) => (
                    <option key={value} value={value}>{label}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">–î–∏–∞–≥–Ω–æ—Å—Ç</label>
                <select
                  value={form.diagnosticianId || ""}
                  onChange={(e) => setForm({ ...form, diagnosticianId: e.target.value ? parseInt(e.target.value) : null })}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                  {users.map(user => (
                    <option key={user.id} value={user.id}>
                      {user.surname} {user.name} ({user.login})
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <div className="flex items-center gap-2">
              <input
                type="checkbox"
                id="editHasSPISI"
                checked={form.hasSPISI || false}
                onChange={(e) => setForm({ ...form, hasSPISI: e.target.checked })}
              />
              <label htmlFor="editHasSPISI" className="text-sm">–ù–∞–ª–∏—á–∏–µ –°–ü–∏–°–ò</label>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
              <textarea
                value={form.notes || ""}
                onChange={(e) => setForm({ ...form, notes: e.target.value })}
                rows={2}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">–î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞</label>
              <textarea
                value={form.repairDetails || ""}
                onChange={(e) => setForm({ ...form, repairDetails: e.target.value })}
                rows={2}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
          </div>


          <div className="space-y-4">

            <div className="p-3 bg-red-50 rounded-lg border border-red-200">
              <div className="text-sm font-medium text-red-700 mb-2">S/N –±—Ä–∞–∫–æ–≤–∞–Ω–Ω–æ–π –¥–µ—Ç–∞–ª–∏</div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">S/N –Ø–¥—Ä–æ</label>
                  <input
                    type="text"
                    value={form.defectPartSerialYadro || ""}
                    onChange={(e) => setForm({ ...form, defectPartSerialYadro: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è</label>
                  <input
                    type="text"
                    value={form.defectPartSerialManuf || ""}
                    onChange={(e) => setForm({ ...form, defectPartSerialManuf: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
              </div>
            </div>


            <div className="p-3 bg-green-50 rounded-lg border border-green-200">
              <div className="text-sm font-medium text-green-700 mb-2">S/N –∑–∞–º–µ–Ω—ã</div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">S/N –Ø–¥—Ä–æ</label>
                  <input
                    type="text"
                    value={form.replacementPartSerialYadro || ""}
                    onChange={(e) => setForm({ ...form, replacementPartSerialYadro: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è</label>
                  <input
                    type="text"
                    value={form.replacementPartSerialManuf || ""}
                    onChange={(e) => setForm({ ...form, replacementPartSerialManuf: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</label>
              <textarea
                value={form.diagnosisResult || ""}
                onChange={(e) => setForm({ ...form, diagnosisResult: e.target.value })}
                rows={2}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>


            <div className="p-3 bg-orange-50 rounded-lg border border-orange-200">
              <label className="flex items-center gap-2 cursor-pointer mb-2">
                <input
                  type="checkbox"
                  checked={form.isRepeatedDefect || false}
                  onChange={(e) => setForm({ ...form, isRepeatedDefect: e.target.checked })}
                />
                <span className="text-sm font-medium text-orange-700">–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫</span>
              </label>
              {form.isRepeatedDefect && (
                <div className="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <label className="block text-xs text-gray-600 mb-1">–ü—Ä–∏—á–∏–Ω–∞</label>
                    <input
                      type="text"
                      value={form.repeatedDefectReason || ""}
                      onChange={(e) => setForm({ ...form, repeatedDefectReason: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-600 mb-1">–î–∞—Ç–∞</label>
                    <input
                      type="date"
                      value={form.repeatedDefectDate || ""}
                      onChange={(e) => setForm({ ...form, repeatedDefectDate: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                    />
                  </div>
                </div>
              )}
            </div>


            <div>
              <label className="block text-sm font-medium mb-1">–°–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–¥–º–µ–Ω—ã (S/N)</label>
              <input
                type="text"
                value={form.substituteServerSerial || ""}
                onChange={(e) => setForm({ ...form, substituteServerSerial: e.target.value })}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>


            <div className="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
              <div className="text-sm font-medium text-indigo-700 mb-2">–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –Ø–¥—Ä–æ</div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                  <input
                    type="date"
                    value={form.sentToYadroAt || ""}
                    onChange={(e) => setForm({ ...form, sentToYadroAt: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</label>
                  <input
                    type="date"
                    value={form.returnedFromYadroAt || ""}
                    onChange={(e) => setForm({ ...form, returnedFromYadroAt: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
          </button>
        </div>
      </form>
    </Modal>
  );
};


const StatusModal: React.FC<{
  isOpen: boolean;
  record: BeryllDefectRecord;
  onClose: () => void;
  onSuccess: () => void;
}> = ({ isOpen, record, onClose, onSuccess }) => {
  const [newStatus, setNewStatus] = useState<DefectRecordStatus>(record.status);
  const [comment, setComment] = useState("");
  const [substituteSerial, setSubstituteSerial] = useState("");
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    setNewStatus(record.status);
    setComment("");
    setSubstituteSerial("");
  }, [record]);

  const handleSubmit = async () => {
    try {
      setSaving(true);

      if (newStatus === "SENT_TO_YADRO") {
        await sendDefectToYadro(record.id, { substituteServerSerial: substituteSerial, notes: comment });
      } else if (newStatus === "RETURNED") {
        await returnDefectFromYadro(record.id, { notes: comment });
      } else if (newStatus === "RESOLVED") {
        await resolveDefectRecord(record.id, comment);
      } else if (newStatus === "REPEATED") {
        await markDefectAsRepeated(record.id, comment);
      } else {
        await changeDefectRecordStatus(record.id, newStatus, comment);
      }

      toast.success("–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å</label>
          <select
            value={newStatus}
            onChange={(e) => setNewStatus(e.target.value as DefectRecordStatus)}
            className="w-full px-3 py-2 border rounded-lg"
          >
            {Object.entries(STATUS_CONFIG).map(([value, config]) => (
              <option key={value} value={value}>{config.label}</option>
            ))}
          </select>
        </div>

        {newStatus === "SENT_TO_YADRO" && (
          <div>
            <label className="block text-sm font-medium mb-1">S/N –ø–æ–¥–º–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞</label>
            <input
              type="text"
              value={substituteSerial}
              onChange={(e) => setSubstituteSerial(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        )}

        <div>
          <label className="block text-sm font-medium mb-1">
            {newStatus === "RESOLVED" ? "–†–µ–∑–æ–ª—é—Ü–∏—è" : newStatus === "REPEATED" ? "–ü—Ä–∏—á–∏–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –±—Ä–∞–∫–∞" : "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"}
          </label>
          <textarea
            value={comment}
            onChange={(e) => setComment(e.target.value)}
            rows={3}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>

        <div className="flex justify-end gap-3 pt-4">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            onClick={handleSubmit}
            disabled={saving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"}
          </button>
        </div>
      </div>
    </Modal>
  );
};

export default DefectRecordsTab;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/tabs/HistoryTab.tsx
================================================================================

import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import {
  History,
  Search,
  Filter,
  Calendar,
  User,
  Server,
  RefreshCw,
  ChevronLeft,
  ChevronRight,
  Clock,
  ArrowRight,
  Play,
  Square,
  CheckCircle2,
  XCircle,
  MessageSquare,
  Package,
  Trash2,
  FileText
} from "lucide-react";
import {
  getHistory,
  BeryllHistoryItem,
  HistoryAction,
  HISTORY_ACTION_LABELS,
  STATUS_LABELS,
  formatDateTime,
  formatDuration
} from "src/api/beryllApi";

export const HistoryTab: React.FC = () => {
  const navigate = useNavigate();

  const [history, setHistory] = useState<BeryllHistoryItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [totalCount, setTotalCount] = useState(0);


  const [actionFilter, setActionFilter] = useState<HistoryAction | "ALL">("ALL");
  const [dateFrom, setDateFrom] = useState("");
  const [dateTo, setDateTo] = useState("");
  const [showFilters, setShowFilters] = useState(false);

  const loadHistory = async () => {
    setLoading(true);
    try {
      const data = await getHistory({
        action: actionFilter === "ALL" ? undefined : actionFilter,
        dateFrom: dateFrom || undefined,
        dateTo: dateTo || undefined,
        page,
        limit: 50
      });
      setHistory(data.rows);
      setTotalPages(data.totalPages);
      setTotalCount(data.count);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:", e);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadHistory();
  }, [page, actionFilter, dateFrom, dateTo]);

  const resetFilters = () => {
    setActionFilter("ALL");
    setDateFrom("");
    setDateTo("");
    setPage(1);
  };

  const getActionIcon = (action: HistoryAction) => {
    switch (action) {
      case "CREATED": return <Server className="w-4 h-4 text-gray-500" />;
      case "TAKEN": return <Play className="w-4 h-4 text-blue-500" />;
      case "RELEASED": return <Square className="w-4 h-4 text-gray-500" />;
      case "STATUS_CHANGED": return <RefreshCw className="w-4 h-4 text-indigo-500" />;
      case "NOTE_ADDED": return <MessageSquare className="w-4 h-4 text-yellow-500" />;
      case "CHECKLIST_COMPLETED": return <CheckCircle2 className="w-4 h-4 text-green-500" />;
      case "BATCH_ASSIGNED": return <Package className="w-4 h-4 text-purple-500" />;
      case "BATCH_REMOVED": return <Package className="w-4 h-4 text-gray-400" />;
      case "DELETED": return <Trash2 className="w-4 h-4 text-red-500" />;
      default: return <FileText className="w-4 h-4 text-gray-400" />;
    }
  };

  const getActionColor = (action: HistoryAction) => {
    switch (action) {
      case "CREATED": return "bg-gray-100 text-gray-700";
      case "TAKEN": return "bg-blue-100 text-blue-700";
      case "RELEASED": return "bg-gray-100 text-gray-600";
      case "STATUS_CHANGED": return "bg-indigo-100 text-indigo-700";
      case "NOTE_ADDED": return "bg-yellow-100 text-yellow-700";
      case "CHECKLIST_COMPLETED": return "bg-green-100 text-green-700";
      case "BATCH_ASSIGNED": return "bg-purple-100 text-purple-700";
      case "BATCH_REMOVED": return "bg-gray-100 text-gray-600";
      case "DELETED": return "bg-red-100 text-red-700";
      default: return "bg-gray-100 text-gray-600";
    }
  };

  return (
    <div className="space-y-4">

      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div className="flex items-center gap-3">
          <History className="w-5 h-5 text-gray-400" />
          <h2 className="text-lg font-semibold text-gray-800">
            –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
          </h2>
          <span className="text-sm text-gray-500">
            ({totalCount} –∑–∞–ø–∏—Å–µ–π)
          </span>
        </div>

        <div className="flex items-center gap-2">

          <select
            value={actionFilter}
            onChange={(e) => {
              setActionFilter(e.target.value as HistoryAction | "ALL");
              setPage(1);
            }}
            className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          >
            <option value="ALL">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
            {Object.entries(HISTORY_ACTION_LABELS).map(([value, label]) => (
              <option key={value} value={value}>{label}</option>
            ))}
          </select>


          <button
            onClick={() => setShowFilters(!showFilters)}
            className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
              showFilters || dateFrom || dateTo
                ? "bg-indigo-100 text-indigo-700"
                : "bg-gray-100 text-gray-600 hover:bg-gray-200"
            }`}
          >
            <Filter className="w-4 h-4" />
            –§–∏–ª—å—Ç—Ä—ã
          </button>


          {(actionFilter !== "ALL" || dateFrom || dateTo) && (
            <button
              onClick={resetFilters}
              className="px-3 py-2 text-sm text-gray-500 hover:text-gray-700"
            >
              –°–±—Ä–æ—Å–∏—Ç—å
            </button>
          )}
        </div>
      </div>


      {showFilters && (
        <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 flex flex-wrap gap-4">
          <div>
            <label className="block text-xs font-medium text-gray-500 mb-1">
              –î–∞—Ç–∞ —Å
            </label>
            <input
              type="date"
              value={dateFrom}
              onChange={(e) => {
                setDateFrom(e.target.value);
                setPage(1);
              }}
              className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
            />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-500 mb-1">
              –î–∞—Ç–∞ –ø–æ
            </label>
            <input
              type="date"
              value={dateTo}
              onChange={(e) => {
                setDateTo(e.target.value);
                setPage(1);
              }}
              className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
            />
          </div>
        </div>
      )}


      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
        {loading ? (
          <div className="flex items-center justify-center py-12">
            <RefreshCw className="w-6 h-6 animate-spin text-indigo-500" />
            <span className="ml-2 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
          </div>
        ) : history.length === 0 ? (
          <div className="text-center py-12 text-gray-400">
            <History className="w-12 h-12 mx-auto mb-3 opacity-50" />
            <p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
          </div>
        ) : (
          <div className="divide-y divide-gray-100">
            {history.map((item) => (
              <div
                key={item.id}
                className="p-4 hover:bg-gray-50 transition-colors"
              >
                <div className="flex items-start gap-4">

                  <div className={`p-2 rounded-lg ${getActionColor(item.action)}`}>
                    {getActionIcon(item.action)}
                  </div>


                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 flex-wrap">

                      <span className="font-medium text-gray-800">
                        {HISTORY_ACTION_LABELS[item.action]}
                      </span>


                      {item.action === "STATUS_CHANGED" && item.fromStatus && item.toStatus && (
                        <span className="flex items-center gap-1 text-sm text-gray-500">
                          <span className="px-2 py-0.5 bg-gray-100 rounded text-xs">
                            {STATUS_LABELS[item.fromStatus as keyof typeof STATUS_LABELS] || item.fromStatus}
                          </span>
                          <ArrowRight className="w-3 h-3" />
                          <span className="px-2 py-0.5 bg-gray-100 rounded text-xs">
                            {STATUS_LABELS[item.toStatus as keyof typeof STATUS_LABELS] || item.toStatus}
                          </span>
                        </span>
                      )}


                      {item.durationMinutes && (
                        <span className="flex items-center gap-1 text-xs text-gray-500">
                          <Clock className="w-3 h-3" />
                          {formatDuration(item.durationMinutes)}
                        </span>
                      )}
                    </div>


                    <div className="mt-1 flex items-center gap-2 text-sm">
                      <Server className="w-3 h-3 text-gray-400" />
                      {item.server ? (
                        <button
                          onClick={() => navigate(`/beryll/server/${item.server!.id}`)}
                          className="text-indigo-600 hover:underline"
                        >
                          {item.server.ipAddress}
                          {item.server.hostname && (
                            <span className="text-gray-400 ml-1">
                              ({item.server.hostname})
                            </span>
                          )}
                        </button>
                      ) : (
                        <span className="text-gray-400">
                          {item.serverIp || "–°–µ—Ä–≤–µ—Ä —É–¥–∞–ª—ë–Ω"}
                          {item.serverHostname && ` (${item.serverHostname})`}
                        </span>
                      )}
                    </div>


                    {item.comment && (
                      <p className="mt-1 text-sm text-gray-600 line-clamp-2">
                        {item.comment}
                      </p>
                    )}
                  </div>


                  <div className="text-right shrink-0">

                    <div className="text-sm text-gray-500">
                      {formatDateTime(item.createdAt)}
                    </div>


                    {item.user && (
                      <div className="mt-1 flex items-center gap-1 justify-end text-xs text-gray-400">
                        <User className="w-3 h-3" />
                        {item.user.surname} {item.user.name?.charAt(0)}.
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>


      {totalPages > 1 && (
        <div className="flex items-center justify-between">
          <div className="text-sm text-gray-500">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –∏–∑ {totalPages}
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setPage((p) => Math.max(1, p - 1))}
              disabled={page === 1}
              className="flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-lg border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
            >
              <ChevronLeft className="w-4 h-4" />
              –ù–∞–∑–∞–¥
            </button>
            <button
              onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
              disabled={page === totalPages}
              className="flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-lg border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
            >
              –î–∞–ª–µ–µ
              <ChevronRight className="w-4 h-4" />
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default HistoryTab;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/tabs/RacksTab.tsx
================================================================================

import React, { useState, useEffect } from "react";
import {
  Server, Plus, Search, MapPin, Wifi,
  Trash2, Edit, Move, CheckCircle, XCircle, PlusCircle
} from "lucide-react";
import toast from "react-hot-toast";
import {
  getRacks, getRackById, createRack, updateRack, deleteRack,
  installServerInRack, removeServerFromRack,
  createAndPlaceServer, findServerInDhcp,
  BeryllRack, BeryllRackUnit, RackStatus
} from "../../../api/beryll/beryllExtendedApi";
import { getServers } from "../../../api/beryllApi";
import { Modal } from "../../../components/Modal/Modal";
import { ConfirmModal } from "../../../components/Modal/ConfirmModal";


const RACK_STATUS_CONFIG: Record<RackStatus, { label: string; color: string; bg: string }> = {
  ACTIVE: { label: "–ê–∫—Ç–∏–≤–Ω–∞", color: "text-green-600", bg: "bg-green-100" },
  MAINTENANCE: { label: "–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ", color: "text-yellow-600", bg: "bg-yellow-100" },
  DECOMMISSIONED: { label: "–í—ã–≤–µ–¥–µ–Ω–∞", color: "text-gray-600", bg: "bg-gray-100" }
};

const RacksTab: React.FC = () => {
  const [racks, setRacks] = useState<BeryllRack[]>([]);
  const [selectedRack, setSelectedRack] = useState<BeryllRack | null>(null);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");


  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showInstallModal, setShowInstallModal] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);


  const [selectedUnit, setSelectedUnit] = useState<BeryllRackUnit | null>(null);


  const [availableServers, setAvailableServers] = useState<any[]>([]);


  const loadRacks = async () => {
    try {
      setLoading(true);
      const data = await getRacks({ search, includeUnits: false });
      setRacks(data);
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ–µ–∫");
    } finally {
      setLoading(false);
    }
  };


  const loadRackDetails = async (rackId: number) => {
    try {
      const data = await getRackById(rackId);
      setSelectedRack(data);
    } catch (error: any) {
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ–π–∫–∏");
    }
  };


  const loadAvailableServers = async () => {
    try {
      const data = await getServers({});
      setAvailableServers(data);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤:", error);
    }
  };

  useEffect(() => {
    loadRacks();
  }, [search]);

  useEffect(() => {
    if (showInstallModal) {
      loadAvailableServers();
    }
  }, [showInstallModal]);


  const getUnitStatus = (unit: BeryllRackUnit) => {
    if (!unit.serverId) return "empty";
    if (unit.installedAt) return "in_work";
    if (unit.placedAt) return "placed";
    return "placed";
  };

  const renderUnit = (unit: BeryllRackUnit) => {
    const status = getUnitStatus(unit);
    const isEmpty = status === "empty";
    const isInWork = status === "in_work";
    const isPlaced = status === "placed";


    const borderClass = isEmpty
      ? "border-dashed border-gray-300"
      : isInWork
        ? "border-solid border-green-500 border-l-4"
        : "border-solid border-orange-400 border-l-4";

    const bgClass = isEmpty
      ? "bg-gray-50"
      : isInWork
        ? "bg-green-50"
        : "bg-orange-50";

    return (
      <div
        key={unit.id}
        className={`
          p-2 border rounded cursor-pointer transition-all
          ${borderClass} ${bgClass}
          hover:shadow hover:border-blue-500
        `}
        onClick={() => {
          setSelectedUnit(unit);
          if (isEmpty) {
            setShowInstallModal(true);
          }
        }}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-1">
            <span className="text-xs font-mono text-gray-500">U{unit.unitNumber}</span>

            {isInWork && (
              <span className="px-1 py-0.5 text-[10px] bg-green-500 text-white rounded" title="–í —Ä–∞–±–æ—Ç–µ">
                –í —Ä–∞–±–æ—Ç–µ
              </span>
            )}
            {isPlaced && (
              <span className="px-1 py-0.5 text-[10px] bg-orange-500 text-white rounded" title="–†–∞–∑–º–µ—â—ë–Ω, –Ω–µ –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É">
                –†–∞–∑–º–µ—â—ë–Ω
              </span>
            )}
          </div>
          {!isEmpty && (
            <div className="flex gap-1">

              {isPlaced && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setSelectedUnit(unit);
                    setShowInstallModal(true);
                  }}
                  className="p-1 hover:bg-green-100 rounded text-green-600"
                  title="–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"
                >
                  <CheckCircle size={12} />
                </button>
              )}
              <button
                onClick={async (e) => {
                  e.stopPropagation();
                  if (confirm("–ò–∑–≤–ª–µ—á—å —Å–µ—Ä–≤–µ—Ä –∏–∑ —é–Ω–∏—Ç–∞?")) {
                    try {
                      await removeServerFromRack(unit.rackId, unit.unitNumber);
                      toast.success("–°–µ—Ä–≤–µ—Ä –∏–∑–≤–ª–µ—á—ë–Ω");
                      loadRackDetails(unit.rackId);
                    } catch (error: any) {
                      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
                    }
                  }
                }}
                className="p-1 hover:bg-red-100 rounded text-red-500"
                title="–ò–∑–≤–ª–µ—á—å"
              >
                <XCircle size={12} />
              </button>
            </div>
          )}
        </div>

        {!isEmpty && unit.server && (
          <div className="mt-1">
            <div className="text-xs font-medium truncate" title={unit.server.apkSerialNumber}>
              {unit.server.apkSerialNumber || `#${unit.server.id}`}
            </div>
            {unit.hostname && (
              <div className="text-xs text-gray-500 truncate">{unit.hostname}</div>
            )}
            {unit.mgmtIpAddress && (
              <div className="text-xs text-blue-500 truncate">{unit.mgmtIpAddress}</div>
            )}

            {isPlaced && unit.placedBy && (
              <div className="text-[10px] text-orange-600 truncate mt-0.5">
                –†–∞–∑–º–µ—Å—Ç–∏–ª: {unit.placedBy.surname || unit.placedBy.login}
              </div>
            )}
            {isInWork && unit.installedBy && (
              <div className="text-[10px] text-green-600 truncate mt-0.5">
                –í —Ä–∞–±–æ—Ç–µ: {unit.installedBy.surname || unit.installedBy.login}
              </div>
            )}
          </div>
        )}

        {isEmpty && (
          <div className="text-xs text-gray-400 text-center mt-1">–ü—É—Å—Ç–æ</div>
        )}
      </div>
    );
  };


  const RackVisualization: React.FC<{ rack: BeryllRack }> = ({ rack }) => {
    if (!rack.units || rack.units.length === 0) {
      return <div className="text-gray-500">–Æ–Ω–∏—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>;
    }


    const sortedUnits = [...rack.units].sort((a, b) => b.unitNumber - a.unitNumber);


    const stats = {
      empty: sortedUnits.filter(u => !u.serverId).length,
      placed: sortedUnits.filter(u => u.serverId && !u.installedAt).length,
      inWork: sortedUnits.filter(u => u.serverId && u.installedAt).length
    };

    return (
      <div>

        <div className="flex items-center gap-4 mb-3 p-2 bg-gray-100 rounded text-xs">
          <div className="flex items-center gap-1">
            <div className="w-3 h-3 border-l-4 border-green-500 bg-green-50 rounded"></div>
            <span>–í —Ä–∞–±–æ—Ç–µ ({stats.inWork})</span>
          </div>
          <div className="flex items-center gap-1">
            <div className="w-3 h-3 border-l-4 border-orange-400 bg-orange-50 rounded"></div>
            <span>–†–∞–∑–º–µ—â—ë–Ω ({stats.placed})</span>
          </div>
          <div className="flex items-center gap-1">
            <div className="w-3 h-3 border border-dashed border-gray-300 bg-gray-50 rounded"></div>
            <span>–ü—É—Å—Ç–æ ({stats.empty})</span>
          </div>
        </div>


        <div className="grid grid-cols-1 gap-1 max-h-[600px] overflow-y-auto">
          {sortedUnits.map(unit => renderUnit(unit))}
        </div>
      </div>
    );
  };

  return (
    <div className="p-4">

      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold flex items-center gap-2">
          <Server className="text-blue-600" />
          –°—Ç–æ–π–∫–∏
        </h2>

        <div className="flex items-center gap-3">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
            <input
              type="text"
              placeholder="–ü–æ–∏—Å–∫ —Å—Ç–æ–µ–∫..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <button
            onClick={() => setShowCreateModal(true)}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            <Plus size={18} />
            –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–π–∫—É
          </button>
        </div>
      </div>

      <div className="flex gap-4">

        <div className="w-80 flex-shrink-0">
          <div className="bg-white rounded-lg shadow">
            <div className="p-3 border-b font-medium text-gray-700">
              –°–ø–∏—Å–æ–∫ —Å—Ç–æ–µ–∫ ({racks.length})
            </div>

            {loading ? (
              <div className="p-4 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            ) : racks.length === 0 ? (
              <div className="p-4 text-center text-gray-500">–°—Ç–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
            ) : (
              <div className="divide-y max-h-[600px] overflow-y-auto">
                {racks.map(rack => (
                  <div
                    key={rack.id}
                    className={`
                      p-3 cursor-pointer hover:bg-gray-50 transition-colors
                      ${selectedRack?.id === rack.id ? "bg-blue-50 border-l-4 border-blue-500" : ""}
                    `}
                    onClick={() => loadRackDetails(rack.id)}
                  >
                    <div className="flex items-center justify-between">
                      <span className="font-medium">{rack.name}</span>
                      <span className={`text-xs px-2 py-0.5 rounded ${RACK_STATUS_CONFIG[rack.status].bg} ${RACK_STATUS_CONFIG[rack.status].color}`}>
                        {RACK_STATUS_CONFIG[rack.status].label}
                      </span>
                    </div>

                    {rack.location && (
                      <div className="text-sm text-gray-500 flex items-center gap-1 mt-1">
                        <MapPin size={12} />
                        {rack.location}
                      </div>
                    )}

                    <div className="flex items-center gap-4 mt-2 text-xs text-gray-500">
                      <span>–Æ–Ω–∏—Ç–æ–≤: {rack.totalUnits}</span>
                      {rack.filledUnits !== undefined && (
                        <span>–ó–∞–Ω—è—Ç–æ: {rack.filledUnits}</span>
                      )}
                      {rack.occupancyPercent !== undefined && (
                        <span className="text-blue-600">{rack.occupancyPercent}%</span>
                      )}
                    </div>


                    {rack.occupancyPercent !== undefined && (
                      <div className="mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                        <div
                          className="h-full bg-blue-500 transition-all"
                          style={{ width: `${rack.occupancyPercent}%` }}
                        />
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>


        <div className="flex-1">
          {selectedRack ? (
            <div className="bg-white rounded-lg shadow">

              <div className="p-4 border-b flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-semibold">{selectedRack.name}</h3>
                  {selectedRack.location && (
                    <p className="text-sm text-gray-500">{selectedRack.location}</p>
                  )}
                </div>

                <div className="flex items-center gap-2">
                  <button
                    onClick={() => setShowEditModal(true)}
                    className="p-2 hover:bg-gray-100 rounded-lg"
                    title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                  >
                    <Edit size={18} />
                  </button>
                  <button
                    onClick={() => setShowDeleteConfirm(true)}
                    className="p-2 hover:bg-red-100 text-red-500 rounded-lg"
                    title="–£–¥–∞–ª–∏—Ç—å"
                  >
                    <Trash2 size={18} />
                  </button>
                </div>
              </div>


              {(selectedRack.networkSubnet || selectedRack.gateway) && (
                <div className="px-4 py-2 bg-gray-50 border-b flex items-center gap-4 text-sm">
                  <Wifi size={16} className="text-gray-400" />
                  {selectedRack.networkSubnet && <span>Subnet: {selectedRack.networkSubnet}</span>}
                  {selectedRack.gateway && <span>Gateway: {selectedRack.gateway}</span>}
                </div>
              )}


              <div className="p-4">
                <RackVisualization rack={selectedRack} />
              </div>


              {selectedRack.notes && (
                <div className="px-4 pb-4">
                  <div className="p-3 bg-yellow-50 rounded-lg text-sm">
                    <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</strong> {selectedRack.notes}
                  </div>
                </div>
              )}
            </div>
          ) : (
            <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
              <Server size={48} className="mx-auto mb-4 text-gray-300" />
              <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–π–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
            </div>
          )}
        </div>
      </div>


      <CreateRackModal
        isOpen={showCreateModal}
        onClose={() => setShowCreateModal(false)}
        onSuccess={() => {
          loadRacks();
          setShowCreateModal(false);
        }}
      />


      {selectedRack && (
        <EditRackModal
          isOpen={showEditModal}
          rack={selectedRack}
          onClose={() => setShowEditModal(false)}
          onSuccess={() => {
            loadRacks();
            loadRackDetails(selectedRack.id);
            setShowEditModal(false);
          }}
        />
      )}


      {selectedUnit && selectedRack && (
        <InstallServerModal
          isOpen={showInstallModal}
          rack={selectedRack}
          unit={selectedUnit}
          servers={availableServers}
          onClose={() => {
            setShowInstallModal(false);
            setSelectedUnit(null);
          }}
          onSuccess={() => {
            loadRackDetails(selectedRack.id);
            setShowInstallModal(false);
            setSelectedUnit(null);
          }}
        />
      )}


      {selectedRack && (
        <ConfirmModal
          isOpen={showDeleteConfirm}
          title="–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–π–∫—É?"
          message={`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç–æ–π–∫—É "${selectedRack.name}"?`}
          onConfirm={async () => {
            try {
              await deleteRack(selectedRack.id);
              toast.success("–°—Ç–æ–π–∫–∞ —É–¥–∞–ª–µ–Ω–∞");
              setSelectedRack(null);
              loadRacks();
            } catch (error: any) {
              toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
            }
            setShowDeleteConfirm(false);
          }}
          onCancel={() => setShowDeleteConfirm(false)}
        />
      )}
    </div>
  );
};


interface CreateRackModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

const CreateRackModal: React.FC<CreateRackModalProps> = ({ isOpen, onClose, onSuccess }) => {
  const [form, setForm] = useState({
    name: "",
    location: "",
    totalUnits: 42,
    networkSubnet: "",
    gateway: "",
    notes: ""
  });
  const [saving, setSaving] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!form.name.trim()) {
      toast.error("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–π–∫–∏");
      return;
    }

    try {
      setSaving(true);
      await createRack(form);
      toast.success("–°—Ç–æ–π–∫–∞ —Å–æ–∑–¥–∞–Ω–∞");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–°–æ–∑–¥–∞—Ç—å —Å—Ç–æ–π–∫—É">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input
            type="text"
            value={form.name}
            onChange={(e) => setForm({ ...form, name: e.target.value })}
            placeholder="BL0206-240001"
            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
          <input
            type="text"
            value={form.location}
            onChange={(e) => setForm({ ...form, location: e.target.value })}
            placeholder="–°—Ç–µ–ª–ª–∞–∂ 1, —É —â–∏—Ç–∫–∞"
            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —é–Ω–∏—Ç–æ–≤</label>
          <input
            type="number"
            value={form.totalUnits}
            onChange={(e) => setForm({ ...form, totalUnits: parseInt(e.target.value) || 42 })}
            min={1}
            max={50}
            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Subnet</label>
            <input
              type="text"
              value={form.networkSubnet}
              onChange={(e) => setForm({ ...form, networkSubnet: e.target.value })}
              placeholder="10.10.0.0/24"
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Gateway</label>
            <input
              type="text"
              value={form.gateway}
              onChange={(e) => setForm({ ...form, gateway: e.target.value })}
              placeholder="10.10.0.1"
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
          <textarea
            value={form.notes}
            onChange={(e) => setForm({ ...form, notes: e.target.value })}
            rows={3}
            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div className="flex justify-end gap-3 pt-4">
          <button
            type="button"
            onClick={onClose}
            className="px-4 py-2 border rounded-lg hover:bg-gray-50"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ–∑–¥–∞—Ç—å"}
          </button>
        </div>
      </form>
    </Modal>
  );
};


interface EditRackModalProps {
  isOpen: boolean;
  rack: BeryllRack;
  onClose: () => void;
  onSuccess: () => void;
}

const EditRackModal: React.FC<EditRackModalProps> = ({ isOpen, rack, onClose, onSuccess }) => {
  const [form, setForm] = useState({
    name: rack.name,
    location: rack.location || "",
    networkSubnet: rack.networkSubnet || "",
    gateway: rack.gateway || "",
    status: rack.status,
    notes: rack.notes || ""
  });
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    setForm({
      name: rack.name,
      location: rack.location || "",
      networkSubnet: rack.networkSubnet || "",
      gateway: rack.gateway || "",
      status: rack.status,
      notes: rack.notes || ""
    });
  }, [rack]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    try {
      setSaving(true);
      await updateRack(rack.id, form);
      toast.success("–°—Ç–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
    } finally {
      setSaving(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–π–∫—É">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input
            type="text"
            value={form.name}
            onChange={(e) => setForm({ ...form, name: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
          <input
            type="text"
            value={form.location}
            onChange={(e) => setForm({ ...form, location: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–°—Ç–∞—Ç—É—Å</label>
          <select
            value={form.status}
            onChange={(e) => setForm({ ...form, status: e.target.value as RackStatus })}
            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            {Object.entries(RACK_STATUS_CONFIG).map(([value, config]) => (
              <option key={value} value={value}>{config.label}</option>
            ))}
          </select>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Subnet</label>
            <input
              type="text"
              value={form.networkSubnet}
              onChange={(e) => setForm({ ...form, networkSubnet: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Gateway</label>
            <input
              type="text"
              value={form.gateway}
              onChange={(e) => setForm({ ...form, gateway: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
          <textarea
            value={form.notes}
            onChange={(e) => setForm({ ...form, notes: e.target.value })}
            rows={3}
            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div className="flex justify-end gap-3 pt-4">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
          </button>
        </div>
      </form>
    </Modal>
  );
};


interface InstallServerModalProps {
  isOpen: boolean;
  rack: BeryllRack;
  unit: BeryllRackUnit;
  servers: any[];
  onClose: () => void;
  onSuccess: () => void;
}

const InstallServerModal: React.FC<InstallServerModalProps> = ({
  isOpen, rack, unit, servers, onClose, onSuccess
}) => {
  const [form, setForm] = useState({
    serverId: 0,
    apkSerialNumber: "",
    hostname: "",
    mgmtMacAddress: "",
    mgmtIpAddress: "",
    dataMacAddress: "",
    dataIpAddress: "",
    accessLogin: "admin",
    accessPassword: "V36man",
    notes: ""
  });
  const [saving, setSaving] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [dhcpInfo, setDhcpInfo] = useState<any>(null);
  const [searchingDhcp, setSearchingDhcp] = useState(false);


  const filteredServers = servers.filter(s =>
    searchQuery.length >= 2 && (
      s.apkSerialNumber?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      s.serialNumber?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      s.hostname?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      s.ipAddress?.includes(searchQuery)
    )
  );


  const exactMatch = servers.find(s =>
    s.apkSerialNumber?.toUpperCase() === searchQuery.toUpperCase() ||
    s.serialNumber?.toUpperCase() === searchQuery.toUpperCase()
  );


  const showServerList = searchQuery.length >= 2 && filteredServers.length > 0;


  const searchInDhcp = async () => {
    if (!searchQuery) {
      toast.error("–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä");
      return;
    }

    try {
      setSearchingDhcp(true);
      const result = await findServerInDhcp(searchQuery);
      setDhcpInfo(result);

      if (result.found) {
        toast.success("–ù–∞–π–¥–µ–Ω –≤ DHCP!");

        setForm(prev => ({
          ...prev,
          mgmtMacAddress: result.macAddress || prev.mgmtMacAddress,
          mgmtIpAddress: result.ipAddress || prev.mgmtIpAddress,
          hostname: result.hostname || prev.hostname
        }));
      } else {
        toast.info("–ù–µ –Ω–∞–π–¥–µ–Ω –≤ DHCP");
      }
    } catch (error: any) {
      toast.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ DHCP");
      console.error(error);
    } finally {
      setSearchingDhcp(false);
    }
  };


  const selectServer = (server: any) => {
    setForm(prev => ({
      ...prev,
      serverId: server.id,
      hostname: server.hostname || prev.hostname,
      mgmtIpAddress: server.ipAddress || prev.mgmtIpAddress,
      mgmtMacAddress: server.macAddress || prev.mgmtMacAddress
    }));
    setSearchQuery(server.apkSerialNumber || server.serialNumber || `#${server.id}`);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!searchQuery) {
      toast.error("–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä");
      return;
    }

    try {
      setSaving(true);

      if (form.serverId) {

        await installServerInRack(rack.id, unit.unitNumber, {
          serverId: form.serverId,
          hostname: form.hostname,
          mgmtMacAddress: form.mgmtMacAddress,
          mgmtIpAddress: form.mgmtIpAddress,
          dataMacAddress: form.dataMacAddress,
          dataIpAddress: form.dataIpAddress,
          accessLogin: form.accessLogin,
          accessPassword: form.accessPassword,
          notes: form.notes
        });
        toast.success("–°–µ—Ä–≤–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
      } else {

        await createAndPlaceServer({
          apkSerialNumber: searchQuery.toUpperCase(),
          macAddress: form.mgmtMacAddress || undefined,
          hostname: form.hostname || undefined,
          rackId: rack.id,
          unitNumber: unit.unitNumber,
          unitData: {
            hostname: form.hostname,
            mgmtMacAddress: form.mgmtMacAddress,
            mgmtIpAddress: form.mgmtIpAddress,
            dataMacAddress: form.dataMacAddress,
            dataIpAddress: form.dataIpAddress,
            accessLogin: form.accessLogin,
            accessPassword: form.accessPassword,
            notes: form.notes
          }
        });
        toast.success("–°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
      }

      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏");
    } finally {
      setSaving(false);
    }
  };


  useEffect(() => {
    if (isOpen) {

      if (unit.serverId && unit.server) {
        setForm({
          serverId: unit.serverId,
          apkSerialNumber: unit.server.apkSerialNumber || "",
          hostname: unit.hostname || unit.server.hostname || "",
          mgmtMacAddress: unit.mgmtMacAddress || unit.server.macAddress || "",
          mgmtIpAddress: unit.mgmtIpAddress || unit.server.ipAddress || "",
          dataMacAddress: unit.dataMacAddress || "",
          dataIpAddress: unit.dataIpAddress || "",
          accessLogin: unit.accessLogin || "admin",
          accessPassword: unit.accessPassword || "V36man",
          notes: unit.notes || ""
        });
        setSearchQuery(unit.server.apkSerialNumber || `#${unit.serverId}`);
      } else {

        setForm({
          serverId: 0,
          apkSerialNumber: "",
          hostname: "",
          mgmtMacAddress: "",
          mgmtIpAddress: "",
          dataMacAddress: "",
          dataIpAddress: "",
          accessLogin: "admin",
          accessPassword: "V36man",
          notes: ""
        });
        setSearchQuery("");
      }
      setDhcpInfo(null);
    }
  }, [isOpen, unit]);


  useEffect(() => {
    if (!exactMatch) {
      setForm(prev => ({ ...prev, serverId: 0 }));
    }
  }, [searchQuery]);


  const isTakeToWorkMode = unit.serverId && !unit.installedAt;

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title={
        isTakeToWorkMode
          ? `–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É: ${rack.name} / Unit ${unit.unitNumber}`
          : `–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –≤ ${rack.name} / Unit ${unit.unitNumber}`
      }
    >
      <form onSubmit={handleSubmit} className="space-y-4">

        {isTakeToWorkMode && (
          <div className="p-3 bg-orange-50 border border-orange-200 rounded-lg text-sm text-orange-800">
            <CheckCircle size={16} className="inline mr-1" />
            –°–µ—Ä–≤–µ—Ä <strong>{unit.server?.apkSerialNumber}</strong> —É–∂–µ —Ä–∞–∑–º–µ—â—ë–Ω –≤ —é–Ω–∏—Ç–µ.
            –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É".
          </div>
        )}


        <div>
          <label className="block text-sm font-medium mb-1">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä *</label>
          <div className="flex gap-2">
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value.toUpperCase())}
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω–∏–∫..."
              className="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
              autoFocus
              disabled={isTakeToWorkMode}
            />
            <button
              type="button"
              onClick={searchInDhcp}
              disabled={searchingDhcp || !searchQuery}
              className="px-3 py-2 bg-gray-100 border rounded-lg hover:bg-gray-200 disabled:opacity-50"
              title="–ù–∞–π—Ç–∏ –≤ DHCP"
            >
              {searchingDhcp ? "..." : <Wifi size={18} />}
            </button>
          </div>
        </div>


        {!isTakeToWorkMode && showServerList && (
          <div className="border rounded-lg overflow-hidden">
            <div className="px-3 py-2 bg-gray-50 text-sm font-medium text-gray-600">
              –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã ({filteredServers.length})
            </div>
            <div className="max-h-32 overflow-y-auto">
              {filteredServers.slice(0, 10).map(server => (
                <div
                  key={server.id}
                  className={`
                    p-2 cursor-pointer hover:bg-blue-50 border-b last:border-b-0
                    ${form.serverId === server.id ? "bg-blue-100" : ""}
                  `}
                  onClick={() => selectServer(server)}
                >
                  <div className="font-medium">{server.apkSerialNumber || server.serialNumber || `#${server.id}`}</div>
                  <div className="text-xs text-gray-500">
                    {server.hostname && `${server.hostname} ‚Ä¢ `}
                    {server.ipAddress || "IP –Ω–µ –∑–∞–¥–∞–Ω"} ‚Ä¢
                    <span className={`ml-1 ${server.status === "DONE" ? "text-green-600" : "text-yellow-600"}`}>
                      {server.status}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}


        {!isTakeToWorkMode && searchQuery.length >= 2 && (
          <div className={`p-3 rounded-lg text-sm ${
            form.serverId
              ? "bg-green-50 border border-green-200 text-green-800"
              : "bg-blue-50 border border-blue-200 text-blue-800"
          }`}>
            {form.serverId ? (
              <>
                <CheckCircle size={16} className="inline mr-1" />
                –í—ã–±—Ä–∞–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–µ—Ä–≤–µ—Ä
              </>
            ) : (
              <>
                <PlusCircle size={16} className="inline mr-1" />
                –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä: <strong>{searchQuery}</strong>
              </>
            )}
          </div>
        )}


        {dhcpInfo && dhcpInfo.found && (
          <div className="p-3 bg-green-50 border border-green-200 rounded-lg text-sm">
            <div className="font-medium text-green-800 mb-1">‚úì –ù–∞–π–¥–µ–Ω –≤ DHCP:</div>
            <div className="text-green-700">
              IP: {dhcpInfo.ipAddress} ‚Ä¢ MAC: {dhcpInfo.macAddress}
              {dhcpInfo.hostname && ` ‚Ä¢ Hostname: ${dhcpInfo.hostname}`}
            </div>
          </div>
        )}


        <div>
          <label className="block text-sm font-medium mb-1">Hostname –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ</label>
          <input
            type="text"
            value={form.hostname}
            onChange={(e) => setForm({ ...form, hostname: e.target.value })}
            placeholder="cl1-worker1"
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>


        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">MGMT MAC</label>
            <input
              type="text"
              value={form.mgmtMacAddress}
              onChange={(e) => setForm({ ...form, mgmtMacAddress: e.target.value })}
              placeholder="AA:BB:CC:DD:EE:FF"
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">MGMT IP</label>
            <input
              type="text"
              value={form.mgmtIpAddress}
              onChange={(e) => setForm({ ...form, mgmtIpAddress: e.target.value })}
              placeholder="10.10.0.10"
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">DATA MAC</label>
            <input
              type="text"
              value={form.dataMacAddress}
              onChange={(e) => setForm({ ...form, dataMacAddress: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">DATA IP</label>
            <input
              type="text"
              value={form.dataIpAddress}
              onChange={(e) => setForm({ ...form, dataIpAddress: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </div>


        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Login</label>
            <input
              type="text"
              value={form.accessLogin}
              onChange={(e) => setForm({ ...form, accessLogin: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Password</label>
            <input
              type="text"
              value={form.accessPassword}
              onChange={(e) => setForm({ ...form, accessPassword: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </div>

        <div className="flex justify-end gap-3 pt-4">
          <button type="button" onClick={onClose} className="px-4 py-2 border rounded-lg hover:bg-gray-50">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            type="submit"
            disabled={saving || !searchQuery}
            className={`px-4 py-2 text-white rounded-lg disabled:opacity-50 ${
              isTakeToWorkMode
                ? "bg-green-600 hover:bg-green-700"
                : "bg-blue-600 hover:bg-blue-700"
            }`}
          >
            {saving
              ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..."
              : isTakeToWorkMode
                ? "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"
                : form.serverId
                  ? "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
                  : "–°–æ–∑–¥–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
            }
          </button>
        </div>
      </form>
    </Modal>
  );
};

export default RacksTab;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/tabs/ServersTab.tsx
================================================================================



import { useState, useEffect, useContext } from "react";
import { useNavigate } from "react-router-dom";
import { observer } from "mobx-react-lite";
import toast from "react-hot-toast";
import {
  Server,
  Search,
  RefreshCw,
  Play,
  CheckCircle2,
  XCircle,
  HelpCircle,
  Clock,
  Trash2,
  ExternalLink,
  Package,
  User,
  Copy,
  Archive,
  FileSpreadsheet,
  Wifi,
  WifiOff,
  ChevronLeft,
  ChevronRight,
  ChevronsLeft,
  ChevronsRight,
  Globe,
  Download
} from "lucide-react";
import { Context } from "src/main";
import {
  getServers,
  getBatches,
  takeServer,
  releaseServer,
  updateServerStatus,
  deleteServer,
  archiveServer,
  assignServersToBatch,
  generatePassport,
  pingServer,
  exportPassports,
  exportSelectedPassports,
  BeryllServer,
  BeryllBatch,
  ServerStatus,
  STATUS_LABELS,
  STATUS_COLORS,
  formatDateTime
} from "src/api/beryllApi";

interface ServersTabProps {
  onStatsUpdate?: () => void;
}

const PAGE_SIZE_OPTIONS = [20, 50, 100];

export const ServersTab: React.FC<ServersTabProps> = observer(({ onStatsUpdate }) => {
  const navigate = useNavigate();
  const context = useContext(Context);
  const currentUser = context?.user?.user;

  const [servers, setServers] = useState<BeryllServer[]>([]);
  const [batches, setBatches] = useState<BeryllBatch[]>([]);
  const [loading, setLoading] = useState(true);
  const [actionLoading, setActionLoading] = useState<number | null>(null);
  const [exporting, setExporting] = useState(false);


  const [pingingServerId, setPingingServerId] = useState<number | null>(null);
  const [pingResults, setPingResults] = useState<Record<number, { online: boolean; latency: number | null }>>({});


  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState<ServerStatus | "ALL">("ALL");
  const [batchFilter, setBatchFilter] = useState<number | "ALL" | "UNASSIGNED">("ALL");
  const [onlyActive, setOnlyActive] = useState(false);
  const [onlyMine, setOnlyMine] = useState(false);


  const [currentPage, setCurrentPage] = useState(1);
  const [pageSize, setPageSize] = useState(20);


  const [selectedServers, setSelectedServers] = useState<number[]>([]);
  const [showBatchModal, setShowBatchModal] = useState(false);
  const [openMenuId, setOpenMenuId] = useState<number | null>(null);


  const loadData = async () => {
    setLoading(true);
    try {
      const [serversData, batchesData] = await Promise.all([
        getServers({
          status: statusFilter === "ALL" ? undefined : statusFilter,
          search: search || undefined,
          onlyActive: onlyActive || undefined,
          batchId: batchFilter === "ALL" ? undefined : batchFilter === "UNASSIGNED" ? "null" : batchFilter,
          assignedToId: onlyMine ? currentUser?.id : undefined
        }),
        getBatches({ status: "ACTIVE" })
      ]);
      setServers(serversData);
      setBatches(batchesData);
      setCurrentPage(1);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadData();
  }, [statusFilter, onlyActive, batchFilter, onlyMine]);

  useEffect(() => {
    const timer = setTimeout(() => loadData(), 300);
    return () => clearTimeout(timer);
  }, [search]);

  useEffect(() => {
    const handleClickOutside = () => setOpenMenuId(null);
    document.addEventListener("click", handleClickOutside);
    return () => document.removeEventListener("click", handleClickOutside);
  }, []);


  const totalPages = Math.ceil(servers.length / pageSize);
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const paginatedServers = servers.slice(startIndex, endIndex);

  const goToPage = (page: number) => {
    if (page >= 1 && page <= totalPages) {
      setCurrentPage(page);
      setSelectedServers([]);
    }
  };

  const handlePageSizeChange = (newSize: number) => {
    setPageSize(newSize);
    setCurrentPage(1);
    setSelectedServers([]);
  };


  const handleExportAll = async () => {
    setExporting(true);
    try {
      const blob = await exportPassports({
        status: statusFilter === "ALL" ? undefined : statusFilter,
        batchId: batchFilter === "ALL" ? undefined : batchFilter === "UNASSIGNED" ? "null" : batchFilter,
        search: search || undefined
      });

      const timestamp = new Date().toISOString().split("T")[0];
      const filename = `–°–æ—Å—Ç–∞–≤_—Å–µ—Ä–≤–µ—Ä–æ–≤_${timestamp}.xlsx`;

      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);

      toast.success(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${servers.length} —Å–µ—Ä–≤–µ—Ä–æ–≤`);
    } catch (e: any) {
      console.error("Export error:", e);
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞");
    } finally {
      setExporting(false);
    }
  };

  const handleExportSelected = async () => {
    if (selectedServers.length === 0) {
      toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞");
      return;
    }

    setExporting(true);
    try {
      const blob = await exportSelectedPassports(selectedServers);

      const timestamp = new Date().toISOString().split("T")[0];
      const filename = `–°–æ—Å—Ç–∞–≤_—Å–µ—Ä–≤–µ—Ä–æ–≤_${selectedServers.length}—à—Ç_${timestamp}.xlsx`;

      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);

      toast.success(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${selectedServers.length} —Å–µ—Ä–≤–µ—Ä–æ–≤`);
    } catch (e: any) {
      console.error("Export error:", e);
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞");
    } finally {
      setExporting(false);
    }
  };


  const handlePing = async (server: BeryllServer) => {
    setPingingServerId(server.id);
    try {
      const result = await pingServer(server.id);
      setPingResults(prev => ({
        ...prev,
        [server.id]: { online: result.online, latency: result.latency }
      }));

      if (result.online) {
        toast.success(`${server.ipAddress} –¥–æ—Å—Ç—É–ø–µ–Ω (${result.latency}ms)`, { duration: 2000 });
      } else {
        toast.error(`${server.ipAddress} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`, { duration: 2000 });
      }
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ –ø–∏–Ω–≥–∞");
      setPingResults(prev => ({
        ...prev,
        [server.id]: { online: false, latency: null }
      }));
    } finally {
      setPingingServerId(null);
    }
  };


  const handleTake = async (server: BeryllServer) => {
    setActionLoading(server.id);
    try {
      await takeServer(server.id);
      await loadData();
      onStatsUpdate?.();
      toast.success("–°–µ—Ä–≤–µ—Ä –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setActionLoading(null);
    }
  };

  const handleRelease = async (server: BeryllServer) => {
    setActionLoading(server.id);
    try {
      await releaseServer(server.id);
      await loadData();
      onStatsUpdate?.();
      toast.success("–°–µ—Ä–≤–µ—Ä –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setActionLoading(null);
    }
  };

  const handleStatusChange = async (server: BeryllServer, status: ServerStatus) => {
    setActionLoading(server.id);
    try {
      await updateServerStatus(server.id, status);
      await loadData();
      onStatsUpdate?.();
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setActionLoading(null);
    }
  };

  const handleArchive = async (server: BeryllServer) => {
    if (!server.apkSerialNumber) {
      toast.error("–î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ –∞—Ä—Ö–∏–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏—Å–≤–æ–∏—Ç—å —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ê–ü–ö");
      return;
    }
    if (server.status !== "DONE") {
      toast.error("–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –∞—Ä—Ö–∏–≤ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '–ì–æ—Ç–æ–≤–æ'");
      return;
    }
    if (!confirm(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä ${server.apkSerialNumber || server.ipAddress} –≤ –∞—Ä—Ö–∏–≤?`)) {
      return;
    }

    setActionLoading(server.id);
    try {
      await archiveServer(server.id);
      await loadData();
      onStatsUpdate?.();
      toast.success("–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ –∞—Ä—Ö–∏–≤");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏");
    } finally {
      setActionLoading(null);
    }
  };

  const handleDelete = async (server: BeryllServer) => {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä ${server.ipAddress}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
      return;
    }

    setActionLoading(server.id);
    try {
      await deleteServer(server.id);
      await loadData();
      onStatsUpdate?.();
      toast.success("–°–µ—Ä–≤–µ—Ä —É–¥–∞–ª—ë–Ω");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    } finally {
      setActionLoading(null);
    }
  };

  const handleGeneratePassport = async (server: BeryllServer) => {
    try {
      const blob = await generatePassport(server.id);
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `passport_${server.apkSerialNumber || server.ipAddress}.pdf`;
      a.click();
      window.URL.revokeObjectURL(url);
      toast.success("–ü–∞—Å–ø–æ—Ä—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω");
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞");
    }
  };


  const toggleSelect = (id: number) => {
    setSelectedServers(prev =>
      prev.includes(id) ? prev.filter(s => s !== id) : [...prev, id]
    );
  };

  const toggleSelectAll = () => {
    if (selectedServers.length === paginatedServers.length) {
      setSelectedServers([]);
    } else {
      setSelectedServers(paginatedServers.map(s => s.id));
    }
  };

  const handleAssignToBatch = async (batchId: number) => {
    try {
      await assignServersToBatch(selectedServers, batchId);
      await loadData();
      onStatsUpdate?.();
      setShowBatchModal(false);
      setSelectedServers([]);
      toast.success(`–°–µ—Ä–≤–µ—Ä—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ø–∞—Ä—Ç–∏–∏`);
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };


  const copyToClipboard = async (text: string) => {
    if (!text) {
      toast.error("–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
      return;
    }
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
      } else {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        const successful = document.execCommand("copy");
        document.body.removeChild(textArea);
        if (!successful) throw new Error("execCommand failed");
      }
      toast.success("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ", { duration: 1500 });
    } catch (err) {
      console.error("Copy failed:", err);
      toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    }
  };

  const openInBrowser = (ipAddress: string | null) => {
    if (!ipAddress) {
      toast.error("IP –∞–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω");
      return;
    }
    window.open(`http://${ipAddress}`, "_blank", "noopener,noreferrer");
  };

  const getStatusIcon = (status: ServerStatus) => {
    switch (status) {
      case "NEW": return <Clock className="w-3.5 h-3.5" />;
      case "IN_WORK": return <RefreshCw className="w-3.5 h-3.5" />;
      case "DONE": return <CheckCircle2 className="w-3.5 h-3.5" />;
      case "DEFECT": return <XCircle className="w-3.5 h-3.5" />;
      default: return <HelpCircle className="w-3.5 h-3.5" />;
    }
  };

  const getPingStatusIcon = (serverId: number) => {
    const result = pingResults[serverId];
    if (!result) return null;

    if (result.online) {
      return (
        <span className="flex items-center gap-1 text-xs text-green-600">
          <Wifi className="w-3.5 h-3.5" />
          {result.latency !== null && `${result.latency}ms`}
        </span>
      );
    } else {
      return (
        <span className="flex items-center gap-1 text-xs text-red-500">
          <WifiOff className="w-3.5 h-3.5" />
        </span>
      );
    }
  };


  return (
    <div className="p-4 space-y-4">

      <div className="flex flex-wrap items-center gap-3 p-4 bg-white rounded-xl border border-gray-200 shadow-sm">

        <div className="relative flex-1 min-w-[200px]">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
          <input
            type="text"
            placeholder="–ü–æ–∏—Å–∫ –ø–æ IP, hostname, —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>


        <select
          value={statusFilter}
          onChange={(e) => setStatusFilter(e.target.value as ServerStatus | "ALL")}
          className="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
        >
          <option value="ALL">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="NEW">–ù–æ–≤—ã–π</option>
          <option value="IN_WORK">–í —Ä–∞–±–æ—Ç–µ</option>
          <option value="DONE">–ì–æ—Ç–æ–≤–æ</option>
          <option value="DEFECT">–ë—Ä–∞–∫</option>
        </select>


        <select
          value={batchFilter}
          onChange={(e) => {
            const val = e.target.value;
            setBatchFilter(val === "ALL" ? "ALL" : val === "UNASSIGNED" ? "UNASSIGNED" : Number(val));
          }}
          className="px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
        >
          <option value="ALL">–í—Å–µ –ø–∞—Ä—Ç–∏–∏</option>
          <option value="UNASSIGNED">–ë–µ–∑ –ø–∞—Ä—Ç–∏–∏</option>
          {batches.map(b => (
            <option key={b.id} value={b.id}>{b.title}</option>
          ))}
        </select>


        <label className="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            checked={onlyActive}
            onChange={(e) => setOnlyActive(e.target.checked)}
            className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
          />
          <span className="text-sm text-gray-600">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</span>
        </label>


        <label className="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            checked={onlyMine}
            onChange={(e) => setOnlyMine(e.target.checked)}
            className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
          />
          <User className="w-4 h-4 text-gray-500" />
          <span className="text-sm text-gray-600">–ú–æ–∏ —Å–µ—Ä–≤–µ—Ä—ã</span>
        </label>


        <button
          onClick={() => loadData()}
          disabled={loading}
          className="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
          title="–û–±–Ω–æ–≤–∏—Ç—å"
        >
          <RefreshCw className={`w-5 h-5 ${loading ? "animate-spin" : ""}`} />
        </button>


        <button
          onClick={handleExportAll}
          disabled={exporting || servers.length === 0}
          className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          title="–í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –≤ Excel"
        >
          {exporting ? (
            <RefreshCw className="w-4 h-4 animate-spin" />
          ) : (
            <Download className="w-4 h-4" />
          )}
          <span>–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel</span>
        </button>
      </div>


      <div className="flex items-center justify-between">
        <div className="text-sm text-gray-500">
          –ù–∞–π–¥–µ–Ω–æ: <span className="font-medium text-gray-700">{servers.length}</span> —Å–µ—Ä–≤–µ—Ä–æ–≤
          {servers.length > 0 && (
            <span className="ml-2">
              (–ø–æ–∫–∞–∑–∞–Ω—ã {startIndex + 1}-{Math.min(endIndex, servers.length)})
            </span>
          )}
        </div>

        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-500">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</span>
          <select
            value={pageSize}
            onChange={(e) => handlePageSizeChange(Number(e.target.value))}
            className="px-2 py-1 text-sm border border-gray-200 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            {PAGE_SIZE_OPTIONS.map(size => (
              <option key={size} value={size}>{size}</option>
            ))}
          </select>
        </div>
      </div>


      {selectedServers.length > 0 && (
        <div className="flex items-center gap-4 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
          <span className="text-sm font-medium text-indigo-700">
            –í—ã–±—Ä–∞–Ω–æ: {selectedServers.length}
          </span>
          <button
            onClick={() => setShowBatchModal(true)}
            className="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition-colors"
          >
            <Package className="w-4 h-4" />
            –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ –ø–∞—Ä—Ç–∏–∏
          </button>

          <button
            onClick={handleExportSelected}
            disabled={exporting}
            className="flex items-center gap-1.5 px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors"
          >
            {exporting ? (
              <RefreshCw className="w-4 h-4 animate-spin" />
            ) : (
              <Download className="w-4 h-4" />
            )}
            –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
          </button>
          <button
            onClick={() => setSelectedServers([])}
            className="text-sm text-indigo-600 hover:text-indigo-800"
          >
            –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
          </button>
        </div>
      )}


      <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
        {loading ? (
          <div className="flex items-center justify-center py-16">
            <RefreshCw className="w-8 h-8 animate-spin text-indigo-500" />
          </div>
        ) : servers.length === 0 ? (
          <div className="text-center py-16 text-gray-400">
            <Server className="w-16 h-16 mx-auto mb-4 opacity-50" />
            <p className="text-lg font-medium">–°–µ—Ä–≤–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            <p className="text-sm mt-1">
              {onlyMine
                ? "–£ –≤–∞—Å –Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ. –°–Ω–∏–º–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä –∏–ª–∏ –≤–æ–∑—å–º–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –≤ —Ä–∞–±–æ—Ç—É."
                : "–ù–∞–∂–º–∏—Ç–µ \"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å DHCP\" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞"
              }
            </p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="bg-gray-50 border-b border-gray-200">
                  <th className="p-3 text-left w-10">
                    <input
                      type="checkbox"
                      checked={selectedServers.length === paginatedServers.length && paginatedServers.length > 0}
                      onChange={toggleSelectAll}
                      className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                    />
                  </th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">IP</th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">Hostname</th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">–ü–∞—Ä—Ç–∏—è</th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                  <th className="p-3 text-left text-xs font-semibold text-gray-500 uppercase">–û–±–Ω–æ–≤–ª—ë–Ω</th>
                  <th className="p-3 text-center text-xs font-semibold text-gray-500 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {paginatedServers.map((server) => {
                  const isAssignedToMe = server.assignedToId === currentUser?.id;
                  const canWork = server.status === "IN_WORK" && isAssignedToMe;
                  const isLoading = actionLoading === server.id;
                  const isPinging = pingingServerId === server.id;

                  return (
                    <tr
                      key={server.id}
                      className={`hover:bg-gray-50 transition-colors ${
                        !server.leaseActive ? "opacity-60" : ""
                      } ${selectedServers.includes(server.id) ? "bg-indigo-50/50" : ""}`}
                    >
                      <td className="p-3">
                        <input
                          type="checkbox"
                          checked={selectedServers.includes(server.id)}
                          onChange={() => toggleSelect(server.id)}
                          className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                        />
                      </td>

                      <td className="p-3">
                        <div className="flex items-center gap-1.5">
                          <button
                            onClick={() => navigate(`/beryll/server/${server.id}`)}
                            className="font-mono text-sm font-medium text-indigo-600 hover:underline"
                          >
                            {server.ipAddress}
                          </button>
                          <button
                            onClick={() => copyToClipboard(server.ipAddress || "")}
                            className="p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded transition-colors"
                            title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å IP"
                          >
                            <Copy className="w-3.5 h-3.5" />
                          </button>
                          <button
                            onClick={() => openInBrowser(server.ipAddress)}
                            className="p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                            title="–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
                          >
                            <Globe className="w-3.5 h-3.5" />
                          </button>
                          {!server.leaseActive && (
                            <span className="px-1.5 py-0.5 bg-red-100 text-red-600 text-[10px] rounded font-medium">
                              OFFLINE
                            </span>
                          )}
                          {getPingStatusIcon(server.id)}
                        </div>
                        {server.apkSerialNumber && (
                          <div className="text-xs text-purple-600 font-mono mt-0.5">
                            –ê–ü–ö: {server.apkSerialNumber}
                          </div>
                        )}
                      </td>

                      <td className="p-3">
                        <span className="text-sm text-gray-600 font-mono">
                          {server.hostname || "-"}
                        </span>
                      </td>

                      <td className="p-3">
                        <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border ${STATUS_COLORS[server.status]}`}>
                          {getStatusIcon(server.status)}
                          {STATUS_LABELS[server.status]}
                        </span>
                      </td>

                      <td className="p-3">
                        {server.batch ? (
                          <button
                            onClick={() => navigate(`/beryll/batch/${server.batch!.id}`)}
                            className="text-sm text-indigo-600 hover:underline flex items-center gap-1"
                          >
                            <Package className="w-3.5 h-3.5" />
                            {server.batch.title}
                          </button>
                        ) : (
                          <span className="text-sm text-gray-400">-</span>
                        )}
                      </td>

                      <td className="p-3">
                        {server.assignedTo ? (
                          <div className="flex items-center gap-2">
                            <div className={`w-7 h-7 rounded-full flex items-center justify-center ${
                              isAssignedToMe ? "bg-green-100" : "bg-indigo-100"
                            }`}>
                              <User className={`w-3.5 h-3.5 ${
                                isAssignedToMe ? "text-green-600" : "text-indigo-600"
                              }`} />
                            </div>
                            <span className="text-sm text-gray-700">
                              {server.assignedTo.surname} {server.assignedTo.name?.charAt(0)}.
                              {isAssignedToMe && (
                                <span className="text-green-600 text-xs ml-1">(–≤—ã)</span>
                              )}
                            </span>
                          </div>
                        ) : (
                          <span className="text-sm text-gray-400">-</span>
                        )}
                      </td>

                      <td className="p-3">
                        <span className="text-xs text-gray-500">
                          {formatDateTime(server.updatedAt)}
                        </span>
                      </td>

                      <td className="p-3">
                        <div className="flex items-center justify-center gap-1">
                          <button
                            onClick={() => handlePing(server)}
                            disabled={isPinging}
                            className="p-1.5 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors disabled:opacity-50"
                            title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (ping)"
                          >
                            {isPinging ? (
                              <RefreshCw className="w-4 h-4 animate-spin" />
                            ) : (
                              <Wifi className="w-4 h-4" />
                            )}
                          </button>

                          <button
                            onClick={() => navigate(`/beryll/server/${server.id}`)}
                            className="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                            title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É"
                          >
                            <ExternalLink className="w-4 h-4" />
                          </button>

                          {server.status === "NEW" && (
                            <button
                              onClick={() => handleTake(server)}
                              disabled={isLoading}
                              className="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg disabled:opacity-50 transition-colors"
                              title="–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"
                            >
                              {isLoading ? (
                                <RefreshCw className="w-4 h-4 animate-spin" />
                              ) : (
                                <Play className="w-4 h-4" />
                              )}
                            </button>
                          )}

                          {canWork && (
                            <button
                              onClick={() => handleStatusChange(server, "DONE")}
                              disabled={isLoading}
                              className="p-1.5 text-green-600 hover:bg-green-50 rounded-lg disabled:opacity-50 transition-colors"
                              title="–ó–∞–≤–µ—Ä—à–∏—Ç—å"
                            >
                              {isLoading ? (
                                <RefreshCw className="w-4 h-4 animate-spin" />
                              ) : (
                                <CheckCircle2 className="w-4 h-4" />
                              )}
                            </button>
                          )}

                          {server.status === "DONE" && server.apkSerialNumber && (
                            <button
                              onClick={() => handleArchive(server)}
                              disabled={isLoading}
                              className="p-1.5 text-purple-500 hover:bg-purple-50 rounded-lg disabled:opacity-50 transition-colors"
                              title="–í –∞—Ä—Ö–∏–≤"
                            >
                              <Archive className="w-4 h-4" />
                            </button>
                          )}

                          {server.status === "DONE" && server.apkSerialNumber && (
                            <button
                              onClick={() => handleGeneratePassport(server)}
                              className="p-1.5 text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                              title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Å–ø–æ—Ä—Ç"
                            >
                              <FileSpreadsheet className="w-4 h-4" />
                            </button>
                          )}

                          <button
                            onClick={() => handleDelete(server)}
                            disabled={isLoading}
                            className="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg disabled:opacity-50 transition-colors"
                            title="–£–¥–∞–ª–∏—Ç—å"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>


      {totalPages > 1 && (
        <div className="flex items-center justify-between p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
          <div className="text-sm text-gray-500">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {currentPage} –∏–∑ {totalPages}
          </div>

          <div className="flex items-center gap-1">
            <button
              onClick={() => goToPage(1)}
              disabled={currentPage === 1}
              className="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
              title="–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"
            >
              <ChevronsLeft className="w-5 h-5" />
            </button>

            <button
              onClick={() => goToPage(currentPage - 1)}
              disabled={currentPage === 1}
              className="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
              title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
            >
              <ChevronLeft className="w-5 h-5" />
            </button>

            <div className="flex items-center gap-1 mx-2">
              {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                let pageNum: number;
                if (totalPages <= 5) {
                  pageNum = i + 1;
                } else if (currentPage <= 3) {
                  pageNum = i + 1;
                } else if (currentPage >= totalPages - 2) {
                  pageNum = totalPages - 4 + i;
                } else {
                  pageNum = currentPage - 2 + i;
                }

                return (
                  <button
                    key={pageNum}
                    onClick={() => goToPage(pageNum)}
                    className={`w-9 h-9 rounded-lg text-sm font-medium transition-colors ${
                      currentPage === pageNum
                        ? "bg-indigo-600 text-white"
                        : "text-gray-600 hover:bg-indigo-50 hover:text-indigo-600"
                    }`}
                  >
                    {pageNum}
                  </button>
                );
              })}
            </div>

            <button
              onClick={() => goToPage(currentPage + 1)}
              disabled={currentPage === totalPages}
              className="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
              title="–°–ª–µ–¥—É—é—â–∞—è"
            >
              <ChevronRight className="w-5 h-5" />
            </button>

            <button
              onClick={() => goToPage(totalPages)}
              disabled={currentPage === totalPages}
              className="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
              title="–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"
            >
              <ChevronsRight className="w-5 h-5" />
            </button>
          </div>
        </div>
      )}


      {showBatchModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div className="p-5 border-b border-gray-200">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-indigo-100 rounded-lg">
                  <Package className="w-5 h-5 text-indigo-600" />
                </div>
                <div>
                  <h3 className="text-lg font-semibold text-gray-800">
                    –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–∏—é
                  </h3>
                  <p className="text-sm text-gray-500">
                    {selectedServers.length} {
                      selectedServers.length === 1 ? "—Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω" :
                      selectedServers.length < 5 ? "—Å–µ—Ä–≤–µ—Ä–∞ –±—É–¥—É—Ç –ø—Ä–∏–≤—è–∑–∞–Ω—ã" : "—Å–µ—Ä–≤–µ—Ä–æ–≤ –±—É–¥—É—Ç –ø—Ä–∏–≤—è–∑–∞–Ω—ã"
                    } –∫ –ø–∞—Ä—Ç–∏–∏
                  </p>
                </div>
              </div>
            </div>

            <div className="p-4 max-h-96 overflow-y-auto">
              {batches.length === 0 ? (
                <div className="text-center py-8 text-gray-400">
                  <Package className="w-12 h-12 mx-auto mb-2 opacity-50" />
                  <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π</p>
                  <p className="text-sm mt-1">–°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä—Ç–∏—é –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ü–∞—Ä—Ç–∏–∏"</p>
                </div>
              ) : (
                <div className="space-y-2">
                  {batches.map(batch => (
                    <button
                      key={batch.id}
                      onClick={() => handleAssignToBatch(batch.id)}
                      className="w-full p-3 text-left rounded-lg border border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all group"
                    >
                      <div className="font-medium text-gray-800 group-hover:text-indigo-700">
                        {batch.title}
                      </div>
                      {batch.supplier && (
                        <div className="text-sm text-gray-500">{batch.supplier}</div>
                      )}
                    </button>
                  ))}
                </div>
              )}
            </div>

            <div className="p-4 border-t border-gray-200 flex justify-end">
              <button
                onClick={() => setShowBatchModal(false)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
});

export default ServersTab;

================================================================================
FILE: QMS-Client-main/src/pages/Beryll/tabs/SettingsTab.tsx
================================================================================



import { useState, useEffect, useCallback } from "react";
import {
  Settings,
  Server,
  ListChecks,
  Plus,
  Edit,
  Trash2,
  Save,
  X,
  GripVertical,
  Clock,
  RefreshCw,
  CheckCircle2,
  AlertCircle,
  Camera,
  RotateCcw,
  Eye,
  EyeOff,
  FileImage
} from "lucide-react";
import {
  getChecklistTemplates,
  createChecklistTemplate,
  updateChecklistTemplate,
  deleteChecklistTemplate,
  reorderChecklistTemplates,
  restoreChecklistTemplate,
  BeryllChecklistTemplate,
  ChecklistGroup,
  CHECKLIST_GROUP_LABELS
} from "src/api/beryllApi";


interface DragItem {
  id: number;
  index: number;
}

export const SettingsTab: React.FC = () => {
  const [activeSection, setActiveSection] = useState<"dhcp" | "checklists">("checklists");


  const [templates, setTemplates] = useState<BeryllChecklistTemplate[]>([]);
  const [loadingTemplates, setLoadingTemplates] = useState(true);
  const [editingTemplate, setEditingTemplate] = useState<BeryllChecklistTemplate | null>(null);
  const [showTemplateModal, setShowTemplateModal] = useState(false);
  const [showInactive, setShowInactive] = useState(false);
  const [templateForm, setTemplateForm] = useState({
    title: "",
    description: "",
    sortOrder: 0,
    isRequired: true,
    estimatedMinutes: 30,
    groupCode: "TESTING" as ChecklistGroup,
    fileCode: "",
    requiresFile: false
  });
  const [saving, setSaving] = useState(false);


  const [draggedItem, setDraggedItem] = useState<DragItem | null>(null);
  const [dragOverIndex, setDragOverIndex] = useState<number | null>(null);

  const loadTemplates = async () => {
    setLoadingTemplates(true);
    try {
      const data = await getChecklistTemplates(showInactive);
      setTemplates(data.sort((a, b) => a.sortOrder - b.sortOrder));
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤:", e);
    } finally {
      setLoadingTemplates(false);
    }
  };

  useEffect(() => {
    loadTemplates();
  }, [showInactive]);

  const openCreateModal = () => {
    setEditingTemplate(null);
    setTemplateForm({
      title: "",
      description: "",
      sortOrder: templates.length * 10,
      isRequired: true,
      estimatedMinutes: 30,
      groupCode: "TESTING",
      fileCode: "",
      requiresFile: false
    });
    setShowTemplateModal(true);
  };

  const openEditModal = (template: BeryllChecklistTemplate) => {
    setEditingTemplate(template);
    setTemplateForm({
      title: template.title,
      description: template.description || "",
      sortOrder: template.sortOrder,
      isRequired: template.isRequired,
      estimatedMinutes: template.estimatedMinutes,
      groupCode: template.groupCode || "TESTING",
      fileCode: template.fileCode || "",
      requiresFile: template.requiresFile || false
    });
    setShowTemplateModal(true);
  };

  const handleSaveTemplate = async () => {
    if (!templateForm.title.trim()) {
      alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞");
      return;
    }

    setSaving(true);
    try {
      if (editingTemplate) {
        await updateChecklistTemplate(editingTemplate.id, templateForm);
      } else {
        await createChecklistTemplate(templateForm);
      }
      setShowTemplateModal(false);
      await loadTemplates();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    } finally {
      setSaving(false);
    }
  };

  const handleDeleteTemplate = async (template: BeryllChecklistTemplate) => {
    const action = template.isActive ? "–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å" : "–ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å";
    if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} —ç—Ç–∞–ø "${template.title}"?`)) return;

    try {
      await deleteChecklistTemplate(template.id, !template.isActive);
      await loadTemplates();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    }
  };

  const handleRestoreTemplate = async (template: BeryllChecklistTemplate) => {
    try {
      await restoreChecklistTemplate(template.id);
      await loadTemplates();
    } catch (e: any) {
      alert(e.response?.data?.message || "–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è");
    }
  };


  const handleDragStart = useCallback((e: React.DragEvent, id: number, index: number) => {
    setDraggedItem({ id, index });
    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData("text/html", e.currentTarget.outerHTML);
    (e.currentTarget as HTMLElement).style.opacity = "0.5";
  }, []);

  const handleDragEnd = useCallback((e: React.DragEvent) => {
    (e.currentTarget as HTMLElement).style.opacity = "1";
    setDraggedItem(null);
    setDragOverIndex(null);
  }, []);

  const handleDragOver = useCallback((e: React.DragEvent, index: number) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
    setDragOverIndex(index);
  }, []);

  const handleDrop = useCallback(async (e: React.DragEvent, dropIndex: number) => {
    e.preventDefault();

    if (!draggedItem || draggedItem.index === dropIndex) {
      setDragOverIndex(null);
      return;
    }


    const newTemplates = [...templates];
    const [draggedTemplate] = newTemplates.splice(draggedItem.index, 1);
    newTemplates.splice(dropIndex, 0, draggedTemplate);


    setTemplates(newTemplates);
    setDragOverIndex(null);


    try {
      const orderedIds = newTemplates.map(t => t.id);
      await reorderChecklistTemplates(orderedIds);
    } catch (e: any) {
      console.error("–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞:", e);

      await loadTemplates();
    }
  }, [draggedItem, templates]);


  const groupedTemplates = templates.reduce((acc, template) => {
    const group = template.groupCode || "TESTING";
    if (!acc[group]) acc[group] = [];
    acc[group].push(template);
    return acc;
  }, {} as Record<ChecklistGroup, BeryllChecklistTemplate[]>);

  const groupOrder: ChecklistGroup[] = ["VISUAL", "TESTING", "QC_PRIMARY", "BURN_IN", "QC_FINAL"];

  return (
    <div className="space-y-6">

      <div className="flex gap-2 border-b border-gray-200 pb-4">
        <button
          onClick={() => setActiveSection("checklists")}
          className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            activeSection === "checklists"
              ? "bg-indigo-100 text-indigo-700"
              : "text-gray-600 hover:bg-gray-100"
          }`}
        >
          <ListChecks className="w-4 h-4" />
          –≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç (–ß–µ–∫-–ª–∏—Å—Ç)
        </button>
        <button
          onClick={() => setActiveSection("dhcp")}
          className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            activeSection === "dhcp"
              ? "bg-indigo-100 text-indigo-700"
              : "text-gray-600 hover:bg-gray-100"
          }`}
        >
          <Server className="w-4 h-4" />
          –ù–∞—Å—Ç—Ä–æ–π–∫–∏ DHCP
        </button>
      </div>


      {activeSection === "checklists" && (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-lg font-semibold text-gray-800">
                –≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç –Ω–∞–¥ —Å–µ—Ä–≤–µ—Ä–æ–º
              </h2>
              <p className="text-sm text-gray-500">
                –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —á–µ–∫-–ª–∏—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–π. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —ç—Ç–∞–ø—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞.
              </p>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setShowInactive(!showInactive)}
                className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm transition-colors ${
                  showInactive
                    ? "bg-gray-200 text-gray-700"
                    : "text-gray-500 hover:bg-gray-100"
                }`}
              >
                {showInactive ? <Eye className="w-4 h-4" /> : <EyeOff className="w-4 h-4" />}
                {showInactive ? "–°–∫—Ä—ã—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ" : "–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ"}
              </button>
              <button
                onClick={openCreateModal}
                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
              >
                <Plus className="w-4 h-4" />
                –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø
              </button>
            </div>
          </div>

          {loadingTemplates ? (
            <div className="flex items-center justify-center py-12">
              <RefreshCw className="w-6 h-6 animate-spin text-indigo-500" />
            </div>
          ) : templates.length === 0 ? (
            <div className="text-center py-12 bg-white rounded-xl border border-gray-200">
              <ListChecks className="w-12 h-12 mx-auto mb-3 text-gray-300" />
              <p className="text-gray-500 mb-4">–≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</p>
              <button
                onClick={openCreateModal}
                className="text-indigo-600 hover:underline"
              >
                –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø
              </button>
            </div>
          ) : (
            <div className="space-y-6">
              {groupOrder.map(groupCode => {
                const groupTemplates = groupedTemplates[groupCode];
                if (!groupTemplates || groupTemplates.length === 0) return null;

                return (
                  <div key={groupCode} className="bg-white rounded-xl border border-gray-200 overflow-hidden">

                    <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                      <h3 className="font-medium text-gray-700">
                        {CHECKLIST_GROUP_LABELS[groupCode]}
                      </h3>
                    </div>


                    <div className="divide-y divide-gray-100">
                      {groupTemplates.map((template, index) => {
                        const globalIndex = templates.findIndex(t => t.id === template.id);

                        return (
                          <div
                            key={template.id}
                            draggable
                            onDragStart={(e) => handleDragStart(e, template.id, globalIndex)}
                            onDragEnd={handleDragEnd}
                            onDragOver={(e) => handleDragOver(e, globalIndex)}
                            onDrop={(e) => handleDrop(e, globalIndex)}
                            className={`p-4 flex items-center gap-4 transition-all cursor-move ${
                              !template.isActive ? "opacity-50 bg-gray-50" : "hover:bg-gray-50"
                            } ${
                              dragOverIndex === globalIndex ? "border-t-2 border-indigo-500" : ""
                            }`}
                          >

                            <div className="flex items-center gap-2 text-gray-400">
                              <GripVertical className="w-4 h-4 cursor-grab active:cursor-grabbing" />
                              <span className="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs font-medium">
                                {index + 1}
                              </span>
                            </div>


                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 flex-wrap">
                                <span className={`font-medium ${template.isActive ? "text-gray-800" : "text-gray-500"}`}>
                                  {template.title}
                                </span>
                                {template.isRequired && (
                                  <span className="px-1.5 py-0.5 bg-red-100 text-red-600 text-[10px] rounded font-medium">
                                    –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô
                                  </span>
                                )}
                                {template.requiresFile && (
                                  <span className="px-1.5 py-0.5 bg-amber-100 text-amber-700 text-[10px] rounded font-medium flex items-center gap-1">
                                    <Camera className="w-3 h-3" />
                                    –°–ö–†–ò–ù
                                  </span>
                                )}
                                {!template.isActive && (
                                  <span className="px-1.5 py-0.5 bg-gray-200 text-gray-600 text-[10px] rounded font-medium">
                                    –ù–ï–ê–ö–¢–ò–í–ï–ù
                                  </span>
                                )}
                              </div>
                              {template.description && (
                                <p className="text-sm text-gray-500 mt-0.5 line-clamp-1">
                                  {template.description}
                                </p>
                              )}
                              {template.fileCode && (
                                <p className="text-xs text-gray-400 mt-0.5">
                                  –ö–æ–¥ —Ñ–∞–π–ª–∞: {template.fileCode}
                                </p>
                              )}
                            </div>


                            <div className="flex items-center gap-1 text-sm text-gray-500">
                              <Clock className="w-4 h-4" />
                              ~{template.estimatedMinutes} –º–∏–Ω
                            </div>


                            <div className="flex items-center gap-1">
                              {!template.isActive && (
                                <button
                                  onClick={() => handleRestoreTemplate(template)}
                                  className="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg"
                                  title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
                                >
                                  <RotateCcw className="w-4 h-4" />
                                </button>
                              )}
                              <button
                                onClick={() => openEditModal(template)}
                                className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg"
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                              >
                                <Edit className="w-4 h-4" />
                              </button>
                              <button
                                onClick={() => handleDeleteTemplate(template)}
                                className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg"
                                title={template.isActive ? "–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å" : "–£–¥–∞–ª–∏—Ç—å"}
                              >
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          )}


          <div className="p-4 bg-blue-50 rounded-lg border border-blue-200 flex gap-3">
            <AlertCircle className="w-5 h-5 text-blue-500 shrink-0 mt-0.5" />
            <div className="text-sm text-blue-700">
              <p className="font-medium">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —ç—Ç–∞–ø—ã:</p>
              <ul className="mt-1 list-disc list-inside space-y-1 text-blue-600">
                <li>–ü—Ä–∏ –≤–∑—è—Ç–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ä–∞–±–æ—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ–∫-–ª–∏—Å—Ç</li>
                <li>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ—Ç–º–µ—á–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã</li>
                <li>
                  <Camera className="w-3 h-3 inline mr-1" />
                  –≠—Ç–∞–ø—ã —Å –ø–æ–º–µ—Ç–∫–æ–π <strong>"–°–ö–†–ò–ù"</strong> —Ç—Ä–µ–±—É—é—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
                </li>
                <li>–í—Å–µ –æ—Ç–º–µ—Ç–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π</li>
                <li>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç—Ç–∞–ø—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º</li>
              </ul>
            </div>
          </div>
        </div>
      )}


      {activeSection === "dhcp" && (
        <div className="space-y-4">
          <div>
            <h2 className="text-lg font-semibold text-gray-800">
              –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ DHCP —Å–µ—Ä–≤–µ—Ä—É
            </h2>
            <p className="text-sm text-gray-500">
              –ü–∞—Ä–∞–º–µ—Ç—Ä—ã SSH-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ lease-—Ñ–∞–π–ª–∞
            </p>
          </div>

          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <div className="grid md:grid-cols-2 gap-6">

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  DHCP —Å–µ—Ä–≤–µ—Ä (IP)
                </label>
                <input
                  type="text"
                  value="10.11.0.10"
                  disabled
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                />
                <p className="text-xs text-gray-500 mt-1">
                  –ò–∑–º–µ–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞
                </p>
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  SSH –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                </label>
                <input
                  type="text"
                  value="root"
                  disabled
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                />
              </div>


              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  –ü—É—Ç—å –∫ lease-—Ñ–∞–π–ª—É
                </label>
                <input
                  type="text"
                  value="/var/lib/kea/kea-leases4.csv"
                  disabled
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 font-mono text-sm"
                />
              </div>
            </div>
          </div>
        </div>
      )}


      {showTemplateModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-800">
                {editingTemplate ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∞–ø" : "–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø"}
              </h3>
            </div>

            <div className="p-6 space-y-4">

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ *
                </label>
                <input
                  type="text"
                  value={templateForm.title}
                  onChange={(e) => setTemplateForm({ ...templateForm, title: e.target.value })}
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –û–ø–∏—Å–∞–Ω–∏–µ
                </label>
                <textarea
                  value={templateForm.description}
                  onChange={(e) => setTemplateForm({ ...templateForm, description: e.target.value })}
                  placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–∞–ø–∞..."
                  rows={3}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –ì—Ä—É–ø–ø–∞
                </label>
                <select
                  value={templateForm.groupCode}
                  onChange={(e) => setTemplateForm({ ...templateForm, groupCode: e.target.value as ChecklistGroup })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                >
                  {groupOrder.map(group => (
                    <option key={group} value={group}>
                      {CHECKLIST_GROUP_LABELS[group]}
                    </option>
                  ))}
                </select>
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –û—Ü–µ–Ω–æ—á–Ω–æ–µ –≤—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã)
                </label>
                <input
                  type="number"
                  value={templateForm.estimatedMinutes}
                  onChange={(e) => setTemplateForm({ ...templateForm, estimatedMinutes: parseInt(e.target.value) || 0 })}
                  min={0}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –ö–æ–¥ —Ñ–∞–π–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                </label>
                <input
                  type="text"
                  value={templateForm.fileCode}
                  onChange={(e) => setTemplateForm({ ...templateForm, fileCode: e.target.value })}
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: sn_raid2"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
                <p className="text-xs text-gray-500 mt-1">
                  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
                </p>
              </div>


              <div className="space-y-3 pt-2">

                <label className="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={templateForm.isRequired}
                    onChange={(e) => setTemplateForm({ ...templateForm, isRequired: e.target.checked })}
                    className="w-5 h-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                  />
                  <div>
                    <span className="font-medium text-gray-700">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —ç—Ç–∞–ø</span>
                    <p className="text-xs text-gray-500">–î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç—ã</p>
                  </div>
                </label>


                <label className="flex items-center gap-3 cursor-pointer p-3 rounded-lg border-2 border-dashed border-amber-300 bg-amber-50">
                  <input
                    type="checkbox"
                    checked={templateForm.requiresFile}
                    onChange={(e) => setTemplateForm({ ...templateForm, requiresFile: e.target.checked })}
                    className="w-5 h-5 rounded border-amber-400 text-amber-600 focus:ring-amber-500"
                  />
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <Camera className="w-4 h-4 text-amber-600" />
                      <span className="font-medium text-amber-700">–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–Ω—à–æ—Ç/–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ</span>
                    </div>
                    <p className="text-xs text-amber-600 mt-0.5">
                      –ù–µ–ª—å–∑—è –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                    </p>
                  </div>
                </label>
              </div>
            </div>

            <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
              <button
                onClick={() => setShowTemplateModal(false)}
                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleSaveTemplate}
                disabled={saving}
                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
              >
                {saving ? (
                  <RefreshCw className="w-4 h-4 animate-spin" />
                ) : (
                  <Save className="w-4 h-4" />
                )}
                {editingTemplate ? "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" : "–°–æ–∑–¥–∞—Ç—å"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default SettingsTab;

================================================================================
FILE: QMS-Client-main/src/pages/BetaFlight/Betaflight.tsx
================================================================================

import React, { useState, useEffect } from "react";

export const Betaflight: React.FC = () => {
  const [attitude, setAttitude] = useState({ roll: 0, pitch: 0, yaw: 0 });
  const [serialPort, setSerialPort] = useState<SerialPort | null>(null);
  const [isConnected, setIsConnected] = useState(false);


  const openSerialPort = async () => {
    try {
      if (serialPort) {
        console.log("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ");
        return;
      }

      const port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });

      setSerialPort(port);
      setIsConnected(true);
      console.log("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ");


      startReadingAttitude(port);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:", error);
    }
  };


  const sendMspCommand = async (port: SerialPort, commandCode: number) => {
    try {
      if (!port.writable) {
        throw new Error("–ü–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏");
      }

      const writer = port.writable.getWriter();
      const commandBuffer = new Uint8Array([
        36,
        77,
        60,
        0,
        commandCode,
        commandCode ^ 0x00,
      ]);

      await writer.write(commandBuffer);
      writer.releaseLock();
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ MSP-–∫–æ–º–∞–Ω–¥—ã:", error);
    }
  };


  const startReadingAttitude = async (port: SerialPort) => {
    try {
      if (!port.readable) {
        throw new Error("–ü–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è");
      }

      const reader = port.readable.getReader();

      const readLoop = async () => {
        while (true) {
          try {
            await sendMspCommand(port, 108);

            const { value, done } = await reader.read();
            if (done) break;

            if (value) {
              parseAttitudeData(value);
            }

            await new Promise((resolve) => setTimeout(resolve, 10));
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≤ –ø–æ—Ç–æ–∫–µ —á—Ç–µ–Ω–∏—è:", error);
            break;
          }
        }
        reader.releaseLock();
      };

      readLoop();
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ—Ç–æ–∫–∞ —á—Ç–µ–Ω–∏—è:", error);
    }
  };


  const parseAttitudeData = (data: Uint8Array) => {
    if (data.length < 12) {
      console.error("–û—à–∏–±–∫–∞: –ø—Ä–∏—à–µ–ª —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø–∞–∫–µ—Ç", data);
      return;
    }

    const dv = new DataView(data.buffer);

    try {
      console.log("–°—ã—Ä–æ–π MSP_ATTITUDE:", Array.from(data));

      const roll = dv.getInt16(5, true) / 10;
      const pitch = dv.getInt16(7, true) / 10;
      const yaw = dv.getInt16(9, true) / 1;

      console.log(`ROLL=${roll}, PITCH=${pitch}, YAW=${yaw}`);

      setAttitude({ roll, pitch, yaw });
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö:", e, data);
    }
  };


  useEffect(() => {
    return () => {
      if (serialPort) {
        serialPort.close();
      }
    };
  }, [serialPort]);

  return (
    <div className="p-4">
      <h1 className="text-xl font-bold mb-4">–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ª–µ—Ç–Ω–∏–∫–∞:</h1>
      <button
        className="px-4 py-2 bg-blue-500 text-white rounded-md"
        onClick={openSerialPort}
      >
        {isConnected ? "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ" : "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"}
      </button>
      <div className="mt-4 text-lg">
        <p>
          –†—ã—Å–∫–∞–Ω–∏–µ (Yaw): <b>{attitude.yaw.toFixed(1)}¬∞</b>
        </p>
        <p>
          –¢–∞–Ω–≥–∞–∂ (Pitch): <b>{attitude.pitch.toFixed(1)}¬∞</b>
        </p>
        <p>
          –ö—Ä–µ–Ω (Roll): <b>{attitude.roll.toFixed(1)}¬∞</b>
        </p>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Defects/DefectDetailPage.tsx
================================================================================

import React, { useEffect, useState, useCallback } from "react";
import { useParams, useNavigate } from "react-router-dom";
import {
  ArrowLeft,
  AlertTriangle,
  Wrench,
  CheckCircle2,
  XCircle,
  Clock,
  User,
  Plus,
  Trash2,
  PackageCheck,
  RotateCcw
} from "lucide-react";
import {
  fetchDefectById,
  markDefectRepaired,
  markDefectScrapped,
  verifyDefectRepair,
  updateDefectStatus
} from "src/api/defectApi";
import {
  BoardDefect,
  RepairAction,
  BOARD_TYPE_LABELS,
  DEFECT_STATUS_LABELS,
  DEFECT_STATUS_COLORS,
  SEVERITY_LABELS,
  SEVERITY_COLORS,
  ACTION_TYPE_LABELS,
  ACTION_TYPE_ICONS,
  ACTION_RESULT_LABELS,
  ACTION_RESULT_COLORS
} from "src/types/DefectTypes";
import { AddRepairActionModal } from "./components/AddRepairActionModal";

export const DefectDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();

  const [defect, setDefect] = useState<BoardDefect | null>(null);
  const [boardInfo, setBoardInfo] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [actionLoading, setActionLoading] = useState(false);


  const [showAddAction, setShowAddAction] = useState(false);
  const [showRepairedModal, setShowRepairedModal] = useState(false);
  const [showScrapModal, setShowScrapModal] = useState(false);


  const [repairNote, setRepairNote] = useState("");
  const [repairTime, setRepairTime] = useState("");
  const [scrapReason, setScrapReason] = useState("");

  const loadDefect = useCallback(async () => {
    if (!id) return;

    setLoading(true);
    try {
      const response = await fetchDefectById(Number(id));
      setDefect(response.defect);
      setBoardInfo(response.boardInfo);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
    } finally {
      setLoading(false);
    }
  }, [id]);

  useEffect(() => {
    loadDefect();
  }, [loadDefect]);


  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  };

  const formatShortDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  };


  const handleMarkRepaired = async () => {
    if (!defect) return;
    setActionLoading(true);
    try {
      await markDefectRepaired(defect.id, {
        repairNote: repairNote || undefined,
        timeSpentMinutes: repairTime ? Number(repairTime) : undefined
      });
      setShowRepairedModal(false);
      setRepairNote("");
      setRepairTime("");
      loadDefect();
    } catch (e) {
      console.error(e);
    } finally {
      setActionLoading(false);
    }
  };

  const handleMarkScrapped = async () => {
    if (!defect) return;
    setActionLoading(true);
    try {
      await markDefectScrapped(defect.id, {
        reason: scrapReason || undefined
      });
      setShowScrapModal(false);
      setScrapReason("");
      loadDefect();
    } catch (e) {
      console.error(e);
    } finally {
      setActionLoading(false);
    }
  };

  const handleVerify = async () => {
    if (!defect) return;
    if (!confirm("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ —Ä–µ–º–æ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ?")) return;

    setActionLoading(true);
    try {
      await verifyDefectRepair(defect.id);
      loadDefect();
    } catch (e) {
      console.error(e);
    } finally {
      setActionLoading(false);
    }
  };

  const handleTakeToWork = async () => {
    if (!defect) return;
    setActionLoading(true);
    try {
      await updateDefectStatus(defect.id, "IN_REPAIR");
      loadDefect();
    } catch (e) {
      console.error(e);
    } finally {
      setActionLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50/50 flex items-center justify-center">
        <div className="text-center text-gray-500">
          <div className="animate-spin w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full mx-auto mb-4"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>
    );
  }

  if (!defect) {
    return (
      <div className="min-h-screen bg-gray-50/50 flex items-center justify-center">
        <div className="text-center">
          <AlertTriangle className="mx-auto text-gray-300 mb-4" size={48} />
          <p className="text-gray-500">–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
          <button
            onClick={() => navigate("/defects")}
            className="mt-4 text-orange-500 hover:text-orange-600"
          >
            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
          </button>
        </div>
      </div>
    );
  }

  const isActive = ["OPEN", "IN_REPAIR", "REPAIRED"].includes(defect.status);
  const canRepair = ["OPEN", "IN_REPAIR"].includes(defect.status);
  const canVerify = defect.status === "REPAIRED";
  const canScrap = ["OPEN", "IN_REPAIR"].includes(defect.status);

  return (
    <div className="min-h-screen bg-gray-50/50 p-6 pb-20">
      <div className="max-w-5xl mx-auto">


        <div className="flex items-center gap-4 mb-6">
          <button
            onClick={() => navigate("/defects")}
            className="p-2 hover:bg-white rounded-lg transition-all"
          >
            <ArrowLeft size={24} />
          </button>
          <div className="flex-1">
            <div className="flex items-center gap-3">
              <h1 className="text-2xl font-bold text-gray-800">–î–µ—Ñ–µ–∫—Ç #{defect.id}</h1>
              <span className={`px-3 py-1 rounded-full text-sm font-medium ${DEFECT_STATUS_COLORS[defect.status]}`}>
                {DEFECT_STATUS_LABELS[defect.status]}
              </span>
            </div>
            <p className="text-gray-500">
              {BOARD_TYPE_LABELS[defect.boardType]}
              {defect.serialNumber && <span className="ml-2 font-mono">‚Ä¢ {defect.serialNumber}</span>}
            </p>
          </div>
        </div>

        <div className="grid grid-cols-3 gap-6">

          <div className="col-span-2 space-y-6">


            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <AlertTriangle className="text-orange-500" size={20} />
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ—Ñ–µ–∫—Ç–µ
              </h2>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <span className="text-sm text-gray-500">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                  <div className="flex items-center gap-2 mt-1">
                    {defect.category && (
                      <>
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${SEVERITY_COLORS[defect.category.severity]}`}>
                          {SEVERITY_LABELS[defect.category.severity]}
                        </span>
                        <span className="font-medium">{defect.category.title}</span>
                      </>
                    )}
                  </div>
                </div>

                <div>
                  <span className="text-sm text-gray-500">–û–±–Ω–∞—Ä—É–∂–∏–ª</span>
                  <div className="flex items-center gap-2 mt-1">
                    <User size={16} className="text-gray-400" />
                    <span>
                      {defect.detectedBy
                        ? `${defect.detectedBy.surname} ${defect.detectedBy.name}`
                        : "‚Äî"
                      }
                    </span>
                  </div>
                </div>

                <div>
                  <span className="text-sm text-gray-500">–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è</span>
                  <div className="mt-1 font-medium">{formatDate(defect.detectedAt)}</div>
                </div>

                <div>
                  <span className="text-sm text-gray-500">–í—Ä–µ–º—è —Ä–µ–º–æ–Ω—Ç–∞</span>
                  <div className="mt-1 font-medium">
                    {defect.totalRepairMinutes > 0
                      ? `${defect.totalRepairMinutes} –º–∏–Ω—É—Ç`
                      : "‚Äî"
                    }
                  </div>
                </div>
              </div>

              {defect.description && (
                <div className="mt-4 pt-4 border-t border-gray-100">
                  <span className="text-sm text-gray-500">–û–ø–∏—Å–∞–Ω–∏–µ</span>
                  <p className="mt-1 text-gray-700">{defect.description}</p>
                </div>
              )}

              {defect.closedAt && (
                <div className="mt-4 pt-4 border-t border-gray-100">
                  <span className="text-sm text-gray-500">–ó–∞–∫—Ä—ã—Ç</span>
                  <div className="mt-1">
                    {defect.closedBy && (
                      <span>{defect.closedBy.surname} {defect.closedBy.name} ‚Ä¢ </span>
                    )}
                    <span className="text-gray-500">{formatDate(defect.closedAt)}</span>
                  </div>
                </div>
              )}
            </div>


            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                  <Wrench className="text-blue-500" size={20} />
                  –ò—Å—Ç–æ—Ä–∏—è —Ä–µ–º–æ–Ω—Ç–∞
                </h2>
                {canRepair && (
                  <button
                    onClick={() => setShowAddAction(true)}
                    className="flex items-center gap-1 px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-all"
                  >
                    <Plus size={16} />
                    –î–æ–±–∞–≤–∏—Ç—å
                  </button>
                )}
              </div>

              {defect.repairs && defect.repairs.length > 0 ? (
                <div className="space-y-3">
                  {defect.repairs.map((action: RepairAction) => (
                    <div
                      key={action.id}
                      className="border border-gray-200 rounded-lg p-4 hover:border-gray-300 transition-all"
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex items-center gap-2">
                          <span className="text-xl">{ACTION_TYPE_ICONS[action.actionType]}</span>
                          <div>
                            <span className="font-medium">{ACTION_TYPE_LABELS[action.actionType]}</span>
                            {action.timeSpentMinutes && (
                              <span className="text-sm text-gray-500 ml-2">
                                ‚Ä¢ {action.timeSpentMinutes} –º–∏–Ω
                              </span>
                            )}
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm text-gray-500">
                            {formatShortDate(action.performedAt)}
                          </div>
                          <div className="text-sm">
                            {action.performedBy && (
                              <span>{action.performedBy.surname} {action.performedBy.name?.charAt(0)}.</span>
                            )}
                          </div>
                        </div>
                      </div>
                      <p className="mt-2 text-gray-700">{action.description}</p>
                      <div className="mt-2">
                        <span className={`text-sm font-medium ${ACTION_RESULT_COLORS[action.result]}`}>
                          {action.result === "SUCCESS" && "‚úì "}
                          {action.result === "FAILED" && "‚úó "}
                          {ACTION_RESULT_LABELS[action.result]}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-400">
                  <Clock className="mx-auto mb-2" size={32} />
                  <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                </div>
              )}
            </div>
          </div>


          <div className="space-y-6">

            {isActive && (
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 className="text-lg font-bold text-gray-800 mb-4">–î–µ–π—Å—Ç–≤–∏—è</h2>

                <div className="space-y-3">
                  {defect.status === "OPEN" && (
                    <button
                      onClick={handleTakeToWork}
                      disabled={actionLoading}
                      className="w-full py-3 bg-yellow-500 hover:bg-yellow-600 disabled:bg-gray-300 text-white rounded-xl font-semibold flex items-center justify-center gap-2 transition-all"
                    >
                      <Wrench size={18} />
                      –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
                    </button>
                  )}

                  {canRepair && (
                    <>
                      <button
                        onClick={() => setShowAddAction(true)}
                        className="w-full py-3 border-2 border-blue-500 text-blue-600 hover:bg-blue-50 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all"
                      >
                        <Plus size={18} />
                        –î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
                      </button>

                      <button
                        onClick={() => setShowRepairedModal(true)}
                        disabled={actionLoading}
                        className="w-full py-3 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white rounded-xl font-semibold flex items-center justify-center gap-2 transition-all"
                      >
                        <CheckCircle2 size={18} />
                        –û—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
                      </button>
                    </>
                  )}

                  {canVerify && (
                    <button
                      onClick={handleVerify}
                      disabled={actionLoading}
                      className="w-full py-3 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white rounded-xl font-semibold flex items-center justify-center gap-2 transition-all"
                    >
                      <PackageCheck size={18} />
                      –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (–û–¢–ö)
                    </button>
                  )}

                  {canScrap && (
                    <button
                      onClick={() => setShowScrapModal(true)}
                      disabled={actionLoading}
                      className="w-full py-3 border-2 border-red-500 text-red-600 hover:bg-red-50 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all"
                    >
                      <Trash2 size={18} />
                      –°–ø–∏—Å–∞—Ç—å
                    </button>
                  )}
                </div>
              </div>
            )}


            {boardInfo && (
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 className="text-lg font-bold text-gray-800 mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ</h2>
                <pre className="text-xs text-gray-600 overflow-auto">
                  {JSON.stringify(boardInfo, null, 2)}
                </pre>
              </div>
            )}
          </div>
        </div>
      </div>


      {showAddAction && (
        <AddRepairActionModal
          defectId={defect.id}
          boardType={defect.boardType}
          onClose={() => setShowAddAction(false)}
          onAdded={() => {
            setShowAddAction(false);
            loadDefect();
          }}
        />
      )}


      {showRepairedModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
            <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <CheckCircle2 className="text-green-500" size={24} />
              –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ
            </h2>

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
              </label>
              <textarea
                value={repairNote}
                onChange={e => setRepairNote(e.target.value)}
                rows={3}
                placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 resize-none"
              />
            </div>

            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                –ó–∞—Ç—Ä–∞—á–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ (–º–∏–Ω—É—Ç)
              </label>
              <input
                type="number"
                value={repairTime}
                onChange={e => setRepairTime(e.target.value)}
                placeholder="0"
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500"
              />
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => setShowRepairedModal(false)}
                className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleMarkRepaired}
                disabled={actionLoading}
                className="flex-1 py-3 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white rounded-xl font-semibold"
              >
                {actionLoading ? "..." : "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"}
              </button>
            </div>
          </div>
        </div>
      )}


      {showScrapModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
            <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <XCircle className="text-red-500" size={24} />
              –°–ø–∏—Å–∞—Ç—å –∫–∞–∫ –±—Ä–∞–∫
            </h2>

            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                –ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è
              </label>
              <textarea
                value={scrapReason}
                onChange={e => setScrapReason(e.target.value)}
                rows={3}
                placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É..."
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 resize-none"
              />
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => setShowScrapModal(false)}
                className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleMarkScrapped}
                disabled={actionLoading}
                className="flex-1 py-3 bg-red-500 hover:bg-red-600 disabled:bg-gray-300 text-white rounded-xl font-semibold"
              >
                {actionLoading ? "..." : "–°–ø–∏—Å–∞—Ç—å"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Defects/DefectsPage.tsx
================================================================================

import React, { useEffect, useState, useCallback } from "react";
import { useNavigate } from "react-router-dom";
import {
  AlertTriangle,
  Search,
  Plus,
  Filter,
  Wrench,
  CheckCircle2,
  XCircle,
  Clock,
  RefreshCw,
  ChevronLeft,
  ChevronRight
} from "lucide-react";
import { fetchDefects, FetchDefectsParams } from "src/api/defectApi";
import {
  BoardDefect,
  DefectStatus,
  BoardType,
  BOARD_TYPE_SHORT,
  DEFECT_STATUS_LABELS,
  DEFECT_STATUS_COLORS,
  SEVERITY_COLORS
} from "src/types/DefectTypes";
import { CreateDefectModal } from "./components/CreateDefectModal";


const STATUS_TABS: Array<{ key: DefectStatus | "ACTIVE" | "ALL"; label: string; icon: React.ReactNode }> = [
  { key: "OPEN", label: "–ñ–¥—É—Ç —Ä–µ–º–æ–Ω—Ç–∞", icon: <AlertTriangle size={16} /> },
  { key: "IN_REPAIR", label: "–í —Ä–µ–º–æ–Ω—Ç–µ", icon: <Wrench size={16} /> },
  { key: "REPAIRED", label: "–û—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ", icon: <Clock size={16} /> },
  { key: "ACTIVE", label: "–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ", icon: <RefreshCw size={16} /> },
  { key: "ALL", label: "–í—Å–µ", icon: null },
];

export const DefectsPage: React.FC = () => {
  const navigate = useNavigate();


  const [defects, setDefects] = useState<BoardDefect[]>([]);
  const [loading, setLoading] = useState(false);
  const [stats, setStats] = useState<Record<string, number>>({});


  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [total, setTotal] = useState(0);


  const [activeTab, setActiveTab] = useState<DefectStatus | "ACTIVE" | "ALL">("OPEN");
  const [boardType, setBoardType] = useState<BoardType | "">("");
  const [search, setSearch] = useState("");
  const [searchInput, setSearchInput] = useState("");


  const [showCreateModal, setShowCreateModal] = useState(false);


  const loadDefects = useCallback(async () => {
    setLoading(true);
    try {
      const params: FetchDefectsParams = {
        page,
        limit: 30,
      };

      if (activeTab !== "ALL") {
        params.status = activeTab;
      }
      if (boardType) {
        params.boardType = boardType;
      }
      if (search) {
        params.search = search;
      }

      const response = await fetchDefects(params);
      setDefects(response.defects);
      setTotalPages(response.totalPages);
      setTotal(response.total);
      setStats(response.stats);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤:", e);
    } finally {
      setLoading(false);
    }
  }, [page, activeTab, boardType, search]);

  useEffect(() => {
    loadDefects();
  }, [loadDefects]);


  useEffect(() => {
    setPage(1);
  }, [activeTab, boardType, search]);


  useEffect(() => {
    const timer = setTimeout(() => {
      setSearch(searchInput);
    }, 500);
    return () => clearTimeout(timer);
  }, [searchInput]);


  const openDefect = (id: number) => {
    navigate(`/defects/${id}`);
  };


  const handleCreated = () => {
    setShowCreateModal(false);
    loadDefects();
  };


  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      year: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  };


  const getTabCount = (key: string) => {
    if (key === "ALL") return total;
    if (key === "ACTIVE") {
      return (stats["OPEN"] || 0) + (stats["IN_REPAIR"] || 0) + (stats["REPAIRED"] || 0);
    }
    return stats[key] || 0;
  };

  return (
    <div className="min-h-screen bg-gray-50/50 p-6 pb-20">
      <div className="max-w-7xl mx-auto">


        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-orange-500 rounded-2xl shadow-lg shadow-orange-200 text-white">
              <AlertTriangle size={32} />
            </div>
            <div>
              <h1 className="text-3xl font-bold text-gray-800">–£—á—ë—Ç –±—Ä–∞–∫–∞ –∏ —Ä–µ–º–æ–Ω—Ç</h1>
              <p className="text-gray-500 font-medium">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∏ –∏—Å—Ç–æ—Ä–∏—è —Ä–µ–º–æ–Ω—Ç–∞</p>
            </div>
          </div>

          <button
            onClick={() => setShowCreateModal(true)}
            className="flex items-center gap-2 px-5 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-semibold shadow-lg shadow-orange-200 transition-all"
          >
            <Plus size={20} />
            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –±—Ä–∞–∫
          </button>
        </div>


        <div className="grid grid-cols-4 gap-4 mb-6">
          <div className="bg-white rounded-xl p-4 border border-red-200 shadow-sm">
            <div className="flex items-center justify-between">
              <span className="text-red-600 font-medium">–ñ–¥—É—Ç —Ä–µ–º–æ–Ω—Ç–∞</span>
              <AlertTriangle className="text-red-400" size={20} />
            </div>
            <p className="text-3xl font-bold text-red-600 mt-1">{stats["OPEN"] || 0}</p>
          </div>
          <div className="bg-white rounded-xl p-4 border border-yellow-200 shadow-sm">
            <div className="flex items-center justify-between">
              <span className="text-yellow-600 font-medium">–í —Ä–µ–º–æ–Ω—Ç–µ</span>
              <Wrench className="text-yellow-400" size={20} />
            </div>
            <p className="text-3xl font-bold text-yellow-600 mt-1">{stats["IN_REPAIR"] || 0}</p>
          </div>
          <div className="bg-white rounded-xl p-4 border border-blue-200 shadow-sm">
            <div className="flex items-center justify-between">
              <span className="text-blue-600 font-medium">–û—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ</span>
              <Clock className="text-blue-400" size={20} />
            </div>
            <p className="text-3xl font-bold text-blue-600 mt-1">{stats["REPAIRED"] || 0}</p>
          </div>
          <div className="bg-white rounded-xl p-4 border border-green-200 shadow-sm">
            <div className="flex items-center justify-between">
              <span className="text-green-600 font-medium">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –û–¢–ö</span>
              <CheckCircle2 className="text-green-400" size={20} />
            </div>
            <p className="text-3xl font-bold text-green-600 mt-1">{stats["VERIFIED"] || 0}</p>
          </div>
        </div>


        <div className="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">

          <div className="flex border-b border-gray-200">
            {STATUS_TABS.map(tab => (
              <button
                key={tab.key}
                onClick={() => setActiveTab(tab.key)}
                className={`flex items-center gap-2 px-5 py-3 font-medium transition-all border-b-2 -mb-[2px] ${
                  activeTab === tab.key
                    ? "border-orange-500 text-orange-600 bg-orange-50/50"
                    : "border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50"
                }`}
              >
                {tab.icon}
                {tab.label}
                <span className={`ml-1 px-2 py-0.5 rounded-full text-xs ${
                  activeTab === tab.key ? "bg-orange-100 text-orange-600" : "bg-gray-100 text-gray-500"
                }`}>
                  {getTabCount(tab.key)}
                </span>
              </button>
            ))}
          </div>


          <div className="p-4 flex items-center gap-4">
            <div className="flex items-center gap-2 text-gray-500">
              <Filter size={18} />
              <span className="text-sm font-medium">–§–∏–ª—å—Ç—Ä—ã:</span>
            </div>

            <select
              value={boardType}
              onChange={e => setBoardType(e.target.value as BoardType | "")}
              className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
            >
              <option value="">–í—Å–µ —Ç–∏–ø—ã –ø–ª–∞—Ç</option>
              <option value="FC">–ü–æ–ª—ë—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (FC)</option>
              <option value="ELRS_915">ELRS 915 –ú–ì—Ü</option>
              <option value="ELRS_2_4">ELRS 2.4 –ì–ì—Ü</option>
              <option value="CORAL_B">Coral B</option>
              <option value="SMARAGD">–°–º–∞—Ä–∞–≥–¥</option>
            </select>

            <div className="flex-1 relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
              <input
                type="text"
                placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–∏–π–Ω–∏–∫—É..."
                value={searchInput}
                onChange={e => setSearchInput(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
              />
            </div>

            <button
              onClick={loadDefects}
              className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-all"
              title="–û–±–Ω–æ–≤–∏—Ç—å"
            >
              <RefreshCw size={18} className={loading ? "animate-spin" : ""} />
            </button>
          </div>
        </div>


        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          {loading && defects.length === 0 ? (
            <div className="p-12 text-center text-gray-500">
              <RefreshCw className="animate-spin mx-auto mb-4" size={32} />
              <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
          ) : defects.length === 0 ? (
            <div className="p-12 text-center text-gray-500">
              <AlertTriangle className="mx-auto mb-4 text-gray-300" size={48} />
              <p className="text-lg font-medium">–î–µ—Ñ–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
              <p className="text-sm mt-1">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</p>
            </div>
          ) : (
            <table className="w-full">
              <thead className="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">#</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ü–ª–∞—Ç–∞</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–°–µ—Ä–∏–π–Ω–∏–∫</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–î–µ—Ñ–µ–∫—Ç</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–û–±–Ω–∞—Ä—É–∂–∏–ª</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–î–∞—Ç–∞</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–í—Ä–µ–º—è</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {defects.map(defect => (
                  <tr
                    key={defect.id}
                    onClick={() => openDefect(defect.id)}
                    className="hover:bg-orange-50/50 cursor-pointer transition-all"
                  >
                    <td className="px-4 py-3 text-sm font-mono text-gray-500">
                      #{defect.id}
                    </td>
                    <td className="px-4 py-3">
                      <span className="px-2 py-1 bg-gray-100 rounded text-sm font-medium">
                        {BOARD_TYPE_SHORT[defect.boardType]}
                      </span>
                    </td>
                    <td className="px-4 py-3 font-mono text-sm">
                      {defect.serialNumber || <span className="text-gray-400">‚Äî</span>}
                    </td>
                    <td className="px-4 py-3">
                      <div className="flex items-center gap-2">
                        {defect.category && (
                          <>
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                              SEVERITY_COLORS[defect.category.severity]
                            }`}>
                              {defect.category.severity === "CRITICAL" ? "!" :
                               defect.category.severity === "MAJOR" ? "‚Ä¢" : "‚óã"}
                            </span>
                            <span className="text-sm">{defect.category.title}</span>
                          </>
                        )}
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <span className={`px-2 py-1 rounded text-xs font-medium ${
                        DEFECT_STATUS_COLORS[defect.status]
                      }`}>
                        {DEFECT_STATUS_LABELS[defect.status]}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600">
                      {defect.detectedBy
                        ? `${defect.detectedBy.surname} ${defect.detectedBy.name?.charAt(0)}.`
                        : "‚Äî"
                      }
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-500">
                      {formatDate(defect.detectedAt)}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-500">
                      {defect.totalRepairMinutes > 0
                        ? `${defect.totalRepairMinutes} –º–∏–Ω`
                        : "‚Äî"
                      }
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}


          {totalPages > 1 && (
            <div className="px-4 py-3 border-t border-gray-200 flex items-center justify-between">
              <span className="text-sm text-gray-500">
                –ü–æ–∫–∞–∑–∞–Ω–æ {defects.length} –∏–∑ {total}
              </span>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setPage(p => Math.max(1, p - 1))}
                  disabled={page === 1}
                  className="p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <ChevronLeft size={18} />
                </button>
                <span className="text-sm font-medium">
                  {page} / {totalPages}
                </span>
                <button
                  onClick={() => setPage(p => Math.min(totalPages, p + 1))}
                  disabled={page === totalPages}
                  className="p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <ChevronRight size={18} />
                </button>
              </div>
            </div>
          )}
        </div>
      </div>


      {showCreateModal && (
        <CreateDefectModal
          onClose={() => setShowCreateModal(false)}
          onCreated={handleCreated}
        />
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Defects/components/AddRepairActionModal.tsx
================================================================================

import React, { useState } from "react";
import { X, Wrench } from "lucide-react";
import { addRepairAction } from "src/api/defectApi";
import {
  ActionType,
  ActionResult,
  BoardType,
  ACTION_TYPE_LABELS,
  ACTION_TYPE_ICONS,
  ACTION_RESULT_LABELS
} from "src/types/DefectTypes";

interface Props {
  defectId: number;
  boardType: BoardType;
  onClose: () => void;
  onAdded: () => void;
}


const getActionTypes = (boardType: BoardType): ActionType[] => {
  const common: ActionType[] = ["DIAGNOSIS", "SOLDER", "REPLACE", "FLASH", "TEST", "CLEAN", "OTHER"];

  if (boardType === "SMARAGD") {
    return ["DIAGNOSIS", "SOLDER", "REPLACE", "FLASH", "TEST", "CLEAN", "CLONE_DISK", "CABLE_REPLACE", "OTHER"];
  }

  return common;
};

export const AddRepairActionModal: React.FC<Props> = ({
  defectId,
  boardType,
  onClose,
  onAdded
}) => {
  const [actionType, setActionType] = useState<ActionType | "">("");
  const [description, setDescription] = useState("");
  const [timeSpent, setTimeSpent] = useState("");
  const [result, setResult] = useState<ActionResult>("PENDING");

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const availableActionTypes = getActionTypes(boardType);

  const handleSubmit = async () => {
    if (!actionType) {
      setError("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è");
      return;
    }
    if (!description.trim()) {
      setError("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ");
      return;
    }

    setLoading(true);
    setError("");

    try {
      await addRepairAction(defectId, {
        actionType,
        description: description.trim(),
        timeSpentMinutes: timeSpent ? Number(timeSpent) : undefined,
        result
      });

      onAdded();
    } catch (e: any) {
      setError(e.response?.data?.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

        <div className="bg-blue-500 text-white px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Wrench size={24} />
            <h2 className="text-lg font-bold">–î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</h2>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-white/20 rounded-lg transition-all"
          >
            <X size={20} />
          </button>
        </div>


        <div className="p-6">

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              –ß—Ç–æ –¥–µ–ª–∞–ª–∏ *
            </label>
            <div className="grid grid-cols-3 gap-2">
              {availableActionTypes.map(type => (
                <button
                  key={type}
                  onClick={() => setActionType(type)}
                  className={`p-3 border-2 rounded-xl text-center transition-all ${
                    actionType === type
                      ? "border-blue-500 bg-blue-50"
                      : "border-gray-200 hover:border-gray-300"
                  }`}
                >
                  <span className="text-2xl block mb-1">{ACTION_TYPE_ICONS[type]}</span>
                  <span className="text-xs font-medium">{ACTION_TYPE_LABELS[type]}</span>
                </button>
              ))}
            </div>
          </div>


          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              –û–ø–∏—Å–∞–Ω–∏–µ *
            </label>
            <textarea
              value={description}
              onChange={e => setDescription(e.target.value)}
              rows={3}
              placeholder="–ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Å–¥–µ–ª–∞–ª–∏..."
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
            />
          </div>


          <div className="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                –í—Ä–µ–º—è (–º–∏–Ω—É—Ç)
              </label>
              <input
                type="number"
                value={timeSpent}
                onChange={e => setTimeSpent(e.target.value)}
                placeholder="0"
                min="0"
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                –†–µ–∑—É–ª—å—Ç–∞—Ç
              </label>
              <select
                value={result}
                onChange={e => setResult(e.target.value as ActionResult)}
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"
              >
                <option value="PENDING">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                <option value="SUCCESS">–£—Å–ø–µ—à–Ω–æ</option>
                <option value="PARTIAL">–ß–∞—Å—Ç–∏—á–Ω–æ</option>
                <option value="FAILED">–ù–µ—É–¥–∞—á–∞</option>
              </select>
            </div>
          </div>

          {error && (
            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm">
              {error}
            </div>
          )}

          <div className="flex gap-3">
            <button
              onClick={onClose}
              className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-all"
            >
              –û—Ç–º–µ–Ω–∞
            </button>
            <button
              onClick={handleSubmit}
              disabled={loading || !actionType || !description.trim()}
              className="flex-1 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-xl font-semibold transition-all"
            >
              {loading ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Defects/components/CreateDefectModal.tsx
================================================================================

import React, { useState, useEffect } from "react";
import { X, AlertTriangle, ChevronRight } from "lucide-react";
import { fetchDefectCategories, createDefect } from "src/api/defectApi";
import {
  DefectCategory,
  BoardType,
  BOARD_TYPE_LABELS
} from "src/types/DefectTypes";

interface Props {
  onClose: () => void;
  onCreated: () => void;

  initialBoardType?: BoardType;
  initialSerialNumber?: string;
  initialBoardId?: number;
}

export const CreateDefectModal: React.FC<Props> = ({
  onClose,
  onCreated,
  initialBoardType,
  initialSerialNumber,
  initialBoardId
}) => {

  const [step, setStep] = useState(initialBoardType ? 2 : 1);


  const [boardType, setBoardType] = useState<BoardType | "">(initialBoardType || "");
  const [serialNumber, setSerialNumber] = useState(initialSerialNumber || "");
  const [noSerial, setNoSerial] = useState(false);
  const [categoryId, setCategoryId] = useState<number | "">("");
  const [description, setDescription] = useState("");


  const [categories, setCategories] = useState<DefectCategory[]>([]);
  const [loadingCategories, setLoadingCategories] = useState(false);


  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");


  useEffect(() => {
    if (boardType) {
      setLoadingCategories(true);
      fetchDefectCategories(boardType, true)
        .then(setCategories)
        .catch(e => console.error(e))
        .finally(() => setLoadingCategories(false));
    }
  }, [boardType]);


  const goToStep2 = () => {
    if (!boardType) {
      setError("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–ª–∞—Ç—ã");
      return;
    }
    setError("");
    setStep(2);
  };


  const handleSubmit = async () => {
    if (!categoryId) {
      setError("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–µ—Ñ–µ–∫—Ç–∞");
      return;
    }

    setLoading(true);
    setError("");

    try {
      await createDefect({
        boardType: boardType as BoardType,
        boardId: initialBoardId || null,
        serialNumber: noSerial ? null : (serialNumber || null),
        categoryId: categoryId as number,
        description: description || undefined
      });

      onCreated();
    } catch (e: any) {
      setError(e.response?.data?.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏");
    } finally {
      setLoading(false);
    }
  };


  const criticalCategories = categories.filter(c => c.severity === "CRITICAL");
  const majorCategories = categories.filter(c => c.severity === "MAJOR");
  const minorCategories = categories.filter(c => c.severity === "MINOR");

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

        <div className="bg-orange-500 text-white px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <AlertTriangle size={24} />
            <div>
              <h2 className="text-lg font-bold">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±—Ä–∞–∫–∞</h2>
              <p className="text-orange-100 text-sm">–®–∞–≥ {step} –∏–∑ 2</p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-white/20 rounded-lg transition-all"
          >
            <X size={20} />
          </button>
        </div>


        <div className="p-6">
          {step === 1 ? (

            <>
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  –¢–∏–ø –ø–ª–∞—Ç—ã *
                </label>
                <div className="grid grid-cols-1 gap-2">
                  {(Object.keys(BOARD_TYPE_LABELS) as BoardType[]).map(type => (
                    <button
                      key={type}
                      onClick={() => setBoardType(type)}
                      className={`p-3 border-2 rounded-xl text-left transition-all ${
                        boardType === type
                          ? "border-orange-500 bg-orange-50"
                          : "border-gray-200 hover:border-gray-300"
                      }`}
                    >
                      <span className="font-medium">{BOARD_TYPE_LABELS[type]}</span>
                    </button>
                  ))}
                </div>
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä / QR
                </label>
                <input
                  type="text"
                  value={serialNumber}
                  onChange={e => setSerialNumber(e.target.value)}
                  disabled={noSerial}
                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω–∏–∫..."
                  className={`w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 ${
                    noSerial ? "bg-gray-100 text-gray-400" : ""
                  }`}
                />
                <label className="flex items-center gap-2 mt-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={noSerial}
                    onChange={e => {
                      setNoSerial(e.target.checked);
                      if (e.target.checked) setSerialNumber("");
                    }}
                    className="w-4 h-4 rounded border-gray-300 text-orange-500 focus:ring-orange-500"
                  />
                  <span className="text-sm text-gray-600">–°–µ—Ä–∏–π–Ω–∏–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç / –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è</span>
                </label>
              </div>

              {error && (
                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm">
                  {error}
                </div>
              )}

              <button
                onClick={goToStep2}
                disabled={!boardType}
                className="w-full py-3 bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-xl font-semibold flex items-center justify-center gap-2 transition-all"
              >
                –î–∞–ª–µ–µ
                <ChevronRight size={18} />
              </button>
            </>
          ) : (

            <>

              <div className="mb-4 p-3 bg-gray-50 rounded-xl flex items-center justify-between">
                <div>
                  <span className="text-sm text-gray-500">–ü–ª–∞—Ç–∞:</span>
                  <span className="ml-2 font-medium">{BOARD_TYPE_LABELS[boardType as BoardType]}</span>
                  {serialNumber && (
                    <>
                      <span className="mx-2 text-gray-300">|</span>
                      <span className="font-mono text-sm">{serialNumber}</span>
                    </>
                  )}
                </div>
                <button
                  onClick={() => setStep(1)}
                  className="text-sm text-orange-500 hover:text-orange-600"
                >
                  –ò–∑–º–µ–Ω–∏—Ç—å
                </button>
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  –ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–µ—Ñ–µ–∫—Ç–∞ *
                </label>

                {loadingCategories ? (
                  <div className="p-4 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                ) : (
                  <div className="space-y-3 max-h-60 overflow-y-auto pr-2">

                    {criticalCategories.length > 0 && (
                      <div>
                        <div className="text-xs font-semibold text-red-600 mb-1 flex items-center gap-1">
                          <span className="w-2 h-2 bg-red-500 rounded-full"></span>
                          –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï
                        </div>
                        {criticalCategories.map(cat => (
                          <button
                            key={cat.id}
                            onClick={() => setCategoryId(cat.id)}
                            className={`w-full p-3 mb-1 border-2 rounded-lg text-left transition-all ${
                              categoryId === cat.id
                                ? "border-red-500 bg-red-50"
                                : "border-gray-200 hover:border-gray-300"
                            }`}
                          >
                            <div className="font-medium">{cat.title}</div>
                            {cat.description && (
                              <div className="text-xs text-gray-500 mt-0.5">{cat.description}</div>
                            )}
                          </button>
                        ))}
                      </div>
                    )}


                    {majorCategories.length > 0 && (
                      <div>
                        <div className="text-xs font-semibold text-yellow-600 mb-1 flex items-center gap-1">
                          <span className="w-2 h-2 bg-yellow-500 rounded-full"></span>
                          –°–ï–†–¨–Å–ó–ù–´–ï
                        </div>
                        {majorCategories.map(cat => (
                          <button
                            key={cat.id}
                            onClick={() => setCategoryId(cat.id)}
                            className={`w-full p-3 mb-1 border-2 rounded-lg text-left transition-all ${
                              categoryId === cat.id
                                ? "border-yellow-500 bg-yellow-50"
                                : "border-gray-200 hover:border-gray-300"
                            }`}
                          >
                            <div className="font-medium">{cat.title}</div>
                            {cat.description && (
                              <div className="text-xs text-gray-500 mt-0.5">{cat.description}</div>
                            )}
                          </button>
                        ))}
                      </div>
                    )}


                    {minorCategories.length > 0 && (
                      <div>
                        <div className="text-xs font-semibold text-gray-500 mb-1 flex items-center gap-1">
                          <span className="w-2 h-2 bg-gray-400 rounded-full"></span>
                          –ù–ï–ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–´–ï
                        </div>
                        {minorCategories.map(cat => (
                          <button
                            key={cat.id}
                            onClick={() => setCategoryId(cat.id)}
                            className={`w-full p-3 mb-1 border-2 rounded-lg text-left transition-all ${
                              categoryId === cat.id
                                ? "border-gray-500 bg-gray-50"
                                : "border-gray-200 hover:border-gray-300"
                            }`}
                          >
                            <div className="font-medium">{cat.title}</div>
                            {cat.description && (
                              <div className="text-xs text-gray-500 mt-0.5">{cat.description}</div>
                            )}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  –û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                </label>
                <textarea
                  value={description}
                  onChange={e => setDescription(e.target.value)}
                  rows={3}
                  placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ..."
                  className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 resize-none"
                />
              </div>

              {error && (
                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm">
                  {error}
                </div>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => setStep(1)}
                  className="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-all"
                >
                  –ù–∞–∑–∞–¥
                </button>
                <button
                  onClick={handleSubmit}
                  disabled={loading || !categoryId}
                  className="flex-1 py-3 bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-xl font-semibold transition-all"
                >
                  {loading ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å"}
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Firmware/Firmware2_4.tsx
================================================================================

import { observer } from "mobx-react-lite";
import plata915_1 from "assets/images/24v1.png";
import plata915_2 from "assets/images/24v2png.png";
import { useContext, useEffect, useRef, useState } from "react";
import { Context } from "src/main";
import { eraseFlash915, getMAC915, uploadFlash2_4 } from "src/api/firmwareApi";
import { PreloaderMini } from "src/components/common/PreloaderMini";
import { DiamondPlus } from "lucide-react";
import { create2_4Board } from "src/api/elrsApi";

export const Firmware2_4: React.FC = observer(() => {
  const context = useContext(Context);
  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { firmware915 } = context;

  const abortControllerRef = useRef(new AbortController());
  const [showIcon, setShowIcon] = useState(false);

  useEffect(() => {
    if (firmware915.counterTotalForSession >= 0) {
      setShowIcon(true);
      const timer = setTimeout(() => setShowIcon(false), 7000);
      return () => clearTimeout(timer);
    }
  }, [firmware915.counterTotalForSession]);

  const abortAllRequests = () => {
    abortControllerRef.current.abort();
    abortControllerRef.current = new AbortController();
    firmware915.resetState();
  };

  const eraseFlashForPort = async (id: number) => {
    try {
      firmware915.setLoading(id, true);
      const currentFlash = await eraseFlash915(
        id,
        abortControllerRef.current.signal
      );
      currentFlash.message
        ? firmware915.setEraseFlashStatus(id, currentFlash.message)
        : (console.log(currentFlash),
          firmware915.setEraseFlashStatus(id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Ç—Å–∫–µ —Ñ–ª—ç—à"));
      firmware915.setLoading(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        console.log(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω`);
      } else {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—á–∏—Å—Ç–∫–µ flash –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`, error);
      }
      firmware915.setLoading(id, false);
    }
  };

  const eraseFlashForAllPort = async () => {
    await Promise.all(
      Array.from({ length: firmware915.countPort }, (_, i) =>
        eraseFlashForPort(i)
      )
    );
  };

  const getMACForPort = async (id: number) => {
    try {
      firmware915.setLoadingMAC(id, true);
      const currentMAC = await getMAC915(id, abortControllerRef.current.signal);
      if (currentMAC.length < 30) firmware915.setMacAddress(id, currentMAC);
      else {
        console.log(currentMAC);
        firmware915.setMacAddress(id, "–û—à–±–∏–∫–∞ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è MAC-–∞–¥—Ä–µ—Å—Å–∞");
      }
      firmware915.setLoadingMAC(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        console.log(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω`);
      } else {
        console.error(
          `–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—á–∏—Ç—ã–≤–∞–Ω–∏–∏ –º–∞–∫-–∞–¥—Ä–µ—Å—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`,
          error
        );
      }
      firmware915.setLoadingMAC(id, false);
    }
  };

  const getMACForAllPorts = async () => {
    await Promise.all(
      Array.from({ length: firmware915.countPort }, (_, i) => getMACForPort(i))
    );
  };

  const flashForPort = async (id: number) => {
    try {
      firmware915.setLoading(id, true);

      const result = await uploadFlash2_4(
        id,
        abortControllerRef.current.signal
      );
      result.message
        ? firmware915.setFlashStatus(id, result.message)
        : (firmware915.setFlashStatus(id, "–û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏"),
          console.log(result));

      firmware915.setLoading(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        const err = `–ü—Ä–æ—à–∏–≤–∫–∞ –Ω–∞ ${id} –æ—Ç–º–µ–Ω–µ–Ω–∞`;
        firmware915.setFlashStatus(id, err);
        console.log(`–ü—Ä–æ—à–∏–≤–∫–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω–∞`);
      } else {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—à–∏–≤–∫–µ –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`, error);
      }
      firmware915.setLoading(id, false);
    }
  };

  const flashForAllPorts = async () => {
    await Promise.all(
      Array.from({ length: firmware915.countPort }, (_, i) => flashForPort(i))
    );
  };

  const addBoardsToBase = async (id: number) => {
    const MAC_address: string = firmware915.macAddress[id];
    const currentFirm: boolean =
      firmware915.flashStatus[id] === "–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏–ª–æ—Å—å";
    const sessionId = Number(localStorage.getItem("sessionID"));
    const categoryDefect915Id = 1;
    if (
      MAC_address !== null &&
      MAC_address.length < 25 &&
      currentFirm === true
    ) {
      try {
        await create2_4Board(
          MAC_address,
          currentFirm,
          sessionId,
          categoryDefect915Id
        );
        firmware915.setCounterTotalForSessionPlus();
        firmware915.setMessageDB(id, "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ");
      } catch (error) {
        firmware915.setMessageDB(id, `–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –±–∞–∑—É ${error}`);
      }
    }
  };

  const addBoardsToBaseALL = async () => {
    for (let i = 0; i <= firmware915.countPort - 1; i++) {
      addBoardsToBase(i);
    }
  };

  const getCardClass = (id: number) => {
    const unique_device_id: string = firmware915._macAddress[id];
    const currentFirm: boolean =
      firmware915.flashStatus[id] === "–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏–ª–æ—Å—å";
    const currentMessageDB: boolean =
      firmware915.messageDB[id] === "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ";

    return unique_device_id &&
      unique_device_id.length < 25 &&
      currentFirm &&
      currentMessageDB
      ? "bg-green-300"
      : "bg-white";
  };

  const getFirmwareClass = (id: number) => {
    let classNameForFirm = "";
    let currentFirm = firmware915.flashStatus[id];

    if (currentFirm === "–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏–ª–æ—Å—å") {
      classNameForFirm = "text-green-600";
    } else if (currentFirm === "–ù–µ –ø—Ä–æ—à–∏—Ç–æ") {
      classNameForFirm = "text-gray-600";
    } else {
      classNameForFirm = "bg-rose-500 animate-pulse";
    }
    return classNameForFirm;
  };

  const getEraseFirmwareClass = (id: number) => {
    let classNameForFirm = "";
    let currentFirm = firmware915.eraseFlashStatus[id];

    if (currentFirm === "Flash –æ—á–∏—â–µ–Ω") {
      classNameForFirm = "bg-green-600";
    } else if (currentFirm === "–ù–µ —Å–±—Ä–æ—à–µ–Ω–æ") {
      classNameForFirm = "bg-stone-200";
    } else {
      classNameForFirm = "bg-rose-500 animate-pulse";
    }
    return classNameForFirm;
  };

  const getAddToBaseClass = (id: number) => {
    let classNameForMessageDB = "";
    let currentMessageDB = firmware915.messageDB[id];
    console.log(currentMessageDB);

    if (currentMessageDB === "–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ") {
      classNameForMessageDB = "text-gray-600";
    } else if (currentMessageDB === "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ") {
      classNameForMessageDB = "text-green-600";
    } else {
      classNameForMessageDB = "bg-rose-500 animate-pulse";
    }
    return classNameForMessageDB;
  };

  const getMACAddressClass = (id: number) => {
    let classNameForSerial = "";
    let currentSerial = firmware915._macAddress[id];

    if (!currentSerial) {
      classNameForSerial = "text-gray-600";
    } else if (currentSerial && currentSerial.length < 25) {
      classNameForSerial = "text-green-600";
    } else {
      classNameForSerial = "bg-rose-500 animate-pulse";
    }
    return classNameForSerial;
  };

  return (
    <div className="space-y-4 bg-gray-100/50 min-h-screen">
      <div className="flex items-center justify-between p-6 rounded-xl ">

        <div className="flex items-center space-x-4 bg-white p-4 rounded-lg shadow-sm">
          <span className="text-gray-700 font-medium">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ç–æ–≤</span>
          <div className="flex items-center space-x-2">
            <button
              onClick={() => firmware915.setCountPortMinus()}
              className="w-8 h-8 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center hover:bg-gray-300 transition duration-200"
            >
              -
            </button>
            <span className="text-xl font-bold text-gray-800">
              {firmware915.countPort}
            </span>
            <button
              onClick={() => firmware915.setCountPortPlus()}
              className="w-8 h-8 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center hover:bg-gray-300 transition duration-200"
            >
              +
            </button>
          </div>
        </div>


        <h2 className="w-3/5 text-3xl font-bold text-gray-800">
          –ü—Ä–æ—à–∏–≤–∫–∞ –ø—Ä–∏–µ–º–Ω–∏–∫–∞ 2.4
        </h2>
      </div>

      <div className="flex justify-around">

        <div className="flex justify-center items-center gap-6">
          <img
            src={plata915_1}
            className="w-28 h-auto rounded-lg shadow-md"
            alt="–∫–∞—Ä—Ç–∏–Ω–∫–∞"
          />
          <img
            src={plata915_2}
            className="w-28 h-auto rounded-lg shadow-md"
            alt="–∫–∞—Ä—Ç–∏–Ω–∫–∞"
          />
        </div>

        <div className="flex flex-col items-center space-y-4">

          <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-blue-600 transition"
            onClick={eraseFlashForAllPort}
          >
            –û—á–∏—Å—Ç–∏—Ç—å Flash
          </button>


          <div className="flex flex-wrap justify-center gap-2">
            {Array.from({ length: firmware915.countPort }, (_, i) => i).map(
              (number) => (
                <button
                  key={number}
                  onClick={() => eraseFlashForPort(number)}
                  className={`w-12 h-12  font-bold rounded-lg shadow-md ${getEraseFirmwareClass(
                    number
                  )} hover:bg-gray-300 transition flex items-center justify-center`}
                >
                  {number + 1}
                  {firmware915.loading[number] && <PreloaderMini />}
                </button>
              )
            )}
          </div>
        </div>

        <div className="grid grid-cols-2 w-max gap-2 mt-8">
          <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-blue-600 transition "
            onClick={getMACForAllPorts}
          >
            üîç –°—á–∏—Ç–∞—Ç—å
          </button>

          <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-green-500 transition duration-300"
            onClick={flashForAllPorts}
          >
            ‚ö° –ü—Ä–æ—à–∏—Ç—å
          </button>

          <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-indigo-700 transition duration-300"
            onClick={addBoardsToBaseALL}
          >
            üì• –ó–∞–ø–∏—Å–∞—Ç—å
          </button>

          <button
            className="bg-red-700 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-rose-600 transition duration-300"
            onClick={abortAllRequests}
          >
            üîÑ –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞
          </button>
        </div>
      </div>

      <div className="grid grid-cols-6 gap-4">
        {Array.from({ length: firmware915.countPort }, (_, i) => i).map(
          (id) => (
            <div
              key={id}
              className={`border p-4 rounded-lg shadow-md ${getCardClass(id)}`}
            >
              <h3 className="text-md font-semibold text-center">
                –ü–æ—Ä—Ç {id + 1}
              </h3>
              <div className="flex">
                <button
                  className=" bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-blue-700 transition duration-200"
                  onClick={() => getMACForPort(id)}
                >
                  üîç
                </button>

                <p className="text-sm ml-2 text-center">–ú–∞–∫-–∞–¥—Ä–µ—Å:</p>
              </div>

              <p
                className={`break-words text-xl   font-medium ${getMACAddressClass(
                  id
                )}`}
              >
                {firmware915.macAddress[id] || "–º–∞–∫-–∞–¥—Ä–µ—Å—Å"}
                {firmware915.loadingMAC[id] && <PreloaderMini />}
              </p>

              <div className="flex mt-3">
                <button
                  className="bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-red-700 transition duration-200 mt-2"
                  onClick={() => flashForPort(id)}
                >
                  ‚ö°
                </button>

                <p className="text-sm mt-2 ml-2 text-center">
                  –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏
                </p>
              </div>

              <p className={` text-xl font-medium ${getFirmwareClass(id)}`}>
                <p className={` text-xl font-medium ${getFirmwareClass(id)}`}>
                  {firmware915.flashStatus[id]}
                  {firmware915.loading[id] && <PreloaderMini />}
                </p>
              </p>

              <div className="flex mt-3">
                <button
                  className="bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-blue-700 transition duration-200"
                  onClick={() => addBoardsToBase(id)}
                >
                  üì•
                </button>
                <p className="text-sm mt-2 ml-2 text-center">
                  –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É
                </p>
              </div>
              <p className={`text-xl  font-medium ${getAddToBaseClass(id)}`}>
                {firmware915.messageDB[id]}
              </p>
            </div>
          )
        )}
      </div>

      <div className="p-4 bg-gray-100 rounded-lg shadow-md">
        <div className="flex  mr-20 items-center text-lg font-semibold text-gray-800">
          <div className="w-2/3"></div>

          <div className="w-1/3  ml-20 ">
            <div className="flex">
              –í—Å–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É –∑–∞ —Ç–µ–∫—É—â–∏–π —Å–µ–∞–Ω—Å:
              <span className="ml-2  text-blue-600">
                {firmware915.counterTotalForSession}
              </span>
              {showIcon && (
                <span className="ml-2 text-green-600 animate-pulse">
                  <DiamondPlus size={32} />
                </span>
              )}
            </div>
            <button
              className="bg-red-600 text-white py-2 px-2 rounded-2xl shadow-xl hover:bg-rose-400 transition duration-300"
              onClick={() => firmware915.resetCounterTotalForSession()}
            >
              –û–±–Ω—É–ª–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
            </button>
          </div>
        </div>

        <div className="mt-5 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-md">
          ‚ö†Ô∏è <span className="font-medium">–í–ù–ò–ú–ê–ù–ò–ï:</span> –≤ –±–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
          —Ç–æ–ª—å–∫–æ –ø–ª–∞—Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–π —Å—á–∏—Ç–∞–ª—Å—è –ú–∞–∫-–∞–¥—Ä–µ—Å –∏ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
          –ø—Ä–æ—à–∏–≤–∫–∞.
          <br></br>
          –ü–µ—Ä–µ–≤–æ–¥ –≤ —Ä–µ–∂–∏–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –º–∏–≥–∞–Ω–∏—è —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞
          –Ω–∞ –ø–ª–∞—Ç–µ.
          <br></br>
          –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–æ—à–∏–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å.
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Firmware/Firmware915_002.tsx
================================================================================

import { observer } from "mobx-react-lite";
import plata915_1 from "assets/images/radiomaster-bandit-br3-expresslrs-915mhz-03.png";
import plata915_2 from "assets/images/radiomaster-bandit-br3-expresslrs-915mhz-05.png";
import { useContext, useEffect, useRef, useState } from "react";
import { Context } from "src/main";
import {
  eraseFlash915,
  getMAC915,
  transferToMode915,
  uploadFlash915_002,
} from "src/api/firmwareApi";
import { PreloaderMini } from "src/components/common/PreloaderMini";
import { DiamondPlus } from "lucide-react";
import { create915Board } from "src/api/elrsApi";

export const Firmware915_002: React.FC = observer(() => {
  const context = useContext(Context);
  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { firmware915 } = context;

  const abortControllerRef = useRef(new AbortController());
  const [showIcon, setShowIcon] = useState(false);

  useEffect(() => {
    if (firmware915.counterTotalForSession >= 0) {
      setShowIcon(true);
      const timer = setTimeout(() => setShowIcon(false), 7000);
      return () => clearTimeout(timer);
    }
  }, [firmware915.counterTotalForSession]);

  const abortAllRequests = () => {
    abortControllerRef.current.abort();
    abortControllerRef.current = new AbortController();
    firmware915.resetState();
  };

  const eraseFlashForPort = async (id: number) => {
    try {
      firmware915.setLoading(id, true);
      const currentFlash = await eraseFlash915(
        id,
        abortControllerRef.current.signal
      );
      currentFlash.message
        ? firmware915.setEraseFlashStatus(id, currentFlash.message)
        : (console.log(currentFlash),
          firmware915.setEraseFlashStatus(id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Ç—Å–∫–µ —Ñ–ª—ç—à"));
      firmware915.setLoading(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        console.log(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω`);
      } else {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—á–∏—Å—Ç–∫–µ flash –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`, error);
      }
      firmware915.setLoading(id, false);
    }
  };

  const eraseFlashForAllPort = async () => {
    await Promise.all(
      Array.from({ length: firmware915.countPort }, (_, i) =>
        eraseFlashForPort(i)
      )
    );
  };

  const getMACForPort = async (id: number) => {
    try {
      firmware915.setLoadingMAC(id, true);
      const currentMAC = await getMAC915(id, abortControllerRef.current.signal);
      if (currentMAC.length < 30) firmware915.setMacAddress(id, currentMAC);
      else {
        console.log(currentMAC);
        firmware915.setMacAddress(id, "–û—à–±–∏–∫–∞ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è MAC-–∞–¥—Ä–µ—Å—Å–∞");
      }
      firmware915.setLoadingMAC(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        console.log(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω`);
      } else {
        console.error(
          `–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—á–∏—Ç—ã–≤–∞–Ω–∏–∏ –º–∞–∫-–∞–¥—Ä–µ—Å—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`,
          error
        );
      }
      firmware915.setLoadingMAC(id, false);
    }
  };

  const getMACForAllPorts = async () => {
    await Promise.all(
      Array.from({ length: firmware915.countPort }, (_, i) => getMACForPort(i))
    );
  };

  const flashForPort = async (id: number) => {
    try {
      firmware915.setLoading(id, true);

      const result = await uploadFlash915_002(
        id,
        abortControllerRef.current.signal
      );
      result.message
        ? firmware915.setFlashStatus(id, result.message)
        : (firmware915.setFlashStatus(id, "–û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏"),
          console.log(result));

      firmware915.setLoading(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        const err = `–ü—Ä–æ—à–∏–≤–∫–∞ –Ω–∞ ${id} –æ—Ç–º–µ–Ω–µ–Ω–∞`;
        firmware915.setFlashStatus(id, err);
        console.log(`–ü—Ä–æ—à–∏–≤–∫–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω–∞`);
      } else {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—à–∏–≤–∫–µ –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`, error);
      }
      firmware915.setLoading(id, false);
    }
  };

  const flashForAllPorts = async () => {
    await Promise.all(
      Array.from({ length: firmware915.countPort }, (_, i) => flashForPort(i))
    );
  };

  const transferToModeForAllPort = async () => {
    try {
      const data = await transferToMode915(abortControllerRef.current.signal);
      console.log(data);
    } catch (error: any) {
      if (error.name === "AbortError") {
        console.log(`–ü–µ—Ä–µ–≤–æ–¥ –≤ —Ä–µ–∂–∏–º –æ—Ç–º–µ–Ω–µ–Ω`);
      } else {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –≤ —Ä–µ–∂–∏–º`, error);
      }
    }
  };

  const addBoardsToBase = async (id: number) => {
    const MAC_address: string = firmware915.macAddress[id];
    const currentFirm: boolean =
      firmware915.flashStatus[id] === "–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏–ª–æ—Å—å";
    const sessionId = Number(localStorage.getItem("sessionID"));
    const categoryDefect915Id = 1;
    if (
      MAC_address !== null &&
      MAC_address.length < 25 &&
      currentFirm === true
    ) {
      try {
        await create915Board(
          MAC_address,
          currentFirm,
          sessionId,
          categoryDefect915Id,
          "002"
        );
        firmware915.setCounterTotalForSessionPlus();
        firmware915.setMessageDB(id, "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ");
      } catch (error) {
        firmware915.setMessageDB(id, `–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –±–∞–∑—É ${error}`);
      }
    }
  };

  const addBoardsToBaseALL = async () => {
    for (let i = 0; i <= firmware915.countPort - 1; i++) {
      addBoardsToBase(i);
    }
  };


  const getCardClass = (id: number) => {
    const unique_device_id: string = firmware915._macAddress[id];
    const currentFirm: boolean =
      firmware915.flashStatus[id] === "–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏–ª–æ—Å—å";
    const currentMessageDB: boolean =
      firmware915.messageDB[id] === "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ";

    return unique_device_id &&
      unique_device_id.length < 25 &&
      currentFirm &&
      currentMessageDB
      ? "bg-green-300"
      : "bg-white";
  };

  const getFirmwareClass = (id: number) => {
    let classNameForFirm = "";
    let currentFirm = firmware915.flashStatus[id];

    if (currentFirm === "–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏–ª–æ—Å—å") {
      classNameForFirm = "text-green-600";
    } else if (currentFirm === "–ù–µ –ø—Ä–æ—à–∏—Ç–æ") {
      classNameForFirm = "text-gray-600";
    } else {
      classNameForFirm = "bg-rose-500 animate-pulse";
    }
    return classNameForFirm;
  };

  const getEraseFirmwareClass = (id: number) => {
    let classNameForFirm = "";
    let currentFirm = firmware915.eraseFlashStatus[id];

    if (currentFirm === "Flash –æ—á–∏—â–µ–Ω") {
      classNameForFirm = "bg-green-600";
    } else if (currentFirm === "–ù–µ —Å–±—Ä–æ—à–µ–Ω–æ") {
      classNameForFirm = "bg-stone-200";
    } else {
      classNameForFirm = "bg-rose-500 animate-pulse";
    }
    return classNameForFirm;
  };

  const getAddToBaseClass = (id: number) => {
    let classNameForMessageDB = "";
    let currentMessageDB = firmware915.messageDB[id];
    console.log(currentMessageDB);

    if (currentMessageDB === "–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ") {
      classNameForMessageDB = "text-gray-600";
    } else if (currentMessageDB === "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ") {
      classNameForMessageDB = "text-green-600";
    } else {
      classNameForMessageDB = "bg-rose-500 animate-pulse";
    }
    return classNameForMessageDB;
  };

  const getMACAddressClass = (id: number) => {
    let classNameForSerial = "";
    let currentSerial = firmware915._macAddress[id];

    if (!currentSerial) {
      classNameForSerial = "text-gray-600";
    } else if (currentSerial && currentSerial.length < 25) {
      classNameForSerial = "text-green-600";
    } else {
      classNameForSerial = "bg-rose-500 animate-pulse";
    }
    return classNameForSerial;
  };

  return (
    <div className="space-y-4 bg-gray-100/50 min-h-screen">
      <div className="flex items-center justify-between p-6 rounded-xl ">

        <div className="flex items-center space-x-4 bg-white p-4 rounded-lg shadow-sm">
          <span className="text-gray-700 font-medium">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ç–æ–≤</span>
          <div className="flex items-center space-x-2">
            <button
              onClick={() => firmware915.setCountPortMinus()}
              className="w-8 h-8 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center hover:bg-gray-300 transition duration-200"
            >
              -
            </button>
            <span className="text-xl font-bold text-gray-800">
              {firmware915.countPort}
            </span>
            <button
              onClick={() => firmware915.setCountPortPlus()}
              className="w-8 h-8 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center hover:bg-gray-300 transition duration-200"
            >
              +
            </button>
          </div>
        </div>


        <h2 className="w-3/5 text-3xl font-bold text-gray-800">
          –ü—Ä–æ—à–∏–≤–∫–∞ –ø—Ä–∏–µ–º–Ω–∏–∫–∞ 915 (002, —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º –≤ —Ä–µ–∂–∏–º)
        </h2>

      </div>

      <div className="flex justify-around">

        <div className="flex justify-center items-center gap-6">
          <img
            src={plata915_1}
            className="w-28 h-auto rounded-lg shadow-md"
            alt="–∫–∞—Ä—Ç–∏–Ω–∫–∞"
          />
          <img
            src={plata915_2}
            className="w-28 h-auto rounded-lg shadow-md"
            alt="–∫–∞—Ä—Ç–∏–Ω–∫–∞"
          />
        </div>

        <div className="flex flex-col items-center space-y-4">

          <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-blue-600 transition"
            onClick={eraseFlashForAllPort}
          >
            –û—á–∏—Å—Ç–∏—Ç—å Flash
          </button>


          <div className="flex flex-wrap justify-center gap-2">
            {Array.from({ length: firmware915.countPort }, (_, i) => i).map(
              (number) => (
                <button
                  key={number}
                  onClick={() => eraseFlashForPort(number)}
                  className={`w-12 h-12  font-bold rounded-lg shadow-md ${getEraseFirmwareClass(
                    number
                  )} hover:bg-gray-300 transition flex items-center justify-center`}
                >
                  {number+1}
                  {firmware915.loading[number] && <PreloaderMini />}
                </button>
              )
            )}
          </div>
        </div>

        <div className="grid grid-cols-2 w-max gap-2 mt-8">
          <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-blue-600 transition "
            onClick={getMACForAllPorts}
          >
            üîç –°—á–∏—Ç–∞—Ç—å
          </button>


           <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-green-500 transition duration-300"
            onClick={flashForAllPorts}
          >
            ‚ö° –ü—Ä–æ—à–∏—Ç—å
          </button>


           <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-indigo-700 transition duration-300"
            onClick={() => transferToModeForAllPort()}
          >
            üõ†Ô∏è –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ —Ä–µ–∂–∏–º
          </button>

          <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-indigo-700 transition duration-300"
            onClick={addBoardsToBaseALL}
          >
            üì• –ó–∞–ø–∏—Å–∞—Ç—å
          </button>

          <button
            className="bg-red-700 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-rose-600 transition duration-300"
            onClick={abortAllRequests}
          >
            üîÑ –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞
          </button>
        </div>
      </div>

      <div className="grid grid-cols-6 gap-4">
        {Array.from({ length: firmware915.countPort }, (_, i) => i).map(
          (id) => (
            <div
              key={id}
              className={`border p-4 rounded-lg shadow-md ${getCardClass(id)}`}
            >
              <h3 className="text-md font-semibold text-center">–ü–æ—Ä—Ç {id+1}</h3>
              <div className="flex">
                <button
                  className=" bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-blue-700 transition duration-200"
                  onClick={() => getMACForPort(id)}
                >
                  üîç
                </button>

                <p className="text-sm ml-2 text-center">–ú–∞–∫-–∞–¥—Ä–µ—Å:</p>
              </div>

              <p
                className={`break-words text-xl   font-medium ${getMACAddressClass(
                  id
                )}`}
              >
                {firmware915.macAddress[id] || "–º–∞–∫-–∞–¥—Ä–µ—Å—Å"}
                {firmware915.loadingMAC[id] && <PreloaderMini />}
              </p>

              <div className="flex mt-3">
                <button
                  className="bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-red-700 transition duration-200 mt-2"
                  onClick={() => flashForPort(id)}
                >
                  ‚ö°
                </button>

                <p className="text-sm mt-2 ml-2 text-center">
                  –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏
                </p>
              </div>

              <p className={` text-xl font-medium ${getFirmwareClass(id)}`}>
                <p className={` text-xl font-medium ${getFirmwareClass(id)}`}>
                  {firmware915.flashStatus[id]}
                  {firmware915.loading[id] && <PreloaderMini />}
                </p>
              </p>

              <div className="flex mt-3">
                <button
                  className="bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-blue-700 transition duration-200"
                  onClick={() => addBoardsToBase(id)}
                >
                  üì•
                </button>
                <p className="text-sm mt-2 ml-2 text-center">
                  –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É
                </p>
              </div>
              <p className={`text-xl  font-medium ${getAddToBaseClass(id)}`}>
                {firmware915.messageDB[id]}
              </p>
            </div>
          )
        )}
      </div>

      <div className="p-4 bg-gray-100 rounded-lg shadow-md">
        <div className="flex  mr-20 items-center text-lg font-semibold text-gray-800">
          <div className="w-2/3"></div>

          <div className="w-1/3  ml-20 ">
            <div className="flex">
              –í—Å–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É –∑–∞ —Ç–µ–∫—É—â–∏–π —Å–µ–∞–Ω—Å:
              <span className="ml-2  text-blue-600">
                {firmware915.counterTotalForSession}
              </span>
              {showIcon && (
                <span className="ml-2 text-green-600 animate-pulse">
                  <DiamondPlus size={32} />
                </span>
              )}
            </div>
            <button
              className="bg-red-600 text-white py-2 px-2 rounded-2xl shadow-xl hover:bg-rose-400 transition duration-300"
              onClick={() => firmware915.resetCounterTotalForSession()}
            >
              –û–±–Ω—É–ª–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
            </button>
          </div>


        </div>

        <div className="mt-5 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-md">
          ‚ö†Ô∏è <span className="font-medium">–í–ù–ò–ú–ê–ù–ò–ï:</span> –≤ –±–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
          —Ç–æ–ª—å–∫–æ –ø–ª–∞—Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–π —Å—á–∏—Ç–∞–ª—Å—è –ú–∞–∫-–∞–¥—Ä–µ—Å –∏ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
          –ø—Ä–æ—à–∏–≤–∫–∞.
          <br></br>
          –ü–µ—Ä–µ–≤–æ–¥ –≤ —Ä–µ–∂–∏–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –º–∏–≥–∞–Ω–∏—è —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞
          –Ω–∞ –ø–ª–∞—Ç–µ.
          <br></br>
          –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–æ—à–∏–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å.
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Firmware/Firmware915_019.tsx
================================================================================

import { observer } from "mobx-react-lite";
import plata915_1 from "assets/images/radiomaster-bandit-br3-expresslrs-915mhz-03.png";
import plata915_2 from "assets/images/radiomaster-bandit-br3-expresslrs-915mhz-05.png";
import { useContext, useEffect, useRef, useState } from "react";
import { Context } from "src/main";
import {
  eraseFlash915,
  getMAC915,

  uploadFlash915_019,
} from "src/api/firmwareApi";
import { PreloaderMini } from "src/components/common/PreloaderMini";
import { DiamondPlus } from "lucide-react";
import { create915Board } from "src/api/elrsApi";

export const Firmware915_019: React.FC = observer(() => {
  const context = useContext(Context);
  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { firmware915 } = context;

  const abortControllerRef = useRef(new AbortController());
  const [showIcon, setShowIcon] = useState(false);

  useEffect(() => {
    if (firmware915.counterTotalForSession >= 0) {
      setShowIcon(true);
      const timer = setTimeout(() => setShowIcon(false), 7000);
      return () => clearTimeout(timer);
    }
  }, [firmware915.counterTotalForSession]);

  const abortAllRequests = () => {
    abortControllerRef.current.abort();
    abortControllerRef.current = new AbortController();
    firmware915.resetState();
  };

  const eraseFlashForPort = async (id: number) => {
    try {
      firmware915.setLoading(id, true);
      const currentFlash = await eraseFlash915(
        id,
        abortControllerRef.current.signal
      );
      currentFlash.message
        ? firmware915.setEraseFlashStatus(id, currentFlash.message)
        : (console.log(currentFlash),
          firmware915.setEraseFlashStatus(id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Ç—Å–∫–µ —Ñ–ª—ç—à"));
      firmware915.setLoading(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        console.log(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω`);
      } else {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—á–∏—Å—Ç–∫–µ flash –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`, error);
      }
      firmware915.setLoading(id, false);
    }
  };

  const eraseFlashForAllPort = async () => {
    await Promise.all(
      Array.from({ length: firmware915.countPort }, (_, i) =>
        eraseFlashForPort(i)
      )
    );
  };

  const getMACForPort = async (id: number) => {
    try {
      firmware915.setLoadingMAC(id, true);
      const currentMAC = await getMAC915(id, abortControllerRef.current.signal);
      if (currentMAC.length < 30) firmware915.setMacAddress(id, currentMAC);
      else {
        console.log(currentMAC);
        firmware915.setMacAddress(id, "–û—à–±–∏–∫–∞ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è MAC-–∞–¥—Ä–µ—Å—Å–∞");
      }
      firmware915.setLoadingMAC(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        console.log(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω`);
      } else {
        console.error(
          `–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—á–∏—Ç—ã–≤–∞–Ω–∏–∏ –º–∞–∫-–∞–¥—Ä–µ—Å—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`,
          error
        );
      }
      firmware915.setLoadingMAC(id, false);
    }
  };

  const getMACForAllPorts = async () => {
    await Promise.all(
      Array.from({ length: firmware915.countPort }, (_, i) => getMACForPort(i))
    );
  };

  const flashForPort = async (id: number) => {
    try {
      firmware915.setLoading(id, true);

      const result = await uploadFlash915_019(
        id,
        abortControllerRef.current.signal
      );
      result.message
        ? firmware915.setFlashStatus(id, result.message)
        : (firmware915.setFlashStatus(id, "–û—à–∏–±–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏"),
          console.log(result));

      firmware915.setLoading(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        const err = `–ü—Ä–æ—à–∏–≤–∫–∞ –Ω–∞ ${id} –æ—Ç–º–µ–Ω–µ–Ω–∞`;
        firmware915.setFlashStatus(id, err);
        console.log(`–ü—Ä–æ—à–∏–≤–∫–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω–∞`);
      } else {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—à–∏–≤–∫–µ –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`, error);
      }
      firmware915.setLoading(id, false);
    }
  };

  const flashForAllPorts = async () => {
    await Promise.all(
      Array.from({ length: firmware915.countPort }, (_, i) => flashForPort(i))
    );
  };


  const addBoardsToBase = async (id: number) => {
    const MAC_address: string = firmware915.macAddress[id];
    const currentFirm: boolean =
      firmware915.flashStatus[id] === "–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏–ª–æ—Å—å";
    const sessionId = Number(localStorage.getItem("sessionID"));
    const categoryDefect915Id = 1;
    if (
      MAC_address !== null &&
      MAC_address.length < 25 &&
      currentFirm === true
    ) {
      try {
        await create915Board(
          MAC_address,
          currentFirm,
          sessionId,
          categoryDefect915Id,
          "019"
        );
        firmware915.setCounterTotalForSessionPlus();
        firmware915.setMessageDB(id, "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ");
      } catch (error) {
        firmware915.setMessageDB(id, `–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –±–∞–∑—É ${error}`);
      }
    }
  };

  const addBoardsToBaseALL = async () => {
    for (let i = 0; i <= firmware915.countPort - 1; i++) {
      addBoardsToBase(i);
    }
  };


  const flashAndWriteAll = async () => {
    try {

      await flashForAllPorts();


      await addBoardsToBaseALL();

      console.log("–ü—Ä–æ—à–∏–≤–∫–∞ –∏ –∑–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!");
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø—Ä–æ—à–∏–≤–∫–∏ –∏ –∑–∞–ø–∏—Å–∏:", error);
    }
  };


  const getCardClass = (id: number) => {
    const unique_device_id: string = firmware915._macAddress[id];
    const currentFirm: boolean =
      firmware915.flashStatus[id] === "–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏–ª–æ—Å—å";
    const currentMessageDB: boolean =
      firmware915.messageDB[id] === "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ";

    return unique_device_id &&
      unique_device_id.length < 25 &&
      currentFirm &&
      currentMessageDB
      ? "bg-green-300"
      : "bg-white";
  };

  const getFirmwareClass = (id: number) => {
    let classNameForFirm = "";
    let currentFirm = firmware915.flashStatus[id];

    if (currentFirm === "–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–∏–ª–æ—Å—å") {
      classNameForFirm = "text-green-600";
    } else if (currentFirm === "–ù–µ –ø—Ä–æ—à–∏—Ç–æ") {
      classNameForFirm = "text-gray-600";
    } else {
      classNameForFirm = "bg-rose-500 animate-pulse";
    }
    return classNameForFirm;
  };

  const getEraseFirmwareClass = (id: number) => {
    let classNameForFirm = "";
    let currentFirm = firmware915.eraseFlashStatus[id];

    if (currentFirm === "Flash –æ—á–∏—â–µ–Ω") {
      classNameForFirm = "bg-green-600";
    } else if (currentFirm === "–ù–µ —Å–±—Ä–æ—à–µ–Ω–æ") {
      classNameForFirm = "bg-stone-200";
    } else {
      classNameForFirm = "bg-rose-500 animate-pulse";
    }
    return classNameForFirm;
  };

  const getAddToBaseClass = (id: number) => {
    let classNameForMessageDB = "";
    let currentMessageDB = firmware915.messageDB[id];
    console.log(currentMessageDB);

    if (currentMessageDB === "–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ") {
      classNameForMessageDB = "text-gray-600";
    } else if (currentMessageDB === "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ") {
      classNameForMessageDB = "text-green-600";
    } else {
      classNameForMessageDB = "bg-rose-500 animate-pulse";
    }
    return classNameForMessageDB;
  };

  const getMACAddressClass = (id: number) => {
    let classNameForSerial = "";
    let currentSerial = firmware915._macAddress[id];

    if (!currentSerial) {
      classNameForSerial = "text-gray-600";
    } else if (currentSerial && currentSerial.length < 25) {
      classNameForSerial = "text-green-600";
    } else {
      classNameForSerial = "bg-rose-500 animate-pulse";
    }
    return classNameForSerial;
  };

  return (
    <div className="space-y-4 bg-gray-100/50 min-h-screen">
      <div className="flex items-center justify-between p-6 rounded-xl ">

        <div className="flex items-center space-x-4 bg-white p-4 rounded-lg shadow-sm">
          <span className="text-gray-700 font-medium">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ç–æ–≤</span>
          <div className="flex items-center space-x-2">
            <button
              onClick={() => firmware915.setCountPortMinus()}
              className="w-8 h-8 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center hover:bg-gray-300 transition duration-200"
            >
              -
            </button>
            <span className="text-xl font-bold text-gray-800">
              {firmware915.countPort}
            </span>
            <button
              onClick={() => firmware915.setCountPortPlus()}
              className="w-8 h-8 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center hover:bg-gray-300 transition duration-200"
            >
              +
            </button>
          </div>
        </div>


        <h2 className="w-3/5 text-3xl font-bold text-gray-800">
          –ü—Ä–æ—à–∏–≤–∫–∞ –ø—Ä–∏–µ–º–Ω–∏–∫–∞ 915 (019, –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ —Ä–µ–∂–∏–º)
        </h2>

      </div>

      <div className="flex justify-around">

        <div className="flex justify-center items-center gap-6">
          <img
            src={plata915_1}
            className="w-28 h-auto rounded-lg shadow-md"
            alt="–∫–∞—Ä—Ç–∏–Ω–∫–∞"
          />
          <img
            src={plata915_2}
            className="w-28 h-auto rounded-lg shadow-md"
            alt="–∫–∞—Ä—Ç–∏–Ω–∫–∞"
          />
        </div>

        <div className="flex flex-col items-center space-y-4">

          <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-blue-600 transition"
            onClick={eraseFlashForAllPort}
          >
            –û—á–∏—Å—Ç–∏—Ç—å Flash
          </button>


          <div className="flex flex-wrap justify-center gap-2">
            {Array.from({ length: firmware915.countPort }, (_, i) => i).map(
              (number) => (
                <button
                  key={number}
                  onClick={() => eraseFlashForPort(number)}
                  className={`w-12 h-12  font-bold rounded-lg shadow-md ${getEraseFirmwareClass(
                    number
                  )} hover:bg-gray-300 transition flex items-center justify-center`}
                >
                  {number+1}
                  {firmware915.loading[number] && <PreloaderMini />}
                </button>
              )
            )}
          </div>
        </div>

        <div className="grid grid-cols-2 w-max gap-2 mt-8">
          <button
            className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-blue-600 transition "
            onClick={getMACForAllPorts}
          >
            üîç –°—á–∏—Ç–∞—Ç—å
          </button>


          <button
            className="bg-gradient-to-r from-teal-600 to-purple-700 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:from-teal-700 hover:to-purple-800 transition duration-300"
            onClick={flashAndWriteAll}
          >
            ‚ö° –ü—Ä–æ—à–∏—Ç—å + üì• –ó–∞–ø–∏—Å–∞—Ç—å
          </button>


          <button
            className="bg-red-700 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-rose-600 transition duration-300"
            onClick={abortAllRequests}
          >
            üîÑ –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞
          </button>
        </div>
      </div>

      <div className="grid grid-cols-6 gap-4">
        {Array.from({ length: firmware915.countPort }, (_, i) => i).map(
          (id) => (
            <div
              key={id}
              className={`border p-4 rounded-lg shadow-md ${getCardClass(id)}`}
            >
              <h3 className="text-md font-semibold text-center">–ü–æ—Ä—Ç {id+1}</h3>
              <div className="flex">
                <button
                  className=" bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-blue-700 transition duration-200"
                  onClick={() => getMACForPort(id)}
                >
                  üîç
                </button>

                <p className="text-sm ml-2 text-center">–ú–∞–∫-–∞–¥—Ä–µ—Å:</p>
              </div>

              <p
                className={`break-words text-xl   font-medium ${getMACAddressClass(
                  id
                )}`}
              >
                {firmware915.macAddress[id] || "–º–∞–∫-–∞–¥—Ä–µ—Å—Å"}
                {firmware915.loadingMAC[id] && <PreloaderMini />}
              </p>

              <div className="flex mt-3">
                <button
                  className="bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-red-700 transition duration-200 mt-2"
                  onClick={() => flashForPort(id)}
                >
                  ‚ö°
                </button>

                <p className="text-sm mt-2 ml-2 text-center">
                  –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏
                </p>
              </div>

              <p className={` text-xl font-medium ${getFirmwareClass(id)}`}>
                <p className={` text-xl font-medium ${getFirmwareClass(id)}`}>
                  {firmware915.flashStatus[id]}
                  {firmware915.loading[id] && <PreloaderMini />}
                </p>
              </p>

              <div className="flex mt-3">
                <button
                  className="bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-blue-700 transition duration-200"
                  onClick={() => addBoardsToBase(id)}
                >
                  üì•
                </button>
                <p className="text-sm mt-2 ml-2 text-center">
                  –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É
                </p>
              </div>
              <p className={`text-xl  font-medium ${getAddToBaseClass(id)}`}>
                {firmware915.messageDB[id]}
              </p>
            </div>
          )
        )}
      </div>

      <div className="p-4 bg-gray-100 rounded-lg shadow-md">
        <div className="flex  mr-20 items-center text-lg font-semibold text-gray-800">
          <div className="w-2/3"></div>

          <div className="w-1/3  ml-20 ">
            <div className="flex">
              –í—Å–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É –∑–∞ —Ç–µ–∫—É—â–∏–π —Å–µ–∞–Ω—Å:
              <span className="ml-2  text-blue-600">
                {firmware915.counterTotalForSession}
              </span>
              {showIcon && (
                <span className="ml-2 text-green-600 animate-pulse">
                  <DiamondPlus size={32} />
                </span>
              )}
            </div>
            <button
              className="bg-red-600 text-white py-2 px-2 rounded-2xl shadow-xl hover:bg-rose-400 transition duration-300"
              onClick={() => firmware915.resetCounterTotalForSession()}
            >
              –û–±–Ω—É–ª–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
            </button>
          </div>


        </div>

        <div className="mt-5 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-md">
          ‚ö†Ô∏è <span className="font-medium">–í–ù–ò–ú–ê–ù–ò–ï:</span> –≤ –±–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
          —Ç–æ–ª—å–∫–æ –ø–ª–∞—Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–π —Å—á–∏—Ç–∞–ª—Å—è –ú–∞–∫-–∞–¥—Ä–µ—Å –∏ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
          –ø—Ä–æ—à–∏–≤–∫–∞.
          <br></br>
          –ü–µ—Ä–µ–≤–æ–¥ –≤ —Ä–µ–∂–∏–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –º–∏–≥–∞–Ω–∏—è —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞
          –Ω–∞ –ø–ª–∞—Ç–µ.
          <br></br>
          –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–æ—à–∏–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å.
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Firmware/FirmwareCoralB/FIrmwareCoralB.tsx
================================================================================

import React, { useContext, useEffect, useState } from "react";
import { sendCommand, checkConnection, fetchData } from "api/firmwareApi";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import { FirmCoralBPortCard } from "./FirmCoralBPortCard";
import { createCoral_B_Board } from "src/api/coralBApi";
import { startCoralBFirm, stopCoralBFirm } from "src/api/firmwareControlApi";

export const FirmwareCoralB: React.FC = observer(() => {
  const context = useContext(Context);
  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { firmwareCoralB } = context;

  const [isConnected, setIsConnected] = useState(false);
  const [logs, setLogs] = useState("–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...");
  const [loadingCommand, setLoadingCommand] = useState<string | null>(null);

  const handleCommand = async (cmd: string) => {
    setLoadingCommand(cmd);
    try {
      await sendCommand(cmd);
      await updateData();
    } finally {
      setLoadingCommand(null);
    }
  };

  const updateData = async () => {
    try {
      const data = await fetchData();
      setLogs(data.logs || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

      if (data.lastCommand === "RD") {
        firmwareCoralB.setFirmwareVersion(data.logs.trim());
      }
      if (["MODE?", "SAW1", "SAW0"].includes(data.lastCommand)) {
        const saw: boolean = data.logs === "0" ? false : true;

        firmwareCoralB.setSAW_mode(saw);
      }

      firmwareCoralB.resetSerial();


      data.serials?.forEach((serial: string, i: number) => {
        firmwareCoralB.setSerial(i, serial);
      });

      data.result?.forEach((status: string, i: number) => {
        firmwareCoralB.setFlashStatus(
          i,
          status === "OK"
            ? "‚úÖ –£—Å–ø–µ—à–Ω–æ"
            : status === "ERROR"
            ? "‚ùå –û—à–∏–±–∫–∞"
            : "–ù–µ –ø—Ä–æ—à–∏—Ç–æ"
        );
      });

      setIsConnected(true);
    } catch {
      setIsConnected(false);
    }
  };

  const startstop = async (on: boolean) => {
    on ? await startCoralBFirm() : await stopCoralBFirm();
  };

  const addBoardsToBase = async (id: number) => {
    const serial: string = firmwareCoralB.serial[id];
    const currentFirm: boolean =
      firmwareCoralB.flashStatus[id] === "‚úÖ –£—Å–ø–µ—à–Ω–æ";
    const sessionId = Number(localStorage.getItem("sessionID"));
    const categoryDefectCoralBId = 1;
    const SAW_mode = firmwareCoralB.SAW_mode;
    const firmwareVersion = firmwareCoralB.firmwareVersion;
    if (
      serial !== "" &&
      SAW_mode !== null &&
      firmwareVersion !== null


    ) {
      try {
        await createCoral_B_Board(
          serial,
          currentFirm,
          SAW_mode,
          firmwareVersion,
          sessionId,
          categoryDefectCoralBId
        );
        firmwareCoralB.setCounterTotalForSessionPlus();
        firmwareCoralB.setMessageDB(id, "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ");
      } catch (error) {
        firmwareCoralB.setMessageDB(
          id,
          `–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –±–∞–∑—É ${error}`
        );
      }
    }
  };

  const addBoardsToBaseALL = async () => {
    for (let i = 0; i <= firmwareCoralB.countPort - 1; i++) {
      addBoardsToBase(i);
    }
  };

  useEffect(() => {
    checkConnection()
      .then(() => setIsConnected(true))
      .catch(() => setIsConnected(false));

    updateData();
    const interval = setInterval(updateData, 2000);
    return () => clearInterval(interval);
  }, []);

  console.log(firmwareCoralB);

  return (
    <div className="max-w-screen-xl mx-auto p-4 space-y-6">
      <h1 className="text-3xl font-bold text-gray-800">
        –ü—Ä–æ—à–∏–≤–∫–∞ –ø–ª–∞—Ç Coral B
      </h1>


      <div className="fixed top-20 right-6 z-50 w-72">
        <div
          className={`rounded-2xl px-5 py-4 shadow-xl border text-sm transition-all duration-300 ${
            isConnected
              ? "bg-green-50 border-green-300 text-green-800"
              : "bg-red-50 border-red-300 text-red-800"
          }`}
        >
          {isConnected ? (
            <div className="space-y-3">
              <div className="flex items-center gap-2 font-semibold text-base">
                <span className="text-xl">üü¢</span>
                <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
              </div>
              <div className="text-xs text-gray-700 space-y-1">
                <p>
                  <span className="font-semibold">–í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏:</span>{" "}
                  {firmwareCoralB.firmwareVersion || "‚Äî"}
                </p>
                <p>
                  <span className="font-semibold">–†–µ–∂–∏–º –ü–ê–í:</span>{" "}
                  {firmwareCoralB.SAW_mode === null
                    ? "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                    : firmwareCoralB.SAW_mode
                    ? "—Å –ü–ê–í"
                    : "–±–µ–∑ –ü–ê–í"}
                </p>
              </div>
              <button
                onClick={() => startstop(false)}
                className="w-full mt-1 bg-red-100 text-red-800 hover:bg-red-200 font-medium py-1.5 px-3 rounded-xl text-xs transition"
              >
                ‚õî –û—Ç–∫–ª—é—á–∏—Ç—å
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              <div className="flex items-center gap-2 font-semibold text-base">
                <span className="text-xl">üî¥</span>
                <span>–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>
              </div>
              <button
                onClick={() => startstop(true)}
                className="w-full bg-green-100 text-green-800 hover:bg-green-200 font-medium py-1.5 px-3 rounded-xl text-xs transition"
              >
                üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
              </button>
            </div>
          )}
        </div>
      </div>


      <div className="bg-white p-6 rounded-2xl shadow space-y-4">
        <h2 className="text-2xl font-semibold text-gray-800">
          –ö–æ–º–∞–Ω–¥—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        </h2>

        <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <button
            onClick={() => handleCommand("RD")}
            className="bg-indigo-600 text-white text-sm font-bold py-3 px-6 rounded-xl shadow hover:bg-indigo-700 transition"
          >
            üìÑ –í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏ (RD)
          </button>

          <button
            onClick={() => handleCommand("MODE?")}
            className="bg-gray-600 text-white text-sm font-bold py-3 px-6 rounded-xl shadow hover:bg-gray-700 transition"
          >
            üß≠ –£–∑–Ω–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º (MODE?)
          </button>

          <button
            onClick={() => handleCommand("SAW1")}
            className="bg-gray-600 text-white text-sm font-bold py-3 px-6 rounded-xl shadow hover:bg-gray-700 transition"
          >
            üß™ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º —Å –ü–ê–í (SAW1)
          </button>

          <button
            onClick={() => handleCommand("SAW0")}
            className="bg-gray-600 text-white text-sm font-bold py-3 px-6 rounded-xl shadow hover:bg-gray-700 transition"
          >
            üö´ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º –±–µ–∑ –ü–ê–í (SAW0)
          </button>

          <button
            onClick={() => handleCommand("INF0")}
            className="bg-gradient-to-r from-teal-800 to-yellow-600 text-white text-sm font-bold py-3 px-6 rounded-xl shadow hover:from-teal-700 hover:to-yellow-700 transition"
          >
            üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—à–∏–≤–∫—É (INF0)
          </button>
        </div>


        <div className="pt-6 space-y-4">
          <button
            onClick={() => handleCommand("FLH0")}
            className="w-full bg-gradient-to-r from-teal-500 to-purple-700 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:from-teal-600 hover:to-purple-800 transition"
          >
            ‚ö° –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª (FLH0)
          </button>

          <button
            onClick={addBoardsToBaseALL}
            className="w-full bg-white text-gray-700 border border-gray-300 hover:bg-gray-100 py-3 px-6 rounded-xl shadow transition flex items-center justify-center gap-2"
          >
            üì• –ó–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ –≤ –±–∞–∑—É
          </button>
        </div>
      </div>


      <div className="bg-gray-900 text-white p-4 rounded-xl shadow h-[600px] overflow-y-auto relative">
        <pre className="whitespace-pre-wrap">{logs}</pre>
      </div>


      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {Array.from({ length: firmwareCoralB.countPort }, (_, i) => (
          <FirmCoralBPortCard
            key={i}
            id={i}
            sendCommand={handleCommand}
            loadingCommand={loadingCommand}
            firmwareCoralB={firmwareCoralB}
            addBoardsToBase={() => addBoardsToBase(i)}
          />
        ))}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Firmware/FirmwareCoralB/FirmCoralBPortCard.tsx
================================================================================

import FirmwareCoralBStore from "src/store/FirmwareCoralB";

interface FirmPortProps {
  id: number;
  sendCommand: (value: string) => void;
  addBoardsToBase: () => void;
  firmwareCoralB: FirmwareCoralBStore;
  loadingCommand: string | null;
}

export const FirmCoralBPortCard: React.FC<FirmPortProps> = ({
  id,
  firmwareCoralB,
  sendCommand,
  addBoardsToBase,
  loadingCommand,
}) => {
  const flashStatus = firmwareCoralB.flashStatus[id];
  const isSuccess = flashStatus?.includes("‚úÖ");

  const isFlashing = loadingCommand === `FLH${id + 1}`;
  const isTesting = loadingCommand === `TST${id + 1}`;
  const isInfo = loadingCommand === `INF${id + 1}`;

  return (
    <div
      key={id}
      className="rounded-2xl shadow-md bg-white p-5 space-y-4 border border-gray-200 hover:shadow-xl transition-all duration-300"
    >
      <h3 className="text-center text-lg font-bold text-gray-800">
        üîå –ü–æ—Ä—Ç {id + 1}
      </h3>


      <div className="flex flex-col">
        <span className="text-xl text-gray-500">Serial:</span>
        <p className="text-xl font-mono text-gray-900 break-all">
          {firmwareCoralB.serial[id] || "‚Äî"}
        </p>
      </div>


      <div className="flex flex-col">
        <span className="text-xl text-gray-500">–°—Ç–∞—Ç—É—Å –ø—Ä–æ—à–∏–≤–∫–∏:</span>
        <p
          className={`text-xl font-semibold ${
            isSuccess ? "text-green-600" : "text-red-600"
          }`}
        >
          {flashStatus || "‚Äî"}
        </p>
      </div>


      <div className="flex flex-col gap-2">
        <button
          disabled={isTesting}
          className={`w-full px-4 py-2 rounded-lg text-sm font-medium text-white transition ${
            isTesting
              ? "bg-blue-300 cursor-wait"
              : "bg-blue-600 hover:bg-blue-700"
          }`}
          onClick={() => sendCommand(`TST${id + 1}`)}
        >
          {isTesting ? "‚åõ –¢–µ—Å—Ç..." : `üîç –¢–µ—Å—Ç-—Ç—å –ø–∏—Ç–∞–Ω–∏–µ –∏ RF (TST${id + 1})`}
        </button>

        <button
          disabled={isFlashing}
          className={`w-full px-4 py-2 rounded-lg text-sm font-medium text-white transition ${
            isFlashing
              ? "bg-yellow-300 cursor-wait"
              : "bg-yellow-500 hover:bg-yellow-600"
          }`}
          onClick={() => sendCommand(`FLH${id + 1}`)}
        >
          {isFlashing ? "‚åõ –ü—Ä–æ—à–∏–≤–∫–∞..." : `‚ö° –ü—Ä–æ—à–∏—Ç—å (FLH${id + 1})`}
        </button>

        <button
          disabled={isInfo}
          className={`w-full px-4 py-2 rounded-lg text-sm font-medium text-white transition ${
            isInfo
              ? "bg-purple-300 cursor-wait"
              : "bg-purple-600 hover:bg-purple-700"
          }`}
          onClick={() => sendCommand(`INF${id + 1}`)}
        >
          {isInfo
            ? "‚åõ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö..."
            : `üìä –¢–µ—Å—Ç-—Ç—å –ø—Ä–æ—à–∏–≤–∫—É (INF${id + 1})`}
        </button>
      </div>


      <div className="pt-2 border-t border-gray-200 space-y-1">
        <button
          className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm py-2 px-4 rounded-lg transition"
          onClick={() => addBoardsToBase}
        >
          üì• –î–æ–±–∞–≤–∏—Ç—å –≤ –ë–î
        </button>

        <div className="text-xs text-gray-500">–°—Ç–∞—Ç—É—Å –ë–î:</div>
        <div className="text-sm text-gray-700">
          {firmwareCoralB.messageDB[id] || "‚Äî"}
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Firmware/FrimwareFC/FirmwareFC.tsx
================================================================================

import { DiamondPlus } from "lucide-react";
import { observer } from "mobx-react-lite";
import { useContext, useEffect, useRef, useState } from "react";
import { createFC } from "src/api/fcApi";
import { getSerialId, startWork, stopWork, uploadFont } from "src/api/firmwareApi";
import { Context } from "src/main";
import FC1 from "assets/images/FC1.png";
import FC2 from "assets/images/FC2.png";
import { toJS } from "mobx";
import { useDeepCompareEffect } from "react-use";
import { PortCardFC } from "./PortCard";
import { FirmwareFCControls } from "./FirmwareFCControl";
import { useBetaflyData } from "src/hooks/useBetaflyData";


export const FirmwareFC: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { firmwareFC } = context;

  const [socketKey, setSocketKey] = useState(0);

  const { devices, deviceHighlight, startChecking, resetDeviceHiglicht } = useBetaflyData(socketKey);


  const abortControllerRef = useRef(new AbortController());
  const [showIcon, setShowIcon] = useState(false);

  useEffect(() => {
    if (firmwareFC.counterTotalForSession >= 0) {
      setShowIcon(true);
      const timer = setTimeout(() => setShowIcon(false), 7000);
      return () => clearTimeout(timer);
    }
  }, [firmwareFC.counterTotalForSession]);

  const [highlightedCards, setHighlightedCards] = useState<{
    [key: number]: boolean;
  }>({});


  const activateGreenBackground = (id: number) => {
    setHighlightedCards((prev) => ({ ...prev, [id]: true }));
    setTimeout(() => {
      setHighlightedCards((prev) => ({ ...prev, [id]: false }));
    }, 7000);
  };

  useDeepCompareEffect(() => {
    Array.from({ length: firmwareFC.countPort }, (_, id) => {
      if (
        firmwareFC.serialIdsFC[id] &&
        firmwareFC.flashStatus[id] === "–ü—Ä–æ—à–∏–ª–æ—Å—å" &&
        firmwareFC.messageDB[id] === "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ"
      ) {
        activateGreenBackground(id);
      }
    });
  }, [
    firmwareFC.serialIdsFC,
    toJS(firmwareFC.flashStatus),
    toJS(firmwareFC.messageDB),
    firmwareFC.countPort,
  ]);

  const abortAllRequests = () => {
    abortControllerRef.current.abort();
    abortControllerRef.current = new AbortController();
    firmwareFC.resetState();
    stopWork();
    resetDeviceHiglicht();
  };

  const getSerialForPort = async (id: number) => {
    try {
      const currentId = await getSerialId(
        id,
        abortControllerRef.current.signal
      );
      firmwareFC.setSerialIdsFC(id, currentId.serial_number);
    } catch (error: any) {
      if (error.name === "AbortError") {
        console.log(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω`);
      } else {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—á–∏—Ç—ã–≤–∞–Ω–∏–∏ —Å–µ—Ä–∏–π–Ω–∏–∫–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`, error);
      }
    }
  };

  const getSerialForAllPorts = async () => {
    await stopWork();
    await Promise.all(
      Array.from({ length: firmwareFC.countPort }, (_, i) =>
        getSerialForPort(i)
      )
    );
    await startWork();
    setSocketKey((k) => k + 1);

    startChecking()
  };

  const flashForPort = async (id: number) => {
    if (deviceHighlight[`/dev/ttyACM${id}`]=== 'red' ) {firmwareFC.setFlashStatus(id, '–ë–†–ê–ö'); return}
    try {
      firmwareFC.setLoading(id, true);

      const result = await uploadFont(id, abortControllerRef.current.signal);

      firmwareFC.setFlashStatus(id, result.status);
      firmwareFC.setLoading(id, false);
    } catch (error: any) {
      if (error.name === "AbortError") {
        const err = `–ü—Ä–æ—à–∏–≤–∫–∞ –Ω–∞ ${id} –æ—Ç–º–µ–Ω–µ–Ω–∞`;
        firmwareFC.setFlashStatus(id, err);
        console.log(`–ü—Ä–æ—à–∏–≤–∫–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${id} –æ—Ç–º–µ–Ω–µ–Ω–∞`);
      } else {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—à–∏–≤–∫–µ –Ω–∞ –ø–æ—Ä—Ç—É ${id}:`, error);
      }
      firmwareFC.setLoading(id, false);
    }
  };

  const flashForAllPorts = async () => {
    await stopWork();
    await Promise.all(
      Array.from({ length: firmwareFC.countPort }, (_, i) => flashForPort(i))
    );
  };

  const addFCtoBase = async (id: number) => {
    const unique_device_id: string = firmwareFC.serialIdsFC[id];
    const currentFirm: boolean = firmwareFC.flashStatus[id] === "–ü—Ä–æ—à–∏–ª–æ—Å—å";
    const sessionId = Number(localStorage.getItem("sessionID"));
    const categoryDefectId = 1;
    if (
      unique_device_id !== null &&
      unique_device_id.length < 35 &&
      currentFirm === true
    ) {
      try {
        await createFC(
          unique_device_id,
          currentFirm,
          sessionId,
          categoryDefectId
        );
        firmwareFC.setCounterTotalForSessionPlus();
        firmwareFC.setMessageDB(id, "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ");
      } catch (error) {
        firmwareFC.setMessageDB(id, `–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –±–∞–∑—É ${error}`);
      }
    }
  };

  const addFCtoBaseALL = async () => {
    for (let i = 0; i <= firmwareFC.countPort - 1; i++) {
      addFCtoBase(i);
    }
  };

  return (
    <div className="space-y-4 bg-gray-100/50 min-h-screen">
      <h2 className="text-3xl font-bold text-center text-gray-800 ">
        –ü—Ä–æ—à–∏–≤–∫–∞ –ü–æ–ª–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ (FC)
      </h2>

      <div className="flex justify-around">

        <div className="flex h-16 items-center space-x-4 bg-white p-4 rounded-lg shadow-sm">
          <span className="text-gray-700 font-medium">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ç–æ–≤</span>
          <div className="flex items-center space-x-2">
            <button
              onClick={() => firmwareFC.setCountPortMinus()}
              className="w-8 h-8 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center hover:bg-gray-300 transition duration-200"
            >
              -
            </button>
            <span className="text-xl font-bold text-gray-800">
              {firmwareFC.countPort}
            </span>
            <button
              onClick={() => firmwareFC.setCountPortPlus()}
              className="w-8 h-8 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center hover:bg-gray-300 transition duration-200"
            >
              +
            </button>
          </div>


          <div className="flex h-16 items-center space-x-4 bg-white p-4 rounded-lg shadow-sm">
            <span className="text-gray-700 font-medium">Pro –†–µ–∂–∏–º</span>
            <label className="relative inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                className="sr-only peer"
                checked={firmwareFC.proMode}
                onChange={() => firmwareFC.setProMode()}
              />
              <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>
        </div>


        <div className="flex justify-center items-center gap-6">
          <img
            src={FC2}
            className="w-40 h-auto rounded-lg shadow-md"
            alt="FC1"
          />
          <img
            src={FC1}
            className="w-40 h-auto rounded-lg shadow-md"
            alt="FC2"
          />
        </div>

        <FirmwareFCControls
          onReadAll={getSerialForAllPorts}
          onFlashAll={flashForAllPorts}
          onWriteAll={addFCtoBaseALL}
          onAbortAll={abortAllRequests}
        />
      </div>

      <div className="grid grid-cols-5 gap-4">
        {Array.from({ length: firmwareFC.countPort }, (_, i) => i).map((id) => {
          const portPath = `/dev/ttyACM${id}`;
          const device = devices.find((d) => d.port?.trim() === portPath?.trim());
          return (
            <PortCardFC
              key={id}
              id={id}
              deviceData={device}
              serial={firmwareFC.serialIdsFC[id]}
              flashStatus={firmwareFC.flashStatus[id]}
              messageDB={firmwareFC.messageDB[id]}
              loading={firmwareFC.loading[id]}
              onReadSerial={() => getSerialForPort(id)}
              onFlash={() => flashForPort(id)}
              onAddToBase={() => addFCtoBase(id)}
              isHighlighted={highlightedCards[id]}
              deviceHighlight={deviceHighlight[`/dev/ttyACM${id}`]}
              proMode={firmwareFC.proMode}
            />
          )
        }
        )}
      </div>

      <div className="p-4 bg-gray-100 rounded-lg shadow-md">
        <div className="flex  mr-20 items-center text-lg font-semibold text-gray-800">
          <div className="w-2/3"></div>

          <div className="w-1/3  ml-20 ">
            <div className="flex">
              –í—Å–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É –∑–∞ —Ç–µ–∫—É—â–∏–π —Å–µ–∞–Ω—Å:
              <span className="ml-2  text-blue-600">
                {firmwareFC.counterTotalForSession}
              </span>
              {showIcon && (
                <span className="ml-2 text-green-600 animate-pulse">
                  <DiamondPlus size={32} />
                </span>
              )}
            </div>
            <button
              className="bg-red-600 text-white py-2 px-2 rounded-2xl shadow-xl hover:bg-rose-400 transition duration-300"
              onClick={() => firmwareFC.resetCounterTotalForSession()}
            >
              –û–±–Ω—É–ª–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
            </button>
          </div>
        </div>

        <div className="mt-5 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-md">
          ‚ö†Ô∏è <span className="font-medium">–í–ù–ò–ú–ê–ù–ò–ï:</span> –≤ –±–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
          —Ç–æ–ª—å–∫–æ –ø–ª–∞—Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–π —Å—á–∏—Ç–∞–ª—Å—è –Ω–æ–º–µ—Ä –∏ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –∑–∞–≥—Ä—É–∑–∏–ª—Å—è —à—Ä–∏—Ñ—Ç.
          <br></br>
          –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–æ—à–∏–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å.
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Firmware/FrimwareFC/FirmwareFCControl.tsx
================================================================================

import React, { useEffect, useState } from "react";

interface FirmwareControlsProps {
    onReadAll: () => void;
    onFlashAll: () => Promise<void>;
    onWriteAll: () => Promise<void>;

    onAbortAll: () => void;
}

export const FirmwareFCControls: React.FC<FirmwareControlsProps> = ({
    onReadAll,
    onFlashAll,
    onWriteAll,
    onAbortAll,
}) => {

    const [isDisabled, setIsDisabled] = useState(false);
    const [countdown, setCountdown] = useState(0);
    const [isFlashing, setIsFlashing] = useState(false);


    useEffect(() => {
        if (countdown > 0) {
            const timer = setTimeout(() => {
                setCountdown(prev => prev - 1);
            }, 1000);

            return () => clearTimeout(timer);
        } else if (countdown === 0 && isDisabled) {
            setIsDisabled(false);
        }
    }, [isDisabled, countdown]);

    const handleReadAll = () => {
        onReadAll();
        setIsDisabled(true);
        setCountdown(5);


    }

    const flashAndWriteAll = async () => {
        if (isDisabled) return;
        setIsFlashing(true)
        try {

            await onFlashAll();


            await onWriteAll();

            console.log("–ü—Ä–æ—à–∏–≤–∫–∞ –∏ –∑–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!");
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø—Ä–æ—à–∏–≤–∫–∏ –∏ –∑–∞–ø–∏—Å–∏:", error);
        } finally {setIsFlashing(false)}
    };

    return (
        <div className="grid grid-cols-2 w-max gap-2 mt-8">
            <button
                className="bg-teal-600 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-blue-600 transition"
                onClick={handleReadAll}
            >
                üîç –°—á–∏—Ç–∞—Ç—å
            </button>


            <button
                className={`bg-gradient-to-r from-teal-600 to-purple-700 text-lg font-bold py-4 px-8 rounded-2xl shadow-xl transition duration-300 ${ isFlashing
                    ? "bg-orange-500 text-white cursor-wait opacity-80"
                    : isDisabled
                    ? "bg-gray-400 text-gray-600 cursor-wait opacity-60"
                    : "bg-gradient-to-r from-teal-600 to-purple-700 text-white hover:from-teal-700 hover:to-purple-800"
                }`}
                onClick={flashAndWriteAll}
                disabled={isDisabled}

 >
                <div className="gap-2">
                    {isFlashing ? "‚è≥ –ü—Ä–æ—à–∏–≤–∞–µ—Ç—Å—è..." : "‚ö° –ü—Ä–æ—à–∏—Ç—å + üì• –ó–∞–ø–∏—Å–∞—Ç—å"}
                    {isDisabled && countdown > 0 && (
                        <div className="ml-2 text-sm bg-white/20 px-2 py-1 rounded-full">
                            {countdown}—Å–µ–∫
                        </div>
                    )}
                </div>
            </button>


            <button
                className="bg-red-700 text-white text-lg font-bold py-4 px-8 rounded-2xl shadow-xl hover:bg-rose-600 transition duration-300"
                onClick={onAbortAll}
            >
                üîÑ –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞
            </button>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Firmware/FrimwareFC/MiniBetafly.tsx
================================================================================

import React from "react";
import { Activity, Gauge, BatteryCharging } from "lucide-react";
import { BetaflyDevice } from "src/hooks/useBetaflyData";

interface MiniBetaflyProps {
device?: BetaflyDevice;
highlight: string | null;
proMode: boolean;}


export const MiniBetafly: React.FC<MiniBetaflyProps> = ({ device, highlight, proMode }) => {


  const attitude = device?.attitude || { roll: 0, pitch: 0, yaw: 0 };
  const altitude = device?.altitude || { estAlt: 0, vario: 0 };
  const analog = device?.analog || { amperage: 0, vbat: 0, rssi: 0 };

const highlightClass =
    highlight === "green"
      ? "bg-green-200"
      : highlight === "red"
      ? "bg-red-400"
      : "";

  return (
    <>
    { proMode&&
    <div
    className={`flex flex-col space-y-2 text-sm rounded-lg p-2 shadow-inner transition-colors duration-300 ${highlightClass}`}
    >

      <div className="flex items-center space-x-2">
        <Activity className="text-blue-600 w-5 h-5" />
        <span>Roll: {attitude.roll.toFixed(1)}¬∞</span>
        <span>Pitch: {attitude.pitch.toFixed(1)}¬∞</span>
        <span>Yaw: {attitude.yaw.toFixed(1)}¬∞</span>
      </div>


      <div className="flex items-center space-x-2">
        <Gauge className="text-purple-600 w-5 h-5" />
        <span>Alt: {altitude.estAlt.toFixed(1)} —Å–º</span>
      </div>


      <div className="flex items-center space-x-2">
        <BatteryCharging className="text-green-600 w-5 h-5" />
        <span>{(analog.amperage /100).toFixed(3)} –ê</span>
      </div>
    </div>
}
    </>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Firmware/FrimwareFC/PortCard.tsx
================================================================================

import { PreloaderMini } from "src/components/common/PreloaderMini";
import { MiniBetafly } from "./MiniBetafly";
import { BetaflyDevice } from "src/hooks/useBetaflyData";

interface PortCardProps {
  id: number;
  deviceData?: BetaflyDevice;
  serial: string | null;
  flashStatus: string;
  messageDB: string;
  loading: boolean;
  onReadSerial: () => void;
  onFlash: () => void;
  onAddToBase: () => void;
  isHighlighted: boolean;
  deviceHighlight: string | null;
  proMode: boolean;
}

export const PortCardFC: React.FC<PortCardProps> = ({
  id,
  deviceData,
  serial,
  flashStatus,
  messageDB,
  loading,
  onReadSerial,
  onFlash,
  onAddToBase,
  isHighlighted,
  deviceHighlight,
  proMode
}) => {
  const getFirmwareClass = () => {
    if (flashStatus === "–ü—Ä–æ—à–∏–ª–æ—Å—å") return "text-green-600";
    if (flashStatus === "–ù–µ –ø—Ä–æ—à–∏—Ç–æ") return "text-gray-600";
    return "bg-rose-500 animate-pulse";
  };

  const getSerialClass = () => {
    if (!serial) return "text-gray-600";
    if (serial.length < 30) return "text-green-600";
    return "bg-rose-500 animate-pulse";
  };

  const getMessageClass = () => {
    if (messageDB === "–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ") return "text-gray-600";
    if (messageDB === "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ") return "text-green-600";
    return "bg-rose-500 animate-pulse";
  };

  return (
    <div className={`border p-4 rounded-lg shadow-md ${isHighlighted ? "bg-green-400" : "bg-white"}`}>
      <h3 className="text-md font-semibold text-center">–ü–æ—Ä—Ç {id + 1}</h3>

      <div className="flex">
        <button
          className="bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-blue-700 transition duration-200"
          onClick={onReadSerial}
        >
          üîç
        </button>
        <p className="text-sm ml-2 text-center">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</p>
      </div>

      <p className={`break-words text-xl font-medium ${getSerialClass()}`}>
        {serial || "—Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä"}
      </p>

      <MiniBetafly device={deviceData} highlight={deviceHighlight} proMode={proMode}  />
      <div className="flex mt-3">
        <button
          className="bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-red-700 transition duration-200 mt-2"
          onClick={onFlash}
        >
          ‚ö°
        </button>
        <p className="text-sm mt-2 ml-2 text-center">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏</p>
      </div>

      <p className={`text-xl font-medium ${getFirmwareClass()}`}>
        {flashStatus}
        {loading && <PreloaderMini />}
      </p>

      <div className="flex mt-3">
        <button
          className="bg-blue-200 font-medium py-1 px-2 rounded-lg hover:bg-blue-700 transition duration-200"
          onClick={onAddToBase}
        >
          üì•
        </button>
        <p className="text-sm mt-2 ml-2 text-center">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É</p>
      </div>

      <p className={`text-xl font-medium ${getMessageClass()}`}>{messageDB}</p>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/FirmwareOld/FirmwareOld.tsx
================================================================================

export const FirmwareOld: React.FC = () => {
  return (
    <div className="w-100 h-screen bg-gray-100/70">
      <iframe
        src="http://localhost:1880"
        title="Node-RED"
        width="100%"
        height="100%"
        style={{ border: "none" }}
      ></iframe>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/InputDefect/InputDefect.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState } from "react";
import {
  createManyDefects2_4boards,
  createManyDefects915boards,
  deleteManyDefects2_4boards,
  deleteManyDefects915boards,
  fetchCategoryDefect24,
  fetchCategoryDefect915,
} from "src/api/elrsApi";
import {
  createManyDefectsFC,
  deleteManyDefectsFC,
  fetchCategoryDefect,
} from "src/api/fcApi";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { Context } from "src/main";

export const InputDefect: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { flightController, elrsStore } = context;

  useEffect(() => {
    fetchCategoryDefect().then((data) =>
      flightController.setDefectCategories(data)
    );
    flightController.resetSelectedDefect();
  }, []);

  const [count, setCount] = useState(0);

  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  const [isBoardSelected, setIsBoardSelected] = useState(false);
  const typeOfBoards = ["FC", "ELRS 915", "ELRS 2,4"];
  const [currentBoard, setCurrentBoard] = useState("");

  useEffect(() => {
    if (currentBoard) {
      switch (currentBoard) {
        case "FC":
          fetchCategoryDefect()
            .then((data) => {
              flightController.setDefectCategories(data);
              flightController.resetSelectedDefect();
            })
            .catch((error) => {
              console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è FC:", error);
            });
          break;

        case "ELRS 915":
          fetchCategoryDefect915()
            .then((data) => {
              elrsStore.setDefect_915_Categories(data);
              elrsStore.resetSelectedDefect();
            })
            .catch((error) => {
              console.error(
                "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è ELRS 915:",
                error
              );
            });
          break;

        case "ELRS 2,4":
          fetchCategoryDefect24()
            .then((data) => {
              elrsStore.setDefect_2_4_Categories(data);
              elrsStore.resetSelectedDefect();
            })
            .catch((error) => {
              console.error(
                "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è ELRS 2,4:",
                error
              );
            });
          break;

        default:
          console.warn("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø–ª–∞—Ç—ã:", currentBoard);
          break;
      }
    }
  }, [currentBoard]);

  const addToBaseManyFC = async () => {
    try {
      let defectCat;
      let defectCatName;
      let request;

      switch (currentBoard) {
        case "FC":
          defectCat = flightController.selectedDefect?.id || -1;
          defectCatName = flightController.selectedDefect?.title || "";
          request = createManyDefectsFC;
          break;
        case "ELRS 915":
          defectCat = elrsStore.selectedDefect?.id || -1;
          defectCatName = elrsStore.selectedDefect?.title || "";
          request = createManyDefects915boards;
          break;
        case "ELRS 2,4":
          defectCat = elrsStore.selectedDefect?.id || -1;
          defectCatName = elrsStore.selectedDefect?.title || "";
          request = createManyDefects2_4boards;
          break;
        default:
          throw new Error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø–ª–∞—Ç—ã");
      }

      if (defectCat < 0) {
        return alert("–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –±—Ä–∞–∫–∞");
      }

      await request(
        count,
        Number(localStorage.getItem("sessionID")),
        defectCat
      );
      alert(
        `–í –±–∞–∑—É –≤–Ω–µ—Å–µ–Ω–æ ${count} –ø–ª–∞—Ç  ${currentBoard} —Å –±—Ä–∞–∫–æ–º ${defectCatName}`
      );
      closeModal();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–Ω–µ—Å–µ–Ω–∏–∏ –≤ –±–∞–∑—É:", error);
    }
    flightController.resetSelectedDefect();
    elrsStore.resetSelectedDefect();
  };

  const deleteFromBaseManyFC = async () => {
    try {
      let defectCat;
      let defectCatName;
      let request;

      switch (currentBoard) {
        case "FC":
          defectCat = flightController.selectedDefect?.id || -1;
          defectCatName = flightController.selectedDefect?.title || "";
          request = deleteManyDefectsFC;
          break;
        case "ELRS 915":
          defectCat = elrsStore.selectedDefect?.id || -1;
          defectCatName = elrsStore.selectedDefect?.title || "";
          request = deleteManyDefects915boards;
          break;
        case "ELRS 2,4":
          defectCat = elrsStore.selectedDefect?.id || -1;
          defectCatName = elrsStore.selectedDefect?.title || "";
          request = deleteManyDefects2_4boards;
          break;
        default:
          throw new Error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø–ª–∞—Ç—ã");
      }

      if (defectCat < 0) {
        return alert("–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –±—Ä–∞–∫–∞");
      }

      await request(count, defectCat);
      alert(
        `–ò–∑ –±–∞–∑—ã —É–¥–∞–ª–µ–Ω–æ ${count} –ø–ª–∞—Ç  ${currentBoard} —Å –±—Ä–∞–∫–æ–º ${defectCatName} `
      );
      closeModal();
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–Ω–æ–≥–∏—Ö –ø–ª–∞—Ç:", error);
    }
    flightController.resetSelectedDefect();
    elrsStore.resetSelectedDefect();
  };

  return (
    <div className="bg-white p-6 rounded-xl shadow-lg max-w-xl mx-auto">
      <h1 className="text-2xl font-bold text-gray-800 mb-4 text-center">
        –í–≤–æ–¥ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±—Ä–∞–∫–∞ –∏–∑ –±–∞–∑—ã
      </h1>


      <select
        className="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-blue-500 transition"
        onChange={(e) => {
          const selectedBoard = typeOfBoards.find(
            (el) => el === e.target.value
          );
          if (selectedBoard) {
            setCurrentBoard(selectedBoard);
            setIsBoardSelected(true);
          }
          flightController.resetSelectedDefect();
          elrsStore.resetSelectedDefect();
        }}
      >
        <option value="" disabled selected>
          –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –ø–ª–∞—Ç—ã
        </option>
        {typeOfBoards.map((el, index) => (
          <option key={index} value={el}>
            {el}
          </option>
        ))}
      </select>

      <p>{currentBoard}</p>


      {isBoardSelected && (
        <>

          <select
            className="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-blue-500 transition"
            onChange={(e) => {
              let selectedDefect;
              switch (currentBoard) {
                case "FC":
                  selectedDefect = flightController.defectCategories.find(
                    (defect) => defect.id === Number(e.target.value)
                  );
                  if (selectedDefect)
                    flightController.setSelectedDefect(selectedDefect);
                  break;
                case "ELRS 915":
                  selectedDefect = elrsStore.defect_915_Categories.find(
                    (defect) => defect.id === Number(e.target.value)
                  );
                  if (selectedDefect)
                    elrsStore.setSelectedDefect(selectedDefect);
                  break;
                case "ELRS 2,4":
                  selectedDefect = elrsStore.defect_2_4_Categories.find(
                    (defect) => defect.id === Number(e.target.value)
                  );
                  if (selectedDefect)
                    elrsStore.setSelectedDefect(selectedDefect);
                  break;
                default:
                  console.warn("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø–ª–∞—Ç—ã:", currentBoard);
              }
            }}
          >
            <option value="" disabled selected>
              –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±—Ä–∞–∫–∞
            </option>

            {currentBoard === "FC" &&
              flightController.defectCategories.map((el) => (
                <option key={el.id} value={el.id}>
                  {el.title}
                </option>
              ))}
            {currentBoard === "ELRS 915" &&
              elrsStore.defect_915_Categories.map((el) => (
                <option key={el.id} value={el.id}>
                  {el.title}
                </option>
              ))}
            {currentBoard === "ELRS 2,4" &&
              elrsStore.defect_2_4_Categories.map((el) => (
                <option key={el.id} value={el.id}>
                  {el.title}
                </option>
              ))}
          </select>


          <input
            value={count}
            type="number"
            onChange={(e) => setCount(Number(e.target.value))}
            placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"
            className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 transition"
          />
          <p className="mb-4">
            –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–≤–æ–¥–∏—Ç—å –±–æ–ª–µ–µ 100 000 –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑{" "}
          </p>


          <div className="flex gap-4">
            <button
              type="button"
              className="w-1/2 bg-green-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-green-700 transition"
              onClick={() => openModal("addManyDefects")}
            >
              ‚úÖ –í–Ω–µ—Å—Ç–∏ –≤ –±–∞–∑—É
            </button>

            <button
              type="button"
              className="w-1/2 bg-red-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-red-700 transition"
              onClick={() => openModal("deleteManyDefects")}
            >
              ‚ùå –£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã
            </button>
          </div>
        </>
      )}

      <Modal isOpen={modalType === "addManyDefects"} onClose={closeModal}>
        <ConfirmModal
          title1={`–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É ${count} —à—Ç. ${currentBoard} —Å –±—Ä–∞–∫–æ–º ${
            flightController.selectedDefect?.title ||
            elrsStore.selectedDefect?.title
          }?`}
          actionConfirm={addToBaseManyFC}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "deleteManyDefects"} onClose={closeModal}>
        <ConfirmModal
          title1={`–£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã ${count} —à—Ç. ${currentBoard} —Å –±—Ä–∞–∫–æ–º ${
            flightController.selectedDefect?.title ||
            elrsStore.selectedDefect?.title
          }?`}
          actionConfirm={deleteFromBaseManyFC}
          onClose={closeModal}
        />
      </Modal>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/KnowledgeBase/KnowledgeBase.tsx
================================================================================

import React, { useState } from "react";
import {
  BookOpen,
  FileText,
  Cpu,
  Package,
  Settings,
  Zap,
  Layout,
  Info,
  ChevronRight,
  Shield,
  Layers
} from "lucide-react";


import VidyBrakaFC from "assets/pdf/Vidy-Braka-FC.pdf";
import VidyBrakaESC from "assets/pdf/Vidy-Braka-ESC.pdf";
import Firmware915 from "assets/pdf/Firmware-915.pdf";


type Tab = "OVERVIEW" | "PDF_FC" | "PDF_ESC" | "PDF_915";

interface ModuleCardProps {
  title: string;
  description: string;
  icon: React.ElementType;
  tips: string[];
  color: string;
}

const ModuleCard: React.FC<ModuleCardProps> = ({ title, description, icon: Icon, tips, color }) => {
  return (
    <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group">
      <div className={`w-12 h-12 rounded-xl flex items-center justify-center mb-4 ${color} text-white shadow-md`}>
        <Icon size={24} />
      </div>
      <h3 className="text-xl font-bold text-slate-800 mb-2 group-hover:text-indigo-600 transition-colors">
        {title}
      </h3>
      <p className="text-slate-500 text-sm mb-4 leading-relaxed">
        {description}
      </p>

      <div className="bg-slate-50 rounded-lg p-3 border border-slate-100">
        <p className="text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-1">
          <Info size={12}/> –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:
        </p>
        <ul className="space-y-1">
          {tips.map((tip, idx) => (
            <li key={idx} className="text-xs text-slate-600 flex items-start gap-2">
              <span className="mt-1 w-1 h-1 rounded-full bg-indigo-400 flex-shrink-0"/>
              {tip}
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
};

const SystemOverview: React.FC = () => {
  return (
    <div className="animate-fade-in space-y-8 pb-10">

      <div className="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden">
        <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
        <div className="relative z-10">
          <h1 className="text-3xl font-extrabold mb-2 flex items-center gap-3">
            <BookOpen className="opacity-80"/> MES Knowledge Hub
          </h1>
          <p className="text-indigo-100 max-w-2xl text-lg">
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π ¬´–ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç¬ª. –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ —Å–∏—Å—Ç–µ–º—ã,
            –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –º–æ–¥—É–ª—è–º–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è.
          </p>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        <ModuleCard
          title="–°–∫–ª–∞–¥ –∏ WMS"
          description="–£—á–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –ø—Ä–∏–µ–º–∫–∞ –ø–æ—Å—Ç–∞–≤–æ–∫, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR-—ç—Ç–∏–∫–µ—Ç–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞–º–∏."
          icon={Package}
          color="bg-emerald-500"
          tips={[
            "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª '–°–∫–ª–∞–¥' –¥–ª—è –ø—Ä–∏–µ–º–∫–∏ —Ç–æ–≤–∞—Ä–∞.",
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é' –¥–ª—è —Å–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤.",
            "–ü–µ—á–∞—Ç–∞–π—Ç–µ —ç—Ç–∏–∫–µ—Ç–∫–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–∞—Ä—Ç–∏–∏."
          ]}
        />

        <ModuleCard
          title="–°–±–æ—Ä–∫–∞ –∏ –†–µ—Ü–µ–ø—Ç—ã"
          description="–ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–±–æ—Ä—â–∏–∫–æ–≤, –∫–æ–Ω—Ç—Ä–æ–ª—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –∏ —Ü–∏—Ñ—Ä–æ–≤—ã–µ –ø–∞—Å–ø–æ—Ä—Ç–∞ –∏–∑–¥–µ–ª–∏–π."
          icon={Layers}
          color="bg-blue-500"
          tips={[
            "–¢–µ—Ö–Ω–æ–ª–æ–≥ —Å–æ–∑–¥–∞–µ—Ç —Ä–µ—Ü–µ–ø—Ç—ã –≤ '–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ'.",
            "–°–±–æ—Ä—â–∏–∫ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR –∫–æ—Ä–ø—É—Å–∞ –≤ '–¢–µ—Ä–º–∏–Ω–∞–ª–µ'.",
            "–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
          ]}
        />

        <ModuleCard
          title="–ü—Ä–æ—à–∏–≤–∫–∞ (Firmware)"
          description="–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ—à–∏–≤–∫–∞ –ø–ª–∞—Ç (FC, ELRS, Coral) —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –∑–∞–ø–∏—Å—å—é –ª–æ–≥–æ–≤."
          icon={Cpu}
          color="bg-orange-500"
          tips={[
            "–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ USB.",
            "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ—à–∏—Ç—å'.",
            "–ó–µ–ª–µ–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç —É—Å–ø–µ—à–Ω—É—é –∑–∞–ø–∏—Å—å –≤ –ë–î."
          ]}
        />

        <ModuleCard
          title="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ"
          description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —Ä–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å (RBAC), –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç –∏ –∞—É–¥–∏—Ç."
          icon={Shield}
          color="bg-slate-700"
          tips={[
            "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ RBAC.",
            "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ —á–µ—Ä–µ–∑ '–ñ—É—Ä–Ω–∞–ª –ê—É–¥–∏—Ç–∞'.",
            "–î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –ü–ö –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–π—Ç–µ –∏—Ö –∫ —Ü–µ—Ö–∞–º."
          ]}
        />

        <ModuleCard
          title="–ó–∞–¥–∞—á–∏ –∏ –ü—Ä–æ–µ–∫—Ç—ã"
          description="–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á –Ω–∞ —Å–º–µ–Ω—É –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º."
          icon={Layout}
          color="bg-purple-500"
          tips={[
            "–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –ü—Ä–æ–µ–∫—Ç—É.",
            "–ù–∞–∑–Ω–∞—á–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏ —Å—Ä–æ–∫–∏.",
            "–°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏."
          ]}
        />

        <ModuleCard
          title="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –†–µ–π—Ç–∏–Ω–≥"
          description="–î–∞—à–±–æ—Ä–¥—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—Ä–∞–∫–∞ –∏ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤."
          icon={Zap}
          color="bg-yellow-500"
          tips={[
            "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–∏—á–Ω—ã–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –≤ '–†–µ–π—Ç–∏–Ω–≥–∞—Ö'.",
            "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–∏—á–∏–Ω—ã –±—Ä–∞–∫–∞ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö.",
            "–°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±—Ä–∏–≥–∞–¥."
          ]}
        />
      </div>
    </div>
  );
};

export const KnowledgeBase: React.FC = () => {
  const [activeTab, setActiveTab] = useState<Tab>("OVERVIEW");

  const menuItems = [
    { id: "OVERVIEW", label: "–û —Å–∏—Å—Ç–µ–º–µ MES", icon: Layout },
    { type: "divider", label: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (PDF)" },
    { id: "PDF_FC", label: "–í–∏–¥—ã –±—Ä–∞–∫–∞ FC", icon: FileText },
    { id: "PDF_ESC", label: "–í–∏–¥—ã –±—Ä–∞–∫–∞ ESC", icon: FileText },
    { id: "PDF_915", label: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ELRS 915", icon: FileText },
  ];

  return (
    <div className="flex h-[calc(100vh-64px)] bg-slate-50 overflow-hidden">


      <aside className="w-72 bg-white border-r border-slate-200 flex flex-col shadow-lg z-10">
        <div className="p-6 border-b border-slate-100">
          <h2 className="text-xl font-extrabold text-slate-800 flex items-center gap-2">
            <BookOpen className="text-indigo-600"/> –ë–∞–∑–∞ –ó–Ω–∞–Ω–∏–π
          </h2>
          <p className="text-xs text-slate-400 mt-1">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –≥–∞–π–¥—ã</p>
        </div>

        <nav className="flex-1 overflow-y-auto p-4 space-y-1">
          {menuItems.map((item, idx) => {
            if (item.type === "divider") {
              return (
                <div key={idx} className="pt-4 pb-2 px-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                  {item.label}
                </div>
              );
            }

            const Icon = item.icon;
            const isActive = activeTab === item.id;

            return (
              <button
                key={idx}
                onClick={() => setActiveTab(item.id as Tab)}
                className={`w-full flex items-center justify-between px-3 py-3 rounded-xl text-sm font-medium transition-all duration-200 ${
                  isActive
                    ? "bg-indigo-50 text-indigo-700 shadow-sm"
                    : "text-slate-600 hover:bg-slate-50 hover:text-slate-900"
                }`}
              >
                <div className="flex items-center gap-3">
                  <Icon size={18} className={isActive ? "text-indigo-600" : "text-slate-400"} />
                  {item.label}
                </div>
                {isActive && <ChevronRight size={16} className="text-indigo-400"/>}
              </button>
            );
          })}
        </nav>

        <div className="p-4 border-t border-slate-100 bg-slate-50">
          <div className="text-xs text-slate-400 text-center">
            ¬© 2025 NPK Kryptonit <br/> Internal Documentation
          </div>
        </div>
      </aside>


      <main className="flex-1 overflow-y-auto p-8 relative">

        <div className="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>

        <div className="relative z-10 max-w-7xl mx-auto h-full flex flex-col">

          {activeTab === "OVERVIEW" && <SystemOverview />}

          {activeTab !== "OVERVIEW" && (
            <div className="bg-white rounded-2xl shadow-lg border border-slate-200 h-full flex flex-col overflow-hidden animate-fade-in">
              <div className="bg-slate-800 text-white p-4 flex justify-between items-center shadow-md">
                <span className="font-semibold flex items-center gap-2">
                  <FileText size={18}/>
                  {menuItems.find(i => i.id === activeTab)?.label}
                </span>
                <span className="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">PDF Viewer</span>
              </div>
              <div className="flex-1 bg-slate-100">
                {activeTab === "PDF_FC" && (
                  <iframe src={VidyBrakaFC} title="FC" className="w-full h-full border-none"/>
                )}
                {activeTab === "PDF_ESC" && (
                  <iframe src={VidyBrakaESC} title="ESC" className="w-full h-full border-none"/>
                )}
                {activeTab === "PDF_915" && (
                  <iframe src={Firmware915} title="915" className="w-full h-full border-none"/>
                )}
              </div>
            </div>
          )}

        </div>
      </main>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Login/Login.tsx
================================================================================

import { useContext, useState } from "react";
import { NavLink, useNavigate } from "react-router-dom";
import { login } from "src/api/userApi";
import { Context } from "src/main";
import { REGISTRATION_ROUTE, SELECT_PC_ROUTE } from "src/utils/consts";

export const Login: React.FC = () => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { user } = context;

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const navigate = useNavigate();

  const [loginName, setLoginName] = useState("");
  const [password, setPassword] = useState("");

  const signIN = async (event: React.FormEvent) => {
    event.preventDefault();

    try {
      const currentUser = await login(loginName, password);

      user.setUser(currentUser);
      user.setIsAuth(true);

      console.log(user.user);
      setSuccessMessage("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ");
      setErrorMessage("");
      localStorage.removeItem("pcID");
      localStorage.removeItem("sessionID");

      setTimeout(() => {
        navigate(SELECT_PC_ROUTE);
        window.location.reload();
      }, 1000);
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-yellow-200 to-green-300">
      <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
        <h2 className="text-2xl font-bold mb-4">
          –í–æ–π—Ç–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫–∫–∞—É–Ω—Ç
        </h2>
        <form>
          <div className="mb-4">
            <label className="block text-gray-700 text-sm font-bold mb-2">
              –õ–æ–≥–∏–Ω
            </label>
            <input
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
              value={loginName}
              onChange={(e) => setLoginName(e.target.value)}
            />
          </div>
          <div className="mb-6">
            <label
              className="block text-gray-700 text-sm font-bold mb-2"
              htmlFor="password"
            >
              –ü–∞—Ä–æ–ª—å
            </label>
            <input
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
              value={password}
              type="password"
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>
          <div className="flex items-center justify-between">
            <button
              onClick={signIN}
              type="submit"
              className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
            >
              –í–æ–π—Ç–∏
            </button>

            <NavLink
              to={REGISTRATION_ROUTE}
              className="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800"
            >
              –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
            </NavLink>
          </div>
        </form>
        {successMessage && (
          <div className="mt-4 text-green-500 font-medium">
            {successMessage}
          </div>
        )}
        {errorMessage && (
          <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Login/Registration.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useState } from "react";
import { useNavigate } from "react-router-dom";
import { registration } from "src/api/userApi";
import { Context } from "src/main";
import { SELECT_PC_ROUTE } from "src/utils/consts";

export const Registration: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { user } = context;

  const [successMessage, setSuccessMessage] = useState("");
  const [errorMessage, setErrorMessage] = useState("");

  const navigate = useNavigate();

  const [login, setLogin] = useState("");
  const [password, setPassword] = useState("");
  const [name, setName] = useState("");
  const [surname, setSurname] = useState("");

  const signUP = async (event: React.FormEvent) => {
    event.preventDefault();
    try {
      const currentUser = await registration(login, password, name, surname);
      user.setUser(currentUser);
      user.setIsAuth(true);
      setSuccessMessage("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!");
      setErrorMessage("");
      localStorage.removeItem("pcID");
      localStorage.removeItem("sessionID");
      setTimeout(() => {
        navigate(SELECT_PC_ROUTE);
        window.location.reload();

      }, 2000);
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-yellow-200 to-green-300">
      <div className="max-w-md w-full p-6 bg-white shadow-md rounded-lg">
        <h2 className="text-2xl font-semibold mb-4">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

        <form>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">
              –õ–æ–≥–∏–Ω
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={login}
              onChange={(e) => setLogin(e.target.value)}
            />
          </div>

          <div className="mb-4">
            <label
              htmlFor="password"
              className="block text-sm font-medium text-gray-700"
            >
              –ü–∞—Ä–æ–ª—å
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={password}
              type="password"
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">
              –ò–º—è
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={name}
              onChange={(e) => setName(e.target.value)}
            />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">
              –§–∞–º–∏–ª–∏—è
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={surname}
              onChange={(e) => setSurname(e.target.value)}
            />
          </div>

          <div className="mb-4">
            <button
              onClick={signUP}
              type="submit"
              className="w-full bg-blue-500 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring focus:ring-blue-300"
            >
              –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
            </button>
          </div>
        </form>
        {successMessage && (
          <div className="mt-4 text-green-500 font-medium">
            {successMessage}
          </div>
        )}
        {errorMessage && (
          <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
        )}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/MqttCheck/MqttCheckESC.tsx
================================================================================

import { useState, useEffect, useRef } from "react";
import io from "socket.io-client";
import { mqttGetStatusESC, reloadTestESC, startTestESC } from "src/api/mqttApi";
import ESC1 from "assets/images/ESC1.png";
import ESC2 from "assets/images/ESC2.png";
import standESC1 from "assets/images/StandESC1.png";
import standESC2 from "assets/images/StandESC2.png";
import { BrushIcon, CircleXIcon } from "lucide-react";


interface Tests {
  [key: string]: string;
}


interface StandData {
  tests: Tests;
}


interface StatusData {
  [placeId: string]: StandData;
}

const socket = io(import.meta.env.VITE_MQTT_API_URL);

export const MqttCheckESC: React.FC = () => {
  const [statusData, setStatusData] = useState<StatusData>({});
  const prevStatusData = useRef<StatusData>({});

  const [hiddenRows, setHiddenRows] = useState<string[]>([]);
  const [startTestNotify, setStartTestNotify] = useState("");

  useEffect(() => {
    const fetchStatus = async () => {
      const data = await mqttGetStatusESC();
      setStatusData(data);
      prevStatusData.current = data;
    };

    fetchStatus();

    socket.on("mqtt-message-esc", (newData: StatusData) => {

      Object.entries(newData).forEach(([placeId, newStandData]) => {
        const prevStandData = prevStatusData.current[placeId] || {
          tests: {},
        };


        if (
          newStandData.tests.Result &&
          newStandData.tests.Result !== prevStandData.tests.Result
        ) {
          const stand_test = newStandData.tests.Result === "‚úÖ –ü—Ä–æ–π–¥–µ–Ω";
          console.log(`Detected Result change for ${placeId}:`, {
            oldResult: prevStandData.tests.Result,
            newResult: newStandData.tests.Result,
            stand_test,
          });
        }
      });

      setStatusData(newData);
      prevStatusData.current = newData;
    });

    return () => {
      socket.off("mqtt-message-esc");
    };
  }, []);

  const handleStartTest = async (standId: string) => {
    if (!standId) {
      alert("–í–≤–µ–¥–∏—Ç–µ ID —Å—Ç–µ–Ω–¥–∞!");
      return;
    }

    try {
      await startTestESC(standId);
      setStartTestNotify(`–¢–µ—Å—Ç –¥–ª—è —Å—Ç–µ–Ω–¥–∞ ${standId} –∑–∞–ø—É—â–µ–Ω!`);
      setTimeout(() => {
        setStartTestNotify("");
      }, 5000);
    } catch (error) {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–∞");
      console.error(error);
    }
  };

  const startTestAll = async () => {

    const allIds = Object.keys(statusData);
    const allIdsWithoutHidden = allIds.filter(el_A => !hiddenRows.includes(el_A));

    if (allIds.length === 0) {
      alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–µ–Ω–¥–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞.");
      return;
    }

    setStartTestNotify("–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –Ω–∞ –≤—Å–µ—Ö —Å—Ç–µ–Ω–¥–∞—Ö...");

    for (const id of allIdsWithoutHidden) {
      await handleStartTest(id);
    }

    setStartTestNotify("‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã!");
    setTimeout(() => setStartTestNotify(""), 5000);
  };

  const handleReloadTest = async (standId: string) => {
    if (!standId) {
      alert("–í–≤–µ–¥–∏—Ç–µ ID —Å—Ç–µ–Ω–¥–∞!");
      return;
    }

    try {
      await reloadTestESC(standId);
    } catch (error) {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–µ —Ç–µ—Å—Ç–∞");
      console.error(error);
    }
  };

  const reloadAll = async () => {

    const allIds = Object.keys(statusData);
    if (allIds.length === 0) {
      alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–µ–Ω–¥–æ–≤ –¥–ª—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏.");
      return;
    }

    for (const id of allIds) {
      await handleReloadTest(id);
    }
  };


  const handleHideRow = (placeId: string) => {
    setHiddenRows((prev) => [...prev, placeId]);
  };

  const allTests = [
    "Connector",
    "Polarity",
    "Power",
    "Telemetry",
    "Motors",
    "Result",
  ];

  return (
    <div className="w-full min-h-screen bg-gradient-to-br from-gray-100/50 to-blue-50 p-4 md:p-8">
      <div className="max-w-7xl mx-auto">

        <div className="flex flex-col md:flex-row items-center justify-center gap-4 mb-8 p-6 bg-white/80 rounded-2xl shadow-xl backdrop-blur-sm border border-white">
          <div className="flex items-center gap-4 flex-wrap justify-center">
            <h2 className="text-4xl font-extrabold text-gray-800 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-800">
              –ü—Ä–æ–≤–µ—Ä–∫–∞ ESC
            </h2>
            <div className="flex items-center gap-2">
              <img
                src={ESC1}
                alt="FC Icon"
                className="w-14 h-14 object-contain transition-transform hover:scale-110"
              />
              <img
                src={ESC2}
                alt="FC Icon"
                className="w-14 h-14 object-contain transition-transform hover:scale-110"
              />
            </div>
            <h2 className="text-4xl font-extrabold text-gray-800">
              –Ω–∞ —Å—Ç–µ–Ω–¥–∞—Ö
            </h2>
            <div className="flex items-center gap-2">
              <img
                src={standESC1}
                alt="Stand Icon"
                className="w-28 h-40 object-contain hover:rotate-1 transition-transform"
              />
              <img
                src={standESC2}
                alt="Stand Icon"
                className="w-40 h-28 object-contain hover:-rotate-1 transition-transform"
              />
            </div>
          </div>
        </div>


        {startTestNotify && (
          <div className="mb-8 animate-fade-in">
            <div className="bg-indigo-600 text-white px-6 py-4 rounded-xl shadow-lg flex items-center justify-center gap-3">
              <svg
                className="w-6 h-6 animate-spin"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              <span className="text-xl font-semibold">{startTestNotify}</span>
            </div>
          </div>
        )}


        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
          <button
            className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex items-center justify-center gap-2"
            onClick={startTestAll}
          >
            <svg
              className="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
            –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç –Ω–∞ –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–µ–Ω–¥–∞—Ö
          </button>

          <button
            className="bg-gradient-to-r from-red-500 to-rose-600 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex items-center justify-center gap-2"
            onClick={reloadAll}
          >
            <svg
              className="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
          </button>
        </div>


        <div className="w-full overflow-hidden rounded-2xl shadow-2xl bg-white/90 backdrop-blur-sm border border-white">
          <table className="w-full border-collapse">
            <thead>
              <tr className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white">
                <th className="p-4 text-left rounded-tl-2xl">PlaceID</th>
                {allTests.map((test) => (
                  <th key={test} className="p-4 text-left">
                    <div className="flex items-center gap-2">{test}</div>
                  </th>
                ))}
                <th className="p-4 text-left rounded-tr-2xl">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody>
              {Object.entries(statusData)
                .filter(([placeId]) => !hiddenRows.includes(placeId))
                .map(([placeId, data]) => (
                  <tr
                    key={placeId}
                    className={`border-t border-gray-200 transition-all duration-200 hover:bg-gray-50/80 ${
                      data.tests.Result === "‚úÖ –ü—Ä–æ–π–¥–µ–Ω"
                        ? "bg-green-200 hover:bg-green-500 transition-colors"
                        : data.tests.Result === "‚ùå –û—à–∏–±–∫–∞"
                        ? "animate-pulse bg-red-300   hover:bg-red-500 transition-colors"
                        : " bg-gray-50 hover:bg-gray-100"
                    }`}
                  >
                    <td className="p-4 flex items-center gap-3">
                      <button
                        onClick={() => handleReloadTest(placeId)}
                        className="p-2 rounded-lg bg-white shadow hover:bg-gray-100 transition-colors border border-gray-200 hover:border-blue-300 group"
                        title="–æ—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ç–µ–Ω–¥–∞"
                      >
                        <BrushIcon
                          className="text-rose-500 group-hover:text-rose-700 transition-colors"
                          strokeWidth={1.5}
                        />
                      </button>
                      <span className="font-medium text-gray-800">
                        {placeId || "‚Äî"}
                      </span>
                      <button
                        onClick={() => handleStartTest(placeId)}
                        title="–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞ —Å—Ç–µ–Ω–¥–µ ${placeId} "
                        className="ml-auto px-4 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-colors flex items-center gap-2"
                      >
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M13 10V3L4 14h7v7l9-11h-7z"
                          />
                        </svg>
                        –¢–µ—Å—Ç
                      </button>
                    </td>

                    {allTests.map((test) => (
                      <td key={test} className="p-4">
                        <div
                          className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                            data.tests[test] === "‚úÖ –ü—Ä–æ–π–¥–µ–Ω"
                              ? "bg-green-100 text-green-800"
                              : data.tests[test] === "‚ùå –û—à–∏–±–∫–∞"
                              ? "bg-rose-100 text-rose-800"
                              : "bg-gray-100 text-gray-800"
                          }`}
                        >
                          {data.tests[test] || "‚Äî"}
                        </div>
                      </td>
                    ))}

                    <td className="p-4">
                      <button
                        onClick={() => handleHideRow(placeId)}
                        className="p-2 text-gray-500 hover:text-rose-600 transition-colors hover:bg-rose-50 rounded-lg"
                        title="–°–∫—Ä—ã—Ç—å —Å—Ç—Ä–æ–∫—É"
                      >
                        <CircleXIcon className="w-5 h-5" />
                      </button>
                    </td>
                  </tr>
                ))}
            </tbody>
          </table>
        </div>


        <div className="mt-6 text-center text-sm text-gray-500">
          <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ESC –Ω–∞ —Å—Ç–µ–Ω–¥–∞—Ö</p>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/MqttCheck/MqttCheckFC.tsx
================================================================================

import { useState, useEffect, useRef } from "react";
import io from "socket.io-client";
import { mqttGetStatus, reloadTestFC, startTestFC } from "src/api/mqttApi";
import FC1 from "assets/images/FC1.png";
import FC2 from "assets/images/FC2.png";
import standFC from "assets/images/standFC.png";
import { CircleXIcon } from "lucide-react";
import { changeStandTestResult } from "src/api/fcApi";


interface Tests {
  [key: string]: string;
}


interface StandData {
  tests: Tests;
  fc_id: string | null;
}


interface StatusData {
  [placeId: string]: StandData;
}

const socket = io(import.meta.env.VITE_MQTT_API_URL);

export const MqttCheckFC: React.FC = () => {
  const [statusData, setStatusData] = useState<StatusData>({});
  const prevStatusData = useRef<StatusData>({});

  const [standId, setStandId] = useState("");
  const [hiddenRows, setHiddenRows] = useState<string[]>([]);
  const [startTestNotify, setStartTestNotify] = useState("");


  const hasConnectionError = Object.values(statusData).some(
    (data: StandData) => data.tests["FC Connection"] === "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
  );

  useEffect(() => {
    const fetchStatus = async () => {
      const data = await mqttGetStatus();
      setStatusData(data);
      prevStatusData.current = data;
    };

    fetchStatus();

    socket.on("mqtt-message", (newData: StatusData) => {

      Object.entries(newData).forEach(([placeId, newStandData]) => {
        const prevStandData = prevStatusData.current[placeId] || {
          tests: {},
          fc_id: null,
        };


        if (
          newStandData.tests.Result &&
          newStandData.tests.Result !== prevStandData.tests.Result
        ) {
          const stand_test = newStandData.tests.Result === "‚úÖ –ü—Ä–æ–π–¥–µ–Ω";
          console.log(`Detected Result change for ${placeId}:`, {
            oldResult: prevStandData.tests.Result,
            newResult: newStandData.tests.Result,
            stand_test,
            fc_id: newStandData.fc_id,
          });

          if (newStandData.fc_id) {
            const sessionId = Number(localStorage.getItem("sessionID"));
            changeStandTestResult(newStandData.fc_id, sessionId, stand_test)
              .then(() => console.log(`Status updated for ${placeId}`))
              .catch((err) =>
                console.error(`Update error for ${placeId}:`, err)
              );
          }
        }
      });

      setStatusData(newData);
      prevStatusData.current = newData;
    });

    return () => {
      socket.off("mqtt-message");
    };
  }, []);

  const handleStartTest = async () => {
    if (!standId) {
      alert("–í–≤–µ–¥–∏—Ç–µ ID —Å—Ç–µ–Ω–¥–∞!");
      return;
    }

    try {
      await startTestFC(standId);
      setStartTestNotify(`–¢–µ—Å—Ç –¥–ª—è —Å—Ç–µ–Ω–¥–∞ ${standId} –∑–∞–ø—É—â–µ–Ω!`);
      setTimeout(() => {
        setStartTestNotify("");
      }, 5000);
    } catch (error) {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–∞");
      console.error(error);
    }
  };
  const handleReloadTest = async () => {
    if (!standId) {
      alert("–í–≤–µ–¥–∏—Ç–µ ID —Å—Ç–µ–Ω–¥–∞!");
      return;
    }

    try {
      await reloadTestFC(standId);
    } catch (error) {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–µ —Ç–µ—Å—Ç–∞");
      console.error(error);
    }
  };


  const handleHideRow = (placeId: string) => {
    setHiddenRows((prev) => [...prev, placeId]);
  };

  const allTests = [
    "UID",
    "FONT",
    "PRECONFIG",
    "Power",
    "Buzzer",
    "Boot",
    "UARTs",
    "Analog",
    "Motors",
    "OSD",
    "IMU",
    "Baro",
    "PinIO",
    "Config",
    "POSTCONFIG",
    "Result",
  ];

  return (
    <div className="w-full min-h-screen bg-gray-100/50 p-8">
      <div className="mx-auto">

        <div className="flex items-center justify-center space-x-4 mb-8">
          <h2 className="text-3xl font-bold text-gray-800">–ü—Ä–æ–≤–µ—Ä–∫–∞ FC</h2>
          <img src={FC1} alt="FC Icon" className="w-16 h-16" />
          <img src={FC2} alt="FC Icon" className="w-16 h-16" />
          <h2 className="text-3xl font-bold text-gray-800">–Ω–∞ —Å—Ç–µ–Ω–¥–∞—Ö</h2>
          <img src={standFC} alt="Stand Icon" className="w-32 h-48" />
        </div>
        <h2 className="text-3xl animate-bounce font-bold text-gray-800">
          {startTestNotify}
        </h2>


        <div className="flex space-x-4 mb-6">
          <input
            type="text"
            className="border p-2 rounded w-full shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å—Ç–µ–Ω–¥–∞"
            value={standId}
            onChange={(e) => setStandId(e.target.value)}
          />
          <button
            className="bg-blue-500 text-white px-6 py-2 rounded shadow-lg hover:bg-blue-600 transition-colors"
            onClick={handleStartTest}
          >
            –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç
          </button>
          <button
            className="bg-red-500 text-white px-6 py-2 rounded shadow-lg hover:bg-red-700 transition-colors"
            onClick={handleReloadTest}
          >
            –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞
          </button>
        </div>


        <div className="w-full overflow-x-auto shadow-lg rounded-lg">
          <table className="w-full border-collapse">
            <thead>
              <tr className="bg-blue-500 text-white">
                <th className="border p-3">PlaceID</th>
                <th className="border p-3">FC ID</th>

                {hasConnectionError && (
                  <th className="border p-3">–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è FC</th>
                )}
                {allTests.map((test) => (
                  <th key={test} className="border p-3">
                    {test}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {Object.entries(statusData)
                .filter(([placeId]) => !hiddenRows.includes(placeId))
                .map(([placeId, data]) => (
                  <tr
                    key={placeId}
                    className={
                      data.tests.Result === "‚úÖ –ü—Ä–æ–π–¥–µ–Ω"
                        ? "bg-green-200   hover:bg-green-500 transition-colors"
                        : data.tests.Result === "‚ùå –û—à–∏–±–∫–∞"
                        ? "animate-pulse bg-red-300   hover:bg-red-500 transition-colors"
                        : " bg-neutral-200   hover:bg-gray-500 transition-colors"
                    }
                  >
                    <td className="border border-sky-500 p-3">{placeId}</td>
                    <td className="border border-sky-500 p-3">
                      {hasConnectionError && (
                        <div
                          className={`${
                            data.tests["FC Connection"] ===
                            "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
                              ? "animate-pulse bg-red-200"
                              : ""
                          }`}
                        >
                          {data.tests["FC Connection"] || ""}
                        </div>
                      )}

                      {data.fc_id || "‚Äî"}
                    </td>


                    {allTests.map((test) => (
                      <td key={test} className="border border-sky-500 p-3">
                        {data.tests[test] || "‚Äî"}
                      </td>
                    ))}


                    <td className="border border-sky-500 p-3">
                      <button
                        className="bg-red-500 text-white px-1 py-1 rounded hover:bg-red-800 transition-colors"
                        onClick={() => handleHideRow(placeId)}
                      >
                        {<CircleXIcon />}
                      </button>
                    </td>
                  </tr>
                ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/PCs/OnePC.tsx
================================================================================

import clsx from "clsx";

interface OnePCProps {
  active: boolean;
  onClick: () => void;
  PCname: string;
  IP: string;
  userName: string;
  userSurname: string;
}

export const OnePC: React.FC<OnePCProps> = ({
  active,
  onClick,
  PCname,
  IP,
  userName,
  userSurname
}) => {
  return (
    <div className="flex justify-center items-center">
      <div
        className={clsx(
          "p-3 rounded-lg shadow-md mb-2 border-l-4 transition duration-200 w-1/3",
          active
            ? "bg-red-500 text-white border-red-700 pointer-events-none opacity-70"
            : "bg-gray-100 text-gray-800 border-emerald-500 hover:bg-gray-400 cursor-pointer"
        )}
        onClick={!active ? onClick : undefined}
      >
        <p className="text-lg font-semibold">{PCname}</p>
        <p className="text-sm">{IP}</p>

        {active && (
          <p className="text-xs font-semibold mt-2 bg-red-700 px-2 py-1 rounded-md text-center">
            –ü–ö –∑–∞–Ω—è—Ç {userName} {userSurname}
          </p>
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/PCs/SelectPC.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect, useMemo, useState } from "react";
import { Context } from "src/main";
import {
  fetchPC,
  fetchSession,
  fetchUsers,
  setSessionOnline,
} from "src/api/fcApi";
import { pcModelFull } from "src/types/PCModel";
import { SessionModelFull } from "src/types/SessionModel";
import { useNavigate } from "react-router-dom";
import { START_ROUTE } from "src/utils/consts";
import { userGetModel } from "src/types/UserModel";
import { Monitor, Search, MapPin, User, Lock, Wifi, Laptop } from "lucide-react";

export const SelectPC: React.FC = observer(() => {
  const context = useContext(Context);
  const navigate = useNavigate();
  const [searchTerm, setSearchTerm] = useState("");

  if (!context) throw new Error("Context required");
  const { flightController, user } = context;

  useEffect(() => {

    if (!user.isAuth) return;

    const loadData = async () => {

      try {
        const [pcs, sessions] = await Promise.all([fetchPC(), fetchSession()]);
        flightController.setPCs(pcs);
        flightController.setSessions(sessions);
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –ü–ö:", error);
      }


      try {
        const users = await fetchUsers();
        flightController.setUsers(users);
      } catch (error) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–æ–∑–º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –ø—Ä–∞–≤–∞):", error);
      }
    };

    loadData();
  }, [user.isAuth]);


  const getActiveSessionInfo = (pcId: number) => {
    const session = flightController.sessions.find(
      (s: SessionModelFull) => s.online === true && s.PCId === pcId
    );

    if (!session) return null;

    const sessionUser = flightController.users.find(
      (u: userGetModel) => u.id === session.userId
    );


    return sessionUser
      ? { name: sessionUser.name, surname: sessionUser.surname }
      : { name: "–°–æ—Ç—Ä—É–¥–Ω–∏–∫", surname: `ID: ${session.userId}` };
  };


  const handleSelectPC = async (pcId: number | null) => {
    const userIdStr = localStorage.getItem("userID");
    if (!userIdStr) {
        alert("–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–π—Ç–∏ (F5).");
        return;
    }
    const userId = Number(userIdStr);

    try {
        await setSessionOnline(true, userId, pcId);
        navigate(START_ROUTE);
    } catch (error: any) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ü–ö:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ.");
    }
  };


  const groupedPCs = useMemo(() => {
    const filtered = flightController.PCs.filter(pc =>
        pc.pc_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        pc.ip.includes(searchTerm) ||
        pc.cabinet?.toLowerCase().includes(searchTerm.toLowerCase())
    );

    const groups: Record<string, pcModelFull[]> = {};

    filtered.forEach(pc => {
        const cab = pc.cabinet || "–ë–µ–∑ –∫–∞–±–∏–Ω–µ—Ç–∞";
        if (!groups[cab]) groups[cab] = [];
        groups[cab].push(pc);
    });

    return groups;
  }, [flightController.PCs, searchTerm]);

  return (
    <div className="min-h-screen bg-slate-50 relative overflow-hidden font-sans flex flex-col">


      <div className="absolute inset-0 z-0 pointer-events-none">
          <div className="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]"></div>
          <div className="absolute left-0 right-0 top-0 -z-10 m-auto h-[500px] w-[500px] rounded-full bg-blue-400 opacity-10 blur-[120px]"></div>
      </div>

      <div className="relative z-10 container mx-auto px-4 py-8 flex flex-col h-screen">


        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 className="text-3xl font-extrabold text-slate-800 flex items-center gap-3">
                    <Monitor className="text-indigo-600" size={32}/>
                    –†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ
                </h1>
                <p className="text-slate-500">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã</p>
            </div>


            <div className="relative w-full md:w-96">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Search className="text-gray-400" size={20}/>
                </div>
                <input
                    type="text"
                    className="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 transition shadow-sm"
                    placeholder="–ù–∞–π—Ç–∏ –ü–ö –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ IP..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                />
            </div>
        </div>


        <div className="mb-8 animate-fadeIn">
            <button
                onClick={() => handleSelectPC(null)}
                className="w-full md:w-auto flex items-center justify-center gap-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all group border border-purple-400"
            >
                <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm group-hover:bg-white/30 transition">
                    <Laptop size={32} />
                </div>
                <div className="text-left">
                    <h3 className="font-bold text-lg">–Ø –Ω–∞ –ª–∏—á–Ω–æ–º –Ω–æ—É—Ç–±—É–∫–µ</h3>
                    <p className="text-purple-100 text-sm">–†–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ–º—É –ü–ö</p>
                </div>
            </button>
        </div>


        <div className="flex-1 overflow-y-auto pr-2 pb-10 custom-scrollbar">


            {localStorage.getItem("pcID") && (
                 <div className="mb-8 p-4 bg-yellow-50 border border-yellow-200 rounded-xl flex items-start gap-3 animate-fadeIn">
                     <div className="p-2 bg-yellow-100 rounded-full text-yellow-600">
                         <Lock size={20}/>
                     </div>
                     <div>
                         <h3 className="font-bold text-yellow-800">–í–Ω–∏–º–∞–Ω–∏–µ</h3>
                         <p className="text-sm text-yellow-700">
                             –£ –≤–∞—Å —É–∂–µ –≤—ã–±—Ä–∞–Ω –ü–ö –≤ –ø—Ä–æ—à–ª–æ–π —Å–µ—Å—Å–∏–∏. –ß—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å –µ–≥–æ, –≤—ã–π–¥–∏—Ç–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏ –∑–∞–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.
                         </p>
                     </div>
                 </div>
            )}

            {Object.keys(groupedPCs).length === 0 ? (
                <div className="text-center py-20 text-gray-400">
                    –ö–æ–º–ø—å—é—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è)
                </div>
            ) : (
                Object.entries(groupedPCs).map(([cabinet, pcs]) => (
                    <div key={cabinet} className="mb-8">
                        <div className="flex items-center gap-2 mb-4 px-2">
                            <MapPin className="text-indigo-500" size={18}/>
                            <h2 className="text-lg font-bold text-gray-700 uppercase tracking-wide">
                                {cabinet}
                            </h2>
                            <span className="text-xs font-medium bg-gray-100 text-gray-500 px-2 py-1 rounded-full">
                                {pcs.length} —à—Ç.
                            </span>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                            {pcs.map(pc => {
                                const activeUser = getActiveSessionInfo(pc.id);
                                const isOccupied = !!activeUser;
                                const isMyPC = localStorage.getItem("pcID") === String(pc.id);

                                return (
                                    <button
                                        key={pc.id}
                                        disabled={isOccupied}
                                        onClick={() => handleSelectPC(pc.id)}
                                        className={`relative group text-left p-4 rounded-2xl border transition-all duration-200 flex flex-col gap-3
                                            ${isOccupied
                                                ? "bg-slate-50 border-slate-200 opacity-80 cursor-not-allowed"
                                                : "bg-white border-slate-200 hover:border-indigo-400 hover:shadow-lg hover:-translate-y-1 cursor-pointer"
                                            }
                                            ${isMyPC ? "ring-2 ring-indigo-500 border-indigo-500 bg-indigo-50" : ""}
                                        `}
                                    >
                                        <div className="flex justify-between items-start">
                                            <div className={`p-2.5 rounded-xl ${isOccupied ? "bg-red-100 text-red-500" : "bg-emerald-100 text-emerald-600"}`}>
                                                <Monitor size={22} strokeWidth={2}/>
                                            </div>
                                            {isOccupied ? (
                                                <span className="px-2 py-1 bg-red-50 text-red-600 text-[10px] font-bold uppercase rounded-md border border-red-100">
                                                    –ó–∞–Ω—è—Ç
                                                </span>
                                            ) : (
                                                <span className="px-2 py-1 bg-emerald-50 text-emerald-600 text-[10px] font-bold uppercase rounded-md border border-emerald-100">
                                                    –°–≤–æ–±–æ–¥–µ–Ω
                                                </span>
                                            )}
                                        </div>

                                        <div>
                                            <h3 className="font-bold text-slate-800 text-lg leading-tight truncate" title={pc.pc_name}>
                                                {pc.pc_name}
                                            </h3>
                                            <div className="flex items-center gap-1.5 mt-1 text-xs text-slate-500 font-mono">
                                                <Wifi size={12}/> {pc.ip}
                                            </div>
                                        </div>

                                        {isOccupied && (
                                            <div className="mt-auto pt-3 border-t border-slate-100 flex items-center gap-2">
                                                <div className="w-6 h-6 rounded-full bg-red-100 flex items-center justify-center text-red-600 text-xs font-bold">
                                                    <User size={12}/>
                                                </div>
                                                <div className="text-xs font-medium text-slate-600 truncate">
                                                    {activeUser.name} {activeUser.surname}
                                                </div>
                                            </div>
                                        )}

                                        {!isOccupied && (
                                            <div className="mt-auto pt-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                 <div className="w-full py-1.5 bg-indigo-600 text-white text-xs font-bold text-center rounded-lg">
                                                     –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –ü–ö
                                                 </div>
                                            </div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                ))
            )}
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Production/ProductionPage.tsx
================================================================================



import React, { useState, useEffect } from "react";
import { useSearchParams } from "react-router-dom";
import {
    PlusCircle, CheckSquare, BookOpen, Table2, Settings,
    Factory
} from "lucide-react";

import ProductionEntry from "./tabs/ProductionEntry";
import ProductionApproval from "./tabs/ProductionApproval";
import ProductionJournal from "./tabs/ProductionJournal";
import ProductionMatrix from "./tabs/ProductionMatrix";
import ProductionSettings from "./tabs/ProductionSettings";

type TabId = 'entry' | 'approval' | 'journal' | 'matrix' | 'settings';

interface Tab {
    id: TabId;
    label: string;
    icon: React.ElementType;
    component: React.ComponentType;
}

const tabs: Tab[] = [
    { id: 'entry', label: '–í–≤–æ–¥', icon: PlusCircle, component: ProductionEntry },
    { id: 'approval', label: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ', icon: CheckSquare, component: ProductionApproval },
    { id: 'journal', label: '–ñ—É—Ä–Ω–∞–ª', icon: BookOpen, component: ProductionJournal },
    { id: 'matrix', label: '–¢–∞–±–ª–∏—Ü–∞', icon: Table2, component: ProductionMatrix },
    { id: 'settings', label: '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏', icon: Settings, component: ProductionSettings },
];

const ProductionPage: React.FC = () => {
    const [searchParams, setSearchParams] = useSearchParams();
    const tabFromUrl = searchParams.get('tab') as TabId | null;

    const [activeTab, setActiveTab] = useState<TabId>(
        tabFromUrl && tabs.some(t => t.id === tabFromUrl) ? tabFromUrl : 'entry'
    );


    useEffect(() => {
        if (tabFromUrl !== activeTab) {
            setSearchParams({ tab: activeTab });
        }
    }, [activeTab]);

    useEffect(() => {
        if (tabFromUrl && tabs.some(t => t.id === tabFromUrl) && tabFromUrl !== activeTab) {
            setActiveTab(tabFromUrl);
        }
    }, [tabFromUrl]);

    const ActiveComponent = tabs.find(t => t.id === activeTab)?.component || ProductionEntry;

    return (
        <div className="min-h-screen bg-gray-50 p-4 md:p-6">
            <div className="max-w-[1600px] mx-auto">


                <div className="mb-6">
                    <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-3">
                        <div className="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                            <Factory size={22} className="text-white" />
                        </div>
                        –£—á—ë—Ç –≤—ã—Ä–∞–±–æ—Ç–∫–∏
                    </h1>
                    <p className="text-gray-500 mt-1 ml-13">
                        –í–Ω–µ—Å–µ–Ω–∏–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
                    </p>
                </div>


                <div className="bg-white rounded-xl shadow-sm border border-gray-100 mb-6">
                    <div className="flex overflow-x-auto">
                        {tabs.map(tab => {
                            const isActive = activeTab === tab.id;
                            const Icon = tab.icon;

                            return (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex items-center gap-2 px-5 py-4 text-sm font-medium whitespace-nowrap border-b-2 transition-all ${
                                        isActive
                                            ? 'border-emerald-500 text-emerald-700 bg-emerald-50/50'
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                                    }`}
                                >
                                    <Icon size={18} className={isActive ? 'text-emerald-600' : 'text-gray-400'} />
                                    {tab.label}
                                </button>
                            );
                        })}
                    </div>
                </div>


                <ActiveComponent />
            </div>
        </div>
    );
};

export default ProductionPage;

================================================================================
FILE: QMS-Client-main/src/pages/Production/tabs/ProductionApproval.tsx
================================================================================



import React, { useState, useEffect, useContext, useMemo } from "react";
import {
    CheckCircle2, XCircle, Clock, ChevronDown, ChevronRight,
    User, Calendar, Hash, Edit3, AlertTriangle, Filter,
    FolderKanban, Settings2, Users
} from "lucide-react";
import toast from "react-hot-toast";
import { Context } from "src/main";
import { observer } from "mobx-react-lite";

import {
    fetchPendingOutputs,
    approveOutputs,
    rejectOutputs,
    ProductionOutput,
    formatUserName,
    formatDate,
    formatShortDate
} from "src/api/productionApi";

import { fetchStructure } from "src/api/structureApi";

interface GroupedOutputs {
    date: string;
    outputs: ProductionOutput[];
    totalClaimed: number;
}

export const ProductionApproval: React.FC = observer(() => {
    const context = useContext(Context);
    const currentUser = context?.user?.user;


    const [outputs, setOutputs] = useState<ProductionOutput[]>([]);
    const [loading, setLoading] = useState(true);


    const [teams, setTeams] = useState<Array<{ id: number; title: string }>>([]);
    const [sections, setSections] = useState<Array<{ id: number; title: string }>>([]);
    const [filterTeamId, setFilterTeamId] = useState<number | null>(null);
    const [filterSectionId, setFilterSectionId] = useState<number | null>(null);


    const [selectedIds, setSelectedIds] = useState<Set<number>>(new Set());
    const [expandedDates, setExpandedDates] = useState<Set<string>>(new Set());
    const [adjustments, setAdjustments] = useState<Record<number, number>>({});
    const [editingId, setEditingId] = useState<number | null>(null);
    const [rejectReason, setRejectReason] = useState("");
    const [showRejectModal, setShowRejectModal] = useState(false);


    useEffect(() => {
        loadData();
        loadStructure();
    }, [filterTeamId, filterSectionId]);

    const loadData = async () => {
        setLoading(true);
        try {
            const data = await fetchPendingOutputs({
                teamId: filterTeamId || undefined,
                sectionId: filterSectionId || undefined
            });
            setOutputs(data);


            const dates = new Set(data.map(o => o.date));
            setExpandedDates(dates);
        } catch (e) {
            console.error(e);
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
        } finally {
            setLoading(false);
        }
    };

    const loadStructure = async () => {
        try {
            const structure = await fetchStructure();
            setSections(structure.sections || []);

            const allTeams: Array<{ id: number; title: string }> = [];
            structure.sections?.forEach((s: any) => {
                s.teams?.forEach((t: any) => {
                    allTeams.push({ id: t.id, title: `${t.title} (${s.title})` });
                });
            });
            setTeams(allTeams);
        } catch (e) {
            console.error(e);
        }
    };


    const groupedOutputs = useMemo((): GroupedOutputs[] => {
        const map = new Map<string, ProductionOutput[]>();

        outputs.forEach(o => {
            const list = map.get(o.date) || [];
            list.push(o);
            map.set(o.date, list);
        });

        return Array.from(map.entries())
            .map(([date, list]) => ({
                date,
                outputs: list.sort((a, b) => (a.user?.surname || '').localeCompare(b.user?.surname || '')),
                totalClaimed: list.reduce((sum, o) => sum + o.claimedQty, 0)
            }))
            .sort((a, b) => b.date.localeCompare(a.date));
    }, [outputs]);


    const toggleSelect = (id: number) => {
        const newSet = new Set(selectedIds);
        if (newSet.has(id)) {
            newSet.delete(id);
        } else {
            newSet.add(id);
        }
        setSelectedIds(newSet);
    };

    const toggleSelectAll = (date: string, outputsForDate: ProductionOutput[]) => {
        const ids = outputsForDate.map(o => o.id);
        const allSelected = ids.every(id => selectedIds.has(id));

        const newSet = new Set(selectedIds);
        if (allSelected) {
            ids.forEach(id => newSet.delete(id));
        } else {
            ids.forEach(id => newSet.add(id));
        }
        setSelectedIds(newSet);
    };

    const toggleExpand = (date: string) => {
        const newSet = new Set(expandedDates);
        if (newSet.has(date)) {
            newSet.delete(date);
        } else {
            newSet.add(date);
        }
        setExpandedDates(newSet);
    };


    const handleApprove = async () => {
        if (selectedIds.size === 0) {
            toast.error("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å–∏");
            return;
        }

        try {
            const result = await approveOutputs(
                Array.from(selectedIds),
                Object.keys(adjustments).length > 0 ? adjustments : undefined
            );

            const successCount = result.results.filter(r => !r.error).length;
            toast.success(`–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: ${successCount}`);

            setSelectedIds(new Set());
            setAdjustments({});
            loadData();
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
        }
    };

    const handleReject = async () => {
        if (selectedIds.size === 0) {
            toast.error("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å–∏");
            return;
        }

        try {
            const result = await rejectOutputs(
                Array.from(selectedIds),
                rejectReason || undefined
            );

            const successCount = result.results.filter(r => !r.error).length;
            toast.success(`–û—Ç–∫–ª–æ–Ω–µ–Ω–æ: ${successCount}`);

            setSelectedIds(new Set());
            setRejectReason("");
            setShowRejectModal(false);
            loadData();
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
        }
    };

    const handleAdjustment = (id: number, value: number) => {
        setAdjustments(prev => ({
            ...prev,
            [id]: value
        }));
    };


    return (
        <div className="space-y-4">


            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div className="flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <Clock size={20} className="text-yellow-500" />
                            –û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                        </h2>
                        <p className="text-sm text-gray-500">
                            {outputs.length} –∑–∞–ø–∏—Å–µ–π –Ω–∞ {groupedOutputs.length} –¥–∞—Ç
                        </p>
                    </div>


                    <div className="flex items-center gap-3">
                        <Filter size={16} className="text-gray-400" />

                        <select
                            value={filterSectionId || ""}
                            onChange={(e) => {
                                setFilterSectionId(Number(e.target.value) || null);
                                setFilterTeamId(null);
                            }}
                            className="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500"
                        >
                            <option value="">–í—Å–µ —É—á–∞—Å—Ç–∫–∏</option>
                            {sections.map(s => (
                                <option key={s.id} value={s.id}>{s.title}</option>
                            ))}
                        </select>

                        <select
                            value={filterTeamId || ""}
                            onChange={(e) => setFilterTeamId(Number(e.target.value) || null)}
                            className="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500"
                        >
                            <option value="">–í—Å–µ –±—Ä–∏–≥–∞–¥—ã</option>
                            {teams.map(t => (
                                <option key={t.id} value={t.id}>{t.title}</option>
                            ))}
                        </select>
                    </div>
                </div>
            </div>


            {selectedIds.size > 0 && (
                <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4 flex items-center justify-between">
                    <span className="text-emerald-800 font-medium">
                        –í—ã–±—Ä–∞–Ω–æ: {selectedIds.size}
                    </span>
                    <div className="flex gap-2">
                        <button
                            onClick={handleApprove}
                            className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium flex items-center gap-2 transition"
                        >
                            <CheckCircle2 size={18} />
                            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                        </button>
                        <button
                            onClick={() => setShowRejectModal(true)}
                            className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium flex items-center gap-2 transition"
                        >
                            <XCircle size={18} />
                            –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            )}


            {loading ? (
                <div className="bg-white rounded-xl p-8 text-center text-gray-400">
                    <Clock size={40} className="mx-auto mb-2 animate-spin" />
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            ) : groupedOutputs.length === 0 ? (
                <div className="bg-white rounded-xl p-8 text-center text-gray-400">
                    <CheckCircle2 size={48} className="mx-auto mb-3 text-emerald-300" />
                    <p className="text-lg font-medium">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
                    <p className="text-sm">–í—Å–µ –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã</p>
                </div>
            ) : (
                <div className="space-y-3">
                    {groupedOutputs.map(group => (
                        <div key={group.date} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">


                            <div
                                className="px-4 py-3 bg-gray-50 border-b border-gray-100 flex items-center justify-between cursor-pointer hover:bg-gray-100 transition"
                                onClick={() => toggleExpand(group.date)}
                            >
                                <div className="flex items-center gap-3">
                                    {expandedDates.has(group.date)
                                        ? <ChevronDown size={20} className="text-gray-400" />
                                        : <ChevronRight size={20} className="text-gray-400" />
                                    }
                                    <Calendar size={16} className="text-gray-400" />
                                    <span className="font-bold text-gray-800">
                                        {formatDate(group.date)}
                                    </span>
                                    <span className="text-sm text-gray-500">
                                        ({group.outputs.length} –∑–∞–ø–∏—Å–µ–π)
                                    </span>
                                </div>
                                <div className="flex items-center gap-4">
                                    <span className="text-lg font-bold text-emerald-600">
                                        {group.totalClaimed} —à—Ç
                                    </span>
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            toggleSelectAll(group.date, group.outputs);
                                        }}
                                        className="text-sm text-blue-600 hover:text-blue-800"
                                    >
                                        {group.outputs.every(o => selectedIds.has(o.id))
                                            ? "–°–Ω—è—Ç—å –≤—Å–µ"
                                            : "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
                                        }
                                    </button>
                                </div>
                            </div>


                            {expandedDates.has(group.date) && (
                                <div className="divide-y divide-gray-50">
                                    {group.outputs.map(output => (
                                        <div
                                            key={output.id}
                                            className={`px-4 py-3 flex items-center gap-4 hover:bg-gray-50 transition ${
                                                selectedIds.has(output.id) ? 'bg-emerald-50' : ''
                                            }`}
                                        >

                                            <input
                                                type="checkbox"
                                                checked={selectedIds.has(output.id)}
                                                onChange={() => toggleSelect(output.id)}
                                                className="w-5 h-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
                                            />


                                            <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                                {output.user?.img ? (
                                                    <img
                                                        src={`${import.meta.env.VITE_API_URL}/${output.user.img}`}
                                                        alt=""
                                                        className="w-full h-full object-cover"
                                                    />
                                                ) : (
                                                    <User size={20} className="text-gray-400" />
                                                )}
                                            </div>


                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-medium text-gray-800">
                                                        {formatUserName(output.user)}
                                                    </span>
                                                    {output.team && (
                                                        <span className="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded">
                                                            {output.team.title}
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="flex items-center gap-3 mt-1 text-sm text-gray-500">
                                                    {output.operationType && (
                                                        <span className="flex items-center gap-1">
                                                            <Settings2 size={12} />
                                                            {output.operationType.name}
                                                        </span>
                                                    )}
                                                    {output.project && (
                                                        <span className="flex items-center gap-1">
                                                            <FolderKanban size={12} />
                                                            {output.project.title}
                                                        </span>
                                                    )}
                                                </div>
                                                {output.comment && (
                                                    <p className="text-xs text-gray-400 mt-1 truncate">
                                                        {output.comment}
                                                    </p>
                                                )}
                                            </div>


                                            <div className="text-right">
                                                {editingId === output.id ? (
                                                    <input
                                                        type="number"
                                                        value={adjustments[output.id] ?? output.claimedQty}
                                                        onChange={(e) => handleAdjustment(output.id, Number(e.target.value))}
                                                        onBlur={() => setEditingId(null)}
                                                        autoFocus
                                                        className="w-20 px-2 py-1 border border-emerald-300 rounded text-right font-bold"
                                                    />
                                                ) : (
                                                    <div
                                                        className="flex items-center gap-2 cursor-pointer group"
                                                        onClick={() => setEditingId(output.id)}
                                                    >
                                                        <span className={`text-xl font-bold ${
                                                            adjustments[output.id] !== undefined && adjustments[output.id] !== output.claimedQty
                                                                ? 'text-blue-600'
                                                                : 'text-gray-800'
                                                        }`}>
                                                            {adjustments[output.id] ?? output.claimedQty}
                                                        </span>
                                                        <Edit3 size={14} className="text-gray-300 group-hover:text-gray-500" />
                                                    </div>
                                                )}
                                                {adjustments[output.id] !== undefined && adjustments[output.id] !== output.claimedQty && (
                                                    <p className="text-xs text-gray-400 line-through">
                                                        –±—ã–ª–æ: {output.claimedQty}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            )}


            {showRejectModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                            <AlertTriangle size={20} className="text-red-500" />
                            –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø–∏—Å–∏
                        </h3>

                        <p className="text-sm text-gray-600 mb-4">
                            –ë—É–¥–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ: {selectedIds.size} –∑–∞–ø–∏—Å–µ–π
                        </p>

                        <textarea
                            value={rejectReason}
                            onChange={(e) => setRejectReason(e.target.value)}
                            placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
                            rows={3}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg mb-4 resize-none"
                        />

                        <div className="flex justify-end gap-2">
                            <button
                                onClick={() => setShowRejectModal(false)}
                                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                            >
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button
                                onClick={handleReject}
                                className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium"
                            >
                                –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
});

export default ProductionApproval;

================================================================================
FILE: QMS-Client-main/src/pages/Production/tabs/ProductionEntry.tsx
================================================================================



import React, { useState, useEffect, useContext, useMemo } from "react";
import {
    Calendar, User, Hash, MessageSquare, Save,
    Plus, RotateCcw, CheckCircle2, Clock, FolderKanban,
    ClipboardList, Settings2, Users
} from "lucide-react";
import toast from "react-hot-toast";
import { Context } from "src/main";
import { observer } from "mobx-react-lite";

import {
    createOutput,
    fetchOperationTypes,
    fetchMyTeamMembers,
    fetchOutputs,
    OperationType,
    TeamMember,
    ProductionOutput,
    OUTPUT_STATUS_LABELS,
    OUTPUT_STATUS_COLORS,
    formatUserName,
    formatDate
} from "src/api/productionApi";

import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { fetchTasks, ProductionTask } from "src/api/tasksApi";

export const ProductionEntry: React.FC = observer(() => {
    const context = useContext(Context);
    const currentUser = context?.user?.user;


    const [operationTypes, setOperationTypes] = useState<OperationType[]>([]);
    const [teamMembers, setTeamMembers] = useState<TeamMember[]>([]);
    const [projects, setProjects] = useState<ProjectModel[]>([]);
    const [tasks, setTasks] = useState<ProductionTask[]>([]);


    const [date, setDate] = useState(() => new Date().toISOString().split('T')[0]);
    const [selectedUserId, setSelectedUserId] = useState<number | null>(null);
    const [selectedProjectId, setSelectedProjectId] = useState<number | null>(null);
    const [selectedTaskId, setSelectedTaskId] = useState<number | null>(null);
    const [selectedOperationId, setSelectedOperationId] = useState<number | null>(null);
    const [quantity, setQuantity] = useState<number>(0);
    const [comment, setComment] = useState("");


    const [loading, setLoading] = useState(false);
    const [todayOutputs, setTodayOutputs] = useState<ProductionOutput[]>([]);


    useEffect(() => {
        loadInitialData();
    }, []);

    useEffect(() => {
        if (currentUser?.id) {
            setSelectedUserId(currentUser.id);
        }
    }, [currentUser]);

    useEffect(() => {

        if (selectedProjectId) {
            loadTasks(selectedProjectId);
        } else {
            setTasks([]);
            setSelectedTaskId(null);
        }
    }, [selectedProjectId]);

    useEffect(() => {

        loadTodayOutputs();
    }, [date, selectedUserId]);

    const loadInitialData = async () => {
        try {
            const [ops, members, projs] = await Promise.all([
                fetchOperationTypes(),
                fetchMyTeamMembers(),
                fetchProjects()
            ]);
            setOperationTypes(ops);
            setTeamMembers(members);
            setProjects(projs);
        } catch (e) {
            console.error(e);
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
        }
    };

    const loadTasks = async (projectId: number) => {
        try {
            const result = await fetchTasks({
                status: 'active',
                limit: 100
            });

            const filtered = result.rows.filter(t => t.projectId === projectId);
            setTasks(filtered);
        } catch (e) {
            console.error(e);
        }
    };

    const loadTodayOutputs = async () => {
        if (!selectedUserId) return;

        try {
            const result = await fetchOutputs({
                userId: selectedUserId,
                dateFrom: date,
                dateTo: date,
                limit: 50
            });
            setTodayOutputs(result.rows);
        } catch (e) {
            console.error(e);
        }
    };


    const todayStats = useMemo(() => {
        const pending = todayOutputs
            .filter(o => o.status === 'pending')
            .reduce((sum, o) => sum + o.claimedQty, 0);

        const approved = todayOutputs
            .filter(o => o.status === 'approved' || o.status === 'adjusted')
            .reduce((sum, o) => sum + o.approvedQty, 0);

        const total = todayOutputs.reduce((sum, o) => sum + o.claimedQty, 0);

        return { pending, approved, total, count: todayOutputs.length };
    }, [todayOutputs]);


    const handleQuickAdd = (val: number) => {
        setQuantity(prev => prev + val);
    };

    const handleReset = () => {
        setQuantity(0);
        setComment("");
    };

    const handleSubmit = async () => {
        if (!selectedUserId) {
            toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞");
            return;
        }
        if (quantity <= 0) {
            toast.error("–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
            return;
        }

        setLoading(true);
        try {
            await createOutput({
                date,
                userId: selectedUserId,
                projectId: selectedProjectId,
                taskId: selectedTaskId,
                operationTypeId: selectedOperationId,
                claimedQty: quantity,
                comment: comment || undefined
            });

            toast.success(`–ó–∞–ø–∏—Å–∞–Ω–æ: ${quantity} —à—Ç`);
            setQuantity(0);
            setComment("");
            loadTodayOutputs();
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        } finally {
            setLoading(false);
        }
    };


    const selectedUser = teamMembers.find(u => u.id === selectedUserId);
    const isForSelf = selectedUserId === currentUser?.id;

    return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">


            <div className="lg:col-span-2 space-y-4">


                <div className="bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-6 py-4 rounded-xl shadow-lg">
                    <h2 className="text-xl font-bold flex items-center gap-2">
                        <Plus size={24} />
                        –í–Ω–µ—Å—Ç–∏ –≤—ã—Ä–∞–±–æ—Ç–∫—É
                    </h2>
                    <p className="text-emerald-100 text-sm mt-1">
                        –£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç, –æ–ø–µ—Ä–∞—Ü–∏—é –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                    </p>
                </div>


                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-5">


                    <div>
                        <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                            <Calendar size={16} className="text-gray-400" />
                            –î–∞—Ç–∞
                        </label>
                        <input
                            type="date"
                            value={date}
                            onChange={(e) => setDate(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition"
                        />
                    </div>


                    <div>
                        <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                            <User size={16} className="text-gray-400" />
                            –°–æ—Ç—Ä—É–¥–Ω–∏–∫
                        </label>
                        <select
                            value={selectedUserId || ""}
                            onChange={(e) => setSelectedUserId(Number(e.target.value) || null)}
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition bg-white"
                        >
                            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî</option>
                            {teamMembers.map(u => (
                                <option key={u.id} value={u.id}>
                                    {u.id === currentUser?.id ? "–ó–∞ —Å–µ–±—è" : `${u.surname} ${u.name}`}
                                    {u.team ? ` (${u.team.title})` : ""}
                                </option>
                            ))}
                        </select>
                        {!isForSelf && selectedUser && (
                            <p className="text-xs text-amber-600 mt-1 flex items-center gap-1">
                                <Users size={12} />
                                –í—ã –≤–Ω–æ—Å–∏—Ç–µ –∑–∞: {selectedUser.surname} {selectedUser.name}
                            </p>
                        )}
                    </div>


                    <div>
                        <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                            <FolderKanban size={16} className="text-gray-400" />
                            –ü—Ä–æ–µ–∫—Ç
                            <span className="text-gray-400 font-normal">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                        </label>
                        <select
                            value={selectedProjectId || ""}
                            onChange={(e) => setSelectedProjectId(Number(e.target.value) || null)}
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition bg-white"
                        >
                            <option value="">‚Äî –ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî</option>
                            {projects.map(p => (
                                <option key={p.id} value={p.id}>{p.title}</option>
                            ))}
                        </select>
                    </div>


                    {selectedProjectId && tasks.length > 0 && (
                        <div>
                            <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                                <ClipboardList size={16} className="text-gray-400" />
                                –ó–∞–¥–∞—á–∞
                                <span className="text-gray-400 font-normal">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                            </label>
                            <select
                                value={selectedTaskId || ""}
                                onChange={(e) => setSelectedTaskId(Number(e.target.value) || null)}
                                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition bg-white"
                            >
                                <option value="">‚Äî –ë–µ–∑ –∑–∞–¥–∞—á–∏ ‚Äî</option>
                                {tasks.map(t => (
                                    <option key={t.id} value={t.id}>
                                        {t.title} ({t.targetQty} {t.unit})
                                    </option>
                                ))}
                            </select>
                        </div>
                    )}


                    <div>
                        <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                            <Settings2 size={16} className="text-gray-400" />
                            –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
                        </label>
                        <select
                            value={selectedOperationId || ""}
                            onChange={(e) => setSelectedOperationId(Number(e.target.value) || null)}
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition bg-white"
                        >
                            <option value="">‚Äî –ë–µ–∑ —Ç–∏–ø–∞ ‚Äî</option>
                            {operationTypes.map(op => (
                                <option key={op.id} value={op.id}>
                                    {op.name} {op.code ? `(${op.code})` : ""} ‚Äî {op.unit}
                                </option>
                            ))}
                        </select>
                    </div>


                    <div>
                        <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                            <Hash size={16} className="text-gray-400" />
                            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                        </label>
                        <input
                            type="number"
                            min="0"
                            value={quantity || ""}
                            onChange={(e) => setQuantity(Number(e.target.value) || 0)}
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition text-lg font-semibold"
                        />


                        <div className="flex gap-2 mt-3">
                            {[10, 20, 50, 100, 200].map(val => (
                                <button
                                    key={val}
                                    onClick={() => handleQuickAdd(val)}
                                    className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition"
                                >
                                    +{val}
                                </button>
                            ))}
                            <button
                                onClick={handleReset}
                                className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition"
                            >
                                –°–±—Ä–æ—Å
                            </button>
                        </div>
                    </div>


                    <div>
                        <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                            <MessageSquare size={16} className="text-gray-400" />
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                            <span className="text-gray-400 font-normal">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                        </label>
                        <textarea
                            value={comment}
                            onChange={(e) => setComment(e.target.value)}
                            placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."
                            rows={2}
                            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition resize-none"
                        />
                    </div>


                    <button
                        onClick={handleSubmit}
                        disabled={loading || quantity <= 0}
                        className="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 disabled:from-gray-300 disabled:to-gray-400 text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition shadow-lg disabled:shadow-none"
                    >
                        <Save size={20} />
                        {loading ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
                    </button>
                </div>
            </div>


            <div className="space-y-4">


                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h3 className="font-bold text-gray-800 mb-4">
                        –ò—Ç–æ–≥–æ –∑–∞ {formatDate(date)}
                    </h3>

                    <div className="space-y-3">
                        <div className="flex justify-between items-center py-2 border-b border-gray-100">
                            <span className="flex items-center gap-2 text-yellow-600">
                                <Clock size={16} />
                                –û–∂–∏–¥–∞–µ—Ç
                            </span>
                            <span className="font-bold text-lg">{todayStats.pending}</span>
                        </div>

                        <div className="flex justify-between items-center py-2 border-b border-gray-100">
                            <span className="flex items-center gap-2 text-green-600">
                                <CheckCircle2 size={16} />
                                –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                            </span>
                            <span className="font-bold text-lg text-green-600">{todayStats.approved}</span>
                        </div>

                        <div className="flex justify-between items-center py-2">
                            <span className="text-gray-600 font-medium">–í—Å–µ–≥–æ</span>
                            <span className="font-bold text-xl">{todayStats.total}</span>
                        </div>
                    </div>
                </div>


                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h3 className="font-bold text-gray-800 mb-4">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h3>

                    {todayOutputs.length === 0 ? (
                        <div className="text-center py-8 text-gray-400">
                            <Clock size={32} className="mx-auto mb-2 opacity-50" />
                            <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</p>
                        </div>
                    ) : (
                        <div className="space-y-2 max-h-80 overflow-y-auto">
                            {todayOutputs.map(output => (
                                <div
                                    key={output.id}
                                    className="p-3 bg-gray-50 rounded-lg border border-gray-100"
                                >
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="font-medium text-sm">
                                                {output.operationType?.name || "–ë–µ–∑ —Ç–∏–ø–∞"}
                                            </p>
                                            {output.project && (
                                                <p className="text-xs text-gray-500">
                                                    {output.project.title}
                                                </p>
                                            )}
                                        </div>
                                        <div className="text-right">
                                            <p className="font-bold">{output.claimedQty}</p>
                                            <span className={`text-xs px-2 py-0.5 rounded-full ${OUTPUT_STATUS_COLORS[output.status]}`}>
                                                {OUTPUT_STATUS_LABELS[output.status]}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
});

export default ProductionEntry;

================================================================================
FILE: QMS-Client-main/src/pages/Production/tabs/ProductionJournal.tsx
================================================================================



import React, { useState, useEffect, useContext } from "react";
import {
    Calendar, User, Filter, Search, Download, Trash2,
    ChevronLeft, ChevronRight, FolderKanban, ClipboardList,
    Settings2, Users, CheckCircle2, Clock, XCircle, RefreshCw
} from "lucide-react";
import toast from "react-hot-toast";
import { Context } from "src/main";
import { observer } from "mobx-react-lite";

import {
    fetchOutputs,
    deleteOutput,
    fetchOperationTypes,
    ProductionOutput,
    OperationType,
    OUTPUT_STATUS_LABELS,
    OUTPUT_STATUS_COLORS,
    formatUserName,
    formatDate
} from "src/api/productionApi";

import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { fetchStructure } from "src/api/structureApi";

export const ProductionJournal: React.FC = observer(() => {
    const context = useContext(Context);
    const currentUser = context?.user?.user;
    const isAdmin = currentUser?.role === 'SUPER_ADMIN' || currentUser?.role === 'Admin';


    const [outputs, setOutputs] = useState<ProductionOutput[]>([]);
    const [totalCount, setTotalCount] = useState(0);
    const [loading, setLoading] = useState(true);


    const [operationTypes, setOperationTypes] = useState<OperationType[]>([]);
    const [projects, setProjects] = useState<ProjectModel[]>([]);
    const [teams, setTeams] = useState<Array<{ id: number; title: string }>>([]);
    const [sections, setSections] = useState<Array<{ id: number; title: string }>>([]);
    const [users, setUsers] = useState<Array<{ id: number; name: string; surname: string }>>([]);


    const [page, setPage] = useState(1);
    const [limit] = useState(30);
    const [filterUserId, setFilterUserId] = useState<number | null>(null);
    const [filterTeamId, setFilterTeamId] = useState<number | null>(null);
    const [filterSectionId, setFilterSectionId] = useState<number | null>(null);
    const [filterProjectId, setFilterProjectId] = useState<number | null>(null);
    const [filterOperationId, setFilterOperationId] = useState<number | null>(null);
    const [filterStatus, setFilterStatus] = useState<string>("");
    const [filterDateFrom, setFilterDateFrom] = useState<string>("");
    const [filterDateTo, setFilterDateTo] = useState<string>("");

    const totalPages = Math.ceil(totalCount / limit);


    useEffect(() => {
        loadDictionaries();
    }, []);

    useEffect(() => {
        loadData();
    }, [page, filterUserId, filterTeamId, filterSectionId, filterProjectId, filterOperationId, filterStatus, filterDateFrom, filterDateTo]);

    const loadDictionaries = async () => {
        try {
            const [ops, projs, structure] = await Promise.all([
                fetchOperationTypes(),
                fetchProjects(),
                fetchStructure()
            ]);

            setOperationTypes(ops);
            setProjects(projs);
            setSections(structure.sections || []);


            const allTeams: Array<{ id: number; title: string }> = [];
            const allUsers: Array<{ id: number; name: string; surname: string }> = [];

            structure.sections?.forEach((s: any) => {
                s.teams?.forEach((t: any) => {
                    allTeams.push({ id: t.id, title: `${t.title} (${s.title})` });
                    t.members?.forEach((m: any) => {
                        if (!allUsers.find(u => u.id === m.id)) {
                            allUsers.push({ id: m.id, name: m.name, surname: m.surname });
                        }
                    });
                });
            });

            setTeams(allTeams);
            setUsers(allUsers.sort((a, b) => a.surname.localeCompare(b.surname)));
        } catch (e) {
            console.error(e);
        }
    };

    const loadData = async () => {
        setLoading(true);
        try {
            const result = await fetchOutputs({
                page,
                limit,
                userId: filterUserId || undefined,
                teamId: filterTeamId || undefined,
                sectionId: filterSectionId || undefined,
                projectId: filterProjectId || undefined,
                operationTypeId: filterOperationId || undefined,
                status: filterStatus || undefined,
                dateFrom: filterDateFrom || undefined,
                dateTo: filterDateTo || undefined
            });

            setOutputs(result.rows);
            setTotalCount(result.count);
        } catch (e) {
            console.error(e);
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
        } finally {
            setLoading(false);
        }
    };

    const handleDelete = async (id: number) => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;

        try {
            await deleteOutput(id);
            toast.success("–£–¥–∞–ª–µ–Ω–æ");
            loadData();
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
        }
    };

    const handleResetFilters = () => {
        setFilterUserId(null);
        setFilterTeamId(null);
        setFilterSectionId(null);
        setFilterProjectId(null);
        setFilterOperationId(null);
        setFilterStatus("");
        setFilterDateFrom("");
        setFilterDateTo("");
        setPage(1);
    };

    const handleExportCSV = () => {

        const headers = ['–î–∞—Ç–∞', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', '–ë—Ä–∏–≥–∞–¥–∞', '–ü—Ä–æ–µ–∫—Ç', '–û–ø–µ—Ä–∞—Ü–∏—è', '–ó–∞—è–≤–ª–µ–Ω–æ', '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ', '–°—Ç–∞—Ç—É—Å', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'];
        const rows = outputs.map(o => [
            o.date,
            formatUserName(o.user),
            o.team?.title || '',
            o.project?.title || '',
            o.operationType?.name || '',
            o.claimedQty,
            o.approvedQty,
            OUTPUT_STATUS_LABELS[o.status] || o.status,
            o.comment || ''
        ]);

        const csvContent = '\uFEFF' + [headers, ...rows].map(r => r.map(c => `"${c}"`).join(';')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `–≤—ã—Ä–∞–±–æ—Ç–∫–∞_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        toast.success("–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
    };

    const getStatusIcon = (status: string) => {
        switch (status) {
            case 'approved':
            case 'adjusted':
                return <CheckCircle2 size={16} className="text-green-500" />;
            case 'pending':
                return <Clock size={16} className="text-yellow-500" />;
            case 'rejected':
                return <XCircle size={16} className="text-red-500" />;
            default:
                return null;
        }
    };


    return (
        <div className="space-y-4">


            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div className="flex items-center gap-2 mb-3">
                    <Filter size={18} className="text-gray-400" />
                    <span className="font-medium text-gray-700">–§–∏–ª—å—Ç—Ä—ã</span>
                    <button
                        onClick={handleResetFilters}
                        className="ml-auto text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1"
                    >
                        <RefreshCw size={14} />
                        –°–±—Ä–æ—Å–∏—Ç—å
                    </button>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">

                    <div>
                        <label className="text-xs text-gray-500 mb-1 block">–î–∞—Ç–∞ —Å</label>
                        <input
                            type="date"
                            value={filterDateFrom}
                            onChange={(e) => { setFilterDateFrom(e.target.value); setPage(1); }}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                        />
                    </div>
                    <div>
                        <label className="text-xs text-gray-500 mb-1 block">–î–∞—Ç–∞ –ø–æ</label>
                        <input
                            type="date"
                            value={filterDateTo}
                            onChange={(e) => { setFilterDateTo(e.target.value); setPage(1); }}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                        />
                    </div>


                    <div>
                        <label className="text-xs text-gray-500 mb-1 block">–£—á–∞—Å—Ç–æ–∫</label>
                        <select
                            value={filterSectionId || ""}
                            onChange={(e) => { setFilterSectionId(Number(e.target.value) || null); setPage(1); }}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                        >
                            <option value="">–í—Å–µ</option>
                            {sections.map(s => (
                                <option key={s.id} value={s.id}>{s.title}</option>
                            ))}
                        </select>
                    </div>


                    <div>
                        <label className="text-xs text-gray-500 mb-1 block">–ë—Ä–∏–≥–∞–¥–∞</label>
                        <select
                            value={filterTeamId || ""}
                            onChange={(e) => { setFilterTeamId(Number(e.target.value) || null); setPage(1); }}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                        >
                            <option value="">–í—Å–µ</option>
                            {teams.map(t => (
                                <option key={t.id} value={t.id}>{t.title}</option>
                            ))}
                        </select>
                    </div>


                    <div>
                        <label className="text-xs text-gray-500 mb-1 block">–ü—Ä–æ–µ–∫—Ç</label>
                        <select
                            value={filterProjectId || ""}
                            onChange={(e) => { setFilterProjectId(Number(e.target.value) || null); setPage(1); }}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                        >
                            <option value="">–í—Å–µ</option>
                            {projects.map(p => (
                                <option key={p.id} value={p.id}>{p.title}</option>
                            ))}
                        </select>
                    </div>


                    <div>
                        <label className="text-xs text-gray-500 mb-1 block">–û–ø–µ—Ä–∞—Ü–∏—è</label>
                        <select
                            value={filterOperationId || ""}
                            onChange={(e) => { setFilterOperationId(Number(e.target.value) || null); setPage(1); }}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                        >
                            <option value="">–í—Å–µ</option>
                            {operationTypes.map(op => (
                                <option key={op.id} value={op.id}>{op.name}</option>
                            ))}
                        </select>
                    </div>


                    <div>
                        <label className="text-xs text-gray-500 mb-1 block">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                        <select
                            value={filterUserId || ""}
                            onChange={(e) => { setFilterUserId(Number(e.target.value) || null); setPage(1); }}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                        >
                            <option value="">–í—Å–µ</option>
                            {users.map(u => (
                                <option key={u.id} value={u.id}>{u.surname} {u.name}</option>
                            ))}
                        </select>
                    </div>


                    <div>
                        <label className="text-xs text-gray-500 mb-1 block">–°—Ç–∞—Ç—É—Å</label>
                        <select
                            value={filterStatus}
                            onChange={(e) => { setFilterStatus(e.target.value); setPage(1); }}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                        >
                            <option value="">–í—Å–µ</option>
                            <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                            <option value="approved">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option>
                            <option value="adjusted">–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ</option>
                            <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                        </select>
                    </div>
                </div>
            </div>


            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">


                <div className="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                    <div>
                        <span className="font-medium text-gray-700">–ù–∞–π–¥–µ–Ω–æ: {totalCount}</span>
                    </div>
                    <button
                        onClick={handleExportCSV}
                        className="px-3 py-1.5 text-sm text-emerald-600 hover:bg-emerald-50 rounded-lg flex items-center gap-1"
                    >
                        <Download size={16} />
                        –≠–∫—Å–ø–æ—Ä—Ç CSV
                    </button>
                </div>


                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-4 py-3 text-left font-medium text-gray-500">–î–∞—Ç–∞</th>
                                <th className="px-4 py-3 text-left font-medium text-gray-500">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                <th className="px-4 py-3 text-left font-medium text-gray-500">–ë—Ä–∏–≥–∞–¥–∞</th>
                                <th className="px-4 py-3 text-left font-medium text-gray-500">–ü—Ä–æ–µ–∫—Ç</th>
                                <th className="px-4 py-3 text-left font-medium text-gray-500">–û–ø–µ—Ä–∞—Ü–∏—è</th>
                                <th className="px-4 py-3 text-right font-medium text-gray-500">–ó–∞—è–≤–ª.</th>
                                <th className="px-4 py-3 text-right font-medium text-gray-500">–ü–æ–¥—Ç–≤.</th>
                                <th className="px-4 py-3 text-center font-medium text-gray-500">–°—Ç–∞—Ç—É—Å</th>
                                <th className="px-4 py-3 text-left font-medium text-gray-500">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏–ª</th>
                                <th className="px-4 py-3 text-center font-medium text-gray-500"></th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50">
                            {loading ? (
                                <tr>
                                    <td colSpan={10} className="px-4 py-8 text-center text-gray-400">
                                        <RefreshCw size={24} className="mx-auto mb-2 animate-spin" />
                                        –ó–∞–≥—Ä—É–∑–∫–∞...
                                    </td>
                                </tr>
                            ) : outputs.length === 0 ? (
                                <tr>
                                    <td colSpan={10} className="px-4 py-8 text-center text-gray-400">
                                        –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π
                                    </td>
                                </tr>
                            ) : (
                                outputs.map(output => (
                                    <tr key={output.id} className="hover:bg-gray-50">
                                        <td className="px-4 py-3 whitespace-nowrap">
                                            {formatDate(output.date)}
                                        </td>
                                        <td className="px-4 py-3">
                                            <div className="flex items-center gap-2">
                                                <div className="w-7 h-7 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                                    {output.user?.img ? (
                                                        <img
                                                            src={`${import.meta.env.VITE_API_URL}/${output.user.img}`}
                                                            className="w-full h-full object-cover"
                                                        />
                                                    ) : (
                                                        <User size={14} className="text-gray-400" />
                                                    )}
                                                </div>
                                                <span>{formatUserName(output.user)}</span>
                                            </div>
                                        </td>
                                        <td className="px-4 py-3 text-gray-500">
                                            {output.team?.title || '‚Äî'}
                                        </td>
                                        <td className="px-4 py-3">
                                            {output.project ? (
                                                <span className="flex items-center gap-1 text-blue-600">
                                                    <FolderKanban size={14} />
                                                    {output.project.title}
                                                </span>
                                            ) : (
                                                <span className="text-gray-400">‚Äî</span>
                                            )}
                                        </td>
                                        <td className="px-4 py-3">
                                            {output.operationType ? (
                                                <span className="flex items-center gap-1">
                                                    <Settings2 size={14} className="text-gray-400" />
                                                    {output.operationType.name}
                                                </span>
                                            ) : (
                                                <span className="text-gray-400">‚Äî</span>
                                            )}
                                        </td>
                                        <td className="px-4 py-3 text-right font-medium">
                                            {output.claimedQty}
                                        </td>
                                        <td className="px-4 py-3 text-right font-bold text-emerald-600">
                                            {output.approvedQty || '‚Äî'}
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${OUTPUT_STATUS_COLORS[output.status]}`}>
                                                {getStatusIcon(output.status)}
                                                {OUTPUT_STATUS_LABELS[output.status]}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 text-gray-500">
                                            {formatUserName(output.approvedBy)}
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            {(isAdmin || output.createdById === currentUser?.id || output.userId === currentUser?.id) && output.status === 'pending' && (
                                                <button
                                                    onClick={() => handleDelete(output.id)}
                                                    className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition"
                                                    title="–£–¥–∞–ª–∏—Ç—å"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>


                {totalPages > 1 && (
                    <div className="px-4 py-3 border-t border-gray-100 flex items-center justify-between">
                        <span className="text-sm text-gray-500">
                            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page} –∏–∑ {totalPages}
                        </span>
                        <div className="flex gap-1">
                            <button
                                onClick={() => setPage(p => Math.max(1, p - 1))}
                                disabled={page === 1}
                                className="p-2 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <ChevronLeft size={18} />
                            </button>
                            <button
                                onClick={() => setPage(p => Math.min(totalPages, p + 1))}
                                disabled={page === totalPages}
                                className="p-2 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <ChevronRight size={18} />
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
});

export default ProductionJournal;

================================================================================
FILE: QMS-Client-main/src/pages/Production/tabs/ProductionMatrix.tsx
================================================================================



import React, { useState, useEffect, useMemo } from "react";
import {
    Calendar, ChevronLeft, ChevronRight, Download,
    Users, FolderKanban, Settings2, TrendingUp, Award,
    RefreshCw, User, Filter, X
} from "lucide-react";
import toast from "react-hot-toast";

import {
    fetchMatrix,
    fetchOperationTypes,
    MatrixResponse,
    MatrixUser,
    OperationType,
    formatShortDate,
    getDayOfWeek
} from "src/api/productionApi";

import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { fetchStructure } from "src/api/structureApi";


type PeriodType = 'week' | 'month' | 'year' | 'all' | 'custom';

interface PeriodOption {
    id: PeriodType;
    label: string;
    icon?: React.ReactNode;
}

const PERIOD_OPTIONS: PeriodOption[] = [
    { id: 'week', label: '–ù–µ–¥–µ–ª—è' },
    { id: 'month', label: '–ú–µ—Å—è—Ü' },
    { id: 'year', label: '–ì–æ–¥' },
    { id: 'all', label: '–í—Å—ë –≤—Ä–µ–º—è' },
    { id: 'custom', label: '–ü–µ—Ä–∏–æ–¥' },
];

export const ProductionMatrix: React.FC = () => {

    const [matrixData, setMatrixData] = useState<MatrixResponse | null>(null);
    const [loading, setLoading] = useState(true);


    const [operationTypes, setOperationTypes] = useState<OperationType[]>([]);
    const [projects, setProjects] = useState<ProjectModel[]>([]);
    const [teams, setTeams] = useState<Array<{ id: number; title: string }>>([]);
    const [sections, setSections] = useState<Array<{ id: number; title: string }>>([]);
    const [employees, setEmployees] = useState<Array<{ id: number; name: string; surname: string }>>([]);


    const [periodType, setPeriodType] = useState<PeriodType>('week');
    const [periodOffset, setPeriodOffset] = useState(0);
    const [customDateFrom, setCustomDateFrom] = useState('');
    const [customDateTo, setCustomDateTo] = useState('');

    const [filterTeamId, setFilterTeamId] = useState<number | null>(null);
    const [filterSectionId, setFilterSectionId] = useState<number | null>(null);
    const [filterProjectId, setFilterProjectId] = useState<number | null>(null);
    const [filterOperationId, setFilterOperationId] = useState<number | null>(null);
    const [filterUserId, setFilterUserId] = useState<number | null>(null);


    const periodDates = useMemo(() => {
        const now = new Date();
        let from: Date;
        let to: Date;

        if (periodType === 'custom') {
            return {
                from: customDateFrom || now.toISOString().split('T')[0],
                to: customDateTo || now.toISOString().split('T')[0],
                label: customDateFrom && customDateTo
                    ? `${formatDate(customDateFrom)} ‚Äî ${formatDate(customDateTo)}`
                    : '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã'
            };
        }

        if (periodType === 'week') {
            const dayOfWeek = now.getDay();
            from = new Date(now);
            from.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1) + (periodOffset * 7));
            to = new Date(from);
            to.setDate(from.getDate() + 6);
        } else if (periodType === 'month') {
            from = new Date(now.getFullYear(), now.getMonth() + periodOffset, 1);
            to = new Date(now.getFullYear(), now.getMonth() + periodOffset + 1, 0);
        } else if (periodType === 'year') {
            from = new Date(now.getFullYear() + periodOffset, 0, 1);
            to = new Date(now.getFullYear() + periodOffset, 11, 31);
        } else {

            from = new Date(2020, 0, 1);
            to = new Date();
        }

        const fromStr = from.toISOString().split('T')[0];
        const toStr = to.toISOString().split('T')[0];

        let label = '';
        if (periodType === 'week') {
            label = `${formatDate(fromStr)} ‚Äî ${formatDate(toStr)}`;
        } else if (periodType === 'month') {
            label = from.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
        } else if (periodType === 'year') {
            label = from.getFullYear().toString();
        } else {
            label = '–í—Å—ë –≤—Ä–µ–º—è';
        }

        return { from: fromStr, to: toStr, label };
    }, [periodType, periodOffset, customDateFrom, customDateTo]);


    useEffect(() => {
        loadDictionaries();
    }, []);


    useEffect(() => {
        if (periodType !== 'custom' || (customDateFrom && customDateTo)) {
            loadMatrix();
        }
    }, [periodDates, filterTeamId, filterSectionId, filterProjectId, filterOperationId, filterUserId]);

    const loadDictionaries = async () => {
        try {
            const [ops, projs, structure] = await Promise.all([
                fetchOperationTypes(),
                fetchProjects(),
                fetchStructure()
            ]);

            setOperationTypes(ops);
            setProjects(projs);
            setSections(structure.sections || []);

            const allTeams: Array<{ id: number; title: string }> = [];
            const allEmployees: Array<{ id: number; name: string; surname: string }> = [];

            structure.sections?.forEach((s: any) => {
                s.teams?.forEach((t: any) => {
                    allTeams.push({ id: t.id, title: t.title });
                    t.members?.forEach((m: any) => {
                        if (!allEmployees.find(e => e.id === m.id)) {
                            allEmployees.push({ id: m.id, name: m.name, surname: m.surname });
                        }
                    });
                });
            });

            setTeams(allTeams);
            setEmployees(allEmployees.sort((a, b) => a.surname.localeCompare(b.surname)));
        } catch (e) {
            console.error(e);
        }
    };

    const loadMatrix = async () => {
        setLoading(true);
        try {
            const data = await fetchMatrix({
                dateFrom: periodDates.from,
                dateTo: periodDates.to,
                teamId: filterTeamId || undefined,
                sectionId: filterSectionId || undefined,
                projectId: filterProjectId || undefined,
                operationTypeId: filterOperationId || undefined,
            });


            if (filterUserId && data.matrix) {
                data.matrix = data.matrix.filter(u => u.userId === filterUserId);
            }

            setMatrixData(data);
        } catch (e: any) {
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
            console.error(e);
        } finally {
            setLoading(false);
        }
    };


    const goToPrevPeriod = () => setPeriodOffset(prev => prev - 1);
    const goToNextPeriod = () => setPeriodOffset(prev => prev + 1);
    const goToCurrentPeriod = () => setPeriodOffset(0);


    const handlePeriodTypeChange = (type: PeriodType) => {
        setPeriodType(type);
        setPeriodOffset(0);
        if (type !== 'custom') {
            setCustomDateFrom('');
            setCustomDateTo('');
        }
    };


    const resetFilters = () => {
        setFilterTeamId(null);
        setFilterSectionId(null);
        setFilterProjectId(null);
        setFilterOperationId(null);
        setFilterUserId(null);
    };

    const hasActiveFilters = filterTeamId || filterSectionId || filterProjectId || filterOperationId || filterUserId;


    const stats = useMemo(() => {
        if (!matrixData?.matrix) return { employees: 0, total: 0, avgPerDay: 0, leader: null };

        const employees = matrixData.matrix.length;
        const total = matrixData.matrix.reduce((sum, u) => sum + u.total, 0);
        const daysCount = matrixData.dates?.length || 1;
        const avgPerDay = Math.round(total / daysCount);
        const leader = matrixData.matrix[0] || null;

        return { employees, total, avgPerDay, leader };
    }, [matrixData]);


    const dayTotals = useMemo(() => {
        if (!matrixData?.matrix || !matrixData?.dates) return {};

        const totals: Record<string, number> = {};
        matrixData.dates.forEach(date => {
            totals[date] = matrixData.matrix.reduce((sum, u) => sum + (u.days[date] || 0), 0);
        });
        return totals;
    }, [matrixData]);

    const grandTotal = useMemo(() => {
        return Object.values(dayTotals).reduce((sum, val) => sum + val, 0);
    }, [dayTotals]);


    const exportCSV = () => {
        if (!matrixData?.matrix || !matrixData?.dates) return;

        const headers = ['–°–æ—Ç—Ä—É–¥–Ω–∏–∫', ...matrixData.dates.map(d => formatDate(d)), '–ò—Ç–æ–≥–æ'];
        const rows = matrixData.matrix.map(u => [
            `${u.surname} ${u.name}`,
            ...matrixData.dates.map(d => u.days[d] || 0),
            u.total
        ]);
        rows.push(['–ò–¢–û–ì–û', ...matrixData.dates.map(d => dayTotals[d] || 0), grandTotal]);

        const csv = [headers, ...rows].map(row => row.join(';')).join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `–≤—ã—Ä–∞–±–æ—Ç–∫–∞_${periodDates.from}_${periodDates.to}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };

    return (
        <div className="space-y-4">

            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">

                <div className="flex flex-wrap items-center gap-4 mb-4">
                    <div className="flex bg-gray-100 rounded-lg p-1">
                        {PERIOD_OPTIONS.map(opt => (
                            <button
                                key={opt.id}
                                onClick={() => handlePeriodTypeChange(opt.id)}
                                className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${
                                    periodType === opt.id
                                        ? 'bg-white text-emerald-600 shadow-sm'
                                        : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                {opt.label}
                            </button>
                        ))}
                    </div>


                    {periodType !== 'all' && periodType !== 'custom' && (
                        <div className="flex items-center gap-2">
                            <button
                                onClick={goToPrevPeriod}
                                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                            >
                                <ChevronLeft className="w-5 h-5 text-gray-600" />
                            </button>

                            <button
                                onClick={goToCurrentPeriod}
                                className="px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg min-w-[180px]"
                            >
                                {periodDates.label}
                            </button>

                            <button
                                onClick={goToNextPeriod}
                                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                                disabled={periodOffset >= 0}
                            >
                                <ChevronRight className={`w-5 h-5 ${periodOffset >= 0 ? 'text-gray-300' : 'text-gray-600'}`} />
                            </button>

                            {periodOffset !== 0 && (
                                <button
                                    onClick={goToCurrentPeriod}
                                    className="px-2 py-1 text-xs text-emerald-600 hover:bg-emerald-50 rounded"
                                >
                                    –°–µ–≥–æ–¥–Ω—è
                                </button>
                            )}
                        </div>
                    )}


                    {periodType === 'custom' && (
                        <div className="flex items-center gap-2">
                            <input
                                type="date"
                                value={customDateFrom}
                                onChange={(e) => setCustomDateFrom(e.target.value)}
                                className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                            />
                            <span className="text-gray-400">‚Äî</span>
                            <input
                                type="date"
                                value={customDateTo}
                                onChange={(e) => setCustomDateTo(e.target.value)}
                                className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                            />
                        </div>
                    )}

                    <div className="flex-1" />


                    <button
                        onClick={exportCSV}
                        disabled={!matrixData?.matrix?.length}
                        className="flex items-center gap-2 px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-lg disabled:opacity-50"
                    >
                        <Download className="w-4 h-4" />
                        CSV
                    </button>
                </div>


                <div className="flex flex-wrap items-center gap-3">

                    <select
                        value={filterUserId || ''}
                        onChange={(e) => setFilterUserId(e.target.value ? Number(e.target.value) : null)}
                        className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white min-w-[180px]"
                    >
                        <option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                        {employees.map(emp => (
                            <option key={emp.id} value={emp.id}>
                                {emp.surname} {emp.name}
                            </option>
                        ))}
                    </select>


                    <select
                        value={filterSectionId || ''}
                        onChange={(e) => setFilterSectionId(e.target.value ? Number(e.target.value) : null)}
                        className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white"
                    >
                        <option value="">–í—Å–µ —É—á–∞—Å—Ç–∫–∏</option>
                        {sections.map(s => (
                            <option key={s.id} value={s.id}>{s.title}</option>
                        ))}
                    </select>


                    <select
                        value={filterTeamId || ''}
                        onChange={(e) => setFilterTeamId(e.target.value ? Number(e.target.value) : null)}
                        className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white"
                    >
                        <option value="">–í—Å–µ –±—Ä–∏–≥–∞–¥—ã</option>
                        {teams.map(t => (
                            <option key={t.id} value={t.id}>{t.title}</option>
                        ))}
                    </select>


                    <select
                        value={filterProjectId || ''}
                        onChange={(e) => setFilterProjectId(e.target.value ? Number(e.target.value) : null)}
                        className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white"
                    >
                        <option value="">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                        {projects.map(p => (
                            <option key={p.id} value={p.id}>{p.title}</option>
                        ))}
                    </select>


                    <select
                        value={filterOperationId || ''}
                        onChange={(e) => setFilterOperationId(e.target.value ? Number(e.target.value) : null)}
                        className="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white"
                    >
                        <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
                        {operationTypes.map(op => (
                            <option key={op.id} value={op.id}>{op.name}</option>
                        ))}
                    </select>


                    {hasActiveFilters && (
                        <button
                            onClick={resetFilters}
                            className="flex items-center gap-1 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg"
                        >
                            <X className="w-4 h-4" />
                            –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                    )}
                </div>
            </div>


            <div className="grid grid-cols-4 gap-4">
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div className="flex items-center gap-2 text-gray-500 text-sm mb-1">
                        <Users className="w-4 h-4" />
                        –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    </div>
                    <div className="text-2xl font-bold text-gray-800">{stats.employees}</div>
                </div>

                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div className="flex items-center gap-2 text-gray-500 text-sm mb-1">
                        <TrendingUp className="w-4 h-4" />
                        –í—Å–µ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥
                    </div>
                    <div className="text-2xl font-bold text-emerald-600">{stats.total.toLocaleString()}</div>
                </div>

                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div className="flex items-center gap-2 text-gray-500 text-sm mb-1">
                        <Calendar className="w-4 h-4" />
                        –°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å
                    </div>
                    <div className="text-2xl font-bold text-blue-600">{stats.avgPerDay.toLocaleString()}</div>
                </div>

                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <div className="flex items-center gap-2 text-gray-500 text-sm mb-1">
                        <Award className="w-4 h-4" />
                        –õ–∏–¥–µ—Ä
                    </div>
                    <div className="text-lg font-bold text-amber-600 truncate">
                        {stats.leader ? `${stats.leader.surname} ${stats.leader.name[0]}.` : '‚Äî'}
                    </div>
                </div>
            </div>


            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                {loading ? (
                    <div className="flex items-center justify-center py-20">
                        <RefreshCw className="w-6 h-6 animate-spin text-emerald-500" />
                        <span className="ml-2 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                ) : !matrixData?.matrix?.length ? (
                    <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                        <Users className="w-12 h-12 mb-3 opacity-50" />
                        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                    </div>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead>
                                <tr className="bg-gray-50 border-b border-gray-200">
                                    <th className="px-4 py-3 text-left font-semibold text-gray-600 sticky left-0 bg-gray-50 z-10">
                                        –°–æ—Ç—Ä—É–¥–Ω–∏–∫
                                    </th>
                                    {matrixData.dates.map(date => (
                                        <th
                                            key={date}
                                            className="px-3 py-3 text-center font-medium text-gray-600 min-w-[60px]"
                                        >
                                            <div className="text-xs text-gray-400">
                                                {getDayOfWeek ? getDayOfWeek(date) : ''}
                                            </div>
                                            <div>{formatDate(date)}</div>
                                        </th>
                                    ))}
                                    <th className="px-4 py-3 text-center font-semibold text-emerald-700 bg-emerald-50">
                                        –ò—Ç–æ–≥–æ
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {matrixData.matrix.map((user, idx) => (
                                    <tr
                                        key={user.userId}
                                        className={`border-b border-gray-100 hover:bg-gray-50 transition-colors ${
                                            idx === 0 ? 'bg-amber-50/50' : ''
                                        }`}
                                    >
                                        <td className="px-4 py-3 font-medium text-gray-800 sticky left-0 bg-white z-10">
                                            <div className="flex items-center gap-2">
                                                {idx === 0 && <Award className="w-4 h-4 text-amber-500" />}
                                                <span>{user.surname} {user.name}</span>
                                            </div>
                                        </td>
                                        {matrixData.dates.map(date => (
                                            <td
                                                key={date}
                                                className={`px-3 py-3 text-center ${
                                                    user.days[date]
                                                        ? user.days[date] >= 200
                                                            ? 'text-emerald-700 font-semibold bg-emerald-50'
                                                            : 'text-gray-700'
                                                        : 'text-gray-300'
                                                }`}
                                            >
                                                {user.days[date] || '‚Äî'}
                                            </td>
                                        ))}
                                        <td className="px-4 py-3 text-center font-bold text-emerald-700 bg-emerald-50">
                                            {user.total}
                                        </td>
                                    </tr>
                                ))}


                                <tr className="bg-gray-100 font-semibold border-t-2 border-gray-300">
                                    <td className="px-4 py-3 text-gray-700 sticky left-0 bg-gray-100 z-10">
                                        –ò–¢–û–ì–û
                                    </td>
                                    {matrixData.dates.map(date => (
                                        <td
                                            key={date}
                                            className={`px-3 py-3 text-center text-gray-700 ${
                                                dayTotals[date] >= 1000 ? 'bg-amber-100' : ''
                                            }`}
                                        >
                                            {dayTotals[date] || 0}
                                        </td>
                                    ))}
                                    <td className="px-4 py-3 text-center text-lg text-emerald-700 bg-emerald-100">
                                        {grandTotal}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );
};


function formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
}

export default ProductionMatrix;

================================================================================
FILE: QMS-Client-main/src/pages/Production/tabs/ProductionSettings.tsx
================================================================================



import React, { useState, useEffect, useContext } from "react";
import {
    Plus, Edit2, Trash2, Save, X, Settings2,
    CheckCircle2, XCircle, GripVertical, Clock,
    AlertTriangle, Building2
} from "lucide-react";
import toast from "react-hot-toast";
import { Context } from "src/main";
import { observer } from "mobx-react-lite";

import {
    fetchOperationTypes,
    createOperationType,
    updateOperationType,
    deleteOperationType,
    OperationType
} from "src/api/productionApi";

import { fetchStructure } from "src/api/structureApi";

interface EditingOperation extends Partial<OperationType> {
    isNew?: boolean;
}

export const ProductionSettings: React.FC = observer(() => {
    const context = useContext(Context);
    const currentUser = context?.user?.user;


    const canManage = currentUser?.role === 'SUPER_ADMIN' ||
                      currentUser?.role === 'Admin' ||
                      currentUser?.role === 'Technologist';


    const [operations, setOperations] = useState<OperationType[]>([]);
    const [sections, setSections] = useState<Array<{ id: number; title: string }>>([]);
    const [loading, setLoading] = useState(true);


    const [editingOp, setEditingOp] = useState<EditingOperation | null>(null);
    const [showInactive, setShowInactive] = useState(false);


    useEffect(() => {
        loadData();
        loadSections();
    }, [showInactive]);

    const loadData = async () => {
        setLoading(true);
        try {
            const data = await fetchOperationTypes({ includeInactive: showInactive });
            setOperations(data);
        } catch (e) {
            console.error(e);
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
        } finally {
            setLoading(false);
        }
    };

    const loadSections = async () => {
        try {
            const structure = await fetchStructure();
            setSections(structure.sections || []);
        } catch (e) {
            console.error(e);
        }
    };


    const handleCreate = () => {
        setEditingOp({
            isNew: true,
            name: "",
            code: "",
            description: "",
            unit: "—à—Ç",
            normMinutes: undefined,
            sectionId: undefined,
            isActive: true,
            sortOrder: operations.length * 10
        });
    };

    const handleEdit = (op: OperationType) => {
        setEditingOp({ ...op });
    };

    const handleCancel = () => {
        setEditingOp(null);
    };

    const handleSave = async () => {
        if (!editingOp) return;

        if (!editingOp.name?.trim()) {
            toast.error("–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏");
            return;
        }

        try {
            if (editingOp.isNew) {
                await createOperationType({
                    name: editingOp.name,
                    code: editingOp.code || undefined,
                    description: editingOp.description || undefined,
                    unit: editingOp.unit || '—à—Ç',
                    normMinutes: editingOp.normMinutes || undefined,
                    sectionId: editingOp.sectionId || undefined,
                    sortOrder: editingOp.sortOrder || 0
                });
                toast.success("–û–ø–µ—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞");
            } else {
                await updateOperationType(editingOp.id!, {
                    name: editingOp.name,
                    code: editingOp.code,
                    description: editingOp.description,
                    unit: editingOp.unit,
                    normMinutes: editingOp.normMinutes,
                    sectionId: editingOp.sectionId,
                    isActive: editingOp.isActive,
                    sortOrder: editingOp.sortOrder
                });
                toast.success("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
            }

            setEditingOp(null);
            loadData();
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
    };

    const handleDelete = async (op: OperationType) => {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é "${op.name}"?`)) return;

        try {
            const result = await deleteOperationType(op.id);

            if (result.deactivated) {
                toast.success("–û–ø–µ—Ä–∞—Ü–∏—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ (–µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏)");
            } else {
                toast.success("–û–ø–µ—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞");
            }

            loadData();
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
        }
    };

    const handleToggleActive = async (op: OperationType) => {
        try {
            await updateOperationType(op.id, { isActive: !op.isActive });
            toast.success(op.isActive ? "–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ" : "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ");
            loadData();
        } catch (e: any) {
            toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞");
        }
    };


    if (!canManage) {
        return (
            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
                <AlertTriangle size={48} className="mx-auto mb-4 text-amber-400" />
                <h3 className="text-lg font-bold text-gray-800 mb-2">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h3>
                <p className="text-gray-500">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∞–º –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
                </p>
            </div>
        );
    }

    return (
        <div className="space-y-4">


            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex items-center justify-between">
                <div>
                    <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <Settings2 size={20} className="text-indigo-500" />
                        –¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π
                    </h2>
                    <p className="text-sm text-gray-500">
                        –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —É—á—ë—Ç–∞ –≤—ã—Ä–∞–±–æ—Ç–∫–∏
                    </p>
                </div>

                <div className="flex items-center gap-3">
                    <label className="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                        <input
                            type="checkbox"
                            checked={showInactive}
                            onChange={(e) => setShowInactive(e.target.checked)}
                            className="rounded border-gray-300"
                        />
                        –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ
                    </label>

                    <button
                        onClick={handleCreate}
                        className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium flex items-center gap-2 transition"
                    >
                        <Plus size={18} />
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>


            {editingOp && (
                <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <h3 className="font-bold text-blue-800 mb-4">
                        {editingOp.isNew ? "–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è" : "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"}
                    </h3>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label className="text-sm text-gray-600 mb-1 block">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input
                                type="text"
                                value={editingOp.name || ""}
                                onChange={(e) => setEditingOp({ ...editingOp, name: e.target.value })}
                                placeholder="–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞"
                                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
                            />
                        </div>

                        <div>
                            <label className="text-sm text-gray-600 mb-1 block">–ö–æ–¥ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)</label>
                            <input
                                type="text"
                                value={editingOp.code || ""}
                                onChange={(e) => setEditingOp({ ...editingOp, code: e.target.value.toUpperCase() })}
                                placeholder="CALIB"
                                className="w-full px-3 py-2 border border-gray-200 rounded-lg font-mono"
                            />
                        </div>

                        <div>
                            <label className="text-sm text-gray-600 mb-1 block">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                            <select
                                value={editingOp.unit || "—à—Ç"}
                                onChange={(e) => setEditingOp({ ...editingOp, unit: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
                            >
                                <option value="—à—Ç">—à—Ç (—à—Ç—É–∫–∏)</option>
                                <option value="–º">–º (–º–µ—Ç—Ä—ã)</option>
                                <option value="–∫–≥">–∫–≥ (–∫–∏–ª–æ–≥—Ä–∞–º–º—ã)</option>
                                <option value="–ª">–ª (–ª–∏—Ç—Ä—ã)</option>
                                <option value="—á–∞—Å">—á–∞—Å (—á–∞—Å—ã)</option>
                            </select>
                        </div>

                        <div>
                            <label className="text-sm text-gray-600 mb-1 block">–ù–æ—Ä–º–∞—Ç–∏–≤ (–º–∏–Ω—É—Ç –Ω–∞ –µ–¥.)</label>
                            <input
                                type="number"
                                step="0.1"
                                value={editingOp.normMinutes || ""}
                                onChange={(e) => setEditingOp({ ...editingOp, normMinutes: Number(e.target.value) || undefined })}
                                placeholder="5.0"
                                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
                            />
                        </div>

                        <div>
                            <label className="text-sm text-gray-600 mb-1 block">–£—á–∞—Å—Ç–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <select
                                value={editingOp.sectionId || ""}
                                onChange={(e) => setEditingOp({ ...editingOp, sectionId: Number(e.target.value) || undefined })}
                                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
                            >
                                <option value="">‚Äî –õ—é–±–æ–π —É—á–∞—Å—Ç–æ–∫ ‚Äî</option>
                                {sections.map(s => (
                                    <option key={s.id} value={s.id}>{s.title}</option>
                                ))}
                            </select>
                        </div>

                        <div>
                            <label className="text-sm text-gray-600 mb-1 block">–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
                            <input
                                type="number"
                                value={editingOp.sortOrder || 0}
                                onChange={(e) => setEditingOp({ ...editingOp, sortOrder: Number(e.target.value) })}
                                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
                            />
                        </div>

                        <div className="md:col-span-2 lg:col-span-3">
                            <label className="text-sm text-gray-600 mb-1 block">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea
                                value={editingOp.description || ""}
                                onChange={(e) => setEditingOp({ ...editingOp, description: e.target.value })}
                                placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏..."
                                rows={2}
                                className="w-full px-3 py-2 border border-gray-200 rounded-lg resize-none"
                            />
                        </div>
                    </div>

                    <div className="flex justify-end gap-2 mt-4">
                        <button
                            onClick={handleCancel}
                            className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg flex items-center gap-2"
                        >
                            <X size={18} />
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button
                            onClick={handleSave}
                            className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium flex items-center gap-2"
                        >
                            <Save size={18} />
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            )}


            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <table className="w-full text-sm">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-4 py-3 text-left font-medium text-gray-500 w-10">#</th>
                            <th className="px-4 py-3 text-left font-medium text-gray-500">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th className="px-4 py-3 text-left font-medium text-gray-500">–ö–æ–¥</th>
                            <th className="px-4 py-3 text-left font-medium text-gray-500">–ï–¥. –∏–∑–º.</th>
                            <th className="px-4 py-3 text-left font-medium text-gray-500">–ù–æ—Ä–º–∞—Ç–∏–≤</th>
                            <th className="px-4 py-3 text-left font-medium text-gray-500">–£—á–∞—Å—Ç–æ–∫</th>
                            <th className="px-4 py-3 text-center font-medium text-gray-500">–°—Ç–∞—Ç—É—Å</th>
                            <th className="px-4 py-3 text-center font-medium text-gray-500 w-32">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-50">
                        {loading ? (
                            <tr>
                                <td colSpan={8} className="px-4 py-8 text-center text-gray-400">
                                    <Clock size={24} className="mx-auto mb-2 animate-spin" />
                                    –ó–∞–≥—Ä—É–∑–∫–∞...
                                </td>
                            </tr>
                        ) : operations.length === 0 ? (
                            <tr>
                                <td colSpan={8} className="px-4 py-8 text-center text-gray-400">
                                    <Settings2 size={32} className="mx-auto mb-2 opacity-50" />
                                    <p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>
                                    <button
                                        onClick={handleCreate}
                                        className="mt-2 text-emerald-600 hover:text-emerald-700"
                                    >
                                        –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é
                                    </button>
                                </td>
                            </tr>
                        ) : (
                            operations.map((op, idx) => (
                                <tr
                                    key={op.id}
                                    className={`hover:bg-gray-50 ${!op.isActive ? 'opacity-50' : ''}`}
                                >
                                    <td className="px-4 py-3 text-gray-400">
                                        {idx + 1}
                                    </td>
                                    <td className="px-4 py-3">
                                        <div className="font-medium text-gray-800">{op.name}</div>
                                        {op.description && (
                                            <div className="text-xs text-gray-500 truncate max-w-xs">
                                                {op.description}
                                            </div>
                                        )}
                                    </td>
                                    <td className="px-4 py-3">
                                        {op.code ? (
                                            <span className="px-2 py-1 bg-gray-100 rounded font-mono text-xs">
                                                {op.code}
                                            </span>
                                        ) : (
                                            <span className="text-gray-300">‚Äî</span>
                                        )}
                                    </td>
                                    <td className="px-4 py-3 text-gray-600">
                                        {op.unit}
                                    </td>
                                    <td className="px-4 py-3 text-gray-600">
                                        {op.normMinutes ? (
                                            <span className="flex items-center gap-1">
                                                <Clock size={14} className="text-gray-400" />
                                                {op.normMinutes} –º–∏–Ω
                                            </span>
                                        ) : (
                                            <span className="text-gray-300">‚Äî</span>
                                        )}
                                    </td>
                                    <td className="px-4 py-3">
                                        {op.section ? (
                                            <span className="flex items-center gap-1 text-blue-600">
                                                <Building2 size={14} />
                                                {op.section.title}
                                            </span>
                                        ) : (
                                            <span className="text-gray-400">–õ—é–±–æ–π</span>
                                        )}
                                    </td>
                                    <td className="px-4 py-3 text-center">
                                        <button
                                            onClick={() => handleToggleActive(op)}
                                            className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${
                                                op.isActive
                                                    ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                                    : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                                            }`}
                                        >
                                            {op.isActive ? (
                                                <>
                                                    <CheckCircle2 size={12} />
                                                    –ê–∫—Ç–∏–≤–Ω–∞
                                                </>
                                            ) : (
                                                <>
                                                    <XCircle size={12} />
                                                    –ù–µ–∞–∫—Ç–∏–≤–Ω–∞
                                                </>
                                            )}
                                        </button>
                                    </td>
                                    <td className="px-4 py-3 text-center">
                                        <div className="flex items-center justify-center gap-1">
                                            <button
                                                onClick={() => handleEdit(op)}
                                                className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition"
                                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                            >
                                                <Edit2 size={16} />
                                            </button>
                                            <button
                                                onClick={() => handleDelete(op)}
                                                className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition"
                                                title="–£–¥–∞–ª–∏—Ç—å"
                                            >
                                                <Trash2 size={16} />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
});

export default ProductionSettings;

================================================================================
FILE: QMS-Client-main/src/pages/Profile/Profile.tsx
================================================================================

import { useEffect, useState, ChangeEvent } from "react";
import { fetchCurrentUser, updateUser, updateUserImg } from "src/api/userApi";
import { UserIcon } from "lucide-react";

export const Profile: React.FC = () => {
  const [currentUser, setCurrentUser] = useState({
    id: 0,
    login: "",
    password: "",
    role: "",
    name: "",
    surname: "",
    createdAt: "",
    updatedAt: "",
    img: "",
  });

  const [isEditing, setIsEditing] = useState(false);

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [isAvatarEditVisible, setAvatarEditVisible] = useState(false);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleAvatarUpload = async () => {
    if (!selectedFile) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏");
      return;
    }

    const formData = new FormData();
    formData.append("id", String(currentUser.id));
    formData.append("img", selectedFile);

    try {
      await updateUserImg(formData);
      setAvatarEditVisible(false);
      setSuccessMessage("—É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      refetchUser();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }
  };

  const refetchUser = () => {
    fetchCurrentUser(Number(localStorage.getItem("userID"))).then((data) => setCurrentUser(data));
  };

  useEffect(() => {
    fetchCurrentUser(Number(localStorage.getItem("userID"))).then((data) => setCurrentUser(data));
  }, []);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setCurrentUser((prevUser) => ({
      ...prevUser,
      [name]: value,
    }));
  };

  const handleEditToggle = () => {
    setIsEditing((prev) => !prev);
  };

  const handleSave = async () => {
    try {
      await updateUser(
        currentUser.id,
        currentUser.password,
        currentUser.name,
        currentUser.surname
      );
      setSuccessMessage("—É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ");
      setErrorMessage("");
      refetchUser();
    } catch (error: any) {
      setErrorMessage(
        `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:", error);
    }

    setIsEditing(false);
  };


  return (
    <div className="p-8 max-w-2xl mx-auto bg-gradient-to-br from-blue-50 to-purple-50 shadow-2xl rounded-3xl transform transition-all">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 text-center">
        –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      </h1>


      <div className="flex flex-col items-center mb-8">
  <div className="relative w-32 h-32 rounded-full overflow-hidden shadow-lg border-4 border-white hover:border-purple-500 transition-all duration-300">
    {currentUser.img ? (
      <img
        src={import.meta.env.VITE_API_URL + "/" + currentUser.img}
        alt=''
        className="w-full h-full object-cover"
      />
    ) : (
      <div className="w-full h-full flex items-center justify-center bg-blue-50">
        <UserIcon className="text-blue-600 w-16 h-16" />
      </div>
    )}
  </div>
</div>


      {isAvatarEditVisible ? (
        <div className="flex flex-col items-center mb-8">
          <input
            type="file"
            onChange={handleFileChange}
            className="mb-4 p-2 bg-white rounded-lg shadow-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={handleAvatarUpload}
          >
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
          </button>
        </div>
      ) : (
        <div className="flex justify-center mb-8">
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={() => setAvatarEditVisible(true)}
          >
            –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
          </button>
        </div>
      )}


<div className="space-y-6 bg-white p-8 rounded-2xl shadow-xl">

  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–õ–æ–≥–∏–Ω:</span>{" "}
    <span className="text-gray-900">{currentUser.login}</span>
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–ü–∞—Ä–æ–ª—å:</span>{" "}
    {isEditing ? (
      <input
        type="password"
        name="password"
        value={currentUser.password}
        onChange={handleInputChange}
        className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    ) : (
      <span className="text-gray-900">********</span>
    )}
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–†–æ–ª—å:</span>{" "}
    <span className="text-gray-900">{currentUser.role}</span>
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–ò–º—è:</span>{" "}
    {isEditing ? (
      <input
        name="name"
        value={currentUser.name}
        onChange={handleInputChange}
        className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    ) : (
      <span className="text-gray-900">{currentUser.name}</span>
    )}
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">–§–∞–º–∏–ª–∏—è:</span>{" "}
    {isEditing ? (
      <input
        name="surname"
        value={currentUser.surname}
        onChange={handleInputChange}
        className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    ) : (
      <span className="text-gray-900">{currentUser.surname}</span>
    )}
  </p>
</div>


<div className="mt-8 flex justify-center space-x-4">
  {isEditing ? (
    <>
      <button
        onClick={handleSave}
        className="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
      >
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
      </button>
      <button
        onClick={() => {
          handleEditToggle();
          refetchUser();
        }}
        className="bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
      >
        –û—Ç–º–µ–Ω–∞
      </button>
    </>
  ) : (
    <button
      onClick={handleEditToggle}
      className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
    >
      –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
    </button>
  )}
</div>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Rankings/RankingsChartsPage.tsx
================================================================================

import React, { useState, useMemo, useEffect } from "react";
import {
  TrendingUp, TrendingDown, Users, Briefcase, Factory,
  ArrowLeft, Layers, Activity, Loader2, RefreshCw,
  CalendarDays, FolderKanban
} from "lucide-react";
import {
  AreaChart, Area, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip,
  ResponsiveContainer, ReferenceLine, Legend
} from 'recharts';
import { useNavigate } from "react-router-dom";
import clsx from "clsx";
import { RANKINGS_ROUTE } from "src/utils/consts";
import { fetchRankings, RankingResponse, RankingsParams } from "src/api/rankingsApi";
import { fetchProjects } from "src/api/projectsApi";
import dayjs from "dayjs";

const COLORS = [
  "#10B981", "#3B82F6", "#F59E0B", "#EF4444", "#8B5CF6",
  "#EC4899", "#6366F1", "#14B8A6", "#F97316", "#06B6D4"
];

type Period = "day" | "week" | "month" | "year" | "all" | "custom";
type Tab = "users" | "teams" | "sections";

interface ProjectOption {
  id: number;
  title: string;
}

interface ChartAsset {
  id: number;
  name: string;
  fullName: string;
  current: number;
  change: string;
  history: { date: string; value: number }[];
  color: string;
}


const PERIOD_LABELS: Record<Period, string> = {
  day: "–î–µ–Ω—å",
  week: "–ù–µ–¥–µ–ª—è",
  month: "–ú–µ—Å—è—Ü",
  year: "–ì–æ–¥",
  all: "–í—Å—ë",
  custom: "–ü–µ—Ä–∏–æ–¥"
};


function getApiParams(
  period: Period,
  projectId: string,
  customStart?: string,
  customEnd?: string
): RankingsParams {
  const params: RankingsParams = { period };

  if (period === 'custom' && customStart && customEnd) {
    params.startDate = customStart;
    params.endDate = customEnd;
  }

  if (projectId) {
    params.projectId = projectId;
  }

  return params;
}

export const RankingsChartsPage: React.FC = () => {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<Tab>("users");
  const [viewMode, setViewMode] = useState<"individual" | "comparison">("individual");
  const [selectedId, setSelectedId] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);
  const [data, setData] = useState<RankingResponse | null>(null);


  const [projects, setProjects] = useState<ProjectOption[]>([]);
  const [selectedProjectId, setSelectedProjectId] = useState<string>("");


  const [period, setPeriod] = useState<Period>("all");
  const [customStart, setCustomStart] = useState(dayjs().subtract(30, 'day').format('YYYY-MM-DD'));
  const [customEnd, setCustomEnd] = useState(dayjs().format('YYYY-MM-DD'));
  const [showCustomPicker, setShowCustomPicker] = useState(false);


  useEffect(() => {
    fetchProjects()
      .then(setProjects)
      .catch(e => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:", e));
  }, []);


  const loadData = async () => {
    setLoading(true);

    const params = getApiParams(period, selectedProjectId, customStart, customEnd);
    console.log("[Analytics] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:", params);

    try {
      const res = await fetchRankings(params);
      console.log("[Analytics] –ü–æ–ª—É—á–µ–Ω–æ:", res.users?.length, "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");
      setData(res);
      setSelectedId(null);
    } catch (e) {
      console.error("[Analytics] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
    } finally {
      setLoading(false);
    }
  };


  useEffect(() => {
    loadData();
  }, [period, selectedProjectId]);


  const handlePeriodChange = (newPeriod: Period) => {
    if (newPeriod === 'custom') {
      setShowCustomPicker(true);
    } else {
      setShowCustomPicker(false);
    }
    setPeriod(newPeriod);
  };


  const applyCustomPeriod = () => {
    loadData();
  };


  const usersAssets: ChartAsset[] = useMemo(() => {
    if (!data?.users?.length) return [];

    return data.users.slice(0, 10).map((user, idx) => {
      const history = user.sparkline?.length > 0
        ? user.sparkline.map(p => ({
            date: dayjs(p.date).format('DD.MM'),
            value: p.value
          }))
        : [{ date: '–ò—Ç–æ–≥–æ', value: user.output }];

      const values = history.map(h => h.value);
      const startVal = values.length > 1 ? values.slice(0, Math.floor(values.length/2)).reduce((a,b) => a+b, 0) / Math.floor(values.length/2) : 0;
      const endVal = values.length > 1 ? values.slice(Math.floor(values.length/2)).reduce((a,b) => a+b, 0) / (values.length - Math.floor(values.length/2)) : values[0] || 0;
      const change = startVal > 0 ? ((endVal - startVal) / startVal * 100) : 0;

      return {
        id: user.id,
        name: (user.surname || '').substring(0, 3).toUpperCase(),
        fullName: (user.surname || '') + " " + (user.name || ''),
        current: user.output,
        change: change.toFixed(1),
        history,
        color: COLORS[idx % COLORS.length]
      };
    });
  }, [data]);


  const teamsAssets: ChartAsset[] = useMemo(() => {
    if (!data?.teams?.length) return [];

    return data.teams.slice(0, 10).map((team, idx) => {
      const history = team.sparkline?.length > 0
        ? team.sparkline.map(p => ({
            date: dayjs(p.date).format('DD.MM'),
            value: p.value
          }))
        : [{ date: '–ò—Ç–æ–≥–æ', value: team.totalOutput }];

      return {
        id: team.id,
        name: (team.title || '').substring(0, 4).toUpperCase(),
        fullName: team.title || `–ë—Ä–∏–≥–∞–¥–∞ ${team.id}`,
        current: team.totalOutput,
        change: "0",
        history,
        color: COLORS[idx % COLORS.length]
      };
    });
  }, [data]);


  const sectionsAssets: ChartAsset[] = useMemo(() => {
    if (!data?.sections?.length) return [];

    return data.sections.slice(0, 10).map((section, idx) => {
      const history = section.sparkline?.length > 0
        ? section.sparkline.map(p => ({
            date: dayjs(p.date).format('DD.MM'),
            value: p.value
          }))
        : [{ date: '–ò—Ç–æ–≥–æ', value: section.totalOutput }];

      return {
        id: section.id,
        name: (section.title || '').substring(0, 4).toUpperCase(),
        fullName: section.title || `–£—á–∞—Å—Ç–æ–∫ ${section.id}`,
        current: section.totalOutput,
        change: "0",
        history,
        color: COLORS[idx % COLORS.length]
      };
    });
  }, [data]);


  const assets = activeTab === "users" ? usersAssets : activeTab === "teams" ? teamsAssets : sectionsAssets;


  const selectedAsset = selectedId !== null
    ? assets.find(a => a.id === selectedId) || assets[0]
    : assets[0];

  const isPositive = selectedAsset ? Number(selectedAsset.change) >= 0 : true;
  const chartColor = isPositive ? "#10B981" : "#EF4444";


  const comparisonData = useMemo(() => {
    if (!assets.length || !assets[0]?.history?.length) return [];

    const maxLen = Math.max(...assets.map(a => a.history?.length || 0));
    if (maxLen === 0) return [];

    return Array.from({ length: maxLen }, (_, i) => {
      const point: Record<string, any> = { name: assets[0]?.history[i]?.date || "#" + (i + 1) };
      assets.forEach(asset => {
        point[asset.id] = asset.history[i]?.value || 0;
      });
      return point;
    });
  }, [assets]);


  const CustomComparisonTooltip = ({ active, payload, label }: any) => {
    if (!active || !payload?.length) return null;

    const sortedPayload = [...payload].sort((a, b) => b.value - a.value);

    return (
      <div className="bg-slate-900 border border-slate-700 p-3 rounded-xl shadow-2xl">
        <p className="text-slate-400 text-xs font-bold mb-2 uppercase tracking-wider">{label}</p>
        <div className="space-y-1">
          {sortedPayload.map((entry: any) => (
            <div key={entry.name} className="flex items-center justify-between gap-4 text-xs">
              <div className="flex items-center gap-2">
                <div className="w-2 h-2 rounded-full" style={{ backgroundColor: entry.color }} />
                <span className="text-slate-200 font-medium">{entry.name}</span>
              </div>
              <span className="font-mono font-bold text-white">{entry.value?.toLocaleString()}</span>
            </div>
          ))}
        </div>
      </div>
    );
  };


  const handleTabChange = (tab: Tab) => {
    setActiveTab(tab);
    setSelectedId(null);
  };


  const selectedProjectName = useMemo(() => {
    if (!selectedProjectId) return "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã";
    const project = projects.find(p => p.id === Number(selectedProjectId));
    return project?.title || "–ü—Ä–æ–µ–∫—Ç";
  }, [selectedProjectId, projects]);

  return (
    <div className="min-h-screen bg-[#0B0E14] text-slate-200 font-sans flex flex-col">


      <header className="border-b border-slate-800 bg-[#0B0E14] px-6 py-4 shrink-0 z-20">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-4">
            <button
              onClick={() => navigate(RANKINGS_ROUTE)}
              className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition"
            >
              <ArrowLeft size={20} />
            </button>
            <div>
              <h1 className="text-lg font-bold text-white flex items-center gap-2 tracking-tight">
                <Activity className="text-indigo-500" />
                –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
              </h1>
              <p className="text-[10px] text-slate-500 font-mono uppercase tracking-widest">
                {loading
                  ? '–ó–∞–≥—Ä—É–∑–∫–∞...'
                  : `${selectedProjectId ? (data as any)?.projectName || selectedProjectName : "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã"} | ${data?.users?.length || 0} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`
                }
              </p>
            </div>
          </div>


          <div className="flex bg-slate-900 border border-slate-800 p-1 rounded-lg">
            <button
              onClick={() => handleTabChange("users")}
              className={clsx(
                "px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center gap-2",
                activeTab === 'users'
                  ? "bg-indigo-600 text-white shadow-lg shadow-indigo-900/50"
                  : "text-slate-400 hover:text-slate-200 hover:bg-slate-800"
              )}
            >
              <Users size={14}/> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
              {data?.users?.length ? <span className="ml-1 text-xs opacity-70">({data.users.length})</span> : null}
            </button>
            <button
              onClick={() => handleTabChange("teams")}
              className={clsx(
                "px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center gap-2",
                activeTab === 'teams'
                  ? "bg-purple-600 text-white shadow-lg shadow-purple-900/50"
                  : "text-slate-400 hover:text-slate-200 hover:bg-slate-800"
              )}
            >
              <Briefcase size={14}/> –ë—Ä–∏–≥–∞–¥—ã
              {data?.teams?.length ? <span className="ml-1 text-xs opacity-70">({data.teams.length})</span> : null}
            </button>
            <button
              onClick={() => handleTabChange("sections")}
              className={clsx(
                "px-4 py-1.5 rounded-md text-sm font-bold transition flex items-center gap-2",
                activeTab === 'sections'
                  ? "bg-emerald-600 text-white shadow-lg shadow-emerald-900/50"
                  : "text-slate-400 hover:text-slate-200 hover:bg-slate-800"
              )}
            >
              <Factory size={14}/> –£—á–∞—Å—Ç–∫–∏
              {data?.sections?.length ? <span className="ml-1 text-xs opacity-70">({data.sections.length})</span> : null}
            </button>
          </div>


          <div className="flex items-center gap-3">
            <button
              onClick={loadData}
              disabled={loading}
              className={clsx(
                "p-2 rounded-lg transition",
                loading
                  ? "text-slate-600 cursor-not-allowed"
                  : "text-slate-400 hover:bg-slate-800 hover:text-white"
              )}
              title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"
            >
              <RefreshCw size={18} className={loading ? "animate-spin" : ""} />
            </button>

            <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
              <button
                onClick={() => setViewMode("individual")}
                className={clsx(
                  "px-3 py-1.5 rounded-md text-xs font-bold transition",
                  viewMode === 'individual'
                    ? "bg-slate-700 text-white"
                    : "text-slate-500 hover:text-slate-300"
                )}
              >
                –î–µ—Ç–∞–ª—å–Ω–æ
              </button>
              <button
                onClick={() => setViewMode("comparison")}
                className={clsx(
                  "px-3 py-1.5 rounded-md text-xs font-bold transition",
                  viewMode === 'comparison'
                    ? "bg-slate-700 text-white"
                    : "text-slate-500 hover:text-slate-300"
                )}
              >
                –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
              </button>
            </div>
          </div>
        </div>


        <div className="flex flex-wrap items-center gap-4">

          <div className="flex items-center gap-2">
            <FolderKanban size={16} className="text-emerald-500" />
            <select
              value={selectedProjectId}
              onChange={(e) => setSelectedProjectId(e.target.value)}
              disabled={loading}
              className="px-3 py-1.5 bg-slate-800 border border-slate-700 rounded-lg text-sm font-medium text-white focus:ring-2 focus:ring-emerald-500 min-w-[180px]"
            >
              <option value="">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
              {projects.map(p => (
                <option key={p.id} value={p.id}>{p.title}</option>
              ))}
            </select>
          </div>


          <div className="flex items-center gap-2">
            <CalendarDays size={16} className="text-indigo-400" />
            <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
              {(["day", "week", "month", "year", "all", "custom"] as Period[]).map(p => (
                <button
                  key={p}
                  onClick={() => handlePeriodChange(p)}
                  disabled={loading}
                  className={clsx(
                    "px-3 py-1 rounded-md text-xs font-bold transition",
                    period === p
                      ? "bg-indigo-600 text-white"
                      : "text-slate-400 hover:text-white hover:bg-slate-700",
                    loading && "opacity-50 cursor-not-allowed"
                  )}
                >
                  {PERIOD_LABELS[p]}
                </button>
              ))}
            </div>
          </div>


          {showCustomPicker && (
            <div className="flex items-center gap-2">
              <input
                type="date"
                value={customStart}
                onChange={e => setCustomStart(e.target.value)}
                className="px-2 py-1 bg-slate-800 border border-slate-700 rounded-lg text-xs text-white"
              />
              <span className="text-slate-500">‚Äî</span>
              <input
                type="date"
                value={customEnd}
                onChange={e => setCustomEnd(e.target.value)}
                className="px-2 py-1 bg-slate-800 border border-slate-700 rounded-lg text-xs text-white"
              />
              <button
                onClick={applyCustomPeriod}
                disabled={loading}
                className="px-3 py-1 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 disabled:opacity-50"
              >
                OK
              </button>
            </div>
          )}


          {data && (
            <div className="text-xs text-slate-500 ml-auto">
              {dayjs(data.startDate).format("DD.MM.YYYY")} ‚Äî {dayjs(data.endDate).format("DD.MM.YYYY")}
            </div>
          )}
        </div>
      </header>


      <div className="flex-1 flex overflow-hidden">


        {viewMode === 'individual' && (
          <aside className="w-72 border-r border-slate-800 bg-[#080A0F] overflow-y-auto">
            {loading ? (
              <div className="flex justify-center items-center h-40">
                <Loader2 className="animate-spin text-indigo-500" size={24} />
              </div>
            ) : assets.length === 0 ? (
              <div className="flex justify-center items-center h-40 text-slate-500 text-sm">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥
              </div>
            ) : (
              assets.map((item, idx) => {
                const isUp = Number(item.change) >= 0;
                const isSelected = item.id === (selectedAsset?.id ?? 0);

                return (
                  <div
                    key={item.id}
                    onClick={() => setSelectedId(item.id)}
                    className={clsx(
                      "px-4 py-3 border-b border-slate-800/50 cursor-pointer transition-all",
                      isSelected
                        ? "bg-slate-800/80 border-l-2 border-l-indigo-500"
                        : "hover:bg-slate-800/30"
                    )}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div
                          className="w-8 h-8 rounded-lg flex items-center justify-center text-white text-xs font-bold"
                          style={{ backgroundColor: item.color }}
                        >
                          {idx + 1}
                        </div>
                        <div>
                          <p className="text-sm font-semibold text-slate-200 truncate max-w-[120px]">
                            {item.fullName}
                          </p>
                          <p className="text-xs text-slate-500 font-mono">{item.name}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-sm font-bold text-white font-mono">
                          {item.current.toLocaleString()}
                        </p>
                        <div className={clsx(
                          "text-xs font-bold flex items-center justify-end gap-0.5",
                          isUp ? "text-emerald-500" : "text-red-500"
                        )}>
                          {isUp ? <TrendingUp size={12}/> : <TrendingDown size={12}/>}
                          {item.change}%
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </aside>
        )}


        <main className="flex-1 flex flex-col bg-[#0B0E14] relative">


          <div className="h-16 border-b border-slate-800 flex items-center justify-between px-8 bg-[#0B0E14]">
            {viewMode === 'individual' && selectedAsset ? (
              <div className="flex items-center gap-4">
                <div
                  className="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg"
                  style={{ backgroundColor: selectedAsset.color }}
                >
                  {selectedAsset.name[0]}
                </div>
                <div>
                  <h2 className="text-xl font-bold text-white leading-tight">{selectedAsset.fullName}</h2>
                  <span className="text-xs text-slate-500 font-mono tracking-wider">
                    ID: {selectedAsset.id} | {selectedAsset.history.length} —Ç–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö
                  </span>
                </div>
              </div>
            ) : (
              <div className="flex items-center gap-4">
                <div className="p-2 bg-slate-800 rounded-lg text-indigo-400">
                  <Layers size={24}/>
                </div>
                <div>
                  <h2 className="text-xl font-bold text-white leading-tight">–°–≤–æ–¥–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h2>
                  <span className="text-xs text-slate-500 font-mono tracking-wider">
                    –°—Ä–∞–≤–Ω–µ–Ω–∏–µ {assets.length} –æ–±—ä–µ–∫—Ç–æ–≤
                  </span>
                </div>
              </div>
            )}

            <div className="text-right">
              {viewMode === 'individual' && selectedAsset ? (
                <>
                  <div className={clsx(
                    "text-3xl font-black font-mono tracking-tight",
                    isPositive ? "text-emerald-400" : "text-red-400"
                  )}>
                    {selectedAsset.current.toLocaleString()}
                  </div>
                  <div className={clsx(
                    "text-xs font-bold uppercase tracking-wider",
                    isPositive ? "text-emerald-600" : "text-red-600"
                  )}>
                    –í—ã—Ä–∞–±–æ—Ç–∫–∞ –∑–∞ {PERIOD_LABELS[period]}
                  </div>
                </>
              ) : (
                <div className="flex -space-x-2">
                  {assets.slice(0, 5).map(a => (
                    <div
                      key={a.id}
                      className="w-8 h-8 rounded-full border-2 border-slate-900 flex items-center justify-center text-xs font-bold text-white"
                      style={{ backgroundColor: a.color }}
                    >
                      {a.name[0]}
                    </div>
                  ))}
                  {assets.length > 5 && (
                    <div className="w-8 h-8 rounded-full border-2 border-slate-900 bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-400">
                      +{assets.length - 5}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>


          <div className="flex-1 p-6 relative">
            {loading ? (
              <div className="h-full flex items-center justify-center">
                <Loader2 className="animate-spin text-indigo-500" size={48} />
              </div>
            ) : assets.length === 0 ? (
              <div className="h-full flex items-center justify-center text-slate-500">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
              </div>
            ) : (
              <ResponsiveContainer width="100%" height="100%">
                {viewMode === 'individual' && selectedAsset ? (
                  <AreaChart data={selectedAsset.history}>
                    <defs>
                      <linearGradient id="colorValue" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor={chartColor} stopOpacity={0.3}/>
                        <stop offset="95%" stopColor={chartColor} stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" vertical={false} />
                    <XAxis
                      dataKey="date"
                      stroke="#475569"
                      tick={{ fontSize: 12, fill: '#64748b' }}
                      axisLine={false}
                      tickLine={false}
                      dy={10}
                    />
                    <YAxis
                      stroke="#475569"
                      tick={{ fontSize: 12, fill: '#64748b' }}
                      axisLine={false}
                      tickLine={false}
                      domain={['auto', 'auto']}
                      dx={-10}
                    />
                    <Tooltip
                      contentStyle={{
                        backgroundColor: '#0f172a',
                        borderColor: '#334155',
                        color: '#f8fafc',
                        borderRadius: '12px',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.5)'
                      }}
                      itemStyle={{ color: chartColor, fontWeight: 'bold' }}
                      cursor={{ stroke: '#fff', strokeWidth: 1, strokeDasharray: '4 4' }}
                      formatter={(value: number) => [value.toLocaleString(), '–í—ã—Ä–∞–±–æ—Ç–∫–∞']}
                    />
                    <ReferenceLine y={selectedAsset.current} stroke="rgba(255,255,255,0.1)" strokeDasharray="3 3" />
                    <Area
                      type="monotone"
                      dataKey="value"
                      stroke={chartColor}
                      strokeWidth={3}
                      fillOpacity={1}
                      fill="url(#colorValue)"
                      animationDuration={1000}
                    />
                  </AreaChart>
                ) : (
                  <LineChart data={comparisonData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" vertical={false} />
                    <XAxis
                      dataKey="name"
                      stroke="#475569"
                      tick={{ fontSize: 12, fill: '#64748b' }}
                      axisLine={false}
                      tickLine={false}
                      dy={10}
                    />
                    <YAxis
                      stroke="#475569"
                      tick={{ fontSize: 12, fill: '#64748b' }}
                      axisLine={false}
                      tickLine={false}
                      domain={['auto', 'auto']}
                      dx={-10}
                    />
                    <Tooltip
                      content={<CustomComparisonTooltip />}
                      cursor={{ stroke: '#fff', strokeWidth: 1, strokeDasharray: '4 4' }}
                    />
                    <Legend wrapperStyle={{ paddingTop: '20px' }} />
                    {assets.map((asset) => (
                      <Line
                        key={asset.id}
                        type="monotone"
                        dataKey={asset.id}
                        name={asset.fullName}
                        stroke={asset.color}
                        strokeWidth={2}
                        dot={false}
                        activeDot={{ r: 6, strokeWidth: 0, fill: '#fff' }}
                        animationDuration={1500}
                      />
                    ))}
                  </LineChart>
                )}
              </ResponsiveContainer>
            )}
          </div>


          {data && !loading && (
            <div className="h-14 border-t border-slate-800 bg-[#080A0F] flex items-center justify-center gap-8 px-6">
              <div className="text-center">
                <div className="text-lg font-bold text-white">{data.totals?.totalOutput?.toLocaleString() || 0}</div>
                <div className="text-[10px] text-slate-500 uppercase">–í—Å–µ–≥–æ –≤—ã—Ä–∞–±–æ—Ç–∫–∞</div>
              </div>
              <div className="text-center">
                <div className="text-lg font-bold text-white">{data.users?.length || 0}</div>
                <div className="text-[10px] text-slate-500 uppercase">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
              </div>
              <div className="text-center">
                <div className="text-lg font-bold text-white">{data.teams?.length || 0}</div>
                <div className="text-[10px] text-slate-500 uppercase">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div className="text-center">
                <div className="text-lg font-bold text-white">{data.sections?.length || 0}</div>
                <div className="text-[10px] text-slate-500 uppercase">–£—á–∞—Å—Ç–∫–æ–≤</div>
              </div>
            </div>
          )}
        </main>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Rankings/RankingsPage.tsx
================================================================================

import React, { useEffect, useMemo, useState, useCallback } from "react";
import { useNavigate } from "react-router-dom";
import {
  Trophy, TrendingUp, TrendingDown, Users, Search, Factory,
  Medal, Star, Loader2, BarChart3, Boxes, Calendar, X, Minus
} from "lucide-react";
import { fetchRankings, RankingResponse, RankingUser, RankingTeam, Period, RankingsParams, SparklinePoint } from "src/api/rankingsApi";
import { LineChart, Line, ResponsiveContainer } from "recharts";
import clsx from "clsx";
import dayjs from "dayjs";

type Tab = "users" | "teams" | "sections";

const periodLabels: Record<Period, string> = {
  day: "–°–µ–≥–æ–¥–Ω—è",
  week: "–≠—Ç–∞ –Ω–µ–¥–µ–ª—è",
  month: "–≠—Ç–æ—Ç –º–µ—Å—è—Ü",
  year: "–ó–∞ –≥–æ–¥",
  all: "–í—Å—ë –≤—Ä–µ–º—è",
  custom: "–ü–µ—Ä–∏–æ–¥"
};

const mainPeriods: Period[] = ["day", "week", "month", "year", "all"];


const Sparkline: React.FC<{ data: SparklinePoint[]; color?: string }> = ({ data, color }) => {
  if (!data || data.length < 2) {
    return <div className="w-20 h-8 flex items-center justify-center text-slate-300">‚Äî</div>;
  }


  const firstValue = data[0]?.value || 0;
  const lastValue = data[data.length - 1]?.value || 0;
  const isUp = lastValue >= firstValue;
  const lineColor = color || (isUp ? "#10b981" : "#ef4444");

  return (
    <div className="w-20 h-8">
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={data}>
          <Line
            type="monotone"
            dataKey="value"
            stroke={lineColor}
            strokeWidth={1.5}
            dot={false}
          />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
};


const ChangeIndicator: React.FC<{ change: number; showPercent?: boolean }> = ({ change, showPercent }) => {
  if (change === 0) {
    return (
      <div className="flex items-center gap-1 text-slate-400">
        <Minus size={14} />
        <span className="text-sm font-medium">0</span>
      </div>
    );
  }

  const isPositive = change > 0;

  return (
    <div className={clsx(
      "flex items-center gap-1",
      isPositive ? "text-emerald-600" : "text-red-500"
    )}>
      {isPositive ? <TrendingUp size={14} /> : <TrendingDown size={14} />}
      <span className="text-sm font-bold">
        {isPositive ? "+" : ""}{change}
      </span>
    </div>
  );
};

const RankingsPage: React.FC = () => {
  const navigate = useNavigate();
  const [period, setPeriod] = useState<Period>("week");
  const [activeTab, setActiveTab] = useState<Tab>("users");
  const [data, setData] = useState<RankingResponse | null>(null);
  const [loading, setLoading] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");

  const [showDatePicker, setShowDatePicker] = useState(false);
  const [customStartDate, setCustomStartDate] = useState<string>("");
  const [customEndDate, setCustomEndDate] = useState<string>("");
  const [appliedDateRange, setAppliedDateRange] = useState<{ start: string; end: string } | null>(null);

  const loadData = useCallback(async (params: RankingsParams) => {
    setLoading(true);
    try {
      const res = await fetchRankings(params);
      setData(res);
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    if (period === "custom" && appliedDateRange) {
      loadData({
        period: "custom",
        startDate: appliedDateRange.start,
        endDate: appliedDateRange.end
      });
    } else if (period !== "custom") {
      loadData({ period });
    }
  }, [period, appliedDateRange, loadData]);

  const handlePeriodChange = (newPeriod: Period) => {
    if (newPeriod === "custom") {
      setShowDatePicker(true);
    } else {
      setPeriod(newPeriod);
      setShowDatePicker(false);
      setAppliedDateRange(null);
    }
  };

  const applyCustomRange = () => {
    if (customStartDate && customEndDate) {
      setAppliedDateRange({
        start: customStartDate,
        end: customEndDate
      });
      setPeriod("custom");
      setShowDatePicker(false);
    }
  };

  const resetCustomRange = () => {
    setCustomStartDate("");
    setCustomEndDate("");
    setAppliedDateRange(null);
    setShowDatePicker(false);
    setPeriod("week");
  };

  const applyPreset = (days: number) => {
    const end = dayjs().format("YYYY-MM-DD");
    const start = dayjs().subtract(days, "day").format("YYYY-MM-DD");
    setCustomStartDate(start);
    setCustomEndDate(end);
  };

  const sectionsStats = useMemo(() => {
    if (!data?.teams) return [];
    const map = new Map();
    data.teams.forEach(team => {
      const sectionName = team.section || "–ë–µ–∑ —É—á–∞—Å—Ç–∫–∞";
      if (!map.has(sectionName)) {
        map.set(sectionName, {
          title: sectionName,
          totalOutput: 0,
          warehouseOutput: 0,
          productionOutput: 0,
          totalMembers: 0,
          teamsCount: 0
        });
      }
      const s = map.get(sectionName);
      s.totalOutput += team.totalOutput;
      s.warehouseOutput += team.warehouseOutput;
      s.productionOutput += team.productionOutput;
      s.totalMembers += team.membersCount;
      s.teamsCount += 1;
    });
    return Array.from(map.values()).sort((a: any, b: any) => b.totalOutput - a.totalOutput);
  }, [data]);

  const filteredUsers = data?.users.filter(u =>
    u.surname.toLowerCase().includes(searchTerm.toLowerCase()) ||
    u.teamName.toLowerCase().includes(searchTerm.toLowerCase())
  ) || [];

  const filteredTeams = data?.teams.filter(t =>
    t.title.toLowerCase().includes(searchTerm.toLowerCase())
  ) || [];

  const formatDateRange = () => {
    if (appliedDateRange) {
      const start = dayjs(appliedDateRange.start).format("DD.MM.YYYY");
      const end = dayjs(appliedDateRange.end).format("DD.MM.YYYY");
      return `${start} ‚Äî ${end}`;
    }
    return periodLabels[period];
  };

  return (
    <div className="min-h-screen bg-slate-50 pb-20 font-sans text-slate-800">


      <div className="bg-slate-900 pt-8 pb-32 px-6 rounded-b-[3rem] shadow-2xl relative overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-full overflow-hidden opacity-20 pointer-events-none">
          <div className="absolute -top-24 -right-24 w-96 h-96 bg-indigo-500 rounded-full blur-[100px]"></div>
          <div className="absolute top-1/2 left-1/4 w-64 h-64 bg-emerald-500 rounded-full blur-[80px]"></div>
        </div>

        <div className="max-w-7xl mx-auto relative z-10">
          <div className="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div>
              <h1 className="text-4xl font-black text-white tracking-tight flex items-center gap-3">
                <Trophy className="text-yellow-400 fill-yellow-400" size={36}/>
                –¶–µ–Ω—Ç—Ä –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
              </h1>
              <p className="text-slate-400 mt-2 font-medium">
                –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
              </p>
            </div>


            <div className="flex flex-col items-end gap-2">
              <div className="bg-slate-800/50 backdrop-blur-md p-1.5 rounded-xl flex flex-wrap gap-1 border border-slate-700/50">
                {mainPeriods.map(p => (
                  <button
                    key={p}
                    onClick={() => handlePeriodChange(p)}
                    className={clsx(
                      "px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap",
                      period === p && !appliedDateRange
                        ? "bg-indigo-600 text-white shadow-lg"
                        : "text-slate-400 hover:text-white hover:bg-slate-700/50"
                    )}
                  >
                    {periodLabels[p]}
                  </button>
                ))}

                <button
                  onClick={() => setShowDatePicker(!showDatePicker)}
                  className={clsx(
                    "px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2",
                    appliedDateRange
                      ? "bg-indigo-600 text-white shadow-lg"
                      : "text-slate-400 hover:text-white hover:bg-slate-700/50"
                  )}
                >
                  <Calendar size={16} />
                  {appliedDateRange ? formatDateRange() : "–ü–µ—Ä–∏–æ–¥"}
                </button>
              </div>


              {showDatePicker && (
                <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 shadow-2xl mt-2 w-80">
                  <div className="flex justify-between items-center mb-4">
                    <span className="text-white font-semibold">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥</span>
                    <button
                      onClick={() => setShowDatePicker(false)}
                      className="text-slate-400 hover:text-white"
                    >
                      <X size={18} />
                    </button>
                  </div>

                  <div className="flex flex-wrap gap-2 mb-4">
                    {[
                      { label: "7 –¥–Ω–µ–π", days: 7 },
                      { label: "14 –¥–Ω–µ–π", days: 14 },
                      { label: "30 –¥–Ω–µ–π", days: 30 },
                      { label: "90 –¥–Ω–µ–π", days: 90 },
                    ].map(preset => (
                      <button
                        key={preset.days}
                        onClick={() => applyPreset(preset.days)}
                        className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300 transition"
                      >
                        {preset.label}
                      </button>
                    ))}
                  </div>

                  <div className="space-y-3">
                    <div>
                      <label className="text-slate-400 text-xs mb-1 block">–ù–∞—á–∞–ª–æ</label>
                      <input
                        type="date"
                        value={customStartDate}
                        onChange={(e) => setCustomStartDate(e.target.value)}
                        max={customEndDate || undefined}
                        className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      />
                    </div>
                    <div>
                      <label className="text-slate-400 text-xs mb-1 block">–ö–æ–Ω–µ—Ü</label>
                      <input
                        type="date"
                        value={customEndDate}
                        onChange={(e) => setCustomEndDate(e.target.value)}
                        min={customStartDate || undefined}
                        max={dayjs().format("YYYY-MM-DD")}
                        className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      />
                    </div>
                  </div>

                  <div className="flex gap-2 mt-4">
                    <button
                      onClick={resetCustomRange}
                      className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm text-slate-300 transition"
                    >
                      –°–±—Ä–æ—Å–∏—Ç—å
                    </button>
                    <button
                      onClick={applyCustomRange}
                      disabled={!customStartDate || !customEndDate}
                      className={clsx(
                        "flex-1 px-4 py-2 rounded-lg text-sm font-bold transition",
                        customStartDate && customEndDate
                          ? "bg-indigo-600 hover:bg-indigo-500 text-white"
                          : "bg-slate-700 text-slate-500 cursor-not-allowed"
                      )}
                    >
                      –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>


          {data?.totals && (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-slate-800/60 backdrop-blur-md rounded-2xl p-4 border border-slate-700/50">
                <div className="flex items-center gap-2 text-slate-400 mb-2">
                  <BarChart3 size={16} />
                  <span className="text-xs uppercase">–í—Å–µ–≥–æ</span>
                </div>
                <div className="text-3xl font-black text-white">
                  {data.totals.totalOutput.toLocaleString()}
                </div>
              </div>

              <div className="bg-slate-800/60 backdrop-blur-md rounded-2xl p-4 border border-slate-700/50">
                <div className="flex items-center gap-2 text-blue-400 mb-2">
                  <Boxes size={16} />
                  <span className="text-xs uppercase">–°–∫–ª–∞–¥</span>
                </div>
                <div className="text-3xl font-black text-white">
                  {data.totals.warehouseOutput.toLocaleString()}
                </div>
              </div>

              <div className="bg-slate-800/60 backdrop-blur-md rounded-2xl p-4 border border-slate-700/50">
                <div className="flex items-center gap-2 text-emerald-400 mb-2">
                  <Factory size={16} />
                  <span className="text-xs uppercase">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</span>
                </div>
                <div className="text-3xl font-black text-white">
                  {data.totals.productionOutput.toLocaleString()}
                </div>
              </div>

              <div className="bg-slate-800/60 backdrop-blur-md rounded-2xl p-4 border border-slate-700/50">
                <div className="flex items-center gap-2 text-slate-400 mb-2">
                  <Users size={16} />
                  <span className="text-xs uppercase">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
                </div>
                <div className="text-3xl font-black text-white">
                  {data.totals.usersCount}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>


      <div className="max-w-7xl mx-auto px-6 -mt-16 relative z-20">


        <div className="bg-white rounded-2xl shadow-xl p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
          <div className="flex gap-2">
            {[
              { id: "users", label: "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏", icon: Users },
              { id: "teams", label: "–ë—Ä–∏–≥–∞–¥—ã", icon: Medal },
              { id: "sections", label: "–£—á–∞—Å—Ç–∫–∏", icon: Star }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as Tab)}
                className={clsx(
                  "px-4 py-2 rounded-xl font-semibold text-sm flex items-center gap-2 transition",
                  activeTab === tab.id
                    ? "bg-indigo-100 text-indigo-700"
                    : "text-slate-500 hover:bg-slate-100"
                )}
              >
                <tab.icon size={16} />
                {tab.label}
              </button>
            ))}
          </div>

          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
            <input
              type="text"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="–ü–æ–∏—Å–∫..."
              className="pl-10 pr-4 py-2 border border-slate-200 rounded-xl text-sm w-64 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            />
          </div>
        </div>

        {loading ? (
          <div className="flex justify-center py-20">
            <Loader2 className="animate-spin text-indigo-600" size={40} />
          </div>
        ) : (
          <>

            {activeTab === "users" && (
              <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
                <table className="w-full">
                  <thead className="bg-slate-50 text-xs text-slate-500 uppercase">
                    <tr>
                      <th className="px-4 py-3 text-left w-12">#</th>
                      <th className="px-4 py-3 text-left">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                      <th className="px-4 py-3 text-left">–ë—Ä–∏–≥–∞–¥–∞</th>
                      <th className="px-4 py-3 text-right">
                        <div className="flex items-center justify-end gap-1">
                          <Boxes size={14} className="text-blue-500" />
                          –°–∫–ª–∞–¥
                        </div>
                      </th>
                      <th className="px-4 py-3 text-right">
                        <div className="flex items-center justify-end gap-1">
                          <Factory size={14} className="text-emerald-500" />
                          –ü—Ä–æ–∏–∑–≤.
                        </div>
                      </th>
                      <th className="px-4 py-3 text-right font-bold">–ò—Ç–æ–≥–æ</th>
                      <th className="px-4 py-3 text-center">–î–∏–Ω–∞–º–∏–∫–∞</th>
                      <th className="px-4 py-3 text-right">+/‚àí</th>
                      <th className="px-4 py-3 text-right">–≠—Ñ—Ñ–µ–∫—Ç.</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {filteredUsers.map((user, idx) => (
                      <tr
                        key={user.id}
                        className={clsx(
                          "hover:bg-slate-50 transition cursor-pointer",
                          idx < 3 && "bg-yellow-50/30"
                        )}
                      >
                        <td className="px-4 py-4">
                          {idx < 3 ? (
                            <div className={clsx(
                              "w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm",
                              idx === 0 && "bg-yellow-400 text-yellow-900",
                              idx === 1 && "bg-slate-300 text-slate-700",
                              idx === 2 && "bg-orange-300 text-orange-900"
                            )}>
                              {user.place}
                            </div>
                          ) : (
                            <span className="text-slate-400 font-medium">{user.place}</span>
                          )}
                        </td>
                        <td className="px-4 py-4">
                          <div className="flex items-center gap-3">
                            {user.avatar ? (
                              <img
                                src={`${import.meta.env.VITE_API_URL}/${user.avatar}`}
                                alt=""
                                className="w-10 h-10 rounded-full object-cover"
                              />
                            ) : (
                              <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">
                                {user.surname[0]}{user.name[0]}
                              </div>
                            )}
                            <div>
                              <p className="font-semibold text-slate-800">
                                {user.surname} {user.name}
                              </p>
                              <p className="text-xs text-slate-400">{user.sectionName}</p>
                            </div>
                          </div>
                        </td>
                        <td className="px-4 py-4 text-sm text-slate-600">
                          {user.teamName}
                        </td>
                        <td className="px-4 py-4 text-right">
                          <span className="font-medium text-blue-600">
                            {user.warehouseOutput > 0 ? user.warehouseOutput : "‚Äî"}
                          </span>
                        </td>
                        <td className="px-4 py-4 text-right">
                          <span className="font-medium text-emerald-600">
                            {user.productionOutput > 0 ? user.productionOutput : "‚Äî"}
                          </span>
                        </td>
                        <td className="px-4 py-4 text-right">
                          <span className="text-xl font-black text-slate-800">
                            {user.output}
                          </span>
                        </td>

                        <td className="px-4 py-4">
                          <div className="flex justify-center">
                            <Sparkline data={user.sparkline} />
                          </div>
                        </td>

                        <td className="px-4 py-4 text-right">
                          <ChangeIndicator change={user.dailyChange?.change || 0} />
                        </td>
                        <td className="px-4 py-4 text-right">
                          <span className={clsx(
                            "px-2 py-0.5 rounded-full text-xs font-bold",
                            user.efficiency >= 95 && "bg-emerald-100 text-emerald-700",
                            user.efficiency >= 80 && user.efficiency < 95 && "bg-yellow-100 text-yellow-700",
                            user.efficiency < 80 && "bg-red-100 text-red-700"
                          )}>
                            {user.efficiency}%
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>

                {filteredUsers.length === 0 && (
                  <div className="text-center py-20 text-slate-500">
                    –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
                  </div>
                )}
              </div>
            )}


            {activeTab === "teams" && (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredTeams.map((team, idx) => (
                  <div
                    key={team.id}
                    className={clsx(
                      "bg-white rounded-2xl shadow-lg p-6 border-l-4 transition hover:shadow-xl",
                      idx === 0 && "border-yellow-400",
                      idx === 1 && "border-slate-400",
                      idx === 2 && "border-orange-400",
                      idx > 2 && "border-slate-200"
                    )}
                  >
                    <div className="flex items-start justify-between mb-4">
                      <div>
                        <h3 className="font-bold text-slate-800 text-lg">{team.title}</h3>
                        <p className="text-sm text-slate-500">{team.section}</p>
                      </div>
                      <div className={clsx(
                        "w-10 h-10 rounded-xl flex items-center justify-center font-bold",
                        idx === 0 && "bg-yellow-100 text-yellow-700",
                        idx === 1 && "bg-slate-200 text-slate-700",
                        idx === 2 && "bg-orange-100 text-orange-700",
                        idx > 2 && "bg-slate-100 text-slate-500"
                      )}>
                        {idx + 1}
                      </div>
                    </div>

                    <div className="text-4xl font-black text-slate-800 mb-2">
                      {team.totalOutput.toLocaleString()}
                    </div>

                    <div className="flex gap-4 mb-4 text-sm">
                      <div className="flex items-center gap-1">
                        <Boxes size={14} className="text-blue-500" />
                        <span className="text-blue-600 font-medium">{team.warehouseOutput}</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <Factory size={14} className="text-emerald-500" />
                        <span className="text-emerald-600 font-medium">{team.productionOutput}</span>
                      </div>
                    </div>

                    <div className="flex items-center justify-between text-sm text-slate-500">
                      <span>{team.membersCount} —á–µ–ª.</span>
                      <span>–≠—Ñ—Ñ. {team.avgEfficiency}%</span>
                    </div>

                    <div className="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all"
                        style={{ width: `${team.progress}%` }}
                      />
                    </div>
                  </div>
                ))}
              </div>
            )}


            {activeTab === "sections" && (
              <div className="space-y-4">
                {sectionsStats.map((section: any, idx: number) => (
                  <div
                    key={section.title}
                    className="bg-white rounded-2xl shadow-lg p-6 flex items-center gap-6"
                  >
                    <div className={clsx(
                      "w-14 h-14 rounded-2xl flex items-center justify-center text-2xl font-black",
                      idx === 0 && "bg-yellow-100 text-yellow-700",
                      idx === 1 && "bg-slate-200 text-slate-700",
                      idx === 2 && "bg-orange-100 text-orange-700",
                      idx > 2 && "bg-slate-100 text-slate-500"
                    )}>
                      {idx + 1}
                    </div>

                    <div className="flex-1">
                      <h3 className="font-bold text-slate-800 text-xl">{section.title}</h3>
                      <p className="text-sm text-slate-500">
                        {section.teamsCount} –±—Ä–∏–≥–∞–¥ ‚Ä¢ {section.totalMembers} —á–µ–ª–æ–≤–µ–∫
                      </p>
                    </div>

                    <div className="flex gap-8 items-center">
                      <div className="text-center">
                        <div className="flex items-center gap-1 text-blue-600 mb-1">
                          <Boxes size={16} />
                          <span className="text-2xl font-bold">{section.warehouseOutput.toLocaleString()}</span>
                        </div>
                        <p className="text-xs text-slate-400">–°–∫–ª–∞–¥</p>
                      </div>

                      <div className="text-center">
                        <div className="flex items-center gap-1 text-emerald-600 mb-1">
                          <Factory size={16} />
                          <span className="text-2xl font-bold">{section.productionOutput.toLocaleString()}</span>
                        </div>
                        <p className="text-xs text-slate-400">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</p>
                      </div>

                      <div className="text-center border-l border-slate-200 pl-8">
                        <div className="text-3xl font-black text-slate-800">
                          {section.totalOutput.toLocaleString()}
                        </div>
                        <p className="text-xs text-slate-400">–í—Å–µ–≥–æ</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
};

export default RankingsPage;

================================================================================
FILE: QMS-Client-main/src/pages/StartPage/StartPage.tsx
================================================================================

import React, { useState, useEffect, useContext } from "react";
import { Context } from "src/main";
import { observer } from "mobx-react-lite";
import { useNavigate } from "react-router-dom";
import clsx from "clsx";
import {
  Zap, Box, Activity, ArrowRight, Clock,
  PlayCircle, Users, BookOpen, Settings,
  Cpu, ClipboardList, BarChart3, Radio, Server,
  Monitor, Laptop, RefreshCw, AlertTriangle, CheckCircle2, Circle
} from "lucide-react";
import {
  BETAFLIGHT_ROUTE,
  WAREHOUSE_ROUTE,
  KNOWLEDGE_BASE_ROUTE,
  TASKS_ROUTE,
  RECIPE_EXECUTION_ROUTE,
  ADMIN_ROUTE,
  RANKINGS_ROUTE
} from "src/utils/consts";
import { fetchPC, fetchSession, fetchUsers } from "src/api/fcApi";


const UPDATES = [
    { ver: "2.04", date: "21.01", desc: "–í–∏–¥–∂–µ—Ç –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π." },
    { ver: "2.03", date: "18.09", desc: "–î–æ–±–∞–≤–ª–µ–Ω PRO-—Ä–µ–∂–∏–º –ø—Ä–æ—à–∏–≤–∫–∏ FC." },
    { ver: "2.02", date: "05.09", desc: "–ù–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö." },
];


const HeroCard = ({ title, sub, icon: Icon, to }: any) => {
    const navigate = useNavigate();
    return (
        <div
            onClick={() => navigate(to)}
            className="group relative col-span-1 md:col-span-2 lg:col-span-2 row-span-2 cursor-pointer overflow-hidden rounded-[2.5rem] bg-gradient-to-br from-indigo-600 to-violet-700 p-8 text-white shadow-2xl shadow-indigo-200 transition-all duration-500 hover:-translate-y-1 hover:shadow-indigo-300"
        >
            <div className="absolute -right-20 -top-20 h-64 w-64 rounded-full bg-white opacity-10 blur-3xl transition-transform duration-700 group-hover:scale-150"></div>
            <div className="absolute bottom-0 left-0 h-40 w-full bg-gradient-to-t from-black/20 to-transparent"></div>

            <div className="relative z-10 flex h-full flex-col justify-between">
                <div className="flex items-start justify-between">
                    <div className="rounded-2xl bg-white/20 p-4 backdrop-blur-md transition-transform duration-300 group-hover:rotate-12">
                        <Icon size={32} className="text-white" />
                    </div>
                    <div className="rounded-full border border-white/20 bg-white/10 px-3 py-1 text-xs font-bold uppercase tracking-wider backdrop-blur-md">
                        –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å
                    </div>
                </div>

                <div>
                    <h2 className="text-3xl font-black leading-tight tracking-tight md:text-4xl">{title}</h2>
                    <p className="mt-2 max-w-sm text-sm font-medium text-indigo-100 opacity-90">{sub}</p>
                    <div className="mt-6 flex items-center gap-2 font-bold text-white opacity-0 transition-all duration-300 group-hover:translate-x-2 group-hover:opacity-100">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞–±–æ—Ç–µ <ArrowRight size={18} />
                    </div>
                </div>
            </div>
        </div>
    );
};


const InfoTile = ({ title, sub, icon: Icon, to, colorClass, iconColor }: any) => {
    const navigate = useNavigate();
    return (
        <div
            onClick={() => navigate(to)}
            className="group relative flex cursor-pointer flex-col justify-between overflow-hidden rounded-[2rem] border border-slate-100 bg-white p-6 shadow-sm transition-all duration-300 hover:-translate-y-1 hover:shadow-xl col-span-1"
        >
            <div className={clsx("absolute -right-4 -top-4 h-24 w-24 rounded-full opacity-5 transition-transform duration-500 group-hover:scale-150", colorClass)}></div>
            <div className="flex items-start justify-between">
                <div className={clsx("rounded-2xl p-3 shadow-sm transition-transform duration-300 group-hover:scale-110", colorClass)}>
                    <Icon size={24} className={iconColor} strokeWidth={2} />
                </div>
            </div>
            <div className="mt-4">
                <h3 className="text-lg font-bold text-slate-800 transition-colors group-hover:text-indigo-600">{title}</h3>
                <p className="mt-1 text-xs font-medium text-slate-400">{sub}</p>
            </div>
        </div>
    );
};


const SystemWidget = () => (
    <div className="col-span-1 md:col-span-1 lg:row-span-2 flex flex-col gap-4">
        <div className="flex-1 rounded-[2rem] border border-slate-100 bg-white p-6 shadow-sm relative overflow-hidden">
             <div className="mb-4 flex items-center justify-between">
                <h3 className="font-bold text-slate-700 flex items-center gap-2">
                    <Activity size={18} className="text-emerald-500"/> –°—Ç–∞—Ç—É—Å
                </h3>
                <span className="flex h-2.5 w-2.5">
                  <span className="absolute inline-flex h-2.5 w-2.5 animate-ping rounded-full bg-emerald-400 opacity-75"></span>
                  <span className="relative inline-flex h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
                </span>
             </div>
             <div className="space-y-4">
                 <div className="flex items-center justify-between rounded-xl bg-slate-50 p-3">
                     <div className="flex items-center gap-3">
                         <div className="rounded-lg bg-white p-1.5 shadow-sm"><Server size={14} className="text-slate-500"/></div>
                         <div className="text-xs font-bold text-slate-600">Core API</div>
                     </div>
                     <span className="text-[10px] font-bold text-emerald-600">ONLINE</span>
                 </div>
                 <div className="flex items-center justify-between rounded-xl bg-slate-50 p-3">
                     <div className="flex items-center gap-3">
                         <div className="rounded-lg bg-white p-1.5 shadow-sm"><Radio size={14} className="text-slate-500"/></div>
                         <div className="text-xs font-bold text-slate-600">MQTT</div>
                     </div>
                     <span className="text-[10px] font-bold text-emerald-600">ACTIVE</span>
                 </div>
             </div>
        </div>

        <div className="flex-1 rounded-[2rem] border border-slate-100 bg-slate-900 p-6 text-slate-300 shadow-lg relative overflow-hidden group">
            <div className="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>
            <h3 className="mb-4 flex items-center gap-2 text-sm font-bold text-white uppercase tracking-wider">
                <Zap size={16} className="text-yellow-400 fill-yellow-400"/> Updates
            </h3>
            <div className="space-y-3">
                {UPDATES.map((u, i) => (
                    <div key={i} className="flex items-start gap-3 text-xs">
                        <span className="font-mono text-indigo-400 min-w-[32px]">{u.ver}</span>
                        <p className="leading-snug opacity-80">{u.desc}</p>
                    </div>
                ))}
            </div>
        </div>
    </div>
);


interface OnlineUser {
  id: number;
  name: string;
  surname: string;
  role: string;
  pcName: string | null;
  isPersonalLaptop: boolean;
}

const OnlineUsersWidget = () => {
    const context = useContext(Context);
    const { flightController } = context || {};

    const [onlineUsers, setOnlineUsers] = useState<OnlineUser[]>([]);
    const [loading, setLoading] = useState(true);
    const [lastUpdate, setLastUpdate] = useState<Date>(new Date());

    const loadOnlineUsers = async () => {
        try {
            setLoading(true);
            const [sessions, users, pcs] = await Promise.all([
                fetchSession(),
                fetchUsers(),
                fetchPC().catch(() => [])
            ]);

            const activeSessions = sessions.filter((s: any) => s.online === true);

            const online: OnlineUser[] = activeSessions.map((session: any) => {
                const user = users.find((u: any) => u.id === session.userId);
                const pc = pcs.find((p: any) => p.id === session.PCId);
                return {
                    id: user?.id || 0,
                    name: user?.name || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",
                    surname: user?.surname || "",
                    role: user?.role || "USER",
                    pcName: pc?.pc_name || null,
                    isPersonalLaptop: session.PCId === null
                };
            });

            const uniqueOnline = online.filter((user, index, self) =>
                index === self.findIndex(u => u.id === user.id)
            );

            setOnlineUsers(uniqueOnline);
            setLastUpdate(new Date());
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", e);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        loadOnlineUsers();
        const interval = setInterval(loadOnlineUsers, 30000);
        return () => clearInterval(interval);
    }, []);

    const getRoleLabel = (role: string) => {
        const roles: Record<string, string> = {
            SUPER_ADMIN: "–ê–¥–º–∏–Ω", ADMIN: "–ê–¥–º–∏–Ω", PRODUCTION_CHIEF: "–ù–∞—á. –ø—Ä.",
            WAREHOUSE_MASTER: "–°–∫–ª–∞–¥", TECHNOLOGIST: "–¢–µ—Ö–Ω.", ASSEMBLER: "–°–±–æ—Ä—â–∏–∫",
            REPAIR: "–†–µ–º–æ–Ω—Ç", OTK: "–û–¢–ö", USER: "User"
        };
        return roles[role] || role;
    };

    const canReboot = onlineUsers.length === 0;

    return (
        <div className="col-span-1 md:col-span-2 row-span-2 rounded-[2rem] border border-slate-100 bg-white shadow-sm overflow-hidden flex flex-col">

            <div className="p-5 border-b border-slate-100 flex-shrink-0">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className={clsx(
                            "p-2.5 rounded-xl",
                            onlineUsers.length > 0 ? "bg-emerald-100" : "bg-slate-100"
                        )}>
                            <Users size={20} className={onlineUsers.length > 0 ? "text-emerald-600" : "text-slate-500"} />
                        </div>
                        <div>
                            <h3 className="font-bold text-slate-800">–°–µ–π—á–∞—Å –≤ —Å–∏—Å—Ç–µ–º–µ</h3>
                            <p className="text-xs text-slate-400">
                                –û–±–Ω: {lastUpdate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
                            </p>
                        </div>
                    </div>

                    <div className="flex items-center gap-2">
                        <div className={clsx(
                            "flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold",
                            canReboot
                                ? "bg-emerald-50 text-emerald-700 border border-emerald-200"
                                : "bg-amber-50 text-amber-700 border border-amber-200"
                        )}>
                            {canReboot ? (
                                <><CheckCircle2 size={12} /> OK</>
                            ) : (
                                <><AlertTriangle size={12} /> {onlineUsers.length}</>
                            )}
                        </div>
                        <button
                            onClick={loadOnlineUsers}
                            disabled={loading}
                            className="p-1.5 rounded-lg hover:bg-slate-100 transition-colors"
                        >
                            <RefreshCw size={14} className={clsx("text-slate-500", loading && "animate-spin")} />
                        </button>
                    </div>
                </div>
            </div>


            <div className="flex-1 overflow-y-auto p-4">
                {loading && onlineUsers.length === 0 ? (
                    <div className="flex items-center justify-center h-full">
                        <RefreshCw size={20} className="text-slate-300 animate-spin" />
                    </div>
                ) : onlineUsers.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full text-center">
                        <div className="w-14 h-14 mb-3 rounded-full bg-slate-100 flex items-center justify-center">
                            <Users size={24} className="text-slate-400" />
                        </div>
                        <p className="font-medium text-slate-600 text-sm">–ù–∏–∫–æ–≥–æ –Ω–µ—Ç</p>
                        <p className="text-xs text-slate-400 mt-1">–ú–æ–∂–Ω–æ —Ä–µ–±—É—Ç–∞—Ç—å —Å–µ—Ä–≤–µ—Ä</p>
                    </div>
                ) : (
                    <div className="space-y-2">
                        {onlineUsers.map((user) => (
                            <div
                                key={user.id}
                                className="flex items-center justify-between p-2.5 rounded-xl bg-slate-50 hover:bg-slate-100 transition-colors"
                            >
                                <div className="flex items-center gap-2.5">
                                    <div className="relative">
                                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold">
                                            {user.name[0]}{user.surname?.[0] || ""}
                                        </div>
                                        <span className="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-emerald-500 border-2 border-white rounded-full"></span>
                                    </div>
                                    <div>
                                        <div className="font-semibold text-slate-800 text-sm leading-tight">
                                            {user.name} {user.surname?.[0] ? user.surname[0] + "." : ""}
                                        </div>
                                        <span className="text-[10px] font-medium text-slate-400">
                                            {getRoleLabel(user.role)}
                                        </span>
                                    </div>
                                </div>
                                <div className="flex items-center gap-1 text-[10px] text-slate-400">
                                    {user.isPersonalLaptop ? (
                                        <Laptop size={12} />
                                    ) : (
                                        <Monitor size={12} />
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>


            {onlineUsers.length > 0 && (
                <div className="px-5 py-2.5 bg-slate-50 border-t border-slate-100 flex-shrink-0">
                    <div className="flex items-center justify-between text-xs">
                        <span className="text-slate-500">
                            –û–Ω–ª–∞–π–Ω: <span className="font-bold text-emerald-600">{onlineUsers.length}</span>
                        </span>
                        <div className="flex items-center gap-1 text-slate-400">
                            <Circle size={6} className="fill-emerald-500 text-emerald-500" />
                            <span>Live</span>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};


export const StartPage: React.FC = observer(() => {
    const { user } = useContext(Context)!;
    const [greeting, setGreeting] = useState("");
    const [currentTime, setCurrentTime] = useState(new Date());

    useEffect(() => {
        const updateTime = () => {
            const now = new Date();
            setCurrentTime(now);
            const hour = now.getHours();
            if (hour < 12) setGreeting("–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ");
            else if (hour < 18) setGreeting("–î–æ–±—Ä—ã–π –¥–µ–Ω—å");
            else setGreeting("–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä");
        };
        updateTime();
        const t = setInterval(updateTime, 1000);
        return () => clearInterval(t);
    }, []);

    const today = currentTime.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
    const isAdmin = user.can('admin.access') || user.can('users.manage');

    return (
        <div className="min-h-screen bg-[#F6F8FA] p-6 lg:p-10 font-sans text-slate-800 pb-20">
            <div className="max-w-[1400px] mx-auto animate-fade-in-up">


                <div className="mb-10 flex flex-col justify-between gap-4 md:flex-row md:items-end">
                    <div>
                        <div className="mb-2 flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-slate-400">
                            <Clock size={14} className="text-indigo-500"/>
                            {today}
                        </div>
                        <h1 className="text-4xl font-black tracking-tight text-slate-900 md:text-5xl">
                            {greeting}, <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">{user.user?.name || "–ö–æ–ª–ª–µ–≥–∞"}</span>.
                        </h1>
                        <p className="mt-2 text-lg font-medium text-slate-500">
                            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –µ–¥–∏–Ω–æ–µ —Ä–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.
                        </p>
                    </div>

                    <div className="hidden md:block">
                        <div className="flex items-center gap-3 rounded-2xl bg-white px-5 py-3 shadow-sm border border-slate-100">
                            <div className="h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold">
                                {user.user?.name?.[0] || "U"}
                            </div>
                            <div>
                                <div className="text-xs font-bold uppercase text-slate-400">–í–∞—à–∞ —Ä–æ–ª—å</div>
                                <div className="font-bold text-indigo-600">{user.user?.role || "–°–æ—Ç—Ä—É–¥–Ω–∏–∫"}</div>
                            </div>
                        </div>
                    </div>
                </div>


                <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4 auto-rows-auto">


                    <HeroCard
                        title="–¢–µ—Ä–º–∏–Ω–∞–ª –°–±–æ—Ä–∫–∏"
                        sub="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å —ç—Ç–∞–ø–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞"
                        icon={PlayCircle}
                        to={RECIPE_EXECUTION_ROUTE}
                    />


                    <InfoTile title="–ó–∞–¥–∞—á–∏" sub="–ú–æ–π –ø–ª–∞–Ω –Ω–∞ —Å–º–µ–Ω—É" icon={ClipboardList} to={TASKS_ROUTE} colorClass="bg-blue-500" iconColor="text-blue-600" />
                    <InfoTile title="–°–∫–ª–∞–¥" sub="–û—Å—Ç–∞—Ç–∫–∏ –∏ –¥–≤–∏–∂–µ–Ω–∏–µ" icon={Box} to={WAREHOUSE_ROUTE} colorClass="bg-emerald-500" iconColor="text-emerald-600" />
                    <InfoTile title="–ü—Ä–æ—à–∏–≤–∫–∞ FC" sub="–£—Ç–∏–ª–∏—Ç—ã Betaflight" icon={Cpu} to={BETAFLIGHT_ROUTE} colorClass="bg-orange-500" iconColor="text-orange-600" />
                    <InfoTile title="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞" sub="–†–µ–π—Ç–∏–Ω–≥–∏ –∏ –æ—Ç—á–µ—Ç—ã" icon={BarChart3} to={RANKINGS_ROUTE} colorClass="bg-purple-500" iconColor="text-purple-600" />


                    <SystemWidget />


                    <InfoTile title="–ë–∞–∑–∞ –ó–Ω–∞–Ω–∏–π" sub="–†–µ–≥–ª–∞–º–µ–Ω—Ç—ã –∏ PDF" icon={BookOpen} to={KNOWLEDGE_BASE_ROUTE} colorClass="bg-sky-500" iconColor="text-sky-600" />

                    {isAdmin && (
                        <InfoTile title="–ê–¥–º–∏–Ω–∫–∞" sub="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã" icon={Settings} to={ADMIN_ROUTE} colorClass="bg-slate-800" iconColor="text-slate-700" />
                    )}


                    {isAdmin && <OnlineUsersWidget />}

                </div>
            </div>
        </div>
    );
});

================================================================================
FILE: QMS-Client-main/src/pages/StartPage/StartPage_archive.tsx
================================================================================

import Photo from "assets/images/Kryptonit.png";
import {Monitor, Plane, User} from "lucide-react";
import React, {useState} from "react";
import {NavLink} from "react-router-dom";
import {BETAFLIGHT_ROUTE, USERS_ROUTE} from "src/utils/consts";

export const StartPage: React.FC = () => {
    const releases = [
        {
            version: "MVP 1.00",
            date: "14.02.2025",
            description:
                "–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–æ—à–∏–≤–∫–∞ FC, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É, —Å—á–∏—Ç—ã–≤–∞–Ω–∏–µ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è FC, –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞.",
        },
        {
            version: "1.01",
            date: "17.02.2025",
            description: "–£–ª—É—á—à–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö FC –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ FC",
        },
        {
            version: "1.02",
            date: "20.02.2025",
            description:
                "–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ FC —É–≤–µ–ª–∏—á–µ–Ω–∞ –±–æ–ª–µ–µ —á–µ–º –≤ 10 —Ä–∞–∑. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –≤—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –≤ –ø—Ä–æ—à–∏–≤–∫–µ.",
        },
        {
            version: "1.03",
            date: "26.02.2025",
            description:
                "–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ—Ñ–∏–∫—à–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–≤–∏—Å—à–µ–π —Å–µ—Å—Å–∏–µ–π. –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏—è FC –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.",
        },
        {
            version: "1.10",
            date: "04.03.2025",
            description:
                "–î–æ–±–∞–≤–ª–µ–Ω–æ: –ø—Ä–æ—à–∏–≤–∫–∞ 915, –ø—Ä–æ—à–∏–≤–∫–∞ 2.4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ü–ö. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.",
        },
        {
            version: "1.11",
            date: "06.03.2025",
            description:
                "–î–æ–±–∞–≤–ª–µ–Ω–æ: —Ç–∞–±–ª–∏—Ü–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –¥–ª—è –ø—Ä–∏–µ–º–Ω–∏–∫–æ–≤ 915; —Ç–∞–±–ª–∏—Ü–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –¥–ª—è –ø—Ä–∏–µ–º–Ω–∏–∫–æ–≤ 2.4; —Ä–∞–±–æ—Ç–∞ —Å 915 –∏ 2.4 –≤ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∞, –≤–≤–æ–¥ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±—Ä–∞–∫–∞ –¥–ª—è 915 –∏ 2.4 (–¥–ª—è –∞–¥–º–∏–Ω–∞).",
        },
        {
            version: "1.12",
            date: "10.03.2025",
            description: "–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω—ã –æ—à–∏–±–∫–∏, –ø–µ—Ä–µ–¥–µ–ª–∞–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∞.",
        },
        {
            version: "1.13",
            date: "15.03.2025",
            description: "–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ FC –Ω–∞ —Å—Ç–µ–Ω–¥–∞—Ö.",
        },
        {
            version: "1.14",
            date: "08.04.2025",
            description:
                "–ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ FC –Ω–∞ —Å—Ç–µ–Ω–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É. –í —Ç–∞–±–ª–∏—Ü–µ –≤–∏–¥–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        },
        {
            version: "2.0",
            date: "28.05.2025",
            description:
                "–í–Ω–µ–¥—Ä–µ–Ω–∞ –ø—Ä–æ—à–∏–≤–∫–∞ –ø–ª–∞—Ç Coral B (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–æ—à–∏–≤–∫–∏, —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è). –î–æ–±–∞–≤–ª–µ–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Coral B –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏. –í –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª  `–ò–∑–¥–µ–ª–∏—è –∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ`, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–µ–π",
        },
        {
            version: "2.01",
            date: "30.05.2025",
            description:
                "–î–æ–±–∞–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ESC –Ω–∞ —Å—Ç–µ–Ω–¥–∞—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏",
        },
        {
            version: "2.02",
            date: "05.09.2025",
            description:
                "–î–æ–±–∞–≤–ª–µ–Ω –≤—ã–±–æ—Ä –≤–µ—Ä—Å–∏–π –ø—Ä–æ—à–∏–≤–∫–∏ ELRS –ø—Ä–∏–µ–º–Ω–∫–∏–æ–≤ 915, –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥—É –≤ —Ç–∞–±–ª–∏—Ü–µ + —Å–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ FC",
        },
          {
            version: "2.03",
            date: "18.09.2025",
            description:
                "–î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–æ —Ä–µ–∂–∏–º –≤ –ø—Ä–æ—à–∏–≤–∫—É FC, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π —Ä–∞–±–æ—Ç—É –≥–∏—Ä–æ—Å–∫–æ–ø–∞, –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞ –∏ –±–∞—Ä–æ–º–µ—Ç—Ä–∞",
        },
    ];

    const [showAll, setShowAll] = useState(false);


    const visibleReleases = showAll ? releases : releases.slice(-3);

    return (
        <div className="container-fluid px-0">
            <div className="max-w-4xl mx-auto px-4 py-8 bg-white bg-opacity-90 rounded-lg shadow-xl">
                <div className="flex justify-around items-center mb-8">
                    <h1 className="text-3xl md:text-4xl lg:text-5xl font-semibold text-gray-800">
                        MES –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç

                    </h1>
                    <img className="h-64 rounded-lg" src={Photo} alt="–§–æ—Ç–æ"/>
                </div>
                <div className="space-y-4 max-w-xs mx-auto ">

                    <NavLink
                        to={USERS_ROUTE}
                        className="relative py-3 px-6 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold rounded-lg shadow-lg hover:from-blue-600 hover:to-purple-600 transition-all duration-300 transform hover:scale-105 block w-full text-center"
                    >
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
                        <div className="absolute top-1/2 right-4 transform -translate-y-1/2">
                            <div
                                className="w-6 h-6 bg-white rounded-full flex justify-center items-center text-blue-500 font-semibold shadow-sm">
                                <User className="w-4 h-4"/>
                            </div>
                        </div>
                    </NavLink>


                    <NavLink
                        to={BETAFLIGHT_ROUTE}
                        className="relative py-3 px-6 bg-gradient-to-r from-yellow-500 to-purple-500 text-white font-semibold rounded-lg shadow-lg hover:from-yellow-600 hover:to-purple-600 transition-all duration-300 transform hover:scale-105 block w-full text-center"
                    >
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FC
                        <div className="absolute top-1/2 right-4 transform -translate-y-1/2">
                            <div
                                className="w-6 h-6 bg-white rounded-full flex justify-center items-center text-blue-500 font-semibold shadow-sm">
                                <Plane className="w-4 h-4"/>
                            </div>
                        </div>
                    </NavLink>


                    <div
                        className="relative py-3 px-6 bg-gradient-to-r from-green-500 to-teal-500 text-white font-semibold rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 cursor-default">
                        Version 2.01
                        <div className="absolute top-1/2 right-4 transform -translate-y-1/2">
                            <div
                                className="w-6 h-6 bg-white rounded-full flex justify-center items-center text-green-500 font-semibold shadow-sm">
                                <Monitor className="w-4 h-4"/>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="mt-10">
                    <h1 className="text-2xl font-bold text-gray-900 mb-6">
                        üìú –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π
                    </h1>

                    {visibleReleases.reverse().map((release, index) => (
                        <div
                            key={index}
                            className="p-5 mb-4 bg-gray-100 rounded-xl border-l-4 border-indigo-500 shadow-sm"
                        >
                            <h2 className="text-lg font-semibold text-gray-800">
                                üöÄ Version {release.version} –æ—Ç {release.date}
                            </h2>
                            <p className="text-gray-600 mt-2">{release.description}</p>
                        </div>
                    ))}


                    {releases.length > 3 && (
                        <button
                            className="w-full mt-4 py-2 bg-indigo-500 text-white font-semibold rounded-md hover:bg-indigo-600 transition"
                            onClick={() => setShowAll(!showAll)}
                        >
                            {showAll ? "–°–∫—Ä—ã—Ç—å" : "–ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ"}
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Tables/CoralBs/CoralBList.tsx
================================================================================

import dayjs from "dayjs";
import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState } from "react";
import { fetchPC, fetchSession, fetchUsers } from "src/api/fcApi";
import { Context } from "src/main";
import {
  deleteCoral_BbyID,
  fetchCategoryDefectCoral_B,
  fetchCoral_B,
} from "src/api/coralBApi";
import { CoralB_boardItem } from "./CpralB_boardItem";
import { FilterCoralB } from "./FilterCoralB";

export const CoralBList: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { coralBStore } = context;

  const [firmwareState, setFirmwareState] = useState("");
  const [serial, setSerial] = useState("");
  const [SAW_filter, setSAW_Filter] = useState("");
  const [firmwareVersion, setFirmwareVersion] = useState("");

  const [inputValue, setInputValue] = useState(coralBStore.limit.toString());

  useEffect(() => {
    fetchSession().then((data) => coralBStore.setSessions(data));
    fetchUsers().then((data) => coralBStore.setUsers(data));
    fetchPC().then((data) => coralBStore.setPCs(data));
    fetchCategoryDefectCoral_B().then((data) =>
      coralBStore.setDefect_coral_B_categories(data)
    );
    fetchCoral_B(null, null, null, null, null, null, null, null, 30, 1).then(
      (data) => {
        coralBStore.setCoralBs(data.rows);
        coralBStore.setTotalCount(data.count);
      }
    );
  }, []);

  useEffect(() => {
    refetch();
  }, [coralBStore.page]);

  const refetch = () => {
    const valueFIRM =
      firmwareState === "true"
        ? true
        : firmwareState === "false"
        ? false
        : null;
    const valueSAW =
      SAW_filter === "true" ? true : SAW_filter === "false" ? false : null;
    fetchCoral_B(
      serial === "" ? null : serial,
      valueFIRM,
      valueSAW,
      firmwareVersion === "" ? null : firmwareVersion,
      coralBStore.selectedPC ? coralBStore.selectedPC.id : null,
      coralBStore.selectedUser ? coralBStore.selectedUser.id : null,
      coralBStore.selectedDefect ? coralBStore.selectedDefect.id : null,
      coralBStore.selectedDate,

      coralBStore.limit,
      coralBStore.page
    ).then((data) => {
      coralBStore.setCoralBs(data.rows);
      coralBStore.setTotalCount(data.count);
    });
  };

  const deleteBoard = async (id: number) => {
    await deleteCoral_BbyID(id);
    refetch();
  };


  const boardsAllOnPage = coralBStore.coralBs.map((board) => (
    <CoralB_boardItem
      key={board.id}
      serial={board.serial}
      firmware={board.firmware}
      SAW_filter={board.SAW_filter}
      firmwareVersion={board.firmwareVersion}
      sessionId={board.sessionId}
      categoryDefectedId={board.categoryDefectCoralBId}
      createdAt={dayjs(board.createdAt).format("DD.MM.YYYY HH:mm")}
      deleteBoard={() => deleteBoard(board.id)}
    />
  ));

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;


    setInputValue(value);


    if (value === "") return;


    const numericValue = Number(value);
    if (!isNaN(numericValue) && numericValue > 0) {
      coralBStore.setLimit(numericValue);
    }
  };

  useEffect(() => {
    setInputValue(coralBStore.limit.toString());
  }, [coralBStore.limit]);

  return (
    <div className="overflow-x-auto p-6 bg-white shadow-lg rounded-lg">
      <div className=" flex items-center gap-4 bg-gray-100 p-4 rounded-lg shadow-sm">
        <div className="w-3/4"> </div>

        <label className="text-gray-800 font-medium whitespace-nowrap">
          –ù–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:
        </label>
        <div className="relative">
          <input
            value={inputValue}
            type="number"
            min={0}
            onChange={handleChange}
            className="w-24 p-2 text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none shadow-sm"
          />
        </div>
      </div>

      <div className="flex mt-4">
        <div className="w-3/4"></div>
        <button
          type="reset"
          onClick={refetch}
          className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 text-gray transition duration-200"
        >
          –û–±–Ω–æ–≤–∏—Ç—å —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        </button>
      </div>

      <div className="flex mt-4">
        <div className="w-3/4"></div>
        <h1 className="text-2xl font-bold text-gray-800 mb-4">
          –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –±–∞–∑–µ: {coralBStore.totalCount}
        </h1>
      </div>

      <table className="min-w-full shadow-lg rounded-lg border border-gray-400">
        <thead>
          <tr className=" bg-indigo-700 text-white text-sm uppercase font-semibold">
            <th className="px-4 py-3 border border-gray-400">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
            <th className="px-4 py-3 border border-gray-400">–ü—Ä–æ—à–∏–≤–∫–∞</th>
            <th className="px-4 py-3 border border-gray-400">–ü–ê–í</th>
            <th className="px-4 py-3 border border-gray-400">
              –í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏
            </th>
            <th className="px-4 py-3 border border-gray-400">–ö–æ–º–ø—å—é—Ç–µ—Ä</th>
            <th className="px-4 py-3 border border-gray-400">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th className="px-4 py-3 border border-gray-400">–ë—Ä–∞–∫</th>
            <th className="px-4 py-3 border border-gray-400">
              –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            </th>
          </tr>

          <FilterCoralB
            serial={serial}
            setSerial={setSerial}
            firmwareState={firmwareState}
            setFirmwareState={setFirmwareState}
            SAW_filter={SAW_filter}
            setSAW_Filter={setSAW_Filter}
            firmwareVersion={firmwareVersion}
            setFirmwareVersion={setFirmwareVersion}
          />
        </thead>
        <tbody>
          {boardsAllOnPage.length > 0 ? (
            boardsAllOnPage
          ) : (
            <td className="px-4 py-6 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
          )}
        </tbody>
      </table>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Tables/CoralBs/CoralBs.tsx
================================================================================

import coralB1 from "assets/images/CoralB1.png";
import coralB2 from "assets/images/CoralB2.png";
import { PagesCoralB } from "./PagesCoralB";
import { CoralBList } from "./CoralBList";

export const CoralBs: React.FC = () => {
  return (
    <div className="flex  h-screen bg-gray-100/60">

      <main className="flex-1 p-6 flex flex-col overflow-y-auto h-screen">

        <header className=" flex  mb-6">
          <h1 className="text-3xl font-bold text-gray-800">Coral B</h1>


          <div className="flex ml-10 justify-center items-center gap-6">
            <img
              src={coralB1}
              className="w-24 h-auto rounded-lg shadow-md"
              alt="915"
            />
            <img
              src={coralB2}
              className="w-24 h-auto rounded-lg shadow-md"
              alt="915"
            />
          </div>
        </header>


        <div className="flex-1 bg-white shadow-md rounded-lg">
          <CoralBList />
        </div>


        <div className="mt-6 flex justify-center">
          <PagesCoralB />
        </div>
      </main>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Tables/CoralBs/CpralB_boardItem.tsx
================================================================================

import { Trash2 } from "lucide-react";
import { observer } from "mobx-react-lite";
import { useContext, useState } from "react";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { Context } from "src/main";

interface OneCoralB_boardItem {
  serial: string;
  firmware: boolean;
  SAW_filter: boolean;
  firmwareVersion: string;
  sessionId: number;
  categoryDefectedId: number;
  createdAt: string;
  deleteBoard: () => void;
}

export const CoralB_boardItem: React.FC<OneCoralB_boardItem> = observer(
  ({
    serial,
    firmware,
    SAW_filter,
    firmwareVersion,
    sessionId,
    categoryDefectedId,
    createdAt,
    deleteBoard,
  }) => {
    const context = useContext(Context);

    if (!context) {
      throw new Error("Context must be used within a Provider");
    }

    const { coralBStore, user } = context;

    const [modalType, setModalType] = useState<string | null>(null);

    const currentSession = coralBStore.sessions.find(
      (session) => session.id === sessionId
    );

    const currentPC = coralBStore.PCs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    const currentDefect = coralBStore.defect_coral_B_categories.find(
      (defect) => defect.id === categoryDefectedId
    );

    const currentUser = coralBStore.users.find(
      (user) => user.id === currentSession?.userId
    );

    const openModal = (type: string) => setModalType(type);
    const closeModal = () => setModalType(null);

    return (
      <tr className="text-center hover:bg-gray-500 transition odd:bg-gray-200 even:bg-white">
        <td className="px-4 py-2 border">{serial}</td>
        <td className="px-4 py-2 border">
          {firmware ? "–ø—Ä–æ—à–∏—Ç–æ ‚úÖ" : "–Ω–µ –ø—Ä–æ—à–∏—Ç–æ ‚ùå"}
        </td>
        <td className="px-4 py-2 border">
          {SAW_filter ? "c –ü–ê–í ‚èπÔ∏é" : "–±–µ–∑ –ü–ê–í ‚óªÔ∏é"}
        </td>
        <td className="px-4 py-2 border">{firmwareVersion}</td>

        <td className="px-4 py-2 border">{currentPC?.pc_name}</td>
        <td className="px-4 py-2 border">
          {currentUser?.name} {currentUser?.surname}
        </td>
        <td className="px-4 py-2 border">{currentDefect?.title}</td>
        <td className="px-4 py-2 border">{createdAt}</td>
        {user.isAdmin && (
          <td>
            {" "}
            <button
              className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition"
              onClick={() => openModal("computerDelete")}
            >
              <Trash2 size={15} />
            </button>
          </td>
        )}

        <Modal isOpen={modalType === "computerDelete"} onClose={closeModal}>
          <ConfirmModal
            title1={`–£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç—É Coral B ${serial} ${createdAt} ?`}
            actionConfirm={deleteBoard}
            onClose={closeModal}
          />
        </Modal>
      </tr>
    );
  }
);

================================================================================
FILE: QMS-Client-main/src/pages/Tables/CoralBs/DateFilterForCoralB.tsx
================================================================================

import { DatePicker, Gapped, Tooltip } from "@skbkontur/react-ui";


import React, { useContext, useEffect } from "react";
import { Context } from "src/main";

export const DateFilterForCoralB: React.FC = () => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { coralBStore } = context;

  const [value, setValue] = React.useState("");
  const [error, setError] = React.useState(false);
  const [tooltip, setTooltip] = React.useState(false);

  const minDate = "01.01.2025";
  const maxDate = "02.05.2028";

  const unvalidate = () => {
    setError(false);
    setTooltip(false);
  };

  const validate = () => {
    const errorNew =
      !!value &&
      !DatePicker.validate(value, { minDate: minDate, maxDate: maxDate });
    setError(errorNew);
    setTooltip(errorNew);
  };

  let removeTooltip = () => setTooltip(false);

  useEffect(() => {
    if (!error) {
      coralBStore.setSelectedDate(value);
    }
  }, [value]);

  return (
    <Gapped gap={10} vertical>


      <Tooltip
        trigger={tooltip ? "opened" : "closed"}
        render={() => "–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –¥–∞—Ç–∞"}
        onCloseClick={removeTooltip}
      >
        <DatePicker
          error={error}
          value={value}
          onValueChange={setValue}
          onFocus={unvalidate}
          onBlur={validate}
          minDate={minDate}
          maxDate={maxDate}
          enableTodayLink
        />
      </Tooltip>

    </Gapped>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Tables/CoralBs/FilterCoralB.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext } from "react";
import { Context } from "src/main";
import { DateFilterForCoralB } from "./DateFilterForCoralB";

interface FilterCoralBModel {
  serial: string;
  setSerial: (value: string) => void;
  firmwareState: string;
  setFirmwareState: (value: string) => void;
  SAW_filter: string;
  setSAW_Filter: (value: string) => void;
  firmwareVersion: string;
  setFirmwareVersion: (value: string) => void;
}

export const FilterCoralB: React.FC<FilterCoralBModel> = observer(
  ({
    serial,
    setSerial,
    firmwareState,
    setFirmwareState,
    SAW_filter,
    setSAW_Filter,
    firmwareVersion,
    setFirmwareVersion,
  }) => {
    const context = useContext(Context);

    if (!context) {
      throw new Error("Context must be used within a Provider");
    }

    const { coralBStore } = context;

    return (
      <tr className="bg-gray-800 text-white text-sm uppercase font-semibold">
        <th className="px-4 py-3 border border-gray-600">
          <input
            className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            value={serial}
            onChange={(e) => setSerial(e.target.value)}
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä"
          />
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            value={firmwareState}
            onChange={(e) => setFirmwareState(e.target.value)}
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
          >
            <option value="" disabled selected>
              –ü—Ä–æ—à–∏–≤–∫–∞
            </option>
            <option value="true">‚úÖ –î–∞</option>
            <option value="false">‚ùå –ù–µ—Ç</option>
          </select>
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            value={SAW_filter}
            onChange={(e) => setSAW_Filter(e.target.value)}
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
          >
            <option value="" disabled selected>
              –ü–ê–í
            </option>
            <option value="true">—Å –ü–ê–í</option>
            <option value="false">–±–µ–∑ –ü–ê–í</option>
          </select>
        </th>


        <th className="px-4 py-3 border border-gray-600">
          <input
            className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            value={firmwareVersion}
            onChange={(e) => setFirmwareVersion(e.target.value)}
            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–µ—Ä—Å–∏—é –ø—Ä–æ—à–∏–≤–∫–∏"
          />
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            onChange={(e) => {
              const selectedPC = coralBStore.PCs.find(
                (pc) => pc.id === Number(e.target.value)
              );
              if (selectedPC) coralBStore.setSelectedPC(selectedPC);
            }}
          >
            <option value="" disabled selected>
              –ö–æ–º–ø—å—é—Ç–µ—Ä
            </option>
            {coralBStore.PCs.map((el) => (
              <option key={el.id} value={el.id}>
                {el.pc_name}
              </option>
            ))}
          </select>
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            onChange={(e) => {
              const selectedUser = coralBStore.users.find(
                (user) => user.id === Number(e.target.value)
              );
              if (selectedUser) coralBStore.setSelectedUser(selectedUser);
            }}
          >
            <option value="" disabled selected>
              –°–æ—Ç—Ä—É–¥–Ω–∏–∫
            </option>
            {coralBStore.users.map((el) => (
              <option key={el.id} value={el.id}>
                {el.name} {el.surname}
              </option>
            ))}
          </select>
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            onChange={(e) => {
              const selectedDefect = coralBStore.defect_coral_B_categories.find(
                (defect) => defect.id === Number(e.target.value)
              );
              if (selectedDefect) coralBStore.setSelectedDefect(selectedDefect);
            }}
          >
            <option value="" disabled selected>
              –ë—Ä–∞–∫
            </option>
            {coralBStore.defect_coral_B_categories.map((el) => (
              <option key={el.id} value={el.id}>
                {el.title}
              </option>
            ))}
          </select>
        </th>

        <th className="px-4 py-3 border border-gray-600">
          <DateFilterForCoralB />
        </th>
      </tr>
    );
  }
);

================================================================================
FILE: QMS-Client-main/src/pages/Tables/CoralBs/PagesCoralB.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext } from "react";
import { Context } from "src/main";

export const PagesCoralB: React.FC = observer(() => {
  const context = useContext(Context);
  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { coralBStore } = context;

  const pageCount = Math.ceil(coralBStore.totalCount / coralBStore.limit);

  const currentPage = coralBStore.page;


  const getVisiblePages = () => {
    const visiblePages = [];
    const range = 2;


    visiblePages.push(1);


    const start = Math.max(2, currentPage - range);
    const end = Math.min(pageCount - 1, currentPage + range);
    if (start > 2) {
      visiblePages.push("...");
    }

    for (let i = start; i <= end; i++) {
      visiblePages.push(i);
    }

    if (end < pageCount - 1) {
      visiblePages.push("...");
    }


    if (pageCount > 1) {
      visiblePages.push(pageCount);
    }

    return visiblePages;
  };

  const visiblePages = getVisiblePages();


  return (
    <div className="flex flex-wrap justify-center items-center gap-2 mt-6 max-w-2xl">
      <button
        onClick={() => coralBStore.setPage(Math.max(1, currentPage - 1))}
        disabled={currentPage === 1}
        className="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold disabled:opacity-50"
      >
        –ù–∞–∑–∞–¥
      </button>

      {visiblePages.map((page, index) =>
        page === "..." ? (
          <span key={`ellipsis-${index}`} className="px-2 py-2">
            ...
          </span>
        ) : (
          <button
            key={page}
            onClick={() => coralBStore.setPage(page as number)}
            className={`px-4 py-2 rounded-lg text-lg font-semibold transition duration-200
              ${
                currentPage === page
                  ? "bg-indigo-600 text-white shadow-lg"
                  : "bg-gray-200 text-gray-800 hover:bg-indigo-400 hover:text-white"
              }`}
            type="button"
          >
            {page}
          </button>
        )
      )}

      <button
        onClick={() =>
          coralBStore.setPage(Math.min(pageCount, currentPage + 1))
        }
        disabled={currentPage === pageCount}
        className="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold disabled:opacity-50"
      >
        –í–ø–µ—Ä–µ–¥
      </button>


    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Tables/ELRS24s/ELRS24s.tsx
================================================================================

import plata24_1 from "assets/images/24v1.png";
import plata24_2 from "assets/images/24v2png.png";
import { PagesELRS } from "../ELRS915s/PagesELRS";
import { Elrs24List } from "./Elrs24List";

export const ELRS24s: React.FC = () => {
  return (
    <div className="flex  h-screen bg-gray-100/60">

      <main className="flex-1 p-6 flex flex-col overflow-y-auto h-screen">

        <header className=" flex  mb-6">
          <h1 className="text-3xl font-bold text-gray-800">
            ELRS –ø—Ä–∏–µ–º–Ω–∏–∫ 24
          </h1>


          <div className="flex ml-10 justify-center items-center gap-6">
            <img
              src={plata24_1}
              className="w-24 h-auto rounded-lg shadow-md"
              alt="24"
            />
            <img
              src={plata24_2}
              className="w-24 h-auto rounded-lg shadow-md"
              alt="24"
            />
          </div>
        </header>


        <div className="flex-1 bg-white shadow-md rounded-lg">
          <Elrs24List />
        </div>


        <div className="mt-6 flex justify-center">
          <PagesELRS />
        </div>
      </main>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Tables/ELRS24s/Elrs24BoardItem.tsx
================================================================================

import { Trash2 } from "lucide-react";
import { observer } from "mobx-react-lite";
import { useContext, useState } from "react";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { Context } from "src/main";

interface One24BoardItem {
  MAC_address: string;
  firmware: boolean;
  sessionId: number;
  categoryDefectedId: number;
  createdAt: string;
  deleteBoard: () => void;
}

export const Elrs24BoardItem: React.FC<One24BoardItem> = observer(
  ({
    MAC_address,
    firmware,
    sessionId,
    categoryDefectedId,
    createdAt,
    deleteBoard,
  }) => {
    const context = useContext(Context);

    if (!context) {
      throw new Error("Context must be used within a Provider");
    }

    const { elrsStore, user } = context;

    const currentSession = elrsStore.sessions.find(
      (session) => session.id === sessionId
    );

    const currentPC = elrsStore.PCs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    const currentDefect = elrsStore.defect_2_4_Categories.find(
      (defect) => defect.id === categoryDefectedId
    );

    const currentUser = elrsStore.users.find(
      (user) => user.id === currentSession?.userId
    );

    const [modalType, setModalType] = useState<string | null>(null);

    const openModal = (type: string) => setModalType(type);
    const closeModal = () => setModalType(null);

    return (
      <tr className="text-center hover:bg-gray-500 transition odd:bg-gray-200 even:bg-white">
        <td className="px-4 py-2 border">{MAC_address}</td>
        <td className="px-4 py-2 border">
          {firmware ? "–ø—Ä–æ—à–∏—Ç–æ ‚úÖ" : "–Ω–µ –ø—Ä–æ—à–∏—Ç–æ ‚ùå"}
        </td>
        <td className="px-4 py-2 border">{currentPC?.pc_name}</td>
        <td className="px-4 py-2 border">
          {currentUser?.name} {currentUser?.surname}
        </td>
        <td className="px-4 py-2 border">{currentDefect?.title}</td>
        <td className="px-4 py-2 border">{createdAt}</td>
        {user.isAdmin && (
          <td>
            {" "}
            <button
              className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition"
              onClick={() => openModal("computerDelete")}
            >
              <Trash2 size={15} />
            </button>
          </td>
        )}

        <Modal isOpen={modalType === "computerDelete"} onClose={closeModal}>
          <ConfirmModal
            title1={`–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–µ–º–Ω–∏–∫ 2.4 ${MAC_address} ${createdAt} ?`}
            actionConfirm={deleteBoard}
            onClose={closeModal}
          />
        </Modal>
      </tr>
    );
  }
);

================================================================================
FILE: QMS-Client-main/src/pages/Tables/ELRS24s/Elrs24List.tsx
================================================================================

import dayjs from "dayjs";
import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState } from "react";
import {
  delete2_4byID,
  fetch2_4,
  fetchCategoryDefect24,
} from "src/api/elrsApi";
import { fetchPC, fetchSession, fetchUsers } from "src/api/fcApi";
import { Context } from "src/main";
import { Elrs24BoardItem } from "./Elrs24BoardItem";
import { FilterElrs } from "../ELRS915s/FilterElrs";

export const Elrs24List: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { elrsStore } = context;

  const [firmwareState, setFirmwareState] = useState("");
  const [MAC_address, setMAC_address] = useState("");

  useEffect(() => {
    fetchSession().then((data) => elrsStore.setSessions(data));
    fetchUsers().then((data) => elrsStore.setUsers(data));
    fetchPC().then((data) => elrsStore.setPCs(data));
    fetchCategoryDefect24().then((data) =>
      elrsStore.setDefect_2_4_Categories(data)
    );
    fetch2_4(null, null, null, null, null, null, 30, 1).then((data) => {
      elrsStore.setELRS_2_4s(data.rows);
      elrsStore.setTotalCount(data.count);
      console.log(elrsStore.totalCount);
    });
  }, []);

  useEffect(() => {
    refetch();
  }, [elrsStore.page]);

  const refetch = () => {
    const valueFIRM =
      firmwareState === "true"
        ? true
        : firmwareState === "false"
          ? false
          : null;
    fetch2_4(
      MAC_address === "" ? null : MAC_address,
      valueFIRM,
      elrsStore.selectedPC ? elrsStore.selectedPC.id : null,
      elrsStore.selectedUser ? elrsStore.selectedUser.id : null,
      elrsStore.selectedDefect ? elrsStore.selectedDefect.id : null,
      elrsStore.selectedDate,

      elrsStore.limit,
      elrsStore.page
    ).then((data) => {
      elrsStore.setELRS_2_4s(data.rows);
      elrsStore.setTotalCount(data.count);
    });
  };

  const deleteBoard = async (id: number) => {
    await delete2_4byID(id);
    refetch();
  };

  const fcAllOnPage = elrsStore.ELRS2_4.map((board) => (
    <Elrs24BoardItem
      key={board.id}
      MAC_address={board.MAC_address}
      firmware={board.firmware}
      sessionId={board.sessionId}
      categoryDefectedId={board.categoryDefect24Id}
      createdAt={dayjs(board.createdAt).format("DD.MM.YYYY HH:mm")}
      deleteBoard={() => deleteBoard(board.id)}
    />
  ));

  const [inputValue, setInputValue] = useState(elrsStore.limit.toString());

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;


    setInputValue(value);


    if (value === "") return;


    const numericValue = Number(value);
    if (!isNaN(numericValue) && numericValue > 0) {
      elrsStore.setLimit(numericValue);
    }
  };

  useEffect(() => {
    setInputValue(elrsStore.limit.toString());
  }, [elrsStore.limit]);

  return (
    <div className="overflow-x-auto p-6 bg-white shadow-lg rounded-lg">
      <div className=" flex items-center gap-4 bg-gray-100 p-4 rounded-lg shadow-sm">
        <div className="w-3/4"> </div>

        <label className="text-gray-800 font-medium whitespace-nowrap">
          –ù–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:
        </label>
        <div className="relative">
          <input
            value={inputValue}
            type="number"
            min={0}
            onChange={handleChange}
            className="w-24 p-2 text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none shadow-sm"
          />
        </div>
      </div>

      <div className="flex mt-4">
        <div className="w-3/4"></div>
        <button
          type="reset"
          onClick={refetch}
          className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 text-gray transition duration-200"
        >
          –û–±–Ω–æ–≤–∏—Ç—å —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        </button>
      </div>

      <div className="flex mt-4">
        <div className="w-3/4"></div>
        <h1 className="text-2xl font-bold text-gray-800 mb-4">
          –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –±–∞–∑–µ: {elrsStore.totalCount}
        </h1>
      </div>

      <table className="min-w-full shadow-lg rounded-lg border border-gray-400">
        <thead>
          <tr className=" bg-indigo-700 text-white text-sm uppercase font-semibold">
            <th className="px-4 py-3 border border-gray-400">MAC-address</th>
            <th className="px-4 py-3 border border-gray-400">–ü—Ä–æ—à–∏–≤–∫–∞</th>
            <th className="px-4 py-3 border border-gray-400">–ö–æ–º–ø—å—é—Ç–µ—Ä</th>
            <th className="px-4 py-3 border border-gray-400">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th className="px-4 py-3 border border-gray-400">–ë—Ä–∞–∫</th>
            <th className="px-4 py-3 border border-gray-400">
              –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            </th>
          </tr>

          <FilterElrs
            category="24"
            MAC_address={MAC_address}
            setMAC_address={setMAC_address}
            firmwareState={firmwareState}
            setFirmwareState={setFirmwareState}
            firmwareVersion={null}
            setFirmwareVersion={null}
          />
        </thead>
        <tbody>
          {fcAllOnPage.length > 0 ? (
            fcAllOnPage
          ) : (
            <td className="px-4 py-6 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
          )}
        </tbody>
      </table>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Tables/ELRS915s/DateFilterForELRS.tsx
================================================================================

import { DatePicker, Gapped, Tooltip } from "@skbkontur/react-ui";


import React, { useContext, useEffect } from "react";
import { Context } from "src/main";

export const DateFilterforElrs: React.FC = () => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { elrsStore } = context;

  const [value, setValue] = React.useState("");
  const [error, setError] = React.useState(false);
  const [tooltip, setTooltip] = React.useState(false);

  const minDate = "01.01.2025";
  const maxDate = "02.05.2028";

  const unvalidate = () => {
    setError(false);
    setTooltip(false);
  };

  const validate = () => {
    const errorNew =
      !!value &&
      !DatePicker.validate(value, { minDate: minDate, maxDate: maxDate });
    setError(errorNew);
    setTooltip(errorNew);
  };

  let removeTooltip = () => setTooltip(false);

  useEffect(() => {
    if (!error) {
      elrsStore.setSelectedDate(value);
    }
  }, [value]);

  return (
    <Gapped gap={10} vertical>


      <Tooltip
        trigger={tooltip ? "opened" : "closed"}
        render={() => "–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –¥–∞—Ç–∞"}
        onCloseClick={removeTooltip}
      >
        <DatePicker
          error={error}
          value={value}
          onValueChange={setValue}
          onFocus={unvalidate}
          onBlur={validate}
          minDate={minDate}
          maxDate={maxDate}
          enableTodayLink
        />
      </Tooltip>

    </Gapped>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Tables/ELRS915s/ELRS915s.tsx
================================================================================

import plata915_1 from "assets/images/radiomaster-bandit-br3-expresslrs-915mhz-03.png";
import plata915_2 from "assets/images/radiomaster-bandit-br3-expresslrs-915mhz-05.png";
import { Elrs915List } from "./Elrs915List";
import { PagesELRS } from "./PagesELRS";

export const ELRS915s: React.FC = () => {
  return (
    <div className="flex  h-screen bg-gray-100/60">

      <main className="flex-1 p-6 flex flex-col overflow-y-auto h-screen">

        <header className=" flex  mb-6">
          <h1 className="text-3xl font-bold text-gray-800">
            ELRS –ø—Ä–∏–µ–º–Ω–∏–∫ 915
          </h1>


          <div className="flex ml-10 justify-center items-center gap-6">
            <img
              src={plata915_1}
              className="w-24 h-auto rounded-lg shadow-md"
              alt="915"
            />
            <img
              src={plata915_2}
              className="w-24 h-auto rounded-lg shadow-md"
              alt="915"
            />
          </div>
        </header>


        <div className="flex-1 bg-white shadow-md rounded-lg">
          <Elrs915List />
        </div>


        <div className="mt-6 flex justify-center">
          <PagesELRS />
        </div>
      </main>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Tables/ELRS915s/Elrs915BoardItem.tsx
================================================================================

import { Trash2 } from "lucide-react";
import { observer } from "mobx-react-lite";
import { useContext, useState } from "react";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { Context } from "src/main";

interface One915BoardItem {
  MAC_address: string;
  firmware: boolean;
  sessionId: number;
  categoryDefectedId: number;
  firmwareVersion: string;
  createdAt: string;
  deleteBoard: () => void;
}

export const Elrs915BoardItem: React.FC<One915BoardItem> = observer(
  ({
    MAC_address,
    firmware,
    sessionId,
    categoryDefectedId,
    firmwareVersion,
    createdAt,
    deleteBoard,
  }) => {
    const context = useContext(Context);

    if (!context) {
      throw new Error("Context must be used within a Provider");
    }

    const { elrsStore, user } = context;

    const currentSession = elrsStore.sessions.find(
      (session) => session.id === sessionId
    );

    const currentPC = elrsStore.PCs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    const currentDefect = elrsStore.defect_915_Categories.find(
      (defect) => defect.id === categoryDefectedId
    );

    const currentUser = elrsStore.users.find(
      (user) => user.id === currentSession?.userId
    );

    const [modalType, setModalType] = useState<string | null>(null);

    const openModal = (type: string) => setModalType(type);
    const closeModal = () => setModalType(null);

    return (
      <tr className="text-center hover:bg-gray-500 transition odd:bg-gray-200 even:bg-white">
        <td className="px-4 py-2 border">{MAC_address}</td>
        <td className="px-4 py-2 border">
          {firmware ? "–ø—Ä–æ—à–∏—Ç–æ ‚úÖ" : "–Ω–µ –ø—Ä–æ—à–∏—Ç–æ ‚ùå"}
        </td>
         <td className="px-4 py-2 border">{firmwareVersion}</td>
        <td className="px-4 py-2 border">{currentPC?.pc_name}</td>
        <td className="px-4 py-2 border">
          {currentUser?.name} {currentUser?.surname}
        </td>
        <td className="px-4 py-2 border">{currentDefect?.title}</td>
        <td className="px-4 py-2 border">{createdAt}</td>
        {user.isAdmin && (
          <td>
            {" "}
            <button
              className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition"
              onClick={() => openModal("computerDelete")}
            >
              <Trash2 size={15} />
            </button>
          </td>
        )}

        <Modal isOpen={modalType === "computerDelete"} onClose={closeModal}>
          <ConfirmModal
            title1={`–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–µ–º–Ω–∏–∫ 915 ${MAC_address} ${createdAt} ?`}
            actionConfirm={deleteBoard}
            onClose={closeModal}
          />
        </Modal>
      </tr>
    );
  }
);

================================================================================
FILE: QMS-Client-main/src/pages/Tables/ELRS915s/Elrs915List.tsx
================================================================================

import dayjs from "dayjs";
import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState } from "react";
import {
  delete915byID,
  fetch915,
  fetchCategoryDefect915,
} from "src/api/elrsApi";
import { fetchPC, fetchSession, fetchUsers } from "src/api/fcApi";
import { Context } from "src/main";
import { Elrs915BoardItem } from "./Elrs915BoardItem";
import { FilterElrs } from "./FilterElrs";

export const Elrs915List: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { elrsStore } = context;

  const [firmwareState, setFirmwareState] = useState("");
  const [MAC_address, setMAC_address] = useState("");
  const [firmwareVersion, setFirmwareVersion] = useState("");


  useEffect(() => {
    fetchSession().then((data) => elrsStore.setSessions(data));
    fetchUsers().then((data) => elrsStore.setUsers(data));
    fetchPC().then((data) => elrsStore.setPCs(data));
    fetchCategoryDefect915().then((data) =>
      elrsStore.setDefect_915_Categories(data)
    );
    fetch915(null, null, null, null, null, null, null, 30, 1).then((data) => {
      elrsStore.setELRS915s(data.rows);
      elrsStore.setTotalCount(data.count);
      console.log(elrsStore.totalCount);
    });
  }, []);

  useEffect(() => {
    refetch();
  }, [elrsStore.page]);

  const refetch = () => {
    const valueFIRM =
      firmwareState === "true"
        ? true
        : firmwareState === "false"
          ? false
          : null;
    fetch915(
      MAC_address === "" ? null : MAC_address,
      valueFIRM,
      elrsStore.selectedPC ? elrsStore.selectedPC.id : null,
      elrsStore.selectedUser ? elrsStore.selectedUser.id : null,
      elrsStore.selectedDefect ? elrsStore.selectedDefect.id : null,
      firmwareVersion === "" ? null : firmwareVersion,
      elrsStore.selectedDate,

      elrsStore.limit,
      elrsStore.page
    ).then((data) => {
      elrsStore.setELRS915s(data.rows);
      elrsStore.setTotalCount(data.count);
    });
  };

  const deleteBoard = async (id: number) => {
    await delete915byID(id);
    refetch();
  };

  const fcAllOnPage = elrsStore.ELRS915.map((board) => (
    <Elrs915BoardItem
      key={board.id}
      MAC_address={board.MAC_address}
      firmwareVersion={board.firmwareVersion}
      firmware={board.firmware}
      sessionId={board.sessionId}
      categoryDefectedId={board.categoryDefect915Id}
      createdAt={dayjs(board.createdAt).format("DD.MM.YYYY HH:mm")}
      deleteBoard={() => deleteBoard(board.id)}
    />
  ));

  const [inputValue, setInputValue] = useState(elrsStore.limit.toString());

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;


    setInputValue(value);


    if (value === "") return;


    const numericValue = Number(value);
    if (!isNaN(numericValue) && numericValue > 0) {
      elrsStore.setLimit(numericValue);
    }
  };

  useEffect(() => {
    setInputValue(elrsStore.limit.toString());
  }, [elrsStore.limit]);

  return (
    <div className="overflow-x-auto p-6 bg-white shadow-lg rounded-lg">
      <div className=" flex items-center gap-4 bg-gray-100 p-4 rounded-lg shadow-sm">
        <div className="w-3/4"> </div>

        <label className="text-gray-800 font-medium whitespace-nowrap">
          –ù–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:
        </label>
        <div className="relative">
          <input
            value={inputValue}
            type="number"
            min={0}
            onChange={handleChange}
            className="w-24 p-2 text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none shadow-sm"
          />
        </div>
      </div>

      <div className="flex mt-4">
        <div className="w-3/4"></div>
        <button
          type="reset"
          onClick={refetch}
          className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 text-gray transition duration-200"
        >
          –û–±–Ω–æ–≤–∏—Ç—å —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        </button>
      </div>

      <div className="flex mt-4">
        <div className="w-3/4"></div>
        <h1 className="text-2xl font-bold text-gray-800 mb-4">
          –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –±–∞–∑–µ: {elrsStore.totalCount}
        </h1>
      </div>

      <table className="min-w-full shadow-lg rounded-lg border border-gray-400">
        <thead>
          <tr className=" bg-indigo-700 text-white text-sm uppercase font-semibold">
            <th className="px-4 py-3 border border-gray-400">MAC-address</th>
            <th className="px-4 py-3 border border-gray-400">–ü—Ä–æ—à–∏–≤–∫–∞</th>
            <th className="px-4 py-3 border border-gray-400">–í–µ—Ä—Å–∏—è </th>
            <th className="px-4 py-3 border border-gray-400">–ö–æ–º–ø—å—é—Ç–µ—Ä</th>
            <th className="px-4 py-3 border border-gray-400">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th className="px-4 py-3 border border-gray-400">–ë—Ä–∞–∫</th>
            <th className="px-4 py-3 border border-gray-400">
              –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            </th>
          </tr>

          <FilterElrs
            category="915"
            MAC_address={MAC_address}
            setMAC_address={setMAC_address}
            firmwareState={firmwareState}
            setFirmwareState={setFirmwareState}
            firmwareVersion={firmwareVersion}
            setFirmwareVersion={setFirmwareVersion}
          />
        </thead>
        <tbody>
          {fcAllOnPage.length > 0 ? (
            fcAllOnPage
          ) : (
            <td className="px-4 py-6 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
          )}
        </tbody>
      </table>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Tables/ELRS915s/FilterElrs.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext } from "react";
import { Context } from "src/main";
import { DateFilterforElrs } from "./DateFilterForELRS";

interface FilterElrsModel {
  category: string;
  MAC_address: string;
  setMAC_address: (value: string) => void;
  firmwareState: string;
  setFirmwareState: (value: string) => void;
  firmwareVersion: string | null;
  setFirmwareVersion: ((value: string) => void) | null;

}

export const FilterElrs: React.FC<FilterElrsModel> = observer(
  ({
    category,
    MAC_address,
    setMAC_address,
    firmwareState,
    setFirmwareState,
    firmwareVersion,
    setFirmwareVersion
  }) => {
    const context = useContext(Context);

    if (!context) {
      throw new Error("Context must be used within a Provider");
    }

    const { elrsStore } = context;

    const categoriesOptions = () => {
      if (category === "915")
        return elrsStore.defect_915_Categories.map((el) => (
          <option key={el.id} value={el.id}>
            {el.title}
          </option>
        ));
      else if (category === "24")
        return elrsStore.defect_2_4_Categories.map((el) => (
          <option key={el.id} value={el.id}>
            {el.title}
          </option>
        ));
    };

    return (
      <tr className="bg-gray-800 text-white text-sm uppercase font-semibold">
        <th className="px-4 py-3 border border-gray-600">
          <input
            className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            value={MAC_address}
            onChange={(e) => setMAC_address(e.target.value)}
            placeholder="–í–≤–µ–¥–∏—Ç–µ –º–∞–∫-–∞–¥—Ä–µ—Å—Å"
          />
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            value={firmwareState}
            onChange={(e) => setFirmwareState(e.target.value)}
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
          >
            <option value="" disabled selected>
              –ü—Ä–æ—à–∏–≤–∫–∞
            </option>
            <option value="true">‚úÖ –î–∞</option>
            <option value="false">‚ùå –ù–µ—Ç</option>
          </select>
        </th>


        {category === "915" &&

          <th className="px-2 py-2 border border-gray-600">
            <select
              value={firmwareVersion ?? ''}
              onChange={(e) => setFirmwareVersion ? setFirmwareVersion(e.target.value) : console.error('setFirmwareVersion is null')}
              className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            >
              <option value="" disabled selected>
                –í–µ—Ä—Å–∏—è
              </option>
              <option value="002"> 002</option>
              <option value="019">019</option>
            </select>
          </th>
        }


        <th className="px-2 py-2 border border-gray-600">
          <select
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            onChange={(e) => {
              const selectedPC = elrsStore.PCs.find(
                (pc) => pc.id === Number(e.target.value)
              );
              if (selectedPC) elrsStore.setSelectedPC(selectedPC);
            }}
          >
            <option value="" disabled selected>
              –ö–æ–º–ø—å—é—Ç–µ—Ä
            </option>
            {elrsStore.PCs.map((el) => (
              <option key={el.id} value={el.id}>
                {el.pc_name}
              </option>
            ))}
          </select>
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            onChange={(e) => {
              const selectedUser = elrsStore.users.find(
                (user) => user.id === Number(e.target.value)
              );
              if (selectedUser) elrsStore.setSelectedUser(selectedUser);
            }}
          >
            <option value="" disabled selected>
              –°–æ—Ç—Ä—É–¥–Ω–∏–∫
            </option>
            {elrsStore.users.map((el) => (
              <option key={el.id} value={el.id}>
                {el.name} {el.surname}
              </option>
            ))}
          </select>
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            onChange={(e) => {
              if (category === "915") {
                const selectedDefect = elrsStore.defect_915_Categories.find(
                  (defect) => defect.id === Number(e.target.value)
                );
                if (selectedDefect) elrsStore.setSelectedDefect(selectedDefect);
              } else if (category === "24") {
                const selectedDefect = elrsStore.defect_2_4_Categories.find(
                  (defect) => defect.id === Number(e.target.value)
                );
                if (selectedDefect) elrsStore.setSelectedDefect(selectedDefect);
              }
            }}
          >
            <option value="" disabled selected>
              –ë—Ä–∞–∫
            </option>

            {categoriesOptions()}
          </select>
        </th>

        <th className="px-4 py-3 border border-gray-600">
          <DateFilterforElrs />
        </th>
      </tr>
    );
  }
);

================================================================================
FILE: QMS-Client-main/src/pages/Tables/ELRS915s/PagesELRS.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext } from "react";
import { Context } from "src/main";

export const PagesELRS: React.FC = observer(() => {
  const context = useContext(Context);
  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { elrsStore } = context;

  const pageCount = Math.ceil(elrsStore.totalCount / elrsStore.limit);
  const pages = Array.from({ length: pageCount }, (_, i) => i + 1);

  return (
    <div className="flex flex-wrap justify-center items-center gap-2 mt-6 max-w-2xl">
      {pages.map((page) => (
        <button
          key={page}
          onClick={() => elrsStore.setPage(page)}
          className={`px-4 py-2 rounded-lg text-lg font-semibold transition duration-200
            ${
              elrsStore.page === page
                ? "bg-indigo-600 text-white shadow-lg"
                : "bg-gray-200 text-gray-800 hover:bg-indigo-400 hover:text-white"
            }`}
          type="button"
        >
          {page}
        </button>
      ))}
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Tables/FlightController/DateFilter.tsx
================================================================================

import { DatePicker, Tooltip } from "@skbkontur/react-ui";


import React from "react";

interface DateFilterProps {
  startDate: string;
  endDate: string;
  onStartDateChange: (date: string) => void;
  onEndDateChange: (date: string) => void;
}

export const DateFilter: React.FC<DateFilterProps> = ({
  startDate,
  endDate,
  onStartDateChange,
  onEndDateChange
}) => {


  const [startValue, setStartValue] = React.useState("");
  const [endValue, setEndValue] = React.useState("");
  const [startError, setStartError] = React.useState(false);
  const [endError, setEndError] = React.useState(false);
  const [startTooltip, setStartTooltip] = React.useState(false);
  const [endTooltip, setEndTooltip] = React.useState(false);

  const minDate = "01.01.2025";
  const maxDate = "02.05.2028";
  React.useEffect(() => {
    setStartValue(startDate);
  }, [startDate]);

  React.useEffect(() => {
    setEndValue(endDate);
  }, [endDate]);

  const unvalidateStart = () => {
    setStartError(false);
    setStartTooltip(false);
  };

  const unvalidateEnd = () => {
    setEndError(false);
    setEndTooltip(false);
  };

  const validateStart = () => {
    const errorNew =
      !!startValue &&
      !DatePicker.validate(startValue, { minDate, maxDate });
    setStartError(errorNew);
    setStartTooltip(errorNew);
  };

  const validateEnd = () => {
    const errorNew =
      !!endValue &&
      !DatePicker.validate(endValue, { minDate, maxDate });
    setEndError(errorNew);
    setEndTooltip(errorNew);
  };

  React.useEffect(() => {
    if (!startError) onStartDateChange(startValue);
  }, [startValue]);

  React.useEffect(() => {
    if (!endError) onEndDateChange(endValue);
  }, [endValue]);


  return (
    <div className="flex flex-col gap-2">
      <div className="text-sm text-white mb-1">–ü–µ—Ä–∏–æ–¥:</div>

      <div className="flex justify-center gap-2">
        <div className="flex items-center gap-2">
          <span className="text-sm text-white whitespace-nowrap">–°:</span>
          <Tooltip
            trigger={startTooltip ? "opened" : "closed"}
            render={() => "–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –¥–∞—Ç–∞"}
            onCloseClick={() => setStartTooltip(false)}
          >
            <DatePicker
              error={startError}
              value={startValue}
              onValueChange={setStartValue}
              onFocus={unvalidateStart}
              onBlur={validateStart}
              minDate={minDate}
              maxDate={maxDate}
              enableTodayLink
              width={120}
            />
          </Tooltip>
        </div>

        <div className="flex items-center gap-2">
          <span className="text-sm text-white whitespace-nowrap">–ü–æ:</span>
          <Tooltip
            trigger={endTooltip ? "opened" : "closed"}
            render={() => "–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –¥–∞—Ç–∞"}
            onCloseClick={() => setEndTooltip(false)}
          >
            <DatePicker
              error={endError}
              value={endValue}
              onValueChange={setEndValue}
              onFocus={unvalidateEnd}
              onBlur={validateEnd}
              minDate={minDate}
              maxDate={maxDate}
              enableTodayLink
              width={120}
            />
          </Tooltip>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Tables/FlightController/FCItem.tsx
================================================================================

import { Trash2 } from "lucide-react";
import { observer } from "mobx-react-lite";
import { useContext, useState } from "react";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { Context } from "src/main";

interface OneFCItem {
  unique_device_id: string;
  firmware: boolean;
  sessionId: number;
  categoryDefectedId: number;
  createdAt: string;
  stand_test: boolean;
  deleteFC: () => void;
}

export const FCItem: React.FC<OneFCItem> = observer(
  ({
    unique_device_id,
    firmware,
    sessionId,
    categoryDefectedId,
    createdAt,
    stand_test,
    deleteFC,
  }) => {
    const context = useContext(Context);

    if (!context) {
      throw new Error("Context must be used within a Provider");
    }

    const { flightController, user } = context;

    const currentSession = flightController.sessions.find(
      (session) => session.id === sessionId
    );

    const currentPC = flightController.PCs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    const currentDefect = flightController.defectCategories.find(
      (defect) => defect.id === categoryDefectedId
    );

    const currentUser = flightController.users.find(
      (user) => user.id === currentSession?.userId
    );

    const [modalType, setModalType] = useState<string | null>(null);

    const openModal = (type: string) => setModalType(type);
    const closeModal = () => setModalType(null);

    return (
      <tr className="text-center hover:bg-gray-500 transition odd:bg-gray-200 even:bg-white">
        <td className="px-4 py-2 border">{unique_device_id}</td>
        <td className="px-4 py-2 border">
          {firmware ? "–ø—Ä–æ—à–∏—Ç–æ ‚úÖ" : "–Ω–µ –ø—Ä–æ—à–∏—Ç–æ ‚ùå"}
        </td>
        <td className="px-4 py-2 border">{currentPC?.pc_name}</td>
        <td className="px-4 py-2 border">
          {currentUser?.name} {currentUser?.surname}
        </td>
        <td className="px-4 py-2 border">{currentDefect?.title}</td>
        <td className="px-4 py-2 border">
          {stand_test === true ? "–ø—Ä–æ–π–¥–µ–Ω ‚úÖ" : stand_test === false ? "–Ω–µ –ø—Ä–æ–π–¥–µ–Ω ‚ùå" : ""}
        </td>
        <td className="px-4 py-2 border">{createdAt}</td>
        {user.isAdmin && (
          <td>
            {" "}
            <button
              className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition"
              onClick={() => openModal("computerDelete")}
            >
              <Trash2 size={15} />
            </button>
          </td>
        )}

        <Modal isOpen={modalType === "computerDelete"} onClose={closeModal}>
          <ConfirmModal
            title1={`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä  ${unique_device_id} ${createdAt} ?`}
            actionConfirm={deleteFC}
            onClose={closeModal}
          />
        </Modal>
      </tr>
    );
  }
);

================================================================================
FILE: QMS-Client-main/src/pages/Tables/FlightController/FCList.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState } from "react";
import { Context } from "src/main";
import { FCItem } from "./FCItem";
import {
  deleteFCbyID,
  fetchCategoryDefect,
  fetchFC,
  fetchPC,
  fetchSession,
  fetchUsers,
} from "src/api/fcApi";
import { FilterFC } from "./FilterFC";
import dayjs from "dayjs";

export const FlightControllerList = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { flightController } = context;

  const [firmwareState, setFirmwareState] = useState("");
  const [standTestState, setStandTestState] = useState("");
  const [unique_device_id, setUnique_device_id] = useState("");

  const parseFilterValue = (value: string): boolean | null => {
    if (value === "true") return true;
    if (value === "false") return false;
    return null;
  };


  const loadData = async (page: number = flightController.page) => {
    const valueFIRM = parseFilterValue(firmwareState);
    const valueStandTest = parseFilterValue(standTestState);

    const data = await fetchFC(
      unique_device_id === "" ? null : unique_device_id,
      valueFIRM,
      flightController.selectedPC ? flightController.selectedPC.id : null,
      flightController.selectedUser ? flightController.selectedUser.id : null,
      flightController.selectedDefect ? flightController.selectedDefect.id : null,
      valueStandTest,
      flightController.selectedStartDate,
      flightController.selectedEndDate,
      flightController.limit,
      page
    );

    flightController.setFCs(data.rows);
    flightController.setTotalCount(data.count);
    return data;
  };


  const loadReferenceData = async () => {
    const [sessions, users, pcs, defects] = await Promise.all([
      fetchSession(),
      fetchUsers(),
      fetchPC(),
      fetchCategoryDefect()
    ]);

    flightController.setSessions(sessions);
    flightController.setUsers(users);
    flightController.setPCs(pcs);
    flightController.setDefectCategories(defects);
  };


  useEffect(() => {
    const initializeData = async () => {
      await loadReferenceData();
      await loadData(1);
    };

    initializeData();
  }, []);

  useEffect(() => {
    loadData();
  }, [flightController.page]);

  const refetch = () => {
    loadData();
  };

  const deleteFC = async (id: number) => {
    await deleteFCbyID(id);
    refetch();
  };


  const resetAllFilters = async () => {

    setFirmwareState("");
    setStandTestState("");
    setUnique_device_id("");


    flightController.resetAll();


    await loadData(1);
  };

  const fcAllOnPage = flightController.FCs.map((fc) => (
    <FCItem
      key={fc.id}
      unique_device_id={fc.unique_device_id}
      firmware={fc.firmware}
      sessionId={fc.sessionId}
      categoryDefectedId={fc.categoryDefectId}
      stand_test={fc.stand_test}
      createdAt={dayjs(fc.createdAt).format("DD.MM.YYYY HH:mm")}
      deleteFC={() => deleteFC(fc.id)}
    />
  ));

  const [inputValue, setInputValue] = useState(
    flightController.limit.toString()
  );
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;


    setInputValue(value);


    if (value === "") return;


    const numericValue = Number(value);
    if (!isNaN(numericValue) && numericValue > 0) {
      flightController.setLimit(numericValue);
    }
  };

  useEffect(() => {
    setInputValue(flightController.limit.toString());
  }, [flightController.limit]);


  return (
    <div className="overflow-x-auto p-6 bg-white shadow-lg rounded-lg">
      <div className=" flex items-center gap-4 bg-gray-100 p-4 rounded-lg shadow-sm">
        <div className="w-3/4"> </div>

        <label className="text-gray-800 font-medium whitespace-nowrap">
          –ù–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:
        </label>
        <div className="relative">
          <input
            value={inputValue}
            type="number"
            min={0}
            onChange={handleChange}
            className="w-24 p-2 text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none shadow-sm"
          />
        </div>
      </div>

      <div className="flex justify-between items-center mt-4">
         <button
          type="button"
          onClick={resetAllFilters}
          className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 font-medium"
          title="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã"
        >
          üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        </button>

        <button
          type="button"
          onClick={refetch}
          className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200 font-medium"
          title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã"
        >
          üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
        </button>
      </div>

      <div className="flex mt-4">
        <div className="w-3/4"></div>
        <h1 className="text-2xl font-bold text-gray-800 mb-4">
          –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –±–∞–∑–µ: {flightController.totalCount}
        </h1>
      </div>

      <table className="min-w-full shadow-lg rounded-lg border border-gray-400">
        <thead>
          <tr className=" bg-indigo-700 text-white text-sm uppercase font-semibold">
            <th className="px-4 py-3 border border-gray-400">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
            <th className="px-4 py-3 border border-gray-400">–ü—Ä–æ—à–∏–≤–∫–∞</th>
            <th className="px-4 py-3 border border-gray-400">–ö–æ–º–ø—å—é—Ç–µ—Ä</th>
            <th className="px-4 py-3 border border-gray-400">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th className="px-4 py-3 border border-gray-400">–ë—Ä–∞–∫</th>
            <th className="px-4 py-3 border border-gray-400">–°—Ç–µ–Ω–¥ –¢–µ—Å—Ç</th>
            <th className="px-4 py-3 border border-gray-400">
              –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            </th>
          </tr>

          <FilterFC
            unique_device_id={unique_device_id}
            setUnique_device_id={setUnique_device_id}
            firmwareState={firmwareState}
            setFirmwareState={setFirmwareState}
            standTestState={standTestState}
            setStandTestState={setStandTestState}
          />
        </thead>
        <tbody>
          {fcAllOnPage.length > 0 ? (
            fcAllOnPage
          ) : (
            <td className="px-4 py-6 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
          )}
        </tbody>
      </table>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Tables/FlightController/FCs.tsx
================================================================================

import { FlightControllerList } from "./FCList";
import { Pages } from "./Pages";
import FC1 from 'assets/images/FC1.png'
import FC2 from 'assets/images/FC2.png'

export const FCs: React.FC = () => {
  return (
    <div className="flex  h-screen bg-gray-100/60">


      <main className="flex-1 p-6 flex flex-col overflow-y-auto h-screen">

        <header className=" flex  mb-6">
          <h1 className="text-3xl font-bold text-gray-800">
            –ü–æ–ª–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (FC)
          </h1>


        <div className="flex ml-10 justify-center items-center gap-6">
          <img
            src={FC2}
            className="w-24 h-auto rounded-lg shadow-md"
            alt="FC1"
          />
          <img
            src={FC1}
            className="w-24 h-auto rounded-lg shadow-md"
            alt="FC2"
          />
        </div>
        </header>


        <div className="flex-1 bg-white shadow-md rounded-lg">
          <FlightControllerList />
        </div>


        <div className="mt-6 flex justify-center">
          <Pages />
        </div>
      </main>


    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Tables/FlightController/FilterFC.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext } from "react";
import { Context } from "src/main";
import { DateFilter } from "./DateFilter";

interface FilterFCModel {
  unique_device_id: string;
  setUnique_device_id: (value: string) => void;
  firmwareState: string;
  setFirmwareState: (value: string) => void;
  standTestState: string;
  setStandTestState: (value: string) => void;
}

export const FilterFC: React.FC<FilterFCModel> = observer(
  ({
    unique_device_id,
    setUnique_device_id,
    firmwareState,
    setFirmwareState,
    standTestState,
    setStandTestState,
  }) => {
    const context = useContext(Context);

    if (!context) {
      throw new Error("Context must be used within a Provider");
    }

    const { flightController } = context;


    const handleStartDateChange = (date: string) => {
      flightController.setSelectedStartDate(date);
    };

    const handleEndDateChange = (date: string) => {
      flightController.setSelectedEndDate(date);
    };


    return (
      <tr className="bg-gray-800 text-white text-sm uppercase font-semibold">
        <th className="px-4 py-3 border border-gray-600">
          <input
            className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            value={unique_device_id}
            onChange={(e) => setUnique_device_id(e.target.value)}
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä FC"
          />

        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            value={firmwareState}
            onChange={(e) => setFirmwareState(e.target.value)}
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
          >
            <option value="" disabled selected>
              –ü—Ä–æ—à–∏–≤–∫–∞
            </option>
            <option value="true">‚úÖ –î–∞</option>
            <option value="false">‚ùå –ù–µ—Ç</option>
          </select>
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            value={flightController.selectedPC ? flightController.selectedPC.id : ""}
            onChange={(e) => {
              const selectedPC = flightController.PCs.find(
                (pc) => pc.id === Number(e.target.value)
              );
              flightController.setSelectedPC(selectedPC ?? null);
            }}
          >
            <option value="" disabled selected>
              –ö–æ–º–ø—å—é—Ç–µ—Ä
            </option>
            {flightController.PCs.map((el) => (
              <option key={el.id} value={el.id}>
                {el.pc_name}
              </option>
            ))}
          </select>
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            value={flightController.selectedUser ? flightController.selectedUser.id : ""}
            onChange={(e) => {
              const selectedUser = flightController.users.find(
                (user) => user.id === Number(e.target.value)
              );
              flightController.setSelectedUser(selectedUser ?? null)
            }}
          >
            <option value="" disabled selected>
              –°–æ—Ç—Ä—É–¥–Ω–∏–∫
            </option>
            {flightController.users.map((el) => (
              <option key={el.id} value={el.id}>
                {el.name} {el.surname}
              </option>
            ))}
          </select>
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
            value={flightController.selectedDefect ? flightController.selectedDefect.id : ""}
            onChange={(e) => {
              const selectedDefect = flightController.defectCategories.find(
                (defect) => defect.id === Number(e.target.value)
              );
              flightController.setSelectedDefect(selectedDefect ?? null)

            }}
          >
            <option value="" disabled selected>
              –ë—Ä–∞–∫
            </option>
            {flightController.defectCategories.map((el) => (
              <option key={el.id} value={el.id}>
                {el.title}
              </option>
            ))}
          </select>
        </th>


        <th className="px-2 py-2 border border-gray-600">
          <select
            value={standTestState}
            onChange={(e) => setStandTestState(e.target.value)}
            className="w-full p-2 border border-gray-500 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-indigo-400 transition"
          >
            <option value="" disabled selected>
              –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω
            </option>
            <option value="true">‚úÖ –î–∞</option>
            <option value="false">‚ùå –ù–µ—Ç</option>
          </select>
        </th>

        <th className="px-4 py-3 border border-gray-600">
          <DateFilter
          startDate={flightController.selectedStartDate || ""}
  endDate={flightController.selectedEndDate || ""}
            onStartDateChange={handleStartDateChange}
            onEndDateChange={handleEndDateChange} />
        </th>
      </tr>
    );
  }
);

================================================================================
FILE: QMS-Client-main/src/pages/Tables/FlightController/Pages.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext } from "react";
import { Context } from "src/main";

export const Pages: React.FC = observer(() => {
  const context = useContext(Context);
  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { flightController } = context;

  const pageCount = Math.ceil(
    flightController.totalCount / flightController.limit
  );

  const currentPage = flightController.page;


  const getVisiblePages = () => {
    const visiblePages = [];
    const range = 2;


    visiblePages.push(1);


    const start = Math.max(2, currentPage - range);
    const end = Math.min(pageCount - 1, currentPage + range);
    if (start > 2) {
      visiblePages.push("...");
    }

    for (let i = start; i <= end; i++) {
      visiblePages.push(i);
    }

    if (end < pageCount - 1) {
      visiblePages.push("...");
    }


    if (pageCount > 1) {
      visiblePages.push(pageCount);
    }

    return visiblePages;
  };

  const visiblePages = getVisiblePages();


  return (
    <div className="flex flex-wrap justify-center items-center gap-2 mt-6 max-w-2xl">
      <button
        onClick={() => flightController.setPage(Math.max(1, currentPage - 1))}
        disabled={currentPage === 1}
        className="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold disabled:opacity-50"
      >
        –ù–∞–∑–∞–¥
      </button>

      {visiblePages.map((page, index) =>
        page === "..." ? (
          <span key={`ellipsis-${index}`} className="px-2 py-2">
            ...
          </span>
        ) : (
          <button
            key={page}
            onClick={() => flightController.setPage(page as number)}
            className={`px-4 py-2 rounded-lg text-lg font-semibold transition duration-200
              ${
                currentPage === page
                  ? "bg-indigo-600 text-white shadow-lg"
                  : "bg-gray-200 text-gray-800 hover:bg-indigo-400 hover:text-white"
              }`}
            type="button"
          >
            {page}
          </button>
        )
      )}

      <button
        onClick={() =>
          flightController.setPage(Math.min(pageCount, currentPage + 1))
        }
        disabled={currentPage === pageCount}
        className="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold disabled:opacity-50"
      >
        –í–ø–µ—Ä–µ–¥
      </button>


    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Tasks/ProjectsList.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { Plus, Trash2, FolderOpen, Box } from "lucide-react";
import { fetchProjects, createProject, deleteProject, ProjectModel } from "src/api/projectsApi";
import { Modal } from "src/components/Modal/Modal";

const ProjectsList: React.FC = () => {
    const [projects, setProjects] = useState<ProjectModel[]>([]);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [form, setForm] = useState({ title: "", description: "" });

    const load = async () => {
        const data = await fetchProjects();
        setProjects(data);
    };

    useEffect(() => { load(); }, []);

    const handleCreate = async () => {
        if(!form.title) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
        await createProject(form.title, form.description);
        setIsModalOpen(false);
        setForm({ title: "", description: "" });
        load();
    };

    const handleDelete = async (id: number) => {
        if(window.confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) {
            await deleteProject(id);
            load();
        }
    };

    return (
        <div className="animate-fade-in">
            <div className="flex justify-end mb-4">
                <button onClick={() => setIsModalOpen(true)} className="flex items-center gap-2 bg-gray-900 text-white px-4 py-2 rounded-xl font-bold hover:bg-black transition">
                    <Plus size={18}/> –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {projects.map(p => (
                    <div key={p.id} className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 hover:shadow-md transition relative group">
                        <div className="flex justify-between items-start mb-2">
                            <div className="p-3 bg-blue-50 text-blue-600 rounded-xl">
                                <FolderOpen size={24}/>
                            </div>
                            <button onClick={() => handleDelete(p.id)} className="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100">
                                <Trash2 size={18}/>
                            </button>
                        </div>
                        <h3 className="text-lg font-bold text-gray-800 mb-1">{p.title}</h3>
                        <p className="text-sm text-gray-500 mb-4 line-clamp-2 h-10">{p.description || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}</p>

                        <div className="flex justify-between items-center text-xs text-gray-400 border-t pt-3">
                            <span>–°–æ–∑–¥–∞–ª: {p.author?.surname || "Admin"}</span>
                            <span>{new Date(p.createdAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                ))}
            </div>

            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)}>
                <div className="p-4">
                    <h2 className="text-xl font-bold mb-4">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h2>
                    <input className="w-full p-3 border rounded-xl mb-3" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –î—Ä–æ–Ω-—Ä–∞–∑–≤–µ–¥—á–∏–∫)" value={form.title} onChange={e => setForm({...form, title: e.target.value})} />
                    <textarea className="w-full p-3 border rounded-xl mb-3" placeholder="–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –ø—Ä–æ–µ–∫—Ç..." rows={3} value={form.description} onChange={e => setForm({...form, description: e.target.value})} />
                    <button onClick={handleCreate} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </Modal>
        </div>
    );
};

export default ProjectsList;

================================================================================
FILE: QMS-Client-main/src/pages/Tasks/TasksList.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  ProductionTask,
  TaskDetailResponse,
  fetchTasks,
  fetchTaskById,
  createTask,
  updateTaskStatus,
  updateTask,
  deleteTask,
} from "src/api/tasksApi";
import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { fetchUsers } from "src/api/fcApi";
import { fetchStructure } from "src/api/structureApi";
import { userGetModel } from "src/types/UserModel";
import { SectionModel } from "src/store/StructureStore";
import {
  Plus, Calendar, Target, Loader2, MapPin, Box,
  CheckCircle2, AlertCircle, Clock, Flag, User, Trash2, Building2,
  Edit3, Save, X, Briefcase
} from "lucide-react";
import { Modal } from "src/components/Modal/Modal";

interface TaskStats { total: number; done: number; inWork: number; onStock: number; }
interface ExtendedTask extends ProductionTask { stats?: TaskStats; }

const TasksList: React.FC = () => {
  const [tasks, setTasks] = useState<ExtendedTask[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedTask, setSelectedTask] = useState<TaskDetailResponse | null>(null);

  const [isEditing, setIsEditing] = useState(false);
  const [editForm, setEditForm] = useState<any>({});

  const [users, setUsers] = useState<userGetModel[]>([]);
  const [sections, setSections] = useState<SectionModel[]>([]);
  const [projects, setProjects] = useState<ProjectModel[]>([]);

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [createForm, setCreateForm] = useState<any>({ priority: "1", targetQty: "" });

  const loadData = async () => {
    setLoading(true);
    try {
      const res = await fetchTasks({ page: 1, limit: 100 });
      setTasks(res.rows as unknown as ExtendedTask[]);
    } catch (e) { console.error(e); }
    finally { setLoading(false); }
  };

  useEffect(() => {
      loadData();
      fetchUsers().then(setUsers);
      fetchStructure().then(setSections);
      fetchProjects().then(setProjects);
  }, []);

  const handleSelectTask = async (id: number) => {
    setIsEditing(false);
    try {
      const res = await fetchTaskById(id);
      setSelectedTask(res);
    } catch (e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π"); }
  };

  const startEditing = () => {
      if(!selectedTask) return;
      setEditForm({
          priority: selectedTask.task.priority,
          dueDate: selectedTask.task.dueDate,
          responsibleId: selectedTask.task.responsibleId,
          sectionId: selectedTask.task.sectionId,
          projectId: selectedTask.task.projectId,
          status: selectedTask.task.status
      });
      setIsEditing(true);
  };

  const saveChanges = async () => {
      if(!selectedTask) return;
      try {
          await updateTask(selectedTask.task.id, editForm);
          setIsEditing(false);
          handleSelectTask(selectedTask.task.id);
          loadData();
      } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
  };


  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">


        <div className="lg:col-span-7 space-y-4">
            <button onClick={() => setIsModalOpen(true)} className="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:border-indigo-500 hover:text-indigo-600 transition flex justify-center items-center gap-2">
                <Plus size={20}/> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
            </button>

            {loading && <Loader2 className="animate-spin mx-auto"/>}

            {tasks.map(task => {
                const stats = task.stats || { done: 0, inWork: 0, onStock: 0, total: 0 };
                const pDone = Math.min(100, Math.round((stats.done / task.targetQty) * 100));

                const projName = projects.find(p => p.id === task.projectId)?.title;

                return (
                    <div
                        key={task.id}
                        onClick={() => handleSelectTask(task.id)}
                        className={`bg-white p-5 rounded-2xl border transition-all cursor-pointer hover:shadow-lg relative overflow-hidden ${selectedTask?.task.id === task.id ? 'border-indigo-500 ring-2 ring-indigo-100' : 'border-gray-200'}`}
                    >

                        <div className="flex justify-between items-start mb-2">
                            <div className="flex flex-col">
                                <h3 className="font-bold text-lg text-gray-800">{task.title}</h3>
                                {projName && <span className="text-xs text-indigo-600 font-bold flex items-center gap-1"><Briefcase size={10}/> {projName}</span>}
                            </div>
                            <div className="text-right">
                                <div className="text-2xl font-black text-gray-900">{stats.total} <span className="text-sm text-gray-400">/ {task.targetQty}</span></div>
                            </div>
                        </div>

                        <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden mt-2">
                            <div style={{width: `${pDone}%`}} className="bg-emerald-500 h-full"></div>
                        </div>
                    </div>
                )
            })}
        </div>


        <div className="lg:col-span-5">
           {selectedTask ? (
             <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sticky top-6">


                <div className="flex justify-between items-start mb-4 border-b pb-4">
                    <h2 className="text-xl font-bold text-gray-800 w-3/4">{selectedTask.task.title}</h2>
                    <div className="flex gap-2">
                        {isEditing ? (
                            <>
                                <button onClick={saveChanges} className="p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200"><Save size={18}/></button>
                                <button onClick={() => setIsEditing(false)} className="p-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200"><X size={18}/></button>
                            </>
                        ) : (
                            <button onClick={startEditing} className="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100"><Edit3 size={18}/></button>
                        )}
                    </div>
                </div>


                <div className="space-y-4 mb-6">

                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–°—Ç–∞—Ç—É—Å</span>
                        {isEditing ? (
                            <select
                                value={editForm.status}
                                onChange={e => setEditForm({...editForm, status: e.target.value})}
                                className="border rounded p-1 text-sm font-bold"
                            >
                                <option value="NEW">–ù–û–í–ê–Ø</option>
                                <option value="IN_PROGRESS">–í –†–ê–ë–û–¢–ï</option>
                                <option value="DONE">–ì–û–¢–û–í–û</option>
                            </select>
                        ) : (
                            <span className="px-2 py-1 bg-gray-100 rounded text-xs font-bold">{selectedTask.task.status}</span>
                        )}
                    </div>


                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–ü—Ä–æ–µ–∫—Ç</span>
                        {isEditing ? (
                            <select
                                value={editForm.projectId || ""}
                                onChange={e => setEditForm({...editForm, projectId: e.target.value || null})}
                                className="border rounded p-1 text-sm w-48"
                            >
                                <option value="">–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞</option>
                                {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                            </select>
                        ) : (
                            <span className="text-sm font-medium text-indigo-600">
                                {projects.find(p => p.id === selectedTask.task.projectId)?.title || "‚Äî"}
                            </span>
                        )}
                    </div>


                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
                        {isEditing ? (
                            <select
                                value={editForm.priority || 1}
                                onChange={e => setEditForm({...editForm, priority: e.target.value})}
                                className="border rounded p-1 text-sm"
                            >
                                <option value="1">–ù–∏–∑–∫–∏–π</option>
                                <option value="2">–°—Ä–µ–¥–Ω–∏–π</option>
                                <option value="3">–í—ã—Å–æ–∫–∏–π</option>
                            </select>
                        ) : (
                            <span className="text-sm">{selectedTask.task.priority === 3 ? "üî• –í—ã—Å–æ–∫–∏–π" : "–û–±—ã—á–Ω—ã–π"}</span>
                        )}
                    </div>


                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</span>
                        {isEditing ? (
                            <select
                                value={editForm.responsibleId || ""}
                                onChange={e => setEditForm({...editForm, responsibleId: e.target.value || null})}
                                className="border rounded p-1 text-sm w-48"
                            >
                                <option value="">-- –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω --</option>
                                {users.map(u => <option key={u.id} value={u.id}>{u.surname} {u.name}</option>)}
                            </select>
                        ) : (
                            <span className="text-sm">{selectedTask.task.responsible ? `${selectedTask.task.responsible.surname} ${selectedTask.task.responsible.name}` : "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"}</span>
                        )}
                    </div>


                    <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-500 font-bold uppercase">–°—Ä–æ–∫ —Å–¥–∞—á–∏</span>
                        {isEditing ? (
                            <input type="date" value={editForm.dueDate || ""} onChange={e => setEditForm({...editForm, dueDate: e.target.value})} className="border rounded p-1 text-sm"/>
                        ) : (
                            <span className="text-sm">{selectedTask.task.dueDate || "‚Äî"}</span>
                        )}
                    </div>
                </div>


                <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm uppercase tracking-wide border-t pt-4">
                   <MapPin size={16} className="text-indigo-500"/> –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–¥–µ–ª–∏–π
                </h3>
                <div className="space-y-2">
                   {selectedTask.breakdown.map((item, idx) => (
                     <div key={idx} className="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                        <span>{item.sectionTitle || "–°–∫–ª–∞–¥"}</span>
                        <span className="font-bold">{item.qty} —à—Ç</span>
                     </div>
                   ))}
                </div>

             </div>
           ) : (
             <div className="h-[400px] flex items-center justify-center text-gray-400 bg-white rounded-2xl border-2 border-dashed">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É</p>
             </div>
           )}
        </div>


        <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)}>
            <div className="p-4">
                <h2 className="text-xl font-bold mb-4">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
                <div className="space-y-4">
                    <input className="w-full p-2 border rounded" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value={createCreateFormTitle(createForm)} onChange={e => setCreateForm({...createForm, title: e.target.value})} />


                    <select className="w-full p-2 border rounded" value={createForm.projectId || ""} onChange={e => setCreateForm({...createForm, projectId: e.target.value})}>
                        <option value="">-- –ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞ --</option>
                        {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                    </select>

                    <div className="grid grid-cols-2 gap-2">
                        <select className="w-full p-2 border rounded" value={createForm.originType || "PRODUCT"} onChange={e => setCreateForm({...createForm, originType: e.target.value})}>
                            <option value="PRODUCT">–ò–∑–¥–µ–ª–∏–µ</option>
                            <option value="COMPONENT">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ</option>
                        </select>
                        <input type="number" className="w-full p-2 border rounded" placeholder="ID –û–±—ä–µ–∫—Ç–∞" value={createForm.originId || ""} onChange={e => setCreateForm({...createForm, originId: e.target.value})} />
                    </div>

                    <input type="number" className="w-full p-2 border rounded font-bold" placeholder="–¶–µ–ª—å (—à—Ç)" value={createForm.targetQty} onChange={e => setCreateForm({...createForm, targetQty: e.target.value})} />

                    <button onClick={async () => {
                        await createTask({...createForm, targetQty: Number(createForm.targetQty), originId: Number(createForm.originId), projectId: createForm.projectId ? Number(createForm.projectId) : undefined});
                        setIsModalOpen(false);
                        loadData();
                    }} className="w-full py-3 bg-blue-600 text-white font-bold rounded">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </Modal>
    </div>
  );

  function createCreateFormTitle(form: any) { return form.title || ""; }
};

export default TasksList;

================================================================================
FILE: QMS-Client-main/src/pages/Tasks/TasksPage.tsx
================================================================================

import React, { useState } from "react";
import { Layout, Briefcase } from "lucide-react";
import TasksList from "./TasksList";
import ProjectsList from "./ProjectsList";

const TasksPage: React.FC = () => {
  const [activeTab, setActiveTab] = useState<"TASKS" | "PROJECTS">("TASKS");

  return (
    <div className="min-h-screen bg-gray-50/50 p-6 pb-20 font-sans text-gray-700">


      <div className="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
        <div className="flex items-center gap-4">
           <div className="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 text-white">
              {activeTab === 'TASKS' ? <Layout size={28}/> : <Briefcase size={28}/>}
           </div>
           <div>
              <h1 className="text-2xl font-bold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º</h1>
              <p className="text-gray-500 text-sm font-medium">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∑–∞–¥–∞—á</p>
           </div>
        </div>

        <div className="flex bg-white p-1 rounded-xl shadow-sm border border-gray-200">
            <button
                onClick={() => setActiveTab("TASKS")}
                className={`px-6 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'TASKS' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}
            >
                –ó–∞–¥–∞—á–∏
            </button>
            <button
                onClick={() => setActiveTab("PROJECTS")}
                className={`px-6 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'PROJECTS' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}
            >
                –ü—Ä–æ–µ–∫—Ç—ã
            </button>
        </div>
      </div>

      <div className="max-w-7xl mx-auto">
          {activeTab === "TASKS" && <TasksList />}
          {activeTab === "PROJECTS" && <ProjectsList />}
      </div>
    </div>
  );
};

export default TasksPage;

================================================================================
FILE: QMS-Client-main/src/pages/Users/OneUser.tsx
================================================================================

import { UserIcon, ShieldCheck, MonitorDot, User } from "lucide-react";

interface OneUserProps {
  login: string;
  role: string;
  name: string;
  surName: string;
  img: string | null;
  active: boolean;
  pcName: string | undefined;
  pcIP: string | undefined;
}

export const OneUser: React.FC<OneUserProps> = ({
  login,
  role,
  name,
  surName,
  img,
  active,
  pcName,
  pcIP,
}) => {
  return (
    <div className="bg-white shadow-md rounded-xl p-4 flex items-center gap-4 border-l-4 border-blue-500 transition duration-300 hover:shadow-lg overflow-hidden flex-wrap">


      {img ? (
        <div className="relative w-24 h-24 rounded-full overflow-hidden shadow-2xl border-4 border-white hover:border-purple-500 transition-all duration-300 transform hover:scale-105 group">
          <img
            src={import.meta.env.VITE_API_URL + "/" + img}
            alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
            className="w-full h-full object-cover"
          />
        </div>
      ) : (
        <div className="bg-gradient-to-br from-blue-100 to-purple-100 p-3 rounded-full w-24 h-24 flex items-center justify-center shadow-lg transform transition-all hover:scale-105 duration-300">
          <UserIcon className="text-blue-600 w-12 h-12" />
        </div>
      )}


      <div className="flex-1">
        <h3 className="text-2xl font-bold text-gray-900">
          {name} {surName}
        </h3>
        <p className="text-gray-600 text-sm mt-1">{login}</p>
      </div>


      {active ? (
        <div className="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-full shadow-sm">
          <div className="relative">
            <MonitorDot className="text-green-600 w-6 h-6" />

            <div className="absolute inset-0 flex items-center justify-center">
              <div className="w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
            </div>
          </div>
          <p className="text-sm font-medium text-green-800">
            {pcName} ({pcIP}) ‚Äì Online
          </p>
        </div>
      ) : (
        <div className="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-full shadow-sm">
          <MonitorDot className="text-red-600 w-6 h-6" />
          <p className="text-sm font-medium text-red-800">Offline</p>
        </div>
      )}


      <div className="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-purple-50 px-4 py-2 rounded-full shadow-sm">
        {role === "ADMIN" ? (
          <ShieldCheck className="text-green-600 w-6 h-6" />
        ) : (
          <User className="text-blue-600 w-6 h-6" />
        )}
        <span className="text-gray-700 font-medium">{role}</span>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Users/Users.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect } from "react";
import { fetchPC, fetchSession, fetchUsers } from "src/api/fcApi";
import { Context } from "src/main";
import { OneUser } from "./OneUser";
import { userGetModel } from "src/types/UserModel";
import { SessionModelFull } from "src/types/SessionModel";

export const Users: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { flightController } = context;

  useEffect(() => {
    fetchUsers().then((data) => flightController.setUsers(data));
    fetchSession().then((data) => flightController.setSessions(data));
    fetchPC().then((data) => flightController.setPCs(data));
  }, []);

  const getActiveSession = () => {
    return flightController.sessions.filter(
      (session: SessionModelFull) => session.online === true
    );
  };

  const getUsersOnlineID = () => {
    return (

      getActiveSession().map((session: SessionModelFull) => session.userId)
    );
  };

  const isOnline = (id: number) => {
    return getUsersOnlineID().includes(id);
  };

  const getCurrentPCName = (userId: number) => {
    const currentSession = getActiveSession().find(
      (session) => session.userId === userId
    );
    console.log(currentSession? currentSession.PCId : '00000')
    const currentPC = flightController.PCs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    return currentPC;
  };

  let allUsers = flightController.users.map((user: userGetModel) => (
    <OneUser
      key={user.id}
      login={user.login}
      role={user.role}
      name={user.name}
      surName={user.surname}
      img = {user.img}
      active={isOnline(user.id)}
      pcName={getCurrentPCName(user.id)?.pc_name}
      pcIP={getCurrentPCName(user.id)?.ip}
    />
  ));
  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
        üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {allUsers}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/AnalyticsPage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { fetchDashboardStats } from "src/api/warehouseApi";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { TrendingUp, Package, AlertTriangle, Activity, ArrowLeft } from "lucide-react";
import { WAREHOUSE_ROUTE } from "src/utils/consts";

export const AnalyticsPage: React.FC = () => {
    const navigate = useNavigate();
    const [data, setData] = useState<any>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchDashboardStats().then(res => {
            setData(res);
            setLoading(false);
        });
    }, []);

    if (loading) return <div className="p-10 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</div>;

    const totalItems = data?.stock?.totalItems || 0;
    const totalBoxes = data?.stock?.totalBoxes || 0;
    const scrapOp = data?.today?.find((x: any) => x.operation === 'QUALITY' || x.operation === 'SCRAP');
    const scrapToday = scrapOp ? Number(scrapOp.sumScrap) : 0;
    const chartData = data?.chart?.map((item: any) => ({
        name: new Date(item.date).toLocaleDateString('ru-RU', {weekday: 'short'}),
        count: Number(item.count)
    })) || [];

    return (
        <div className="p-6 max-w-7xl mx-auto animate-fade-in bg-gray-50 min-h-screen">
            <button
                onClick={() => navigate(WAREHOUSE_ROUTE)}
                className="mb-4 flex items-center text-gray-500 hover:text-indigo-600 transition font-medium text-sm"
            >
                <ArrowLeft size={18} className="mr-1"/> –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∫–ª–∞–¥
            </button>

            <h1 className="text-3xl font-bold text-gray-800 mb-8">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h1>


            <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-gray-500 text-sm font-medium">–í—Å–µ–≥–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>
                            <h3 className="text-3xl font-bold text-indigo-600 mt-2">{Number(totalItems).toLocaleString()}</h3>
                            <p className="text-xs text-gray-400 mt-1">–µ–¥–∏–Ω–∏—Ü —Ö—Ä–∞–Ω–µ–Ω–∏—è</p>
                        </div>
                        <div className="p-3 bg-indigo-50 rounded-xl text-indigo-600"><Package /></div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-gray-500 text-sm font-medium">–ú–µ—Å—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è</p>
                            <h3 className="text-3xl font-bold text-gray-800 mt-2">{totalBoxes}</h3>
                            <p className="text-xs text-gray-400 mt-1">–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—Ä–æ–±–æ–∫</p>
                        </div>
                        <div className="p-3 bg-gray-50 rounded-xl text-gray-600"><Activity /></div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-gray-500 text-sm font-medium">–ë—Ä–∞–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</p>
                            <h3 className="text-3xl font-bold text-red-600 mt-2">{scrapToday}</h3>
                            <p className="text-xs text-gray-400 mt-1">–≤—ã—è–≤–ª–µ–Ω–æ –Ω–∞ –û–¢–ö</p>
                        </div>
                        <div className="p-3 bg-red-50 rounded-xl text-red-600"><AlertTriangle /></div>
                    </div>
                </div>

                <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-lg text-white">
                    <p className="text-indigo-100 text-sm font-medium">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
                    <h3 className="text-3xl font-bold mt-2">98.5%</h3>
                    <div className="flex items-center gap-1 text-xs text-indigo-200 mt-1">
                        <TrendingUp size={14}/> <span>–°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç</span>
                    </div>
                </div>
            </div>

            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h3 className="text-lg font-bold text-gray-700 mb-6">–î–∏–Ω–∞–º–∏–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π (7 –¥–Ω–µ–π)</h3>
                <div className="h-80 w-full">
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData}>
                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
                            <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#9ca3af'}} dy={10} />
                            <YAxis axisLine={false} tickLine={false} tick={{fill: '#9ca3af'}} />
                            <Tooltip cursor={{fill: '#f9fafb'}} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} />
                            <Bar dataKey="count" fill="#4f46e5" radius={[4, 4, 0, 0]} barSize={40} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/InventoryPage.tsx
================================================================================

import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import { fetchBoxByQr, moveBoxesBatch, fetchBoxById } from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import { Search, CheckCircle2, Save, Scale, ArrowRight, ScanLine, ArrowLeft } from "lucide-react";
import toast from 'react-hot-toast';
import { WAREHOUSE_ROUTE } from "src/utils/consts";

interface InventoryItem {
    box: InventoryBoxModel;
    systemQty: number;
    actualQty: number;
    delta: number;
}

export const InventoryPage: React.FC = () => {
    const navigate = useNavigate();
    const [scanCode, setScanCode] = useState("");
    const [loading, setLoading] = useState(false);

    const [items, setItems] = useState<InventoryItem[]>([]);
    const [scannedBox, setScannedBox] = useState<InventoryBoxModel | null>(null);
    const [actualInput, setActualInput] = useState("");

    const handleScan = async () => {
        if (!scanCode) return;
        setLoading(true);
        try {
            let res;
            if (/^\d+$/.test(scanCode)) res = await fetchBoxById(Number(scanCode));
            else res = await fetchBoxByQr(scanCode);

            if (items.some(i => i.box.id === res.box.id)) {
                toast.error("–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ!");
                setScanCode("");
                return;
            }
            setScannedBox(res.box);
            setActualInput(String(res.box.quantity));
        } catch (e) {
            toast.error("–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        } finally {
            setLoading(false);
        }
    };

    const confirmItem = () => {
        if (!scannedBox) return;
        const actual = Number(actualInput);
        if (isNaN(actual) || actual < 0) return toast.error("–ù–µ–≤–µ—Ä–Ω–æ–µ —á–∏—Å–ª–æ");
        const delta = actual - scannedBox.quantity;
        setItems(prev => [{
            box: scannedBox,
            systemQty: scannedBox.quantity,
            actualQty: actual,
            delta
        }, ...prev]);
        setScannedBox(null);
        setScanCode("");
        setActualInput("");
        if (delta === 0) toast.success("–°–æ–≤–ø–∞–¥–∞–µ—Ç");
        else toast("–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ", { icon: '‚ö†Ô∏è' });
    };

    const commitInventory = async () => {
        if (items.length === 0) return;
        const loadingToast = toast.loading("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∞...");
        try {
            await moveBoxesBatch({
                movements: items.map(item => ({
                    boxId: item.box.id,
                    operation: "INVENTORY_CHECK",
                    deltaQty: item.delta,
                    comment: `–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è. –ë—ã–ª–æ: ${item.systemQty}, –°—Ç–∞–ª–æ: ${item.actualQty}`
                })),
                documentData: {
                    createNew: true,
                    number: `INV-${Date.now()}`,
                    type: "INVENTORY_ACT",
                    comment: `–ê–∫—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ (${items.length} –ø–æ–∑.)`
                }
            });
            toast.success("–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", { id: loadingToast });
            setItems([]);
        } catch (e: any) {
            toast.error("–û—à–∏–±–∫–∞: " + e.message, { id: loadingToast });
        }
    };

    return (
        <div className="p-6 max-w-5xl mx-auto min-h-screen bg-gray-50">
            <button
                onClick={() => navigate(WAREHOUSE_ROUTE)}
                className="mb-4 flex items-center text-gray-500 hover:text-indigo-600 transition font-medium text-sm"
            >
                <ArrowLeft size={18} className="mr-1"/> –û—Ç–º–µ–Ω–∞ –∏ –≤—ã—Ö–æ–¥
            </button>

            <h1 className="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <Scale className="text-indigo-600"/> –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
            </h1>

            {scannedBox && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-fade-in">
                        <h3 className="text-xl font-bold text-gray-800 mb-1">{scannedBox.label}</h3>
                        <p className="text-gray-500 text-sm mb-6">ID: {scannedBox.id} ‚Ä¢ {scannedBox.shortCode}</p>

                        <div className="flex items-center justify-between bg-gray-100 p-4 rounded-xl mb-6">
                            <div className="text-center">
                                <div className="text-xs text-gray-500 uppercase">–ü–æ —É—á–µ—Ç—É</div>
                                <div className="text-2xl font-bold text-gray-700">{scannedBox.quantity}</div>
                            </div>
                            <ArrowRight className="text-gray-400"/>
                            <div className="text-center w-1/2">
                                <div className="text-xs text-indigo-600 uppercase font-bold mb-1">–ü–æ —Ñ–∞–∫—Ç—É</div>
                                <input
                                    type="number"
                                    value={actualInput}
                                    onChange={e => setActualInput(e.target.value)}
                                    className="w-full text-center text-3xl font-bold border-b-2 border-indigo-500 bg-transparent focus:outline-none"
                                    autoFocus
                                    onKeyDown={e => e.key === 'Enter' && confirmItem()}
                                />
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={() => setScannedBox(null)} className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300">–û—Ç–º–µ–Ω–∞</button>
                            <button onClick={confirmItem} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <div className="lg:col-span-1 space-y-4">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <label className="block text-sm font-bold text-gray-700 mb-2">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR / ID</label>
                        <div className="flex gap-2">
                            <input
                                value={scanCode} onChange={e => setScanCode(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleScan()}
                                className="w-full p-3 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 text-lg outline-none"
                                placeholder="..."
                                autoFocus={!scannedBox}
                            />
                            <button onClick={handleScan} disabled={loading} className="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700">
                                {loading ? <ScanLine className="animate-spin"/> : <Search/>}
                            </button>
                        </div>
                    </div>

                    <div className="bg-indigo-900 p-6 rounded-2xl shadow-lg text-white">
                        <div className="text-indigo-200 text-sm font-medium mb-1">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π</div>
                        <div className="text-5xl font-black">{items.length}</div>
                    </div>
                </div>


                <div className="lg:col-span-2">
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 min-h-[500px] flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="font-bold text-gray-700">–õ–∏—Å—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</h3>
                            {items.length > 0 && <button onClick={commitInventory} className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition"><Save size={18}/> –ó–∞–≤–µ—Ä—à–∏—Ç—å –∞–∫—Ç</button>}
                        </div>

                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                            {items.length === 0 && (
                                <div className="h-full flex flex-col items-center justify-center text-gray-400">
                                    <Scale size={48} className="mb-2 opacity-20"/>
                                    <p>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
                                </div>
                            )}
                            {items.map((item, idx) => (
                                <div key={idx} className="flex items-center justify-between p-3 bg-white border rounded-xl shadow-sm">
                                    <div>
                                        <div className="font-bold text-gray-800">{item.box.label}</div>
                                        <div className="text-xs text-gray-500">ID: {item.box.id}</div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="text-right">
                                            <div className="text-xs text-gray-400">–£—á–µ—Ç</div>
                                            <div className="font-medium">{item.systemQty}</div>
                                        </div>
                                        <ArrowRight size={14} className="text-gray-300"/>
                                        <div className="text-right">
                                            <div className="text-xs text-gray-400">–§–∞–∫—Ç</div>
                                            <div className="font-bold text-lg">{item.actualQty}</div>
                                        </div>
                                        <div className={`w-20 text-center py-1 rounded-lg text-xs font-bold ${item.delta === 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                            {item.delta === 0 ? <CheckCircle2 className="mx-auto" size={16}/> : `${item.delta > 0 ? '+' : ''}${item.delta}`}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/WarehousePage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import {
  Package, ArrowRightLeft, FileText, Truck, PieChart,
  BarChart3, ClipboardCheck, Settings, Tag, Tv, History
} from "lucide-react";

import { fetchStructure } from "src/api/structureApi";
import { fetchProductsReference, fetchComponentsRef } from "src/api/product_componentApi";
import { fetchAlerts } from "src/api/warehouseApi";
import { SectionModel } from "src/store/StructureStore";
import { productModel } from "src/types/ProductModel";
import { componentModel } from "src/types/ComponentModel";
import { WAREHOUSE_ANALYTICS_ROUTE, WAREHOUSE_INVENTORY_ROUTE } from "src/utils/consts";

import { ProjectDashboard } from "./components/ProjectDashboard";
import { WarehouseIntake } from "./tabs/WarehouseIntake";
import { WarehouseMoves } from "./tabs/WarehouseMoves";
import { WarehouseDocs } from "./tabs/WarehouseDocs";
import { WarehouseBalance } from "./tabs/WarehouseBalance";
import { WarehouseSettings } from "./tabs/WarehouseSettings";
import { WarehouseLabels } from "./tabs/WarehouseLabels";
import { VideoTransmittersLabel } from "./tabs/VideoTransmittersLabel";
import { WarehousePrintHistory } from "./tabs/WarehousePrintHistory";

type Tab = "INTAKE" | "MOVES" | "BALANCE" | "DOCS" | "SETTINGS" | "LABELS" | "VIDEO_LABEL" | "HISTORY";

export const WarehousePage: React.FC = () => {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<Tab>("INTAKE");
  const [alertsCount, setAlertsCount] = useState(0);

  const [sections, setSections] = useState<SectionModel[]>([]);
  const [productsList, setProductsList] = useState<productModel[]>([]);
  const [componentsList, setComponentsList] = useState<componentModel[]>([]);

  useEffect(() => {
    fetchStructure().then(setSections);
    fetchProductsReference().then(res => setProductsList(Array.isArray(res) ? res : []));
    fetchComponentsRef().then(res => setComponentsList(res.data || []));

    fetchAlerts().then(alerts => setAlertsCount(alerts.length)).catch(console.error);
  }, []);

  return (
    <div className="min-h-screen bg-gray-50 p-6 pb-20 font-sans text-gray-700">


      <div className="max-w-7xl mx-auto mb-6">
        <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6 mb-6">
            <div className="flex items-center gap-4">
               <div className="p-3 bg-indigo-100 rounded-2xl relative">
                  <Package className="w-8 h-8 text-indigo-600" />

                  {alertsCount > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>}
               </div>
               <div>
                  <h1 className="text-3xl font-bold text-gray-800">–°–∫–ª–∞–¥—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞</h1>
                  <p className="text-indigo-600/80 font-medium">WMS Kryptonit v2.4</p>
               </div>
            </div>


            <div className="flex flex-col md:flex-row gap-4 items-center w-full xl:w-auto">
                <ProjectDashboard />

                <div className="flex gap-2">
                    <button
                        onClick={() => navigate(WAREHOUSE_ANALYTICS_ROUTE)}
                        className="flex flex-col items-center justify-center w-24 h-20 bg-white border border-indigo-100 rounded-xl shadow-sm hover:shadow-md hover:border-indigo-300 transition group"
                    >
                        <div className="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600 mb-1"><BarChart3 size={20}/></div>
                        <span className="text-[10px] font-bold text-gray-600 uppercase">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                    </button>

                    <button
                        onClick={() => navigate(WAREHOUSE_INVENTORY_ROUTE)}
                        className="flex flex-col items-center justify-center w-24 h-20 bg-white border border-orange-100 rounded-xl shadow-sm hover:shadow-md hover:border-orange-300 transition group"
                    >
                        <div className="p-2 bg-orange-50 rounded-full group-hover:bg-orange-100 text-orange-600 mb-1"><ClipboardCheck size={20}/></div>
                        <span className="text-[10px] font-bold text-gray-600 uppercase">–†–µ–≤–∏–∑–∏—è</span>
                    </button>
                </div>
            </div>
        </div>


        <div className="flex gap-2 border-b border-gray-200 pb-1 overflow-x-auto">
           {[
               { id: "INTAKE", label: "–ü—Ä–∏—ë–º–∫–∞", icon: <Truck size={18}/> },
               { id: "MOVES", label: "–û–ø–µ—Ä–∞—Ü–∏–∏", icon: <ArrowRightLeft size={18}/> },
               { id: "BALANCE", label: "–û—Å—Ç–∞—Ç–∫–∏", icon: <PieChart size={18}/> },
               { id: "DOCS", label: "–ù–∞–∫–ª–∞–¥–Ω—ã–µ", icon: <FileText size={18}/> },
               { id: "LABELS", label: "–≠—Ç–∏–∫–µ—Ç–∫–∏ / –†–µ–µ—Å—Ç—Ä", icon: <Tag size={18}/> },
               { id: "VIDEO_LABEL", label: "–ü–µ—á–∞—Ç—å –í–∏–¥–µ–æ", icon: <Tv size={18}/> },

               { id: "HISTORY", label: "–ò—Å—Ç–æ—Ä–∏—è –ø–µ—á–∞—Ç–∏", icon: <History size={18}/> },

               { id: "SETTINGS", label: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –õ–∏–º–∏—Ç—ã", icon:
                 <div className="relative flex items-center gap-1">
                    <Settings size={18}/>
                    {alertsCount > 0 && <span className="bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full ml-1">{alertsCount}</span>}
                 </div>
               },
           ].map(tab => (
               <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as Tab)}
                  className={`flex items-center gap-2 px-5 py-3 rounded-t-lg font-bold text-sm transition-all relative top-[1px] whitespace-nowrap ${
                      activeTab === tab.id
                      ? "bg-white text-indigo-700 border border-gray-200 border-b-white shadow-sm z-10"
                      : "text-gray-500 hover:text-indigo-600 hover:bg-gray-100/50"
                  }`}
               >
                   {tab.icon} {tab.label}
               </button>
           ))}
        </div>
      </div>


      <div className="max-w-7xl mx-auto">
        {activeTab === "INTAKE" && <WarehouseIntake sections={sections} productsList={productsList} componentsList={componentsList} />}
        {activeTab === "MOVES" && <WarehouseMoves sections={sections} />}
        {activeTab === "BALANCE" && <WarehouseBalance />}
        {activeTab === "DOCS" && <WarehouseDocs />}
        {activeTab === "LABELS" && <WarehouseLabels />}
        {activeTab === "VIDEO_LABEL" && <VideoTransmittersLabel />}
        {activeTab === "HISTORY" && <WarehousePrintHistory />}
        {activeTab === "SETTINGS" && <WarehouseSettings />}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/__tests__/utils.test.ts
================================================================================

import { describe, it, expect } from 'vitest';
import { calculateBatch } from '../utils';

describe('Warehouse Utils - Batch Calculator', () => {

    it('–¥–æ–ª–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—ã–µ –∫–æ—Ä–æ–±–∫–∏ (—Ä–æ–≤–Ω–æ–µ –¥–µ–ª–µ–Ω–∏–µ)', () => {

        const res = calculateBatch(1000, 100);

        expect(res.fullUnits).toBe(10);
        expect(res.remainder).toBe(0);
        expect(res.totalUnits).toBe(10);
    });

    it('–¥–æ–ª–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—á–∏—Ç–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ (–Ω–µ—Ä–æ–≤–Ω–æ–µ –¥–µ–ª–µ–Ω–∏–µ)', () => {

        const res = calculateBatch(1050, 100);

        expect(res.fullUnits).toBe(10);
        expect(res.remainder).toBe(50);
        expect(res.totalUnits).toBe(11);
    });

    it('–¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω—É–ª–∏ –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –æ–±—â–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ', () => {
        const res = calculateBatch(0, 100);

        expect(res.totalUnits).toBe(0);
        expect(res.fullUnits).toBe(0);
        expect(res.remainder).toBe(0);
    });

    it('–¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–Ω—å—à–µ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏', () => {

        const res = calculateBatch(50, 100);

        expect(res.fullUnits).toBe(0);
        expect(res.remainder).toBe(50);
        expect(res.totalUnits).toBe(1);
    });

    it('–¥–æ–ª–∂–µ–Ω –∑–∞—â–∏—â–∞—Ç—å –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å (capacity = 0)', () => {

        const res = calculateBatch(100, 0);

        expect(res.fullUnits).toBe(100);
        expect(res.totalUnits).toBe(100);
    });

    it('–¥–æ–ª–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ (—Å—á–∏—Ç–∞—Ç—å –∫–∞–∫ 0)', () => {
        const res = calculateBatch(-500, 100);

        expect(res.totalUnits).toBe(0);
    });
});

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/components/LabelConstructor.tsx
================================================================================

import React, { useEffect, useMemo, useRef, useState, useCallback } from "react";
import {
  Type,
  QrCode,
  Trash2,
  Save,
  X,
  AlignLeft,
  AlignCenter,
  AlignRight,
  Minus,
  Square,
  Columns,
  GripHorizontal,
  ZoomIn,
  ZoomOut,
  Database,
  MousePointer2,
  Image as ImageIcon,
  Hash,
  Info,
  Umbrella,
  Wine,
  Package,
  ArrowUp,
  Snowflake,
  Flame,
  AlertTriangle,
  Upload,
  Library,
  Eye,
  Layers,
  HelpCircle,
  BookOpen,
  ChevronRight,
  ChevronLeft,
} from "lucide-react";
import QRCode from "react-qr-code";
import clsx from "clsx";
import toast from "react-hot-toast";


export type LabelElementType = "TEXT" | "QR" | "RECTANGLE" | "LINE" | "IMAGE" | "COUNTER" | "ICON";

export interface LabelElement {
  id: string;
  type: LabelElementType;
  x: number;
  y: number;
  width: number;
  height: number;
  content?: string;
  fontSize?: number;
  fontFamily?: string;
  isBold?: boolean;
  align?: "left" | "center" | "right";
  strokeWidth?: number;
  imageUrl?: string;
  imageName?: string;
  qrDescription?: string;
  qrSource?: "code" | "name" | "custom" | "serial" | "contract" | "url";
  counterFormat?: string;
  iconType?: string;
}

interface Props {
  initialName?: string;
  initialWidth?: number;
  initialHeight?: number;
  initialLayout?: LabelElement[];
  onSave?: (name: string, w: number, h: number, layout: LabelElement[]) => void;
  onClose?: () => void;
}


const PX_PER_MM = 3.78;
const SNAP_MM = 1.0;
const MIN_MM = 2;


const TEXT_VARIABLES = [
  { label: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è...", value: "", description: "" },
  { label: "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ {{code}}", value: "{{code}}", description: "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥/–∞—Ä—Ç–∏–∫—É–ª" },
  { label: "–ù–∞–∑–≤–∞–Ω–∏–µ {{name}}", value: "{{name}}", description: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" },
  { label: "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä {{serial}}", value: "{{serial}}", description: "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑–¥–µ–ª–∏—è" },
  { label: "–¶–µ–Ω–∞ {{price}}", value: "{{price}}", description: "–°—Ç–æ–∏–º–æ—Å—Ç—å" },
  { label: "–î–∞—Ç–∞ {{date}}", value: "{{date}}", description: "–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞" },
  { label: "–ö–æ–Ω—Ç—Ä–∞–∫—Ç {{contract}}", value: "{{contract}}", description: "–ù–æ–º–µ—Ä –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞" },
  { label: "–ü–∞—Ä—Ç–∏—è {{batch}}", value: "{{batch}}", description: "–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏" },
  { label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ {{qty}}", value: "{{qty}}", description: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ" },
];


interface CustomFont {
  name: string;
  fontFamily: string;
  fontDataUrl: string;
}


const CUSTOM_FONTS_STORAGE_KEY = "mes_label_custom_fonts";


const QR_SOURCES = [
  {
    value: "code",
    label: "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞",
    template: "{{code}}",
    description: "–í QR –±—É–¥–µ—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞",
    example: "7342511000501"
  },
  {
    value: "serial",
    label: "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä",
    template: "{{serial}}",
    description: "–í QR –±—É–¥–µ—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑–¥–µ–ª–∏—è",
    example: "SN-2024-00813"
  },
  {
    value: "name",
    label: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
    template: "{{name}}",
    description: "–í QR –±—É–¥–µ—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
    example: "–í–∏–¥–µ–æ–ø–µ—Ä–µ–¥–∞—Ç—á–∏–∫ –í–ü-500"
  },
  {
    value: "contract",
    label: "‚Ññ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞",
    template: "{{contract}}",
    description: "–í QR –±—É–¥–µ—Ç –Ω–æ–º–µ—Ä –≥–æ—Å–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞",
    example: "187/249/9/–ü/25-63-–§–ï"
  },
  {
    value: "url",
    label: "–°—Å—ã–ª–∫–∞/URL",
    template: "{{url}}",
    description: "–í QR –±—É–¥–µ—Ç —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
    example: "https://mes.local/item/813"
  },
  {
    value: "custom",
    label: "–°–≤–æ–π —Ç–µ–∫—Å—Ç",
    template: "",
    description: "–í–≤–µ–¥–∏—Ç–µ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è",
    example: "–õ—é–±–æ–π —Ç–µ–∫—Å—Ç"
  },
];


const COUNTER_FORMATS = [
  { label: "1 / 100", value: "{{current}} / {{total}}", description: "–¢–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä / –í—Å–µ–≥–æ" },
  { label: "1 –∏–∑ 100", value: "{{current}} –∏–∑ {{total}}", description: "–¢–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä –∏–∑ –í—Å–µ–≥–æ" },
  { label: "#1", value: "#{{current}}", description: "–¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä" },
  { label: "‚Ññ 1 (100)", value: "‚Ññ {{current}} ({{total}})", description: "–° —Å–∏–º–≤–æ–ª–æ–º –Ω–æ–º–µ—Ä–∞" },
  { label: "–≠—Ç–∏–∫–µ—Ç–∫–∞ 1/100", value: "–≠—Ç–∏–∫–µ—Ç–∫–∞ {{current}}/{{total}}", description: "–° –ø–æ–¥–ø–∏—Å—å—é" },
];


const DEFAULT_ICON_LIBRARY = [
  {
    type: "fragile",
    label: "–•—Ä—É–ø–∫–æ–µ",
    icon: Wine,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <path d="M18 6 L18 17 Q18 24 25 24 Q32 24 32 17 L32 6" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
      <line x1="25" y1="24" x2="25" y2="38" stroke="#000" stroke-width="2"/>
      <line x1="18" y1="38" x2="32" y2="38" stroke="#000" stroke-width="2" stroke-linecap="round"/>
      <line x1="14" y1="44" x2="36" y2="44" stroke="#000" stroke-width="2" stroke-linecap="round"/>
    </svg>`
  },
  {
    type: "keep_dry",
    label: "–í–ª–∞–≥–∞",
    icon: Umbrella,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <line x1="25" y1="4" x2="25" y2="10" stroke="#000" stroke-width="2"/>
      <path d="M6 22 Q6 8 25 8 Q44 8 44 22 Z" fill="none" stroke="#000" stroke-width="2"/>
      <path d="M25 22 L25 38 Q25 42 21 42" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
      <circle cx="11" cy="30" r="2" fill="#000"/>
      <circle cx="25" cy="34" r="2" fill="#000"/>
      <circle cx="39" cy="30" r="2" fill="#000"/>
      <circle cx="17" cy="40" r="2" fill="#000"/>
      <circle cx="33" cy="40" r="2" fill="#000"/>
    </svg>`
  },
  {
    type: "keep_away_heat",
    label: "–ù–∞–≥—Ä–µ–≤",
    icon: Flame,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <circle cx="25" cy="13" r="5" fill="none" stroke="#000" stroke-width="2"/>
      <line x1="25" y1="3" x2="25" y2="6" stroke="#000" stroke-width="2"/>
      <line x1="25" y1="20" x2="25" y2="23" stroke="#000" stroke-width="2"/>
      <line x1="14" y1="13" x2="17" y2="13" stroke="#000" stroke-width="2"/>
      <line x1="33" y1="13" x2="36" y2="13" stroke="#000" stroke-width="2"/>
      <line x1="17" y1="5" x2="19" y2="8" stroke="#000" stroke-width="2"/>
      <line x1="33" y1="5" x2="31" y2="8" stroke="#000" stroke-width="2"/>
      <line x1="17" y1="21" x2="19" y2="18" stroke="#000" stroke-width="2"/>
      <line x1="33" y1="21" x2="31" y2="18" stroke="#000" stroke-width="2"/>
      <path d="M8 46 L8 34 L25 26 L42 34 L42 46" fill="none" stroke="#000" stroke-width="2" stroke-linejoin="round"/>
    </svg>`
  },
  {
    type: "this_side_up",
    label: "–í–µ—Ä—Ö",
    icon: ArrowUp,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <polygon points="25,4 36,16 29,16 29,22 21,22 21,16 14,16" fill="none" stroke="#000" stroke-width="2" stroke-linejoin="round"/>
      <polygon points="25,26 36,38 29,38 29,44 21,44 21,38 14,38" fill="none" stroke="#000" stroke-width="2" stroke-linejoin="round"/>
    </svg>`
  },
  {
    type: "keep_frozen",
    label: "–ó–∞–º–æ—Ä–æ–∑–∫–∞",
    icon: Snowflake,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <rect x="16" y="12" width="10" height="24" rx="5" fill="none" stroke="#000" stroke-width="2"/>
      <circle cx="21" cy="32" r="5" fill="none" stroke="#000" stroke-width="2"/>
      <circle cx="21" cy="32" r="3" fill="#000"/>
      <line x1="21" y1="29" x2="21" y2="18" stroke="#000" stroke-width="2"/>
      <line x1="36" y1="12" x2="36" y2="28" stroke="#000" stroke-width="1.5"/>
      <line x1="28" y1="20" x2="44" y2="20" stroke="#000" stroke-width="1.5"/>
      <line x1="30" y1="14" x2="42" y2="26" stroke="#000" stroke-width="1.5"/>
      <line x1="42" y1="14" x2="30" y2="26" stroke="#000" stroke-width="1.5"/>
      <line x1="8" y1="44" x2="44" y2="44" stroke="#000" stroke-width="2"/>
      <text x="12" y="42" font-size="8" font-family="Arial, sans-serif" fill="#000">-18¬∞C</text>
    </svg>`
  },
  {
    type: "warning",
    label: "–í–Ω–∏–º–∞–Ω–∏–µ",
    icon: AlertTriangle,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <polygon points="25,5 46,44 4,44" fill="none" stroke="#000" stroke-width="2.5" stroke-linejoin="round"/>
      <line x1="25" y1="17" x2="25" y2="30" stroke="#000" stroke-width="3" stroke-linecap="round"/>
      <circle cx="25" cy="37" r="2.5" fill="#000"/>
    </svg>`
  },
  {
    type: "do_not_stack",
    label: "–ù–µ —à—Ç–∞–±–µ–ª–∏—Ä–æ–≤–∞—Ç—å",
    icon: Package,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <rect x="10" y="28" width="30" height="16" fill="none" stroke="#000" stroke-width="2"/>
      <rect x="14" y="14" width="22" height="12" fill="none" stroke="#000" stroke-width="2"/>
      <line x1="6" y1="6" x2="44" y2="44" stroke="#000" stroke-width="2.5"/>
    </svg>`
  },
];


interface CustomIcon {
  type: string;
  label: string;
  imageUrl: string;
}


const CUSTOM_ICONS_STORAGE_KEY = "mes_label_custom_icons";

const snap = (v: number) => Math.round(v / SNAP_MM) * SNAP_MM;
const round2 = (v: number) => Math.round(v * 100) / 100;


export const LabelConstructor: React.FC<Props> = ({
  initialName = "–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω",
  initialWidth = 105,
  initialHeight = 60,
  initialLayout = [],
  onSave,
  onClose,
}) => {

  const [name, setName] = useState(initialName);
  const [size, setSize] = useState({ w: initialWidth, h: initialHeight });


  const normalizedLayout = useMemo(() => {
    return initialLayout.map(el => ({
      ...el,
      fontFamily: el.fontFamily || "Arial, sans-serif",
    }));
  }, [initialLayout]);

  const [elements, setElements] = useState<LabelElement[]>(normalizedLayout);


  useEffect(() => {
    setElements(normalizedLayout);
  }, [normalizedLayout]);
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [zoom, setZoom] = useState(1.5);
  const [showQrHelper, setShowQrHelper] = useState(false);
  const [showIconPicker, setShowIconPicker] = useState(false);
  const [showCounterPreview, setShowCounterPreview] = useState(false);
  const [showHelp, setShowHelp] = useState(false);


  const [fontSizeInput, setFontSizeInput] = useState<string>('');
  const [isEditingFontSize, setIsEditingFontSize] = useState(false);


  const [customIcons, setCustomIcons] = useState<CustomIcon[]>(() => {
    try {
      const saved = localStorage.getItem(CUSTOM_ICONS_STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch {
      return [];
    }
  });


  const [customFonts, setCustomFonts] = useState<CustomFont[]>(() => {
    try {
      const saved = localStorage.getItem(CUSTOM_FONTS_STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch {
      return [];
    }
  });


  useEffect(() => {
    localStorage.setItem(CUSTOM_ICONS_STORAGE_KEY, JSON.stringify(customIcons));
  }, [customIcons]);


  useEffect(() => {
    localStorage.setItem(CUSTOM_FONTS_STORAGE_KEY, JSON.stringify(customFonts));


    customFonts.forEach((font) => {
      const styleId = `custom-font-${font.name.replace(/\s+/g, '-')}`;
      if (!document.getElementById(styleId)) {
        const style = document.createElement('style');
        style.id = styleId;
        style.textContent = `
          @font-face {
            font-family: '${font.name}';
            src: url(${font.fontDataUrl});
          }
        `;
        document.head.appendChild(style);
      }
    });
  }, [customFonts]);


  const elementRefs = useRef<Map<string, HTMLDivElement>>(new Map());
  const fileInputRef = useRef<HTMLInputElement>(null);
  const iconUploadRef = useRef<HTMLInputElement>(null);
  const fontUploadRef = useRef<HTMLInputElement>(null);

  const stateRef = useRef({ elements, zoom, selectedId });
  useEffect(() => {
    stateRef.current = { elements, zoom, selectedId };
  }, [elements, zoom, selectedId]);


  const dragInfo = useRef<{
    active: boolean;
    mode: "MOVE" | "RESIZE" | null;
    elId: string | null;
    startX: number;
    startY: number;
    initialItem: LabelElement | null;
  }>({
    active: false,
    mode: null,
    elId: null,
    startX: 0,
    startY: 0,
    initialItem: null,
  });

  useEffect(() => {
    const handlePointerMove = (e: PointerEvent) => {
      if (!dragInfo.current.active || !dragInfo.current.elId || !dragInfo.current.initialItem) return;

      const { startX, startY, initialItem, mode, elId } = dragInfo.current;
      const currentZoom = stateRef.current.zoom;

      const deltaXScreen = e.clientX - startX;
      const deltaYScreen = e.clientY - startY;

      const deltaXMm = deltaXScreen / (PX_PER_MM * currentZoom);
      const deltaYMm = deltaYScreen / (PX_PER_MM * currentZoom);

      const useSnap = e.shiftKey;

      let newX = initialItem.x;
      let newY = initialItem.y;
      let newW = initialItem.width;
      let newH = initialItem.height;

      if (mode === "MOVE") {
        newX = initialItem.x + deltaXMm;
        newY = initialItem.y + deltaYMm;

        if (useSnap) {
          newX = snap(newX);
          newY = snap(newY);
        } else {
          newX = round2(newX);
          newY = round2(newY);
        }

        if (newX < 0) newX = 0;
        if (newY < 0) newY = 0;
      } else if (mode === "RESIZE") {
        newW = initialItem.width + deltaXMm;
        newH = initialItem.height + deltaYMm;

        if (useSnap) {
          newW = snap(newW);
          newH = snap(newH);
        } else {
          newW = round2(newW);
          newH = round2(newH);
        }

        if (newW < MIN_MM) newW = MIN_MM;
        if (newH < MIN_MM) newH = MIN_MM;
      }

      const node = elementRefs.current.get(elId);
      if (node) {
        node.style.left = `${newX * PX_PER_MM * currentZoom}px`;
        node.style.top = `${newY * PX_PER_MM * currentZoom}px`;
        node.style.width = `${newW * PX_PER_MM * currentZoom}px`;
        node.style.height = `${newH * PX_PER_MM * currentZoom}px`;

        const tooltip = node.querySelector(".resize-tooltip") as HTMLElement;
        if (tooltip) {
          tooltip.textContent = `${newW.toFixed(1)} √ó ${newH.toFixed(1)} –º–º`;
        }

        (node as any).dataset.lastMm = JSON.stringify({ x: newX, y: newY, w: newW, h: newH });
      }
    };

    const handlePointerUp = () => {
      if (!dragInfo.current.active) return;

      const { elId, mode, initialItem } = dragInfo.current;
      const node = elId ? elementRefs.current.get(elId) : null;

      if (node && elId) {
        const lastMm = (node as any).dataset.lastMm;
        const finalData = lastMm ? JSON.parse(lastMm) : { x: initialItem?.x, y: initialItem?.y, w: initialItem?.width, h: initialItem?.height };

        setElements((prev) =>
          prev.map((el) => {
            if (el.id === elId) {
              const updated = { ...el, x: finalData.x, y: finalData.y, width: finalData.w, height: finalData.h };

              if (mode === "RESIZE" && el.type === "TEXT" && initialItem?.height !== finalData.h) {
                updated.fontSize = Math.max(6, Math.round(finalData.h * 2.8));
              }
              return updated;
            }
            return el;
          })
        );

        delete (node as any).dataset.lastMm;
      }

      dragInfo.current = {
        active: false,
        mode: null,
        elId: null,
        startX: 0,
        startY: 0,
        initialItem: null,
      };
    };

    window.addEventListener("pointermove", handlePointerMove);
    window.addEventListener("pointerup", handlePointerUp);

    return () => {
      window.removeEventListener("pointermove", handlePointerMove);
      window.removeEventListener("pointerup", handlePointerUp);
    };
  }, []);

  const handleStartDrag = (e: React.PointerEvent, id: string, mode: "MOVE" | "RESIZE") => {
    if (e.button !== 0) return;
    e.preventDefault();
    e.stopPropagation();

    const el = elements.find((x) => x.id === id);
    if (!el) return;

    setSelectedId(id);

    dragInfo.current = {
      active: true,
      mode,
      elId: id,
      startX: e.clientX,
      startY: e.clientY,
      initialItem: { ...el },
    };
  };


  const addElement = (type: LabelElementType, extra: Partial<LabelElement> = {}) => {
    const id = Date.now().toString() + Math.random().toString().slice(2, 6);

    const defaultSizes: Record<LabelElementType, { w: number; h: number }> = {
      TEXT: { w: 30, h: 10 },
      QR: { w: 20, h: 20 },
      LINE: { w: 30, h: 2 },
      RECTANGLE: { w: 30, h: 20 },
      IMAGE: { w: 20, h: 20 },
      COUNTER: { w: 25, h: 8 },
      ICON: { w: 15, h: 15 },
    };

    const defaults = defaultSizes[type] || { w: 20, h: 20 };

    const newEl: LabelElement = {
      id,
      type,
      x: 5,
      y: 5,
      width: defaults.w,
      height: defaults.h,
      fontSize: 10,
      fontFamily: "Arial, sans-serif",
      strokeWidth: 0.3,
      align: "left",
      isBold: false,
      content: type === "TEXT" ? "–¢–µ–∫—Å—Ç" : type === "QR" ? "{{code}}" : type === "COUNTER" ? "{{current}} / {{total}}" : "",
      qrSource: type === "QR" ? "code" : undefined,
      qrDescription: type === "QR" ? "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞" : undefined,
      counterFormat: type === "COUNTER" ? "{{current}} / {{total}}" : undefined,
      ...extra,
    };

    setElements((prev) => {
      if (type === "RECTANGLE" || type === "LINE") return [newEl, ...prev];
      return [...prev, newEl];
    });

    setSelectedId(id);
  };

  const updateSelected = (updates: Partial<LabelElement>) => {
    if (!selectedId) return;
    setElements((prev) => prev.map((el) => (el.id === selectedId ? { ...el, ...updates } : el)));
  };

  const deleteSelected = () => {
    if (!selectedId) return;
    setElements((prev) => prev.filter((el) => el.id !== selectedId));
    setSelectedId(null);
  };


  const handleImageUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const dataUrl = event.target?.result as string;
      addElement("IMAGE", {
        imageUrl: dataUrl,
        imageName: file.name,
        width: 20,
        height: 20,
      });
      toast.success(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "${file.name}" –¥–æ–±–∞–≤–ª–µ–Ω–æ`);
    };
    reader.readAsDataURL(file);

    e.target.value = "";
  }, []);


  const handleIconUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
      return;
    }

    if (file.size > 100 * 1024) {
      toast.error("–ò–∫–æ–Ω–∫–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (–º–∞–∫—Å. 100KB)");
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const dataUrl = event.target?.result as string;
      const iconName = file.name.replace(/\.[^.]+$/, "");
      const iconType = `custom_${Date.now()}`;

      setCustomIcons(prev => [...prev, {
        type: iconType,
        label: iconName,
        imageUrl: dataUrl,
      }]);

      toast.success(`–ò–∫–æ–Ω–∫–∞ "${iconName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É`);
    };
    reader.readAsDataURL(file);

    e.target.value = "";
  }, []);


  const deleteCustomIcon = useCallback((iconType: string) => {
    setCustomIcons(prev => prev.filter(i => i.type !== iconType));
    toast.success("–ò–∫–æ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏");
  }, []);


  const handleFontUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const ext = file.name.split('.').pop()?.toLowerCase();
    if (!['ttf', 'otf', 'woff', 'woff2'].includes(ext || '')) {
      toast.error("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ TTF, OTF, WOFF, WOFF2");
      return;
    }

    if (file.size > 2 * 1024 * 1024) {
      toast.error("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ 2MB");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const fontDataUrl = reader.result as string;
      const fontName = file.name.replace(/\.(ttf|otf|woff|woff2)$/i, '');

      if (customFonts.find(f => f.name === fontName)) {
        toast.error("–®—Ä–∏—Ñ—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
        return;
      }

      setCustomFonts((prev) => [...prev, {
        name: fontName,
        fontFamily: `'${fontName}', sans-serif`,
        fontDataUrl,
      }]);
      toast.success(`–®—Ä–∏—Ñ—Ç "${fontName}" –∑–∞–≥—Ä—É–∂–µ–Ω`);
    };
    reader.readAsDataURL(file);
    e.target.value = "";
  }, [customFonts]);


  const deleteCustomFont = useCallback((fontName: string) => {
    setCustomFonts((prev) => prev.filter((f) => f.name !== fontName));
    const styleEl = document.getElementById(`custom-font-${fontName.replace(/\s+/g, '-')}`);
    if (styleEl) styleEl.remove();
    toast.success("–®—Ä–∏—Ñ—Ç —É–¥–∞–ª—ë–Ω");
  }, []);

  const activeElement = elements.find((el) => el.id === selectedId);

  const gridBgSize = PX_PER_MM * zoom * 5;


  const getQrDisplayInfo = (el: LabelElement) => {
    const source = QR_SOURCES.find(s => s.value === el.qrSource);
    return source || QR_SOURCES[0];
  };

  return (
    <div className="flex flex-col h-[90vh] bg-gradient-to-br from-slate-100 to-slate-200 font-sans text-slate-800 rounded-xl overflow-hidden shadow-2xl border border-slate-300 select-none">

      <input
        ref={fileInputRef}
        type="file"
        accept="image/*"
        className="hidden"
        onChange={handleImageUpload}
      />


      <input
        ref={iconUploadRef}
        type="file"
        accept="image/*"
        className="hidden"
        onChange={handleIconUpload}
      />


      <input
        ref={fontUploadRef}
        type="file"
        accept=".ttf,.otf,.woff,.woff2"
        className="hidden"
        onChange={handleFontUpload}
      />


      <div className="h-auto min-h-[64px] bg-white border-b flex flex-wrap items-center px-4 py-2 justify-between shrink-0 z-20 shadow-sm gap-2">

        <div className="flex gap-1 flex-wrap">
          <ToolBtn icon={<Type />} label="–¢–µ–∫—Å—Ç" onClick={() => addElement("TEXT")} />


          <div className="relative">
            <ToolBtn
              icon={<QrCode />}
              label="QR"
              onClick={() => {
                addElement("QR", { width: 20, height: 20 });
                setShowQrHelper(true);
              }}
            />
          </div>


          <ToolBtn
            icon={<Hash />}
            label="–°—á—ë—Ç—á–∏–∫"
            onClick={() => addElement("COUNTER", { width: 25, height: 8 })}
            title="–ù—É–º–µ—Ä–∞—Ü–∏—è —ç—Ç–∏–∫–µ—Ç–æ–∫: 1/100, 2/100..."
          />

          <div className="w-px h-8 bg-slate-200 mx-1 self-center"></div>


          <ToolBtn
            icon={<Upload />}
            label="–ö–∞—Ä—Ç–∏–Ω–∫–∞"
            onClick={() => fileInputRef.current?.click()}
            title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—ë –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
          />


          <div className="relative">
            <ToolBtn
              icon={<Library />}
              label="–ò–∫–æ–Ω–∫–∏"
              onClick={() => setShowIconPicker(!showIconPicker)}
              title="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è —ç—Ç–∏–∫–µ—Ç–æ–∫"
            />


            {showIconPicker && (
              <div className="absolute top-full left-0 mt-1 bg-white rounded-xl shadow-2xl border border-slate-200 p-3 z-50 w-72 max-h-96 overflow-y-auto">

                <div className="text-xs font-bold text-slate-500 mb-2 uppercase">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–ì–û–°–¢ 14192)</div>
                <div className="grid grid-cols-4 gap-2 mb-3">
                  {DEFAULT_ICON_LIBRARY.map((iconItem) => (
                    <button
                      key={iconItem.type}
                      onClick={() => {
                        addElement("ICON", {
                          iconType: iconItem.type,
                          content: iconItem.label,
                          width: 15,
                          height: 15
                        });
                        setShowIconPicker(false);
                      }}
                      className="flex flex-col items-center p-2 hover:bg-indigo-50 rounded-lg transition-colors group border border-transparent hover:border-indigo-200"
                      title={iconItem.label}
                    >
                      <div
                        className="w-8 h-8"
                        dangerouslySetInnerHTML={{ __html: iconItem.svg }}
                      />
                      <span className="text-[8px] mt-1 text-slate-500 group-hover:text-indigo-600 text-center leading-tight">
                        {iconItem.label}
                      </span>
                    </button>
                  ))}
                </div>


                {customIcons.length > 0 && (
                  <>
                    <div className="text-xs font-bold text-emerald-600 mb-2 uppercase border-t pt-2">–ú–æ–∏ –∏–∫–æ–Ω–∫–∏</div>
                    <div className="grid grid-cols-4 gap-2 mb-3">
                      {customIcons.map((iconItem) => (
                        <div key={iconItem.type} className="relative group">
                          <button
                            onClick={() => {
                              addElement("ICON", {
                                iconType: iconItem.type,
                                content: iconItem.label,
                                imageUrl: iconItem.imageUrl,
                                width: 15,
                                height: 15
                              });
                              setShowIconPicker(false);
                            }}
                            className="flex flex-col items-center p-2 hover:bg-emerald-50 rounded-lg transition-colors w-full"
                            title={iconItem.label}
                          >
                            <img src={iconItem.imageUrl} alt={iconItem.label} className="w-6 h-6 object-contain" />
                            <span className="text-[8px] mt-1 text-slate-500 text-center leading-tight truncate w-full">
                              {iconItem.label}
                            </span>
                          </button>

                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteCustomIcon(iconItem.type);
                            }}
                            className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[10px] opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-600"
                            title="–£–¥–∞–ª–∏—Ç—å –∏–∫–æ–Ω–∫—É"
                          >
                            √ó
                          </button>
                        </div>
                      ))}
                    </div>
                  </>
                )}


                <button
                  onClick={() => iconUploadRef.current?.click()}
                  className="w-full flex items-center justify-center gap-2 p-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 transition-colors text-sm"
                >
                  <Upload size={16} />
                  <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é –∏–∫–æ–Ω–∫—É</span>
                </button>
                <div className="text-[10px] text-slate-400 text-center mt-1">PNG/SVG, –º–∞–∫—Å. 100KB</div>
              </div>
            )}
          </div>

          <div className="w-px h-8 bg-slate-200 mx-1 self-center"></div>


          <ToolBtn
            icon={<Minus />}
            label="–õ–∏–Ω–∏—è"
            onClick={() => addElement("LINE", { width: 30, height: 0.5, strokeWidth: 0.3 })}
          />


          <ToolBtn
            icon={<Square />}
            label="–†–∞–º–∫–∞"
            onClick={() => addElement("RECTANGLE", { strokeWidth: 0.3 })}
          />

          <div className="w-px h-8 bg-slate-200 mx-1 self-center"></div>


          <div className="flex items-center gap-1 bg-slate-50 rounded-lg px-2 py-1 border">
            <button onClick={() => setZoom((z) => Math.max(0.5, z - 0.25))} className="p-1 hover:bg-slate-200 rounded" type="button">
              <ZoomOut size={16} />
            </button>
            <span className="text-xs font-medium w-10 text-center tabular-nums">{Math.round(zoom * 100)}%</span>
            <button onClick={() => setZoom((z) => Math.min(3, z + 0.25))} className="p-1 hover:bg-slate-200 rounded" type="button">
              <ZoomIn size={16} />
            </button>
          </div>
        </div>


        <div className="flex items-center gap-2">
          <button
            onClick={() => setShowHelp(!showHelp)}
            className={clsx(
              "flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              showHelp ? "bg-amber-100 text-amber-700 border border-amber-300" : "bg-slate-100 text-slate-600 hover:bg-slate-200"
            )}
            type="button"
          >
            <HelpCircle size={18} />
            <span className="hidden sm:inline">–°–ø—Ä–∞–≤–∫–∞</span>
          </button>

          {onClose && (
            <button
              onClick={onClose}
              className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
              title="–ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä"
              type="button"
            >
              <X size={20} />
            </button>
          )}
        </div>
      </div>


      {activeElement && (
        <div className="bg-gradient-to-r from-indigo-50 to-violet-50 border-b px-4 py-3 shrink-0 z-10">
          <div className="flex items-center gap-3 flex-wrap">

            <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border border-indigo-200 shadow-sm">
              {activeElement.type === "TEXT" && <Type size={16} className="text-indigo-600" />}
              {activeElement.type === "QR" && <QrCode size={16} className="text-indigo-600" />}
              {activeElement.type === "IMAGE" && <ImageIcon size={16} className="text-indigo-600" />}
              {activeElement.type === "COUNTER" && <Hash size={16} className="text-indigo-600" />}
              {activeElement.type === "ICON" && <Library size={16} className="text-indigo-600" />}
              {(activeElement.type === "LINE" || activeElement.type === "RECTANGLE") && <Layers size={16} className="text-indigo-600" />}
              <span className="text-xs font-bold text-indigo-800 uppercase">
                {activeElement.type === "TEXT" && "–¢–µ–∫—Å—Ç"}
                {activeElement.type === "QR" && "QR-–∫–æ–¥"}
                {activeElement.type === "IMAGE" && "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"}
                {activeElement.type === "COUNTER" && "–°—á—ë—Ç—á–∏–∫"}
                {activeElement.type === "ICON" && "–ò–∫–æ–Ω–∫–∞"}
                {activeElement.type === "LINE" && "–õ–∏–Ω–∏—è"}
                {activeElement.type === "RECTANGLE" && "–†–∞–º–∫–∞"}
              </span>
            </div>


            {activeElement.type === "TEXT" && (
              <>

                <div className="relative shrink-0" style={{ width: '220px' }}>
                  <textarea
                    value={activeElement.content || ""}
                    onChange={(e) => updateSelected({ content: e.target.value })}
                    className="w-full text-sm px-3 py-2 border border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none bg-white shadow-sm resize-none"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."
                    rows={1}
                    style={{
                      minHeight: '38px',
                      height: 'auto',
                      maxHeight: '80px',
                      overflow: 'auto'
                    }}
                    onInput={(e) => {
                      const target = e.target as HTMLTextAreaElement;
                      target.style.height = '38px';
                      target.style.height = Math.min(target.scrollHeight, 80) + 'px';
                    }}
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                  />
                </div>


                <div className="relative shrink-0">
                  <select
                    className="text-sm pl-3 pr-7 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none appearance-none"
                    style={{ width: '130px' }}
                    value=""
                    onChange={(e) => {
                      if (e.target.value) updateSelected({ content: (activeElement.content || "") + e.target.value });
                    }}
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                  >
                    <option value="">+ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è</option>
                    {TEXT_VARIABLES.filter(v => v.value).map((v) => (
                      <option key={v.value} value={v.value}>{v.label}</option>
                    ))}
                  </select>
                  <Database size={14} className="absolute right-2 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none" />
                </div>


                <div className="flex items-center gap-1 shrink-0">
                  <select
                    value={activeElement.fontFamily ?? "Arial, sans-serif"}
                    onChange={(e) => {
                      const newFont = e.target.value;
                      updateSelected({ fontFamily: newFont });
                    }}
                    className="text-sm px-2 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none shadow-sm"
                    style={{ width: '130px' }}
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                  >
                    <optgroup label="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ">
                      <option value="Arial, sans-serif">Arial</option>
                      <option value="'Times New Roman', serif">Times New Roman</option>
                      <option value="'Courier New', monospace">Courier New</option>
                      <option value="Verdana, sans-serif">Verdana</option>
                      <option value="Tahoma, sans-serif">Tahoma</option>
                    </optgroup>
                    <optgroup label="–ì–û–°–¢">
                      <option value="'GOST type A', sans-serif">GOST type A</option>
                      <option value="'GOST type B', sans-serif">GOST type B</option>
                    </optgroup>
                    {customFonts.length > 0 && (
                      <optgroup label="–ú–æ–∏ —à—Ä–∏—Ñ—Ç—ã">
                        {customFonts.map((f) => (
                          <option key={f.name} value={f.fontFamily}>{f.name}</option>
                        ))}
                      </optgroup>
                    )}
                  </select>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      fontUploadRef.current?.click();
                    }}
                    className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                    title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —à—Ä–∏—Ñ—Ç (TTF, OTF, WOFF)"
                    type="button"
                  >
                    <Upload size={16} />
                  </button>
                </div>


                <div className="flex items-center bg-white border border-indigo-200 rounded-lg overflow-hidden shadow-sm">
                  <button
                    onClick={() => updateSelected({ fontSize: Math.max(6, (activeElement.fontSize || 10) - 1) })}
                    className="px-3 py-2 hover:bg-slate-50 text-sm font-bold text-indigo-600"
                    type="button"
                  >
                    ‚àí
                  </button>
                  <input
                    type="text"
                    inputMode="numeric"
                    value={isEditingFontSize ? fontSizeInput : (activeElement.fontSize || 10)}
                    onFocus={(e) => {
                      setIsEditingFontSize(true);
                      setFontSizeInput(String(activeElement.fontSize || 10));
                      e.target.select();
                    }}
                    onChange={(e) => {

                      const value = e.target.value.replace(/[^0-9]/g, '');
                      setFontSizeInput(value);
                    }}
                    onBlur={() => {
                      setIsEditingFontSize(false);
                      const val = parseInt(fontSizeInput);
                      if (!isNaN(val) && val >= 6 && val <= 200) {
                        updateSelected({ fontSize: val });
                      }

                    }}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        e.currentTarget.blur();
                      }
                      if (e.key === 'Escape') {
                        setIsEditingFontSize(false);
                        setFontSizeInput('');
                      }
                    }}
                    className="w-14 text-sm font-bold text-center tabular-nums border-x border-indigo-100 py-2 outline-none focus:bg-indigo-50 focus:ring-2 focus:ring-indigo-300"
                    onPointerDown={(e) => e.stopPropagation()}
                  />
                  <button
                    onClick={() => updateSelected({ fontSize: Math.min(200, (activeElement.fontSize || 10) + 1) })}
                    className="px-3 py-2 hover:bg-slate-50 text-sm font-bold text-indigo-600"
                    type="button"
                  >
                    +
                  </button>
                </div>


                <button
                  onClick={() => updateSelected({ isBold: !activeElement.isBold })}
                  className={clsx(
                    "w-9 h-9 border rounded-lg flex items-center justify-center font-bold transition-all shadow-sm",
                    activeElement.isBold ? "bg-indigo-600 text-white border-indigo-600" : "bg-white border-indigo-200 hover:bg-slate-50"
                  )}
                  type="button"
                >
                  B
                </button>


                <div className="flex bg-white border border-indigo-200 rounded-lg overflow-hidden shadow-sm">
                  {["left", "center", "right"].map((align) => (
                    <button
                      key={align}
                      onClick={() => updateSelected({ align: align as "left" | "center" | "right" })}
                      className={clsx("p-2 hover:bg-slate-50", activeElement.align === align && "bg-indigo-100 text-indigo-700")}
                      type="button"
                    >
                      {align === "left" && <AlignLeft size={16} />}
                      {align === "center" && <AlignCenter size={16} />}
                      {align === "right" && <AlignRight size={16} />}
                    </button>
                  ))}
                </div>
              </>
            )}


            {activeElement.type === "QR" && (
              <div className="flex items-center gap-3 flex-wrap">
                <div className="flex flex-col gap-1">
                  <label className="text-[10px] font-bold text-indigo-600 uppercase">–ß—Ç–æ –±—É–¥–µ—Ç –≤ QR:</label>
                  <select
                    value={activeElement.qrSource || "code"}
                    onChange={(e) => {
                      const source = QR_SOURCES.find(s => s.value === e.target.value);
                      if (source) {
                        updateSelected({
                          qrSource: e.target.value as any,
                          content: source.template,
                          qrDescription: source.label
                        });
                      }
                    }}
                    className="text-sm px-3 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none shadow-sm min-w-[180px]"
                    onPointerDown={(e) => e.stopPropagation()}
                  >
                    {QR_SOURCES.map((s) => (
                      <option key={s.value} value={s.value}>{s.label}</option>
                    ))}
                  </select>
                </div>

                {activeElement.qrSource === "custom" && (
                  <input
                    value={activeElement.content || ""}
                    onChange={(e) => updateSelected({ content: e.target.value })}
                    className="w-48 text-sm px-3 py-2 border border-indigo-200 rounded-lg focus:border-indigo-500 outline-none bg-white shadow-sm"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è QR..."
                    onPointerDown={(e) => e.stopPropagation()}
                  />
                )}


                <div className="flex items-start gap-2 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 max-w-sm">
                  <Info size={16} className="text-blue-500 shrink-0 mt-0.5" />
                  <div className="text-xs text-blue-700">
                    <div className="font-semibold">{getQrDisplayInfo(activeElement).description}</div>
                    <div className="text-blue-500 mt-0.5">–ü—Ä–∏–º–µ—Ä: {getQrDisplayInfo(activeElement).example}</div>
                  </div>
                </div>
              </div>
            )}


            {activeElement.type === "COUNTER" && (
              <div className="flex items-center gap-3 flex-wrap">
                <div className="flex flex-col gap-1">
                  <label className="text-[10px] font-bold text-indigo-600 uppercase">–§–æ—Ä–º–∞—Ç –Ω—É–º–µ—Ä–∞—Ü–∏–∏:</label>
                  <select
                    value={activeElement.counterFormat || COUNTER_FORMATS[0].value}
                    onChange={(e) => updateSelected({ counterFormat: e.target.value, content: e.target.value })}
                    className="text-sm px-3 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none shadow-sm min-w-[200px]"
                    onPointerDown={(e) => e.stopPropagation()}
                  >
                    {COUNTER_FORMATS.map((f) => (
                      <option key={f.value} value={f.value}>{f.label} ‚Äî {f.description}</option>
                    ))}
                  </select>
                </div>

                <div className="flex items-center bg-white border border-indigo-200 rounded-lg overflow-hidden shadow-sm">
                  <button onClick={() => updateSelected({ fontSize: Math.max(6, (activeElement.fontSize || 14) - 1) })} className="px-3 py-2 hover:bg-slate-50 text-sm font-bold" type="button">‚àí</button>
                  <span className="text-sm font-bold w-8 text-center tabular-nums border-x border-indigo-100">{activeElement.fontSize || 14}</span>
                  <button onClick={() => updateSelected({ fontSize: (activeElement.fontSize || 14) + 1 })} className="px-3 py-2 hover:bg-slate-50 text-sm font-bold" type="button">+</button>
                </div>

                <button
                  onClick={() => updateSelected({ isBold: !activeElement.isBold })}
                  className={clsx(
                    "w-9 h-9 border rounded-lg flex items-center justify-center font-bold transition-all shadow-sm",
                    activeElement.isBold ? "bg-indigo-600 text-white border-indigo-600" : "bg-white border-indigo-200 hover:bg-slate-50"
                  )}
                  type="button"
                >B</button>


                <div className="flex items-center gap-2 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2">
                  <Eye size={14} className="text-emerald-600" />
                  <span className="text-sm font-mono font-bold text-emerald-800">
                    {(activeElement.counterFormat || "{{current}} / {{total}}")
                      .replace("{{current}}", "1")
                      .replace("{{total}}", "100")}
                  </span>
                </div>
              </div>
            )}


            {activeElement.type === "IMAGE" && activeElement.imageName && (
              <div className="flex items-center gap-2 bg-slate-100 px-3 py-2 rounded-lg">
                <ImageIcon size={16} className="text-slate-500" />
                <span className="text-sm text-slate-600 truncate max-w-[200px]">{activeElement.imageName}</span>
              </div>
            )}


            {activeElement.type === "ICON" && (
              <div className="flex items-center gap-2 bg-slate-100 px-3 py-2 rounded-lg">
                <span className="text-sm font-medium text-slate-600">{activeElement.content || "–ò–∫–æ–Ω–∫–∞"}</span>
              </div>
            )}


            {(activeElement.type === "LINE" || activeElement.type === "RECTANGLE") && (
              <div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-indigo-200 shadow-sm">
                <span className="text-xs text-indigo-900 font-medium">–¢–æ–ª—â–∏–Ω–∞:</span>
                <input
                  type="number"
                  step={0.1}
                  min={0.1}
                  value={activeElement.strokeWidth}
                  onChange={(e) => updateSelected({ strokeWidth: parseFloat(e.target.value) })}
                  className="w-14 text-sm border-b border-indigo-300 px-1 py-0.5 text-center focus:outline-none focus:border-indigo-600 bg-transparent"
                  onPointerDown={(e) => e.stopPropagation()}
                />
                <span className="text-xs text-slate-400">–º–º</span>
              </div>
            )}

            <div className="flex-1"></div>


            <button
              onClick={deleteSelected}
              className="flex items-center gap-2 text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors border border-transparent hover:border-red-200"
              title="–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç"
              type="button"
            >
              <Trash2 size={18} />
              <span className="text-sm font-medium">–£–¥–∞–ª–∏—Ç—å</span>
            </button>
          </div>
        </div>
      )}


      {!activeElement && (
        <div className="bg-slate-50 border-b px-4 py-3 shrink-0">
          <div className="flex items-center gap-2 text-slate-400 text-sm">
            <MousePointer2 size={16} />
            <span>–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —ç—Ç–∏–∫–µ—Ç–∫–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —Å –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</span>
          </div>
        </div>
      )}


      <div className="flex-1 flex overflow-hidden">

        <div
          className="flex-1 overflow-auto bg-slate-300/50 flex items-center justify-center relative touch-none p-8"
          style={{
            backgroundImage: "radial-gradient(circle, #94a3b8 1px, transparent 1px)",
            backgroundSize: "20px 20px",
          }}
          onPointerDown={() => {
            setSelectedId(null);
            setShowIconPicker(false);
          }}
        >
        <div
          className="bg-white shadow-2xl relative transition-transform duration-75 rounded-sm"
          style={{
            width: size.w * PX_PER_MM * zoom,
            height: size.h * PX_PER_MM * zoom,
            backgroundImage: "linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px)",
            backgroundSize: `${gridBgSize}px ${gridBgSize}px`,
          }}
          onPointerDown={(e) => e.stopPropagation()}
        >
          {elements.map((el, idx) => {
            const isSelected = selectedId === el.id;

            const style: React.CSSProperties = {
              left: `${el.x * PX_PER_MM * zoom}px`,
              top: `${el.y * PX_PER_MM * zoom}px`,
              width: `${el.width * PX_PER_MM * zoom}px`,
              height: `${el.height * PX_PER_MM * zoom}px`,
              zIndex: isSelected ? 9999 : idx + 1,
            };

            const strokePx = (el.strokeWidth || 0.1) * PX_PER_MM * zoom;

            return (
              <div
                key={el.id}
                ref={(node) => {
                  if (node) elementRefs.current.set(el.id, node);
                  else elementRefs.current.delete(el.id);
                }}
                className={clsx(
                  "absolute box-border transition-shadow",
                  isSelected
                    ? "outline outline-2 outline-indigo-500 shadow-lg shadow-indigo-200/50"
                    : "hover:outline hover:outline-1 hover:outline-indigo-300"
                )}
                style={style}
                onPointerDown={(e) => handleStartDrag(e, el.id, "MOVE")}
              >

                {el.type === "TEXT" && (
                  <div
                    className="w-full h-full whitespace-pre-wrap break-words leading-none pointer-events-none overflow-hidden"
                    style={{
                      fontSize: `${(el.fontSize || 10) * PX_PER_MM * zoom * 0.35}px`,
                      fontWeight: el.isBold ? "bold" : "normal",
                      fontFamily: el.fontFamily || "Arial, sans-serif",
                      textAlign: el.align,
                      color: "#1e293b",
                    }}
                  >
                    {el.content}
                  </div>
                )}


                {el.type === "QR" && (
                  <div className="w-full h-full p-[2px] pointer-events-none flex items-center justify-center bg-white rounded-sm">
                    <QRCode value={el.content || "QR"} style={{ width: "100%", height: "100%" }} viewBox="0 0 256 256" />
                  </div>
                )}


                {el.type === "IMAGE" && (
                  <div className="w-full h-full pointer-events-none flex items-center justify-center bg-slate-50 rounded-sm overflow-hidden">
                    {el.imageUrl ? (
                      <img src={el.imageUrl} alt={el.imageName || "Image"} className="w-full h-full object-contain" />
                    ) : (
                      <ImageIcon size={24} className="text-slate-300" />
                    )}
                  </div>
                )}


                {el.type === "COUNTER" && (
                  <div
                    className="w-full h-full whitespace-nowrap pointer-events-none flex items-center justify-center overflow-hidden"
                    style={{
                      fontSize: `${(el.fontSize || 14) * PX_PER_MM * zoom * 0.35}px`,
                      fontWeight: el.isBold ? "bold" : "normal",
                      color: "#1e293b",
                      fontFamily: "monospace",
                    }}
                  >
                    {(el.counterFormat || "{{current}} / {{total}}")
                      .replace("{{current}}", "1")
                      .replace("{{total}}", "100")}
                  </div>
                )}


                {el.type === "ICON" && (
                  <div className="w-full h-full pointer-events-none flex items-center justify-center p-0.5">
                    {(() => {
                      const iconData = DEFAULT_ICON_LIBRARY.find(i => i.type === el.iconType);
                      if (iconData && iconData.svg) {
                        return (
                          <div
                            className="w-full h-full"
                            dangerouslySetInnerHTML={{ __html: iconData.svg }}
                          />
                        );
                      }

                      if (el.imageUrl) {
                        return <img src={el.imageUrl} alt={el.content || 'Icon'} className="w-full h-full object-contain" />;
                      }

                      const customIcon = customIcons.find(i => i.type === el.iconType);
                      if (customIcon) {
                        return <img src={customIcon.imageUrl} alt={customIcon.label} className="w-full h-full object-contain" />;
                      }

                      return <AlertTriangle size={20} className="text-slate-400" />;
                    })()}
                  </div>
                )}


                {(el.type === "LINE" || el.type === "RECTANGLE") && (
                  <svg className="w-full h-full pointer-events-none overflow-visible" xmlns="http://www.w3.org/2000/svg">
                    {el.type === "RECTANGLE" ? (
                      <rect x="0" y="0" width="100%" height="100%" fill="none" stroke="black" strokeWidth={strokePx} vectorEffect="non-scaling-stroke" />
                    ) : el.width >= el.height ? (
                      <line x1="0" y1="50%" x2="100%" y2="50%" stroke="black" strokeWidth={strokePx} vectorEffect="non-scaling-stroke" />
                    ) : (
                      <line x1="50%" y1="0" x2="50%" y2="100%" stroke="black" strokeWidth={strokePx} vectorEffect="non-scaling-stroke" />
                    )}
                  </svg>
                )}


                {isSelected && (
                  <>
                    <div
                      className="absolute -bottom-2 -right-2 w-5 h-5 bg-indigo-600 rounded-full cursor-nwse-resize flex items-center justify-center shadow-lg hover:scale-110 transition-transform z-50"
                      onPointerDown={(e) => handleStartDrag(e, el.id, "RESIZE")}
                    >
                      <GripHorizontal size={12} className="text-white -rotate-45" />
                    </div>

                    <div className="resize-tooltip absolute -top-7 left-0 bg-indigo-600 text-white text-[10px] px-2 py-1 rounded-md opacity-90 pointer-events-none whitespace-nowrap shadow-md font-mono">
                      {el.width.toFixed(1)} √ó {el.height.toFixed(1)} –º–º
                    </div>


                    <div className="absolute -top-7 right-0 bg-slate-700 text-white text-[9px] px-1.5 py-0.5 rounded opacity-80 pointer-events-none uppercase font-bold">
                      {el.type === "QR" && el.qrSource && `QR: ${QR_SOURCES.find(s => s.value === el.qrSource)?.label || el.qrSource}`}
                      {el.type === "COUNTER" && "–°—á—ë—Ç—á–∏–∫"}
                      {el.type === "IMAGE" && "–ö–∞—Ä—Ç–∏–Ω–∫–∞"}
                      {el.type === "ICON" && el.content}
                    </div>
                  </>
                )}
              </div>
            );
          })}
        </div>
      </div>


      {showHelp && (
        <div className="w-80 bg-white border-l border-slate-200 overflow-y-auto shrink-0 shadow-lg">
          <div className="sticky top-0 bg-gradient-to-r from-amber-50 to-orange-50 border-b px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <BookOpen size={20} className="text-amber-600" />
              <span className="font-bold text-amber-900">–°–ø—Ä–∞–≤–∫–∞</span>
            </div>
            <button
              onClick={() => setShowHelp(false)}
              className="p-1 hover:bg-amber-100 rounded text-amber-600"
              type="button"
            >
              <X size={18} />
            </button>
          </div>

          <div className="p-4 space-y-5 text-sm">

            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Database size={18} className="text-indigo-500" />
                –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
              </h3>
              <div className="space-y-2">
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{code}}"}</code>
                  <p className="text-slate-600 mt-1">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: 7342511000501</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{name}}"}</code>
                  <p className="text-slate-600 mt-1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: –ü—Ä–∏—ë–º–Ω–∏–∫ 2xLR1121</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{contract}}"}</code>
                  <p className="text-slate-600 mt-1">–ù–æ–º–µ—Ä –≥–æ—Å–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: ‚Ññ 249/2/–û–ü/25/1/37</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{date}}"}</code>
                  <p className="text-slate-600 mt-1">–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: 20.01.2026, 15:30</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{quantity}}"}</code>
                  <p className="text-slate-600 mt-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: 500</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{unit}}"}</code>
                  <p className="text-slate-600 mt-1">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</p>
                  <p className="text-slate-400 text-xs mt-1">–ü—Ä–∏–º–µ—Ä: —à—Ç.</p>
                </div>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Hash size={18} className="text-emerald-500" />
                –°—á—ë—Ç—á–∏–∫ (–Ω—É–º–µ—Ä–∞—Ü–∏—è —ç—Ç–∏–∫–µ—Ç–æ–∫)
              </h3>
              <div className="bg-emerald-50 p-3 rounded-lg border border-emerald-100 space-y-2">
                <p className="text-slate-600">–ü—Ä–∏ –ø–µ—á–∞—Ç–∏ 100 —ç—Ç–∏–∫–µ—Ç–æ–∫:</p>
                <div className="grid grid-cols-2 gap-2 text-xs">
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">1 / 100</span>
                    <span className="text-slate-400 ml-2">‚Üê –ø–µ—Ä–≤–∞—è</span>
                  </div>
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">2 / 100</span>
                    <span className="text-slate-400 ml-2">‚Üê –≤—Ç–æ—Ä–∞—è</span>
                  </div>
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">...</span>
                  </div>
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">100 / 100</span>
                    <span className="text-slate-400 ml-2">‚Üê –ø–æ—Å–ª–µ–¥–Ω—è—è</span>
                  </div>
                </div>
                <div className="mt-2 text-xs text-slate-500">
                  <code className="text-emerald-600">{"{{current}}"}</code> ‚Äî –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —ç—Ç–∏–∫–µ—Ç–∫–∏<br/>
                  <code className="text-emerald-600">{"{{total}}"}</code> ‚Äî –≤—Å–µ–≥–æ —ç—Ç–∏–∫–µ—Ç–æ–∫ –≤ —Ç–∏—Ä–∞–∂–µ
                </div>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <QrCode size={18} className="text-violet-500" />
                QR-–∫–æ–¥
              </h3>
              <div className="bg-violet-50 p-3 rounded-lg border border-violet-100">
                <p className="text-slate-600">–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ QR –≤—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –≤ –Ω—ë–º –±—É–¥–µ—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ:</p>
                <ul className="mt-2 text-xs text-slate-600 space-y-1">
                  <li>‚Ä¢ <strong>–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞</strong> ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</li>
                  <li>‚Ä¢ <strong>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</strong> ‚Äî –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è</li>
                  <li>‚Ä¢ <strong>–ì–æ—Å–∫–æ–Ω—Ç—Ä–∞–∫—Ç</strong> ‚Äî –Ω–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</li>
                  <li>‚Ä¢ <strong>–°—Å—ã–ª–∫–∞</strong> ‚Äî URL –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                  <li>‚Ä¢ <strong>–°–≤–æ–π —Ç–µ–∫—Å—Ç</strong> ‚Äî –ª—é–±–æ–π —Ç–µ–∫—Å—Ç</li>
                </ul>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Library size={18} className="text-orange-500" />
                –ò–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏
              </h3>
              <div className="bg-orange-50 p-3 rounded-lg border border-orange-100">
                <p className="text-slate-600 mb-2">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –ø–æ –ì–û–°–¢:</p>
                <div className="grid grid-cols-2 gap-2 text-xs">
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Wine size={16} className="text-slate-600" />
                    <span>–•—Ä—É–ø–∫–æ–µ</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Umbrella size={16} className="text-slate-600" />
                    <span>–í–ª–∞–≥–∞</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Flame size={16} className="text-slate-600" />
                    <span>–ù–∞–≥—Ä–µ–≤</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <ArrowUp size={16} className="text-slate-600" />
                    <span>–í–µ—Ä—Ö</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Snowflake size={16} className="text-slate-600" />
                    <span>–ó–∞–º–æ—Ä–æ–∑–∫–∞</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <AlertTriangle size={16} className="text-slate-600" />
                    <span>–í–Ω–∏–º–∞–Ω–∏–µ</span>
                  </div>
                </div>
                <p className="text-slate-500 text-xs mt-2">+ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–∏ –∏–∫–æ–Ω–∫–∏</p>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Info size={18} className="text-cyan-500" />
                –°–æ–≤–µ—Ç—ã
              </h3>
              <div className="bg-cyan-50 p-3 rounded-lg border border-cyan-100 text-xs text-slate-600 space-y-2">
                <p>‚Ä¢ <strong>Shift + —Ç—è–Ω—É—Ç—å</strong> ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ 5–º–º</p>
                <p>‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞</p>
                <p>‚Ä¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –¥–≤–æ–π–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö <code className="text-cyan-700">{"{{}}"}</code> –∑–∞–º–µ–Ω—è—Ç—Å—è –ø—Ä–∏ –ø–µ—á–∞—Ç–∏</p>
                <p>‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —à–∞–±–ª–æ–Ω, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ</p>
              </div>
            </div>
          </div>
        </div>
      )}
      </div>


      <div className="bg-white border-t px-4 py-3 flex items-center justify-between shrink-0 z-20 gap-4 flex-wrap">
        <div className="flex gap-4 text-sm items-center">
          <label className="flex items-center gap-2 text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border">
            <span className="font-bold text-indigo-600">–®:</span>
            <input
              type="number"
              value={size.w}
              onChange={(e) => setSize({ ...size, w: +e.target.value })}
              className="bg-transparent w-12 text-center outline-none font-medium"
            />
            <span className="text-slate-400">–º–º</span>
          </label>
          <label className="flex items-center gap-2 text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border">
            <span className="font-bold text-indigo-600">–í:</span>
            <input
              type="number"
              value={size.h}
              onChange={(e) => setSize({ ...size, h: +e.target.value })}
              className="bg-transparent w-12 text-center outline-none font-medium"
            />
            <span className="text-slate-400">–º–º</span>
          </label>
          <span className="text-slate-400 hidden sm:inline">Shift = –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ</span>
        </div>

        <div className="flex gap-3 items-center">
          <input
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="border rounded-lg px-4 py-2 text-sm w-56 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all"
            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞..."
          />
          <button
            onClick={() => {
              if (!onSave) {
                toast.error("onSave –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
                return;
              }
              onSave(name, size.w, size.h, elements);
              toast.success("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
            }}
            className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-indigo-200 transition-all active:scale-95"
            type="button"
          >
            <Save size={18} /> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  );
};


const ToolBtn = ({ icon, label, onClick, title }: { icon: React.ReactElement; label: string; onClick: () => void; title?: string }) => (
  <button
    onClick={onClick}
    type="button"
    title={title}
    className="flex flex-col items-center justify-center w-14 h-14 hover:bg-indigo-50 text-slate-500 hover:text-indigo-600 rounded-xl transition-all group border border-transparent hover:border-indigo-200"
  >
    <div className="group-hover:-translate-y-0.5 transition-transform">
      {React.cloneElement(icon, { size: 22 })}
    </div>
    <span className="text-[10px] mt-1 font-medium">{label}</span>
  </button>
);

export default LabelConstructor;

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/components/LabelPreview.tsx
================================================================================

import React from "react";
import QRCode from "react-qr-code";

interface LabelPreviewProps {
  label: string;
  project: string;
  batch: string;
  id: string;
  qrValue: string;
  qty: number;
  unit: string;
  isPartial?: boolean;
}

export const LabelPreview: React.FC<LabelPreviewProps> = ({ label, project, batch, id, qrValue, qty, unit, isPartial }) => (
  <div className={`border-2 ${isPartial ? 'border-amber-500 bg-amber-50/30' : 'border-gray-800 bg-white'} rounded-lg p-3 w-full max-w-[280px] shadow-xl relative overflow-hidden group transition-all hover:scale-[1.02]`}>
      {isPartial && <div className="absolute top-0 right-0 bg-amber-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl shadow-sm">–û–°–¢–ê–¢–û–ö</div>}
      <div className="flex gap-3 items-center">
          <div className="bg-white p-1 rounded border border-gray-100">
             {qrValue ? <QRCode value={qrValue} size={70} /> : <div className="w-[70px] h-[70px] bg-gray-100 animate-pulse rounded"/>}
          </div>
          <div className="flex-1 text-left overflow-hidden">
              <div className="text-[9px] font-bold text-gray-400 uppercase tracking-wider flex justify-between">
                  <span>{batch || "–ë–ï–ó –ü–ê–†–¢–ò–ò"}</span>
              </div>
              <div className="text-sm font-black text-gray-900 leading-tight mb-1 line-clamp-2 mt-0.5">
                  {label || "–ò–∑–¥–µ–ª–∏–µ"}
              </div>
              <div className="text-[10px] text-gray-500 truncate mb-1 bg-gray-100 px-1 rounded w-max max-w-full">
                  {project || "–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞"}
              </div>
              <div className="flex items-center justify-between border-t border-gray-200 pt-1.5 mt-1">
                  <span className="font-mono text-[9px] text-gray-400">ID: {id || "..."}</span>
                  <span className={`text-xs font-bold px-1.5 py-0.5 rounded ${isPartial ? 'bg-amber-100 text-amber-800' : 'bg-black text-white'}`}>
                      {qty} {unit}
                  </span>
              </div>
          </div>
      </div>
  </div>
);
================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/components/ProjectDashboard.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchStockBalance } from "src/api/warehouseApi";
import { StockBalanceItem } from "src/types/WarehouseModels";
import { Loader2 } from "lucide-react";

export const ProjectDashboard: React.FC = () => {
    const [topItems, setTopItems] = useState<StockBalanceItem[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {

        fetchStockBalance()
            .then(data => {

                const sorted = data.sort((a, b) => Number(b.totalQuantity) - Number(a.totalQuantity)).slice(0, 3);
                setTopItems(sorted);
            })
            .catch(console.error)
            .finally(() => setLoading(false));
    }, []);

    if (loading) return <div className="flex items-center text-sm text-gray-400"><Loader2 className="animate-spin mr-2 h-4 w-4"/> –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–∞...</div>;

    if (topItems.length === 0) return <div className="text-sm text-gray-400">–°–∫–ª–∞–¥ –ø—É—Å—Ç</div>;

    return (
        <div className="flex gap-4 overflow-x-auto pb-2 w-full md:w-auto">
            {topItems.map((item, idx) => (
                <div key={idx} className="bg-white border border-gray-200 p-3 rounded-xl shadow-sm flex flex-col gap-1 min-w-[200px]">
                    <div className="flex justify-between items-start">
                        <div className="font-bold text-gray-700 text-sm truncate w-32" title={item.label}>
                            {item.label}
                        </div>
                        <div className="text-[10px] font-bold bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded">
                            TOP {idx + 1}
                        </div>
                    </div>


                    <div className="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden mt-1">
                        <div
                            className="bg-emerald-500 h-full rounded-full"
                            style={{ width: idx === 0 ? '100%' : `${(Number(item.totalQuantity) / Number(topItems[0].totalQuantity)) * 100}%` }}
                        ></div>
                    </div>

                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                        <span>–í –Ω–∞–ª–∏—á–∏–∏:</span>
                        <span className="font-bold text-gray-900">{Number(item.totalQuantity).toLocaleString()} {item.unit}</span>
                    </div>
                </div>
            ))}
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/VideoTransmittersLabel.tsx
================================================================================

import React, { useState, useMemo, useEffect } from "react";
import {
    Printer, RefreshCw, RotateCw, ArrowRight,
    Tv, Tag, Ruler, Trash2, FolderOpen, PenTool, LayoutTemplate, Bookmark,

    Wine, Umbrella, ArrowUp, Snowflake, Flame, Package, AlertTriangle
} from "lucide-react";
import { printSpecialLabel } from "src/api/warehouseApi";
import {
    fetchLabelTemplates,
    createLabelTemplate,
    deleteLabelTemplate,
    LabelTemplateModel,
    LabelElement
} from "src/api/labelTemplatesApi";
import { LabelConstructor } from "../components/LabelConstructor";
import { Modal } from "src/components/Modal/Modal";
import QRCode from "react-qr-code";
import toast from "react-hot-toast";
import clsx from "clsx";

type TemplateType = "VIDEO_KIT" | "SIMPLE" | "CUSTOM";


const LabelPreviewCard: React.FC<{
    data: any,
    title: string,
    template: TemplateType,
    size: { w: number, h: number },
    customLayout?: LabelElement[],
    currentIndex?: number,
    totalCount?: number
}> = ({ data, title, template, size, customLayout, currentIndex = 1, totalCount = 1 }) => {

    const infoString = `${data.productName} - ${data.quantity} ${data.unit} (ID: ${data.code})`;


    const baseWidthPx = 300;
    const cssHeight = size.w > 0 ? (baseWidthPx * (size.h / size.w)) : 190;


    const replaceVars = (text: string) => {
        if (!text) return '';
        return text

            .replace(/\{\{code\}\}/g, data.code || '')
            .replace(/\{\{name\}\}/g, data.productName || '')
            .replace(/\{\{productName\}\}/g, data.productName || '')
            .replace(/\{\{id\}\}/g, data.id || '')
            .replace(/\{\{date\}\}/g, data.date || '')
            .replace(/\{\{serial\}\}/g, data.code || '')
            .replace(/\{\{contract\}\}/g, data.contract || '')
            .replace(/\{\{batch\}\}/g, data.batch || '')
            .replace(/\{\{qty\}\}/g, String(data.quantity || ''))
            .replace(/\{\{quantity\}\}/g, String(data.quantity || ''))
            .replace(/\{\{unit\}\}/g, data.unit || '')
            .replace(/\{\{price\}\}/g, data.price || '')
            .replace(/\{\{weight\}\}/g, data.weight || '')

            .replace(/\{\{url\}\}/g, `https://mes.local/item/${data.code}`)

            .replace(/\{\{full_info\}\}/g, infoString)
            .replace(/\{\{quantity_unit\}\}/g, `${data.quantity} ${data.unit}`)

            .replace(/\{\{current\}\}/g, String(currentIndex))
            .replace(/\{\{total\}\}/g, String(totalCount));
    };

    return (
        <div className="flex flex-col items-center animate-fade-in">
            <div className="text-xs font-bold text-gray-400 uppercase mb-2 bg-white px-2 py-1 rounded shadow-sm border border-gray-100">
                {title}
            </div>

            <div className="bg-white shadow-2xl transition-all duration-300">
                <div
                    className="bg-white relative flex flex-col box-border overflow-hidden"
                    style={{
                        width: `${baseWidthPx}px`,
                        height: `${cssHeight}px`,
                        border: '1px solid #000'
                    }}
                >

                    {template === "VIDEO_KIT" && (
                        <div className="flex flex-row h-full p-2">
                            <div className="w-6 border-r border-black flex items-end justify-center py-2 bg-gray-50">
                                <div className="text-[8px] whitespace-nowrap -rotate-90 origin-bottom-left translate-x-full mb-4 w-40 truncate font-mono">
                                    {data.contract}
                                </div>
                            </div>
                            <div className="flex-1 flex flex-col pl-2">
                                <div className="flex justify-between items-start mb-2 shrink-0">
                                    <div className="font-mono text-sm font-bold truncate mt-1">{data.code}</div>
                                    <div><QRCode value={data.code} size={35} /></div>
                                </div>
                                <div className="border-2 border-black text-center text-xs w-full mb-2">
                                    <div className="border-b border-black p-1 font-bold bg-gray-50">{data.productName}</div>
                                    <div className="flex border-b border-black h-10">
                                        <div className="border-r border-black w-1/3 font-bold flex items-center justify-center text-lg">{data.id}</div>
                                        <div className="w-2/3 flex flex-col">
                                            <div className="border-b border-black h-1/2 flex items-center justify-center text-[9px]">{data.date}</div>
                                            <div className="h-1/2 font-bold flex items-center justify-center text-sm">{data.quantity} {data.unit}</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-auto flex justify-center pb-2">
                                    <QRCode value={infoString} size={60} />
                                </div>
                            </div>
                        </div>
                    )}


                    {template === "SIMPLE" && (
                        <div className="h-full flex flex-col justify-center items-center p-2">
                            <div className="text-sm font-bold text-center mb-2 leading-tight">{data.productName}</div>
                            <div className="flex items-center gap-4 w-full justify-center">
                                <QRCode value={infoString} size={70} />
                                <div className="text-left overflow-hidden">
                                    <div className="text-[9px] text-gray-500 uppercase">ID / –ü–∞—Ä—Ç–∏—è</div>
                                    <div className="font-mono font-bold text-sm mb-1 truncate">{data.code}</div>
                                    <div className="font-black text-xl">{data.quantity} {data.unit}</div>
                                </div>
                            </div>
                        </div>
                    )}


                    {template === "CUSTOM" && customLayout && customLayout.map(el => {

                        const elStyle: React.CSSProperties = {
                            position: 'absolute',
                            left: `${(el.x / size.w) * 100}%`,
                            top: `${(el.y / size.h) * 100}%`,
                            width: `${(el.width / size.w) * 100}%`,
                            height: ['QR', 'ICON', 'IMAGE', 'RECTANGLE'].includes(el.type)
                                ? `${(el.height / size.h) * 100}%`
                                : 'auto',
                            fontSize: `${(el.fontSize || 10) * (baseWidthPx / size.w) * 0.35}px`,
                            fontWeight: el.isBold ? 'bold' : 'normal',
                            textAlign: el.align || 'left',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: el.align === 'center' ? 'center' : el.align === 'right' ? 'flex-end' : 'flex-start',
                            overflow: 'hidden',
                        };

                        return (
                            <div key={el.id} style={elStyle}>


                                {el.type === 'TEXT' && (
                                    <span className="whitespace-pre-wrap break-words leading-tight">
                                        {replaceVars(el.content || '')}
                                    </span>
                                )}


                                {el.type === 'QR' && (
                                    <QRCode
                                        value={replaceVars(el.content || '{{code}}')}
                                        style={{ width: '100%', height: '100%' }}
                                        viewBox="0 0 256 256"
                                    />
                                )}


                                {el.type === 'COUNTER' && (
                                    <span
                                        className="whitespace-nowrap font-mono"
                                        style={{ fontWeight: el.isBold ? 'bold' : 'normal' }}
                                    >
                                        {replaceVars(el.counterFormat || '{{current}} / {{total}}')}
                                    </span>
                                )}


                                {el.type === 'IMAGE' && el.imageUrl && (
                                    <img
                                        src={el.imageUrl}
                                        alt={el.imageName || 'Image'}
                                        className="w-full h-full object-contain"
                                    />
                                )}


                                {el.type === 'ICON' && (
                                    <div className="w-full h-full flex items-center justify-center p-0.5">

                                        {el.imageUrl ? (
                                            <img src={el.imageUrl} alt={el.content || 'Icon'} className="w-full h-full object-contain" />
                                        ) : (

                                            <>
                                                {el.iconType === 'fragile' && <Wine className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'keep_dry' && <Umbrella className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'this_side_up' && <ArrowUp className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'keep_frozen' && <Snowflake className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'keep_away_heat' && <Flame className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'do_not_stack' && <Package className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'warning' && <AlertTriangle className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                            </>
                                        )}
                                    </div>
                                )}


                                {el.type === 'LINE' && (
                                    <div
                                        className="bg-black"
                                        style={{
                                            width: el.width >= el.height ? '100%' : `${(el.strokeWidth || 0.3) * 3}px`,
                                            height: el.width >= el.height ? `${(el.strokeWidth || 0.3) * 3}px` : '100%',
                                        }}
                                    />
                                )}


                                {el.type === 'RECTANGLE' && (
                                    <div
                                        className="w-full h-full border-black"
                                        style={{ borderWidth: `${(el.strokeWidth || 0.3) * 2}px` }}
                                    />
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
            <div className="mt-2 text-[10px] text-gray-400 font-mono">
                {size.w} x {size.h} –º–º
            </div>
        </div>
    );
};


export const VideoTransmittersLabel: React.FC = () => {
    const [templateType, setTemplateType] = useState<TemplateType>("VIDEO_KIT");


    const [form, setForm] = useState({
        code: "7342511000501",
        productName: "–ü—Ä–∏–µ–º–Ω–∏–∫ 2xLR1121",
        id: "734",
        date: new Date().toLocaleString('ru-RU'),
        quantity: "500",
        unit: "—à—Ç.",
        contract: "–ì.–∫. ‚Ññ 249/2/–û–ü/25/1/37 –æ—Ç ¬´05¬ª —Å–µ–Ω—Ç—è–±—Ä—è 2025 –≥."
    });

    const [printCount, setPrintCount] = useState<number>(1);
    const [labelSize, setLabelSize] = useState({ width: 140, height: 90 });
    const [loading, setLoading] = useState(false);


    const [isConstructorMode, setIsConstructorMode] = useState(false);
    const [customLayout, setCustomLayout] = useState<LabelElement[]>([]);
    const [customTemplateName, setCustomTemplateName] = useState("");


    const [savedTemplates, setSavedTemplates] = useState<LabelTemplateModel[]>([]);

    useEffect(() => {
        loadTemplates();
    }, []);

    const loadTemplates = async () => {
        try {
            const data = await fetchLabelTemplates();
            setSavedTemplates(data);
        } catch (e) {
            console.error(e);
        }
    };


    const endCode = useMemo(() => {
        try {
            const cleanCode = form.code.replace(/\D/g, '');
            if(!cleanCode) return form.code;
            const startBig = BigInt(cleanCode);
            const countBig = BigInt(Math.max(1, printCount));
            const endBig = startBig + countBig - 1n;
            return endBig.toString().padStart(cleanCode.length, '0');
        } catch {
            return form.code;
        }
    }, [form.code, printCount]);

    const handlePrint = async () => {
        if (printCount < 1) return toast.error("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ø–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0");
        setLoading(true);
        try {
            await printSpecialLabel({
                ...form,
                template: templateType,

                customLayout: templateType === "CUSTOM" ? customLayout : undefined,
                printCount,
                rotate: false,
                widthMm: labelSize.width,
                heightMm: labelSize.height
            });
            toast.success(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${printCount} —ç—Ç–∏–∫–µ—Ç–æ–∫`);
        } catch (e: any) {
            toast.error("–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏: " + e.message);
        } finally {
            setLoading(false);
        }
    };


    const onSaveConstructor = async (name: string, w: number, h: number, layout: LabelElement[]) => {
        try {
            await createLabelTemplate(name, w, h, layout);
            toast.success("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑—É!");
            setIsConstructorMode(false);
            loadTemplates();


            setTemplateType("CUSTOM");
            setCustomLayout(layout);
            setCustomTemplateName(name);
            setLabelSize({ width: w, height: h });
        } catch (e) {
            toast.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
    };


    const applySavedTemplate = (t: LabelTemplateModel) => {
        setIsConstructorMode(false);
        setTemplateType("CUSTOM");
        setLabelSize({ width: t.width, height: t.height });
        setCustomLayout(t.layout);
        setCustomTemplateName(t.name);
        toast.success(`–ó–∞–≥—Ä—É–∂–µ–Ω –º–∞–∫–µ—Ç: ${t.name}`);
    };

    const deleteSavedTemplate = async (id: number) => {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?")) return;
        await deleteLabelTemplate(id);
        loadTemplates();
        if(customTemplateName && templateType === 'CUSTOM') {
             setTemplateType("VIDEO_KIT");
             setCustomTemplateName("");
        }
    };

    const updateTime = () => {
        setForm(prev => ({...prev, date: new Date().toLocaleString('ru-RU')}));
    };

    const toggleRotation = () => {
        setLabelSize({ width: labelSize.height, height: labelSize.width });
    };

    return (
        <div className="max-w-7xl mx-auto animate-fade-in pb-10">


            <div className="mb-6 flex flex-col md:flex-row justify-center items-center gap-4">
                <div className="bg-white p-1 rounded-xl border border-gray-200 shadow-sm inline-flex gap-1">
                    <button onClick={() => {setTemplateType("VIDEO_KIT"); setIsConstructorMode(false); setLabelSize({width: 140, height: 90})}} className={clsx("px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all", templateType === "VIDEO_KIT" && !isConstructorMode ? "bg-indigo-600 text-white shadow-md" : "text-gray-500 hover:bg-gray-100")}>
                        <Tv size={18}/> –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
                    </button>
                    <button onClick={() => {setTemplateType("SIMPLE"); setIsConstructorMode(false); setLabelSize({width: 100, height: 60})}} className={clsx("px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all", templateType === "SIMPLE" && !isConstructorMode ? "bg-indigo-600 text-white shadow-md" : "text-gray-500 hover:bg-gray-100")}>
                        <Tag size={18}/> –ü—Ä–æ—Å—Ç–æ–π
                    </button>

                    <button onClick={() => {setTemplateType("CUSTOM"); setIsConstructorMode(false)}} className={clsx("px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all", templateType === "CUSTOM" && !isConstructorMode ? "bg-indigo-600 text-white shadow-md" : "text-gray-500 hover:bg-gray-100")}>
                        <LayoutTemplate size={18}/> {customTemplateName || "–ú–æ–∏ —à–∞–±–ª–æ–Ω—ã"}
                    </button>
                </div>

                <button
                    onClick={() => setIsConstructorMode(!isConstructorMode)}
                    className={clsx("px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all border", isConstructorMode ? "bg-red-50 text-red-600 border-red-200" : "bg-white text-indigo-600 border-indigo-200 hover:bg-indigo-50")}
                >
                    {isConstructorMode ? <Trash2 size={18}/> : <PenTool size={18}/>}
                    {isConstructorMode ? "–ó–∞–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä" : "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä"}
                </button>
            </div>


            {isConstructorMode ? (
                <LabelConstructor
                    initialWidth={labelSize.width}
                    initialHeight={labelSize.height}
                    initialLayout={templateType === 'CUSTOM' ? customLayout : []}
                    onSave={onSaveConstructor}
                    onClose={() => setIsConstructorMode(false)}
                />
            ) : (
                <div className="flex flex-col xl:flex-row gap-8">


                    <div className="flex-1 space-y-5 bg-white p-6 rounded-3xl shadow-xl border border-gray-100">
                        <div className="flex items-center gap-2 text-indigo-800 border-b pb-4 mb-2">
                            <Printer className="text-indigo-600"/>
                            <h2 className="text-xl font-bold">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—á–∞—Ç–∏</h2>
                        </div>


                        {savedTemplates.length > 0 && (
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <div className="text-[10px] font-bold text-slate-400 uppercase flex items-center gap-2 mb-2">
                                    <FolderOpen size={12}/> –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω:
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {savedTemplates.map(t => (
                                        <div key={t.id} className={clsx("group flex items-center bg-white border rounded-lg overflow-hidden shadow-sm transition cursor-pointer", customTemplateName === t.name ? "border-indigo-500 ring-1 ring-indigo-500" : "border-gray-300 hover:border-indigo-400")}>
                                            <div onClick={() => applySavedTemplate(t)} className="px-3 py-1.5 text-xs font-bold text-gray-700 hover:text-indigo-600">
                                                {t.name} <span className="text-gray-400 font-normal ml-1">{t.width}x{t.height}</span>
                                            </div>
                                            <button onClick={(e) => { e.stopPropagation(); deleteSavedTemplate(t.id); }} className="px-2 py-1.5 hover:bg-red-50 text-gray-400 hover:text-red-500 border-l">
                                                <Trash2 size={12}/>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}


                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2">
                                <label className="text-xs font-bold text-gray-500 uppercase">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                                <input value={form.productName} onChange={e => setForm({...form, productName: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg font-bold text-gray-800 focus:border-indigo-500 outline-none" />
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">ID / –ù–æ–º–µ—Ä</label>
                                <input value={form.id} onChange={e => setForm({...form, id: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg focus:border-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">–î–∞—Ç–∞</label>
                                <div className="flex gap-1">
                                    <input value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:border-indigo-500 outline-none" />
                                    <button onClick={updateTime} className="p-2.5 bg-gray-100 rounded-lg hover:bg-gray-200"><RefreshCw size={16}/></button>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">–ö–æ–ª-–≤–æ</label>
                                <input value={form.quantity} onChange={e => setForm({...form, quantity: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg focus:border-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">–ï–¥. –∏–∑–º.</label>
                                <input value={form.unit} onChange={e => setForm({...form, unit: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 outline-none" />
                            </div>

                            <div className="md:col-span-2">
                                <label className="text-xs font-bold text-gray-500 uppercase">–î–æ–≥–æ–≤–æ—Ä / –ò–Ω—Ñ–æ</label>
                                <input value={form.contract} onChange={e => setForm({...form, contract: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:border-indigo-500 outline-none" />
                            </div>
                        </div>


                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-indigo-800 uppercase flex justify-between">
                                    <span>–°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–æ–º–µ—Ä (–î–ª—è QR)</span>
                                </label>
                                <input value={form.code} onChange={e => setForm({...form, code: e.target.value})} className="w-full p-3 border-2 border-indigo-200 rounded-xl font-mono text-xl font-black text-indigo-900 focus:border-indigo-500 outline-none shadow-sm" />
                            </div>

                            <div className="flex items-end gap-4">
                                <div className="flex-1">
                                    <label className="text-xs font-bold text-indigo-800 uppercase mb-1 block">–¢–∏—Ä–∞–∂</label>
                                    <input type="number" min="1" max="1000" value={printCount} onChange={e => setPrintCount(Number(e.target.value))} className="w-full p-3 border-2 border-indigo-200 rounded-xl font-bold text-lg" />
                                </div>
                                <div className="flex items-center gap-2 p-3 bg-white/60 rounded-xl border border-indigo-100">
                                    <Ruler size={18} className="text-indigo-400"/>
                                    <div className="text-xs font-bold text-indigo-900">{labelSize.width} x {labelSize.height} –º–º</div>
                                </div>
                            </div>

                            <div className="text-xs text-indigo-700 flex items-center justify-between">
                                <span>–î–∏–∞–ø–∞–∑–æ–Ω:</span>
                                <div className="font-mono font-bold">{form.code} <ArrowRight size={12} className="inline"/> {endCode}</div>
                            </div>

                            <button onClick={handlePrint} disabled={loading} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl rounded-xl shadow-lg hover:shadow-indigo-300 transition flex justify-center items-center gap-3">
                                {loading ? "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è..." : <><Printer /> –ü–ï–ß–ê–¢–¨</>}
                            </button>
                        </div>
                    </div>


                    <div className="flex-1 bg-gray-100 rounded-3xl p-8 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 min-h-[500px] sticky top-6">
                        <div className="grid grid-cols-1 gap-12 w-full place-items-center max-h-[800px] overflow-y-auto custom-scrollbar">
                            <LabelPreviewCard
                                title="–ü–µ—Ä–≤–∞—è –≤ —Å–µ—Ä–∏–∏"
                                data={form}
                                template={templateType}
                                size={{ w: labelSize.width, h: labelSize.height }}
                                customLayout={templateType === 'CUSTOM' ? customLayout : undefined}
                                currentIndex={1}
                                totalCount={printCount}
                            />
                            {printCount > 1 && (
                                <>
                                    <div className="text-gray-400 -my-6"><ArrowRight className="rotate-90" size={32}/></div>
                                    <LabelPreviewCard
                                        title={`–ü–æ—Å–ª–µ–¥–Ω—è—è (‚Ññ${printCount})`}
                                        data={{...form, code: endCode}}
                                        template={templateType}
                                        size={{ w: labelSize.width, h: labelSize.height }}
                                        customLayout={templateType === 'CUSTOM' ? customLayout : undefined}
                                        currentIndex={printCount}
                                        totalCount={printCount}
                                    />
                                </>
                            )}
                        </div>
                        <p className="text-xs text-gray-400 mt-6 font-mono text-center">
                            * –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç PDF.<br/>
                            –†–∞–∑–º–µ—Ä –±—É–º–∞–≥–∏: {labelSize.width}x{labelSize.height} –º–º
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseBalance.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchStockBalance } from "src/api/warehouseApi";
import { StockBalanceItem } from "src/types/WarehouseModels";
import { PieChart, Package, RefreshCw, PackageX } from "lucide-react";

export const WarehouseBalance: React.FC = () => {
    const [balance, setBalance] = useState<StockBalanceItem[]>([]);
    const [loading, setLoading] = useState(false);

    const loadData = async () => {
        setLoading(true);
        try {
            const data = await fetchStockBalance();
            setBalance(data);
        } catch (e) { console.error(e); }
        finally { setLoading(false); }
    };

    useEffect(() => { loadData(); }, []);


    const products = balance.filter(i => i.originType === "PRODUCT");
    const components = balance.filter(i => i.originType === "COMPONENT");
    const others = balance.filter(i => i.originType !== "PRODUCT" && i.originType !== "COMPONENT");

    const renderTable = (title: string, items: StockBalanceItem[], colorClass: string) => (
        <div className="mb-8 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div className={`px-6 py-3 font-bold text-gray-700 bg-gray-50 border-b flex justify-between ${colorClass}`}>
                <span>{title}</span>
                <span className="text-xs bg-white px-2 py-0.5 rounded border">–ü–æ–∑–∏—Ü–∏–π: {items.length}</span>
            </div>
            <table className="w-full text-left">
                <thead className="bg-gray-50/50 text-xs text-gray-500 uppercase border-b">
                    <tr>
                        <th className="px-6 py-3">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th className="px-6 py-3 text-right">–û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</th>
                        <th className="px-6 py-3 text-right">–ú–µ—Å—Ç (–ö–æ—Ä–æ–±–æ–∫)</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-100 text-sm">
                    {items.map((item, idx) => (
                        <tr key={idx} className="hover:bg-gray-50 transition">
                            <td className="px-6 py-3 font-medium text-gray-800">{item.label}</td>
                            <td className="px-6 py-3 text-right font-bold text-indigo-600">
                                {Number(item.totalQuantity).toLocaleString()} <span className="text-gray-400 font-normal text-xs">{item.unit}</span>
                            </td>
                            <td className="px-6 py-3 text-right text-gray-600">{item.boxCount}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );

    return (
        <div className="animate-fade-in">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <PieChart className="text-indigo-600"/> –°–≤–æ–¥–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ —Å–∫–ª–∞–¥–∞
                </h2>
                <button onClick={loadData} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"><RefreshCw size={18}/></button>
            </div>

            {loading ? (
                <div className="text-center py-20 text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            ) : (
                <>
                    {products.length > 0 && renderTable("–ì–æ—Ç–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è", products, "border-l-4 border-l-purple-500")}
                    {components.length > 0 && renderTable("–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã", components, "border-l-4 border-l-blue-500")}
                    {others.length > 0 && renderTable("–ü—Ä–æ—á–µ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", others, "border-l-4 border-l-gray-500")}

                    {balance.length === 0 && (
                        <div className="text-center py-20 bg-white rounded-xl border-2 border-dashed">
                            <PackageX size={48} className="mx-auto text-gray-300 mb-4"/>
                            <p className="text-gray-500">–°–∫–ª–∞–¥ –ø—É—Å—Ç. –ü—Ä–∏–º–∏—Ç–µ —Ç–æ–≤–∞—Ä, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Å—Ç–∞—Ç–∫–∏.</p>
                        </div>
                    )}
                </>
            )}
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseDocs.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  FileText, Calendar, Search, Plus, Filter,
  ArrowDownToLine, Printer, User, MoreHorizontal
} from "lucide-react";
import { createDocument, fetchDocuments } from "src/api/warehouseApi";
import { WarehouseDocument } from "src/types/WarehouseModels";
import { formatDateTime } from "../utils";

export const WarehouseDocs: React.FC = () => {
  const [docs, setDocs] = useState<WarehouseDocument[]>([]);
  const [loading, setLoading] = useState(false);

  const [search, setSearch] = useState("");
  const [typeFilter, setTypeFilter] = useState("");
  const [dateFrom, setDateFrom] = useState("");

  const [isCreateOpen, setIsCreateOpen] = useState(false);
  const [newDoc, setNewDoc] = useState({ number: "", type: "INCOME", comment: "" });

  const loadDocuments = async () => {
      setLoading(true);
      try {
          const res = await fetchDocuments({
            limit: 50,
            search: search || undefined,
            type: typeFilter || undefined,
            dateFrom: dateFrom || undefined
          });
          setDocs(res.rows);
      } catch(e) { console.error(e); }
      finally { setLoading(false); }
  };

  useEffect(() => {
      const timer = setTimeout(loadDocuments, 500);
      return () => clearTimeout(timer);
  }, [search, typeFilter, dateFrom]);

  const handleCreate = async () => {
      if(!newDoc.number) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä!");
      try {
          await createDocument({ ...newDoc, boxId: null });
          setIsCreateOpen(false);
          setNewDoc({ number: "", type: "INCOME", comment: "" });
          loadDocuments();
      } catch(e) { alert("–û—à–∏–±–∫–∞"); }
  };


  const getTypeStyle = (type: string | null) => {
      const t = (type || "").toUpperCase();
      if (t.includes("INCOME") || t.includes("–ü–†–ò–•–û–î")) return "bg-emerald-100 text-emerald-700 border-emerald-200";
      if (t.includes("OUT") || t.includes("–†–ê–°–•–û–î") || t.includes("–°–ü–ò–°–ê–ù–ò–ï")) return "bg-orange-100 text-orange-700 border-orange-200";
      return "bg-blue-50 text-blue-700 border-blue-200";
  }

  return (
    <div className="space-y-6 animate-fade-in">


        <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between gap-4">
            <div className="flex items-center gap-4 flex-1">
                <div className="relative flex-1 max-w-md">
                    <Search className="absolute left-3 top-2.5 text-gray-400 w-5 h-5" />
                    <input
                        value={search} onChange={e => setSearch(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é..."
                    />
                </div>

                <select
                    value={typeFilter} onChange={e => setTypeFilter(e.target.value)}
                    className="p-2 border border-gray-200 rounded-lg bg-gray-50 text-sm font-medium"
                >
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="INCOME">–ü—Ä–∏—Ö–æ–¥ (INCOME)</option>
                    <option value="OUTCOME">–†–∞—Å—Ö–æ–¥ (OUTCOME)</option>
                    <option value="MOVE">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</option>
                </select>

                <input
                    type="date"
                    value={dateFrom} onChange={e => setDateFrom(e.target.value)}
                    className="p-2 border border-gray-200 rounded-lg text-sm text-gray-600"
                />
            </div>

            <button
                onClick={() => setIsCreateOpen(!isCreateOpen)}
                className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm"
            >
                <Plus size={18} /> –ù–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
            </button>
        </div>


        {isCreateOpen && (
            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex flex-col md:flex-row gap-3 items-end animate-fade-in">
                <div className="flex-1 w-full">
                    <label className="text-xs font-bold text-indigo-900 uppercase">–ù–æ–º–µ—Ä</label>
                    <input value={newDoc.number} onChange={e => setNewDoc({...newDoc, number: e.target.value})} className="w-full p-2 border rounded-lg" placeholder="‚Ññ –ê–ö–¢-001" />
                </div>
                <div className="w-full md:w-48">
                    <label className="text-xs font-bold text-indigo-900 uppercase">–¢–∏–ø</label>
                    <select value={newDoc.type} onChange={e => setNewDoc({...newDoc, type: e.target.value})} className="w-full p-2 border rounded-lg">
                        <option value="INCOME">–ü—Ä–∏—Ö–æ–¥</option>
                        <option value="OUTCOME">–°–ø–∏—Å–∞–Ω–∏–µ</option>
                        <option value="MOVE">–ê–∫—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</option>
                    </select>
                </div>
                <div className="flex-[2] w-full">
                    <label className="text-xs font-bold text-indigo-900 uppercase">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <input value={newDoc.comment} onChange={e => setNewDoc({...newDoc, comment: e.target.value})} className="w-full p-2 border rounded-lg" placeholder="–û—Å–Ω–æ–≤–∞–Ω–∏–µ..." />
                </div>
                <button onClick={handleCreate} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        )}


        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <table className="w-full text-left border-collapse">
                <thead>
                    <tr className="bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        <th className="px-6 py-4">–î–æ–∫—É–º–µ–Ω—Ç</th>
                        <th className="px-6 py-4">–¢–∏–ø</th>
                        <th className="px-6 py-4">–î–∞—Ç–∞ / –ê–≤—Ç–æ—Ä</th>
                        <th className="px-6 py-4">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        <th className="px-6 py-4 text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                    {loading ? (
                         <tr><td colSpan={5} className="p-10 text-center text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    ) : docs.length === 0 ? (
                         <tr><td colSpan={5} className="p-10 text-center text-gray-400">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>
                    ) : (
                        docs.map(doc => (
                            <tr key={doc.id} className="hover:bg-gray-50 transition-colors group">
                                <td className="px-6 py-4">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-gray-100 rounded-lg text-gray-500">
                                            <FileText size={20} />
                                        </div>
                                        <div>
                                            <div className="font-bold text-gray-900">{doc.number}</div>
                                            <div className="text-xs text-gray-400">ID: {doc.id}</div>
                                        </div>
                                    </div>
                                </td>
                                <td className="px-6 py-4">
                                    <span className={`px-2.5 py-1 rounded-md text-xs font-bold border ${getTypeStyle(doc.type)}`}>
                                        {doc.type || "OTHER"}
                                    </span>
                                </td>
                                <td className="px-6 py-4">
                                    <div className="flex flex-col">
                                        <span className="text-sm font-medium text-gray-700 flex items-center gap-1.5">
                                            <Calendar size={14} className="text-gray-400"/>
                                            {doc.date || formatDateTime(doc.createdAt).split(',')[0]}
                                        </span>
                                        <span className="text-xs text-gray-500 flex items-center gap-1.5 mt-0.5">
                                            <User size={12}/>
                                            {doc.createdBy?.name || "–°–∏—Å—Ç–µ–º–∞"}
                                        </span>
                                    </div>
                                </td>
                                <td className="px-6 py-4 max-w-xs">
                                    <div className="text-sm text-gray-600 truncate" title={doc.comment || ""}>
                                        {doc.comment || "‚Äî"}
                                    </div>
                                </td>
                                <td className="px-6 py-4 text-right">
                                    <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="–ü–µ—á–∞—Ç—å">
                                            <Printer size={18} />
                                        </button>
                                        <button className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="–°–∫–∞—á–∞—Ç—å">
                                            <ArrowDownToLine size={18} />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))
                    )}
                </tbody>
            </table>
        </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseIntake.tsx
================================================================================

import React, { useEffect, useMemo, useState } from "react";
import QRCode from "react-qr-code";
import {
  ClipboardList, AlertCircle, Printer, Copy, Layers, FileSpreadsheet
} from "lucide-react";
import { createBoxesBatch, downloadBoxesExcel, printBoxesPdf } from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import { SectionModel } from "src/store/StructureStore";
import { productModel } from "src/types/ProductModel";
import { componentModel } from "src/types/ComponentModel";
import { LabelPreview } from "../components/LabelPreview";

interface Props {
  sections: SectionModel[];
  productsList: productModel[];
  componentsList: componentModel[];
}

export const WarehouseIntake: React.FC<Props> = ({ sections, productsList, componentsList }) => {

  const [intakeMode, setIntakeMode] = useState<"PRODUCT" | "COMPONENT" | "OTHER">("PRODUCT");
  const [selectedSkuId, setSelectedSkuId] = useState<number | "">("");
  const [label, setLabel] = useState("");
  const [projectName, setProjectName] = useState("");
  const [batchName, setBatchName] = useState("");


  const [measureType, setMeasureType] = useState<"PCS" | "METERS">("PCS");
  const [unit, setUnit] = useState("—à—Ç");
  const [shipmentTotal, setShipmentTotal] = useState<number | "">("");
  const [capacityPerUnit, setCapacityPerUnit] = useState<number>(1);

  const batchCalc = useMemo(() => {
      const total = Number(shipmentTotal) || 0;
      const capacity = Number(capacityPerUnit) || 1;
      if (total === 0) return { fullUnits: 0, remainder: 0, totalUnits: 0 };
      const fullUnits = Math.floor(total / capacity);
      const remainder = total % capacity;
      const totalUnits = fullUnits + (remainder > 0 ? 1 : 0);
      return { fullUnits, remainder, totalUnits };
  }, [shipmentTotal, capacityPerUnit]);

  const [intakeStatus, setIntakeStatus] = useState("ON_STOCK");
  const [intakeSectionId, setIntakeSectionId] = useState<number | "">("");
  const [intakeNotes, setIntakeNotes] = useState("");
  const [createdBoxes, setCreatedBoxes] = useState<InventoryBoxModel[]>([]);
  const [intakeLoading, setIntakeLoading] = useState(false);
  const [intakeError, setIntakeError] = useState<string | null>(null);


  useEffect(() => {
    setUnit(measureType === "PCS" ? "—à—Ç" : "–º");
  }, [measureType]);


  useEffect(() => {
      if (intakeMode === "PRODUCT" && selectedSkuId) {
          const p = productsList.find(x => x.id === Number(selectedSkuId));
          if(p) setLabel(p.title);
      } else if (intakeMode === "COMPONENT" && selectedSkuId) {
          const c = componentsList.find(x => x.id === Number(selectedSkuId));
          if(c) setLabel(c.title);
      }
  }, [intakeMode, selectedSkuId]);


  const applyTemplate = (type: "THERMAL" | "CABLE" | "SUB") => {
      if (type === "THERMAL") {
        setLabel("–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –¢–ü-200 (–ö–æ–º–ø–ª–µ–∫—Ç)");
        setProjectName("Project-40k");
        setBatchName("–ü–∞—Ä—Ç–∏—è 2");
        setMeasureType("PCS");
        setShipmentTotal(4000);
        setCapacityPerUnit(200);
        setIntakeNotes("–ü—Ä–∏—à–ª–∞ —á–∞—Å—Ç—å. –°–±–æ—Ä–∫—É –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–∞–º–∏.");
      } else if (type === "CABLE") {
        setLabel("–ö–∞–±–µ–ª—å –ö–æ–∞–∫—Å–∏–∞–ª—å–Ω—ã–π RG-6");
        setProjectName("–û–±—â–∏–π –∑–∞–ø–∞—Å");
        setBatchName("–ü–æ—Å—Ç–∞–≤–∫–∞ –î–µ–∫-24");
        setMeasureType("METERS");
        setShipmentTotal(5000);
        setCapacityPerUnit(1000);
        setIntakeNotes("–ö–∞–±–µ–ª—å –¥–ª—è –Ω–∞—Ä–µ–∑–∫–∏");
      } else if (type === "SUB") {
        setLabel("–ü–æ–ª—ë—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä v3 (–°—É–±–ø–æ–¥—Ä—è–¥)");
        setProjectName("–î—Ä–æ–Ω—ã FPV");
        setBatchName("–û—Ç –û–û–û '–¢–µ—Ö–Ω–æ'");
        setMeasureType("PCS");
        setShipmentTotal(10000);
        setCapacityPerUnit(500);
        setIntakeNotes("–ü—Ä–∏—à–ª–∏ –≥–æ—Ç–æ–≤—ã–µ, —Å—Ä–∞–∑—É –Ω–∞ –ø—Ä–æ—à–∏–≤–∫—É!");
        setIntakeStatus("IN_WORK");
      }
  };

  const handleCreateBatch = async () => {
    if (!label.trim()) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");
    if (batchCalc.totalUnits > 1000) return alert("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —ç—Ç–∏–∫–µ—Ç–æ–∫ (>1000).");

    setIntakeLoading(true);
    setIntakeError(null);
    try {
      let autoNote = intakeNotes;
      if (batchCalc.remainder > 0) {
         autoNote += ` | –í–ù–ò–ú–ê–ù–ò–ï: –û—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ: ${batchCalc.remainder} ${unit}`;
      }

      const res = await createBoxesBatch({
        label, projectName, batchName,
        originType: intakeMode,
        originId: selectedSkuId ? Number(selectedSkuId) : null,
        quantity: batchCalc.totalUnits,
        itemsPerBox: capacityPerUnit,
        unit,
        status: intakeStatus,
        currentSectionId: intakeSectionId ? Number(intakeSectionId) : null,
        notes: autoNote
      });

      setCreatedBoxes(res.boxes);
      setShipmentTotal("");
    } catch (e: any) {
        setIntakeError(e.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è");
    }
    finally { setIntakeLoading(false); }
  };

  return (
    <div className="grid grid-cols-1 xl:grid-cols-12 gap-8 animate-fade-in">

        <div className="xl:col-span-8 space-y-6">

            <div className="flex gap-2 overflow-x-auto pb-2">
                <button onClick={() => applyTemplate("THERMAL")} className="whitespace-nowrap px-4 py-2 bg-white border rounded text-xs font-bold text-gray-600 hover:bg-blue-50 transition flex gap-2"><Copy size={14}/> –ü—Ä–∏–º–µ—Ä: –¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä—ã</button>
                <button onClick={() => applyTemplate("SUB")} className="whitespace-nowrap px-4 py-2 bg-white border rounded text-xs font-bold text-gray-600 hover:bg-purple-50 transition flex gap-2"><Copy size={14}/> –ü—Ä–∏–º–µ—Ä: –°—É–±–ø–æ–¥—Ä—è–¥</button>
                <button onClick={() => applyTemplate("CABLE")} className="whitespace-nowrap px-4 py-2 bg-white border rounded text-xs font-bold text-gray-600 hover:bg-orange-50 transition flex gap-2"><Copy size={14}/> –ü—Ä–∏–º–µ—Ä: –ö–∞–±–µ–ª—å</button>
            </div>

            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h2 className="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <ClipboardList className="text-indigo-600"/> –ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞
                </h2>


                <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">–ß—Ç–æ –ø—Ä–∏–Ω–∏–º–∞–µ–º?</label>
                    <div className="flex gap-2">
                        {(['PRODUCT', 'COMPONENT', 'OTHER'] as const).map(m => (
                            <button
                                key={m}
                                onClick={() => { setIntakeMode(m); setSelectedSkuId(""); setLabel(""); }}
                                className={`flex-1 py-2 rounded-lg border text-sm font-bold transition ${intakeMode === m ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-gray-50 text-gray-600'}`}
                            >
                                {m === 'PRODUCT' ? '–ò–∑–¥–µ–ª–∏–µ' : m === 'COMPONENT' ? '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ' : '–ü—Ä–æ—á–µ–µ'}
                            </button>
                        ))}
                    </div>
                </div>


                {(intakeMode === 'PRODUCT' || intakeMode === 'COMPONENT') && (
                    <div className="mb-4">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</label>
                        <select
                            className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500"
                            value={selectedSkuId} onChange={e => setSelectedSkuId(e.target.value)}
                        >
                            <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
                            {intakeMode === 'PRODUCT'
                                ? productsList.map(p => <option key={p.id} value={p.id}>{p.title}</option>)
                                : componentsList.map(c => <option key={c.id} value={c.id}>{c.title} ({c.article})</option>)
                            }
                        </select>
                    </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div className="md:col-span-2">
                         <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                         <input value={label} onChange={e => setLabel(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä FC v2.4"/>
                     </div>
                     <div>
                         <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ü–∞—Ä—Ç–∏—è</label>
                         <input value={batchName} onChange={e => setBatchName(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="‚Ññ –ø–∞—Ä—Ç–∏–∏" />
                     </div>
                     <div>
                         <label className="block text-xs font-bold text-gray-500 uppercase mb-1">–ü—Ä–æ–µ–∫—Ç</label>
                         <input value={projectName} onChange={e => setProjectName(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" />
                     </div>
                     <div>
                         <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">–ö—É–¥–∞ (–£—á–∞—Å—Ç–æ–∫)</label>
                         <select value={intakeSectionId} onChange={e => setIntakeSectionId(Number(e.target.value))} className="w-full p-2 border rounded-lg text-sm bg-gray-50">
                            <option value="">-- –°–∫–ª–∞–¥ –ü—Ä–∏—ë–º–∫–∏ --</option>
                            {sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                         </select>
                     </div>
                     <div>
                         <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">–°—Ç–∞—Ç—É—Å</label>
                         <select value={intakeStatus} onChange={e => setIntakeStatus(e.target.value)} className="w-full p-2 border rounded-lg text-sm">
                             <option value="ON_STOCK">–ù–∞ —Å–∫–ª–∞–¥–µ (–û–±—ã—á–Ω—ã–π)</option>
                             <option value="IN_WORK">–°—Ä–∞–∑—É –≤ —Ä–∞–±–æ—Ç—É</option>
                         </select>
                     </div>
                     <div className="md:col-span-2">
                         <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                         <input value={intakeNotes} onChange={e => setIntakeNotes(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="..." />
                     </div>
                </div>


                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6">
                    <div className="flex justify-between mb-2">
                        <h4 className="text-sm font-bold text-indigo-900 flex items-center gap-2"><Layers size={14}/> –†–∞—Å—á–µ—Ç –º–µ—Å—Ç</h4>
                        <div className="flex text-[10px] font-bold bg-white rounded border overflow-hidden">
                            <button onClick={() => setMeasureType("PCS")} className={`px-2 py-1 ${measureType === 'PCS' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500'}`}>–®–¢</button>
                            <button onClick={() => setMeasureType("METERS")} className={`px-2 py-1 ${measureType === 'METERS' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500'}`}>–ú–ï–¢–†–´</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-2">
                         <div>
                             <label className="text-xs text-gray-600">–í—Å–µ–≥–æ –ø—Ä–∏—à–ª–æ ({unit})</label>
                             <input type="number" min={1} value={shipmentTotal} onChange={e => setShipmentTotal(Number(e.target.value))} className="w-full p-2 border rounded-lg font-bold" placeholder="0"/>
                         </div>
                         <div>
                             <label className="text-xs text-gray-600">–í –æ–¥–Ω–æ–π —Ç–∞—Ä–µ ({unit})</label>
                             <input type="number" min={1} value={capacityPerUnit} onChange={e => setCapacityPerUnit(Number(e.target.value))} className="w-full p-2 border rounded-lg" placeholder="1"/>
                         </div>
                    </div>

                    <div className="text-sm text-indigo-800 font-medium flex justify-between items-center pt-2 border-t border-indigo-200">
                        <span>–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ —ç—Ç–∏–∫–µ—Ç–æ–∫:</span>
                        <span className="text-xl font-black">{batchCalc.totalUnits}</span>
                    </div>
                    {batchCalc.remainder > 0 && (
                        <div className="mt-2 text-xs text-orange-600 font-bold flex items-center gap-1">
                            <AlertCircle size={12}/> {batchCalc.fullUnits} –ø–æ–ª–Ω—ã—Ö + 1 —Å –æ—Å—Ç–∞—Ç–∫–æ–º ({batchCalc.remainder} {unit})
                        </div>
                    )}
                </div>

                {intakeError && <div className="text-sm text-red-600 mb-4 p-3 bg-red-50 rounded-lg">{intakeError}</div>}

                <div className="flex justify-end">
                     <button
                        onClick={handleCreateBatch} disabled={intakeLoading || !label}
                        className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2"
                     >
                        {intakeLoading ? "..." : <Printer size={20}/>} –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—é
                     </button>
                </div>
            </div>


            <div className="space-y-4">
                <div className="flex justify-between items-center">
                    <h3 className="text-lg font-bold text-gray-700">–†–µ–∑—É–ª—å—Ç–∞—Ç ({createdBoxes.length})</h3>
                    <div className="flex gap-2">

                        {createdBoxes.length > 0 && (
                            <button
                                onClick={() => printBoxesPdf(createdBoxes.map(b => b.id))}
                                className="flex items-center gap-2 text-sm font-bold text-white bg-indigo-600 px-3 py-2 rounded-lg hover:bg-indigo-700 transition shadow-md"
                            >
                                <Printer size={18}/> PDF
                            </button>
                        )}

                        {createdBoxes.length > 0 && (
                            <button
                                onClick={() => downloadBoxesExcel(createdBoxes.map(b => b.id))}
                                className="flex items-center gap-2 text-sm font-bold text-green-700 bg-green-100 px-3 py-2 rounded-lg hover:bg-green-200 transition"
                            >
                                <FileSpreadsheet size={18}/> Excel
                            </button>
                        )}
                    </div>
                </div>

                {createdBoxes.length === 0 && <div className="text-center py-10 bg-white rounded-2xl border-2 border-dashed border-gray-200 text-gray-400">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —ç—Ç–∏–∫–µ—Ç–∫–∏</div>}

                <div className="grid grid-cols-2 gap-4 max-h-[600px] overflow-y-auto pr-2">
                    {createdBoxes.map(box => (
                        <div key={box.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center text-center relative group hover:border-indigo-300 transition">
                            <div className="absolute top-2 left-2 text-[10px] font-mono bg-gray-100 px-1.5 rounded text-gray-500 font-bold">{box.shortCode}</div>
                            <div className="mb-2 bg-white p-1"><QRCode value={box.qrCode} size={80} /></div>
                            <div className="text-xs font-bold text-gray-900 w-full truncate">{box.label}</div>
                            <div className="text-[10px] text-gray-500 mt-1">ID: {box.id}</div>
                            <div className="mt-2 bg-gray-900 text-white text-xs font-bold px-2 py-0.5 rounded">{box.quantity} {box.unit}</div>
                        </div>
                    ))}
                </div>
            </div>
        </div>

        <div className="xl:col-span-4">
            <div className="sticky top-6 flex justify-center">
                <LabelPreview label={label || "–ù–∞–∑–≤–∞–Ω–∏–µ"} project={projectName} batch={batchName} id="###" qrValue={`BOX-FULL`} qty={capacityPerUnit} unit={unit} />
            </div>
        </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseLabels.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
    fetchBoxes, updateBoxesBatch, createBoxesBatch,
    printBoxesPdf, downloadBoxesExcel
} from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import {
    Search, Filter, Printer, Edit, Trash2,
    Plus, CheckSquare, Square, Save, X, Tag, Copy
} from "lucide-react";
import { Modal } from "src/components/Modal/Modal";
import toast from "react-hot-toast";
import { Preloader } from "src/components/common/Preloader";

export const WarehouseLabels: React.FC = () => {

    const [boxes, setBoxes] = useState<InventoryBoxModel[]>([]);
    const [loading, setLoading] = useState(false);
    const [selectedIds, setSelectedIds] = useState<number[]>([]);


    const [search, setSearch] = useState("");
    const [batchFilter, setBatchFilter] = useState("");
    const [page, setPage] = useState(1);
    const [totalCount, setTotalCount] = useState(0);
    const limit = 50;


    const [isCreateOpen, setIsCreateOpen] = useState(false);
    const [isEditOpen, setIsEditOpen] = useState(false);


    const [createForm, setCreateForm] = useState({
        label: "", quantity: 1, count: 1, batchName: "", projectName: ""
    });


    const [editForm, setEditForm] = useState<Partial<InventoryBoxModel>>({});


    const loadData = async () => {
        setLoading(true);
        try {
            const res = await fetchBoxes({
                page, limit, search: search || undefined,
                batchName: batchFilter || undefined
            });
            setBoxes(res.rows);
            setTotalCount(res.count);
        } finally { setLoading(false); }
    };

    useEffect(() => { loadData(); }, [page, search, batchFilter]);


    const toggleSelect = (id: number) => {
        setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
    };

    const toggleSelectAll = () => {
        if (selectedIds.length === boxes.length) setSelectedIds([]);
        else setSelectedIds(boxes.map(b => b.id));
    };

    const handleCreate = async () => {
        if (!createForm.label) return toast.error("–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ");
        try {
            await createBoxesBatch({
                label: createForm.label,
                quantity: createForm.count,
                itemsPerBox: createForm.quantity,
                batchName: createForm.batchName,
                projectName: createForm.projectName,
                unit: "—à—Ç",
                status: "ON_STOCK"
            });
            toast.success(`–°–æ–∑–¥–∞–Ω–æ ${createForm.count} —ç—Ç–∏–∫–µ—Ç–æ–∫`);
            setIsCreateOpen(false);
            loadData();
        } catch (e) { toast.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è"); }
    };

    const handleBulkEdit = async () => {
        if (selectedIds.length === 0) return;
        try {
            await updateBoxesBatch(selectedIds, editForm);
            toast.success("–û–±–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ");
            setIsEditOpen(false);
            setEditForm({});
            setSelectedIds([]);
            loadData();
        } catch (e) { toast.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"); }
    };

    const handlePrint = async () => {
        if (selectedIds.length === 0) return toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∏–∫–µ—Ç–∫–∏");
        await printBoxesPdf(selectedIds);
    };

    return (
        <div className="space-y-4 animate-fade-in">

            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col xl:flex-row justify-between gap-4">
                <div className="flex gap-4 flex-1">
                    <div className="relative flex-1 max-w-md">
                        <Search className="absolute left-3 top-2.5 text-gray-400 w-5 h-5"/>
                        <input
                            value={search} onChange={e => setSearch(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, ID, QR..."
                        />
                    </div>
                    <div className="relative w-64">
                        <Filter className="absolute left-3 top-2.5 text-gray-400 w-5 h-5"/>
                        <input
                            value={batchFilter} onChange={e => setBatchFilter(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –ü–∞—Ä—Ç–∏–∏..."
                        />
                    </div>
                </div>

                <div className="flex gap-2">
                    {selectedIds.length > 0 && (
                        <>
                            <button onClick={() => setIsEditOpen(true)} className="flex items-center gap-2 bg-orange-100 text-orange-700 px-4 py-2 rounded-lg font-bold hover:bg-orange-200 transition">
                                <Edit size={18}/> –ü—Ä–∞–≤–∫–∞ ({selectedIds.length})
                            </button>
                            <button onClick={handlePrint} className="flex items-center gap-2 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg font-bold hover:bg-indigo-200 transition">
                                <Printer size={18}/> –ü–µ—á–∞—Ç—å
                            </button>
                        </>
                    )}
                    <button onClick={() => setIsCreateOpen(true)} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">
                        <Plus size={18}/> –°–æ–∑–¥–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏
                    </button>
                </div>
            </div>


            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                            <tr>
                                <th className="px-4 py-3 w-10">
                                    <button onClick={toggleSelectAll}>
                                        {selectedIds.length > 0 && selectedIds.length === boxes.length
                                            ? <CheckSquare className="text-indigo-600"/>
                                            : <Square className="text-gray-400"/>}
                                    </button>
                                </th>
                                <th className="px-4 py-3">ID / –ö–æ–¥</th>
                                <th className="px-4 py-3">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (Label)</th>
                                <th className="px-4 py-3">–ü–∞—Ä—Ç–∏—è</th>
                                <th className="px-4 py-3">–ü—Ä–æ–µ–∫—Ç</th>
                                <th className="px-4 py-3">–ö–æ–ª-–≤–æ</th>
                                <th className="px-4 py-3">–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {loading ? <tr><td colSpan={7} className="p-10"><Preloader/></td></tr> :
                             boxes.map(box => (
                                <tr key={box.id} className={`hover:bg-indigo-50/50 transition cursor-pointer ${selectedIds.includes(box.id) ? 'bg-indigo-50' : ''}`} onClick={() => toggleSelect(box.id)}>
                                    <td className="px-4 py-3">
                                        {selectedIds.includes(box.id) ? <CheckSquare className="text-indigo-600" size={18}/> : <Square className="text-gray-300" size={18}/>}
                                    </td>
                                    <td className="px-4 py-3 font-mono text-xs text-gray-500">
                                        <div className="font-bold text-gray-800">#{box.id}</div>
                                        {box.shortCode}
                                    </td>
                                    <td className="px-4 py-3 font-medium text-gray-800">{box.label}</td>
                                    <td className="px-4 py-3 text-gray-600">{box.batchName || "‚Äî"}</td>
                                    <td className="px-4 py-3 text-gray-600">{box.projectName || "‚Äî"}</td>
                                    <td className="px-4 py-3 font-bold">{box.quantity} {box.unit}</td>
                                    <td className="px-4 py-3">
                                        <span className={`px-2 py-1 rounded text-xs font-bold ${box.status === 'SCRAP' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                            {box.status}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>

                <div className="p-4 border-t border-gray-200 flex justify-between items-center bg-gray-50">
                    <span className="text-xs text-gray-500">–í—Å–µ–≥–æ: {totalCount}</span>
                    <div className="flex gap-2">
                        <button disabled={page === 1} onClick={() => setPage(p => p - 1)} className="px-3 py-1 border rounded bg-white disabled:opacity-50">–ù–∞–∑–∞–¥</button>
                        <button disabled={boxes.length < limit} onClick={() => setPage(p => p + 1)} className="px-3 py-1 border rounded bg-white disabled:opacity-50">–í–ø–µ—Ä–µ–¥</button>
                    </div>
                </div>
            </div>


            <Modal isOpen={isCreateOpen} onClose={() => setIsCreateOpen(false)}>
                <div className="p-6">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Tag/> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —ç—Ç–∏–∫–µ—Ç–æ–∫</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–ß—Ç–æ –Ω–∞ —ç—Ç–∏–∫–µ—Ç–∫–µ)</label>
                            <input className="w-full p-2 border rounded-lg" value={createForm.label} onChange={e => setCreateForm({...createForm, label: e.target.value})} placeholder="–ù–∞–ø—Ä. –ö–æ—Ä–ø—É—Å v1.0" />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">–ö–æ–ª-–≤–æ –≤ 1 –∫–æ—Ä–æ–±–∫–µ</label>
                                <input type="number" className="w-full p-2 border rounded-lg" value={createForm.quantity} onChange={e => setCreateForm({...createForm, quantity: Number(e.target.value)})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">–°–∫–æ–ª—å–∫–æ –Ω–∞–∫–ª–µ–µ–∫ —Å–æ–∑–¥–∞—Ç—å</label>
                                <input type="number" className="w-full p-2 border rounded-lg bg-indigo-50 font-bold" value={createForm.count} onChange={e => setCreateForm({...createForm, count: Number(e.target.value)})} />
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <input className="p-2 border rounded-lg text-sm" placeholder="–ü–∞—Ä—Ç–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value={createForm.batchName} onChange={e => setCreateForm({...createForm, batchName: e.target.value})} />
                            <input className="p-2 border rounded-lg text-sm" placeholder="–ü—Ä–æ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value={createForm.projectName} onChange={e => setCreateForm({...createForm, projectName: e.target.value})} />
                        </div>
                        <button onClick={handleCreate} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </Modal>


            <Modal isOpen={isEditOpen} onClose={() => setIsEditOpen(false)}>
                <div className="p-6">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-orange-600"><Edit/> –ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–∞–≤–∫–∞ ({selectedIds.length})</h2>
                    <p className="text-sm text-gray-500 mb-4">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¢–û–õ–¨–ö–û —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ—Ä–æ–±–æ–∫.</p>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">–ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input className="w-full p-2 border rounded-lg" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å" onChange={e => setEditForm({...editForm, label: e.target.value})} />
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">–ü–∞—Ä—Ç–∏—è</label>
                            <input className="w-full p-2 border rounded-lg" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏" onChange={e => setEditForm({...editForm, batchName: e.target.value})} />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                                <input type="number" className="w-full p-2 border rounded-lg" placeholder="–ù–µ –º–µ–Ω—è—Ç—å" onChange={e => setEditForm({...editForm, quantity: e.target.value ? Number(e.target.value) : undefined})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">–°—Ç–∞—Ç—É—Å</label>
                                <select className="w-full p-2 border rounded-lg" onChange={e => setEditForm({...editForm, status: e.target.value})}>
                                    <option value="">(–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)</option>
                                    <option value="ON_STOCK">–ù–∞ —Å–∫–ª–∞–¥</option>
                                    <option value="SCRAP">–ë–†–ê–ö (SCRAP)</option>
                                    <option value="IN_WORK">–í —Ä–∞–±–æ—Ç—É</option>
                                </select>
                            </div>
                        </div>

                        <button onClick={handleBulkEdit} className="w-full py-3 bg-orange-600 text-white font-bold rounded-xl hover:bg-orange-700">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseMoves.tsx
================================================================================

import React, { useState } from "react";
import { Search, Loader2, AlertCircle, MapPin, ArrowRightLeft, Ruler, Trash2, ShoppingCart, Save } from "lucide-react";
import { fetchBoxById, fetchBoxByQr, moveBoxesBatch } from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import { SectionModel } from "src/store/StructureStore";

interface Props { sections: SectionModel[]; }

type CartItem = {
    box: InventoryBoxModel;
    operation: string;
    toSectionId: number | null;
    statusAfter: string;
    deltaQty: number;
    goodQty: number | null;
    scrapQty: number | null;
    comment: string;
};

export const WarehouseMoves: React.FC<Props> = ({ sections }) => {
  const [scanCode, setScanCode] = useState("");
  const [loading, setLoading] = useState(false);

  const [currentBox, setCurrentBox] = useState<InventoryBoxModel | null>(null);


  const [opType, setOpType] = useState<"MOVE" | "CONSUME">("MOVE");
  const [toSectionId, setToSectionId] = useState<number | "">("");
  const [statusAfter, setStatusAfter] = useState("");
  const [consumeAmount, setConsumeAmount] = useState<number | "">("");
  const [comment, setComment] = useState("");

  const [cart, setCart] = useState<CartItem[]>([]);
  const [docNumber, setDocNumber] = useState("");

  const handleScan = async () => {
      if (!scanCode) return;
      setLoading(true);
      setCurrentBox(null);
      try {
          let res;
          if (/^\d+$/.test(scanCode)) res = await fetchBoxById(Number(scanCode));
          else res = await fetchBoxByQr(scanCode);

          setCurrentBox(res.box);

          setOpType("MOVE");
          setToSectionId(res.box.currentSectionId || "");
          setStatusAfter(res.box.status);
          setConsumeAmount("");
          setComment("");
      } catch (e) { alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ"); }
      finally { setLoading(false); setScanCode(""); }
  };

  const addToCart = () => {
      if (!currentBox) return;

      let delta = 0;
      let op = opType;

      if (opType === "CONSUME") {
          const amount = Number(consumeAmount);
          if (!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è");
          if (amount > currentBox.quantity) return alert(`–ù–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å (${currentBox.quantity})`);

          delta = -amount;
      }

      if (cart.some(i => i.box.id === currentBox.id)) {
          alert("–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ!");
          return;
      }

      const item: CartItem = {
          box: currentBox,
          operation: op,
          toSectionId: toSectionId ? Number(toSectionId) : null,
          statusAfter: statusAfter,
          deltaQty: delta,
          goodQty: null,
          scrapQty: null,
          comment: comment
      };

      setCart([item, ...cart]);
      setCurrentBox(null);
  };

  const commitBatch = async () => {
      if (cart.length === 0) return;
      if (!docNumber.trim()) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞/–Ω–∞–∫–ª–∞–¥–Ω–æ–π –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏!");

      setLoading(true);
      try {
          await moveBoxesBatch({
              movements: cart.map(c => ({
                  boxId: c.box.id,
                  operation: c.operation,
                  toSectionId: c.toSectionId,
                  statusAfter: c.statusAfter,
                  deltaQty: c.deltaQty,
                  goodQty: c.goodQty || undefined,
                  scrapQty: c.scrapQty || undefined,
                  comment: c.comment
              })),
              documentData: {
                  createNew: true,
                  number: docNumber,
                  type: "MOVE_BATCH",
                  comment: `–ü–∞–∫–µ—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (${cart.length} –ø–æ–∑.)`
              }
          });
          setCart([]);
          setDocNumber("");
          alert("–û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞! –°–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç.");
      } catch (e: any) { alert("–û—à–∏–±–∫–∞: " + e.message); }
      finally { setLoading(false); }
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">


        <div className="lg:col-span-5 space-y-4">

             <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <label className="block text-sm font-bold text-gray-700 mb-2">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</label>
                <div className="flex gap-2">
                    <input
                        value={scanCode} onChange={e => setScanCode(e.target.value)}
                        onKeyDown={e => e.key === 'Enter' && handleScan()}
                        className="w-full p-3 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 text-lg outline-none"
                        placeholder="QR –∏–ª–∏ –∫–æ–¥..."
                        autoFocus
                    />
                    <button onClick={handleScan} disabled={loading} className="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition">
                        {loading ? <Loader2 className="animate-spin"/> : <Search/>}
                    </button>
                </div>
             </div>


             {currentBox ? (
                 <div className="bg-white rounded-xl shadow-lg border border-indigo-200 overflow-hidden animate-fade-in">
                     <div className="bg-gray-900 p-4 text-white">
                         <div className="flex justify-between items-start">
                            <div>
                                <div className="text-xs text-gray-400 uppercase font-bold">–¢–µ–∫—É—â–∞—è –∫–æ—Ä–æ–±–∫–∞</div>
                                <h3 className="font-bold text-lg leading-tight mt-1">{currentBox.label}</h3>
                            </div>
                            <div className="text-right">
                                <span className="bg-gray-700 px-2 py-1 rounded text-xs font-mono">{currentBox.shortCode}</span>
                            </div>
                         </div>
                         <div className="mt-2 text-sm opacity-80 flex gap-2 items-center">
                             <AlertCircle size={14}/>
                             <span>–û—Å—Ç–∞—Ç–æ–∫: <b>{currentBox.quantity} {currentBox.unit}</b></span>
                         </div>
                     </div>

                     <div className="p-4 space-y-4">

                         <div className="flex gap-2 bg-gray-100 p-1 rounded-lg">
                             <button onClick={() => setOpType("MOVE")} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${opType === 'MOVE' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</button>
                             <button onClick={() => setOpType("CONSUME")} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${opType === 'CONSUME' ? 'bg-white shadow text-orange-600' : 'text-gray-500'}`}>–†–∞—Å—Ö–æ–¥ / –°–ø–∏—Å–∞–Ω–∏–µ</button>
                         </div>


                         {opType === 'CONSUME' ? (
                             <div className="bg-orange-50 p-3 rounded-lg border border-orange-200">
                                 <label className="text-xs font-bold text-orange-800 uppercase">–°–∫–æ–ª—å–∫–æ –≤–∑—è—Ç—å?</label>
                                 <div className="flex gap-2 mt-1">
                                    <input type="number" className="flex-1 p-2 text-xl font-bold border-orange-300 rounded outline-none" value={consumeAmount} onChange={e => setConsumeAmount(Number(e.target.value))} autoFocus />
                                    <div className="flex items-center text-orange-700 font-bold px-2">{currentBox.unit}</div>
                                 </div>
                             </div>
                         ) : (
                             <div className="grid grid-cols-2 gap-3">
                                 <div>
                                     <label className="text-[10px] uppercase font-bold text-gray-500">–ö—É–¥–∞</label>
                                     <select className="w-full p-2 border rounded text-sm bg-white outline-none" value={toSectionId} onChange={e => setToSectionId(e.target.value)}>
                                         <option value="">(–¢–µ–∫—É—â–µ–µ)</option>
                                         {sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                     </select>
                                 </div>
                                 <div>
                                     <label className="text-[10px] uppercase font-bold text-gray-500">–°—Ç–∞—Ç—É—Å</label>
                                     <select className="w-full p-2 border rounded text-sm bg-white outline-none" value={statusAfter} onChange={e => setStatusAfter(e.target.value)}>
                                         <option value="ON_STOCK">–ù–∞ —Å–∫–ª–∞–¥–µ</option>
                                         <option value="IN_WORK">–í —Ä–∞–±–æ—Ç–µ</option>
                                         <option value="DONE">–ì–æ—Ç–æ–≤–æ</option>
                                         <option value="SCRAP">–ë—Ä–∞–∫</option>
                                     </select>
                                 </div>
                             </div>
                         )}

                         <input className="w-full p-2 border rounded text-sm outline-none focus:border-indigo-500" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." value={comment} onChange={e => setComment(e.target.value)} />

                         <button onClick={addToCart} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-md flex justify-center items-center gap-2 transition">
                             <ShoppingCart size={18}/> –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫
                         </button>
                     </div>
                 </div>
             ) : (
                <div className="text-center p-10 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed min-h-[300px] flex flex-col items-center justify-center">
                    <ArrowRightLeft className="mb-2 opacity-20" size={40}/>
                    <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ—Ä–æ–±–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</p>
                </div>
             )}
        </div>


        <div className="lg:col-span-7 h-[calc(100vh-140px)] flex flex-col">
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 h-full flex flex-col overflow-hidden">
                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h3 className="font-bold text-gray-700 flex items-center gap-2"><ShoppingCart size={18}/> –û–ø–µ—Ä–∞—Ü–∏–∏ –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é ({cart.length})</h3>
                    {cart.length > 0 && <button onClick={() => setCart([])} className="text-xs text-red-500 hover:underline">–û—á–∏—Å—Ç–∏—Ç—å</button>}
                </div>

                <div className="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50/30">
                    {cart.length === 0 && <div className="text-center py-20 text-gray-300">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>}
                    {cart.map((item, idx) => (
                        <div key={idx} className="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm hover:shadow-md transition group">
                            <div className="flex-1">
                                <div className="font-bold text-sm text-gray-800">{item.box.label} <span className="text-gray-400 font-normal text-xs">#{item.box.id}</span></div>
                                <div className="text-xs text-gray-500 flex flex-wrap gap-2 mt-1 items-center">
                                    {item.deltaQty !== 0
                                        ? <span className="bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded font-bold">–†–ê–°–•–û–î: {Math.abs(item.deltaQty)} {item.box.unit}</span>
                                        : <span className="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold">–ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï</span>
                                    }
                                    {item.toSectionId && <span className="flex items-center gap-1"><MapPin size={10}/> –°–µ–∫—Ü–∏—è #{item.toSectionId}</span>}
                                    {item.statusAfter !== item.box.status && <span>–°—Ç–∞—Ç—É—Å: {item.statusAfter}</span>}
                                    {item.comment && <span className="italic text-gray-400">"{item.comment}"</span>}
                                </div>
                            </div>
                            <button onClick={() => setCart(cart.filter((_, i) => i !== idx))} className="p-2 text-gray-300 hover:text-red-500 transition">
                                <Trash2 size={16}/>
                            </button>
                        </div>
                    ))}
                </div>

                <div className="p-4 border-t bg-indigo-50">
                    <label className="text-xs font-bold text-indigo-800 uppercase mb-1 block">–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ / –ù–∞–∫–ª–∞–¥–Ω–æ–π</label>
                    <div className="flex gap-2">
                        <input
                            value={docNumber} onChange={e => setDocNumber(e.target.value)}
                            className="flex-1 p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="–ù–∞–ø—Ä: –¢–ù-2025-10-15"
                        />
                        <button onClick={commitBatch} disabled={loading || cart.length === 0} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow transition flex items-center gap-2 disabled:opacity-50">
                            {loading ? <Loader2 className="animate-spin"/> : <Save size={18}/>} –ü—Ä–æ–≤–µ—Å—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehousePrintHistory.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchPrintHistory } from "src/api/warehouseApi";
import {
    Search, Calendar, Printer, User, History,
    ArrowRight, Tv, Tag, Info, FileText
} from "lucide-react";
import { formatDateTime } from "../utils";
import { Modal } from "src/components/Modal/Modal";
import clsx from "clsx";

export const WarehousePrintHistory: React.FC = () => {
    const [data, setData] = useState<any[]>([]);
    const [totalCount, setTotalCount] = useState(0);
    const [loading, setLoading] = useState(false);


    const [page, setPage] = useState(1);
    const [search, setSearch] = useState("");
    const [template, setTemplate] = useState("");
    const [dateFrom, setDateFrom] = useState("");


    const [selectedItem, setSelectedItem] = useState<any | null>(null);

    const loadData = async () => {
        setLoading(true);
        try {
            const res = await fetchPrintHistory({
                page,
                limit: 20,
                search,
                template,
                dateFrom
            });
            setData(res.rows);
            setTotalCount(res.count);
        } catch (e) {
            console.error(e);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        const timer = setTimeout(loadData, 500);
        return () => clearTimeout(timer);
    }, [page, search, template, dateFrom]);


    const getTemplateIcon = (type: string) => {
        if (type === "VIDEO_KIT") return <Tv size={16} className="text-indigo-600"/>;
        return <Tag size={16} className="text-gray-600"/>;
    };

    return (
        <div className="space-y-6 animate-fade-in">

            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between gap-4">
                <div className="flex items-center gap-3 text-gray-700 font-bold text-lg">
                    <History className="text-indigo-600" /> –ò—Å—Ç–æ—Ä–∏—è –ø–µ—á–∞—Ç–∏
                </div>

                <div className="flex flex-wrap gap-3 flex-1 justify-end">
                    <div className="relative w-full md:w-64">
                        <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4" />
                        <input
                            value={search} onChange={e => setSearch(e.target.value)}
                            className="w-full pl-9 pr-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, ID –∏–ª–∏ –ö–æ–¥..."
                        />
                    </div>

                    <select
                        value={template} onChange={e => setTemplate(e.target.value)}
                        className="p-2 border rounded-lg text-sm bg-gray-50 font-medium"
                    >
                        <option value="">–í—Å–µ —à–∞–±–ª–æ–Ω—ã</option>
                        <option value="VIDEO_KIT">–í–∏–¥–µ–æ–∫–æ–º–ø–ª–µ–∫—Ç</option>
                        <option value="SIMPLE">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è</option>
                    </select>

                    <input
                        type="date"
                        value={dateFrom} onChange={e => setDateFrom(e.target.value)}
                        className="p-2 border rounded-lg text-sm text-gray-600"
                    />
                </div>
            </div>


            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                        <tr>
                            <th className="px-6 py-4">–î–∞—Ç–∞ / –í—Ä–µ–º—è</th>
                            <th className="px-6 py-4">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            <th className="px-6 py-4">–®–∞–±–ª–æ–Ω</th>
                            <th className="px-6 py-4">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                            <th className="px-6 py-4">–î–∏–∞–ø–∞–∑–æ–Ω (ID)</th>
                            <th className="px-6 py-4 text-center">–¢–∏—Ä–∞–∂</th>
                            <th className="px-6 py-4 text-right">–ò–Ω—Ñ–æ</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100 text-sm">
                        {loading ? (
                            <tr><td colSpan={7} className="p-8 text-center text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        ) : data.length === 0 ? (
                            <tr><td colSpan={7} className="p-8 text-center text-gray-400">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>
                        ) : (
                            data.map(item => (
                                <tr key={item.id} className="hover:bg-slate-50 transition group">
                                    <td className="px-6 py-4 text-gray-600 whitespace-nowrap">
                                        {formatDateTime(item.createdAt)}
                                    </td>
                                    <td className="px-6 py-4">
                                        <div className="flex items-center gap-2">
                                            <div className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">
                                                {item.createdBy?.name?.[0] || <User size={12}/>}
                                            </div>
                                            <span className="font-medium text-gray-800">
                                                {item.createdBy ? `${item.createdBy.surname} ${item.createdBy.name}` : "–°–∏—Å—Ç–µ–º–∞"}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4">
                                        <div className="flex items-center gap-2">
                                            {getTemplateIcon(item.template)}
                                            <span className={clsx("text-xs font-bold px-2 py-0.5 rounded", item.template === "VIDEO_KIT" ? "bg-indigo-50 text-indigo-700" : "bg-gray-100 text-gray-700")}>
                                                {item.template === "VIDEO_KIT" ? "–í–∏–¥–µ–æ" : "–ü—Ä–æ—Å—Ç–∞—è"}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 font-bold text-gray-800 max-w-xs truncate" title={item.labelName}>
                                        {item.labelName}
                                    </td>
                                    <td className="px-6 py-4 font-mono text-xs text-gray-600">
                                        {item.quantity > 1 ? (
                                            <div className="flex items-center gap-1">
                                                {item.startCode} <ArrowRight size={10} className="text-gray-400"/> {item.endCode}
                                            </div>
                                        ) : (
                                            item.startCode
                                        )}
                                    </td>
                                    <td className="px-6 py-4 text-center">
                                        <span className="font-bold text-lg">{item.quantity}</span>
                                        <span className="text-xs text-gray-400 ml-1">—à—Ç</span>
                                    </td>
                                    <td className="px-6 py-4 text-right">
                                        <button
                                            onClick={() => setSelectedItem(item)}
                                            className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition"
                                        >
                                            <Info size={18}/>
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>


                <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center text-xs text-gray-500">
                    <span>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {totalCount}</span>
                    <div className="flex gap-2">
                        <button disabled={page === 1} onClick={() => setPage(p => p - 1)} className="px-3 py-1 bg-white border rounded hover:bg-gray-100 disabled:opacity-50">–ù–∞–∑–∞–¥</button>
                        <span className="py-1 px-2">–°—Ç—Ä. {page}</span>
                        <button disabled={data.length < 20} onClick={() => setPage(p => p + 1)} className="px-3 py-1 bg-white border rounded hover:bg-gray-100 disabled:opacity-50">–í–ø–µ—Ä–µ–¥</button>
                    </div>
                </div>
            </div>


            <Modal isOpen={!!selectedItem} onClose={() => setSelectedItem(null)}>
                {selectedItem && (
                    <div className="p-6 max-w-lg w-full">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-indigo-50 rounded-full text-indigo-600">
                                <Printer size={24}/>
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-gray-800">–î–µ—Ç–∞–ª–∏ –ø–µ—á–∞—Ç–∏</h3>
                                <p className="text-xs text-gray-500">ID –æ–ø–µ—Ä–∞—Ü–∏–∏: {selectedItem.id}</p>
                            </div>
                        </div>

                        <div className="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm">
                            <div className="flex justify-between">
                                <span className="text-gray-500">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span>
                                <span className="font-bold">{selectedItem.labelName}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">–î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏:</span>
                                <span>{formatDateTime(selectedItem.createdAt)}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">–¢–∏—Ä–∞–∂:</span>
                                <span className="font-bold">{selectedItem.quantity} —à—Ç.</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">–†–∞–∑–º–µ—Ä –±—É–º–∞–≥–∏:</span>
                                <span>{selectedItem.params?.widthMm} x {selectedItem.params?.heightMm} –º–º</span>
                            </div>

                            {selectedItem.params?.contract && (
                                <div className="border-t border-gray-200 pt-2 mt-2">
                                    <span className="text-gray-500 block mb-1">–î–æ–≥–æ–≤–æ—Ä:</span>
                                    <p className="bg-white p-2 rounded border border-gray-200 text-xs text-gray-700 italic">
                                        {selectedItem.params.contract}
                                    </p>
                                </div>
                            )}


                            <div className="border-t border-gray-200 pt-2 mt-2">
                                <span className="text-gray-500 block mb-1 flex items-center gap-1"><FileText size={12}/> –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON):</span>
                                <pre className="bg-slate-800 text-green-400 p-2 rounded text-[10px] overflow-auto max-h-32">
                                    {JSON.stringify(selectedItem.params, null, 2)}
                                </pre>
                            </div>
                        </div>

                        <button
                            onClick={() => setSelectedItem(null)}
                            className="w-full mt-6 py-3 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition"
                        >
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                )}
            </Modal>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseSettings.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchStockBalance, fetchAllLimits, saveLimit } from "src/api/warehouseApi";
import { InventoryLimitModel, StockBalanceItem } from "src/types/WarehouseModels";
import { Settings, Save, Search, AlertTriangle } from "lucide-react";
import toast from "react-hot-toast";

export const WarehouseSettings: React.FC = () => {
    const [items, setItems] = useState<any[]>([]);
    const [search, setSearch] = useState("");
    const [loading, setLoading] = useState(false);

    const loadData = async () => {
        setLoading(true);
        try {
            const [balance, limits] = await Promise.all([
                fetchStockBalance(),
                fetchAllLimits()
            ]);


            const limitsMap = new Map();
            limits.forEach(l => limitsMap.set(l.label, l.minQuantity));

            const uniqueItems = new Map();

            balance.forEach(b => {
                uniqueItems.set(b.label, {
                    label: b.label,
                    originType: b.originType,
                    originId: b.originId,
                    current: Number(b.totalQuantity),
                    min: limitsMap.get(b.label) || 0
                });
            });

            limits.forEach(l => {
                if (!uniqueItems.has(l.label)) {
                    uniqueItems.set(l.label, {
                        label: l.label,
                        originType: l.originType,
                        originId: l.originId,
                        current: 0,
                        min: l.minQuantity
                    });
                }
            });

            setItems(Array.from(uniqueItems.values()));

        } catch (e) {
            console.error(e);
            toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => { loadData(); }, []);

    const handleSave = async (item: any, newMin: string) => {
        const val = parseInt(newMin);
        if (isNaN(val)) return;
        if (val === item.min) return;

        try {
            await saveLimit({
                label: item.label,
                min: val,
                originType: item.originType,
                originId: item.originId
            });
            toast.success(`–õ–∏–º–∏—Ç –¥–ª—è "${item.label}" –æ–±–Ω–æ–≤–ª–µ–Ω`);
            setItems(prev => prev.map(i => i.label === item.label ? { ...i, min: val } : i));
        } catch (e) {
            toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å");
        }
    };

    const filteredItems = items.filter(i => i.label.toLowerCase().includes(search.toLowerCase()));

    return (
        <div className="animate-fade-in max-w-4xl mx-auto">
            <div className="flex justify-between items-end mb-6">
                <div>
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <Settings className="text-indigo-600"/> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–ª–∞–¥–∞
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                </div>

                <div className="relative">
                    <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4"/>
                    <input
                        value={search} onChange={e => setSearch(e.target.value)}
                        className="pl-9 pr-4 py-2 border rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
                    />
                </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table className="w-full text-left">
                    <thead className="bg-gray-50 text-xs text-gray-500 uppercase font-semibold">
                        <tr>
                            <th className="px-6 py-4">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                            <th className="px-6 py-4 text-center">–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</th>
                            <th className="px-6 py-4 text-center w-48">–ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫</th>
                            <th className="px-6 py-4">–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {loading && <tr><td colSpan={4} className="p-8 text-center text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>}

                        {!loading && filteredItems.map((item, idx) => (
                            <tr key={idx} className="hover:bg-gray-50 transition">
                                <td className="px-6 py-4 font-medium text-gray-800">{item.label}</td>
                                <td className="px-6 py-4 text-center text-gray-600 font-mono">{item.current}</td>
                                <td className="px-6 py-4 text-center">
                                    <input
                                        type="number"
                                        defaultValue={item.min}
                                        onBlur={(e) => handleSave(item, e.target.value)}
                                        className="w-24 p-2 text-center border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition"
                                    />
                                </td>
                                <td className="px-6 py-4">
                                    {item.min > 0 && item.current < item.min ? (
                                        <span className="flex items-center gap-1 text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded-full w-max">
                                            <AlertTriangle size={12}/> –î–µ—Ñ–∏—Ü–∏—Ç (-{item.min - item.current})
                                        </span>
                                    ) : (
                                        item.min > 0 && <span className="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-full">OK</span>
                                    )}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                {!loading && filteredItems.length === 0 && (
                    <div className="p-8 text-center text-gray-400">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                )}
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/utils.ts
================================================================================

export const formatDateTime = (iso: string | null | undefined) => {
  if (!iso) return "‚Äî";
  return new Date(iso).toLocaleString("ru-RU", {
    day: "2-digit", month: "2-digit", hour: "2-digit", minute: "2-digit"
  });
};

export const getStatusBadge = (status: string) => {
  switch (status) {
    case "ON_STOCK": return "bg-emerald-100 text-emerald-700 border-emerald-200";
    case "IN_WORK": return "bg-blue-100 text-blue-700 border-blue-200";
    case "DONE": return "bg-purple-100 text-purple-700 border-purple-200";
    case "SCRAP": return "bg-red-100 text-red-700 border-red-200";
    default: return "bg-gray-100 text-gray-700 border-gray-200";
  }
};


export const calculateBatch = (total: number, capacity: number) => {

    const safeTotal = Math.max(0, Number(total) || 0);


    const safeCapacity = Math.max(1, Number(capacity) || 1);

    if (safeTotal === 0) {
        return { fullUnits: 0, remainder: 0, totalUnits: 0 };
    }

    const fullUnits = Math.floor(safeTotal / safeCapacity);
    const remainder = safeTotal % safeCapacity;


    const totalUnits = fullUnits + (remainder > 0 ? 1 : 0);

    return { fullUnits, remainder, totalUnits };
};

================================================================================
FILE: QMS-Client-main/src/pages/beryll/ComponentInventoryPage.tsx
================================================================================



import React, { useState, useEffect, useCallback } from "react";
import {
  Package,
  Search,
  Plus,
  Filter,
  RefreshCw,
  HardDrive,
  Cpu,
  MemoryStick,
  Server,
  Zap,
  Network,
  AlertCircle,
  ChevronRight,
  Download,
  Upload,
  Clock
} from "lucide-react";
import toast from "react-hot-toast";
import {
  inventoryApi,
  ComponentInventory,
  ComponentCatalog,
  InventoryStatus,
  ComponentCondition
} from "../../api/beryllExtendedApi";

const STATUS_COLORS: Record<InventoryStatus, string> = {
  AVAILABLE: "bg-green-100 text-green-800",
  RESERVED: "bg-yellow-100 text-yellow-800",
  IN_USE: "bg-blue-100 text-blue-800",
  IN_REPAIR: "bg-purple-100 text-purple-800",
  DEFECTIVE: "bg-red-100 text-red-800",
  SCRAPPED: "bg-gray-100 text-gray-800",
  RETURNED: "bg-cyan-100 text-cyan-800"
};

const STATUS_LABELS: Record<InventoryStatus, string> = {
  AVAILABLE: "–î–æ—Å—Ç—É–ø–µ–Ω",
  RESERVED: "–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω",
  IN_USE: "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω",
  IN_REPAIR: "–í —Ä–µ–º–æ–Ω—Ç–µ",
  DEFECTIVE: "–î–µ—Ñ–µ–∫—Ç–Ω—ã–π",
  SCRAPPED: "–°–ø–∏—Å–∞–Ω",
  RETURNED: "–í–æ–∑–≤—Ä–∞—â—ë–Ω"
};

const CONDITION_LABELS: Record<ComponentCondition, string> = {
  NEW: "–ù–æ–≤—ã–π",
  REFURBISHED: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π",
  USED: "–ë/–£",
  DAMAGED: "–ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π"
};

const TYPE_ICONS: Record<string, React.ComponentType<any>> = {
  HDD: HardDrive,
  SSD: HardDrive,
  RAM: MemoryStick,
  CPU: Cpu,
  MOTHERBOARD: Server,
  PSU: Zap,
  NIC: Network
};

const ComponentInventoryPage: React.FC = () => {
  const [components, setComponents] = useState<ComponentInventory[]>([]);
  const [catalog, setCatalog] = useState<ComponentCatalog[]>([]);
  const [loading, setLoading] = useState(true);
  const [totalCount, setTotalCount] = useState(0);


  const [search, setSearch] = useState("");
  const [typeFilter, setTypeFilter] = useState("");
  const [statusFilter, setStatusFilter] = useState<InventoryStatus | "">("");
  const [conditionFilter, setConditionFilter] = useState<ComponentCondition | "">("");
  const [showWarrantyExpiring, setShowWarrantyExpiring] = useState(false);


  const [page, setPage] = useState(0);
  const [limit] = useState(25);


  const [showAddModal, setShowAddModal] = useState(false);
  const [selectedComponent, setSelectedComponent] = useState<ComponentInventory | null>(null);


  const [stats, setStats] = useState<any>(null);


  const componentTypes = [...new Set(catalog.map(c => c.type))].sort();


  const loadComponents = useCallback(async () => {
    setLoading(true);
    try {
      const response = await inventoryApi.getAll({
        search: search || undefined,
        type: typeFilter || undefined,
        status: statusFilter || undefined,
        condition: conditionFilter || undefined,
        warrantyExpired: showWarrantyExpiring || undefined,
        limit,
        offset: page * limit
      });

      setComponents(response.data.rows);
      setTotalCount(response.data.count);
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
    } finally {
      setLoading(false);
    }
  }, [search, typeFilter, statusFilter, conditionFilter, showWarrantyExpiring, page, limit]);

  const loadCatalog = async () => {
    try {
      const response = await inventoryApi.getCatalog();
      setCatalog(response.data);
    } catch (error) {
      console.error("Error loading catalog:", error);
    }
  };

  const loadStats = async () => {
    try {
      const response = await inventoryApi.getStats();
      setStats(response.data);
    } catch (error) {
      console.error("Error loading stats:", error);
    }
  };

  useEffect(() => {
    loadCatalog();
    loadStats();
  }, []);

  useEffect(() => {
    loadComponents();
  }, [loadComponents]);


  const resetFilters = () => {
    setSearch("");
    setTypeFilter("");
    setStatusFilter("");
    setConditionFilter("");
    setShowWarrantyExpiring(false);
    setPage(0);
  };


  const formatDate = (dateStr: string | null): string => {
    if (!dateStr) return "‚Äî";
    return new Date(dateStr).toLocaleDateString("ru-RU");
  };

  const isWarrantyExpiring = (comp: ComponentInventory): boolean => {
    if (!comp.warrantyExpires) return false;
    const expiryDate = new Date(comp.warrantyExpires);
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
    return expiryDate <= thirtyDaysFromNow && expiryDate > new Date();
  };

  const isWarrantyExpired = (comp: ComponentInventory): boolean => {
    if (!comp.warrantyExpires) return false;
    return new Date(comp.warrantyExpires) < new Date();
  };

  const getTypeIcon = (type: string) => {
    const Icon = TYPE_ICONS[type] || Package;
    return <Icon className="w-4 h-4" />;
  };

  return (
    <div className="p-6 max-w-7xl mx-auto">

      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <Package className="w-7 h-7 text-blue-500" />
            –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
          </h1>
          <p className="text-gray-500 mt-1">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–Ω—ã–º–∏ —á–∞—Å—Ç—è–º–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤
          </p>
        </div>

        <div className="flex gap-2">
          <button
            onClick={() => setShowAddModal(true)}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            <Plus className="w-5 h-5" />
            –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>


      {stats && (
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–í—Å–µ–≥–æ</div>
            <div className="text-2xl font-bold text-gray-900">{stats.totals?.total || 0}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–î–æ—Å—Ç—É–ø–Ω–æ</div>
            <div className="text-2xl font-bold text-green-600">{stats.totals?.available || 0}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
            <div className="text-2xl font-bold text-blue-600">{stats.totals?.inUse || 0}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–í —Ä–µ–º–æ–Ω—Ç–µ</div>
            <div className="text-2xl font-bold text-purple-600">{stats.totals?.inRepair || 0}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–î–µ—Ñ–µ–∫—Ç–Ω—ã–µ</div>
            <div className="text-2xl font-bold text-red-600">{stats.totals?.defective || 0}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500 flex items-center gap-1">
              <Clock className="w-4 h-4" />
              –ì–∞—Ä–∞–Ω—Ç–∏—è –∏—Å—Ç–µ–∫–∞–µ—Ç
            </div>
            <div className="text-2xl font-bold text-orange-600">{stats.warrantyExpiringSoon || 0}</div>
          </div>
        </div>
      )}


      <div className="bg-white rounded-lg shadow p-4 mb-6">
        <div className="flex flex-wrap items-center gap-4">
          <div className="flex-1 min-w-[200px]">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input
                type="text"
                placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É, –º–æ–¥–µ–ª–∏..."
                value={search}
                onChange={(e) => { setSearch(e.target.value); setPage(0); }}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>

          <select
            value={typeFilter}
            onChange={(e) => { setTypeFilter(e.target.value); setPage(0); }}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
            {componentTypes.map((type) => (
              <option key={type} value={type}>{type}</option>
            ))}
          </select>

          <select
            value={statusFilter}
            onChange={(e) => { setStatusFilter(e.target.value as InventoryStatus | ""); setPage(0); }}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            {Object.entries(STATUS_LABELS).map(([value, label]) => (
              <option key={value} value={value}>{label}</option>
            ))}
          </select>

          <select
            value={conditionFilter}
            onChange={(e) => { setConditionFilter(e.target.value as ComponentCondition | ""); setPage(0); }}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="">–í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è</option>
            {Object.entries(CONDITION_LABELS).map(([value, label]) => (
              <option key={value} value={value}>{label}</option>
            ))}
          </select>

          <label className="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              checked={showWarrantyExpiring}
              onChange={(e) => { setShowWarrantyExpiring(e.target.checked); setPage(0); }}
              className="w-4 h-4 text-orange-600 rounded"
            />
            <span className="text-sm text-gray-700">–ì–∞—Ä–∞–Ω—Ç–∏—è –∏—Å—Ç–µ–∫–∞–µ—Ç</span>
          </label>

          <button
            onClick={resetFilters}
            className="px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <Filter className="w-5 h-5" />
          </button>

          <button
            onClick={loadComponents}
            disabled={loading}
            className="px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <RefreshCw className={`w-5 h-5 ${loading ? "animate-spin" : ""}`} />
          </button>
        </div>
      </div>


      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –¢–∏–ø
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                S/N (–Ø–¥—Ä–æ)
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                S/N (–ü—Ä–æ–∏–∑–≤.)
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –ú–æ–¥–µ–ª—å
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –°—Ç–∞—Ç—É—Å
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –°–æ—Å—Ç–æ—è–Ω–∏–µ
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –õ–æ–∫–∞—Ü–∏—è
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –ì–∞—Ä–∞–Ω—Ç–∏—è
              </th>
              <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {loading ? (
              <tr>
                <td colSpan={9} className="px-4 py-8 text-center text-gray-500">
                  <RefreshCw className="w-6 h-6 animate-spin mx-auto mb-2" />
                  –ó–∞–≥—Ä—É–∑–∫–∞...
                </td>
              </tr>
            ) : components.length === 0 ? (
              <tr>
                <td colSpan={9} className="px-4 py-8 text-center text-gray-500">
                  –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </td>
              </tr>
            ) : (
              components.map((comp) => (
                <tr
                  key={comp.id}
                  className={`hover:bg-gray-50 cursor-pointer ${
                    isWarrantyExpired(comp) ? "bg-red-50" :
                    isWarrantyExpiring(comp) ? "bg-orange-50" : ""
                  }`}
                  onClick={() => setSelectedComponent(comp)}
                >
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      {getTypeIcon(comp.type)}
                      <span className="font-medium">{comp.type}</span>
                    </div>
                  </td>
                  <td className="px-4 py-3 font-mono text-sm">
                    {comp.serialNumberYadro || "‚Äî"}
                  </td>
                  <td className="px-4 py-3 font-mono text-sm">
                    {comp.serialNumber}
                  </td>
                  <td className="px-4 py-3">
                    <div className="text-sm">
                      {comp.manufacturer && <span className="text-gray-500">{comp.manufacturer} </span>}
                      {comp.model || "‚Äî"}
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${STATUS_COLORS[comp.status]}`}>
                      {STATUS_LABELS[comp.status]}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-500">
                    {CONDITION_LABELS[comp.condition]}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-500">
                    {comp.location || "‚Äî"}
                  </td>
                  <td className="px-4 py-3">
                    {comp.warrantyExpires ? (
                      <div className={`flex items-center gap-1 text-sm ${
                        isWarrantyExpired(comp) ? "text-red-600" :
                        isWarrantyExpiring(comp) ? "text-orange-600" : "text-gray-500"
                      }`}>
                        {(isWarrantyExpired(comp) || isWarrantyExpiring(comp)) && (
                          <AlertCircle className="w-4 h-4" />
                        )}
                        {formatDate(comp.warrantyExpires)}
                      </div>
                    ) : (
                      <span className="text-gray-400">‚Äî</span>
                    )}
                  </td>
                  <td className="px-4 py-3 text-right">
                    <button
                      onClick={(e) => { e.stopPropagation(); setSelectedComponent(comp); }}
                      className="p-1 text-gray-400 hover:text-gray-600"
                    >
                      <ChevronRight className="w-5 h-5" />
                    </button>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>


        {totalCount > limit && (
          <div className="px-4 py-3 bg-gray-50 border-t flex items-center justify-between">
            <div className="text-sm text-gray-500">
              –ü–æ–∫–∞–∑–∞–Ω–æ {page * limit + 1}‚Äî{Math.min((page + 1) * limit, totalCount)} –∏–∑ {totalCount}
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setPage(p => Math.max(0, p - 1))}
                disabled={page === 0}
                className="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                –ù–∞–∑–∞–¥
              </button>
              <span className="text-sm text-gray-600">
                –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {Math.ceil(totalCount / limit)}
              </span>
              <button
                onClick={() => setPage(p => p + 1)}
                disabled={(page + 1) * limit >= totalCount}
                className="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                –í–ø–µ—Ä—ë–¥
              </button>
            </div>
          </div>
        )}
      </div>


      {showAddModal && (
        <AddComponentModal
          catalog={catalog}
          onClose={() => setShowAddModal(false)}
          onSuccess={() => {
            setShowAddModal(false);
            loadComponents();
            loadStats();
          }}
        />
      )}


      {selectedComponent && (
        <ComponentDetails
          component={selectedComponent}
          onClose={() => setSelectedComponent(null)}
          onUpdate={() => {
            loadComponents();
            loadStats();
          }}
        />
      )}
    </div>
  );
};


interface AddComponentModalProps {
  catalog: ComponentCatalog[];
  onClose: () => void;
  onSuccess: () => void;
}

const AddComponentModal: React.FC<AddComponentModalProps> = ({ catalog, onClose, onSuccess }) => {
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    type: "",
    serialNumber: "",
    serialNumberYadro: "",
    manufacturer: "",
    model: "",
    condition: "NEW" as ComponentCondition,
    location: "",
    purchaseDate: "",
    warrantyExpires: "",
    notes: ""
  });

  const componentTypes = [...new Set(catalog.map(c => c.type))].sort();
  const filteredCatalog = formData.type
    ? catalog.filter(c => c.type === formData.type)
    : [];

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!formData.type || !formData.serialNumber) {
      toast.error("–¢–∏–ø –∏ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");
      return;
    }

    setLoading(true);
    try {
      await inventoryApi.create({
        type: formData.type,
        serialNumber: formData.serialNumber,
        serialNumberYadro: formData.serialNumberYadro || undefined,
        manufacturer: formData.manufacturer || undefined,
        model: formData.model || undefined,
        condition: formData.condition,
        location: formData.location || undefined,
        purchaseDate: formData.purchaseDate || undefined,
        warrantyExpires: formData.warrantyExpires || undefined,
        notes: formData.notes || undefined
      });

      toast.success("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl w-full max-w-lg">
        <div className="px-6 py-4 border-b flex items-center justify-between">
          <h2 className="text-lg font-semibold">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç</h2>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
            ‚úï
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                –¢–∏–ø <span className="text-red-500">*</span>
              </label>
              <select
                value={formData.type}
                onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg"
                required
              >
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                {componentTypes.map(type => (
                  <option key={type} value={type}>{type}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                –°–æ—Å—Ç–æ—è–Ω–∏–µ
              </label>
              <select
                value={formData.condition}
                onChange={(e) => setFormData(prev => ({ ...prev, condition: e.target.value as ComponentCondition }))}
                className="w-full px-3 py-2 border rounded-lg"
              >
                {Object.entries(CONDITION_LABELS).map(([value, label]) => (
                  <option key={value} value={value}>{label}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                S/N (–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å) <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                value={formData.serialNumber}
                onChange={(e) => setFormData(prev => ({ ...prev, serialNumber: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg font-mono"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                S/N (–Ø–¥—Ä–æ)
              </label>
              <input
                type="text"
                value={formData.serialNumberYadro}
                onChange={(e) => setFormData(prev => ({ ...prev, serialNumberYadro: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg font-mono"
              />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å
              </label>
              <input
                type="text"
                value={formData.manufacturer}
                onChange={(e) => setFormData(prev => ({ ...prev, manufacturer: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg"
                list="manufacturers"
              />
              <datalist id="manufacturers">
                {[...new Set(filteredCatalog.map(c => c.manufacturer).filter(Boolean))].map(m => (
                  <option key={m} value={m!} />
                ))}
              </datalist>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                –ú–æ–¥–µ–ª—å
              </label>
              <input
                type="text"
                value={formData.model}
                onChange={(e) => setFormData(prev => ({ ...prev, model: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg"
                list="models"
              />
              <datalist id="models">
                {filteredCatalog.map(c => (
                  <option key={c.id} value={c.model} />
                ))}
              </datalist>
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              –õ–æ–∫–∞—Ü–∏—è
            </label>
            <input
              type="text"
              value={formData.location}
              onChange={(e) => setFormData(prev => ({ ...prev, location: e.target.value }))}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder="–°–∫–ª–∞–¥, —Å—Ç–µ–ª–ª–∞–∂..."
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                –î–∞—Ç–∞ –∑–∞–∫—É–ø–∫–∏
              </label>
              <input
                type="date"
                value={formData.purchaseDate}
                onChange={(e) => setFormData(prev => ({ ...prev, purchaseDate: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                –ì–∞—Ä–∞–Ω—Ç–∏—è –¥–æ
              </label>
              <input
                type="date"
                value={formData.warrantyExpires}
                onChange={(e) => setFormData(prev => ({ ...prev, warrantyExpires: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
            </label>
            <textarea
              value={formData.notes}
              onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
              rows={2}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </form>

        <div className="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            onClick={handleSubmit}
            disabled={loading}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {loading ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–î–æ–±–∞–≤–∏—Ç—å"}
          </button>
        </div>
      </div>
    </div>
  );
};


interface ComponentDetailsProps {
  component: ComponentInventory;
  onClose: () => void;
  onUpdate: () => void;
}

const ComponentDetails: React.FC<ComponentDetailsProps> = ({ component, onClose, onUpdate }) => {
  const [loading, setLoading] = useState(false);
  const [history, setHistory] = useState<any[]>([]);

  useEffect(() => {
    loadHistory();
  }, [component.id]);

  const loadHistory = async () => {
    try {
      const response = await inventoryApi.getHistory(component.id);
      setHistory(response.data);
    } catch (error) {
      console.error("Error loading history:", error);
    }
  };

  const handleScrap = async () => {
    const reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Å–ø–∏—Å–∞–Ω–∏—è:");
    if (!reason) return;

    setLoading(true);
    try {
      await inventoryApi.scrap(component.id, reason);
      toast.success("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø–∏—Å–∞–Ω");
      onUpdate();
      onClose();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleUpdateLocation = async () => {
    const location = prompt("–ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è:", component.location || "");
    if (location === null) return;

    setLoading(true);
    try {
      await inventoryApi.updateLocation(component.id, location);
      toast.success("–õ–æ–∫–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
      onUpdate();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <div className="px-6 py-4 border-b flex items-center justify-between">
          <div>
            <h2 className="text-lg font-semibold">{component.type}</h2>
            <p className="text-sm text-gray-500 font-mono">{component.serialNumber}</p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
            ‚úï
          </button>
        </div>

        <div className="flex-1 overflow-y-auto p-6">
          <div className="grid grid-cols-2 gap-4 mb-6">
            <div>
              <div className="text-sm text-gray-500">S/N (–Ø–¥—Ä–æ)</div>
              <div className="font-mono">{component.serialNumberYadro || "‚Äî"}</div>
            </div>
            <div>
              <div className="text-sm text-gray-500">–°—Ç–∞—Ç—É—Å</div>
              <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${STATUS_COLORS[component.status]}`}>
                {STATUS_LABELS[component.status]}
              </span>
            </div>
            <div>
              <div className="text-sm text-gray-500">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</div>
              <div>{component.manufacturer || "‚Äî"}</div>
            </div>
            <div>
              <div className="text-sm text-gray-500">–ú–æ–¥–µ–ª—å</div>
              <div>{component.model || "‚Äî"}</div>
            </div>
            <div>
              <div className="text-sm text-gray-500">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div>
              <div>{CONDITION_LABELS[component.condition]}</div>
            </div>
            <div>
              <div className="text-sm text-gray-500">–õ–æ–∫–∞—Ü–∏—è</div>
              <div>{component.location || "‚Äî"}</div>
            </div>
            {component.currentServer && (
              <div className="col-span-2">
                <div className="text-sm text-gray-500">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–µ—Ä–≤–µ—Ä</div>
                <div className="font-medium">{component.currentServer.apkSerialNumber} ({component.currentServer.hostname})</div>
              </div>
            )}
          </div>


          <div>
            <h3 className="font-medium mb-3">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            {history.length > 0 ? (
              <div className="space-y-2 max-h-60 overflow-y-auto">
                {history.map((h, i) => (
                  <div key={i} className="p-3 bg-gray-50 rounded-lg text-sm">
                    <div className="flex justify-between">
                      <span className="font-medium">{h.action}</span>
                      <span className="text-gray-500">
                        {new Date(h.performedAt).toLocaleString("ru-RU")}
                      </span>
                    </div>
                    {h.notes && <div className="text-gray-600 mt-1">{h.notes}</div>}
                    {h.performedBy && (
                      <div className="text-gray-500 mt-1">
                        {h.performedBy.surname} {h.performedBy.name}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-gray-500 text-sm">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
            )}
          </div>
        </div>

        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between">
          <div className="flex gap-2">
            {component.status === "AVAILABLE" && (
              <>
                <button
                  onClick={handleUpdateLocation}
                  disabled={loading}
                  className="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                >
                  –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é
                </button>
                <button
                  onClick={handleScrap}
                  disabled={loading}
                  className="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200"
                >
                  –°–ø–∏—Å–∞—Ç—å
                </button>
              </>
            )}
          </div>
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg"
          >
            –ó–∞–∫—Ä—ã—Ç—å
          </button>
        </div>
      </div>
    </div>
  );
};

export default ComponentInventoryPage;

================================================================================
FILE: QMS-Client-main/src/pages/beryll/DefectRecordDetails.tsx
================================================================================



import React, { useState, useEffect } from "react";
import {
  X,
  AlertTriangle,
  Server,
  Clock,
  User,
  Wrench,
  Truck,
  CheckCircle,
  Package,
  RotateCcw,
  AlertCircle,
  ChevronRight,
  FileText,
  History,
  Loader2
} from "lucide-react";
import toast from "react-hot-toast";
import {
  defectRecordApi,
  inventoryApi,
  substituteApi,
  DefectRecord,
  DefectRecordStatus,
  ComponentInventory
} from "../../api/beryllExtendedApi";

interface Props {
  record: DefectRecord;
  partTypes: Array<{ value: string; label: string }>;
  onClose: () => void;
  onUpdate: () => void;
}

const STATUS_FLOW: Record<DefectRecordStatus, DefectRecordStatus[]> = {
  NEW: ["DIAGNOSING"],
  DIAGNOSING: ["WAITING_PARTS", "REPAIRING", "SENT_TO_YADRO"],
  WAITING_PARTS: ["REPAIRING", "SENT_TO_YADRO"],
  REPAIRING: ["RESOLVED", "SENT_TO_YADRO"],
  SENT_TO_YADRO: ["RETURNED"],
  RETURNED: ["REPAIRING", "RESOLVED"],
  RESOLVED: ["CLOSED"],
  REPEATED: ["DIAGNOSING"],
  CLOSED: []
};

const DefectRecordDetails: React.FC<Props> = ({ record: initialRecord, partTypes, onClose, onUpdate }) => {
  const [record, setRecord] = useState<DefectRecord>(initialRecord);
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState<"info" | "workflow" | "history">("info");


  const [availableComponents, setAvailableComponents] = useState<ComponentInventory[]>([]);
  const [availableSubstitutes, setAvailableSubstitutes] = useState<any[]>([]);


  const [diagnosisData, setDiagnosisData] = useState({
    repairPartType: record.repairPartType || "",
    defectPartSerialYadro: record.defectPartSerialYadro || "",
    defectPartSerialManuf: record.defectPartSerialManuf || "",
    problemDescription: record.problemDescription || "",
    notes: ""
  });

  const [replacementData, setReplacementData] = useState({
    replacementPartSerialYadro: "",
    replacementPartSerialManuf: "",
    replacementInventoryId: 0,
    repairDetails: ""
  });

  const [yadroData, setYadroData] = useState({
    ticketNumber: "",
    subject: "",
    description: record.problemDescription || "",
    trackingNumber: ""
  });

  const [returnData, setReturnData] = useState({
    resolution: "",
    replacementSerialYadro: "",
    replacementSerialManuf: "",
    condition: "REFURBISHED"
  });

  const [resolveData, setResolveData] = useState({
    resolution: "",
    notes: ""
  });


  const reloadRecord = async () => {
    try {
      const response = await defectRecordApi.getById(record.id);
      setRecord(response.data);
      onUpdate();
    } catch (error) {
      console.error("Error reloading record:", error);
    }
  };


  useEffect(() => {
    const loadComponents = async () => {
      if (record.repairPartType) {
        try {
          const response = await inventoryApi.getAvailableByType(record.repairPartType, 20);
          setAvailableComponents(response.data);
        } catch (error) {
          console.error("Error loading components:", error);
        }
      }
    };

    const loadSubstitutes = async () => {
      try {
        const response = await substituteApi.getAvailable();
        setAvailableSubstitutes(response.data);
      } catch (error) {
        console.error("Error loading substitutes:", error);
      }
    };

    loadComponents();
    loadSubstitutes();
  }, [record.repairPartType]);


  const handleStartDiagnosis = async () => {
    setLoading(true);
    try {
      await defectRecordApi.startDiagnosis(record.id);
      toast.success("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞—á–∞—Ç–∞");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleCompleteDiagnosis = async () => {
    setLoading(true);
    try {
      await defectRecordApi.completeDiagnosis(record.id, diagnosisData);
      toast.success("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleSetWaitingParts = async () => {
    setLoading(true);
    try {
      await defectRecordApi.setWaitingParts(record.id, "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø–∞—Å–Ω—ã—Ö —á–∞—Å—Ç–µ–π");
      toast.success("–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleReserveComponent = async (inventoryId: number) => {
    setLoading(true);
    try {
      await defectRecordApi.reserveComponent(record.id, inventoryId);
      toast.success("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleStartRepair = async () => {
    setLoading(true);
    try {
      await defectRecordApi.startRepair(record.id);
      toast.success("–†–µ–º–æ–Ω—Ç –Ω–∞—á–∞—Ç");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handlePerformReplacement = async () => {
    setLoading(true);
    try {
      await defectRecordApi.performReplacement(record.id, {
        replacementPartSerialYadro: replacementData.replacementPartSerialYadro || undefined,
        replacementPartSerialManuf: replacementData.replacementPartSerialManuf || undefined,
        replacementInventoryId: replacementData.replacementInventoryId || undefined,
        repairDetails: replacementData.repairDetails || undefined
      });
      toast.success("–ó–∞–º–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleSendToYadro = async () => {
    setLoading(true);
    try {
      await defectRecordApi.sendToYadro(record.id, yadroData);
      toast.success("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –Ø–¥—Ä–æ");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleReturnFromYadro = async () => {
    setLoading(true);
    try {
      await defectRecordApi.returnFromYadro(record.id, {
        resolution: returnData.resolution,
        replacementSerialYadro: returnData.replacementSerialYadro || undefined,
        replacementSerialManuf: returnData.replacementSerialManuf || undefined,
        condition: returnData.condition as any
      });
      toast.success("–í–æ–∑–≤—Ä–∞—Ç –∏–∑ –Ø–¥—Ä–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleIssueSubstitute = async (substituteId?: number) => {
    setLoading(true);
    try {
      await defectRecordApi.issueSubstitute(record.id, substituteId);
      toast.success("–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤—ã–¥–∞–Ω");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleReturnSubstitute = async () => {
    setLoading(true);
    try {
      await defectRecordApi.returnSubstitute(record.id);
      toast.success("–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â—ë–Ω");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };

  const handleResolve = async () => {
    if (!resolveData.resolution.trim()) {
      toast.error("–£–∫–∞–∂–∏—Ç–µ —Ä–µ–∑–æ–ª—é—Ü–∏—é");
      return;
    }

    setLoading(true);
    try {
      await defectRecordApi.resolve(record.id, resolveData);
      toast.success("–ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞");
      await reloadRecord();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    } finally {
      setLoading(false);
    }
  };


  const formatDate = (dateStr: string | null): string => {
    if (!dateStr) return "‚Äî";
    return new Date(dateStr).toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  };

  const getPartTypeLabel = (type: string | null): string => {
    if (!type) return "–ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω";
    return partTypes.find(t => t.value === type)?.label || type;
  };

  const isSlaBreached = (): boolean => {
    if (!record.slaDeadline) return false;
    if (record.status === "RESOLVED" || record.status === "CLOSED") return false;
    return new Date(record.slaDeadline) < new Date();
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-start justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-xl shadow-xl w-full max-w-4xl my-8">

        <div className={`px-6 py-4 border-b flex items-center justify-between ${
          record.isRepeatedDefect ? "bg-red-50" : isSlaBreached() ? "bg-orange-50" : "bg-gray-50"
        }`}>
          <div className="flex items-center gap-3">
            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
              record.isRepeatedDefect ? "bg-red-100" : "bg-gray-100"
            }`}>
              <AlertTriangle className={`w-5 h-5 ${
                record.isRepeatedDefect ? "text-red-600" : "text-gray-600"
              }`} />
            </div>
            <div>
              <h2 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                –ó–∞–ø–∏—Å—å #{record.id}
                {record.isRepeatedDefect && (
                  <span className="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded-full">
                    –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫
                  </span>
                )}
                {isSlaBreached() && (
                  <span className="text-xs px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full">
                    SLA –Ω–∞—Ä—É—à–µ–Ω
                  </span>
                )}
              </h2>
              <p className="text-sm text-gray-500">
                {record.server?.apkSerialNumber} ‚Ä¢ {record.server?.hostname}
              </p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
          >
            <X className="w-5 h-5 text-gray-500" />
          </button>
        </div>


        <div className="border-b px-6">
          <div className="flex gap-4">
            {[
              { id: "info", label: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", icon: FileText },
              { id: "workflow", label: "Workflow", icon: ChevronRight },
              { id: "history", label: "–ò—Å—Ç–æ—Ä–∏—è", icon: History }
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-colors ${
                  activeTab === tab.id
                    ? "border-blue-500 text-blue-600"
                    : "border-transparent text-gray-500 hover:text-gray-700"
                }`}
              >
                <tab.icon className="w-4 h-4" />
                {tab.label}
              </button>
            ))}
          </div>
        </div>


        <div className="p-6">
          {activeTab === "info" && (
            <div className="space-y-6">

              <div className="grid grid-cols-2 gap-6">
                <div className="space-y-4">
                  <div>
                    <div className="text-sm text-gray-500">–°—Ç–∞—Ç—É—Å</div>
                    <div className="mt-1">
                      <span className={`inline-flex px-3 py-1 text-sm font-medium rounded-full ${
                        record.status === "RESOLVED" ? "bg-green-100 text-green-800" :
                        record.status === "CLOSED" ? "bg-gray-100 text-gray-800" :
                        "bg-blue-100 text-blue-800"
                      }`}>
                        {record.status}
                      </span>
                    </div>
                  </div>

                  <div>
                    <div className="text-sm text-gray-500">–ó–∞—è–≤–∫–∞ –Ø–¥—Ä–æ</div>
                    <div className="mt-1 font-mono text-blue-600">
                      {record.yadroTicketNumber || "‚Äî"}
                    </div>
                  </div>

                  <div>
                    <div className="text-sm text-gray-500">–¢–∏–ø –¥–µ—Ñ–µ–∫—Ç–∞</div>
                    <div className="mt-1 flex items-center gap-2">
                      <Wrench className="w-4 h-4 text-gray-400" />
                      {getPartTypeLabel(record.repairPartType)}
                    </div>
                  </div>

                  <div>
                    <div className="text-sm text-gray-500">–û–±–Ω–∞—Ä—É–∂–µ–Ω</div>
                    <div className="mt-1 flex items-center gap-2">
                      <Clock className="w-4 h-4 text-gray-400" />
                      {formatDate(record.detectedAt)}
                    </div>
                  </div>

                  {record.detectedBy && (
                    <div>
                      <div className="text-sm text-gray-500">–ö–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω</div>
                      <div className="mt-1 flex items-center gap-2">
                        <User className="w-4 h-4 text-gray-400" />
                        {record.detectedBy.surname} {record.detectedBy.name}
                      </div>
                    </div>
                  )}
                </div>

                <div className="space-y-4">
                  <div>
                    <div className="text-sm text-gray-500">–î–µ–¥–ª–∞–π–Ω SLA</div>
                    <div className={`mt-1 flex items-center gap-2 ${
                      isSlaBreached() ? "text-red-600" : ""
                    }`}>
                      {isSlaBreached() ? (
                        <AlertCircle className="w-4 h-4" />
                      ) : (
                        <Clock className="w-4 h-4 text-gray-400" />
                      )}
                      {formatDate(record.slaDeadline)}
                    </div>
                  </div>

                  <div>
                    <div className="text-sm text-gray-500">S/N –¥–µ—Ñ–µ–∫—Ç–Ω–æ–π –¥–µ—Ç–∞–ª–∏ (–Ø–¥—Ä–æ)</div>
                    <div className="mt-1 font-mono">
                      {record.defectPartSerialYadro || "‚Äî"}
                    </div>
                  </div>

                  <div>
                    <div className="text-sm text-gray-500">S/N –¥–µ—Ñ–µ–∫—Ç–Ω–æ–π –¥–µ—Ç–∞–ª–∏ (–ü—Ä–æ–∏–∑–≤.)</div>
                    <div className="mt-1 font-mono">
                      {record.defectPartSerialManuf || "‚Äî"}
                    </div>
                  </div>

                  {record.substituteServer && (
                    <div>
                      <div className="text-sm text-gray-500">–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä</div>
                      <div className="mt-1 flex items-center gap-2">
                        <Server className="w-4 h-4 text-gray-400" />
                        {record.substituteServer.apkSerialNumber}
                      </div>
                    </div>
                  )}
                </div>
              </div>


              <div>
                <div className="text-sm text-gray-500 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</div>
                <div className="p-3 bg-gray-50 rounded-lg text-gray-700">
                  {record.problemDescription || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"}
                </div>
              </div>


              {record.resolution && (
                <div>
                  <div className="text-sm text-gray-500 mb-1">–†–µ–∑–æ–ª—é—Ü–∏—è</div>
                  <div className="p-3 bg-green-50 rounded-lg text-gray-700">
                    {record.resolution}
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === "workflow" && (
            <div className="space-y-6">

              <div className="p-4 bg-blue-50 rounded-lg">
                <div className="font-medium text-blue-800 mb-2">
                  –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: {record.status}
                </div>
                <div className="text-sm text-blue-600">
                  –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã: {STATUS_FLOW[record.status]?.join(", ") || "–Ω–µ—Ç"}
                </div>
              </div>


              {record.status === "NEW" && (
                <div className="space-y-4">
                  <h3 className="font-medium">–ù–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</h3>
                  <button
                    onClick={handleStartDiagnosis}
                    disabled={loading}
                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                  >
                    {loading && <Loader2 className="w-4 h-4 animate-spin" />}
                    –ù–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
                  </button>
                </div>
              )}

              {record.status === "DIAGNOSING" && (
                <div className="space-y-4">
                  <h3 className="font-medium">–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</h3>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">–¢–∏–ø –¥–µ—Ñ–µ–∫—Ç–∞</label>
                      <select
                        value={diagnosisData.repairPartType}
                        onChange={(e) => setDiagnosisData(prev => ({ ...prev, repairPartType: e.target.value }))}
                        className="w-full px-3 py-2 border rounded-lg"
                      >
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                        {partTypes.map(t => (
                          <option key={t.value} value={t.value}>{t.label}</option>
                        ))}
                      </select>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm text-gray-600 mb-1">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</label>
                    <textarea
                      value={diagnosisData.notes}
                      onChange={(e) => setDiagnosisData(prev => ({ ...prev, notes: e.target.value }))}
                      rows={3}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏..."
                    />
                  </div>

                  <div className="flex gap-2">
                    <button
                      onClick={handleCompleteDiagnosis}
                      disabled={loading}
                      className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
                    >
                      {loading && <Loader2 className="w-4 h-4 animate-spin" />}
                      –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
                    </button>
                    <button
                      onClick={handleSetWaitingParts}
                      disabled={loading}
                      className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50"
                    >
                      –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π
                    </button>
                    <button
                      onClick={handleSendToYadro}
                      disabled={loading}
                      className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
                    >
                      –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –Ø–¥—Ä–æ
                    </button>
                  </div>
                </div>
              )}

              {record.status === "WAITING_PARTS" && (
                <div className="space-y-4">
                  <h3 className="font-medium">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π</h3>

                  {availableComponents.length > 0 && (
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –∑–∞–º–µ–Ω—ã</label>
                      <div className="space-y-2 max-h-48 overflow-y-auto">
                        {availableComponents.map(comp => (
                          <div
                            key={comp.id}
                            className="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
                          >
                            <div>
                              <div className="font-mono text-sm">{comp.serialNumber}</div>
                              <div className="text-xs text-gray-500">{comp.manufacturer} {comp.model}</div>
                            </div>
                            <button
                              onClick={() => handleReserveComponent(comp.id)}
                              disabled={loading}
                              className="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                            >
                              –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  <button
                    onClick={handleStartRepair}
                    disabled={loading}
                    className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50"
                  >
                    {loading && <Loader2 className="w-4 h-4 animate-spin" />}
                    –ù–∞—á–∞—Ç—å —Ä–µ–º–æ–Ω—Ç
                  </button>
                </div>
              )}

              {record.status === "REPAIRING" && (
                <div className="space-y-4">
                  <h3 className="font-medium">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–º–µ–Ω—ã</h3>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">S/N –Ω–æ–≤–æ–π –¥–µ—Ç–∞–ª–∏ (–Ø–¥—Ä–æ)</label>
                      <input
                        type="text"
                        value={replacementData.replacementPartSerialYadro}
                        onChange={(e) => setReplacementData(prev => ({ ...prev, replacementPartSerialYadro: e.target.value }))}
                        className="w-full px-3 py-2 border rounded-lg font-mono"
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">S/N –Ω–æ–≤–æ–π –¥–µ—Ç–∞–ª–∏ (–ü—Ä–æ–∏–∑–≤.)</label>
                      <input
                        type="text"
                        value={replacementData.replacementPartSerialManuf}
                        onChange={(e) => setReplacementData(prev => ({ ...prev, replacementPartSerialManuf: e.target.value }))}
                        className="w-full px-3 py-2 border rounded-lg font-mono"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm text-gray-600 mb-1">–î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞</label>
                    <textarea
                      value={replacementData.repairDetails}
                      onChange={(e) => setReplacementData(prev => ({ ...prev, repairDetails: e.target.value }))}
                      rows={3}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç..."
                    />
                  </div>

                  <div className="flex gap-2">
                    <button
                      onClick={handlePerformReplacement}
                      disabled={loading}
                      className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
                    >
                      {loading && <Loader2 className="w-4 h-4 animate-spin" />}
                      –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–º–µ–Ω—É –∏ –∑–∞–∫—Ä—ã—Ç—å
                    </button>
                  </div>
                </div>
              )}

              {record.status === "SENT_TO_YADRO" && (
                <div className="space-y-4">
                  <h3 className="font-medium">–í–æ–∑–≤—Ä–∞—Ç –∏–∑ –Ø–¥—Ä–æ</h3>

                  <div>
                    <label className="block text-sm text-gray-600 mb-1">–†–µ–∑–æ–ª—é—Ü–∏—è –æ—Ç –Ø–¥—Ä–æ</label>
                    <textarea
                      value={returnData.resolution}
                      onChange={(e) => setReturnData(prev => ({ ...prev, resolution: e.target.value }))}
                      rows={3}
                      className="w-full px-3 py-2 border rounded-lg"
                    />
                  </div>

                  <button
                    onClick={handleReturnFromYadro}
                    disabled={loading}
                    className="flex items-center gap-2 px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 disabled:opacity-50"
                  >
                    {loading && <Loader2 className="w-4 h-4 animate-spin" />}
                    –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç
                  </button>
                </div>
              )}


              {!record.substituteServerId && record.status !== "RESOLVED" && record.status !== "CLOSED" && (
                <div className="pt-4 border-t">
                  <h3 className="font-medium mb-2">–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä</h3>
                  {availableSubstitutes.length > 0 ? (
                    <div className="flex gap-2">
                      <button
                        onClick={() => handleIssueSubstitute()}
                        disabled={loading}
                        className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50"
                      >
                        –í—ã–¥–∞—Ç—å –ø–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
                      </button>
                      <span className="text-sm text-gray-500 self-center">
                        –î–æ—Å—Ç—É–ø–Ω–æ: {availableSubstitutes.length}
                      </span>
                    </div>
                  ) : (
                    <p className="text-gray-500 text-sm">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤</p>
                  )}
                </div>
              )}

              {record.substituteServerId && (
                <div className="pt-4 border-t">
                  <h3 className="font-medium mb-2">–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤—ã–¥–∞–Ω</h3>
                  <div className="flex items-center gap-4">
                    <span className="font-mono">{record.substituteServer?.apkSerialNumber}</span>
                    <button
                      onClick={handleReturnSubstitute}
                      disabled={loading}
                      className="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                    >
                      –í–µ—Ä–Ω—É—Ç—å
                    </button>
                  </div>
                </div>
              )}


              {(record.status === "REPAIRING" || record.status === "RETURNED") && (
                <div className="pt-4 border-t">
                  <h3 className="font-medium mb-2">–ó–∞–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å—å</h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">–†–µ–∑–æ–ª—é—Ü–∏—è</label>
                      <textarea
                        value={resolveData.resolution}
                        onChange={(e) => setResolveData(prev => ({ ...prev, resolution: e.target.value }))}
                        rows={3}
                        className="w-full px-3 py-2 border rounded-lg"
                        placeholder="–ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∑–æ–ª—é—Ü–∏—è..."
                      />
                    </div>
                    <button
                      onClick={handleResolve}
                      disabled={loading || !resolveData.resolution.trim()}
                      className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
                    >
                      {loading && <Loader2 className="w-4 h-4 animate-spin" />}
                      <CheckCircle className="w-4 h-4" />
                      –ó–∞–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === "history" && (
            <div className="text-gray-500 text-center py-8">
              –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default DefectRecordDetails;

================================================================================
FILE: QMS-Client-main/src/pages/beryll/DefectRecordModal.tsx
================================================================================



import React, { useState, useEffect, useMemo, useRef } from "react";
import { X, AlertTriangle, Server, Loader2, Search, ChevronDown } from "lucide-react";
import toast from "react-hot-toast";
import { createDefectRecord, updateDefectRecord, BeryllDefectRecord, RepairPartType } from "src/api/beryllApi";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
  servers: Array<{ id: number; apkSerialNumber: string; hostname?: string }>;
  users: Array<{ id: number; name: string; surname: string }>;
  editRecord?: BeryllDefectRecord | null;
}

const PART_TYPES: Array<{ value: RepairPartType; label: string }> = [
  { value: "RAM", label: "–û–ó–£" },
  { value: "MOTHERBOARD", label: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞" },
  { value: "CPU", label: "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä" },
  { value: "HDD", label: "HDD –¥–∏—Å–∫" },
  { value: "SSD", label: "SSD –¥–∏—Å–∫" },
  { value: "PSU", label: "–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è" },
  { value: "FAN", label: "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä" },
  { value: "RAID", label: "RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä" },
  { value: "NIC", label: "–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞" },
  { value: "BACKPLANE", label: "Backplane" },
  { value: "BMC", label: "BMC –º–æ–¥—É–ª—å" },
  { value: "CABLE", label: "–ö–∞–±–µ–ª—å" },
  { value: "OTHER", label: "–î—Ä—É–≥–æ–µ" },
];


interface ServerComboboxProps {
  servers: Array<{ id: number; apkSerialNumber: string; hostname?: string }>;
  value: { serverId: number | null; serverSerial: string };
  onChange: (value: { serverId: number | null; serverSerial: string }) => void;
  placeholder?: string;
}

const ServerCombobox: React.FC<ServerComboboxProps> = ({
  servers,
  value,
  onChange,
  placeholder = "–ü–æ–∏—Å–∫ –ø–æ S/N, hostname..."
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [search, setSearch] = useState(value.serverSerial || "");
  const containerRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);


  const filteredServers = useMemo(() => {
    if (!search.trim()) return servers.slice(0, 20);
    const q = search.toLowerCase();
    return servers.filter(s =>
      s.apkSerialNumber?.toLowerCase().includes(q) ||
      s.hostname?.toLowerCase().includes(q)
    ).slice(0, 20);
  }, [servers, search]);


  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);


  useEffect(() => {
    if (value.serverSerial && value.serverSerial !== search) {
      setSearch(value.serverSerial);
    }
  }, [value.serverSerial]);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newValue = e.target.value;
    setSearch(newValue);
    setIsOpen(true);


    const exactMatch = servers.find(s =>
      s.apkSerialNumber?.toLowerCase() === newValue.toLowerCase()
    );

    if (exactMatch) {
      onChange({ serverId: exactMatch.id, serverSerial: exactMatch.apkSerialNumber });
    } else {

      onChange({ serverId: null, serverSerial: newValue });
    }
  };

  const handleSelect = (server: { id: number; apkSerialNumber: string; hostname?: string }) => {
    setSearch(server.apkSerialNumber);
    onChange({ serverId: server.id, serverSerial: server.apkSerialNumber });
    setIsOpen(false);
  };

  const handleFocus = () => {
    setIsOpen(true);
  };


  const displayValue = search || "";

  return (
    <div ref={containerRef} className="relative">
      <div className="relative">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={16} />
        <input
          ref={inputRef}
          type="text"
          value={displayValue}
          onChange={handleInputChange}
          onFocus={handleFocus}
          placeholder={placeholder}
          className="w-full pl-9 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
        />
        <button
          type="button"
          onClick={() => setIsOpen(!isOpen)}
          className="absolute right-2 top-1/2 -translate-y-1/2 p-1 hover:bg-gray-100 rounded"
        >
          <ChevronDown size={16} className={`text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
      </div>


      {isOpen && (
        <div className="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto">
          {filteredServers.length === 0 ? (
            <div className="p-3 text-sm text-gray-500">
              {search.trim() ? (
                <div>
                  <p>–°–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                  <p className="text-xs text-gray-400 mt-1">
                    –°–µ—Ä–∏–π–Ω–∏–∫ "{search}" –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ –µ—Å—Ç—å
                  </p>
                </div>
              ) : (
                "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä..."
              )}
            </div>
          ) : (
            <>

              {search.trim() && !filteredServers.some(s =>
                s.apkSerialNumber?.toLowerCase() === search.toLowerCase()
              ) && (
                <div
                  className="px-3 py-2 text-sm bg-amber-50 border-b cursor-pointer hover:bg-amber-100"
                  onClick={() => {
                    onChange({ serverId: null, serverSerial: search });
                    setIsOpen(false);
                  }}
                >
                  <span className="text-amber-700">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: </span>
                  <span className="font-mono font-medium">{search}</span>
                  <span className="text-xs text-amber-600 ml-2">(—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)</span>
                </div>
              )}

              {filteredServers.map(server => (
                <div
                  key={server.id}
                  onClick={() => handleSelect(server)}
                  className={`px-3 py-2 cursor-pointer hover:bg-gray-100 ${
                    value.serverId === server.id ? 'bg-red-50' : ''
                  }`}
                >
                  <div className="font-mono text-sm font-medium">
                    {server.apkSerialNumber}
                  </div>
                  {server.hostname && (
                    <div className="text-xs text-gray-500">
                      {server.hostname}
                    </div>
                  )}
                </div>
              ))}
            </>
          )}
        </div>
      )}


      {value.serverSerial && (
        <div className="mt-1 text-xs">
          {value.serverId ? (
            <span className="text-green-600">‚úì –°–µ—Ä–≤–µ—Ä –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ</span>
          ) : (
            <span className="text-amber-600">‚ö† –†—É—á–Ω–æ–π –≤–≤–æ–¥ (—Å–µ—Ä–≤–µ—Ä –Ω–µ –≤ –±–∞–∑–µ)</span>
          )}
        </div>
      )}
    </div>
  );
};

const DefectRecordModal: React.FC<Props> = ({
  isOpen, onClose, onSuccess, servers, users, editRecord
}) => {
  const [loading, setLoading] = useState(false);


  const [serverValue, setServerValue] = useState<{ serverId: number | null; serverSerial: string }>({
    serverId: null,
    serverSerial: ""
  });
  const [yadroTicketNumber, setYadroTicketNumber] = useState("");
  const [hasSPISI, setHasSPISI] = useState(false);
  const [clusterCode, setClusterCode] = useState("");
  const [problemDescription, setProblemDescription] = useState("");
  const [detectedAt, setDetectedAt] = useState(new Date().toISOString().split("T")[0]);
  const [diagnosticianId, setDiagnosticianId] = useState<number | "">("");


  const [repairPartType, setRepairPartType] = useState<RepairPartType | "">("");
  const [defectPartSerialYadro, setDefectPartSerialYadro] = useState("");
  const [defectPartSerialManuf, setDefectPartSerialManuf] = useState("");
  const [replacementPartSerialYadro, setReplacementPartSerialYadro] = useState("");
  const [replacementPartSerialManuf, setReplacementPartSerialManuf] = useState("");
  const [diagnosisResult, setDiagnosisResult] = useState("");
  const [notes, setNotes] = useState("");


  const [isRepeatedDefect, setIsRepeatedDefect] = useState(false);
  const [repeatedDefectReason, setRepeatedDefectReason] = useState("");
  const [repeatedDefectDate, setRepeatedDefectDate] = useState("");


  const [substituteServerSerial, setSubstituteServerSerial] = useState("");


  const [sentToYadroAt, setSentToYadroAt] = useState("");
  const [returnedFromYadroAt, setReturnedFromYadroAt] = useState("");


  useEffect(() => {
    if (editRecord) {

      const server = servers.find(s => s.id === editRecord.serverId);
      setServerValue({
        serverId: editRecord.serverId,
        serverSerial: server?.apkSerialNumber || editRecord.serverSerial || ""
      });
      setYadroTicketNumber(editRecord.yadroTicketNumber || "");
      setHasSPISI(editRecord.hasSPISI || false);
      setClusterCode(editRecord.clusterCode || "");
      setProblemDescription(editRecord.problemDescription || "");
      setDetectedAt(editRecord.detectedAt?.split("T")[0] || "");
      setDiagnosticianId(editRecord.diagnosticianId || "");
      setRepairPartType(editRecord.repairPartType || "");
      setDefectPartSerialYadro(editRecord.defectPartSerialYadro || "");
      setDefectPartSerialManuf(editRecord.defectPartSerialManuf || "");
      setReplacementPartSerialYadro(editRecord.replacementPartSerialYadro || "");
      setReplacementPartSerialManuf(editRecord.replacementPartSerialManuf || "");
      setDiagnosisResult(editRecord.diagnosisResult || "");
      setNotes(editRecord.notes || "");
      setIsRepeatedDefect(editRecord.isRepeatedDefect || false);
      setRepeatedDefectReason(editRecord.repeatedDefectReason || "");
      setRepeatedDefectDate(editRecord.repeatedDefectDate?.split("T")[0] || "");
      setSubstituteServerSerial(editRecord.substituteServerSerial || "");
      setSentToYadroAt(editRecord.sentToYadroAt?.split("T")[0] || "");
      setReturnedFromYadroAt(editRecord.returnedFromYadroAt?.split("T")[0] || "");
    } else {

      setServerValue({ serverId: null, serverSerial: "" });
      setYadroTicketNumber("");
      setHasSPISI(false);
      setClusterCode("");
      setProblemDescription("");
      setDetectedAt(new Date().toISOString().split("T")[0]);
      setDiagnosticianId("");
      setRepairPartType("");
      setDefectPartSerialYadro("");
      setDefectPartSerialManuf("");
      setReplacementPartSerialYadro("");
      setReplacementPartSerialManuf("");
      setDiagnosisResult("");
      setNotes("");
      setIsRepeatedDefect(false);
      setRepeatedDefectReason("");
      setRepeatedDefectDate("");
      setSubstituteServerSerial("");
      setSentToYadroAt("");
      setReturnedFromYadroAt("");
    }
  }, [editRecord, isOpen, servers]);

  const handleSubmit = async () => {

    if (!serverValue.serverId && !serverValue.serverSerial.trim()) {
      toast.error("–£–∫–∞–∂–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä (–≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä)");
      return;
    }
    if (!problemDescription.trim()) {
      toast.error("–£–∫–∞–∂–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã");
      return;
    }

    setLoading(true);
    try {
      const data: any = {

        serverId: serverValue.serverId || undefined,
        serverSerial: serverValue.serverSerial || undefined,
        yadroTicketNumber: yadroTicketNumber || null,
        hasSPISI,
        clusterCode: clusterCode || null,
        problemDescription,
        detectedAt: detectedAt ? new Date(detectedAt).toISOString() : null,
        diagnosticianId: diagnosticianId ? Number(diagnosticianId) : null,
        repairPartType: repairPartType || null,
        defectPartSerialYadro: defectPartSerialYadro || null,
        defectPartSerialManuf: defectPartSerialManuf || null,
        replacementPartSerialYadro: replacementPartSerialYadro || null,
        replacementPartSerialManuf: replacementPartSerialManuf || null,
        diagnosisResult: diagnosisResult || null,
        notes: notes || null,
        isRepeatedDefect,
        repeatedDefectReason: isRepeatedDefect ? repeatedDefectReason : null,
        repeatedDefectDate: isRepeatedDefect && repeatedDefectDate ? new Date(repeatedDefectDate).toISOString() : null,
        substituteServerSerial: substituteServerSerial || null,
        sentToYadroAt: sentToYadroAt ? new Date(sentToYadroAt).toISOString() : null,
        sentToYadroRepair: !!sentToYadroAt,
        returnedFromYadroAt: returnedFromYadroAt ? new Date(returnedFromYadroAt).toISOString() : null,
        returnedFromYadro: !!returnedFromYadroAt,
      };

      if (editRecord) {
        await updateDefectRecord(editRecord.id, data);
        toast.success("–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
      } else {
        await createDefectRecord(data);
        toast.success("–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞");
      }

      onSuccess();
      onClose();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    } finally {
      setLoading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">

        <div className="flex items-center justify-between px-6 py-4 border-b bg-red-50">
          <h2 className="text-lg font-semibold flex items-center gap-2">
            <AlertTriangle className="text-red-500" size={20} />
            {editRecord ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –±—Ä–∞–∫–µ" : "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ"}
          </h2>
          <button onClick={onClose} className="p-2 hover:bg-red-100 rounded-lg">
            <X size={20} />
          </button>
        </div>


        <div className="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">


            <div className="space-y-4">
              <h3 className="font-medium text-gray-700 border-b pb-2">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –°–µ—Ä–≤–µ—Ä <span className="text-red-500">*</span>
                </label>
                <ServerCombobox
                  servers={servers}
                  value={serverValue}
                  onChange={setServerValue}
                  placeholder="–ü–æ–∏—Å–∫ –ø–æ S/N, hostname..."
                />
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –ó–∞—è–≤–∫–∞ –Ø–¥—Ä–æ
                </label>
                <input
                  type="text"
                  value={yadroTicketNumber}
                  onChange={(e) => setYadroTicketNumber(e.target.value)}
                  placeholder="INC123456"
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>


              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    –ö–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞
                  </label>
                  <input
                    type="text"
                    value={clusterCode}
                    onChange={(e) => setClusterCode(e.target.value)}
                    placeholder="240008"
                    className="w-full px-3 py-2 border rounded-lg"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    –ù–∞–ª–∏—á–∏–µ –°–ü–∏–°–ò
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer mt-2">
                    <input
                      type="checkbox"
                      checked={hasSPISI}
                      onChange={(e) => setHasSPISI(e.target.checked)}
                      className="w-4 h-4 rounded"
                    />
                    <span>–î–∞</span>
                  </label>
                </div>
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã <span className="text-red-500">*</span>
                </label>
                <textarea
                  value={problemDescription}
                  onChange={(e) => setProblemDescription(e.target.value)}
                  rows={3}
                  className="w-full px-3 py-2 border rounded-lg"
                  placeholder="ECC Error, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä..."
                />
              </div>


              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    –¢–∏–ø –¥–µ—Ç–∞–ª–∏
                  </label>
                  <select
                    value={repairPartType}
                    onChange={(e) => setRepairPartType(e.target.value as RepairPartType)}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">‚Äî –í—ã–± ‚Äî</option>
                    {PART_TYPES.map(pt => (
                      <option key={pt.value} value={pt.value}>{pt.label}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    –î–∏–∞–≥–Ω–æ—Å—Ç
                  </label>
                  <select
                    value={diagnosticianId}
                    onChange={(e) => setDiagnosticianId(e.target.value ? Number(e.target.value) : "")}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">‚Äî –í—ã–± ‚Äî</option>
                    {users.map(u => (
                      <option key={u.id} value={u.id}>
                        {u.surname} {u.name}
                      </option>
                    ))}
                  </select>
                </div>
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
                </label>
                <textarea
                  value={notes}
                  onChange={(e) => setNotes(e.target.value)}
                  rows={2}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
            </div>


            <div className="space-y-4">
              <h3 className="font-medium text-gray-700 border-b pb-2">–î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞</h3>


              <div className="p-3 bg-red-50 rounded-lg">
                <label className="block text-sm font-medium text-red-700 mb-2">
                  S/N –±—Ä–∞–∫–æ–≤–∞–Ω–Ω–æ–π –¥–µ—Ç–∞–ª–∏
                </label>
                <div className="grid grid-cols-2 gap-2">
                  <input
                    type="text"
                    value={defectPartSerialYadro}
                    onChange={(e) => setDefectPartSerialYadro(e.target.value)}
                    placeholder="S/N –Ø–¥—Ä–æ"
                    className="px-3 py-2 border rounded-lg text-sm"
                  />
                  <input
                    type="text"
                    value={defectPartSerialManuf}
                    onChange={(e) => setDefectPartSerialManuf(e.target.value)}
                    placeholder="S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è"
                    className="px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
              </div>


              <div className="p-3 bg-green-50 rounded-lg">
                <label className="block text-sm font-medium text-green-700 mb-2">
                  S/N –∑–∞–º–µ–Ω—ã
                </label>
                <div className="grid grid-cols-2 gap-2">
                  <input
                    type="text"
                    value={replacementPartSerialYadro}
                    onChange={(e) => setReplacementPartSerialYadro(e.target.value)}
                    placeholder="S/N –Ø–¥—Ä–æ"
                    className="px-3 py-2 border rounded-lg text-sm"
                  />
                  <input
                    type="text"
                    value={replacementPartSerialManuf}
                    onChange={(e) => setReplacementPartSerialManuf(e.target.value)}
                    placeholder="S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è"
                    className="px-3 py-2 border rounded-lg text-sm"
                  />
                </div>
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                </label>
                <textarea
                  value={diagnosisResult}
                  onChange={(e) => setDiagnosisResult(e.target.value)}
                  rows={2}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>


              <div className="p-3 bg-orange-50 rounded-lg">
                <label className="flex items-center gap-2 cursor-pointer mb-2">
                  <input
                    type="checkbox"
                    checked={isRepeatedDefect}
                    onChange={(e) => setIsRepeatedDefect(e.target.checked)}
                    className="w-4 h-4 rounded"
                  />
                  <span className="font-medium text-orange-700">–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫</span>
                </label>
                {isRepeatedDefect && (
                  <div className="space-y-2 mt-2">
                    <input
                      type="text"
                      value={repeatedDefectReason}
                      onChange={(e) => setRepeatedDefectReason(e.target.value)}
                      placeholder="–ü—Ä–∏—á–∏–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –±—Ä–∞–∫–∞"
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                    />
                    <input
                      type="date"
                      value={repeatedDefectDate}
                      onChange={(e) => setRepeatedDefectDate(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                    />
                  </div>
                )}
              </div>


              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  –°–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–¥–º–µ–Ω—ã (S/N)
                </label>
                <input
                  type="text"
                  value={substituteServerSerial}
                  onChange={(e) => setSubstituteServerSerial(e.target.value)}
                  placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ–¥–º–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>


              <div className="p-3 bg-indigo-50 rounded-lg">
                <label className="block text-sm font-medium text-indigo-700 mb-2">
                  –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –Ø–¥—Ä–æ
                </label>
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <span className="text-xs text-gray-500">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</span>
                    <input
                      type="date"
                      value={sentToYadroAt}
                      onChange={(e) => setSentToYadroAt(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                    />
                  </div>
                  <div>
                    <span className="text-xs text-gray-500">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</span>
                    <input
                      type="date"
                      value={returnedFromYadroAt}
                      onChange={(e) => setReturnedFromYadroAt(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>


        <div className="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 border rounded-lg hover:bg-gray-100"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            onClick={handleSubmit}
            disabled={loading}
            className="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 flex items-center gap-2"
          >
            {loading && <Loader2 className="w-4 h-4 animate-spin" />}
            {editRecord ? "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" : "–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å"}
          </button>
        </div>
      </div>
    </div>
  );
};

export default DefectRecordModal;

================================================================================
FILE: QMS-Client-main/src/pages/beryll/DefectRecordsPage.tsx
================================================================================



import React, { useState, useEffect, useCallback } from "react";
import {
  AlertTriangle,
  Search,
  Plus,
  Filter,
  RefreshCw,
  Clock,
  CheckCircle,
  XCircle,
  Truck,
  Wrench,
  Eye,
  ChevronRight,
  AlertCircle
} from "lucide-react";
import toast from "react-hot-toast";
import { defectRecordApi, DefectRecord, DefectRecordStatus } from "../../api/beryllExtendedApi";
import DefectRecordModal from "./DefectRecordModal";
import DefectRecordDetails from "./DefectRecordDetails";

const STATUS_COLORS: Record<DefectRecordStatus, string> = {
  NEW: "bg-blue-100 text-blue-800",
  DIAGNOSING: "bg-yellow-100 text-yellow-800",
  WAITING_PARTS: "bg-orange-100 text-orange-800",
  REPAIRING: "bg-purple-100 text-purple-800",
  SENT_TO_YADRO: "bg-indigo-100 text-indigo-800",
  RETURNED: "bg-cyan-100 text-cyan-800",
  RESOLVED: "bg-green-100 text-green-800",
  REPEATED: "bg-red-100 text-red-800",
  CLOSED: "bg-gray-100 text-gray-800"
};

const STATUS_LABELS: Record<DefectRecordStatus, string> = {
  NEW: "–ù–æ–≤—ã–π",
  DIAGNOSING: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
  WAITING_PARTS: "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π",
  REPAIRING: "–†–µ–º–æ–Ω—Ç",
  SENT_TO_YADRO: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –Ø–¥—Ä–æ",
  RETURNED: "–í–æ–∑–≤—Ä–∞—â—ë–Ω",
  RESOLVED: "–†–µ—à—ë–Ω",
  REPEATED: "–ü–æ–≤—Ç–æ—Ä–Ω—ã–π",
  CLOSED: "–ó–∞–∫—Ä—ã—Ç"
};

const DefectRecordsPage: React.FC = () => {
  const [records, setRecords] = useState<DefectRecord[]>([]);
  const [loading, setLoading] = useState(true);
  const [totalCount, setTotalCount] = useState(0);


  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState<DefectRecordStatus | "">("");
  const [partTypeFilter, setPartTypeFilter] = useState("");
  const [showSlaBreached, setShowSlaBreached] = useState(false);
  const [showRepeated, setShowRepeated] = useState(false);


  const [page, setPage] = useState(0);
  const [limit] = useState(20);


  const [showCreateModal, setShowCreateModal] = useState(false);
  const [selectedRecord, setSelectedRecord] = useState<DefectRecord | null>(null);


  const [partTypes, setPartTypes] = useState<Array<{ value: string; label: string }>>([]);
  const [stats, setStats] = useState<any>(null);


  const loadRecords = useCallback(async () => {
    setLoading(true);
    try {
      const response = await defectRecordApi.getAll({
        search: search || undefined,
        status: statusFilter || undefined,
        repairPartType: partTypeFilter || undefined,
        slaBreached: showSlaBreached || undefined,
        isRepeatedDefect: showRepeated || undefined,
        limit,
        offset: page * limit
      });

      setRecords(response.data.rows);
      setTotalCount(response.data.count);
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
    } finally {
      setLoading(false);
    }
  }, [search, statusFilter, partTypeFilter, showSlaBreached, showRepeated, page, limit]);

  const loadPartTypes = async () => {
    try {
      const response = await defectRecordApi.getPartTypes();
      setPartTypes(response.data);
    } catch (error) {
      console.error("Error loading part types:", error);
    }
  };

  const loadStats = async () => {
    try {
      const response = await defectRecordApi.getStats({});
      setStats(response.data);
    } catch (error) {
      console.error("Error loading stats:", error);
    }
  };

  useEffect(() => {
    loadPartTypes();
    loadStats();
  }, []);

  useEffect(() => {
    loadRecords();
  }, [loadRecords]);


  const resetFilters = () => {
    setSearch("");
    setStatusFilter("");
    setPartTypeFilter("");
    setShowSlaBreached(false);
    setShowRepeated(false);
    setPage(0);
  };


  const isSlaBreached = (record: DefectRecord): boolean => {
    if (!record.slaDeadline) return false;
    if (record.status === "RESOLVED" || record.status === "CLOSED") return false;
    return new Date(record.slaDeadline) < new Date();
  };


  const formatDate = (dateStr: string | null): string => {
    if (!dateStr) return "‚Äî";
    return new Date(dateStr).toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  };

  const formatDowntime = (minutes: number | null): string => {
    if (!minutes) return "‚Äî";
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 0) return `${days}–¥ ${hours % 24}—á`;
    if (hours > 0) return `${hours}—á ${minutes % 60}–º`;
    return `${minutes}–º`;
  };

  return (
    <div className="p-6 max-w-7xl mx-auto">

      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <AlertTriangle className="w-7 h-7 text-red-500" />
            –£—á—ë—Ç –±—Ä–∞–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
          </h1>
          <p className="text-gray-500 mt-1">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –æ –¥–µ—Ñ–µ–∫—Ç–∞—Ö –∏ —Ä–µ–º–æ–Ω—Ç–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ Beryll
          </p>
        </div>

        <button
          onClick={() => setShowCreateModal(true)}
          className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
        >
          <Plus className="w-5 h-5" />
          –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å
        </button>
      </div>


      {stats && (
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
            <div className="text-2xl font-bold text-gray-900">{totalCount}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–í —Ä–∞–±–æ—Ç–µ</div>
            <div className="text-2xl font-bold text-blue-600">
              {stats.byStatus?.filter((s: any) =>
                !["RESOLVED", "CLOSED"].includes(s.status)
              ).reduce((sum: number, s: any) => sum + parseInt(s.count), 0) || 0}
            </div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫</div>
            <div className="text-2xl font-bold text-red-600">{stats.repeatedCount || 0}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ SLA</div>
            <div className="text-2xl font-bold text-orange-600">{stats.slaBreachedCount || 0}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–°—Ä. –≤—Ä–µ–º—è —Ä–µ–º–æ–Ω—Ç–∞</div>
            <div className="text-2xl font-bold text-gray-900">
              {stats.avgRepairTimeHours ? `${stats.avgRepairTimeHours}—á` : "‚Äî"}
            </div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–†–µ—à–µ–Ω–æ</div>
            <div className="text-2xl font-bold text-green-600">
              {stats.byStatus?.find((s: any) => s.status === "RESOLVED")?.count || 0}
            </div>
          </div>
        </div>
      )}


      <div className="bg-white rounded-lg shadow p-4 mb-6">
        <div className="flex flex-wrap items-center gap-4">
          <div className="flex-1 min-w-[200px]">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input
                type="text"
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞—è–≤–∫–µ, –æ–ø–∏—Å–∞–Ω–∏—é, —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É..."
                value={search}
                onChange={(e) => { setSearch(e.target.value); setPage(0); }}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>

          <select
            value={statusFilter}
            onChange={(e) => { setStatusFilter(e.target.value as DefectRecordStatus | ""); setPage(0); }}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            {Object.entries(STATUS_LABELS).map(([value, label]) => (
              <option key={value} value={value}>{label}</option>
            ))}
          </select>

          <select
            value={partTypeFilter}
            onChange={(e) => { setPartTypeFilter(e.target.value); setPage(0); }}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
            {partTypes.map((type) => (
              <option key={type.value} value={type.value}>{type.label}</option>
            ))}
          </select>

          <label className="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              checked={showSlaBreached}
              onChange={(e) => { setShowSlaBreached(e.target.checked); setPage(0); }}
              className="w-4 h-4 text-orange-600 rounded"
            />
            <span className="text-sm text-gray-700">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ SLA</span>
          </label>

          <label className="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              checked={showRepeated}
              onChange={(e) => { setShowRepeated(e.target.checked); setPage(0); }}
              className="w-4 h-4 text-red-600 rounded"
            />
            <span className="text-sm text-gray-700">–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫</span>
          </label>

          <button
            onClick={resetFilters}
            className="px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <Filter className="w-5 h-5" />
          </button>

          <button
            onClick={loadRecords}
            disabled={loading}
            className="px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <RefreshCw className={`w-5 h-5 ${loading ? "animate-spin" : ""}`} />
          </button>
        </div>
      </div>


      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –°–µ—Ä–≤–µ—Ä
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –ó–∞—è–≤–∫–∞ –Ø–¥—Ä–æ
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –¢–∏–ø –¥–µ—Ñ–µ–∫—Ç–∞
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –°—Ç–∞—Ç—É—Å
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –û–±–Ω–∞—Ä—É–∂–µ–Ω
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                SLA
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –ü—Ä–æ—Å—Ç–æ–π
              </th>
              <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">

              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {loading ? (
              <tr>
                <td colSpan={8} className="px-4 py-8 text-center text-gray-500">
                  <RefreshCw className="w-6 h-6 animate-spin mx-auto mb-2" />
                  –ó–∞–≥—Ä—É–∑–∫–∞...
                </td>
              </tr>
            ) : records.length === 0 ? (
              <tr>
                <td colSpan={8} className="px-4 py-8 text-center text-gray-500">
                  –ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </td>
              </tr>
            ) : (
              records.map((record) => (
                <tr
                  key={record.id}
                  className={`hover:bg-gray-50 cursor-pointer ${
                    record.isRepeatedDefect ? "bg-red-50" : ""
                  } ${
                    isSlaBreached(record) ? "bg-orange-50" : ""
                  }`}
                  onClick={() => setSelectedRecord(record)}
                >
                  <td className="px-4 py-3">
                    <div className="font-medium text-gray-900">
                      {record.server?.apkSerialNumber || `ID: ${record.serverId}`}
                    </div>
                    <div className="text-sm text-gray-500">
                      {record.server?.hostname || record.server?.ipAddress}
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    {record.yadroTicketNumber ? (
                      <span className="font-mono text-sm text-blue-600">
                        {record.yadroTicketNumber}
                      </span>
                    ) : (
                      <span className="text-gray-400">‚Äî</span>
                    )}
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      {record.repairPartType ? (
                        <>
                          <Wrench className="w-4 h-4 text-gray-400" />
                          <span className="text-sm">
                            {partTypes.find(t => t.value === record.repairPartType)?.label || record.repairPartType}
                          </span>
                        </>
                      ) : (
                        <span className="text-gray-400">–ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</span>
                      )}
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${STATUS_COLORS[record.status]}`}>
                        {STATUS_LABELS[record.status]}
                      </span>
                      {record.isRepeatedDefect && (
                        <span className="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                          –ü–æ–≤—Ç–æ—Ä–Ω—ã–π
                        </span>
                      )}
                    </div>
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-500">
                    {formatDate(record.detectedAt)}
                  </td>
                  <td className="px-4 py-3">
                    {record.slaDeadline ? (
                      <div className={`flex items-center gap-1 text-sm ${
                        isSlaBreached(record) ? "text-red-600" : "text-gray-500"
                      }`}>
                        {isSlaBreached(record) ? (
                          <AlertCircle className="w-4 h-4" />
                        ) : (
                          <Clock className="w-4 h-4" />
                        )}
                        {formatDate(record.slaDeadline)}
                      </div>
                    ) : (
                      <span className="text-gray-400">‚Äî</span>
                    )}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-500">
                    {formatDowntime(record.totalDowntimeMinutes)}
                  </td>
                  <td className="px-4 py-3 text-right">
                    <button
                      onClick={(e) => { e.stopPropagation(); setSelectedRecord(record); }}
                      className="p-1 text-gray-400 hover:text-gray-600"
                    >
                      <ChevronRight className="w-5 h-5" />
                    </button>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>


        {totalCount > limit && (
          <div className="px-4 py-3 bg-gray-50 border-t flex items-center justify-between">
            <div className="text-sm text-gray-500">
              –ü–æ–∫–∞–∑–∞–Ω–æ {page * limit + 1}‚Äî{Math.min((page + 1) * limit, totalCount)} –∏–∑ {totalCount}
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setPage(p => Math.max(0, p - 1))}
                disabled={page === 0}
                className="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                –ù–∞–∑–∞–¥
              </button>
              <span className="text-sm text-gray-600">
                –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {Math.ceil(totalCount / limit)}
              </span>
              <button
                onClick={() => setPage(p => p + 1)}
                disabled={(page + 1) * limit >= totalCount}
                className="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                –í–ø–µ—Ä—ë–¥
              </button>
            </div>
          </div>
        )}
      </div>


      {showCreateModal && (
        <DefectRecordModal
          onClose={() => setShowCreateModal(false)}
          onSuccess={() => {
            setShowCreateModal(false);
            loadRecords();
            loadStats();
          }}
          partTypes={partTypes}
        />
      )}

      {selectedRecord && (
        <DefectRecordDetails
          record={selectedRecord}
          partTypes={partTypes}
          onClose={() => setSelectedRecord(null)}
          onUpdate={() => {
            loadRecords();
            loadStats();
          }}
        />
      )}
    </div>
  );
};

export default DefectRecordsPage;

================================================================================
FILE: QMS-Client-main/src/pages/beryll/SubstituteServersPage.tsx
================================================================================



import React, { useState, useEffect, useCallback } from "react";
import {
  Server,
  Search,
  Plus,
  RefreshCw,
  CheckCircle,
  XCircle,
  Wrench,
  ArrowRightLeft,
  BarChart3,
  Clock
} from "lucide-react";
import toast from "react-hot-toast";
import { substituteApi, SubstituteServer, SubstituteStatus } from "../../api/beryllExtendedApi";

const STATUS_CONFIG: Record<SubstituteStatus, { label: string; color: string; icon: React.ComponentType<any> }> = {
  AVAILABLE: { label: "–î–æ—Å—Ç—É–ø–µ–Ω", color: "bg-green-100 text-green-800", icon: CheckCircle },
  IN_USE: { label: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è", color: "bg-blue-100 text-blue-800", icon: ArrowRightLeft },
  MAINTENANCE: { label: "–ù–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏", color: "bg-orange-100 text-orange-800", icon: Wrench },
  RETIRED: { label: "–í—ã–≤–µ–¥–µ–Ω", color: "bg-gray-100 text-gray-800", icon: XCircle }
};

const SubstituteServersPage: React.FC = () => {
  const [substitutes, setSubstitutes] = useState<SubstituteServer[]>([]);
  const [loading, setLoading] = useState(true);
  const [statusFilter, setStatusFilter] = useState<SubstituteStatus | "">("");
  const [stats, setStats] = useState<any>(null);


  const [showAddModal, setShowAddModal] = useState(false);
  const [selectedSubstitute, setSelectedSubstitute] = useState<SubstituteServer | null>(null);

  const loadSubstitutes = useCallback(async () => {
    setLoading(true);
    try {
      const response = await substituteApi.getAll(statusFilter || undefined);
      setSubstitutes(response.data);
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
    } finally {
      setLoading(false);
    }
  }, [statusFilter]);

  const loadStats = async () => {
    try {
      const response = await substituteApi.getStats();
      setStats(response.data);
    } catch (error) {
      console.error("Error loading stats:", error);
    }
  };

  useEffect(() => {
    loadSubstitutes();
    loadStats();
  }, [loadSubstitutes]);

  const handleReturn = async (id: number) => {
    if (!confirm("–í–µ—Ä–Ω—É—Ç—å –ø–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤ –ø—É–ª?")) return;

    try {
      await substituteApi.return(id);
      toast.success("–°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ –ø—É–ª");
      loadSubstitutes();
      loadStats();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };

  const handleSetMaintenance = async (id: number) => {
    const notes = prompt("–ü—Ä–∏—á–∏–Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:");
    if (notes === null) return;

    try {
      await substituteApi.setMaintenance(id, notes);
      toast.success("–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ");
      loadSubstitutes();
      loadStats();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };

  const handleRemove = async (id: number) => {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –∏–∑ –ø—É–ª–∞ –ø–æ–¥–º–µ–Ω–Ω—ã—Ö?")) return;

    try {
      await substituteApi.removeFromPool(id);
      toast.success("–°–µ—Ä–≤–µ—Ä —É–¥–∞–ª—ë–Ω –∏–∑ –ø—É–ª–∞");
      loadSubstitutes();
      loadStats();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞");
    }
  };

  const formatDate = (dateStr: string | null): string => {
    if (!dateStr) return "‚Äî";
    return new Date(dateStr).toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  };

  return (
    <div className="p-6 max-w-6xl mx-auto">

      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <ArrowRightLeft className="w-7 h-7 text-purple-500" />
            –ü–æ–¥–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã
          </h1>
          <p className="text-gray-500 mt-1">
            –ü—É–ª —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–º–µ–Ω—ã –Ω–∞ –≤—Ä–µ–º—è —Ä–µ–º–æ–Ω—Ç–∞
          </p>
        </div>

        <button
          onClick={() => setShowAddModal(true)}
          className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
        >
          <Plus className="w-5 h-5" />
          –î–æ–±–∞–≤–∏—Ç—å –≤ –ø—É–ª
        </button>
      </div>


      {stats && (
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–í—Å–µ–≥–æ –≤ –ø—É–ª–µ</div>
            <div className="text-2xl font-bold text-gray-900">{stats.total}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–î–æ—Å—Ç—É–ø–Ω–æ</div>
            <div className="text-2xl font-bold text-green-600">{stats.available}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è</div>
            <div className="text-2xl font-bold text-blue-600">{stats.inUse}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500">–ù–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏</div>
            <div className="text-2xl font-bold text-orange-600">{stats.maintenance}</div>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            <div className="text-sm text-gray-500 flex items-center gap-1">
              <BarChart3 className="w-4 h-4" />
              –°—Ä. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
            </div>
            <div className="text-2xl font-bold text-gray-900">
              {stats.avgUsageCount?.toFixed(1) || "0"}
            </div>
          </div>
        </div>
      )}


      <div className="bg-white rounded-lg shadow p-4 mb-6">
        <div className="flex items-center gap-4">
          <select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value as SubstituteStatus | "")}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
          >
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            {Object.entries(STATUS_CONFIG).map(([value, config]) => (
              <option key={value} value={value}>{config.label}</option>
            ))}
          </select>

          <button
            onClick={loadSubstitutes}
            disabled={loading}
            className="px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <RefreshCw className={`w-5 h-5 ${loading ? "animate-spin" : ""}`} />
          </button>
        </div>
      </div>


      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –°–µ—Ä–≤–µ—Ä
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –°—Ç–∞—Ç—É—Å
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –¢–µ–∫—É—â–∏–π –¥–µ—Ñ–µ–∫—Ç
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –í—ã–¥–∞–Ω
              </th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
              </th>
              <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                –î–µ–π—Å—Ç–≤–∏—è
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {loading ? (
              <tr>
                <td colSpan={6} className="px-4 py-8 text-center text-gray-500">
                  <RefreshCw className="w-6 h-6 animate-spin mx-auto mb-2" />
                  –ó–∞–≥—Ä—É–∑–∫–∞...
                </td>
              </tr>
            ) : substitutes.length === 0 ? (
              <tr>
                <td colSpan={6} className="px-4 py-8 text-center text-gray-500">
                  –ü–æ–¥–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </td>
              </tr>
            ) : (
              substitutes.map((sub) => {
                const statusConfig = STATUS_CONFIG[sub.status];
                const StatusIcon = statusConfig.icon;

                return (
                  <tr key={sub.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="flex items-center gap-2">
                        <Server className="w-5 h-5 text-gray-400" />
                        <div>
                          <div className="font-medium">{sub.server?.apkSerialNumber}</div>
                          <div className="text-sm text-gray-500">
                            {sub.server?.hostname} ‚Ä¢ {sub.server?.ipAddress}
                          </div>
                        </div>
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <span className={`inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-full ${statusConfig.color}`}>
                        <StatusIcon className="w-3 h-3" />
                        {statusConfig.label}
                      </span>
                    </td>
                    <td className="px-4 py-3">
                      {sub.currentDefect ? (
                        <div className="text-sm">
                          <div className="text-blue-600">#{sub.currentDefect.id}</div>
                          <div className="text-gray-500 truncate max-w-[200px]">
                            {sub.currentDefect.problemDescription}
                          </div>
                        </div>
                      ) : (
                        <span className="text-gray-400">‚Äî</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-sm">
                      {sub.issuedAt ? (
                        <div>
                          <div className="flex items-center gap-1 text-gray-600">
                            <Clock className="w-4 h-4" />
                            {formatDate(sub.issuedAt)}
                          </div>
                          {sub.issuedTo && (
                            <div className="text-gray-500">
                              {sub.issuedTo.surname} {sub.issuedTo.name}
                            </div>
                          )}
                        </div>
                      ) : (
                        <span className="text-gray-400">‚Äî</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <span className="font-medium">{sub.usageCount}</span>
                    </td>
                    <td className="px-4 py-3 text-right">
                      <div className="flex items-center justify-end gap-2">
                        {sub.status === "IN_USE" && (
                          <button
                            onClick={() => handleReturn(sub.id)}
                            className="px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200"
                          >
                            –í–µ—Ä–Ω—É—Ç—å
                          </button>
                        )}
                        {sub.status === "AVAILABLE" && (
                          <button
                            onClick={() => handleSetMaintenance(sub.id)}
                            className="px-2 py-1 text-xs bg-orange-100 text-orange-700 rounded hover:bg-orange-200"
                          >
                            –ù–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
                          </button>
                        )}
                        {sub.status === "MAINTENANCE" && (
                          <button
                            onClick={() => handleReturn(sub.id)}
                            className="px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200"
                          >
                            –î–æ—Å—Ç—É–ø–µ–Ω
                          </button>
                        )}
                        {sub.status !== "IN_USE" && (
                          <button
                            onClick={() => handleRemove(sub.id)}
                            className="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200"
                          >
                            –£–¥–∞–ª–∏—Ç—å
                          </button>
                        )}
                      </div>
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>


      {showAddModal && (
        <AddSubstituteModal
          onClose={() => setShowAddModal(false)}
          onSuccess={() => {
            setShowAddModal(false);
            loadSubstitutes();
            loadStats();
          }}
        />
      )}
    </div>
  );
};


interface AddSubstituteModalProps {
  onClose: () => void;
  onSuccess: () => void;
}

const AddSubstituteModal: React.FC<AddSubstituteModalProps> = ({ onClose, onSuccess }) => {
  const [loading, setLoading] = useState(false);
  const [serverSearch, setServerSearch] = useState("");
  const [searchResults, setSearchResults] = useState<any[]>([]);
  const [searching, setSearching] = useState(false);
  const [selectedServer, setSelectedServer] = useState<any>(null);
  const [notes, setNotes] = useState("");


  useEffect(() => {
    const search = async () => {
      if (serverSearch.length < 2) {
        setSearchResults([]);
        return;
      }

      setSearching(true);
      try {
        const response = await fetch(`/api/beryll/servers?search=${encodeURIComponent(serverSearch)}&limit=10`);
        const data = await response.json();
        setSearchResults(data.rows || []);
      } catch (error) {
        console.error("Error searching servers:", error);
      } finally {
        setSearching(false);
      }
    };

    const debounce = setTimeout(search, 300);
    return () => clearTimeout(debounce);
  }, [serverSearch]);

  const handleSubmit = async () => {
    if (!selectedServer) {
      toast.error("–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä");
      return;
    }

    setLoading(true);
    try {
      await substituteApi.addToPool(selectedServer.id, notes || undefined);
      toast.success("–°–µ—Ä–≤–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—É–ª –ø–æ–¥–º–µ–Ω–Ω—ã—Ö");
      onSuccess();
    } catch (error: any) {
      toast.error(error.response?.data?.message || "–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl w-full max-w-md">
        <div className="px-6 py-4 border-b flex items-center justify-between">
          <h2 className="text-lg font-semibold">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä</h2>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
            ‚úï
          </button>
        </div>

        <div className="p-6 space-y-4">

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              –°–µ—Ä–≤–µ—Ä
            </label>
            {selectedServer ? (
              <div className="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
                <Server className="w-5 h-5 text-gray-400" />
                <div className="flex-1">
                  <div className="font-medium">{selectedServer.apkSerialNumber}</div>
                  <div className="text-sm text-gray-500">{selectedServer.hostname}</div>
                </div>
                <button
                  onClick={() => setSelectedServer(null)}
                  className="text-red-500 hover:text-red-700"
                >
                  ‚úï
                </button>
              </div>
            ) : (
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                <input
                  type="text"
                  value={serverSearch}
                  onChange={(e) => setServerSearch(e.target.value)}
                  placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É, IP..."
                  className="w-full pl-10 pr-4 py-2 border rounded-lg"
                />

                {searchResults.length > 0 && (
                  <div className="absolute top-full left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 max-h-48 overflow-y-auto">
                    {searchResults.map((server) => (
                      <button
                        key={server.id}
                        onClick={() => {
                          setSelectedServer(server);
                          setServerSearch("");
                          setSearchResults([]);
                        }}
                        className="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center gap-2"
                      >
                        <Server className="w-4 h-4 text-gray-400" />
                        <div>
                          <div className="font-medium">{server.apkSerialNumber}</div>
                          <div className="text-sm text-gray-500">{server.hostname}</div>
                        </div>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>


          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
            </label>
            <textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              rows={2}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."
            />
          </div>
        </div>

        <div className="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            onClick={handleSubmit}
            disabled={loading || !selectedServer}
            className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50"
          >
            {loading ? "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ..." : "–î–æ–±–∞–≤–∏—Ç—å"}
          </button>
        </div>
      </div>
    </div>
  );
};

export default SubstituteServersPage;

================================================================================
FILE: QMS-Client-main/src/pages/beryll/YadroTicketsPage.tsx
================================================================================

import React, { useState, useEffect } from "react";
import { Plus, Save, Trash2, Loader2 } from "lucide-react";
import toast from "react-hot-toast";
import { apiClient } from "../../api";

interface TicketRow {
  id: number | null;
  ticketNumber: string;
  serverSerial: string;
  serverId: number | null;
  componentType: string;
  serialYadro: string;
  serialManuf: string;
  sentDate: string;
  returnDate: string;
  notes: string;
  changed?: boolean;
}

const EMPTY_ROW: TicketRow = {
  id: null,
  ticketNumber: "",
  serverSerial: "",
  serverId: null,
  componentType: "",
  serialYadro: "",
  serialManuf: "",
  sentDate: "",
  returnDate: "",
  notes: "",
  changed: true
};

const COMP_TYPES = ["", "–û–ó–£", "–ú–∞—Ç. –ø–ª–∞—Ç–∞", "HDD", "SSD", "–ë–ü", "CPU", "–ö—É–ª–µ—Ä", "RAID", "–°–µ—Ç–µ–≤–∞—è", "BMC", "–î—Ä—É–≥–æ–µ"];

const mapTypeFromDB = (t: string | null): string => {
  if (!t) return "";
  const map: Record<string, string> = {
    RAM: "–û–ó–£", MOTHERBOARD: "–ú–∞—Ç. –ø–ª–∞—Ç–∞", HDD: "HDD", SSD: "SSD",
    PSU: "–ë–ü", CPU: "CPU", FAN: "–ö—É–ª–µ—Ä", RAID: "RAID", NIC: "–°–µ—Ç–µ–≤–∞—è", BMC: "BMC"
  };
  return map[t] || t;
};

const mapTypeToDB = (t: string): string | null => {
  const map: Record<string, string> = {
    "–û–ó–£": "RAM", "–ú–∞—Ç. –ø–ª–∞—Ç–∞": "MOTHERBOARD", "–ë–ü": "PSU",
    "–ö—É–ª–µ—Ä": "FAN", "–°–µ—Ç–µ–≤–∞—è": "NIC"
  };
  return map[t] || t || null;
};

export default function YadroTicketsPage() {
  const [rows, setRows] = useState<TicketRow[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState<number | null>(null);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setLoading(true);
    try {
      const { data } = await apiClient.get("/beryll/extended/yadro/logs", {
        params: { limit: 500 }
      });

      const loaded: TicketRow[] = (data.rows || []).map((r: any) => ({
        id: r.id,
        ticketNumber: r.ticketNumber || "",
        serverSerial: r.server?.apkSerialNumber || "",
        serverId: r.serverId || null,
        componentType: mapTypeFromDB(r.componentType),
        serialYadro: r.sentComponentSerialYadro || "",
        serialManuf: r.sentComponentSerialManuf || "",
        sentDate: r.sentAt ? r.sentAt.split("T")[0] : "",
        returnDate: r.receivedAt ? r.receivedAt.split("T")[0] : "",
        notes: r.notes || "",
        changed: false
      }));

      setRows(loaded);
    } catch (e) {
      console.error(e);
      toast.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
    } finally {
      setLoading(false);
    }
  };

  const addRow = () => {
    setRows([{ ...EMPTY_ROW }, ...rows]);
  };

  const updateCell = (idx: number, field: keyof TicketRow, value: string) => {
    setRows(rows.map((r, i) =>
      i === idx ? { ...r, [field]: value, changed: true } : r
    ));
  };

  const saveRow = async (idx: number) => {
    const row = rows[idx];
    if (!row.ticketNumber.trim()) {
      toast.error("–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
      return;
    }

    setSaving(idx);
    try {
      if (row.id) {
        await apiClient.put(`/beryll/extended/yadro/logs/${row.id}`, {
          ticketNumber: row.ticketNumber.trim(),
          serverSerial: row.serverSerial.trim() || undefined,
          componentType: mapTypeToDB(row.componentType),
          sentComponentSerialYadro: row.serialYadro.trim() || undefined,
          sentComponentSerialManuf: row.serialManuf.trim() || undefined,
          sentAt: row.sentDate || undefined,
          receivedAt: row.returnDate || undefined,
          notes: row.notes.trim() || undefined
        });
      } else {
        await apiClient.post("/beryll/extended/yadro/logs", {
          ticketNumber: row.ticketNumber.trim(),
          serverSerial: row.serverSerial.trim() || undefined,
          componentType: mapTypeToDB(row.componentType),
          sentComponentSerialYadro: row.serialYadro.trim() || undefined,
          sentComponentSerialManuf: row.serialManuf.trim() || undefined,
          sentAt: row.sentDate || undefined,
          notes: row.notes.trim() || undefined
        });
      }
      toast.success("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
      loadData();
    } catch (e: any) {
      toast.error(e.response?.data?.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    } finally {
      setSaving(null);
    }
  };

  const deleteRow = async (idx: number) => {
    const row = rows[idx];
    if (!row.id) {
      setRows(rows.filter((_, i) => i !== idx));
      return;
    }
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É ${row.ticketNumber}?`)) return;

    try {
      await apiClient.delete(`/beryll/extended/yadro/logs/${row.id}`);
      toast.success("–£–¥–∞–ª–µ–Ω–æ");
      loadData();
    } catch (e) {
      toast.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <Loader2 className="w-8 h-8 animate-spin text-blue-600" />
      </div>
    );
  }

  return (
    <div className="p-4">
      <div className="flex items-center justify-between mb-4">
        <h1 className="text-xl font-bold">üìã –ñ—É—Ä–Ω–∞–ª –∑–∞—è–≤–æ–∫ –Ø–¥—Ä–æ</h1>
        <button
          onClick={addRow}
          className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          <Plus className="w-4 h-4" /> –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </div>

      <div className="overflow-x-auto border rounded-lg bg-white">
        <table className="w-full text-sm">
          <thead className="bg-gray-100">
            <tr>
              <th className="px-2 py-2 text-left font-semibold border-b w-28">‚Ññ –∑–∞—è–≤–∫–∏</th>
              <th className="px-2 py-2 text-left font-semibold border-b w-28">–°–µ—Ä–≤–µ—Ä</th>
              <th className="px-2 py-2 text-left font-semibold border-b w-24">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç</th>
              <th className="px-2 py-2 text-left font-semibold border-b w-40">S/N (–Ø–¥—Ä–æ)</th>
              <th className="px-2 py-2 text-left font-semibold border-b w-40">S/N (–ø—Ä–æ–∏–∑–≤.)</th>
              <th className="px-2 py-2 text-left font-semibold border-b w-28">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
              <th className="px-2 py-2 text-left font-semibold border-b w-28">–í–æ–∑–≤—Ä–∞—Ç</th>
              <th className="px-2 py-2 text-left font-semibold border-b">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th>
              <th className="px-2 py-2 text-center font-semibold border-b w-20"></th>
            </tr>
          </thead>
          <tbody>
            {rows.length === 0 ? (
              <tr>
                <td colSpan={9} className="px-4 py-8 text-center text-gray-400">
                  –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è.
                </td>
              </tr>
            ) : (
              rows.map((row, idx) => (
                <tr
                  key={row.id || `new-${idx}`}
                  className={`hover:bg-blue-50 ${row.changed ? "bg-yellow-50" : ""} ${!row.id ? "bg-green-50" : ""}`}
                >
                  <td className="px-1 py-1 border-b">
                    <input
                      type="text"
                      value={row.ticketNumber}
                      onChange={(e) => updateCell(idx, "ticketNumber", e.target.value.toUpperCase())}
                      placeholder="INC553187"
                      className="w-full px-2 py-1 border rounded text-xs font-mono focus:ring-1 focus:ring-blue-500 focus:outline-none"
                    />
                  </td>

                  <td className="px-1 py-1 border-b">
                    <input
                      type="text"
                      value={row.serverSerial}
                      onChange={(e) => updateCell(idx, "serverSerial", e.target.value)}
                      placeholder="020223076B"
                      className="w-full px-2 py-1 border rounded text-xs font-mono focus:ring-1 focus:ring-blue-500 focus:outline-none"
                    />
                  </td>

                  <td className="px-1 py-1 border-b">
                    <select
                      value={row.componentType}
                      onChange={(e) => updateCell(idx, "componentType", e.target.value)}
                      className="w-full px-1 py-1 border rounded text-xs focus:ring-1 focus:ring-blue-500 focus:outline-none"
                    >
                      {COMP_TYPES.map(t => (
                        <option key={t} value={t}>{t || "‚Äî"}</option>
                      ))}
                    </select>
                  </td>

                  <td className="px-1 py-1 border-b">
                    <input
                      type="text"
                      value={row.serialYadro}
                      onChange={(e) => updateCell(idx, "serialYadro", e.target.value)}
                      placeholder="Y0ZJBC025024..."
                      className="w-full px-2 py-1 border rounded text-xs font-mono focus:ring-1 focus:ring-blue-500 focus:outline-none"
                    />
                  </td>

                  <td className="px-1 py-1 border-b">
                    <input
                      type="text"
                      value={row.serialManuf}
                      onChange={(e) => updateCell(idx, "serialManuf", e.target.value)}
                      placeholder="K07Z0003201..."
                      className="w-full px-2 py-1 border rounded text-xs font-mono focus:ring-1 focus:ring-blue-500 focus:outline-none"
                    />
                  </td>

                  <td className="px-1 py-1 border-b">
                    <input
                      type="date"
                      value={row.sentDate}
                      onChange={(e) => updateCell(idx, "sentDate", e.target.value)}
                      className="w-full px-1 py-1 border rounded text-xs focus:ring-1 focus:ring-blue-500 focus:outline-none"
                    />
                  </td>

                  <td className="px-1 py-1 border-b">
                    <input
                      type="date"
                      value={row.returnDate}
                      onChange={(e) => updateCell(idx, "returnDate", e.target.value)}
                      className={`w-full px-1 py-1 border rounded text-xs focus:ring-1 focus:ring-blue-500 focus:outline-none ${
                        row.returnDate ? "bg-green-100 border-green-300" : ""
                      }`}
                    />
                  </td>

                  <td className="px-1 py-1 border-b">
                    <input
                      type="text"
                      value={row.notes}
                      onChange={(e) => updateCell(idx, "notes", e.target.value)}
                      placeholder="..."
                      className="w-full px-2 py-1 border rounded text-xs focus:ring-1 focus:ring-blue-500 focus:outline-none"
                    />
                  </td>

                  <td className="px-1 py-1 border-b text-center">
                    <div className="flex items-center justify-center gap-1">
                      {row.changed && (
                        <button
                          onClick={() => saveRow(idx)}
                          disabled={saving === idx}
                          className="p-1 text-green-600 hover:bg-green-100 rounded disabled:opacity-50"
                          title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
                        >
                          {saving === idx ? (
                            <Loader2 className="w-4 h-4 animate-spin" />
                          ) : (
                            <Save className="w-4 h-4" />
                          )}
                        </button>
                      )}
                      <button
                        onClick={() => deleteRow(idx)}
                        className="p-1 text-red-500 hover:bg-red-100 rounded"
                        title="–£–¥–∞–ª–∏—Ç—å"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      <div className="mt-3 text-xs text-gray-500 flex gap-4">
        <span>–í—Å–µ–≥–æ: {rows.length}</span>
        <span className="text-yellow-600">–ò–∑–º–µ–Ω–µ–Ω–æ: {rows.filter(r => r.changed).length}</span>
        <span className="text-green-600">–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ: {rows.filter(r => r.returnDate).length}</span>
      </div>
    </div>
  );
}
================================================================================
FILE: QMS-Client-main/src/routes.ts
================================================================================

import { AdminDefect_915_Categories } from "./pages/Admin/AdminDefectCategory/AdminDefect_915_Categories";
import { AdminDefect_2_4_Categories } from "./pages/Admin/AdminDefectCategory/AdminDefect_2_4_Categories";
import { AdminDefectCategories } from "./pages/Admin/AdminDefectCategory/AdminDefectCategories";
import { AdminPanel } from "./pages/Admin/AdminPanel";
import { AdminPCs } from "./pages/Admin/AdminPCs/AdminPCs";
import { AdminUsers } from "./pages/Admin/AdminUsers/AdminUsers";
import { StructurePage } from "./pages/Admin/Structure/StructurePage";
import { AuditLogPage } from "./pages/Admin/Audit/AuditLogPage";
import { Firmware2_4 } from "./pages/Firmware/Firmware2_4";
import { Firmware915_019 } from "./pages/Firmware/Firmware915_019";
import { Firmware915_002 } from "./pages/Firmware/Firmware915_002";
import { FirmwareFC } from "./pages/Firmware/FrimwareFC/FirmwareFC";
import { FirmwareOld } from "./pages/FirmwareOld/FirmwareOld";
import { FCs } from "./pages/Tables/FlightController/FCs";
import { InputDefect } from "./pages/InputDefect/InputDefect";
import { KnowledgeBase } from "./pages/KnowledgeBase/KnowledgeBase";
import { SelectPC } from "./pages/PCs/SelectPC";
import { Profile } from "./pages/Profile/Profile";
import { StartPage } from "./pages/StartPage/StartPage";
import { Users } from "./pages/Users/Users";
import { ELRS915s } from "./pages/Tables/ELRS915s/ELRS915s";
import { ELRS24s } from "./pages/Tables/ELRS24s/ELRS24s";
import { Betaflight } from "./pages/BetaFlight/Betaflight";
import { MqttCheckFC } from "./pages/MqttCheck/MqttCheckFC";
import { MqttCheckESC } from "./pages/MqttCheck/MqttCheckESC";
import { AdminProducts } from "./pages/Admin/AdminProducts/AdminProducts";
import { AdmProdStatuses } from "./pages/Admin/AdminProducts/AdmProdStatuses/AdmProdStatuses";
import { AdmProdComponents } from "./pages/Admin/AdminProd_Components/AdmProdComponents";
import { FirmwareCoralB } from "./pages/Firmware/FirmwareCoralB/FIrmwareCoralB";
import { CoralBs } from "./pages/Tables/CoralBs/CoralBs";
import { AdminDefect_Coral_B_categories } from "./pages/Admin/AdminDefectCategory/AdminDefect_Coral_B_categories";
import RankingsPage from "./pages/Rankings/RankingsPage";
import { RankingsChartsPage } from "./pages/Rankings/RankingsChartsPage";
import { Login } from "./pages/Login/Login";
import { Registration } from "./pages/Login/Registration";

import { WarehousePage as AdminWarehousePage } from "./pages/Admin/Warehouse/WarehousePage";
import { WarehousePage as UserWarehousePage } from "./pages/Warehouse/WarehousePage";
import { AnalyticsPage } from "./pages/Warehouse/AnalyticsPage";
import { InventoryPage } from "./pages/Warehouse/InventoryPage";

import { AssemblyRoutesPage } from "./pages/Assembly/AssemblyRoutesPage";
import { AssemblyWorkPage } from "./pages/Assembly/AssemblyWorkPage";

import { RecipeConstructorPage } from "./pages/AssemblyRecipes/RecipeConstructorPage";
import { RecipeExecutionPage } from "./pages/AssemblyRecipes/RecipeExecutionPage";
import { AssembledProductsPage } from "./pages/AssemblyRecipes/AssembledProductsPage";

import TasksPage from "./pages/Tasks/TasksPage";

import { AdminRightsPage } from "./pages/Admin/RBAC/AdminRightsPage";

import { ProductionDashboard } from "./pages/Analytics/ProductionDashboard";

import BeryllPage from "./pages/Beryll/BeryllPage";
import { ServerDetailPage } from "./pages/Beryll/pages/ServerDetailPage";
import { BatchDetailPage } from "./pages/Beryll/pages/BatchDetailPage";
import BeryllMonitoringPage from "./pages/Beryll/BeryllMonitoringPage";
import ComponentRevisionsPage from "./pages/Beryll/ComponentRevisionsPage";

import { DefectsPage } from "./pages/Defects/DefectsPage";
import { DefectDetailPage } from "./pages/Defects/DefectDetailPage";
import { AdminDefectCategoriesPage } from "./pages/Admin/AdminDefectCategoriesPage";

import ProductionPage from "./pages/Production/ProductionPage";

import {
  ADMIN_COMPONENTS_ROUTE,
  ADMIN_DEFECTS_2_4_CATEGORIES_ROUTE,
  ADMIN_DEFECTS_915_CATEGORIES_ROUTE,
  ADMIN_DEFECTS_CORAL_B_CATEGORIES_ROUTE,
  ADMIN_DEFECTS_FC_CATEGORIES_ROUTE,
  ADMIN_PCs_ROUTE,
  ADMIN_PRODUCTS_ROUTE,
  ADMIN_PRODUCTS_STATUSES_ROUTE,
  ADMIN_ROUTE,
  ADMIN_USERS_ROUTE,
  BETAFLIGHT_ROUTE,
  CORAL_B_ROUTE,
  ELRS_2_4_ROUTE,
  ELRS_915_ROUTE,
  FC_ROUTE,
  FIRMWARE_2_4_ROUTE,
  FIRMWARE_915_002_ROUTE,
  FIRMWARE_915_019_ROUTE,
  FIRMWARE_Coral_B_ROUTE,
  FIRMWARE_FC_ROUTE,
  FIRMWARE_OLD_ROUTE,
  INPUT_DEFECT_ROUTE,
  KNOWLEDGE_BASE_ROUTE,
  MQTT_CHECK_ESC_ROUTE,
  MQTT_CHECK_FC_ROUTE,
  PROFILE_ROUTE,
  SELECT_PC_ROUTE,
  START_ROUTE,
  USERS_ROUTE,
  RANKINGS_ROUTE,
  RANKINGS_CHARTS_ROUTE,
  STRUCTURE_ROUTE,
  AUDIT_LOG_ROUTE,
  ADMIN_WAREHOUSE_ROUTE,
  WAREHOUSE_ROUTE,
  WAREHOUSE_ANALYTICS_ROUTE,
  WAREHOUSE_INVENTORY_ROUTE,
  ASSEMBLY_ROUTE,
  ADMIN_ASSEMBLY_ROUTES_ROUTE,
  TASKS_ROUTE,
  RECIPE_CONSTRUCTOR_ROUTE,
  RECIPE_EXECUTION_ROUTE,
  ASSEMBLED_PRODUCTS_ROUTE,
  ADMIN_RBAC_ROUTE,
  ANALYTICS_DASHBOARD_ROUTE,
  BERYLL_ROUTE,
  BERYLL_SERVER_ROUTE,
  BERYLL_BATCH_ROUTE,
  BERYLL_MONITORING_ROUTE,
  BERYLL_REVISIONS_ROUTE,
  DEFECTS_ROUTE,
  DEFECT_DETAIL_ROUTE,
  ADMIN_DEFECT_CATEGORIES_ROUTE,
  PRODUCTION_ROUTE,
  LOGIN_ROUTE,
  REGISTRATION_ROUTE,
} from "./utils/consts";

export const authRoutes = [
  { path: FC_ROUTE, Component: FCs },
  { path: ELRS_915_ROUTE, Component: ELRS915s },
  { path: ELRS_2_4_ROUTE, Component: ELRS24s },
  { path: CORAL_B_ROUTE, Component: CoralBs },
  { path: FIRMWARE_OLD_ROUTE, Component: FirmwareOld },
  { path: FIRMWARE_FC_ROUTE, Component: FirmwareFC },
  { path: FIRMWARE_915_019_ROUTE, Component: Firmware915_019 },
  { path: FIRMWARE_915_002_ROUTE, Component: Firmware915_002 },
  { path: FIRMWARE_2_4_ROUTE, Component: Firmware2_4 },
  { path: FIRMWARE_Coral_B_ROUTE, Component: FirmwareCoralB },
  { path: MQTT_CHECK_FC_ROUTE, Component: MqttCheckFC },
  { path: MQTT_CHECK_ESC_ROUTE, Component: MqttCheckESC },
  { path: SELECT_PC_ROUTE, Component: SelectPC },
  { path: KNOWLEDGE_BASE_ROUTE, Component: KnowledgeBase },
  { path: PROFILE_ROUTE, Component: Profile },
  { path: RANKINGS_ROUTE, Component: RankingsPage },
  { path: RANKINGS_CHARTS_ROUTE, Component: RankingsChartsPage },
  { path: WAREHOUSE_ROUTE, Component: UserWarehousePage },
  { path: WAREHOUSE_ANALYTICS_ROUTE, Component: AnalyticsPage },
  { path: WAREHOUSE_INVENTORY_ROUTE, Component: InventoryPage },
  { path: ASSEMBLY_ROUTE, Component: AssemblyWorkPage },
  { path: RECIPE_EXECUTION_ROUTE, Component: RecipeExecutionPage },
  { path: RECIPE_CONSTRUCTOR_ROUTE, Component: RecipeConstructorPage },
  { path: ASSEMBLED_PRODUCTS_ROUTE, Component: AssembledProductsPage },
  { path: ANALYTICS_DASHBOARD_ROUTE, Component: ProductionDashboard },
  { path: TASKS_ROUTE, Component: TasksPage },
  { path: BERYLL_ROUTE, Component: BeryllPage },
  { path: BERYLL_SERVER_ROUTE, Component: ServerDetailPage },
  { path: BERYLL_BATCH_ROUTE, Component: BatchDetailPage },
  { path: BERYLL_MONITORING_ROUTE, Component: BeryllMonitoringPage },
  { path: BERYLL_REVISIONS_ROUTE, Component: ComponentRevisionsPage },
  { path: DEFECTS_ROUTE, Component: DefectsPage },
  { path: DEFECT_DETAIL_ROUTE, Component: DefectDetailPage },
  { path: PRODUCTION_ROUTE, Component: ProductionPage },
];

export const adminRoutes = [
  { path: ADMIN_ROUTE, Component: AdminPanel },
  { path: STRUCTURE_ROUTE, Component: StructurePage },
  { path: AUDIT_LOG_ROUTE, Component: AuditLogPage },
  { path: INPUT_DEFECT_ROUTE, Component: InputDefect },
  { path: ADMIN_PCs_ROUTE, Component: AdminPCs },
  { path: ADMIN_DEFECTS_FC_CATEGORIES_ROUTE, Component: AdminDefectCategories },
  { path: ADMIN_DEFECTS_915_CATEGORIES_ROUTE, Component: AdminDefect_915_Categories },
  { path: ADMIN_DEFECTS_2_4_CATEGORIES_ROUTE, Component: AdminDefect_2_4_Categories },
  { path: ADMIN_DEFECTS_CORAL_B_CATEGORIES_ROUTE, Component: AdminDefect_Coral_B_categories },
  { path: ADMIN_USERS_ROUTE, Component: AdminUsers },
  { path: ADMIN_PRODUCTS_ROUTE, Component: AdminProducts },
  { path: ADMIN_PRODUCTS_STATUSES_ROUTE, Component: AdmProdStatuses },
  { path: ADMIN_WAREHOUSE_ROUTE, Component: AdminWarehousePage },
  { path: ADMIN_COMPONENTS_ROUTE, Component: AdmProdComponents },
  { path: ADMIN_ASSEMBLY_ROUTES_ROUTE, Component: AssemblyRoutesPage },
  { path: ADMIN_RBAC_ROUTE, Component: AdminRightsPage },
  { path: ADMIN_DEFECT_CATEGORIES_ROUTE, Component: AdminDefectCategoriesPage },
];

export const publicRoutes = [
  { path: START_ROUTE, Component: StartPage },
  { path: USERS_ROUTE, Component: Users },
  { path: BETAFLIGHT_ROUTE, Component: Betaflight },
  { path: LOGIN_ROUTE, Component: Login },
  { path: REGISTRATION_ROUTE, Component: Registration },
];
================================================================================
FILE: QMS-Client-main/src/setupTests.ts
================================================================================

import '@testing-library/jest-dom';
================================================================================
FILE: QMS-Client-main/src/store/Coral_B_store.ts
================================================================================

import { makeAutoObservable } from "mobx";
import { Coral_B_ModelFull } from "src/types/BoardsForFlashModel";
import { defectModelFull } from "src/types/DefectModel";
import { pcModelFull } from "src/types/PCModel";
import { SessionModelFull } from "src/types/SessionModel";
import { userGetModel } from "src/types/UserModel";

export default class CoralBStore {

    private _sessions: SessionModelFull[] = [];
    private _defects_coral_B_categories: defectModelFull[] = [];
    private _PCs: pcModelFull[] = [];
    private _coralBs: Coral_B_ModelFull[] = [];
    private _users: userGetModel[] = [];
    private _selectedPC: pcModelFull | null = null
    private _selectedDefect: defectModelFull | null = null
    private _selectedUser: userGetModel | null = null
    private _selectedDate: string | null = null
    private _page: number = 1
    private _totalCount: number = 0
    private _limit: number = 30


    constructor() {
        makeAutoObservable(this);
    }

    setSessions(sessions: SessionModelFull[]) {
        this._sessions = sessions;
    }


    setDefect_coral_B_categories(defectCategories: defectModelFull[]) {
        this._defects_coral_B_categories = defectCategories;
    }

    setPCs(PCs: pcModelFull[]) {
        this._PCs = PCs;
    }

    setCoralBs(boards: Coral_B_ModelFull[]) {
        this._coralBs = boards;
    }

    setUsers(users: userGetModel[]) {
        this._users = users;
    }

    setSelectedPC(PC: pcModelFull) {
        this.setPage(1)
        this._selectedPC = PC;
    }

    setSelectedDate(date: string) {
        this._selectedDate = date;
    }


    setSelectedDefect(defect: defectModelFull) {
        this.setPage(1)
        this._selectedDefect = defect;
    }
    setSelectedUser(user: userGetModel) {
        this.setPage(1)
        this._selectedUser = user;
    }

    setPage(page: number) {
        this._page = page
    }
    setTotalCount(totalCount: number) {
        this._totalCount = totalCount
    }
    setLimit(limit: number) {
        this._limit = limit
    }
    resetSelectedDefect() {
        this._selectedDefect = null
    }

    get sessions() {
        return this._sessions;
    }


    get defect_coral_B_categories() {
        return this._defects_coral_B_categories;
    }

    get coralBs() {
        return this._coralBs;
    }

    get users() {
        return this._users;
    }

    get PCs() {
        return this._PCs;
    }
    get selectedPC() {
        return this._selectedPC
    }
    get selectedDefect() {
        return this._selectedDefect
    }
    get selectedUser() {
        return this._selectedUser
    }
    get selectedDate() {
        return this._selectedDate
    }
    get page() {
        return this._page
    }
    get totalCount() {
        return this._totalCount
    }
    get limit() {
        return this._limit
    }
}

================================================================================
FILE: QMS-Client-main/src/store/ELRS_915_and_2_4_store.ts
================================================================================

import { makeAutoObservable } from "mobx";
import { defectModelFull } from "src/types/DefectModel";
import { ELRS2_4ModelFull, ELRS915ModelFull } from "src/types/BoardsForFlashModel";
import { pcModelFull } from "src/types/PCModel";
import { SessionModelFull } from "src/types/SessionModel";
import { userGetModel } from "src/types/UserModel";

export default class ELRSStore {

    private _sessions: SessionModelFull[] = [];
    private _defect_915_Categories: defectModelFull[] = [];
    private _defect_2_4_Categories: defectModelFull[] = [];
    private _PCs: pcModelFull[] = [];
    private _ELRS915: ELRS915ModelFull[] = [];
    private _ELRS_2_4: ELRS2_4ModelFull[] = [];
    private _users: userGetModel[] = [];
    private _selectedPC: pcModelFull | null = null
    private _selectedDefect: defectModelFull | null = null
    private _selectedUser: userGetModel | null = null
    private _selectedDate: string | null = null
    private _page: number = 1
    private _totalCount: number = 0
    private _limit: number = 30


    constructor() {
        makeAutoObservable(this);
    }


    setDefect_915_Categories(defectCategories: defectModelFull[]) {
        this._defect_915_Categories = defectCategories;
    }
    setDefect_2_4_Categories(defectCategories: defectModelFull[]) {
        this._defect_2_4_Categories = defectCategories;
    }
    setPCs(PCs: pcModelFull[]) {
        this._PCs = PCs;
    }

    setELRS915s(boards: ELRS915ModelFull[]) {
        this._ELRS915 = boards;
    }
    setELRS_2_4s(boards: ELRS2_4ModelFull[]) {
        this._ELRS_2_4 = boards;
    }

    setSessions(sessions: SessionModelFull[]) {
        this._sessions = sessions;
    }
    setUsers(users: userGetModel[]) {
        this._users = users;
    }
    setSelectedDate(date: string) {
        this._selectedDate = date;
    }


    setSelectedPC(PC: pcModelFull) {
        this.setPage(1)
        this._selectedPC = PC;
    }
    setSelectedDefect(defect: defectModelFull) {
        this.setPage(1)
        this._selectedDefect = defect;
    }
    setSelectedUser(user: userGetModel) {
        this.setPage(1)
        this._selectedUser = user;
    }

    setPage(page: number) {
        this._page = page
    }
    setTotalCount(totalCount: number) {
        this._totalCount = totalCount
    }
    setLimit(limit: number) {
        this._limit = limit
    }
    resetSelectedDefect() {
        this._selectedDefect = null
    }

    get defect_915_Categories() {
        return this._defect_915_Categories;
    }
    get defect_2_4_Categories() {
        return this._defect_2_4_Categories;
    }

    get ELRS915() {
        return this._ELRS915;
    }
    get ELRS2_4() {
        return this._ELRS_2_4;
    }

    get PCs() {
        return this._PCs;
    }
    get sessions() {
        return this._sessions;
    }
    get users() {
        return this._users;
    }
    get selectedPC() {
        return this._selectedPC
    }
    get selectedDefect() {
        return this._selectedDefect
    }
    get selectedUser() {
        return this._selectedUser
    }
    get selectedDate() {
        return this._selectedDate
    }
    get page() {
        return this._page
    }
    get totalCount() {
        return this._totalCount
    }
    get limit() {
        return this._limit
    }
}

================================================================================
FILE: QMS-Client-main/src/store/FCStore.ts
================================================================================

import { makeAutoObservable } from "mobx";
import { defectModelFull } from "src/types/DefectModel";
import { fcModelFull } from "src/types/BoardsForFlashModel";
import { pcModelFull } from "src/types/PCModel";
import { SessionModelFull } from "src/types/SessionModel";
import { userGetModel } from "src/types/UserModel";

export default class FlightControllerStore {

  private _sessions: SessionModelFull[] = [];
  private _defectCategories: defectModelFull[] = [];
  private _PCs: pcModelFull[] = [];
  private _FCs: fcModelFull[] = [];
  private _users: userGetModel[] = [];
  private _selectedPC: pcModelFull | null = null
  private _selectedDefect: defectModelFull | null = null
  private _selectedUser: userGetModel | null = null
  private _selectedStartDate: string | null = null
  private _selectedEndDate: string | null = null

  private _page: number = 1
  private _totalCount: number = 0
  private _limit: number = 30


  constructor() {
    makeAutoObservable(this);
  }


  setDefectCategories(defectCategories: defectModelFull[]) {
    this._defectCategories = defectCategories;
  }
  setPCs(PCs: pcModelFull[]) {
    this._PCs = PCs;
  }
  setFCs(FCs: fcModelFull[]) {
    this._FCs = FCs;
  }
  setSessions(sessions: SessionModelFull[]) {
    this._sessions = sessions;
  }
  setUsers(users: userGetModel[]) {
    this._users = users;
  }
  setSelectedStartDate(date: string) {
    this._selectedStartDate = date;
  }
  setSelectedEndDate(date: string) {
    this._selectedEndDate = date;
  }


  setSelectedPC(PC: pcModelFull | null) {
    this.setPage(1)
    this._selectedPC = PC;
  }
  setSelectedDefect(defect: defectModelFull | null) {
    this.setPage(1)
    this._selectedDefect = defect;
  }
  setSelectedUser(user: userGetModel | null) {
    this.setPage(1)
    this._selectedUser = user;
  }

  setPage(page: number) {
    this._page = page
  }
  setTotalCount(totalCount: number) {
    this._totalCount = totalCount
  }
  setLimit(limit: number) {
    this._limit = limit
  }
  resetSelectedDefect() {
    this._selectedDefect = null
  }

  resetAll() {
     this._selectedPC = null;
  this._selectedDefect = null;
  this._selectedUser = null;
  this._selectedStartDate = null;
  this._selectedEndDate = null;
  this._page = 1;
  }
  get defectCategories() {
    return this._defectCategories;
  }
  get PCs() {
    return this._PCs;
  }
  get FCs() {
    return this._FCs;
  }
  get sessions() {
    return this._sessions;
  }
  get users() {
    return this._users;
  }
  get selectedPC() {
    return this._selectedPC
  }
  get selectedDefect() {
    return this._selectedDefect
  }
  get selectedUser() {
    return this._selectedUser
  }
  get selectedStartDate() {
    return this._selectedStartDate
  }
  get selectedEndDate() {
    return this._selectedEndDate
  }
  get page() {
    return this._page
  }
  get totalCount() {
    return this._totalCount
  }
  get limit() {
    return this._limit
  }
}

================================================================================
FILE: QMS-Client-main/src/store/Firmware915.ts
================================================================================

import { makeAutoObservable } from "mobx";

export default class Firmware915Store {
    _counterTotalForSession: number = 0;
    _countPort: number = 6
    _macAddress: { [key: number]: string } = {};
    _flashStatus: string[] = Array(this._countPort).fill("–ù–µ –ø—Ä–æ—à–∏—Ç–æ");
    _loading: boolean[] = Array(this._countPort).fill(false);
    _loadingMAC: boolean[] = Array(this._countPort).fill(false);
    _messageDB: string[] = Array(this._countPort).fill("–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ")
    _eraseFlashStatus: string[] = Array(this._countPort).fill("–ù–µ —Å–±—Ä–æ—à–µ–Ω–æ")

    constructor() {
        makeAutoObservable(this);
    }

    setMacAddress(port: number, macAddress: string) {
        this._macAddress[port] = macAddress;
    }

    resetMacAddress() {
        this._macAddress = {};
    }

    setFlashStatus(port: number, status: string) {
        this._flashStatus[port] = status;
    }

    setLoading(port: number, isLoading: boolean) {
        this._loading[port] = isLoading;
    }
    setLoadingMAC(port: number, isLoading: boolean) {
        this._loadingMAC[port] = isLoading;
    }
    setMessageDB(port: number, messageDB: string) {
        this._messageDB[port] = messageDB
    }

    setCountPort(count: number) {
        this._countPort = count;
    }
    setCountPortPlus() {
        this._countPort += 1;
    }
    setCountPortMinus() {
        this._countPort -= 1;
    }

    setCounterTotalForSessionPlus() {
        this._counterTotalForSession += 1;
    }
    resetCounterTotalForSession() {
        this._counterTotalForSession = 0;
    }

    setEraseFlashStatus(port: number, status: string) {
        this._eraseFlashStatus[port] = status
    }
    resetState() {
        this._macAddress = {};
        this._flashStatus = Array(this._countPort).fill("–ù–µ –ø—Ä–æ—à–∏—Ç–æ");
        this._loading = Array(this._countPort).fill(false);
        this._messageDB = Array(this._countPort).fill('–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
        this._eraseFlashStatus = Array(this._countPort).fill("–ù–µ —Å–±—Ä–æ—à–µ–Ω–æ")

    }

    get macAddress() {
        return this._macAddress;
    }

    get flashStatus() {
        return this._flashStatus;
    }

    get loading() {
        return this._loading;
    }
    get loadingMAC() {
        return this._loadingMAC;
    }
    get messageDB() {
        return this._messageDB;
    }
    get countPort() {
        return this._countPort;
    }
    get counterTotalForSession() {
        return this._counterTotalForSession;
    }
    get eraseFlashStatus() {
        return this._eraseFlashStatus
    }
}

================================================================================
FILE: QMS-Client-main/src/store/FirmwareCoralB.ts
================================================================================

import { makeAutoObservable } from "mobx";

export default class FirmwareCoralBStore {
    _firmwareVersion: string | null = null;
    _SAW_mode: boolean | null = null;
    _counterTotalForSession: number = 0;
    _countPort: number = 4
    _serial: { [key: number]: string } = {};
    _flashStatus: string[] = Array(this._countPort).fill("–ù–µ –ø—Ä–æ—à–∏—Ç–æ");
    _loading: boolean[] = Array(this._countPort).fill(false);
    _messageDB: string[] = Array(this._countPort).fill("–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ")

    constructor() {
        makeAutoObservable(this);
    }
    setFirmwareVersion(version: string) {
        this._firmwareVersion = version;
    }

    setSAW_mode(saw:boolean){
        this._SAW_mode= saw;
    }

    setSerial(port: number, serial: string) {
        this._serial[port] = serial;
    }

    resetSerial() {
        this._serial = {};
    }

    setFlashStatus(port: number, status: string) {
        this._flashStatus[port] = status;
    }

    setLoading(port: number, isLoading: boolean) {
        this._loading[port] = isLoading;
    }

    setMessageDB(port: number, messageDB: string) {
        this._messageDB[port] = messageDB
    }


    setCounterTotalForSessionPlus() {
        this._counterTotalForSession += 1;
    }
    resetCounterTotalForSession() {
        this._counterTotalForSession = 0;
    }


    resetState() {
        this._serial = {};
        this._flashStatus = Array(this._countPort).fill("–ù–µ –ø—Ä–æ—à–∏—Ç–æ");
        this._loading = Array(this._countPort).fill(false);
        this._messageDB = Array(this._countPort).fill('–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');

    }

    get firmwareVersion() {
        return this._firmwareVersion
    }

    get SAW_mode(){
        return this._SAW_mode
    }

    get serial() {
        return this._serial;
    }

    get flashStatus() {
        return this._flashStatus;
    }

    get loading() {
        return this._loading;
    }

    get messageDB() {
        return this._messageDB;
    }
    get countPort() {
        return this._countPort;
    }
    get counterTotalForSession() {
        return this._counterTotalForSession;
    }

}

================================================================================
FILE: QMS-Client-main/src/store/FirmwareFC.ts
================================================================================

import { makeAutoObservable } from "mobx";

export default class FirmwareFCStore {
  _counterTotalForSession: number = 0;
  _countPort: number = 5
  _serialIdsFC: { [key: number]: string } = {};
  _flashStatus: string[] = Array(this._countPort).fill("–ù–µ –ø—Ä–æ—à–∏—Ç–æ");
  _loading: boolean[] = Array(this._countPort).fill(false);
  _messageDB: string[] = Array(this._countPort).fill("–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ")
  private _proMode: boolean = false


  constructor() {
    makeAutoObservable(this);
  }

  setSerialIdsFC(port: number, serialId: string) {
    this._serialIdsFC[port] = serialId;
  }

  resetSerialIds() {
    this._serialIdsFC = {};
  }

  setFlashStatus(port: number, status: string) {
    this._flashStatus[port] = status;
  }

  setLoading(port: number, isLoading: boolean) {
    this._loading[port] = isLoading;
  }
  setMessageDB(port: number, messageDB: string) {
    this._messageDB[port] = messageDB
  }


  setCountPort(count: number) {
    this._countPort = count;
  }
  setCountPortPlus() {
    this._countPort += 1;
  }
  setCountPortMinus() {
    this._countPort -= 1;
  }

  setCounterTotalForSessionPlus() {
    this._counterTotalForSession += 1;
  }
  setProMode(){
    const current = this._proMode
    this._proMode = !current
  }
  resetCounterTotalForSession() {
    this._counterTotalForSession = 0;
  }

  resetState() {
    this._serialIdsFC = {};
    this._flashStatus = Array(this._countPort).fill("–ù–µ –ø—Ä–æ—à–∏—Ç–æ");
    this._loading = Array(this._countPort).fill(false);
    this._messageDB = Array(this._countPort).fill('–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');

  }

  get serialIdsFC() {
    return this._serialIdsFC;
  }

  get flashStatus() {
    return this._flashStatus;
  }

  get loading() {
    return this._loading;
  }

  get countPort() {
    return this._countPort;
  }
  get counterTotalForSession() {
    return this._counterTotalForSession;
  }
  get messageDB() {
    return this._messageDB;
  }
    get proMode(){
    return this._proMode
  }
}

================================================================================
FILE: QMS-Client-main/src/store/ProductStore.ts
================================================================================

import { makeAutoObservable } from "mobx"
import { componentModel, connectionProduct_ComponentModel } from "src/types/ComponentModel"
import { productModel, productStatusModel } from "src/types/ProductModel"


export default class ProductStore {

    private _referencesProducts: productModel[] | null = null
    private _selectedProduct: productModel | null = null
    private _products: productModel[] | null = null
    private _components: componentModel[] | null = null
    private _referencesComponents: componentModel[] | null = null
    private _productStatus: productStatusModel[] | null = null
    private _connectionProduct_Component: connectionProduct_ComponentModel[] | null = null


    constructor() {
        makeAutoObservable(this)
    }

    setReferencesProducts(referencesProducts: productModel[]) {
        this._referencesProducts = referencesProducts
    }
    setSelectedProduct(selectedProduct: productModel) {
        this._selectedProduct = selectedProduct
    }

    setProducts(products: productModel[]) {
        this._products = products
    }
    setComponents(components: componentModel[]) {
        this._components = components
    }
    setReferencesComponents(components: componentModel[]) {
        this._referencesComponents = components
    }
    setProductStatus(productStatus: productStatusModel[]) {
        this._productStatus = productStatus
    }
    setConnectionProduct_Component(connectionProduct_Component: connectionProduct_ComponentModel[]) {
        this._connectionProduct_Component = connectionProduct_Component
    }

    get referencesProducts() {
        return this._referencesProducts
    }
    get selectedProduct() {
        return this._selectedProduct
    }

    get products() {
        return this._products
    }
    get components() {
        return this._components
    }
    get referencesComponents() {
        return this._referencesComponents
    }
    get productStatus() {
        return this._productStatus
    }
    get connectionProduct_Component() {
        return this._connectionProduct_Component
    }
}

================================================================================
FILE: QMS-Client-main/src/store/StructureStore.ts
================================================================================

import { makeAutoObservable } from "mobx";
import { userGetModel } from "src/types/UserModel";

export interface TeamModel {
    id: number;
    title: string;
    sectionId: number;
    teamLead: userGetModel | null;
    users: userGetModel[];
}

export interface SectionModel {
    id: number;
    title: string;
    manager: userGetModel | null;
    production_teams: TeamModel[];
}

export default class StructureStore {
    sections: SectionModel[] = [];

    constructor() {
        makeAutoObservable(this);
    }

    setSections(sections: SectionModel[]) {
        this.sections = sections;
    }
}

================================================================================
FILE: QMS-Client-main/src/store/UserStore.ts
================================================================================

import { makeAutoObservable } from "mobx"
import { userModel } from "src/types/UserModel"

export default class UserStore {
    private _isAuth: boolean = false
    private _user: userModel | null = null

    constructor() {
        makeAutoObservable(this)
    }

    setIsAuth(bool: boolean) {
        this._isAuth = bool
    }

    setUser(user: userModel) {
        this._user = user
    }

    resetUser() {
        this._user = null
        this._isAuth = false
    }


    can(permission: string): boolean {
        if (!this._user) return false;


        if (this._user.role === 'SUPER_ADMIN') return true;


        return this._user.abilities?.includes(permission) || false;
    }


    hasRole(role: string): boolean {
        return this._user?.role === role;
    }


    get user() {
        return this._user
    }

    get isAuth() {
        return this._isAuth
    }


    get isAdmin() {
        return this.can('admin.access') || this.can('rbac.manage');
    }
}

================================================================================
FILE: QMS-Client-main/src/store/__tests__/UserStore.test.ts
================================================================================

import { describe, it, expect, beforeEach } from 'vitest';
import UserStore from '../UserStore';

describe('UserStore RBAC', () => {
    let store: UserStore;

    beforeEach(() => {
        store = new UserStore();
    });

    it('SUPER_ADMIN –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É', () => {
        store.setUser({
            id: 1, login: 'admin', name: 'Adm', surname: 'Adm', role: 'SUPER_ADMIN', abilities: [], exp:0, iat:0, img: null
        });

        expect(store.can('warehouse.view')).toBe(true);
        expect(store.can('nuclear.launch')).toBe(true);
    });

    it('–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–∞–≤–∞', () => {
        store.setUser({
            id: 2, login: 'user', name: 'User', surname: 'U', role: 'USER',
            abilities: ['warehouse.view'],
            exp:0, iat:0, img: null
        });

        expect(store.can('warehouse.view')).toBe(true);
        expect(store.can('users.manage')).toBe(false);
    });

    it('–ì–æ—Å—Ç—å (–Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω) –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∞–≤', () => {
        store.resetUser();
        expect(store.can('warehouse.view')).toBe(false);
    });
});

================================================================================
FILE: QMS-Client-main/src/types/AssemblyModels.ts
================================================================================

export interface AssemblyRouteStepModel {
  id: number;
  routeId: number;
  order: number;
  title: string;
  operation: string;
  sectionId: number | null;
  teamId: number | null;
  description: string | null;

  section?: {
    id: number;
    title: string;
  } | null;

  team?: {
    id: number;
    title: string;
  } | null;
}

export interface AssemblyRouteModel {
  id: number;
  title: string;
  productName: string | null;
  description: string | null;
  isActive: boolean;
  createdById: number;
  createdAt: string;
  updatedAt: string;

  steps?: AssemblyRouteStepModel[];
}


export interface SaveAssemblyRouteDto {
  id?: number;
  title: string;
  productName?: string;
  description?: string;
  isActive?: boolean;
  steps?: {
    id?: number;
    order: number;
    title: string;
    operation: string;
    sectionId?: number | null;
    teamId?: number | null;
    description?: string | null;
  }[];
}

================================================================================
FILE: QMS-Client-main/src/types/AuditLogModel.ts
================================================================================

export interface AuditLogUserShort {
  id: number;
  login: string;
  name: string;
  surname: string;
}

export interface AuditLogMetadata {
  ip?: string | null;
  userAgent?: string | null;
  PCId?: number | null;
  pcName?: string | null;
  pcIp?: string | null;

  [key: string]: any;
}

export interface AuditLogModel {
  id: number;
  userId: number | null;
  action: string;
  entity: string | null;
  entityId: string | null;
  description: string | null;
  metadata: AuditLogMetadata | null;
  createdAt: string;
  updatedAt: string;
  User?: AuditLogUserShort | null;
}

================================================================================
FILE: QMS-Client-main/src/types/BoardsForFlashModel.ts
================================================================================

export interface fcModelFull {
    id: number;
    unique_device_id: string;
    firmware: boolean;
    stand_test: boolean;
    sessionId: number;
    categoryDefectId: number;
    createdAt: string;
    updatedAt: string;
}
export interface fcModelMed {
    id: number;
    firmware: boolean;
    sessionId: number;
    categoryDefectId: number;
}

export interface fcModelShort {
    unique_device_id: string;
    firmware: boolean;
    sessionId: number;
    categoryDefectId: number;
}

export interface ELRS915ModelFull {
    id: number;
    MAC_address: string;
    firmware: boolean;
    sessionId: number;
    categoryDefect915Id: number;
    firmwareVersion: string;
    createdAt: string;
    updatedAt: string;
}

export interface ELRS2_4ModelFull {
    id: number;
    MAC_address: string;
    firmware: boolean;
    sessionId: number;
    categoryDefect24Id: number;
    createdAt: string;
    updatedAt: string;
}


export interface Coral_B_ModelFull {
    id: number;
    serial: string;
    firmware: boolean;
    SAW_filter: boolean;
    firmwareVersion: string;
    sessionId: number;
    categoryDefectCoralBId: number;
    createdAt: string;
    updatedAt: string;
}
================================================================================
FILE: QMS-Client-main/src/types/ComponentModel.ts
================================================================================

import { productModel } from "./ProductModel";

export interface componentModel {
    id: number;
    title: string;
    article: string;
    quantity: number;
    image: string;
    createdAt: string;
    updatedAt: string;
}

export interface connectionProduct_ComponentModel {
    id: number;
    product_id: number;
    component_id: number;
    required_quantity: number;
    createdAt: string;
    updatedAt: string;
    Product: productModel;
    Component: componentModel;
}
================================================================================
FILE: QMS-Client-main/src/types/DefectModel.ts
================================================================================

export interface defectModelFull {
    id: number;
    title: string;
    description: string;
    createdAt: string;
    updatedAt: string;
}
export interface defectModelMed {
    id: number;
    title: string;
    description: string;
}
export interface defectModelShort {
    title: string;
    description: string;
}
================================================================================
FILE: QMS-Client-main/src/types/DefectTypes.ts
================================================================================



export interface DefectCategory {
  id: number;
  code: string;
  title: string;
  description: string | null;
  severity: "CRITICAL" | "MAJOR" | "MINOR";
  applicableTypes: string[];
  isActive: boolean;
  createdAt: string;
  updatedAt: string;
}

export interface CreateDefectCategoryDto {
  code: string;
  title: string;
  description?: string;
  severity?: "CRITICAL" | "MAJOR" | "MINOR";
  applicableTypes?: string[];
}

export interface UpdateDefectCategoryDto {
  code?: string;
  title?: string;
  description?: string;
  severity?: "CRITICAL" | "MAJOR" | "MINOR";
  applicableTypes?: string[];
  isActive?: boolean;
}


export type BoardType = "FC" | "ELRS_915" | "ELRS_2_4" | "CORAL_B" | "SMARAGD";

export type DefectStatus =
  | "OPEN"
  | "IN_REPAIR"
  | "REPAIRED"
  | "VERIFIED"
  | "SCRAPPED"
  | "RETURNED"
  | "CLOSED";

export type FinalResult =
  | "FIXED"
  | "SCRAPPED"
  | "RETURNED_TO_SUPPLIER"
  | "FALSE_POSITIVE";

export interface UserShort {
  id: number;
  name: string;
  surname: string;
}

export interface BoardDefect {
  id: number;
  boardType: BoardType;
  boardId: number | null;
  serialNumber: string | null;
  categoryId: number;
  description: string | null;
  detectedById: number;
  detectedAt: string;
  status: DefectStatus;
  closedById: number | null;
  closedAt: string | null;
  finalResult: FinalResult | null;
  totalRepairMinutes: number;
  createdAt: string;
  updatedAt: string;


  category?: DefectCategory;
  detectedBy?: UserShort;
  closedBy?: UserShort;
  repairs?: RepairAction[];
}

export interface CreateDefectDto {
  boardType: BoardType;
  boardId?: number | null;
  serialNumber?: string | null;
  categoryId: number;
  description?: string;
}

export interface DefectsResponse {
  defects: BoardDefect[];
  total: number;
  page: number;
  totalPages: number;
  stats: Record<DefectStatus, number>;
}

export interface DefectDetailResponse {
  defect: BoardDefect;
  boardInfo: any | null;
}


export type ActionType =
  | "DIAGNOSIS"
  | "SOLDER"
  | "REPLACE"
  | "FLASH"
  | "TEST"
  | "CLEAN"
  | "CLONE_DISK"
  | "CABLE_REPLACE"
  | "OTHER";

export type ActionResult = "SUCCESS" | "PARTIAL" | "FAILED" | "PENDING";

export interface RepairAction {
  id: number;
  boardDefectId: number;
  actionType: ActionType;
  performedById: number;
  performedAt: string;
  description: string;
  timeSpentMinutes: number | null;
  result: ActionResult;
  createdAt: string;
  updatedAt: string;


  performedBy?: UserShort;
}

export interface CreateRepairActionDto {
  actionType: ActionType;
  description: string;
  timeSpentMinutes?: number;
  result?: ActionResult;
}

export interface MarkRepairedDto {
  repairNote?: string;
  timeSpentMinutes?: number;
}

export interface MarkScrappedDto {
  reason?: string;
}


export interface DefectStatistics {
  byStatus: Array<{ status: DefectStatus; count: number }>;
  byCategory: Array<{ categoryId: number; count: number; "category.title"?: string }>;
  byBoardType: Array<{ boardType: BoardType; count: number }>;
  avgRepairTime: number | null;
}


export const BOARD_TYPE_LABELS: Record<BoardType, string> = {
  FC: "–ü–æ–ª—ë—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (FC)",
  ELRS_915: "ELRS 915 –ú–ì—Ü",
  ELRS_2_4: "ELRS 2.4 –ì–ì—Ü",
  CORAL_B: "Coral B",
  SMARAGD: "–°–º–∞—Ä–∞–≥–¥"
};

export const BOARD_TYPE_SHORT: Record<BoardType, string> = {
  FC: "FC",
  ELRS_915: "ELRS 915",
  ELRS_2_4: "ELRS 2.4",
  CORAL_B: "Coral B",
  SMARAGD: "–°–º–∞—Ä–∞–≥–¥"
};

export const DEFECT_STATUS_LABELS: Record<DefectStatus, string> = {
  OPEN: "–ñ–¥—ë—Ç —Ä–µ–º–æ–Ω—Ç–∞",
  IN_REPAIR: "–í —Ä–µ–º–æ–Ω—Ç–µ",
  REPAIRED: "–û—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ",
  VERIFIED: "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –û–¢–ö",
  SCRAPPED: "–°–ø–∏—Å–∞–Ω–æ",
  RETURNED: "–í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫—É",
  CLOSED: "–ó–∞–∫—Ä—ã—Ç–æ"
};

export const DEFECT_STATUS_COLORS: Record<DefectStatus, string> = {
  OPEN: "bg-red-100 text-red-700",
  IN_REPAIR: "bg-yellow-100 text-yellow-700",
  REPAIRED: "bg-blue-100 text-blue-700",
  VERIFIED: "bg-green-100 text-green-700",
  SCRAPPED: "bg-gray-100 text-gray-700",
  RETURNED: "bg-purple-100 text-purple-700",
  CLOSED: "bg-gray-100 text-gray-500"
};

export const SEVERITY_LABELS: Record<string, string> = {
  CRITICAL: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π",
  MAJOR: "–°–µ—Ä—å—ë–∑–Ω—ã–π",
  MINOR: "–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π"
};

export const SEVERITY_COLORS: Record<string, string> = {
  CRITICAL: "bg-red-100 text-red-700",
  MAJOR: "bg-yellow-100 text-yellow-700",
  MINOR: "bg-gray-100 text-gray-600"
};

export const ACTION_TYPE_LABELS: Record<ActionType, string> = {
  DIAGNOSIS: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
  SOLDER: "–ü–∞–π–∫–∞",
  REPLACE: "–ó–∞–º–µ–Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞",
  FLASH: "–ü—Ä–æ—à–∏–≤–∫–∞",
  TEST: "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
  CLEAN: "–ß–∏—Å—Ç–∫–∞",
  CLONE_DISK: "–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞",
  CABLE_REPLACE: "–ó–∞–º–µ–Ω–∞ –∫–∞–±–µ–ª—è",
  OTHER: "–î—Ä—É–≥–æ–µ"
};

export const ACTION_TYPE_ICONS: Record<ActionType, string> = {
  DIAGNOSIS: "üîç",
  SOLDER: "üîß",
  REPLACE: "üîÑ",
  FLASH: "üíæ",
  TEST: "üß™",
  CLEAN: "üßπ",
  CLONE_DISK: "üíø",
  CABLE_REPLACE: "üîå",
  OTHER: "üìù"
};

export const ACTION_RESULT_LABELS: Record<ActionResult, string> = {
  SUCCESS: "–£—Å–ø–µ—à–Ω–æ",
  PARTIAL: "–ß–∞—Å—Ç–∏—á–Ω–æ",
  FAILED: "–ù–µ—É–¥–∞—á–∞",
  PENDING: "–í –ø—Ä–æ—Ü–µ—Å—Å–µ"
};

export const ACTION_RESULT_COLORS: Record<ActionResult, string> = {
  SUCCESS: "text-green-600",
  PARTIAL: "text-yellow-600",
  FAILED: "text-red-600",
  PENDING: "text-gray-500"
};

================================================================================
FILE: QMS-Client-main/src/types/PCModel.ts
================================================================================

export interface pcModelFull {
    id: number;
    ip: string;
    pc_name: string;
    cabinet: string;
    createdAt: string;
    updatedAt: string;
}
export interface pcModelMed {
    id: number;
    ip: string;
    pc_name: string;
    cabinet: string;
}
export interface pcModelShort {
    ip: string;
    pc_name: string;
    cabinet: string;
}
================================================================================
FILE: QMS-Client-main/src/types/ProductModel.ts
================================================================================

export interface productModel {
    id: number;
    title: string;
    status_id: number;
    createdAt: string;
    updatedAt: string;
    Status: productStatusModel
}

export interface productStatusModel {
    id: number;
    title: string;
    createdAt: string;
    updatedAt: string;
}
================================================================================
FILE: QMS-Client-main/src/types/SessionModel.ts
================================================================================

export interface SessionModelFull {
    id: number;
    online: boolean;
    userId: number;
    PCId: number;
    createdAt: string;
    updatedAt: string;
}
export interface SessionModelShort {
    online: boolean;
    userId: number;
    PCId: number;
}
================================================================================
FILE: QMS-Client-main/src/types/UserModel.ts
================================================================================

export interface userModel {
    exp: number;
    iat: number;
    id: number;
    login: string;
    name: string;

    role: "SUPER_ADMIN" | "PRODUCTION_CHIEF" | "TECHNOLOGIST" | "WAREHOUSE_MASTER" | "ASSEMBLER" | "QC_ENGINEER" | "FIRMWARE_OPERATOR" | string;
    surname: string;
    img: string | null;
    abilities?: string[];
}

export interface userGetModel {
    id: number;
    login: string;
    password: string;
    role: string;
    name: string;
    surname: string;
    img: string | null;
    createdAt: string;
    updatedAt: string;
    abilities?: string[];
}

export interface userModelShort {
    login: string;
    password: string;
}

================================================================================
FILE: QMS-Client-main/src/types/WarehouseModels.ts
================================================================================

export interface WarehouseUserShort {
  id: number;
  login: string;
  name: string;
  surname: string;
}

export interface WarehouseSectionShort {
  id: number;
  title: string;
}

export interface WarehouseTeamShort {
  id: number;
  title: string;
}


export interface SupplyModel {
  id: number;
  supplier: string | null;
  docNumber: string | null;
  status: string;
  comment: string | null;
  expectedDate: string | null;
  createdAt: string;
  updatedAt: string;
}


export interface InventoryBoxModel {
  id: number;
  supplyId: number | null;


  qrCode: string;
  shortCode: string | null;

  label: string;

  originType: string | null;
  originId: number | null;


  quantity: number;
  unit: string;


  parentBoxId: number | null;


  boxNumber: string | null;
  kitNumber: string | null;
  projectName: string | null;
  batchName: string | null;

  status: string;
  notes: string | null;

  currentSectionId: number | null;
  currentTeamId: number | null;

  createdAt: string;
  updatedAt: string;

  section?: WarehouseSectionShort | null;
  team?: WarehouseTeamShort | null;
  currentSection?: WarehouseSectionShort | null;
  currentTeam?: WarehouseTeamShort | null;
  supply?: SupplyModel | null;
}

export interface WarehouseMovement {
  id: number;
  boxId: number;

  fromSectionId: number | null;
  toSectionId: number | null;
  fromTeamId: number | null;
  toTeamId: number | null;

  operation: string;
  statusAfter: string | null;

  deltaQty: number;
  goodQty?: number | null;
  scrapQty?: number | null;

  performedAt: string;
  comment: string | null;

  performedBy?: WarehouseUserShort;
  fromSection?: WarehouseSectionShort;
  toSection?: WarehouseSectionShort;
  fromTeam?: WarehouseTeamShort;
  toTeam?: WarehouseTeamShort;
}

export interface WarehouseDocument {
    id: number;
    boxId: number | null;
    number: string;
    type: string | null;
    date: string | null;
    fileUrl: string | null;
    comment: string | null;
    createdById: number;
    createdAt: string;
    updatedAt: string;
    createdBy?: WarehouseUserShort;
}

export interface WarehouseUserShort {
  id: number;
  login: string;
  name: string;
  surname: string;
}

export interface WarehouseSectionShort {
  id: number;
  title: string;
}

export interface WarehouseTeamShort {
  id: number;
  title: string;
}

export interface SupplyModel {
  id: number;
  supplier: string | null;
  docNumber: string | null;
  status: string;
  comment: string | null;
  expectedDate: string | null;
  createdAt: string;
  updatedAt: string;
}

export interface InventoryBoxModel {
  id: number;
  supplyId: number | null;
  qrCode: string;
  shortCode: string | null;
  label: string;
  originType: string | null;
  originId: number | null;
  quantity: number;
  unit: string;
  parentBoxId: number | null;
  kitNumber: string | null;
  projectName: string | null;
  batchName: string | null;
  status: string;
  notes: string | null;
  currentSectionId: number | null;
  currentTeamId: number | null;
  createdAt: string;
  updatedAt: string;
  section?: WarehouseSectionShort | null;
  team?: WarehouseTeamShort | null;
  currentSection?: WarehouseSectionShort | null;
  currentTeam?: WarehouseTeamShort | null;
  supply?: SupplyModel | null;
}

export interface WarehouseMovement {
  id: number;
  boxId: number;
  documentId?: number | null;
  fromSectionId: number | null;
  toSectionId: number | null;
  fromTeamId: number | null;
  toTeamId: number | null;
  operation: string;
  statusAfter: string | null;
  deltaQty: number;
  goodQty?: number | null;
  scrapQty?: number | null;
  performedAt: string;
  comment: string | null;
  performedBy?: WarehouseUserShort;
  fromSection?: WarehouseSectionShort;
  toSection?: WarehouseSectionShort;
  fromTeam?: WarehouseTeamShort;
  toTeam?: WarehouseTeamShort;
}

export interface WarehouseDocument {
    id: number;
    boxId: number | null;
    number: string;
    type: string | null;
    date: string | null;
    fileUrl: string | null;
    comment: string | null;
    createdById: number;
    createdAt: string;
    updatedAt: string;
    createdBy?: WarehouseUserShort;
}

export interface StockBalanceItem {
    label: string;
    originType: string | null;
    originId: number | null;
    unit: string;
    totalQuantity: string;
    boxCount: string;
}

================================================================================
FILE: QMS-Client-main/src/types/beryll/components.ts
================================================================================



export type ComponentType =
  | 'CPU'
  | 'RAM'
  | 'HDD'
  | 'SSD'
  | 'NVME'
  | 'NIC'
  | 'MOTHERBOARD'
  | 'PSU'
  | 'GPU'
  | 'RAID'
  | 'BMC'
  | 'FAN'
  | 'CHASSIS'
  | 'OTHER';

export type ComponentStatus = 'OK' | 'WARNING' | 'CRITICAL' | 'UNKNOWN' | 'REPLACED';

export type DataSource = 'BMC' | 'REDFISH' | 'MANUAL' | 'IMPORT' | 'REPLACEMENT';

export type BMCDiscrepancyReason =
  | 'NOT_FOUND_IN_BMC'
  | 'REMOVED_FROM_BMC'
  | 'DATA_MISMATCH'
  | 'SERIAL_CHANGED';


export interface ServerComponent {
  id: number;
  serverId: number;


  componentType: ComponentType;
  name: string;


  manufacturer?: string;
  model?: string;


  serialNumber?: string;
  serialNumberYadro?: string;
  partNumber?: string;


  slot?: string;


  capacity?: number;
  speed?: string;
  firmwareVersion?: string;


  status: ComponentStatus;
  healthPercent?: number;


  dataSource?: DataSource;
  metadata?: ComponentMetadata;
  lastUpdatedAt?: string;
  createdAt?: string;
  updatedAt?: string;


  inventoryId?: number;
  catalogId?: number;
  installedById?: number;


  bmcDiscrepancy?: boolean;
  bmcDiscrepancyReason?: BMCDiscrepancyReason;
}

export interface ComponentMetadata {

  cores?: number;
  threads?: number;
  architecture?: string;


  memoryType?: string;
  rank?: number;


  mediaType?: string;
  interface?: string;


  macAddress?: string;
  linkSpeed?: string;


  health?: string | number;
  fetchedById?: number;


  replacedAt?: string;
  replacedById?: number;
  reason?: string;
  replacesComponentId?: number;
  replacementReason?: string;
  defectRecordId?: number;
  inventorySourceId?: number;
}


export interface ComponentsResponse {
  server: {
    id: number;
    ipAddress?: string;
    hostname?: string;
    apkSerialNumber?: string;
    lastComponentsFetchAt?: string;
  };
  summary: {
    totalRAMBytes: number;
    totalStorageBytes: number;
    totalRAM: string;
    totalStorage: string;
    cpuCores: number;
    cpuThreads: number;
    totalComponents: number;
  };
  grouped: {
    CPU: ServerComponent[];
    RAM: ServerComponent[];
    storage: ServerComponent[];
    NIC: ServerComponent[];
    other: ServerComponent[];
  };
  components: ServerComponent[];
  discrepancyCount?: number;
}

export interface BMCCheckResponse {
  success: boolean;
  redfishVersion?: string;
  bmcAddress?: string;
  error?: string;
}

export interface FetchComponentsResponse {
  success: boolean;
  message: string;
  components: ServerComponent[];
}


export type SyncMode = 'compare' | 'force' | 'merge';

export interface BMCComponent {
  componentType: ComponentType;
  name?: string;
  slot?: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  partNumber?: string;
  firmwareVersion?: string;
  status?: string;
  capacityBytes?: number;
  speedMHz?: number;
  speedMT?: number;
  speed?: number;
  cores?: number;
  threads?: number;
  architecture?: string;
  memoryType?: string;
  rank?: string;
  mediaType?: string;
  interface?: string;
  macAddress?: string;
  linkSpeed?: string;
  health?: number | string;
}

export interface ComponentDifference {
  field: string;
  db: string | null;
  bmc: string | null;
}

export interface ComparisonMatchedItem {
  dbComponent: ServerComponent;
  bmcComponent: BMCComponent;
}

export interface ComparisonMissingItem {
  dbComponent: ServerComponent;
  isManual: boolean;
  reason: string;
}

export interface ComparisonNewItem {
  bmcComponent: BMCComponent;
  reason: string;
}

export interface ComparisonMismatchItem {
  dbComponent: ServerComponent;
  bmcComponent: BMCComponent;
  differences: ComponentDifference[];
}

export interface ComparisonDetails {
  matched: ComparisonMatchedItem[];
  missingInBmc: ComparisonMissingItem[];
  newInBmc: ComparisonNewItem[];
  mismatches: ComparisonMismatchItem[];
}

export interface ComparisonSummary {
  total: {
    inDb: number;
    inBmc: number;
  };
  matched: number;
  missingInBmc: number;
  newInBmc: number;
  mismatches: number;
}

export interface BMCCompareResponse {
  success: boolean;
  mode: 'compare';
  hasDiscrepancies: boolean;
  summary: ComparisonSummary;
  details: ComparisonDetails;
  message?: string;
}

export interface BMCForceResponse {
  success: boolean;
  mode: 'force';
  message: string;
  manualPreserved: number;
  components: ServerComponent[];
}

export interface BMCMergeActions {
  updated: Array<{
    id: number;
    serialNumber: string | null;
    changes: ComponentDifference[];
  }>;
  added: ServerComponent[];
  preserved: ServerComponent[];
  flaggedForReview: Array<{
    id: number;
    serialNumber: string | null;
    reason: string;
  }>;
}

export interface BMCMergeResponse {
  success: boolean;
  mode: 'merge';
  message: string;
  actions: BMCMergeActions;
}

export type BMCSyncResponse = BMCCompareResponse | BMCForceResponse | BMCMergeResponse;

export interface BMCSyncRequest {
  mode: SyncMode;
  preserveManual?: boolean;
}

export interface ResolveDiscrepancyRequest {
  resolution: 'keep' | 'delete';
}

export interface ResolveDiscrepancyResponse {
  success: boolean;
  action: 'kept' | 'deleted';
  component?: ServerComponent;
}


export interface AddComponentData {
  componentType: string;
  name?: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  serialNumberYadro?: string;
  partNumber?: string;
  slot?: string;
  status?: string;
  capacity?: number;
  speed?: string;
  firmwareVersion?: string;
  metadata?: Record<string, any>;
}

export interface UpdateComponentData {
  name?: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  serialNumberYadro?: string;
  partNumber?: string;
  slot?: string;
  status?: string;
  firmwareVersion?: string;
  capacity?: number;
  speed?: string;
  metadata?: Record<string, any>;
}

export interface ReplaceComponentData {
  newSerialNumber?: string;
  newSerialNumberYadro?: string;
  newManufacturer?: string;
  newModel?: string;
  newPartNumber?: string;
  reason?: string;
  defectRecordId?: number;
  inventoryComponentId?: number;
}


export type ComponentHistoryAction =
  | 'ADDED'
  | 'UPDATED'
  | 'REPLACED'
  | 'REMOVED'
  | 'SERIAL_CHANGED'
  | 'COMPONENTS_FETCHED'
  | 'COMPONENTS_MERGED'
  | 'DISCREPANCY_RESOLVED';

export interface ComponentHistoryEntry {
  id: number;
  action: ComponentHistoryAction;
  componentId: number;
  serverId: number;
  userId: number;
  userName?: string;
  oldValue?: Record<string, any>;
  newValue?: Record<string, any>;
  reason?: string;
  performedAt: string;
}


export interface ComponentSearchParams {
  serialNumber?: string;
  serialNumberYadro?: string;
  componentType?: string;
  serverId?: number;
}

export interface ComponentSearchResult {
  found: boolean;
  component?: ServerComponent;
  server?: {
    id: number;
    apkSerialNumber: string;
    hostname?: string;
    ipAddress?: string;
  };
  suggestions?: ServerComponent[];
}


export const COMPONENT_TYPE_LABELS: Record<ComponentType, string> = {
  CPU: '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä',
  RAM: '–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å',
  HDD: '–ñ—ë—Å—Ç–∫–∏–π –¥–∏—Å–∫',
  SSD: '–¢–≤–µ—Ä–¥–æ—Ç–µ–ª—å–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å',
  NVME: 'NVMe –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å',
  NIC: '–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞',
  MOTHERBOARD: '–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞',
  PSU: '–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è',
  GPU: '–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞',
  RAID: 'RAID-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä',
  BMC: 'BMC',
  FAN: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä',
  CHASSIS: '–ö–æ—Ä–ø—É—Å',
  OTHER: '–ü—Ä–æ—á–µ–µ'
};

export const COMPONENT_STATUS_LABELS: Record<ComponentStatus, string> = {
  OK: '–ò—Å–ø—Ä–∞–≤–µ–Ω',
  WARNING: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
  CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ',
  UNKNOWN: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
  REPLACED: '–ó–∞–º–µ–Ω—ë–Ω'
};

export const COMPONENT_STATUS_COLORS: Record<ComponentStatus, string> = {
  OK: 'bg-emerald-100 text-emerald-700 border-emerald-300',
  WARNING: 'bg-amber-100 text-amber-700 border-amber-300',
  CRITICAL: 'bg-red-100 text-red-700 border-red-300',
  UNKNOWN: 'bg-slate-100 text-slate-500 border-slate-300',
  REPLACED: 'bg-violet-100 text-violet-700 border-violet-300'
};

export const COMPONENT_TYPE_ICONS: Record<ComponentType, string> = {
  CPU: 'cpu',
  RAM: 'memory-stick',
  HDD: 'hard-drive',
  SSD: 'hard-drive',
  NVME: 'hard-drive',
  NIC: 'network',
  MOTHERBOARD: 'circuit-board',
  PSU: 'zap',
  GPU: 'circuit-board',
  RAID: 'hard-drive',
  BMC: 'server',
  FAN: 'fan',
  CHASSIS: 'box',
  OTHER: 'settings'
};

export const BMC_DISCREPANCY_LABELS: Record<BMCDiscrepancyReason, string> = {
  NOT_FOUND_IN_BMC: '–ù–µ –Ω–∞–π–¥–µ–Ω –≤ BMC',
  REMOVED_FROM_BMC: '–£–¥–∞–ª—ë–Ω –∏–∑ BMC',
  DATA_MISMATCH: '–î–∞–Ω–Ω—ã–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è',
  SERIAL_CHANGED: '–ò–∑–º–µ–Ω—ë–Ω S/N'
};


export function formatBytes(bytes: number | undefined | null): string {
  if (!bytes || bytes === 0) return '0 B';

  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));

  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

export function isStorageComponent(type: ComponentType): boolean {
  return ['HDD', 'SSD', 'NVME'].includes(type);
}

export function getStatusColor(status: ComponentStatus): string {
  return COMPONENT_STATUS_COLORS[status] || COMPONENT_STATUS_COLORS.UNKNOWN;
}

================================================================================
FILE: QMS-Client-main/src/types/beryll/defectsAndMonitoring.ts
================================================================================



export type DefectCategory = 'HARDWARE' | 'SOFTWARE' | 'ASSEMBLY' | 'COMPONENT' | 'OTHER';
export type DefectPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
export type DefectStatus = 'NEW' | 'IN_PROGRESS' | 'RESOLVED' | 'WONT_FIX';

export interface DefectFile {
  id: number;
  commentId: number;
  originalName: string;
  fileName: string;
  filePath: string;
  mimeType: string | null;
  fileSize: number | null;
  uploadedById: number | null;
  uploadedBy?: {
    id: number;
    login: string;
    name: string;
    surname: string;
  };
  createdAt: string;
}

export interface DefectComment {
  id: number;
  serverId: number;
  userId: number;
  text: string;
  defectCategory: DefectCategory;
  priority: DefectPriority;
  status: DefectStatus;
  resolvedById: number | null;
  resolvedAt: string | null;
  resolution: string | null;
  createdAt: string;
  updatedAt: string;
  author?: {
    id: number;
    login: string;
    name: string;
    surname: string;
  };
  resolvedBy?: {
    id: number;
    login: string;
    name: string;
    surname: string;
  };
  server?: {
    id: number;
    ipAddress: string;
    hostname: string;
    serialNumber: string;
    apkSerialNumber: string;
  };
  files?: DefectFile[];
}

export interface DefectStats {
  total: number;
  unresolved: number;
  resolved: number;
  byCategory: Record<DefectCategory, number>;
  byStatus: Record<DefectStatus, number>;
  byPriority: Record<DefectPriority, number>;
}


export type PingStatus = 'ONLINE' | 'OFFLINE' | 'UNKNOWN';

export interface ServerPingResult {
  serverId: number;
  ipAddress: string;
  hostname: string;
  serialNumber?: string;
  apkSerialNumber?: string;
  serverStatus?: string;
  batchId?: number;
  online: boolean;
  latency: number | null;
  error: string | null;
  checkedAt: string;
}

export interface MonitoringStats {
  byStatus: Record<PingStatus, number>;
  total: number;
  online: number;
  offline: number;
  unknown: number;
  staleServers: number;
  avgLatency: string | null;
  lastFullScan: string | null;
}

export interface PingAllResult {
  total: number;
  online: number;
  offline: number;
  checkedAt: string;
  cached?: boolean;
  servers: ServerPingResult[];
}


export const DEFECT_CATEGORY_LABELS: Record<DefectCategory, string> = {
  HARDWARE: '–ñ–µ–ª–µ–∑–æ',
  SOFTWARE: '–°–æ—Ñ—Ç',
  ASSEMBLY: '–°–±–æ—Ä–∫–∞',
  COMPONENT: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç',
  OTHER: '–î—Ä—É–≥–æ–µ'
};

export const DEFECT_PRIORITY_LABELS: Record<DefectPriority, string> = {
  LOW: '–ù–∏–∑–∫–∏–π',
  MEDIUM: '–°—Ä–µ–¥–Ω–∏–π',
  HIGH: '–í—ã—Å–æ–∫–∏–π',
  CRITICAL: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π'
};

export const DEFECT_STATUS_LABELS: Record<DefectStatus, string> = {
  NEW: '–ù–æ–≤—ã–π',
  IN_PROGRESS: '–í —Ä–∞–±–æ—Ç–µ',
  RESOLVED: '–†–µ—à—ë–Ω',
  WONT_FIX: '–ù–µ –±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω'
};

export const PING_STATUS_LABELS: Record<PingStatus, string> = {
  ONLINE: '–û–Ω–ª–∞–π–Ω',
  OFFLINE: '–û—Ñ—Ñ–ª–∞–π–Ω',
  UNKNOWN: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
};


export const PRIORITY_COLORS: Record<DefectPriority, string> = {
  LOW: '#4caf50',
  MEDIUM: '#ff9800',
  HIGH: '#f44336',
  CRITICAL: '#9c27b0'
};

export const STATUS_COLORS: Record<DefectStatus, string> = {
  NEW: '#2196f3',
  IN_PROGRESS: '#ff9800',
  RESOLVED: '#4caf50',
  WONT_FIX: '#9e9e9e'
};

export const PING_STATUS_COLORS: Record<PingStatus, string> = {
  ONLINE: '#4caf50',
  OFFLINE: '#f44336',
  UNKNOWN: '#9e9e9e'
};

================================================================================
FILE: QMS-Client-main/src/utils/consts.ts
================================================================================



export const ADMIN_ROUTE = '/admin';
export const ADMIN_PCs_ROUTE = '/admin/pcs';
export const ADMIN_DEFECTS_FC_CATEGORIES_ROUTE = '/admin/defects-FC-categories';
export const ADMIN_DEFECTS_915_CATEGORIES_ROUTE = '/admin/defects-915-categories';
export const ADMIN_DEFECTS_2_4_CATEGORIES_ROUTE = '/admin/defects-2-4-categories';
export const ADMIN_DEFECTS_CORAL_B_CATEGORIES_ROUTE = '/admin/defects-coral-b-categories';
export const ADMIN_USERS_ROUTE = '/admin/users';
export const ADMIN_PRODUCTS_ROUTE = '/admin/products';
export const ADMIN_PRODUCTS_STATUSES_ROUTE = '/admin/products-statuses';
export const ADMIN_COMPONENTS_ROUTE = '/admin/components';
export const STRUCTURE_ROUTE = '/admin/structure';
export const AUDIT_LOG_ROUTE = '/admin/audit-log';
export const ADMIN_WAREHOUSE_ROUTE = '/admin/warehouse';
export const ADMIN_RBAC_ROUTE = '/admin/rbac';
export const ADMIN_ASSEMBLY_ROUTES_ROUTE = '/admin/assembly-routes';


export const DEFECTS_ROUTE = '/defects';
export const DEFECT_DETAIL_ROUTE = '/defects/:id';
export const ADMIN_DEFECT_CATEGORIES_ROUTE = '/admin/defect-categories';
export const INPUT_DEFECT_ROUTE = '/input-defect';


export const RECIPE_CONSTRUCTOR_ROUTE = '/assembly/recipes/constructor';
export const RECIPE_EXECUTION_ROUTE = '/assembly/recipes/terminal';
export const ASSEMBLY_ROUTE = '/assembly';
export const ASSEMBLED_PRODUCTS_ROUTE = '/database/assembled';


export const LOGIN_ROUTE = '/login';
export const SELECT_PC_ROUTE = '/select-pc-for-start-session';
export const REGISTRATION_ROUTE = '/registration';
export const USERS_ROUTE = '/users';
export const PROFILE_ROUTE = '/profile';


export const START_ROUTE = '/';
export const BETAFLIGHT_ROUTE = '/betaflight';


export const FC_ROUTE = '/flight-controller';
export const ELRS_915_ROUTE = '/elrs-915';
export const ELRS_2_4_ROUTE = '/elrs-2-4';
export const CORAL_B_ROUTE = '/coral-b';


export const BERYLL_ROUTE = '/beryll';
export const BERYLL_SERVER_ROUTE = '/beryll/server/:id';
export const BERYLL_BATCH_ROUTE = '/beryll/batch/:id';
export const BERYLL_MONITORING_ROUTE = '/beryll/monitoring';
export const BERYLL_REVISIONS_ROUTE = '/beryll/revisions';


export const KNOWLEDGE_BASE_ROUTE = '/knowledge-base';
export const WAREHOUSE_ROUTE = '/warehouse';


export const FIRMWARE_OLD_ROUTE = '/firmware-node-red';
export const FIRMWARE_FC_ROUTE = '/firmware-flight-controller';
export const FIRMWARE_915_019_ROUTE = '/firmware-915-019';
export const FIRMWARE_915_002_ROUTE = '/firmware-915-002';
export const FIRMWARE_2_4_ROUTE = '/firmware-2-4';
export const FIRMWARE_Coral_B_ROUTE = '/firmware-coral-b';
export const MQTT_CHECK_FC_ROUTE = '/mqtt-check-fc';
export const MQTT_CHECK_ESC_ROUTE = '/mqtt-check-esc';

export const TEST_ROUTE = '/test';


export const RANKINGS_ROUTE = '/rankings';
export const RANKINGS_CHARTS_ROUTE = '/rankings/analytics';


export const WAREHOUSE_ANALYTICS_ROUTE = '/warehouse/analytics';
export const WAREHOUSE_INVENTORY_ROUTE = '/warehouse/inventory';


export const TASKS_ROUTE = '/tasks';


export const ANALYTICS_DASHBOARD_ROUTE = '/analytics/dashboard';


export const PRODUCTION_ROUTE = '/production';

================================================================================
FILE: QMS-Client-main/src/utils/constsModalType.ts
================================================================================

  export const CREATE_DEFECT_FC = 'createDefectFC'
  export const CREATE_DEFECT_915 = 'createDefect915'
  export const CREATE_DEFECT_24 = 'createDefect24'
  export const CREATE_DEFECT_CORAL_B = 'createDefectCoralB'

  export const CREATE_BOARD_FC = 'createBoardFC'
  export const CREATE_BOARD_915 = 'createBoard915'
  export const CREATE_BOARD_24 = 'createBoard24'
  export const CREATE_BOARD_CORAL_B = 'createBoardCoralB'

  export const CREATE_COMPUTER = 'createPC'
  export const CREATE_USER = 'createUser'

  export const CREATE_PRODUCT = 'createProduct'
  export const CREATE_PRODUCT_STATUSES = 'createProductStatuses'
  export const CREATE_COMPONENT = 'createComponent'

================================================================================
FILE: QMS-Client-main/src/vite-env.d.ts
================================================================================



================================================================================
FILE: QMS-Client-main/tailwind.config.js
================================================================================


export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      animation: {

        'fade-in': 'fadeIn 0.4s ease-out forwards',

        'slide-in-up': 'slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',

        'scale-in': 'scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideInUp: {
          '0%': { opacity: '0', transform: 'translateY(15px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
        scaleIn: {
          '0%': { opacity: '0', transform: 'scale(0.95) translateY(-10px)' },
          '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
        }
      }
    },
  },
  plugins: [],
}

================================================================================
FILE: QMS-Client-main/tsconfig.json
================================================================================

{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,

    
    "baseUrl": ".",
    "paths": {
      "public/*": ["public/*"],
      "src/*": ["src/*"],
      "api/*": ["src/api/*"],
      "assets/*": ["src/assets/*"],
      "components/*": ["src/components/*"],
      "pages/*": ["src/pages/*"],
      "store/*": ["src/store/*"],
      "types/*": ["src/types/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}

================================================================================
FILE: QMS-Client-main/tsconfig.node.json
================================================================================

{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true,
    "strict": true
  },
  "include": ["vite.config.ts"]
}

================================================================================
FILE: QMS-Client-main/vite.config.ts
================================================================================

import { defineConfig } from "vite";
import react from "@vitejs/plugin-react-swc";
import { VitePWA } from "vite-plugin-pwa";


export default defineConfig({
  preview: {
    host: "10.11.0.15",
    port: 4173,
  },

  plugins: [
    react(),
    VitePWA({
      registerType: "autoUpdate",
      includeAssets: [
        "favicon.ico",
        "apple-touch-icon.png",
        "maskable-icon-512x512.svg",
      ],
      manifest: {
        name: "MES_crypto",
        short_name: "Vite PWA Project",
        theme_color: "#ffffff",
        icons: [
          {
            src: "pwa-64x64.png",
            sizes: "64x64",
            type: "image/png",
          },
          {
            src: "pwa-192x192.png",
            sizes: "192x192",
            type: "image/png",
          },
          {
            src: "pwa-512x512.png",
            sizes: "512x512",
            type: "image/png",
            purpose: "any",
          },
          {
            src: "maskable-icon-512x512.png",
            sizes: "512x512",
            type: "image/png",
            purpose: "maskable",
          },
        ],
      },
    }),
  ],

  resolve: {
    alias: {
      public: "/public",
      src: "/src",
      api: "/src/api",
      assets: "/src/assets",
      components: "/src/components",
      pages: "src/pages",
      store: "/src/store",
      types: "/src/types",
    },
  },
});

================================================================================
FILE: QMS-Client-main/vitest.config.ts
================================================================================

import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react-swc';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      public: path.resolve(__dirname, './public'),
      src: path.resolve(__dirname, './src'),
      api: path.resolve(__dirname, './src/api'),
      assets: path.resolve(__dirname, './src/assets'),
      components: path.resolve(__dirname, './src/components'),
      pages: path.resolve(__dirname, './src/pages'),
      store: path.resolve(__dirname, './src/store'),
      types: path.resolve(__dirname, './src/types'),
    },
  },
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/setupTests.ts',
    css: true,
  },
});

================================================================================
FILE: QMS-Mobile/mes-pwa/deploy.sh
================================================================================

#!/bin/bash














set -e


RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'


APP_NAME="MES Kryptonit PWA"
VERSION="2.0.0"
BUILD_DIR="./dist"
DEPLOY_DIR="/var/www/mes-pwa"
NGINX_CONF_SRC="./nginx/mes-pwa-gateway.conf"
NGINX_CONF_DST="/etc/nginx/sites-available/mes-pwa-gateway.conf"
NGINX_ENABLED="/etc/nginx/sites-enabled/mes-pwa-gateway.conf"


ENVIRONMENT=${1:-production}





log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë            $APP_NAME v$VERSION                  ‚ïë"
    echo "‚ïë                  Deployment Script                         ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    log_info "Environment: $ENVIRONMENT"
    echo ""
}

check_requirements() {
    log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π..."
    

    if ! command -v node &> /dev/null; then
        log_error "Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
        exit 1
    fi
    log_success "Node.js: $(node -v)"
    

    if ! command -v npm &> /dev/null; then
        log_error "npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
        exit 1
    fi
    log_success "npm: $(npm -v)"
    

    if [ "$ENVIRONMENT" = "production" ]; then
        if ! command -v nginx &> /dev/null; then
            log_warning "Nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞."
        else
            log_success "Nginx: $(nginx -v 2>&1 | head -1)"
        fi
    fi
}

install_dependencies() {
    log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    if [ -f "package-lock.json" ]; then
        npm ci
    else
        npm install
    fi
    
    log_success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

build_app() {
    log_info "–°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    

    rm -rf "$BUILD_DIR"
    

    npm run build
    

    if [ ! -d "$BUILD_DIR" ]; then
        log_error "–°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å - –ø–∞–ø–∫–∞ dist –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
        exit 1
    fi
    
    log_success "–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $BUILD_DIR"
    log_info "–†–∞–∑–º–µ—Ä —Å–±–æ—Ä–∫–∏: $(du -sh $BUILD_DIR | cut -f1)"
}

deploy_files() {
    log_info "–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
    

    sudo mkdir -p "$DEPLOY_DIR"
    

    sudo rm -rf "${DEPLOY_DIR:?}"/*
    

    sudo cp -r "$BUILD_DIR"/* "$DEPLOY_DIR/"
    

    sudo chown -R www-data:www-data "$DEPLOY_DIR"
    

    sudo chmod -R 755 "$DEPLOY_DIR"
    
    log_success "–§–∞–π–ª—ã —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã –≤ $DEPLOY_DIR"
}

configure_nginx() {
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."
    
    if ! command -v nginx &> /dev/null; then
        log_warning "Nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
        return
    fi
    

    if [ ! -f "$NGINX_CONF_SRC" ]; then
        log_warning "–ö–æ–Ω—Ñ–∏–≥ Nginx –Ω–µ –Ω–∞–π–¥–µ–Ω: $NGINX_CONF_SRC"
        return
    fi
    

    sudo cp "$NGINX_CONF_SRC" "$NGINX_CONF_DST"
    

    if [ ! -L "$NGINX_ENABLED" ]; then
        sudo ln -s "$NGINX_CONF_DST" "$NGINX_ENABLED"
    fi
    

    log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
    if sudo nginx -t; then
        log_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –≤–∞–ª–∏–¥–Ω–∞"
        

        sudo systemctl reload nginx
        log_success "Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
    else
        log_error "–û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx!"
        exit 1
    fi
}

print_summary() {
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ                  ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    log_success "PWA —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç!"
    echo ""
    echo "üì± –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:"
    echo ""
    echo "   –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç—å (10.11.0.x):"
    echo "   ‚Üí http://10.11.0.16:3000"
    echo ""
    echo "   WiFi —Å–µ—Ç—å (192.168.27.x):"
    echo "   ‚Üí http://192.168.27.1:3000"
    echo ""
    echo "üîß Keycloak:"
    echo "   ‚Üí –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç—å: http://10.11.0.16:8080"
    echo "   ‚Üí WiFi —Å–µ—Ç—å:     http://192.168.27.1:8080"
    echo ""
    echo "üìù –ù–µ –∑–∞–±—É–¥—å—Ç–µ:"
    echo "   1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Keycloak client —Å redirect URIs –¥–ª—è –æ–±–µ–∏—Ö —Å–µ—Ç–µ–π"
    echo "   2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É —Å–µ—Ç—è–º–∏ –Ω–∞ Gateway"
    echo "   3. –û–±–Ω–æ–≤–∏—Ç—å IP –∞–¥—Ä–µ—Å–∞ –≤ nginx –∫–æ–Ω—Ñ–∏–≥–µ –ø–æ–¥ –≤–∞—à—É –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É"
    echo ""
}





print_header

case "$ENVIRONMENT" in
    production)
        check_requirements
        install_dependencies
        build_app
        deploy_files
        configure_nginx
        print_summary
        ;;
    staging)
        check_requirements
        install_dependencies
        build_app
        deploy_files
        log_success "Staging —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
        ;;
    local)
        check_requirements
        install_dependencies
        build_app
        log_success "–õ–æ–∫–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: npm run preview"
        ;;
    *)
        log_error "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: $ENVIRONMENT"
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [production|staging|local]"
        exit 1
        ;;
esac

exit 0
================================================================================
FILE: QMS-Mobile/mes-pwa/index.html
================================================================================

<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="description" content="MES Kryptonit - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="MES Kryptonit" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <title>MES Kryptonit</title>
  </head>
  <body class="bg-background text-slate-100">
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: QMS-Mobile/mes-pwa/package.json
================================================================================

{
  "name": "mes-kryptonit-pwa",
  "version": "2.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview --host --port 3000"
  },
  "dependencies": {
    "axios": "^1.6.2",
    "lucide-react": "^0.303.0",
    "oidc-client-ts": "^3.0.1",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-oidc-context": "^3.1.0",
    "react-router-dom": "^6.21.0",
    "zustand": "^4.4.7"
  },
  "devDependencies": {
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.4.0",
    "typescript": "^5.2.2",
    "vite": "^5.0.8",
    "vite-plugin-pwa": "^0.17.4"
  }
}

================================================================================
FILE: QMS-Mobile/mes-pwa/postcss.config.js
================================================================================

export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: QMS-Mobile/mes-pwa/public/silent-check-sso.html
================================================================================

<!doctype html>
<html>
<head>
  <title>Silent SSO Check</title>
</head>
<body>
  <script>
    parent.postMessage(location.href, location.origin);
  </script>
</body>
</html>

================================================================================
FILE: QMS-Mobile/mes-pwa/src/App.tsx
================================================================================



import { useEffect } from 'react'
import { Routes, Route, Navigate } from 'react-router-dom'
import { useAuth } from 'react-oidc-context'
import { Loader } from './components/ui'


import { Layout } from './components/common/Layout'


import { LoginPage } from './pages/Auth/LoginPage'
import { HomePage } from './pages/Home/HomePage'
import { WarehousePage } from './pages/Warehouse/WarehousePage'
import { BoxDetailPage } from './pages/Warehouse/BoxDetailPage'
import { ProductionPage } from './pages/Production/ProductionPage'
import { ProductScanPage } from './pages/Production/ProductScanPage'
import { ChecklistPage } from './pages/Production/ChecklistPage'
import { RankingsPage } from './pages/Rankings/RankingsPage'
import { TasksPage } from './pages/Tasks/TasksPage'
import { ProfilePage } from './pages/Profile/ProfilePage'


const ProtectedRoute = ({ children }: { children: React.ReactNode }) => {
  const auth = useAuth()

  if (auth.isLoading) {
    return <Loader fullScreen text="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..." />
  }

  if (!auth.isAuthenticated) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}


function App() {
  const auth = useAuth()


  useEffect(() => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.ready.then((registration) => {
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                if (confirm('–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å?')) {
                  window.location.reload()
                }
              }
            })
          }
        })
      })
    }
  }, [])


  if (auth.isLoading) {
    return <Loader fullScreen text="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è..." />
  }

  return (
    <Routes>

      <Route path="/login" element={<LoginPage />} />


      <Route
        path="/"
        element={
          <ProtectedRoute>
            <Layout />
          </ProtectedRoute>
        }
      >
        <Route index element={<HomePage />} />


        <Route path="warehouse" element={<WarehousePage />} />
        <Route path="warehouse/:id" element={<BoxDetailPage />} />


        <Route path="production" element={<ProductionPage />} />
        <Route path="production/scan" element={<ProductScanPage />} />
        <Route path="production/:id" element={<ProductionPage />} />
        <Route path="production/checklist/:productId/:stepId" element={<ChecklistPage />} />


        <Route path="tasks" element={<TasksPage />} />


        <Route path="rankings" element={<RankingsPage />} />


        <Route path="profile" element={<ProfilePage />} />
      </Route>


      <Route path="*" element={<Navigate to="/" replace />} />
    </Routes>
  )
}

export default App

================================================================================
FILE: QMS-Mobile/mes-pwa/src/api/client.ts
================================================================================

import axios, { AxiosError, InternalAxiosRequestConfig, AxiosResponse } from 'axios'
import { User } from 'oidc-client-ts'

export type NetworkEnvironment = 'production' | 'wifi' | 'development'

interface NetworkConfig {
  apiBaseUrl: string
  keycloakAuthority: string
  keycloakClientId: string
  network: NetworkEnvironment
}

const detectNetwork = (): NetworkConfig => {
  const hostname = window.location.hostname
  const protocol = window.location.protocol

  if (hostname.startsWith('192.168.27.')) {
    return {
      apiBaseUrl: `${protocol}//${hostname}:3000/api`,
      keycloakAuthority: `${protocol}//${hostname}:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'wifi'
    }
  }

  if (hostname === 'mes-wifi.local' || hostname === 'mes-mobile.local') {
    return {
      apiBaseUrl: `${protocol}//${hostname}:3000/api`,
      keycloakAuthority: `${protocol}//${hostname}:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'wifi'
    }
  }

  if (hostname.startsWith('10.11.0.')) {
    return {
      apiBaseUrl: `${protocol}//${hostname}:3000/api`,
      keycloakAuthority: `${protocol}//10.11.0.16:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'production'
    }
  }

  if (hostname === 'mes.local' || hostname === 'mes-kryptonit.local') {
    return {
      apiBaseUrl: `${protocol}//${hostname}:3000/api`,
      keycloakAuthority: `${protocol}//${hostname}:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'production'
    }
  }

  if (hostname === '10.11.0.16') {
    return {
      apiBaseUrl: `${protocol}//10.11.0.16:5001/api`,
      keycloakAuthority: `${protocol}//10.11.0.16:8080/realms/MES-Realm`,
      keycloakClientId: 'mes-pwa-client',
      network: 'production'
    }
  }

  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return {
      apiBaseUrl: '/api',
      keycloakAuthority: 'http://keycloak.local/realms/MES-Realm',
      keycloakClientId: 'mes-client',
      network: 'development'
    }
  }

  return {
    apiBaseUrl: `${protocol}//${hostname}/api`,
    keycloakAuthority: `${protocol}//${hostname}:8080/realms/MES-Realm`,
    keycloakClientId: 'mes-pwa-client',
    network: 'production'
  }
}

const networkConfig = detectNetwork()

export const API_BASE_URL = networkConfig.apiBaseUrl

export const KEYCLOAK_CONFIG = {
  authority: networkConfig.keycloakAuthority,
  clientId: networkConfig.keycloakClientId,
}

const DEBUG_HTTP = import.meta.env.DEV

const maskToken = (t?: string | null): string => {
  if (!t) return '<none>'
  const head = t.slice(0, 10)
  const tail = t.slice(-6)
  return `${head}‚Ä¶${tail} (len=${t.length})`
}

const joinUrl = (baseURL?: string, url?: string): string => {
  if (!url) return baseURL ?? ''
  if (/^https?:\/\
  const base = baseURL ?? ''
  return `${base.replace(/\/+$/, '')}/${url.replace(/^\/+/, '')}`
}

const getOidcStorageKey = (): string => {
  return `oidc.user:${KEYCLOAK_CONFIG.authority}:${KEYCLOAK_CONFIG.clientId}`
}

export const getAccessToken = (): string | null => {
  const key = getOidcStorageKey()
  const data = sessionStorage.getItem(key)
  if (!data) return null
  try {
    const user = JSON.parse(data) as User
    return user.access_token || null
  } catch {
    return null
  }
}

export const getUser = (): User | null => {
  const key = getOidcStorageKey()
  const data = sessionStorage.getItem(key)
  if (!data) return null
  try {
    return JSON.parse(data) as User
  } catch {
    return null
  }
}

export const api = axios.create({
  baseURL: API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
  },
})

api.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    const token = getAccessToken()

    if (DEBUG_HTTP) {
      const method = (config.method ?? 'GET').toUpperCase()
      console.log(`[HTTP] --> ${method} ${joinUrl(config.baseURL, config.url)}`)
      console.log(`[HTTP] token = ${maskToken(token)}`)
    }

    if (token) {
      config.headers = config.headers ?? {}
      config.headers.Authorization = `Bearer ${token}`
    }

    return config
  },
  (error) => {
    console.error('[API] Request error:', error)
    return Promise.reject(error)
  }
)

api.interceptors.response.use(
  (response: AxiosResponse) => {
    if (DEBUG_HTTP) {
      console.log(`[HTTP] <-- ${response.status} ${response.config.method?.toUpperCase()} ${joinUrl(response.config.baseURL, response.config.url)}`)
    }
    return response
  },
  (err: AxiosError) => {
    const status = err.response?.status
    const url = err.config?.url

    if (DEBUG_HTTP) {
      console.error(`[HTTP] <-- ERROR`, {
        message: err.message,
        status: status,
        data: err.response?.data,
      })
    }

    if (status === 401) {
      console.warn('[API] Unauthorized - token may be expired')
    }

    if (status === 403) {
      console.warn('[API] Forbidden - insufficient permissions')
    }

    if (status === 404) {
      console.warn('[API] Not Found:', url)
    }

    if (status && status >= 500) {
      console.error('[API] Server Error:', err.response?.data)
    }

    if (!err.response) {
      console.error('[API] Network Error - check connection')
    }

    return Promise.reject(err)
  }
)

export interface ApiErrorResponse {
  message: string
  error?: string
  statusCode?: number
  details?: any
}

export const getErrorMessage = (error: unknown, fallback = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'): string => {
  if (axios.isAxiosError(error)) {
    const axiosError = error as AxiosError<ApiErrorResponse>

    if (axiosError.response?.data?.message) {
      return axiosError.response.data.message
    }

    if (axiosError.response?.status === 401) {
      return '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.'
    }
    if (axiosError.response?.status === 403) {
      return '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏.'
    }
    if (axiosError.response?.status === 404) {
      return '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π —Ä–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.'
    }
    if (axiosError.response?.status && axiosError.response.status >= 500) {
      return '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
    }

    if (axiosError.code === 'ECONNABORTED') {
      return '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.'
    }
    if (!axiosError.response) {
      return '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å.'
    }

    return axiosError.message
  }

  if (error instanceof Error) {
    return error.message
  }

  return fallback
}

export const isNetworkError = (error: unknown): boolean => {
  if (axios.isAxiosError(error)) {
    return !error.response || error.code === 'ECONNABORTED' || error.code === 'ERR_NETWORK'
  }
  return false
}

export const isAuthError = (error: unknown): boolean => {
  if (axios.isAxiosError(error)) {
    return error.response?.status === 401
  }
  return false
}

export const apiGet = async <T>(url: string, params?: any): Promise<T> => {
  const { data } = await api.get<T>(url, { params })
  return data
}

export const apiPost = async <T>(url: string, body?: any): Promise<T> => {
  const { data } = await api.post<T>(url, body)
  return data
}

export const apiPut = async <T>(url: string, body?: any): Promise<T> => {
  const { data } = await api.put<T>(url, body)
  return data
}

export const apiPatch = async <T>(url: string, body?: any): Promise<T> => {
  const { data } = await api.patch<T>(url, body)
  return data
}

export const apiDelete = async <T>(url: string): Promise<T> => {
  const { data } = await api.delete<T>(url)
  return data
}

export const apiUpload = async <T>(url: string, formData: FormData): Promise<T> => {
  const { data } = await api.post<T>(url, formData, {
    headers: {
      'Content-Type': 'multipart/form-data',
    },
    timeout: 60000,
  })
  return data
}

export const getNetworkInfo = () => ({
  apiUrl: API_BASE_URL,
  keycloakAuthority: KEYCLOAK_CONFIG.authority,
  network: networkConfig.network,
  isWifi: networkConfig.network === 'wifi',
  isProduction: networkConfig.network === 'production',
  isDevelopment: networkConfig.network === 'development',
})

console.log(`[API] Network: ${networkConfig.network}, URL: ${API_BASE_URL}`)

export default api
================================================================================
FILE: QMS-Mobile/mes-pwa/src/components/common/Layout.tsx
================================================================================



import { useState, useEffect } from 'react'
import { Outlet, NavLink, useNavigate, useLocation } from 'react-router-dom'
import {
  Home, Package, Cpu, ListTodo, Trophy, User, LogOut,
  Menu, X, Bell, QrCode, Wifi, WifiOff
} from 'lucide-react'
import { useAuth } from 'react-oidc-context'
import { USER_ROLES } from '../../config'

const navItems = [
  { to: '/', icon: Home, label: '–ì–ª–∞–≤–Ω–∞—è' },
  { to: '/warehouse', icon: Package, label: '–°–∫–ª–∞–¥' },
  { to: '/production', icon: Cpu, label: '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ' },
  { to: '/tasks', icon: ListTodo, label: '–ó–∞–¥–∞—á–∏' },
  { to: '/rankings', icon: Trophy, label: '–†–µ–π—Ç–∏–Ω–≥–∏' },
]

export const Layout = () => {
  const [sidebarOpen, setSidebarOpen] = useState(false)
  const [isOnline, setIsOnline] = useState(navigator.onLine)
  const auth = useAuth()
  const navigate = useNavigate()
  const location = useLocation()


  const user = auth.user?.profile ? {
    name: auth.user.profile.given_name || '',
    surname: auth.user.profile.family_name || '',
    role: (auth.user.profile as any).realm_access?.roles?.[0] || 'USER',
    img: (auth.user.profile as any).picture,
  } : null

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  const handleLogout = () => {
    if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
      auth.signoutRedirect()
    }
  }

  const getPageTitle = () => {
    const path = location.pathname
    if (path === '/') return '–ì–ª–∞–≤–Ω–∞—è'
    if (path.startsWith('/warehouse')) return '–°–∫–ª–∞–¥'
    if (path.startsWith('/production')) return '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ'
    if (path.startsWith('/tasks')) return '–ó–∞–¥–∞—á–∏'
    if (path.startsWith('/rankings')) return '–†–µ–π—Ç–∏–Ω–≥–∏'
    if (path.startsWith('/profile')) return '–ü—Ä–æ—Ñ–∏–ª—å'
    return 'MES'
  }

  return (
    <div className="min-h-screen bg-background flex">

      {sidebarOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-40 lg:hidden backdrop-blur-sm"
          onClick={() => setSidebarOpen(false)}
        />
      )}


      <aside className={`
        fixed lg:static inset-y-0 left-0 z-50
        w-64 bg-surface border-r border-slate-700/50
        transform transition-transform duration-300 ease-out
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
        flex flex-col
      `}>

        <div className="h-16 flex items-center justify-between px-4 border-b border-slate-700/50 shrink-0">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center shadow-lg shadow-primary/25">
              <Cpu size={20} className="text-white" />
            </div>
            <div>
              <span className="font-bold text-lg">MES</span>
              <span className="text-primary ml-1 font-light">Kryptonit</span>
            </div>
          </div>
          <button
            className="lg:hidden p-2 hover:bg-surface-light rounded-lg transition-colors"
            onClick={() => setSidebarOpen(false)}
          >
            <X size={20} />
          </button>
        </div>


        <div className="p-4 shrink-0">
          <button
            onClick={() => { navigate('/production/scan'); setSidebarOpen(false) }}
            className="w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gradient-to-r from-primary to-primary-dark text-white
              rounded-xl font-medium shadow-lg shadow-primary/25
              hover:shadow-primary/40 transition-all active:scale-[0.98]"
          >
            <QrCode size={20} />
            –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </div>


        <nav className="flex-1 px-3 space-y-1 overflow-y-auto">
          {navItems.map((item) => (
            <NavLink
              key={item.to}
              to={item.to}
              end={item.to === '/'}
              onClick={() => setSidebarOpen(false)}
              className={({ isActive }) => `
                flex items-center gap-3 px-4 py-3 rounded-xl
                transition-all duration-150
                ${isActive
                  ? 'bg-primary text-white shadow-lg shadow-primary/25'
                  : 'text-slate-400 hover:bg-surface-light hover:text-white'
                }
              `}
            >
              <item.icon size={20} />
              <span className="font-medium">{item.label}</span>
            </NavLink>
          ))}
        </nav>


        <div className="p-4 border-t border-slate-700/50 shrink-0">
          <NavLink
            to="/profile"
            onClick={() => setSidebarOpen(false)}
            className={({ isActive }) => `
              flex items-center gap-3 px-3 py-3 rounded-xl mb-2
              transition-all duration-150
              ${isActive
                ? 'bg-primary/20 text-primary'
                : 'text-slate-400 hover:bg-surface-light hover:text-white'
              }
            `}
          >
            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center border border-primary/20">
              {user?.img ? (
                <img src={user.img} alt="" className="w-full h-full rounded-full object-cover" />
              ) : (
                <User size={18} className="text-primary" />
              )}
            </div>
            <div className="flex-1 min-w-0">
              <p className="font-medium truncate text-white">
                {user?.surname} {user?.name}
              </p>
              <p className="text-xs text-slate-500 truncate">
                {USER_ROLES[user?.role || ''] || user?.role}
              </p>
            </div>
          </NavLink>

          <button
            onClick={handleLogout}
            className="w-full flex items-center gap-3 px-4 py-3 rounded-xl
              text-slate-400 hover:bg-danger/10 hover:text-danger
              transition-all duration-150"
          >
            <LogOut size={20} />
            <span className="font-medium">–í—ã–π—Ç–∏</span>
          </button>
        </div>
      </aside>


      <div className="flex-1 flex flex-col min-w-0">

        <header className="h-16 bg-surface/80 backdrop-blur-xl border-b border-slate-700/50 flex items-center px-4 lg:px-6 sticky top-0 z-30 shrink-0">
          <button
            className="lg:hidden p-2 hover:bg-surface-light rounded-lg mr-3 transition-colors"
            onClick={() => setSidebarOpen(true)}
          >
            <Menu size={22} />
          </button>

          <h1 className="text-lg font-semibold lg:hidden">{getPageTitle()}</h1>

          <div className="flex-1" />


          <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg mr-3 ${isOnline ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}`}>
            {isOnline ? <Wifi size={16} /> : <WifiOff size={16} />}
            <span className="text-xs font-medium hidden sm:inline">
              {isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}
            </span>
          </div>


          <button className="p-2 hover:bg-surface-light rounded-lg relative transition-colors">
            <Bell size={20} className="text-slate-400" />
          </button>
        </header>


        <main className="flex-1 overflow-auto p-4 lg:p-6">
          <Outlet />
        </main>
      </div>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/components/ui/index.tsx
================================================================================



import { ButtonHTMLAttributes, InputHTMLAttributes, ReactNode, forwardRef } from 'react'


interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger' | 'success' | 'outline' | 'ghost'
  size?: 'sm' | 'md' | 'lg'
  loading?: boolean
  icon?: ReactNode
  fullWidth?: boolean
}

export const Button = ({
  children,
  variant = 'primary',
  size = 'md',
  loading = false,
  icon,
  fullWidth = false,
  className = '',
  disabled,
  ...props
}: ButtonProps) => {
  const base = 'inline-flex items-center justify-center font-medium rounded-xl transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed active:scale-[0.98]'

  const variants = {
    primary: 'bg-primary hover:bg-primary-dark text-white shadow-lg shadow-primary/25',
    secondary: 'bg-slate-600 hover:bg-slate-500 text-white',
    danger: 'bg-danger hover:bg-red-600 text-white',
    success: 'bg-success hover:bg-emerald-600 text-white',
    outline: 'border-2 border-primary text-primary hover:bg-primary/10',
    ghost: 'text-slate-400 hover:bg-surface-light hover:text-white',
  }

  const sizes = {
    sm: 'px-3 py-1.5 text-sm gap-1.5',
    md: 'px-4 py-2.5 text-sm gap-2',
    lg: 'px-6 py-3 text-base gap-2',
  }

  return (
    <button
      className={`${base} ${variants[variant]} ${sizes[size]} ${fullWidth ? 'w-full' : ''} ${className}`}
      disabled={disabled || loading}
      {...props}
    >
      {loading ? (
        <div className="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin" />
      ) : icon ? (
        <span className="shrink-0">{icon}</span>
      ) : null}
      {children}
    </button>
  )
}


interface CardProps {
  children: ReactNode
  className?: string
  onClick?: () => void
  hover?: boolean
  padding?: 'none' | 'sm' | 'md' | 'lg'
}

export const Card = ({
  children,
  className = '',
  onClick,
  hover = false,
  padding = 'none'
}: CardProps) => {
  const base = 'bg-surface border border-slate-700/50 rounded-2xl'
  const hoverStyles = hover || onClick ? 'cursor-pointer hover:border-slate-600 hover:bg-surface-light/30 transition-all' : ''
  const paddings = {
    none: '',
    sm: 'p-3',
    md: 'p-4',
    lg: 'p-6',
  }

  return (
    <div
      className={`${base} ${hoverStyles} ${paddings[padding]} ${className}`}
      onClick={onClick}
    >
      {children}
    </div>
  )
}


interface BadgeProps {
  children: ReactNode
  variant?: 'primary' | 'success' | 'warning' | 'danger' | 'neutral'
  size?: 'sm' | 'md'
  dot?: boolean
}

export const Badge = ({ children, variant = 'primary', size = 'md', dot = false }: BadgeProps) => {
  const variants = {
    primary: 'bg-primary/20 text-primary',
    success: 'bg-success/20 text-success',
    warning: 'bg-warning/20 text-warning',
    danger: 'bg-danger/20 text-danger',
    neutral: 'bg-slate-600/50 text-slate-400',
  }

  const sizes = {
    sm: 'px-2 py-0.5 text-xs',
    md: 'px-2.5 py-1 text-xs',
  }

  const dotColors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    danger: 'bg-danger',
    neutral: 'bg-slate-500',
  }

  return (
    <span className={`inline-flex items-center gap-1.5 font-medium rounded-lg ${variants[variant]} ${sizes[size]}`}>
      {dot && <span className={`w-1.5 h-1.5 rounded-full ${dotColors[variant]}`} />}
      {children}
    </span>
  )
}


interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string
  error?: string
  icon?: ReactNode
  rightIcon?: ReactNode
}

export const Input = forwardRef<HTMLInputElement, InputProps>(
  ({ label, error, icon, rightIcon, className = '', ...props }, ref) => {
    return (
      <div className="space-y-1.5">
        {label && (
          <label className="block text-sm font-medium text-slate-300">
            {label}
          </label>
        )}
        <div className="relative">
          {icon && (
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">
              {icon}
            </div>
          )}
          <input
            ref={ref}
            className={`
              w-full bg-surface-light border border-slate-600 rounded-xl
              px-4 py-2.5 text-white placeholder-slate-500
              focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none
              transition-all duration-150
              ${icon ? 'pl-10' : ''}
              ${rightIcon ? 'pr-10' : ''}
              ${error ? 'border-danger focus:border-danger focus:ring-danger/20' : ''}
              ${className}
            `}
            {...props}
          />
          {rightIcon && (
            <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500">
              {rightIcon}
            </div>
          )}
        </div>
        {error && <p className="text-sm text-danger">{error}</p>}
      </div>
    )
  }
)

Input.displayName = 'Input'


export const Skeleton = ({ className = '' }: { className?: string }) => (
  <div className={`bg-surface-light rounded-lg animate-pulse ${className}`} />
)


interface LoaderProps {
  size?: 'sm' | 'md' | 'lg'
  text?: string
  fullScreen?: boolean
}

export const Loader = ({ size = 'md', text, fullScreen = false }: LoaderProps) => {
  const sizes = {
    sm: 'w-4 h-4 border-2',
    md: 'w-8 h-8 border-2',
    lg: 'w-12 h-12 border-3',
  }

  const content = (
    <div className="flex flex-col items-center justify-center gap-3">
      <div className={`${sizes[size]} border-primary border-t-transparent rounded-full animate-spin`} />
      {text && <p className="text-slate-400 text-sm">{text}</p>}
    </div>
  )

  if (fullScreen) {
    return (
      <div className="fixed inset-0 bg-background flex items-center justify-center z-50">
        {content}
      </div>
    )
  }

  return content
}


interface EmptyStateProps {
  icon?: ReactNode
  title: string
  description?: string
  action?: ReactNode
}

export const EmptyState = ({ icon, title, description, action }: EmptyStateProps) => (
  <div className="flex flex-col items-center justify-center py-12 text-center">
    {icon && <div className="text-slate-600 mb-4">{icon}</div>}
    <h3 className="text-lg font-medium text-slate-300 mb-2">{title}</h3>
    {description && <p className="text-slate-500 mb-4 max-w-sm">{description}</p>}
    {action}
  </div>
)


interface StatsCardProps {
  title: string
  value: string | number
  icon?: ReactNode
  trend?: { value: number; label?: string }
  variant?: 'default' | 'primary' | 'success' | 'warning' | 'danger'
}

export const StatsCard = ({ title, value, icon, trend, variant = 'default' }: StatsCardProps) => {
  const iconBg = {
    default: 'bg-slate-600/50',
    primary: 'bg-primary/20',
    success: 'bg-success/20',
    warning: 'bg-warning/20',
    danger: 'bg-danger/20',
  }

  const iconColor = {
    default: 'text-slate-400',
    primary: 'text-primary',
    success: 'text-success',
    warning: 'text-warning',
    danger: 'text-danger',
  }

  return (
    <Card className="p-5">
      <div className="flex items-start justify-between">
        <div className="flex-1 min-w-0">
          <p className="text-sm text-slate-400 mb-1 truncate">{title}</p>
          <p className="text-2xl font-bold truncate">{value}</p>
          {trend && (
            <p className={`text-sm mt-1 ${trend.value >= 0 ? 'text-success' : 'text-danger'}`}>
              {trend.value >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(trend.value)}%
              {trend.label && <span className="text-slate-500 ml-1">{trend.label}</span>}
            </p>
          )}
        </div>
        {icon && (
          <div className={`p-3 rounded-xl ${iconBg[variant]} shrink-0 ml-3`}>
            <div className={iconColor[variant]}>{icon}</div>
          </div>
        )}
      </div>
    </Card>
  )
}


interface ModalProps {
  isOpen: boolean
  onClose: () => void
  title?: string
  children: ReactNode
  size?: 'sm' | 'md' | 'lg'
}

export const Modal = ({ isOpen, onClose, title, children, size = 'md' }: ModalProps) => {
  if (!isOpen) return null

  const sizes = {
    sm: 'max-w-sm',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
      <div className={`relative bg-surface rounded-2xl w-full ${sizes[size]} shadow-2xl animate-slideUp`}>
        {title && (
          <div className="px-6 py-4 border-b border-slate-700">
            <h2 className="text-lg font-semibold">{title}</h2>
          </div>
        )}
        <div className="p-6">{children}</div>
      </div>
    </div>
  )
}


interface Tab {
  key: string
  label: string
  icon?: ReactNode
}

interface TabsProps {
  tabs: Tab[]
  activeTab: string
  onChange: (key: string) => void
}

export const Tabs = ({ tabs, activeTab, onChange }: TabsProps) => {
  return (
    <div className="flex gap-1 p-1 bg-surface-light rounded-xl overflow-x-auto">
      {tabs.map((tab) => (
        <button
          key={tab.key}
          onClick={() => onChange(tab.key)}
          className={`
            flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg
            text-sm font-medium transition-all duration-150 whitespace-nowrap
            ${activeTab === tab.key
              ? 'bg-primary text-white shadow-lg'
              : 'text-slate-400 hover:text-white hover:bg-surface'
            }
          `}
        >
          {tab.icon}
          {tab.label}
        </button>
      ))}
    </div>
  )
}


interface ProgressProps {
  value: number
  max?: number
  size?: 'sm' | 'md'
  variant?: 'primary' | 'success' | 'warning' | 'danger'
  showLabel?: boolean
}

export const Progress = ({
  value,
  max = 100,
  size = 'md',
  variant = 'primary',
  showLabel = false
}: ProgressProps) => {
  const percent = Math.min(100, Math.max(0, (value / max) * 100))

  const heights = { sm: 'h-1.5', md: 'h-2.5' }
  const colors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    danger: 'bg-danger',
  }

  return (
    <div className="space-y-1">
      <div className={`w-full bg-surface-light rounded-full overflow-hidden ${heights[size]}`}>
        <div
          className={`${heights[size]} ${colors[variant]} rounded-full transition-all duration-300`}
          style={{ width: `${percent}%` }}
        />
      </div>
      {showLabel && (
        <div className="flex justify-between text-xs text-slate-500">
          <span>{value} / {max}</span>
          <span>{Math.round(percent)}%</span>
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/config/index.ts
================================================================================



export { API_BASE_URL, KEYCLOAK_CONFIG } from '../api/client'


export const config = {

  REQUEST_TIMEOUT: 15000,


  CACHE_TTL: 5 * 60 * 1000,


  DEBUG: import.meta.env.DEV,
}


export const PRODUCT_STATUS = {
  IN_PRODUCTION: 'IN_PRODUCTION',
  QUALITY_CONTROL: 'QUALITY_CONTROL',
  READY: 'READY',
  SHIPPED: 'SHIPPED',
  DEFECT: 'DEFECT',
  ARCHIVED: 'ARCHIVED',
} as const

export const TASK_STATUS = {
  PENDING: 'PENDING',
  IN_PROGRESS: 'IN_PROGRESS',
  COMPLETED: 'COMPLETED',
  CANCELLED: 'CANCELLED',
  ON_HOLD: 'ON_HOLD',
} as const

export const BOX_STATUS = {
  ACTIVE: 'ACTIVE',
  RESERVED: 'RESERVED',
  EMPTY: 'EMPTY',
  WRITTEN_OFF: 'WRITTEN_OFF',
} as const

export const STATUS_COLORS: Record<string, 'primary' | 'success' | 'warning' | 'danger' | 'neutral'> = {

  IN_PRODUCTION: 'warning',
  QUALITY_CONTROL: 'primary',
  READY: 'success',
  SHIPPED: 'primary',
  DEFECT: 'danger',
  ARCHIVED: 'neutral',

  PENDING: 'warning',
  IN_PROGRESS: 'primary',
  COMPLETED: 'success',
  CANCELLED: 'danger',
  ON_HOLD: 'neutral',

  ACTIVE: 'success',
  RESERVED: 'warning',
  EMPTY: 'neutral',
  WRITTEN_OFF: 'danger',
}

export const STATUS_LABELS: Record<string, string> = {

  IN_PRODUCTION: '–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ',
  QUALITY_CONTROL: '–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞',
  READY: '–ì–æ—Ç–æ–≤',
  SHIPPED: '–û—Ç–≥—Ä—É–∂–µ–Ω',
  DEFECT: '–ë—Ä–∞–∫',
  ARCHIVED: '–í –∞—Ä—Ö–∏–≤–µ',

  PENDING: '–û–∂–∏–¥–∞–µ—Ç',
  IN_PROGRESS: '–í —Ä–∞–±–æ—Ç–µ',
  COMPLETED: '–ó–∞–≤–µ—Ä—à–µ–Ω–∞',
  CANCELLED: '–û—Ç–º–µ–Ω–µ–Ω–∞',
  ON_HOLD: '–ù–∞ –ø–∞—É–∑–µ',

  ACTIVE: '–ê–∫—Ç–∏–≤–Ω–∞',
  RESERVED: '–†–µ–∑–µ—Ä–≤',
  EMPTY: '–ü—É—Å—Ç–æ',
  WRITTEN_OFF: '–°–ø–∏—Å–∞–Ω–∞',
}

export const USER_ROLES: Record<string, string> = {
  SUPER_ADMIN: '–°—É–ø–µ—Ä–∞–¥–º–∏–Ω',
  PRODUCTION_CHIEF: '–ù–∞—á–∞–ª—å–Ω–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞',
  WAREHOUSE_MASTER: '–ö–ª–∞–¥–æ–≤—â–∏–∫',
  TECHNOLOGIST: '–¢–µ—Ö–Ω–æ–ª–æ–≥',
  ASSEMBLER: '–°–±–æ—Ä—â–∏–∫',
  QC_INSPECTOR: '–ö–æ–Ω—Ç—Ä–æ–ª—ë—Ä –û–¢–ö',
  REPAIR_TECHNICIAN: '–†–µ–º–æ–Ω—Ç–Ω–∏–∫',
}

export default config

================================================================================
FILE: QMS-Mobile/mes-pwa/src/hooks/index.ts
================================================================================



import { useState, useEffect, useCallback, useRef } from 'react'


export function useDebounce<T>(value: T, delay: number = 300): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value)

  useEffect(() => {
    const timer = setTimeout(() => setDebouncedValue(value), delay)
    return () => clearTimeout(timer)
  }, [value, delay])

  return debouncedValue
}


export function useOnlineStatus(): boolean {
  const [isOnline, setIsOnline] = useState(navigator.onLine)

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return isOnline
}


export function useLocalStorage<T>(
  key: string,
  initialValue: T
): [T, (value: T | ((prev: T) => T)) => void] {
  const [storedValue, setStoredValue] = useState<T>(() => {
    try {
      const item = localStorage.getItem(key)
      return item ? JSON.parse(item) : initialValue
    } catch {
      return initialValue
    }
  })

  const setValue = useCallback(
    (value: T | ((prev: T) => T)) => {
      try {
        const valueToStore = value instanceof Function ? value(storedValue) : value
        setStoredValue(valueToStore)
        localStorage.setItem(key, JSON.stringify(valueToStore))
      } catch (error) {
        console.error('useLocalStorage error:', error)
      }
    },
    [key, storedValue]
  )

  return [storedValue, setValue]
}


export function usePrevious<T>(value: T): T | undefined {
  const ref = useRef<T>()
  useEffect(() => {
    ref.current = value
  }, [value])
  return ref.current
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/index.css
================================================================================

@tailwind base;
@tailwind components;
@tailwind utilities;





* {
  -webkit-tap-highlight-color: transparent;
}

html {
  scroll-behavior: smooth;
}

body {
  @apply bg-background text-slate-100 antialiased;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  overscroll-behavior: none;
}





::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  @apply bg-transparent;
}

::-webkit-scrollbar-thumb {
  @apply bg-slate-700 rounded-full;
}

::-webkit-scrollbar-thumb:hover {
  @apply bg-slate-600;
}





@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

.animate-slideUp {
  animation: slideUp 0.3s ease-out;
}

.animate-slideDown {
  animation: slideDown 0.3s ease-out;
}

.animate-scaleIn {
  animation: scaleIn 0.2s ease-out;
}

.animate-shimmer {
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.05) 50%,
    transparent 100%
  );
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}





input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -moz-appearance: textfield;
}

input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus {
  -webkit-text-fill-color: white;
  -webkit-box-shadow: 0 0 0px 1000px #1e293b inset;
  transition: background-color 5000s ease-in-out 0s;
}






.splash-screen {
  @apply fixed inset-0 bg-background flex items-center justify-center z-50;
  transition: opacity 0.3s ease-out;
}

.splash-screen.hidden {
  opacity: 0;
  pointer-events: none;
}


@supports (padding: max(0px)) {
  .safe-area-inset-top {
    padding-top: max(env(safe-area-inset-top), 0px);
  }
  
  .safe-area-inset-bottom {
    padding-bottom: max(env(safe-area-inset-bottom), 0px);
  }
}





.no-select {
  -webkit-user-select: none;
  user-select: none;
}

.truncate-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.truncate-3 {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}


.glass {
  @apply bg-surface/80 backdrop-blur-xl;
}


.gradient-text {
  @apply bg-gradient-to-r from-primary to-primary-light bg-clip-text text-transparent;
}


.hide-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.hide-scrollbar::-webkit-scrollbar {
  display: none;
}





:focus-visible {
  @apply outline-none ring-2 ring-primary ring-offset-2 ring-offset-background;
}

button:focus-visible,
a:focus-visible {
  @apply outline-none ring-2 ring-primary ring-offset-2 ring-offset-background rounded-lg;
}





@media print {
  body {
    @apply bg-white text-black;
  }
  
  .no-print {
    display: none !important;
  }
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/main.tsx
================================================================================

import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import { AuthProvider, AuthProviderProps } from 'react-oidc-context'
import App from './App'
import './index.css'
import { KEYCLOAK_CONFIG, getNetworkInfo } from './api/client'

const createOidcConfig = (): AuthProviderProps => {
  const networkInfo = getNetworkInfo()

  console.log('[MES] OIDC Authority:', KEYCLOAK_CONFIG.authority)
  console.log('[MES] OIDC Client:', KEYCLOAK_CONFIG.clientId)
  console.log('[MES] Network:', networkInfo.network)

  return {
    authority: KEYCLOAK_CONFIG.authority,
    client_id: KEYCLOAK_CONFIG.clientId,
    redirect_uri: `${window.location.origin}/`,
    post_logout_redirect_uri: `${window.location.origin}/`,
    response_type: 'code',
    scope: 'openid profile email',
    automaticSilentRenew: true,
    onSigninCallback: () => {
      window.history.replaceState({}, document.title, window.location.pathname)
    },
  }
}

const oidcConfig = createOidcConfig()

const registerServiceWorker = () => {
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' })
        console.log('[PWA] SW registered:', registration.scope)

        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[PWA] New version available')
              }
            })
          }
        })
      } catch (error) {
        console.error('[PWA] SW registration failed:', error)
      }
    })
  }
}

if (import.meta.env.PROD) {
  registerServiceWorker()
}

const networkInfo = getNetworkInfo()
console.log('[MES] PWA Mode:', import.meta.env.MODE)
console.log('[MES] Network:', networkInfo.network)
console.log('[MES] API:', networkInfo.apiUrl)

const root = document.getElementById('root')

if (!root) {
  throw new Error('Root element not found')
}

ReactDOM.createRoot(root).render(
  <React.StrictMode>
    <AuthProvider {...oidcConfig}>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </AuthProvider>
  </React.StrictMode>
)

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Auth/LoginPage.tsx
================================================================================



import { useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuth } from 'react-oidc-context'
import { Cpu, Key, AlertCircle } from 'lucide-react'
import { Button, Card } from '../../components/ui'

export const LoginPage = () => {
  const navigate = useNavigate()
  const auth = useAuth()


  useEffect(() => {
    if (auth.isAuthenticated) {
      navigate('/', { replace: true })
    }
  }, [auth.isAuthenticated, navigate])

  const handleLogin = () => {
    auth.signinRedirect()
  }

  return (
    <div className="min-h-screen bg-background flex items-center justify-center p-4">
      <div className="w-full max-w-sm">

        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-primary to-primary-dark rounded-2xl mb-4 shadow-2xl shadow-primary/30">
            <Cpu size={40} className="text-white" />
          </div>
          <h1 className="text-3xl font-bold">
            MES <span className="text-primary">Kryptonit</span>
          </h1>
          <p className="text-slate-400 mt-2">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º</p>
        </div>


        <Card className="p-6">
          <div className="space-y-4">
            {auth.error && (
              <div className="flex items-center gap-2 p-3 bg-danger/10 border border-danger/20 rounded-xl text-danger text-sm">
                <AlertCircle size={16} className="shrink-0" />
                <span>{auth.error.message}</span>
              </div>
            )}

            <Button
              onClick={handleLogin}
              className="w-full"
              size="lg"
              icon={<Key size={20} />}
              loading={auth.isLoading}
            >
              –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ SSO
            </Button>
          </div>
        </Card>


        <div className="mt-6 text-center">
          <p className="text-slate-600 text-sm">
            MES Kryptonit PWA v2.0
          </p>
          <p className="text-slate-700 text-xs mt-1">
            –î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∏
          </p>
        </div>
      </div>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Home/HomePage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { Link } from 'react-router-dom'
import {
  Package, Cpu, CheckCircle2, AlertTriangle, ArrowRight,
  ListTodo, Trophy, Clock, QrCode, TrendingUp
} from 'lucide-react'
import { Card, StatsCard, Badge, Skeleton, Button } from '../../components/ui'
import { useAuth } from 'react-oidc-context'
import { api } from '../../api/client'
import { STATUS_LABELS, STATUS_COLORS } from '../../config'
import type { Task, UserStats } from '../../types'

interface DashboardData {
  warehouse: { totalBoxes: number; alertsCount: number }
  production: { today: number; inProgress: number }
  userStats: UserStats | null
  recentTasks: Task[]
}

export const HomePage = () => {
  const auth = useAuth()
  const user = auth.user?.profile ? {
    name: auth.user.profile.given_name || '',
    surname: auth.user.profile.family_name || '',
  } : null
  const [data, setData] = useState<DashboardData | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadDashboard()
  }, [])

  const loadDashboard = async () => {
    try {
      const [tasksRes] = await Promise.allSettled([
        api.get('/tasks', { params: { limit: 5 } }),
      ])

      setData({
        warehouse: {
          totalBoxes: 0,
          alertsCount: 0,
        },
        production: { today: 0, inProgress: 0 },
        userStats: null,
        recentTasks: tasksRes.status === 'fulfilled' ? (tasksRes.value.data?.rows || tasksRes.value.data || []) : [],
      })
    } catch (error) {
      console.error('Dashboard load error:', error)
    } finally {
      setLoading(false)
    }
  }

  const getGreeting = () => {
    const hour = new Date().getHours()
    if (hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ'
    if (hour < 18) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å'
    return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä'
  }

  return (
    <div className="space-y-6 animate-fadeIn">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">{getGreeting()}, {user?.name}!</h1>
          <p className="text-slate-400 mt-1">–í–æ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–≥–æ–¥–Ω—è</p>
        </div>
        <Link to="/production/scan">
          <Button icon={<QrCode size={18} />}>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</Button>
        </Link>
      </div>


      <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
        {loading ? (
          <>
            <Skeleton className="h-28" />
            <Skeleton className="h-28" />
            <Skeleton className="h-28" />
            <Skeleton className="h-28" />
          </>
        ) : (
          <>
            <StatsCard title="–ù–∞ —Å–∫–ª–∞–¥–µ" value={data?.warehouse.totalBoxes || 0} icon={<Package size={24} />} variant="primary" />
            <StatsCard title="–í —Ä–∞–±–æ—Ç–µ" value={data?.production.inProgress || 0} icon={<Cpu size={24} />} variant="warning" />
            <StatsCard title="–ú–æ–π —Ä–µ–π—Ç–∏–Ω–≥" value={data?.userStats?.rank ? `#${data.userStats.rank}` : '‚Äî'} icon={<Trophy size={24} />} variant="success" />
            <StatsCard title="–ö—Ä–∏—Ç–∏—á–Ω–æ" value={data?.warehouse.alertsCount || 0} icon={<AlertTriangle size={24} />} variant={data?.warehouse.alertsCount ? 'danger' : 'default'} />
          </>
        )}
      </div>


      {data?.userStats && (
        <Card className="p-5">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <TrendingUp size={20} className="text-primary" />
            –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          </h2>
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold text-primary">{data.userStats.todayOperations}</p>
              <p className="text-xs text-slate-400 mt-1">–°–µ–≥–æ–¥–Ω—è</p>
            </div>
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold">{data.userStats.weekOperations}</p>
              <p className="text-xs text-slate-400 mt-1">–ó–∞ –Ω–µ–¥–µ–ª—é</p>
            </div>
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold">{data.userStats.monthOperations}</p>
              <p className="text-xs text-slate-400 mt-1">–ó–∞ –º–µ—Å—è—Ü</p>
            </div>
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold">{data.userStats.totalOperations}</p>
              <p className="text-xs text-slate-400 mt-1">–í—Å–µ–≥–æ</p>
            </div>
          </div>
        </Card>
      )}


      <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 lg:gap-4">
        <Link to="/warehouse">
          <Card hover className="p-5 group h-full">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-primary/20"><Package size={24} className="text-primary" /></div>
                <div><h3 className="font-semibold">–°–∫–ª–∞–¥</h3><p className="text-sm text-slate-400">–ó–∞–ø–∞—Å—ã</p></div>
              </div>
              <ArrowRight size={20} className="text-slate-600 group-hover:text-primary group-hover:translate-x-1 transition-all" />
            </div>
          </Card>
        </Link>

        <Link to="/production">
          <Card hover className="p-5 group h-full">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-success/20"><Cpu size={24} className="text-success" /></div>
                <div><h3 className="font-semibold">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h3><p className="text-sm text-slate-400">–°–±–æ—Ä–∫–∞</p></div>
              </div>
              <ArrowRight size={20} className="text-slate-600 group-hover:text-success group-hover:translate-x-1 transition-all" />
            </div>
          </Card>
        </Link>

        <Link to="/rankings">
          <Card hover className="p-5 group h-full">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-warning/20"><Trophy size={24} className="text-warning" /></div>
                <div><h3 className="font-semibold">–†–µ–π—Ç–∏–Ω–≥–∏</h3><p className="text-sm text-slate-400">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p></div>
              </div>
              <ArrowRight size={20} className="text-slate-600 group-hover:text-warning group-hover:translate-x-1 transition-all" />
            </div>
          </Card>
        </Link>
      </div>


      <Card className="p-5">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold flex items-center gap-2">
            <ListTodo size={20} className="text-primary" />
            –ú–æ–∏ –∑–∞–¥–∞—á–∏
          </h2>
          <Link to="/tasks" className="text-sm text-primary hover:underline">–í—Å–µ –∑–∞–¥–∞—á–∏</Link>
        </div>

        {loading ? (
          <div className="space-y-3"><Skeleton className="h-14" /><Skeleton className="h-14" /><Skeleton className="h-14" /></div>
        ) : data?.recentTasks && data.recentTasks.length > 0 ? (
          <div className="space-y-2">
            {data.recentTasks.map((task) => (
              <Link key={task.id} to="/tasks" className="flex items-center justify-between p-3 rounded-xl hover:bg-surface-light transition-colors">
                <div className="flex items-center gap-3 min-w-0">
                  <div className={`w-2 h-2 rounded-full shrink-0 ${task.status === 'IN_PROGRESS' ? 'bg-primary' : 'bg-warning'}`} />
                  <span className="font-medium truncate">{task.title}</span>
                </div>
                <Badge variant={STATUS_COLORS[task.status] || 'neutral'}>{STATUS_LABELS[task.status] || task.status}</Badge>
              </Link>
            ))}
          </div>
        ) : (
          <div className="text-center py-8 text-slate-500">
            <CheckCircle2 size={32} className="mx-auto mb-2 opacity-50" />
            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</p>
          </div>
        )}
      </Card>


      <Card className="p-4">
        <div className="flex items-center justify-center gap-3 text-slate-400">
          <Clock size={18} />
          <span>{new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
        </div>
      </Card>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Production/ChecklistPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import {
  ArrowLeft,
  Check,
  Circle,
  CheckCircle2,
  AlertCircle,
  Camera,
  QrCode
} from 'lucide-react'
import { Card, Button, Input, Badge, Loader, Progress } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import type { Product, ProductionStep, ChecklistItem } from '../../types'

interface ChecklistItemState {
  item: ChecklistItem
  value: string
  completed: boolean
}

export const ChecklistPage = () => {
  const { productId, stepId } = useParams<{ productId: string; stepId: string }>()
  const navigate = useNavigate()

  const [product, setProduct] = useState<Product | null>(null)
  const [step, setStep] = useState<ProductionStep | null>(null)
  const [items, setItems] = useState<ChecklistItemState[]>([])
  const [loading, setLoading] = useState(true)
  const [submitting, setSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (productId && stepId) loadData()
  }, [productId, stepId])

  const loadData = async () => {
    try {
      setLoading(true)

      const [productRes, stepRes] = await Promise.all([
        api.get(`/products/${productId}`),
        api.get(`/production-steps/${stepId}`),
      ])

      setProduct(productRes.data)
      setStep(stepRes.data)

      const checklistItems = stepRes.data.checklistItems || []
      setItems(
        checklistItems
          .sort((a: ChecklistItem, b: ChecklistItem) => a.order - b.order)
          .map((item: ChecklistItem) => ({
            item,
            value: '',
            completed: false,
          }))
      )

      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const updateItem = (index: number, value: string, completed?: boolean) => {
    setItems(prev => prev.map((item, i) => {
      if (i !== index) return item

      const newCompleted = completed !== undefined
        ? completed
        : item.item.type === 'checkbox'
          ? !item.completed
          : !!value

      return { ...item, value, completed: newCompleted }
    }))
  }

  const completedCount = items.filter(i => i.completed).length
  const canSubmit = items.filter(i => i.item.required).every(i => i.completed)

  const handleSubmit = async () => {
    if (!canSubmit) return

    try {
      setSubmitting(true)

      await api.post(`/products/${productId}/complete-step`, {
        stepId: parseInt(stepId!),
        responses: items.map(i => ({
          itemId: i.item.id,
          value: i.item.type === 'checkbox' ? (i.completed ? 'true' : 'false') : i.value,
        })),
      })

      navigate(`/production/${productId}`, { replace: true })
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setSubmitting(false)
    }
  }

  const renderItemInput = (itemState: ChecklistItemState, index: number) => {
    const { item, value, completed } = itemState

    switch (item.type) {
      case 'checkbox':
        return (
          <button
            onClick={() => updateItem(index, '', !completed)}
            className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${
              completed
                ? 'bg-success border-success'
                : 'border-slate-600 hover:border-primary'
            }`}
          >
            {completed && <Check size={14} className="text-white" />}
          </button>
        )

      case 'text':
        return (
          <Input
            value={value}
            onChange={(e) => updateItem(index, e.target.value)}
            placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ..."
            className="mt-2"
          />
        )

      case 'number':
        return (
          <Input
            type="number"
            value={value}
            onChange={(e) => updateItem(index, e.target.value)}
            placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ..."
            className="mt-2"
          />
        )

      case 'select':
        return (
          <div className="flex flex-wrap gap-2 mt-2">
            {item.options?.map((option) => (
              <button
                key={option}
                onClick={() => updateItem(index, option, true)}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                  value === option
                    ? 'bg-primary text-white'
                    : 'bg-surface-light text-slate-400 hover:text-white'
                }`}
              >
                {option}
              </button>
            ))}
          </div>
        )

      case 'photo':
        return (
          <button
            onClick={() => updateItem(index, 'photo_captured', true)}
            className="mt-2 w-full p-4 border-2 border-dashed border-slate-600 rounded-xl
              hover:border-primary transition-colors flex flex-col items-center gap-2"
          >
            <Camera size={24} className="text-slate-500" />
            <span className="text-sm text-slate-400">
              {completed ? '–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ‚úì' : '–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ'}
            </span>
          </button>
        )

      case 'serial':
        return (
          <div className="mt-2 flex gap-2">
            <Input
              value={value}
              onChange={(e) => updateItem(index, e.target.value.toUpperCase())}
              placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä..."
              className="flex-1 font-mono"
            />
            <Button variant="outline" icon={<QrCode size={18} />}>
              –°–∫–∞–Ω
            </Button>
          </div>
        )

      default:
        return null
    }
  }

  if (loading) {
    return (
      <div className="flex justify-center py-12">
        <Loader text="–ó–∞–≥—Ä—É–∑–∫–∞..." />
      </div>
    )
  }

  if (error || !product || !step) {
    return (
      <div className="text-center py-12">
        <p className="text-danger mb-4">{error || '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}</p>
        <Button variant="outline" onClick={() => navigate(-1)}>
          –ù–∞–∑–∞–¥
        </Button>
      </div>
    )
  }

  return (
    <div className="max-w-xl mx-auto space-y-4 animate-fadeIn pb-24">

      <div className="flex items-center gap-4">
        <Button
          variant="ghost"
          icon={<ArrowLeft size={20} />}
          onClick={() => navigate(-1)}
        />
        <div className="flex-1 min-w-0">
          <h1 className="text-lg font-bold truncate">{step.title}</h1>
          <p className="text-slate-400 text-sm font-mono truncate">{product.serialNumber}</p>
        </div>
      </div>


      <Card className="p-4">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm text-slate-400">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
          <span className="text-sm font-medium">{completedCount} / {items.length}</span>
        </div>
        <Progress
          value={completedCount}
          max={items.length}
          variant={completedCount === items.length ? 'success' : 'primary'}
        />
      </Card>


      <div className="space-y-3">
        {items.map((itemState, index) => (
          <Card
            key={itemState.item.id}
            className={`p-4 transition-all ${
              itemState.completed ? 'border-success/30 bg-success/5' : ''
            }`}
          >
            <div className="flex items-start gap-3">
              {itemState.item.type === 'checkbox' ? (
                renderItemInput(itemState, index)
              ) : (
                <div className={`w-6 h-6 rounded-full flex items-center justify-center shrink-0 ${
                  itemState.completed ? 'bg-success/20' : 'bg-surface-light'
                }`}>
                  {itemState.completed ? (
                    <CheckCircle2 size={16} className="text-success" />
                  ) : (
                    <Circle size={16} className="text-slate-500" />
                  )}
                </div>
              )}

              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                  <p className={`font-medium ${itemState.completed ? 'text-success' : ''}`}>
                    {itemState.item.title}
                  </p>
                  {itemState.item.required && (
                    <Badge variant="danger" size="sm">–û–±—è–∑.</Badge>
                  )}
                </div>

                {itemState.item.type !== 'checkbox' && renderItemInput(itemState, index)}
              </div>
            </div>
          </Card>
        ))}
      </div>


      <div className="fixed bottom-0 left-0 right-0 p-4 bg-background/80 backdrop-blur-xl border-t border-slate-700/50">
        <div className="max-w-xl mx-auto">
          {!canSubmit && (
            <p className="text-center text-sm text-warning mb-3 flex items-center justify-center gap-2">
              <AlertCircle size={16} />
              –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã
            </p>
          )}
          <Button
            onClick={handleSubmit}
            disabled={!canSubmit}
            loading={submitting}
            fullWidth
            size="lg"
            icon={<Check size={18} />}
          >
            –ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
          </Button>
        </div>
      </div>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Production/ProductScanPage.tsx
================================================================================



import { useState, useRef, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { QrCode, Keyboard, Search, ArrowRight, Package, ArrowLeft } from 'lucide-react'
import { Card, Input, Button, Badge, Loader, EmptyState } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { STATUS_LABELS, STATUS_COLORS } from '../../config'
import type { ScanResult } from '../../types'

export const ProductScanPage = () => {
  const navigate = useNavigate()
  const inputRef = useRef<HTMLInputElement>(null)

  const [serialNumber, setSerialNumber] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [result, setResult] = useState<ScanResult | null>(null)

  useEffect(() => {
    setTimeout(() => inputRef.current?.focus(), 100)
  }, [])

  const handleSearch = async () => {
    const code = serialNumber.trim()
    if (!code) return

    setLoading(true)
    setError(null)
    setResult(null)

    try {
      const { data } = await api.post('/products/scan', { code })
      setResult(data)
    } catch (err) {
      setError(getErrorMessage(err, '–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'))
    } finally {
      setLoading(false)
    }
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleSearch()
    }
  }

  const handleStartOperation = () => {
    if (result?.product && result?.nextStep) {
      navigate(`/production/checklist/${result.product.id}/${result.nextStep.id}`)
    }
  }

  const handleViewProduct = () => {
    if (result?.product) {
      navigate(`/production/${result.product.id}`)
    }
  }

  const handleReset = () => {
    setSerialNumber('')
    setResult(null)
    setError(null)
    inputRef.current?.focus()
  }

  return (
    <div className="max-w-xl mx-auto space-y-6 animate-fadeIn">

      <div className="flex items-center gap-4">
        <Button
          variant="ghost"
          icon={<ArrowLeft size={20} />}
          onClick={() => navigate(-1)}
        />
        <div>
          <h1 className="text-xl font-bold">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
          <p className="text-slate-400 text-sm">–ù–∞–π—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç</p>
        </div>
      </div>


      <div className="text-center">
        <div className="inline-flex items-center justify-center w-20 h-20 bg-primary/20 rounded-2xl">
          <QrCode size={40} className="text-primary" />
        </div>
      </div>


      <Card className="p-5">
        <div className="flex gap-3">
          <div className="flex-1">
            <Input
              ref={inputRef}
              placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ QR..."
              icon={<Keyboard size={18} />}
              value={serialNumber}
              onChange={(e) => {
                setSerialNumber(e.target.value.toUpperCase())
                setError(null)
              }}
              onKeyDown={handleKeyDown}
              className="text-lg font-mono"
            />
          </div>
          <Button
            onClick={handleSearch}
            loading={loading}
            disabled={!serialNumber.trim()}
            size="lg"
            icon={<Search size={18} />}
          >
            <span className="hidden sm:inline">–ù–∞–π—Ç–∏</span>
          </Button>
        </div>

        <p className="text-sm text-slate-500 mt-3 text-center">
          –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫–∞–Ω–µ—Ä –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é
        </p>
      </Card>


      {loading && (
        <div className="flex justify-center py-8">
          <Loader text="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞..." />
        </div>
      )}


      {error && !loading && (
        <Card className="p-6 bg-danger/10 border-danger/20">
          <div className="text-center">
            <p className="text-danger font-medium mb-4">{error}</p>
            <Button variant="outline" onClick={handleReset}>
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </Button>
          </div>
        </Card>
      )}


      {result && !loading && (
        <Card className="p-5 animate-slideUp">
          <div className="flex items-start justify-between mb-4">
            <div>
              <h2 className="text-xl font-bold font-mono">{result.product.serialNumber}</h2>
              <p className="text-slate-400">{result.product.productType?.name || '–ü—Ä–æ–¥—É–∫—Ç'}</p>
            </div>
            <Badge variant={STATUS_COLORS[result.product.status] || 'neutral'}>
              {STATUS_LABELS[result.product.status] || result.product.status}
            </Badge>
          </div>

          {result.currentStep && (
            <div className="p-4 bg-surface-light rounded-xl mb-3">
              <p className="text-sm text-slate-400 mb-1">–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø</p>
              <p className="font-medium">{result.currentStep.title}</p>
            </div>
          )}

          {result.nextStep && (
            <div className="p-4 bg-primary/10 border border-primary/20 rounded-xl mb-3">
              <p className="text-sm text-primary mb-1">–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø</p>
              <p className="font-medium">{result.nextStep.title}</p>
            </div>
          )}

          {result.message && (
            <p className="text-sm text-slate-400 text-center mb-4">
              {result.message}
            </p>
          )}

          <div className="flex gap-3 mt-6">
            {result.canProceed && result.nextStep && (
              <Button
                onClick={handleStartOperation}
                className="flex-1"
                icon={<ArrowRight size={18} />}
              >
                –ù–∞—á–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
              </Button>
            )}
            <Button
              onClick={handleViewProduct}
              variant={result.canProceed ? 'outline' : 'primary'}
              className="flex-1"
            >
              –ü–æ–¥—Ä–æ–±–Ω–µ–µ
            </Button>
          </div>

          <button
            onClick={handleReset}
            className="w-full text-center text-sm text-primary hover:underline mt-4"
          >
            –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø—Ä–æ–¥—É–∫—Ç
          </button>
        </Card>
      )}


      {!loading && !error && !result && (
        <EmptyState
          icon={<Package size={48} />}
          title="–ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é"
          description="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä"
        />
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Production/ProductionPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useNavigate, Link } from 'react-router-dom'
import {
  Search,
  Cpu,
  QrCode,
  ChevronRight
} from 'lucide-react'
import { Card, Input, Button, Badge, EmptyState, Loader, Tabs } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { useDebounce } from '../../hooks'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { Product } from '../../types'

export const ProductionPage = () => {
  const navigate = useNavigate()

  const [products, setProducts] = useState<Product[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [search, setSearch] = useState('')
  const [activeTab, setActiveTab] = useState('all')

  const debouncedSearch = useDebounce(search, 300)

  useEffect(() => {
    loadProducts()
  }, [debouncedSearch, activeTab])

  const loadProducts = async () => {
    try {
      setLoading(true)

      const params: Record<string, any> = { limit: 50 }
      if (debouncedSearch) params.search = debouncedSearch
      if (activeTab !== 'all') params.status = activeTab

      const { data } = await api.get('/production/outputs', { params })
      setProducts(Array.isArray(data) ? data : data.rows || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const tabs = [
    { key: 'all', label: '–í—Å–µ' },
    { key: 'IN_PRODUCTION', label: '–í —Ä–∞–±–æ—Ç–µ' },
    { key: 'QUALITY_CONTROL', label: '–û–¢–ö' },
    { key: 'READY', label: '–ì–æ—Ç–æ–≤–æ' },
  ]

  return (
    <div className="space-y-4 animate-fadeIn">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h1>
          <p className="text-slate-400 text-sm">–°–±–æ—Ä–∫–∞ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞</p>
        </div>
        <Link to="/production/scan">
          <Button icon={<QrCode size={18} />}>
            –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
          </Button>
        </Link>
      </div>


      <Card className="p-3">
        <Input
          placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É..."
          icon={<Search size={18} />}
          value={search}
          onChange={(e) => setSearch(e.target.value.toUpperCase())}
        />
      </Card>


      <Tabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />


      {loading ? (
        <div className="flex justify-center py-12">
          <Loader text="–ó–∞–≥—Ä—É–∑–∫–∞..." />
        </div>
      ) : error ? (
        <Card className="p-6 text-center">
          <p className="text-danger mb-4">{error}</p>
          <Button variant="outline" onClick={loadProducts}>
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
          </Button>
        </Card>
      ) : products.length === 0 ? (
        <EmptyState
          icon={<Cpu size={48} />}
          title="–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          description={search ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å' : '–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º'}
          action={
            <Link to="/production/scan">
              <Button icon={<QrCode size={18} />}>
                –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π
              </Button>
            </Link>
          }
        />
      ) : (
        <div className="grid gap-3">
          {products.map((product) => (
            <Card
              key={product.id}
              hover
              className="p-4"
              onClick={() => navigate(`/production/${product.id}`)}
            >
              <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-4 min-w-0">
                  <div className="w-12 h-12 rounded-xl bg-surface-light flex items-center justify-center shrink-0">
                    <Cpu size={24} className="text-primary" />
                  </div>
                  <div className="min-w-0">
                    <p className="font-bold truncate">{product.serialNumber}</p>
                    <p className="text-sm text-slate-400 truncate">
                      {product.productType?.name || '–ë–µ–∑ —Ç–∏–ø–∞'}
                    </p>
                    {product.currentStep && (
                      <p className="text-xs text-slate-500 truncate mt-1">
                        –≠—Ç–∞–ø: {product.currentStep.title}
                      </p>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-3 shrink-0">
                  <Badge variant={STATUS_COLORS[product.status] || 'neutral'}>
                    {STATUS_LABELS[product.status] || product.status}
                  </Badge>
                  <ChevronRight size={20} className="text-slate-600" />
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Profile/ProfilePage.tsx
================================================================================



import { useState } from 'react'
import { useNavigate } from 'react-router-dom'
import {
  User,
  Mail,
  Shield,
  LogOut,
  Bell,
  Moon,
  Smartphone,
  Download,
  CheckCircle,
  Info,
  ChevronRight,
  RefreshCw
} from 'lucide-react'
import { Card, Button, Badge } from '../../components/ui'
import { useAuth } from 'react-oidc-context'
import { USER_ROLES } from '../../config'

export const ProfilePage = () => {
  const navigate = useNavigate()
  const auth = useAuth()


  const user = auth.user?.profile ? {
    name: auth.user.profile.given_name || '',
    surname: auth.user.profile.family_name || '',
    login: auth.user.profile.preferred_username || auth.user.profile.email || '',
    email: auth.user.profile.email || '',
    role: (auth.user.profile as any).realm_access?.roles?.[0] || 'USER',
    img: (auth.user.profile as any).picture,
  } : null

  const authMethod = 'keycloak'
  const logout = () => auth.signoutRedirect()

  const [installPrompt, setInstallPrompt] = useState<any>(null)
  const [isInstalled, setIsInstalled] = useState(false)


  useState(() => {

    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
      setIsInstalled(true)
    }


    const handleBeforeInstall = (e: any) => {
      e.preventDefault()
      setInstallPrompt(e)
    }

    window.addEventListener('beforeinstallprompt', handleBeforeInstall)

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstall)
    }
  })

  const handleInstall = async () => {
    if (!installPrompt) return

    installPrompt.prompt()
    const { outcome } = await installPrompt.userChoice

    if (outcome === 'accepted') {
      setIsInstalled(true)
      setInstallPrompt(null)
    }
  }

  const handleLogout = () => {
    if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
      logout()
      navigate('/login')
    }
  }

  const handleRefreshApp = () => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        registrations.forEach((registration) => {
          registration.update()
        })
      })
    }
    window.location.reload()
  }

  return (
    <div className="max-w-xl mx-auto space-y-4 animate-fadeIn">

      <div>
        <h1 className="text-2xl font-bold">–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <p className="text-slate-400 text-sm">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
      </div>


      <Card className="p-6">
        <div className="flex items-center gap-4">
          <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center border border-primary/20">
            {user?.img ? (
              <img src={user.img} alt="" className="w-full h-full rounded-2xl object-cover" />
            ) : (
              <User size={28} className="text-primary" />
            )}
          </div>
          <div className="flex-1 min-w-0">
            <h2 className="text-xl font-bold truncate">
              {user?.surname} {user?.name}
            </h2>
            <p className="text-slate-400 truncate">@{user?.login}</p>
            <Badge variant="primary" className="mt-2">
              {USER_ROLES[user?.role || ''] || user?.role}
            </Badge>
          </div>
        </div>


        <div className="mt-4 pt-4 border-t border-slate-700/50">
          <div className="flex items-center gap-2 text-sm text-slate-400">
            <Shield size={14} />
            <span>
              –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: {authMethod === 'keycloak' ? 'SSO (Keycloak)' : '–õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å'}
            </span>
          </div>
        </div>
      </Card>


      <Card className="divide-y divide-slate-700/50">
        <div className="p-4 flex items-center gap-4">
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <User size={18} className="text-slate-400" />
          </div>
          <div className="flex-1">
            <p className="text-sm text-slate-400">–õ–æ–≥–∏–Ω</p>
            <p className="font-medium">{user?.login}</p>
          </div>
        </div>

        {user?.team && (
          <div className="p-4 flex items-center gap-4">
            <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
              <Shield size={18} className="text-slate-400" />
            </div>
            <div className="flex-1">
              <p className="text-sm text-slate-400">–ö–æ–º–∞–Ω–¥–∞</p>
              <p className="font-medium">{user.team.title}</p>
            </div>
          </div>
        )}

        {user?.section && (
          <div className="p-4 flex items-center gap-4">
            <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
              <Info size={18} className="text-slate-400" />
            </div>
            <div className="flex-1">
              <p className="text-sm text-slate-400">–£—á–∞—Å—Ç–æ–∫</p>
              <p className="font-medium">{user.section.title}</p>
            </div>
          </div>
        )}
      </Card>


      {user?.abilities && user.abilities.length > 0 && (
        <Card className="p-4">
          <h3 className="font-semibold mb-3 flex items-center gap-2">
            <Shield size={18} className="text-primary" />
            –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
          </h3>
          <div className="flex flex-wrap gap-2">
            {user.abilities.map((ability) => (
              <Badge key={ability} variant="neutral">
                {ability}
              </Badge>
            ))}
          </div>
        </Card>
      )}


      {!isInstalled && (
        <Card className="p-4 bg-primary/10 border-primary/20">
          <div className="flex items-center gap-4">
            <div className="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center shrink-0">
              <Smartphone size={24} className="text-primary" />
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="font-semibold">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
              <p className="text-sm text-slate-400">
                –î–æ–±–∞–≤—å—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
              </p>
            </div>
            <Button
              onClick={handleInstall}
              disabled={!installPrompt}
              icon={<Download size={18} />}
            >
              <span className="hidden sm:inline">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</span>
            </Button>
          </div>
        </Card>
      )}

      {isInstalled && (
        <Card className="p-4 bg-success/10 border-success/20">
          <div className="flex items-center gap-3 text-success">
            <CheckCircle size={20} />
            <span className="font-medium">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>
          </div>
        </Card>
      )}


      <Card className="divide-y divide-slate-700/50">
        <button className="w-full p-4 flex items-center gap-4 hover:bg-surface-light/50 transition-colors">
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <Bell size={18} className="text-slate-400" />
          </div>
          <div className="flex-1 text-left">
            <p className="font-medium">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
            <p className="text-sm text-slate-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
          </div>
          <ChevronRight size={20} className="text-slate-600" />
        </button>

        <button className="w-full p-4 flex items-center gap-4 hover:bg-surface-light/50 transition-colors">
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <Moon size={18} className="text-slate-400" />
          </div>
          <div className="flex-1 text-left">
            <p className="font-medium">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</p>
            <p className="text-sm text-slate-500">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</p>
          </div>
          <ChevronRight size={20} className="text-slate-600" />
        </button>

        <button
          onClick={handleRefreshApp}
          className="w-full p-4 flex items-center gap-4 hover:bg-surface-light/50 transition-colors"
        >
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <RefreshCw size={18} className="text-slate-400" />
          </div>
          <div className="flex-1 text-left">
            <p className="font-medium">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
            <p className="text-sm text-slate-500">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</p>
          </div>
          <ChevronRight size={20} className="text-slate-600" />
        </button>
      </Card>


      <Card className="p-4">
        <div className="text-center text-sm text-slate-500">
          <p>MES Kryptonit PWA v2.0.0</p>
          <p className="mt-1">¬© 2024 –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
        </div>
      </Card>


      <Button
        variant="danger"
        fullWidth
        size="lg"
        icon={<LogOut size={18} />}
        onClick={handleLogout}
      >
        –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
      </Button>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Rankings/RankingsPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import {
  Trophy,
  Users,
  TrendingUp,
  TrendingDown,
  Medal,
  Crown,
  RefreshCw
} from 'lucide-react'
import { Card, Tabs, Badge, Loader, EmptyState } from '../../components/ui'
import { useAuth } from 'react-oidc-context'
import { api, getErrorMessage } from '../../api/client'
import type { UserRanking, TeamRanking, UserStats } from '../../types'

type Period = 'day' | 'week' | 'month' | 'all'

export const RankingsPage = () => {
  const auth = useAuth()
  const user = auth.user?.profile ? {
    id: auth.user.profile.sub,
  } : null

  const [tab, setTab] = useState<'users' | 'teams'>('users')
  const [period, setPeriod] = useState<Period>('week')
  const [userRankings, setUserRankings] = useState<UserRanking[]>([])
  const [teamRankings, setTeamRankings] = useState<TeamRanking[]>([])
  const [myStats, setMyStats] = useState<UserStats | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    loadRankings()
  }, [tab, period])

  const loadRankings = async () => {
    try {
      setLoading(true)


      setUserRankings([])
      setTeamRankings([])
      setMyStats(null)

      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const getRankIcon = (rank: number) => {
    if (rank === 1) return <Crown size={20} className="text-yellow-400" />
    if (rank === 2) return <Medal size={20} className="text-slate-300" />
    if (rank === 3) return <Medal size={20} className="text-amber-600" />
    return <span className="text-slate-500 font-mono text-sm">#{rank}</span>
  }

  const periodTabs = [
    { key: 'day', label: '–î–µ–Ω—å' },
    { key: 'week', label: '–ù–µ–¥–µ–ª—è' },
    { key: 'month', label: '–ú–µ—Å—è—Ü' },
    { key: 'all', label: '–í—Å—ë –≤—Ä–µ–º—è' },
  ]

  return (
    <div className="space-y-4 animate-fadeIn">

      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">–†–µ–π—Ç–∏–Ω–≥–∏</h1>
          <p className="text-slate-400 text-sm">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
        </div>
        <button
          onClick={loadRankings}
          className="p-2 hover:bg-surface-light rounded-lg transition-colors"
        >
          <RefreshCw size={20} className={`text-slate-400 ${loading ? 'animate-spin' : ''}`} />
        </button>
      </div>


      {myStats && tab === 'users' && (
        <Card className="p-5 bg-gradient-to-br from-primary/10 to-primary/5 border-primary/20">
          <div className="flex items-center gap-4 mb-4">
            <div className="w-14 h-14 rounded-2xl bg-primary/20 flex items-center justify-center">
              <Trophy size={28} className="text-primary" />
            </div>
            <div>
              <p className="text-sm text-slate-400">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥</p>
              <p className="text-3xl font-bold">#{myStats.rank}</p>
            </div>
            <div className="ml-auto text-right">
              <p className="text-sm text-slate-400">–∏–∑ {myStats.totalUsers}</p>
              <p className="text-sm text-slate-500">—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
            </div>
          </div>

          <div className="grid grid-cols-4 gap-3">
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold text-primary">{myStats.todayOperations}</p>
              <p className="text-xs text-slate-500">–°–µ–≥–æ–¥–Ω—è</p>
            </div>
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold">{myStats.weekOperations}</p>
              <p className="text-xs text-slate-500">–ù–µ–¥–µ–ª—è</p>
            </div>
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold">{myStats.monthOperations}</p>
              <p className="text-xs text-slate-500">–ú–µ—Å—è—Ü</p>
            </div>
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold">{myStats.totalOperations}</p>
              <p className="text-xs text-slate-500">–í—Å–µ–≥–æ</p>
            </div>
          </div>
        </Card>
      )}


      <Tabs
        tabs={[
          { key: 'users', label: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', icon: <Users size={16} /> },
          { key: 'teams', label: '–ö–æ–º–∞–Ω–¥—ã', icon: <Trophy size={16} /> },
        ]}
        activeTab={tab}
        onChange={(key) => setTab(key as 'users' | 'teams')}
      />


      <div className="flex gap-2 overflow-x-auto pb-1">
        {periodTabs.map((p) => (
          <button
            key={p.key}
            onClick={() => setPeriod(p.key as Period)}
            className={`px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${
              period === p.key
                ? 'bg-primary text-white'
                : 'bg-surface-light text-slate-400 hover:text-white'
            }`}
          >
            {p.label}
          </button>
        ))}
      </div>


      {loading ? (
        <div className="flex justify-center py-12">
          <Loader text="–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤..." />
        </div>
      ) : error ? (
        <Card className="p-6 text-center">
          <p className="text-danger mb-4">{error}</p>
        </Card>
      ) : tab === 'users' ? (
        userRankings.length > 0 ? (
          <div className="space-y-2">
            {userRankings.map((item) => {
              const isMe = item.userId === user?.id
              return (
                <Card
                  key={item.userId}
                  className={`p-4 ${isMe ? 'border-primary/50 bg-primary/5' : ''}`}
                >
                  <div className="flex items-center gap-4">
                    <div className="w-10 h-10 flex items-center justify-center">
                      {getRankIcon(item.rank)}
                    </div>

                    <div className="w-10 h-10 rounded-full bg-surface-light flex items-center justify-center shrink-0">
                      <span className="text-sm font-bold">
                        {item.user?.surname?.charAt(0)}{item.user?.name?.charAt(0)}
                      </span>
                    </div>

                    <div className="flex-1 min-w-0">
                      <p className={`font-medium truncate ${isMe ? 'text-primary' : ''}`}>
                        {item.user?.surname} {item.user?.name}
                        {isMe && <span className="text-xs text-slate-500 ml-2">(–≤—ã)</span>}
                      </p>
                      <p className="text-sm text-slate-500">
                        {item.operations} –æ–ø–µ—Ä–∞—Ü–∏–π
                      </p>
                    </div>

                    <div className="text-right shrink-0">
                      <p className="font-bold text-lg">{item.score}</p>
                      {item.trend !== 0 && (
                        <div className={`flex items-center justify-end gap-1 text-xs ${
                          item.trend > 0 ? 'text-success' : 'text-danger'
                        }`}>
                          {item.trend > 0 ? <TrendingUp size={12} /> : <TrendingDown size={12} />}
                          {Math.abs(item.trend)}%
                        </div>
                      )}
                    </div>
                  </div>
                </Card>
              )
            })}
          </div>
        ) : (
          <EmptyState
            icon={<Trophy size={48} />}
            title="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
            description="–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
          />
        )
      ) : (
        teamRankings.length > 0 ? (
          <div className="space-y-2">
            {teamRankings.map((item) => (
              <Card key={item.teamId} className="p-4">
                <div className="flex items-center gap-4">
                  <div className="w-10 h-10 flex items-center justify-center">
                    {getRankIcon(item.rank)}
                  </div>

                  <div className="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center shrink-0">
                    <Users size={18} className="text-primary" />
                  </div>

                  <div className="flex-1 min-w-0">
                    <p className="font-medium truncate">{item.team?.title || '–ö–æ–º–∞–Ω–¥–∞'}</p>
                    <p className="text-sm text-slate-500">
                      {item.memberCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Ä¢ {item.operations} –æ–ø–µ—Ä–∞—Ü–∏–π
                    </p>
                  </div>

                  <div className="text-right shrink-0">
                    <p className="font-bold text-lg">{item.score}</p>
                  </div>
                </div>
              </Card>
            ))}
          </div>
        ) : (
          <EmptyState
            icon={<Users size={48} />}
            title="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
            description="–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"
          />
        )
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Tasks/TasksPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import {
  ListTodo,
  Plus,
  Search,
  Filter,
  CheckCircle2,
  Clock,
  AlertCircle,
  ChevronRight
} from 'lucide-react'
import { Card, Input, Button, Badge, Tabs, EmptyState, Loader } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { useDebounce } from '../../hooks'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { Task } from '../../types'

export const TasksPage = () => {
  const [tasks, setTasks] = useState<Task[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [search, setSearch] = useState('')
  const [activeTab, setActiveTab] = useState('my')

  const debouncedSearch = useDebounce(search, 300)

  useEffect(() => {
    loadTasks()
  }, [debouncedSearch, activeTab])

  const loadTasks = async () => {
    try {
      setLoading(true)

      const params: Record<string, any> = { limit: 50 }
      if (debouncedSearch) params.search = debouncedSearch
      if (activeTab === 'my') params.assignedToMe = true
      if (activeTab === 'active') params.status = 'IN_PROGRESS,PENDING'
      if (activeTab === 'completed') params.status = 'COMPLETED'

      const { data } = await api.get('/tasks', { params })
      setTasks(Array.isArray(data) ? data : data.rows || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'COMPLETED':
        return <CheckCircle2 size={16} className="text-success" />
      case 'IN_PROGRESS':
        return <Clock size={16} className="text-primary" />
      case 'PENDING':
        return <AlertCircle size={16} className="text-warning" />
      default:
        return <Clock size={16} className="text-slate-500" />
    }
  }

  const getPriorityColor = (priority: number): 'danger' | 'warning' | 'neutral' => {
    if (priority >= 3) return 'danger'
    if (priority >= 2) return 'warning'
    return 'neutral'
  }

  const tabs = [
    { key: 'my', label: '–ú–æ–∏', icon: <ListTodo size={16} /> },
    { key: 'active', label: '–ê–∫—Ç–∏–≤–Ω—ã–µ' },
    { key: 'completed', label: '–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ' },
    { key: 'all', label: '–í—Å–µ' },
  ]

  return (
    <div className="space-y-4 animate-fadeIn">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">–ó–∞–¥–∞—á–∏</h1>
          <p className="text-slate-400 text-sm">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</p>
        </div>
        <Button icon={<Plus size={18} />}>
          –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
        </Button>
      </div>


      <Card className="p-3">
        <div className="flex gap-3">
          <div className="flex-1">
            <Input
              placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..."
              icon={<Search size={18} />}
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
          </div>
          <Button variant="outline" icon={<Filter size={18} />}>
            <span className="hidden sm:inline">–§–∏–ª—å—Ç—Ä—ã</span>
          </Button>
        </div>
      </Card>


      <Tabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />


      {loading ? (
        <div className="flex justify-center py-12">
          <Loader text="–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á..." />
        </div>
      ) : error ? (
        <Card className="p-6 text-center">
          <p className="text-danger mb-4">{error}</p>
          <Button variant="outline" onClick={loadTasks}>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</Button>
        </Card>
      ) : tasks.length === 0 ? (
        <EmptyState
          icon={<ListTodo size={48} />}
          title="–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          description={search ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å' : '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á'}
          action={
            <Button icon={<Plus size={18} />}>
              –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
            </Button>
          }
        />
      ) : (
        <div className="space-y-2">
          {tasks.map((task) => (
            <Card key={task.id} hover className="p-4">
              <div className="flex items-center gap-4">
                <div className="shrink-0">
                  {getStatusIcon(task.status)}
                </div>

                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <p className={`font-medium truncate ${
                      task.status === 'COMPLETED' ? 'text-slate-500 line-through' : ''
                    }`}>
                      {task.title}
                    </p>
                    {task.priority >= 2 && (
                      <Badge variant={getPriorityColor(task.priority)} size="sm">
                        {task.priority >= 3 ? '–°—Ä–æ—á–Ω–æ' : '–í–∞–∂–Ω–æ'}
                      </Badge>
                    )}
                  </div>

                  <div className="flex items-center gap-3 text-sm text-slate-500">
                    {task.project && (
                      <span className="truncate">{task.project.title}</span>
                    )}
                    {task.dueDate && (
                      <>
                        <span>‚Ä¢</span>
                        <span className={new Date(task.dueDate) < new Date() && task.status !== 'COMPLETED' ? 'text-danger' : ''}>
                          {new Date(task.dueDate).toLocaleDateString('ru-RU', {
                            day: 'numeric',
                            month: 'short'
                          })}
                        </span>
                      </>
                    )}
                    {task.assignee && (
                      <>
                        <span>‚Ä¢</span>
                        <span className="truncate">{task.assignee.surname}</span>
                      </>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-3 shrink-0">
                  <Badge variant={STATUS_COLORS[task.status] || 'neutral'}>
                    {STATUS_LABELS[task.status] || task.status}
                  </Badge>
                  <ChevronRight size={18} className="text-slate-600" />
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Warehouse/BoxDetailPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import { ArrowLeft, Package, MapPin, Clock, QrCode, Plus, Minus, History, Edit } from 'lucide-react'
import { Card, Button, Badge, Loader, Modal, Input } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { InventoryBox, WarehouseMovement } from '../../types'

export const BoxDetailPage = () => {
  const { id } = useParams<{ id: string }>()
  const navigate = useNavigate()

  const [box, setBox] = useState<InventoryBox | null>(null)
  const [movements, setMovements] = useState<WarehouseMovement[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const [showMovementModal, setShowMovementModal] = useState(false)
  const [movementType, setMovementType] = useState<'IN' | 'OUT'>('OUT')
  const [movementQty, setMovementQty] = useState('')
  const [movementReason, setMovementReason] = useState('')
  const [submitting, setSubmitting] = useState(false)

  useEffect(() => {
    if (id) loadBox()
  }, [id])

  const loadBox = async () => {
    try {
      setLoading(true)
      const [boxRes, movementsRes] = await Promise.all([
        api.get(`/warehouse/boxes/${id}`),
        api.get(`/warehouse/boxes/${id}/movements`, { params: { limit: 10 } }),
      ])
      setBox(boxRes.data)
      setMovements(movementsRes.data?.rows || movementsRes.data || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const handleMovement = async () => {
    if (!movementQty || !box) return
    try {
      setSubmitting(true)
      await api.post(`/warehouse/boxes/${id}/movements`, {
        type: movementType,
        quantity: parseInt(movementQty),
        reason: movementReason || undefined,
      })
      setShowMovementModal(false)
      setMovementQty('')
      setMovementReason('')
      loadBox()
    } catch (err) {
      alert(getErrorMessage(err))
    } finally {
      setSubmitting(false)
    }
  }

  const openMovementModal = (type: 'IN' | 'OUT') => {
    setMovementType(type)
    setShowMovementModal(true)
  }

  if (loading) return <div className="flex justify-center py-12"><Loader text="–ó–∞–≥—Ä—É–∑–∫–∞..." /></div>

  if (error || !box) {
    return (
      <div className="text-center py-12">
        <p className="text-danger mb-4">{error || '–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}</p>
        <Button variant="outline" onClick={() => navigate('/warehouse')}>–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</Button>
      </div>
    )
  }

  return (
    <div className="space-y-4 animate-fadeIn">
      <div className="flex items-center gap-4">
        <Button variant="ghost" icon={<ArrowLeft size={20} />} onClick={() => navigate('/warehouse')} />
        <div className="flex-1 min-w-0">
          <h1 className="text-xl font-bold truncate">{box.label}</h1>
          <p className="text-slate-400 text-sm truncate">{box.qrCode}</p>
        </div>
        <Button variant="ghost" icon={<Edit size={18} />}><span className="hidden sm:inline">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span></Button>
      </div>

      <Card className="p-5">
        <div className="flex items-center gap-4 mb-6">
          <div className="w-16 h-16 rounded-2xl bg-primary/20 flex items-center justify-center">
            <Package size={32} className="text-primary" />
          </div>
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-1">
              <span className="text-3xl font-bold">{box.quantity}</span>
              <span className="text-slate-400">{box.unit}</span>
            </div>
            <Badge variant={STATUS_COLORS[box.status] || 'neutral'}>{STATUS_LABELS[box.status] || box.status}</Badge>
          </div>
        </div>
        <div className="flex gap-3">
          <Button variant="outline" className="flex-1" icon={<Minus size={18} />} onClick={() => openMovementModal('OUT')}>–°–ø–∏—Å–∞—Ç—å</Button>
          <Button className="flex-1" icon={<Plus size={18} />} onClick={() => openMovementModal('IN')}>–î–æ–±–∞–≤–∏—Ç—å</Button>
        </div>
      </Card>

      <Card className="p-5">
        <h2 className="font-semibold mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <div className="space-y-4">
          <div className="flex items-center gap-3">
            <QrCode size={18} className="text-slate-500 shrink-0" />
            <div className="min-w-0"><p className="text-sm text-slate-400">QR-–∫–æ–¥</p><p className="font-medium truncate">{box.qrCode}</p></div>
          </div>
          {box.partNumber && (
            <div className="flex items-center gap-3">
              <Package size={18} className="text-slate-500 shrink-0" />
              <div className="min-w-0"><p className="text-sm text-slate-400">–ê—Ä—Ç–∏–∫—É–ª</p><p className="font-medium truncate">{box.partNumber}</p></div>
            </div>
          )}
          {box.section && (
            <div className="flex items-center gap-3">
              <MapPin size={18} className="text-slate-500 shrink-0" />
              <div className="min-w-0"><p className="text-sm text-slate-400">–°–µ–∫—Ü–∏—è</p><p className="font-medium truncate">{box.section.title}</p></div>
            </div>
          )}
          <div className="flex items-center gap-3">
            <Clock size={18} className="text-slate-500 shrink-0" />
            <div className="min-w-0">
              <p className="text-sm text-slate-400">–û–±–Ω–æ–≤–ª–µ–Ω–æ</p>
              <p className="font-medium">{new Date(box.updatedAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' })}</p>
            </div>
          </div>
        </div>
      </Card>

      <Card className="p-5">
        <h2 className="font-semibold mb-4 flex items-center gap-2"><History size={18} className="text-slate-500" />–ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏–π</h2>
        {movements.length > 0 ? (
          <div className="space-y-3">
            {movements.map((m) => (
              <div key={m.id} className="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-0">
                <div className="flex items-center gap-3">
                  <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${m.type === 'IN' ? 'bg-success/20' : 'bg-danger/20'}`}>
                    {m.type === 'IN' ? <Plus size={16} className="text-success" /> : <Minus size={16} className="text-danger" />}
                  </div>
                  <div>
                    <p className="font-medium">{m.type === 'IN' ? '+' : '-'}{m.quantity} {box.unit}</p>
                    <p className="text-xs text-slate-500">{m.user?.surname} {m.user?.name}</p>
                  </div>
                </div>
                <p className="text-xs text-slate-500">{new Date(m.createdAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</p>
              </div>
            ))}
          </div>
        ) : (
          <p className="text-slate-500 text-center py-4">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
        )}
      </Card>

      <Modal isOpen={showMovementModal} onClose={() => setShowMovementModal(false)} title={movementType === 'IN' ? '–ü—Ä–∏—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'} size="sm">
        <div className="space-y-4">
          <Input label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" type="number" value={movementQty} onChange={(e) => setMovementQty(e.target.value)} placeholder={`–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (${box.unit})`} min="1" autoFocus />
          <Input label="–ü—Ä–∏—á–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value={movementReason} onChange={(e) => setMovementReason(e.target.value)} placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É" />
          <div className="flex gap-3 pt-2">
            <Button variant="ghost" className="flex-1" onClick={() => setShowMovementModal(false)}>–û—Ç–º–µ–Ω–∞</Button>
            <Button variant={movementType === 'IN' ? 'success' : 'danger'} className="flex-1" onClick={handleMovement} loading={submitting} disabled={!movementQty || parseInt(movementQty) <= 0}>{movementType === 'IN' ? '–î–æ–±–∞–≤–∏—Ç—å' : '–°–ø–∏—Å–∞—Ç—å'}</Button>
          </div>
        </div>
      </Modal>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Warehouse/WarehousePage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { Search, Package, Plus, Filter, AlertTriangle, RefreshCw } from 'lucide-react'
import { Card, Input, Button, Badge, EmptyState, Loader } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { useDebounce } from '../../hooks'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { InventoryBox } from '../../types'

export const WarehousePage = () => {
  const navigate = useNavigate()
  const [boxes, setBoxes] = useState<InventoryBox[]>([])
  const [loading, setLoading] = useState(true)
  const [refreshing, setRefreshing] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [search, setSearch] = useState('')

  const debouncedSearch = useDebounce(search, 300)

  useEffect(() => {
    loadBoxes()
  }, [debouncedSearch])

  const loadBoxes = async (isRefresh = false) => {
    try {
      if (isRefresh) setRefreshing(true)
      else setLoading(true)

      const params: Record<string, string | number> = { limit: 50 }
      if (debouncedSearch) params.search = debouncedSearch

      const { data } = await api.get('/warehouse/boxes', { params })
      setBoxes(Array.isArray(data) ? data : data.rows || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'))
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }

  const getStatusBadge = (status: string, quantity: number, minQuantity?: number) => {
    if (minQuantity && quantity <= minQuantity) {
      return <Badge variant="danger" dot>–ö—Ä–∏—Ç–∏—á–Ω–æ</Badge>
    }
    return <Badge variant={STATUS_COLORS[status] || 'neutral'}>{STATUS_LABELS[status] || status}</Badge>
  }

  return (
    <div className="space-y-4 animate-fadeIn">
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">–°–∫–ª–∞–¥</h1>
          <p className="text-slate-400 text-sm">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏</p>
        </div>
        <div className="flex gap-2">
          <Button variant="ghost" icon={<RefreshCw size={18} className={refreshing ? 'animate-spin' : ''} />} onClick={() => loadBoxes(true)} disabled={refreshing}>
            <span className="hidden sm:inline">–û–±–Ω–æ–≤–∏—Ç—å</span>
          </Button>
          <Button icon={<Plus size={18} />}><span className="hidden sm:inline">–ù–æ–≤–∞—è –∫–æ—Ä–æ–±–∫–∞</span></Button>
        </div>
      </div>

      <Card className="p-3">
        <div className="flex gap-3">
          <div className="flex-1">
            <Input placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é, QR –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª—É..." icon={<Search size={18} />} value={search} onChange={(e) => setSearch(e.target.value)} />
          </div>
          <Button variant="outline" icon={<Filter size={18} />}><span className="hidden sm:inline">–§–∏–ª—å—Ç—Ä—ã</span></Button>
        </div>
      </Card>

      {error && (
        <Card className="p-4 bg-danger/10 border-danger/20">
          <div className="flex items-center gap-3 text-danger">
            <AlertTriangle size={20} />
            <span>{error}</span>
            <Button variant="ghost" size="sm" onClick={() => loadBoxes()}>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</Button>
          </div>
        </Card>
      )}

      {loading ? (
        <div className="flex justify-center py-12"><Loader text="–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö..." /></div>
      ) : boxes.length === 0 ? (
        <EmptyState icon={<Package size={48} />} title="–ö–æ—Ä–æ–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" description={search ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å' : '–ù–∞ —Å–∫–ª–∞–¥–µ –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ—Ä–æ–±–æ–∫'} action={search ? <Button variant="outline" onClick={() => setSearch('')}>–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫</Button> : undefined} />
      ) : (
        <div className="grid gap-3">
          {boxes.map((box) => (
            <Card key={box.id} hover className="p-4" onClick={() => navigate(`/warehouse/${box.id}`)}>
              <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-4 min-w-0">
                  <div className="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center shrink-0">
                    <Package size={24} className="text-primary" />
                  </div>
                  <div className="min-w-0">
                    <p className="font-semibold truncate">{box.label}</p>
                    <div className="flex items-center gap-2 text-sm text-slate-400">
                      <span className="truncate">{box.qrCode}</span>
                      {box.partNumber && <><span>‚Ä¢</span><span className="truncate">{box.partNumber}</span></>}
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-4 shrink-0">
                  <div className="text-right hidden sm:block">
                    <p className="font-bold text-lg">{box.quantity}</p>
                    <p className="text-xs text-slate-500">{box.unit}</p>
                  </div>
                  {getStatusBadge(box.status, box.quantity, box.minQuantity)}
                </div>
              </div>
              <div className="flex items-center justify-between mt-3 pt-3 border-t border-slate-700/50 sm:hidden">
                <span className="text-slate-400">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span className="font-bold">{box.quantity} {box.unit}</span>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/types/index.ts
================================================================================



export interface User {
  id: number
  login: string
  name: string
  surname: string
  role: string
  abilities: string[]
  teamId?: number
  sectionId?: number
  team?: Team
  section?: Section
  img?: string | null
}

export interface Team {
  id: number
  title: string
  leaderId?: number
}

export interface Section {
  id: number
  title: string
}


export interface InventoryBox {
  id: number
  qrCode: string
  label: string
  partNumber?: string
  quantity: number
  unit: string
  status: string
  minQuantity?: number
  sectionId?: number
  section?: Section
  createdAt: string
  updatedAt: string
}

export interface WarehouseMovement {
  id: number
  boxId: number
  userId: number
  type: 'IN' | 'OUT' | 'TRANSFER' | 'ADJUSTMENT'
  quantity: number
  reason?: string
  createdAt: string
  user?: User
  box?: InventoryBox
}


export interface Product {
  id: number
  serialNumber: string
  productTypeId: number
  productType?: ProductType
  status: string
  currentStepId?: number
  currentStep?: ProductionStep
  assignedUserId?: number
  assignedUser?: User
  createdAt: string
  updatedAt: string
}

export interface ProductType {
  id: number
  code: string
  name: string
  description?: string
  steps?: ProductionStep[]
}

export interface ProductionStep {
  id: number
  productTypeId: number
  title: string
  description?: string
  order: number
  checklistItems?: ChecklistItem[]
}

export interface ChecklistItem {
  id: number
  stepId: number
  title: string
  type: 'checkbox' | 'text' | 'number' | 'select' | 'photo' | 'serial'
  required: boolean
  options?: string[]
  order: number
}

export interface ChecklistResponse {
  id: number
  productId: number
  stepId: number
  itemId: number
  value: string
  userId: number
  createdAt: string
}


export interface Task {
  id: number
  title: string
  description?: string
  status: string
  priority: number
  projectId?: number
  project?: Project
  assigneeId?: number
  assignee?: User
  creatorId: number
  creator?: User
  dueDate?: string
  completedAt?: string
  createdAt: string
  updatedAt: string
}

export interface Project {
  id: number
  title: string
  description?: string
  status: string
}


export interface UserRanking {
  userId: number
  user: User
  rank: number
  score: number
  operations: number
  trend: number
}

export interface TeamRanking {
  teamId: number
  team: Team
  rank: number
  score: number
  operations: number
  memberCount: number
}

export interface UserStats {
  totalOperations: number
  todayOperations: number
  weekOperations: number
  monthOperations: number
  avgPerDay: number
  rank: number
  totalUsers: number
}


export interface PaginatedResponse<T> {
  rows: T[]
  count: number
  page?: number
  limit?: number
}

export interface ApiError {
  message: string
  error?: string
  statusCode?: number
}


export interface ScanResult {
  product: Product
  currentStep?: ProductionStep
  nextStep?: ProductionStep
  canProceed: boolean
  message?: string
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/vite-env.d.ts
================================================================================




================================================================================
FILE: QMS-Mobile/mes-pwa/tailwind.config.js
================================================================================


export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          DEFAULT: '#3b82f6',
          dark: '#2563eb',
          light: '#60a5fa',
        },
        surface: {
          DEFAULT: '#1e293b',
          light: '#334155',
          hover: '#3f4f63',
        },
        background: '#0f172a',
        success: '#10b981',
        warning: '#f59e0b',
        danger: '#ef4444',
      },
      animation: {
        'fadeIn': 'fadeIn 0.2s ease-out',
        'slideUp': 'slideUp 0.3s ease-out',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideUp: {
          '0%': { opacity: '0', transform: 'translateY(10px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
      },
    },
  },
  plugins: [],
}

================================================================================
FILE: QMS-Mobile/mes-pwa/tsconfig.json
================================================================================

{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}

================================================================================
FILE: QMS-Mobile/mes-pwa/tsconfig.node.json
================================================================================

{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}

================================================================================
FILE: QMS-Mobile/mes-pwa/vite.config.ts
================================================================================

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: [
        'favicon.svg',
        'favicon.ico',
        'robots.txt',
        'icon-192.png',
        'icon-512.png',
        'apple-touch-icon.png'
      ],
      manifest: {
        name: 'MES Kryptonit',
        short_name: 'MES',
        description: '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º —Å–µ—Ä–≤–µ—Ä–æ–≤',
        theme_color: '#0f172a',
        background_color: '#0f172a',
        display: 'standalone',
        orientation: 'portrait',
        scope: '/',
        start_url: '/',
        lang: 'ru',
        categories: ['business', 'productivity'],
        icons: [
          {
            src: '/icon-192.png',
            sizes: '192x192',
            type: 'image/png',
            purpose: 'any'
          },
          {
            src: '/icon-512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable'
          }
        ],
        shortcuts: [
          {
            name: '–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å',
            short_name: '–°–∫–∞–Ω',
            url: '/production/scan',
            icons: [{ src: '/icon-192.png', sizes: '192x192' }]
          },
          {
            name: '–°–∫–ª–∞–¥',
            short_name: '–°–∫–ª–∞–¥',
            url: '/warehouse',
            icons: [{ src: '/icon-192.png', sizes: '192x192' }]
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https?:\/\/.*\/api\/.*/i,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 60 * 60
              },
              cacheableResponse: {
                statuses: [0, 200]
              },
              networkTimeoutSeconds: 10
            }
          },
          {
            urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp)$/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'images-cache',
              expiration: {
                maxEntries: 50,
                maxAgeSeconds: 60 * 60 * 24 * 30
              }
            }
          },
          {
            urlPattern: /\.(?:woff|woff2|ttf|eot)$/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'fonts-cache',
              expiration: {
                maxEntries: 10,
                maxAgeSeconds: 60 * 60 * 24 * 365
              }
            }
          }
        ],
        navigateFallbackDenylist: [/^\/realms/]
      },
      devOptions: {
        enabled: false
      }
    })
  ],
  server: {
    host: '0.0.0.0',
    port: 3000,
    strictPort: true,
    proxy: {
      '/api': {
        target: 'http://localhost:5001',
        changeOrigin: true,
        secure: false
      }
    },
    cors: true
  },
  preview: {
    host: '0.0.0.0',
    port: 3000,
    strictPort: true
  },
  build: {
    outDir: 'dist',
    sourcemap: false,
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true
      }
    },
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor-react': ['react', 'react-dom', 'react-router-dom'],
          'vendor-auth': ['oidc-client-ts', 'react-oidc-context'],
          'vendor-ui': ['lucide-react'],
          'vendor-http': ['axios']
        }
      }
    },
    chunkSizeWarningLimit: 500
  },
  resolve: {
    alias: {
      '@': '/src',
      '@components': '/src/components',
      '@pages': '/src/pages',
      '@api': '/src/api',
      '@hooks': '/src/hooks',
      '@config': '/src/config',
      '@types': '/src/types'
    }
  },
  define: {
    __APP_VERSION__: JSON.stringify('2.0.0')
  }
})
================================================================================
FILE: QMS-Server-master/config/config.js
================================================================================

require('dotenv').config();

module.exports = {
  development: {
    username: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || 'postgres',
    database: process.env.DB_NAME || 'mes_kryptonit',
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 5432,
    dialect: 'postgres',
    logging: console.log
  },
  production: {
    username: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    host: process.env.DB_HOST,
    port: process.env.DB_PORT || 5432,
    dialect: 'postgres',
    logging: false
  }
};

================================================================================
FILE: QMS-Server-master/controllers/ELRS2_4_Controller.js
================================================================================

const { ELRS2_4, Session } = require("../models/index");
const ApiError = require("../error/ApiError");
const { Op } = require("sequelize");

class ELRS2_4_Controller {
  async getBoards(req, res, next) {
    let {
      MAC_address,
      firmware,
      PCId,
      userId,
      categoryDefect24Id,
      date,
      limit,
      page,
    } = req.query;
    page = page || 1;
    limit = limit || 100;
    let offset = page * limit - limit;

    try {
      let sessionIds = null;

      if (PCId || userId) {
        const sessionPCIds = PCId
          ? await Session.findAll({
              attributes: ["id"],
              where: { PCId },
              raw: true,
            })
          : [];

        const sessionUserIds = userId
          ? await Session.findAll({
              attributes: ["id"],
              where: { userId },
              raw: true,
            })
          : [];

        const pcIdList = new Set(sessionPCIds.map((s) => s.id));
        const userIdList = new Set(sessionUserIds.map((s) => s.id));

        if (PCId && userId) {
          sessionIds = [...pcIdList].filter((id) => userIdList.has(id));
        } else if (PCId) {
          sessionIds = [...pcIdList];
        } else if (userId) {
          sessionIds = [...userIdList];
        }

        if (PCId && userId && sessionIds.length === 0) {
          return res.json({ count: 0, rows: [] });
        }
      }

      let whereClause = {};

      if (sessionIds && sessionIds.length > 0) {
        whereClause.sessionId = sessionIds;
      }

      if (categoryDefect24Id) {
        whereClause.categoryDefect24Id = categoryDefect24Id;
      }

      if (firmware) {
        whereClause.firmware = firmware;
      }
      if (MAC_address) {
        whereClause.MAC_address = MAC_address;
      }

      const convertToISODate = (dateStr) => {
        const [day, month, year] = dateStr.split(".");
        return `${year}-${month}-${day}`;
      };

      if (date) {

        date = convertToISODate(date);

        whereClause.createdAt = {
          [Op.between]: [
            new Date(`${date}T00:00:00.000Z`),
            new Date(`${date}T23:59:59.999Z`),
          ],
        };
      }

      const boardsAll = await ELRS2_4.findAndCountAll({
        where: whereClause,
        limit,
        offset,
        order: [["id", "ASC"]],
      });

      return res.json(boardsAll);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async postBoard(req, res, next) {
    try {
      const { MAC_address, firmware, sessionId, categoryDefect24Id } = req.body;

      const board = await ELRS2_4.create({
        MAC_address,
        firmware,
        sessionId,
        categoryDefect24Id,
      });
      return res.json(board);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async postManyDefect24(req, res, next) {
    try {
      const { count, sessionId, categoryDefect24Id } = req.body;
      const MAC_address = null;
      const firmware = false;

      const records = Array.from({ length: count }, () => ({
        MAC_address,
        firmware,
        sessionId,
        categoryDefect24Id,
      }));

      await ELRS2_4.bulkCreate(records);

      return res.json("–¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–ø–∏—Å–∏");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteManyDefect24(req, res, next) {
    try {
      const { count, categoryDefect24Id } = req.body;

      const recordsToDelete = await ELRS2_4.findAll({
        attributes: ["id"],
        where: { categoryDefect24Id },
        order: [["createdAt", "DESC"]],
        limit: count,
      });

      const idsToDelete = recordsToDelete.map((record) => record.id);

      await ELRS2_4.destroy({
        where: {
          id: {
            [Op.in]: idsToDelete,
          },
        },
      });

      return res.json("–∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updateBoard(req, res, next) {
    try {
      const { id, firmware, sessionId, categoryDefectId } = req.body;
      await ELRS2_4.update(
        { firmware, sessionId, categoryDefectId },
        { where: { id } }
      );
      const boardUpdated = await ELRS2_4.findAll({ where: { id } });
      return res.json(boardUpdated[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteBoardByDBid(req, res, next) {
    try {
      const id = req.params.id;
      await ELRS2_4.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new ELRS2_4_Controller();

================================================================================
FILE: QMS-Server-master/controllers/ELRS915_Controller.js
================================================================================

const { ELRS915, Session } = require("../models/index");
const ApiError = require("../error/ApiError");
const { Op } = require("sequelize");

class ELRS915_Controller {
  async getBoards(req, res, next) {
    let {
      MAC_address,
      firmware,
      PCId,
      userId,
      categoryDefect915Id,
      firmwareVersion,
      date,
      limit,
      page,
    } = req.query;
    page = page || 1;
    limit = limit || 100;
    let offset = page * limit - limit;

    try {
      let sessionIds = null;

      if (PCId || userId) {
        const sessionPCIds = PCId
          ? await Session.findAll({
              attributes: ["id"],
              where: { PCId },
              raw: true,
            })
          : [];


        const sessionUserIds = userId
          ? await Session.findAll({
              attributes: ["id"],
              where: { userId },
              raw: true,
            })
          : [];

        const pcIdList = new Set(sessionPCIds.map((s) => s.id));
        const userIdList = new Set(sessionUserIds.map((s) => s.id));

        if (PCId && userId) {
          sessionIds = [...pcIdList].filter((id) => userIdList.has(id));
        } else if (PCId) {
          sessionIds = [...pcIdList];
        } else if (userId) {
          sessionIds = [...userIdList];
        }

        if (PCId && userId && sessionIds.length === 0) {
          return res.json({ count: 0, rows: [] });
        }
      }

      let whereClause = {};

      if (sessionIds && sessionIds.length > 0) {
        whereClause.sessionId = sessionIds;
      }

      if (categoryDefect915Id) {
        whereClause.categoryDefect915Id = categoryDefect915Id;
      }
      if (firmwareVersion) {
        whereClause.firmwareVersion = firmwareVersion;
      }

      if (firmware) {
        whereClause.firmware = firmware;
      }
      if (MAC_address) {
        whereClause.MAC_address = MAC_address;
      }

      const convertToISODate = (dateStr) => {
        const [day, month, year] = dateStr.split(".");
        return `${year}-${month}-${day}`;
      };

      if (date) {

        date = convertToISODate(date);

        whereClause.createdAt = {
          [Op.between]: [
            new Date(`${date}T00:00:00.000Z`),
            new Date(`${date}T23:59:59.999Z`),
          ],
        };
      }

      const boardsAll = await ELRS915.findAndCountAll({
        where: whereClause,
        limit,
        offset,
        order: [["id", "ASC"]],
      });

      return res.json(boardsAll);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async postBoard(req, res, next) {
    try {
      const { MAC_address, firmware, sessionId, categoryDefect915Id, firmwareVersion } =
        req.body;

      const board = await ELRS915.create({
        MAC_address,
        firmware,
        sessionId,
        categoryDefect915Id,
        firmwareVersion
      });
      return res.json(board);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async postManyDefect915(req, res, next) {
    try {
      const { count, sessionId, categoryDefect915Id } = req.body;
      const MAC_address = null;
      const firmware = false;

      const records = Array.from({ length: count }, () => ({
        MAC_address,
        firmware,
        sessionId,
        categoryDefect915Id,
      }));

      await ELRS915.bulkCreate(records);

      return res.json("–¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–ø–∏—Å–∏");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteManyDefect915(req, res, next) {
    try {
      const { count, categoryDefect915Id } = req.body;

      const recordsToDelete = await ELRS915.findAll({
        attributes: ["id"],
        where: { categoryDefect915Id },
        order: [["createdAt", "DESC"]],
        limit: count,
      });

      const idsToDelete = recordsToDelete.map((record) => record.id);

      await ELRS915.destroy({
        where: {
          id: {
            [Op.in]: idsToDelete,
          },
        },
      });

      return res.json("–∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updateBoard(req, res, next) {
    try {
      const { id, firmware, sessionId, categoryDefectId } = req.body;
      await ELRS915.update(
        { firmware, sessionId, categoryDefectId },
        { where: { id } }
      );
      const boardUpdated = await ELRS915.findAll({ where: { id } });
      return res.json(boardUpdated[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteBoardByDBid(req, res, next) {
    try {
      const id = req.params.id;
      await ELRS915.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new ELRS915_Controller();

================================================================================
FILE: QMS-Server-master/controllers/ProjectController.js
================================================================================

const { Project, User } = require("../models/index");
const ApiError = require("../error/ApiError");

class ProjectController {
  async create(req, res, next) {
    try {
      const { title, description } = req.body;
      if (!title) return next(ApiError.badRequest("–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"));

      const project = await Project.create({
        title,
        description,
        createdById: req.user.id
      });
      return res.json(project);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }

  async getAll(req, res, next) {
    try {
      const projects = await Project.findAll({
        order: [["createdAt", "DESC"]],
        include: [{ model: User, as: "author", attributes: ["name", "surname"] }]
      });
      return res.json(projects);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }

  async delete(req, res, next) {
    try {
        await Project.destroy({ where: { id: req.params.id } });
        return res.json({ message: "Deleted" });
    } catch(e) { next(ApiError.internal(e.message)); }
  }
}

module.exports = new ProjectController();

================================================================================
FILE: QMS-Server-master/controllers/RankingsController.js
================================================================================



const { WarehouseMovement, User, Team, Section, Project } = require("../models/index");
const { ProductionOutput, OUTPUT_STATUSES } = require("../models/ProductionOutput");
const { Op } = require("sequelize");
const sequelize = require("../db");
const ApiError = require("../error/ApiError");


function calculateDateRange(period, customStartDate, customEndDate) {
    let startDate = new Date();
    let endDate = new Date();

    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(23, 59, 59, 999);

    switch (period) {
        case 'day':
            break;

        case 'week':
            const day = startDate.getDay() || 7;
            if (day !== 1) {
                startDate.setHours(-24 * (day - 1));
            }
            break;

        case 'month':
            startDate.setDate(1);
            break;

        case 'year':
            startDate.setMonth(0, 1);
            break;

        case 'all':
            startDate = new Date('2020-01-01');
            break;

        case 'custom':
            if (customStartDate) {
                startDate = new Date(customStartDate);
                startDate.setHours(0, 0, 0, 0);
            }
            if (customEndDate) {
                endDate = new Date(customEndDate);
                endDate.setHours(23, 59, 59, 999);
            }
            break;

        default:
            const defaultDay = startDate.getDay() || 7;
            if (defaultDay !== 1) {
                startDate.setHours(-24 * (defaultDay - 1));
            }
    }

    return { startDate, endDate };
}


function generateDateRange(startDate, endDate) {
    const dates = [];
    const current = new Date(startDate);
    current.setHours(0, 0, 0, 0);
    const end = new Date(endDate);
    end.setHours(0, 0, 0, 0);
    while (current <= end) {
        dates.push(current.toISOString().split('T')[0]);
        current.setDate(current.getDate() + 1);
    }
    return dates;
}


function getSparklineLimit(period, totalDays) {
    switch (period) {
        case 'day': return 1;
        case 'week': return 7;
        case 'month': return 31;
        case 'year': return Math.min(totalDays, 365);
        case 'all': return Math.min(totalDays, 365);
        case 'custom': return Math.min(totalDays, 90);
        default: return 14;
    }
}


async function getStats(req, res, next) {
    try {
        const {
            period = 'week',
            startDate: customStartDate,
            endDate: customEndDate,
            projectId
        } = req.query;

        const { startDate, endDate } = calculateDateRange(period, customStartDate, customEndDate);
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];
        const parsedProjectId = projectId ? Number(projectId) : null;


        const allDates = generateDateRange(startDate, endDate);
        const sparklineLimit = getSparklineLimit(period, allDates.length);

        console.log(`>>> [Rankings] –ø–µ—Ä–∏–æ–¥=${period}, –ø—Ä–æ–µ–∫—Ç=${parsedProjectId || '–≤—Å–µ'}, –¥–Ω–µ–π=${allDates.length}, —Å ${startDateStr} –ø–æ ${endDateStr}`);

        const warehouseDateCondition = period === 'all'
            ? { [Op.gte]: startDate }
            : { [Op.gte]: startDate, [Op.lte]: endDate };

        const productionDateCondition = period === 'all'
            ? { [Op.gte]: startDateStr }
            : { [Op.gte]: startDateStr, [Op.lte]: endDateStr };


        const productionProjectCondition = parsedProjectId
            ? { projectId: parsedProjectId }
            : {};


        let warehouseStats = [];
        let warehouseByDay = [];

        if (!parsedProjectId) {

            warehouseStats = await WarehouseMovement.findAll({
                attributes: [
                    "performedById",
                    [sequelize.fn("SUM", sequelize.col("goodQty")), "warehouseGood"],
                    [sequelize.fn("SUM", sequelize.col("scrapQty")), "warehouseScrap"],
                    [sequelize.fn("COUNT", sequelize.col("warehouse_movement.id")), "warehouseOps"],
                ],
                where: {
                    performedAt: warehouseDateCondition,
                    performedById: { [Op.ne]: null },
                    goodQty: { [Op.gt]: 0 }
                },
                include: [
                    {
                        model: User,
                        as: "performedBy",
                        attributes: ["id", "name", "surname", "img"],
                        include: [
                            {
                                model: Team,
                                attributes: ["id", "title"],
                                include: [
                                    {
                                        model: Section,
                                        as: "production_section",
                                        attributes: ["id", "title"]
                                    },
                                    {
                                        model: User,
                                        as: "teamLead",
                                        attributes: ["id", "name", "surname"]
                                    }
                                ]
                            }
                        ]
                    }
                ],
                group: [
                    "performedById",
                    "performedBy.id",
                    "performedBy.production_team.id",
                    "performedBy.production_team.production_section.id",
                    "performedBy.production_team.teamLead.id"
                ],
                raw: false
            });


            warehouseByDay = await WarehouseMovement.findAll({
                attributes: [
                    "performedById",
                    [sequelize.fn("DATE", sequelize.col("performedAt")), "date"],
                    [sequelize.fn("SUM", sequelize.col("goodQty")), "good"],
                ],
                where: {
                    performedAt: warehouseDateCondition,
                    performedById: { [Op.ne]: null },
                    goodQty: { [Op.gt]: 0 }
                },
                group: ["performedById", sequelize.fn("DATE", sequelize.col("performedAt"))],
                order: [[sequelize.fn("DATE", sequelize.col("performedAt")), "ASC"]],
                raw: true
            });
        }


        const productionStats = await ProductionOutput.findAll({
            attributes: [
                "userId",
                [sequelize.fn("SUM", sequelize.col("approvedQty")), "productionGood"],
                [sequelize.fn("COUNT", sequelize.col("id")), "productionOps"],
            ],
            where: {
                date: productionDateCondition,
                status: OUTPUT_STATUSES.APPROVED,
                ...productionProjectCondition
            },
            group: ["userId"],
            raw: true
        });


        const productionByDay = await ProductionOutput.findAll({
            attributes: [
                "userId",
                "date",
                [sequelize.fn("SUM", sequelize.col("approvedQty")), "good"],
            ],
            where: {
                date: productionDateCondition,
                status: OUTPUT_STATUSES.APPROVED,
                ...productionProjectCondition
            },
            group: ["userId", "date"],
            order: [["date", "ASC"]],
            raw: true
        });


        const userDailyMap = new Map();

        warehouseByDay.forEach(row => {
            const userId = row.performedById;
            const date = row.date;
            const good = Number(row.good) || 0;

            if (!userDailyMap.has(userId)) {
                userDailyMap.set(userId, new Map());
            }
            const dayMap = userDailyMap.get(userId);
            dayMap.set(date, (dayMap.get(date) || 0) + good);
        });

        productionByDay.forEach(row => {
            const userId = row.userId;
            const date = row.date;
            const good = Number(row.good) || 0;

            if (!userDailyMap.has(userId)) {
                userDailyMap.set(userId, new Map());
            }
            const dayMap = userDailyMap.get(userId);
            dayMap.set(date, (dayMap.get(date) || 0) + good);
        });


        function getSparklineData(userId) {
            const dayMap = userDailyMap.get(userId);
            if (!dayMap || dayMap.size === 0) return [];


            const sparkline = allDates.map(date => ({
                date,
                value: dayMap.get(date) || 0
            })).slice(-sparklineLimit);

            return sparkline;
        }


        function getDailyChange(userId) {
            const dayMap = userDailyMap.get(userId);
            if (!dayMap || dayMap.size < 2) return { change: 0, percent: 0, today: 0, yesterday: 0 };

            const entries = [...dayMap.entries()].sort((a, b) => a[0].localeCompare(b[0]));
            const today = entries[entries.length - 1]?.[1] || 0;
            const yesterday = entries[entries.length - 2]?.[1] || 0;

            const change = today - yesterday;
            const percent = yesterday > 0 ? Math.round((change / yesterday) * 100) : (today > 0 ? 100 : 0);

            return { change, percent, today, yesterday };
        }


        const productionMap = new Map();
        productionStats.forEach(p => {
            productionMap.set(p.userId, {
                productionGood: Number(p.productionGood) || 0,
                productionOps: Number(p.productionOps) || 0
            });
        });


        const allUserIds = new Set();

        warehouseStats.forEach(item => {
            const user = item.get({ plain: true }).performedBy;
            if (user) allUserIds.add(user.id);
        });

        productionStats.forEach(p => {
            allUserIds.add(p.userId);
        });


        const missingUserIds = [...allUserIds].filter(
            id => !warehouseStats.some(ws => ws.performedBy?.id === id)
        );

        let additionalUsers = [];
        if (missingUserIds.length > 0) {
            additionalUsers = await User.findAll({
                where: { id: missingUserIds },
                attributes: ["id", "name", "surname", "img"],
                include: [
                    {
                        model: Team,
                        attributes: ["id", "title"],
                        include: [
                            {
                                model: Section,
                                as: "production_section",
                                attributes: ["id", "title"]
                            },
                            {
                                model: User,
                                as: "teamLead",
                                attributes: ["id", "name", "surname"]
                            }
                        ]
                    }
                ]
            });
        }


        const usersMap = new Map();


        warehouseStats.forEach(item => {
            const plainItem = item.get({ plain: true });
            const user = plainItem.performedBy;
            if (!user) return;

            const warehouseGood = Number(plainItem.warehouseGood) || 0;
            const warehouseScrap = Number(plainItem.warehouseScrap) || 0;
            const productionData = productionMap.get(user.id) || { productionGood: 0, productionOps: 0 };

            const team = user.production_team || user.Team;
            const section = team ? (team.production_section || team.section) : null;
            const lead = team ? team.teamLead : null;

            usersMap.set(user.id, {
                id: user.id,
                name: user.name,
                surname: user.surname,
                avatar: user.img,
                teamName: team ? team.title : "–ë–µ–∑ –±—Ä–∏–≥–∞–¥—ã",
                teamId: team ? team.id : null,
                sectionName: section ? section.title : "–ù–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω",
                sectionId: section ? section.id : null,
                teamLeadName: lead ? `${lead.surname} ${lead.name[0]}.` : "‚Äî",

                warehouseOutput: warehouseGood,
                warehouseDefects: warehouseScrap,
                productionOutput: productionData.productionGood,

                output: warehouseGood + productionData.productionGood,
                defects: warehouseScrap,

                sparkline: getSparklineData(user.id),
                dailyChange: getDailyChange(user.id)
            });
        });


        additionalUsers.forEach(user => {
            if (usersMap.has(user.id)) return;

            const productionData = productionMap.get(user.id) || { productionGood: 0 };
            if (productionData.productionGood === 0) return;

            const team = user.production_team || user.Team;
            const section = team ? (team.production_section || team.section) : null;
            const lead = team ? team.teamLead : null;

            usersMap.set(user.id, {
                id: user.id,
                name: user.name,
                surname: user.surname,
                avatar: user.img,
                teamName: team ? team.title : "–ë–µ–∑ –±—Ä–∏–≥–∞–¥—ã",
                teamId: team ? team.id : null,
                sectionName: section ? section.title : "–ù–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω",
                sectionId: section ? section.id : null,
                teamLeadName: lead ? `${lead.surname} ${lead.name[0]}.` : "‚Äî",

                warehouseOutput: 0,
                warehouseDefects: 0,
                productionOutput: productionData.productionGood,

                output: productionData.productionGood,
                defects: 0,

                sparkline: getSparklineData(user.id),
                dailyChange: getDailyChange(user.id)
            });
        });


        const usersRank = [...usersMap.values()]
            .filter(u => u.output > 0)
            .sort((a, b) => b.output - a.output)
            .map((u, index) => {
                const total = u.output + u.defects;
                const efficiency = total > 0 ? ((u.output / total) * 100).toFixed(1) : 100;

                return {
                    ...u,
                    efficiency: Number(efficiency),
                    place: index + 1
                };
            });


        const teamsMap = {};

        usersRank.forEach(u => {
            if (!u.teamId) return;

            if (!teamsMap[u.teamId]) {
                teamsMap[u.teamId] = {
                    id: u.teamId,
                    title: u.teamName,
                    section: u.sectionName,
                    sectionId: u.sectionId,
                    teamLead: u.teamLeadName,
                    totalOutput: 0,
                    warehouseOutput: 0,
                    productionOutput: 0,
                    totalDefects: 0,
                    membersCount: 0,
                    efficiencies: [],
                    sparklineMap: new Map()
                };
            }

            const t = teamsMap[u.teamId];
            t.totalOutput += u.output;
            t.warehouseOutput += u.warehouseOutput;
            t.productionOutput += u.productionOutput;
            t.totalDefects += u.defects;
            t.membersCount += 1;
            t.efficiencies.push(u.efficiency);


            u.sparkline.forEach(point => {
                if (!t.sparklineMap.has(point.date)) {
                    t.sparklineMap.set(point.date, 0);
                }
                t.sparklineMap.set(point.date, t.sparklineMap.get(point.date) + point.value);
            });
        });

        function getPlanPerPerson(period) {
            switch (period) {
                case 'day': return 100;
                case 'week': return 500;
                case 'month': return 2000;
                case 'year': return 24000;
                case 'all': return 50000;
                case 'custom': return 1000;
                default: return 500;
            }
        }

        const teamsRank = Object.values(teamsMap).map((t) => {
            const avgEff = t.efficiencies.length > 0
                ? t.efficiencies.reduce((a, b) => a + b, 0) / t.efficiencies.length
                : 0;

            const PLAN_PER_PERSON = getPlanPerPerson(period);
            const totalPlan = t.membersCount * PLAN_PER_PERSON;
            const progress = totalPlan > 0 ? Math.min(100, Math.round((t.totalOutput / totalPlan) * 100)) : 0;


            const sparkline = allDates.map(date => ({
                date,
                value: t.sparklineMap.get(date) || 0
            })).slice(-sparklineLimit);

            return {
                id: t.id,
                title: t.title,
                section: t.section,
                sectionId: t.sectionId,
                teamLead: t.teamLead,
                totalOutput: t.totalOutput,
                warehouseOutput: t.warehouseOutput,
                productionOutput: t.productionOutput,
                avgEfficiency: Number(avgEff.toFixed(1)),
                membersCount: t.membersCount,
                progress: progress,
                sparkline
            };
        }).sort((a, b) => b.totalOutput - a.totalOutput);


        const sectionsMap = new Map();

        teamsRank.forEach(team => {
            if (!team.sectionId) return;

            if (!sectionsMap.has(team.sectionId)) {
                sectionsMap.set(team.sectionId, {
                    id: team.sectionId,
                    title: team.section || `–£—á–∞—Å—Ç–æ–∫ ${team.sectionId}`,
                    totalOutput: 0,
                    teamsCount: 0,
                    membersCount: 0,
                    sparklineMap: new Map()
                });
            }

            const section = sectionsMap.get(team.sectionId);
            section.totalOutput += team.totalOutput;
            section.teamsCount++;
            section.membersCount += team.membersCount;

            team.sparkline.forEach(point => {
                if (!section.sparklineMap.has(point.date)) {
                    section.sparklineMap.set(point.date, 0);
                }
                section.sparklineMap.set(point.date, section.sparklineMap.get(point.date) + point.value);
            });
        });

        const sectionsRank = Array.from(sectionsMap.values())
            .map(section => ({
                id: section.id,
                title: section.title,
                totalOutput: section.totalOutput,
                teamsCount: section.teamsCount,
                membersCount: section.membersCount,
                avgOutput: section.membersCount > 0 ? Math.round(section.totalOutput / section.membersCount) : 0,
                sparkline: allDates.map(date => ({
                    date,
                    value: section.sparklineMap.get(date) || 0
                })).slice(-sparklineLimit)
            }))
            .sort((a, b) => b.totalOutput - a.totalOutput);


        const totals = {
            totalOutput: usersRank.reduce((sum, u) => sum + u.output, 0),
            warehouseOutput: usersRank.reduce((sum, u) => sum + u.warehouseOutput, 0),
            productionOutput: usersRank.reduce((sum, u) => sum + u.productionOutput, 0),
            totalDefects: usersRank.reduce((sum, u) => sum + u.defects, 0),
            usersCount: usersRank.length,
            teamsCount: teamsRank.length,
            sectionsCount: sectionsRank.length
        };


        let projectName = null;
        if (parsedProjectId) {
            const project = await Project.findByPk(parsedProjectId, { attributes: ["title"] });
            projectName = project?.title || null;
        }

        return res.json({
            users: usersRank,
            teams: teamsRank,
            sections: sectionsRank,
            totals,
            period,
            projectId: parsedProjectId,
            projectName,
            startDate: startDate.toISOString(),
            endDate: endDate.toISOString()
        });

    } catch (e) {
        console.error("Rankings Error:", e);
        next(ApiError.badRequest("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Ä–µ–π—Ç–∏–Ω–≥–∞: " + e.message));
    }
}


async function getUserDetails(req, res, next) {
    try {
        const { userId } = req.params;
        const { period = 'week', startDate: customStartDate, endDate: customEndDate, projectId } = req.query;

        const { startDate, endDate } = calculateDateRange(period, customStartDate, customEndDate);
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];
        const parsedProjectId = projectId ? Number(projectId) : null;

        const user = await User.findByPk(userId, {
            attributes: ["id", "name", "surname", "img"],
            include: [
                {
                    model: Team,
                    attributes: ["id", "title"],
                    include: [
                        {
                            model: Section,
                            as: "production_section",
                            attributes: ["id", "title"]
                        }
                    ]
                }
            ]
        });

        if (!user) {
            return next(ApiError.notFound("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
        }

        const warehouseDateCondition = period === 'all'
            ? { [Op.gte]: startDate }
            : { [Op.gte]: startDate, [Op.lte]: endDate };

        const productionDateCondition = period === 'all'
            ? { [Op.gte]: startDateStr }
            : { [Op.gte]: startDateStr, [Op.lte]: endDateStr };

        const productionProjectCondition = parsedProjectId
            ? { projectId: parsedProjectId }
            : {};


        let warehouseByDay = [];
        if (!parsedProjectId) {
            warehouseByDay = await WarehouseMovement.findAll({
                attributes: [
                    [sequelize.fn("DATE", sequelize.col("performedAt")), "date"],
                    [sequelize.fn("SUM", sequelize.col("goodQty")), "good"],
                    [sequelize.fn("SUM", sequelize.col("scrapQty")), "scrap"],
                ],
                where: {
                    performedById: userId,
                    performedAt: warehouseDateCondition
                },
                group: [sequelize.fn("DATE", sequelize.col("performedAt"))],
                order: [[sequelize.fn("DATE", sequelize.col("performedAt")), "ASC"]],
                raw: true
            });
        }


        const productionByDay = await ProductionOutput.findAll({
            attributes: [
                "date",
                [sequelize.fn("SUM", sequelize.col("approvedQty")), "good"],
            ],
            where: {
                userId,
                date: productionDateCondition,
                status: OUTPUT_STATUSES.APPROVED,
                ...productionProjectCondition
            },
            group: ["date"],
            order: [["date", "ASC"]],
            raw: true
        });

        const productionByOperation = await ProductionOutput.findAll({
            attributes: [
                "operationTypeId",
                [sequelize.fn("SUM", sequelize.col("approvedQty")), "total"],
            ],
            where: {
                userId,
                date: productionDateCondition,
                status: OUTPUT_STATUSES.APPROVED,
                ...productionProjectCondition
            },
            include: [
                {
                    model: require("../models/ProductionOutput").OperationType,
                    as: "operationType",
                    attributes: ["name", "code"]
                }
            ],
            group: ["operationTypeId", "operationType.id"],
            raw: false
        });

        const daysMap = new Map();

        warehouseByDay.forEach(d => {
            const dateKey = d.date;
            if (!daysMap.has(dateKey)) {
                daysMap.set(dateKey, { date: dateKey, warehouse: 0, production: 0, total: 0 });
            }
            const day = daysMap.get(dateKey);
            day.warehouse = Number(d.good) || 0;
            day.total = day.warehouse + day.production;
        });

        productionByDay.forEach(d => {
            const dateKey = d.date;
            if (!daysMap.has(dateKey)) {
                daysMap.set(dateKey, { date: dateKey, warehouse: 0, production: 0, total: 0 });
            }
            const day = daysMap.get(dateKey);
            day.production = Number(d.good) || 0;
            day.total = day.warehouse + day.production;
        });

        const dailyStats = [...daysMap.values()].sort((a, b) => a.date.localeCompare(b.date));

        const totals = {
            warehouse: dailyStats.reduce((sum, d) => sum + d.warehouse, 0),
            production: dailyStats.reduce((sum, d) => sum + d.production, 0),
            total: dailyStats.reduce((sum, d) => sum + d.total, 0)
        };


        let projectName = null;
        if (parsedProjectId) {
            const project = await Project.findByPk(parsedProjectId, { attributes: ["title"] });
            projectName = project?.title || null;
        }

        return res.json({
            user: {
                id: user.id,
                name: user.name,
                surname: user.surname,
                avatar: user.img,
                team: user.production_team?.title || user.Team?.title || null,
                section: user.production_team?.production_section?.title || user.Team?.production_section?.title || null
            },
            period,
            projectId: parsedProjectId,
            projectName,
            startDate: startDate.toISOString(),
            endDate: endDate.toISOString(),
            dailyStats,
            byOperation: productionByOperation.map(op => ({
                operation: op.operationType?.name || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
                code: op.operationType?.code || "",
                total: Number(op.dataValues.total) || 0
            })),
            totals
        });

    } catch (e) {
        console.error("User Details Error:", e);
        next(ApiError.badRequest("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: " + e.message));
    }
}

module.exports = {
    getStats,
    getUserDetails
};

================================================================================
FILE: QMS-Server-master/controllers/TaskController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../error/ApiError");
const sequelize = require("../db");

const {
  ProductionTask,
  WarehouseBox,
  Section,
  Team,
  User,
  Project
} = require("../models/index");

class TaskController {

  async createTask(req, res, next) {
    try {
      const {
        title,
        originType,
        originId,
        targetQty,
        unit,
        dueDate,
        priority,
        comment,
        responsibleId,
        sectionId,
        projectId
      } = req.body;

      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏–∏"));
      }

      if (!title || !targetQty) {
        return next(ApiError.badRequest("–ù—É–∂–Ω—ã title –∏ targetQty"));
      }

      const task = await ProductionTask.create({
        title,
        originType: originType || null,
        originId: originId || null,
        targetQty,
        unit: unit || "—à—Ç",
        dueDate: dueDate || null,
        priority: priority || null,
        comment: comment || null,
        status: "NEW",
        createdById: req.user.id,
        responsibleId: responsibleId || null,
        sectionId: sectionId || null,
        projectId: projectId || null
      });

      return res.json(task);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getTasks(req, res, next) {
    try {
      let { page = 1, limit = 50, status, search, originType } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 50;
      const offset = (page - 1) * limit;

      const where = {};
      if (status) where.status = status;
      if (originType) where.originType = originType;
      if (search) {
        const s = String(search).trim();
        where[Op.or] = [
          { title: { [Op.iLike]: `%${s}%` } },
          { comment: { [Op.iLike]: `%${s}%` } },
        ];
      }

      const { rows, count } = await ProductionTask.findAndCountAll({
        where,
        limit,
        offset,
        order: [
          ["priority", "DESC"],
          ["dueDate", "ASC"],
          ["id", "ASC"],
        ],
        include: [
            {
                model: User,
                as: "responsible",
                attributes: ["id", "name", "surname"]
            },
            {
                model: Section,
                as: "targetSection",
                attributes: ["id", "title"]
            },
            {
                model: Project,
                as: "project",
                attributes: ["id", "title"]
            },
            {
                model: User,
                as: "createdBy",
                attributes: ["id", "name", "surname"]
            }
        ]
      });


      for (const task of rows) {
        let stats = {
          total: 0,
          done: 0,
          inWork: 0,
          onStock: 0
        };


        if (task.originType && task.originId) {
          const boxes = await WarehouseBox.findAll({
            attributes: ['status', 'quantity'],
            where: {
              originType: task.originType,
              originId: task.originId,
              status: { [Op.notIn]: ["SCRAP"] },
            },
          });

          for (const box of boxes) {
            const qty = Number(box.quantity) || 0;
            stats.total += qty;

            const st = box.status;
            if (st === 'DONE' || st === 'SHIPPED') {
              stats.done += qty;
            } else if (st === 'ON_STOCK') {
              stats.onStock += qty;
            } else {

              stats.inWork += qty;
            }
          }
        }

        const progressPercent = task.targetQty > 0
            ? Math.min(100, Math.round((stats.done / task.targetQty) * 100))
            : 0;


        task.setDataValue("stats", stats);
        task.setDataValue("progressPercent", progressPercent);
        task.setDataValue("totalFound", stats.total);
      }

      return res.json({ rows, count, page, limit });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getTaskById(req, res, next) {
    try {
      const { id } = req.params;
      const task = await ProductionTask.findByPk(id, {
        include: [
            { model: User, as: "responsible", attributes: ["id", "name", "surname"] },
            { model: Section, as: "targetSection", attributes: ["id", "title"] },
            { model: Project, as: "project", attributes: ["id", "title"] }
        ]
      });

      if (!task) {
        return next(ApiError.notFound("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      let boxes = [];
      let breakdown = [];
      let totalQty = 0;


      if (task.originType && task.originId) {
        boxes = await WarehouseBox.findAll({
          where: {
            originType: task.originType,
            originId: task.originId,
            status: { [Op.notIn]: ["SCRAP"] },
          },
          include: [
            {
              model: Section,
              as: "currentSection",
              attributes: ["id", "title"],
            },
            {
              model: Team,
              as: "currentTeam",
              attributes: ["id", "title"],
            },
          ],
          order: [["id", "ASC"]],
        });

        const map = {};

        for (const box of boxes) {
          const qty = box.quantity || 0;
          totalQty += qty;

          const key = `${box.status}|${box.currentSectionId || "null"}`;

          if (!map[key]) {
            map[key] = {
              status: box.status,
              sectionId: box.currentSectionId || null,
              sectionTitle: box.currentSection ? box.currentSection.title : null,
              qty: 0,
            };
          }
          map[key].qty += qty;
        }

        breakdown = Object.values(map);
      }

      return res.json({
        task,
        totalQty,
        breakdown,
        boxes,
      });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async updateFullTask(req, res, next) {
    try {
      const { id } = req.params;
      const {
        title, targetQty, unit, dueDate, priority, comment,
        responsibleId, sectionId, projectId, status
      } = req.body;

      const task = await ProductionTask.findByPk(id);
      if (!task) return next(ApiError.notFound("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));

      await task.update({
        title: title !== undefined ? title : task.title,
        targetQty: targetQty !== undefined ? targetQty : task.targetQty,
        unit: unit !== undefined ? unit : task.unit,
        dueDate: dueDate !== undefined ? dueDate : task.dueDate,
        priority: priority !== undefined ? priority : task.priority,
        comment: comment !== undefined ? comment : task.comment,
        responsibleId: responsibleId !== undefined ? (responsibleId || null) : task.responsibleId,
        sectionId: sectionId !== undefined ? (sectionId || null) : task.sectionId,
        projectId: projectId !== undefined ? (projectId || null) : task.projectId,
        status: status !== undefined ? status : task.status
      });

      return res.json(task);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }


  async updateTaskStatus(req, res, next) {
    try {
      const { id } = req.params;
      const { status } = req.body;

      const task = await ProductionTask.findByPk(id);
      if (!task) return next(ApiError.notFound("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));

      task.status = status;
      await task.save();

      return res.json(task);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }


  async deleteTask(req, res, next) {
    try {
        const { id } = req.params;
        const deleted = await ProductionTask.destroy({ where: { id } });
        if (!deleted) return next(ApiError.notFound("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
        return res.json({ message: "–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞" });
    } catch(e) {
        next(ApiError.internal(e.message));
    }
  }
}

module.exports = new TaskController();

================================================================================
FILE: QMS-Server-master/controllers/assemblyController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../error/ApiError");
const {
  AssemblyRoute,
  AssemblyRouteStep,
  Section,
  Team,
} = require("../models/index");

class AssemblyController {
  async getRoutes(req, res, next) {
    try {
      const { search, productName, isActive } = req.query;

      const where = {};
      if (productName) {
        where.productName = productName;
      }
      if (typeof isActive === "string") {
        where.isActive = isActive === "true";
      }
      if (search) {
        where[Op.or] = [
          { title: { [Op.iLike]: `%${search}%` } },
          { productName: { [Op.iLike]: `%${search}%` } },
        ];
      }

      const routes = await AssemblyRoute.findAll({
        where,
        include: [
          {
            model: AssemblyRouteStep,
            as: "steps",
            include: [
              { model: Section, as: "section", attributes: ["id", "title"] },
              { model: Team, as: "team", attributes: ["id", "title"] },
            ],
          },
        ],
        order: [
          ["title", "ASC"],
          [{ model: AssemblyRouteStep, as: "steps" }, "order", "ASC"],
        ],
      });

      return res.json(routes);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getRouteById(req, res, next) {
    try {
      const { id } = req.params;

      const route = await AssemblyRoute.findByPk(id, {
        include: [
          {
            model: AssemblyRouteStep,
            as: "steps",
            include: [
              { model: Section, as: "section", attributes: ["id", "title"] },
              { model: Team, as: "team", attributes: ["id", "title"] },
            ],
            order: [["order", "ASC"]],
          },
        ],
      });

      if (!route) {
        return next(ApiError.notFound("–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      return res.json(route);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async createRoute(req, res, next) {
    try {
      const { title, productName, description, isActive = true, steps = [] } =
        req.body;

      if (!title) {
        return next(ApiError.badRequest("–ù–µ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞"));
      }

      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"));
      }

      const route = await AssemblyRoute.create({
        title,
        productName: productName || null,
        description: description || null,
        isActive: Boolean(isActive),
        createdById: req.user.id,
      });

      if (Array.isArray(steps) && steps.length > 0) {
        const prepared = steps.map((s, index) => ({
          routeId: route.id,
          order: s.order ?? index + 1,
          title: s.title || `–®–∞–≥ ${index + 1}`,
          operation: s.operation || "MOVE",
          sectionId: s.sectionId || null,
          teamId: s.teamId || null,
          description: s.description || null,
        }));

        await AssemblyRouteStep.bulkCreate(prepared);
      }

      const fullRoute = await AssemblyRoute.findByPk(route.id, {
        include: [
          {
            model: AssemblyRouteStep,
            as: "steps",
            include: [
              { model: Section, as: "section", attributes: ["id", "title"] },
              { model: Team, as: "team", attributes: ["id", "title"] },
            ],
            order: [["order", "ASC"]],
          },
        ],
      });

      return res.json(fullRoute);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async updateRoute(req, res, next) {
    try {
      const { id } = req.params;
      const { title, productName, description, isActive = true, steps = [] } =
        req.body;

      const route = await AssemblyRoute.findByPk(id);
      if (!route) {
        return next(ApiError.notFound("–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await route.update({
        title: title || route.title,
        productName:
          productName !== undefined ? productName : route.productName,
        description:
          description !== undefined ? description : route.description,
        isActive:
          typeof isActive === "boolean" ? isActive : Boolean(route.isActive),
      });

      if (Array.isArray(steps)) {
        await AssemblyRouteStep.destroy({ where: { routeId: route.id } });

        const prepared = steps.map((s, index) => ({
          routeId: route.id,
          order: s.order ?? index + 1,
          title: s.title || `–®–∞–≥ ${index + 1}`,
          operation: s.operation || "MOVE",
          sectionId: s.sectionId || null,
          teamId: s.teamId || null,
          description: s.description || null,
        }));

        if (prepared.length > 0) {
          await AssemblyRouteStep.bulkCreate(prepared);
        }
      }

      const fullRoute = await AssemblyRoute.findByPk(route.id, {
        include: [
          {
            model: AssemblyRouteStep,
            as: "steps",
            include: [
              { model: Section, as: "section", attributes: ["id", "title"] },
              { model: Team, as: "team", attributes: ["id", "title"] },
            ],
            order: [["order", "ASC"]],
          },
        ],
      });

      return res.json(fullRoute);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async deleteRoute(req, res, next) {
    try {
      const { id } = req.params;

      const route = await AssemblyRoute.findByPk(id);
      if (!route) {
        return next(ApiError.notFound("–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await AssemblyRouteStep.destroy({ where: { routeId: route.id } });
      await route.destroy();

      return res.json({ message: "–ú–∞—Ä—à—Ä—É—Ç —É–¥–∞–ª—ë–Ω" });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new AssemblyController();

================================================================================
FILE: QMS-Server-master/controllers/assemblyRecipeController.js
================================================================================

const {
    AssemblyRecipe, RecipeStep, AssemblyProcess,
    WarehouseBox, Project, User, Team, Section, WarehouseMovement
} = require("../models/index");
const { Op } = require("sequelize");
const sequelize = require("../db");
const ApiError = require("../error/ApiError");

class AssemblyRecipeController {


    async createOrUpdate(req, res, next) {
        const t = await sequelize.transaction();
        try {
            const { projectId, title, steps } = req.body;

            if (!projectId) {
                await t.rollback();
                return next(ApiError.badRequest("–ù–µ —É–∫–∞–∑–∞–Ω ID –ø—Ä–æ–µ–∫—Ç–∞"));
            }


            let recipe = await AssemblyRecipe.findOne({ where: { projectId }, transaction: t });

            if (recipe) {

                await recipe.update({ title }, { transaction: t });

                await RecipeStep.destroy({ where: { recipeId: recipe.id }, transaction: t });
            } else {

                recipe = await AssemblyRecipe.create({ projectId, title }, { transaction: t });
            }


            if (steps && steps.length > 0) {
                const stepData = steps.map((s, index) => ({
                    recipeId: recipe.id,
                    order: index + 1,
                    title: s.title || "–®–∞–≥ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
                    quantity: s.quantity || 1,
                    description: s.description || null
                }));
                await RecipeStep.bulkCreate(stepData, { transaction: t });
            }

            await t.commit();
            return res.json(recipe);

        } catch (e) {
            await t.rollback();
            console.error(e);
            next(ApiError.badRequest(e.message));
        }
    }


    async getByProject(req, res, next) {
        try {
            const { projectId } = req.params;
            const recipe = await AssemblyRecipe.findOne({
                where: { projectId },
                include: [{ model: RecipeStep, as: "steps" }],
                order: [[{ model: RecipeStep, as: "steps" }, 'order', 'ASC']]
            });

            return res.json(recipe);
        } catch (e) {
            next(ApiError.badRequest(e.message));
        }
    }


    async startAssembly(req, res, next) {
        const t = await sequelize.transaction();
        try {
            const { qrCode, projectId } = req.body;

            if (!qrCode || !projectId) {
                await t.rollback();
                return next(ApiError.badRequest("–ù–µ —É–∫–∞–∑–∞–Ω QR-–∫–æ–¥ –∏–ª–∏ –ü—Ä–æ–µ–∫—Ç"));
            }


            const recipe = await AssemblyRecipe.findOne({
                where: { projectId },
                include: [{ model: RecipeStep, as: "steps" }],
                transaction: t
            });

            if (!recipe) {
                await t.rollback();
                return next(ApiError.notFound("–î–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω —Ä–µ—Ü–µ–ø—Ç —Å–±–æ—Ä–∫–∏"));
            }


            let box = await WarehouseBox.findOne({ where: { qrCode }, transaction: t });


            if (!box) {
                const project = await Project.findByPk(projectId, { transaction: t });
                const projectTitle = project ? project.title : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç";

                box = await WarehouseBox.create({
                    qrCode: qrCode,
                    label: projectTitle,
                    originType: "PRODUCT",
                    projectName: projectTitle,
                    quantity: 1,
                    unit: "—à—Ç",
                    status: "ASSEMBLY",
                    acceptedById: req.user.id,
                    acceptedAt: new Date()
                }, { transaction: t });

                console.log(`[Assembly] –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ –∏–∑–¥–µ–ª–∏–µ: ${qrCode} (User: ${req.user.id})`);
            } else {

                if (box.status !== 'ASSEMBLY' && box.status !== 'DONE') {
                    await box.update({ status: 'ASSEMBLY' }, { transaction: t });
                }
            }


            let process = await AssemblyProcess.findOne({
                where: {
                    boxId: box.id,
                    recipeId: recipe.id,
                    status: "IN_PROGRESS"
                },
                transaction: t
            });


            if (!process) {
                process = await AssemblyProcess.create({
                    boxId: box.id,
                    recipeId: recipe.id,
                    completedSteps: [],
                    status: "IN_PROGRESS",
                    startTime: new Date()
                }, { transaction: t });
            }

            await t.commit();


            return res.json({ process, recipe });

        } catch (e) {
            await t.rollback();
            console.error(e);
            next(ApiError.badRequest(e.message));
        }
    }


    async updateProcessStep(req, res, next) {
        try {
            const { id } = req.params;
            const { stepIndex, isDone } = req.body;

            const process = await AssemblyProcess.findByPk(id);
            if (!process) return next(ApiError.notFound("–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"));

            let steps = [...(process.completedSteps || [])];

            if (isDone) {

                if (!steps.includes(stepIndex)) steps.push(stepIndex);
            } else {

                steps = steps.filter(i => i !== stepIndex);
            }


            await process.update({ completedSteps: steps });

            return res.json(process);
        } catch (e) {
            next(ApiError.badRequest(e.message));
        }
    }


    async finishAssembly(req, res, next) {
        const t = await sequelize.transaction();
        try {
            const { id } = req.params;

            const process = await AssemblyProcess.findByPk(id, { transaction: t });
            if (!process) {
                await t.rollback();
                return next(ApiError.notFound("–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
            }


            await process.update({
                status: "COMPLETED",
                endTime: new Date()
            }, { transaction: t });


            const box = await WarehouseBox.findByPk(process.boxId, { transaction: t });
            await box.update({ status: "ON_STOCK" }, { transaction: t });


            await WarehouseMovement.create({
                boxId: box.id,
                operation: "ASSEMBLY_FINISH",
                deltaQty: 0,
                goodQty: 1,
                scrapQty: 0,
                performedById: req.user.id,
                performedAt: new Date(),
                comment: `–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ —Ä–µ—Ü–µ–ø—Ç—É #${process.recipeId}`
            }, { transaction: t });

            await t.commit();
            return res.json({ message: "–°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞" });
        } catch (e) {
            await t.rollback();
            next(ApiError.badRequest(e.message));
        }
    }


    async getAssembledList(req, res, next) {
        try {
            const { projectId, search } = req.query;

            const where = { status: "COMPLETED" };

            const processes = await AssemblyProcess.findAll({
                where,
                include: [
                    {
                        model: WarehouseBox,
                        as: "box",
                        where: search ? { qrCode: { [Op.iLike]: `%${search}%` } } : undefined
                    },
                    {
                        model: AssemblyRecipe,
                        as: "recipe",
                        where: projectId ? { projectId } : undefined,
                        include: [
                            { model: Project, as: "project", attributes: ["title"] },
                            { model: RecipeStep, as: "steps", attributes: ["id"] }
                        ]
                    }
                ],
                order: [["endTime", "DESC"]],
                limit: 200
            });


            const result = await Promise.all(processes.map(async (p) => {
                const user = await User.findByPk(p.box.acceptedById, { attributes: ['name', 'surname'] });


                const totalSteps = p.recipe.steps.length;
                const completedCount = p.completedSteps ? p.completedSteps.length : 0;
                const hasDefects = completedCount < totalSteps;

                return {
                    id: p.id,
                    boxId: p.box.id,
                    qrCode: p.box.qrCode,
                    projectTitle: p.recipe.project.title,
                    startTime: p.startTime,
                    endTime: p.endTime,
                    assembler: user ? `${user.surname} ${user.name}` : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
                    hasDefects,
                    progress: `${completedCount} / ${totalSteps}`
                };
            }));

            return res.json(result);
        } catch (e) {
            next(ApiError.badRequest(e.message));
        }
    }


    async getAssemblyPassport(req, res, next) {
        try {
            const { processId } = req.params;

            const process = await AssemblyProcess.findByPk(processId, {
                include: [
                    {
                        model: AssemblyRecipe,
                        as: "recipe",
                        include: [
                            { model: RecipeStep, as: "steps" },
                            { model: Project, as: "project" }
                        ]
                    },
                    { model: WarehouseBox, as: "box" }
                ]
            });

            if (!process) return next(ApiError.notFound("–°–±–æ—Ä–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));


            const user = await User.findByPk(process.box.acceptedById, {
                include: [{
                    model: Team,
                    include: [{ model: Section }]
                }]
            });

            let structureInfo = "–í–Ω–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã";
            if (user && user.team) {
                structureInfo = `${user.team.section ? user.team.section.title : "–ù–µ—Ç —É—á–∞—Å—Ç–∫–∞"} / ${user.team.title}`;
            }

            return res.json({
                process,
                steps: process.recipe.steps.sort((a, b) => a.order - b.order),
                user: user ? {
                    name: user.name,
                    surname: user.surname,
                    login: user.login,
                    structure: structureInfo
                } : null
            });
        } catch (e) {
            next(ApiError.badRequest(e.message));
        }
    }


    async updatePassport(req, res, next) {
        try {
            const { id } = req.params;
            const { completedSteps } = req.body;

            const process = await AssemblyProcess.findByPk(id);
            if (!process) return next(ApiError.notFound("–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"));

            await process.update({ completedSteps });

            return res.json({ message: "–ü–∞—Å–ø–æ—Ä—Ç –æ–±–Ω–æ–≤–ª–µ–Ω" });
        } catch (e) {
            next(ApiError.badRequest(e.message));
        }
    }
}

module.exports = new AssemblyRecipeController();

================================================================================
FILE: QMS-Server-master/controllers/auditController.js
================================================================================

const { AuditLog, User } = require("../models/index");
const ApiError = require("../error/ApiError");
const { Op } = require("sequelize");

class AuditController {
  async getLogs(req, res, next) {
    try {
      let { page, limit, action, entity, userId, dateFrom, dateTo } = req.query;

      page = Number(page) || 1;
      limit = Number(limit) || 50;
      const offset = page * limit - limit;

      const where = {};

      if (action) {
        where.action = { [Op.like]: `%${action}%` };
      }

      if (entity) {
        where.entity = entity;
      }

      if (userId) {
        const parsedUserId = Number(userId);
        if (!Number.isNaN(parsedUserId)) {
          where.userId = parsedUserId;
        }
      }

      if (dateFrom || dateTo) {
        where.createdAt = {};
        if (dateFrom) where.createdAt[Op.gte] = new Date(dateFrom);
        if (dateTo) {
          const to = new Date(dateTo);
          to.setDate(to.getDate() + 1);
          where.createdAt[Op.lt] = to;
        }
      }

      const logs = await AuditLog.findAndCountAll({
        where,
        include: [
          {
            model: User,
            as: "User",
            attributes: ["id", "login", "name", "surname"],
            required: false,
          },
        ],
        order: [["createdAt", "DESC"]],
        limit,
        offset,
      });

      return res.json(logs);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new AuditController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/ApprovalController.js
================================================================================



const ApprovalService = require("./services/ApprovalService");
const { CHECKLIST_STAGES, APPROVAL_STATUSES } = require("../../models/BeryllServerApproval");

class ApprovalController {


  async submitForVerification(req, res) {
    try {
      const { serverId, stageCode } = req.body;
      const userId = req.user.id;

      if (!serverId) {
        return res.status(400).json({ message: "–£–∫–∞–∂–∏—Ç–µ ID —Å–µ—Ä–≤–µ—Ä–∞" });
      }

      const approval = await ApprovalService.submitForVerification(
        serverId,
        userId,
        stageCode || CHECKLIST_STAGES.ASSEMBLY
      );

      res.status(201).json(approval);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é:", error);
      res.status(400).json({ message: error.message });
    }
  }


  async approveServer(req, res) {
    try {
      const { id } = req.params;
      const { comment } = req.body;
      const reviewerId = req.user.id;

      const approval = await ApprovalService.approveServer(
        parseInt(id),
        reviewerId,
        comment
      );

      res.json(approval);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è:", error);
      res.status(400).json({ message: error.message });
    }
  }


  async rejectServer(req, res) {
    try {
      const { id } = req.params;
      const { comment } = req.body;
      const reviewerId = req.user.id;

      const approval = await ApprovalService.rejectServer(
        parseInt(id),
        reviewerId,
        comment
      );

      res.json(approval);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:", error);
      res.status(400).json({ message: error.message });
    }
  }


  async getVerificationQueue(req, res) {
    try {
      const { stageCode, page, limit, sortBy, sortOrder } = req.query;

      const result = await ApprovalService.getVerificationQueue({
        stageCode,
        page: parseInt(page) || 1,
        limit: parseInt(limit) || 20,
        sortBy: sortBy || "submittedAt",
        sortOrder: sortOrder || "ASC"
      });

      res.json(result);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏:", error);
      res.status(500).json({ message: error.message });
    }
  }


  async getApprovalById(req, res) {
    try {
      const { id } = req.params;
      const approval = await ApprovalService.getApprovalById(parseInt(id));

      if (!approval) {
        return res.status(404).json({ message: "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" });
      }

      res.json(approval);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–ø—Ä—É–≤–∞:", error);
      res.status(500).json({ message: error.message });
    }
  }


  async getVerificationDetails(req, res) {
    try {
      const { id } = req.params;
      const details = await ApprovalService.getVerificationDetails(parseInt(id));

      res.json(details);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π:", error);
      res.status(400).json({ message: error.message });
    }
  }


  async getServerVerificationStatus(req, res) {
    try {
      const { serverId } = req.params;
      const status = await ApprovalService.getServerVerificationStatus(parseInt(serverId));

      res.json(status);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:", error);
      res.status(500).json({ message: error.message });
    }
  }


  async getServerApprovalHistory(req, res) {
    try {
      const { serverId } = req.params;
      const history = await ApprovalService.getServerApprovalHistory(parseInt(serverId));

      res.json(history);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:", error);
      res.status(500).json({ message: error.message });
    }
  }


  async checkStageCompletion(req, res) {
    try {
      const { serverId, stageCode } = req.params;
      const result = await ApprovalService.checkStageCompletion(
        parseInt(serverId),
        stageCode
      );

      res.json(result);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç–∏:", error);
      res.status(500).json({ message: error.message });
    }
  }


  async getVerificationStats(req, res) {
    try {
      const stats = await ApprovalService.getVerificationStats();
      res.json(stats);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
      res.status(500).json({ message: error.message });
    }
  }


  async getConstants(req, res) {
    res.json({
      stages: CHECKLIST_STAGES,
      statuses: APPROVAL_STATUSES,
      stageLabels: {
        [CHECKLIST_STAGES.ASSEMBLY]: '–°–±–æ—Ä–∫–∞',
        [CHECKLIST_STAGES.VERIFICATION]: '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –û–¢–ö'
      },
      statusLabels: {
        [APPROVAL_STATUSES.PENDING]: '–û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏',
        [APPROVAL_STATUSES.APPROVED]: '–û–¥–æ–±—Ä–µ–Ω–æ',
        [APPROVAL_STATUSES.REJECTED]: '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
      }
    });
  }
}

module.exports = new ApprovalController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/CatalogExtendedController.js
================================================================================



const { Op } = require("sequelize");
const ApiError = require("../../error/ApiError");


function getCatalogModel() {
  const { ComponentCatalog } = require("../../models/index");
  return ComponentCatalog;
}


class CatalogExtendedController {


  async getCatalogGrouped(req, res, next) {
    try {
      const ComponentCatalog = getCatalogModel();
      const { includeInactive } = req.query;

      const where = {};
      if (includeInactive !== "true") {
        where.isActive = true;
      }

      const catalog = await ComponentCatalog.findAll({
        where,
        order: [
          ["type", "ASC"],
          ["manufacturer", "ASC"],
          ["model", "ASC"],
          ["revision", "ASC"]
        ]
      });


      const grouped = {};
      for (const entry of catalog) {
        const type = entry.type;
        if (!grouped[type]) {
          grouped[type] = [];
        }
        grouped[type].push(entry);
      }

      return res.json(grouped);
    } catch (error) {
      console.error("[CatalogExtended] getCatalogGrouped error:", error);
      return next(ApiError.internal(error.message));
    }
  }


  async getCatalogStats(req, res, next) {
    try {
      const ComponentCatalog = getCatalogModel();

      const allEntries = await ComponentCatalog.findAll({
        attributes: ["id", "type", "manufacturer", "model", "revision", "isActive"]
      });

      const stats = {
        total: allEntries.length,
        active: allEntries.filter(e => e.isActive).length,
        inactive: allEntries.filter(e => !e.isActive).length,
        byType: {},
        manufacturers: new Set(),
        models: new Set()
      };

      for (const entry of allEntries) {

        if (!stats.byType[entry.type]) {
          stats.byType[entry.type] = { total: 0, active: 0, inactive: 0 };
        }
        stats.byType[entry.type].total++;
        if (entry.isActive) {
          stats.byType[entry.type].active++;
        } else {
          stats.byType[entry.type].inactive++;
        }


        if (entry.manufacturer) stats.manufacturers.add(entry.manufacturer);
        if (entry.model) stats.models.add(entry.model);
      }

      return res.json({
        total: stats.total,
        active: stats.active,
        inactive: stats.inactive,
        typesCount: Object.keys(stats.byType).length,
        manufacturersCount: stats.manufacturers.size,
        modelsCount: stats.models.size,
        byType: stats.byType
      });
    } catch (error) {
      console.error("[CatalogExtended] getCatalogStats error:", error);
      return next(ApiError.internal(error.message));
    }
  }


  async getCatalogTypes(req, res, next) {
    try {
      const ComponentCatalog = getCatalogModel();
      const { sequelize } = require("../../models/index");

      const types = await ComponentCatalog.findAll({
        attributes: [
          "type",
          [sequelize.fn("COUNT", sequelize.col("id")), "count"]
        ],
        where: { isActive: true },
        group: ["type"],
        order: [["type", "ASC"]],
        raw: true
      });

      return res.json(types);
    } catch (error) {
      console.error("[CatalogExtended] getCatalogTypes error:", error);
      return next(ApiError.internal(error.message));
    }
  }


  async searchCatalog(req, res, next) {
    try {
      const ComponentCatalog = getCatalogModel();
      const { q, type, includeInactive } = req.query;

      if (!q && !type) {
        return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ–∏—Å–∫–∞: q (—Ç–µ–∫—Å—Ç) –∏–ª–∏ type"));
      }

      const where = {};


      if (includeInactive !== "true") {
        where.isActive = true;
      }


      if (type) {
        where.type = type;
      }


      if (q) {
        const searchTerm = `%${q}%`;
        where[Op.or] = [
          { manufacturer: { [Op.iLike]: searchTerm } },
          { model: { [Op.iLike]: searchTerm } },
          { revision: { [Op.iLike]: searchTerm } },
          { partNumber: { [Op.iLike]: searchTerm } },
          { notes: { [Op.iLike]: searchTerm } }
        ];
      }

      const results = await ComponentCatalog.findAll({
        where,
        order: [["type", "ASC"], ["manufacturer", "ASC"], ["model", "ASC"]],
        limit: 200
      });

      return res.json(results);
    } catch (error) {
      console.error("[CatalogExtended] searchCatalog error:", error);
      return next(ApiError.internal(error.message));
    }
  }


  async deleteCatalogEntry(req, res, next) {
    try {
      const ComponentCatalog = getCatalogModel();
      const { id } = req.params;

      const catalog = await ComponentCatalog.findByPk(id);
      if (!catalog) {
        return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      if (!catalog.isActive) {
        return res.json({
          success: true,
          message: "–ó–∞–ø–∏—Å—å —É–∂–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞",
          catalog
        });
      }


      try {
        const { ComponentInventory } = require("../../models/index");
        const usageCount = await ComponentInventory.count({
          where: {
            catalogId: id,
            status: { [Op.notIn]: ["SCRAPPED", "RETURNED"] }
          }
        });

        if (usageCount > 0) {

          console.warn(
            `[CatalogExtended] –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ #${id} ` +
            `(${catalog.manufacturer || ""} ${catalog.model}): ` +
            `–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ${usageCount} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è`
          );
        }
      } catch (inventoryError) {

        console.warn("[CatalogExtended] –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å:", inventoryError.message);
      }

      await catalog.update({ isActive: false });

      console.log(
        `[CatalogExtended] –ó–∞–ø–∏—Å—å #${id} –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞: ` +
        `${catalog.type} ${catalog.manufacturer || ""} ${catalog.model} rev.${catalog.revision || "-"}`
      );

      return res.json({
        success: true,
        message: `–ó–∞–ø–∏—Å—å "${catalog.manufacturer || ""} ${catalog.model}" –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞`,
        catalog
      });
    } catch (error) {
      console.error("[CatalogExtended] deleteCatalogEntry error:", error);
      return next(ApiError.internal(error.message));
    }
  }


  async restoreCatalogEntry(req, res, next) {
    try {
      const ComponentCatalog = getCatalogModel();
      const { id } = req.params;

      const catalog = await ComponentCatalog.findByPk(id);
      if (!catalog) {
        return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      if (catalog.isActive) {
        return res.json({
          success: true,
          message: "–ó–∞–ø–∏—Å—å —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞",
          catalog
        });
      }

      await catalog.update({ isActive: true });

      console.log(
        `[CatalogExtended] –ó–∞–ø–∏—Å—å #${id} –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ` +
        `${catalog.type} ${catalog.manufacturer || ""} ${catalog.model}`
      );

      return res.json({
        success: true,
        message: `–ó–∞–ø–∏—Å—å "${catalog.manufacturer || ""} ${catalog.model}" –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`,
        catalog
      });
    } catch (error) {
      console.error("[CatalogExtended] restoreCatalogEntry error:", error);
      return next(ApiError.internal(error.message));
    }
  }


  async batchCreateCatalog(req, res, next) {
    try {
      const ComponentCatalog = getCatalogModel();
      const { entries } = req.body;

      if (!Array.isArray(entries) || entries.length === 0) {
        return next(ApiError.badRequest("–ú–∞—Å—Å–∏–≤ entries –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º"));
      }

      if (entries.length > 100) {
        return next(ApiError.badRequest("–ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø–∏—Å–µ–π –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å"));
      }

      const results = {
        created: [],
        updated: [],
        errors: []
      };

      for (const entry of entries) {
        try {
          const { type, manufacturer, model, revision, partNumber, specifications, notes } = entry;

          if (!type || !model) {
            results.errors.push({
              entry,
              error: "–ü–æ–ª—è type –∏ model –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã"
            });
            continue;
          }


          const existing = await ComponentCatalog.findOne({
            where: {
              type,
              manufacturer: manufacturer || null,
              model
            }
          });

          if (existing) {

            const updateData = {};
            if (revision !== undefined && revision !== existing.revision) updateData.revision = revision;
            if (partNumber !== undefined && partNumber !== existing.partNumber) updateData.partNumber = partNumber;
            if (specifications) updateData.specifications = { ...existing.specifications, ...specifications };
            if (notes !== undefined) updateData.notes = notes;
            if (!existing.isActive) updateData.isActive = true;

            if (Object.keys(updateData).length > 0) {
              await existing.update(updateData);
              results.updated.push(existing.toJSON());
            }
          } else {

            const newEntry = await ComponentCatalog.create({
              type,
              manufacturer: manufacturer || null,
              model,
              revision: revision || null,
              partNumber: partNumber || null,
              specifications: specifications || {},
              notes: notes || null,
              isActive: true
            });
            results.created.push(newEntry.toJSON());
          }
        } catch (entryError) {
          results.errors.push({
            entry,
            error: entryError.message
          });
        }
      }

      console.log(
        `[CatalogExtended] batchCreate: ` +
        `${results.created.length} —Å–æ–∑–¥–∞–Ω–æ, ${results.updated.length} –æ–±–Ω–æ–≤–ª–µ–Ω–æ, ` +
        `${results.errors.length} –æ—à–∏–±–æ–∫`
      );

      return res.json({
        success: true,
        created: results.created.length,
        updated: results.updated.length,
        errors: results.errors.length,
        details: results
      });
    } catch (error) {
      console.error("[CatalogExtended] batchCreateCatalog error:", error);
      return next(ApiError.internal(error.message));
    }
  }


  async exportCatalog(req, res, next) {
    try {
      const ComponentCatalog = getCatalogModel();
      const { includeInactive, type } = req.query;

      const where = {};
      if (includeInactive !== "true") {
        where.isActive = true;
      }
      if (type) {
        where.type = type;
      }

      const catalog = await ComponentCatalog.findAll({
        where,
        order: [["type", "ASC"], ["manufacturer", "ASC"], ["model", "ASC"]],
        raw: true
      });

      const exportData = {
        exportedAt: new Date().toISOString(),
        count: catalog.length,
        entries: catalog.map(entry => ({
          type: entry.type,
          manufacturer: entry.manufacturer,
          model: entry.model,
          revision: entry.revision,
          partNumber: entry.partNumber,
          specifications: entry.specifications,
          notes: entry.notes,
          isActive: entry.isActive
        }))
      };


      const filename = `catalog_export_${new Date().toISOString().slice(0, 10)}.json`;
      res.setHeader("Content-Type", "application/json; charset=utf-8");
      res.setHeader("Content-Disposition", `attachment; filename="${filename}"`);

      return res.json(exportData);
    } catch (error) {
      console.error("[CatalogExtended] exportCatalog error:", error);
      return next(ApiError.internal(error.message));
    }
  }
}


module.exports = new CatalogExtendedController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/ComponentsExtendedController.js
================================================================================



const ApiError = require("../../error/ApiError");
const {
  BeryllServer,
  BeryllServerComponent,
  BeryllHistory,
  User
} = require("../../models/index");
const { Op } = require("sequelize");
const sequelize = require("../../db");


const COMPONENT_TYPES = ['CPU', 'RAM', 'HDD', 'SSD', 'NVME', 'NIC', 'MOTHERBOARD', 'PSU', 'GPU', 'RAID', 'BMC', 'OTHER'];
const COMPONENT_STATUSES = ['OK', 'WARNING', 'CRITICAL', 'UNKNOWN', 'REPLACED'];


function sanitizeNumericFields(data) {
  const integerFields = ['capacity', 'speed', 'healthPercent', 'temperature', 'catalogId', 'inventoryId', 'installedById'];

  const sanitized = { ...data };

  integerFields.forEach(field => {
    if (sanitized[field] === '' || sanitized[field] === undefined) {
      sanitized[field] = null;
    } else if (sanitized[field] !== null && typeof sanitized[field] === 'string') {

      const parsed = parseInt(sanitized[field], 10);
      sanitized[field] = isNaN(parsed) ? null : parsed;
    }
  });


  if (typeof sanitized.metadata === 'string') {
    try {
      sanitized.metadata = sanitized.metadata ? JSON.parse(sanitized.metadata) : {};
    } catch (e) {
      sanitized.metadata = {};
    }
  }
  if (sanitized.metadata === '' || sanitized.metadata === undefined) {
    sanitized.metadata = null;
  }

  return sanitized;
}


async function checkSerialConflict(serialNumber, serialNumberYadro, excludeComponentId = null) {
  if (!serialNumber && !serialNumberYadro) {
    return null;
  }

  const whereConditions = [];

  if (serialNumber) {
    whereConditions.push({
      [Op.or]: [
        { serialNumber },
        { serialNumberYadro: serialNumber }
      ]
    });
  }

  if (serialNumberYadro) {
    whereConditions.push({
      [Op.or]: [
        { serialNumber: serialNumberYadro },
        { serialNumberYadro }
      ]
    });
  }

  const where = {
    [Op.or]: whereConditions,
    status: { [Op.ne]: 'REPLACED' }
  };

  if (excludeComponentId) {
    where.id = { [Op.ne]: excludeComponentId };
  }

  const existing = await BeryllServerComponent.findOne({
    where,
    include: [{
      model: BeryllServer,
      as: 'server',
      attributes: ['id', 'ipAddress', 'apkSerialNumber']
    }]
  });

  return existing;
}


async function logHistory(serverId, userId, action, details, transaction = null) {
  try {
    await BeryllHistory.create({
      serverId,
      userId,
      action,
      comment: typeof details === 'string' ? details : JSON.stringify(details),
      metadata: typeof details === 'object' ? details : null
    }, { transaction });
  } catch (err) {
    console.error('[ComponentsExtended] History log error:', err.message);
  }
}


async function addComponent(req, res, next) {
  const transaction = await sequelize.transaction();

  try {
    const { id: serverId } = req.params;
    const userId = req.user?.id;


    const sanitizedBody = sanitizeNumericFields(req.body);

    const {
      componentType,
      name,
      manufacturer,
      model,
      serialNumber,
      serialNumberYadro,
      partNumber,
      slot,
      capacity,
      speed,
      status = 'OK',
      metadata,
      notes
    } = sanitizedBody;


    const server = await BeryllServer.findByPk(serverId, { transaction });
    if (!server) {
      await transaction.rollback();
      return next(ApiError.notFound('–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'));
    }


    if (!componentType || !COMPONENT_TYPES.includes(componentType)) {
      await transaction.rollback();
      return next(ApiError.badRequest(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–≥–æ. –î–æ–ø—É—Å—Ç–∏–º—ã–µ: ${COMPONENT_TYPES.join(', ')}`));
    }


    if (!serialNumber && !serialNumberYadro) {
      await transaction.rollback();
      return next(ApiError.badRequest('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä'));
    }


    const serialConflict = await checkSerialConflict(serialNumber, serialNumberYadro, null);
    if (serialConflict) {
      await transaction.rollback();
      const conflictServer = serialConflict.server;
      return next(ApiError.badRequest(
        `–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ "${serialConflict.name}" ` +
        `–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ${conflictServer?.ipAddress || conflictServer?.apkSerialNumber || serialConflict.serverId}`
      ));
    }


    const component = await BeryllServerComponent.create({
      serverId: parseInt(serverId),
      componentType,
      name: name || `${manufacturer || ''} ${model || componentType}`.trim(),
      manufacturer: manufacturer || null,
      model: model || null,
      serialNumber: serialNumber || null,
      serialNumberYadro: serialNumberYadro || null,
      partNumber: partNumber || null,
      slot: slot || null,
      capacity,
      speed,
      status,
      metadata: metadata || null,
      notes: notes || null,
      dataSource: 'MANUAL',
      installedById: userId
    }, { transaction });


    await logHistory(serverId, userId, 'COMPONENT_ADDED', {
      componentId: component.id,
      componentType,
      name: component.name,
      serialNumber,
      serialNumberYadro
    }, transaction);

    await transaction.commit();

    res.json({
      success: true,
      message: '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ',
      component
    });

  } catch (error) {
    await transaction.rollback();
    console.error('[ComponentsExtended] addComponent error:', error);
    next(ApiError.internal(error.message));
  }
}


async function addComponentsBatch(req, res, next) {
  const transaction = await sequelize.transaction();

  try {
    const { id: serverId } = req.params;
    const userId = req.user?.id;
    const { components } = req.body;

    if (!Array.isArray(components) || components.length === 0) {
      await transaction.rollback();
      return next(ApiError.badRequest('–ü–µ—Ä–µ–¥–∞–π—Ç–µ –º–∞—Å—Å–∏–≤ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö'));
    }

    const server = await BeryllServer.findByPk(serverId, { transaction });
    if (!server) {
      await transaction.rollback();
      return next(ApiError.notFound('–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'));
    }

    const created = [];
    const errors = [];

    for (let i = 0; i < components.length; i++) {

      const comp = sanitizeNumericFields(components[i]);

      try {

        const conflict = await checkSerialConflict(comp.serialNumber, comp.serialNumberYadro, null);
        if (conflict) {
          errors.push({
            index: i,
            error: `–°–µ—Ä–∏–π–Ω–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${comp.serialNumber || comp.serialNumberYadro}`
          });
          continue;
        }

        const component = await BeryllServerComponent.create({
          serverId: parseInt(serverId),
          componentType: comp.componentType,
          name: comp.name || `${comp.manufacturer || ''} ${comp.model || comp.componentType}`.trim(),
          manufacturer: comp.manufacturer || null,
          model: comp.model || null,
          serialNumber: comp.serialNumber || null,
          serialNumberYadro: comp.serialNumberYadro || null,
          partNumber: comp.partNumber || null,
          slot: comp.slot || null,
          capacity: comp.capacity,
          speed: comp.speed,
          status: comp.status || 'OK',
          metadata: comp.metadata || null,
          dataSource: 'MANUAL',
          installedById: userId
        }, { transaction });

        created.push(component);
      } catch (err) {
        errors.push({ index: i, error: err.message });
      }
    }

    if (created.length > 0) {
      await logHistory(serverId, userId, 'COMPONENTS_BATCH_ADDED', {
        count: created.length,
        componentIds: created.map(c => c.id)
      }, transaction);
    }

    await transaction.commit();

    res.json({
      success: true,
      message: `–î–æ–±–∞–≤–ª–µ–Ω–æ ${created.length} –∏–∑ ${components.length} –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö`,
      created,
      errors
    });

  } catch (error) {
    await transaction.rollback();
    console.error('[ComponentsExtended] addComponentsBatch error:', error);
    next(ApiError.internal(error.message));
  }
}


async function updateComponent(req, res, next) {
  const transaction = await sequelize.transaction();

  try {
    const { id: componentId } = req.params;
    const userId = req.user?.id;


    const sanitizedBody = sanitizeNumericFields(req.body);

    const {
      name,
      manufacturer,
      model,
      serialNumber,
      serialNumberYadro,
      partNumber,
      slot,
      capacity,
      speed,
      status,
      metadata,
      notes
    } = sanitizedBody;

    const component = await BeryllServerComponent.findByPk(componentId, {
      include: [{ model: BeryllServer, as: 'server' }],
      transaction
    });

    if (!component) {
      await transaction.rollback();
      return next(ApiError.notFound('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'));
    }


    const oldValues = {
      name: component.name,
      serialNumber: component.serialNumber,
      serialNumberYadro: component.serialNumberYadro,
      manufacturer: component.manufacturer,
      model: component.model,
      status: component.status,
      capacity: component.capacity,
      speed: component.speed
    };


    const newSerial = serialNumber !== undefined ? serialNumber : component.serialNumber;
    const newYadro = serialNumberYadro !== undefined ? serialNumberYadro : component.serialNumberYadro;

    if (newSerial !== component.serialNumber || newYadro !== component.serialNumberYadro) {
      const conflict = await checkSerialConflict(newSerial, newYadro, componentId);
      if (conflict) {
        await transaction.rollback();
        return next(ApiError.badRequest(
          `–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ "${conflict.name}"`
        ));
      }
    }


    if (name !== undefined) component.name = name || null;
    if (manufacturer !== undefined) component.manufacturer = manufacturer || null;
    if (model !== undefined) component.model = model || null;
    if (serialNumber !== undefined) component.serialNumber = serialNumber || null;
    if (serialNumberYadro !== undefined) component.serialNumberYadro = serialNumberYadro || null;
    if (partNumber !== undefined) component.partNumber = partNumber || null;
    if (slot !== undefined) component.slot = slot || null;
    if (capacity !== undefined) component.capacity = capacity;
    if (speed !== undefined) component.speed = speed;
    if (status !== undefined && COMPONENT_STATUSES.includes(status)) {
      component.status = status;
    }


    if (metadata !== undefined) {
      if (metadata === null) {
        component.metadata = null;
      } else {
        component.metadata = {
          ...(component.metadata || {}),
          ...metadata
        };
      }
    }
    if (notes !== undefined) component.notes = notes || null;

    await component.save({ transaction });


    const newValues = {
      name: component.name,
      serialNumber: component.serialNumber,
      serialNumberYadro: component.serialNumberYadro,
      manufacturer: component.manufacturer,
      model: component.model,
      status: component.status,
      capacity: component.capacity,
      speed: component.speed
    };

    await logHistory(component.serverId, userId, 'COMPONENT_UPDATED', {
      componentId: component.id,
      componentType: component.componentType,
      oldValues,
      newValues
    }, transaction);

    await transaction.commit();

    res.json({
      success: true,
      message: '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ',
      component
    });

  } catch (error) {
    await transaction.rollback();
    console.error('[ComponentsExtended] updateComponent error:', error);
    next(ApiError.internal(error.message));
  }
}


async function updateSerials(req, res, next) {
  const transaction = await sequelize.transaction();

  try {
    const { id: componentId } = req.params;
    const userId = req.user?.id;
    const { serialNumber, serialNumberYadro } = req.body;

    if (!serialNumber && !serialNumberYadro) {
      await transaction.rollback();
      return next(ApiError.badRequest('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä'));
    }

    const component = await BeryllServerComponent.findByPk(componentId, { transaction });
    if (!component) {
      await transaction.rollback();
      return next(ApiError.notFound('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'));
    }

    const oldSerials = {
      serialNumber: component.serialNumber,
      serialNumberYadro: component.serialNumberYadro
    };


    const serialToCheck = serialNumber !== undefined ? serialNumber : component.serialNumber;
    const yadroToCheck = serialNumberYadro !== undefined ? serialNumberYadro : component.serialNumberYadro;


    const conflict = await checkSerialConflict(serialToCheck, yadroToCheck, componentId);
    if (conflict) {
      await transaction.rollback();
      return next(ApiError.badRequest(
        `–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ "${conflict.name}"`
      ));
    }


    if (serialNumber !== undefined) component.serialNumber = serialNumber || null;
    if (serialNumberYadro !== undefined) component.serialNumberYadro = serialNumberYadro || null;

    await component.save({ transaction });

    await logHistory(component.serverId, userId, 'COMPONENT_SERIALS_UPDATED', {
      componentId: component.id,
      oldSerials,
      newSerials: {
        serialNumber: component.serialNumber,
        serialNumberYadro: component.serialNumberYadro
      }
    }, transaction);

    await transaction.commit();

    res.json({
      success: true,
      message: '–°–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã',
      component
    });

  } catch (error) {
    await transaction.rollback();
    console.error('[ComponentsExtended] updateSerials error:', error);
    next(ApiError.internal(error.message));
  }
}


async function replaceComponent(req, res, next) {
  const transaction = await sequelize.transaction();

  try {
    const { id: componentId } = req.params;
    const userId = req.user?.id;


    const sanitizedBody = sanitizeNumericFields(req.body);

    const {
      newSerialNumber,
      newSerialNumberYadro,
      newManufacturer,
      newModel,
      newPartNumber,
      reason
    } = sanitizedBody;


    const oldComponent = await BeryllServerComponent.findByPk(componentId, {
      include: [{ model: BeryllServer, as: 'server' }],
      transaction
    });

    if (!oldComponent) {
      await transaction.rollback();
      return next(ApiError.notFound('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'));
    }

    if (!newSerialNumber && !newSerialNumberYadro) {
      await transaction.rollback();
      return next(ApiError.badRequest('–£–∫–∞–∂–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–æ–≤–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–≥–æ'));
    }


    const conflict = await checkSerialConflict(newSerialNumber, newSerialNumberYadro, null);
    if (conflict) {
      await transaction.rollback();
      return next(ApiError.badRequest(
        `–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ "${conflict.name}"`
      ));
    }


    oldComponent.status = 'REPLACED';
    oldComponent.metadata = {
      ...oldComponent.metadata,
      replacedAt: new Date().toISOString(),
      replacedBy: userId,
      replacementReason: reason
    };
    await oldComponent.save({ transaction });


    const newComponent = await BeryllServerComponent.create({
      serverId: oldComponent.serverId,
      componentType: oldComponent.componentType,
      name: `${newManufacturer || oldComponent.manufacturer || ''} ${newModel || oldComponent.model || oldComponent.componentType}`.trim(),
      manufacturer: newManufacturer || oldComponent.manufacturer,
      model: newModel || oldComponent.model,
      serialNumber: newSerialNumber || null,
      serialNumberYadro: newSerialNumberYadro || null,
      partNumber: newPartNumber || oldComponent.partNumber,
      slot: oldComponent.slot,
      capacity: oldComponent.capacity,
      speed: oldComponent.speed,
      status: 'OK',
      dataSource: 'MANUAL',
      installedById: userId,
      metadata: {
        replacesComponentId: oldComponent.id,
        replacedAt: new Date().toISOString()
      }
    }, { transaction });


    await logHistory(oldComponent.serverId, userId, 'COMPONENT_REPLACED', {
      oldComponentId: oldComponent.id,
      newComponentId: newComponent.id,
      componentType: oldComponent.componentType,
      oldSerial: oldComponent.serialNumber || oldComponent.serialNumberYadro,
      newSerial: newSerialNumber || newSerialNumberYadro,
      reason
    }, transaction);

    await transaction.commit();

    res.json({
      success: true,
      message: '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –∑–∞–º–µ–Ω–µ–Ω–æ',
      oldComponent,
      newComponent
    });

  } catch (error) {
    await transaction.rollback();
    console.error('[ComponentsExtended] replaceComponent error:', error);
    next(ApiError.internal(error.message));
  }
}


async function deleteComponent(req, res, next) {
  const transaction = await sequelize.transaction();

  try {
    const { id: componentId } = req.params;
    const userId = req.user?.id;
    const { reason } = req.body || {};

    const component = await BeryllServerComponent.findByPk(componentId, { transaction });
    if (!component) {
      await transaction.rollback();
      return next(ApiError.notFound('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'));
    }

    const componentData = {
      id: component.id,
      componentType: component.componentType,
      name: component.name,
      serialNumber: component.serialNumber,
      serialNumberYadro: component.serialNumberYadro
    };

    await logHistory(component.serverId, userId, 'COMPONENT_DELETED', {
      ...componentData,
      reason
    }, transaction);

    await component.destroy({ transaction });

    await transaction.commit();

    res.json({
      success: true,
      message: '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ —É–¥–∞–ª–µ–Ω–æ',
      deleted: componentData
    });

  } catch (error) {
    await transaction.rollback();
    console.error('[ComponentsExtended] deleteComponent error:', error);
    next(ApiError.internal(error.message));
  }
}


async function searchComponent(req, res, next) {
  try {
    const { q, type, status, serverId, limit = 50 } = req.query;

    if (!q && !type && !status && !serverId) {
      return next(ApiError.badRequest('–£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞'));
    }

    const where = {};

    if (q) {
      where[Op.or] = [
        { serialNumber: { [Op.iLike]: `%${q}%` } },
        { serialNumberYadro: { [Op.iLike]: `%${q}%` } },
        { name: { [Op.iLike]: `%${q}%` } },
        { manufacturer: { [Op.iLike]: `%${q}%` } },
        { model: { [Op.iLike]: `%${q}%` } },
        { partNumber: { [Op.iLike]: `%${q}%` } }
      ];
    }

    if (type) where.componentType = type;
    if (status) where.status = status;
    if (serverId) where.serverId = parseInt(serverId);

    const components = await BeryllServerComponent.findAll({
      where,
      include: [{
        model: BeryllServer,
        as: 'server',
        attributes: ['id', 'ipAddress', 'apkSerialNumber', 'status']
      }],
      limit: parseInt(limit),
      order: [['updatedAt', 'DESC']]
    });

    res.json({
      success: true,
      count: components.length,
      components
    });

  } catch (error) {
    console.error('[ComponentsExtended] searchComponent error:', error);
    next(ApiError.internal(error.message));
  }
}


async function scanYadroSerial(req, res, next) {
  try {
    const { serial } = req.query;

    if (!serial) {
      return next(ApiError.badRequest('–£–∫–∞–∂–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä'));
    }


    let component = await BeryllServerComponent.findOne({
      where: {
        [Op.or]: [
          { serialNumberYadro: serial },
          { serialNumber: serial }
        ]
      },
      include: [{
        model: BeryllServer,
        as: 'server',
        attributes: ['id', 'ipAddress', 'apkSerialNumber', 'status']
      }]
    });


    if (!component) {
      component = await BeryllServerComponent.findOne({
        where: {
          [Op.or]: [
            { serialNumberYadro: { [Op.iLike]: `%${serial}%` } },
            { serialNumber: { [Op.iLike]: `%${serial}%` } }
          ]
        },
        include: [{
          model: BeryllServer,
          as: 'server',
          attributes: ['id', 'ipAddress', 'apkSerialNumber', 'status']
        }]
      });
    }

    if (!component) {
      return res.json({
        success: false,
        found: false,
        message: '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
      });
    }

    res.json({
      success: true,
      found: true,
      component
    });

  } catch (error) {
    console.error('[ComponentsExtended] scanYadroSerial error:', error);
    next(ApiError.internal(error.message));
  }
}


async function checkSerialUniqueness(req, res, next) {
  try {
    const { serialNumber, serialNumberYadro, excludeComponentId } = req.body;

    if (!serialNumber && !serialNumberYadro) {
      return res.json({ unique: true });
    }

    const conflict = await checkSerialConflict(serialNumber, serialNumberYadro, excludeComponentId);

    if (conflict) {
      return res.json({
        unique: false,
        conflict: {
          id: conflict.id,
          name: conflict.name,
          componentType: conflict.componentType,
          serialNumber: conflict.serialNumber,
          serialNumberYadro: conflict.serialNumberYadro,
          server: conflict.server ? {
            id: conflict.server.id,
            ipAddress: conflict.server.ipAddress,
            apkSerialNumber: conflict.server.apkSerialNumber
          } : null
        }
      });
    }

    res.json({ unique: true });

  } catch (error) {
    console.error('[ComponentsExtended] checkSerialUniqueness error:', error);
    next(ApiError.internal(error.message));
  }
}


async function getComponentHistory(req, res, next) {
  try {
    const { id: componentId } = req.params;
    const { limit = 50 } = req.query;

    const component = await BeryllServerComponent.findByPk(componentId);
    if (!component) {
      return next(ApiError.notFound('–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–µ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'));
    }


    const history = await BeryllHistory.findAll({
      where: {
        serverId: component.serverId,
        [Op.or]: [
          { action: { [Op.in]: ['COMPONENT_ADDED', 'COMPONENT_UPDATED', 'COMPONENT_REPLACED', 'COMPONENT_DELETED', 'COMPONENT_SERIALS_UPDATED'] } }
        ]
      },
      include: [{
        model: User,
        as: 'user',
        attributes: ['id', 'name', 'surname']
      }],
      order: [['createdAt', 'DESC']],
      limit: parseInt(limit)
    });


    const filtered = history.filter(h => {
      try {
        const meta = h.metadata || (h.comment ? JSON.parse(h.comment) : {});
        return meta.componentId === parseInt(componentId) ||
               meta.oldComponentId === parseInt(componentId) ||
               meta.newComponentId === parseInt(componentId);
      } catch {
        return false;
      }
    });

    res.json({
      success: true,
      componentId: parseInt(componentId),
      history: filtered
    });

  } catch (error) {
    console.error('[ComponentsExtended] getComponentHistory error:', error);
    next(ApiError.internal(error.message));
  }
}


async function getServerComponentsHistory(req, res, next) {
  try {
    const { id: serverId } = req.params;
    const { limit = 100 } = req.query;

    const history = await BeryllHistory.findAll({
      where: {
        serverId: parseInt(serverId),
        action: {
          [Op.in]: [
            'COMPONENT_ADDED',
            'COMPONENT_UPDATED',
            'COMPONENT_REPLACED',
            'COMPONENT_DELETED',
            'COMPONENT_SERIALS_UPDATED',
            'COMPONENTS_BATCH_ADDED',
            'COMPONENTS_FETCHED'
          ]
        }
      },
      include: [{
        model: User,
        as: 'user',
        attributes: ['id', 'name', 'surname']
      }],
      order: [['createdAt', 'DESC']],
      limit: parseInt(limit)
    });

    res.json({
      success: true,
      serverId: parseInt(serverId),
      count: history.length,
      history
    });

  } catch (error) {
    console.error('[ComponentsExtended] getServerComponentsHistory error:', error);
    next(ApiError.internal(error.message));
  }
}


module.exports = {

  sanitizeNumericFields,
  checkSerialConflict,
  logHistory,


  addComponent,
  addComponentsBatch,
  updateComponent,
  updateSerials,
  replaceComponent,
  deleteComponent,


  searchComponent,
  scanYadroSerial,
  checkSerialUniqueness,


  getComponentHistory,
  getServerComponentsHistory
};

================================================================================
FILE: QMS-Server-master/controllers/beryll/config/beryll.config.js
================================================================================

const path = require("path");

const UPLOAD_DIR = path.join(__dirname, "..", "..", "uploads", "beryll");

const DHCP_CONFIG = {
  host: "10.11.0.10",
  username: "root",
  password: process.env.DHCP_SSH_PASSWORD || "",
  leaseFile: "/var/lib/dhcp/dhcpd.leases"
};

module.exports = {
  UPLOAD_DIR,
  DHCP_CONFIG
};

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/ArchiveController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const ArchiveService = require("../services/ArchiveService");

class ArchiveController {
  async getArchivedServers(req, res, next) {
    try {
      const result = await ArchiveService.getArchivedServers(req.query);
      return res.json(result);
    } catch (e) {
      console.error(e);
      return next(ApiError.internal(e.message));
    }
  }

  async archiveServer(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user.id;

      const result = await ArchiveService.archiveServer(id, userId);
      return res.json(result);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      if (e.message.includes("–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ") || e.message.includes("—Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä")) {
        return next(ApiError.badRequest(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async unarchiveServer(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;

      const updated = await ArchiveService.unarchiveServer(id, userId);
      return res.json(updated);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞—Ä—Ö–∏–≤–µ") {
        return next(ApiError.badRequest(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async updateApkSerialNumber(req, res, next) {
    try {
      const { id } = req.params;
      const { apkSerialNumber } = req.body;
      const userId = req.user.id;

      const result = await ArchiveService.updateApkSerialNumber(id, apkSerialNumber, userId);
      return res.json(result);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      if (e.message.includes("–£–∫–∞–∂–∏—Ç–µ") || e.message.includes("–ø—Ä–∏—Å–≤–æ–µ–Ω")) {
        return next(ApiError.badRequest(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }
}

module.exports = new ArchiveController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/BatchController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const BatchService = require("../services/BatchService");

class BatchController {
  async getBatches(req, res, next) {
    try {
      const batches = await BatchService.getBatches(req.query);
      return res.json(batches);
    } catch (e) {
      console.error(e);
      return next(ApiError.internal(e.message));
    }
  }

  async getBatchById(req, res, next) {
    try {
      const { id } = req.params;
      const batch = await BatchService.getBatchById(id);
      return res.json(batch);
    } catch (e) {
      console.error(e);
      if (e.message === "–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async createBatch(req, res, next) {
    try {
      const userId = req.user?.id;
      const batch = await BatchService.createBatch(req.body, userId);
      return res.json(batch);
    } catch (e) {
      console.error(e);
      if (e.message === "–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ") {
        return next(ApiError.badRequest(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async updateBatch(req, res, next) {
    try {
      const { id } = req.params;
      const batch = await BatchService.updateBatch(id, req.body);
      return res.json(batch);
    } catch (e) {
      console.error(e);
      if (e.message === "–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async deleteBatch(req, res, next) {
    try {
      const { id } = req.params;
      const result = await BatchService.deleteBatch(id);
      return res.json(result);
    } catch (e) {
      console.error(e);
      if (e.message === "–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async assignServersToBatch(req, res, next) {
    try {
      const { id } = req.params;
      const { serverIds } = req.body;
      const userId = req.user?.id;

      const result = await BatchService.assignServersToBatch(id, serverIds, userId);
      return res.json(result);
    } catch (e) {
      console.error(e);
      if (e.message === "–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞") {
        return next(ApiError.notFound(e.message));
      }
      if (e.message === "–£–∫–∞–∂–∏—Ç–µ ID —Å–µ—Ä–≤–µ—Ä–æ–≤") {
        return next(ApiError.badRequest(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async removeServersFromBatch(req, res, next) {
    try {
      const { id } = req.params;
      const { serverIds } = req.body;
      const userId = req.user?.id;

      const result = await BatchService.removeServersFromBatch(id, serverIds, userId);
      return res.json(result);
    } catch (e) {
      console.error(e);
      if (e.message === "–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }
}

module.exports = new BatchController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/ChecklistController.js
================================================================================

const ChecklistService = require("../services/ChecklistService");
const ApiError = require("../../../error/ApiError");

class ChecklistController {


  async getChecklistTemplates(req, res, next) {
    try {
      const { includeInactive } = req.query;

      let templates;
      if (includeInactive === 'true') {
        templates = await ChecklistService.getAllChecklistTemplates(true);
      } else {
        templates = await ChecklistService.getChecklistTemplates();
      }

      return res.json(templates);
    } catch (e) {
      console.error("getChecklistTemplates error:", e);
      return next(ApiError.internal(e.message));
    }
  }


  async createChecklistTemplate(req, res, next) {
    try {
      const template = await ChecklistService.createChecklistTemplate(req.body);
      return res.status(201).json(template);
    } catch (e) {
      console.error("createChecklistTemplate error:", e);
      if (e.message === "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ") {
        return next(ApiError.badRequest(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }


  async updateChecklistTemplate(req, res, next) {
    try {
      const { id } = req.params;
      const template = await ChecklistService.updateChecklistTemplate(id, req.body);
      return res.json(template);
    } catch (e) {
      console.error("updateChecklistTemplate error:", e);
      if (e.message === "–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }


  async deleteChecklistTemplate(req, res, next) {
    try {
      const { id } = req.params;
      const { hardDelete } = req.query;
      const result = await ChecklistService.deleteChecklistTemplate(id, hardDelete === 'true');
      return res.json(result);
    } catch (e) {
      console.error("deleteChecklistTemplate error:", e);
      if (e.message === "–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      if (e.message.includes("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å")) {
        return next(ApiError.badRequest(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }


  async restoreChecklistTemplate(req, res, next) {
    try {
      const { id } = req.params;
      const template = await ChecklistService.restoreChecklistTemplate(id);
      return res.json(template);
    } catch (e) {
      console.error("restoreChecklistTemplate error:", e);
      if (e.message === "–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }


  async reorderChecklistTemplates(req, res, next) {
    try {
      const { orderedIds } = req.body;

      if (!Array.isArray(orderedIds) || orderedIds.length === 0) {
        return next(ApiError.badRequest("–ù–µ–æ–±—Ö–æ–¥–∏–º –º–∞—Å—Å–∏–≤ orderedIds"));
      }

      const result = await ChecklistService.reorderChecklistTemplates(orderedIds);
      return res.json(result);
    } catch (e) {
      console.error("reorderChecklistTemplates error:", e);
      return next(ApiError.internal(e.message));
    }
  }


  async getServerChecklist(req, res, next) {
    try {
      const { serverId } = req.params;
      const checklist = await ChecklistService.getServerChecklist(serverId);
      return res.json(checklist);
    } catch (e) {
      console.error("getServerChecklist error:", e);
      return next(ApiError.internal(e.message));
    }
  }


  async toggleChecklistItem(req, res, next) {
    try {
      const { serverId, checklistId } = req.params;
      const { completed, notes } = req.body;
      const userId = req.user?.id;

      const checklist = await ChecklistService.toggleChecklistItem(
        serverId,
        checklistId,
        completed,
        notes,
        userId
      );

      return res.json(checklist);
    } catch (e) {
      console.error("toggleChecklistItem error:", e);
      if (e.message.includes("–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å")) {
        return next(ApiError.badRequest(e.message));
      }
      if (e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")) {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }


  async uploadChecklistFile(req, res, next) {
    try {
      const { serverId, checklistId } = req.params;
      const userId = req.user?.id;


      if (!req.files || !req.files.file) {
        return next(ApiError.badRequest("–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"));
      }

      const uploadedFile = req.files.file;


      const allowedTypes = ["image/jpeg", "image/png", "image/gif", "image/webp", "application/pdf"];
      if (!allowedTypes.includes(uploadedFile.mimetype)) {
        return next(ApiError.badRequest("–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã: JPG, PNG, GIF, WEBP, PDF"));
      }


      if (uploadedFile.size > 5 * 1024 * 1024) {
        return next(ApiError.badRequest("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ 5 –ú–ë"));
      }

      const file = await ChecklistService.uploadChecklistFile(
        serverId,
        checklistId,
        uploadedFile,
        userId
      );

      return res.status(201).json(file);
    } catch (e) {
      console.error("uploadChecklistFile error:", e);
      if (e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")) {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }


  async getServerFiles(req, res, next) {
    try {
      const { serverId } = req.params;
      const files = await ChecklistService.getServerFiles(serverId);
      return res.json(files);
    } catch (e) {
      console.error("getServerFiles error:", e);
      return next(ApiError.internal(e.message));
    }
  }


  async downloadFile(req, res, next) {
    try {
      const { fileId } = req.params;
      const file = await ChecklistService.getFileById(fileId);

      if (!file) {
        return next(ApiError.notFound("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }


      const disposition = req.query.download === 'true' ? 'attachment' : 'inline';

      res.setHeader('Content-Type', file.mimetype || 'application/octet-stream');
      res.setHeader('Content-Disposition', `${disposition}; filename="${encodeURIComponent(file.originalName)}"`);


      return res.sendFile(file.path);
    } catch (e) {
      console.error("downloadFile error:", e);
      if (e.message === "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }


  async deleteChecklistFile(req, res, next) {
    try {
      const { fileId } = req.params;
      const userId = req.user?.id;

      const result = await ChecklistService.deleteChecklistFile(fileId, userId);
      return res.json(result);
    } catch (e) {
      console.error("deleteChecklistFile error:", e);
      if (e.message === "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }
}

module.exports = new ChecklistController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/ClusterController.js
================================================================================


const ClusterService = require("../services/ClusterService");
const ApiError = require("../../../error/ApiError");

class ClusterController {

  async getAllShipments(req, res, next) {
    try {
      const { status, search, city } = req.query;
      const shipments = await ClusterService.getAllShipments({ status, search, city });
      res.json(shipments);
    } catch (error) {
      console.error("[ClusterController] getAllShipments error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async getShipmentById(req, res, next) {
    try {
      const { id } = req.params;
      const shipment = await ClusterService.getShipmentById(id);

      if (!shipment) {
        return next(ApiError.notFound("–ö–æ–º–ø–ª–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      res.json(shipment);
    } catch (error) {
      console.error("[ClusterController] getShipmentById error:", error);
      next(ApiError.internal(error.message));
    }
  }

  async createShipment(req, res, next) {
    try {
      const userId = req.user?.id;
      const shipment = await ClusterService.createShipment(req.body, userId);
      res.status(201).json(shipment);
    } catch (error) {
      console.error("[ClusterController] createShipment error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async updateShipment(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const shipment = await ClusterService.updateShipment(id, req.body, userId);
      res.json(shipment);
    } catch (error) {
      console.error("[ClusterController] updateShipment error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async deleteShipment(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const result = await ClusterService.deleteShipment(id, userId);
      res.json(result);
    } catch (error) {
      console.error("[ClusterController] deleteShipment error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async getShipmentHistory(req, res, next) {
    try {
      const { id } = req.params;
      const { limit, offset } = req.query;
      const history = await ClusterService.getHistory("SHIPMENT", id, { limit, offset });
      res.json(history);
    } catch (error) {
      console.error("[ClusterController] getShipmentHistory error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async getAllClusters(req, res, next) {
    try {
      const { status, shipmentId, search } = req.query;
      const clusters = await ClusterService.getAllClusters({ status, shipmentId, search });
      res.json(clusters);
    } catch (error) {
      console.error("[ClusterController] getAllClusters error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async getClusterById(req, res, next) {
    try {
      const { id } = req.params;
      const cluster = await ClusterService.getClusterById(id);

      if (!cluster) {
        return next(ApiError.notFound("–ö–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      res.json(cluster);
    } catch (error) {
      console.error("[ClusterController] getClusterById error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async createCluster(req, res, next) {
    try {
      const userId = req.user?.id;
      const cluster = await ClusterService.createCluster(req.body, userId);
      res.status(201).json(cluster);
    } catch (error) {
      console.error("[ClusterController] createCluster error:", error);
      next(ApiError.badRequest(error.message));
    }
  }

  async updateCluster(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const cluster = await ClusterService.updateCluster(id, req.body, userId);
      res.json(cluster);
    } catch (error) {
      console.error("[ClusterController] updateCluster error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async deleteCluster(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const result = await ClusterService.deleteCluster(id, userId);
      res.json(result);
    } catch (error) {
      console.error("[ClusterController] deleteCluster error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async getClusterHistory(req, res, next) {
    try {
      const { id } = req.params;
      const { limit, offset } = req.query;
      const history = await ClusterService.getHistory("CLUSTER", id, { limit, offset });
      res.json(history);
    } catch (error) {
      console.error("[ClusterController] getClusterHistory error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async addServerToCluster(req, res, next) {
    try {
      const { clusterId } = req.params;
      const { serverId, ...data } = req.body;
      const userId = req.user?.id;

      if (!serverId) {
        return next(ApiError.badRequest("serverId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
      }

      const clusterServer = await ClusterService.addServerToCluster(clusterId, serverId, data, userId);
      res.status(201).json(clusterServer);
    } catch (error) {
      console.error("[ClusterController] addServerToCluster error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async addServersToCluster(req, res, next) {
    try {
      const { clusterId } = req.params;
      const { serverIds, ...data } = req.body;
      const userId = req.user?.id;

      if (!serverIds || !Array.isArray(serverIds) || serverIds.length === 0) {
        return next(ApiError.badRequest("serverIds –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º"));
      }

      const result = await ClusterService.addServersToCluster(clusterId, serverIds, data, userId);
      res.json(result);
    } catch (error) {
      console.error("[ClusterController] addServersToCluster error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async removeServerFromCluster(req, res, next) {
    try {
      const { clusterId, serverId } = req.params;
      const userId = req.user?.id;

      const result = await ClusterService.removeServerFromCluster(clusterId, serverId, userId);
      res.json(result);
    } catch (error) {
      console.error("[ClusterController] removeServerFromCluster error:", error);
      next(ApiError.badRequest(error.message));
    }
  }

  async updateClusterServer(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const clusterServer = await ClusterService.updateClusterServer(id, req.body, userId);
      res.json(clusterServer);
    } catch (error) {
      console.error("[ClusterController] updateClusterServer error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async getUnassignedServers(req, res, next) {
    try {
      const { status, batchId, search, limit } = req.query;
      const servers = await ClusterService.getUnassignedServers({ status, batchId, search, limit });
      res.json(servers);
    } catch (error) {
      console.error("[ClusterController] getUnassignedServers error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async getServerClusters(req, res, next) {
    try {
      const { serverId } = req.params;
      const clusters = await ClusterService.getServerClusters(serverId);
      res.json(clusters);
    } catch (error) {
      console.error("[ClusterController] getServerClusters error:", error);
      next(ApiError.internal(error.message));
    }
  }
}

module.exports = new ClusterController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/ComponentInventoryController.js
================================================================================


const ApiError = require("../../../error/ApiError");
const ComponentInventoryService = require("../services/ComponentInventoryService");

class ComponentInventoryController {


    async getCatalog(req, res, next) {
        try {
            const { type } = req.query;

            if (type) {
                const catalog = await ComponentInventoryService.getCatalogByType(type);
                return res.json(catalog);
            }


            const { ComponentCatalog } = require("../../../models/index");
            const catalog = await ComponentCatalog.findAll({
                where: { isActive: true },
                order: [["type", "ASC"], ["manufacturer", "ASC"], ["model", "ASC"]]
            });

            return res.json(catalog);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }

    async createCatalogEntry(req, res, next) {
        try {
            const { catalog, created } = await ComponentInventoryService.getOrCreateCatalogEntry(req.body);
            return res.json({ catalog, created });
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async updateCatalogEntry(req, res, next) {
        try {
            const { id } = req.params;
            const catalog = await ComponentInventoryService.updateCatalogEntry(id, req.body);
            return res.json(catalog);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }


    async getAll(req, res, next) {
        try {
            const filters = {
                type: req.query.type,
                status: req.query.status,
                condition: req.query.condition,
                manufacturer: req.query.manufacturer,
                model: req.query.model,
                search: req.query.search,
                serverId: req.query.serverId,
                location: req.query.location,
                warrantyExpired: req.query.warrantyExpired === "true" ? true :
                                 req.query.warrantyExpired === "false" ? false : undefined,
                limit: parseInt(req.query.limit) || 50,
                offset: parseInt(req.query.offset) || 0
            };

            const result = await ComponentInventoryService.getAll(filters);
            return res.json(result);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }

    async getById(req, res, next) {
        try {
            const { id } = req.params;
            const component = await ComponentInventoryService.getById(id);

            if (!component) {
                return next(ApiError.notFound("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
            }

            return res.json(component);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }

    async getBySerial(req, res, next) {
        try {
            const { serial } = req.params;
            const component = await ComponentInventoryService.getBySerial(serial);

            if (!component) {
                return next(ApiError.notFound("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
            }

            return res.json(component);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }

    async create(req, res, next) {
        try {
            const userId = req.user?.id;
            const component = await ComponentInventoryService.addToInventory(req.body, userId);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async bulkCreate(req, res, next) {
        try {
            const userId = req.user?.id;
            const { items } = req.body;

            if (!Array.isArray(items) || items.length === 0) {
                return next(ApiError.badRequest("–ú–∞—Å—Å–∏–≤ items –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
            }

            const results = await ComponentInventoryService.bulkAddToInventory(items, userId);
            return res.json(results);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async getAvailableByType(req, res, next) {
        try {
            const { type } = req.params;
            const count = parseInt(req.query.count) || 10;

            const components = await ComponentInventoryService.getAvailableByType(type, count);
            return res.json(components);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }


    async reserve(req, res, next) {
        try {
            const { id } = req.params;
            const { defectId } = req.body;
            const userId = req.user?.id;

            if (!defectId) {
                return next(ApiError.badRequest("defectId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
            }

            const component = await ComponentInventoryService.reserve(id, defectId, userId);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async release(req, res, next) {
        try {
            const { id } = req.params;
            const { notes } = req.body;
            const userId = req.user?.id;

            const component = await ComponentInventoryService.release(id, userId, notes);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async installToServer(req, res, next) {
        try {
            const { id } = req.params;
            const { serverId, defectId } = req.body;
            const userId = req.user?.id;

            if (!serverId) {
                return next(ApiError.badRequest("serverId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
            }

            const component = await ComponentInventoryService.installToServer(id, serverId, userId, defectId);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async removeFromServer(req, res, next) {
        try {
            const { id } = req.params;
            const { reason, defectId } = req.body;
            const userId = req.user?.id;

            const component = await ComponentInventoryService.removeFromServer(id, userId, reason, defectId);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async sendToYadro(req, res, next) {
        try {
            const { id } = req.params;
            const { ticketNumber } = req.body;
            const userId = req.user?.id;

            if (!ticketNumber) {
                return next(ApiError.badRequest("ticketNumber –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
            }

            const component = await ComponentInventoryService.sendToYadro(id, ticketNumber, userId);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async returnFromYadro(req, res, next) {
        try {
            const { id } = req.params;
            const { condition } = req.body;
            const userId = req.user?.id;

            const component = await ComponentInventoryService.returnFromYadro(id, userId, condition);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async scrap(req, res, next) {
        try {
            const { id } = req.params;
            const { reason } = req.body;
            const userId = req.user?.id;

            const component = await ComponentInventoryService.scrap(id, userId, reason);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async updateLocation(req, res, next) {
        try {
            const { id } = req.params;
            const { location } = req.body;
            const userId = req.user?.id;

            if (!location) {
                return next(ApiError.badRequest("location –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
            }

            const component = await ComponentInventoryService.updateLocation(id, location, userId);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async markTested(req, res, next) {
        try {
            const { id } = req.params;
            const { passed, notes } = req.body;
            const userId = req.user?.id;

            if (passed === undefined) {
                return next(ApiError.badRequest("passed –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
            }

            const component = await ComponentInventoryService.markTested(id, userId, passed, notes);
            return res.json(component);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }


    async getHistory(req, res, next) {
        try {
            const { id } = req.params;
            const history = await ComponentInventoryService.getHistory(id);
            return res.json(history);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }


    async getStats(req, res, next) {
        try {
            const stats = await ComponentInventoryService.getStats();
            return res.json(stats);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }

    async getWarrantyExpiring(req, res, next) {
        try {
            const days = parseInt(req.query.days) || 30;
            const components = await ComponentInventoryService.getWarrantyExpiring(days);
            return res.json(components);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }
}

module.exports = new ComponentInventoryController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/ComponentsController.js
================================================================================

const { BeryllServer, BeryllServerComponent, BeryllHistory } = require("../../../models");
const OpenBMCService = require("../services/OpenBMCService");
const ApiError = require("../../../error/ApiError");
const { Op } = require("sequelize");


function generateComponentName(comp) {
  const parts = [];
  if (comp.manufacturer) parts.push(comp.manufacturer);
  if (comp.model) parts.push(comp.model);
  if (parts.length === 0 && comp.name) parts.push(comp.name);
  return parts.join(" ") || `${comp.componentType} Component`;
}


function compareComponents(dbComponents, bmcComponents) {
  const result = {
    missingInBmc: [],
    newInBmc: [],
    mismatches: [],
    matched: []
  };

  const bmcBySerial = new Map();
  const bmcBySlotType = new Map();

  for (const bmcComp of bmcComponents) {
    if (bmcComp.serialNumber) {
      bmcBySerial.set(bmcComp.serialNumber, bmcComp);
    }
    const slotTypeKey = `${bmcComp.componentType}:${bmcComp.slot || 'default'}`;
    bmcBySlotType.set(slotTypeKey, bmcComp);
  }

  const dbBySerial = new Map();
  const processedBmcSerials = new Set();

  for (const dbComp of dbComponents) {
    if (dbComp.serialNumber) {
      dbBySerial.set(dbComp.serialNumber, dbComp);
    }
  }

  for (const dbComp of dbComponents) {
    const serialNumber = dbComp.serialNumber;

    if (serialNumber && bmcBySerial.has(serialNumber)) {
      const bmcComp = bmcBySerial.get(serialNumber);
      processedBmcSerials.add(serialNumber);

      const differences = [];

      if (dbComp.model !== bmcComp.model && bmcComp.model) {
        differences.push({ field: 'model', db: dbComp.model, bmc: bmcComp.model });
      }
      if (dbComp.firmwareVersion !== bmcComp.firmwareVersion && bmcComp.firmwareVersion) {
        differences.push({ field: 'firmwareVersion', db: dbComp.firmwareVersion, bmc: bmcComp.firmwareVersion });
      }
      if (dbComp.status !== bmcComp.status && bmcComp.status) {
        differences.push({ field: 'status', db: dbComp.status, bmc: bmcComp.status });
      }
      if (dbComp.slot !== bmcComp.slot && bmcComp.slot) {
        differences.push({ field: 'slot', db: dbComp.slot, bmc: bmcComp.slot });
      }

      if (differences.length > 0) {
        result.mismatches.push({
          dbComponent: dbComp,
          bmcComponent: bmcComp,
          differences
        });
      } else {
        result.matched.push({
          dbComponent: dbComp,
          bmcComponent: bmcComp
        });
      }
    } else {
      const isManual = dbComp.dataSource === 'MANUAL' || dbComp.dataSource === 'REPLACEMENT';

      result.missingInBmc.push({
        dbComponent: dbComp,
        isManual,
        reason: isManual
          ? '–î–æ–±–∞–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é, –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ BMC'
          : '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É–¥–∞–ª—ë–Ω –∏–ª–∏ –∑–∞–º–µ–Ω—ë–Ω —Ñ–∏–∑–∏—á–µ—Å–∫–∏'
      });
    }
  }

  for (const bmcComp of bmcComponents) {
    const serialNumber = bmcComp.serialNumber;

    if (serialNumber && !processedBmcSerials.has(serialNumber) && !dbBySerial.has(serialNumber)) {
      result.newInBmc.push({
        bmcComponent: bmcComp,
        reason: '–ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –æ–±–Ω–∞—Ä—É–∂–µ–Ω –≤ BMC'
      });
    }
  }

  return result;
}

class ComponentsController {

  async checkBMC(req, res, next) {
    try {
      const { id } = req.params;

      const server = await BeryllServer.findByPk(id);
      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const bmcAddress = server.bmcAddress || server.ipAddress;
      if (!bmcAddress) {
        return next(ApiError.badRequest("IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω"));
      }

      const result = await OpenBMCService.checkConnection(bmcAddress);

      res.json({
        success: result.success,
        redfishVersion: result.version,
        bmcAddress,
        error: result.error
      });
    } catch (error) {
      console.error("[ComponentsController] checkBMC error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async compareWithBMC(req, res, next) {
    try {
      const { id } = req.params;

      const server = await BeryllServer.findByPk(id);
      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const bmcAddress = server.bmcAddress || server.ipAddress;
      if (!bmcAddress) {
        return next(ApiError.badRequest("IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω"));
      }

      const dbComponents = await BeryllServerComponent.findAll({
        where: { serverId: id },
        raw: true
      });

      const bmcComponents = await OpenBMCService.getAllComponents(bmcAddress);

      if (bmcComponents.length === 0) {
        return next(ApiError.badRequest("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å BMC"));
      }

      const comparison = compareComponents(dbComponents, bmcComponents);

      res.json({
        success: true,
        hasDiscrepancies: comparison.missingInBmc.length > 0 ||
                          comparison.newInBmc.length > 0 ||
                          comparison.mismatches.length > 0,
        summary: {
          total: {
            inDb: dbComponents.length,
            inBmc: bmcComponents.length
          },
          matched: comparison.matched.length,
          missingInBmc: comparison.missingInBmc.length,
          newInBmc: comparison.newInBmc.length,
          mismatches: comparison.mismatches.length
        },
        details: comparison
      });
    } catch (error) {
      console.error("[ComponentsController] compareWithBMC error:", error);
      next(ApiError.internal(error.message));
    }
  }

  async fetchComponents(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const {
        mode = 'compare',
        preserveManual = true
      } = req.body;

      const server = await BeryllServer.findByPk(id);
      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const bmcAddress = server.bmcAddress || server.ipAddress;
      if (!bmcAddress) {
        return next(ApiError.badRequest("IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω"));
      }

      const dbComponents = await BeryllServerComponent.findAll({
        where: { serverId: id }
      });

      const bmcComponents = await OpenBMCService.getAllComponents(bmcAddress);

      if (bmcComponents.length === 0) {
        return next(ApiError.badRequest("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å BMC. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å."));
      }

      const comparison = compareComponents(
        dbComponents.map(c => c.get({ plain: true })),
        bmcComponents
      );

      const hasDiscrepancies = comparison.missingInBmc.length > 0 ||
                               comparison.newInBmc.length > 0 ||
                               comparison.mismatches.length > 0;

      if (mode === 'compare') {
        return res.json({
          success: true,
          mode: 'compare',
          hasDiscrepancies,
          summary: {
            total: {
              inDb: dbComponents.length,
              inBmc: bmcComponents.length
            },
            matched: comparison.matched.length,
            missingInBmc: comparison.missingInBmc.length,
            newInBmc: comparison.newInBmc.length,
            mismatches: comparison.mismatches.length
          },
          details: comparison,
          message: hasDiscrepancies
            ? '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º: force (–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –≤—Å—ë) –∏–ª–∏ merge (—Å–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ)'
            : '–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'
        });
      }

      if (mode === 'force') {
        const manualComponents = preserveManual
          ? dbComponents.filter(c => c.dataSource === 'MANUAL' || c.dataSource === 'REPLACEMENT')
          : [];

        if (preserveManual && manualComponents.length > 0) {
          const manualIds = manualComponents.map(c => c.id);
          await BeryllServerComponent.destroy({
            where: {
              serverId: id,
              id: { [Op.notIn]: manualIds }
            }
          });
        } else {
          await BeryllServerComponent.destroy({ where: { serverId: id } });
        }

        const savedComponents = [];
        for (const comp of bmcComponents) {
          const name = generateComponentName(comp);

          const metadata = {
            cores: comp.cores,
            threads: comp.threads,
            architecture: comp.architecture,
            memoryType: comp.memoryType,
            rank: comp.rank,
            mediaType: comp.mediaType,
            interface: comp.interface,
            macAddress: comp.macAddress,
            linkSpeed: comp.linkSpeed,
            health: comp.health,
            fetchedById: userId
          };

          Object.keys(metadata).forEach(key => {
            if (metadata[key] === undefined || metadata[key] === null) {
              delete metadata[key];
            }
          });

          const saved = await BeryllServerComponent.create({
            serverId: id,
            componentType: comp.componentType,
            name: name,
            slot: comp.slot,
            manufacturer: comp.manufacturer,
            model: comp.model,
            serialNumber: comp.serialNumber,
            partNumber: comp.partNumber,
            firmwareVersion: comp.firmwareVersion,
            status: comp.status || "UNKNOWN",
            capacity: comp.capacityBytes || null,
            speed: comp.speedMHz || comp.speedMT || comp.speed || null,
            healthPercent: typeof comp.health === "number" ? comp.health : null,
            metadata: Object.keys(metadata).length > 0 ? metadata : null,
            dataSource: "REDFISH",
            lastUpdatedAt: new Date()
          });
          savedComponents.push(saved);
        }

        await server.update({ lastComponentsFetchAt: new Date() });

        await BeryllHistory.create({
          serverId: id,
          serverIp: server.ipAddress,
          serverHostname: server.hostname,
          userId,
          action: "COMPONENTS_FETCHED",
          comment: `–í—ã–≥—Ä—É–∂–µ–Ω–æ ${savedComponents.length} –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö —Å BMC (—Ä–µ–∂–∏–º: force)`,
          metadata: {
            mode: 'force',
            preserveManual,
            manualPreserved: manualComponents.length,
            componentsCount: savedComponents.length,
            discrepancies: {
              missingInBmc: comparison.missingInBmc.length,
              newInBmc: comparison.newInBmc.length,
              mismatches: comparison.mismatches.length
            }
          }
        });

        return res.json({
          success: true,
          mode: 'force',
          message: `–í—ã–≥—Ä—É–∂–µ–Ω–æ ${savedComponents.length} –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö`,
          manualPreserved: manualComponents.length,
          components: savedComponents
        });
      }

      if (mode === 'merge') {
        const actions = {
          updated: [],
          added: [],
          preserved: [],
          flaggedForReview: []
        };

        for (const mismatch of comparison.mismatches) {
          const dbComp = dbComponents.find(c => c.id === mismatch.dbComponent.id);
          if (dbComp) {
            const updateData = {};
            for (const diff of mismatch.differences) {
              updateData[diff.field] = diff.bmc;
            }
            updateData.lastUpdatedAt = new Date();
            updateData.dataSource = 'REDFISH';

            await dbComp.update(updateData);
            actions.updated.push({
              id: dbComp.id,
              serialNumber: dbComp.serialNumber,
              changes: mismatch.differences
            });
          }
        }

        for (const newComp of comparison.newInBmc) {
          const comp = newComp.bmcComponent;
          const name = generateComponentName(comp);

          const metadata = {
            cores: comp.cores,
            threads: comp.threads,
            architecture: comp.architecture,
            memoryType: comp.memoryType,
            health: comp.health,
            fetchedById: userId
          };

          Object.keys(metadata).forEach(key => {
            if (metadata[key] === undefined || metadata[key] === null) {
              delete metadata[key];
            }
          });

          const saved = await BeryllServerComponent.create({
            serverId: id,
            componentType: comp.componentType,
            name: name,
            slot: comp.slot,
            manufacturer: comp.manufacturer,
            model: comp.model,
            serialNumber: comp.serialNumber,
            partNumber: comp.partNumber,
            firmwareVersion: comp.firmwareVersion,
            status: comp.status || "UNKNOWN",
            capacity: comp.capacityBytes || null,
            speed: comp.speedMHz || comp.speedMT || comp.speed || null,
            healthPercent: typeof comp.health === "number" ? comp.health : null,
            metadata: Object.keys(metadata).length > 0 ? metadata : null,
            dataSource: "REDFISH",
            lastUpdatedAt: new Date()
          });
          actions.added.push(saved);
        }

        for (const missing of comparison.missingInBmc) {
          const dbComp = dbComponents.find(c => c.id === missing.dbComponent.id);
          if (dbComp) {
            if (missing.isManual) {
              await dbComp.update({
                bmcDiscrepancy: true,
                bmcDiscrepancyReason: 'NOT_FOUND_IN_BMC',
                lastUpdatedAt: new Date()
              });
              actions.flaggedForReview.push({
                id: dbComp.id,
                serialNumber: dbComp.serialNumber,
                reason: missing.reason
              });
            } else {
              await dbComp.update({
                bmcDiscrepancy: true,
                bmcDiscrepancyReason: 'REMOVED_FROM_BMC',
                lastUpdatedAt: new Date()
              });
              actions.flaggedForReview.push({
                id: dbComp.id,
                serialNumber: dbComp.serialNumber,
                reason: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ BMC - –≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª—ë–Ω'
              });
            }
          }
        }

        await server.update({ lastComponentsFetchAt: new Date() });

        await BeryllHistory.create({
          serverId: id,
          serverIp: server.ipAddress,
          serverHostname: server.hostname,
          userId,
          action: "COMPONENTS_MERGED",
          comment: `–°–ª–∏—è–Ω–∏–µ: –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${actions.updated.length}, –¥–æ–±–∞–≤–ª–µ–Ω–æ ${actions.added.length}, –ø–æ–º–µ—á–µ–Ω–æ ${actions.flaggedForReview.length}`,
          metadata: {
            mode: 'merge',
            updated: actions.updated.length,
            added: actions.added.length,
            flaggedForReview: actions.flaggedForReview.length
          }
        });

        return res.json({
          success: true,
          mode: 'merge',
          message: '–°–ª–∏—è–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ',
          actions
        });
      }

      return next(ApiError.badRequest("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: compare, force, merge"));

    } catch (error) {
      console.error("[ComponentsController] fetchComponents error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async getComponents(req, res, next) {
    try {
      const { id } = req.params;

      const server = await BeryllServer.findByPk(id, {
        attributes: ["id", "ipAddress", "hostname", "apkSerialNumber", "lastComponentsFetchAt"]
      });

      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const components = await BeryllServerComponent.findAll({
        where: { serverId: id },
        order: [
          ["componentType", "ASC"],
          ["slot", "ASC"]
        ]
      });

      res.json({
        server: {
          id: server.id,
          ipAddress: server.ipAddress,
          hostname: server.hostname,
          apkSerialNumber: server.apkSerialNumber,
          lastComponentsFetchAt: server.lastComponentsFetchAt
        },
        components,
        discrepancyCount: components.filter(c => c.bmcDiscrepancy).length
      });
    } catch (error) {
      console.error("[ComponentsController] getComponents error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async getComponentById(req, res, next) {
    try {
      const { id } = req.params;

      const component = await BeryllServerComponent.findByPk(id, {
        include: [
          {
            model: BeryllServer,
            as: "server",
            attributes: ["id", "ipAddress", "apkSerialNumber", "hostname"]
          }
        ]
      });

      if (!component) {
        return next(ApiError.notFound("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      res.json(component);
    } catch (error) {
      console.error("[ComponentsController] getComponentById error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async deleteComponents(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;

      const server = await BeryllServer.findByPk(id);
      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const deleted = await BeryllServerComponent.destroy({ where: { serverId: id } });

      await BeryllServer.update(
        { lastComponentsFetchAt: null },
        { where: { id } }
      );

      if (deleted > 0) {
        await BeryllHistory.create({
          serverId: id,
          serverIp: server.ipAddress,
          serverHostname: server.hostname,
          userId,
          action: "COMPONENTS_DELETED",
          comment: `–£–¥–∞–ª–µ–Ω–æ ${deleted} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤`,
          metadata: { deletedCount: deleted }
        });
      }

      res.json({
        success: true,
        message: `–£–¥–∞–ª–µ–Ω–æ ${deleted} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤`
      });
    } catch (error) {
      console.error("[ComponentsController] deleteComponents error:", error);
      next(ApiError.internal(error.message));
    }
  }

  async updateBMCAddress(req, res, next) {
    try {
      const { id } = req.params;
      const { bmcAddress } = req.body;
      const userId = req.user?.id;

      const server = await BeryllServer.findByPk(id);
      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const oldAddress = server.bmcAddress;
      await server.update({ bmcAddress });

      await BeryllHistory.create({
        serverId: id,
        serverIp: server.ipAddress,
        serverHostname: server.hostname,
        userId,
        action: "BMC_ADDRESS_UPDATED",
        comment: `BMC –∞–¥—Ä–µ—Å –∏–∑–º–µ–Ω—ë–Ω: ${oldAddress || '–Ω–µ –∑–∞–¥–∞–Ω'} ‚Üí ${bmcAddress || '–æ—á–∏—â–µ–Ω'}`,
        metadata: { oldAddress, newAddress: bmcAddress }
      });

      res.json({
        success: true,
        bmcAddress: server.bmcAddress
      });
    } catch (error) {
      console.error("[ComponentsController] updateBMCAddress error:", error);
      next(ApiError.internal(error.message));
    }
  }

  async resolveDiscrepancy(req, res, next) {
    try {
      const { serverId, componentId } = req.params;
      const { resolution } = req.body;
      const userId = req.user?.id;

      const component = await BeryllServerComponent.findOne({
        where: { id: componentId, serverId }
      });

      if (!component) {
        return next(ApiError.notFound("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      if (resolution === 'delete') {
        await component.destroy();

        await BeryllHistory.create({
          serverId,
          userId,
          action: "COMPONENT_DELETED",
          comment: `–ö–æ–º–ø–æ–Ω–µ–Ω—Ç ${component.serialNumber || component.name} —É–¥–∞–ª—ë–Ω –ø—Ä–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è`,
          metadata: { componentId, serialNumber: component.serialNumber }
        });

        return res.json({ success: true, action: 'deleted' });
      }

      await component.update({
        bmcDiscrepancy: false,
        bmcDiscrepancyReason: null,
        lastUpdatedAt: new Date()
      });

      await BeryllHistory.create({
        serverId,
        userId,
        action: "DISCREPANCY_RESOLVED",
        comment: `–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –¥–ª—è ${component.serialNumber || component.name} —Ä–∞–∑—Ä–µ—à–µ–Ω–æ (–æ—Å—Ç–∞–≤–ª–µ–Ω)`,
        metadata: { componentId, serialNumber: component.serialNumber }
      });

      return res.json({ success: true, action: 'kept', component });

    } catch (error) {
      console.error("[ComponentsController] resolveDiscrepancy error:", error);
      next(ApiError.internal(error.message));
    }
  }
}

module.exports = new ComponentsController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/DefectExportController.js
================================================================================

const DefectExportService = require("../services/DefectExportService");
const ApiError = require("../../../error/ApiError");

class DefectExportController {

    async exportDefects(req, res, next) {
        try {
            const { status, dateFrom, dateTo, serverId, search } = req.query;

            const buffer = await DefectExportService.exportToExcel({
                status,
                dateFrom,
                dateTo,
                serverId: serverId ? parseInt(serverId) : undefined,
                search
            });

            const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
            const filename = `–ë—Ä–∞–∫_—Å–µ—Ä–≤–µ—Ä–æ–≤_${date}.xlsx`;

            res.setHeader(
                "Content-Type",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            );
            res.setHeader(
                "Content-Disposition",
                `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`
            );
            res.setHeader("Content-Length", buffer.length);

            return res.send(buffer);

        } catch (error) {
            console.error("exportDefects error:", error);
            return next(ApiError.internal(error.message));
        }
    }


    async exportStats(req, res, next) {
        try {
            const buffer = await DefectExportService.exportStatsToExcel();

            const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
            const filename = `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞_–±—Ä–∞–∫–∞_${date}.xlsx`;

            res.setHeader(
                "Content-Type",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            );
            res.setHeader(
                "Content-Disposition",
                `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`
            );
            res.setHeader("Content-Length", buffer.length);

            return res.send(buffer);

        } catch (error) {
            console.error("exportStats error:", error);
            return next(ApiError.internal(error.message));
        }
    }
}

module.exports = new DefectExportController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/DefectMonitoringController.js
================================================================================

const { exec } = require("child_process");
const { promisify } = require("util");
const path = require("path");
const fs = require("fs");
const { Op, fn, col } = require("sequelize");

const ApiError = require("../../../error/ApiError");
const { BeryllServer, BeryllHistory } = require("../../../models/definitions/Beryll");
const { User } = require("../../../models/index");

const execAsync = promisify(exec);


const PING_TIMEOUT = 2;
const CACHE_TTL = 60000;


let pingCache = new Map();
let lastFullScan = null;


const DEFECT_FILES_DIR = path.join(__dirname, "../../../uploads/beryll/defects");


if (!fs.existsSync(DEFECT_FILES_DIR)) {
  fs.mkdirSync(DEFECT_FILES_DIR, { recursive: true });
}

class DefectMonitoringController {


  async pingHost(ipAddress) {
    if (!ipAddress) {
      return { online: false, latency: null, error: "IP –Ω–µ —É–∫–∞–∑–∞–Ω" };
    }

    try {

      const isWindows = process.platform === 'win32';
      const cmd = isWindows
        ? `ping -n 1 -w ${PING_TIMEOUT * 1000} ${ipAddress}`
        : `ping -c 1 -W ${PING_TIMEOUT} ${ipAddress}`;

      const { stdout } = await execAsync(cmd, {
        timeout: (PING_TIMEOUT + 1) * 1000
      });

      const latencyMatch = stdout.match(/time[=<](\d+\.?\d*)/);
      return {
        online: true,
        latency: latencyMatch ? parseFloat(latencyMatch[1]) : null,
        error: null
      };
    } catch (error) {
      return {
        online: false,
        latency: null,
        error: error.message || "Timeout"
      };
    }
  }

  async pingServer(req, res, next) {
    try {
      const serverId = parseInt(req.params.id);

      const server = await BeryllServer.findByPk(serverId, {
        attributes: ["id", "ipAddress", "hostname", "serialNumber", "apkSerialNumber", "status", "batchId"]
      });

      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      if (!server.ipAddress) {
        return res.json({
          serverId,
          ipAddress: null,
          hostname: server.hostname,
          online: false,
          latency: null,
          error: "IP –Ω–µ —É–∫–∞–∑–∞–Ω",
          checkedAt: new Date().toISOString()
        });
      }

      const result = await this.pingHost(server.ipAddress);

      const cacheEntry = {
        serverId,
        ipAddress: server.ipAddress,
        hostname: server.hostname,
        serialNumber: server.serialNumber,
        apkSerialNumber: server.apkSerialNumber,
        serverStatus: server.status,
        batchId: server.batchId,
        ...result,
        checkedAt: new Date().toISOString()
      };
      pingCache.set(serverId, cacheEntry);

      return res.json(cacheEntry);
    } catch (e) {
      console.error("pingServer error:", e);
      return next(ApiError.internal(e.message));
    }
  }


  async pingAllServers(req, res, next) {
    try {
      const { batchId, status, forceRefresh } = req.query;

      if (forceRefresh !== "true" && lastFullScan && (Date.now() - lastFullScan.getTime() < CACHE_TTL)) {
        return res.json(this.getCachedStatusesData());
      }

      const where = {
        ipAddress: { [Op.ne]: null },
        status: { [Op.notIn]: ["ARCHIVED"] }
      };
      if (batchId) where.batchId = parseInt(batchId);
      if (status) where.status = status;

      const servers = await BeryllServer.findAll({
        where,
        attributes: ["id", "ipAddress", "hostname", "serialNumber", "apkSerialNumber", "status", "batchId"]
      });

      console.log(`[Monitoring] –ü–∏–Ω–≥—É–µ–º ${servers.length} —Å–µ—Ä–≤–µ—Ä–æ–≤...`);

      const results = [];
      const batchSize = 10;

      for (let i = 0; i < servers.length; i += batchSize) {
        const batch = servers.slice(i, i + batchSize);
        const batchResults = await Promise.all(batch.map(async (server) => {
          const pingResult = await this.pingHost(server.ipAddress);

          const result = {
            serverId: server.id,
            ipAddress: server.ipAddress,
            hostname: server.hostname,
            serialNumber: server.serialNumber,
            apkSerialNumber: server.apkSerialNumber,
            serverStatus: server.status,
            batchId: server.batchId,
            ...pingResult,
            checkedAt: new Date().toISOString()
          };

          pingCache.set(server.id, result);
          return result;
        }));
        results.push(...batchResults);
      }

      lastFullScan = new Date();
      const online = results.filter(r => r.online).length;

      console.log(`[Monitoring] –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${online} online, ${results.length - online} offline`);

      return res.json({
        total: results.length,
        online,
        offline: results.length - online,
        checkedAt: lastFullScan.toISOString(),
        servers: results
      });
    } catch (e) {
      console.error("pingAllServers error:", e);
      return next(ApiError.internal(e.message));
    }
  }


  async getCachedStatus(req, res, next) {
    try {
      return res.json(this.getCachedStatusesData());
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }


  async getMonitoringStats(req, res, next) {
    try {
      const results = Array.from(pingCache.values());
      const online = results.filter(r => r.online).length;
      const offline = results.filter(r => !r.online).length;


      const latencies = results.filter(r => r.online && r.latency).map(r => r.latency);
      const avgLatency = latencies.length > 0
        ? (latencies.reduce((a, b) => a + b, 0) / latencies.length).toFixed(2)
        : null;

      return res.json({
        byStatus: {
          ONLINE: online,
          OFFLINE: offline,
          UNKNOWN: 0
        },
        total: results.length,
        online,
        offline,
        unknown: 0,
        staleServers: 0,
        avgLatency,
        lastFullScan: lastFullScan ? lastFullScan.toISOString() : null
      });
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }


  async getOnlineServers(req, res, next) {
    try {
      const results = Array.from(pingCache.values()).filter(r => r.online);
      return res.json({ servers: results, total: results.length });
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }


  async getOfflineServers(req, res, next) {
    try {
      const results = Array.from(pingCache.values()).filter(r => !r.online);
      return res.json({ servers: results, total: results.length });
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }


  async clearCache(req, res, next) {
    try {
      pingCache.clear();
      lastFullScan = null;
      return res.json({ success: true, message: "–ö—ç—à –æ—á–∏—â–µ–Ω" });
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }


  getCachedStatusesData() {
    const results = Array.from(pingCache.values());
    const online = results.filter(r => r.online).length;
    return {
      total: results.length,
      online,
      offline: results.length - online,
      checkedAt: lastFullScan ? lastFullScan.toISOString() : null,
      cached: true,
      servers: results
    };
  }

  async getServerDefects(req, res, next) {
    try {
      const { serverId } = req.params;
      const { status, category, limit = 50, offset = 0 } = req.query;

      const server = await BeryllServer.findByPk(serverId);
      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      return res.json({
        count: 0,
        rows: [],
        page: 1,
        totalPages: 0
      });
    } catch (e) {
      console.error("getServerDefects:", e);
      return next(ApiError.internal(e.message));
    }
  }

  async getDefectById(req, res, next) {
    try {

      return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }


  async createDefect(req, res, next) {
    try {
      const { serverId } = req.params;
      const { text, defectCategory, priority } = req.body;

      if (!text || !text.trim()) {
        return next(ApiError.badRequest("–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
      }

      const server = await BeryllServer.findByPk(serverId);
      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await BeryllHistory.create({
        serverId,
        serverIp: server.ipAddress,
        serverHostname: server.hostname,
        userId: req.user?.id,
        action: "NOTE_ADDED",
        comment: `[–î–ï–§–ï–ö–¢/${defectCategory || "OTHER"}] ${text.trim()}`,
        metadata: { defectCategory, priority, isDefect: true }
      });

      return res.status(201).json({
        success: true,
        message: "–î–µ—Ñ–µ–∫—Ç –∑–∞–ø–∏—Å–∞–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é —Å–µ—Ä–≤–µ—Ä–∞"
      });
    } catch (e) {
      console.error("createDefect:", e);
      return next(ApiError.internal(e.message));
    }
  }

  async updateDefect(req, res, next) {
    try {
      return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }

  async deleteDefect(req, res, next) {
    try {
      return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }

  async resolveDefect(req, res, next) {
    try {
      return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }

  async uploadDefectFile(req, res, next) {
    try {
      if (!req.file) {
        return next(ApiError.badRequest("–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"));
      }

      return res.json({
        success: true,
        file: {
          id: Date.now(),
          fileName: req.file.filename,
          originalName: req.file.originalname,
          fileSize: req.file.size
        }
      });
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }


  async downloadDefectFile(req, res, next) {
    try {
      return next(ApiError.notFound("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"));
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }


  async deleteDefectFile(req, res, next) {
    try {
      return next(ApiError.notFound("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"));
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }

  async getDefectStats(req, res, next) {
    try {
      return res.json({
        total: 0,
        unresolved: 0,
        resolved: 0,
        byCategory: {},
        byStatus: {},
        byPriority: {}
      });
    } catch (e) {
      return next(ApiError.internal(e.message));
    }
  }
}

const controller = new DefectMonitoringController();

module.exports = {

  pingServer: controller.pingServer.bind(controller),
  pingAllServers: controller.pingAllServers.bind(controller),
  getCachedStatus: controller.getCachedStatus.bind(controller),
  getMonitoringStats: controller.getMonitoringStats.bind(controller),
  getOnlineServers: controller.getOnlineServers.bind(controller),
  getOfflineServers: controller.getOfflineServers.bind(controller),
  clearCache: controller.clearCache.bind(controller),


  getServerDefects: controller.getServerDefects.bind(controller),
  getDefectById: controller.getDefectById.bind(controller),
  createDefect: controller.createDefect.bind(controller),
  updateDefect: controller.updateDefect.bind(controller),
  deleteDefect: controller.deleteDefect.bind(controller),
  resolveDefect: controller.resolveDefect.bind(controller),
  uploadDefectFile: controller.uploadDefectFile.bind(controller),
  downloadDefectFile: controller.downloadDefectFile.bind(controller),
  deleteDefectFile: controller.deleteDefectFile.bind(controller),
  getDefectStats: controller.getDefectStats.bind(controller)
};

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/DefectRecordController.js
================================================================================


const path = require("path");
const fs = require("fs");
const ApiError = require("../../../error/ApiError");
const DefectRecordService = require("../services/DefectRecordService");


const DEFECT_FILES_DIR = path.join(__dirname, "../../../static/defect-records");


if (!fs.existsSync(DEFECT_FILES_DIR)) {
    fs.mkdirSync(DEFECT_FILES_DIR, { recursive: true });
}

class DefectRecordController {


    async getAll(req, res, next) {
        try {
            const filters = {
                serverId: req.query.serverId,
                status: req.query.status,
                repairPartType: req.query.repairPartType,
                diagnosticianId: req.query.diagnosticianId,
                isRepeatedDefect: req.query.isRepeatedDefect === "true" ? true :
                                  req.query.isRepeatedDefect === "false" ? false : undefined,
                dateFrom: req.query.dateFrom,
                dateTo: req.query.dateTo,
                search: req.query.search,
                slaBreached: req.query.slaBreached === "true",
                limit: parseInt(req.query.limit) || 50,
                offset: parseInt(req.query.offset) || 0
            };

            const result = await DefectRecordService.getAll(filters);
            return res.json(result);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }

    async getById(req, res, next) {
        try {
            const { id } = req.params;
            const defect = await DefectRecordService.getById(id);

            if (!defect) {
                return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }

            return res.json(defect);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }

    async create(req, res, next) {
        try {
            const userId = req.user?.id;
            const defect = await DefectRecordService.create(req.body, userId);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async update(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.getById(id);
            if (!defect) {
                return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }

            const updated = await DefectRecordService.update(id, req.body, userId);
            return res.json(updated);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async delete(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.getById(id);
            if (!defect) {
                return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }

            await DefectRecordService.delete(id, userId);
            return res.json({ success: true, message: "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" });
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async changeStatus(req, res, next) {
        try {
            const { id } = req.params;
            const { status, notes } = req.body;
            const userId = req.user?.id;

            if (!status) {
                return next(ApiError.badRequest("–°—Ç–∞—Ç—É—Å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
            }

            const defect = await DefectRecordService.changeStatus(id, status, userId, notes);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async markAsRepeated(req, res, next) {
        try {
            const { id } = req.params;
            const { originalDefectId, notes } = req.body;
            const userId = req.user?.id;

            const defect = await DefectRecordService.markAsRepeated(id, originalDefectId, userId, notes);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }


    async startDiagnosis(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.startDiagnosis(id, userId);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async completeDiagnosis(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.completeDiagnosis(id, userId, req.body);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }


    async setWaitingParts(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;
            const { notes } = req.body;

            const defect = await DefectRecordService.setWaitingParts(id, userId, notes);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async reserveComponent(req, res, next) {
        try {
            const { id } = req.params;
            const { inventoryId } = req.body;
            const userId = req.user?.id;

            if (!inventoryId) {
                return next(ApiError.badRequest("inventoryId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
            }

            const defect = await DefectRecordService.reserveReplacementComponent(id, inventoryId, userId);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }


    async startRepair(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.startRepair(id, userId);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async performReplacement(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.performComponentReplacement(id, userId, req.body);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }


    async sendToYadro(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.sendToYadro(id, userId, req.body);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async returnFromYadro(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.returnFromYadro(id, userId, req.body);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }


    async issueSubstitute(req, res, next) {
        try {
            const { id } = req.params;
            const { substituteServerId } = req.body;
            const userId = req.user?.id;

            const defect = await DefectRecordService.issueSubstituteServer(id, userId, substituteServerId);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }

    async returnSubstitute(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.returnSubstituteServer(id, userId);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }


    async resolve(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.resolve(id, userId, req.body);
            return res.json(defect);
        } catch (error) {
            next(ApiError.badRequest(error.message));
        }
    }


    async getFiles(req, res, next) {
        try {
            const { id } = req.params;

            const defect = await DefectRecordService.getById(id);
            if (!defect) {
                return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }

            const files = await DefectRecordService.getFiles(id);
            return res.json(files);
        } catch (error) {
            console.error("[DefectRecordController] getFiles error:", error);
            next(ApiError.internal(error.message));
        }
    }

    async uploadFile(req, res, next) {
        try {
            const { id } = req.params;
            const userId = req.user?.id;

            const defect = await DefectRecordService.getById(id);
            if (!defect) {
                return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }

            if (!req.files || !req.files.file) {
                return next(ApiError.badRequest("–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"));
            }

            const file = req.files.file;

            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                return next(ApiError.badRequest("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 50MB)"));
            }

            const recordDir = path.join(DEFECT_FILES_DIR, String(id));
            if (!fs.existsSync(recordDir)) {
                fs.mkdirSync(recordDir, { recursive: true });
            }

            const ext = path.extname(file.name);
            const timestamp = Date.now();
            const safeOriginalName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
            const fileName = `${timestamp}_${safeOriginalName}`;
            const filePath = path.join(recordDir, fileName);

            await file.mv(filePath);

            const fileRecord = await DefectRecordService.addFile(id, {
                fileName,
                originalName: file.name,
                filePath: path.join(String(id), fileName),
                mimeType: file.mimetype,
                fileSize: file.size,
                uploadedById: userId
            });

            return res.json({
                success: true,
                file: fileRecord
            });
        } catch (error) {
            console.error("[DefectRecordController] uploadFile error:", error);
            next(ApiError.internal(error.message));
        }
    }

    async downloadFile(req, res, next) {
        try {
            const { fileId } = req.params;

            const fileRecord = await DefectRecordService.getFileById(fileId);
            if (!fileRecord) {
                return next(ApiError.notFound("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"));
            }

            const fullPath = path.join(DEFECT_FILES_DIR, fileRecord.filePath);

            if (!fs.existsSync(fullPath)) {
                return next(ApiError.notFound("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –¥–∏—Å–∫–µ"));
            }

            res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(fileRecord.originalName)}"`);
            res.setHeader('Content-Type', fileRecord.mimeType || 'application/octet-stream');

            return res.download(fullPath, fileRecord.originalName);
        } catch (error) {
            console.error("[DefectRecordController] downloadFile error:", error);
            next(ApiError.internal(error.message));
        }
    }

    async deleteFile(req, res, next) {
        try {
            const { fileId } = req.params;
            const userId = req.user?.id;

            const fileRecord = await DefectRecordService.getFileById(fileId);
            if (!fileRecord) {
                return next(ApiError.notFound("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"));
            }

            const fullPath = path.join(DEFECT_FILES_DIR, fileRecord.filePath);
            if (fs.existsSync(fullPath)) {
                fs.unlinkSync(fullPath);
            }

            await DefectRecordService.deleteFile(fileId, userId);

            return res.json({
                success: true,
                message: "–§–∞–π–ª —É–¥–∞–ª—ë–Ω"
            });
        } catch (error) {
            console.error("[DefectRecordController] deleteFile error:", error);
            next(ApiError.internal(error.message));
        }
    }


    async getRepairPartTypes(req, res, next) {
        try {
            const types = DefectRecordService.getRepairPartTypes();
            return res.json(types);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }

    async getStatuses(req, res, next) {
        try {
            const statuses = DefectRecordService.getStatuses();
            return res.json(statuses);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }


    async getStats(req, res, next) {
        try {
            const filters = {
                dateFrom: req.query.dateFrom,
                dateTo: req.query.dateTo,
                serverId: req.query.serverId
            };

            const stats = await DefectRecordService.getStats(filters);
            return res.json(stats);
        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }
}

module.exports = new DefectRecordController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/DhcpController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const DhcpService = require("../services/DhcpService");

class DhcpController {
  async syncWithDhcp(req, res, next) {
    try {
      const userId = req.user?.id;
      const result = await DhcpService.syncWithDhcp(userId);
      return res.json(result);
    } catch (e) {
      console.error("DHCP Sync Error:", e);
      return next(ApiError.internal(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å DHCP: ${e.message}`));
    }
  }
}

module.exports = new DhcpController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/FileController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const FileService = require("../services/FileService");

class FileController {
  async uploadChecklistFile(req, res, next) {
    try {
      const { serverId, checklistId } = req.params;
      const userId = req.user.id;

      if (!req.files || !req.files.file) {
        return next(ApiError.badRequest("–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"));
      }

      const file = req.files.file;
      const result = await FileService.uploadChecklistFile(serverId, checklistId, file, userId);

      return res.json(result);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω" || e.message === "–ü—É–Ω–∫—Ç —á–µ–∫-–ª–∏—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async getServerFiles(req, res, next) {
    try {
      const { serverId } = req.params;
      const files = await FileService.getServerFiles(serverId);
      return res.json(files);
    } catch (e) {
      console.error(e);
      return next(ApiError.internal(e.message));
    }
  }

  async downloadFile(req, res, next) {
    try {
      const { fileId } = req.params;
      const { fullPath, originalName } = await FileService.getFileForDownload(fileId);

      return res.download(fullPath, originalName);
    } catch (e) {
      console.error(e);
      if (e.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")) {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }
}

module.exports = new FileController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/HistoryController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const HistoryService = require("../services/HistoryService");

class HistoryController {
  async getHistory(req, res, next) {
    try {
      const result = await HistoryService.getHistory(req.query);
      return res.json(result);
    } catch (e) {
      console.error(e);
      return next(ApiError.internal(e.message));
    }
  }
}

module.exports = new HistoryController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/ImportController.js
================================================================================

const ApiError = require("../../error/ApiError");
const ExcelImportService = require("../../services/ExcelImportService");
const path = require("path");
const fs = require("fs");

const UPLOADS_DIR = path.join(__dirname, "../../../uploads/imports");

class ImportController {

    async importServerComponents(req, res, next) {
        try {
            if (!req.files || !req.files.file) {
                return next(ApiError.badRequest("–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"));
            }

            const file = req.files.file;
            const dryRun = req.body.dryRun === "true";
            const skipExisting = req.body.skipExisting !== "false";


            const ext = path.extname(file.name).toLowerCase();
            if (![".xlsx", ".xls", ".xlsm"].includes(ext)) {
                return next(ApiError.badRequest("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .xlsx, .xls –∏–ª–∏ .xlsm"));
            }


            if (!fs.existsSync(UPLOADS_DIR)) {
                fs.mkdirSync(UPLOADS_DIR, { recursive: true });
            }

            const tempPath = path.join(UPLOADS_DIR, `${Date.now()}_${file.name}`);
            await file.mv(tempPath);

            try {

                const results = await ExcelImportService.importServerComponents(tempPath, {
                    dryRun,
                    skipExisting
                });

                fs.unlinkSync(tempPath);

                return res.json({
                    success: true,
                    dryRun,
                    summary: {
                        serversCreated: results.servers.filter(s => s.action === "created").length,
                        serversExisting: results.servers.filter(s => s.action === "exists").length,
                        componentsCreated: results.components.length,
                        skipped: results.skipped.length,
                        errors: results.errors.length
                    },
                    details: results
                });

            } catch (importError) {
                if (fs.existsSync(tempPath)) {
                    fs.unlinkSync(tempPath);
                }
                throw importError;
            }

        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }

    async importDefectRecords(req, res, next) {
        try {
            if (!req.files || !req.files.file) {
                return next(ApiError.badRequest("–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"));
            }

            const file = req.files.file;
            const dryRun = req.body.dryRun === "true";

            const ext = path.extname(file.name).toLowerCase();
            if (![".xlsx", ".xls", ".xlsm"].includes(ext)) {
                return next(ApiError.badRequest("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .xlsx, .xls –∏–ª–∏ .xlsm"));
            }

            if (!fs.existsSync(UPLOADS_DIR)) {
                fs.mkdirSync(UPLOADS_DIR, { recursive: true });
            }

            const tempPath = path.join(UPLOADS_DIR, `${Date.now()}_${file.name}`);
            await file.mv(tempPath);

            try {

                const results = await ExcelImportService.importDefectRecords(tempPath, {
                    dryRun
                });


                fs.unlinkSync(tempPath);

                return res.json({
                    success: true,
                    dryRun,
                    summary: {
                        recordsCreated: results.records.length,
                        skipped: results.skipped.length,
                        errors: results.errors.length
                    },
                    details: results
                });

            } catch (importError) {
                if (fs.existsSync(tempPath)) {
                    fs.unlinkSync(tempPath);
                }
                throw importError;
            }

        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }


    async downloadServerComponentsTemplate(req, res, next) {
        try {
            const XLSX = require("xlsx");


            const headers = [
                "S/N —Å–µ—Ä–≤–µ—Ä–∞",
                ...Array.from({ length: 12 }, (_, i) => `HDD_${i + 1} (Yadro S/N)`),
                ...Array.from({ length: 12 }, (_, i) => `RAM_${i + 1} (Yadro S/N)`),
                ...Array.from({ length: 4 }, (_, i) => `SSD_${i + 1} (Yadro S/N)`),
                "PSU_1 (Yadro S/N)", "PSU_1 (Manuf S/N)",
                "PSU_2 (Yadro S/N)", "PSU_2 (Manuf S/N)"
            ];

            const exampleRow = [
                "APK12345678",
                "Y1P6A0GN2E02B", "Y1P6A0GN2E02C", "", "", "", "", "", "", "", "", "", "",
                "Y1RAM001", "Y1RAM002", "", "", "", "", "", "", "", "", "", "",
                "Y1SSD001", "", "", "",
                "Y1PSU001", "MANUF001",
                "Y1PSU002", "MANUF002"
            ];

            const ws = XLSX.utils.aoa_to_sheet([headers, exampleRow]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–µ—Ä–≤–µ—Ä–æ–≤");

            const buffer = XLSX.write(wb, { type: "buffer", bookType: "xlsx" });

            res.setHeader("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            res.setHeader("Content-Disposition", "attachment; filename=template_server_components.xlsx");
            res.send(buffer);

        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }


    async downloadDefectRecordsTemplate(req, res, next) {
        try {
            const XLSX = require("xlsx");

            const headers = [
                "‚Ññ –∑–∞—è–≤–∫–∏",
                "S/N —Å–µ—Ä–≤–µ—Ä",
                "–ö–ª–∞—Å—Ç–µ—Ä",
                "–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è",
                "–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
                "–¢–∏–ø –¥–µ—Ç–∞–ª–∏",
                "S/N –±—Ä–∞–∫–æ–≤–æ–π –¥–µ—Ç–∞–ª–∏",
                "S/N –∑–∞–º–µ–Ω—ã",
                "–°—Ç–∞—Ç—É—Å",
                "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫"
            ];

            const exampleRow = [
                "INC123456",
                "APK12345678",
                "cl1-master1",
                "2025-01-15",
                "–°–±–æ–π HDD –≤ —Å–ª–æ—Ç–µ 3",
                "HDD",
                "Y1P6A0GN2E02B",
                "Y1P6A0GN2E02C",
                "–†–µ—à—ë–Ω",
                "–ò–≤–∞–Ω–æ–≤ –ò.–ò."
            ];

            const ws = XLSX.utils.aoa_to_sheet([headers, exampleRow]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "–ó–∞–ø–∏—Å–∏ –æ –±—Ä–∞–∫–µ");

            const buffer = XLSX.write(wb, { type: "buffer", bookType: "xlsx" });

            res.setHeader("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            res.setHeader("Content-Disposition", "attachment; filename=template_defect_records.xlsx");
            res.send(buffer);

        } catch (error) {
            next(ApiError.internal(error.message));
        }
    }
}

module.exports = new ImportController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/PassportController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const PassportService = require("../services/PassportService");

class PassportController {
  async generatePassport(req, res, next) {
    try {
      const { id } = req.params;
      const { buffer, fileName } = await PassportService.generatePassport(id);

      res.setHeader("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
      res.setHeader("Content-Disposition", `attachment; filename="${encodeURIComponent(fileName)}"`);
      res.setHeader("Content-Length", buffer.length);

      return res.send(buffer);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }
}

module.exports = new PassportController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/PingController.js
================================================================================



const PingController = require("../controllers/beryll/controllers/PingController");


router.get(
  "/monitoring/stats",
  ...protect,
  checkAbility("beryll.view"),
  PingController.getMonitoringStats.bind(PingController)
);


router.get(
  "/monitoring/status",
  ...protect,
  checkAbility("beryll.view"),
  PingController.getCachedStatus.bind(PingController)
);


router.get(
  "/monitoring/ping/:id",
  ...protect,
  checkAbility("beryll.view"),
  PingController.pingServer.bind(PingController)
);


router.post(
  "/monitoring/ping-all",
  ...protect,
  checkAbility("beryll.work"),
  PingController.pingAllServers.bind(PingController)
);


router.get(
  "/monitoring/servers/online",
  ...protect,
  checkAbility("beryll.view"),
  PingController.getOnlineServers.bind(PingController)
);


router.get(
  "/monitoring/servers/offline",
  ...protect,
  checkAbility("beryll.view"),
  PingController.getOfflineServers.bind(PingController)
);


router.post(
  "/monitoring/clear-cache",
  ...protect,
  checkAbility("beryll.manage"),
  PingController.clearCache.bind(PingController)
);

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/RackController.js
================================================================================


const RackService = require("../services/RackService");
const ApiError = require("../../../error/ApiError");

class RackController {


  async getAllRacks(req, res, next) {
    try {
      const { status, search, includeUnits } = req.query;
      const racks = await RackService.getAllRacks({
        status,
        search,
        includeUnits: includeUnits === "true"
      });
      res.json(racks);
    } catch (error) {
      console.error("[RackController] getAllRacks error:", error);
      next(ApiError.internal(error.message));
    }
  }

  async getRackById(req, res, next) {
    try {
      const { id } = req.params;
      const rack = await RackService.getRackById(id);

      if (!rack) {
        return next(ApiError.notFound("–°—Ç–æ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      res.json(rack);
    } catch (error) {
      console.error("[RackController] getRackById error:", error);
      next(ApiError.internal(error.message));
    }
  }

  async createRack(req, res, next) {
    try {
      const userId = req.user?.id;
      const rack = await RackService.createRack(req.body, userId);
      res.status(201).json(rack);
    } catch (error) {
      console.error("[RackController] createRack error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async updateRack(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const rack = await RackService.updateRack(id, req.body, userId);
      res.json(rack);
    } catch (error) {
      console.error("[RackController] updateRack error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async deleteRack(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const result = await RackService.deleteRack(id, userId);
      res.json(result);
    } catch (error) {
      console.error("[RackController] deleteRack error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async getRackHistory(req, res, next) {
    try {
      const { id } = req.params;
      const { limit, offset } = req.query;

      const history = await RackService.getHistory("RACK", id, {
        limit: parseInt(limit) || 50,
        offset: parseInt(offset) || 0
      });

      res.json(history);
    } catch (error) {
      console.error("[RackController] getRackHistory error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async getRackSummary(req, res, next) {
    try {
      const { rackId } = req.params;
      const summary = await RackService.getRackSummary(parseInt(rackId));
      res.json(summary);
    } catch (error) {
      console.error("[RackController] getRackSummary error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async getFreeUnits(req, res, next) {
    try {
      const { rackId } = req.params;
      const units = await RackService.getFreeUnits(rackId);
      res.json(units);
    } catch (error) {
      console.error("[RackController] getFreeUnits error:", error);
      next(ApiError.internal(error.message));
    }
  }

  async getUnit(req, res, next) {
    try {
      const { rackId, unitNumber } = req.params;
      const unit = await RackService.getUnitByNumber(parseInt(rackId), parseInt(unitNumber));

      if (!unit) {
        return next(ApiError.notFound("–Æ–Ω–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      res.json(unit);
    } catch (error) {
      console.error("[RackController] getUnit error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async getUnitsByStatus(req, res, next) {
    try {
      const { rackId } = req.params;
      const { status } = req.query;

      const units = await RackService.getUnitsByServerStatus(parseInt(rackId), status);
      res.json(units);
    } catch (error) {
      console.error("[RackController] getUnitsByStatus error:", error);
      next(ApiError.internal(error.message));
    }
  }


  async placeServer(req, res, next) {
    try {
      const { rackId, unitNumber } = req.params;
      const { serverId } = req.body;
      const userId = req.user?.id;

      if (!serverId) {
        return next(ApiError.badRequest("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å serverId"));
      }

      const unit = await RackService.placeServerInRack(
        parseInt(rackId),
        parseInt(unitNumber),
        serverId,
        userId
      );

      res.json(unit);
    } catch (error) {
      console.error("[RackController] placeServer error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async installServer(req, res, next) {
    try {
      const { rackId, unitNumber } = req.params;
      const { serverId, ...data } = req.body;
      const userId = req.user?.id;

      if (!serverId) {
        return next(ApiError.badRequest("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å serverId"));
      }

      const unit = await RackService.installServer(
        parseInt(rackId),
        parseInt(unitNumber),
        serverId,
        data,
        userId
      );

      res.json(unit);
    } catch (error) {
      console.error("[RackController] installServer error:", error);
      next(ApiError.badRequest(error.message));
    }
  }

  async removeServer(req, res, next) {
    try {
      const { rackId, unitNumber } = req.params;
      const userId = req.user?.id;

      const result = await RackService.removeServer(
        parseInt(rackId),
        parseInt(unitNumber),
        userId
      );

      res.json(result);
    } catch (error) {
      console.error("[RackController] removeServer error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async updateUnit(req, res, next) {
    try {
      const { unitId } = req.params;
      const userId = req.user?.id;
      const unit = await RackService.updateUnit(unitId, req.body, userId);
      res.json(unit);
    } catch (error) {
      console.error("[RackController] updateUnit error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async moveServer(req, res, next) {
    try {
      const { fromRackId, fromUnit, toRackId, toUnit } = req.body;
      const userId = req.user?.id;

      if (!fromRackId || !fromUnit || !toRackId || !toUnit) {
        return next(ApiError.badRequest("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: fromRackId, fromUnit, toRackId, toUnit"));
      }

      const unit = await RackService.moveServer(fromRackId, fromUnit, toRackId, toUnit, userId);
      res.json(unit);
    } catch (error) {
      console.error("[RackController] moveServer error:", error);
      next(ApiError.badRequest(error.message));
    }
  }

  async findServerInRacks(req, res, next) {
    try {
      const { serverId } = req.params;
      const location = await RackService.findServerInRacks(serverId);
      res.json(location || { found: false });
    } catch (error) {
      console.error("[RackController] findServerInRacks error:", error);
      next(ApiError.internal(error.message));
    }
  }

  async syncWithDhcp(req, res, next) {
    try {
      const { rackId } = req.params;
      const userId = req.user?.id;

      const result = await RackService.syncRackWithDhcp(parseInt(rackId), userId);
      res.json(result);
    } catch (error) {
      console.error("[RackController] syncWithDhcp error:", error);
      next(ApiError.internal(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å DHCP: ${error.message}`));
    }
  }

  async findIpByMac(req, res, next) {
    try {
      const { mac } = req.params;

      if (!mac) {
        return next(ApiError.badRequest("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å MAC –∞–¥—Ä–µ—Å"));
      }

      const result = await RackService.findIpByMac(mac);
      res.json(result);
    } catch (error) {
      console.error("[RackController] findIpByMac error:", error);
      next(ApiError.internal(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ IP: ${error.message}`));
    }
  }

  async createServer(req, res, next) {
    try {
      const userId = req.user?.id;
      const server = await RackService.createServerManually(req.body, userId);
      res.status(201).json(server);
    } catch (error) {
      console.error("[RackController] createServer error:", error);
      next(ApiError.badRequest(error.message));
    }
  }

  async createAndPlaceServer(req, res, next) {
    try {
      const userId = req.user?.id;
      const server = await RackService.createAndPlaceServer(req.body, userId);
      res.status(201).json(server);
    } catch (error) {
      console.error("[RackController] createAndPlaceServer error:", error);
      next(ApiError.badRequest(error.message));
    }
  }


  async findServerInDhcp(req, res, next) {
    try {
      const { serial } = req.params;

      if (!serial) {
        return next(ApiError.badRequest("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä"));
      }

      const result = await RackService.findServerInDhcp(serial);
      res.json(result);
    } catch (error) {
      console.error("[RackController] findServerInDhcp error:", error);
      next(ApiError.internal(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ DHCP: ${error.message}`));
    }
  }
}

module.exports = new RackController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/ServerController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const ServerService = require("../services/ServerService");

class ServerController {
  async getServers(req, res, next) {
    try {
      const servers = await ServerService.getServers(req.query);
      return res.json(servers);
    } catch (e) {
      console.error(e);
      return next(ApiError.internal(e.message));
    }
  }

  async getServerById(req, res, next) {
    try {
      const { id } = req.params;
      const server = await ServerService.getServerById(id);

      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      return res.json(server);
    } catch (e) {
      console.error(e);
      return next(ApiError.internal(e.message));
    }
  }


  async takeServer(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const userRole = req.user?.role;

      if (!userId) {
        return next(ApiError.unauthorized("–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"));
      }

      const updated = await ServerService.takeServer(id, userId, userRole);
      return res.json(updated);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      if (e.message === "–°–µ—Ä–≤–µ—Ä —É–∂–µ –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É" ||
          e.message === "–°–µ—Ä–≤–µ—Ä —É–∂–µ –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º" ||
          e.message === "–°–µ—Ä–≤–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω –¥—Ä—É–≥–æ–º—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é" ||
          e.message.includes("–ù–µ–ª—å–∑—è –≤–∑—è—Ç—å")) {
        return next(ApiError.badRequest(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }


  async releaseServer(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;
      const userRole = req.user?.role;

      const server = await ServerService.releaseServer(id, userId, userRole);
      return res.json(server);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      if (e.message.includes("–ù–µ—Ç –ø—Ä–∞–≤")) {
        return next(ApiError.forbidden(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async updateStatus(req, res, next) {
    try {
      const { id } = req.params;
      const { status, notes } = req.body;
      const userId = req.user?.id;

      const { SERVER_STATUSES } = require("../../../models/definitions/Beryll");

      if (!status || !Object.values(SERVER_STATUSES).includes(status)) {
        return next(ApiError.badRequest("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å"));
      }

      const updated = await ServerService.updateStatus(id, status, notes, userId);
      return res.json(updated);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async updateNotes(req, res, next) {
    try {
      const { id } = req.params;
      const { notes } = req.body;
      const userId = req.user?.id;

      const server = await ServerService.updateNotes(id, notes, userId);
      return res.json(server);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }

  async deleteServer(req, res, next) {
    try {
      const { id } = req.params;
      const userId = req.user?.id;

      const result = await ServerService.deleteServer(id, userId);
      return res.json(result);
    } catch (e) {
      console.error(e);
      if (e.message === "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω") {
        return next(ApiError.notFound(e.message));
      }
      return next(ApiError.internal(e.message));
    }
  }
}

module.exports = new ServerController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/StatsController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const StatsService = require("../services/StatsService");

class StatsController {
  async getStats(req, res, next) {
    try {
      const stats = await StatsService.getStats();
      return res.json(stats);
    } catch (e) {
      console.error(e);
      return next(ApiError.internal(e.message));
    }
  }

  async getAnalytics(req, res, next) {
    try {
      const analytics = await StatsService.getAnalytics(req.query);
      return res.json(analytics);
    } catch (e) {
      console.error(e);
      return next(ApiError.internal(e.message));
    }
  }
}

module.exports = new StatsController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/controllers/YadroController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const { Op } = require("sequelize");
const {
  YadroTicketLog,
  SubstituteServerPool,
  SlaConfig,
  UserAlias,
  BeryllServer,
  BeryllDefectRecord,
  User,
  YADRO_REQUEST_TYPES,
  YADRO_LOG_STATUSES,
  SUBSTITUTE_STATUSES
} = require("../../../models/index");

class YadroController {

  async getAllLogs(req, res, next) {
    try {
      const {
        status,
        requestType,
        defectRecordId,
        serverId,
        dateFrom,
        dateTo,
        search,
        limit = 50,
        offset = 0
      } = req.query;

      const where = {};

      if (status) where.status = status;
      if (requestType) where.requestType = requestType;
      if (defectRecordId) where.defectRecordId = defectRecordId;
      if (serverId) where.serverId = serverId;

      if (dateFrom || dateTo) {
        where.sentAt = {};
        if (dateFrom) where.sentAt[Op.gte] = new Date(dateFrom);
        if (dateTo) where.sentAt[Op.lte] = new Date(dateTo);
      }

      if (search) {
        where[Op.or] = [
          { ticketNumber: { [Op.iLike]: `%${search}%` } },
          { problemDescription: { [Op.iLike]: `%${search}%` } },
          { sentComponentSerialYadro: { [Op.iLike]: `%${search}%` } },
          { sentComponentSerialManuf: { [Op.iLike]: `%${search}%` } }
        ];
      }

      const result = await YadroTicketLog.findAndCountAll({
        where,
        include: [
          { model: BeryllServer, as: "server", attributes: ["id", "apkSerialNumber", "hostname"] },
          { model: BeryllDefectRecord, as: "defectRecord", attributes: ["id", "status", "problemDescription"] },
          { model: User, as: "createdBy", attributes: ["id", "name", "surname"] }
        ],
        order: [["createdAt", "DESC"]],
        limit: parseInt(limit),
        offset: parseInt(offset)
      });

      return res.json(result);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async getLogById(req, res, next) {
    try {
      const { id } = req.params;

      const log = await YadroTicketLog.findByPk(id, {
        include: [
          { model: BeryllServer, as: "server" },
          { model: BeryllDefectRecord, as: "defectRecord" },
          { model: User, as: "createdBy", attributes: ["id", "name", "surname"] }
        ]
      });

      if (!log) {
        return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      return res.json(log);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async createLog(req, res, next) {
    try {
      const userId = req.user?.id;
      const {
        ticketNumber,
        defectRecordId,
        serverId,
        serverSerial,
        requestType,
        componentType,
        sentComponentSerialYadro,
        sentComponentSerialManuf,
        sentAt,
        problemDescription,
        notes
      } = req.body;

      if (!ticketNumber) {
        return next(ApiError.badRequest("–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
      }

      let finalServerId = serverId;
      if (serverSerial && !finalServerId) {
        const server = await BeryllServer.findOne({
          where: {
            [Op.or]: [
              { apkSerialNumber: serverSerial },
              { apkSerialNumber: { [Op.iLike]: `%${serverSerial}%` } }
            ]
          }
        });
        if (server) {
          finalServerId = server.id;
        }
      }

      const log = await YadroTicketLog.create({
        ticketNumber,
        defectRecordId,
        serverId: finalServerId,
        requestType: requestType || YADRO_REQUEST_TYPES.COMPONENT_REPAIR,
        status: YADRO_LOG_STATUSES.SENT,
        componentType,
        sentComponentSerialYadro,
        sentComponentSerialManuf,
        sentAt: sentAt ? new Date(sentAt) : new Date(),
        problemDescription,
        notes,
        createdById: userId
      });

      if (defectRecordId) {
        await BeryllDefectRecord.update(
          {
            sentToYadroRepair: true,
            sentToYadroAt: new Date(),
            yadroTicketNumber: ticketNumber
          },
          { where: { id: defectRecordId } }
        );
      }

      const created = await YadroTicketLog.findByPk(log.id, {
        include: [
          { model: BeryllServer, as: "server", attributes: ["id", "apkSerialNumber", "hostname"] }
        ]
      });

      return res.json(created);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async updateLog(req, res, next) {
    try {
      const { id } = req.params;
      const {
        ticketNumber,
        serverId,
        serverSerial,
        defectRecordId,
        requestType,
        status,
        componentType,
        sentComponentSerialYadro,
        sentComponentSerialManuf,
        receivedComponentSerialYadro,
        receivedComponentSerialManuf,
        sentAt,
        receivedAt,
        problemDescription,
        yadroResponse,
        notes
      } = req.body;

      const log = await YadroTicketLog.findByPk(id);
      if (!log) {
        return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      const updateData = {};

      if (ticketNumber !== undefined) updateData.ticketNumber = ticketNumber;
      if (defectRecordId !== undefined) updateData.defectRecordId = defectRecordId;
      if (requestType !== undefined) updateData.requestType = requestType;
      if (status !== undefined) updateData.status = status;
      if (componentType !== undefined) updateData.componentType = componentType;
      if (sentComponentSerialYadro !== undefined) updateData.sentComponentSerialYadro = sentComponentSerialYadro;
      if (sentComponentSerialManuf !== undefined) updateData.sentComponentSerialManuf = sentComponentSerialManuf;
      if (receivedComponentSerialYadro !== undefined) updateData.receivedComponentSerialYadro = receivedComponentSerialYadro;
      if (receivedComponentSerialManuf !== undefined) updateData.receivedComponentSerialManuf = receivedComponentSerialManuf;
      if (sentAt !== undefined) updateData.sentAt = sentAt ? new Date(sentAt) : null;
      if (receivedAt !== undefined) updateData.receivedAt = receivedAt ? new Date(receivedAt) : null;
      if (problemDescription !== undefined) updateData.problemDescription = problemDescription;
      if (yadroResponse !== undefined) updateData.yadroResponse = yadroResponse;
      if (notes !== undefined) updateData.notes = notes;

      if (serverId !== undefined) {
        updateData.serverId = serverId;
      } else if (serverSerial) {
        const server = await BeryllServer.findOne({
          where: {
            [Op.or]: [
              { apkSerialNumber: serverSerial },
              { apkSerialNumber: { [Op.iLike]: `%${serverSerial}%` } }
            ]
          }
        });
        if (server) {
          updateData.serverId = server.id;
        }
      }

      await log.update(updateData);

      const updated = await YadroTicketLog.findByPk(id, {
        include: [
          { model: BeryllServer, as: "server", attributes: ["id", "apkSerialNumber", "hostname"] },
          { model: BeryllDefectRecord, as: "defectRecord", attributes: ["id", "status", "problemDescription"] }
        ]
      });

      return res.json(updated);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async updateLogStatus(req, res, next) {
    try {
      const { id } = req.params;
      const {
        status,
        yadroResponse,
        receivedComponentSerialYadro,
        receivedComponentSerialManuf,
        notes
      } = req.body;

      const log = await YadroTicketLog.findByPk(id);
      if (!log) {
        return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      const updateData = { status };

      switch (status) {
        case YADRO_LOG_STATUSES.IN_PROGRESS:
          break;

        case YADRO_LOG_STATUSES.COMPLETED:
          if (yadroResponse) updateData.yadroResponse = yadroResponse;
          break;

        case YADRO_LOG_STATUSES.RECEIVED:
          updateData.receivedAt = new Date();
          if (receivedComponentSerialYadro) updateData.receivedComponentSerialYadro = receivedComponentSerialYadro;
          if (receivedComponentSerialManuf) updateData.receivedComponentSerialManuf = receivedComponentSerialManuf;
          if (yadroResponse) updateData.yadroResponse = yadroResponse;

          if (log.defectRecordId) {
            await BeryllDefectRecord.update(
              {
                returnedFromYadro: true,
                returnedFromYadroAt: new Date(),
                replacementPartSerialYadro: receivedComponentSerialYadro,
                replacementPartSerialManuf: receivedComponentSerialManuf
              },
              { where: { id: log.defectRecordId } }
            );
          }
          break;

        case YADRO_LOG_STATUSES.CLOSED:
          if (notes) updateData.notes = (log.notes ? log.notes + "\n" : "") + notes;
          break;
      }

      await log.update(updateData);

      return res.json(log);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async deleteLog(req, res, next) {
    try {
      const { id } = req.params;

      const log = await YadroTicketLog.findByPk(id);
      if (!log) {
        return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      if (log.defectRecordId) {
        await BeryllDefectRecord.update(
          {
            sentToYadroRepair: false,
            yadroTicketNumber: null
          },
          { where: { id: log.defectRecordId } }
        );
      }

      await log.destroy();

      return res.json({ success: true, message: `–ó–∞–ø–∏—Å—å ${log.ticketNumber} —É–¥–∞–ª–µ–Ω–∞` });
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async linkLogToServer(req, res, next) {
    try {
      const { id } = req.params;
      const { serverSerial, serverId: directServerId } = req.body;

      const log = await YadroTicketLog.findByPk(id);
      if (!log) {
        return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      let serverId = directServerId;

      if (serverSerial && !serverId) {
        const server = await BeryllServer.findOne({
          where: {
            [Op.or]: [
              { apkSerialNumber: serverSerial },
              { apkSerialNumber: { [Op.iLike]: `%${serverSerial}%` } }
            ]
          }
        });

        if (!server) {
          return next(ApiError.notFound(`–°–µ—Ä–≤–µ—Ä —Å S/N "${serverSerial}" –Ω–µ –Ω–∞–π–¥–µ–Ω`));
        }

        serverId = server.id;
      }

      if (!serverId) {
        return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ serverId –∏–ª–∏ serverSerial"));
      }

      await log.update({ serverId });

      const updated = await YadroTicketLog.findByPk(id, {
        include: [
          { model: BeryllServer, as: "server", attributes: ["id", "apkSerialNumber", "hostname"] }
        ]
      });

      return res.json(updated);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async getOpenLogs(req, res, next) {
    try {
      const logs = await YadroTicketLog.getOpenRequests();
      return res.json(logs);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async getLogStats(req, res, next) {
    try {
      const { dateFrom, dateTo } = req.query;
      const stats = await YadroTicketLog.getStats(
        dateFrom ? new Date(dateFrom) : null,
        dateTo ? new Date(dateTo) : null
      );
      return res.json(stats);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async getAllSubstitutes(req, res, next) {
    try {
      const { status } = req.query;

      const where = {};
      if (status) where.status = status;

      const substitutes = await SubstituteServerPool.findAll({
        where,
        include: [
          { model: BeryllServer, as: "server", attributes: ["id", "apkSerialNumber", "hostname", "ipAddress"] },
          { model: User, as: "issuedTo", attributes: ["id", "name", "surname"] },
          { model: BeryllDefectRecord, as: "currentDefect", attributes: ["id", "status", "problemDescription"] }
        ],
        order: [["status", "ASC"], ["usageCount", "ASC"]]
      });

      return res.json(substitutes);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async getAvailableSubstitutes(req, res, next) {
    try {
      const substitutes = await SubstituteServerPool.getAvailable();
      return res.json(substitutes);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async addToSubstitutePool(req, res, next) {
    try {
      const { serverId, notes } = req.body;

      if (!serverId) {
        return next(ApiError.badRequest("serverId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
      }

      const server = await BeryllServer.findByPk(serverId);
      if (!server) {
        return next(ApiError.notFound("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const existing = await SubstituteServerPool.findOne({ where: { serverId } });
      if (existing) {
        return next(ApiError.badRequest("–°–µ—Ä–≤–µ—Ä —É–∂–µ –≤ –ø—É–ª–µ –ø–æ–¥–º–µ–Ω–Ω—ã—Ö"));
      }

      const substitute = await SubstituteServerPool.create({
        serverId,
        status: SUBSTITUTE_STATUSES.AVAILABLE,
        notes
      });

      await server.update({
        isSubstitutePool: true,
        substitutePoolAddedAt: new Date()
      });

      return res.json(substitute);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async removeFromSubstitutePool(req, res, next) {
    try {
      const { id } = req.params;

      const substitute = await SubstituteServerPool.findByPk(id);
      if (!substitute) {
        return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      if (substitute.status === SUBSTITUTE_STATUSES.IN_USE) {
        return next(ApiError.badRequest("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å - —Å–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –ø–æ–¥–º–µ–Ω–Ω—ã–π"));
      }

      await BeryllServer.update(
        { isSubstitutePool: false },
        { where: { id: substitute.serverId } }
      );

      await substitute.destroy();

      return res.json({ success: true });
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async issueSubstitute(req, res, next) {
    try {
      const { id } = req.params;
      const { defectId } = req.body;
      const userId = req.user?.id;

      if (!defectId) {
        return next(ApiError.badRequest("defectId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"));
      }

      const substitute = await SubstituteServerPool.findByPk(id);
      if (!substitute) {
        return next(ApiError.notFound("–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await substitute.issue(defectId, userId);

      return res.json(substitute);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async returnSubstitute(req, res, next) {
    try {
      const { id } = req.params;

      const substitute = await SubstituteServerPool.findByPk(id);
      if (!substitute) {
        return next(ApiError.notFound("–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await substitute.return();

      return res.json(substitute);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async setSubstituteMaintenance(req, res, next) {
    try {
      const { id } = req.params;
      const { notes } = req.body;

      const substitute = await SubstituteServerPool.findByPk(id);
      if (!substitute) {
        return next(ApiError.notFound("–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await substitute.setMaintenance(notes);

      return res.json(substitute);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async getSubstituteStats(req, res, next) {
    try {
      const stats = await SubstituteServerPool.getStats();
      return res.json(stats);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async getAllSlaConfigs(req, res, next) {
    try {
      const configs = await SlaConfig.findAll({
        where: { isActive: true },
        order: [["defectType", "ASC"], ["priority", "ASC"]]
      });
      return res.json(configs);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async createSlaConfig(req, res, next) {
    try {
      const config = await SlaConfig.create(req.body);
      return res.json(config);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async updateSlaConfig(req, res, next) {
    try {
      const { id } = req.params;

      const config = await SlaConfig.findByPk(id);
      if (!config) {
        return next(ApiError.notFound("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      await config.update(req.body);
      return res.json(config);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async deleteSlaConfig(req, res, next) {
    try {
      const { id } = req.params;

      const config = await SlaConfig.findByPk(id);
      if (!config) {
        return next(ApiError.notFound("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      await config.update({ isActive: false });
      return res.json({ success: true });
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async getAllAliases(req, res, next) {
    try {
      const { userId } = req.query;

      const where = { isActive: true };
      if (userId) where.userId = userId;

      const aliases = await UserAlias.findAll({
        where,
        include: [{ model: User, as: "user", attributes: ["id", "name", "surname", "login"] }],
        order: [["alias", "ASC"]]
      });

      return res.json(aliases);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async findUserByAlias(req, res, next) {
    try {
      const { alias } = req.params;

      const user = await UserAlias.findUserByAlias(alias);

      if (!user) {
        return next(ApiError.notFound("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –∞–ª–∏–∞—Å—É"));
      }

      return res.json(user);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async createAlias(req, res, next) {
    try {
      const { userId, alias, source } = req.body;

      if (!userId || !alias) {
        return next(ApiError.badRequest("userId –∏ alias –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã"));
      }

      const record = await UserAlias.create({
        userId,
        alias: alias.trim(),
        source: source || "manual",
        isActive: true
      });

      return res.json(record);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async deleteAlias(req, res, next) {
    try {
      const { id } = req.params;

      const alias = await UserAlias.findByPk(id);
      if (!alias) {
        return next(ApiError.notFound("–ê–ª–∏–∞—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await alias.update({ isActive: false });
      return res.json({ success: true });
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async generateAliasesForUser(req, res, next) {
    try {
      const { userId } = req.params;

      const user = await User.findByPk(userId);
      if (!user) {
        return next(ApiError.notFound("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const aliases = await UserAlias.generateAliasesFromUser(user);
      return res.json(aliases);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async getRequestTypes(req, res, next) {
    try {
      const types = Object.entries(YADRO_REQUEST_TYPES).map(([key, value]) => ({
        value,
        label: this.getRequestTypeLabel(value)
      }));
      return res.json(types);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  async getLogStatuses(req, res, next) {
    try {
      const statuses = Object.entries(YADRO_LOG_STATUSES).map(([key, value]) => ({
        value,
        label: this.getLogStatusLabel(value)
      }));
      return res.json(statuses);
    } catch (error) {
      next(ApiError.internal(error.message));
    }
  }

  getRequestTypeLabel(type) {
    const labels = {
      COMPONENT_REPAIR: "–†–µ–º–æ–Ω—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞",
      COMPONENT_EXCHANGE: "–û–±–º–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞",
      WARRANTY_CLAIM: "–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å–ª—É—á–∞–π",
      CONSULTATION: "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"
    };
    return labels[type] || type;
  }

  getLogStatusLabel(status) {
    const labels = {
      SENT: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",
      IN_PROGRESS: "–í —Ä–∞–±–æ—Ç–µ —É –Ø–¥—Ä–æ",
      COMPLETED: "–Ø–¥—Ä–æ –∑–∞–≤–µ—Ä—à–∏–ª",
      RECEIVED: "–ü–æ–ª—É—á–µ–Ω–æ –æ–±—Ä–∞—Ç–Ω–æ",
      CLOSED: "–ó–∞–∫—Ä—ã—Ç–æ"
    };
    return labels[status] || status;
  }
}

module.exports = new YadroController();

================================================================================
FILE: QMS-Server-master/controllers/beryll/index.js
================================================================================



const DhcpController = require("./controllers/DhcpController");
const ServerController = require("./controllers/ServerController");
const BatchController = require("./controllers/BatchController");
const ChecklistController = require("./controllers/ChecklistController");
const HistoryController = require("./controllers/HistoryController");
const ArchiveController = require("./controllers/ArchiveController");
const FileController = require("./controllers/FileController");
const PassportController = require("./controllers/PassportController");
const StatsController = require("./controllers/StatsController");
const DefectMonitoringController = require("./controllers/DefectMonitoringController");

const { initChecklistTemplates } = require("./services/ChecklistService");

class BeryllController {

  syncWithDhcp = DhcpController.syncWithDhcp.bind(DhcpController);


  getServers = ServerController.getServers.bind(ServerController);
  getServerById = ServerController.getServerById.bind(ServerController);
  takeServer = ServerController.takeServer.bind(ServerController);
  releaseServer = ServerController.releaseServer.bind(ServerController);
  updateStatus = ServerController.updateStatus.bind(ServerController);
  updateNotes = ServerController.updateNotes.bind(ServerController);
  deleteServer = ServerController.deleteServer.bind(ServerController);


  getBatches = BatchController.getBatches.bind(BatchController);
  getBatchById = BatchController.getBatchById.bind(BatchController);
  createBatch = BatchController.createBatch.bind(BatchController);
  updateBatch = BatchController.updateBatch.bind(BatchController);
  deleteBatch = BatchController.deleteBatch.bind(BatchController);
  assignServersToBatch = BatchController.assignServersToBatch.bind(BatchController);
  removeServersFromBatch = BatchController.removeServersFromBatch.bind(BatchController);


  getChecklistTemplates = ChecklistController.getChecklistTemplates.bind(ChecklistController);
  createChecklistTemplate = ChecklistController.createChecklistTemplate.bind(ChecklistController);
  updateChecklistTemplate = ChecklistController.updateChecklistTemplate.bind(ChecklistController);
  deleteChecklistTemplate = ChecklistController.deleteChecklistTemplate.bind(ChecklistController);
  toggleChecklistItem = ChecklistController.toggleChecklistItem.bind(ChecklistController);


  getHistory = HistoryController.getHistory.bind(HistoryController);


  getArchivedServers = ArchiveController.getArchivedServers.bind(ArchiveController);
  archiveServer = ArchiveController.archiveServer.bind(ArchiveController);
  unarchiveServer = ArchiveController.unarchiveServer.bind(ArchiveController);
  updateApkSerialNumber = ArchiveController.updateApkSerialNumber.bind(ArchiveController);


  uploadChecklistFile = FileController.uploadChecklistFile.bind(FileController);
  getServerFiles = FileController.getServerFiles.bind(FileController);
  downloadFile = FileController.downloadFile.bind(FileController);


  generatePassport = PassportController.generatePassport.bind(PassportController);


  getStats = StatsController.getStats.bind(StatsController);
  getAnalytics = StatsController.getAnalytics.bind(StatsController);


  getServerDefects = DefectMonitoringController.getServerDefects.bind(DefectMonitoringController);
  getDefectById = DefectMonitoringController.getDefectById.bind(DefectMonitoringController);
  createDefect = DefectMonitoringController.createDefect.bind(DefectMonitoringController);
  updateDefect = DefectMonitoringController.updateDefect.bind(DefectMonitoringController);
  deleteDefect = DefectMonitoringController.deleteDefect.bind(DefectMonitoringController);
  resolveDefect = DefectMonitoringController.resolveDefect.bind(DefectMonitoringController);
  uploadDefectFile = DefectMonitoringController.uploadDefectFile.bind(DefectMonitoringController);
  downloadDefectFile = DefectMonitoringController.downloadDefectFile.bind(DefectMonitoringController);
  deleteDefectFile = DefectMonitoringController.deleteDefectFile.bind(DefectMonitoringController);
  getDefectStats = DefectMonitoringController.getDefectStats.bind(DefectMonitoringController);


  pingServer = DefectMonitoringController.pingServer.bind(DefectMonitoringController);
  pingAllServers = DefectMonitoringController.pingAllServers.bind(DefectMonitoringController);
  getCachedStatus = DefectMonitoringController.getCachedStatus.bind(DefectMonitoringController);
  getMonitoringStats = DefectMonitoringController.getMonitoringStats.bind(DefectMonitoringController);
  getOnlineServers = DefectMonitoringController.getOnlineServers.bind(DefectMonitoringController);
  getOfflineServers = DefectMonitoringController.getOfflineServers.bind(DefectMonitoringController);
  clearMonitoringCache = DefectMonitoringController.clearCache.bind(DefectMonitoringController);
}

module.exports = new BeryllController();
module.exports.initChecklistTemplates = initChecklistTemplates;

================================================================================
FILE: QMS-Server-master/controllers/beryll/passportsExportController.js
================================================================================



const UnifiedPassportsExportService = require("./services/UnifiedPassportsExportService");
const ApiError = require("../../error/ApiError");


async function exportPassports(req, res, next) {
  try {
    const options = {
      serverIds: req.body.serverIds || null,
      batchId: req.body.batchId || null,
      status: req.body.status || null,
      dateFrom: req.body.dateFrom || null,
      dateTo: req.body.dateTo || null,
      search: req.body.search || null,
      includeArchived: req.body.includeArchived || false
    };

    console.log("[PassportsExport] Starting export with options:", options);

    const buffer = await UnifiedPassportsExportService.exportUnifiedPassports(options);


    const timestamp = new Date().toISOString().split("T")[0];
    let filename = `–°–æ—Å—Ç–∞–≤_—Å–µ—Ä–≤–µ—Ä–æ–≤_${timestamp}`;

    if (options.batchId) {
      filename += `_–ø–∞—Ä—Ç–∏—è_${options.batchId}`;
    }
    if (options.status) {
      filename += `_${options.status}`;
    }

    filename += ".xlsx";


    res.setHeader("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    res.setHeader("Content-Disposition", `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`);
    res.setHeader("Content-Length", buffer.length);

    console.log(`[PassportsExport] Export complete, file size: ${buffer.length} bytes`);

    res.send(buffer);

  } catch (error) {
    console.error("[PassportsExport] Export error:", error);

    if (error.message === "–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞") {
      return next(ApiError.notFound(error.message));
    }

    next(ApiError.internal(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`));
  }
}


async function getExportStats(req, res, next) {
  try {
    const options = {
      batchId: req.query.batchId || null,
      status: req.query.status || null,
      dateFrom: req.query.dateFrom || null,
      dateTo: req.query.dateTo || null,
      search: req.query.search || null,
      includeArchived: req.query.includeArchived === "true"
    };

    console.log("[PassportsExport] Getting stats with options:", options);

    const stats = await UnifiedPassportsExportService.getExportStats(options);

    res.json({
      success: true,
      stats
    });

  } catch (error) {
    console.error("[PassportsExport] Stats error:", error);
    next(ApiError.internal(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}`));
  }
}


async function getExportPreview(req, res, next) {
  try {
    const options = {
      batchId: req.query.batchId || null,
      status: req.query.status || null,
      dateFrom: req.query.dateFrom || null,
      dateTo: req.query.dateTo || null,
      search: req.query.search || null,
      includeArchived: req.query.includeArchived === "true"
    };

    const limit = parseInt(req.query.limit) || 10;

    console.log("[PassportsExport] Getting preview with options:", options);


    const servers = await UnifiedPassportsExportService.getServersWithComponents(options);


    const previewServers = servers.slice(0, limit);


    const preview = previewServers.map(server => {
      const components = server.components || [];
      const grouped = UnifiedPassportsExportService.groupComponentsByType(components);

      return {
        id: server.id,
        apkSerialNumber: server.apkSerialNumber,
        serialNumber: server.serialNumber,
        status: server.status,
        batchName: server.batch?.name || null,
        createdAt: server.createdAt,
        componentsSummary: {
          total: components.length,
          hdd: grouped.HDD?.length || 0,
          ssd: (grouped.SSD?.length || 0) + (grouped.NVME?.length || 0),
          ram: grouped.RAM?.length || 0,
          psu: grouped.PSU?.length || 0,
          motherboard: grouped.MOTHERBOARD?.length || 0,
          bmc: grouped.BMC?.length || 0,
          nic: grouped.NIC?.length || 0,
          raid: grouped.RAID?.length || 0
        },
        completeness: this.calculateCompleteness(grouped)
      };
    });

    res.json({
      success: true,
      total: servers.length,
      showing: previewServers.length,
      preview
    });

  } catch (error) {
    console.error("[PassportsExport] Preview error:", error);
    next(ApiError.internal(`–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ${error.message}`));
  }
}


function calculateCompleteness(grouped) {
  const expected = {
    HDD: 12,
    RAM: 12,
    PSU: 2,
    SSD: 2,
    NVME: 2,
    MOTHERBOARD: 1,
    BMC: 1,
    NIC: 1,
    RAID: 1
  };

  let totalExpected = 0;
  let totalActual = 0;

  for (const [type, count] of Object.entries(expected)) {
    totalExpected += count;
    const actual = grouped[type]?.length || 0;
    totalActual += Math.min(actual, count);
  }


  const ssdNvmeActual = (grouped.SSD?.length || 0) + (grouped.NVME?.length || 0);
  const ssdNvmeExpected = expected.SSD + expected.NVME;
  totalActual = totalActual - Math.min(grouped.SSD?.length || 0, expected.SSD) - Math.min(grouped.NVME?.length || 0, expected.NVME);
  totalActual += Math.min(ssdNvmeActual, ssdNvmeExpected);

  return Math.round((totalActual / totalExpected) * 100);
}


async function exportSinglePassport(req, res, next) {
  try {
    const { serverId } = req.params;

    if (!serverId) {
      return next(ApiError.badRequest("–ù–µ —É–∫–∞–∑–∞–Ω ID —Å–µ—Ä–≤–µ—Ä–∞"));
    }

    console.log("[PassportsExport] Single export for server:", serverId);


    const buffer = await UnifiedPassportsExportService.exportUnifiedPassports({
      serverIds: [parseInt(serverId)]
    });

    const timestamp = new Date().toISOString().split("T")[0];
    const filename = `–ü–∞—Å–ø–æ—Ä—Ç_—Å–µ—Ä–≤–µ—Ä–∞_${serverId}_${timestamp}.xlsx`;

    res.setHeader("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    res.setHeader("Content-Disposition", `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`);
    res.setHeader("Content-Length", buffer.length);

    res.send(buffer);

  } catch (error) {
    console.error("[PassportsExport] Single export error:", error);
    next(ApiError.internal(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`));
  }
}


async function exportSelectedPassports(req, res, next) {
  try {
    const { serverIds } = req.body;

    if (!serverIds || !Array.isArray(serverIds) || serverIds.length === 0) {
      return next(ApiError.badRequest("–ù–µ –≤—ã–±—Ä–∞–Ω—ã —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞"));
    }

    console.log("[PassportsExport] Selected export for servers:", serverIds);

    const buffer = await UnifiedPassportsExportService.exportUnifiedPassports({
      serverIds: serverIds.map(id => parseInt(id))
    });

    const timestamp = new Date().toISOString().split("T")[0];
    const filename = `–°–æ—Å—Ç–∞–≤_—Å–µ—Ä–≤–µ—Ä–æ–≤_–≤—ã–±—Ä–∞–Ω–Ω—ã–µ_${serverIds.length}—à—Ç_${timestamp}.xlsx`;

    res.setHeader("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    res.setHeader("Content-Disposition", `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`);
    res.setHeader("Content-Length", buffer.length);

    res.send(buffer);

  } catch (error) {
    console.error("[PassportsExport] Selected export error:", error);
    next(ApiError.internal(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`));
  }
}


async function exportBatchPassports(req, res, next) {
  try {
    const { batchId } = req.params;

    console.log("[PassportsExport] Batch export for:", batchId);

    const buffer = await UnifiedPassportsExportService.exportUnifiedPassports({
      batchId: batchId === "null" ? "null" : parseInt(batchId)
    });

    const timestamp = new Date().toISOString().split("T")[0];
    const filename = batchId === "null"
      ? `–°–æ—Å—Ç–∞–≤_—Å–µ—Ä–≤–µ—Ä–æ–≤_–±–µ–∑_–ø–∞—Ä—Ç–∏–∏_${timestamp}.xlsx`
      : `–°–æ—Å—Ç–∞–≤_—Å–µ—Ä–≤–µ—Ä–æ–≤_–ø–∞—Ä—Ç–∏—è_${batchId}_${timestamp}.xlsx`;

    res.setHeader("Content-Type", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    res.setHeader("Content-Disposition", `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`);
    res.setHeader("Content-Length", buffer.length);

    res.send(buffer);

  } catch (error) {
    console.error("[PassportsExport] Batch export error:", error);
    next(ApiError.internal(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`));
  }
}

module.exports = {
  exportPassports,
  getExportStats,
  getExportPreview,
  exportSinglePassport,
  exportSelectedPassports,
  exportBatchPassports,
  calculateCompleteness
};

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/ApprovalService.js
================================================================================


const { Op } = require("sequelize");
const sequelize = require("../../../db");

const {
  BeryllServer,
  BeryllServerChecklist,
  BeryllChecklistTemplate,
  BeryllChecklistFile,
  BeryllHistory,
  HISTORY_ACTIONS,
  CHECKLIST_GROUPS
} = require("../../../models/definitions/BeryllExtended");

const {
  BeryllServerApproval,
  CHECKLIST_STAGES,
  APPROVAL_STATUSES
} = require("../../../models/BeryllServerApproval");

const User = require("../../../models/User");

class ApprovalService {


  async submitForVerification(serverId, userId, stageCode = CHECKLIST_STAGES.ASSEMBLY) {
    const transaction = await sequelize.transaction();

    try {

      const server = await BeryllServer.findByPk(serverId);
      if (!server) {
        throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
      }


      const existingPending = await BeryllServerApproval.findOne({
        where: {
          serverId,
          stageCode,
          status: APPROVAL_STATUSES.PENDING
        },
        transaction
      });

      if (existingPending) {
        throw new Error("–°–µ—Ä–≤–µ—Ä —É–∂–µ –æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —ç—Ç–æ–π —Å—Ç–∞–¥–∏–∏");
      }

      const completionCheck = await this.checkStageCompletion(serverId, stageCode, transaction);
      if (!completionCheck.isComplete) {
        throw new Error(`–ù–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã —á–µ–∫–ª–∏—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –û—Å—Ç–∞–ª–æ—Å—å: ${completionCheck.remaining.join(", ")}`);
      }


      const checklistSnapshot = await this.getChecklistSnapshot(serverId, stageCode, transaction);

      const approval = await BeryllServerApproval.create({
        serverId,
        stageCode,
        status: APPROVAL_STATUSES.PENDING,
        submittedById: userId,
        submittedAt: new Date(),
        metadata: {
          checklistSnapshot,
          serverData: {
            serialNumber: server.serialNumber,
            apkSerialNumber: server.apkSerialNumber,
            hostname: server.hostname,
            ipAddress: server.ipAddress,
            status: server.status
          }
        }
      }, { transaction });

      await BeryllHistory.create({
        serverId,
        userId,
        action: HISTORY_ACTIONS.STATUS_CHANGE,
        fromStatus: server.status,
        toStatus: server.status,
        comment: `–°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é (—Å—Ç–∞–¥–∏—è: ${stageCode})`,
        metadata: { approvalId: approval.id, stageCode }
      }, { transaction });

      await transaction.commit();


      return await this.getApprovalById(approval.id);

    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  async checkStageCompletion(serverId, stageCode, transaction = null) {

    const templates = await BeryllChecklistTemplate.findAll({
      where: {
        stageCode,
        isActive: true,
        isRequired: true
      },
      transaction
    });

    if (templates.length === 0) {
      return { isComplete: true, remaining: [], total: 0, completed: 0 };
    }

    const serverChecklists = await BeryllServerChecklist.findAll({
      where: {
        serverId,
        checklistTemplateId: { [Op.in]: templates.map(t => t.id) }
      },
      include: [{
        model: BeryllChecklistTemplate,
        as: "template"
      }],
      transaction
    });

    const completedIds = new Set(
      serverChecklists
        .filter(sc => sc.completed)
        .map(sc => sc.checklistTemplateId)
    );

    const remaining = templates
      .filter(t => !completedIds.has(t.id))
      .map(t => t.title);

    return {
      isComplete: remaining.length === 0,
      remaining,
      total: templates.length,
      completed: completedIds.size
    };
  }


  async getChecklistSnapshot(serverId, stageCode, transaction = null) {
    const checklists = await BeryllServerChecklist.findAll({
      where: { serverId },
      include: [
        {
          model: BeryllChecklistTemplate,
          as: "template",
          where: { stageCode },
          required: true
        },
        {
          model: BeryllChecklistFile,
          as: "files"
        },
        {
          model: User,
          as: "completedBy",
          attributes: ["id", "login", "name", "surname"]
        }
      ],
      transaction
    });

    return checklists.map(cl => ({
      templateId: cl.checklistTemplateId,
      title: cl.template?.title,
      groupCode: cl.template?.groupCode,
      completed: cl.completed,
      completedAt: cl.completedAt,
      completedBy: cl.completedBy ? {
        id: cl.completedBy.id,
        name: `${cl.completedBy.name || ''} ${cl.completedBy.surname || ''}`.trim() || cl.completedBy.login
      } : null,
      notes: cl.notes,
      filesCount: cl.files?.length || 0
    }));
  }


  async approveServer(approvalId, reviewerId, comment = null) {
    const transaction = await sequelize.transaction();

    try {
      const approval = await BeryllServerApproval.findByPk(approvalId, { transaction });

      if (!approval) {
        throw new Error("–ó–∞–ø–∏—Å—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
      }

      if (approval.status !== APPROVAL_STATUSES.PENDING) {
        throw new Error("–≠—Ç–∞ –∑–∞–ø–∏—Å—å —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞");
      }


      approval.status = APPROVAL_STATUSES.APPROVED;
      approval.reviewedById = reviewerId;
      approval.reviewedAt = new Date();
      approval.comment = comment;
      await approval.save({ transaction });


      await BeryllHistory.create({
        serverId: approval.serverId,
        userId: reviewerId,
        action: HISTORY_ACTIONS.STATUS_CHANGE,
        comment: `–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–¥–æ–±—Ä–µ–Ω–∞${comment ? `: ${comment}` : ''}`,
        metadata: { approvalId, stageCode: approval.stageCode }
      }, { transaction });

      await transaction.commit();

      return await this.getApprovalById(approvalId);

    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }


  async rejectServer(approvalId, reviewerId, comment) {
    if (!comment?.trim()) {
      throw new Error("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è");
    }

    const transaction = await sequelize.transaction();

    try {
      const approval = await BeryllServerApproval.findByPk(approvalId, { transaction });

      if (!approval) {
        throw new Error("–ó–∞–ø–∏—Å—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
      }

      if (approval.status !== APPROVAL_STATUSES.PENDING) {
        throw new Error("–≠—Ç–∞ –∑–∞–ø–∏—Å—å —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞");
      }


      approval.status = APPROVAL_STATUSES.REJECTED;
      approval.reviewedById = reviewerId;
      approval.reviewedAt = new Date();
      approval.comment = comment;
      await approval.save({ transaction });


      await BeryllHistory.create({
        serverId: approval.serverId,
        userId: reviewerId,
        action: HISTORY_ACTIONS.STATUS_CHANGE,
        comment: `–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞: ${comment}`,
        metadata: { approvalId, stageCode: approval.stageCode }
      }, { transaction });

      await transaction.commit();

      return await this.getApprovalById(approvalId);

    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }


  async getApprovalById(approvalId) {
    return await BeryllServerApproval.findByPk(approvalId, {
      include: [
        {
          model: BeryllServer,
          as: "server",
          attributes: ["id", "serialNumber", "apkSerialNumber", "hostname", "ipAddress", "status"]
        },
        {
          model: User,
          as: "submittedBy",
          attributes: ["id", "login", "name", "surname"]
        },
        {
          model: User,
          as: "reviewedBy",
          attributes: ["id", "login", "name", "surname"]
        }
      ]
    });
  }


  async getVerificationQueue(options = {}) {
    const {
      stageCode = null,
      page = 1,
      limit = 20,
      sortBy = "submittedAt",
      sortOrder = "ASC"
    } = options;

    const where = {
      status: APPROVAL_STATUSES.PENDING
    };

    if (stageCode) {
      where.stageCode = stageCode;
    }

    const offset = (page - 1) * limit;

    const { rows, count } = await BeryllServerApproval.findAndCountAll({
      where,
      include: [
        {
          model: BeryllServer,
          as: "server",
          attributes: ["id", "serialNumber", "apkSerialNumber", "hostname", "ipAddress", "status", "batchId"],
          include: [
            {
              model: BeryllServerChecklist,
              as: "checklists",
              include: [
                { model: BeryllChecklistFile, as: "files" }
              ]
            }
          ]
        },
        {
          model: User,
          as: "submittedBy",
          attributes: ["id", "login", "name", "surname"]
        }
      ],
      order: [[sortBy, sortOrder]],
      limit,
      offset
    });

    return {
      items: rows,
      total: count,
      page,
      limit,
      totalPages: Math.ceil(count / limit)
    };
  }


  async getServerApprovalHistory(serverId) {
    return await BeryllServerApproval.findAll({
      where: { serverId },
      include: [
        {
          model: User,
          as: "submittedBy",
          attributes: ["id", "login", "name", "surname"]
        },
        {
          model: User,
          as: "reviewedBy",
          attributes: ["id", "login", "name", "surname"]
        }
      ],
      order: [["createdAt", "DESC"]]
    });
  }


  async getServerVerificationStatus(serverId) {

    const stages = Object.values(CHECKLIST_STAGES);
    const result = {};

    for (const stage of stages) {
      const latestApproval = await BeryllServerApproval.findOne({
        where: { serverId, stageCode: stage },
        order: [["createdAt", "DESC"]],
        include: [
          { model: User, as: "submittedBy", attributes: ["id", "login", "name", "surname"] },
          { model: User, as: "reviewedBy", attributes: ["id", "login", "name", "surname"] }
        ]
      });

      const completion = await this.checkStageCompletion(serverId, stage);

      result[stage] = {
        stageCode: stage,
        latestApproval: latestApproval ? {
          id: latestApproval.id,
          status: latestApproval.status,
          submittedBy: latestApproval.submittedBy,
          submittedAt: latestApproval.submittedAt,
          reviewedBy: latestApproval.reviewedBy,
          reviewedAt: latestApproval.reviewedAt,
          comment: latestApproval.comment
        } : null,
        completion,
        canSubmit: completion.isComplete && (!latestApproval || latestApproval.status !== APPROVAL_STATUSES.PENDING)
      };
    }

    return result;
  }


  async getVerificationDetails(approvalId) {
    const approval = await this.getApprovalById(approvalId);

    if (!approval) {
      throw new Error("–ó–∞–ø–∏—Å—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    }

    const checklists = await BeryllServerChecklist.findAll({
      where: { serverId: approval.serverId },
      include: [
        {
          model: BeryllChecklistTemplate,
          as: "template",
          where: { stageCode: approval.stageCode },
          required: true
        },
        {
          model: BeryllChecklistFile,
          as: "files",
          include: [
            { model: User, as: "uploadedBy", attributes: ["id", "login", "name", "surname"] }
          ]
        },
        {
          model: User,
          as: "completedBy",
          attributes: ["id", "login", "name", "surname"]
        }
      ],
      order: [[{ model: BeryllChecklistTemplate, as: "template" }, "sortOrder", "ASC"]]
    });

    const groupedChecklists = {};
    for (const cl of checklists) {
      const groupCode = cl.template?.groupCode || "OTHER";
      if (!groupedChecklists[groupCode]) {
        groupedChecklists[groupCode] = [];
      }
      groupedChecklists[groupCode].push(cl);
    }

    return {
      approval,
      checklists: groupedChecklists,
      server: approval.server,
      metadata: approval.metadata
    };
  }


  async getVerificationStats() {
    const pendingCount = await BeryllServerApproval.count({
      where: { status: APPROVAL_STATUSES.PENDING }
    });

    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);

    const approvedToday = await BeryllServerApproval.count({
      where: {
        status: APPROVAL_STATUSES.APPROVED,
        reviewedAt: { [Op.gte]: todayStart }
      }
    });

    const rejectedToday = await BeryllServerApproval.count({
      where: {
        status: APPROVAL_STATUSES.REJECTED,
        reviewedAt: { [Op.gte]: todayStart }
      }
    });

    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);

    const recentApprovals = await BeryllServerApproval.findAll({
      where: {
        status: { [Op.in]: [APPROVAL_STATUSES.APPROVED, APPROVAL_STATUSES.REJECTED] },
        reviewedAt: { [Op.gte]: weekAgo }
      },
      attributes: ["submittedAt", "reviewedAt"]
    });

    let avgMinutes = 0;
    if (recentApprovals.length > 0) {
      const totalMinutes = recentApprovals.reduce((sum, a) => {
        const diff = new Date(a.reviewedAt) - new Date(a.submittedAt);
        return sum + diff / 1000 / 60;
      }, 0);
      avgMinutes = Math.round(totalMinutes / recentApprovals.length);
    }

    return {
      pending: pendingCount,
      approvedToday,
      rejectedToday,
      avgVerificationMinutes: avgMinutes
    };
  }
}

module.exports = new ApprovalService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/ArchiveService.js
================================================================================

const { BeryllServer, BeryllBatch, BeryllHistory, User } = require("../../../models/index");
const { SERVER_STATUSES, HISTORY_ACTIONS } = require("../../../models/definitions/Beryll");
const { Op } = require("sequelize");
const HistoryService = require("./HistoryService");

class ArchiveService {

  async getArchivedServers(filters = {}) {
    const { search, batchId, page = 1, limit = 50 } = filters;

    const where = { status: SERVER_STATUSES.ARCHIVED };

    if (search) {
      where[Op.or] = [
        { apkSerialNumber: { [Op.iLike]: `%${search}%` } },
        { serialNumber: { [Op.iLike]: `%${search}%` } },
        { hostname: { [Op.iLike]: `%${search}%` } },
        { ipAddress: { [Op.iLike]: `%${search}%` } }
      ];
    }

    if (batchId) {
      where.batchId = batchId === "null" ? null : parseInt(batchId);
    }

    const { count, rows } = await BeryllServer.findAndCountAll({
      where,
      include: [
        { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] },
        { model: User, as: "archivedBy", attributes: ["id", "login", "name", "surname"] },
        { model: BeryllBatch, as: "batch", attributes: ["id", "title"] }
      ],
      order: [["archivedAt", "DESC"]],
      limit: parseInt(limit),
      offset: (parseInt(page) - 1) * parseInt(limit)
    });

    return {
      servers: rows,
      total: count,
      page: parseInt(page),
      totalPages: Math.ceil(count / parseInt(limit))
    };
  }


  async archiveServer(id, userId) {
    const server = await BeryllServer.findByPk(id);

    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }


    if (server.status !== SERVER_STATUSES.DONE) {
      throw new Error("–ú–æ–∂–Ω–æ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã");
    }

    if (!server.apkSerialNumber) {
      throw new Error("–ü–µ—Ä–µ–¥ –∞—Ä—Ö–∏–≤–∞—Ü–∏–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏—Å–≤–æ–∏—Ç—å —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ê–ü–ö");
    }

    const oldStatus = server.status;

    await server.update({
      status: SERVER_STATUSES.ARCHIVED,
      archivedAt: new Date(),
      archivedById: userId,
      leaseActive: false
    });

    await HistoryService.logHistory(server.id, userId, HISTORY_ACTIONS.ARCHIVED, {
      fromStatus: oldStatus,
      toStatus: SERVER_STATUSES.ARCHIVED,
      comment: `–°–µ—Ä–≤–µ—Ä ${server.apkSerialNumber} –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ –∞—Ä—Ö–∏–≤`
    });

    return { success: true, message: "–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ –∞—Ä—Ö–∏–≤" };
  }


  async unarchiveServer(id, userId) {
    const server = await BeryllServer.findByPk(id);

    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    if (!server.archivedAt) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞—Ä—Ö–∏–≤–µ");
    }

    await server.update({
      archivedAt: null,
      archivedById: null,
      status: SERVER_STATUSES.DONE
    });

    await HistoryService.logHistory(server.id, userId, HISTORY_ACTIONS.STATUS_CHANGED, {
      fromStatus: "ARCHIVED",
      toStatus: SERVER_STATUSES.DONE,
      comment: "–ò–∑–≤–ª–µ—á—ë–Ω –∏–∑ –∞—Ä—Ö–∏–≤–∞"
    });

    const updated = await BeryllServer.findByPk(id, {
      include: [
        { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] },
        { model: User, as: "archivedBy", attributes: ["id", "login", "name", "surname"] },
        { model: BeryllBatch, as: "batch" }
      ]
    });

    return updated;
  }


  async updateApkSerialNumber(id, apkSerialNumber, userId) {
    if (!apkSerialNumber || !apkSerialNumber.trim()) {
      throw new Error("–£–∫–∞–∂–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –ê–ü–ö");
    }

    const server = await BeryllServer.findByPk(id);
    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    const existing = await BeryllServer.findOne({
      where: {
        apkSerialNumber: apkSerialNumber.trim(),
        id: { [Op.ne]: id }
      }
    });

    if (existing) {
      throw new Error("–≠—Ç–æ—Ç —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —É–∂–µ –ø—Ä–∏—Å–≤–æ–µ–Ω –¥—Ä—É–≥–æ–º—É —Å–µ—Ä–≤–µ—Ä—É");
    }

    const oldSerial = server.apkSerialNumber;

    await server.update({ apkSerialNumber: apkSerialNumber.trim() });

    await HistoryService.logHistory(server.id, userId, HISTORY_ACTIONS.SERIAL_ASSIGNED, {
      comment: oldSerial
        ? `–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑–º–µ–Ω—ë–Ω —Å ${oldSerial} –Ω–∞ ${apkSerialNumber.trim()}`
        : `–ü—Ä–∏—Å–≤–æ–µ–Ω —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä ${apkSerialNumber.trim()}`,
      metadata: { oldSerial, newSerial: apkSerialNumber.trim() }
    });

    return { success: true, apkSerialNumber: apkSerialNumber.trim() };
  }
}

module.exports = new ArchiveService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/BatchService.js
================================================================================

const { BeryllServer, BeryllBatch, User } = require("../../../models/index");
const { BATCH_STATUSES } = require("../../../models/definitions/Beryll");
const { Op, fn, col } = require("sequelize");
const HistoryService = require("./HistoryService");

class BatchService {

  async getBatches(filters = {}) {
    const { status, search } = filters;

    const where = {};

    if (status && Object.values(BATCH_STATUSES).includes(status)) {
      where.status = status;
    }

    if (search) {
      where[Op.or] = [
        { title: { [Op.iLike]: `%${search}%` } },
        { supplier: { [Op.iLike]: `%${search}%` } }
      ];
    }

    const batches = await BeryllBatch.findAll({
      where,
      include: [
        { model: User, as: "createdBy", attributes: ["id", "login", "name", "surname"] }
      ],
      order: [["createdAt", "DESC"]]
    });

    const batchesWithStats = await Promise.all(batches.map(async (batch) => {
      const stats = await BeryllServer.findAll({
        where: { batchId: batch.id },
        attributes: [
          "status",
          [fn("COUNT", col("id")), "count"]
        ],
        group: ["status"],
        raw: true
      });

      const totalCount = await BeryllServer.count({ where: { batchId: batch.id } });

      return {
        ...batch.toJSON(),
        totalCount,
        stats: stats.reduce((acc, s) => {
          acc[s.status] = parseInt(s.count);
          return acc;
        }, {})
      };
    }));

    return batchesWithStats;
  }

  async getBatchById(id) {
    const batch = await BeryllBatch.findByPk(id, {
      include: [
        { model: User, as: "createdBy", attributes: ["id", "login", "name", "surname"] },
        {
          model: BeryllServer,
          as: "servers",
          include: [{ model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] }]
        }
      ]
    });

    if (!batch) {
      throw new Error("–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    }

    const stats = await BeryllServer.findAll({
      where: { batchId: id },
      attributes: ["status", [fn("COUNT", col("id")), "count"]],
      group: ["status"],
      raw: true
    });

    return {
      ...batch.toJSON(),
      stats: stats.reduce((acc, s) => {
        acc[s.status] = parseInt(s.count);
        return acc;
      }, {})
    };
  }

  async createBatch(data, userId) {
    const { title, supplier, deliveryDate, expectedCount, notes } = data;

    if (!title) {
      throw new Error("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
    }

    const batch = await BeryllBatch.create({
      title,
      supplier,
      deliveryDate,
      expectedCount,
      notes,
      createdById: userId
    });

    return batch;
  }

  async updateBatch(id, data) {
    const { title, supplier, deliveryDate, expectedCount, notes, status } = data;

    const batch = await BeryllBatch.findByPk(id);

    if (!batch) {
      throw new Error("–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    }

    const updateData = {};
    if (title !== undefined) updateData.title = title;
    if (supplier !== undefined) updateData.supplier = supplier;
    if (deliveryDate !== undefined) updateData.deliveryDate = deliveryDate;
    if (expectedCount !== undefined) updateData.expectedCount = expectedCount;
    if (notes !== undefined) updateData.notes = notes;
    if (status !== undefined) {
      updateData.status = status;
      if (status === BATCH_STATUSES.COMPLETED) {
        updateData.completedAt = new Date();
      }
    }

    await batch.update(updateData);

    return batch;
  }

  async deleteBatch(id) {
    const batch = await BeryllBatch.findByPk(id);

    if (!batch) {
      throw new Error("–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    }

    await BeryllServer.update(
      { batchId: null },
      { where: { batchId: id } }
    );

    await batch.destroy();

    return { success: true };
  }

  async assignServersToBatch(id, serverIds, userId) {
    const batch = await BeryllBatch.findByPk(id);

    if (!batch) {
      throw new Error("–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    }

    if (!Array.isArray(serverIds) || serverIds.length === 0) {
      throw new Error("–£–∫–∞–∂–∏—Ç–µ ID —Å–µ—Ä–≤–µ—Ä–æ–≤");
    }

    await BeryllServer.update(
      { batchId: id },
      { where: { id: { [Op.in]: serverIds } } }
    );

    for (const serverId of serverIds) {
      await HistoryService.logHistory(serverId, userId, HISTORY_ACTIONS.BATCH_ASSIGNED, {
        comment: `–ü—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–∞—Ä—Ç–∏–∏: ${batch.title}`,
        metadata: { batchId: id, batchTitle: batch.title }
      });
    }

    return { success: true, count: serverIds.length };
  }

  async removeServersFromBatch(id, serverIds, userId) {
    const batch = await BeryllBatch.findByPk(id);

    if (!batch) {
      throw new Error("–ü–∞—Ä—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    }

    await BeryllServer.update(
      { batchId: null },
      { where: { id: { [Op.in]: serverIds }, batchId: id } }
    );

    for (const serverId of serverIds) {
      await HistoryService.logHistory(serverId, userId, HISTORY_ACTIONS.BATCH_REMOVED, {
        comment: `–û—Ç–≤—è–∑–∞–Ω –æ—Ç –ø–∞—Ä—Ç–∏–∏: ${batch.title}`
      });
    }

    return { success: true };
  }
}

module.exports = new BatchService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/ChecklistService.js
================================================================================


const {
  BeryllChecklistTemplate,
  BeryllServerChecklist,
  BeryllChecklistFile,
  BeryllServer,
  HISTORY_ACTIONS
} = require("../../../models/definitions/Beryll");


const { User } = require("../../../models/index");

const HistoryService = require("./HistoryService");
const { Op } = require("sequelize");
const path = require("path");
const fs = require("fs");

const UPLOAD_DIR = path.join(__dirname, "../../../uploads/beryll");


function decodeFileName(name) {
  if (!name) return name;

  try {

    const hasInvalidChars = /[\u0080-\u00ff]/.test(name);

    if (hasInvalidChars) {

      return Buffer.from(name, 'latin1').toString('utf8');
    }

    return name;
  } catch (e) {
    console.error("Error decoding filename:", e);
    return name;
  }
}

class ChecklistService {


  async initializeServerChecklist(serverId) {
    try {
      const templates = await BeryllChecklistTemplate.findAll({
        where: { isActive: true },
        order: [["sortOrder", "ASC"]]
      });

      for (const template of templates) {
        await BeryllServerChecklist.findOrCreate({
          where: { serverId, checklistTemplateId: template.id },
          defaults: { completed: false }
        });
      }
    } catch (e) {
      console.error("Error initializing checklist:", e);
      throw e;
    }
  }


  async getChecklistTemplates() {
    const templates = await BeryllChecklistTemplate.findAll({
      where: { isActive: true },
      order: [["sortOrder", "ASC"]]
    });

    return templates;
  }

  async getAllChecklistTemplates(includeInactive = false) {
    const where = includeInactive ? {} : { isActive: true };

    const templates = await BeryllChecklistTemplate.findAll({
      where,
      order: [["sortOrder", "ASC"]]
    });

    return templates;
  }

  async createChecklistTemplate(data) {
    const {
      title,
      description,
      sortOrder,
      isRequired,
      estimatedMinutes,
      groupCode,
      fileCode,
      requiresFile
    } = data;

    if (!title) {
      throw new Error("–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ");
    }

    let order = sortOrder;
    if (order === undefined || order === null) {
      const maxOrder = await BeryllChecklistTemplate.max('sortOrder') || 0;
      order = maxOrder + 10;
    }

    const template = await BeryllChecklistTemplate.create({
      title,
      description: description || null,
      sortOrder: order,
      isRequired: isRequired !== false,
      estimatedMinutes: estimatedMinutes || 30,
      groupCode: groupCode || 'TESTING',
      fileCode: fileCode || null,
      requiresFile: requiresFile === true,
      isActive: true
    });

    return template;
  }

  async updateChecklistTemplate(id, data) {
    const {
      title,
      description,
      sortOrder,
      isRequired,
      estimatedMinutes,
      isActive,
      groupCode,
      fileCode,
      requiresFile
    } = data;

    const template = await BeryllChecklistTemplate.findByPk(id);

    if (!template) {
      throw new Error("–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    const updateData = {};
    if (title !== undefined) updateData.title = title;
    if (description !== undefined) updateData.description = description;
    if (sortOrder !== undefined) updateData.sortOrder = sortOrder;
    if (isRequired !== undefined) updateData.isRequired = isRequired;
    if (estimatedMinutes !== undefined) updateData.estimatedMinutes = estimatedMinutes;
    if (isActive !== undefined) updateData.isActive = isActive;
    if (groupCode !== undefined) updateData.groupCode = groupCode;
    if (fileCode !== undefined) updateData.fileCode = fileCode;
    if (requiresFile !== undefined) updateData.requiresFile = requiresFile;

    await template.update(updateData);

    return template;
  }


  async deleteChecklistTemplate(id, hardDelete = false) {
    const template = await BeryllChecklistTemplate.findByPk(id);

    if (!template) {
      throw new Error("–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    if (hardDelete) {
      const usageCount = await BeryllServerChecklist.count({
        where: { checklistTemplateId: id }
      });

      if (usageCount > 0) {
        throw new Error(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å: —à–∞–±–ª–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ${usageCount} —Å–µ—Ä–≤–µ—Ä–∞—Ö. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—é.`);
      }

      await template.destroy();
    } else {
      await template.update({ isActive: false });
    }

    return { success: true };
  }


  async restoreChecklistTemplate(id) {
    const template = await BeryllChecklistTemplate.findByPk(id);

    if (!template) {
      throw new Error("–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    await template.update({ isActive: true });

    return template;
  }


  async reorderChecklistTemplates(orderedIds) {
    const updates = orderedIds.map((id, index) =>
      BeryllChecklistTemplate.update(
        { sortOrder: (index + 1) * 10 },
        { where: { id } }
      )
    );

    await Promise.all(updates);

    return { success: true };
  }


  async getServerChecklist(serverId) {
    const templates = await BeryllChecklistTemplate.findAll({
      where: { isActive: true },
      order: [["sortOrder", "ASC"]]
    });

    const serverChecklists = await BeryllServerChecklist.findAll({
      where: { serverId },
      include: [
        {
          model: BeryllChecklistFile,
          as: "files",
          include: [
            { model: User, as: "uploadedBy", attributes: ["id", "login", "name", "surname"] }
          ]
        },
        { model: User, as: "completedBy", attributes: ["id", "login", "name", "surname"] }
      ]
    });

    return templates.map(template => {
      const serverChecklist = serverChecklists.find(
        sc => sc.checklistTemplateId === template.id
      );

      return {
        id: serverChecklist?.id || null,
        serverId: parseInt(serverId),
        checklistTemplateId: template.id,
        completed: serverChecklist?.completed || false,
        completedAt: serverChecklist?.completedAt || null,
        completedById: serverChecklist?.completedById || null,
        notes: serverChecklist?.notes || null,
        template: template.toJSON(),
        completedBy: serverChecklist?.completedBy || null,
        files: serverChecklist?.files || []
      };
    });
  }


  async toggleChecklistItem(serverId, checklistTemplateId, completed, notes, userId) {

    const template = await BeryllChecklistTemplate.findByPk(checklistTemplateId);

    if (!template) {
      throw new Error("–®–∞–±–ª–æ–Ω —á–µ–∫-–ª–∏—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    let [checklist, created] = await BeryllServerChecklist.findOrCreate({
      where: { serverId, checklistTemplateId },
      defaults: { completed: false }
    });

    const files = await BeryllChecklistFile.findAll({
      where: { serverChecklistId: checklist.id }
    });


    if (completed && template.requiresFile) {
      if (!files || files.length === 0) {
        throw new Error("–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ (—Å–∫—Ä–∏–Ω—à–æ—Ç)");
      }
    }


    const updateData = {
      completed,
      notes: notes !== undefined ? notes : checklist.notes
    };

    if (completed) {
      updateData.completedById = userId;
      updateData.completedAt = new Date();
    } else {
      updateData.completedById = null;
      updateData.completedAt = null;
    }

    await checklist.update(updateData);


    if (completed) {
      try {
        await HistoryService.logHistory(parseInt(serverId), userId, HISTORY_ACTIONS.CHECKLIST_COMPLETED, {
          checklistItemId: checklistTemplateId,
          comment: `–í—ã–ø–æ–ª–Ω–µ–Ω —ç—Ç–∞–ø: ${template.title}`
        });
      } catch (e) {
        console.error("Error logging history:", e);
      }
    }

    return await BeryllServerChecklist.findByPk(checklist.id, {
      include: [
        { model: BeryllChecklistTemplate, as: "template" },
        {
          model: BeryllChecklistFile,
          as: "files",
          include: [
            { model: User, as: "uploadedBy", attributes: ["id", "login", "name", "surname"] }
          ]
        },
        { model: User, as: "completedBy", attributes: ["id", "login", "name", "surname"] }
      ]
    });
  }


  async uploadChecklistFile(serverId, checklistTemplateId, file, userId) {
    const template = await BeryllChecklistTemplate.findByPk(checklistTemplateId);
    if (!template) {
      throw new Error("–®–∞–±–ª–æ–Ω —á–µ–∫-–ª–∏—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    let [checklist, created] = await BeryllServerChecklist.findOrCreate({
      where: { serverId, checklistTemplateId },
      defaults: { completed: false }
    });

    const serverDir = path.join(UPLOAD_DIR, `server_${serverId}`);
    if (!fs.existsSync(serverDir)) {
      fs.mkdirSync(serverDir, { recursive: true });
    }

    const originalName = decodeFileName(file.name);

    const ext = path.extname(file.name);
    const uniqueSuffix = Date.now() + "-" + Math.round(Math.random() * 1e9);
    const fileName = `checklist_${checklistTemplateId}_${uniqueSuffix}${ext}`;
    const filePath = path.join(serverDir, fileName);


    await file.mv(filePath);


    const relativePath = path.join(`server_${serverId}`, fileName);

    const checklistFile = await BeryllChecklistFile.create({
      serverChecklistId: checklist.id,
      fileName: fileName,
      originalName: originalName,
      mimetype: file.mimetype,
      fileSize: file.size,
      filePath: relativePath,
      uploadedById: userId
    });

    try {
      await HistoryService.logHistory(parseInt(serverId), userId, HISTORY_ACTIONS.FILE_UPLOADED, {
        checklistItemId: checklistTemplateId,
        comment: `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ${originalName}`,
        metadata: {
          fileName: fileName,
          originalName: originalName,
          fileSize: file.size
        }
      });
    } catch (e) {
      console.error("Error logging history:", e);
    }


    return await BeryllChecklistFile.findByPk(checklistFile.id, {
      include: [
        { model: User, as: "uploadedBy", attributes: ["id", "login", "name", "surname"] }
      ]
    });
  }

  async getServerFiles(serverId) {
    const serverChecklists = await BeryllServerChecklist.findAll({
      where: { serverId },
      attributes: ["id"]
    });

    const checklistIds = serverChecklists.map(c => c.id);

    if (checklistIds.length === 0) {
      return [];
    }

    const files = await BeryllChecklistFile.findAll({
      where: { serverChecklistId: { [Op.in]: checklistIds } },
      include: [
        { model: User, as: "uploadedBy", attributes: ["id", "login", "name", "surname"] },
        {
          model: BeryllServerChecklist,
          as: "checklist",
          include: [
            { model: BeryllChecklistTemplate, as: "template", attributes: ["id", "title", "groupCode"] }
          ]
        }
      ],
      order: [["createdAt", "DESC"]]
    });

    return files;
  }

  async getFileById(fileId) {
    const file = await BeryllChecklistFile.findByPk(fileId);

    if (!file) {
      throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    const fullPath = path.join(UPLOAD_DIR, file.filePath);

    if (!fs.existsSync(fullPath)) {
      throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –¥–∏—Å–∫–µ");
    }

    return {
      id: file.id,
      fileName: file.fileName,
      originalName: file.originalName,
      mimetype: file.mimetype,
      fileSize: file.fileSize,
      path: fullPath
    };
  }

  async deleteChecklistFile(fileId, userId) {
    const file = await BeryllChecklistFile.findByPk(fileId, {
      include: [{
        model: BeryllServerChecklist,
        as: "checklist",
        include: [{ model: BeryllChecklistTemplate, as: "template" }]
      }]
    });

    if (!file) {
      throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    const serverId = file.checklist?.serverId;
    const checklistId = file.checklist?.id;
    const templateRequiresFile = file.checklist?.template?.requiresFile;
    const originalName = file.originalName;

    try {
      const fullPath = path.join(UPLOAD_DIR, file.filePath);
      if (fs.existsSync(fullPath)) {
        fs.unlinkSync(fullPath);
      }
    } catch (e) {
      console.error("Error deleting physical file:", e);
    }

    await file.destroy();


    if (serverId) {
      try {
        await HistoryService.logHistory(serverId, userId, HISTORY_ACTIONS.FILE_DELETED, {
          checklistItemId: file.checklist?.checklistTemplateId,
          comment: `–£–¥–∞–ª—ë–Ω —Ñ–∞–π–ª: ${originalName}`,
          metadata: { fileName: file.fileName, originalName }
        });
      } catch (e) {
        console.error("Error logging history:", e);
      }
    }

    if (templateRequiresFile && checklistId) {
      const remainingFiles = await BeryllChecklistFile.count({
        where: { serverChecklistId: checklistId }
      });

      if (remainingFiles === 0) {
        await BeryllServerChecklist.update(
          {
            completed: false,
            completedById: null,
            completedAt: null
          },
          { where: { id: checklistId } }
        );
      }
    }

    return { success: true };
  }
}

async function initChecklistTemplates() {
  try {
    const count = await BeryllChecklistTemplate.count();
    if (count > 0) {
      console.log(`‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —à–∞–±–ª–æ–Ω—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç (${count} —à—Ç.)`);
      return;
    }

    const templates = [

      { groupCode: 'VISUAL', title: '–í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞', description: '–ü—Ä–æ–≤–µ—Å—Ç–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è)', fileCode: null, requiresFile: false, sortOrder: 100, isRequired: true, estimatedMinutes: 10 },


      { groupCode: 'TESTING', title: '–°–∫—Ä–∏–Ω –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏', description: '–°–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞', fileCode: 'sn_on2', requiresFile: true, sortOrder: 200, isRequired: true, estimatedMinutes: 5 },
      { groupCode: 'TESTING', title: '–¢–µ—Å—Ç RAID (cachevault)', description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏ cachevault', fileCode: 'sn_cachevault2', requiresFile: true, sortOrder: 210, isRequired: true, estimatedMinutes: 15 },
      { groupCode: 'TESTING', title: '–°—Ç—Ä–µ—Å—Å —Ç–µ—Å—Ç 3 (60 –º–∏–Ω)', description: '–ü—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ 60 –º–∏–Ω—É—Ç', fileCode: 'sn_gtk32', requiresFile: true, sortOrder: 220, isRequired: true, estimatedMinutes: 60 },
      { groupCode: 'TESTING', title: '–¢–µ—Å—Ç SSD + —Å–∫—Ä–∏–Ω RAID', description: '–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å SSD –∏ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç RAID', fileCode: 'sn_raid2', requiresFile: true, sortOrder: 230, isRequired: true, estimatedMinutes: 20 },
      { groupCode: 'TESTING', title: '–¢–µ—Å—Ç HDD, SSD + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤', description: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HDD –∏ SSD', fileCode: null, requiresFile: false, sortOrder: 240, isRequired: true, estimatedMinutes: 30 },
      { groupCode: 'TESTING', title: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ (0, 3, 6)', description: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ + —Å–∫—Ä–∏–Ω', fileCode: 'sn_dimm2', requiresFile: true, sortOrder: 250, isRequired: true, estimatedMinutes: 30 },
      { groupCode: 'TESTING', title: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ (11, 12)', description: '–í—ã—è–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞', fileCode: 'sn_dimm2FAIL2', requiresFile: false, sortOrder: 260, isRequired: false, estimatedMinutes: 20 },
      { groupCode: 'TESTING', title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤', description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', fileCode: null, requiresFile: false, sortOrder: 270, isRequired: true, estimatedMinutes: 5 },
      { groupCode: 'TESTING', title: '–í—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –æ–±—â–∏–π –¥–∏—Å–∫', description: '–í—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', fileCode: null, requiresFile: false, sortOrder: 280, isRequired: true, estimatedMinutes: 10 },
      { groupCode: 'TESTING', title: '–°–∫—Ä–∏–Ω BIOS, BMC [dts, die]', description: '–í–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ + —Å–∫—Ä–∏–Ω', fileCode: 'sn_Bios2', requiresFile: true, sortOrder: 290, isRequired: true, estimatedMinutes: 10 },

      { groupCode: 'QC_PRIMARY', title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤ (–û–¢–ö)', description: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', fileCode: null, requiresFile: false, sortOrder: 300, isRequired: true, estimatedMinutes: 15 },

      { groupCode: 'BURN_IN', title: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–æ–Ω', description: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –ø—Ä–æ–≥–æ–Ω (burn-in)', fileCode: null, requiresFile: false, sortOrder: 400, isRequired: true, estimatedMinutes: 1440 },

      { groupCode: 'QC_FINAL', title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–æ–Ω–∞ (–û–¢–ö)', description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≥–æ–Ω–∞', fileCode: null, requiresFile: false, sortOrder: 500, isRequired: true, estimatedMinutes: 10 }
    ];

    await BeryllChecklistTemplate.bulkCreate(templates);
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${templates.length} —à–∞–±–ª–æ–Ω–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞`);
  } catch (e) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —à–∞–±–ª–æ–Ω–æ–≤:', e);
  }
}

module.exports = new ChecklistService();
module.exports.initChecklistTemplates = initChecklistTemplates;

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/ClusterService.js
================================================================================


const { Op } = require("sequelize");

const {
  BeryllShipment,
  BeryllCluster,
  BeryllClusterServer,
  BeryllExtendedHistory,
  SHIPMENT_STATUSES,
  CLUSTER_STATUSES,
  SERVER_ROLES,
  BeryllServer,
  User
} = require("../../../models/index");

class ClusterService {


  async getAllShipments(options = {}) {
    const { status, search, city } = options;

    const where = {};
    if (status) where.status = status;
    if (city) where.destinationCity = { [Op.iLike]: `%${city}%` };
    if (search) {
      where[Op.or] = [
        { name: { [Op.iLike]: `%${search}%` } },
        { destinationCity: { [Op.iLike]: `%${search}%` } },
        { waybillNumber: { [Op.iLike]: `%${search}%` } }
      ];
    }

    const shipments = await BeryllShipment.findAll({
      where,
      include: [
        { model: User, as: "createdBy", attributes: ["id", "login", "name", "surname"] },
        {
          model: BeryllCluster,
          as: "clusters",
          include: [
            {
              model: BeryllClusterServer,
              as: "clusterServers",
              attributes: ["id"]
            }
          ]
        }
      ],
      order: [["createdAt", "DESC"]]
    });


    return shipments.map(shipment => {
      const data = shipment.toJSON();
      const totalServers = data.clusters?.reduce((sum, c) => sum + (c.clusterServers?.length || 0), 0) || 0;
      const clustersCount = data.clusters?.length || 0;

      return {
        ...data,
        clustersCount,
        totalServers,
        completionPercent: data.expectedCount > 0
          ? Math.round((totalServers / data.expectedCount) * 100)
          : 0
      };
    });
  }


  async getShipmentById(id) {
    const shipment = await BeryllShipment.findByPk(id, {
      include: [
        { model: User, as: "createdBy", attributes: ["id", "login", "name", "surname"] },
        {
          model: BeryllCluster,
          as: "clusters",
          include: [
            { model: User, as: "createdBy", attributes: ["id", "login", "name", "surname"] },
            {
              model: BeryllClusterServer,
              as: "clusterServers",
              include: [
                {
                  model: BeryllServer,
                  as: "server",
                  attributes: ["id", "ipAddress", "apkSerialNumber", "hostname", "status"]
                },
                { model: User, as: "addedBy", attributes: ["id", "login", "name", "surname"] }
              ]
            }
          ]
        }
      ]
    });

    if (!shipment) return null;

    const data = shipment.toJSON();
    const totalServers = data.clusters?.reduce((sum, c) => sum + (c.clusterServers?.length || 0), 0) || 0;

    return {
      ...data,
      totalServers,
      completionPercent: data.expectedCount > 0
        ? Math.round((totalServers / data.expectedCount) * 100)
        : 0
    };
  }


  async createShipment(data, userId) {
    const shipment = await BeryllShipment.create({
      name: data.name,
      destinationCity: data.destinationCity,
      destinationAddress: data.destinationAddress,
      contactPerson: data.contactPerson,
      contactPhone: data.contactPhone,
      expectedCount: data.expectedCount || 80,
      status: SHIPMENT_STATUSES.FORMING,
      plannedShipDate: data.plannedShipDate,
      waybillNumber: data.waybillNumber,
      carrier: data.carrier,
      notes: data.notes,
      createdById: userId,
      metadata: data.metadata || {}
    });

    await this.logHistory("SHIPMENT", shipment.id, "CREATED", userId, `–°–æ–∑–¥–∞–Ω –∫–æ–º–ø–ª–µ–∫—Ç "${shipment.name}"`);

    return this.getShipmentById(shipment.id);
  }


  async updateShipment(id, data, userId) {
    const shipment = await BeryllShipment.findByPk(id);
    if (!shipment) throw new Error("–ö–æ–º–ø–ª–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const oldData = shipment.toJSON();

    await shipment.update(data);


    if (data.status && data.status !== oldData.status) {
      if (data.status === SHIPMENT_STATUSES.SHIPPED && !shipment.actualShipDate) {
        await shipment.update({ actualShipDate: new Date() });
      }
      if (data.status === SHIPMENT_STATUSES.DELIVERED && !shipment.deliveredAt) {
        await shipment.update({ deliveredAt: new Date() });
      }
      if (data.status === SHIPMENT_STATUSES.ACCEPTED && !shipment.acceptedAt) {
        await shipment.update({ acceptedAt: new Date() });
      }
    }

    const changes = {};
    Object.keys(data).forEach(key => {
      if (oldData[key] !== data[key]) {
        changes[key] = { from: oldData[key], to: data[key] };
      }
    });

    if (Object.keys(changes).length > 0) {
      await this.logHistory("SHIPMENT", id, "UPDATED", userId, `–û–±–Ω–æ–≤–ª—ë–Ω –∫–æ–º–ø–ª–µ–∫—Ç "${shipment.name}"`, changes);
    }

    return this.getShipmentById(id);
  }


  async deleteShipment(id, userId) {
    const shipment = await BeryllShipment.findByPk(id, {
      include: [{ model: BeryllCluster, as: "clusters" }]
    });

    if (!shipment) throw new Error("–ö–æ–º–ø–ª–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

    if (shipment.clusters && shipment.clusters.length > 0) {
      throw new Error(`–ö–æ–º–ø–ª–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç ${shipment.clusters.length} –∫–ª–∞—Å—Ç–µ—Ä–æ–≤. –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç–µ –∏—Ö.`);
    }

    await this.logHistory("SHIPMENT", id, "DELETED", userId, `–£–¥–∞–ª—ë–Ω –∫–æ–º–ø–ª–µ–∫—Ç "${shipment.name}"`);

    await shipment.destroy();

    return { success: true, message: "–ö–æ–º–ø–ª–µ–∫—Ç —É–¥–∞–ª—ë–Ω" };
  }

  async getAllClusters(options = {}) {
    const { status, shipmentId, search } = options;

    const where = {};
    if (status) where.status = status;
    if (shipmentId !== undefined) {
      where.shipmentId = shipmentId === "null" ? null : shipmentId;
    }
    if (search) {
      where[Op.or] = [
        { name: { [Op.iLike]: `%${search}%` } },
        { description: { [Op.iLike]: `%${search}%` } }
      ];
    }

    const clusters = await BeryllCluster.findAll({
      where,
      include: [
        { model: BeryllShipment, as: "shipment", attributes: ["id", "name", "destinationCity"] },
        { model: User, as: "createdBy", attributes: ["id", "login", "name", "surname"] },
        {
          model: BeryllClusterServer,
          as: "clusterServers",
          include: [
            { model: BeryllServer, as: "server", attributes: ["id", "apkSerialNumber", "status"] }
          ]
        }
      ],
      order: [["createdAt", "DESC"]]
    });

    return clusters.map(cluster => {
      const data = cluster.toJSON();
      const serversCount = data.clusterServers?.length || 0;
      const masterCount = data.clusterServers?.filter(cs => cs.role === SERVER_ROLES.MASTER).length || 0;
      const workerCount = data.clusterServers?.filter(cs => cs.role === SERVER_ROLES.WORKER).length || 0;

      return {
        ...data,
        serversCount,
        masterCount,
        workerCount,
        completionPercent: data.expectedCount > 0
          ? Math.round((serversCount / data.expectedCount) * 100)
          : 0
      };
    });
  }


  async getClusterById(id) {
    const cluster = await BeryllCluster.findByPk(id, {
      include: [
        { model: BeryllShipment, as: "shipment" },
        { model: User, as: "createdBy", attributes: ["id", "login", "name", "surname"] },
        {
          model: BeryllClusterServer,
          as: "clusterServers",
          include: [
            {
              model: BeryllServer,
              as: "server",
              attributes: ["id", "ipAddress", "apkSerialNumber", "hostname", "status", "macAddress"]
            },
            { model: User, as: "addedBy", attributes: ["id", "login", "name", "surname"] }
          ],
          order: [["orderNumber", "ASC"]]
        }
      ]
    });

    if (!cluster) return null;

    const data = cluster.toJSON();
    const serversCount = data.clusterServers?.length || 0;

    return {
      ...data,
      serversCount,
      completionPercent: data.expectedCount > 0
        ? Math.round((serversCount / data.expectedCount) * 100)
        : 0
    };
  }


  async createCluster(data, userId) {
    const cluster = await BeryllCluster.create({
      name: data.name,
      description: data.description,
      shipmentId: data.shipmentId || null,
      expectedCount: data.expectedCount || 10,
      status: CLUSTER_STATUSES.FORMING,
      configVersion: data.configVersion,
      notes: data.notes,
      createdById: userId,
      metadata: data.metadata || {}
    });

    await this.logHistory("CLUSTER", cluster.id, "CREATED", userId, `–°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Ç–µ—Ä "${cluster.name}"`);

    return this.getClusterById(cluster.id);
  }


  async updateCluster(id, data, userId) {
    const cluster = await BeryllCluster.findByPk(id);
    if (!cluster) throw new Error("–ö–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const oldData = cluster.toJSON();

    await cluster.update(data);

    const changes = {};
    Object.keys(data).forEach(key => {
      if (oldData[key] !== data[key]) {
        changes[key] = { from: oldData[key], to: data[key] };
      }
    });

    if (Object.keys(changes).length > 0) {
      await this.logHistory("CLUSTER", id, "UPDATED", userId, `–û–±–Ω–æ–≤–ª—ë–Ω –∫–ª–∞—Å—Ç–µ—Ä "${cluster.name}"`, changes);
    }

    return this.getClusterById(id);
  }

  async deleteCluster(id, userId) {
    const cluster = await BeryllCluster.findByPk(id);
    if (!cluster) throw new Error("–ö–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");

    await this.logHistory("CLUSTER", id, "DELETED", userId, `–£–¥–∞–ª—ë–Ω –∫–ª–∞—Å—Ç–µ—Ä "${cluster.name}"`);

    await cluster.destroy();

    return { success: true, message: "–ö–ª–∞—Å—Ç–µ—Ä —É–¥–∞–ª—ë–Ω" };
  }


  async addServerToCluster(clusterId, serverId, data, userId) {

    const cluster = await BeryllCluster.findByPk(clusterId);
    if (!cluster) throw new Error("–ö–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const server = await BeryllServer.findByPk(serverId);
    if (!server) throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const existing = await BeryllClusterServer.findOne({
      where: { clusterId, serverId }
    });

    if (existing) {
      throw new Error("–°–µ—Ä–≤–µ—Ä —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —ç—Ç–æ—Ç –∫–ª–∞—Å—Ç–µ—Ä");
    }

    const lastOrder = await BeryllClusterServer.max("orderNumber", {
      where: { clusterId }
    });

    const clusterServer = await BeryllClusterServer.create({
      clusterId,
      serverId,
      role: data.role || SERVER_ROLES.WORKER,
      orderNumber: data.orderNumber || (lastOrder || 0) + 1,
      clusterHostname: data.clusterHostname,
      clusterIpAddress: data.clusterIpAddress,
      notes: data.notes,
      addedAt: new Date(),
      addedById: userId
    });

    await this.logHistory("CLUSTER", clusterId, "SERVER_ADDED", userId,
      `–°–µ—Ä–≤–µ—Ä ${server.apkSerialNumber || serverId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä`,
      { serverId, role: data.role }
    );

    return this.getClusterServerById(clusterServer.id);
  }


  async addServersToCluster(clusterId, serverIds, data, userId) {
    const cluster = await BeryllCluster.findByPk(clusterId);
    if (!cluster) throw new Error("–ö–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const results = [];
    let orderNumber = await BeryllClusterServer.max("orderNumber", { where: { clusterId } }) || 0;

    for (const serverId of serverIds) {
      try {

        const existing = await BeryllClusterServer.findOne({ where: { clusterId, serverId } });
        if (existing) continue;

        orderNumber++;

        const clusterServer = await BeryllClusterServer.create({
          clusterId,
          serverId,
          role: data.role || SERVER_ROLES.WORKER,
          orderNumber,
          addedAt: new Date(),
          addedById: userId
        });

        results.push({ serverId, success: true, id: clusterServer.id });
      } catch (error) {
        results.push({ serverId, success: false, error: error.message });
      }
    }

    const successCount = results.filter(r => r.success).length;
    await this.logHistory("CLUSTER", clusterId, "SERVERS_ADDED", userId,
      `–î–æ–±–∞–≤–ª–µ–Ω–æ ${successCount} —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä`
    );

    return { added: successCount, results };
  }

  async removeServerFromCluster(clusterId, serverId, userId) {
    const clusterServer = await BeryllClusterServer.findOne({
      where: { clusterId, serverId },
      include: [{ model: BeryllServer, as: "server" }]
    });

    if (!clusterServer) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ");
    }

    const serverSerial = clusterServer.server?.apkSerialNumber || serverId;

    await clusterServer.destroy();

    await this.logHistory("CLUSTER", clusterId, "SERVER_REMOVED", userId,
      `–°–µ—Ä–≤–µ—Ä ${serverSerial} —É–¥–∞–ª—ë–Ω –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞`,
      { serverId }
    );

    return { success: true, message: "–°–µ—Ä–≤–µ—Ä —É–¥–∞–ª—ë–Ω –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞" };
  }

  async updateClusterServer(clusterServerId, data, userId) {
    const clusterServer = await BeryllClusterServer.findByPk(clusterServerId);
    if (!clusterServer) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

    await clusterServer.update({
      role: data.role !== undefined ? data.role : clusterServer.role,
      orderNumber: data.orderNumber !== undefined ? data.orderNumber : clusterServer.orderNumber,
      clusterHostname: data.clusterHostname !== undefined ? data.clusterHostname : clusterServer.clusterHostname,
      clusterIpAddress: data.clusterIpAddress !== undefined ? data.clusterIpAddress : clusterServer.clusterIpAddress,
      notes: data.notes !== undefined ? data.notes : clusterServer.notes
    });

    await this.logHistory("CLUSTER", clusterServer.clusterId, "SERVER_UPDATED", userId,
      `–û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ`
    );

    return this.getClusterServerById(clusterServerId);
  }

  async getClusterServerById(id) {
    return BeryllClusterServer.findByPk(id, {
      include: [
        { model: BeryllCluster, as: "cluster" },
        { model: BeryllServer, as: "server" },
        { model: User, as: "addedBy", attributes: ["id", "login", "name", "surname"] }
      ]
    });
  }


  async getUnassignedServers(options = {}) {
    const { status, batchId, search, limit = 100 } = options;

    const assignedServerIds = await BeryllClusterServer.findAll({
      attributes: ["serverId"]
    }).then(rows => rows.map(r => r.serverId));

    const where = {};
    if (assignedServerIds.length > 0) {
      where.id = { [Op.notIn]: assignedServerIds };
    }
    if (status) where.status = status;
    if (batchId) where.batchId = batchId;
    if (search) {
      where[Op.or] = [
        { apkSerialNumber: { [Op.iLike]: `%${search}%` } },
        { hostname: { [Op.iLike]: `%${search}%` } },
        { ipAddress: { [Op.iLike]: `%${search}%` } }
      ];
    }

    return BeryllServer.findAll({
      where,
      attributes: ["id", "apkSerialNumber", "hostname", "ipAddress", "status"],
      limit,
      order: [["apkSerialNumber", "ASC"]]
    });
  }

  async getServerClusters(serverId) {
    return BeryllClusterServer.findAll({
      where: { serverId },
      include: [
        { model: BeryllCluster, as: "cluster", include: [{ model: BeryllShipment, as: "shipment" }] }
      ]
    });
  }


  async logHistory(entityType, entityId, action, userId, comment, changes = null) {
    return BeryllExtendedHistory.create({
      entityType,
      entityId,
      action,
      userId,
      comment,
      changes
    });
  }

  async getHistory(entityType, entityId, options = {}) {
    const { limit = 50, offset = 0 } = options;

    return BeryllExtendedHistory.findAndCountAll({
      where: { entityType, entityId },
      include: [
        { model: User, as: "user", attributes: ["id", "login", "name", "surname"] }
      ],
      order: [["createdAt", "DESC"]],
      limit,
      offset
    });
  }
}

module.exports = new ClusterService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/ComponentInventoryService.js
================================================================================


const { Op } = require("sequelize");
const sequelize = require("../../../db");
const {
    ComponentCatalog,
    ComponentInventory,
    ComponentHistory,
    BeryllServer,
    BeryllServerComponent,
    User,
    COMPONENT_TYPES,
    INVENTORY_STATUSES,
    COMPONENT_CONDITIONS,
    HISTORY_ACTIONS
} = require("../../../models/index");

class ComponentInventoryService {


    async getOrCreateCatalogEntry(data) {
        const { type, manufacturer, model, revision, partNumber, specifications } = data;

        const [catalog, created] = await ComponentCatalog.findOrCreate({
            where: { type, manufacturer: manufacturer || null, model },
            defaults: {
                revision,
                partNumber,
                specifications: specifications || {},
                isActive: true
            }
        });

        return { catalog, created };
    }


    async getCatalogByType(type) {
        return ComponentCatalog.findAll({
            where: { type, isActive: true },
            order: [["manufacturer", "ASC"], ["model", "ASC"]]
        });
    }


    async updateCatalogEntry(id, data) {
        const catalog = await ComponentCatalog.findByPk(id);
        if (!catalog) throw new Error("–ó–∞–ø–∏—Å—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        await catalog.update(data);
        return catalog;
    }

    async addToInventory(data, userId) {
        const transaction = await sequelize.transaction();

        try {
            const {
                type,
                serialNumber,
                serialNumberYadro,
                manufacturer,
                model,
                condition = COMPONENT_CONDITIONS.NEW,
                location,
                purchaseDate,
                warrantyExpires,
                notes
            } = data;

            const existing = await ComponentInventory.findOne({
                where: {
                    [Op.or]: [
                        { serialNumber },
                        serialNumberYadro ? { serialNumberYadro } : {}
                    ]
                }
            });

            if (existing) {
                throw new Error(`–ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å —Å–µ—Ä–∏–π–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º ${serialNumber} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
            }

            let catalogId = null;
            if (manufacturer && model) {
                const { catalog } = await this.getOrCreateCatalogEntry({ type, manufacturer, model });
                catalogId = catalog.id;
            }

            const component = await ComponentInventory.create({
                catalogId,
                type,
                serialNumber,
                serialNumberYadro,
                manufacturer,
                model,
                status: INVENTORY_STATUSES.AVAILABLE,
                condition,
                location,
                purchaseDate,
                warrantyExpires,
                notes,
                createdById: userId
            }, { transaction });

            await ComponentHistory.create({
                inventoryComponentId: component.id,
                action: HISTORY_ACTIONS.RECEIVED,
                toLocation: location,
                performedById: userId,
                notes: `–î–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å. –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${condition}`
            }, { transaction });

            await transaction.commit();
            return component;

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }

    async bulkAddToInventory(items, userId) {
        const results = {
            success: [],
            errors: []
        };

        for (const item of items) {
            try {
                const component = await this.addToInventory(item, userId);
                results.success.push({
                    serialNumber: item.serialNumber,
                    id: component.id
                });
            } catch (error) {
                results.errors.push({
                    serialNumber: item.serialNumber,
                    error: error.message
                });
            }
        }

        return results;
    }

    async getById(id) {
        return ComponentInventory.findByPk(id, {
            include: [
                { model: ComponentCatalog, as: "catalog" },
                { model: BeryllServer, as: "currentServer" },
                { model: User, as: "createdBy", attributes: ["id", "name", "surname"] }
            ]
        });
    }


    async getBySerial(serial) {
        return ComponentInventory.findOne({
            where: {
                [Op.or]: [
                    { serialNumber: { [Op.iLike]: serial } },
                    { serialNumberYadro: { [Op.iLike]: serial } }
                ]
            },
            include: [
                { model: ComponentCatalog, as: "catalog" },
                { model: BeryllServer, as: "currentServer" }
            ]
        });
    }


    async getAll(filters = {}) {
        const {
            type,
            status,
            condition,
            manufacturer,
            model,
            search,
            serverId,
            location,
            warrantyExpired,
            limit = 50,
            offset = 0
        } = filters;

        const where = {};

        if (type) where.type = type;
        if (status) where.status = status;
        if (condition) where.condition = condition;
        if (manufacturer) where.manufacturer = { [Op.iLike]: `%${manufacturer}%` };
        if (model) where.model = { [Op.iLike]: `%${model}%` };
        if (serverId) where.currentServerId = serverId;
        if (location) where.location = { [Op.iLike]: `%${location}%` };

        if (warrantyExpired === true) {
            where.warrantyExpires = { [Op.lt]: new Date() };
        } else if (warrantyExpired === false) {
            where.warrantyExpires = { [Op.gte]: new Date() };
        }

        if (search) {
            where[Op.or] = [
                { serialNumber: { [Op.iLike]: `%${search}%` } },
                { serialNumberYadro: { [Op.iLike]: `%${search}%` } },
                { model: { [Op.iLike]: `%${search}%` } }
            ];
        }

        return ComponentInventory.findAndCountAll({
            where,
            include: [
                { model: ComponentCatalog, as: "catalog" },
                { model: BeryllServer, as: "currentServer", attributes: ["id", "apkSerialNumber", "hostname"] }
            ],
            order: [["createdAt", "DESC"]],
            limit,
            offset
        });
    }


    async getAvailableByType(type, count = 10) {
        return ComponentInventory.findAll({
            where: {
                type,
                status: INVENTORY_STATUSES.AVAILABLE
            },
            include: [{ model: ComponentCatalog, as: "catalog" }],
            order: [
                ["condition", "ASC"],
                ["createdAt", "ASC"]
            ],
            limit: count
        });
    }


    async reserve(id, defectId, userId) {
        const component = await ComponentInventory.findByPk(id);
        if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

        return component.reserve(defectId, userId);
    }

    async release(id, userId, notes = null) {
        const component = await ComponentInventory.findByPk(id);
        if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

        return component.release(userId, notes);
    }


    async installToServer(id, serverId, userId, defectId = null) {
        const component = await ComponentInventory.findByPk(id);
        if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

        const server = await BeryllServer.findByPk(serverId);
        if (!server) throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");

        return component.installToServer(serverId, userId, defectId);
    }


    async removeFromServer(id, userId, reason = null, defectId = null) {
        const component = await ComponentInventory.findByPk(id);
        if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

        return component.removeFromServer(userId, reason, defectId);
    }


    async sendToYadro(id, ticketNumber, userId) {
        const component = await ComponentInventory.findByPk(id);
        if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

        return component.sendToYadro(ticketNumber, userId);
    }


    async returnFromYadro(id, userId, condition = COMPONENT_CONDITIONS.REFURBISHED) {
        const component = await ComponentInventory.findByPk(id);
        if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

        return component.returnFromYadro(userId, condition);
    }

    async scrap(id, userId, reason) {
        const transaction = await sequelize.transaction();

        try {
            const component = await ComponentInventory.findByPk(id);
            if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

            await component.update({
                status: INVENTORY_STATUSES.SCRAPPED,
                currentServerId: null,
                reservedForDefectId: null
            }, { transaction });

            await ComponentHistory.create({
                inventoryComponentId: id,
                action: HISTORY_ACTIONS.SCRAPPED,
                performedById: userId,
                notes: reason || "–°–ø–∏—Å–∞–Ω"
            }, { transaction });

            await transaction.commit();
            return component;

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async updateLocation(id, location, userId) {
        const transaction = await sequelize.transaction();

        try {
            const component = await ComponentInventory.findByPk(id);
            if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

            const fromLocation = component.location;

            await component.update({ location }, { transaction });

            await ComponentHistory.create({
                inventoryComponentId: id,
                action: HISTORY_ACTIONS.TRANSFERRED,
                fromLocation,
                toLocation: location,
                performedById: userId,
                notes: `–ü–µ—Ä–µ–º–µ—â—ë–Ω –∏–∑ "${fromLocation || "N/A"}" –≤ "${location}"`
            }, { transaction });

            await transaction.commit();
            return component;

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }

    async markTested(id, userId, passed, notes = null) {
        const transaction = await sequelize.transaction();

        try {
            const component = await ComponentInventory.findByPk(id);
            if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

            await component.update({
                lastTestedAt: new Date(),
                status: passed ? INVENTORY_STATUSES.AVAILABLE : INVENTORY_STATUSES.DEFECTIVE
            }, { transaction });

            await ComponentHistory.create({
                inventoryComponentId: id,
                action: HISTORY_ACTIONS.TESTED,
                performedById: userId,
                metadata: { passed },
                notes: notes || (passed ? "–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω" : "–¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω")
            }, { transaction });

            await transaction.commit();
            return component;

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async getHistory(id) {
        return ComponentHistory.findAll({
            where: { inventoryComponentId: id },
            include: [
                { model: User, as: "performedBy", attributes: ["id", "name", "surname"] },
                { model: BeryllServer, as: "fromServer", attributes: ["id", "apkSerialNumber"] },
                { model: BeryllServer, as: "toServer", attributes: ["id", "apkSerialNumber"] }
            ],
            order: [["performedAt", "DESC"]]
        });
    }

    async getStats() {

        const byTypeStatus = await ComponentInventory.findAll({
            attributes: [
                "type",
                "status",
                [sequelize.fn("COUNT", sequelize.col("id")), "count"]
            ],
            group: ["type", "status"],
            raw: true
        });


        const stats = {};
        for (const row of byTypeStatus) {
            if (!stats[row.type]) {
                stats[row.type] = { total: 0 };
            }
            stats[row.type][row.status] = parseInt(row.count);
            stats[row.type].total += parseInt(row.count);
        }

        const totals = await ComponentInventory.findOne({
            attributes: [
                [sequelize.fn("COUNT", sequelize.col("id")), "total"],
                [sequelize.fn("COUNT", sequelize.literal(`CASE WHEN status = 'AVAILABLE' THEN 1 END`)), "available"],
                [sequelize.fn("COUNT", sequelize.literal(`CASE WHEN status = 'IN_USE' THEN 1 END`)), "inUse"],
                [sequelize.fn("COUNT", sequelize.literal(`CASE WHEN status = 'DEFECTIVE' THEN 1 END`)), "defective"],
                [sequelize.fn("COUNT", sequelize.literal(`CASE WHEN status = 'IN_REPAIR' THEN 1 END`)), "inRepair"]
            ],
            raw: true
        });

        const warrantyExpiringSoon = await ComponentInventory.count({
            where: {
                warrantyExpires: {
                    [Op.between]: [new Date(), new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)]
                }
            }
        });

        return {
            byType: stats,
            totals: {
                total: parseInt(totals.total) || 0,
                available: parseInt(totals.available) || 0,
                inUse: parseInt(totals.inUse) || 0,
                defective: parseInt(totals.defective) || 0,
                inRepair: parseInt(totals.inRepair) || 0
            },
            warrantyExpiringSoon
        };
    }


    async getWarrantyExpiring(days = 30) {
        return ComponentInventory.findAll({
            where: {
                warrantyExpires: {
                    [Op.between]: [new Date(), new Date(Date.now() + days * 24 * 60 * 60 * 1000)]
                }
            },
            include: [{ model: ComponentCatalog, as: "catalog" }],
            order: [["warrantyExpires", "ASC"]]
        });
    }


    parseExcelRow(row, columnMapping) {
        const components = [];


        for (let i = 0; i < 12; i++) {
            const snYadro = row[columnMapping.hdd[i]?.yadro];
            const snManuf = row[columnMapping.hdd[i]?.manuf];

            if (snYadro || snManuf) {
                components.push({
                    type: COMPONENT_TYPES.HDD,
                    serialNumberYadro: snYadro,
                    serialNumber: snManuf,
                    manufacturer: "Seagate",
                    model: "STL015"
                });
            }
        }


        for (let i = 0; i < 12; i++) {
            const snYadro = row[columnMapping.ram[i]?.yadro];
            const snManuf = row[columnMapping.ram[i]?.manuf];

            if (snYadro || snManuf) {
                components.push({
                    type: COMPONENT_TYPES.RAM,
                    serialNumberYadro: snYadro,
                    serialNumber: snManuf,
                    manufacturer: "Samsung",
                    model: "KR M393A8G40AB2-CWEC0"
                });
            }
        }

        for (let i = 0; i < 4; i++) {
            const snYadro = row[columnMapping.ssd[i]?.yadro];
            const snManuf = row[columnMapping.ssd[i]?.manuf];

            if (snYadro || snManuf) {
                components.push({
                    type: COMPONENT_TYPES.SSD,
                    serialNumberYadro: snYadro,
                    serialNumber: snManuf
                });
            }
        }

        for (let i = 0; i < 2; i++) {
            const snYadro = row[columnMapping.psu[i]?.yadro];
            const snManuf = row[columnMapping.psu[i]?.manuf];

            if (snYadro || snManuf) {
                components.push({
                    type: COMPONENT_TYPES.PSU,
                    serialNumberYadro: snYadro,
                    serialNumber: snManuf,
                    manufacturer: "Aspower",
                    model: "U1A-D11200-DRB"
                });
            }
        }

        return components;
    }


    async importServerComponents(serverId, componentsData, userId) {
        const transaction = await sequelize.transaction();
        const results = { created: 0, errors: [] };

        try {
            for (const data of componentsData) {
                try {
                    const existing = await ComponentInventory.findOne({
                        where: {
                            [Op.or]: [
                                data.serialNumber ? { serialNumber: data.serialNumber } : {},
                                data.serialNumberYadro ? { serialNumberYadro: data.serialNumberYadro } : {}
                            ].filter(o => Object.keys(o).length > 0)
                        }
                    });

                    if (existing) {
                        await existing.update({
                            currentServerId: serverId,
                            status: INVENTORY_STATUSES.IN_USE
                        }, { transaction });
                    } else {
                        await ComponentInventory.create({
                            ...data,
                            currentServerId: serverId,
                            status: INVENTORY_STATUSES.IN_USE,
                            createdById: userId
                        }, { transaction });
                        results.created++;
                    }
                } catch (err) {
                    results.errors.push({
                        serialNumber: data.serialNumber || data.serialNumberYadro,
                        error: err.message
                    });
                }
            }

            await transaction.commit();
            return results;

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }
}

module.exports = new ComponentInventoryService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/DefectExportService.js
================================================================================


const ExcelJS = require("exceljs");
const { Op } = require("sequelize");

const STATUS_LABELS = {
    NEW: "–ù–æ–≤–∞—è",
    DIAGNOSING: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
    WAITING_PARTS: "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π",
    REPAIRING: "–†–µ–º–æ–Ω—Ç",
    SENT_TO_YADRO: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –Ø–¥—Ä–æ",
    RETURNED: "–í–æ–∑–≤—Ä–∞—Ç –∏–∑ –Ø–¥—Ä–æ",
    RESOLVED: "–†–µ—à–µ–Ω–æ",
    REPEATED: "–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫",
    CLOSED: "–ó–∞–∫—Ä—ã—Ç–æ"
};


const PART_TYPE_LABELS = {
    RAM: "–û–ó–£",
    HDD: "HDD",
    SSD: "SSD",
    MOTHERBOARD: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞",
    CPU: "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä",
    PSU: "–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è",
    FAN: "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä",
    NIC: "–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞",
    RAID: "RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä",
    BACKPLANE: "Backplane",
    BMC: "BMC –º–æ–¥—É–ª—å",
    CABLE: "–ö–∞–±–µ–ª—å",
    GPU: "–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞",
    OTHER: "–ü—Ä–æ—á–µ–µ"
};


function formatUserName(user) {
    if (!user) return "";

    const surname = user.surname || "";
    const name = user.name || "";

    if (surname && name) {
        return `${surname} ${name.charAt(0)}.`;
    }

    return surname || name || "";
}


function formatDate(date) {
    if (!date) return "";
    const d = new Date(date);
    return d.toLocaleDateString("ru-RU", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
    });
}

function buildStepsHistory(record) {
    const steps = [];

    if (record.detectedAt) {
        steps.push(`${formatDate(record.detectedAt)}: –û–±–Ω–∞—Ä—É–∂–µ–Ω –¥–µ—Ñ–µ–∫—Ç`);
    }

    if (record.diagnosisStartedAt) {
        steps.push(`${formatDate(record.diagnosisStartedAt)}: –ù–∞—á–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞`);
    }

    if (record.diagnosisCompletedAt) {
        steps.push(`${formatDate(record.diagnosisCompletedAt)}: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞`);
    }

    if (record.repairStartedAt) {
        steps.push(`${formatDate(record.repairStartedAt)}: –ù–∞—á–∞—Ç —Ä–µ–º–æ–Ω—Ç`);
    }

    if (record.sentToYadroAt) {
        steps.push(`${formatDate(record.sentToYadroAt)}: –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –Ø–¥—Ä–æ`);
    }

    if (record.returnedFromYadroAt) {
        steps.push(`${formatDate(record.returnedFromYadroAt)}: –í–æ–∑–≤—Ä–∞—Ç –∏–∑ –Ø–¥—Ä–æ`);
    }

    if (record.repairCompletedAt) {
        steps.push(`${formatDate(record.repairCompletedAt)}: –†–µ–º–æ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω`);
    }

    if (record.resolvedAt) {
        steps.push(`${formatDate(record.resolvedAt)}: –†–µ—à–µ–Ω–æ`);
    }

    if (record.repairDetails) {
        steps.push(`–î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞: ${record.repairDetails}`);
    }

    if (record.resolution) {
        steps.push(`–†–µ–∑–æ–ª—é—Ü–∏—è: ${record.resolution}`);
    }

    return steps.join("\n");
}


function getResponsiblePerson(record) {
    if (record.diagnostician) {
        return formatUserName(record.diagnostician);
    }
    if (record.resolvedBy) {
        return formatUserName(record.resolvedBy);
    }
    if (record.detectedBy) {
        return formatUserName(record.detectedBy);
    }
    return "";
}


function applyHeaderStyle(sheet) {
    sheet.getRow(1).height = 30;
    sheet.getRow(1).eachCell((cell) => {
        cell.font = { bold: true, color: { argb: "FFFFFFFF" }, size: 11 };
        cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF4472C4" } };
        cell.alignment = { horizontal: "center", vertical: "middle", wrapText: true };
        cell.border = {
            top: { style: "thin" },
            left: { style: "thin" },
            bottom: { style: "thin" },
            right: { style: "thin" }
        };
    });
}


const DefectExportService = {


    exportToExcel: async function(options = {}) {
        const {
            status,
            dateFrom,
            dateTo,
            serverId,
            search
        } = options;

        const {
            BeryllDefectRecord,
            BeryllServer,
            User
        } = require("../../../models/index");


        const where = {};

        if (status) {
            where.status = status;
        }

        if (dateFrom || dateTo) {
            where.detectedAt = {};
            if (dateFrom) where.detectedAt[Op.gte] = new Date(dateFrom);
            if (dateTo) where.detectedAt[Op.lte] = new Date(dateTo);
        }

        if (serverId) {
            where.serverId = serverId;
        }

        if (search) {
            where[Op.or] = [
                { yadroTicketNumber: { [Op.iLike]: `%${search}%` } },
                { problemDescription: { [Op.iLike]: `%${search}%` } },
                { notes: { [Op.iLike]: `%${search}%` } },
                { serverSerial: { [Op.iLike]: `%${search}%` } }
            ];
        }


        const records = await BeryllDefectRecord.findAll({
            where,
            include: [
                {
                    model: BeryllServer,
                    as: "server",
                    attributes: ["id", "apkSerialNumber", "hostname"],
                    required: false
                },
                {
                    model: User,
                    as: "detectedBy",
                    attributes: ["id", "name", "surname"],
                    required: false
                },
                {
                    model: User,
                    as: "diagnostician",
                    attributes: ["id", "name", "surname"],
                    required: false
                },
                {
                    model: User,
                    as: "resolvedBy",
                    attributes: ["id", "name", "surname"],
                    required: false
                }

            ],
            order: [["detectedAt", "DESC"]]
        });


        const workbook = new ExcelJS.Workbook();
        workbook.creator = "MES Kryptonit";
        workbook.created = new Date();

        const sheet = workbook.addWorksheet("–ë—Ä–∞–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤", {
            pageSetup: {
                paperSize: 9,
                orientation: "landscape"
            }
        });

        sheet.columns = [
            { header: "‚Ññ", key: "num", width: 5 },
            { header: "–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –≤ –Ø–¥—Ä–µ", key: "yadroTicket", width: 18 },
            { header: "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞", key: "serverSerial", width: 20 },
            { header: "–ù–∞–ª–∏—á–∏–µ –°–ü–∏–°–ò", key: "hasSPISI", width: 12 },
            { header: "–ö–ª–∞—Å—Ç–µ—Ä", key: "cluster", width: 15 },
            { header: "–ó–∞—è–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞", key: "problem", width: 45 },
            { header: "–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂.", key: "detectedAt", width: 14 },
            { header: "–ó–∞–Ω–∏–º–∞–ª—Å—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π", key: "diagnostician", width: 22 },
            { header: "–î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞", key: "partType", width: 18 },
            { header: "s/n yadro (–±—Ä–∞–∫)", key: "defectSnYadro", width: 22 },
            { header: "s/n –ø–ª–∞—à–∫–∏ (–±—Ä–∞–∫)", key: "defectSnManuf", width: 18 },
            { header: "s/n yadro (–∑–∞–º–µ–Ω–∞)", key: "replacementSnYadro", width: 22 },
            { header: "s/n –ø–ª–∞—à–∫–∏ (–∑–∞–º–µ–Ω–∞)", key: "replacementSnManuf", width: 18 },
            { header: "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è", key: "notes", width: 35 },
            { header: "–ü–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–±—Ä–∞–∫–æ–≤–∞–Ω", key: "repeated", width: 20 },
            { header: "–°–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–¥–º–µ–Ω—ã", key: "substitute", width: 18 },
            { header: "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –Ø–¥—Ä–æ", key: "sentToYadro", width: 14 },
            { header: "–í–æ–∑–≤—Ä–∞—Ç –∏–∑ –Ø–¥—Ä–æ", key: "returnedFromYadro", width: 14 },
            { header: "–°—Ç–∞—Ç—É—Å", key: "status", width: 15 },
            { header: "–ü—Ä–æ–¥–µ–ª–∞–Ω–Ω—ã–µ —à–∞–≥–∏", key: "steps", width: 50 },
            { header: "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π", key: "responsible", width: 20 }
        ];


        applyHeaderStyle(sheet);

        let rowNum = 1;
        for (const record of records) {
            const steps = buildStepsHistory(record);
            const responsible = getResponsiblePerson(record);

            const serverSerialValue = record.serverSerial || record.server?.apkSerialNumber || "";

            const row = sheet.addRow({
                num: rowNum++,
                yadroTicket: record.yadroTicketNumber || "",
                serverSerial: serverSerialValue,
                hasSPISI: record.hasSPISI ? "–î–∞" : "–ù–µ—Ç",
                cluster: record.clusterCode || "",
                problem: record.problemDescription || "",
                detectedAt: record.detectedAt ? new Date(record.detectedAt) : "",
                diagnostician: formatUserName(record.diagnostician),
                partType: PART_TYPE_LABELS[record.repairPartType] || record.repairPartType || "",
                defectSnYadro: record.defectPartSerialYadro || "",
                defectSnManuf: record.defectPartSerialManuf || "",
                replacementSnYadro: record.replacementPartSerialYadro || "",
                replacementSnManuf: record.replacementPartSerialManuf || "",
                notes: record.notes || "",
                repeated: record.isRepeatedDefect ?
                    `–î–∞: ${record.repeatedDefectReason || "–ø—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}` : "",
                substitute: record.substituteServerSerial || "",
                sentToYadro: record.sentToYadroAt ? new Date(record.sentToYadroAt) : "",
                returnedFromYadro: record.returnedFromYadroAt ? new Date(record.returnedFromYadroAt) : "",
                status: STATUS_LABELS[record.status] || record.status,
                steps: steps,
                responsible: responsible
            });


            row.eachCell((cell) => {
                cell.alignment = { vertical: "middle", wrapText: true };
                cell.border = {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" }
                };
            });


            ["detectedAt", "sentToYadro", "returnedFromYadro"].forEach(col => {
                const cell = row.getCell(col);
                if (cell.value instanceof Date) {
                    cell.numFmt = "DD.MM.YYYY";
                }
            });

            if (record.isRepeatedDefect) {
                row.getCell("repeated").fill = {
                    type: "pattern",
                    pattern: "solid",
                    fgColor: { argb: "FFFF0000" }
                };
                row.getCell("repeated").font = { color: { argb: "FFFFFFFF" } };
            }

            if (record.status === "SENT_TO_YADRO") {
                row.getCell("status").fill = {
                    type: "pattern",
                    pattern: "solid",
                    fgColor: { argb: "FFFFC000" }
                };
            }
        }

        sheet.autoFilter = {
            from: { row: 1, column: 1 },
            to: { row: records.length + 1, column: sheet.columns.length }
        };

        sheet.views = [{ state: "frozen", ySplit: 1 }];

        const buffer = await workbook.xlsx.writeBuffer();
        return buffer;
    },

    exportStatsToExcel: async function(options = {}) {
        const { BeryllDefectRecord, User } = require("../../../models/index");
        const { Sequelize } = require("sequelize");

        const workbook = new ExcelJS.Workbook();
        workbook.creator = "MES Kryptonit";
        workbook.created = new Date();

        const summarySheet = workbook.addWorksheet("–°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º");

        const statusStats = await BeryllDefectRecord.findAll({
            attributes: [
                "status",
                [Sequelize.fn("COUNT", Sequelize.col("id")), "count"]
            ],
            group: ["status"],
            order: [[Sequelize.fn("COUNT", Sequelize.col("id")), "DESC"]]
        });

        summarySheet.columns = [
            { header: "–°—Ç–∞—Ç—É—Å", key: "status", width: 25 },
            { header: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", key: "count", width: 15 }
        ];

        applyHeaderStyle(summarySheet);

        let totalCount = 0;
        statusStats.forEach(stat => {
            const count = parseInt(stat.dataValues.count);
            totalCount += count;
            const row = summarySheet.addRow({
                status: STATUS_LABELS[stat.status] || stat.status,
                count: count
            });
            row.eachCell(cell => {
                cell.border = {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" }
                };
            });
        });

        const totalRow = summarySheet.addRow({ status: "–ò–¢–û–ì–û", count: totalCount });
        totalRow.font = { bold: true };
        totalRow.eachCell(cell => {
            cell.border = {
                top: { style: "thin" },
                left: { style: "thin" },
                bottom: { style: "thin" },
                right: { style: "thin" }
            };
            cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFE2EFDA" } };
        });

        const partTypeSheet = workbook.addWorksheet("–ü–æ —Ç–∏–ø–∞–º –¥–µ—Ç–∞–ª–µ–π");

        const partTypeStats = await BeryllDefectRecord.findAll({
            attributes: [
                "repairPartType",
                [Sequelize.fn("COUNT", Sequelize.col("id")), "count"]
            ],
            where: {
                repairPartType: { [Op.ne]: null }
            },
            group: ["repairPartType"],
            order: [[Sequelize.fn("COUNT", Sequelize.col("id")), "DESC"]]
        });

        partTypeSheet.columns = [
            { header: "–¢–∏–ø –¥–µ—Ç–∞–ª–∏", key: "partType", width: 25 },
            { header: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", key: "count", width: 15 }
        ];

        applyHeaderStyle(partTypeSheet);

        partTypeStats.forEach(stat => {
            const row = partTypeSheet.addRow({
                partType: PART_TYPE_LABELS[stat.repairPartType] || stat.repairPartType,
                count: parseInt(stat.dataValues.count)
            });
            row.eachCell(cell => {
                cell.border = {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" }
                };
            });
        });

        const diagnosticianSheet = workbook.addWorksheet("–ü–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∞–º");

        const diagnosticianStats = await BeryllDefectRecord.findAll({
            attributes: [
                "diagnosticianId",
                [Sequelize.fn("COUNT", Sequelize.col("BeryllDefectRecord.id")), "count"]
            ],
            include: [{
                model: User,
                as: "diagnostician",
                attributes: ["name", "surname"],
                required: true
            }],
            where: {
                diagnosticianId: { [Op.ne]: null }
            },
            group: ["diagnosticianId", "diagnostician.id", "diagnostician.name", "diagnostician.surname"],
            order: [[Sequelize.fn("COUNT", Sequelize.col("BeryllDefectRecord.id")), "DESC"]]
        });

        diagnosticianSheet.columns = [
            { header: "–î–∏–∞–≥–Ω–æ—Å—Ç", key: "name", width: 30 },
            { header: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤", key: "count", width: 20 }
        ];

        applyHeaderStyle(diagnosticianSheet);

        diagnosticianStats.forEach(stat => {
            const row = diagnosticianSheet.addRow({
                name: formatUserName(stat.diagnostician),
                count: parseInt(stat.dataValues.count)
            });
            row.eachCell(cell => {
                cell.border = {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" }
                };
            });
        });

        const repeatedSheet = workbook.addWorksheet("–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫");

        const repeatedStats = await BeryllDefectRecord.findAll({
            attributes: [
                [Sequelize.fn("COUNT", Sequelize.col("id")), "total"],
                [Sequelize.fn("SUM", Sequelize.literal("CASE WHEN \"isRepeatedDefect\" = true THEN 1 ELSE 0 END")), "repeated"]
            ]
        });

        repeatedSheet.columns = [
            { header: "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å", key: "metric", width: 30 },
            { header: "–ó–Ω–∞—á–µ–Ω–∏–µ", key: "value", width: 15 }
        ];

        applyHeaderStyle(repeatedSheet);

        const total = parseInt(repeatedStats[0]?.dataValues?.total || 0);
        const repeated = parseInt(repeatedStats[0]?.dataValues?.repeated || 0);
        const percent = total > 0 ? ((repeated / total) * 100).toFixed(1) : 0;

        [
            { metric: "–í—Å–µ–≥–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤", value: total },
            { metric: "–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫", value: repeated },
            { metric: "–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –±—Ä–∞–∫–∞", value: `${percent}%` }
        ].forEach(item => {
            const row = repeatedSheet.addRow(item);
            row.eachCell(cell => {
                cell.border = {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" }
                };
            });
        });

        const buffer = await workbook.xlsx.writeBuffer();
        return buffer;
    }
};

module.exports = DefectExportService;

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/DefectMonitoringService.js
================================================================================


const path = require("path");
const fs = require("fs");
const { exec } = require("child_process");
const { promisify } = require("util");
const { Op, fn, col } = require("sequelize");

const execAsync = promisify(exec);


const {
  BeryllServer, BeryllHistory, BeryllDefectComment, BeryllDefectFile,
  HISTORY_ACTIONS, DEFECT_STATUSES
} = require("../../../models/definitions/Beryll");
const { User } = require("../../../models/index");
const sequelize = require("../../../db");

const DEFECT_FILES_DIR = path.join(__dirname, "../../../../uploads/beryll/defects");

let pingCache = new Map();
let lastFullScan = null;
const PING_TIMEOUT = 2;
const CACHE_TTL = 60000;

class DefectMonitoringService {

  async getCommentsByServer(serverId, options = {}) {
    const { status, category, limit = 50, offset = 0 } = options;
    const where = { serverId };
    if (status) where.status = status;
    if (category) where.defectCategory = category;

    const comments = await BeryllDefectComment.findAndCountAll({
      where,
      include: [
        { model: User, as: "author", attributes: ["id", "login", "name", "surname"] },
        { model: User, as: "resolvedBy", attributes: ["id", "login", "name", "surname"] },
        { model: BeryllDefectFile, as: "files", include: [
          { model: User, as: "uploadedBy", attributes: ["id", "login", "name", "surname"] }
        ]}
      ],
      order: [["createdAt", "DESC"]],
      limit: parseInt(limit),
      offset: parseInt(offset)
    });

    return { count: comments.count, rows: comments.rows, page: Math.floor(offset / limit) + 1, totalPages: Math.ceil(comments.count / limit) };
  }

  async getCommentById(commentId) {
    const comment = await BeryllDefectComment.findByPk(commentId, {
      include: [
        { model: User, as: "author", attributes: ["id", "login", "name", "surname"] },
        { model: User, as: "resolvedBy", attributes: ["id", "login", "name", "surname"] },
        { model: BeryllServer, as: "server", attributes: ["id", "ipAddress", "hostname", "serialNumber", "apkSerialNumber"] },
        { model: BeryllDefectFile, as: "files", include: [
          { model: User, as: "uploadedBy", attributes: ["id", "login", "name", "surname"] }
        ]}
      ]
    });
    if (!comment) throw new Error("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω");
    return comment;
  }

  async createComment(serverId, userId, data) {
    const { text, defectCategory, priority } = data;
    const server = await BeryllServer.findByPk(serverId);
    if (!server) throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const comment = await BeryllDefectComment.create({
      serverId, userId, text,
      defectCategory: defectCategory || "OTHER",
      priority: priority || "MEDIUM",
      status: "NEW"
    });

    await BeryllHistory.create({
      serverId, serverIp: server.ipAddress, serverHostname: server.hostname, userId,
      action: "DEFECT_COMMENT_ADDED",
      comment: `–î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${text.substring(0, 100)}`,
      metadata: { commentId: comment.id, defectCategory, priority }
    });

    return this.getCommentById(comment.id);
  }

  async updateComment(commentId, userId, data) {
    const { text, defectCategory, priority, status, resolution } = data;
    const comment = await BeryllDefectComment.findByPk(commentId);
    if (!comment) throw new Error("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const updateData = {};
    if (text !== undefined) updateData.text = text;
    if (defectCategory !== undefined) updateData.defectCategory = defectCategory;
    if (priority !== undefined) updateData.priority = priority;

    if (status !== undefined) {
      updateData.status = status;
      if (status === "RESOLVED" || status === "WONT_FIX") {
        updateData.resolvedById = userId;
        updateData.resolvedAt = new Date();
        if (resolution) updateData.resolution = resolution;
      }
    }

    const oldStatus = comment.status;
    await comment.update(updateData);

    if (status && status !== oldStatus) {
      const server = await BeryllServer.findByPk(comment.serverId);
      await BeryllHistory.create({
        serverId: comment.serverId, serverIp: server?.ipAddress, serverHostname: server?.hostname, userId,
        action: "DEFECT_STATUS_CHANGED",
        comment: `–°—Ç–∞—Ç—É—Å –¥–µ—Ñ–µ–∫—Ç–∞: ${oldStatus} ‚Üí ${status}`,
        metadata: { commentId, fromStatus: oldStatus, toStatus: status, resolution }
      });
    }

    return this.getCommentById(commentId);
  }

  async deleteComment(commentId, userId) {
    const comment = await BeryllDefectComment.findByPk(commentId, {
      include: [{ model: BeryllDefectFile, as: "files" }]
    });
    if (!comment) throw new Error("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω");

    for (const file of comment.files || []) {
      const fullPath = path.join(DEFECT_FILES_DIR, file.filePath);
      if (fs.existsSync(fullPath)) fs.unlinkSync(fullPath);
    }

    const server = await BeryllServer.findByPk(comment.serverId);
    await BeryllHistory.create({
      serverId: comment.serverId, serverIp: server?.ipAddress, serverHostname: server?.hostname, userId,
      action: "DEFECT_COMMENT_DELETED",
      comment: `–£–¥–∞–ª—ë–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π`,
      metadata: { commentId, deletedText: comment.text.substring(0, 100) }
    });

    await comment.destroy();
    return { success: true, message: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª—ë–Ω" };
  }

  async uploadFile(commentId, file, userId) {
    const comment = await BeryllDefectComment.findByPk(commentId, {
      include: [{ model: BeryllServer, as: "server" }]
    });
    if (!comment) throw new Error("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const serverSerial = comment.server?.apkSerialNumber || comment.server?.serialNumber || `server_${comment.serverId}`;
    const serverDir = path.join(DEFECT_FILES_DIR, serverSerial);
    if (!fs.existsSync(serverDir)) fs.mkdirSync(serverDir, { recursive: true });

    const ext = path.extname(file.name);
    const fileName = `defect_${commentId}_${Date.now()}${ext}`;
    const filePath = path.join(serverDir, fileName);

    await file.mv(filePath);

    const fileRecord = await BeryllDefectFile.create({
      commentId, originalName: file.name, fileName,
      filePath: path.join(serverSerial, fileName),
      mimeType: file.mimetype, fileSize: file.size, uploadedById: userId
    });

    await BeryllHistory.create({
      serverId: comment.serverId, serverIp: comment.server?.ipAddress, serverHostname: comment.server?.hostname, userId,
      action: "DEFECT_FILE_UPLOADED",
      comment: `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ${file.name}`,
      metadata: { commentId, fileId: fileRecord.id, fileName: file.name }
    });

    return { success: true, file: { id: fileRecord.id, fileName, originalName: file.name, fileSize: file.size } };
  }

  async getFileForDownload(fileId) {
    const file = await BeryllDefectFile.findByPk(fileId);
    if (!file) throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const fullPath = path.join(DEFECT_FILES_DIR, file.filePath);
    if (!fs.existsSync(fullPath)) throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –¥–∏—Å–∫–µ");

    return { fullPath, originalName: file.originalName, mimeType: file.mimeType };
  }

  async deleteFile(fileId, userId) {
    const file = await BeryllDefectFile.findByPk(fileId, {
      include: [{ model: BeryllDefectComment, as: "comment", include: [{ model: BeryllServer, as: "server" }] }]
    });
    if (!file) throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const fullPath = path.join(DEFECT_FILES_DIR, file.filePath);
    if (fs.existsSync(fullPath)) fs.unlinkSync(fullPath);

    await BeryllHistory.create({
      serverId: file.comment?.serverId, serverIp: file.comment?.server?.ipAddress, serverHostname: file.comment?.server?.hostname, userId,
      action: "DEFECT_FILE_DELETED",
      comment: `–£–¥–∞–ª—ë–Ω —Ñ–∞–π–ª: ${file.originalName}`,
      metadata: { fileId, commentId: file.commentId, fileName: file.originalName }
    });

    await file.destroy();
    return { success: true, message: "–§–∞–π–ª —É–¥–∞–ª—ë–Ω" };
  }

  async getDefectStats(options = {}) {
    const { serverId, batchId, dateFrom, dateTo } = options;
    const where = {};

    if (serverId) where.serverId = serverId;
    if (dateFrom || dateTo) {
      where.createdAt = {};
      if (dateFrom) where.createdAt[Op.gte] = new Date(dateFrom);
      if (dateTo) where.createdAt[Op.lte] = new Date(dateTo);
    }
    if (batchId) {
      const servers = await BeryllServer.findAll({ where: { batchId }, attributes: ["id"] });
      where.serverId = { [Op.in]: servers.map(s => s.id) };
    }

    const [byCategory, byStatus, byPriority, total, unresolved] = await Promise.all([
      BeryllDefectComment.findAll({ where, attributes: ["defectCategory", [fn("COUNT", col("id")), "count"]], group: ["defectCategory"], raw: true }),
      BeryllDefectComment.findAll({ where, attributes: ["status", [fn("COUNT", col("id")), "count"]], group: ["status"], raw: true }),
      BeryllDefectComment.findAll({ where, attributes: ["priority", [fn("COUNT", col("id")), "count"]], group: ["priority"], raw: true }),
      BeryllDefectComment.count({ where }),
      BeryllDefectComment.count({ where: { ...where, status: { [Op.in]: ["NEW", "IN_PROGRESS"] } } })
    ]);

    return {
      total, unresolved, resolved: total - unresolved,
      byCategory: byCategory.reduce((acc, i) => { acc[i.defectCategory] = parseInt(i.count); return acc; }, {}),
      byStatus: byStatus.reduce((acc, i) => { acc[i.status] = parseInt(i.count); return acc; }, {}),
      byPriority: byPriority.reduce((acc, i) => { acc[i.priority] = parseInt(i.count); return acc; }, {})
    };
  }

  async pingHost(ipAddress) {
    if (!ipAddress) return { online: false, latency: null, error: "IP –Ω–µ —É–∫–∞–∑–∞–Ω" };

    try {
      const { stdout } = await execAsync(`ping -c 1 -W ${PING_TIMEOUT} ${ipAddress}`, { timeout: (PING_TIMEOUT + 1) * 1000 });
      const latencyMatch = stdout.match(/time[=<](\d+\.?\d*)/);
      return { online: true, latency: latencyMatch ? parseFloat(latencyMatch[1]) : null, error: null };
    } catch (error) {
      return { online: false, latency: null, error: error.message || "Timeout" };
    }
  }

  async pingServer(serverId) {
    const server = await BeryllServer.findByPk(serverId);
    if (!server) throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    if (!server.ipAddress) return { serverId, ipAddress: null, online: false, latency: null, error: "IP –Ω–µ —É–∫–∞–∑–∞–Ω", checkedAt: new Date() };

    const result = await this.pingHost(server.ipAddress);

    await server.update({
      lastPingAt: new Date(),
      pingStatus: result.online ? "ONLINE" : "OFFLINE",
      pingLatency: result.latency
    });

    pingCache.set(serverId, { ...result, serverId, ipAddress: server.ipAddress, hostname: server.hostname, checkedAt: new Date() });

    return { serverId, ipAddress: server.ipAddress, hostname: server.hostname, serialNumber: server.serialNumber, apkSerialNumber: server.apkSerialNumber, ...result, checkedAt: new Date() };
  }

  async pingAllServers(options = {}) {
    const { batchId, status, forceRefresh = false } = options;

    if (!forceRefresh && lastFullScan && (Date.now() - lastFullScan.getTime() < CACHE_TTL)) {
      return this.getCachedStatuses();
    }

    const where = { ipAddress: { [Op.ne]: null }, status: { [Op.notIn]: ["ARCHIVED"] } };
    if (batchId) where.batchId = batchId;
    if (status) where.status = status;

    const servers = await BeryllServer.findAll({
      where, attributes: ["id", "ipAddress", "hostname", "serialNumber", "apkSerialNumber", "status", "batchId"]
    });

    console.log(`[Monitoring] –ü–∏–Ω–≥—É–µ–º ${servers.length} —Å–µ—Ä–≤–µ—Ä–æ–≤...`);
    const results = [];
    const batchSize = 10;

    for (let i = 0; i < servers.length; i += batchSize) {
      const batch = servers.slice(i, i + batchSize);
      const batchResults = await Promise.all(batch.map(async (server) => {
        const pingResult = await this.pingHost(server.ipAddress);
        await server.update({ lastPingAt: new Date(), pingStatus: pingResult.online ? "ONLINE" : "OFFLINE", pingLatency: pingResult.latency });

        const result = {
          serverId: server.id, ipAddress: server.ipAddress, hostname: server.hostname,
          serialNumber: server.serialNumber, apkSerialNumber: server.apkSerialNumber,
          serverStatus: server.status, batchId: server.batchId, ...pingResult, checkedAt: new Date()
        };
        pingCache.set(server.id, result);
        return result;
      }));
      results.push(...batchResults);
    }

    lastFullScan = new Date();
    const online = results.filter(r => r.online).length;
    console.log(`[Monitoring] –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${online} online, ${results.length - online} offline`);

    return { total: results.length, online, offline: results.length - online, checkedAt: lastFullScan, servers: results };
  }

  getCachedStatuses() {
    const results = Array.from(pingCache.values());
    const online = results.filter(r => r.online).length;
    return { total: results.length, online, offline: results.length - online, checkedAt: lastFullScan, cached: true, servers: results };
  }

  async getMonitoringStats() {
    const stats = await BeryllServer.findAll({
      where: { ipAddress: { [Op.ne]: null }, status: { [Op.notIn]: ["ARCHIVED"] } },
      attributes: ["pingStatus", [fn("COUNT", col("id")), "count"]],
      group: ["pingStatus"], raw: true
    });

    const byPingStatus = stats.reduce((acc, i) => { acc[i.pingStatus || "UNKNOWN"] = parseInt(i.count); return acc; }, {});

    const staleThreshold = new Date(Date.now() - 5 * 60 * 1000);
    const staleServers = await BeryllServer.count({
      where: {
        ipAddress: { [Op.ne]: null }, status: { [Op.notIn]: ["ARCHIVED"] },
        [Op.or]: [{ lastPingAt: null }, { lastPingAt: { [Op.lt]: staleThreshold } }]
      }
    });

    const avgLatency = await BeryllServer.findOne({
      where: { pingStatus: "ONLINE", pingLatency: { [Op.ne]: null } },
      attributes: [[fn("AVG", col("pingLatency")), "avgLatency"]], raw: true
    });

    return {
      byStatus: byPingStatus, total: Object.values(byPingStatus).reduce((a, b) => a + b, 0),
      online: byPingStatus.ONLINE || 0, offline: byPingStatus.OFFLINE || 0, unknown: byPingStatus.UNKNOWN || 0,
      staleServers, avgLatency: avgLatency?.avgLatency ? parseFloat(avgLatency.avgLatency).toFixed(2) : null, lastFullScan
    };
  }

  async getServersByPingStatus(pingStatus, options = {}) {
    const { batchId, limit = 50, offset = 0 } = options;
    const where = { status: { [Op.notIn]: ["ARCHIVED"] } };

    if (pingStatus === "ONLINE") where.pingStatus = "ONLINE";
    else if (pingStatus === "OFFLINE") where.pingStatus = "OFFLINE";
    else if (pingStatus === "UNKNOWN") where[Op.or] = [{ pingStatus: null }, { pingStatus: "UNKNOWN" }];

    if (batchId) where.batchId = batchId;

    const servers = await BeryllServer.findAndCountAll({
      where, include: [{ model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] }],
      order: [["lastPingAt", "DESC"]], limit: parseInt(limit), offset: parseInt(offset)
    });

    return { count: servers.count, rows: servers.rows, page: Math.floor(offset / limit) + 1, totalPages: Math.ceil(servers.count / limit) };
  }

  clearCache() { pingCache.clear(); lastFullScan = null; console.log("[Monitoring] –ö—ç—à –æ—á–∏—â–µ–Ω"); }
}

module.exports = new DefectMonitoringService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/DefectRecordFileService.js
================================================================================


const path = require("path");
const fs = require("fs");

const DEFECT_FILES_DIR = path.join(__dirname, "../../../static/defect-records");


if (!fs.existsSync(DEFECT_FILES_DIR)) {
    fs.mkdirSync(DEFECT_FILES_DIR, { recursive: true });
}

class DefectRecordFileService {


    async getFiles(defectRecordId) {
        const { BeryllDefectRecordFile, User } = require("../../../models");

        const files = await BeryllDefectRecordFile.findAll({
            where: { defectRecordId },
            include: [
                {
                    model: User,
                    as: "uploadedBy",
                    attributes: ["id", "name", "surname"]
                }
            ],
            order: [["createdAt", "DESC"]]
        });

        return files;
    }


    async getFileById(fileId) {
        const { BeryllDefectRecordFile, User } = require("../../../models");

        const file = await BeryllDefectRecordFile.findByPk(fileId, {
            include: [
                {
                    model: User,
                    as: "uploadedBy",
                    attributes: ["id", "name", "surname"]
                }
            ]
        });

        return file;
    }


    async addFile(defectRecordId, fileData) {
        const {
            BeryllDefectRecordFile,
            BeryllHistory,
            BeryllDefectRecord,
            BeryllServer
        } = require("../../../models");

        const defect = await BeryllDefectRecord.findByPk(defectRecordId, {
            include: [{ model: BeryllServer, as: "server" }]
        });

        if (!defect) {
            throw new Error("–ó–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        }

        const file = await BeryllDefectRecordFile.create({
            defectRecordId,
            fileName: fileData.fileName,
            originalName: fileData.originalName,
            filePath: fileData.filePath,
            mimeType: fileData.mimeType,
            fileSize: fileData.fileSize,
            uploadedById: fileData.uploadedById
        });

        await BeryllHistory.create({
            serverId: defect.serverId,
            serverIp: defect.server?.ipAddress,
            serverHostname: defect.server?.hostname,
            userId: fileData.uploadedById,
            action: "DEFECT_RECORD_FILE_UPLOADED",
            comment: `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ${fileData.originalName}`,
            metadata: {
                defectRecordId,
                fileId: file.id,
                fileName: fileData.originalName,
                fileSize: fileData.fileSize,
                mimeType: fileData.mimeType
            }
        });

        return file;
    }


    async deleteFile(fileId, userId) {
        const {
            BeryllDefectRecordFile,
            BeryllHistory,
            BeryllDefectRecord,
            BeryllServer
        } = require("../../../models");

        const file = await BeryllDefectRecordFile.findByPk(fileId, {
            include: [{
                model: BeryllDefectRecord,
                as: "defectRecord",
                include: [{ model: BeryllServer, as: "server" }]
            }]
        });

        if (!file) {
            throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }

        const fullPath = path.join(DEFECT_FILES_DIR, file.filePath);
        if (fs.existsSync(fullPath)) {
            fs.unlinkSync(fullPath);
        }

        if (file.defectRecord) {
            await BeryllHistory.create({
                serverId: file.defectRecord.serverId,
                serverIp: file.defectRecord.server?.ipAddress,
                serverHostname: file.defectRecord.server?.hostname,
                userId,
                action: "DEFECT_RECORD_FILE_DELETED",
                comment: `–£–¥–∞–ª—ë–Ω —Ñ–∞–π–ª: ${file.originalName}`,
                metadata: {
                    defectRecordId: file.defectRecordId,
                    fileId: file.id,
                    fileName: file.originalName
                }
            });
        }

        await file.destroy();

        return { success: true, message: "–§–∞–π–ª —É–¥–∞–ª—ë–Ω" };
    }


    async saveFile(defectRecordId, file, userId) {
        const recordDir = path.join(DEFECT_FILES_DIR, String(defectRecordId));
        if (!fs.existsSync(recordDir)) {
            fs.mkdirSync(recordDir, { recursive: true });
        }

        const timestamp = Date.now();
        const safeOriginalName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
        const fileName = `${timestamp}_${safeOriginalName}`;
        const filePath = path.join(recordDir, fileName);
        const relativePath = path.join(String(defectRecordId), fileName);

        await file.mv(filePath);

        const fileRecord = await this.addFile(defectRecordId, {
            fileName,
            originalName: file.name,
            filePath: relativePath,
            mimeType: file.mimetype,
            fileSize: file.size,
            uploadedById: userId
        });

        return fileRecord;
    }


    async getFileForDownload(fileId) {
        const file = await this.getFileById(fileId);

        if (!file) {
            throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }

        const fullPath = path.join(DEFECT_FILES_DIR, file.filePath);

        if (!fs.existsSync(fullPath)) {
            throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –¥–∏—Å–∫–µ");
        }

        return {
            fullPath,
            originalName: file.originalName,
            mimeType: file.mimeType || "application/octet-stream"
        };
    }


    async getFilesCount(defectRecordId) {
        const { BeryllDefectRecordFile } = require("../../../models");

        const count = await BeryllDefectRecordFile.count({
            where: { defectRecordId }
        });

        return count;
    }


    async deleteAllFiles(defectRecordId, userId) {
        const files = await this.getFiles(defectRecordId);

        let deletedCount = 0;
        for (const file of files) {
            try {
                await this.deleteFile(file.id, userId);
                deletedCount++;
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ ${file.id}:`, error.message);
            }
        }

        const recordDir = path.join(DEFECT_FILES_DIR, String(defectRecordId));
        if (fs.existsSync(recordDir)) {
            try {
                fs.rmdirSync(recordDir);
            } catch (e) {

            }
        }

        return {
            success: true,
            deletedCount,
            message: `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} —Ñ–∞–π–ª–æ–≤`
        };
    }
}

module.exports = new DefectRecordFileService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/DefectRecordService.js
================================================================================



const { Op } = require("sequelize");
const sequelize = require("../../../db");
const {
    BeryllDefectRecord,
    BeryllDefectRecordFile,
    BeryllServer,
    BeryllServerComponent,
    ComponentInventory,
    ComponentHistory,
    YadroTicket,
    SubstituteServerPool,
    SlaConfig,
    User,
    DEFECT_RECORD_STATUSES,
    REPAIR_PART_TYPES,
    INVENTORY_STATUSES,
    HISTORY_ACTIONS,
    TICKET_TYPES,
    TICKET_STATUSES
} = require("../../../models/index");


const { logAudit, AUDIT_ACTIONS, AUDIT_ENTITIES } = require("../../../utils/auditLogger");

const fs = require("fs");
const path = require("path");

const UPLOADS_DIR = path.join(__dirname, "../../../../uploads/beryll/defect-records");


if (!fs.existsSync(UPLOADS_DIR)) {
    fs.mkdirSync(UPLOADS_DIR, { recursive: true });
}

class DefectRecordService {


    async create(data, userId) {
        const transaction = await sequelize.transaction();

        try {
            const {
                serverId,
                yadroTicketNumber,
                hasSPISI,
                clusterCode,
                problemDescription,
                repairPartType,
                defectPartSerialYadro,
                defectPartSerialManuf,
                notes,
                priority = "MEDIUM"
            } = data;


            const server = await BeryllServer.findByPk(serverId);
            if (!server) {
                throw new Error(`–°–µ—Ä–≤–µ—Ä —Å ID ${serverId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
            }


            const previousDefect = await this.checkRepeatedDefect(serverId, repairPartType);


            let defectComponentId = null;
            let defectInventoryId = null;

            if (defectPartSerialYadro || defectPartSerialManuf) {
                const component = await this.findServerComponent(
                    serverId,
                    repairPartType,
                    defectPartSerialYadro,
                    defectPartSerialManuf
                );
                if (component) {
                    defectComponentId = component.id;
                    defectInventoryId = component.inventoryId;
                }
            }


            let slaDeadline = null;
            try {
                slaDeadline = await SlaConfig.calculateDeadline(repairPartType, priority);
            } catch (e) {
                console.warn("SlaConfig.calculateDeadline –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω:", e.message);
            }


            const defectRecord = await BeryllDefectRecord.create({
                serverId,
                yadroTicketNumber,
                hasSPISI: hasSPISI || false,
                clusterCode,
                problemDescription,
                detectedAt: new Date(),
                detectedById: userId,
                repairPartType,
                defectPartSerialYadro,
                defectPartSerialManuf,
                defectComponentId,
                defectInventoryId,
                status: DEFECT_RECORD_STATUSES.NEW,
                isRepeatedDefect: !!previousDefect,
                previousDefectId: previousDefect?.id || null,
                repeatedDefectReason: previousDefect ? `–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ #${previousDefect.id}` : null,
                repeatedDefectDate: previousDefect ? new Date() : null,
                slaDeadline,
                notes,
                metadata: { priority }
            }, { transaction });


            await server.update({
                status: "DEFECT",
                metadata: {
                    ...server.metadata,
                    lastDefectId: defectRecord.id,
                    defectAt: new Date().toISOString()
                }
            }, { transaction });


            if (defectInventoryId) {
                await ComponentInventory.update(
                    { status: INVENTORY_STATUSES.DEFECTIVE },
                    { where: { id: defectInventoryId }, transaction }
                );


                await ComponentHistory.create({
                    inventoryComponentId: defectInventoryId,
                    action: HISTORY_ACTIONS.REMOVED,
                    fromServerId: serverId,
                    relatedDefectId: defectRecord.id,
                    performedById: userId,
                    notes: `–í—ã—è–≤–ª–µ–Ω –¥–µ—Ñ–µ–∫—Ç: ${problemDescription}`
                }, { transaction });
            }


            await this.logHistory(defectRecord.id, "CREATED", userId,
                `–°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ. –¢–∏–ø: ${repairPartType || "–ù–µ —É–∫–∞–∑–∞–Ω"}`,
                transaction
            );

            await transaction.commit();


            try {
                await logAudit({
                    userId,
                    action: AUDIT_ACTIONS.DEFECT_CREATE,
                    entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                    entityId: defectRecord.id,
                    description: `–°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ #${defectRecord.id} –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ ${server.apkSerialNumber || server.hostname || 'N/A'}`,
                    metadata: {
                        serverId,
                        serverSerial: server.apkSerialNumber,
                        hostname: server.hostname,
                        problemDescription: problemDescription?.substring(0, 100),
                        repairPartType,
                        defectPartSerialYadro,
                        defectPartSerialManuf,
                        isRepeatedDefect: !!previousDefect,
                        priority
                    }
                });
            } catch (auditErr) {
                console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞:", auditErr.message);
            }

            return this.getById(defectRecord.id);

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async startDiagnosis(id, diagnosticianId) {
        const defect = await BeryllDefectRecord.findByPk(id, {
            include: [{ model: BeryllServer, as: "server" }]
        });
        if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        if (defect.status !== DEFECT_RECORD_STATUSES.NEW) {
            throw new Error(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∏–∑ —Å—Ç–∞—Ç—É—Å–∞ ${defect.status}`);
        }

        await defect.update({
            status: DEFECT_RECORD_STATUSES.DIAGNOSING,
            diagnosticianId,
            diagnosisStartedAt: new Date()
        });

        await this.logHistory(id, "STATUS_CHANGED", diagnosticianId,
            `–ù–∞—á–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞`
        );


        try {
            await logAudit({
                userId: diagnosticianId,
                action: AUDIT_ACTIONS.DEFECT_UPDATE,
                entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                entityId: id,
                description: `–ù–∞—á–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–µ—Ñ–µ–∫—Ç–∞ #${id}`,
                metadata: {
                    serverId: defect.serverId,
                    serverSerial: defect.server?.apkSerialNumber,
                    newStatus: DEFECT_RECORD_STATUSES.DIAGNOSING,
                    diagnosticianId
                }
            });
        } catch (auditErr) {
            console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:", auditErr.message);
        }

        return this.getById(id);
    }


    async completeDiagnosis(id, userId, data) {
        const defect = await BeryllDefectRecord.findByPk(id, {
            include: [{ model: BeryllServer, as: "server" }]
        });
        if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        const {
            repairPartType,
            defectPartSerialYadro,
            defectPartSerialManuf,
            problemDescription,
            notes
        } = data;

        await defect.update({
            repairPartType: repairPartType || defect.repairPartType,
            defectPartSerialYadro: defectPartSerialYadro || defect.defectPartSerialYadro,
            defectPartSerialManuf: defectPartSerialManuf || defect.defectPartSerialManuf,
            problemDescription: problemDescription || defect.problemDescription,
            diagnosisCompletedAt: new Date(),
            notes: notes ? `${defect.notes || ""}\n\n[–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞]: ${notes}` : defect.notes
        });

        await this.logHistory(id, "DIAGNOSIS_COMPLETED", userId,
            `–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–ø—Ä–µ–¥–µ–ª—ë–Ω —Ç–∏–ø: ${repairPartType || defect.repairPartType}`
        );


        try {
            await logAudit({
                userId,
                action: AUDIT_ACTIONS.DEFECT_UPDATE,
                entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                entityId: id,
                description: `–ó–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–µ—Ñ–µ–∫—Ç–∞ #${id}. –¢–∏–ø: ${repairPartType || defect.repairPartType}`,
                metadata: {
                    serverId: defect.serverId,
                    serverSerial: defect.server?.apkSerialNumber,
                    repairPartType: repairPartType || defect.repairPartType,
                    defectPartSerialYadro,
                    defectPartSerialManuf
                }
            });
        } catch (auditErr) {
            console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:", auditErr.message);
        }

        return this.getById(id);
    }


    async setWaitingParts(id, userId, notes = null) {
        const defect = await BeryllDefectRecord.findByPk(id, {
            include: [{ model: BeryllServer, as: "server" }]
        });
        if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        const oldStatus = defect.status;

        await defect.update({
            status: DEFECT_RECORD_STATUSES.WAITING_PARTS,
            notes: notes ? `${defect.notes || ""}\n\n[–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π]: ${notes}` : defect.notes
        });

        await this.logHistory(id, "STATUS_CHANGED", userId,
            `–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π. ${notes || ""}`
        );


        try {
            await logAudit({
                userId,
                action: AUDIT_ACTIONS.DEFECT_UPDATE,
                entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                entityId: id,
                description: `–î–µ—Ñ–µ–∫—Ç #${id} –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –≤ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π`,
                metadata: {
                    serverId: defect.serverId,
                    serverSerial: defect.server?.apkSerialNumber,
                    oldStatus,
                    newStatus: DEFECT_RECORD_STATUSES.WAITING_PARTS
                }
            });
        } catch (auditErr) {
            console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", auditErr.message);
        }

        return this.getById(id);
    }


    async reserveReplacementComponent(id, inventoryId, userId) {
        const transaction = await sequelize.transaction();

        try {
            const defect = await BeryllDefectRecord.findByPk(id, {
                include: [{ model: BeryllServer, as: "server" }]
            });
            if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

            const component = await ComponentInventory.findByPk(inventoryId);
            if (!component) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ");


            if (typeof component.reserve === 'function') {
                await component.reserve(id, userId);
            }

            await defect.update({
                replacementInventoryId: inventoryId
            }, { transaction });

            await this.logHistory(id, "COMPONENT_RESERVED", userId,
                `–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ${component.serialNumber} –¥–ª—è –∑–∞–º–µ–Ω—ã`,
                transaction
            );

            await transaction.commit();


            try {
                await logAudit({
                    userId,
                    action: AUDIT_ACTIONS.COMPONENT_UPDATE,
                    entity: AUDIT_ENTITIES.COMPONENT_INVENTORY,
                    entityId: inventoryId,
                    description: `–ö–æ–º–ø–æ–Ω–µ–Ω—Ç ${component.serialNumber} –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–∞ #${id}`,
                    metadata: {
                        defectRecordId: id,
                        serverId: defect.serverId,
                        serverSerial: defect.server?.apkSerialNumber,
                        componentSerial: component.serialNumber
                    }
                });
            } catch (auditErr) {
                console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", auditErr.message);
            }

            return this.getById(id);

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async startRepair(id, userId) {
        const defect = await BeryllDefectRecord.findByPk(id, {
            include: [{ model: BeryllServer, as: "server" }]
        });
        if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        const oldStatus = defect.status;

        await defect.update({
            status: DEFECT_RECORD_STATUSES.REPAIRING,
            repairStartedAt: new Date()
        });

        await this.logHistory(id, "STATUS_CHANGED", userId, `–ù–∞—á–∞—Ç —Ä–µ–º–æ–Ω—Ç`);


        try {
            await logAudit({
                userId,
                action: AUDIT_ACTIONS.DEFECT_UPDATE,
                entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                entityId: id,
                description: `–ù–∞—á–∞—Ç —Ä–µ–º–æ–Ω—Ç –ø–æ –¥–µ—Ñ–µ–∫—Ç—É #${id}`,
                metadata: {
                    serverId: defect.serverId,
                    serverSerial: defect.server?.apkSerialNumber,
                    oldStatus,
                    newStatus: DEFECT_RECORD_STATUSES.REPAIRING
                }
            });
        } catch (auditErr) {
            console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", auditErr.message);
        }

        return this.getById(id);
    }


    async performComponentReplacement(id, userId, data) {
        const transaction = await sequelize.transaction();

        try {
            const defect = await BeryllDefectRecord.findByPk(id, {
                include: [{ model: BeryllServer, as: "server" }]
            });
            if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

            const {
                replacementPartSerialYadro,
                replacementPartSerialManuf,
                replacementInventoryId,
                repairDetails
            } = data;


            if (replacementInventoryId) {
                const newComponent = await ComponentInventory.findByPk(replacementInventoryId);
                if (!newComponent) throw new Error("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∑–∞–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω");


                if (typeof newComponent.installToServer === 'function') {
                    await newComponent.installToServer(defect.serverId, userId, id);
                }


                const serverComponent = await BeryllServerComponent.create({
                    serverId: defect.serverId,
                    componentType: defect.repairPartType,
                    name: newComponent.name || `${newComponent.manufacturer || ''} ${newComponent.model || defect.repairPartType}`.trim(),
                    serialNumber: newComponent.serialNumber,
                    serialNumberYadro: newComponent.serialNumberYadro,
                    manufacturer: newComponent.manufacturer,
                    model: newComponent.model,
                    status: "OK",
                    installedById: userId,
                    inventoryId: newComponent.id,
                    metadata: { installedDuringDefect: id }
                }, { transaction });

                await defect.update({
                    replacementComponentId: serverComponent.id,
                    replacementInventoryId: newComponent.id,
                    replacementPartSerialYadro: newComponent.serialNumberYadro || replacementPartSerialYadro,
                    replacementPartSerialManuf: newComponent.serialNumber || replacementPartSerialManuf,
                    repairDetails
                }, { transaction });
            } else {

                await defect.update({
                    replacementPartSerialYadro,
                    replacementPartSerialManuf,
                    repairDetails
                }, { transaction });
            }


            if (defect.defectInventoryId) {
                const defectComponent = await ComponentInventory.findByPk(defect.defectInventoryId);
                if (defectComponent) {
                    await defectComponent.update({
                        status: INVENTORY_STATUSES.DEFECTIVE,
                        currentServerId: null
                    }, { transaction });
                }
            }

            await this.logHistory(id, "COMPONENT_REPLACED", userId,
                `–í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∑–∞–º–µ–Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞. –ù–æ–≤—ã–π S/N: ${replacementPartSerialYadro || replacementPartSerialManuf}`,
                transaction
            );

            await transaction.commit();


            try {
                await logAudit({
                    userId,
                    action: AUDIT_ACTIONS.COMPONENT_REPLACE,
                    entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                    entityId: id,
                    description: `–í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∑–∞–º–µ–Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø–æ –¥–µ—Ñ–µ–∫—Ç—É #${id}`,
                    metadata: {
                        serverId: defect.serverId,
                        serverSerial: defect.server?.apkSerialNumber,
                        repairPartType: defect.repairPartType,
                        oldSerial: defect.defectPartSerialYadro || defect.defectPartSerialManuf,
                        newSerial: replacementPartSerialYadro || replacementPartSerialManuf,
                        replacementInventoryId
                    }
                });
            } catch (auditErr) {
                console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", auditErr.message);
            }

            return this.getById(id);

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async sendToYadro(id, userId, data) {
        const transaction = await sequelize.transaction();

        try {
            const defect = await BeryllDefectRecord.findByPk(id, {
                include: [{ model: BeryllServer, as: "server" }]
            });
            if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

            const { ticketNumber, subject, description, trackingNumber } = data;


            let ticket = null;
            try {
                const generateTicketNumber = typeof YadroTicket.generateTicketNumber === 'function'
                    ? await YadroTicket.generateTicketNumber()
                    : `YADRO-${Date.now()}`;

                ticket = await YadroTicket.create({
                    ticketNumber: ticketNumber || generateTicketNumber,
                    defectRecordId: id,
                    serverId: defect.serverId,
                    type: TICKET_TYPES?.COMPONENT_REPAIR || "COMPONENT_REPAIR",
                    status: TICKET_STATUSES?.SUBMITTED || "SUBMITTED",
                    subject: subject || `–†–µ–º–æ–Ω—Ç ${defect.repairPartType} - —Å–µ—Ä–≤–µ—Ä ${defect.server?.apkSerialNumber}`,
                    description: description || defect.problemDescription,
                    componentType: defect.repairPartType,
                    componentSerialYadro: defect.defectPartSerialYadro,
                    componentSerialManuf: defect.defectPartSerialManuf,
                    sentAt: new Date(),
                    trackingNumber,
                    createdById: userId
                }, { transaction });
            } catch (e) {
                console.warn("YadroTicket —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:", e.message);
            }


            await defect.update({
                status: DEFECT_RECORD_STATUSES.SENT_TO_YADRO,
                yadroTicketNumber: ticket?.ticketNumber || ticketNumber,
                sentToYadroRepair: true,
                sentToYadroAt: new Date()
            }, { transaction });


            if (defect.defectInventoryId) {
                const component = await ComponentInventory.findByPk(defect.defectInventoryId);
                if (component && typeof component.sendToYadro === 'function') {
                    await component.sendToYadro(ticket?.ticketNumber || ticketNumber, userId);
                }
            }

            await this.logHistory(id, "SENT_TO_YADRO", userId,
                `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –≤ –Ø–¥—Ä–æ. –ó–∞—è–≤–∫–∞: ${ticket?.ticketNumber || ticketNumber}`,
                transaction
            );

            await transaction.commit();


            try {
                await logAudit({
                    userId,
                    action: AUDIT_ACTIONS.YADRO_TICKET_CREATE,
                    entity: AUDIT_ENTITIES.YADRO_TICKET,
                    entityId: ticket?.id || id,
                    description: `–î–µ—Ñ–µ–∫—Ç #${id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –Ø–¥—Ä–æ. –ó–∞—è–≤–∫–∞: ${ticket?.ticketNumber || ticketNumber}`,
                    metadata: {
                        defectRecordId: id,
                        serverId: defect.serverId,
                        serverSerial: defect.server?.apkSerialNumber,
                        ticketNumber: ticket?.ticketNumber || ticketNumber,
                        repairPartType: defect.repairPartType,
                        componentSerial: defect.defectPartSerialYadro || defect.defectPartSerialManuf,
                        trackingNumber
                    }
                });
            } catch (auditErr) {
                console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", auditErr.message);
            }

            return this.getById(id);

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async returnFromYadro(id, userId, data) {
        const transaction = await sequelize.transaction();

        try {
            const defect = await BeryllDefectRecord.findByPk(id, {
                include: [{ model: BeryllServer, as: "server" }]
            });
            if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

            const { resolution, replacementSerialYadro, replacementSerialManuf, condition } = data;

            await defect.update({
                status: DEFECT_RECORD_STATUSES.RETURNED,
                returnedFromYadro: true,
                returnedFromYadroAt: new Date(),
                resolution,
                replacementPartSerialYadro: replacementSerialYadro || defect.replacementPartSerialYadro,
                replacementPartSerialManuf: replacementSerialManuf || defect.replacementPartSerialManuf
            }, { transaction });


            if (defect.yadroTicketNumber) {
                await YadroTicket.update({
                    status: TICKET_STATUSES?.RECEIVED || "RECEIVED",
                    receivedAt: new Date(),
                    resolution,
                    replacementSerialYadro,
                    replacementSerialManuf
                }, {
                    where: { ticketNumber: defect.yadroTicketNumber },
                    transaction
                });
            }


            if (defect.defectInventoryId) {
                const component = await ComponentInventory.findByPk(defect.defectInventoryId);
                if (component && typeof component.returnFromYadro === 'function') {
                    await component.returnFromYadro(userId, condition || "REFURBISHED");
                }
            }

            await this.logHistory(id, "RETURNED_FROM_YADRO", userId,
                `–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –∏–∑ –Ø–¥—Ä–æ. –†–µ–∑–æ–ª—é—Ü–∏—è: ${resolution || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"}`,
                transaction
            );

            await transaction.commit();


            try {
                await logAudit({
                    userId,
                    action: AUDIT_ACTIONS.YADRO_TICKET_RECEIVE,
                    entity: AUDIT_ENTITIES.YADRO_TICKET,
                    entityId: id,
                    description: `–ü–æ–ª—É—á–µ–Ω –≤–æ–∑–≤—Ä–∞—Ç –∏–∑ –Ø–¥—Ä–æ –ø–æ –¥–µ—Ñ–µ–∫—Ç—É #${id}`,
                    metadata: {
                        defectRecordId: id,
                        serverId: defect.serverId,
                        serverSerial: defect.server?.apkSerialNumber,
                        ticketNumber: defect.yadroTicketNumber,
                        resolution,
                        replacementSerialYadro,
                        replacementSerialManuf,
                        condition
                    }
                });
            } catch (auditErr) {
                console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", auditErr.message);
            }

            return this.getById(id);

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async issueSubstituteServer(id, userId, substituteServerId = null) {
        const transaction = await sequelize.transaction();

        try {
            const defect = await BeryllDefectRecord.findByPk(id, {
                include: [{ model: BeryllServer, as: "server" }]
            });
            if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

            let substitute;

            if (substituteServerId) {
                substitute = await SubstituteServerPool.findOne({
                    where: { serverId: substituteServerId }
                });
            } else {

                if (typeof SubstituteServerPool.findAvailableOne === 'function') {
                    substitute = await SubstituteServerPool.findAvailableOne();
                }
            }

            if (!substitute) {
                throw new Error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤");
            }


            if (typeof substitute.issue === 'function') {
                await substitute.issue(id, userId);
            }


            await defect.update({
                substituteServerId: substitute.serverId
            }, { transaction });


            const server = await BeryllServer.findByPk(substitute.serverId);

            await defect.update({
                substituteServerSerial: server?.apkSerialNumber
            }, { transaction });

            await this.logHistory(id, "SUBSTITUTE_ISSUED", userId,
                `–í—ã–¥–∞–Ω –ø–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä: ${server?.apkSerialNumber}`,
                transaction
            );

            await transaction.commit();


            try {
                await logAudit({
                    userId,
                    action: AUDIT_ACTIONS.DEFECT_UPDATE,
                    entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                    entityId: id,
                    description: `–í—ã–¥–∞–Ω –ø–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä ${server?.apkSerialNumber} –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–∞ #${id}`,
                    metadata: {
                        defectRecordId: id,
                        originalServerId: defect.serverId,
                        originalServerSerial: defect.server?.apkSerialNumber,
                        substituteServerId: substitute.serverId,
                        substituteServerSerial: server?.apkSerialNumber
                    }
                });
            } catch (auditErr) {
                console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", auditErr.message);
            }

            return this.getById(id);

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async returnSubstituteServer(id, userId) {
        const transaction = await sequelize.transaction();

        try {
            const defect = await BeryllDefectRecord.findByPk(id, {
                include: [{ model: BeryllServer, as: "server" }]
            });
            if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

            if (!defect.substituteServerId) {
                throw new Error("–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –±—ã–ª –≤—ã–¥–∞–Ω");
            }

            const substituteServerId = defect.substituteServerId;
            const substituteServerSerial = defect.substituteServerSerial;

            const substitute = await SubstituteServerPool.findOne({
                where: { serverId: defect.substituteServerId }
            });

            if (substitute && typeof substitute.return === 'function') {
                await substitute.return();
            }

            await this.logHistory(id, "SUBSTITUTE_RETURNED", userId,
                `–ü–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â—ë–Ω`,
                transaction
            );

            await transaction.commit();


            try {
                await logAudit({
                    userId,
                    action: AUDIT_ACTIONS.DEFECT_UPDATE,
                    entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                    entityId: id,
                    description: `–í–æ–∑–≤—Ä–∞—â—ë–Ω –ø–æ–¥–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä ${substituteServerSerial} –ø–æ –¥–µ—Ñ–µ–∫—Ç—É #${id}`,
                    metadata: {
                        defectRecordId: id,
                        serverId: defect.serverId,
                        serverSerial: defect.server?.apkSerialNumber,
                        substituteServerId,
                        substituteServerSerial
                    }
                });
            } catch (auditErr) {
                console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", auditErr.message);
            }

            return this.getById(id);

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async resolve(id, userId, data) {
        const transaction = await sequelize.transaction();

        try {
            const defect = await BeryllDefectRecord.findByPk(id, {
                include: [{ model: BeryllServer, as: "server" }]
            });
            if (!defect) throw new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

            const { resolution, notes } = data;


            const totalDowntimeMinutes = defect.detectedAt
                ? Math.round((new Date() - defect.detectedAt) / (1000 * 60))
                : null;

            await defect.update({
                status: DEFECT_RECORD_STATUSES.RESOLVED,
                resolvedAt: new Date(),
                resolvedById: userId,
                resolution,
                repairCompletedAt: new Date(),
                totalDowntimeMinutes,
                notes: notes ? `${defect.notes || ""}\n\n[–ó–∞–∫—Ä—ã—Ç–∏–µ]: ${notes}` : defect.notes
            }, { transaction });


            if (defect.server) {
                await defect.server.update({
                    status: "DONE",
                    metadata: {
                        ...defect.server.metadata,
                        lastDefectResolvedAt: new Date().toISOString()
                    }
                }, { transaction });
            }


            if (defect.yadroTicketNumber) {
                await YadroTicket.update({
                    status: TICKET_STATUSES?.CLOSED || "CLOSED",
                    closedAt: new Date()
                }, {
                    where: { ticketNumber: defect.yadroTicketNumber },
                    transaction
                });
            }


            if (defect.substituteServerId) {
                try {
                    await this.returnSubstituteServer(id, userId);
                } catch (e) {
                    console.warn("–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ–¥–º–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:", e.message);
                }
            }

            await this.logHistory(id, "RESOLVED", userId,
                `–ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞. –†–µ–∑–æ–ª—é—Ü–∏—è: ${resolution}. –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è: ${totalDowntimeMinutes} –º–∏–Ω.`,
                transaction
            );

            await transaction.commit();


            try {
                await logAudit({
                    userId,
                    action: AUDIT_ACTIONS.DEFECT_RESOLVE,
                    entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                    entityId: id,
                    description: `–î–µ—Ñ–µ–∫—Ç #${id} –∑–∞–∫—Ä—ã—Ç. –†–µ–∑–æ–ª—é—Ü–∏—è: ${resolution || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}`,
                    metadata: {
                        serverId: defect.serverId,
                        serverSerial: defect.server?.apkSerialNumber,
                        resolution,
                        totalDowntimeMinutes,
                        totalDowntimeHours: Math.round(totalDowntimeMinutes / 60),
                        repairPartType: defect.repairPartType,
                        hadYadroTicket: !!defect.yadroTicketNumber,
                        yadroTicketNumber: defect.yadroTicketNumber
                    }
                });
            } catch (auditErr) {
                console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:", auditErr.message);
            }

            return this.getById(id);

        } catch (error) {
            await transaction.rollback();
            throw error;
        }
    }


    async checkRepeatedDefect(serverId, repairPartType, days = 30) {
        const dateThreshold = new Date();
        dateThreshold.setDate(dateThreshold.getDate() - days);

        return BeryllDefectRecord.findOne({
            where: {
                serverId,
                repairPartType,
                detectedAt: { [Op.gte]: dateThreshold },
                status: { [Op.in]: [DEFECT_RECORD_STATUSES.RESOLVED, DEFECT_RECORD_STATUSES.CLOSED] }
            },
            order: [["detectedAt", "DESC"]]
        });
    }


    async findServerComponent(serverId, type, serialYadro, serialManuf) {
        const where = { serverId };


        if (type) where.componentType = type;

        if (serialYadro || serialManuf) {
            where[Op.or] = [];

            if (serialYadro) where[Op.or].push({ serialNumberYadro: serialYadro });
            if (serialManuf) where[Op.or].push({ serialNumber: serialManuf });
        }

        return BeryllServerComponent.findOne({ where });
    }


    async logHistory(defectRecordId, action, userId, description, transaction = null) {
        try {
            const { BeryllExtendedHistory } = require("../../../models/index");

            return BeryllExtendedHistory.create({
                entityType: "DEFECT_RECORD",
                entityId: defectRecordId,
                action,
                userId,
                description,
                metadata: {}
            }, { transaction });
        } catch (e) {
            console.warn("logHistory –æ—à–∏–±–∫–∞:", e.message);
        }
    }


    async getById(id) {
        try {
            return await BeryllDefectRecord.findByPk(id, {
                include: [
                    {
                        model: BeryllServer,
                        as: "server",
                        attributes: ["id", "ipAddress", "apkSerialNumber", "hostname", "status"],
                        required: false
                    },
                    {
                        model: User,
                        as: "detectedBy",
                        attributes: ["id", "name", "surname", "login"],
                        required: false
                    },
                    {
                        model: User,
                        as: "diagnostician",
                        attributes: ["id", "name", "surname", "login"],
                        required: false
                    },
                    {
                        model: User,
                        as: "resolvedBy",
                        attributes: ["id", "name", "surname", "login"],
                        required: false
                    },
                    {
                        model: BeryllDefectRecordFile,
                        as: "files",
                        include: [
                            {
                                model: User,
                                as: "uploadedBy",
                                attributes: ["id", "name", "surname", "login"],
                                required: false
                            }
                        ],
                        required: false
                    }
                ]
            });
        } catch (e) {
            console.error("getById include error, trying without includes:", e.message);

            return BeryllDefectRecord.findByPk(id);
        }
    }


    async getAll(filters = {}) {
        const {
            serverId,
            status,
            repairPartType,
            diagnosticianId,
            isRepeatedDefect,
            dateFrom,
            dateTo,
            search,
            slaBreached,
            limit = 50,
            offset = 0
        } = filters;

        const where = {};

        if (serverId) where.serverId = serverId;
        if (status) where.status = status;
        if (repairPartType) where.repairPartType = repairPartType;
        if (diagnosticianId) where.diagnosticianId = diagnosticianId;
        if (isRepeatedDefect !== undefined) where.isRepeatedDefect = isRepeatedDefect;

        if (dateFrom || dateTo) {
            where.detectedAt = {};
            if (dateFrom) where.detectedAt[Op.gte] = new Date(dateFrom);
            if (dateTo) where.detectedAt[Op.lte] = new Date(dateTo);
        }

        if (slaBreached === true) {
            where.slaDeadline = { [Op.lt]: new Date() };
            where.status = { [Op.notIn]: [DEFECT_RECORD_STATUSES.RESOLVED, DEFECT_RECORD_STATUSES.CLOSED] };
        }

        if (search) {
            where[Op.or] = [
                { yadroTicketNumber: { [Op.iLike]: `%${search}%` } },
                { problemDescription: { [Op.iLike]: `%${search}%` } },
                { defectPartSerialYadro: { [Op.iLike]: `%${search}%` } },
                { defectPartSerialManuf: { [Op.iLike]: `%${search}%` } }
            ];
        }

        try {
            return await BeryllDefectRecord.findAndCountAll({
                where,
                include: [
                    {
                        model: BeryllServer,
                        as: "server",
                        attributes: ["id", "ipAddress", "apkSerialNumber", "hostname", "status"],
                        required: false
                    },
                    {
                        model: User,
                        as: "diagnostician",
                        attributes: ["id", "name", "surname"],
                        required: false
                    }
                ],
                order: [["detectedAt", "DESC"]],
                limit,
                offset
            });
        } catch (e) {
            console.error("getAll include error:", e.message);

            return BeryllDefectRecord.findAndCountAll({
                where,
                order: [["detectedAt", "DESC"]],
                limit,
                offset
            });
        }
    }


    async getStats(filters = {}) {
        const { dateFrom, dateTo, serverId } = filters;

        const where = {};
        if (serverId) where.serverId = serverId;
        if (dateFrom || dateTo) {
            where.detectedAt = {};
            if (dateFrom) where.detectedAt[Op.gte] = new Date(dateFrom);
            if (dateTo) where.detectedAt[Op.lte] = new Date(dateTo);
        }


        const byStatus = await BeryllDefectRecord.findAll({
            attributes: [
                "status",
                [sequelize.fn("COUNT", sequelize.col("id")), "count"]
            ],
            where,
            group: ["status"],
            raw: true
        });


        const byType = await BeryllDefectRecord.findAll({
            attributes: [
                "repairPartType",
                [sequelize.fn("COUNT", sequelize.col("id")), "count"]
            ],
            where,
            group: ["repairPartType"],
            raw: true
        });


        const repeatedCount = await BeryllDefectRecord.count({
            where: { ...where, isRepeatedDefect: true }
        });


        const slaBreachedCount = await BeryllDefectRecord.count({
            where: {
                ...where,
                slaDeadline: { [Op.lt]: new Date() },
                status: { [Op.notIn]: [DEFECT_RECORD_STATUSES.RESOLVED, DEFECT_RECORD_STATUSES.CLOSED] }
            }
        });


        const avgRepairTime = await BeryllDefectRecord.findOne({
            attributes: [
                [sequelize.fn("AVG", sequelize.col("totalDowntimeMinutes")), "avgMinutes"]
            ],
            where: {
                ...where,
                totalDowntimeMinutes: { [Op.ne]: null }
            },
            raw: true
        });

        return {
            byStatus,
            byType,
            repeatedCount,
            slaBreachedCount,
            avgRepairTimeMinutes: Math.round(avgRepairTime?.avgMinutes || 0),
            avgRepairTimeHours: Math.round((avgRepairTime?.avgMinutes || 0) / 60)
        };
    }


    getRepairPartTypes() {
        return Object.entries(REPAIR_PART_TYPES || {}).map(([key, value]) => ({
            value,
            label: this.getPartTypeLabel(value)
        }));
    }

    getStatuses() {
        return Object.entries(DEFECT_RECORD_STATUSES || {}).map(([key, value]) => ({
            value,
            label: this.getStatusLabel(value)
        }));
    }

    getPartTypeLabel(type) {
        const labels = {
            RAM: "–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å",
            MOTHERBOARD: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞",
            CPU: "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä",
            HDD: "–ñ—ë—Å—Ç–∫–∏–π –¥–∏—Å–∫",
            SSD: "SSD –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å",
            PSU: "–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è",
            FAN: "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä",
            RAID: "RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä",
            NIC: "–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞",
            BACKPLANE: "Backplane",
            BMC: "BMC –º–æ–¥—É–ª—å",
            CABLE: "–ö–∞–±–µ–ª—å",
            OTHER: "–î—Ä—É–≥–æ–µ"
        };
        return labels[type] || type;
    }

    getStatusLabel(status) {
        const labels = {
            NEW: "–ù–æ–≤—ã–π",
            DIAGNOSING: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
            WAITING_PARTS: "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π",
            REPAIRING: "–†–µ–º–æ–Ω—Ç",
            SENT_TO_YADRO: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –Ø–¥—Ä–æ",
            RETURNED: "–í–æ–∑–≤—Ä–∞—â—ë–Ω –∏–∑ –Ø–¥—Ä–æ",
            RESOLVED: "–†–µ—à—ë–Ω",
            REPEATED: "–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –±—Ä–∞–∫",
            CLOSED: "–ó–∞–∫—Ä—ã—Ç"
        };
        return labels[status] || status;
    }


    async getFiles(defectRecordId) {
        const files = await BeryllDefectRecordFile.findAll({
            where: { defectRecordId },
            include: [
                {
                    model: User,
                    as: "uploadedBy",
                    attributes: ["id", "name", "surname", "login"],
                    required: false
                }
            ],
            order: [["createdAt", "DESC"]]
        });

        return files;
    }


    async getFileById(fileId) {
        const file = await BeryllDefectRecordFile.findByPk(fileId, {
            include: [
                {
                    model: User,
                    as: "uploadedBy",
                    attributes: ["id", "name", "surname", "login"],
                    required: false
                }
            ]
        });

        return file;
    }


    async addFile(defectRecordId, fileData) {

        const defect = await BeryllDefectRecord.findByPk(defectRecordId, {
            include: [{ model: BeryllServer, as: "server" }]
        });

        if (!defect) {
            throw new Error("–ó–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        }


        const file = await BeryllDefectRecordFile.create({
            defectRecordId,
            fileName: fileData.fileName,
            originalName: fileData.originalName,
            filePath: fileData.filePath,
            mimeType: fileData.mimeType,
            fileSize: fileData.fileSize,
            uploadedById: fileData.uploadedById
        });


        try {
            const { BeryllHistory } = require("../../../models");
            await BeryllHistory.create({
                serverId: defect.serverId,
                serverIp: defect.server?.ipAddress,
                serverHostname: defect.server?.hostname,
                userId: fileData.uploadedById,
                action: "DEFECT_RECORD_FILE_UPLOADED",
                comment: `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ${fileData.originalName}`,
                metadata: {
                    defectRecordId,
                    fileId: file.id,
                    fileName: fileData.originalName,
                    fileSize: fileData.fileSize,
                    mimeType: fileData.mimeType
                }
            });
        } catch (historyError) {
            console.error("[DefectRecordService] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é:", historyError.message);
        }


        try {
            await logAudit({
                userId: fileData.uploadedById,
                action: AUDIT_ACTIONS.DEFECT_FILE_UPLOAD,
                entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                entityId: defectRecordId,
                description: `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª "${fileData.originalName}" –∫ –¥–µ—Ñ–µ–∫—Ç—É #${defectRecordId}`,
                metadata: {
                    defectRecordId,
                    fileId: file.id,
                    fileName: fileData.originalName,
                    fileSize: fileData.fileSize,
                    mimeType: fileData.mimeType,
                    serverId: defect.serverId,
                    serverSerial: defect.server?.apkSerialNumber
                }
            });
        } catch (auditErr) {
            console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", auditErr.message);
        }

        return file;
    }


    async deleteFile(fileId, userId) {
        const file = await BeryllDefectRecordFile.findByPk(fileId, {
            include: [{
                model: BeryllDefectRecord,
                as: "defectRecord",
                include: [{ model: BeryllServer, as: "server" }]
            }]
        });

        if (!file) {
            throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }

        const defectRecordId = file.defectRecordId;
        const fileName = file.originalName;
        const serverId = file.defectRecord?.serverId;
        const serverSerial = file.defectRecord?.server?.apkSerialNumber;


        const fullPath = path.join(UPLOADS_DIR, file.filePath);
        if (fs.existsSync(fullPath)) {
            try {
                fs.unlinkSync(fullPath);
            } catch (e) {
                console.warn("[DefectRecordService] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å –¥–∏—Å–∫–∞:", e.message);
            }
        }


        try {
            const { BeryllHistory } = require("../../../models");
            if (file.defectRecord) {
                await BeryllHistory.create({
                    serverId: file.defectRecord.serverId,
                    serverIp: file.defectRecord.server?.ipAddress,
                    serverHostname: file.defectRecord.server?.hostname,
                    userId,
                    action: "DEFECT_RECORD_FILE_DELETED",
                    comment: `–£–¥–∞–ª—ë–Ω —Ñ–∞–π–ª: ${file.originalName}`,
                    metadata: {
                        defectRecordId: file.defectRecordId,
                        fileId: file.id,
                        fileName: file.originalName
                    }
                });
            }
        } catch (historyError) {
            console.error("[DefectRecordService] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é:", historyError.message);
        }


        await file.destroy();


        try {
            await logAudit({
                userId,
                action: AUDIT_ACTIONS.DEFECT_FILE_DELETE,
                entity: AUDIT_ENTITIES.BERYLL_DEFECT,
                entityId: defectRecordId,
                description: `–£–¥–∞–ª—ë–Ω —Ñ–∞–π–ª "${fileName}" –∏–∑ –¥–µ—Ñ–µ–∫—Ç–∞ #${defectRecordId}`,
                metadata: {
                    defectRecordId,
                    fileId,
                    fileName,
                    serverId,
                    serverSerial
                }
            });
        } catch (auditErr) {
            console.error("[Audit] –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞:", auditErr.message);
        }

        return { success: true, message: "–§–∞–π–ª —É–¥–∞–ª—ë–Ω" };
    }
}

module.exports = new DefectRecordService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/DhcpService.js
================================================================================

const { BeryllServer, User } = require("../../../models/index");
const { SERVER_STATUSES, HISTORY_ACTIONS } = require("../../../models/definitions/Beryll");
const { NodeSSH } = require("node-ssh");
const { Op } = require("sequelize");
const { DHCP_CONFIG } = require("../config/beryll.config");
const { parseDhcpLeases } = require("../utils/dhcpParser");
const HistoryService = require("./HistoryService");

class DhcpService {


  async syncWithDhcp(userId) {
    const ssh = new NodeSSH();

    try {
      await ssh.connect({
        host: DHCP_CONFIG.host,
        username: DHCP_CONFIG.username,
        password: DHCP_CONFIG.password,
        readyTimeout: 10000
      });

      const result = await ssh.execCommand(`cat ${DHCP_CONFIG.leaseFile}`);

      if (result.stderr && !result.stdout) {
        throw new Error(`SSH Error: ${result.stderr}`);
      }

      const leases = parseDhcpLeases(result.stdout);
      const activeLeases = leases.filter(l => l.leaseActive);

      const syncTime = new Date();
      const results = { created: 0, updated: 0, total: activeLeases.length };

      for (const lease of activeLeases) {
        let server = await BeryllServer.findOne({
          where: {
            [Op.or]: [
              { ipAddress: lease.ipAddress },
              { macAddress: lease.macAddress }
            ]
          }
        });

        if (server) {
          await server.update({
            ipAddress: lease.ipAddress,
            macAddress: lease.macAddress,
            hostname: lease.hostname,
            serialNumber: lease.serialNumber,
            leaseStart: lease.leaseStart,
            leaseEnd: lease.leaseEnd,
            leaseActive: lease.leaseActive,
            lastSyncAt: syncTime
          });
          results.updated++;
        } else {
          server = await BeryllServer.create({
            ...lease,
            status: SERVER_STATUSES.NEW,
            lastSyncAt: syncTime
          });
          results.created++;


          await HistoryService.logHistory(server.id, userId, HISTORY_ACTIONS.CREATED, {
            comment: "–î–æ–±–∞–≤–ª–µ–Ω –∏–∑ DHCP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
          });
        }
      }

      await BeryllServer.update(
        { leaseActive: false },
        {
          where: {
            lastSyncAt: { [Op.lt]: syncTime },
            leaseActive: true
          }
        }
      );

      ssh.dispose();

      return { success: true, message: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞", results };

    } catch (e) {
      ssh.dispose();
      throw e;
    }
  }
}

module.exports = new DhcpService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/FileService.js
================================================================================

const { BeryllServer, BeryllServerChecklist, User } = require("../../../models/index");
const path = require("path");
const fs = require("fs");
const { UPLOAD_DIR } = require("../config/beryll.config");
const HistoryService = require("./HistoryService");

class FileService {


  async uploadChecklistFile(serverId, checklistId, file, userId) {
    const server = await BeryllServer.findByPk(serverId);
    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    const checklist = await BeryllServerChecklist.findOne({
      where: { id: checklistId, serverId },
      include: [{ model: BeryllChecklistTemplate, as: "template" }]
    });

    if (!checklist) {
      throw new Error("–ü—É–Ω–∫—Ç —á–µ–∫-–ª–∏—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    const ext = path.extname(file.name);
    const fileCode = checklist.template?.fileCode || `item_${checklistId}`;
    const serial = server.apkSerialNumber || server.serialNumber || `srv_${serverId}`;


    const fileName = `${serial}_${fileCode}${ext}`;


    const serverDir = path.join(UPLOAD_DIR, serial);
    if (!fs.existsSync(serverDir)) {
      fs.mkdirSync(serverDir, { recursive: true });
    }

    const filePath = path.join(serverDir, fileName);


    await file.mv(filePath);


    const fileRecord = await BeryllChecklistFile.create({
      serverChecklistId: checklist.id,
      originalName: file.name,
      fileName,
      filePath: path.relative(UPLOAD_DIR, filePath),
      mimeType: file.mimetype,
      fileSize: file.size,
      uploadedById: userId
    });


    await HistoryService.logHistory(serverId, userId, HISTORY_ACTIONS.FILE_UPLOADED, {
      checklistItemId: checklist.id,
      comment: `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª ${fileName}`,
      metadata: { fileName, fileCode, originalName: file.name }
    });

    return {
      success: true,
      file: {
        id: fileRecord.id,
        fileName,
        originalName: file.name,
        fileSize: file.size
      }
    };
  }


  async getServerFiles(serverId) {
    const files = await BeryllChecklistFile.findAll({
      include: [{
        model: BeryllServerChecklist,
        as: "checklist",
        where: { serverId },
        include: [{ model: BeryllChecklistTemplate, as: "template" }]
      }, {
        model: User,
        as: "uploadedBy",
        attributes: ["id", "login", "name", "surname"]
      }],
      order: [["createdAt", "ASC"]]
    });

    return files;
  }


  async getFileForDownload(fileId) {
    const file = await BeryllChecklistFile.findByPk(fileId);
    if (!file) {
      throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    const fullPath = path.join(UPLOAD_DIR, file.filePath);

    if (!fs.existsSync(fullPath)) {
      throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –¥–∏—Å–∫–µ");
    }

    return {
      fullPath,
      originalName: file.originalName
    };
  }
}

module.exports = new FileService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/HistoryService.js
================================================================================

const { BeryllHistory, BeryllServer, User } = require("../../../models/index");
const { HISTORY_ACTIONS } = require("../../../models/definitions/Beryll");
const { Op, fn, col } = require("sequelize");

class HistoryService {


  async logHistory(serverId, userId, action, options = {}) {
    try {
      const server = serverId ? await BeryllServer.findByPk(serverId) : null;

      await BeryllHistory.create({
        serverId,
        serverIp: server?.ipAddress || options.serverIp,
        serverHostname: server?.hostname || options.serverHostname,
        userId,
        action,
        fromStatus: options.fromStatus,
        toStatus: options.toStatus,
        checklistItemId: options.checklistItemId,
        comment: options.comment,
        metadata: options.metadata,
        durationMinutes: options.durationMinutes
      });
    } catch (e) {
      console.error("Error logging history:", e);
    }
  }


  async getHistory(filters = {}) {
    const { serverId, userId, action, dateFrom, dateTo, page = 1, limit = 50 } = filters;

    const where = {};

    if (serverId) where.serverId = serverId;
    if (userId) where.userId = userId;
    if (action) where.action = action;

    if (dateFrom || dateTo) {
      where.createdAt = {};
      if (dateFrom) where.createdAt[Op.gte] = new Date(dateFrom);
      if (dateTo) where.createdAt[Op.lte] = new Date(dateTo);
    }

    const offset = (parseInt(page) - 1) * parseInt(limit);

    const { count, rows } = await BeryllHistory.findAndCountAll({
      where,
      include: [
        { model: User, as: "user", attributes: ["id", "login", "name", "surname"] },
        { model: BeryllServer, as: "server", attributes: ["id", "ipAddress", "hostname"] }
      ],
      order: [["createdAt", "DESC"]],
      limit: parseInt(limit),
      offset
    });

    return {
      count,
      rows,
      page: parseInt(page),
      totalPages: Math.ceil(count / parseInt(limit))
    };
  }
}

module.exports = new HistoryService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/OpenBMCService.js
================================================================================



const axios = require("axios");
const https = require("https");


const agent = new https.Agent({ rejectUnauthorized: false });


const BMC_CONFIG = {
  username: "admin",
  password: "V36man",
  timeout: 30000,
  protocol: "https",
  retries: 2,
  retryDelay: 2000
};

class OpenBMCService {


  static createClient(bmcAddress, config = {}) {
    const { username, password, protocol, timeout } = { ...BMC_CONFIG, ...config };

    const baseURL = `${protocol}://${bmcAddress}`;

    return axios.create({
      baseURL,
      timeout,
      auth: { username, password },
      httpsAgent: agent,
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      }
    });
  }


  static async requestWithRetry(client, url, config = {}) {
    const { retries = BMC_CONFIG.retries, retryDelay = BMC_CONFIG.retryDelay } = config;
    let lastError;

    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        const response = await client.get(url);
        return response;
      } catch (error) {
        lastError = error;


        if (error.response?.status === 404 || error.response?.status === 401) {
          throw error;
        }

        if (attempt < retries) {
          console.log(`[OpenBMC] Retry ${attempt + 1}/${retries} for ${url}...`);
          await this.sleep(retryDelay);
        }
      }
    }

    throw lastError;
  }


  static sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }


  static async checkConnection(bmcAddress, config = {}) {
    try {
      const client = this.createClient(bmcAddress, { ...config, timeout: 15000 });
      const response = await client.get("/redfish/v1/");
      return {
        success: true,
        redfishVersion: response.data?.RedfishVersion,
        name: response.data?.Name,
        uuid: response.data?.UUID
      };
    } catch (error) {
      return {
        success: false,
        error: error.code === 'ECONNABORTED' ? '–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ BMC' : error.message
      };
    }
  }


  static async getSystemInfo(bmcAddress, config = {}) {
    const client = this.createClient(bmcAddress, config);

    try {
      const paths = [
        "/redfish/v1/Systems/system",
        "/redfish/v1/Systems/1",
        "/redfish/v1/Systems"
      ];

      for (const path of paths) {
        try {
          const response = await this.requestWithRetry(client, path, config);
          if (response.data) {
            if (response.data.Members) {
              const firstSystem = response.data.Members[0];
              if (firstSystem?.["@odata.id"]) {
                const systemResponse = await this.requestWithRetry(client, firstSystem["@odata.id"], config);
                return systemResponse.data;
              }
            }
            return response.data;
          }
        } catch (e) {
          continue;
        }
      }
      throw new Error("System info not found");
    } catch (error) {
      console.error("[OpenBMC] Error getting system info:", error.message);
      throw error;
    }
  }


  static async getProcessors(bmcAddress, config = {}) {
    const client = this.createClient(bmcAddress, config);
    const processors = [];

    try {
      const paths = [
        "/redfish/v1/Systems/system/Processors",
        "/redfish/v1/Systems/1/Processors"
      ];

      for (const basePath of paths) {
        try {
          const response = await this.requestWithRetry(client, basePath, config);
          if (response.data?.Members) {

            for (const member of response.data.Members) {
              try {
                const cpuResponse = await this.requestWithRetry(client, member["@odata.id"], config);
                const cpu = cpuResponse.data;

                processors.push({
                  componentType: "CPU",
                  name: cpu.Model || `${cpu.Manufacturer || 'CPU'} ${cpu.Socket || cpu.Id || ''}`.trim(),
                  slot: cpu.Socket || cpu.Id,
                  manufacturer: cpu.Manufacturer,
                  model: cpu.Model,
                  serialNumber: cpu.SerialNumber,
                  partNumber: cpu.PartNumber,
                  cores: cpu.TotalCores,
                  threads: cpu.TotalThreads,
                  speedMHz: cpu.MaxSpeedMHz || cpu.OperatingSpeedMHz,
                  architecture: cpu.InstructionSet || cpu.ProcessorArchitecture,
                  status: this.mapStatus(cpu.Status?.State, cpu.Status?.Health),
                  health: cpu.Status?.Health,
                  rawData: cpu
                });
              } catch (e) {
                console.error("[OpenBMC] Error fetching CPU:", e.message);
              }
            }
            break;
          }
        } catch (e) {
          continue;
        }
      }
    } catch (error) {
      console.error("[OpenBMC] Error getting processors:", error.message);
    }

    return processors;
  }


  static async getMemory(bmcAddress, config = {}) {
    const client = this.createClient(bmcAddress, config);
    const memory = [];

    try {
      const paths = [
        "/redfish/v1/Systems/system/Memory",
        "/redfish/v1/Systems/1/Memory"
      ];

      for (const basePath of paths) {
        try {
          const response = await this.requestWithRetry(client, basePath, config);
          if (response.data?.Members) {
            for (const member of response.data.Members) {
              try {
                const memResponse = await this.requestWithRetry(client, member["@odata.id"], config);
                const mem = memResponse.data;


                if (!mem.CapacityMiB && !mem.SizeMB) continue;

                const capacityMB = mem.CapacityMiB || mem.SizeMB || 0;
                const capacityGB = Math.round(capacityMB / 1024);

                memory.push({
                  componentType: "RAM",
                  name: `${mem.Manufacturer || 'RAM'} ${capacityGB}GB ${mem.MemoryDeviceType || ''}`.trim(),
                  slot: mem.DeviceLocator || mem.Id,
                  manufacturer: mem.Manufacturer,
                  model: mem.PartNumber,
                  serialNumber: mem.SerialNumber,
                  partNumber: mem.PartNumber,
                  capacity: `${capacityGB} GB`,
                  capacityBytes: capacityMB * 1024 * 1024,
                  memoryType: mem.MemoryDeviceType || mem.MemoryType,
                  speedMT: mem.OperatingSpeedMhz || mem.Speed,
                  rank: mem.RankCount,
                  status: this.mapStatus(mem.Status?.State, mem.Status?.Health),
                  health: mem.Status?.Health,
                  rawData: mem
                });
              } catch (e) {
                console.error("[OpenBMC] Error fetching memory:", e.message);
              }
            }
            break;
          }
        } catch (e) {
          continue;
        }
      }
    } catch (error) {
      console.error("[OpenBMC] Error getting memory:", error.message);
    }

    return memory;
  }


  static async getStorage(bmcAddress, config = {}) {
    const client = this.createClient(bmcAddress, config);
    const storage = [];

    try {
      const paths = [
        "/redfish/v1/Systems/system/Storage",
        "/redfish/v1/Systems/1/Storage"
      ];

      for (const basePath of paths) {
        try {
          const response = await this.requestWithRetry(client, basePath, config);
          if (response.data?.Members) {
            for (const storageMember of response.data.Members) {
              try {
                const storageResponse = await this.requestWithRetry(client, storageMember["@odata.id"], config);
                const storageData = storageResponse.data;


                if (storageData.StorageControllers?.length > 0) {
                  for (const ctrl of storageData.StorageControllers) {
                    storage.push({
                      componentType: "RAID",
                      name: ctrl.Model || ctrl.Name || "Storage Controller",
                      slot: ctrl.MemberId || storageData.Id,
                      manufacturer: ctrl.Manufacturer,
                      model: ctrl.Model,
                      serialNumber: ctrl.SerialNumber,
                      firmwareVersion: ctrl.FirmwareVersion,
                      status: this.mapStatus(ctrl.Status?.State, ctrl.Status?.Health),
                      health: ctrl.Status?.Health,
                      rawData: ctrl
                    });
                  }
                }


                if (storageData.Drives) {
                  for (const driveRef of storageData.Drives) {
                    try {
                      const driveResponse = await this.requestWithRetry(client, driveRef["@odata.id"], config);
                      const drive = driveResponse.data;

                      const capacityGB = drive.CapacityBytes
                        ? Math.round(drive.CapacityBytes / (1024 * 1024 * 1024))
                        : 0;

                      const driveType = this.detectDriveType(drive);

                      storage.push({
                        componentType: driveType,
                        name: `${drive.Model || driveType} ${capacityGB}GB`,
                        slot: drive.PhysicalLocation?.PartLocation?.ServiceLabel || drive.Id,
                        manufacturer: drive.Manufacturer,
                        model: drive.Model,
                        serialNumber: drive.SerialNumber,
                        partNumber: drive.PartNumber,
                        capacity: `${capacityGB} GB`,
                        capacityBytes: drive.CapacityBytes,
                        mediaType: drive.MediaType,
                        interface: drive.Protocol,
                        firmwareVersion: drive.Revision || drive.FirmwareVersion,
                        status: this.mapStatus(drive.Status?.State, drive.Status?.Health),
                        health: drive.Status?.Health,
                        rawData: drive
                      });
                    } catch (e) {
                      console.error("[OpenBMC] Error fetching drive:", e.message);
                    }
                  }
                }
              } catch (e) {
                console.error("[OpenBMC] Error fetching storage controller:", e.message);
              }
            }
            break;
          }
        } catch (e) {
          continue;
        }
      }
    } catch (error) {
      console.error("[OpenBMC] Error getting storage:", error.message);
    }

    return storage;
  }


  static detectDriveType(drive) {
    const mediaType = (drive.MediaType || "").toUpperCase();
    const protocol = (drive.Protocol || "").toUpperCase();

    if (protocol.includes("NVME") || protocol.includes("PCIE")) return "NVME";
    if (mediaType.includes("SSD") || mediaType === "SOLIDSTATEDRIVE") return "SSD";
    if (mediaType.includes("HDD") || mediaType === "ROTATIONAL") return "HDD";

    return "SSD";
  }


  static async getNetworkAdapters(bmcAddress, config = {}) {
    const client = this.createClient(bmcAddress, config);
    const adapters = [];

    try {

      const paths = [
        "/redfish/v1/Systems/system/EthernetInterfaces",
        "/redfish/v1/Systems/1/EthernetInterfaces",
        "/redfish/v1/Chassis/chassis/NetworkAdapters",
        "/redfish/v1/Chassis/1/NetworkAdapters"
      ];

      for (const basePath of paths) {
        try {
          const response = await this.requestWithRetry(client, basePath, config);
          if (response.data?.Members) {
            for (const member of response.data.Members) {
              try {
                const nicResponse = await this.requestWithRetry(client, member["@odata.id"], config);
                const nic = nicResponse.data;

                adapters.push({
                  componentType: "NIC",
                  name: nic.Name || nic.Description || `NIC ${nic.Id}`,
                  slot: nic.Id,
                  manufacturer: nic.Manufacturer,
                  model: nic.Model,
                  macAddress: nic.MACAddress || nic.PermanentMACAddress,
                  linkSpeed: nic.SpeedMbps ? `${nic.SpeedMbps} Mbps` : null,
                  firmwareVersion: nic.FirmwarePackageVersion,
                  status: this.mapStatus(nic.Status?.State, nic.Status?.Health),
                  health: nic.Status?.Health,
                  rawData: nic
                });
              } catch (e) {
                console.error("[OpenBMC] Error fetching NIC:", e.message);
              }
            }
            break;
          }
        } catch (e) {
          continue;
        }
      }
    } catch (error) {
      console.error("[OpenBMC] Error getting network adapters:", error.message);
    }

    return adapters;
  }


  static async getMotherboard(bmcAddress, config = {}) {
    const client = this.createClient(bmcAddress, config);

    try {
      const paths = [
        "/redfish/v1/Chassis/chassis",
        "/redfish/v1/Chassis/1",
        "/redfish/v1/Chassis"
      ];

      for (const path of paths) {
        try {
          const response = await this.requestWithRetry(client, path, config);
          let chassisData = response.data;

          if (chassisData.Members) {
            const first = chassisData.Members[0];
            if (first?.["@odata.id"]) {
              const chassisResponse = await this.requestWithRetry(client, first["@odata.id"], config);
              chassisData = chassisResponse.data;
            }
          }

          if (chassisData.Manufacturer || chassisData.Model) {
            return {
              componentType: "MOTHERBOARD",
              name: chassisData.Model || `${chassisData.Manufacturer || ''} Motherboard`.trim(),
              slot: "Main",
              manufacturer: chassisData.Manufacturer,
              model: chassisData.Model,
              serialNumber: chassisData.SerialNumber,
              partNumber: chassisData.PartNumber || chassisData.SKU,
              status: this.mapStatus(chassisData.Status?.State, chassisData.Status?.Health),
              health: chassisData.Status?.Health,
              rawData: chassisData
            };
          }
        } catch (e) {
          continue;
        }
      }
    } catch (error) {
      console.error("[OpenBMC] Error getting motherboard:", error.message);
    }

    return null;
  }


  static async getBMCInfo(bmcAddress, config = {}) {
    const client = this.createClient(bmcAddress, config);

    try {
      const paths = [
        "/redfish/v1/Managers/bmc",
        "/redfish/v1/Managers/1",
        "/redfish/v1/Managers"
      ];

      for (const path of paths) {
        try {
          const response = await this.requestWithRetry(client, path, config);
          let bmcData = response.data;

          if (bmcData.Members) {
            const first = bmcData.Members[0];
            if (first?.["@odata.id"]) {
              const bmcResponse = await this.requestWithRetry(client, first["@odata.id"], config);
              bmcData = bmcResponse.data;
            }
          }

          if (bmcData.FirmwareVersion || bmcData.Model) {
            return {
              componentType: "BMC",
              name: bmcData.Model || "BMC Controller",
              slot: "BMC",
              manufacturer: bmcData.Manufacturer,
              model: bmcData.Model,
              firmwareVersion: bmcData.FirmwareVersion,
              status: this.mapStatus(bmcData.Status?.State, bmcData.Status?.Health),
              health: bmcData.Status?.Health,
              rawData: bmcData
            };
          }
        } catch (e) {
          continue;
        }
      }
    } catch (error) {
      console.error("[OpenBMC] Error getting BMC info:", error.message);
    }

    return null;
  }


  static async getAllComponents(bmcAddress, config = {}) {
    console.log(`[OpenBMC] Fetching components from ${bmcAddress}...`);


    const connectionCheck = await this.checkConnection(bmcAddress, config);
    if (!connectionCheck.success) {
      console.error(`[OpenBMC] BMC –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${connectionCheck.error}`);
      return [];
    }

    const components = [];


    console.log("[OpenBMC] –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤...");
    const processors = await this.getProcessors(bmcAddress, config);
    components.push(...processors);

    console.log("[OpenBMC] –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–º—è—Ç–∏...");
    const memory = await this.getMemory(bmcAddress, config);
    components.push(...memory);

    console.log("[OpenBMC] –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–µ–π...");
    const storage = await this.getStorage(bmcAddress, config);
    components.push(...storage);

    console.log("[OpenBMC] –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –∞–¥–∞–ø—Ç–µ—Ä–æ–≤...");
    const network = await this.getNetworkAdapters(bmcAddress, config);
    components.push(...network);

    console.log("[OpenBMC] –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ...");
    const motherboard = await this.getMotherboard(bmcAddress, config);
    if (motherboard) components.push(motherboard);

    console.log("[OpenBMC] –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ BMC...");
    const bmc = await this.getBMCInfo(bmcAddress, config);
    if (bmc) components.push(bmc);

    console.log(`[OpenBMC] Found ${components.length} components`);

    return components;
  }


  static mapStatus(state, health) {
    if (!state && !health) return "UNKNOWN";

    if (health === "Critical" || state === "Disabled" || state === "UnavailableOffline") {
      return "CRITICAL";
    }
    if (health === "Warning" || state === "Degraded") {
      return "WARNING";
    }
    if (health === "OK" || state === "Enabled" || state === "StandbyOffline") {
      return "OK";
    }

    return "UNKNOWN";
  }
}

module.exports = OpenBMCService;

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/PassportService.js
================================================================================

const { BeryllServer, BeryllServerChecklist, BeryllChecklistTemplate, BeryllBatch, BeryllServerComponent, User } = require("../../../models/index");
const { CHECKLIST_GROUPS } = require("../../../models/definitions/Beryll");
const ExcelJS = require("exceljs");


function formatBytes(bytes) {
  if (!bytes || bytes === 0) return null;

  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB", "TB", "PB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));

  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
}


function formatRamCapacity(capacity) {
  if (!capacity) return null;

  const numCapacity = parseInt(capacity);
  if (!numCapacity || isNaN(numCapacity)) return null;


  if (numCapacity < 1024) {
    return `${numCapacity} GB`;
  }


  return formatBytes(numCapacity);
}


function formatStorageCapacity(capacity) {
  if (!capacity) return null;

  const numCapacity = parseInt(capacity);
  if (!numCapacity || isNaN(numCapacity)) return null;


  if (numCapacity < 10000) {

    if (numCapacity >= 1000) {
      return `${(numCapacity / 1000).toFixed(2)} TB`;
    }
    return `${numCapacity} GB`;
  }


  return formatBytes(numCapacity);
}


function extractRamSpecsFromName(name, model) {
  const source = `${name || ''} ${model || ''}`.toUpperCase();
  const specs = {};


  const knownModels = {
    'M393A8G40AB2': { capacity: '64 GB', type: 'DDR4', speed: '3200 MT/s' },
    'M393A8G40BB4': { capacity: '64 GB', type: 'DDR4', speed: '2933 MT/s' },
    'M393A8G40MB2': { capacity: '64 GB', type: 'DDR4', speed: '2666 MT/s' },
    'M393A4K40CB2': { capacity: '32 GB', type: 'DDR4', speed: '2666 MT/s' },
    'M393A4K40DB2': { capacity: '32 GB', type: 'DDR4', speed: '2933 MT/s' },
    'M393A4K40DB3': { capacity: '32 GB', type: 'DDR4', speed: '3200 MT/s' },
    'M393A2K40CB2': { capacity: '16 GB', type: 'DDR4', speed: '2666 MT/s' },
    'M393A2K40DB2': { capacity: '16 GB', type: 'DDR4', speed: '2933 MT/s' },
    'M393A2K40DB3': { capacity: '16 GB', type: 'DDR4', speed: '3200 MT/s' },
    'M393A1K43DB2': { capacity: '8 GB', type: 'DDR4', speed: '2933 MT/s' },
    'M321R8GA0BB0': { capacity: '64 GB', type: 'DDR5', speed: '4800 MT/s' },
    'M321R4GA0BB0': { capacity: '32 GB', type: 'DDR5', speed: '4800 MT/s' },
  };


  for (const [modelPrefix, modelSpecs] of Object.entries(knownModels)) {
    if (source.includes(modelPrefix)) {
      return modelSpecs;
    }
  }


  const capacityMatch = source.match(/(\d+)\s*GB/i);
  if (capacityMatch) {
    specs.capacity = `${capacityMatch[1]} GB`;
  }


  if (source.includes('DDR5')) {
    specs.type = 'DDR5';
  } else if (source.includes('DDR4')) {
    specs.type = 'DDR4';
  } else if (source.includes('DDR3')) {
    specs.type = 'DDR3';
  }


  const speedMatch = source.match(/(\d{4})\s*(MT\/S|MHZ)?/i);
  if (speedMatch) {
    specs.speed = `${speedMatch[1]} MT/s`;
  }

  return Object.keys(specs).length > 0 ? specs : null;
}


function extractStorageSpecsFromName(name, model, componentType) {
  const source = `${name || ''} ${model || ''}`.toUpperCase();
  const specs = {};


  const knownHddModels = {
    'ST16000NM004J': { capacity: '16 TB', interface: 'SAS' },
    'ST18000NM000J': { capacity: '18 TB', interface: 'SAS' },
    'ST14000NM001G': { capacity: '14 TB', interface: 'SAS' },
    'ST12000NM001G': { capacity: '12 TB', interface: 'SAS' },
    'ST10000NM001G': { capacity: '10 TB', interface: 'SAS' },
    'ST8000NM000A': { capacity: '8 TB', interface: 'SAS' },
  };


  for (const [modelPrefix, modelSpecs] of Object.entries(knownHddModels)) {
    if (source.includes(modelPrefix)) {
      return modelSpecs;
    }
  }


  const tbMatch = source.match(/(\d+(?:\.\d+)?)\s*TB/i);
  if (tbMatch) {
    specs.capacity = `${tbMatch[1]} TB`;
  } else {
    const gbMatch = source.match(/(\d+)\s*GB/i);
    if (gbMatch) {
      specs.capacity = `${gbMatch[1]} GB`;
    }
  }


  if (source.includes('SAS')) {
    specs.interface = 'SAS';
  } else if (source.includes('NVME') || source.includes('NVM')) {
    specs.interface = 'NVMe';
  } else if (source.includes('SATA')) {
    specs.interface = 'SATA';
  } else if (componentType === 'HDD') {
    specs.interface = 'SAS';
  }

  return Object.keys(specs).length > 0 ? specs : null;
}

class PassportService {


  async generatePassport(id) {
    const server = await BeryllServer.findByPk(id, {
      include: [
        { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] },
        { model: BeryllBatch, as: "batch" },
        {
          model: BeryllServerChecklist,
          as: "checklists",
          include: [
            { model: BeryllChecklistTemplate, as: "template" },
            { model: User, as: "completedBy", attributes: ["name", "surname"] }
          ]
        }
      ]
    });

    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }


    const components = await BeryllServerComponent.findAll({
      where: { serverId: id },
      order: [
        ["componentType", "ASC"],
        ["slot", "ASC"]
      ]
    });

    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet("–ü–∞—Å–ø–æ—Ä—Ç");


    sheet.columns = [
      { width: 8 },
      { width: 35 },
      { width: 50 },
      { width: 22 },
      { width: 22 },
      { width: 15 },
      { width: 18 }
    ];


    const headerFont = { bold: true, size: 14 };
    const titleFont = { bold: true, size: 11 };
    const normalFont = { size: 10 };
    const centerAlign = { horizontal: "center", vertical: "middle" };
    const leftAlign = { horizontal: "left", vertical: "middle" };

    const thinBorder = {
      top: { style: "thin" },
      bottom: { style: "thin" },
      left: { style: "thin" },
      right: { style: "thin" }
    };


    sheet.mergeCells("A1:B1");
    sheet.getCell("A1").value = "–ê–û ¬´–ù–ü–ö –ö—Ä–∏–ø—Ç–æ–Ω–∏—Ç¬ª";
    sheet.getCell("A1").font = titleFont;

    sheet.mergeCells("C1:G1");
    sheet.getCell("C1").value = "–°–û–ü–†–û–í–û–î–ò–¢–ï–õ–¨–ù–´–ô –ü–ê–°–ü–û–†–¢ –ü–†–û–ò–ó–í–û–î–°–¢–í–ê";
    sheet.getCell("C1").font = headerFont;
    sheet.getCell("C1").alignment = centerAlign;

    sheet.mergeCells("A2:B2");
    sheet.getCell("A2").value = "–ê–ü–ö \"–ë–µ—Ä–∏–ª–ª\"";
    sheet.getCell("A2").font = titleFont;

    sheet.mergeCells("C2:G2");
    sheet.getCell("C2").value = `–ú–†–¢–ù.466514.002 - ${server.apkSerialNumber || "___"}`;
    sheet.getCell("C2").font = titleFont;
    sheet.getCell("C2").alignment = centerAlign;


    sheet.mergeCells("A3:B3");
    sheet.getCell("A3").value = "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞, (–ê–ü–ö):";
    sheet.getCell("A3").font = normalFont;

    sheet.getCell("C3").value = server.serialNumber || "___";
    sheet.getCell("D3").value = server.apkSerialNumber || "___";


    let currentRow = 5;

    if (components.length > 0) {

      sheet.mergeCells(`A${currentRow}:G${currentRow}`);
      sheet.getCell(`A${currentRow}`).value = "–ö–û–ú–ü–õ–ï–ö–¢–£–Æ–©–ò–ï –°–ï–†–í–ï–†–ê";
      sheet.getCell(`A${currentRow}`).font = headerFont;
      sheet.getCell(`A${currentRow}`).alignment = centerAlign;
      sheet.getCell(`A${currentRow}`).fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "FFD9E1F2" }
      };
      currentRow++;


      sheet.getCell(`A${currentRow}`).value = "‚Ññ";
      sheet.getCell(`B${currentRow}`).value = "–¢–∏–ø";
      sheet.getCell(`C${currentRow}`).value = "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / –ú–æ–¥–µ–ª—å";
      sheet.getCell(`D${currentRow}`).value = "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä";
      sheet.getCell(`E${currentRow}`).value = "S/N Yadro";
      sheet.getCell(`F${currentRow}`).value = "–†–µ–≤–∏–∑–∏—è";
      sheet.getCell(`G${currentRow}`).value = "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏";

      for (let col of ["A", "B", "C", "D", "E", "F", "G"]) {
        const cell = sheet.getCell(`${col}${currentRow}`);
        cell.font = titleFont;
        cell.alignment = centerAlign;
        cell.border = thinBorder;
        cell.fill = {
          type: "pattern",
          pattern: "solid",
          fgColor: { argb: "FFE0E0E0" }
        };
      }
      currentRow++;


      const grouped = {
        CPU: components.filter(c => c.componentType === "CPU"),
        RAM: components.filter(c => c.componentType === "RAM"),
        storage: components.filter(c => ["SSD", "HDD", "NVME"].includes(c.componentType)),
        NIC: components.filter(c => c.componentType === "NIC"),
        other: components.filter(c => ["MOTHERBOARD", "BMC", "PSU", "GPU", "RAID", "OTHER"].includes(c.componentType))
      };

      const typeLabels = {
        CPU: "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä",
        RAM: "–ü–∞–º—è—Ç—å",
        SSD: "SSD",
        HDD: "HDD",
        NVME: "NVMe",
        NIC: "–°–µ—Ç–µ–≤–æ–π –∞–¥–∞–ø—Ç–µ—Ä",
        MOTHERBOARD: "–ú–∞—Ç. –ø–ª–∞—Ç–∞",
        BMC: "BMC",
        PSU: "–ë–ü",
        GPU: "–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞",
        RAID: "RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä",
        OTHER: "–ü—Ä–æ—á–µ–µ"
      };

      let compNumber = 0;


      const allGrouped = [
        ...grouped.CPU,
        ...grouped.RAM,
        ...grouped.storage,
        ...grouped.NIC,
        ...grouped.other
      ];

      for (const comp of allGrouped) {
        compNumber++;


        sheet.getCell(`A${currentRow}`).value = compNumber;
        sheet.getCell(`A${currentRow}`).font = normalFont;
        sheet.getCell(`A${currentRow}`).alignment = centerAlign;


        sheet.getCell(`B${currentRow}`).value = typeLabels[comp.componentType] || comp.componentType;
        sheet.getCell(`B${currentRow}`).font = normalFont;
        sheet.getCell(`B${currentRow}`).alignment = leftAlign;


        const name = comp.name || comp.model || "‚Äî";
        sheet.getCell(`C${currentRow}`).value = name;
        sheet.getCell(`C${currentRow}`).font = normalFont;
        sheet.getCell(`C${currentRow}`).alignment = { ...leftAlign, wrapText: true };


        sheet.getCell(`D${currentRow}`).value = comp.serialNumber || "‚Äî";
        sheet.getCell(`D${currentRow}`).font = normalFont;
        sheet.getCell(`D${currentRow}`).alignment = centerAlign;


        sheet.getCell(`E${currentRow}`).value = comp.serialNumberYadro || "‚Äî";
        sheet.getCell(`E${currentRow}`).font = normalFont;
        sheet.getCell(`E${currentRow}`).alignment = centerAlign;


        const revision = comp.metadata?.revision || "";
        sheet.getCell(`F${currentRow}`).value = revision || "‚Äî";
        sheet.getCell(`F${currentRow}`).font = normalFont;
        sheet.getCell(`F${currentRow}`).alignment = centerAlign;


        let specs = this.formatComponentSpecs(comp);
        sheet.getCell(`G${currentRow}`).value = specs || "‚Äî";
        sheet.getCell(`G${currentRow}`).font = normalFont;
        sheet.getCell(`G${currentRow}`).alignment = centerAlign;


        for (let col of ["A", "B", "C", "D", "E", "F", "G"]) {
          sheet.getCell(`${col}${currentRow}`).border = thinBorder;
        }

        currentRow++;
      }


      sheet.mergeCells(`A${currentRow}:E${currentRow}`);
      sheet.getCell(`A${currentRow}`).value = "–ò—Ç–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö:";
      sheet.getCell(`A${currentRow}`).font = titleFont;
      sheet.getCell(`A${currentRow}`).alignment = { horizontal: "right", vertical: "middle" };
      sheet.getCell(`A${currentRow}`).border = thinBorder;


      const totalRAM = grouped.RAM.reduce((sum, r) => sum + (parseInt(r.capacity) || 0), 0);
      const totalStorage = grouped.storage.reduce((sum, s) => sum + (parseInt(s.capacity) || 0), 0);
      const totalCores = grouped.CPU.reduce((sum, c) => sum + (c.metadata?.cores || 0), 0);

      const ramFormatted = formatRamCapacity(totalRAM) || formatBytes(totalRAM) || "‚Äî";
      const storageFormatted = formatStorageCapacity(totalStorage) || formatBytes(totalStorage) || "‚Äî";

      sheet.mergeCells(`F${currentRow}:G${currentRow}`);
      sheet.getCell(`F${currentRow}`).value = `CPU: ${totalCores} —è–¥–µ—Ä | RAM: ${ramFormatted} | Storage: ${storageFormatted}`;
      sheet.getCell(`F${currentRow}`).font = titleFont;
      sheet.getCell(`F${currentRow}`).alignment = centerAlign;
      sheet.getCell(`F${currentRow}`).border = thinBorder;

      currentRow += 2;
    }


    sheet.mergeCells(`A${currentRow}:G${currentRow}`);
    sheet.getCell(`A${currentRow}`).value = "–û–ü–ï–†–ê–¶–ò–ò –ü–†–û–ò–ó–í–û–î–°–¢–í–ê";
    sheet.getCell(`A${currentRow}`).font = headerFont;
    sheet.getCell(`A${currentRow}`).alignment = centerAlign;
    sheet.getCell(`A${currentRow}`).fill = {
      type: "pattern",
      pattern: "solid",
      fgColor: { argb: "FFD9E1F2" }
    };
    currentRow++;


    const headerRow = currentRow;
    sheet.getCell(`A${headerRow}`).value = "‚Ññ\n–ø/–ø";
    sheet.getCell(`B${headerRow}`).value = "–û–ø–µ—Ä–∞—Ü–∏—è";
    sheet.mergeCells(`C${headerRow}:E${headerRow}`);
    sheet.getCell(`C${headerRow}`).value = "–≠—Ç–∞–ø";
    sheet.getCell(`F${headerRow}`).value = "–ü–æ–¥–ø–∏—Å—å";
    sheet.getCell(`G${headerRow}`).value = "–î–∞—Ç–∞";

    for (let col of ["A", "B", "C", "F", "G"]) {
      const cell = sheet.getCell(`${col}${headerRow}`);
      cell.font = titleFont;
      cell.alignment = centerAlign;
      cell.border = thinBorder;
      cell.fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "FFE0E0E0" }
      };
    }

    sheet.getCell(`D${headerRow}`).border = thinBorder;
    sheet.getCell(`E${headerRow}`).border = thinBorder;
    sheet.getRow(headerRow).height = 30;
    currentRow++;


    const groupLabels = {
      [CHECKLIST_GROUPS.VISUAL]: "–í–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Å–º–æ—Ç—Ä",
      [CHECKLIST_GROUPS.TESTING]: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏",
      [CHECKLIST_GROUPS.QC_PRIMARY]: "–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è",
      [CHECKLIST_GROUPS.BURN_IN]: "–ò—Å–ø—ã—Ç–∞—Ç–µ–ª—å–Ω–∞—è",
      [CHECKLIST_GROUPS.QC_FINAL]: "–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è"
    };


    const sortedChecklists = (server.checklists || []).sort(
      (a, b) => (a.template?.sortOrder || 0) - (b.template?.sortOrder || 0)
    );

    let currentGroup = null;
    let groupNumber = 0;

    for (const checklist of sortedChecklists) {
      const template = checklist.template;
      if (!template) continue;


      if (template.groupCode !== currentGroup) {
        currentGroup = template.groupCode;
        groupNumber++;

        sheet.getCell(`A${currentRow}`).value = groupNumber;
        sheet.getCell(`A${currentRow}`).font = titleFont;
        sheet.getCell(`A${currentRow}`).alignment = centerAlign;

        sheet.getCell(`B${currentRow}`).value = groupLabels[currentGroup] || template.groupCode;
        sheet.getCell(`B${currentRow}`).font = titleFont;
      }


      sheet.mergeCells(`C${currentRow}:E${currentRow}`);
      sheet.getCell(`C${currentRow}`).value = template.title;
      sheet.getCell(`C${currentRow}`).font = normalFont;
      sheet.getCell(`C${currentRow}`).alignment = { ...leftAlign, wrapText: true };


      if (checklist.completed && checklist.completedBy) {
        sheet.getCell(`F${currentRow}`).value =
          `${checklist.completedBy.surname} ${checklist.completedBy.name?.charAt(0) || ""}.`;
      }
      sheet.getCell(`F${currentRow}`).font = normalFont;
      sheet.getCell(`F${currentRow}`).alignment = centerAlign;


      if (checklist.completedAt) {
        const date = new Date(checklist.completedAt);
        sheet.getCell(`G${currentRow}`).value = date.toLocaleDateString("ru-RU");
      }
      sheet.getCell(`G${currentRow}`).font = normalFont;
      sheet.getCell(`G${currentRow}`).alignment = centerAlign;


      for (let col of ["A", "B", "C", "D", "E", "F", "G"]) {
        sheet.getCell(`${col}${currentRow}`).border = thinBorder;
      }

      currentRow++;
    }


    if (server.burnInStartAt) {
      currentRow++;
      sheet.getCell(`B${currentRow}`).value = "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–æ–Ω:";
      sheet.getCell(`B${currentRow}`).font = normalFont;
      sheet.mergeCells(`C${currentRow}:E${currentRow}`);
      sheet.getCell(`C${currentRow}`).value = new Date(server.burnInStartAt).toLocaleString("ru-RU");
      sheet.getCell(`C${currentRow}`).font = normalFont;
    }

    if (server.burnInEndAt) {
      currentRow++;
      sheet.getCell(`B${currentRow}`).value = "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞:";
      sheet.getCell(`B${currentRow}`).font = normalFont;
      sheet.mergeCells(`C${currentRow}:E${currentRow}`);
      sheet.getCell(`C${currentRow}`).value = new Date(server.burnInEndAt).toLocaleString("ru-RU");
      sheet.getCell(`C${currentRow}`).font = normalFont;
    }


    const buffer = await workbook.xlsx.writeBuffer();

    const fileName = `–ü–∞—Å–ø–æ—Ä—Ç_${server.apkSerialNumber || server.id}.xlsx`;

    return {
      buffer,
      fileName
    };
  }


  formatComponentSpecs(comp) {
    if (comp.componentType === "CPU") {
      const parts = [];
      const cores = comp.metadata?.cores;
      const threads = comp.metadata?.threads;
      const speed = comp.speed;

      if (cores) {
        parts.push(`${cores}/${threads || cores} –ø–æ—Ç–æ–∫–æ–≤`);
      }
      if (speed) {
        parts.push(`@ ${speed} MHz`);
      }
      return parts.join(" ") || null;

    } else if (comp.componentType === "RAM") {

      let capacityStr = formatRamCapacity(comp.capacity);
      let typeStr = comp.metadata?.memoryType;
      let speedStr = comp.speed ? String(comp.speed) : null;


      if (!capacityStr || !typeStr || !speedStr) {
        const extracted = extractRamSpecsFromName(comp.name, comp.model);
        if (extracted) {
          if (!capacityStr && extracted.capacity) capacityStr = extracted.capacity;
          if (!typeStr && extracted.type) typeStr = extracted.type;
          if (!speedStr && extracted.speed) speedStr = extracted.speed;
        }
      }


      const parts = [];
      if (capacityStr) parts.push(capacityStr);
      if (typeStr) parts.push(typeStr);
      if (speedStr) {

        const speedString = String(speedStr);
        if (!speedString.includes('MT/s') && !speedString.includes('MHz')) {
          parts.push(`${speedString} MT/s`);
        } else {
          parts.push(speedString);
        }
      }

      return parts.join(" ") || null;

    } else if (["SSD", "HDD", "NVME"].includes(comp.componentType)) {
      let capacityStr = formatStorageCapacity(comp.capacity);
      let interfaceStr = comp.metadata?.interface;


      if (!capacityStr || !interfaceStr) {
        const extracted = extractStorageSpecsFromName(comp.name, comp.model, comp.componentType);
        if (extracted) {
          if (!capacityStr && extracted.capacity) capacityStr = extracted.capacity;
          if (!interfaceStr && extracted.interface) interfaceStr = extracted.interface;
        }
      }

      const parts = [];
      if (capacityStr) parts.push(capacityStr);
      if (interfaceStr) parts.push(interfaceStr);

      return parts.join(" ") || null;

    } else if (comp.componentType === "NIC") {
      const parts = [];
      if (comp.metadata?.macAddress) parts.push(comp.metadata.macAddress);
      if (comp.metadata?.linkSpeed) parts.push(comp.metadata.linkSpeed);
      return parts.join(" ") || null;

    } else if (comp.componentType === "PSU") {
      if (comp.capacity) return `${comp.capacity}W`;
      return null;

    } else {
      if (comp.firmwareVersion) return `FW: ${comp.firmwareVersion}`;
      return null;
    }
  }
}

module.exports = new PassportService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/RackService.js
================================================================================



const { Op } = require("sequelize");
const { NodeSSH } = require("node-ssh");


const {
  BeryllRack,
  BeryllRackUnit,
  BeryllExtendedHistory,
  RACK_STATUSES,
  BeryllServer,
  BeryllBatch,
  User
} = require("../../../models/index");

const { DHCP_CONFIG } = require("../config/beryll.config");
const { parseDhcpLeases } = require("../utils/dhcpParser");

class RackService {


  async getAllRacks(options = {}) {
    const { status, search, includeUnits = false } = options;

    const where = {};
    if (status) where.status = status;
    if (search) {
      where[Op.or] = [
        { name: { [Op.iLike]: `%${search}%` } },
        { location: { [Op.iLike]: `%${search}%` } }
      ];
    }

    const include = [];
    if (includeUnits) {
      include.push({
        model: BeryllRackUnit,
        as: "units",
        include: [
          {
            model: BeryllServer,
            as: "server",
            attributes: ["id", "ipAddress", "apkSerialNumber", "hostname", "status", "macAddress", "assignedToId"],
            include: [
              { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] }
            ]
          },
          { model: User, as: "installedBy", attributes: ["id", "login", "name", "surname"] },
          { model: User, as: "placedBy", attributes: ["id", "login", "name", "surname"] }
        ],
        order: [["unitNumber", "ASC"]]
      });
    }

    const racks = await BeryllRack.findAll({
      where,
      include,
      order: [["name", "ASC"]]
    });


    const result = await Promise.all(racks.map(async (rack) => {
      const rackData = rack.toJSON();

      const filledUnits = await BeryllRackUnit.count({
        where: {
          rackId: rack.id,
          serverId: { [Op.ne]: null }
        }
      });

      const totalUnits = await BeryllRackUnit.count({
        where: { rackId: rack.id }
      });


      const unitsInWork = await BeryllRackUnit.count({
        where: { rackId: rack.id },
        include: [{
          model: BeryllServer,
          as: "server",
          where: { status: "IN_WORK" },
          required: true
        }]
      });


      const unitsWithDefect = await BeryllRackUnit.count({
        where: { rackId: rack.id },
        include: [{
          model: BeryllServer,
          as: "server",
          where: { status: "DEFECT" },
          required: true
        }]
      });

      return {
        ...rackData,
        filledUnits,
        totalUnitsCount: totalUnits,
        unitsInWork,
        unitsWithDefect,
        occupancyPercent: totalUnits > 0 ? Math.round((filledUnits / totalUnits) * 100) : 0
      };
    }));

    return result;
  }


  async getRackById(id) {
    const rack = await BeryllRack.findByPk(id, {
      include: [
        {
          model: BeryllRackUnit,
          as: "units",
          include: [
            {
              model: BeryllServer,
              as: "server",
              attributes: [
                "id", "ipAddress", "apkSerialNumber", "hostname", "status",
                "macAddress", "assignedToId", "assignedAt", "leaseActive",
                "serialNumber", "notes"
              ],
              include: [
                { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] }
              ]
            },
            { model: User, as: "installedBy", attributes: ["id", "login", "name", "surname"] },
            { model: User, as: "placedBy", attributes: ["id", "login", "name", "surname"] }
          ],
          order: [["unitNumber", "ASC"]]
        }
      ]
    });

    return rack;
  }


  async createRack(data, userId) {
    const rack = await BeryllRack.create({
      name: data.name,
      location: data.location,
      totalUnits: data.totalUnits || 42,
      networkSubnet: data.networkSubnet,
      gateway: data.gateway,
      status: data.status || RACK_STATUSES.ACTIVE,
      notes: data.notes,
      metadata: data.metadata || {}
    });


    const units = [];
    for (let i = 1; i <= rack.totalUnits; i++) {
      units.push({
        rackId: rack.id,
        unitNumber: i,
        serverId: null
      });
    }
    await BeryllRackUnit.bulkCreate(units);


    await this.logHistory("RACK", rack.id, "CREATED", userId, `–°–æ–∑–¥–∞–Ω–∞ —Å—Ç–æ–π–∫–∞ ${rack.name}`);

    return this.getRackById(rack.id);
  }


  async updateRack(id, data, userId) {
    const rack = await BeryllRack.findByPk(id);
    if (!rack) throw new Error("–°—Ç–æ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

    const oldData = rack.toJSON();

    await rack.update({
      name: data.name !== undefined ? data.name : rack.name,
      location: data.location !== undefined ? data.location : rack.location,
      networkSubnet: data.networkSubnet !== undefined ? data.networkSubnet : rack.networkSubnet,
      gateway: data.gateway !== undefined ? data.gateway : rack.gateway,
      status: data.status !== undefined ? data.status : rack.status,
      notes: data.notes !== undefined ? data.notes : rack.notes,
      metadata: data.metadata !== undefined ? data.metadata : rack.metadata
    });


    const changes = {};
    Object.keys(data).forEach(key => {
      if (oldData[key] !== data[key]) {
        changes[key] = { from: oldData[key], to: data[key] };
      }
    });

    if (Object.keys(changes).length > 0) {
      await this.logHistory("RACK", id, "UPDATED", userId, `–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–æ–π–∫–∞ ${rack.name}`, changes);
    }

    return this.getRackById(id);
  }


  async deleteRack(id, userId) {
    const rack = await BeryllRack.findByPk(id);
    if (!rack) throw new Error("–°—Ç–æ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");


    const serversInRack = await BeryllRackUnit.count({
      where: {
        rackId: id,
        serverId: { [Op.ne]: null }
      }
    });

    if (serversInRack > 0) {
      throw new Error(`–í —Å—Ç–æ–π–∫–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è ${serversInRack} —Å–µ—Ä–≤–µ—Ä–æ–≤. –°–Ω–∞—á–∞–ª–∞ –∏–∑–≤–ª–µ–∫–∏—Ç–µ –∏—Ö.`);
    }

    await this.logHistory("RACK", id, "DELETED", userId, `–£–¥–∞–ª–µ–Ω–∞ —Å—Ç–æ–π–∫–∞ ${rack.name}`);

    await rack.destroy();

    return { success: true, message: "–°—Ç–æ–π–∫–∞ —É–¥–∞–ª–µ–Ω–∞" };
  }


  async getUnitById(unitId) {
    return BeryllRackUnit.findByPk(unitId, {
      include: [
        { model: BeryllRack, as: "rack" },
        {
          model: BeryllServer,
          as: "server",
          include: [
            { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] }
          ]
        },
        { model: User, as: "installedBy", attributes: ["id", "login", "name", "surname"] },
        { model: User, as: "placedBy", attributes: ["id", "login", "name", "surname"] }
      ]
    });
  }


  async getUnitByNumber(rackId, unitNumber) {
    return BeryllRackUnit.findOne({
      where: { rackId, unitNumber },
      include: [
        { model: BeryllRack, as: "rack" },
        {
          model: BeryllServer,
          as: "server",
          include: [
            { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] }
          ]
        },
        { model: User, as: "installedBy", attributes: ["id", "login", "name", "surname"] },
        { model: User, as: "placedBy", attributes: ["id", "login", "name", "surname"] }
      ]
    });
  }


  async placeServerInRack(rackId, unitNumber, serverId, userId) {
    const unit = await BeryllRackUnit.findOne({
      where: { rackId, unitNumber }
    });

    if (!unit) throw new Error("–Æ–Ω–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
    if (unit.serverId) throw new Error(`–Æ–Ω–∏—Ç ${unitNumber} —É–∂–µ –∑–∞–Ω—è—Ç`);


    const existingInstallation = await BeryllRackUnit.findOne({
      where: { serverId }
    });

    if (existingInstallation) {
      throw new Error(`–°–µ—Ä–≤–µ—Ä —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å—Ç–æ–π–∫—É (Rack ID: ${existingInstallation.rackId}, Unit: ${existingInstallation.unitNumber})`);
    }


    await unit.update({
      serverId,
      placedById: userId,
      placedAt: new Date()

    });

    await this.logHistory("RACK", rackId, "SERVER_PLACED", userId,
      `–°–µ—Ä–≤–µ—Ä ${serverId} —Ä–∞–∑–º–µ—â—ë–Ω –≤ —é–Ω–∏—Ç ${unitNumber} (–±–µ–∑ –≤–∑—è—Ç–∏—è –≤ —Ä–∞–±–æ—Ç—É)`,
      { serverId, unitNumber, action: "PLACED" }
    );

    return this.getUnitById(unit.id);
  }


  async installServer(rackId, unitNumber, serverId, data, userId) {
    const unit = await BeryllRackUnit.findOne({
      where: { rackId, unitNumber }
    });

    if (!unit) throw new Error("–Æ–Ω–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");


    if (unit.serverId && unit.serverId !== serverId) {
      throw new Error(`–Æ–Ω–∏—Ç ${unitNumber} —É–∂–µ –∑–∞–Ω—è—Ç`);
    }


    if (!unit.serverId) {
      const existingInstallation = await BeryllRackUnit.findOne({
        where: { serverId }
      });

      if (existingInstallation) {
        throw new Error(`–°–µ—Ä–≤–µ—Ä —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å—Ç–æ–π–∫—É (Rack ID: ${existingInstallation.rackId}, Unit: ${existingInstallation.unitNumber})`);
      }
    }

    const wasAlreadyPlaced = unit.serverId === serverId;

    await unit.update({
      serverId,
      hostname: data.hostname,
      mgmtMacAddress: data.mgmtMacAddress,
      mgmtIpAddress: data.mgmtIpAddress,
      dataMacAddress: data.dataMacAddress,
      dataIpAddress: data.dataIpAddress,
      accessLogin: data.accessLogin,
      accessPassword: data.accessPassword,
      notes: data.notes,
      installedAt: new Date(),
      installedById: userId,

      placedById: unit.placedById || userId,
      placedAt: unit.placedAt || new Date()
    });

    const action = wasAlreadyPlaced ? "SERVER_TAKEN_TO_WORK" : "SERVER_INSTALLED";
    const comment = wasAlreadyPlaced
      ? `–°–µ—Ä–≤–µ—Ä ${serverId} –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É –≤ —é–Ω–∏—Ç–µ ${unitNumber}`
      : `–°–µ—Ä–≤–µ—Ä ${serverId} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —é–Ω–∏—Ç ${unitNumber}`;

    await this.logHistory("RACK", rackId, action, userId, comment, { serverId, unitNumber });

    return this.getUnitById(unit.id);
  }


  async removeServer(rackId, unitNumber, userId) {
    const unit = await BeryllRackUnit.findOne({
      where: { rackId, unitNumber }
    });

    if (!unit) throw new Error("–Æ–Ω–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
    if (!unit.serverId) throw new Error("–Æ–Ω–∏—Ç –ø—É—Å—Ç");

    const oldServerId = unit.serverId;

    await unit.update({
      serverId: null,
      hostname: null,
      mgmtMacAddress: null,
      mgmtIpAddress: null,
      dataMacAddress: null,
      dataIpAddress: null,
      accessLogin: null,
      accessPassword: null,
      installedAt: null,
      installedById: null,
      placedById: null,
      placedAt: null,
      dhcpIpAddress: null,
      dhcpMacAddress: null,
      dhcpHostname: null,
      dhcpLeaseActive: false,
      dhcpLastSync: null
    });

    await this.logHistory("RACK", rackId, "SERVER_REMOVED", userId,
      `–°–µ—Ä–≤–µ—Ä ${oldServerId} –∏–∑–≤–ª–µ—á—ë–Ω –∏–∑ —é–Ω–∏—Ç–∞ ${unitNumber}`,
      { serverId: oldServerId, unitNumber }
    );

    return { success: true, message: "–°–µ—Ä–≤–µ—Ä –∏–∑–≤–ª–µ—á—ë–Ω" };
  }


  async updateUnit(unitId, data, userId) {
    const unit = await BeryllRackUnit.findByPk(unitId);
    if (!unit) throw new Error("–Æ–Ω–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");

    await unit.update({
      hostname: data.hostname !== undefined ? data.hostname : unit.hostname,
      mgmtMacAddress: data.mgmtMacAddress !== undefined ? data.mgmtMacAddress : unit.mgmtMacAddress,
      mgmtIpAddress: data.mgmtIpAddress !== undefined ? data.mgmtIpAddress : unit.mgmtIpAddress,
      dataMacAddress: data.dataMacAddress !== undefined ? data.dataMacAddress : unit.dataMacAddress,
      dataIpAddress: data.dataIpAddress !== undefined ? data.dataIpAddress : unit.dataIpAddress,
      accessLogin: data.accessLogin !== undefined ? data.accessLogin : unit.accessLogin,
      accessPassword: data.accessPassword !== undefined ? data.accessPassword : unit.accessPassword,
      notes: data.notes !== undefined ? data.notes : unit.notes
    });

    await this.logHistory("RACK", unit.rackId, "UNIT_UPDATED", userId,
      `–û–±–Ω–æ–≤–ª—ë–Ω —é–Ω–∏—Ç ${unit.unitNumber}`
    );

    return this.getUnitById(unitId);
  }


  async moveServer(fromRackId, fromUnit, toRackId, toUnit, userId) {
    const sourceUnit = await BeryllRackUnit.findOne({
      where: { rackId: fromRackId, unitNumber: fromUnit }
    });

    if (!sourceUnit || !sourceUnit.serverId) {
      throw new Error("–ò—Å—Ö–æ–¥–Ω—ã–π —é–Ω–∏—Ç –ø—É—Å—Ç –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    const targetUnit = await BeryllRackUnit.findOne({
      where: { rackId: toRackId, unitNumber: toUnit }
    });

    if (!targetUnit) throw new Error("–¶–µ–ª–µ–≤–æ–π —é–Ω–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
    if (targetUnit.serverId) throw new Error("–¶–µ–ª–µ–≤–æ–π —é–Ω–∏—Ç –∑–∞–Ω—è—Ç");


    const serverData = {
      serverId: sourceUnit.serverId,
      hostname: sourceUnit.hostname,
      mgmtMacAddress: sourceUnit.mgmtMacAddress,
      mgmtIpAddress: sourceUnit.mgmtIpAddress,
      dataMacAddress: sourceUnit.dataMacAddress,
      dataIpAddress: sourceUnit.dataIpAddress,
      accessLogin: sourceUnit.accessLogin,
      accessPassword: sourceUnit.accessPassword,
      notes: sourceUnit.notes,
      installedAt: sourceUnit.installedAt,
      installedById: sourceUnit.installedById,
      placedById: sourceUnit.placedById,
      placedAt: sourceUnit.placedAt,
      dhcpIpAddress: sourceUnit.dhcpIpAddress,
      dhcpMacAddress: sourceUnit.dhcpMacAddress,
      dhcpHostname: sourceUnit.dhcpHostname,
      dhcpLeaseActive: sourceUnit.dhcpLeaseActive,
      dhcpLastSync: sourceUnit.dhcpLastSync
    };


    await sourceUnit.update({
      serverId: null,
      hostname: null,
      mgmtMacAddress: null,
      mgmtIpAddress: null,
      dataMacAddress: null,
      dataIpAddress: null,
      accessLogin: null,
      accessPassword: null,
      installedAt: null,
      installedById: null,
      placedById: null,
      placedAt: null,
      dhcpIpAddress: null,
      dhcpMacAddress: null,
      dhcpHostname: null,
      dhcpLeaseActive: false,
      dhcpLastSync: null
    });


    await targetUnit.update(serverData);

    await this.logHistory("RACK", toRackId, "SERVER_MOVED", userId,
      `–°–µ—Ä–≤–µ—Ä ${serverData.serverId} –ø–µ—Ä–µ–º–µ—â—ë–Ω –∏–∑ ${fromRackId}:${fromUnit} –≤ ${toRackId}:${toUnit}`,
      { serverId: serverData.serverId, from: { rackId: fromRackId, unit: fromUnit }, to: { rackId: toRackId, unit: toUnit } }
    );

    return this.getUnitById(targetUnit.id);
  }


  async getFreeUnits(rackId) {
    return BeryllRackUnit.findAll({
      where: {
        rackId,
        serverId: null
      },
      order: [["unitNumber", "ASC"]]
    });
  }


  async findServerInRacks(serverId) {
    return BeryllRackUnit.findOne({
      where: { serverId },
      include: [
        { model: BeryllRack, as: "rack" },
        { model: User, as: "placedBy", attributes: ["id", "login", "name", "surname"] },
        { model: User, as: "installedBy", attributes: ["id", "login", "name", "surname"] }
      ]
    });
  }


  async getUnitsByServerStatus(rackId, status) {
    const where = { rackId };

    const serverWhere = status ? { status } : { id: { [Op.ne]: null } };

    return BeryllRackUnit.findAll({
      where,
      include: [{
        model: BeryllServer,
        as: "server",
        where: serverWhere,
        required: true,
        include: [
          { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] }
        ]
      }, {
        model: User,
        as: "placedBy",
        attributes: ["id", "login", "name", "surname"]
      }, {
        model: User,
        as: "installedBy",
        attributes: ["id", "login", "name", "surname"]
      }],
      order: [["unitNumber", "ASC"]]
    });
  }


  async getRackSummary(rackId) {
    const rack = await BeryllRack.findByPk(rackId);
    if (!rack) throw new Error("–°—Ç–æ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");


    const units = await BeryllRackUnit.findAll({
      where: {
        rackId,
        serverId: { [Op.ne]: null }
      },
      include: [{
        model: BeryllServer,
        as: "server",
        attributes: ["status"],
        required: true
      }]
    });

    const byStatus = {};
    units.forEach(unit => {
      const status = unit.server?.status || "UNKNOWN";
      byStatus[status] = (byStatus[status] || 0) + 1;
    });


    const placedByUnits = await BeryllRackUnit.findAll({
      where: {
        rackId,
        placedById: { [Op.ne]: null }
      },
      include: [{
        model: User,
        as: "placedBy",
        attributes: ["id", "login", "name", "surname"]
      }],
      attributes: ["placedById"]
    });


    const uniquePlacedBy = [];
    const seenIds = new Set();
    placedByUnits.forEach(unit => {
      if (unit.placedBy && !seenIds.has(unit.placedBy.id)) {
        seenIds.add(unit.placedBy.id);
        uniquePlacedBy.push(unit.placedBy);
      }
    });


    const serversInWork = byStatus["IN_WORK"] || 0;

    return {
      rackId,
      rackName: rack.name,
      totalUnits: rack.totalUnits,
      filledUnits: units.length,
      byStatus,
      placedByUsers: uniquePlacedBy,
      serversInWork,
      serversWithDefect: byStatus["DEFECT"] || 0
    };
  }


  async syncRackWithDhcp(rackId, userId) {
    const rack = await BeryllRack.findByPk(rackId, {
      include: [{
        model: BeryllRackUnit,
        as: "units",
        where: { serverId: { [Op.ne]: null } },
        required: false,
        include: [{ model: BeryllServer, as: "server" }]
      }]
    });

    if (!rack) throw new Error("–°—Ç–æ–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

    const unitsWithServers = rack.units?.filter(u => u.serverId) || [];

    if (unitsWithServers.length === 0) {
      return { success: true, message: "–ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏", synced: 0, total: 0 };
    }

    const ssh = new NodeSSH();

    try {
      await ssh.connect({
        host: DHCP_CONFIG.host,
        username: DHCP_CONFIG.username,
        password: DHCP_CONFIG.password,
        readyTimeout: 10000
      });

      const result = await ssh.execCommand(`cat ${DHCP_CONFIG.leaseFile}`);

      if (result.stderr && !result.stdout) {
        throw new Error(`SSH Error: ${result.stderr}`);
      }

      const leases = parseDhcpLeases(result.stdout);
      const syncTime = new Date();
      let syncedCount = 0;

      for (const unit of unitsWithServers) {
        if (!unit.server) continue;


        const serverMac = unit.server.macAddress?.toUpperCase();
        const unitMac = unit.mgmtMacAddress?.toUpperCase();

        const matchingLease = leases.find(lease => {
          const leaseMac = lease.macAddress?.toUpperCase();
          return leaseMac === serverMac || leaseMac === unitMac;
        });

        if (matchingLease) {
          await unit.update({
            dhcpIpAddress: matchingLease.ipAddress,
            dhcpMacAddress: matchingLease.macAddress,
            dhcpHostname: matchingLease.hostname,
            dhcpLeaseActive: matchingLease.leaseActive,
            dhcpLastSync: syncTime
          });
          syncedCount++;
        } else {

          await unit.update({
            dhcpLeaseActive: false,
            dhcpLastSync: syncTime
          });
        }
      }

      ssh.dispose();

      await this.logHistory("RACK", rackId, "DHCP_SYNC", userId,
        `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å DHCP: –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${syncedCount} —Å–µ—Ä–≤–µ—Ä–æ–≤`,
        { synced: syncedCount, total: unitsWithServers.length }
      );

      return {
        success: true,
        message: `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${syncedCount} –∏–∑ ${unitsWithServers.length} —Å–µ—Ä–≤–µ—Ä–æ–≤`,
        synced: syncedCount,
        total: unitsWithServers.length
      };

    } catch (error) {
      ssh.dispose();
      console.error("[RackService] DHCP Sync Error:", error);
      throw new Error(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å DHCP: ${error.message}`);
    }
  }


  async findIpByMac(macAddress) {
    if (!macAddress) {
      throw new Error("MAC –∞–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω");
    }

    const ssh = new NodeSSH();

    try {
      await ssh.connect({
        host: DHCP_CONFIG.host,
        username: DHCP_CONFIG.username,
        password: DHCP_CONFIG.password,
        readyTimeout: 10000
      });

      const result = await ssh.execCommand(`cat ${DHCP_CONFIG.leaseFile}`);
      ssh.dispose();

      if (result.stderr && !result.stdout) {
        throw new Error(`SSH Error: ${result.stderr}`);
      }

      const leases = parseDhcpLeases(result.stdout);
      const normalizedMac = macAddress.toUpperCase().replace(/-/g, ":");

      const matchingLease = leases.find(lease =>
        lease.macAddress?.toUpperCase() === normalizedMac
      );

      if (matchingLease) {
        return {
          found: true,
          ipAddress: matchingLease.ipAddress,
          hostname: matchingLease.hostname,
          leaseActive: matchingLease.leaseActive,
          leaseStart: matchingLease.leaseStart,
          leaseEnd: matchingLease.leaseEnd
        };
      }

      return { found: false };

    } catch (error) {
      ssh.dispose();
      console.error("[RackService] Find IP Error:", error);
      throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ IP: ${error.message}`);
    }
  }


  async findServerInDhcp(serialNumber) {
    const ssh = new NodeSSH();

    try {
      await ssh.connect({
        host: DHCP_CONFIG.host,
        username: DHCP_CONFIG.username,
        password: DHCP_CONFIG.password,
        readyTimeout: 10000
      });

      const result = await ssh.execCommand(`cat ${DHCP_CONFIG.leaseFile}`);
      ssh.dispose();

      if (result.stderr && !result.stdout) {
        throw new Error(`SSH Error: ${result.stderr}`);
      }

      const leases = parseDhcpLeases(result.stdout);


      const matchingLease = leases.find(lease => {
        const h = lease.hostname?.toLowerCase() || "";
        const s = serialNumber.toLowerCase();
        return h.includes(s) || s.includes(h);
      });

      if (matchingLease) {
        return {
          found: true,
          ipAddress: matchingLease.ipAddress,
          macAddress: matchingLease.macAddress,
          hostname: matchingLease.hostname,
          leaseActive: matchingLease.leaseActive,
          leaseStart: matchingLease.leaseStart,
          leaseEnd: matchingLease.leaseEnd
        };
      }

      return { found: false };

    } catch (error) {
      ssh.dispose();
      console.error("[RackService] Find server in DHCP error:", error);
      return { found: false, error: error.message };
    }
  }


  async logHistory(entityType, entityId, action, userId, comment, changes = null) {
    return BeryllExtendedHistory.create({
      entityType,
      entityId,
      action,
      userId,
      comment,
      changes
    });
  }

  async getHistory(entityType, entityId, options = {}) {
    const { limit = 50, offset = 0 } = options;

    return BeryllExtendedHistory.findAndCountAll({
      where: { entityType, entityId },
      include: [
        { model: User, as: "user", attributes: ["id", "login", "name", "surname"] }
      ],
      order: [["createdAt", "DESC"]],
      limit,
      offset
    });
  }


  async createServerManually(data, userId) {
    const {
      apkSerialNumber,
      serialNumber,
      macAddress,
      hostname,
      batchId,
      notes,
      searchDhcp = true
    } = data;

    if (!apkSerialNumber && !serialNumber) {
      throw new Error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä (apkSerialNumber –∏–ª–∏ serialNumber)");
    }


    if (apkSerialNumber) {
      const existing = await BeryllServer.findOne({
        where: { apkSerialNumber }
      });
      if (existing) {
        throw new Error(`–°–µ—Ä–≤–µ—Ä —Å —Å–µ—Ä–∏–π–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –ê–ü–ö ${apkSerialNumber} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      }
    }


    const serverData = {
      apkSerialNumber: apkSerialNumber || null,
      serialNumber: serialNumber || null,
      macAddress: macAddress || null,
      hostname: hostname || null,
      batchId: batchId || null,
      notes: notes || null,
      status: "NEW",
      leaseActive: false
    };


    if (macAddress && searchDhcp) {
      try {
        const dhcpResult = await this.findIpByMac(macAddress);
        if (dhcpResult.found) {
          serverData.ipAddress = dhcpResult.ipAddress;
          serverData.hostname = serverData.hostname || dhcpResult.hostname;
          serverData.leaseActive = dhcpResult.leaseActive;
          serverData.leaseStart = dhcpResult.leaseStart;
          serverData.leaseEnd = dhcpResult.leaseEnd;
        }
      } catch (err) {

        console.warn("[RackService] DHCP lookup failed:", err.message);
      }
    }


    const server = await BeryllServer.create(serverData);


    await this.logHistory("SERVER", server.id, "CREATED_MANUALLY", userId,
      `–°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é: ${apkSerialNumber || serialNumber}`,
      { apkSerialNumber, serialNumber, macAddress }
    );


    return BeryllServer.findByPk(server.id, {
      include: [
        { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] },
        { model: BeryllBatch, as: "batch" }
      ]
    });
  }


  async createAndPlaceServer(data, userId) {
    const { rackId, unitNumber, unitData, ...serverData } = data;


    const server = await this.createServerManually(serverData, userId);


    if (rackId && unitNumber) {
      await this.placeServerInRack(rackId, unitNumber, server.id, userId);


      if (unitData && Object.keys(unitData).length > 0) {
        const unit = await BeryllRackUnit.findOne({
          where: { rackId, unitNumber }
        });

        if (unit) {
          const updateData = {};

          if (unitData.hostname) updateData.hostname = unitData.hostname;
          if (unitData.mgmtMacAddress) updateData.mgmtMacAddress = unitData.mgmtMacAddress;
          if (unitData.mgmtIpAddress) updateData.mgmtIpAddress = unitData.mgmtIpAddress;
          if (unitData.dataMacAddress) updateData.dataMacAddress = unitData.dataMacAddress;
          if (unitData.dataIpAddress) updateData.dataIpAddress = unitData.dataIpAddress;
          if (unitData.accessLogin) updateData.accessLogin = unitData.accessLogin;
          if (unitData.accessPassword) updateData.accessPassword = unitData.accessPassword;
          if (unitData.notes) updateData.notes = unitData.notes;

          if (Object.keys(updateData).length > 0) {
            await unit.update(updateData);

            await this.logHistory("RACK", rackId, "UNIT_DATA_UPDATED", userId,
              `–î–∞–Ω–Ω—ã–µ —é–Ω–∏—Ç–∞ ${unitNumber} –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞`,
              { serverId: server.id, unitData: updateData }
            );
          }
        }
      }
    }

    return server;
  }
}

module.exports = new RackService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/ServerService.js
================================================================================

const { BeryllServer, BeryllBatch, BeryllHistory, BeryllServerChecklist, User } = require("../../../models/index");
const { SERVER_STATUSES, HISTORY_ACTIONS, BeryllChecklistTemplate, BeryllChecklistFile } = require("../../../models/definitions/Beryll");
const { Op } = require("sequelize");
const { calculateDuration } = require("../utils/helpers");
const HistoryService = require("./HistoryService");
const ChecklistService = require("./ChecklistService");

class ServerService {


  async getServers(filters = {}) {
    const { status, search, onlyActive, batchId, assignedToId } = filters;

    const where = {};

    if (status && Object.values(SERVER_STATUSES).includes(status)) {
      where.status = status;
    }

    if (onlyActive === "true") {
      where.leaseActive = true;
    }

    if (batchId) {
      where.batchId = batchId === "null" ? null : parseInt(batchId);
    }


    if (assignedToId) {
      where.assignedToId = parseInt(assignedToId);
    }

    if (search) {
      where[Op.or] = [
        { ipAddress: { [Op.iLike]: `%${search}%` } },
        { hostname: { [Op.iLike]: `%${search}%` } },
        { serialNumber: { [Op.iLike]: `%${search}%` } },
        { macAddress: { [Op.iLike]: `%${search}%` } }
      ];
    }

    const servers = await BeryllServer.findAll({
      where,
      include: [
        { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] },
        { model: BeryllBatch, as: "batch", attributes: ["id", "title", "status"] }
      ],
      order: [["updatedAt", "DESC"]]
    });

    return servers;
  }


  async getServerById(id) {
    const server = await BeryllServer.findByPk(id, {
      include: [
        { model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] },
        { model: BeryllBatch, as: "batch" },
        {
          model: BeryllServerChecklist,
          as: "checklists",
          include: [
            { model: BeryllChecklistTemplate, as: "template" },
            { model: User, as: "completedBy", attributes: ["id", "login", "name", "surname"] },
            {
              model: BeryllChecklistFile,
              as: "files",
              include: [
                { model: User, as: "uploadedBy", attributes: ["id", "login", "name", "surname"] }
              ]
            }
          ]
        },
        {
          model: BeryllHistory,
          as: "history",
          include: [{ model: User, as: "user", attributes: ["id", "login", "name", "surname"] }],
          order: [["createdAt", "DESC"]],
          limit: 50
        }
      ]
    });

    return server;
  }


  async takeServer(id, userId, userRole) {
    const server = await BeryllServer.findByPk(id);

    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }


    const allowedStatuses = [
      SERVER_STATUSES.NEW,
      SERVER_STATUSES.CLARIFYING,
      SERVER_STATUSES.DEFECT
    ];


    if (server.assignedToId && server.status === SERVER_STATUSES.IN_WORK) {

      if (server.assignedToId !== userId && userRole !== "SUPER_ADMIN") {
        throw new Error("–°–µ—Ä–≤–µ—Ä —É–∂–µ –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º");
      }
    }


    if (server.assignedToId && server.assignedToId !== userId) {
      if (userRole !== "SUPER_ADMIN") {
        throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω –¥—Ä—É–≥–æ–º—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é");
      }
    }


    if (!allowedStatuses.includes(server.status) && server.status !== SERVER_STATUSES.IN_WORK) {
      throw new Error(`–ù–µ–ª—å–∑—è –≤–∑—è—Ç—å —Å–µ—Ä–≤–µ—Ä –∏–∑ —Å—Ç–∞—Ç—É—Å–∞ "${server.status}"`);
    }

    const previousStatus = server.status;
    const previousAssignee = server.assignedToId;


    const isReturning = server.assignedToId === userId &&
      (server.status === SERVER_STATUSES.CLARIFYING || server.status === SERVER_STATUSES.DEFECT);
    const isTakingFromOther = server.assignedToId && server.assignedToId !== userId;

    await server.update({
      status: SERVER_STATUSES.IN_WORK,
      assignedToId: userId,

      assignedAt: isReturning ? server.assignedAt : new Date()
    });


    await ChecklistService.initializeServerChecklist(server.id);


    let comment = null;
    if (isReturning) {
      comment = `–í–æ–∑–≤—Ä–∞—â—ë–Ω –≤ —Ä–∞–±–æ—Ç—É –∏–∑ —Å—Ç–∞—Ç—É—Å–∞ "${previousStatus}"`;
    } else if (isTakingFromOther) {
      comment = `–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID:${previousAssignee}`;
    }


    await HistoryService.logHistory(server.id, userId, HISTORY_ACTIONS.TAKEN, {
      fromStatus: previousStatus,
      toStatus: SERVER_STATUSES.IN_WORK,
      comment
    });

    const updated = await BeryllServer.findByPk(id, {
      include: [{ model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] }]
    });

    return updated;
  }


  async releaseServer(id, userId, userRole) {
    const server = await BeryllServer.findByPk(id);

    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }


    if (server.assignedToId !== userId && userRole !== "SUPER_ADMIN") {
      throw new Error("–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞");
    }

    const duration = calculateDuration(server.assignedAt);
    const previousStatus = server.status;
    const previousAssignee = server.assignedToId;

    await server.update({
      status: SERVER_STATUSES.NEW,
      assignedToId: null,
      assignedAt: null
    });


    const comment = (userRole === "SUPER_ADMIN" && previousAssignee !== userId)
      ? "–°–µ—Ä–≤–µ—Ä —Å–Ω—è—Ç —Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
      : undefined;

    await HistoryService.logHistory(server.id, userId, HISTORY_ACTIONS.RELEASED, {
      fromStatus: previousStatus,
      toStatus: SERVER_STATUSES.NEW,
      durationMinutes: duration,
      comment
    });

    return server;
  }


  async updateStatus(id, status, notes, userId) {
    const server = await BeryllServer.findByPk(id);

    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    const previousStatus = server.status;
    const updateData = { status };

    if (status === SERVER_STATUSES.DONE) {
      updateData.completedAt = new Date();
    }

    if (notes !== undefined) {
      updateData.notes = notes;
    }

    await server.update(updateData);

    const duration = status === SERVER_STATUSES.DONE
      ? calculateDuration(server.assignedAt)
      : null;

    await HistoryService.logHistory(server.id, userId, HISTORY_ACTIONS.STATUS_CHANGED, {
      fromStatus: previousStatus,
      toStatus: status,
      comment: notes,
      durationMinutes: duration
    });

    const updated = await BeryllServer.findByPk(id, {
      include: [{ model: User, as: "assignedTo", attributes: ["id", "login", "name", "surname"] }]
    });

    return updated;
  }


  async updateNotes(id, notes, userId) {
    const server = await BeryllServer.findByPk(id);

    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }

    await server.update({ notes });

    await HistoryService.logHistory(server.id, userId, HISTORY_ACTIONS.NOTE_ADDED, {
      comment: notes
    });

    return server;
  }


  async deleteServer(id, userId) {
    const server = await BeryllServer.findByPk(id);

    if (!server) {
      throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }


    const serverIp = server.ipAddress;
    const serverHostname = server.hostname;


    await BeryllServerChecklist.destroy({ where: { serverId: id } });


    await BeryllHistory.update(
      { serverId: null },
      { where: { serverId: id } }
    );

    await server.destroy();


    await HistoryService.logHistory(null, userId, HISTORY_ACTIONS.DELETED, {
      serverIp,
      serverHostname,
      comment: `–£–¥–∞–ª—ë–Ω —Å–µ—Ä–≤–µ—Ä ${serverIp}`
    });

    return { success: true };
  }
}

module.exports = new ServerService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/StatsService.js
================================================================================

const { BeryllServer, BeryllBatch, BeryllHistory, User } = require("../../../models/index");
const { SERVER_STATUSES, BATCH_STATUSES, HISTORY_ACTIONS } = require("../../../models/definitions/Beryll");
const { Op, fn, col, literal } = require("sequelize");

class StatsService {


  async getStats() {
    const total = await BeryllServer.count();
    const active = await BeryllServer.count({ where: { leaseActive: true } });

    const byStatus = await BeryllServer.findAll({
      attributes: ["status", [fn("COUNT", col("id")), "count"]],
      group: ["status"],
      raw: true
    });

    const byStatusMap = {};
    Object.values(SERVER_STATUSES).forEach(s => byStatusMap[s] = 0);
    byStatus.forEach(s => {
      byStatusMap[s.status] = parseInt(s.count);
    });

    return { total, active, byStatus: byStatusMap };
  }


  async getAnalytics(filters = {}) {
    const { dateFrom, dateTo } = filters;

    const dateFilter = {};
    if (dateFrom) dateFilter[Op.gte] = new Date(dateFrom);
    if (dateTo) dateFilter[Op.lte] = new Date(dateTo);


    const totalServers = await BeryllServer.count();
    const activeServers = await BeryllServer.count({ where: { leaseActive: true } });

    const byStatus = await BeryllServer.findAll({
      attributes: ["status", [fn("COUNT", col("id")), "count"]],
      group: ["status"],
      raw: true
    });


    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    const dailyCompleted = await BeryllHistory.findAll({
      attributes: [
        [fn("DATE", col("createdAt")), "date"],
        [fn("COUNT", col("id")), "count"]
      ],
      where: {
        action: HISTORY_ACTIONS.STATUS_CHANGED,
        toStatus: SERVER_STATUSES.DONE,
        createdAt: { [Op.gte]: sevenDaysAgo }
      },
      group: [fn("DATE", col("createdAt"))],
      order: [[fn("DATE", col("createdAt")), "ASC"]],
      raw: true
    });


    const topPerformers = await BeryllHistory.findAll({
      attributes: [
        "userId",
        [fn("COUNT", col("BeryllHistory.id")), "completedCount"],
        [fn("AVG", col("durationMinutes")), "avgDuration"]
      ],
      where: {
        action: HISTORY_ACTIONS.STATUS_CHANGED,
        toStatus: SERVER_STATUSES.DONE,
        ...(Object.keys(dateFilter).length && { createdAt: dateFilter })
      },
      include: [{
        model: User,
        as: "user",
        attributes: ["id", "login", "name", "surname"]
      }],
      group: ["userId", "user.id"],
      order: [[fn("COUNT", col("BeryllHistory.id")), "DESC"]],
      limit: 10,
      raw: true,
      nest: true
    });


    const avgProcessingTime = await BeryllHistory.findOne({
      attributes: [[fn("AVG", col("durationMinutes")), "avgMinutes"]],
      where: {
        action: HISTORY_ACTIONS.STATUS_CHANGED,
        toStatus: SERVER_STATUSES.DONE,
        durationMinutes: { [Op.not]: null }
      },
      raw: true
    });


    const batchStats = await BeryllBatch.findAll({
      attributes: [
        "id",
        "title",
        "status",
        [literal(`(SELECT COUNT(*) FROM beryll_servers WHERE "batchId" = "BeryllBatch"."id")`), "serverCount"],
        [literal(`(SELECT COUNT(*) FROM beryll_servers WHERE "batchId" = "BeryllBatch"."id" AND status = 'DONE')`), "completedCount"]
      ],
      where: { status: BATCH_STATUSES.ACTIVE },
      raw: true
    });

    return {
      overview: {
        totalServers,
        activeServers,
        byStatus: byStatus.reduce((acc, s) => {
          acc[s.status] = parseInt(s.count);
          return acc;
        }, {})
      },
      dailyCompleted,
      topPerformers,
      avgProcessingTime: avgProcessingTime?.avgMinutes
        ? Math.round(avgProcessingTime.avgMinutes)
        : null,
      activeBatches: batchStats
    };
  }
}

module.exports = new StatsService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/services/UnifiedPassportsExportService.js
================================================================================

const ExcelJS = require("exceljs");
const { Op } = require("sequelize");
const {
  BeryllServer,
  BeryllServerComponent,
  BeryllBatch,
  BeryllServerChecklist,
  BeryllChecklistTemplate,
  User,
  UserAlias
} = require("../../../models/index");

const EXPORT_CONFIG = {
  HDD_COUNT: 12,
  SSD_BOOT_COUNT: 2,
  SSD_DATA_COUNT: 2,
  RAM_COUNT: 12,
  PSU_COUNT: 2,

  COMPONENT_TYPES: {
    HDD: "HDD",
    SSD: "SSD",
    NVME: "NVME",
    RAM: "RAM",
    PSU: "PSU",
    MOTHERBOARD: "MOTHERBOARD",
    BMC: "BMC",
    NIC: "NIC",
    RAID: "RAID",
    FAN: "FAN",
    CPU: "CPU",
    BACKPLANE_HDD: "BACKPLANE_HDD",
    BACKPLANE_SSD: "BACKPLANE_SSD"
  }
};


const COLUMN_STRUCTURE = {
  BASE: ["rowNumber", "apkSerialNumber", "inspectionDate", "employees1", "employees2"],
  HDD: "12x(hdd_yadro, hdd_manuf, hdd_revision)",
  BACKPLANE_HDD: ["backplaneHdd"],
  MOTHERBOARD: ["mb_yadro", "mb_manuf", "mb_revision"],
  COOLERS: ["coolers"],
  CPU: ["cpu_yadro", "cpu_manuf", "cpu_revision"],
  PSU: "2x(psu_yadro, psu_manuf, psu_revision)",
  SSD_BOOT: "2x(ssdBoot_yadro, ssdBoot_manuf, ssdBoot_revision)",
  SSD_DATA: "2x(ssdData_yadro, ssdData_manuf, ssdData_revision)",
  BMC: ["bmc_yadro", "bmc_manuf", "bmc_revision"],
  BACKPLANE_SSD: ["backplaneSsd"],
  RAM: "12x(ram_yadro, ram_manuf, ram_revision)",
  RAID: ["raid_yadro", "raid_manuf", "raid_revision"],
  NIC: ["nic_yadro", "nic_manuf", "nic_revision"]
};

class UnifiedPassportsExportService {


  async exportUnifiedPassports(options = {}) {
    const {
      serverIds,
      batchId,
      status,
      dateFrom,
      dateTo,
      search,
      includeArchived = false
    } = options;

    const servers = await this.getServersWithComponents({
      serverIds, batchId, status, dateFrom, dateTo, search, includeArchived
    });

    if (servers.length === 0) {
      throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞");
    }

    const exportData = await this.prepareExportData(servers);
    const buffer = await this.createExcelFile(exportData, options);

    return buffer;
  }


  async getServersWithComponents(filters) {
    const where = {};

    if (filters.serverIds && filters.serverIds.length > 0) {
      where.id = { [Op.in]: filters.serverIds };
    }

    if (filters.batchId) {
      if (filters.batchId === "null") {
        where.batchId = null;
      } else {
        where.batchId = filters.batchId;
      }
    }

    if (filters.status) {
      where.status = filters.status;
    }

    if (!filters.includeArchived) {
      where.archivedAt = null;
    }

    if (filters.dateFrom || filters.dateTo) {
      where.createdAt = {};
      if (filters.dateFrom) {
        where.createdAt[Op.gte] = new Date(filters.dateFrom);
      }
      if (filters.dateTo) {
        where.createdAt[Op.lte] = new Date(filters.dateTo);
      }
    }

    if (filters.search) {
      where[Op.or] = [
        { apkSerialNumber: { [Op.iLike]: `%${filters.search}%` } },
        { serialNumber: { [Op.iLike]: `%${filters.search}%` } },
        { hostname: { [Op.iLike]: `%${filters.search}%` } }
      ];
    }

    const servers = await BeryllServer.findAll({
      where,
      include: [
        {
          model: BeryllServerComponent,
          as: "components",
          required: false
        },
        {
          model: BeryllBatch,
          as: "batch",
          required: false
        },
        {
          model: User,
          as: "assignedTo",
          attributes: ["id", "name", "surname", "login"],
          required: false
        },
        {
          model: BeryllServerChecklist,
          as: "checklists",
          required: false,
          include: [
            {
              model: User,
              as: "completedBy",
              attributes: ["id", "name", "surname"],
              required: false
            }
          ]
        }
      ],
      order: [
        ["createdAt", "ASC"],
        [{ model: BeryllServerComponent, as: "components" }, "componentType", "ASC"],
        [{ model: BeryllServerComponent, as: "components" }, "slot", "ASC"]
      ]
    });

    return servers;
  }


  async prepareExportData(servers) {
    const rows = [];
    let rowNumber = 1;

    for (const server of servers) {
      const components = server.components || [];
      const grouped = this.groupComponentsByType(components);
      const employees = await this.getServerEmployees(server);


      const row = {
        rowNumber,
        apkSerialNumber: server.apkSerialNumber || server.serialNumber || "",
        inspectionDate: this.formatDate(server.createdAt),
        employees1: employees[0] || "",
        employees2: employees[1] || "",

        ...this.mapHddComponents(grouped.HDD || []),
        backplaneHdd: this.getBackplaneHdd(grouped),
        ...this.mapMotherboard(grouped.MOTHERBOARD || []),
        coolers: this.getCoolerType(grouped.FAN || []),
        ...this.mapCpuComponents(grouped.CPU || []),
        ...this.mapPsuComponents(grouped.PSU || []),
        ...this.mapSsdBootComponents(grouped.SSD || [], grouped.NVME || []),
        ...this.mapSsdDataComponents(grouped.SSD || [], grouped.NVME || []),
        ...this.mapBmcComponents(grouped.BMC || []),
        backplaneSsd: this.getBackplaneSsd(grouped),
        ...this.mapRamComponents(grouped.RAM || []),
        ...this.mapRaidController(grouped.RAID || []),
        ...this.mapNicCard(grouped.NIC || [])
      };

      rows.push({ row, server });
      rowNumber++;
    }

    return rows;
  }


  _getComponentRevision(comp) {
    if (!comp) return "";
    return comp.metadata?.revision || comp.firmwareVersion || "";
  }

  groupComponentsByType(components) {
    const grouped = {};

    for (const comp of components) {
      const type = comp.componentType || "OTHER";
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(comp);
    }

    for (const type in grouped) {
      grouped[type].sort((a, b) => {
        const slotA = this.extractSlotNumber(a.slot);
        const slotB = this.extractSlotNumber(b.slot);
        return slotA - slotB;
      });
    }

    return grouped;
  }

  extractSlotNumber(slot) {
    if (!slot) return 999;
    const match = slot.match(/(\d+)/);
    return match ? parseInt(match[1]) : 999;
  }

  async getServerEmployees(server) {
    const employees = [];

    if (server.checklists && server.checklists.length > 0) {
      for (const checklist of server.checklists) {
        if (checklist.completedBy) {
          const name = `${checklist.completedBy.surname || ""} ${checklist.completedBy.name || ""}`.trim();
          if (name && !employees.includes(name)) {
            employees.push(name);
          }
        }
      }
    }

    if (server.assignedTo) {
      const name = `${server.assignedTo.surname || ""} ${server.assignedTo.name || ""}`.trim();
      if (name && !employees.includes(name)) {
        employees.push(name);
      }
    }

    return employees.slice(0, 2);
  }


  mapHddComponents(hdds) {
    const result = {};
    for (let i = 0; i < EXPORT_CONFIG.HDD_COUNT; i++) {
      const hdd = hdds[i];
      result[`hdd${i + 1}_yadro`] = hdd?.serialNumberYadro || "";
      result[`hdd${i + 1}_manuf`] = hdd?.serialNumber || "";
      result[`hdd${i + 1}_revision`] = this._getComponentRevision(hdd);
    }
    return result;
  }

  getBackplaneHdd(grouped) {
    const backplane = grouped.BACKPLANE_HDD || grouped.BACKPLANE || [];
    if (backplane.length > 0) {
      return backplane[0].serialNumberYadro || backplane[0].serialNumber || backplane[0].model || "";
    }
    const motherboard = grouped.MOTHERBOARD?.[0];
    if (motherboard?.metadata?.backplaneHdd) {
      return motherboard.metadata.backplaneHdd;
    }
    return "";
  }


  mapMotherboard(motherboards) {
    const mb = motherboards[0];
    if (!mb) {
      return { mb_yadro: "", mb_manuf: "", mb_revision: "" };
    }
    return {
      mb_yadro: mb.serialNumberYadro || "",
      mb_manuf: mb.serialNumber || "",
      mb_revision: this._getComponentRevision(mb)
    };
  }

  getCoolerType(fans) {
    if (fans.length === 0) return "";
    const fan = fans[0];
    return fan.metadata?.type || fan.model || "–¢–∏–ø 1";
  }


  mapCpuComponents(cpus) {
    if (cpus.length === 0) {
      return { cpu_yadro: "", cpu_manuf: "", cpu_revision: "" };
    }
    const cpu = cpus[0];
    return {
      cpu_yadro: cpu.serialNumberYadro || "",
      cpu_manuf: cpu.serialNumber || "",
      cpu_revision: this._getComponentRevision(cpu)
    };
  }


  mapPsuComponents(psus) {
    const result = {};
    for (let i = 0; i < EXPORT_CONFIG.PSU_COUNT; i++) {
      const psu = psus[i];
      result[`psu${i + 1}_yadro`] = psu?.serialNumberYadro || "";
      result[`psu${i + 1}_manuf`] = psu?.serialNumber || "";
      result[`psu${i + 1}_revision`] = this._getComponentRevision(psu);
    }
    return result;
  }


  mapSsdBootComponents(ssds, nvmes) {
    const bootSsds = ssds.filter(s =>
      s.manufacturer?.toLowerCase()?.includes("intel") ||
      s.model?.toLowerCase()?.includes("intel") ||
      s.slot?.toLowerCase()?.includes("boot")
    ).slice(0, EXPORT_CONFIG.SSD_BOOT_COUNT);

    const finalBootSsds = bootSsds.length > 0 ? bootSsds : ssds.slice(0, EXPORT_CONFIG.SSD_BOOT_COUNT);

    const result = {};
    for (let i = 0; i < EXPORT_CONFIG.SSD_BOOT_COUNT; i++) {
      const ssd = finalBootSsds[i];
      result[`ssdBoot${i + 1}_yadro`] = ssd?.serialNumberYadro || "";
      result[`ssdBoot${i + 1}_manuf`] = ssd?.serialNumber || "";
      result[`ssdBoot${i + 1}_revision`] = this._getComponentRevision(ssd);
    }
    return result;
  }


  mapSsdDataComponents(ssds, nvmes) {
    const dataSsds = [
      ...nvmes,
      ...ssds.filter(s =>
        s.manufacturer?.toLowerCase()?.includes("samsung") ||
        s.model?.toLowerCase()?.includes("samsung") ||
        s.model?.toLowerCase()?.includes("mz-ql")
      )
    ].slice(0, EXPORT_CONFIG.SSD_DATA_COUNT);

    const result = {};
    for (let i = 0; i < EXPORT_CONFIG.SSD_DATA_COUNT; i++) {
      const ssd = dataSsds[i];
      result[`ssdData${i + 1}_yadro`] = ssd?.serialNumberYadro || "";
      result[`ssdData${i + 1}_manuf`] = ssd?.serialNumber || "";
      result[`ssdData${i + 1}_revision`] = this._getComponentRevision(ssd);
    }
    return result;
  }


  mapBmcComponents(bmcs) {
    const bmc = bmcs[0];
    if (!bmc) {
      return { bmc_yadro: "", bmc_manuf: "", bmc_revision: "" };
    }
    return {
      bmc_yadro: bmc.serialNumberYadro || "",
      bmc_manuf: bmc.serialNumber || "",
      bmc_revision: this._getComponentRevision(bmc)
    };
  }

  getBackplaneSsd(grouped) {
    const backplane = grouped.BACKPLANE_SSD || [];
    if (backplane.length > 0) {
      return backplane[0].serialNumberYadro || backplane[0].serialNumber || "";
    }
    return "";
  }


  mapRamComponents(rams) {
    const result = {};
    for (let i = 0; i < EXPORT_CONFIG.RAM_COUNT; i++) {
      const ram = rams[i];
      result[`ram${i + 1}_yadro`] = ram?.serialNumberYadro || "";
      result[`ram${i + 1}_manuf`] = ram?.serialNumber || "";
      result[`ram${i + 1}_revision`] = this._getComponentRevision(ram);
    }
    return result;
  }


  mapRaidController(raids) {
    const raid = raids[0];
    if (!raid) {
      return { raid_yadro: "", raid_manuf: "", raid_revision: "" };
    }
    return {
      raid_yadro: raid.serialNumberYadro || "",
      raid_manuf: raid.serialNumber || "",
      raid_revision: this._getComponentRevision(raid)
    };
  }


  mapNicCard(nics) {
    const nic = nics[0];
    if (!nic) {
      return { nic_yadro: "", nic_manuf: "", nic_revision: "" };
    }
    return {
      nic_yadro: nic.serialNumberYadro || "",
      nic_manuf: nic.serialNumber || "",
      nic_revision: this._getComponentRevision(nic)
    };
  }

  formatDate(date) {
    if (!date) return "";
    const d = new Date(date);
    const day = String(d.getDate()).padStart(2, "0");
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const year = String(d.getFullYear()).slice(-2);
    return `${day} ${month} ${year}`;
  }


  async createExcelFile(exportData, options = {}) {
    const workbook = new ExcelJS.Workbook();
    workbook.creator = "MES Kryptonit";
    workbook.created = new Date();

    const sheet = workbook.addWorksheet("–°–æ—Å—Ç–∞–≤ —Å–µ—Ä–≤–µ—Ä–æ–≤", {
      views: [{ state: "frozen", ySplit: 2, xSplit: 3 }]
    });

    const headerStyle = {
      font: { bold: true, size: 10 },
      alignment: { horizontal: "center", vertical: "middle", wrapText: true },
      fill: { type: "pattern", pattern: "solid", fgColor: { argb: "FFD9E1F2" } },
      border: {
        top: { style: "thin" },
        bottom: { style: "thin" },
        left: { style: "thin" },
        right: { style: "thin" }
      }
    };

    const subHeaderStyle = {
      font: { bold: false, size: 9 },
      alignment: { horizontal: "center", vertical: "middle", wrapText: true },
      fill: { type: "pattern", pattern: "solid", fgColor: { argb: "FFE0E0E0" } },
      border: {
        top: { style: "thin" },
        bottom: { style: "thin" },
        left: { style: "thin" },
        right: { style: "thin" }
      }
    };

    const dataStyle = {
      font: { size: 9 },
      alignment: { horizontal: "left", vertical: "middle" },
      border: {
        top: { style: "thin" },
        bottom: { style: "thin" },
        left: { style: "thin" },
        right: { style: "thin" }
      }
    };

    const columns = this.buildColumnDefinitions();
    sheet.columns = columns.map(col => ({
      header: "",
      key: col.key,
      width: col.width || 12
    }));


    this.addGroupHeaders(sheet, columns, headerStyle);


    this.addSubHeaders(sheet, columns, subHeaderStyle);


    let currentRow = 3;
    for (const rowData of exportData) {
      const rowValues = columns.map(col => rowData.row[col.key] || "");
      const excelRow = sheet.getRow(currentRow);
      excelRow.values = rowValues;
      excelRow.eachCell({ includeEmpty: true }, (cell, colNumber) => {
        Object.assign(cell, dataStyle);
      });
      currentRow++;
    }


    this.applyHeaderMerges(sheet, columns);

    sheet.getRow(1).height = 30;
    sheet.getRow(2).height = 25;

    const buffer = await workbook.xlsx.writeBuffer();
    return buffer;
  }


  buildColumnDefinitions() {
    const columns = [];


    columns.push(
      { key: "rowNumber", header: "‚Ññ", width: 5, group: "base" },
      { key: "apkSerialNumber", header: "–°–µ—Ä–∏–π–Ω—ã–π ‚Ññ —Å–µ—Ä–≤–µ—Ä–∞", width: 18, group: "base" },
      { key: "inspectionDate", header: "–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è", width: 22, group: "base" },
      { key: "employees1", header: "–§–∞–º–∏–ª–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—Ä–æ–≤–æ–¥–∏–≤—à–∏–µ –ø—Ä–æ–≤–µ—Ä–∫—É, —Å–±–æ—Ä–∫—É —Å–µ—Ä–≤–µ—Ä–∞", width: 20, group: "base" },
      { key: "employees2", header: "", width: 18, group: "base" }
    );


    for (let i = 1; i <= 12; i++) {
      columns.push(
        { key: `hdd${i}_yadro`, header: i === 1 ? "HDD –¥–∏—Å–∫–∏" : "", subHeader: "S/N —è–¥—Ä–æ", width: 15, group: "hdd" },
        { key: `hdd${i}_manuf`, header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 12, group: "hdd" },
        { key: `hdd${i}_revision`, header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 10, group: "hdd" }
      );
    }


    columns.push({ key: "backplaneHdd", header: "Backplane HDD", width: 16, group: "backplane_hdd" });


    columns.push(
      { key: "mb_yadro", header: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞", subHeader: "S/N —è–¥—Ä–æ", width: 20, group: "mb" },
      { key: "mb_manuf", header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 20, group: "mb" },
      { key: "mb_revision", header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 12, group: "mb" }
    );


    columns.push({ key: "coolers", header: "–ö—É–ª–µ—Ä—ã CPU", width: 10, group: "coolers" });


    columns.push(
      { key: "cpu_yadro", header: "CPU", subHeader: "S/N —è–¥—Ä–æ", width: 18, group: "cpu" },
      { key: "cpu_manuf", header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 18, group: "cpu" },
      { key: "cpu_revision", header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 12, group: "cpu" }
    );


    for (let i = 1; i <= 2; i++) {
      columns.push(
        { key: `psu${i}_yadro`, header: i === 1 ? "–ë–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è" : "", subHeader: "S/N —è–¥—Ä–æ", width: 18, group: "psu" },
        { key: `psu${i}_manuf`, header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 16, group: "psu" },
        { key: `psu${i}_revision`, header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 10, group: "psu" }
      );
    }


    for (let i = 1; i <= 2; i++) {
      columns.push(
        { key: `ssdBoot${i}_yadro`, header: i === 1 ? "SSD Boot" : "", subHeader: "S/N —è–¥—Ä–æ", width: 18, group: "ssd_boot" },
        { key: `ssdBoot${i}_manuf`, header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 16, group: "ssd_boot" },
        { key: `ssdBoot${i}_revision`, header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 10, group: "ssd_boot" }
      );
    }


    for (let i = 1; i <= 2; i++) {
      columns.push(
        { key: `ssdData${i}_yadro`, header: i === 1 ? "SSD NVMe" : "", subHeader: "S/N —è–¥—Ä–æ", width: 18, group: "ssd_data" },
        { key: `ssdData${i}_manuf`, header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 16, group: "ssd_data" },
        { key: `ssdData${i}_revision`, header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 10, group: "ssd_data" }
      );
    }


    columns.push(
      { key: "bmc_yadro", header: "BMC", subHeader: "S/N —è–¥—Ä–æ", width: 16, group: "bmc" },
      { key: "bmc_manuf", header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 16, group: "bmc" },
      { key: "bmc_revision", header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 12, group: "bmc" }
    );


    columns.push({ key: "backplaneSsd", header: "Backplane SSD (S/N, —Ä–∞–∑—ä–µ–º)", width: 20, group: "backplane_ssd" });


    for (let i = 1; i <= 12; i++) {
      columns.push(
        { key: `ram${i}_yadro`, header: i === 1 ? "–ü–ª–∞–Ω–∫–∏ –ø–∞–º—è—Ç–∏" : "", subHeader: "S/N —è–¥—Ä–æ", width: 16, group: "ram" },
        { key: `ram${i}_manuf`, header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 14, group: "ram" },
        { key: `ram${i}_revision`, header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 10, group: "ram" }
      );
    }


    columns.push(
      { key: "raid_yadro", header: "Raid-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (—Ä–µ–≤–∏–∑–∏—è –∏ sn)", subHeader: "S/N —è–¥—Ä–æ", width: 18, group: "raid" },
      { key: "raid_manuf", header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 16, group: "raid" },
      { key: "raid_revision", header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 12, group: "raid" }
    );


    columns.push(
      { key: "nic_yadro", header: "–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P (—Ä–µ–≤–∏–∑–∏—è –∏ sn)", subHeader: "S/N —è–¥—Ä–æ", width: 20, group: "nic" },
      { key: "nic_manuf", header: "", subHeader: "S/N –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å", width: 18, group: "nic" },
      { key: "nic_revision", header: "", subHeader: "–†–µ–≤–∏–∑–∏—è", width: 12, group: "nic" }
    );

    return columns;
  }


  addGroupHeaders(sheet, columns, style) {
    const headerRow = sheet.getRow(1);
    columns.forEach((col, idx) => {
      const cell = headerRow.getCell(idx + 1);
      cell.value = col.header || "";
      Object.assign(cell, style);
    });
    headerRow.height = 35;
  }

  addSubHeaders(sheet, columns, style) {
    const subHeaderRow = sheet.getRow(2);
    columns.forEach((col, idx) => {
      const cell = subHeaderRow.getCell(idx + 1);
      cell.value = col.subHeader || "";
      Object.assign(cell, style);
    });
    subHeaderRow.height = 25;
  }

  applyHeaderMerges(sheet, columns) {
    const multiColumnGroups = ["hdd", "psu", "ssd_boot", "ssd_data", "ram", "mb", "cpu", "bmc", "raid", "nic"];

    for (const groupName of multiColumnGroups) {
      const groupRanges = [];
      let rangeStart = null;

      columns.forEach((col, idx) => {
        if (col.group === groupName) {
          if (rangeStart === null) rangeStart = idx + 1;
        } else if (rangeStart !== null) {
          groupRanges.push({ start: rangeStart, end: idx });
          rangeStart = null;
        }
      });

      if (rangeStart !== null) {
        groupRanges.push({ start: rangeStart, end: columns.length });
      }

      for (const range of groupRanges) {
        if (range.end - range.start > 1) {
          try {
            const headerCol = columns.findIndex((c, i) =>
              i >= range.start - 1 && i < range.end && c.header && c.group === groupName
            );

            if (headerCol !== -1) {
              sheet.mergeCells(1, range.start, 1, range.end);
              const cell = sheet.getRow(1).getCell(range.start);
              cell.value = columns[headerCol].header;
              cell.alignment = { horizontal: "center", vertical: "middle", wrapText: true };
            }
          } catch (e) {

          }
        }
      }
    }
  }


  async getExportStats(options = {}) {
    const servers = await this.getServersWithComponents(options);

    const stats = {
      totalServers: servers.length,
      totalComponents: 0,
      byComponentType: {},
      byBatch: {},
      byStatus: {},
      missingComponents: []
    };

    for (const server of servers) {
      const components = server.components || [];
      stats.totalComponents += components.length;

      for (const comp of components) {
        const type = comp.componentType || "OTHER";
        stats.byComponentType[type] = (stats.byComponentType[type] || 0) + 1;
      }

      const batchName = server.batch?.name || "–ë–µ–∑ –ø–∞—Ä—Ç–∏–∏";
      stats.byBatch[batchName] = (stats.byBatch[batchName] || 0) + 1;

      const status = server.status || "UNKNOWN";
      stats.byStatus[status] = (stats.byStatus[status] || 0) + 1;

      const grouped = this.groupComponentsByType(components);
      const missing = [];

      if (!grouped.HDD || grouped.HDD.length < 12) {
        missing.push(`HDD (${grouped.HDD?.length || 0}/12)`);
      }
      if (!grouped.RAM || grouped.RAM.length < 12) {
        missing.push(`RAM (${grouped.RAM?.length || 0}/12)`);
      }
      if (!grouped.PSU || grouped.PSU.length < 2) {
        missing.push(`PSU (${grouped.PSU?.length || 0}/2)`);
      }
      if (!grouped.MOTHERBOARD || grouped.MOTHERBOARD.length === 0) {
        missing.push("–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞");
      }

      if (missing.length > 0) {
        stats.missingComponents.push({
          serverId: server.id,
          apkSerialNumber: server.apkSerialNumber,
          missing
        });
      }
    }

    return stats;
  }
}

module.exports = new UnifiedPassportsExportService();

================================================================================
FILE: QMS-Server-master/controllers/beryll/utils/dhcpParser.js
================================================================================



function parseDhcpLeases(content) {
  const leases = [];
  const leaseRegex = /lease\s+([\d.]+)\s*\{([^}]+)\}/g;

  let match;
  while ((match = leaseRegex.exec(content)) !== null) {
    const ip = match[1];
    const body = match[2];

    const lease = {
      ipAddress: ip,
      macAddress: null,
      hostname: null,
      serialNumber: null,
      leaseStart: null,
      leaseEnd: null,
      leaseActive: false
    };

    const macMatch = body.match(/hardware\s+ethernet\s+([\da-f:]+)/i);
    if (macMatch) {
      lease.macAddress = macMatch[1].toUpperCase();
    }

    const hostnameMatch = body.match(/client-hostname\s+"([^"]+)"/);
    if (hostnameMatch) {
      lease.hostname = hostnameMatch[1];
      const parts = lease.hostname.split("-");
      if (parts.length >= 2) {
        lease.serialNumber = parts[parts.length - 1];
      }
    }

    const startsMatch = body.match(/starts\s+\d+\s+([\d/:\s]+)/);
    if (startsMatch) {
      lease.leaseStart = parseLeaseDate(startsMatch[1]);
    }

    const endsMatch = body.match(/ends\s+\d+\s+([\d/:\s]+)/);
    if (endsMatch) {
      lease.leaseEnd = parseLeaseDate(endsMatch[1]);
    }

    const stateMatch = body.match(/binding\s+state\s+(\w+)/);
    if (stateMatch) {
      lease.leaseActive = stateMatch[1].toLowerCase() === "active";
    }

    leases.push(lease);
  }

  return leases;
}

function parseLeaseDate(dateStr) {
  try {
    const cleaned = dateStr.trim().replace(/;$/, "");
    const [datePart, timePart] = cleaned.split(" ");
    const [year, month, day] = datePart.split("/");
    return new Date(`${year}-${month}-${day}T${timePart}Z`);
  } catch (e) {
    return null;
  }
}

module.exports = {
  parseDhcpLeases,
  parseLeaseDate
};

================================================================================
FILE: QMS-Server-master/controllers/beryll/utils/helpers.js
================================================================================



function calculateDuration(startDate) {
  if (!startDate) return null;
  const start = new Date(startDate);
  const now = new Date();
  return Math.round((now - start) / (1000 * 60));
}

module.exports = {
  calculateDuration
};

================================================================================
FILE: QMS-Server-master/controllers/coralB_Controller.js
================================================================================

const { Session, CoralB } = require("../models/index");
const ApiError = require("../error/ApiError");
const { Op } = require("sequelize");

class CoralB_Controller {
  async getBoards(req, res, next) {
    let {
      serial,
      firmware,
      PCId,
      userId,
      SAW_filter,
      firmwareVersion,
      categoryDefectCoralBId,
      date,
      limit,
      page,
    } = req.query;
    page = page || 1;
    limit = limit || 100;
    let offset = page * limit - limit;

    try {
      let sessionIds = null;

      if (PCId || userId) {
        const sessionPCIds = PCId
          ? await Session.findAll({
              attributes: ["id"],
              where: { PCId },
              raw: true,
            })
          : [];


        const sessionUserIds = userId
          ? await Session.findAll({
              attributes: ["id"],
              where: { userId },
              raw: true,
            })
          : [];

        const pcIdList = new Set(sessionPCIds.map((s) => s.id));
        const userIdList = new Set(sessionUserIds.map((s) => s.id));

        if (PCId && userId) {
          sessionIds = [...pcIdList].filter((id) => userIdList.has(id));
        } else if (PCId) {
          sessionIds = [...pcIdList];
        } else if (userId) {
          sessionIds = [...userIdList];
        }

        if (PCId && userId && sessionIds.length === 0) {
          return res.json({ count: 0, rows: [] });
        }
      }

      let whereClause = {};

      if (sessionIds && sessionIds.length > 0) {
        whereClause.sessionId = sessionIds;
      }

      if (categoryDefectCoralBId) {
        whereClause.categoryDefectCoralBId = categoryDefectCoralBId;
      }

      if (firmware) {
        whereClause.firmware = firmware;
      }
      if (serial) {
        whereClause.serial = serial;
      }
      if (firmwareVersion) {
        whereClause.firmwareVersion = firmwareVersion;
      }
      if (SAW_filter) {
        whereClause.SAW_filter = SAW_filter;
      }

      const convertToISODate = (dateStr) => {

        const [day, month, year] = dateStr.split(".");
        return `${year}-${month}-${day}`;
      };

      if (date) {


        date = convertToISODate(date);

        whereClause.createdAt = {
          [Op.between]: [
            new Date(`${date}T00:00:00.000Z`),
            new Date(`${date}T23:59:59.999Z`),
          ],
        };
      }

      const boardsAll = await CoralB.findAndCountAll({
        where: whereClause,
        limit,
        offset,
        order: [["id", "ASC"]],
      });

      return res.json(boardsAll);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async postBoard(req, res, next) {
    try {
      const {
        serial,
        firmware,
        SAW_filter,
        firmwareVersion,
        sessionId,
        categoryDefectCoralBId,
      } = req.body;

      const board = await CoralB.create({
        serial,
        firmware,
        SAW_filter,
        firmwareVersion,
        sessionId,
        categoryDefectCoralBId,
      });
      return res.json(board);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async postManyDefectCoralB(req, res, next) {
    try {
      const { count, SAW_filter, sessionId, categoryDefectCoralBId } = req.body;
      const serial = null;
      const firmware = false;
      const firmwareVersion = null;


      const records = Array.from({ length: count }, () => ({
        serial,
        firmware,
        SAW_filter,
        firmwareVersion,
        sessionId,
        categoryDefectCoralBId,
      }));

      await CoralB.bulkCreate(records);

      return res.json("–¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–ø–∏—Å–∏");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteManyDefectCoralB(req, res, next) {
    try {
      const { count, SAW_filter, categoryDefectCoralBId } = req.body;

      const recordsToDelete = await CoralB.findAll({
        attributes: ["id"],
        where: {
          SAW_filter: SAW_filter,
          categoryDefectCoralBId: categoryDefectCoralBId,
        },
        order: [["createdAt", "DESC"]],
        limit: count,
      });

      const idsToDelete = recordsToDelete.map((record) => record.id);

      await CoralB.destroy({
        where: {
          id: {
            [Op.in]: idsToDelete,
          },
        },
      });

      return res.json("–∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updateBoard(req, res, next) {
    try {
      const {
        id,
        firmware,
        SAW_filter,
        firmwareVersion,
        sessionId,
        categoryDefectCoralBId,
      } = req.body;
      await CoralB.update(
        {
          firmware,
          sessionId,
          SAW_filter,
          firmwareVersion,
          categoryDefectCoralBId,
        },
        { where: { id } }
      );
      const boardUpdated = await CoralB.findAll({ where: { id } });
      return res.json(boardUpdated[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteBoardByDBid(req, res, next) {
    try {
      const id = req.params.id;
      await CoralB.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new CoralB_Controller();

================================================================================
FILE: QMS-Server-master/controllers/defect2_4Controller.js
================================================================================

const { CategoryDefect2_4 } = require("../models/index");
const ApiError = require("../error/ApiError");

class DefectController2_4 {
  async getDefects(req, res, next) {
    try {
      const defectAll = await CategoryDefect2_4.findAll({
        order: [["id", "ASC"]],
      });
      return res.json(defectAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async postDefect(req, res, next) {
    try {
      const { title, description } = req.body;
      const defect = await CategoryDefect2_4.create({ title, description });
      return res.json(defect);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updateDefect(req, res, next) {
    try {
      const { id, title, description } = req.body;
      await CategoryDefect2_4.update({ title, description }, { where: { id } });
      const defectUpdated = await CategoryDefect2_4.findAll({ where: { id } });
      return res.json(defectUpdated[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteDefect(req, res, next) {
    try {
      const id = req.params.id;
      await CategoryDefect2_4.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new DefectController2_4();

================================================================================
FILE: QMS-Server-master/controllers/defect915Controller.js
================================================================================

const { CategoryDefect915 } = require("../models/index");
const ApiError = require("../error/ApiError");

class DefectController915 {
  async getDefects(req, res, next) {
    try {
      const defectAll = await CategoryDefect915.findAll({
        order: [["id", "ASC"]],
      });
      return res.json(defectAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async postDefect(req, res, next) {
    try {
      const { title, description } = req.body;
      const defect = await CategoryDefect915.create({ title, description });
      return res.json(defect);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updateDefect(req, res, next) {
    try {
      const { id, title, description } = req.body;
      await CategoryDefect915.update({ title, description }, { where: { id } });
      const defectUpdated = await CategoryDefect915.findAll({ where: { id } });
      return res.json(defectUpdated[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteDefect(req, res, next) {
    try {
      const id = req.params.id;
      await CategoryDefect915.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new DefectController915();

================================================================================
FILE: QMS-Server-master/controllers/defectController.js
================================================================================

const { CategoryDefect } = require("../models/index");
const ApiError = require("../error/ApiError");

class DefectController {
  async getDefects(req, res, next) {
    try {
      const defectAll = await CategoryDefect.findAll({
        order: [ ["id", "ASC"]],
      });
      return res.json(defectAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async postDefect(req, res, next) {
    try {
      const { title, description } = req.body;
      const defect = await CategoryDefect.create({ title, description });
      return res.json(defect);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updateDefect(req, res, next) {
    try {
      const { id, title, description } = req.body;
      await CategoryDefect.update({ title, description }, { where: { id } });
      const defectUpdated = await CategoryDefect.findAll({ where: { id } });
      return res.json(defectUpdated[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteDefect(req, res, next) {
    try {
      const id = req.params.id;
      await CategoryDefect.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new DefectController();

================================================================================
FILE: QMS-Server-master/controllers/defectSystemController.js
================================================================================

const {
  DefectCategory,
  BoardDefect,
  RepairAction,
  User,
  FC,
  ELRS915,
  ELRS2_4,
  CoralB
} = require("../models/index");
const ApiError = require("../error/ApiError");
const { Op } = require("sequelize");
const sequelize = require("../db");

class DefectSystemController {


  async getCategories(req, res, next) {
    try {
      const { boardType, activeOnly } = req.query;

      const where = {};
      if (activeOnly === "true") {
        where.isActive = true;
      }

      let categories = await DefectCategory.findAll({
        where,
        order: [["title", "ASC"]]
      });


      if (boardType) {
        categories = categories.filter(cat =>
          cat.applicableTypes && cat.applicableTypes.includes(boardType)
        );
      }

      return res.json(categories);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async createCategory(req, res, next) {
    try {
      const { code, title, description, severity, applicableTypes } = req.body;

      if (!code || !title) {
        return next(ApiError.badRequest("–ö–æ–¥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã"));
      }

      const existing = await DefectCategory.findOne({ where: { code } });
      if (existing) {
        return next(ApiError.badRequest("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"));
      }

      const category = await DefectCategory.create({
        code,
        title,
        description,
        severity: severity || "MAJOR",
        applicableTypes: applicableTypes || []
      });

      return res.json(category);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async updateCategory(req, res, next) {
    try {
      const { id } = req.params;
      const { code, title, description, severity, applicableTypes, isActive } = req.body;

      const category = await DefectCategory.findByPk(id);
      if (!category) {
        return next(ApiError.notFound("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      await category.update({
        code: code ?? category.code,
        title: title ?? category.title,
        description: description ?? category.description,
        severity: severity ?? category.severity,
        applicableTypes: applicableTypes ?? category.applicableTypes,
        isActive: isActive ?? category.isActive
      });

      return res.json(category);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async deleteCategory(req, res, next) {
    try {
      const { id } = req.params;

      const category = await DefectCategory.findByPk(id);
      if (!category) {
        return next(ApiError.notFound("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }


      const defectsCount = await BoardDefect.count({ where: { categoryId: id } });
      if (defectsCount > 0) {

        await category.update({ isActive: false });
        return res.json({ message: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ (–µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏)" });
      }

      await category.destroy();
      return res.json({ message: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞" });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async getDefects(req, res, next) {
    try {
      let {
        page = 1,
        limit = 50,
        status,
        boardType,
        categoryId,
        search,
        startDate,
        endDate
      } = req.query;

      page = Number(page) || 1;
      limit = Number(limit) || 50;
      const offset = (page - 1) * limit;

      const where = {};


      if (status) {
        if (status === "ACTIVE") {

          where.status = { [Op.in]: ["OPEN", "IN_REPAIR", "REPAIRED"] };
        } else {
          where.status = status;
        }
      }


      if (boardType) {
        where.boardType = boardType;
      }


      if (categoryId) {
        where.categoryId = Number(categoryId);
      }


      if (search) {
        where.serialNumber = { [Op.iLike]: `%${search}%` };
      }


      if (startDate || endDate) {
        where.detectedAt = {};
        if (startDate) {
          where.detectedAt[Op.gte] = new Date(startDate);
        }
        if (endDate) {
          where.detectedAt[Op.lte] = new Date(endDate + "T23:59:59.999Z");
        }
      }

      const { rows, count } = await BoardDefect.findAndCountAll({
        where,
        limit,
        offset,
        order: [
          ["status", "ASC"],
          ["detectedAt", "DESC"]
        ],
        include: [
          {
            model: DefectCategory,
            as: "category",
            attributes: ["id", "code", "title", "severity"]
          },
          {
            model: User,
            as: "detectedBy",
            attributes: ["id", "name", "surname"]
          },
          {
            model: User,
            as: "closedBy",
            attributes: ["id", "name", "surname"]
          }
        ]
      });


      const stats = await BoardDefect.findAll({
        attributes: [
          "status",
          [sequelize.fn("COUNT", sequelize.col("id")), "count"]
        ],
        group: ["status"],
        raw: true
      });

      const statsByStatus = {};
      stats.forEach(s => {
        statsByStatus[s.status] = Number(s.count);
      });

      return res.json({
        defects: rows,
        total: count,
        page,
        totalPages: Math.ceil(count / limit),
        stats: statsByStatus
      });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async getDefectById(req, res, next) {
    try {
      const { id } = req.params;

      const defect = await BoardDefect.findByPk(id, {
        include: [
          {
            model: DefectCategory,
            as: "category"
          },
          {
            model: User,
            as: "detectedBy",
            attributes: ["id", "name", "surname"]
          },
          {
            model: User,
            as: "closedBy",
            attributes: ["id", "name", "surname"]
          },
          {
            model: RepairAction,
            as: "repairs",
            include: [
              {
                model: User,
                as: "performedBy",
                attributes: ["id", "name", "surname"]
              }
            ],
            order: [["performedAt", "ASC"]]
          }
        ]
      });

      if (!defect) {
        return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }


      let boardInfo = null;
      try {
        boardInfo = await this._getBoardInfo(defect.boardType, defect.boardId);
      } catch (e) {
        console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ:", e.message);
      }

      return res.json({
        defect,
        boardInfo
      });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async createDefect(req, res, next) {
    try {
      const {
        boardType,
        boardId,
        serialNumber,
        categoryId,
        description
      } = req.body;


      if (!boardType) {
        return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –ø–ª–∞—Ç—ã"));
      }
      if (!categoryId) {
        return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–µ—Ñ–µ–∫—Ç–∞"));
      }


      const category = await DefectCategory.findByPk(categoryId);
      if (!category) {
        return next(ApiError.notFound("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }


      const defect = await BoardDefect.create({
        boardType,
        boardId: boardId || null,
        serialNumber: serialNumber || null,
        categoryId,
        description: description || null,
        detectedById: req.user.id,
        detectedAt: new Date(),
        status: "OPEN"
      });


      const result = await BoardDefect.findByPk(defect.id, {
        include: [
          { model: DefectCategory, as: "category" },
          { model: User, as: "detectedBy", attributes: ["id", "name", "surname"] }
        ]
      });

      return res.json(result);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async updateDefectStatus(req, res, next) {
    try {
      const { id } = req.params;
      const { status, finalResult } = req.body;

      const defect = await BoardDefect.findByPk(id);
      if (!defect) {
        return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const updateData = { status };


      const closedStatuses = ["VERIFIED", "SCRAPPED", "RETURNED", "CLOSED"];
      if (closedStatuses.includes(status)) {
        updateData.closedById = req.user.id;
        updateData.closedAt = new Date();
        if (finalResult) {
          updateData.finalResult = finalResult;
        }
      }

      await defect.update(updateData);

      return res.json(defect);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async addRepairAction(req, res, next) {
    const t = await sequelize.transaction();

    try {
      const { defectId } = req.params;
      const { actionType, description, timeSpentMinutes, result } = req.body;


      if (!actionType) {
        await t.rollback();
        return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è"));
      }
      if (!description) {
        await t.rollback();
        return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ"));
      }


      const defect = await BoardDefect.findByPk(defectId, { transaction: t });
      if (!defect) {
        await t.rollback();
        return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }


      const action = await RepairAction.create({
        boardDefectId: defectId,
        actionType,
        performedById: req.user.id,
        performedAt: new Date(),
        description,
        timeSpentMinutes: timeSpentMinutes || null,
        result: result || "PENDING"
      }, { transaction: t });


      const newTotalMinutes = (defect.totalRepairMinutes || 0) + (timeSpentMinutes || 0);
      const updateData = { totalRepairMinutes: newTotalMinutes };


      if (defect.status === "OPEN") {
        updateData.status = "IN_REPAIR";
      }

      await defect.update(updateData, { transaction: t });

      await t.commit();


      const resultAction = await RepairAction.findByPk(action.id, {
        include: [
          { model: User, as: "performedBy", attributes: ["id", "name", "surname"] }
        ]
      });

      return res.json(resultAction);
    } catch (e) {
      await t.rollback();
      next(ApiError.badRequest(e.message));
    }
  }


  async getRepairHistory(req, res, next) {
    try {
      const { defectId } = req.params;

      const actions = await RepairAction.findAll({
        where: { boardDefectId: defectId },
        include: [
          { model: User, as: "performedBy", attributes: ["id", "name", "surname"] }
        ],
        order: [["performedAt", "ASC"]]
      });

      return res.json(actions);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async markAsRepaired(req, res, next) {
    const t = await sequelize.transaction();

    try {
      const { id } = req.params;
      const { repairNote, timeSpentMinutes } = req.body;

      const defect = await BoardDefect.findByPk(id, { transaction: t });
      if (!defect) {
        await t.rollback();
        return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }


      if (repairNote) {
        await RepairAction.create({
          boardDefectId: id,
          actionType: "OTHER",
          performedById: req.user.id,
          performedAt: new Date(),
          description: repairNote,
          timeSpentMinutes: timeSpentMinutes || null,
          result: "SUCCESS"
        }, { transaction: t });
      }


      await defect.update({
        status: "REPAIRED",
        totalRepairMinutes: (defect.totalRepairMinutes || 0) + (timeSpentMinutes || 0)
      }, { transaction: t });

      await t.commit();

      return res.json({ message: "–î–µ—Ñ–µ–∫—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π", defect });
    } catch (e) {
      await t.rollback();
      next(ApiError.badRequest(e.message));
    }
  }


  async markAsScrapped(req, res, next) {
    try {
      const { id } = req.params;
      const { reason } = req.body;

      const defect = await BoardDefect.findByPk(id);
      if (!defect) {
        return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }


      if (reason) {
        await RepairAction.create({
          boardDefectId: id,
          actionType: "OTHER",
          performedById: req.user.id,
          performedAt: new Date(),
          description: `–°–ø–∏—Å–∞–Ω–æ: ${reason}`,
          result: "FAILED"
        });
      }

      await defect.update({
        status: "SCRAPPED",
        closedById: req.user.id,
        closedAt: new Date(),
        finalResult: "SCRAPPED"
      });

      return res.json({ message: "–î–µ—Ñ–µ–∫—Ç —Å–ø–∏—Å–∞–Ω", defect });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async verifyRepair(req, res, next) {
    try {
      const { id } = req.params;

      const defect = await BoardDefect.findByPk(id);
      if (!defect) {
        return next(ApiError.notFound("–î–µ—Ñ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      if (defect.status !== "REPAIRED") {
        return next(ApiError.badRequest("–ú–æ–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã"));
      }

      await defect.update({
        status: "VERIFIED",
        closedById: req.user.id,
        closedAt: new Date(),
        finalResult: "FIXED"
      });

      return res.json({ message: "–†–µ–º–æ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω", defect });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async getStatistics(req, res, next) {
    try {
      const { startDate, endDate, boardType } = req.query;

      const where = {};
      if (boardType) where.boardType = boardType;
      if (startDate || endDate) {
        where.detectedAt = {};
        if (startDate) where.detectedAt[Op.gte] = new Date(startDate);
        if (endDate) where.detectedAt[Op.lte] = new Date(endDate + "T23:59:59.999Z");
      }


      const byStatus = await BoardDefect.findAll({
        attributes: [
          "status",
          [sequelize.fn("COUNT", sequelize.col("id")), "count"]
        ],
        where,
        group: ["status"],
        raw: true
      });


      const byCategory = await BoardDefect.findAll({
        attributes: [
          "categoryId",
          [sequelize.fn("COUNT", sequelize.col("board_defect.id")), "count"]
        ],
        where,
        include: [
          { model: DefectCategory, as: "category", attributes: ["title"] }
        ],
        group: ["categoryId", "category.id"],
        raw: true
      });


      const byBoardType = await BoardDefect.findAll({
        attributes: [
          "boardType",
          [sequelize.fn("COUNT", sequelize.col("id")), "count"]
        ],
        where,
        group: ["boardType"],
        raw: true
      });


      const avgRepairTime = await BoardDefect.findOne({
        attributes: [
          [sequelize.fn("AVG", sequelize.col("totalRepairMinutes")), "avgMinutes"]
        ],
        where: {
          ...where,
          status: { [Op.in]: ["VERIFIED", "REPAIRED"] },
          totalRepairMinutes: { [Op.gt]: 0 }
        },
        raw: true
      });

      return res.json({
        byStatus,
        byCategory,
        byBoardType,
        avgRepairTime: avgRepairTime?.avgMinutes
          ? Math.round(avgRepairTime.avgMinutes)
          : null
      });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async _getBoardInfo(boardType, boardId) {
    if (!boardId) return null;

    switch (boardType) {
      case "FC":
        return await FC.findByPk(boardId);
      case "ELRS_915":
        return await ELRS915.findByPk(boardId);
      case "ELRS_2_4":
        return await ELRS2_4.findByPk(boardId);
      case "CORAL_B":
        return await CoralB.findByPk(boardId);
      default:
        return null;
    }
  }
}

module.exports = new DefectSystemController();

================================================================================
FILE: QMS-Server-master/controllers/defect_CoralB_Controller.js
================================================================================

const { CategoryDefect_CoralB } = require("../models/index");
const ApiError = require("../error/ApiError");

class DefectController_CoralB {
  async getDefects(req, res, next) {
    try {
      const defectAll = await CategoryDefect_CoralB.findAll({
        order: [["id", "ASC"]],
      });
      return res.json(defectAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async postDefect(req, res, next) {
    try {
      const { title, description } = req.body;
      const defect = await CategoryDefect_CoralB.create({ title, description });
      return res.json(defect);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updateDefect(req, res, next) {
    try {
      const { id, title, description } = req.body;
      await CategoryDefect_CoralB.update(
        { title, description },
        { where: { id } }
      );
      const defectUpdated = await CategoryDefect_CoralB.findAll({
        where: { id },
      });
      return res.json(defectUpdated[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteDefect(req, res, next) {
    try {
      const id = req.params.id;
      await CategoryDefect_CoralB.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new DefectController_CoralB();

================================================================================
FILE: QMS-Server-master/controllers/fcController.js
================================================================================

const { FC, Session } = require("../models/index");
const ApiError = require("../error/ApiError");
const { Op } = require("sequelize");

class FCController {
  async getFCs(req, res, next) {
    let {
      unique_device_id,
      firmware,
      PCId,
      userId,
      categoryDefectId,
      stand_test,
      startDate,
      endDate,
      limit,
      page,
    } = req.query;
    page = page || 1;
    limit = limit || 100;
    let offset = page * limit - limit;

    try {
      let sessionIds = null;

      if (PCId || userId) {
        const sessionPCIds = PCId
          ? await Session.findAll({
            attributes: ["id"],
            where: { PCId },
            raw: true,
          })
          : [];

        const sessionUserIds = userId
          ? await Session.findAll({
            attributes: ["id"],
            where: { userId },
            raw: true,
          })
          : [];

        const pcIdList = new Set(sessionPCIds.map((s) => s.id));
        const userIdList = new Set(sessionUserIds.map((s) => s.id));

        if (PCId && userId) {
          sessionIds = [...pcIdList].filter((id) => userIdList.has(id));
        } else if (PCId) {
          sessionIds = [...pcIdList];
        } else if (userId) {
          sessionIds = [...userIdList];
        }

        if (PCId && userId && sessionIds.length === 0) {
          return res.json({ count: 0, rows: [] });
        }
      }

      let whereClause = {};

      if (sessionIds && sessionIds.length > 0) {
        whereClause.sessionId = sessionIds;
      }

      if (categoryDefectId) {
        whereClause.categoryDefectId = categoryDefectId;
      }

      if (firmware) {
        whereClause.firmware = firmware;
      }

      if (stand_test) {
        whereClause.stand_test = stand_test;
      }

      if (unique_device_id) {
        whereClause.unique_device_id = unique_device_id;
      }

      const convertToISODate = (dateStr) => {
        const [day, month, year] = dateStr.split(".");
        return `${year}-${month}-${day}`;
      };

      if (startDate || endDate) {

        let start = startDate ? convertToISODate(startDate) : null;
        let end = endDate ? convertToISODate(endDate) : null;

        const dateCondition = {};


        if (start && end) {
          dateCondition[Op.between] = [
            new Date(`${start}T00:00:00.000Z`),
            new Date(`${end}T23:59:59.999Z`)
          ];
        } else if (start) {
          dateCondition[Op.gte] = new Date(`${start}T00:00:00.000Z`);
        } else if (end) {
          dateCondition[Op.lte] = new Date(`${end}T23:59:59.999Z`);
        }

        whereClause.createdAt = dateCondition;
      }

      const fcAll = await FC.findAndCountAll({
        where: whereClause,
        limit,
        offset,
        order: [["id", "ASC"]],
      });

      return res.json(fcAll);
    } catch (error) {
      next(ApiError.badRequest(error.message));
    }
  }

  async postFC(req, res, next) {
    try {
      const { unique_device_id, firmware, sessionId, categoryDefectId } =
        req.body;

      const fc = await FC.create({
        unique_device_id,
        firmware,
        sessionId,
        categoryDefectId,
      });
      return res.json(fc);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async postManyDefectFC(req, res, next) {
    try {
      const { count, sessionId, categoryDefectId } = req.body;
      const unique_device_id = null;
      const firmware = false;

      const records = Array.from({ length: count }, () => ({
        unique_device_id,
        firmware,
        sessionId,
        categoryDefectId,
      }));

      await FC.bulkCreate(records);

      return res.json("–¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–ø–∏—Å–∏");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteManyDefectFC(req, res, next) {
    try {
      const { count, categoryDefectId } = req.body;

      const recordsToDelete = await FC.findAll({
        attributes: ["id"],
        where: { categoryDefectId },
        order: [["createdAt", "DESC"]],
        limit: count,
      });

      const idsToDelete = recordsToDelete.map((record) => record.id);

      await FC.destroy({
        where: {
          id: {
            [Op.in]: idsToDelete,
          },
        },
      });

      return res.json("–∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updateFC(req, res, next) {
    try {
      const { id, firmware, sessionId, categoryDefectId } = req.body;
      await FC.update(
        { firmware, sessionId, categoryDefectId },
        { where: { id } }
      );
      const fcUpdated = await FC.findAll({ where: { id } });
      return res.json(fcUpdated[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updateStandTestFC(req, res, next) {
    try {
      const { unique_device_id, sessionId, stand_test } = req.body;

      let standTestBool;
      stand_test === "true" ? (standTestBool = true) : (standTestBool = false);
      stand_test === true ? (standTestBool = true) : (standTestBool = false);

      const existingFC = await FC.findOne({
        where: { unique_device_id },
      });

      if (existingFC) {
        let newCategoryDefectId, newFirmware;
        standTestBool ? (newCategoryDefectId = 1) : (newCategoryDefectId = 2);
        if (standTestBool) newFirmware = true;
        console.log(newCategoryDefectId);
        await FC.update(
          {
            stand_test: standTestBool,
            firmware: newFirmware,
            categoryDefectId: newCategoryDefectId,
          },
          {
            where: { unique_device_id },
          }
        );

        const updatedFC = await FC.findOne({ where: { unique_device_id } });
        return res.json(updatedFC);
      } else {
        const categoryDefectId = standTestBool ? 1 : 2;
        const firmware = standTestBool ? true : false;
        const newFC = await FC.create({
          unique_device_id,
          firmware,
          sessionId,
          categoryDefectId,
          stand_test: standTestBool,
        });
        return res.json(newFC);
      }
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteFCByUniqueID(req, res, next) {
    try {
      const uniqueID = req.params.uniqueID;
      await FC.destroy({
        where: { unique_device_id: uniqueID },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteFCByDBid(req, res, next) {
    try {
      const id = req.params.id;
      await FC.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new FCController();

================================================================================
FILE: QMS-Server-master/controllers/pcController.js
================================================================================

const { PC } = require("../models/index");
const ApiError = require("../error/ApiError");

class PCController {

  async getPCs(req, res, next) {
    try {

      const pcAll = await PC.findAll();


      if (!pcAll) {
        return res.json([]);
      }


      pcAll.sort((a, b) => {
        const nameA = (a.pc_name || "").toString();
        const nameB = (b.pc_name || "").toString();


        const numA = parseInt(nameA.replace(/\D/g, ""), 10);
        const numB = parseInt(nameB.replace(/\D/g, ""), 10);

        const hasNumA = !isNaN(numA);
        const hasNumB = !isNaN(numB);


        if (hasNumA && hasNumB) {
          if (numA !== numB) return numA - numB;
        }


        if (hasNumA && !hasNumB) return -1;
        if (!hasNumA && hasNumB) return 1;


        return nameA.localeCompare(nameB);
      });

      return res.json(pcAll);
    } catch (e) {
      console.error("üî• –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ü–ö:", e);
      next(ApiError.internal("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ü–ö: " + e.message));
    }
  }

  async postPC(req, res, next) {
    try {
      const { ip, pc_name, cabinet } = req.body;
      const pc = await PC.create({ ip, pc_name, cabinet });
      return res.json(pc);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updatePC(req, res, next) {
    try {
      const { id, ip, pc_name, cabinet } = req.body;
      await PC.update({ ip, pc_name, cabinet }, { where: { id } });
      const pc = await PC.findAll({ where: { id } });
      return res.json(pc[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deletePC(req, res, next) {
    try {
      const id = req.params.id;
      await PC.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new PCController();

================================================================================
FILE: QMS-Server-master/controllers/productionOutputController.js
================================================================================



const { Op } = require("sequelize");
const sequelize = require("../db");
const ApiError = require("../error/ApiError");

const {
    ProductionOutput,
    OperationType,
    OUTPUT_STATUSES
} = require("../models/ProductionOutput");

const {
    User, Team, Section, Project, ProductionTask
} = require("../models/index");


function _isAdmin(user) {
    return user?.role === 'SUPER_ADMIN' || user?.role === 'Admin';
}

function _isManager(user) {
    return user?.role === 'Manager' || user?.role === 'SectionManager';
}

function _isTeamLead(user) {
    return user?.role === 'TeamLead' || user?.role === 'Brigadir';
}

async function _getUserWithTeam(userId) {
    return await User.findByPk(userId, {
        include: [{
            model: Team,
            include: [{ model: Section, foreignKey: "sectionId" }]
        }]
    });
}

async function _getUserSection(user) {
    if (!user?.id) return null;

    const fullUser = await User.findByPk(user.id, {
        include: [{
            model: Team,
            include: [{ model: Section, foreignKey: "sectionId" }]
        }]
    });

    return fullUser?.Team?.Section || null;
}

async function _canSubmitFor(currentUser, targetUser) {
    if (_isAdmin(currentUser)) return true;
    if (currentUser?.id === targetUser?.id) return true;
    if (_isTeamLead(currentUser) && currentUser?.teamId === targetUser?.teamId) return true;

    if (_isManager(currentUser)) {
        const currentSection = await _getUserSection(currentUser);
        const targetSection = await _getUserSection(targetUser);
        if (currentSection && targetSection && currentSection.id === targetSection.id) {
            return true;
        }
    }

    return false;
}

async function _shouldAutoApprove(currentUser, targetUser) {
    if (_isAdmin(currentUser)) return true;
    if (_isManager(currentUser)) return true;
    if (_isTeamLead(currentUser) && currentUser?.teamId === targetUser?.teamId) return true;
    return false;
}

async function _canApproveFor(currentUser, output) {
    if (_isAdmin(currentUser)) return true;

    if (_isManager(currentUser)) {
        const currentSection = await _getUserSection(currentUser);
        if (currentSection && output.sectionId === currentSection.id) {
            return true;
        }
    }

    if (_isTeamLead(currentUser) && output.teamId === currentUser?.teamId) {
        return true;
    }

    return false;
}

async function _canEditOutput(currentUser, output) {
    if (_isAdmin(currentUser)) return true;
    if (output.createdById === currentUser?.id) return true;
    if (output.userId === currentUser?.id) return true;
    if (_isTeamLead(currentUser) && output.teamId === currentUser?.teamId) return true;
    return false;
}


class ProductionOutputController {


    async getOperationTypes(req, res, next) {
        try {
            const { includeInactive, sectionId } = req.query;

            const where = {};
            if (!includeInactive) {
                where.isActive = true;
            }
            if (sectionId) {
                where[Op.or] = [
                    { sectionId: Number(sectionId) },
                    { sectionId: null }
                ];
            }

            const types = await OperationType.findAll({
                where,
                order: [["sortOrder", "ASC"], ["name", "ASC"]]
            });

            return res.json(types);
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async createOperationType(req, res, next) {
        try {
            const { name, code, description, unit, normMinutes, sectionId, sortOrder } = req.body;

            if (!name) {
                return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏"));
            }

            if (code) {
                const existing = await OperationType.findOne({ where: { code } });
                if (existing) {
                    return next(ApiError.badRequest(`–ö–æ–¥ "${code}" —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è`));
                }
            }

            const opType = await OperationType.create({
                name,
                code: code || null,
                description: description || null,
                unit: unit || '—à—Ç',
                normMinutes: normMinutes || null,
                sectionId: sectionId || null,
                sortOrder: sortOrder || 0
            });

            return res.json(opType);
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async updateOperationType(req, res, next) {
        try {
            const { id } = req.params;
            const { name, code, description, unit, normMinutes, sectionId, isActive, sortOrder } = req.body;

            const opType = await OperationType.findByPk(id);
            if (!opType) {
                return next(ApiError.notFound("–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"));
            }

            if (code && code !== opType.code) {
                const existing = await OperationType.findOne({ where: { code } });
                if (existing) {
                    return next(ApiError.badRequest(`–ö–æ–¥ "${code}" —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è`));
                }
            }

            await opType.update({
                name: name !== undefined ? name : opType.name,
                code: code !== undefined ? code : opType.code,
                description: description !== undefined ? description : opType.description,
                unit: unit !== undefined ? unit : opType.unit,
                normMinutes: normMinutes !== undefined ? normMinutes : opType.normMinutes,
                sectionId: sectionId !== undefined ? sectionId : opType.sectionId,
                isActive: isActive !== undefined ? isActive : opType.isActive,
                sortOrder: sortOrder !== undefined ? sortOrder : opType.sortOrder
            });

            return res.json(opType);
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async deleteOperationType(req, res, next) {
        try {
            const { id } = req.params;

            const usageCount = await ProductionOutput.count({
                where: { operationTypeId: id }
            });

            if (usageCount > 0) {
                await OperationType.update(
                    { isActive: false },
                    { where: { id } }
                );
                return res.json({
                    message: "–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (–µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏)",
                    deactivated: true
                });
            }

            await OperationType.destroy({ where: { id } });
            return res.json({ message: "–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª—ë–Ω", deleted: true });

        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }


    async getOutputs(req, res, next) {
        try {
            let {
                page = 1, limit = 50,
                userId, teamId, sectionId, projectId, taskId,
                operationTypeId, status,
                dateFrom, dateTo
            } = req.query;

            page = Number(page) || 1;
            limit = Math.min(Number(limit) || 50, 200);
            const offset = (page - 1) * limit;

            const where = {};

            if (userId) where.userId = Number(userId);
            if (teamId) where.teamId = Number(teamId);
            if (sectionId) where.sectionId = Number(sectionId);
            if (projectId) where.projectId = Number(projectId);
            if (taskId) where.taskId = Number(taskId);
            if (operationTypeId) where.operationTypeId = Number(operationTypeId);
            if (status) where.status = status;

            if (dateFrom || dateTo) {
                where.date = {};
                if (dateFrom) where.date[Op.gte] = dateFrom;
                if (dateTo) where.date[Op.lte] = dateTo;
            }

            const { rows, count } = await ProductionOutput.findAndCountAll({
                where,
                limit,
                offset,
                order: [["date", "DESC"], ["createdAt", "DESC"]],
                include: [
                    { model: User, as: "user", attributes: ["id", "name", "surname", "img"] },
                    { model: User, as: "approvedBy", attributes: ["id", "name", "surname"], required: false },
                    { model: User, as: "createdBy", attributes: ["id", "name", "surname"], required: false },
                    { model: OperationType, as: "operationType", attributes: ["id", "name", "code", "unit"], required: false },
                    { model: Team, as: "production_team", attributes: ["id", "title"], required: false },
                    { model: Section, as: "production_section", attributes: ["id", "title"], required: false },
                    { model: Project, as: "project", attributes: ["id", "title"], required: false },
                    { model: ProductionTask, as: "task", attributes: ["id", "title"], required: false }
                ]
            });

            return res.json({
                rows,
                count,
                page,
                limit,
                totalPages: Math.ceil(count / limit)
            });
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async getOutputById(req, res, next) {
        try {
            const { id } = req.params;

            const output = await ProductionOutput.findByPk(id, {
                include: [
                    { model: User, as: "user", attributes: ["id", "name", "surname", "img"] },
                    { model: User, as: "approvedBy", attributes: ["id", "name", "surname"], required: false },
                    { model: User, as: "createdBy", attributes: ["id", "name", "surname"], required: false },
                    { model: OperationType, as: "operationType", required: false },
                    { model: Team, as: "production_team", attributes: ["id", "title"], required: false },
                    { model: Section, as: "production_section", attributes: ["id", "title"], required: false },
                    { model: Project, as: "project", attributes: ["id", "title"], required: false },
                    { model: ProductionTask, as: "task", attributes: ["id", "title"], required: false }
                ]
            });

            if (!output) {
                return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }

            return res.json(output);
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async createOutput(req, res, next) {
        try {
            const {
                date, userId,
                projectId, taskId, operationTypeId,
                claimedQty, comment
            } = req.body;

            const currentUser = req.user;

            if (!date) return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É"));
            if (!userId) return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"));
            if (!claimedQty || claimedQty <= 0) {
                return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ > 0"));
            }


            const targetUser = await User.findByPk(userId, {
                include: [{
                    model: Team,
                    include: [{ model: Section, foreignKey: "sectionId" }]
                }]
            });

            if (!targetUser) {
                return next(ApiError.notFound("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"));
            }

            const canSubmit = await _canSubmitFor(currentUser, targetUser);
            if (!canSubmit) {
                return next(ApiError.forbidden("–ù–µ—Ç –ø—Ä–∞–≤ –≤–Ω–æ—Å–∏—Ç—å –≤—ã—Ä–∞–±–æ—Ç–∫—É –∑–∞ —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"));
            }


            const teamId = targetUser.teamId || null;
            const sectionId = targetUser.Team?.Section?.id || null;

            const shouldAutoApprove = await _shouldAutoApprove(currentUser, targetUser);
            const status = shouldAutoApprove ? OUTPUT_STATUSES.APPROVED : OUTPUT_STATUSES.PENDING;

            const output = await ProductionOutput.create({
                date,
                userId,
                teamId,
                sectionId,
                projectId: projectId || null,
                taskId: taskId || null,
                operationTypeId: operationTypeId || null,
                claimedQty,
                approvedQty: shouldAutoApprove ? claimedQty : 0,
                status,
                approvedById: shouldAutoApprove ? currentUser?.id : null,
                approvedAt: shouldAutoApprove ? new Date() : null,
                createdById: currentUser?.id,
                comment: comment || null
            });

            const result = await ProductionOutput.findByPk(output.id, {
                include: [
                    { model: User, as: "user", attributes: ["id", "name", "surname"] },
                    { model: OperationType, as: "operationType", attributes: ["id", "name", "code"], required: false },
                    { model: Project, as: "project", attributes: ["id", "title"], required: false },
                    { model: ProductionTask, as: "task", attributes: ["id", "title"], required: false }
                ]
            });

            return res.status(201).json(result);
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async updateOutput(req, res, next) {
        try {
            const { id } = req.params;
            const currentUser = req.user;
            const {
                date, projectId, taskId, operationTypeId,
                claimedQty, comment
            } = req.body;

            const output = await ProductionOutput.findByPk(id, {
                include: [{ model: User, as: "user" }]
            });

            if (!output) {
                return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }

            const canEdit = await _canEditOutput(currentUser, output);
            if (!canEdit) {
                return next(ApiError.forbidden("–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"));
            }

            if (output.status === OUTPUT_STATUSES.APPROVED && !_isAdmin(currentUser)) {
                return next(ApiError.forbidden("–ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—É—é –∑–∞–ø–∏—Å—å"));
            }

            await output.update({
                date: date !== undefined ? date : output.date,
                projectId: projectId !== undefined ? projectId : output.projectId,
                taskId: taskId !== undefined ? taskId : output.taskId,
                operationTypeId: operationTypeId !== undefined ? operationTypeId : output.operationTypeId,
                claimedQty: claimedQty !== undefined ? claimedQty : output.claimedQty,
                comment: comment !== undefined ? comment : output.comment
            });

            return res.json(output);
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async deleteOutput(req, res, next) {
        try {
            const { id } = req.params;
            const currentUser = req.user;

            const output = await ProductionOutput.findByPk(id);
            if (!output) {
                return next(ApiError.notFound("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }

            const canEdit = await _canEditOutput(currentUser, output);
            if (!canEdit) {
                return next(ApiError.forbidden("–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ"));
            }

            if (output.status === OUTPUT_STATUSES.APPROVED && !_isAdmin(currentUser)) {
                return next(ApiError.forbidden("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—É—é –∑–∞–ø–∏—Å—å"));
            }

            await output.destroy();
            return res.json({ message: "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" });
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }


    async getPendingOutputs(req, res, next) {
        try {
            const currentUser = req.user;
            let { teamId, sectionId, dateFrom, dateTo } = req.query;

            const where = { status: OUTPUT_STATUSES.PENDING };

            if (_isAdmin(currentUser)) {
                if (teamId) where.teamId = Number(teamId);
                if (sectionId) where.sectionId = Number(sectionId);
            } else if (_isManager(currentUser)) {
                const userSection = await _getUserSection(currentUser);
                where.sectionId = userSection?.id || -1;
            } else if (_isTeamLead(currentUser)) {
                where.teamId = currentUser?.teamId || -1;
            } else {
                where.userId = currentUser?.id;
            }

            if (dateFrom) where.date = { ...where.date, [Op.gte]: dateFrom };
            if (dateTo) where.date = { ...where.date, [Op.lte]: dateTo };

            const outputs = await ProductionOutput.findAll({
                where,
                order: [["date", "DESC"], ["createdAt", "DESC"]],
                include: [
                    { model: User, as: "user", attributes: ["id", "name", "surname", "img"] },
                    { model: OperationType, as: "operationType", attributes: ["id", "name", "code", "unit"], required: false },
                    { model: Team, as: "production_team", attributes: ["id", "title"], required: false },
                    { model: Project, as: "project", attributes: ["id", "title"], required: false },
                    { model: ProductionTask, as: "task", attributes: ["id", "title"], required: false }
                ]
            });

            return res.json(outputs);
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async approveOutputs(req, res, next) {
        const t = await sequelize.transaction();
        try {
            const currentUser = req.user;
            const { ids, adjustments } = req.body;

            if (!ids || !Array.isArray(ids) || ids.length === 0) {
                await t.rollback();
                return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ ID –∑–∞–ø–∏—Å–µ–π"));
            }

            const outputs = await ProductionOutput.findAll({
                where: { id: ids, status: OUTPUT_STATUSES.PENDING },
                include: [{ model: User, as: "user" }],
                transaction: t
            });

            if (outputs.length === 0) {
                await t.rollback();
                return next(ApiError.notFound("–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã"));
            }

            const results = [];

            for (const output of outputs) {
                const canApprove = await _canApproveFor(currentUser, output);
                if (!canApprove) {
                    results.push({ id: output.id, error: "–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ" });
                    continue;
                }

                let approvedQty = output.claimedQty;
                let newStatus = OUTPUT_STATUSES.APPROVED;

                if (adjustments && adjustments[output.id] !== undefined) {
                    approvedQty = Number(adjustments[output.id]);
                    if (approvedQty !== output.claimedQty) {
                        newStatus = OUTPUT_STATUSES.ADJUSTED;
                    }
                }

                await output.update({
                    approvedQty,
                    status: newStatus,
                    approvedById: currentUser?.id,
                    approvedAt: new Date()
                }, { transaction: t });

                results.push({ id: output.id, status: newStatus, approvedQty });
            }

            await t.commit();
            return res.json({ results });
        } catch (e) {
            await t.rollback();
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async rejectOutputs(req, res, next) {
        const t = await sequelize.transaction();
        try {
            const currentUser = req.user;
            const { ids, reason } = req.body;

            if (!ids || !Array.isArray(ids) || ids.length === 0) {
                await t.rollback();
                return next(ApiError.badRequest("–£–∫–∞–∂–∏—Ç–µ ID –∑–∞–ø–∏—Å–µ–π"));
            }

            const outputs = await ProductionOutput.findAll({
                where: { id: ids, status: OUTPUT_STATUSES.PENDING },
                include: [{ model: User, as: "user" }],
                transaction: t
            });

            const results = [];

            for (const output of outputs) {
                const canApprove = await _canApproveFor(currentUser, output);
                if (!canApprove) {
                    results.push({ id: output.id, error: "–ù–µ—Ç –ø—Ä–∞–≤" });
                    continue;
                }

                await output.update({
                    status: OUTPUT_STATUSES.REJECTED,
                    rejectedQty: output.claimedQty,
                    approvedById: currentUser?.id,
                    approvedAt: new Date(),
                    rejectReason: reason || null
                }, { transaction: t });

                results.push({ id: output.id, status: OUTPUT_STATUSES.REJECTED });
            }

            await t.commit();
            return res.json({ results });
        } catch (e) {
            await t.rollback();
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }


    async getUserSummary(req, res, next) {
        try {
            const { userId } = req.params;
            let { dateFrom, dateTo } = req.query;

            if (!dateFrom) {
                const now = new Date();
                dateFrom = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            }
            if (!dateTo) {
                dateTo = new Date().toISOString().split('T')[0];
            }

            const where = {
                userId: Number(userId),
                date: { [Op.between]: [dateFrom, dateTo] }
            };

            const stats = await ProductionOutput.findAll({
                where,
                attributes: [
                    'status',
                    [sequelize.fn('SUM', sequelize.col('claimedQty')), 'totalClaimed'],
                    [sequelize.fn('SUM', sequelize.col('approvedQty')), 'totalApproved'],
                    [sequelize.fn('COUNT', sequelize.col('id')), 'recordCount']
                ],
                group: ['status'],
                raw: true
            });

            const byDay = await ProductionOutput.findAll({
                where: { ...where, status: { [Op.in]: [OUTPUT_STATUSES.APPROVED, OUTPUT_STATUSES.ADJUSTED] } },
                attributes: [
                    'date',
                    [sequelize.fn('SUM', sequelize.col('approvedQty')), 'total']
                ],
                group: ['date'],
                order: [['date', 'ASC']],
                raw: true
            });

            return res.json({
                userId: Number(userId),
                period: { dateFrom, dateTo },
                stats,
                byDay
            });
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async getMatrix(req, res, next) {
        try {
            let {
                teamId, sectionId, projectId, operationTypeId,
                dateFrom, dateTo
            } = req.query;

            if (!dateFrom || !dateTo) {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const monday = new Date(now);
                monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);

                dateFrom = monday.toISOString().split('T')[0];
                dateTo = sunday.toISOString().split('T')[0];
            }

            const where = {
                date: { [Op.between]: [dateFrom, dateTo] },
                status: { [Op.in]: [OUTPUT_STATUSES.APPROVED, OUTPUT_STATUSES.ADJUSTED] }
            };

            if (teamId) where.teamId = Number(teamId);
            if (sectionId) where.sectionId = Number(sectionId);
            if (projectId) where.projectId = Number(projectId);
            if (operationTypeId) where.operationTypeId = Number(operationTypeId);

            const outputs = await ProductionOutput.findAll({
                where,
                attributes: ['userId', 'date', 'approvedQty'],
                include: [
                    { model: User, as: "user", attributes: ["id", "name", "surname"] }
                ],
                raw: true,
                nest: true
            });

            const usersMap = new Map();
            const dates = new Set();

            for (const row of outputs) {
                const uid = row.userId;
                const dateStr = row.date;
                const qty = Number(row.approvedQty) || 0;

                dates.add(dateStr);

                if (!usersMap.has(uid)) {
                    usersMap.set(uid, {
                        userId: uid,
                        name: row.user?.name || '',
                        surname: row.user?.surname || '',
                        days: {},
                        total: 0
                    });
                }

                const u = usersMap.get(uid);
                u.days[dateStr] = (u.days[dateStr] || 0) + qty;
                u.total += qty;
            }

            const sortedDates = [...dates].sort();
            const matrix = [...usersMap.values()].sort((a, b) => b.total - a.total);

            return res.json({
                period: { dateFrom, dateTo },
                dates: sortedDates,
                matrix
            });
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }

    async getMyTeamMembers(req, res, next) {
        try {
            const currentUser = req.user;

            let users = [];

            if (_isAdmin(currentUser)) {

                users = await User.findAll({
                    attributes: ["id", "name", "surname", "img", "teamId"],
                    include: [{ model: Team, attributes: ["id", "title"] }],
                    order: [["surname", "ASC"], ["name", "ASC"]]
                });
            } else if (_isManager(currentUser)) {

                const section = await _getUserSection(currentUser);
                if (section) {
                    const teams = await Team.findAll({
                        where: { sectionId: section.id },
                        attributes: ["id"]
                    });
                    const teamIds = teams.map(t => t.id);

                    if (teamIds.length > 0) {
                        users = await User.findAll({
                            where: { teamId: { [Op.in]: teamIds } },
                            attributes: ["id", "name", "surname", "img", "teamId"],
                            include: [{ model: Team, attributes: ["id", "title"] }],
                            order: [["surname", "ASC"]]
                        });
                    }
                }
            } else if (_isTeamLead(currentUser)) {

                if (currentUser?.teamId) {
                    users = await User.findAll({
                        where: { teamId: currentUser.teamId },
                        attributes: ["id", "name", "surname", "img", "teamId"],
                        order: [["surname", "ASC"]]
                    });
                }
            } else {

                if (currentUser?.id) {
                    users = await User.findAll({
                        where: { id: currentUser.id },
                        attributes: ["id", "name", "surname", "img", "teamId"]
                    });
                }
            }


            if (currentUser?.id) {
                const selfIndex = users.findIndex(u => u.id === currentUser.id);
                if (selfIndex > 0) {
                    const [self] = users.splice(selfIndex, 1);
                    users.unshift(self);
                }
            }

            return res.json(users);
        } catch (e) {
            console.error(e);
            next(ApiError.internal(e.message));
        }
    }
}

module.exports = new ProductionOutputController();

================================================================================
FILE: QMS-Server-master/controllers/rbacController.js
================================================================================

const { Role, Ability, RoleAbility } = require("../models/index");
const ApiError = require("../error/ApiError");

class RbacController {

    async getRoles(req, res, next) {
        try {
            const roles = await Role.findAll({
                include: [{
                    model: Ability,
                    as: "abilities",
                    through: { attributes: [] }
                }],
                order: [['id', 'ASC']]
            });
            return res.json(roles);
        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }


    async getAbilities(req, res, next) {
        try {
            const abilities = await Ability.findAll({
                order: [['code', 'ASC']]
            });
            return res.json(abilities);
        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }


    async updateRoleAbilities(req, res, next) {
        try {
            const { roleId } = req.params;
            const { abilityIds } = req.body;

            const role = await Role.findByPk(roleId);
            if (!role) {
                return next(ApiError.badRequest("–†–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
            }


            await role.setAbilities(abilityIds);

            return res.json({ message: "–ü—Ä–∞–≤–∞ —Ä–æ–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã" });
        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }
}

module.exports = new RbacController();

================================================================================
FILE: QMS-Server-master/controllers/sessionController.js
================================================================================

const { Session, PC } = require("../models/index");
const ApiError = require("../error/ApiError");
const { logAudit } = require("../utils/auditLogger");

class SessionController {
  async getSessions(req, res, next) {
    try {
      const sessionAll = await Session.findAll();
      return res.json(sessionAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async postSession(req, res, next) {
    try {
      const { online, userId, PCId } = req.body;

      const newSession = await Session.create({
        online,
        userId,
        PCId: PCId || null,
      });

      await logAudit({
        req,
        userId,
        action: "SESSION_CREATE",
        entity: "SESSION",
        entityId: newSession.id,
        description: `–°–æ–∑–¥–∞–Ω–∞ —Å–µ—Å—Å–∏—è –≤—Ä—É—á–Ω—É—é (userId=${userId}, PCId=${PCId || 'PERSONAL'}, online=${online})`,
        metadata: { userId, PCId, online },
      });

      return res.json(newSession);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async setOnlineSession(req, res, next) {
    try {

      const { online, PCId, userId: bodyUserId } = req.body;

      const currentUserId = (req.user && req.user.id) || bodyUserId;

      if (typeof online === "undefined" || !currentUserId) {
        return next(
          ApiError.badRequest(
            "–ù–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: online, userId"
          )
        );
      }


      if (online === true) {
        await Session.update(
            { online: false },
            {
                where: {
                    userId: currentUserId,
                    online: true
                }
            }
        );
      }


      let session;

      if (PCId) {

          session = await Session.findOne({
            where: { userId: currentUserId, PCId },
          });
      } else {

          session = await Session.findOne({
            where: { userId: currentUserId, PCId: null },
          });
      }

      if (session) {
        await session.update({ online });
      } else {
        session = await Session.create({
          online,
          userId: currentUserId,
          PCId: PCId || null,
        });
      }


      let pcName = "–õ–∏—á–Ω—ã–π –Ω–æ—É—Ç–±—É–∫";
      let pcIp = "Dynamic";

      if (PCId) {
        try {
          const pc = await PC.findByPk(PCId);
          if (pc) {
            pcName = pc.pc_name;
            pcIp = pc.ip;
          }
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –ü–ö –¥–ª—è –∞—É–¥–∏—Ç–∞:", err);
        }
      }

      const action = online ? "LOGIN" : "LOGOUT";
      const humanPc = pcName;
      const descr = online
        ? `–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${humanPc}${pcIp !== "Dynamic" ? ` (${pcIp})` : ""}`
        : `–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${humanPc}`;

      await logAudit({
        req,
        userId: currentUserId,
        action,
        entity: "SESSION",
        entityId: session.id,
        description: descr,
        metadata: {
          PCId: PCId || "PERSONAL",
          pcName,
          pcIp,
          online,
          userId: currentUserId,
        },
      });

      return res.json(session);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteSession(req, res, next) {
    try {
      const id = req.params.id;
      const session = await Session.findByPk(id);

      await Session.destroy({ where: { id } });

      await logAudit({
        req,
        userId: session ? session.userId : undefined,
        action: "SESSION_DELETE",
        entity: "SESSION",
        entityId: id,
        description: "–°–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º",
        metadata: session
          ? { userId: session.userId, PCId: session.PCId }
          : { sessionId: id },
      });

      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async setOfflineSession(req, res, next) {
    try {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();


      if (
        (hours === 23 && minutes >= 59) ||
        hours === 0 ||
        (hours === 1 && minutes <= 1)
      ) {
        const [updated] = await Session.update(
          { online: false },
          { where: { online: true } }
        );

        await logAudit({
          req,
          action: "SESSION_AUTO_OFF",
          entity: "SESSION",
          description: `–ù–æ—á–Ω–æ–π —Å–±—Ä–æ—Å —Å–µ—Å—Å–∏–π. –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ offline: ${updated}`,
          metadata: { updatedCount: updated },
        });

        return res.json("–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —Å–±—Ä–æ—à–µ–Ω—ã");
      } else {
        return res.json("–°–µ–π—á–∞—Å –Ω–µ –≤—Ä–µ–º—è –¥–ª—è —Å–±—Ä–æ—Å–∞");
      }
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async offlineSessionManual(req, res, next) {
    try {
      const [updated] = await Session.update(
        { online: false },
        { where: { online: true } }
      );

      await logAudit({
        req,
        action: "SESSION_FORCE_OFF",
        entity: "SESSION",
        description: `–†—É—á–Ω–æ–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π. –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ offline: ${updated}`,
        metadata: { updatedCount: updated },
      });

      return res.json("–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —Å–±—Ä–æ—à–µ–Ω—ã");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new SessionController();

================================================================================
FILE: QMS-Server-master/controllers/structureController.js
================================================================================

const { Section, Team, User } = require("../models/index");
const ApiError = require("../error/ApiError");
const { logAudit } = require("../utils/auditLogger");
const { Op } = require("sequelize");

class StructureController {

  async getFullStructure(req, res, next) {
    try {
      const structure = await Section.findAll({
        include: [
          {
            model: User,
            as: "manager",
            attributes: ["id", "name", "surname", "img"],
          },
          {
            model: Team,
            as: "teams",
            include: [
              {
                model: User,
                as: "teamLead",
                attributes: ["id", "name", "surname", "img"],
              },
              {
                model: User,
                attributes: ["id", "name", "surname", "img"],
              },

              {
                model: Section,
                as: "section",
                attributes: ["id", "title"],
              },
            ],
          },
        ],
        order: [["id", "ASC"]],
      });
      return res.json(structure);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async getUnassignedUsers(req, res, next) {
    try {
      const users = await User.findAll({
        where: {
          teamId: { [Op.is]: null },
          role: { [Op.notIn]: ["SUPER_ADMIN"] }
        },
        attributes: ["id", "name", "surname", "login", "role", "img"],
        order: [["surname", "ASC"]]
      });
      return res.json(users);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async createSection(req, res, next) {
    try {
      const { title } = req.body;
      const section = await Section.create({ title });

      await logAudit({
        req,
        action: "SECTION_CREATE",
        entity: "Section",
        entityId: section.id,
        description: `–°–æ–∑–¥–∞–Ω —É—á–∞—Å—Ç–æ–∫ "${title}"`,
      });

      return res.json(section);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async createTeam(req, res, next) {
    try {
      const { title, sectionId } = req.body;

      const team = await Team.create({ title, sectionId });

      await logAudit({
        req,
        action: "TEAM_CREATE",
        entity: "Team",
        entityId: team.id,
        description: `–°–æ–∑–¥–∞–Ω–∞ –±—Ä–∏–≥–∞–¥–∞ "${title}" –≤ —É—á–∞—Å—Ç–∫–µ ${sectionId}`,
      });

      return res.json(team);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async assignSectionManager(req, res, next) {
    try {
      const { sectionId, userId } = req.body;

      const section = await Section.findByPk(sectionId);
      if (!section) {
        return next(ApiError.notFound("–£—á–∞—Å—Ç–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await section.update({ managerId: userId });

      await logAudit({
        req,
        action: "SECTION_MANAGER_ASSIGN",
        entity: "Section",
        entityId: sectionId,
        description: `–ù–∞–∑–Ω–∞—á–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä ${userId} –Ω–∞ —É—á–∞—Å—Ç–æ–∫ ${sectionId}`,
      });

      return res.json(section);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async assignTeamLead(req, res, next) {
    try {
      const { teamId, userId } = req.body;

      const team = await Team.findByPk(teamId);
      if (!team) {
        return next(ApiError.notFound("–ë—Ä–∏–≥–∞–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      await team.update({ teamLeadId: userId });

      await logAudit({
        req,
        action: "TEAM_LEAD_ASSIGN",
        entity: "Team",
        entityId: teamId,
        description: `–ù–∞–∑–Ω–∞—á–µ–Ω –±—Ä–∏–≥–∞–¥–∏—Ä ${userId} –Ω–∞ –±—Ä–∏–≥–∞–¥—É ${teamId}`,
      });

      return res.json(team);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async addMemberToTeam(req, res, next) {
    try {
      const { teamId, userId } = req.body;

      const user = await User.findByPk(userId);
      if (!user) {
        return next(ApiError.notFound("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      await user.update({ teamId });

      await logAudit({
        req,
        action: "USER_TEAM_ASSIGN",
        entity: "User",
        entityId: userId,
        description: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±—Ä–∏–≥–∞–¥—É ${teamId}`,
      });

      return res.json(user);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async removeMemberFromTeam(req, res, next) {
    try {
      const { userId } = req.body;

      const user = await User.findByPk(userId);
      if (!user) {
        return next(ApiError.notFound("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
      }

      const previousTeamId = user.teamId;
      await user.update({ teamId: null });

      await logAudit({
        req,
        action: "USER_TEAM_REMOVE",
        entity: "User",
        entityId: userId,
        description: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É–¥–∞–ª—ë–Ω –∏–∑ –±—Ä–∏–≥–∞–¥—ã ${previousTeamId}`,
      });

      return res.json(user);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new StructureController();

================================================================================
FILE: QMS-Server-master/controllers/userController.js
================================================================================

const ApiError = require("../error/ApiError");
const { User, Session } = require("../models/index");
const jwt = require("jsonwebtoken");
const uuid = require("uuid");
const path = require("path");

const generateJWT = (id, login, role, name, surname, img) => {
  return jwt.sign(
    { id, login, role, name, surname, img },
    process.env.SECRET_KEY,
    {
      expiresIn: "5h",
    }
  );
};


const checkAccess = (req, targetUserId) => {

  const isSelf = req.user.id === Number(targetUserId);


  const hasManageRights = req.user.abilities && req.user.abilities.includes('users.manage');


  const isSuperAdmin = req.user.role === 'SUPER_ADMIN';


  if (!isSelf && !hasManageRights && !isSuperAdmin) {
      throw ApiError.forbidden("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —á—É–∂–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é");
  }
};

class UserController {

  async getUsers(req, res, next) {
    try {
      const usersAll = await User.findAll({
        order: [["name", "ASC"]],
      });
      return res.json(usersAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async getCurrentUser(req, res, next) {
    try {
      const id = req.params.id;


      checkAccess(req, id);

      const user = await User.findOne({
        where: { id },
      });
      return res.json(user);
    } catch (e) {

      if (e instanceof ApiError) return next(e);
      next(ApiError.badRequest(e.message));
    }
  }


  async updateUser(req, res, next) {
    try {
      const { id, password, name, surname } = req.body;


      checkAccess(req, id);


      const updateData = { name, surname };


      if (password && password.trim() !== "") {
        updateData.password = password;
      }

      await User.update(updateData, { where: { id } });
      const user = await User.findAll({ where: { id } });
      return res.json(user[0]);
    } catch (e) {
      if (e instanceof ApiError) return next(e);
      next(ApiError.badRequest(e.message));
    }
  }


  async updateUserImg(req, res, next) {
    try {
      const { id } = req.body;


      checkAccess(req, id);

      const { img } = req.files;
      let fileName = uuid.v4() + ".jpg";
      img.mv(path.resolve(__dirname, "..", "static", fileName));

      await User.update({ img: fileName }, { where: { id } });

      const user = await User.findAll({ where: { id } });
      return res.json(user[0]);
    } catch (e) {
      if (e instanceof ApiError) return next(e);
      next(ApiError.badRequest(e.message));
    }
  }

  async registration(req, res, next) {
    try {
      const { login, password, role, name, surname } = req.body;

      if (!login || !password) {
        return next(ApiError.badRequest("–Ω–µ—Ç –ª–æ–≥–∏–Ω–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—è –≤ –∑–∞–ø—Ä–æ—Å–µ"));
      }
      const candidate = await User.findOne({ where: { login } });
      if (candidate) {
        return next(
          ApiError.badRequest("–¢–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ –µ—Å—Ç—å")
        );
      }

      const user = await User.create({ login, password, role, name, surname });
      const token = generateJWT(
        user.id,
        user.login,
        user.role,
        user.name,
        user.surname,
        null
      );
      return res.json({ token });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async login(req, res, next) {
    try {
      const { login, password } = req.body;

      if (!login || !password) {
        return next(ApiError.badRequest("–Ω–µ—Ç –ª–æ–≥–∏–Ω–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—è –≤ –∑–∞–ø—Ä–æ—Å–µ"));
      }
      const currentUser = await User.findOne({ where: { login } });
      if (!currentUser) {
        return next(ApiError.internal("–¢–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç"));
      }

      if (currentUser.password != password) {
        return next(ApiError.internal("–Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"));
      }

      const isAciveSession = await Session.findAll({
        where: { userId: currentUser.id, online: true },
      });

      if (isAciveSession.length >= 1) {
        await Session.update(
          { online: false },
          { where: { userId: currentUser.id, online: true } }
        );
      }

      const token = generateJWT(
        currentUser.id,
        currentUser.login,
        currentUser.role,
        currentUser.name,
        currentUser.surname,
        currentUser.img
      );
      return res.json({ token });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async check(req, res, next) {
    const token = generateJWT(
      req.user.id,
      req.user.login,
      req.user.role,
      req.user.name,
      req.user.surname,
      req.user.img
    );
    res.json({ token });
  }


  async deleteUser(req, res, next) {
    try {
      const id = req.params.id;
      const deleteUser = await User.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new UserController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/AlertsController.js
================================================================================

const { Op } = require("sequelize");
const { WarehouseBox, InventoryLimit } = require("../../models/index");
const sequelize = require("../../db");
const ApiError = require("../../error/ApiError");

class AlertsController {
  async getAlerts(req, res, next) {
    try {
      const limits = await InventoryLimit.findAll();

      const balances = await WarehouseBox.findAll({
        attributes: [
          "label",
          "originType",
          "originId",
          [sequelize.fn("SUM", sequelize.col("quantity")), "total"],
        ],
        where: {
          status: {
            [Op.notIn]: ["SCRAP", "SHIPPED"],
          },
        },
        group: ["label", "originType", "originId"],
      });

      const alerts = [];

      for (const limit of limits) {
        let currentQty = 0;

        const foundBalance = balances.find(
          (b) =>
            b.label === limit.label &&
            b.originType === limit.originType &&
            (limit.originId == null || b.originId === limit.originId)
        );

        if (foundBalance) {
          currentQty = Number(foundBalance.get("total")) || 0;
        }

        if (currentQty < limit.minQuantity) {
          alerts.push({
            id: limit.id,
            label: limit.label,
            min: limit.minQuantity,
            current: currentQty,
            deficit: limit.minQuantity - currentQty,
          });
        }
      }

      res.json(alerts);
    } catch (e) {
      console.error("Alerts Error:", e);
      next(ApiError.internal(e.message));
    }
  }

  async getAllLimits(req, res, next) {
    try {
      const limits = await InventoryLimit.findAll({
        order: [["label", "ASC"]],
      });
      res.json(limits);
    } catch (e) {
      console.error("Get Limits Error:", e);
      next(ApiError.internal(e.message));
    }
  }

  async setLimit(req, res, next) {
    try {
      const { label, originType, originId, min } = req.body;

      let whereClause = {};
      if (originId && originType) {
        whereClause = { originId, originType };
      } else {
        whereClause = { label };
      }

      let limit = await InventoryLimit.findOne({ where: whereClause });

      if (limit) {
        if (min <= 0) {
          await limit.destroy();
          return res.json({ message: "–õ–∏–º–∏—Ç —É–¥–∞–ª–µ–Ω" });
        }
        await limit.update({ minQuantity: min, label });
      } else if (min > 0) {
        limit = await InventoryLimit.create({
          label,
          originType,
          originId,
          minQuantity: min,
        });
      }

      res.json(limit);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new AlertsController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/AnalyticsController.js
================================================================================



const { Op } = require("sequelize");
const { WarehouseBox, WarehouseMovement, User, Team, Project } = require("../../models/index");
const { ProductionOutput, OUTPUT_STATUSES } = require("../../models/ProductionOutput");
const sequelize = require("../../db");
const ApiError = require("../../error/ApiError");

let BoardDefect = null;
let DefectCategory = null;
try {
  const defectModels = require("../../models/definitions/Defect");
  BoardDefect = defectModels.BoardDefect;
  DefectCategory = defectModels.DefectCategory;
} catch (e) {
  console.log("[Analytics] –ú–æ–¥–µ–ª–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
}

function calculateDateRange(period, customStartDate, customEndDate) {
  const now = new Date();
  let startDate = new Date(now);
  let endDate = new Date(now);

  startDate.setHours(0, 0, 0, 0);
  endDate.setHours(23, 59, 59, 999);

  switch (period) {
    case 'day':
      break;
    case 'week':
      const dayOfWeek = startDate.getDay() || 7;
      startDate.setDate(startDate.getDate() - (dayOfWeek - 1));
      break;
    case 'month':
      startDate.setDate(1);
      break;
    case 'year':
      startDate.setMonth(0, 1);
      break;
    case 'all':
      startDate = new Date('2020-01-01');
      break;
    case 'custom':
      if (customStartDate) {
        startDate = new Date(customStartDate);
        startDate.setHours(0, 0, 0, 0);
      }
      if (customEndDate) {
        endDate = new Date(customEndDate);
        endDate.setHours(23, 59, 59, 999);
      }
      break;
    default:
      const defaultDay = startDate.getDay() || 7;
      startDate.setDate(startDate.getDate() - (defaultDay - 1));
  }

  return { startDate, endDate };
}

function generateDateRange(startDate, endDate) {
  const dates = [];
  const current = new Date(startDate);
  current.setHours(0, 0, 0, 0);

  const end = new Date(endDate);
  end.setHours(0, 0, 0, 0);

  while (current <= end) {
    dates.push(current.toISOString().split('T')[0]);
    current.setDate(current.getDate() + 1);
  }

  return dates;
}

class AnalyticsController {

  async getDashboardStats(req, res, next) {
    try {
      const {
        period = 'week',
        startDate: customStart,
        endDate: customEnd,
        projectId
      } = req.query;

      const { startDate, endDate } = calculateDateRange(period, customStart, customEnd);
      const startDateStr = startDate.toISOString().split('T')[0];
      const endDateStr = endDate.toISOString().split('T')[0];

      const parsedProjectId = projectId ? Number(projectId) : null;

      console.log(`>>> [Analytics] –ø–µ—Ä–∏–æ–¥=${period}, –ø—Ä–æ–µ–∫—Ç=${parsedProjectId || '–≤—Å–µ'}, —Å ${startDateStr} –ø–æ ${endDateStr}`);

      const now = new Date();
      const todayStart = new Date(now);
      todayStart.setHours(0, 0, 0, 0);

      const yesterdayStart = new Date(todayStart);
      yesterdayStart.setDate(yesterdayStart.getDate() - 1);

      const warehouseDateCondition = period === 'all'
        ? { [Op.gte]: startDate }
        : { [Op.gte]: startDate, [Op.lte]: endDate };

      const productionDateCondition = period === 'all'
        ? { [Op.gte]: startDateStr }
        : { [Op.gte]: startDateStr, [Op.lte]: endDateStr };

      const productionProjectCondition = parsedProjectId
        ? { projectId: parsedProjectId }
        : {};


      const stockStats = await WarehouseBox.findOne({
        attributes: [
          [sequelize.fn("SUM", sequelize.col("quantity")), "totalItems"],
          [sequelize.fn("COUNT", sequelize.col("id")), "totalBoxes"],
        ],
        where: { status: "ON_STOCK" },
        raw: true
      });


      const periodWarehouse = parsedProjectId ? null : await WarehouseMovement.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("goodQty")), "goodQty"]],
        where: {
          performedAt: warehouseDateCondition,
          performedById: { [Op.ne]: null },
          goodQty: { [Op.gt]: 0 }
        },
        raw: true
      });


      const periodProduction = await ProductionOutput.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("approvedQty")), "approvedQty"]],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });


      const todayWarehouse = parsedProjectId ? null : await WarehouseMovement.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("goodQty")), "goodQty"]],
        where: {
          performedAt: { [Op.gte]: todayStart },
          performedById: { [Op.ne]: null },
          goodQty: { [Op.gt]: 0 }
        },
        raw: true
      });

      const todayProduction = await ProductionOutput.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("approvedQty")), "approvedQty"]],
        where: {
          date: todayStart.toISOString().split('T')[0],
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });


      const yesterdayWarehouse = parsedProjectId ? null : await WarehouseMovement.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("goodQty")), "goodQty"]],
        where: {
          performedAt: { [Op.gte]: yesterdayStart, [Op.lt]: todayStart },
          performedById: { [Op.ne]: null },
          goodQty: { [Op.gt]: 0 }
        },
        raw: true
      });

      const yesterdayProduction = await ProductionOutput.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("approvedQty")), "approvedQty"]],
        where: {
          date: yesterdayStart.toISOString().split('T')[0],
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });


      let periodDefects = 0;
      let defectTypes = [];

      if (BoardDefect) {
        try {
          periodDefects = await BoardDefect.count({
            where: { detectedAt: warehouseDateCondition }
          });

          if (DefectCategory && periodDefects > 0) {
            try {
              const defectsByCategory = await BoardDefect.findAll({
                attributes: [
                  "categoryId",
                  [sequelize.fn("COUNT", sequelize.col("board_defect.id")), "count"]
                ],
                where: { detectedAt: warehouseDateCondition },
                include: [{
                  model: DefectCategory,
                  as: "category",
                  attributes: ["title"],
                  required: false
                }],
                group: ["categoryId", "category.id"],
                raw: false
              });

              defectTypes = defectsByCategory
                .filter(d => d.dataValues.count > 0)
                .map(d => ({
                  name: d.category?.title || "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
                  value: Number(d.dataValues.count) || 0
                }));
            } catch (e) {
              console.log("[Analytics] –û—à–∏–±–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:", e.message);
            }
          }

          if (defectTypes.length === 0 && periodDefects > 0) {
            defectTypes = [{ name: "–î–µ—Ñ–µ–∫—Ç—ã", value: periodDefects }];
          }
        } catch (e) {
          console.log("[Analytics] –û—à–∏–±–∫–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤:", e.message);
        }
      }


      let warehouseUsers = [];
      if (!parsedProjectId) {
        warehouseUsers = await WarehouseMovement.findAll({
          attributes: [[sequelize.fn("DISTINCT", sequelize.col("performedById")), "userId"]],
          where: {
            performedAt: warehouseDateCondition,
            performedById: { [Op.ne]: null }
          },
          raw: true
        });
      }

      const productionUsers = await ProductionOutput.findAll({
        attributes: [[sequelize.fn("DISTINCT", sequelize.col("userId")), "userId"]],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });

      const allUserIds = new Set([
        ...warehouseUsers.map(u => u.userId),
        ...productionUsers.map(u => u.userId)
      ]);
      const activeUsers = allUserIds.size;


      let todayWarehouseUsers = [];
      if (!parsedProjectId) {
        todayWarehouseUsers = await WarehouseMovement.findAll({
          attributes: [[sequelize.fn("DISTINCT", sequelize.col("performedById")), "userId"]],
          where: {
            performedAt: { [Op.gte]: todayStart },
            performedById: { [Op.ne]: null }
          },
          raw: true
        });
      }

      const todayProductionUsers = await ProductionOutput.findAll({
        attributes: [[sequelize.fn("DISTINCT", sequelize.col("userId")), "userId"]],
        where: {
          date: todayStart.toISOString().split('T')[0],
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });

      const todayUserIds = new Set([
        ...todayWarehouseUsers.map(u => u.userId),
        ...todayProductionUsers.map(u => u.userId)
      ]);
      const activeUsersToday = todayUserIds.size;


      let chartByDay = [];
      if (!parsedProjectId) {
        chartByDay = await WarehouseMovement.findAll({
          attributes: [
            [sequelize.fn("DATE", sequelize.col("performedAt")), "date"],
            [sequelize.fn("SUM", sequelize.col("goodQty")), "output"],
          ],
          where: {
            performedAt: warehouseDateCondition,
            performedById: { [Op.ne]: null },
            goodQty: { [Op.gt]: 0 }
          },
          group: [sequelize.fn("DATE", sequelize.col("performedAt"))],
          order: [[sequelize.fn("DATE", sequelize.col("performedAt")), "ASC"]],
          raw: true
        });
      }

      const productionByDayRaw = await ProductionOutput.findAll({
        attributes: [
          "date",
          [sequelize.fn("SUM", sequelize.col("approvedQty")), "output"],
        ],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        group: ["date"],
        order: [["date", "ASC"]],
        raw: true
      });

      const daysMap = new Map();

      chartByDay.forEach(row => {
        const dateKey = row.date;
        if (!daysMap.has(dateKey)) daysMap.set(dateKey, { output: 0 });
        daysMap.get(dateKey).output += Number(row.output) || 0;
      });

      productionByDayRaw.forEach(row => {
        const dateKey = row.date;
        if (!daysMap.has(dateKey)) daysMap.set(dateKey, { output: 0 });
        daysMap.get(dateKey).output += Number(row.output) || 0;
      });

      const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      const allDates = generateDateRange(startDate, endDate);

      let filteredDates = allDates;
      let skipFactor = 1;

      if (allDates.length > 90) {
        skipFactor = Math.ceil(allDates.length / 90);
        filteredDates = allDates.filter((_, idx) => idx % skipFactor === 0);
      }

      const productionByDay = filteredDates.map(date => {
        const d = new Date(date);
        const dayOfWeek = d.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

        let output = 0;
        if (skipFactor > 1) {
          const idx = allDates.indexOf(date);
          for (let i = 0; i < skipFactor && idx + i < allDates.length; i++) {
            output += daysMap.get(allDates[idx + i])?.output || 0;
          }
        } else {
          output = daysMap.get(date)?.output || 0;
        }

        return {
          date,
          name: dayNames[dayOfWeek],
          fullDate: date,
          output,
          isWeekend
        };
      });


      let warehouseByUser = [];
      if (!parsedProjectId) {
        warehouseByUser = await WarehouseMovement.findAll({
          attributes: [
            "performedById",
            [sequelize.fn("SUM", sequelize.col("goodQty")), "output"],
          ],
          where: {
            performedAt: warehouseDateCondition,
            performedById: { [Op.ne]: null },
            goodQty: { [Op.gt]: 0 }
          },
          group: ["performedById"],
          raw: true
        });
      }


      const productionByUser = await ProductionOutput.findAll({
        attributes: [
          "userId",
          [sequelize.fn("SUM", sequelize.col("approvedQty")), "output"],
        ],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        group: ["userId"],
        raw: true
      });


      const userOutputMap = new Map();

      warehouseByUser.forEach(row => {
        const userId = row.performedById;
        if (!userOutputMap.has(userId)) {
          userOutputMap.set(userId, { output: 0 });
        }
        userOutputMap.get(userId).output += Number(row.output) || 0;
      });

      productionByUser.forEach(row => {
        const userId = row.userId;
        if (!userOutputMap.has(userId)) {
          userOutputMap.set(userId, { output: 0 });
        }
        userOutputMap.get(userId).output += Number(row.output) || 0;
      });


      const allUserIdsList = [...userOutputMap.keys()].filter(id => id != null);

      let usersData = [];
      if (allUserIdsList.length > 0) {
        usersData = await User.findAll({
          attributes: ["id", "name", "surname", "teamId"],
          where: { id: { [Op.in]: allUserIdsList } },
          include: [{
            model: Team,
            attributes: ["id", "title"],
            required: false
          }],
          raw: false
        });
      }


      const userDataMap = new Map();
      usersData.forEach(u => {
        const plain = u.get({ plain: true });

        const teamData = plain.Team || plain.team || null;
        userDataMap.set(plain.id, {
          name: plain.name,
          surname: plain.surname,
          teamId: plain.teamId,
          team: teamData
        });
      });

      console.log(`>>> [Analytics] –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${usersData.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);


      let usersWithTeams = 0;
      userDataMap.forEach((data) => {
        if (data.team) usersWithTeams++;
      });
      console.log(`>>> [Analytics] –ò–∑ –Ω–∏—Ö —Å –±—Ä–∏–≥–∞–¥–∞–º–∏: ${usersWithTeams}`);


      const formattedTopUsers = Array.from(userOutputMap.entries())
        .map(([userId, data]) => {
          const user = userDataMap.get(userId);
          return {
            id: userId,
            name: user
              ? `${user.surname || ''} ${(user.name || '')[0] || ''}.`.trim()
              : `ID: ${userId}`,
            output: data.output
          };
        })
        .filter(u => u.output > 0)
        .sort((a, b) => b.output - a.output)
        .slice(0, 5);


      const teamsMap = new Map();


      const teamIds = new Set();
      userDataMap.forEach((data) => {
        if (data.teamId) teamIds.add(data.teamId);
      });


      let teamsData = new Map();
      if (teamIds.size > 0) {
        const teams = await Team.findAll({
          attributes: ["id", "title"],
          where: { id: { [Op.in]: [...teamIds] } },
          raw: true
        });
        teams.forEach(t => teamsData.set(t.id, t));
      }


      userOutputMap.forEach((data, userId) => {
        const user = userDataMap.get(userId);
        const teamId = user?.teamId;

        if (teamId) {
          const team = user.team || teamsData.get(teamId);

          if (team) {
            if (!teamsMap.has(teamId)) {
              teamsMap.set(teamId, {
                id: teamId,
                name: team.title,
                output: 0,
                members: new Set()
              });
            }
            const t = teamsMap.get(teamId);
            t.output += data.output;
            t.members.add(userId);
          }
        }
      });

      const teamStats = Array.from(teamsMap.values())
        .map(t => ({ id: t.id, name: t.name, output: t.output, members: t.members.size }))
        .sort((a, b) => b.output - a.output)
        .slice(0, 5);

      console.log(`>>> [Analytics] –ë—Ä–∏–≥–∞–¥ —Å –¥–∞–Ω–Ω—ã–º–∏: ${teamStats.length}`);


      const periodOutput = (Number(periodWarehouse?.goodQty) || 0) + (Number(periodProduction?.approvedQty) || 0);
      const todayOutput = (Number(todayWarehouse?.goodQty) || 0) + (Number(todayProduction?.approvedQty) || 0);
      const yesterdayOutput = (Number(yesterdayWarehouse?.goodQty) || 0) + (Number(yesterdayProduction?.approvedQty) || 0);

      const defectRate = (periodOutput + periodDefects) > 0
        ? Number(((periodDefects / (periodOutput + periodDefects)) * 100).toFixed(1))
        : 0;

      const daysDiff = Math.max(1, Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)));


      let projectName = null;
      if (parsedProjectId) {
        const project = await Project.findByPk(parsedProjectId, { attributes: ["title"] });
        projectName = project?.title || null;
      }

      res.json({
        period,
        projectId: parsedProjectId,
        projectName,
        startDate: startDate.toISOString(),
        endDate: endDate.toISOString(),
        daysInPeriod: daysDiff,

        periodOutput,
        periodDefects,
        defectRate,

        todayOutput,
        yesterdayOutput,

        activeUsers,
        activeUsersToday,

        stock: {
          totalItems: Number(stockStats?.totalItems) || 0,
          totalBoxes: Number(stockStats?.totalBoxes) || 0
        },

        productionByDay,
        defectTypes,
        topUsers: formattedTopUsers,
        teamStats,

        generatedAt: new Date().toISOString()
      });

    } catch (e) {
      console.error("Analytics Dashboard Error:", e);
      next(ApiError.internal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: " + e.message));
    }
  }
}

module.exports = new AnalyticsController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/BoxController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../error/ApiError");
const {
  WarehouseBox,
  WarehouseMovement,
  WarehouseDocument,
  Supply,
  Section,
  Team,
  User,
  PrintHistory
} = require("../../models/index");
const { logAudit } = require("../../utils/auditLogger");
const sequelize = require("../../db");
const PdfService = require("../../services/PdfService");

const generateShortCode = () =>
  Math.floor(100000 + Math.random() * 900000).toString();

class BoxController {


  async createSingleBox(req, res, next) {
    try {
      const { supplyId, sectionId, itemName, quantity, unit, kitNumber, comment } = req.body;

      if (!itemName) {
        return next(ApiError.badRequest("–ù–µ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"));
      }
      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"));
      }

      const uniqueSuffix = Date.now().toString(36);
      const qrCode = `KRYPTO-${uniqueSuffix.toUpperCase()}`;
      const shortCode = generateShortCode();

      const box = await WarehouseBox.create({
        supplyId: supplyId || null,
        currentSectionId: sectionId || null,
        label: itemName,
        quantity: quantity || 1,
        unit: unit || "—à—Ç",
        kitNumber: kitNumber || null,
        qrCode,
        shortCode,
        notes: comment || null,
        status: "ON_STOCK",
        acceptedById: req.user.id,
        acceptedAt: new Date(),
      });

      await logAudit({
        req,
        action: "WAREHOUSE_BOX_CREATE",
        entity: "WarehouseBox",
        entityId: String(box.id),
        description: `–°–æ–∑–¥–∞–Ω–∞ –∫–æ—Ä–æ–±–∫–∞ ${itemName} (${shortCode})`,
        metadata: { supplyId, sectionId, itemName, quantity },
      });

      return res.json(box);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async createBoxesBatch(req, res, next) {
    try {
      const {
        label,
        projectName,
        batchName,
        originType,
        originId,
        quantity = 1,
        itemsPerBox = 1,
        unit = "—à—Ç",
        status = "ON_STOCK",
        currentSectionId = null,
        currentTeamId = null,
        notes,
      } = req.body;

      if (!label) {
        return next(ApiError.badRequest("–ù–µ –∑–∞–¥–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ (label)"));
      }

      const qty = Number(quantity);
      if (qty <= 0 || qty > 1000) {
        return next(
          ApiError.badRequest(
            "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–∏–∫–µ—Ç–æ–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 1000",
          ),
        );
      }

      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"));
      }

      const acceptedById = req.user.id;
      const now = new Date();
      const boxesData = [];

      for (let i = 0; i < qty; i++) {
        const suffix = String(i + 1).padStart(3, "0");
        const qrCode = `BOX-${Date.now()}-${suffix}-${Math.random()
          .toString(36)
          .substr(2, 3)
          .toUpperCase()}`;
        const shortCode = generateShortCode();

        boxesData.push({
          qrCode,
          shortCode,
          label,
          originType: originType || "OTHER",
          originId: originId || null,
          projectName: projectName || null,
          batchName: batchName || null,
          quantity: itemsPerBox,
          unit,
          acceptedAt: now,
          acceptedById,
          status,
          currentSectionId,
          currentTeamId,
          notes: notes || null,
        });
      }

      const created = await WarehouseBox.bulkCreate(boxesData, {
        returning: true,
      });

      await logAudit({
        req,
        action: "WAREHOUSE_BATCH",
        entity: "WarehouseBox",
        description: `–°–æ–∑–¥–∞–Ω–∞ –ø–∞—Ä—Ç–∏—è: ${qty} –º–µ—Å—Ç –ø–æ ${itemsPerBox} ${unit}`,
        metadata: { label, batchName },
      });

      return res.json({ boxes: created });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getBoxes(req, res, next) {
    try {
      const {
        page = 1,
        limit = 50,
        search,
        ...filters
      } = req.query;

      const where = { ...filters };

      Object.keys(where).forEach((key) => {
        if (where[key] === undefined || where[key] === "") {
          delete where[key];
        }
      });

      if (search) {
        const s = String(search).trim();
        where[Op.or] = [
          { qrCode: { [Op.iLike]: `%${s}%` } },
          { shortCode: s },
          { label: { [Op.iLike]: `%${s}%` } },
          { batchName: { [Op.iLike]: `%${s}%` } },
        ];
      }

      const pageNum = Number(page) || 1;
      const limitNum = Number(limit) || 50;
      const offset = (pageNum - 1) * limitNum;

      const { rows, count } = await WarehouseBox.findAndCountAll({
        where,
        limit: limitNum,
        offset,
        order: [["id", "DESC"]],
        include: [
          {
            model: User,
            as: "acceptedBy",
            attributes: ["id", "login", "name", "surname"],
          },
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      res.json({ rows, count, page: pageNum, limit: limitNum });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getBoxById(req, res, next) {
    try {
      const { id } = req.params;

      const box = await WarehouseBox.findByPk(id, {
        include: [
          {
            model: User,
            as: "acceptedBy",
            attributes: ["id", "login", "name", "surname"],
          },
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      if (!box) {
        return next(ApiError.notFound("–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      const movements = await WarehouseMovement.findAll({
        where: { boxId: box.id },
        order: [["performedAt", "DESC"]],
        include: [
          { model: Section, as: "fromSection", attributes: ["id", "title"] },
          { model: Section, as: "toSection", attributes: ["id", "title"] },
          { model: Team, as: "fromTeam", attributes: ["id", "title"] },
          { model: Team, as: "toTeam", attributes: ["id", "title"] },
          {
            model: User,
            as: "performedBy",
            attributes: ["id", "name", "surname"],
          },
        ],
      });

      const documents = await WarehouseDocument.findAll({
        where: { boxId: box.id },
        order: [["date", "DESC"]],
      });

      return res.json({ box, movements, documents });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getBoxByQr(req, res, next) {
    try {
      const encoded = req.params.qr;
      const qrCode = decodeURIComponent(encoded);

      const box = await WarehouseBox.findOne({
        where: { qrCode },
        include: [
          {
            model: User,
            as: "acceptedBy",
            attributes: ["id", "login", "name", "surname"],
          },
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      if (!box) {
        return next(ApiError.notFound("–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      const movements = await WarehouseMovement.findAll({
        where: { boxId: box.id },
        order: [["performedAt", "DESC"]],
      });

      const documents = await WarehouseDocument.findAll({
        where: { boxId: box.id },
        order: [["date", "DESC"]],
      });

      return res.json({ box, movements, documents });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async exportCsv(req, res, next) {
    try {
      const { ids } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return next(ApiError.badRequest("–ù–µ –ø–µ—Ä–µ–¥–∞–Ω—ã ID –∫–æ—Ä–æ–±–æ–∫"));
      }

      const boxes = await WarehouseBox.findAll({
        where: { id: { [Op.in]: ids } },
        include: [{ model: Section, as: "currentSection" }],
        order: [["id", "ASC"]],
      });

      if (!boxes || boxes.length === 0) {
        return next(ApiError.badRequest("–ö–æ—Ä–æ–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"));
      }

      let csv = "\uFEFF";
      csv += "ID;ShortCode;Label;Quantity;Unit;Section;QRCode\n";

      boxes.forEach((b) => {
        const section = b.currentSection ? b.currentSection.title : "";
        const row = [
          b.id,
          b.shortCode || "",
          b.label,
          b.quantity,
          b.unit,
          section,
          b.qrCode,
        ]
          .map((field) => `"${String(field).replace(/"/g, '""')}"`)
          .join(";");

        csv += row + "\n";
      });

      res.header("Content-Type", "text/csv; charset=utf-8");
      res.attachment("labels.csv");
      return res.send(csv);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async printLabelsPdf(req, res, next) {
    try {
      const { ids } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return next(ApiError.badRequest("–ù–µ –ø–µ—Ä–µ–¥–∞–Ω—ã ID –∫–æ—Ä–æ–±–æ–∫"));
      }

      const boxes = await WarehouseBox.findAll({
        where: { id: { [Op.in]: ids } },
        order: [["id", "ASC"]],
      });

      if (!boxes.length) {
        return next(ApiError.badRequest("–ö–æ—Ä–æ–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"));
      }

      const pdfBuffer = await PdfService.generateLabels(boxes);

      res.set({
        "Content-Type": "application/pdf",
        "Content-Length": pdfBuffer.length,
        "Content-Disposition": `attachment; filename="labels_${Date.now()}.pdf"`,
      });

      return res.send(pdfBuffer);
    } catch (e) {
      console.error("PDF Gen Error:", e);
      next(ApiError.internal("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: " + e.message));
    }
  }


  async updateBatch(req, res, next) {
    try {
      const { ids, updates } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return next(ApiError.badRequest("–ù–µ –≤—ã–±—Ä–∞–Ω—ã –∫–æ—Ä–æ–±–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"));
      }

      const allowedFields = ['label', 'quantity', 'unit', 'status', 'batchName', 'projectName', 'notes'];
      const cleanUpdates = {};

      Object.keys(updates).forEach(key => {
        if (allowedFields.includes(key) && updates[key] !== undefined && updates[key] !== "") {
          cleanUpdates[key] = updates[key];
        }
      });

      if (Object.keys(cleanUpdates).length === 0) {
        return next(ApiError.badRequest("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"));
      }

      await WarehouseBox.update(cleanUpdates, {
        where: { id: { [Op.in]: ids } }
      });

      await logAudit({
        req,
        action: "WAREHOUSE_BOX_BATCH_UPDATE",
        entity: "WarehouseBox",
        description: `–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${ids.length} –∫–æ—Ä–æ–±–æ–∫`,
        metadata: { ids, updates: cleanUpdates }
      });

      return res.json({ message: "–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ" });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async printSpecialLabel(req, res, next) {
    try {
      const {
        template = "VIDEO_KIT",
        customLayout,
        printCount = 1,
        code,
        rotate,
        widthMm,
        heightMm,
        ...restData
      } = req.body;

      const labelsData = [];
      const count = Math.max(1, Number(printCount));

      let startCodeStr = String(code).trim();

      if (/^\d+$/.test(startCodeStr)) {
          const originalLength = startCodeStr.length;
          const startBigInt = BigInt(startCodeStr);

          for (let i = 0; i < count; i++) {
              const nextVal = startBigInt + BigInt(i);
              const nextCodeStr = nextVal.toString().padStart(originalLength, '0');
              const infoString = `${restData.productName} - ${restData.quantity} ${restData.unit} (ID: ${nextCodeStr})`;

              labelsData.push({
                  ...restData,
                  code: nextCodeStr,
                  qrCode: nextCodeStr,
                  bottomQr: infoString,
                  rotate: rotate,
                  currentIndex: i + 1,
                  totalCount: count
              });
          }
      } else {
          const infoString = `${restData.productName} - ${restData.quantity} ${restData.unit} (ID: ${startCodeStr})`;

          for (let i = 0; i < count; i++) {
              labelsData.push({
                  ...restData,
                  code: startCodeStr,
                  qrCode: startCodeStr,
                  bottomQr: infoString,
                  rotate: rotate,
                  currentIndex: i + 1,
                  totalCount: count
              });
          }
      }

      const options = {
          widthMm: Number(widthMm) || 105,
          heightMm: Number(heightMm) || 60
      };

      let pdfBuffer;


      if (template === "VIDEO_KIT") {
          pdfBuffer = await PdfService.generateVideoTransmitterLabelBatch(labelsData, options);
      } else if (template === "CUSTOM" && customLayout && customLayout.length > 0) {

          pdfBuffer = await PdfService.generateCustomLabelBatch(labelsData, customLayout, options);
      } else {
          pdfBuffer = await PdfService.generateSimpleZebraBatch(labelsData, options);
      }


      const userId = req.user ? req.user.id : null;
      let endCodeStr = startCodeStr;

      if (labelsData.length > 0) {
          startCodeStr = labelsData[0].code;
          endCodeStr = labelsData[labelsData.length - 1].code;
      }

      await PrintHistory.create({
          template,
          labelName: restData.productName || "–≠—Ç–∏–∫–µ—Ç–∫–∞",
          startCode: startCodeStr,
          endCode: endCodeStr,
          quantity: count,
          params: {
            ...restData,
            widthMm,
            heightMm,
            rotate,
            customLayout: template === "CUSTOM" ? customLayout : undefined
          },
          createdById: userId
      });

      res.set({
        "Content-Type": "application/pdf",
        "Content-Length": pdfBuffer.length,
        "Content-Disposition": `inline; filename="zebra_label_${template}.pdf"`,
      });

      return res.send(pdfBuffer);
    } catch (e) {
      console.error("Print Special Error:", e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new BoxController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/DocumentController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../error/ApiError");
const { WarehouseDocument, User } = require("../../models/index");

class DocumentController {
  async createDocument(req, res, next) {
    try {
      const { boxId, number, type, date, fileUrl, comment } = req.body;

      if (!number) {
        return next(ApiError.badRequest("–ù—É–∂–µ–Ω –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞"));
      }

      const doc = await WarehouseDocument.create({
        boxId: boxId || null,
        number,
        type: type || null,
        date: date || null,
        fileUrl: fileUrl || null,
        comment: comment || null,
        createdById: req.user.id,
      });

      return res.json(doc);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getDocuments(req, res, next) {
    try {
      let { page = 1, limit = 50, search, type } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 50;

      const where = {};
      if (type) where.type = type;
      if (search) where.number = { [Op.iLike]: `%${search}%` };

      const offset = (page - 1) * limit;

      const data = await WarehouseDocument.findAndCountAll({
        where,
        limit,
        offset,
        order: [["date", "DESC"]],
        include: [
          {
            model: User,
            as: "createdBy",
            attributes: ["name", "surname"],
          },
        ],
      });

      return res.json({
        rows: data.rows,
        count: data.count,
        page,
        limit,
      });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new DocumentController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/HistoryController.js
================================================================================

const { PrintHistory, User } = require("../../models/index");
const { Op } = require("sequelize");
const ApiError = require("../../error/ApiError");

class HistoryController {
    async getPrintHistory(req, res, next) {
        try {
            let { page = 1, limit = 50, search, template, dateFrom, dateTo } = req.query;
            page = Number(page) || 1;
            limit = Number(limit) || 50;
            const offset = (page - 1) * limit;

            const where = {};

            if (template) where.template = template;

            if (search) {
                const s = String(search).trim();
                where[Op.or] = [
                    { labelName: { [Op.iLike]: `%${s}%` } },
                    { startCode: { [Op.iLike]: `%${s}%` } },
                    { endCode: { [Op.iLike]: `%${s}%` } }
                ];
            }

            if (dateFrom || dateTo) {
                where.createdAt = {};
                if (dateFrom) where.createdAt[Op.gte] = new Date(dateFrom);
                if (dateTo) {
                    const to = new Date(dateTo);
                    to.setDate(to.getDate() + 1);
                    where.createdAt[Op.lt] = to;
                }
            }

            const history = await PrintHistory.findAndCountAll({
                where,
                limit,
                offset,
                order: [["createdAt", "DESC"]],
                include: [
                    {
                        model: User,
                        as: "createdBy",
                        attributes: ["id", "name", "surname"]
                    }
                ]
            });

            return res.json({
                rows: history.rows,
                count: history.count,
                page,
                limit
            });

        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }
}

module.exports = new HistoryController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/MovementController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../error/ApiError");
const {
  WarehouseBox,
  WarehouseMovement,
  WarehouseDocument,
  Supply,
  Section,
  Team,
  User,
} = require("../../models/index");
const { logAudit } = require("../../utils/auditLogger");
const sequelize = require("../../db");

class MovementController {

  async moveSingle(req, res, next) {
    const t = await sequelize.transaction();
    try {
      const {
        boxId,
        operation,
        toSectionId,
        toTeamId,
        statusAfter,
        deltaQty = 0,
        goodQty = null,
        scrapQty = null,
        comment,
        documentId,
      } = req.body;

      if (!boxId || !operation) {
        await t.rollback();
        return next(ApiError.badRequest("–ù–µ —É–∫–∞–∑–∞–Ω boxId –∏–ª–∏ operation"));
      }

      const box = await WarehouseBox.findByPk(boxId, { transaction: t });
      if (!box) {
        await t.rollback();
        return next(ApiError.notFound("–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"));
      }

      const fromSectionId = box.currentSectionId;
      const fromTeamId = box.currentTeamId;

      let newQty = box.quantity;
      const delta = Number(deltaQty) || 0;

      if (delta !== 0) {
        newQty = box.quantity + delta;
        if (newQty < 0) {
          await t.rollback();
          return next(ApiError.badRequest("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º"));
        }
        box.quantity = newQty;
      }

      if (toSectionId !== undefined) box.currentSectionId = toSectionId || null;
      if (toTeamId !== undefined) box.currentTeamId = toTeamId || null;
      if (statusAfter) box.status = statusAfter;

      await box.save({ transaction: t });

      const movement = await WarehouseMovement.create(
        {
          boxId: box.id,
          documentId: documentId || null,
          fromSectionId,
          toSectionId: toSectionId || null,
          fromTeamId,
          toTeamId: toTeamId || null,
          operation,
          statusAfter: box.status,
          deltaQty: delta,
          goodQty: goodQty !== undefined ? goodQty : null,
          scrapQty: scrapQty !== undefined ? scrapQty : null,
          performedAt: new Date(),
          comment: comment || null,
          performedById: req.user ? req.user.id : null,
        },
        { transaction: t }
      );

      await logAudit({
        req,
        action: "WAREHOUSE_MOVE",
        entity: "WarehouseMovement",
        entityId: String(movement.id),
        description: `–û–ø–µ—Ä–∞—Ü–∏—è ${operation} —Å –∫–æ—Ä–æ–±–∫–æ–π #${box.id}`,
        metadata: {
          boxId: box.id,
          fromSectionId,
          toSectionId,
          deltaQty: delta,
        },
      });

      await t.commit();

      const reloadedBox = await WarehouseBox.findByPk(box.id, {
        include: [
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      return res.json({ box: reloadedBox, movement });
    } catch (e) {
      await t.rollback();
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async moveBatch(req, res, next) {
    const t = await sequelize.transaction();
    try {
      const { docNumber, items } = req.body;

      if (!items || !Array.isArray(items) || items.length === 0) {
        await t.rollback();
        return next(ApiError.badRequest("–ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π"));
      }

      let document = null;
      if (docNumber) {
        document = await WarehouseDocument.create(
          {
            boxId: null,
            number: docNumber,
            type: "MOVEMENT",
            date: new Date(),
            fileUrl: null,
            comment: null,
            createdById: req.user ? req.user.id : null,
          },
          { transaction: t }
        );
      }

      const documentId = document ? document.id : null;

      const movements = [];
      const updatedBoxes = [];

      for (const raw of items) {
        const boxId = raw.boxId || (raw.box && raw.box.id);
        if (!boxId) {
          await t.rollback();
          return next(ApiError.badRequest("–í –æ–¥–Ω–æ–º –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç boxId"));
        }

        const {
          operation,
          toSectionId,
          toTeamId,
          statusAfter,
          deltaQty = 0,
          goodQty = null,
          scrapQty = null,
          comment,
        } = raw;

        const box = await WarehouseBox.findByPk(boxId, { transaction: t });
        if (!box) {
          await t.rollback();
          return next(ApiError.notFound(`–ö–æ—Ä–æ–±–∫–∞ ${boxId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`));
        }

        const fromSectionId = box.currentSectionId;
        const fromTeamId = box.currentTeamId;
        const delta = Number(deltaQty) || 0;

        if (delta !== 0) {
          const newQty = box.quantity + delta;
          if (newQty < 0) {
            await t.rollback();
            return next(
              ApiError.badRequest(`–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –∫–æ—Ä–æ–±–∫–∏ ${boxId}`)
            );
          }
          box.quantity = newQty;
        }

        if (toSectionId !== undefined) box.currentSectionId = toSectionId || null;
        if (toTeamId !== undefined) box.currentTeamId = toTeamId || null;
        if (statusAfter) box.status = statusAfter;

        await box.save({ transaction: t });

        const movement = await WarehouseMovement.create(
          {
            boxId: box.id,
            documentId,
            fromSectionId,
            toSectionId: toSectionId || null,
            fromTeamId,
            toTeamId: toTeamId || null,
            operation,
            statusAfter: box.status,
            deltaQty: delta,
            goodQty: goodQty !== undefined ? goodQty : null,
            scrapQty: scrapQty !== undefined ? scrapQty : null,
            performedAt: new Date(),
            comment: comment || null,
            performedById: req.user ? req.user.id : null,
          },
          { transaction: t }
        );

        movements.push(movement);
        updatedBoxes.push(box);
      }

      await logAudit({
        req,
        action: "WAREHOUSE_MOVE_BATCH",
        entity: "WarehouseMovement",
        description: `–ü–∞–∫–µ—Ç–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ, –æ–ø–µ—Ä–∞—Ü–∏–π: ${movements.length}`,
        metadata: {
          docNumber: docNumber || null,
          count: movements.length,
        },
      });

      await t.commit();

      return res.json({
        message: "–û–ø–µ—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã",
        count: movements.length,
        document: document || null,
      });
    } catch (e) {
      await t.rollback();
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getMovements(req, res, next) {
    try {
      let { page = 1, limit = 50, boxId, fromDate, toDate } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 50;

      const where = {};
      if (boxId) where.boxId = boxId;

      if (fromDate || toDate) {
        where.performedAt = {};
        if (fromDate) where.performedAt[Op.gte] = new Date(fromDate);
        if (toDate) where.performedAt[Op.lte] = new Date(toDate);
      }

      const offset = (page - 1) * limit;

      const { rows, count } = await WarehouseMovement.findAndCountAll({
        where,
        limit,
        offset,
        order: [["performedAt", "DESC"]],
        include: [
          { model: Section, as: "fromSection", attributes: ["id", "title"] },
          { model: Section, as: "toSection", attributes: ["id", "title"] },
          { model: Team, as: "fromTeam", attributes: ["id", "title"] },
          { model: Team, as: "toTeam", attributes: ["id", "title"] },
          {
            model: User,
            as: "performedBy",
            attributes: ["id", "name", "surname"],
          },
        ],
      });

      return res.json({ rows, count, page, limit });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getBalance(req, res, next) {
    try {
      const balances = await WarehouseBox.findAll({
        attributes: [
          "label",
          "originType",
          "originId",
          "unit",
          [sequelize.fn("SUM", sequelize.col("quantity")), "totalQuantity"],
          [sequelize.fn("COUNT", sequelize.col("id")), "boxCount"],
        ],
        where: {
          status: {
            [Op.notIn]: ["SCRAP", "SHIPPED"],
          },
        },
        group: ["label", "originType", "originId", "unit"],
        order: [["label", "ASC"]],
      });

      return res.json(balances);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new MovementController();

================================================================================
FILE: QMS-Server-master/controllers/warehouse/SupplyController.js
================================================================================

const ApiError = require("../../error/ApiError");
const { Supply, WarehouseBox, Section } = require("../../models/index");
const { logAudit } = require("../../utils/auditLogger");

class SupplyController {
  async createSupply(req, res, next) {
    try {
      const { supplier, docNumber, expectedDate, comment } = req.body;

      const supply = await Supply.create({
        supplier: supplier || null,
        docNumber: docNumber || null,
        expectedDate: expectedDate || null,
        comment: comment || null,
        status: "NEW",
      });

      await logAudit({
        req,
        action: "SUPPLY_CREATE",
        entity: "Supply",
        entityId: String(supply.id),
        description: `–ü–æ—Å—Ç–∞–≤–∫–∞ ${docNumber || `#${supply.id}`}`,
      });

      return res.json(supply);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getSupplies(req, res, next) {
    try {
      const supplies = await Supply.findAll({
        order: [["createdAt", "DESC"]],
      });
      return res.json(supplies);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async exportCsv(req, res, next) {
    try {
      const { id } = req.params;

      const boxes = await WarehouseBox.findAll({
        where: { supplyId: id },
        include: [{ model: Section, as: "currentSection" }],
        order: [["id", "ASC"]],
      });

      if (!boxes || boxes.length === 0) {
        return next(ApiError.badRequest("–ù–µ—Ç –∫–æ—Ä–æ–±–æ–∫ –≤ —ç—Ç–æ–π –ø–æ—Å—Ç–∞–≤–∫–µ"));
      }

      let csvContent = "\uFEFF";
      csvContent += "ID;ShortCode;Label;Quantity;Unit;Section;QRCode\n";

      boxes.forEach((box) => {
        const section = box.currentSection ? box.currentSection.title : "";
        const row = [
          box.id,
          box.shortCode || "",
          box.label,
          box.quantity,
          box.unit,
          section,
          box.qrCode,
        ]
          .map((field) => `"${String(field).replace(/"/g, '""')}"`)
          .join(";");

        csvContent += row + "\n";
      });

      res.header("Content-Type", "text/csv; charset=utf-8");
      res.attachment(`supply_${id}_labels.csv`);
      return res.send(csvContent);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new SupplyController();

================================================================================
FILE: QMS-Server-master/db.js
================================================================================

const {Sequelize} = require('sequelize')

module.exports = new Sequelize(
    process.env.DB_NAME,
    process.env.DB_USER,
    process.env.DB_PASSWORD,
    {
        dialect: 'postgres',
        host: process.env.DB_HOST,
        port: process.env.DB_PORT

    }
)
================================================================================
FILE: QMS-Server-master/error/ApiError.js
================================================================================

class ApiError extends Error {
  constructor(status, message) {
    super();
    this.status = status;
    this.message = message;
  }


  static badRequest(message) {
    return new ApiError(400, message);
  }


  static notFound(message) {
    return new ApiError(404, message);
  }


  static internal(message) {
    return new ApiError(500, message);
  }


  static forbidden(message) {
    return new ApiError(403, message);
  }


  static unauthorized(message) {
    return new ApiError(401, message);
  }
}

module.exports = ApiError;

================================================================================
FILE: QMS-Server-master/fonts/README.md
================================================================================

# MES-Kryptonit-Server-master

================================================================================
FILE: QMS-Server-master/index.js
================================================================================

require("dotenv").config();
const express = require("express");
const sequelize = require("./db");
const models = require("./models/index");
const cors = require("cors");
const fileUpload = require("express-fileupload");
const router = require("./routes/index");
const errorHandler = require("./middleware/ErrorHandlingMiddleware");
const path = require("path");


const beryllExtendedRouter = require("./routes/beryllExtendedRouter");

const { initChecklistTemplates } = require("./controllers/beryll");

const PORT = process.env.PORT || 5000;
const app = express();

app.use(express.json());

const corsOptions = {
  origin: "*",
  credentials: true,
  optionSuccessStatus: 200,
};

app.use(cors(corsOptions));
app.use(express.static(path.resolve(__dirname, "static")));
app.use(fileUpload({}));


app.use("/api", router);


app.use("/api/beryll", beryllExtendedRouter);


app.use(errorHandler);

const initInitialData = async () => {
  try {
    console.log(">>> [RBAC] –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Ä–æ–ª–µ–π –∏ –ø—Ä–∞–≤...");


    const permissions = [

      { code: "rbac.manage", description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –∏ –º–∞—Ç—Ä–∏—Ü–µ–π –ø—Ä–∞–≤" },
      { code: "users.manage", description: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º" },


      { code: "warehouse.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Å—Ç–∞—Ç–∫–æ–≤" },
      { code: "warehouse.manage", description: "–ü—Ä–∏–µ–º–∫–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–æ–±–æ–∫, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ" },
      { code: "labels.print", description: "–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–æ–∫" },


      { code: "assembly.execute", description: "–†–∞–±–æ—Ç–∞ –≤ —Å–±–æ—Ä–æ—á–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ" },
      { code: "recipe.manage", description: "–°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Ö–∫–∞—Ä—Ç" },


      { code: "firmware.flash", description: "–ü—Ä–æ—à–∏–≤–∫–∞ –ø–ª–∞—Ç (FC, ELRS, Coral)" },
      { code: "devices.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤" },


      { code: "defect.manage", description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏ –±—Ä–∞–∫–∞" },
      { code: "defect.report", description: "–§–∏–∫—Å–∞—Ü–∏—è –±—Ä–∞–∫–∞" },


      { code: "analytics.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞—à–±–æ—Ä–¥–æ–≤ –∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤" },


      { code: "beryll.view", description: "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–µ—Ä–≤–µ—Ä–æ–≤ –ê–ü–ö –ë–µ—Ä–∏–ª–ª" },
      { code: "beryll.work", description: "–í–∑—è—Ç–∏–µ –≤ —Ä–∞–±–æ—Ç—É –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤" },
      { code: "beryll.manage", description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–º (–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è DHCP)" },
    ];


    for (const p of permissions) {
      await models.Ability.findOrCreate({ where: { code: p.code }, defaults: p });
    }


    const rolesData = {
      SUPER_ADMIN: "–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø (DevOps/Admin)",
      PRODUCTION_CHIEF: "–ù–∞—á. –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞",
      TECHNOLOGIST: "–¢–µ—Ö–Ω–æ–ª–æ–≥",
      WAREHOUSE_MASTER: "–ö–ª–∞–¥–æ–≤—â–∏–∫",
      ASSEMBLER: "–°–±–æ—Ä—â–∏–∫",
      QC_ENGINEER: "–ò–Ω–∂–µ–Ω–µ—Ä –û–¢–ö",
      FIRMWARE_OPERATOR: "–ü—Ä–æ—à–∏–≤–∞–ª—å—â–∏–∫"
    };

    for (const [name, desc] of Object.entries(rolesData)) {
      await models.Role.findOrCreate({
        where: { name },
        defaults: { description: desc }
      });
    }


    const assign = async (roleName, slugs) => {
      const role = await models.Role.findOne({ where: { name: roleName } });
      if (!role) return;

      let abilities;
      if (slugs === '*') {

        abilities = await models.Ability.findAll();
      } else {
        abilities = await models.Ability.findAll({ where: { code: slugs } });
      }

      if (abilities.length) {
        await role.setAbilities(abilities);
      }
    };


    await assign("SUPER_ADMIN", '*');

    await assign("PRODUCTION_CHIEF", [
      "analytics.view", "users.manage", "defect.manage",
      "warehouse.view", "devices.view", "recipe.manage",
      "beryll.view"
    ]);

    await assign("TECHNOLOGIST", [
      "recipe.manage", "firmware.flash", "devices.view",
      "defect.manage",
      "beryll.view", "beryll.work", "beryll.manage"
    ]);

    await assign("WAREHOUSE_MASTER", [
      "warehouse.view", "warehouse.manage", "labels.print"
    ]);

    await assign("ASSEMBLER", [
      "assembly.execute"
    ]);

    await assign("QC_ENGINEER", [
      "defect.report", "devices.view", "warehouse.view"
    ]);

    await assign("FIRMWARE_OPERATOR", [
      "firmware.flash", "devices.view",
      "beryll.view", "beryll.work"
    ]);

    console.log(">>> [RBAC] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.");
  } catch (e) {
    console.error(">>> [RBAC] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
  }
};

const start = async () => {
  try {
    await sequelize.authenticate();
    await sequelize.sync({ alter: true });


    await initInitialData();


    console.log(">>> [Beryll] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–æ–≤...");
    await initChecklistTemplates();
    console.log(">>> [Beryll] –®–∞–±–ª–æ–Ω—ã —á–µ–∫-–ª–∏—Å—Ç–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã");

    app.listen(PORT, () => console.log(`Server started on port ${PORT}`));
  } catch (e) {
    console.log(e);
  }
};

start();

================================================================================
FILE: QMS-Server-master/jest.config.js
================================================================================

module.exports = {
  testEnvironment: 'node',
  coveragePathIgnorePatterns: [
    "/node_modules/"
  ]
};
================================================================================
FILE: QMS-Server-master/middleware/ErrorHandlingMiddleware.js
================================================================================

const ApiError = require("../error/ApiError");

module.exports = function (err, req, res, next) {

    const time = new Date().toISOString().replace('T', ' ').substring(0, 19);
    console.error(`\x1b[31m[${time}] ERROR:\x1b[0m ${req.method} ${req.url}`);


    if (!(err instanceof ApiError)) {
        console.error(err);
    } else {
        console.error(`ApiError: ${err.message}`);
    }


    if (err instanceof ApiError) {
        return res.status(err.status).json({
            message: err.message,
            errors: err.errors
        });
    }


    if (err.name === 'UnauthorizedError' || err.status === 401) {
        return res.status(401).json({
            message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (Invalid Token)"
        });
    }
    if (err.name === 'InvalidTokenError') {
        return res.status(401).json({
            message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç–µ–∫"
        });
    }
    if (err.status === 403) {
        return res.status(403).json({
            message: "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (Forbidden)"
        });
    }


    if (err.name === 'SequelizeUniqueConstraintError') {

        return res.status(409).json({
            message: "–ó–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
            details: err.errors.map(e => e.message)
        });
    }

    if (err.name === 'SequelizeValidationError') {
        return res.status(400).json({
            message: "–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö",
            details: err.errors.map(e => e.message)
        });
    }

    if (err.name === 'SequelizeConnectionError') {
        return res.status(503).json({
            message: "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
        });
    }


    return res.status(500).json({
        message: "–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
        error: process.env.NODE_ENV === 'development' ? err.message : undefined
    });
};

================================================================================
FILE: QMS-Server-master/middleware/authMiddleware.js
================================================================================

const { auth } = require('express-oauth2-jwt-bearer');

const checkJwt = auth({
  audience: 'account',
  issuerBaseURL: 'http://keycloak.local/realms/MES-Realm',
  tokenSigningAlg: 'RS256'
});

module.exports = checkJwt;

================================================================================
FILE: QMS-Server-master/middleware/checkAbilityMiddleware.js
================================================================================

const ApiError = require("../error/ApiError");

module.exports = function (requiredSlug) {
    return function (req, res, next) {
        if (req.method === "OPTIONS") return next();

        try {
            const user = req.user;
            if (!user) return next(ApiError.unauthorized("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"));


            if (user.role === 'SUPER_ADMIN') {
                return next();
            }


            if (user.abilities && user.abilities.includes(requiredSlug)) {
                return next();
            }

            return next(ApiError.forbidden(`–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∞–≤–æ: ${requiredSlug}`));

        } catch (e) {
            return next(ApiError.internal("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤"));
        }
    };
};

================================================================================
FILE: QMS-Server-master/middleware/checkRoleMiddleware.js
================================================================================

module.exports = function (role) {
  return function (req, res, next) {
    if (req.method === "OPTIONS") {
      return next();
    }

    try {
      if (!req.user) {
        return res.status(401).json({ message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (Backend Error)" });
      }

      if (req.user.role !== role) {
        return res.status(403).json({
            message: `–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å ${role}, —É –≤–∞—Å ${req.user.role}`
        });
      }

      next();
    } catch (e) {
      console.error("CheckRole Error:", e);
      return res.status(500).json({ message: "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏" });
    }
  };
};

================================================================================
FILE: QMS-Server-master/middleware/syncUserMiddleware.js
================================================================================



const { User, Role, Ability } = require('../models/index');

module.exports = async function (req, res, next) {


    if (req.method === "OPTIONS") return next();

    try {

        if (!req.auth || !req.auth.payload) {
            console.error("‚ùå –û–®–ò–ë–ö–ê: authMiddleware –Ω–µ –ø–µ—Ä–µ–¥–∞–ª payload. –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω.");
            return res.status(401).json({ message: "Invalid token payload" });
        }

        const payload = req.auth.payload;


        const keycloakUUID = payload.sub;


        const login = payload.preferred_username || payload.nickname || payload.email;

        if (!login) {
            console.error("‚ùå –û–®–ò–ë–ö–ê: –í —Ç–æ–∫–µ–Ω–µ –Ω–µ—Ç –ø–æ–ª—è login (preferred_username/nickname/email).");
            return res.status(500).json({ message: "Token structure error: missing username" });
        }

        const name = payload.given_name || login;
        const surname = payload.family_name || '';


        const kcRoles = payload.realm_access?.roles || [];


        const priorityRoles = [
            "SUPER_ADMIN",
            "PRODUCTION_CHIEF",
            "TECHNOLOGIST",
            "WAREHOUSE_MASTER",
            "QC_ENGINEER",
            "FIRMWARE_OPERATOR",
            "ASSEMBLER"
        ];


        const mainRole = priorityRoles.find(r => kcRoles.includes(r)) || "ASSEMBLER";


        let user = await User.findOne({ where: { login } });

        if (!user) {
            console.log(`‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${login} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–µ–º —Å —Ä–æ–ª—å—é ${mainRole}...`);
            try {
                user = await User.create({
                    login,
                    name,
                    surname,
                    role: mainRole,
                    password: 'sso_managed_account',
                    img: null
                });
                console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω. ID: ${user.id}`);
            } catch (dbError) {
                console.error("‚ùå –û–®–ò–ë–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:", dbError);
                return res.status(500).json({ message: "DB Error during user creation" });
            }
        } else {

            if (user.role !== mainRole) {
                console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${login}: ${user.role} -> ${mainRole}`);
                user.role = mainRole;
                await user.save();
            }
        }


        let abilities = [];
        try {
            const roleEntity = await Role.findOne({
                where: { name: mainRole },
                include: [{
                    model: Ability,
                    as: "abilities",
                    through: { attributes: [] }
                }]
            });

            if (roleEntity && roleEntity.abilities) {
                abilities = roleEntity.abilities.map(ab => ab.code);
            }
        } catch (e) {
            console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∞–≤ (abilities):", e.message);
        }


        req.user = {
            id: user.id,
            login: user.login,
            name: user.name,
            surname: user.surname,
            role: user.role,
            roles: kcRoles,
            abilities: abilities,
            keycloakId: keycloakUUID
        };

        next();

    } catch (e) {
        console.error("üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ syncUserMiddleware:", e);
        return res.status(500).json({ message: "Sync Middleware Crash", error: e.message });
    }
};

================================================================================
FILE: QMS-Server-master/migrations/20250121-beryll-defects-monitoring.js
================================================================================

'use strict';


module.exports = {
  async up(queryInterface, Sequelize) {

    console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é: –î–µ—Ñ–µ–∫—Ç—ã + –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥...');


    console.log('üìä –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...');

    await queryInterface.addColumn('beryll_servers', 'lastPingAt', {
      type: Sequelize.DATE,
      allowNull: true,
      comment: '–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∏–Ω–≥–∞'
    }).catch(() => console.log('  - lastPingAt —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'));


    await queryInterface.sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_servers_pingStatus') THEN
          CREATE TYPE "enum_beryll_servers_pingStatus" AS ENUM ('ONLINE', 'OFFLINE', 'UNKNOWN');
        END IF;
      END$$;
    `).catch(() => console.log('  - ENUM pingStatus —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'));

    await queryInterface.addColumn('beryll_servers', 'pingStatus', {
      type: Sequelize.ENUM('ONLINE', 'OFFLINE', 'UNKNOWN'),
      allowNull: true,
      defaultValue: 'UNKNOWN',
      comment: '–°—Ç–∞—Ç—É—Å –ø–∏–Ω–≥–∞'
    }).catch(() => console.log('  - pingStatus —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'));

    await queryInterface.addColumn('beryll_servers', 'pingLatency', {
      type: Sequelize.FLOAT,
      allowNull: true,
      comment: '–ó–∞–¥–µ—Ä–∂–∫–∞ –ø–∏–Ω–≥–∞ –≤ –º—Å'
    }).catch(() => console.log('  - pingLatency —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'));


    console.log('üí¨ –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É beryll_defect_comments...');

    await queryInterface.createTable('beryll_defect_comments', {
      id: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        autoIncrement: true
      },
      serverId: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: { model: 'beryll_servers', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE'
      },
      userId: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: { model: 'users', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'SET NULL'
      },
      text: {
        type: Sequelize.TEXT,
        allowNull: false
      },
      defectCategory: {
        type: Sequelize.ENUM('HARDWARE', 'SOFTWARE', 'ASSEMBLY', 'COMPONENT', 'OTHER'),
        allowNull: true,
        defaultValue: 'OTHER'
      },
      priority: {
        type: Sequelize.ENUM('LOW', 'MEDIUM', 'HIGH', 'CRITICAL'),
        allowNull: true,
        defaultValue: 'MEDIUM'
      },
      status: {
        type: Sequelize.ENUM('NEW', 'IN_PROGRESS', 'RESOLVED', 'WONT_FIX'),
        allowNull: false,
        defaultValue: 'NEW'
      },
      resolvedById: {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: 'users', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'SET NULL'
      },
      resolvedAt: {
        type: Sequelize.DATE,
        allowNull: true
      },
      resolution: {
        type: Sequelize.TEXT,
        allowNull: true
      },
      createdAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      },
      updatedAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      }
    });


    await queryInterface.addIndex('beryll_defect_comments', ['serverId']);
    await queryInterface.addIndex('beryll_defect_comments', ['status']);
    await queryInterface.addIndex('beryll_defect_comments', ['defectCategory']);
    await queryInterface.addIndex('beryll_defect_comments', ['priority']);
    await queryInterface.addIndex('beryll_defect_comments', ['createdAt']);


    console.log('üìé –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É beryll_defect_files...');

    await queryInterface.createTable('beryll_defect_files', {
      id: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        autoIncrement: true
      },
      commentId: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: { model: 'beryll_defect_comments', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE'
      },
      originalName: {
        type: Sequelize.STRING(255),
        allowNull: false
      },
      fileName: {
        type: Sequelize.STRING(255),
        allowNull: false
      },
      filePath: {
        type: Sequelize.STRING(500),
        allowNull: false
      },
      mimeType: {
        type: Sequelize.STRING(100),
        allowNull: true
      },
      fileSize: {
        type: Sequelize.INTEGER,
        allowNull: true
      },
      uploadedById: {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: 'users', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'SET NULL'
      },
      createdAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      }
    });

    await queryInterface.addIndex('beryll_defect_files', ['commentId']);


    console.log('üìù –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ action —Ç–∏–ø—ã –≤ –∏—Å—Ç–æ—Ä–∏—é...');

    const newActions = [
      'DEFECT_COMMENT_ADDED',
      'DEFECT_STATUS_CHANGED',
      'DEFECT_COMMENT_DELETED',
      'DEFECT_FILE_UPLOADED',
      'DEFECT_FILE_DELETED'
    ];

    for (const action of newActions) {
      await queryInterface.sequelize.query(`
        DO $$
        BEGIN
          IF NOT EXISTS (
            SELECT 1 FROM pg_enum
            WHERE enumlabel = '${action}'
            AND enumtypid = (SELECT oid FROM pg_type WHERE typname = 'enum_beryll_history_action')
          ) THEN
            ALTER TYPE "enum_beryll_history_action" ADD VALUE '${action}';
          END IF;
        END$$;
      `).catch(e => console.log(`  - ${action}: ${e.message}`));
    }

    console.log('‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è beryll-defects-monitoring –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
  },

  async down(queryInterface, Sequelize) {
    console.log('‚è™ –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏: –î–µ—Ñ–µ–∫—Ç—ã + –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥...');


    await queryInterface.dropTable('beryll_defect_files').catch(() => {});
    await queryInterface.dropTable('beryll_defect_comments').catch(() => {});


    await queryInterface.removeColumn('beryll_servers', 'lastPingAt').catch(() => {});
    await queryInterface.removeColumn('beryll_servers', 'pingLatency').catch(() => {});
    await queryInterface.removeColumn('beryll_servers', 'pingStatus').catch(() => {});


    console.log('‚úÖ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
  }
};

================================================================================
FILE: QMS-Server-master/migrations/20250121000001-create-beryll-extended.js
================================================================================



"use strict";

module.exports = {
  async up(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();

    try {


      await queryInterface.createTable("beryll_racks", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        name: {
          type: Sequelize.STRING(100),
          allowNull: false,
          unique: true
        },
        location: {
          type: Sequelize.STRING(255),
          allowNull: true
        },
        totalUnits: {
          type: Sequelize.INTEGER,
          allowNull: false,
          defaultValue: 42
        },
        networkSubnet: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        gateway: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        status: {
          type: Sequelize.ENUM("ACTIVE", "MAINTENANCE", "DECOMMISSIONED"),
          allowNull: false,
          defaultValue: "ACTIVE"
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        metadata: {
          type: Sequelize.JSONB,
          allowNull: true,
          defaultValue: {}
        },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("beryll_racks", ["name"], { transaction });
      await queryInterface.addIndex("beryll_racks", ["status"], { transaction });
      await queryInterface.addIndex("beryll_racks", ["location"], { transaction });


      await queryInterface.createTable("beryll_rack_units", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        rackId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: {
            model: "beryll_racks",
            key: "id"
          },
          onDelete: "CASCADE"
        },
        serverId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "beryll_servers",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        unitNumber: {
          type: Sequelize.INTEGER,
          allowNull: false
        },
        hostname: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        mgmtMacAddress: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        mgmtIpAddress: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        dataMacAddress: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        dataIpAddress: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        accessLogin: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        accessPassword: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        installedAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        installedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "users",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("beryll_rack_units", ["rackId"], { transaction });
      await queryInterface.addIndex("beryll_rack_units", ["serverId"], { transaction });
      await queryInterface.addIndex("beryll_rack_units", ["rackId", "unitNumber"], {
        unique: true,
        transaction,
        name: "beryll_rack_units_rack_unit_unique"
      });
      await queryInterface.addIndex("beryll_rack_units", ["hostname"], { transaction });


      await queryInterface.createTable("beryll_shipments", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        name: {
          type: Sequelize.STRING(200),
          allowNull: false
        },
        destinationCity: {
          type: Sequelize.STRING(200),
          allowNull: true
        },
        destinationAddress: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        contactPerson: {
          type: Sequelize.STRING(200),
          allowNull: true
        },
        contactPhone: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        expectedCount: {
          type: Sequelize.INTEGER,
          allowNull: true,
          defaultValue: 80
        },
        status: {
          type: Sequelize.ENUM("FORMING", "READY", "SHIPPED", "IN_TRANSIT", "DELIVERED", "ACCEPTED"),
          allowNull: false,
          defaultValue: "FORMING"
        },
        plannedShipDate: {
          type: Sequelize.DATEONLY,
          allowNull: true
        },
        actualShipDate: {
          type: Sequelize.DATEONLY,
          allowNull: true
        },
        deliveredAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        acceptedAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        waybillNumber: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        carrier: {
          type: Sequelize.STRING(200),
          allowNull: true
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        createdById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "users",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        metadata: {
          type: Sequelize.JSONB,
          allowNull: true,
          defaultValue: {}
        },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("beryll_shipments", ["name"], { transaction });
      await queryInterface.addIndex("beryll_shipments", ["status"], { transaction });
      await queryInterface.addIndex("beryll_shipments", ["destinationCity"], { transaction });
      await queryInterface.addIndex("beryll_shipments", ["plannedShipDate"], { transaction });


      await queryInterface.createTable("beryll_clusters", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        name: {
          type: Sequelize.STRING(100),
          allowNull: false
        },
        description: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        shipmentId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "beryll_shipments",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        expectedCount: {
          type: Sequelize.INTEGER,
          allowNull: true,
          defaultValue: 10
        },
        status: {
          type: Sequelize.ENUM("FORMING", "READY", "SHIPPED", "DEPLOYED"),
          allowNull: false,
          defaultValue: "FORMING"
        },
        configVersion: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        createdById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "users",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        metadata: {
          type: Sequelize.JSONB,
          allowNull: true,
          defaultValue: {}
        },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("beryll_clusters", ["name"], { transaction });
      await queryInterface.addIndex("beryll_clusters", ["shipmentId"], { transaction });
      await queryInterface.addIndex("beryll_clusters", ["status"], { transaction });


      await queryInterface.createTable("beryll_cluster_servers", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        clusterId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: {
            model: "beryll_clusters",
            key: "id"
          },
          onDelete: "CASCADE"
        },
        serverId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: {
            model: "beryll_servers",
            key: "id"
          },
          onDelete: "CASCADE"
        },
        role: {
          type: Sequelize.ENUM("MASTER", "WORKER", "STORAGE", "GATEWAY"),
          allowNull: false,
          defaultValue: "WORKER"
        },
        orderNumber: {
          type: Sequelize.INTEGER,
          allowNull: true
        },
        clusterHostname: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        clusterIpAddress: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        addedAt: {
          type: Sequelize.DATE,
          allowNull: true,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        addedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "users",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("beryll_cluster_servers", ["clusterId"], { transaction });
      await queryInterface.addIndex("beryll_cluster_servers", ["serverId"], { transaction });
      await queryInterface.addIndex("beryll_cluster_servers", ["clusterId", "serverId"], {
        unique: true,
        transaction,
        name: "beryll_cluster_servers_unique"
      });
      await queryInterface.addIndex("beryll_cluster_servers", ["role"], { transaction });


      await queryInterface.createTable("beryll_defect_records", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        serverId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: {
            model: "beryll_servers",
            key: "id"
          },
          onDelete: "CASCADE"
        },
        yadroTicketNumber: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        hasSPISI: {
          type: Sequelize.BOOLEAN,
          allowNull: true,
          defaultValue: false
        },
        clusterCode: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        problemDescription: {
          type: Sequelize.TEXT,
          allowNull: false
        },
        detectedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        detectedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "users",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        diagnosticianId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "users",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        repairPartType: {
          type: Sequelize.ENUM("RAM", "MOTHERBOARD", "CPU", "HDD", "SSD", "PSU", "FAN", "RAID", "NIC", "BACKPLANE", "BMC", "CABLE", "OTHER"),
          allowNull: true
        },
        defectPartSerialYadro: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        defectPartSerialManuf: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        replacementPartSerialYadro: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        replacementPartSerialManuf: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        repairDetails: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        status: {
          type: Sequelize.ENUM("NEW", "DIAGNOSING", "WAITING_PARTS", "REPAIRING", "SENT_TO_YADRO", "RETURNED", "RESOLVED", "REPEATED", "CLOSED"),
          allowNull: false,
          defaultValue: "NEW"
        },
        isRepeatedDefect: {
          type: Sequelize.BOOLEAN,
          allowNull: true,
          defaultValue: false
        },
        repeatedDefectReason: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        repeatedDefectDate: {
          type: Sequelize.DATE,
          allowNull: true
        },
        sentToYadroRepair: {
          type: Sequelize.BOOLEAN,
          allowNull: true,
          defaultValue: false
        },
        sentToYadroAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        returnedFromYadro: {
          type: Sequelize.BOOLEAN,
          allowNull: true,
          defaultValue: false
        },
        returnedFromYadroAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        substituteServerSerial: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        resolvedAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        resolvedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "users",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        resolution: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        metadata: {
          type: Sequelize.JSONB,
          allowNull: true,
          defaultValue: {}
        },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("beryll_defect_records", ["serverId"], { transaction });
      await queryInterface.addIndex("beryll_defect_records", ["yadroTicketNumber"], { transaction });
      await queryInterface.addIndex("beryll_defect_records", ["status"], { transaction });
      await queryInterface.addIndex("beryll_defect_records", ["detectedAt"], { transaction });
      await queryInterface.addIndex("beryll_defect_records", ["repairPartType"], { transaction });
      await queryInterface.addIndex("beryll_defect_records", ["diagnosticianId"], { transaction });
      await queryInterface.addIndex("beryll_defect_records", ["isRepeatedDefect"], { transaction });


      await queryInterface.createTable("beryll_defect_record_files", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        defectRecordId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: {
            model: "beryll_defect_records",
            key: "id"
          },
          onDelete: "CASCADE"
        },
        originalName: {
          type: Sequelize.STRING(255),
          allowNull: false
        },
        fileName: {
          type: Sequelize.STRING(255),
          allowNull: false
        },
        filePath: {
          type: Sequelize.STRING(500),
          allowNull: false
        },
        mimeType: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        fileSize: {
          type: Sequelize.INTEGER,
          allowNull: true
        },
        uploadedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "users",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("beryll_defect_record_files", ["defectRecordId"], { transaction });


      await queryInterface.createTable("beryll_extended_history", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        entityType: {
          type: Sequelize.ENUM("RACK", "CLUSTER", "SHIPMENT", "DEFECT_RECORD"),
          allowNull: false
        },
        entityId: {
          type: Sequelize.INTEGER,
          allowNull: false
        },
        action: {
          type: Sequelize.STRING(50),
          allowNull: false
        },
        userId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: {
            model: "users",
            key: "id"
          },
          onDelete: "SET NULL"
        },
        comment: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        changes: {
          type: Sequelize.JSONB,
          allowNull: true
        },
        metadata: {
          type: Sequelize.JSONB,
          allowNull: true
        },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("beryll_extended_history", ["entityType", "entityId"], { transaction });
      await queryInterface.addIndex("beryll_extended_history", ["userId"], { transaction });
      await queryInterface.addIndex("beryll_extended_history", ["createdAt"], { transaction });

      await transaction.commit();
      console.log("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è beryll_extended —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞");

    } catch (error) {
      await transaction.rollback();
      console.error("‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:", error);
      throw error;
    }
  },

  async down(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();

    try {

      await queryInterface.dropTable("beryll_extended_history", { transaction });
      await queryInterface.dropTable("beryll_defect_record_files", { transaction });
      await queryInterface.dropTable("beryll_defect_records", { transaction });
      await queryInterface.dropTable("beryll_cluster_servers", { transaction });
      await queryInterface.dropTable("beryll_clusters", { transaction });
      await queryInterface.dropTable("beryll_shipments", { transaction });
      await queryInterface.dropTable("beryll_rack_units", { transaction });
      await queryInterface.dropTable("beryll_racks", { transaction });


      await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_beryll_racks_status";', { transaction });
      await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_beryll_shipments_status";', { transaction });
      await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_beryll_clusters_status";', { transaction });
      await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_beryll_cluster_servers_role";', { transaction });
      await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_beryll_defect_records_repairPartType";', { transaction });
      await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_beryll_defect_records_status";', { transaction });
      await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_beryll_extended_history_entityType";', { transaction });

      await transaction.commit();
      console.log("‚úÖ –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ beryll_extended –≤—ã–ø–æ–ª–Ω–µ–Ω");

    } catch (error) {
      await transaction.rollback();
      console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–∞—Ç–∞:", error);
      throw error;
    }
  }
};

================================================================================
FILE: QMS-Server-master/migrations/20250126-add-structure-manager-fields.js
================================================================================

'use strict';


module.exports = {
  async up(queryInterface, Sequelize) {
    console.log('üöÄ –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è managerId –∏ teamLeadId...');


    await queryInterface.addColumn('production_section', 'managerId', {
      type: Sequelize.INTEGER,
      allowNull: true,
      references: {
        model: 'users',
        key: 'id'
      },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    }).then(() => console.log('‚úÖ managerId –¥–æ–±–∞–≤–ª–µ–Ω –≤ production_section'))
      .catch(() => console.log('‚ö†Ô∏è managerId —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ production_section'));


    await queryInterface.addColumn('production_team', 'teamLeadId', {
      type: Sequelize.INTEGER,
      allowNull: true,
      references: {
        model: 'users',
        key: 'id'
      },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    }).then(() => console.log('‚úÖ teamLeadId –¥–æ–±–∞–≤–ª–µ–Ω –≤ production_team'))
      .catch(() => console.log('‚ö†Ô∏è teamLeadId —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ production_team'));

    console.log('üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.removeColumn('production_section', 'managerId')
      .catch(() => console.log('managerId –Ω–µ –Ω–∞–π–¥–µ–Ω'));

    await queryInterface.removeColumn('production_team', 'teamLeadId')
      .catch(() => console.log('teamLeadId –Ω–µ –Ω–∞–π–¥–µ–Ω'));
  }
};

================================================================================
FILE: QMS-Server-master/migrations/20260116-beryll-extension.js
================================================================================

'use strict';

module.exports = {
  async up(queryInterface, Sequelize) {
    const now = new Date();


    const tableExists = async (tableName) => {
      const res = await queryInterface.sequelize.query(
        `SELECT to_regclass('public."${tableName}"') AS regclass`,
        { type: Sequelize.QueryTypes.SELECT }
      );
      return !!(res?.[0]?.regclass);
    };

    const ensureTable = async (tableName, createFn) => {
      if (!(await tableExists(tableName))) {
        await createFn();
      }
    };

    const ensureColumn = async (tableName, columnName, definition) => {
      const desc = await queryInterface.describeTable(tableName);
      if (!desc[columnName]) {
        await queryInterface.addColumn(tableName, columnName, definition);
      }
    };


    await ensureTable('beryll_batches', async () => {
      await queryInterface.createTable('beryll_batches', {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        title: {
          type: Sequelize.STRING(255),
          allowNull: false
        },
        supplier: {
          type: Sequelize.STRING(255),
          allowNull: true
        },
        deliveryDate: {
          type: Sequelize.DATEONLY,
          allowNull: true
        },
        status: {
          type: Sequelize.ENUM('ACTIVE', 'COMPLETED', 'CANCELLED'),
          allowNull: false,
          defaultValue: 'ACTIVE'
        },
        expectedCount: {
          type: Sequelize.INTEGER,
          allowNull: true,
          defaultValue: 0
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        completedAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        createdById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: 'users', key: 'id' },
          onUpdate: 'CASCADE',
          onDelete: 'SET NULL'
        },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
        },
        updatedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
        }
      });
    });


    await ensureColumn('beryll_servers', 'apkSerialNumber', {
      type: Sequelize.STRING(50),
      allowNull: true,
      unique: true
    });

    await ensureColumn('beryll_servers', 'batchId', {
      type: Sequelize.INTEGER,
      allowNull: true,
      references: { model: 'beryll_batches', key: 'id' },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    });

    await ensureColumn('beryll_servers', 'completedAt', {
      type: Sequelize.DATE,
      allowNull: true
    });

    await ensureColumn('beryll_servers', 'archivedAt', {
      type: Sequelize.DATE,
      allowNull: true
    });

    await ensureColumn('beryll_servers', 'archivedById', {
      type: Sequelize.INTEGER,
      allowNull: true,
      references: { model: 'users', key: 'id' },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    });

    await ensureColumn('beryll_servers', 'burnInStartAt', {
      type: Sequelize.DATE,
      allowNull: true
    });

    await ensureColumn('beryll_servers', 'burnInEndAt', {
      type: Sequelize.DATE,
      allowNull: true
    });


    await queryInterface.sequelize.query(`
      ALTER TYPE "enum_beryll_servers_status" ADD VALUE IF NOT EXISTS 'ARCHIVED';
    `).catch(() => console.log('ARCHIVED status might already exist'));


    await ensureTable('beryll_history', async () => {
      await queryInterface.createTable('beryll_history', {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        serverId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: 'beryll_servers', key: 'id' },
          onUpdate: 'CASCADE',
          onDelete: 'SET NULL'
        },
        serverIp: { type: Sequelize.STRING(45), allowNull: true },
        serverHostname: { type: Sequelize.STRING(255), allowNull: true },
        userId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: 'users', key: 'id' },
          onUpdate: 'CASCADE',
          onDelete: 'SET NULL'
        },
        action: {
          type: Sequelize.ENUM(
            'CREATED', 'TAKEN', 'RELEASED', 'STATUS_CHANGED', 'NOTE_ADDED',
            'CHECKLIST_COMPLETED', 'BATCH_ASSIGNED', 'BATCH_REMOVED',
            'DELETED', 'ARCHIVED', 'FILE_UPLOADED', 'SERIAL_ASSIGNED'
          ),
          allowNull: false
        },
        fromStatus: { type: Sequelize.STRING(50), allowNull: true },
        toStatus: { type: Sequelize.STRING(50), allowNull: true },
        checklistItemId: { type: Sequelize.INTEGER, allowNull: true },
        comment: { type: Sequelize.TEXT, allowNull: true },
        metadata: { type: Sequelize.JSONB, allowNull: true },
        durationMinutes: { type: Sequelize.INTEGER, allowNull: true },
        createdAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
        }
      });

      await queryInterface.addIndex('beryll_history', ['serverId']);
      await queryInterface.addIndex('beryll_history', ['userId']);
      await queryInterface.addIndex('beryll_history', ['action']);
      await queryInterface.addIndex('beryll_history', ['createdAt']);
    });


    await ensureTable('beryll_checklist_templates', async () => {
      await queryInterface.createTable('beryll_checklist_templates', {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        groupCode: {
          type: Sequelize.ENUM('VISUAL', 'TESTING', 'QC_PRIMARY', 'BURN_IN', 'QC_FINAL'),
          allowNull: false,
          defaultValue: 'TESTING'
        },
        title: { type: Sequelize.STRING(255), allowNull: false },
        description: { type: Sequelize.TEXT, allowNull: true },
        fileCode: { type: Sequelize.STRING(50), allowNull: true },
        requiresFile: { type: Sequelize.BOOLEAN, defaultValue: false },
        sortOrder: { type: Sequelize.INTEGER, allowNull: false, defaultValue: 0 },
        isRequired: { type: Sequelize.BOOLEAN, defaultValue: true },
        estimatedMinutes: { type: Sequelize.INTEGER, allowNull: true, defaultValue: 30 },
        isActive: { type: Sequelize.BOOLEAN, defaultValue: true },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.literal('CURRENT_TIMESTAMP') },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.literal('CURRENT_TIMESTAMP') }
      });
    });


    await ensureTable('beryll_server_checklists', async () => {
      await queryInterface.createTable('beryll_server_checklists', {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        serverId: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: 'beryll_servers', key: 'id' },
          onUpdate: 'CASCADE', onDelete: 'CASCADE'
        },
        checklistTemplateId: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: 'beryll_checklist_templates', key: 'id' },
          onUpdate: 'CASCADE', onDelete: 'CASCADE'
        },
        completed: { type: Sequelize.BOOLEAN, defaultValue: false },
        completedById: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: 'users', key: 'id' },
          onUpdate: 'CASCADE', onDelete: 'SET NULL'
        },
        completedAt: { type: Sequelize.DATE, allowNull: true },
        notes: { type: Sequelize.TEXT, allowNull: true },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.literal('CURRENT_TIMESTAMP') },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.literal('CURRENT_TIMESTAMP') }
      });

      await queryInterface.addIndex('beryll_server_checklists', ['serverId', 'checklistTemplateId'], {
        unique: true, name: 'beryll_server_checklist_unique'
      });
    });


    await ensureTable('beryll_checklist_files', async () => {
      await queryInterface.createTable('beryll_checklist_files', {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        serverChecklistId: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: 'beryll_server_checklists', key: 'id' },
          onUpdate: 'CASCADE', onDelete: 'CASCADE'
        },
        originalName: { type: Sequelize.STRING(255), allowNull: false },
        fileName: { type: Sequelize.STRING(255), allowNull: false },
        filePath: { type: Sequelize.STRING(500), allowNull: false },
        mimeType: { type: Sequelize.STRING(100), allowNull: true },
        fileSize: { type: Sequelize.INTEGER, allowNull: true },
        uploadedById: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: 'users', key: 'id' },
          onUpdate: 'CASCADE', onDelete: 'SET NULL'
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.literal('CURRENT_TIMESTAMP') }
      });

      await queryInterface.addIndex('beryll_checklist_files', ['serverChecklistId']);
    });


    if (await tableExists('beryll_checklist_templates')) {
      const existing = await queryInterface.sequelize.query(
        `SELECT "groupCode", "title" FROM "beryll_checklist_templates"`,
        { type: Sequelize.QueryTypes.SELECT }
      );

      const existingKey = new Set(existing.map(r => `${r.groupCode}::${r.title}`));

      const templates = [
        { groupCode: 'VISUAL', title: '–í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞', description: '–ü—Ä–æ–≤–µ—Å—Ç–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è), –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ', fileCode: null, requiresFile: false, sortOrder: 100, isRequired: true, estimatedMinutes: 10, isActive: true, createdAt: now, updatedAt: now },

        { groupCode: 'TESTING', title: '–°–∫—Ä–∏–Ω –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏', description: '–°–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞', fileCode: 'sn_on2', requiresFile: true, sortOrder: 200, isRequired: true, estimatedMinutes: 5, isActive: true, createdAt: now, updatedAt: now },
        { groupCode: 'TESTING', title: '–¢–µ—Å—Ç RAID (cachevault)', description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏ cachevault', fileCode: 'sn_cachevault2', requiresFile: true, sortOrder: 210, isRequired: true, estimatedMinutes: 15, isActive: true, createdAt: now, updatedAt: now },
        { groupCode: 'TESTING', title: '–°—Ç—Ä–µ—Å—Å —Ç–µ—Å—Ç 3 (60 –º–∏–Ω)', description: '–ü—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ 60 –º–∏–Ω—É—Ç', fileCode: 'sn_gtk32', requiresFile: true, sortOrder: 220, isRequired: true, estimatedMinutes: 60, isActive: true, createdAt: now, updatedAt: now },
        { groupCode: 'TESTING', title: '–¢–µ—Å—Ç SSD + —Å–∫—Ä–∏–Ω RAID', description: '–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å SSD –∏ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç RAID', fileCode: 'sn_raid2', requiresFile: true, sortOrder: 230, isRequired: true, estimatedMinutes: 20, isActive: true, createdAt: now, updatedAt: now },
        { groupCode: 'TESTING', title: '–¢–µ—Å—Ç HDD, SSD + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤', description: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HDD –∏ SSD, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤', fileCode: null, requiresFile: false, sortOrder: 240, isRequired: true, estimatedMinutes: 30, isActive: true, createdAt: now, updatedAt: now },
        { groupCode: 'TESTING', title: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ (0, 3, 6)', description: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ 0, 3, 6 + —Å–∫—Ä–∏–Ω', fileCode: 'sn_dimm2', requiresFile: true, sortOrder: 250, isRequired: true, estimatedMinutes: 30, isActive: true, createdAt: now, updatedAt: now },
        { groupCode: 'TESTING', title: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ (11, 12)', description: '–í—ã—è–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞, –∑–∞—è–≤–∫–∞ –≤ –Ø–¥—Ä–æ, –æ—Ç–º–µ—Ç–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –±—Ä–∞–∫–∞', fileCode: 'sn_dimm2FAIL2', requiresFile: false, sortOrder: 260, isRequired: false, estimatedMinutes: 20, isActive: true, createdAt: now, updatedAt: now },
        { groupCode: 'TESTING', title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤', description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤', fileCode: null, requiresFile: false, sortOrder: 270, isRequired: true, estimatedMinutes: 5, isActive: true, createdAt: now, updatedAt: now },
        { groupCode: 'TESTING', title: '–í—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –æ–±—â–∏–π –¥–∏—Å–∫', description: '–í—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤', fileCode: null, requiresFile: false, sortOrder: 280, isRequired: true, estimatedMinutes: 10, isActive: true, createdAt: now, updatedAt: now },
        { groupCode: 'TESTING', title: '–°–∫—Ä–∏–Ω BIOS, BMC [dts, die]', description: '–í–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ + —Å–∫—Ä–∏–Ω –∏–∑ BIOS, BMC', fileCode: 'sn_Bios2', requiresFile: true, sortOrder: 290, isRequired: true, estimatedMinutes: 10, isActive: true, createdAt: now, updatedAt: now },

        { groupCode: 'QC_PRIMARY', title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤ (–û–¢–ö)', description: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤', fileCode: null, requiresFile: false, sortOrder: 300, isRequired: true, estimatedMinutes: 15, isActive: true, createdAt: now, updatedAt: now },

        { groupCode: 'BURN_IN', title: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–æ–Ω', description: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–æ–Ω (burn-in)', fileCode: null, requiresFile: false, sortOrder: 400, isRequired: true, estimatedMinutes: 1440, isActive: true, createdAt: now, updatedAt: now },

        { groupCode: 'QC_FINAL', title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–æ–Ω–∞ (–û–¢–ö)', description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–æ–Ω–∞', fileCode: null, requiresFile: false, sortOrder: 500, isRequired: true, estimatedMinutes: 10, isActive: true, createdAt: now, updatedAt: now }
      ];

      const newTemplates = templates.filter(t => !existingKey.has(`${t.groupCode}::${t.title}`));
      if (newTemplates.length > 0) {
        await queryInterface.bulkInsert('beryll_checklist_templates', newTemplates);
      }
    }

    console.log('‚úÖ Migration beryll-extension completed');
  },

  async down(queryInterface, Sequelize) {


    await queryInterface.dropTable('beryll_checklist_files').catch(() => {});
    await queryInterface.dropTable('beryll_server_checklists').catch(() => {});
    await queryInterface.dropTable('beryll_checklist_templates').catch(() => {});
    await queryInterface.dropTable('beryll_history').catch(() => {});


    const safeRemove = async (table, col) => {
      const desc = await queryInterface.describeTable(table);
      if (desc[col]) await queryInterface.removeColumn(table, col);
    };

    await safeRemove('beryll_servers', 'apkSerialNumber');
    await safeRemove('beryll_servers', 'batchId');
    await safeRemove('beryll_servers', 'completedAt');
    await safeRemove('beryll_servers', 'archivedAt');
    await safeRemove('beryll_servers', 'archivedById');
    await safeRemove('beryll_servers', 'burnInStartAt');
    await safeRemove('beryll_servers', 'burnInEndAt');

    await queryInterface.dropTable('beryll_batches').catch(() => {});
    console.log('‚úÖ Migration beryll-extension reverted');
  }
};

================================================================================
FILE: QMS-Server-master/migrations/20260121-create-defect-system.js
================================================================================

'use strict';


module.exports = {
  async up(queryInterface, Sequelize) {


    await queryInterface.createTable('defect_categories', {
      id: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        autoIncrement: true
      },
      code: {
        type: Sequelize.STRING(50),
        unique: true,
        allowNull: false
      },
      title: {
        type: Sequelize.STRING(200),
        allowNull: false
      },
      description: {
        type: Sequelize.TEXT,
        allowNull: true
      },
      severity: {
        type: Sequelize.ENUM("CRITICAL", "MAJOR", "MINOR"),
        defaultValue: "MAJOR"
      },
      applicableTypes: {
        type: Sequelize.JSON,
        defaultValue: []
      },
      isActive: {
        type: Sequelize.BOOLEAN,
        defaultValue: true
      },
      createdAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      },
      updatedAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      }
    });


    await queryInterface.createTable('board_defects', {
      id: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        autoIncrement: true
      },


      boardType: {
        type: Sequelize.STRING(50),
        allowNull: false
      },
      boardId: {
        type: Sequelize.INTEGER,
        allowNull: true
      },
      serialNumber: {
        type: Sequelize.STRING(100),
        allowNull: true
      },


      categoryId: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: { model: 'defect_categories', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'RESTRICT'
      },
      description: {
        type: Sequelize.TEXT,
        allowNull: true
      },


      detectedById: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: { model: 'users', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'RESTRICT'
      },
      detectedAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      },


      status: {
        type: Sequelize.ENUM(
          "OPEN", "IN_REPAIR", "REPAIRED", "VERIFIED",
          "SCRAPPED", "RETURNED", "CLOSED"
        ),
        defaultValue: "OPEN"
      },


      closedById: {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: 'users', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'SET NULL'
      },
      closedAt: {
        type: Sequelize.DATE,
        allowNull: true
      },
      finalResult: {
        type: Sequelize.ENUM("FIXED", "SCRAPPED", "RETURNED_TO_SUPPLIER", "FALSE_POSITIVE"),
        allowNull: true
      },


      totalRepairMinutes: {
        type: Sequelize.INTEGER,
        defaultValue: 0
      },

      createdAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      },
      updatedAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      }
    });


    await queryInterface.addIndex('board_defects', ['boardType']);
    await queryInterface.addIndex('board_defects', ['boardType', 'boardId']);
    await queryInterface.addIndex('board_defects', ['status']);
    await queryInterface.addIndex('board_defects', ['categoryId']);
    await queryInterface.addIndex('board_defects', ['detectedById']);
    await queryInterface.addIndex('board_defects', ['detectedAt']);
    await queryInterface.addIndex('board_defects', ['serialNumber']);


    await queryInterface.createTable('repair_actions', {
      id: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        autoIncrement: true
      },

      boardDefectId: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: { model: 'board_defects', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'CASCADE'
      },

      actionType: {
        type: Sequelize.ENUM(
          "DIAGNOSIS", "SOLDER", "REPLACE", "FLASH",
          "TEST", "CLEAN", "CLONE_DISK", "CABLE_REPLACE", "OTHER"
        ),
        allowNull: false
      },

      performedById: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: { model: 'users', key: 'id' },
        onUpdate: 'CASCADE',
        onDelete: 'RESTRICT'
      },
      performedAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      },

      description: {
        type: Sequelize.TEXT,
        allowNull: false
      },
      timeSpentMinutes: {
        type: Sequelize.INTEGER,
        allowNull: true
      },

      result: {
        type: Sequelize.ENUM("SUCCESS", "PARTIAL", "FAILED", "PENDING"),
        defaultValue: "PENDING"
      },

      createdAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      },
      updatedAt: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
      }
    });


    await queryInterface.addIndex('repair_actions', ['boardDefectId']);
    await queryInterface.addIndex('repair_actions', ['performedById']);
    await queryInterface.addIndex('repair_actions', ['performedAt']);


    const now = new Date();

    await queryInterface.bulkInsert('abilities', [
      { code: 'defect.create', description: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤', createdAt: now, updatedAt: now },
      { code: 'defect.update', description: '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤', createdAt: now, updatedAt: now },
      { code: 'defect.repair', description: '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞', createdAt: now, updatedAt: now },
      { code: 'defect.scrap', description: '–°–ø–∏—Å–∞–Ω–∏–µ –±—Ä–∞–∫–∞', createdAt: now, updatedAt: now },
      { code: 'defect.verify', description: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞ (–û–¢–ö)', createdAt: now, updatedAt: now },
    ], { ignoreDuplicates: true });
  },

  async down(queryInterface, Sequelize) {

    await queryInterface.dropTable('repair_actions');
    await queryInterface.dropTable('board_defects');
    await queryInterface.dropTable('defect_categories');


    await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_defect_categories_severity";');
    await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_board_defects_status";');
    await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_board_defects_finalResult";');
    await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_repair_actions_actionType";');
    await queryInterface.sequelize.query('DROP TYPE IF EXISTS "enum_repair_actions_result";');


    await queryInterface.bulkDelete('abilities', {
      code: { [Sequelize.Op.in]: [
        'defect.create', 'defect.update', 'defect.repair',
        'defect.scrap', 'defect.verify'
      ]}
    });
  }
};

================================================================================
FILE: QMS-Server-master/migrations/20260123-complete-business-logic-fix.js
================================================================================



"use strict";

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const transaction = await queryInterface.sequelize.transaction();

    try {


      await queryInterface.createTable("component_catalog", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        type: {
          type: Sequelize.ENUM(
            "CPU", "RAM", "HDD", "SSD", "NVME", "MOTHERBOARD",
            "GPU", "NIC", "RAID", "PSU", "FAN", "BMC",
            "BACKPLANE", "CABLE", "CHASSIS", "OTHER"
          ),
          allowNull: false
        },
        manufacturer: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        model: {
          type: Sequelize.STRING(150),
          allowNull: false
        },
        revision: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        partNumber: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        specifications: {
          type: Sequelize.JSONB,
          allowNull: true,
          defaultValue: {},
          comment: "capacity, speed, cores, etc."
        },
        serialNumberPattern: {
          type: Sequelize.STRING(100),
          allowNull: true,
          comment: "Regex pattern for validation"
        },
        isActive: {
          type: Sequelize.BOOLEAN,
          defaultValue: true
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        createdAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("component_catalog", ["type"], { transaction });
      await queryInterface.addIndex("component_catalog", ["manufacturer"], { transaction });
      await queryInterface.addIndex("component_catalog", ["model"], { transaction });
      await queryInterface.addIndex("component_catalog", ["type", "manufacturer", "model"], {
        unique: true,
        transaction,
        name: "component_catalog_unique_type_manuf_model"
      });


      await queryInterface.createTable("component_inventory", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        catalogId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "component_catalog", key: "id" },
          onDelete: "SET NULL"
        },
        type: {
          type: Sequelize.ENUM(
            "CPU", "RAM", "HDD", "SSD", "NVME", "MOTHERBOARD",
            "GPU", "NIC", "RAID", "PSU", "FAN", "BMC",
            "BACKPLANE", "CABLE", "CHASSIS", "OTHER"
          ),
          allowNull: false
        },
        serialNumber: {
          type: Sequelize.STRING(100),
          allowNull: false
        },
        serialNumberYadro: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        manufacturer: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        model: {
          type: Sequelize.STRING(150),
          allowNull: true
        },
        status: {
          type: Sequelize.ENUM(
            "AVAILABLE",
            "RESERVED",
            "IN_USE",
            "IN_REPAIR",
            "DEFECTIVE",
            "SCRAPPED",
            "RETURNED"
          ),
          allowNull: false,
          defaultValue: "AVAILABLE"
        },
        condition: {
          type: Sequelize.ENUM("NEW", "REFURBISHED", "USED", "DAMAGED"),
          defaultValue: "NEW"
        },
        location: {
          type: Sequelize.STRING(100),
          allowNull: true,
          comment: "–§–∏–∑–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ"
        },
        currentServerId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "beryll_servers", key: "id" },
          onDelete: "SET NULL"
        },
        reservedForDefectId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "beryll_defect_records", key: "id" },
          onDelete: "SET NULL"
        },
        purchaseDate: {
          type: Sequelize.DATE,
          allowNull: true
        },
        warrantyExpires: {
          type: Sequelize.DATE,
          allowNull: true
        },
        lastTestedAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        metadata: {
          type: Sequelize.JSONB,
          defaultValue: {}
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        createdById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
          onDelete: "SET NULL"
        },
        createdAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("component_inventory", ["type"], { transaction });
      await queryInterface.addIndex("component_inventory", ["status"], { transaction });
      await queryInterface.addIndex("component_inventory", ["serialNumber"], { transaction });
      await queryInterface.addIndex("component_inventory", ["serialNumberYadro"], { transaction });
      await queryInterface.addIndex("component_inventory", ["currentServerId"], { transaction });


      await queryInterface.createTable("component_history", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },

        serverComponentId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "beryll_server_components", key: "id" },
          onDelete: "SET NULL"
        },
        inventoryComponentId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "component_inventory", key: "id" },
          onDelete: "SET NULL"
        },
        action: {
          type: Sequelize.ENUM(
            "RECEIVED",
            "INSTALLED",
            "REMOVED",
            "REPLACED",
            "SENT_TO_YADRO",
            "RETURNED_FROM_YADRO",
            "TESTED",
            "RESERVED",
            "RELEASED",
            "SCRAPPED",
            "TRANSFERRED"
          ),
          allowNull: false
        },
        fromServerId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "beryll_servers", key: "id" },
          onDelete: "SET NULL"
        },
        toServerId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "beryll_servers", key: "id" },
          onDelete: "SET NULL"
        },
        fromLocation: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        toLocation: {
          type: Sequelize.STRING(100),
          allowNull: true
        },
        relatedDefectId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "beryll_defect_records", key: "id" },
          onDelete: "SET NULL"
        },
        yadroTicketNumber: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        performedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
          onDelete: "SET NULL"
        },
        performedAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        metadata: {
          type: Sequelize.JSONB,
          defaultValue: {}
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        createdAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("component_history", ["serverComponentId"], { transaction });
      await queryInterface.addIndex("component_history", ["inventoryComponentId"], { transaction });
      await queryInterface.addIndex("component_history", ["action"], { transaction });
      await queryInterface.addIndex("component_history", ["relatedDefectId"], { transaction });
      await queryInterface.addIndex("component_history", ["performedAt"], { transaction });


      await queryInterface.addColumn("beryll_defect_records", "defectComponentId", {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: "beryll_server_components", key: "id" },
        onDelete: "SET NULL"
      }, { transaction });

      await queryInterface.addColumn("beryll_defect_records", "replacementComponentId", {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: "beryll_server_components", key: "id" },
        onDelete: "SET NULL"
      }, { transaction });


      await queryInterface.addColumn("beryll_defect_records", "defectInventoryId", {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: "component_inventory", key: "id" },
        onDelete: "SET NULL"
      }, { transaction });

      await queryInterface.addColumn("beryll_defect_records", "replacementInventoryId", {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: "component_inventory", key: "id" },
        onDelete: "SET NULL"
      }, { transaction });


      await queryInterface.addColumn("beryll_defect_records", "previousDefectId", {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: "beryll_defect_records", key: "id" },
        onDelete: "SET NULL"
      }, { transaction });


      await queryInterface.addColumn("beryll_defect_records", "substituteServerId", {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: "beryll_servers", key: "id" },
        onDelete: "SET NULL"
      }, { transaction });


      await queryInterface.addColumn("beryll_defect_records", "slaDeadline", {
        type: Sequelize.DATE,
        allowNull: true
      }, { transaction });

      await queryInterface.addColumn("beryll_defect_records", "diagnosisStartedAt", {
        type: Sequelize.DATE,
        allowNull: true
      }, { transaction });

      await queryInterface.addColumn("beryll_defect_records", "diagnosisCompletedAt", {
        type: Sequelize.DATE,
        allowNull: true
      }, { transaction });

      await queryInterface.addColumn("beryll_defect_records", "repairStartedAt", {
        type: Sequelize.DATE,
        allowNull: true
      }, { transaction });

      await queryInterface.addColumn("beryll_defect_records", "repairCompletedAt", {
        type: Sequelize.DATE,
        allowNull: true
      }, { transaction });

      await queryInterface.addColumn("beryll_defect_records", "totalDowntimeMinutes", {
        type: Sequelize.INTEGER,
        allowNull: true
      }, { transaction });

      await queryInterface.addIndex("beryll_defect_records", ["defectComponentId"], { transaction });
      await queryInterface.addIndex("beryll_defect_records", ["previousDefectId"], { transaction });
      await queryInterface.addIndex("beryll_defect_records", ["substituteServerId"], { transaction });


      await queryInterface.createTable("beryll_cluster_racks", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        clusterId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "beryll_clusters", key: "id" },
          onDelete: "CASCADE"
        },
        rackId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "beryll_racks", key: "id" },
          onDelete: "CASCADE"
        },
        isPrimary: {
          type: Sequelize.BOOLEAN,
          defaultValue: false,
          comment: "–û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–æ–π–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞"
        },
        unitRangeStart: {
          type: Sequelize.INTEGER,
          allowNull: true,
          comment: "–ù–∞—á–∞–ª—å–Ω—ã–π —é–Ω–∏—Ç –≤ —Å—Ç–æ–π–∫–µ"
        },
        unitRangeEnd: {
          type: Sequelize.INTEGER,
          allowNull: true,
          comment: "–ö–æ–Ω–µ—á–Ω—ã–π —é–Ω–∏—Ç –≤ —Å—Ç–æ–π–∫–µ"
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        assignedAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        assignedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
          onDelete: "SET NULL"
        },
        createdAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("beryll_cluster_racks", ["clusterId"], { transaction });
      await queryInterface.addIndex("beryll_cluster_racks", ["rackId"], { transaction });
      await queryInterface.addIndex("beryll_cluster_racks", ["clusterId", "rackId"], {
        unique: true,
        transaction
      });


      await queryInterface.createTable("substitute_server_pool", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        serverId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "beryll_servers", key: "id" },
          onDelete: "CASCADE",
          unique: true
        },
        status: {
          type: Sequelize.ENUM("AVAILABLE", "IN_USE", "MAINTENANCE", "RETIRED"),
          defaultValue: "AVAILABLE"
        },
        currentDefectId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "beryll_defect_records", key: "id" },
          onDelete: "SET NULL"
        },
        issuedAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        issuedToUserId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
          onDelete: "SET NULL"
        },
        returnedAt: {
          type: Sequelize.DATE,
          allowNull: true
        },
        usageCount: {
          type: Sequelize.INTEGER,
          defaultValue: 0
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        createdAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("substitute_server_pool", ["status"], { transaction });
      await queryInterface.addIndex("substitute_server_pool", ["currentDefectId"], { transaction });


      await queryInterface.createTable("yadro_ticket_log", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        ticketNumber: {
          type: Sequelize.STRING(50),
          allowNull: false,
          comment: "–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –Ø–¥—Ä–æ (INC...)"
        },
        defectRecordId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "beryll_defect_records", key: "id" },
          onDelete: "SET NULL"
        },
        serverId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "beryll_servers", key: "id" },
          onDelete: "SET NULL"
        },
        requestType: {
          type: Sequelize.ENUM("COMPONENT_REPAIR", "COMPONENT_EXCHANGE", "WARRANTY_CLAIM", "CONSULTATION"),
          defaultValue: "COMPONENT_REPAIR",
          comment: "–¢–∏–ø –æ–±—Ä–∞—â–µ–Ω–∏—è (–¥–ª—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏)"
        },
        status: {
          type: Sequelize.ENUM("SENT", "IN_PROGRESS", "COMPLETED", "RECEIVED", "CLOSED"),
          defaultValue: "SENT",
          comment: "–°—Ç–∞—Ç—É—Å –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É—á—ë—Ç–∞"
        },
        componentType: {
          type: Sequelize.STRING(50),
          allowNull: true
        },
        sentComponentSerialYadro: {
          type: Sequelize.STRING(100),
          allowNull: true,
          comment: "S/N –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–Ø–¥—Ä–æ)"
        },
        sentComponentSerialManuf: {
          type: Sequelize.STRING(100),
          allowNull: true,
          comment: "S/N –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å)"
        },
        receivedComponentSerialYadro: {
          type: Sequelize.STRING(100),
          allowNull: true,
          comment: "S/N –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–Ø–¥—Ä–æ)"
        },
        receivedComponentSerialManuf: {
          type: Sequelize.STRING(100),
          allowNull: true,
          comment: "S/N –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å)"
        },
        sentAt: {
          type: Sequelize.DATE,
          allowNull: true,
          comment: "–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –Ø–¥—Ä–æ"
        },
        receivedAt: {
          type: Sequelize.DATE,
          allowNull: true,
          comment: "–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ"
        },
        problemDescription: {
          type: Sequelize.TEXT,
          allowNull: true,
          comment: "–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã"
        },
        yadroResponse: {
          type: Sequelize.TEXT,
          allowNull: true,
          comment: "–û—Ç–≤–µ—Ç/—Ä–µ–∑–æ–ª—é—Ü–∏—è –æ—Ç –Ø–¥—Ä–æ"
        },
        notes: {
          type: Sequelize.TEXT,
          allowNull: true
        },
        createdById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
          onDelete: "SET NULL"
        },
        createdAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("yadro_ticket_log", ["ticketNumber"], { transaction });
      await queryInterface.addIndex("yadro_ticket_log", ["defectRecordId"], { transaction });
      await queryInterface.addIndex("yadro_ticket_log", ["serverId"], { transaction });
      await queryInterface.addIndex("yadro_ticket_log", ["status"], { transaction });


      await queryInterface.addColumn("beryll_server_components", "catalogId", {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: "component_catalog", key: "id" },
        onDelete: "SET NULL"
      }, { transaction });


      await queryInterface.addColumn("beryll_server_components", "inventoryId", {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: "component_inventory", key: "id" },
        onDelete: "SET NULL"
      }, { transaction });


      await queryInterface.addColumn("beryll_server_components", "installedAt", {
        type: Sequelize.DATE,
        allowNull: true
      }, { transaction });


      await queryInterface.addColumn("beryll_server_components", "installedById", {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: { model: "users", key: "id" },
        onDelete: "SET NULL"
      }, { transaction });


      await queryInterface.createTable("user_aliases", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        userId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
          onDelete: "CASCADE"
        },
        alias: {
          type: Sequelize.STRING(100),
          allowNull: false,
          comment: "–ö–æ—Å—Ç—é–∫–æ–≤ –ò.–ò., –¢—Ä—É—Å–æ–≤ –ê.–ú."
        },
        source: {
          type: Sequelize.STRING(50),
          allowNull: true,
          comment: "excel_import, manual, etc."
        },
        isActive: {
          type: Sequelize.BOOLEAN,
          defaultValue: true
        },
        createdAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });

      await queryInterface.addIndex("user_aliases", ["alias"], { transaction });
      await queryInterface.addIndex("user_aliases", ["userId"], { transaction });
      await queryInterface.addIndex("user_aliases", ["alias", "userId"], {
        unique: true,
        transaction
      });


      await queryInterface.createTable("sla_config", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true
        },
        name: {
          type: Sequelize.STRING(100),
          allowNull: false
        },
        defectType: {
          type: Sequelize.STRING(50),
          allowNull: true,
          comment: "RAM, MOTHERBOARD, etc. NULL = default"
        },
        priority: {
          type: Sequelize.STRING(20),
          allowNull: true,
          comment: "LOW, MEDIUM, HIGH, CRITICAL. NULL = default"
        },
        maxDiagnosisHours: {
          type: Sequelize.INTEGER,
          allowNull: false,
          defaultValue: 24
        },
        maxRepairHours: {
          type: Sequelize.INTEGER,
          allowNull: false,
          defaultValue: 72
        },
        maxTotalHours: {
          type: Sequelize.INTEGER,
          allowNull: false,
          defaultValue: 168,
          comment: "7 days default"
        },
        escalationAfterHours: {
          type: Sequelize.INTEGER,
          allowNull: true,
          defaultValue: 48
        },
        isActive: {
          type: Sequelize.BOOLEAN,
          defaultValue: true
        },
        createdAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        },
        updatedAt: {
          type: Sequelize.DATE,
          defaultValue: Sequelize.literal("CURRENT_TIMESTAMP")
        }
      }, { transaction });


      await queryInterface.addColumn("beryll_servers", "isSubstitutePool", {
        type: Sequelize.BOOLEAN,
        defaultValue: false
      }, { transaction });

      await queryInterface.addColumn("beryll_servers", "substitutePoolAddedAt", {
        type: Sequelize.DATE,
        allowNull: true
      }, { transaction });

      await transaction.commit();
      console.log("‚úÖ Migration 20260123-complete-business-logic-fix completed successfully");

    } catch (error) {
      await transaction.rollback();
      console.error("‚ùå Migration failed:", error);
      throw error;
    }
  },

  down: async (queryInterface, Sequelize) => {
    const transaction = await queryInterface.sequelize.transaction();

    try {

      await queryInterface.removeColumn("beryll_servers", "substitutePoolAddedAt", { transaction });
      await queryInterface.removeColumn("beryll_servers", "isSubstitutePool", { transaction });

      await queryInterface.dropTable("sla_config", { transaction });
      await queryInterface.dropTable("user_aliases", { transaction });

      await queryInterface.removeColumn("beryll_server_components", "installedById", { transaction });
      await queryInterface.removeColumn("beryll_server_components", "installedAt", { transaction });
      await queryInterface.removeColumn("beryll_server_components", "inventoryId", { transaction });
      await queryInterface.removeColumn("beryll_server_components", "catalogId", { transaction });

      await queryInterface.dropTable("yadro_ticket_log", { transaction });
      await queryInterface.dropTable("substitute_server_pool", { transaction });
      await queryInterface.dropTable("beryll_cluster_racks", { transaction });

      await queryInterface.removeColumn("beryll_defect_records", "totalDowntimeMinutes", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "repairCompletedAt", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "repairStartedAt", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "diagnosisCompletedAt", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "diagnosisStartedAt", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "slaDeadline", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "substituteServerId", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "previousDefectId", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "replacementInventoryId", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "defectInventoryId", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "replacementComponentId", { transaction });
      await queryInterface.removeColumn("beryll_defect_records", "defectComponentId", { transaction });

      await queryInterface.dropTable("component_history", { transaction });
      await queryInterface.dropTable("component_inventory", { transaction });
      await queryInterface.dropTable("component_catalog", { transaction });

      await transaction.commit();
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }
};

================================================================================
FILE: QMS-Server-master/migrations/20260126180000-add-serialNumberYadro-to-beryll-components.js
================================================================================

'use strict';


module.exports = {
    async up(queryInterface, Sequelize) {
        const tableInfo = await queryInterface.describeTable('beryll_server_components');


        if (!tableInfo.serialNumberYadro) {
            console.log('‚ûï –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É serialNumberYadro –≤ beryll_server_components...');

            await queryInterface.addColumn('beryll_server_components', 'serialNumberYadro', {
                type: Sequelize.STRING(100),
                allowNull: true,
                comment: '–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –Ø–¥—Ä–æ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π, –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –∑–∞–≤–æ–¥—Å–∫–æ–≥–æ serialNumber)'
            });


            await queryInterface.addIndex('beryll_server_components', ['serialNumberYadro'], {
                name: 'idx_beryll_server_components_serial_yadro'
            });

            console.log('‚úÖ –ö–æ–ª–æ–Ω–∫–∞ serialNumberYadro –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        } else {
            console.log('‚ÑπÔ∏è –ö–æ–ª–æ–Ω–∫–∞ serialNumberYadro —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        }
    },

    async down(queryInterface, Sequelize) {
        const tableInfo = await queryInterface.describeTable('beryll_server_components');

        if (tableInfo.serialNumberYadro) {

            try {
                await queryInterface.removeIndex('beryll_server_components', 'idx_beryll_server_components_serial_yadro');
            } catch (e) {
                console.log('–ò–Ω–¥–µ–∫—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
            }

            await queryInterface.removeColumn('beryll_server_components', 'serialNumberYadro');
            console.log('‚úÖ –ö–æ–ª–æ–Ω–∫–∞ serialNumberYadro —É–¥–∞–ª–µ–Ω–∞');
        }
    }
};

================================================================================
FILE: QMS-Server-master/migrations/run-migration-components.js
================================================================================



require("dotenv").config();
const { Sequelize } = require("sequelize");

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASSWORD,
  {
    host: process.env.DB_HOST || "localhost",
    port: process.env.DB_PORT || 5432,
    dialect: "postgres",
    logging: console.log
  }
);

async function runMigration() {
  try {
    console.log("üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...");
    await sequelize.authenticate();
    console.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫: ${process.env.DB_NAME}\n`);

    console.log("üöÄ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏: –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤\n");


    console.log("üì¶ –°–æ–∑–¥–∞—ë–º ENUM —Ç–∏–ø–æ–≤ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö...");
    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_component_type') THEN
          CREATE TYPE "enum_beryll_component_type" AS ENUM (
            'CPU', 'RAM', 'SSD', 'HDD', 'NVME',
            'NIC', 'MOTHERBOARD', 'PSU', 'GPU',
            'RAID', 'BMC', 'OTHER'
          );
        END IF;
      END$$;
    `);


    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_component_status') THEN
          CREATE TYPE "enum_beryll_component_status" AS ENUM (
            'OK', 'WARNING', 'CRITICAL', 'UNKNOWN'
          );
        END IF;
      END$$;
    `);
    console.log("‚úÖ ENUM —Ç–∏–ø—ã —Å–æ–∑–¥–∞–Ω—ã\n");


    console.log("üíæ –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É beryll_server_components...");
    await sequelize.query(`
      CREATE TABLE IF NOT EXISTS beryll_server_components (
        id SERIAL PRIMARY KEY,
        "serverId" INTEGER NOT NULL REFERENCES beryll_servers(id) ON UPDATE CASCADE ON DELETE CASCADE,

        -- –¢–∏–ø –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        "componentType" "enum_beryll_component_type" NOT NULL,
        "slot" VARCHAR(50),

        -- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –∏ –º–æ–¥–µ–ª—å
        "manufacturer" VARCHAR(255),
        "model" VARCHAR(255),
        "serialNumber" VARCHAR(255),
        "partNumber" VARCHAR(255),

        -- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–æ–±—â–∏–µ)
        "capacity" VARCHAR(50),
        "capacityBytes" BIGINT,

        -- –î–ª—è CPU
        "cores" INTEGER,
        "threads" INTEGER,
        "speedMHz" INTEGER,
        "architecture" VARCHAR(50),

        -- –î–ª—è RAM
        "memoryType" VARCHAR(50),
        "speedMT" INTEGER,
        "rank" INTEGER,

        -- –î–ª—è –¥–∏—Å–∫–æ–≤
        "mediaType" VARCHAR(50),
        "interface" VARCHAR(50),
        "firmwareVersion" VARCHAR(100),

        -- –î–ª—è NIC
        "macAddress" VARCHAR(17),
        "linkSpeed" VARCHAR(50),

        -- –°—Ç–∞—Ç—É—Å –∏ –∑–¥–æ—Ä–æ–≤—å–µ
        "status" "enum_beryll_component_status" DEFAULT 'UNKNOWN',
        "health" VARCHAR(50),
        "healthRollup" VARCHAR(50),

        -- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ BMC (JSON)
        "rawData" JSONB,

        -- –ú–µ—Ç–∞
        "fetchedAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        "fetchedById" INTEGER REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        "createdAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        "updatedAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
      );
    `);


    console.log("üìá –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å—ã...");
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_components_server ON beryll_server_components("serverId");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_components_type ON beryll_server_components("componentType");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_components_serial ON beryll_server_components("serialNumber");`);
    console.log("‚úÖ –¢–∞–±–ª–∏—Ü–∞ beryll_server_components —Å–æ–∑–¥–∞–Ω–∞\n");


    console.log("üìù –î–æ–±–∞–≤–ª—è–µ–º action —Ç–∏–ø COMPONENTS_FETCHED...");
    await sequelize.query(`
      DO $$
      BEGIN
        ALTER TYPE "enum_beryll_history_action" ADD VALUE IF NOT EXISTS 'COMPONENTS_FETCHED';
      EXCEPTION
        WHEN duplicate_object THEN NULL;
      END$$;
    `);
    console.log("‚úÖ Action —Ç–∏–ø –¥–æ–±–∞–≤–ª–µ–Ω\n");


    console.log("üîß –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ bmcAddress –≤ beryll_servers...");
    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "bmcAddress" VARCHAR(255);
    `);
    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "lastComponentsFetchAt" TIMESTAMP;
    `);
    console.log("‚úÖ –ü–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã\n");

    console.log("==================================================");
    console.log("‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!");
    console.log("==================================================\n");


    const [tables] = await sequelize.query(`
      SELECT table_name FROM information_schema.tables
      WHERE table_schema = 'public' AND table_name LIKE 'beryll%'
      ORDER BY table_name;
    `);
    console.log("üìã –¢–∞–±–ª–∏—Ü—ã Beryll:");
    tables.forEach(t => console.log(`  - ${t.table_name}`));

  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:", error.message);
    console.error(error);
  } finally {
    await sequelize.close();
    console.log("\nüîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
  }
}

runMigration();

================================================================================
FILE: QMS-Server-master/migrations/seeders/20260121-seed-defect-categories.js
================================================================================

'use strict';


module.exports = {
  async up(queryInterface, Sequelize) {
    const now = new Date();


    const ALL_BOARDS = ["FC", "ELRS_915", "ELRS_2_4", "CORAL_B", "SMARAGD"];
    const SMALL_BOARDS = ["FC", "ELRS_915", "ELRS_2_4", "CORAL_B"];
    const RF_BOARDS = ["ELRS_915", "ELRS_2_4", "CORAL_B"];
    const SMARAGD_ONLY = ["SMARAGD"];

    await queryInterface.bulkInsert('defect_categories', [


      {
        code: 'SOLDER_DEFECT',
        title: '–î–µ—Ñ–µ–∫—Ç –ø–∞–π–∫–∏',
        description: '–•–æ–ª–æ–¥–Ω–∞—è –ø–∞–π–∫–∞, –ø–µ—Ä–µ–º—ã—á–∫–∏, –Ω–µ–ø—Ä–æ–ø–∞–π, —à–∞—Ä–∏–∫–∏ –ø—Ä–∏–ø–æ—è',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'VISUAL_DAMAGE',
        title: '–í–∏–∑—É–∞–ª—å–Ω—ã–π –¥–µ—Ñ–µ–∫—Ç',
        description: '–¶–∞—Ä–∞–ø–∏–Ω—ã, —Å–∫–æ–ª—ã, —Ç—Ä–µ—â–∏–Ω—ã –Ω–∞ –ø–ª–∞—Ç–µ –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö',
        severity: 'MINOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'COMPONENT_DAMAGE',
        title: '–ü–æ–≤—Ä–µ–∂–¥—ë–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç',
        description: '–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–µ –∏–ª–∏ —Ç–µ—Ä–º–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'COMPONENT_MISSING',
        title: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç',
        description: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –æ—Ç–≤–∞–ª–∏–ª—Å—è',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'WRONG_COMPONENT',
        title: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç',
        description: '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ —Ç–æ–≥–æ –Ω–æ–º–∏–Ω–∞–ª–∞ –∏–ª–∏ —Ç–∏–ø–∞',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'ESD_DAMAGE',
        title: '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ ESD',
        description: '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ–º',
        severity: 'CRITICAL',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'TEST_FAIL',
        title: '–ù–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–µ—Å—Ç—ã',
        description: '–ü—Ä–æ–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        code: 'FIRMWARE_FAIL',
        title: '–ù–µ –ø—Ä–æ—à–∏–≤–∞–µ—Ç—Å—è',
        description: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—à–∏–≤–∫–µ firmware, –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ç–æ—Ä–æ–º',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'NO_SERIAL',
        title: '–ù–µ—Ç —Å–µ—Ä–∏–π–Ω–∏–∫–∞',
        description: '–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
        severity: 'MINOR',
        applicableTypes: JSON.stringify(["FC"]),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'USB_FAIL',
        title: '–ù–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ USB',
        description: '–ü–ª–∞—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ USB',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        code: 'RF_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–¥–∏–æ—á–∞—Å—Ç—å—é',
        description: '–°–ª–∞–±—ã–π —Å–∏–≥–Ω–∞–ª, –Ω–µ—Ç —Å–≤—è–∑–∏, –ø–æ–º–µ—Ö–∏',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(RF_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'ANTENNA_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –∞–Ω—Ç–µ–Ω–Ω–æ–π',
        description: '–î–µ—Ñ–µ–∫—Ç —Ä–∞–∑—ä—ë–º–∞ –∞–Ω—Ç–µ–Ω–Ω—ã –∏–ª–∏ —Å–∞–º–æ–π –∞–Ω—Ç–µ–Ω–Ω—ã',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(RF_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'BINDING_FAIL',
        title: '–ù–µ –±–∏–Ω–¥–∏—Ç—Å—è',
        description: '–ù–µ —É–¥–∞—ë—Ç—Å—è —Å–≤—è–∑–∞—Ç—å –ø—Ä–∏—ë–º–Ω–∏–∫ —Å –ø–µ—Ä–µ–¥–∞—Ç—á–∏–∫–æ–º',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(RF_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        code: 'HDD_SSD_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–∏—Å–∫–æ–º',
        description: '–î–∏—Å–∫ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è, –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'DISPLAY_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–∏—Å–ø–ª–µ–µ–º',
        description: '–ë–∏—Ç—ã–µ –ø–∏–∫—Å–µ–ª–∏, –ø–æ–ª–æ—Å—ã, –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è, –∑–∞—Å–≤–µ—Ç—ã',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'KEYBOARD_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π',
        description: '–ù–µ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–ª–∞–≤–∏—à–∏, –∑–∞–ª–∏–ø–∞–Ω–∏–µ, –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'CABLE_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞–±–µ–ª–µ–º/—à–ª–µ–π—Ñ–æ–º',
        description: '–ü–æ–≤—Ä–µ–∂–¥—ë–Ω –∏–ª–∏ –Ω–µ–∏—Å–ø—Ä–∞–≤–µ–Ω –∫–∞–±–µ–ª—å, —à–ª–µ–π—Ñ',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'BOARD_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–ª–∞—Ç–æ–π',
        description: '–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–∞ –ø–ª–∞—Ç–∞ (–ø—Ä–∏—Å–µ–ª–µ–∫—Ç–æ—Ä, –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∏ —Ç.–¥.)',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'POWER_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ –ø–∏—Ç–∞–Ω–∏—è',
        description: '–ù–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è, –ø—Ä–æ–±–ª–µ–º–∞ —Å –ë–ü –∏–ª–∏ –±–∞—Ç–∞—Ä–µ–µ–π',
        severity: 'CRITICAL',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'MEMORY_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–∞–º—è—Ç—å—é',
        description: '–û–ó–£ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–ª–∏ —Å –æ—à–∏–±–∫–∞–º–∏',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        code: 'NETWORK_ISSUE',
        title: '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é',
        description: '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç Ethernet –∏–ª–∏ WiFi',
        severity: 'MAJOR',
        applicableTypes: JSON.stringify(SMARAGD_ONLY),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        code: 'OTHER',
        title: '–ü—Ä–æ—á–µ–µ',
        description: '–î—Ä—É–≥–∏–µ –¥–µ—Ñ–µ–∫—Ç—ã, –Ω–µ –ø–æ–ø–∞–¥–∞—é—â–∏–µ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
        severity: 'MINOR',
        applicableTypes: JSON.stringify(ALL_BOARDS),
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
    ]);
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.bulkDelete('defect_categories', null, {});
  }
};

================================================================================
FILE: QMS-Server-master/models/BeryllExtended.js
================================================================================



const sequelize = require("../../db");
const { DataTypes } = require("sequelize");


const RACK_STATUSES = {
  ACTIVE: "ACTIVE",
  MAINTENANCE: "MAINTENANCE",
  DECOMMISSIONED: "DECOMMISSIONED"
};

const CLUSTER_STATUSES = {
  FORMING: "FORMING",
  READY: "READY",
  SHIPPED: "SHIPPED",
  DEPLOYED: "DEPLOYED"
};

const SHIPMENT_STATUSES = {
  FORMING: "FORMING",
  READY: "READY",
  SHIPPED: "SHIPPED",
  IN_TRANSIT: "IN_TRANSIT",
  DELIVERED: "DELIVERED",
  ACCEPTED: "ACCEPTED"
};

const SERVER_ROLES = {
  MASTER: "MASTER",
  WORKER: "WORKER",
  STORAGE: "STORAGE",
  GATEWAY: "GATEWAY"
};

const REPAIR_PART_TYPES = {
  RAM: "RAM",
  MOTHERBOARD: "MOTHERBOARD",
  CPU: "CPU",
  HDD: "HDD",
  SSD: "SSD",
  PSU: "PSU",
  FAN: "FAN",
  RAID: "RAID",
  NIC: "NIC",
  BACKPLANE: "BACKPLANE",
  BMC: "BMC",
  CABLE: "CABLE",
  OTHER: "OTHER"
};

const DEFECT_RECORD_STATUSES = {
  NEW: "NEW",
  DIAGNOSING: "DIAGNOSING",
  WAITING_PARTS: "WAITING_PARTS",
  REPAIRING: "REPAIRING",
  SENT_TO_YADRO: "SENT_TO_YADRO",
  RETURNED: "RETURNED",
  RESOLVED: "RESOLVED",
  REPEATED: "REPEATED",
  CLOSED: "CLOSED"
};


const BeryllRack = sequelize.define("BeryllRack", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },


  name: {
    type: DataTypes.STRING(100),
    allowNull: false,
    unique: true
  },


  location: {
    type: DataTypes.STRING(255),
    allowNull: true
  },


  totalUnits: {
    type: DataTypes.INTEGER,
    allowNull: false,
    defaultValue: 42
  },


  networkSubnet: {
    type: DataTypes.STRING(50),
    allowNull: true
  },

  gateway: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  status: {
    type: DataTypes.ENUM(...Object.values(RACK_STATUSES)),
    allowNull: false,
    defaultValue: RACK_STATUSES.ACTIVE
  },


  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  }
}, {
  tableName: "beryll_racks",
  timestamps: true,
  indexes: [
    { fields: ["name"] },
    { fields: ["status"] },
    { fields: ["location"] }
  ]
});


const BeryllRackUnit = sequelize.define("BeryllRackUnit", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },


  rackId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_racks",
      key: "id"
    }
  },


  serverId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },


  unitNumber: {
    type: DataTypes.INTEGER,
    allowNull: false
  },


  hostname: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  mgmtMacAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },

  mgmtIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  dataMacAddress: {
    type: DataTypes.TEXT,
    allowNull: true
  },

  dataIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  accessLogin: {
    type: DataTypes.STRING(100),
    allowNull: true
  },

  accessPassword: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  installedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  installedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_rack_units",
  timestamps: true,
  indexes: [
    { fields: ["rackId"] },
    { fields: ["serverId"] },
    { fields: ["unitNumber"] },
    { unique: true, fields: ["rackId", "unitNumber"] },
    { fields: ["hostname"] }
  ]
});


const BeryllShipment = sequelize.define("BeryllShipment", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },


  name: {
    type: DataTypes.STRING(200),
    allowNull: false
  },


  destinationCity: {
    type: DataTypes.STRING(200),
    allowNull: true
  },


  destinationAddress: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  contactPerson: {
    type: DataTypes.STRING(200),
    allowNull: true
  },


  contactPhone: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  expectedCount: {
    type: DataTypes.INTEGER,
    allowNull: true,
    defaultValue: 80
  },


  status: {
    type: DataTypes.ENUM(...Object.values(SHIPMENT_STATUSES)),
    allowNull: false,
    defaultValue: SHIPMENT_STATUSES.FORMING
  },


  plannedShipDate: {
    type: DataTypes.DATEONLY,
    allowNull: true
  },

  actualShipDate: {
    type: DataTypes.DATEONLY,
    allowNull: true
  },

  deliveredAt: {
    type: DataTypes.DATE,
    allowNull: true
  },

  acceptedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  waybillNumber: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  carrier: {
    type: DataTypes.STRING(200),
    allowNull: true
  },


  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  createdById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  }
}, {
  tableName: "beryll_shipments",
  timestamps: true,
  indexes: [
    { fields: ["name"] },
    { fields: ["status"] },
    { fields: ["destinationCity"] },
    { fields: ["plannedShipDate"] }
  ]
});


const BeryllCluster = sequelize.define("BeryllCluster", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },


  name: {
    type: DataTypes.STRING(100),
    allowNull: false
  },


  description: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  shipmentId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: "beryll_shipments",
      key: "id"
    }
  },


  expectedCount: {
    type: DataTypes.INTEGER,
    allowNull: true,
    defaultValue: 10
  },


  status: {
    type: DataTypes.ENUM(...Object.values(CLUSTER_STATUSES)),
    allowNull: false,
    defaultValue: CLUSTER_STATUSES.FORMING
  },


  configVersion: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  createdById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  }
}, {
  tableName: "beryll_clusters",
  timestamps: true,
  indexes: [
    { fields: ["name"] },
    { fields: ["shipmentId"] },
    { fields: ["status"] }
  ]
});


const BeryllClusterServer = sequelize.define("BeryllClusterServer", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },


  clusterId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_clusters",
      key: "id"
    }
  },


  serverId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },


  role: {
    type: DataTypes.ENUM(...Object.values(SERVER_ROLES)),
    allowNull: false,
    defaultValue: SERVER_ROLES.WORKER
  },


  orderNumber: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  clusterHostname: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  clusterIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  addedAt: {
    type: DataTypes.DATE,
    allowNull: true,
    defaultValue: DataTypes.NOW
  },


  addedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_cluster_servers",
  timestamps: true,
  indexes: [
    { fields: ["clusterId"] },
    { fields: ["serverId"] },
    { unique: true, fields: ["clusterId", "serverId"] },
    { fields: ["role"] }
  ]
});


const BeryllDefectRecord = sequelize.define("BeryllDefectRecord", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },


  serverId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },


  yadroTicketNumber: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  hasSPISI: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },


  clusterCode: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  problemDescription: {
    type: DataTypes.TEXT,
    allowNull: false
  },


  detectedAt: {
    type: DataTypes.DATE,
    allowNull: false,
    defaultValue: DataTypes.NOW
  },


  detectedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  diagnosticianId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  repairPartType: {
    type: DataTypes.ENUM(...Object.values(REPAIR_PART_TYPES)),
    allowNull: true
  },


  defectPartSerialYadro: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  defectPartSerialManuf: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  replacementPartSerialYadro: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  replacementPartSerialManuf: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  repairDetails: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  status: {
    type: DataTypes.ENUM(...Object.values(DEFECT_RECORD_STATUSES)),
    allowNull: false,
    defaultValue: DEFECT_RECORD_STATUSES.NEW
  },


  isRepeatedDefect: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },


  repeatedDefectReason: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  repeatedDefectDate: {
    type: DataTypes.DATE,
    allowNull: true
  },


  sentToYadroRepair: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },


  sentToYadroAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  returnedFromYadro: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },


  returnedFromYadroAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  substituteServerSerial: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  resolvedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  resolvedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  resolution: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  }
}, {
  tableName: "beryll_defect_records",
  timestamps: true,
  indexes: [
    { fields: ["serverId"] },
    { fields: ["yadroTicketNumber"] },
    { fields: ["status"] },
    { fields: ["detectedAt"] },
    { fields: ["repairPartType"] },
    { fields: ["diagnosticianId"] },
    { fields: ["isRepeatedDefect"] }
  ]
});


const BeryllDefectRecordFile = sequelize.define("BeryllDefectRecordFile", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },

  defectRecordId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_defect_records",
      key: "id"
    }
  },

  originalName: {
    type: DataTypes.STRING(255),
    allowNull: false
  },

  fileName: {
    type: DataTypes.STRING(255),
    allowNull: false
  },

  filePath: {
    type: DataTypes.STRING(500),
    allowNull: false
  },

  mimeType: {
    type: DataTypes.STRING(100),
    allowNull: true
  },

  fileSize: {
    type: DataTypes.INTEGER,
    allowNull: true
  },

  uploadedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_defect_record_files",
  timestamps: true,
  indexes: [
    { fields: ["defectRecordId"] }
  ]
});


const BeryllExtendedHistory = sequelize.define("BeryllExtendedHistory", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },


  entityType: {
    type: DataTypes.ENUM("RACK", "CLUSTER", "SHIPMENT", "DEFECT_RECORD"),
    allowNull: false
  },


  entityId: {
    type: DataTypes.INTEGER,
    allowNull: false
  },


  action: {
    type: DataTypes.STRING(50),
    allowNull: false
  },


  userId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  comment: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  changes: {
    type: DataTypes.JSONB,
    allowNull: true
  },


  metadata: {
    type: DataTypes.JSONB,
    allowNull: true
  }
}, {
  tableName: "beryll_extended_history",
  timestamps: true,
  indexes: [
    { fields: ["entityType", "entityId"] },
    { fields: ["userId"] },
    { fields: ["createdAt"] }
  ]
});


const setupExtendedAssociations = (models) => {
  const { User, BeryllServer } = models;


  BeryllRack.hasMany(BeryllRackUnit, { as: "units", foreignKey: "rackId", onDelete: "CASCADE" });
  BeryllRackUnit.belongsTo(BeryllRack, { as: "rack", foreignKey: "rackId" });

  BeryllRackUnit.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });
  if (BeryllServer.hasMany) {
    BeryllServer.hasMany(BeryllRackUnit, { as: "rackUnits", foreignKey: "serverId" });
  }

  BeryllRackUnit.belongsTo(User, { as: "installedBy", foreignKey: "installedById" });


  BeryllShipment.belongsTo(User, { as: "createdBy", foreignKey: "createdById" });
  BeryllShipment.hasMany(BeryllCluster, { as: "clusters", foreignKey: "shipmentId" });


  BeryllCluster.belongsTo(BeryllShipment, { as: "shipment", foreignKey: "shipmentId" });
  BeryllCluster.belongsTo(User, { as: "createdBy", foreignKey: "createdById" });
  BeryllCluster.hasMany(BeryllClusterServer, { as: "clusterServers", foreignKey: "clusterId", onDelete: "CASCADE" });


  BeryllClusterServer.belongsTo(BeryllCluster, { as: "cluster", foreignKey: "clusterId" });
  BeryllClusterServer.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });
  BeryllClusterServer.belongsTo(User, { as: "addedBy", foreignKey: "addedById" });

  if (BeryllServer.hasMany) {
    BeryllServer.hasMany(BeryllClusterServer, { as: "clusterMemberships", foreignKey: "serverId" });
  }


  BeryllDefectRecord.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });
  BeryllDefectRecord.belongsTo(User, { as: "detectedBy", foreignKey: "detectedById" });
  BeryllDefectRecord.belongsTo(User, { as: "diagnostician", foreignKey: "diagnosticianId" });
  BeryllDefectRecord.belongsTo(User, { as: "resolvedBy", foreignKey: "resolvedById" });
  BeryllDefectRecord.hasMany(BeryllDefectRecordFile, { as: "files", foreignKey: "defectRecordId", onDelete: "CASCADE" });

  if (BeryllServer.hasMany) {
    BeryllServer.hasMany(BeryllDefectRecord, { as: "defectRecords", foreignKey: "serverId" });
  }


  BeryllDefectRecordFile.belongsTo(BeryllDefectRecord, { as: "defectRecord", foreignKey: "defectRecordId" });
  BeryllDefectRecordFile.belongsTo(User, { as: "uploadedBy", foreignKey: "uploadedById" });


  BeryllExtendedHistory.belongsTo(User, { as: "user", foreignKey: "userId" });
};


module.exports = {

  BeryllRack,
  BeryllRackUnit,
  BeryllShipment,
  BeryllCluster,
  BeryllClusterServer,
  BeryllDefectRecord,
  BeryllDefectRecordFile,
  BeryllExtendedHistory,


  RACK_STATUSES,
  CLUSTER_STATUSES,
  SHIPMENT_STATUSES,
  SERVER_ROLES,
  REPAIR_PART_TYPES,
  DEFECT_RECORD_STATUSES,


  setupExtendedAssociations
};

================================================================================
FILE: QMS-Server-master/models/ProductionOutput.js
================================================================================



const { DataTypes } = require("sequelize");
const sequelize = require("../db");


const OUTPUT_STATUSES = {
    PENDING: 'pending',
    APPROVED: 'approved',
    REJECTED: 'rejected',
    ADJUSTED: 'adjusted'
};


const OperationType = sequelize.define("operation_type", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },

    name: {
        type: DataTypes.STRING(100),
        allowNull: false
    },

    code: {
        type: DataTypes.STRING(50),
        allowNull: true
    },

    description: {
        type: DataTypes.TEXT,
        allowNull: true
    },

    unit: {
        type: DataTypes.STRING(20),
        allowNull: false,
        defaultValue: '—à—Ç'
    },


    normMinutes: {
        type: DataTypes.FLOAT,
        allowNull: true
    },


    sectionId: {
        type: DataTypes.INTEGER,
        allowNull: true
    },

    isActive: {
        type: DataTypes.BOOLEAN,
        defaultValue: true
    },

    sortOrder: {
        type: DataTypes.INTEGER,
        defaultValue: 0
    }
}, {
    tableName: "operation_types",
    timestamps: true,
    indexes: [
        { unique: true, fields: ["code"], where: { code: { [require("sequelize").Op.ne]: null } } }
    ]
});


const ProductionOutput = sequelize.define("production_output", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },


    date: {
        type: DataTypes.DATEONLY,
        allowNull: false
    },


    userId: {
        type: DataTypes.INTEGER,
        allowNull: false
    },


    teamId: {
        type: DataTypes.INTEGER,
        allowNull: true
    },

    sectionId: {
        type: DataTypes.INTEGER,
        allowNull: true
    },


    projectId: {
        type: DataTypes.INTEGER,
        allowNull: true
    },

    taskId: {
        type: DataTypes.INTEGER,
        allowNull: true
    },

    operationTypeId: {
        type: DataTypes.INTEGER,
        allowNull: true
    },


    claimedQty: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0
    },

    approvedQty: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0
    },

    rejectedQty: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0
    },


    status: {
        type: DataTypes.STRING(20),
        allowNull: false,
        defaultValue: OUTPUT_STATUSES.PENDING
    },


    approvedById: {
        type: DataTypes.INTEGER,
        allowNull: true
    },

    approvedAt: {
        type: DataTypes.DATE,
        allowNull: true
    },


    createdById: {
        type: DataTypes.INTEGER,
        allowNull: true
    },


    comment: {
        type: DataTypes.TEXT,
        allowNull: true
    },

    rejectReason: {
        type: DataTypes.TEXT,
        allowNull: true
    }

}, {
    tableName: "production_outputs",
    timestamps: true,
    indexes: [
        { fields: ["userId", "date"] },
        { fields: ["date"] },
        { fields: ["status"] },
        { fields: ["projectId"] },
        { fields: ["taskId"] },
        { fields: ["teamId"] },
        { fields: ["sectionId"] },
        { fields: ["operationTypeId"] }
    ]
});

module.exports = {
    ProductionOutput,
    OperationType,
    OUTPUT_STATUSES
};

================================================================================
FILE: QMS-Server-master/models/beryll/BeryllDefectRecordFile.js
================================================================================

const { DataTypes } = require("sequelize");

module.exports = (sequelize) => {
    const BeryllDefectRecordFile = sequelize.define(
        "BeryllDefectRecordFile",
        {
            id: {
                type: DataTypes.INTEGER,
                primaryKey: true,
                autoIncrement: true
            },
            defectRecordId: {
                type: DataTypes.INTEGER,
                allowNull: false,
                field: "defect_record_id",
                references: {
                    model: "beryll_defect_records",
                    key: "id"
                },
                onDelete: "CASCADE"
            },
            fileName: {
                type: DataTypes.STRING(255),
                allowNull: false,
                field: "file_name",
                comment: "–ò–º—è —Ñ–∞–π–ª–∞ –Ω–∞ –¥–∏—Å–∫–µ"
            },
            originalName: {
                type: DataTypes.STRING(255),
                allowNull: false,
                field: "original_name",
                comment: "–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞"
            },
            filePath: {
                type: DataTypes.STRING(500),
                allowNull: false,
                field: "file_path",
                comment: "–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É"
            },
            mimeType: {
                type: DataTypes.STRING(100),
                allowNull: true,
                field: "mime_type",
                comment: "MIME-—Ç–∏–ø —Ñ–∞–π–ª–∞"
            },
            fileSize: {
                type: DataTypes.INTEGER,
                allowNull: true,
                field: "file_size",
                comment: "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö"
            },
            uploadedById: {
                type: DataTypes.INTEGER,
                allowNull: true,
                field: "uploaded_by_id",
                references: {
                    model: "users",
                    key: "id"
                },
                onDelete: "SET NULL"
            }
        },
        {
            tableName: "beryll_defect_record_files",
            timestamps: true,
            underscored: true,
            indexes: [
                { fields: ["defect_record_id"] },
                { fields: ["uploaded_by_id"] }
            ]
        }
    );

    return BeryllDefectRecordFile;
};
================================================================================
FILE: QMS-Server-master/models/definitions/Assembly.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");


const AssemblyRecipe = sequelize.define("assembly_recipe", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  projectId: { type: DataTypes.INTEGER, allowNull: false },
  title: { type: DataTypes.STRING, allowNull: false },
  description: { type: DataTypes.TEXT },
});


const RecipeStep = sequelize.define("recipe_step", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  recipeId: { type: DataTypes.INTEGER, allowNull: false },
  order: { type: DataTypes.INTEGER, allowNull: false },
  title: { type: DataTypes.STRING, allowNull: false },
  quantity: { type: DataTypes.INTEGER, defaultValue: 1 },
  description: { type: DataTypes.TEXT },
});


const AssemblyProcess = sequelize.define("assembly_process", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  boxId: { type: DataTypes.INTEGER, allowNull: false },
  recipeId: { type: DataTypes.INTEGER, allowNull: false },


  completedSteps: {
      type: DataTypes.JSONB,
      defaultValue: []
  },

  status: { type: DataTypes.STRING, defaultValue: "IN_PROGRESS" },
  startTime: { type: DataTypes.DATE, defaultValue: DataTypes.NOW },
  endTime: { type: DataTypes.DATE },
});

module.exports = { AssemblyRecipe, RecipeStep, AssemblyProcess };

================================================================================
FILE: QMS-Server-master/models/definitions/Beryll.js
================================================================================



const sequelize = require("../../db");
const { DataTypes } = require("sequelize");


const SERVER_STATUSES = {
  NEW: "NEW",
  IN_WORK: "IN_WORK",
  CLARIFYING: "CLARIFYING",
  DEFECT: "DEFECT",
  DONE: "DONE",
  ARCHIVED: "ARCHIVED"
};

const BATCH_STATUSES = {
  ACTIVE: "ACTIVE",
  COMPLETED: "COMPLETED",
  CANCELLED: "CANCELLED"
};

const HISTORY_ACTIONS = {
  CREATED: "CREATED",
  TAKEN: "TAKEN",
  RELEASED: "RELEASED",
  STATUS_CHANGED: "STATUS_CHANGED",
  NOTE_ADDED: "NOTE_ADDED",
  CHECKLIST_COMPLETED: "CHECKLIST_COMPLETED",
  BATCH_ASSIGNED: "BATCH_ASSIGNED",
  BATCH_REMOVED: "BATCH_REMOVED",
  DELETED: "DELETED",
  ARCHIVED: "ARCHIVED",
  FILE_UPLOADED: "FILE_UPLOADED",
  SERIAL_ASSIGNED: "SERIAL_ASSIGNED",
  COMPONENTS_FETCHED: "COMPONENTS_FETCHED"
};

const CHECKLIST_GROUPS = {
  PREPARATION: "PREPARATION",
  ASSEMBLY: "ASSEMBLY",
  TESTING: "TESTING",
  BURN_IN: "BURN_IN",
  FINAL: "FINAL"
};


const DEFECT_CATEGORIES = {
  HARDWARE: "HARDWARE",
  SOFTWARE: "SOFTWARE",
  ASSEMBLY: "ASSEMBLY",
  COMPONENT: "COMPONENT",
  OTHER: "OTHER"
};

const DEFECT_PRIORITIES = {
  LOW: "LOW",
  MEDIUM: "MEDIUM",
  HIGH: "HIGH",
  CRITICAL: "CRITICAL"
};

const DEFECT_STATUSES = {
  NEW: "NEW",
  IN_PROGRESS: "IN_PROGRESS",
  RESOLVED: "RESOLVED",
  WONT_FIX: "WONT_FIX"
};


const COMPONENT_TYPES = {
  CPU: "CPU",
  RAM: "RAM",
  HDD: "HDD",
  SSD: "SSD",
  NVME: "NVME",
  MOTHERBOARD: "MOTHERBOARD",
  GPU: "GPU",
  NIC: "NIC",
  RAID: "RAID",
  PSU: "PSU",
  FAN: "FAN",
  MEMORY_MODULE: "MEMORY_MODULE",
  BACKPLANE: "BACKPLANE",
  BMC: "BMC",
  OTHER: "OTHER"
};


const COMPONENT_STATUSES = {
  OK: "OK",
  WARNING: "WARNING",
  CRITICAL: "CRITICAL",
  UNKNOWN: "UNKNOWN",
  NOT_PRESENT: "NOT_PRESENT",
  REPLACED: "REPLACED"
};


const RACK_STATUSES = {
  ACTIVE: "ACTIVE",
  MAINTENANCE: "MAINTENANCE",
  DECOMMISSIONED: "DECOMMISSIONED"
};


const BeryllBatch = sequelize.define("BeryllBatch", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  title: {
    type: DataTypes.STRING(255),
    allowNull: false
  },
  supplier: {
    type: DataTypes.STRING(255),
    allowNull: true
  },
  deliveryDate: {
    type: DataTypes.DATEONLY,
    allowNull: true
  },
  status: {
    type: DataTypes.ENUM(...Object.values(BATCH_STATUSES)),
    allowNull: false,
    defaultValue: BATCH_STATUSES.ACTIVE
  },
  expectedCount: {
    type: DataTypes.INTEGER,
    allowNull: true,
    defaultValue: 0
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  completedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  createdById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_batches",
  timestamps: true
});


const BeryllServer = sequelize.define("BeryllServer", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },


  ipAddress: {
    type: DataTypes.STRING(45),
    allowNull: true
  },


  macAddress: {
    type: DataTypes.STRING(17),
    allowNull: true
  },


  hostname: {
    type: DataTypes.STRING(255),
    allowNull: true
  },


  serialNumber: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  apkSerialNumber: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  bmcAddress: {
    type: DataTypes.STRING(45),
    allowNull: true
  },


  status: {
    type: DataTypes.ENUM(...Object.values(SERVER_STATUSES)),
    allowNull: false,
    defaultValue: SERVER_STATUSES.NEW
  },


  batchId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: "beryll_batches",
      key: "id"
    }
  },


  assignedToId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  assignedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  leaseStart: {
    type: DataTypes.DATE,
    allowNull: true
  },


  leaseEnd: {
    type: DataTypes.DATE,
    allowNull: true
  },


  leaseActive: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  },


  lastSyncAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  completedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  archivedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  archivedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  burnInStartAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  burnInEndAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  lastPingAt: {
    type: DataTypes.DATE,
    allowNull: true
  },

  pingStatus: {
    type: DataTypes.ENUM("ONLINE", "OFFLINE", "UNKNOWN"),
    allowNull: true,
    defaultValue: "UNKNOWN"
  },

  pingLatency: {
    type: DataTypes.FLOAT,
    allowNull: true
  },


  lastComponentsFetchAt: {
    type: DataTypes.DATE,
    allowNull: true
  }
}, {
  tableName: "beryll_servers",
  timestamps: true
});


const BeryllHistory = sequelize.define("BeryllHistory", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  serverId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },
  serverIp: {
    type: DataTypes.STRING(45),
    allowNull: true
  },
  serverHostname: {
    type: DataTypes.STRING(255),
    allowNull: true
  },
  userId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  action: {
    type: DataTypes.ENUM(...Object.values(HISTORY_ACTIONS)),
    allowNull: false
  },
  fromStatus: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  toStatus: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  checklistItemId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  comment: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  metadata: {
    type: DataTypes.JSONB,
    allowNull: true
  },
  durationMinutes: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_history",
  timestamps: true,
  updatedAt: false
});


const BeryllChecklistTemplate = sequelize.define("BeryllChecklistTemplate", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  groupCode: {
    type: DataTypes.ENUM(...Object.values(CHECKLIST_GROUPS)),
    allowNull: false,
    defaultValue: CHECKLIST_GROUPS.TESTING
  },
  title: {
    type: DataTypes.STRING(255),
    allowNull: false
  },
  description: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  fileCode: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  requiresFile: {
    type: DataTypes.BOOLEAN,
    defaultValue: false
  },
  sortOrder: {
    type: DataTypes.INTEGER,
    defaultValue: 0
  },
  isRequired: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  },
  estimatedMinutes: {
    type: DataTypes.INTEGER,
    defaultValue: 0
  },
  isActive: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  }
}, {
  tableName: "beryll_checklist_templates",
  timestamps: true
});


const BeryllServerChecklist = sequelize.define("BeryllServerChecklist", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  serverId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },
  checklistTemplateId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_checklist_templates",
      key: "id"
    }
  },
  completed: {
    type: DataTypes.BOOLEAN,
    defaultValue: false
  },
  completedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  completedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  }
}, {
  tableName: "beryll_server_checklists",
  timestamps: true,
  indexes: [
    { unique: true, fields: ["serverId", "checklistTemplateId"] }
  ]
});


const BeryllChecklistFile = sequelize.define("BeryllChecklistFile", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  serverChecklistId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_server_checklists",
      key: "id"
    }
  },
  originalName: {
    type: DataTypes.STRING(255),
    allowNull: false
  },
  fileName: {
    type: DataTypes.STRING(255),
    allowNull: false
  },
  filePath: {
    type: DataTypes.STRING(500),
    allowNull: false
  },
  mimeType: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  fileSize: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  uploadedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_checklist_files",
  timestamps: true
});


const BeryllDefectComment = sequelize.define("BeryllDefectComment", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  serverId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },
  userId: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  text: {
    type: DataTypes.TEXT,
    allowNull: false
  },
  defectCategory: {
    type: DataTypes.ENUM(...Object.values(DEFECT_CATEGORIES)),
    allowNull: true,
    defaultValue: DEFECT_CATEGORIES.OTHER
  },
  priority: {
    type: DataTypes.ENUM(...Object.values(DEFECT_PRIORITIES)),
    allowNull: true,
    defaultValue: DEFECT_PRIORITIES.MEDIUM
  },
  status: {
    type: DataTypes.ENUM(...Object.values(DEFECT_STATUSES)),
    allowNull: false,
    defaultValue: DEFECT_STATUSES.NEW
  },
  resolvedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  resolvedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  resolution: {
    type: DataTypes.TEXT,
    allowNull: true
  }
}, {
  tableName: "beryll_defect_comments",
  timestamps: true
});


const BeryllDefectFile = sequelize.define("BeryllDefectFile", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  commentId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_defect_comments",
      key: "id"
    }
  },
  originalName: {
    type: DataTypes.STRING(255),
    allowNull: false
  },
  fileName: {
    type: DataTypes.STRING(255),
    allowNull: false
  },
  filePath: {
    type: DataTypes.STRING(500),
    allowNull: false
  },
  mimeType: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  fileSize: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  uploadedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_defect_files",
  timestamps: true
});


const BeryllServerComponent = sequelize.define("BeryllServerComponent", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },


  serverId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },


  componentType: {
    type: DataTypes.ENUM(...Object.values(COMPONENT_TYPES)),
    allowNull: false
  },


  name: {
    type: DataTypes.STRING(255),
    allowNull: false
  },


  manufacturer: {
    type: DataTypes.STRING(255),
    allowNull: true
  },


  model: {
    type: DataTypes.STRING(255),
    allowNull: true
  },


  serialNumber: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  serialNumberYadro: {
    type: DataTypes.STRING(100),
    allowNull: true,
    comment: "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –≤ —Å–∏—Å—Ç–µ–º–µ –Ø–¥—Ä–æ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)"
  },


  partNumber: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  firmwareVersion: {
    type: DataTypes.STRING(100),
    allowNull: true
  },


  status: {
    type: DataTypes.ENUM(...Object.values(COMPONENT_STATUSES)),
    allowNull: false,
    defaultValue: COMPONENT_STATUSES.UNKNOWN
  },


  slot: {
    type: DataTypes.STRING(50),
    allowNull: true
  },


  capacity: {
    type: DataTypes.BIGINT,
    allowNull: true
  },


  speed: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  temperature: {
    type: DataTypes.FLOAT,
    allowNull: true
  },


  healthPercent: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  },


  dataSource: {
    type: DataTypes.STRING(50),
    allowNull: true,
    defaultValue: "MANUAL"
  },


  lastUpdatedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },


  catalogId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  inventoryId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  installedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_server_components",
  timestamps: true,
  indexes: [
    { fields: ["serverId"] },
    { fields: ["componentType"] },
    { fields: ["status"] },
    { fields: ["serialNumberYadro"] },
    { fields: ["serverId", "componentType", "slot"], unique: true }
  ]
});


const BeryllRack = sequelize.define("BeryllRack", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  name: {
    type: DataTypes.STRING(100),
    allowNull: false
  },
  location: {
    type: DataTypes.STRING(255),
    allowNull: true
  },
  totalUnits: {
    type: DataTypes.INTEGER,
    allowNull: false,
    defaultValue: 42
  },
  networkSubnet: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  gateway: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  status: {
    type: DataTypes.ENUM(...Object.values(RACK_STATUSES)),
    allowNull: false,
    defaultValue: RACK_STATUSES.ACTIVE
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  }
}, {
  tableName: "beryll_racks",
  timestamps: true
});


const BeryllRackUnit = sequelize.define("BeryllRackUnit", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  rackId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_racks",
      key: "id"
    }
  },
  serverId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },
  unitNumber: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  hostname: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  mgmtMacAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  mgmtIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  dataMacAddress: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  dataIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  accessLogin: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  accessPassword: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  installedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  installedById: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: "users",
      key: "id"
    }
  },


  placedById: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: "users",
      key: "id"
    }
  },

  placedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  dhcpIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  dhcpMacAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  dhcpHostname: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  dhcpLeaseActive: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },
  dhcpLastSync: {
    type: DataTypes.DATE,
    allowNull: true
  }

}, {
  tableName: "beryll_rack_units",
  timestamps: true,
  indexes: [
    { fields: ["rackId", "unitNumber"], unique: true },
    { fields: ["serverId"] },
    { fields: ["installedById"] },
    { fields: ["placedById"] },
    { fields: ["dhcpIpAddress"] },
    { fields: ["dhcpMacAddress"] }
  ]
});


const BeryllExtendedHistory = sequelize.define("BeryllExtendedHistory", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  entityType: {
    type: DataTypes.STRING(50),
    allowNull: false
  },
  entityId: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  action: {
    type: DataTypes.STRING(50),
    allowNull: false
  },
  userId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  comment: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  changes: {
    type: DataTypes.JSONB,
    allowNull: true
  }
}, {
  tableName: "beryll_extended_history",
  timestamps: true,
  updatedAt: false,
  indexes: [
    { fields: ["entityType", "entityId"] },
    { fields: ["userId"] }
  ]
});


const setupAssociations = (User) => {

  BeryllBatch.belongsTo(User, { as: "createdBy", foreignKey: "createdById" });


  BeryllServer.belongsTo(BeryllBatch, { as: "batch", foreignKey: "batchId" });
  BeryllBatch.hasMany(BeryllServer, { as: "servers", foreignKey: "batchId" });


  BeryllServer.belongsTo(User, { as: "assignedTo", foreignKey: "assignedToId" });


  BeryllServer.belongsTo(User, { as: "archivedBy", foreignKey: "archivedById" });


  BeryllServer.hasMany(BeryllHistory, { as: "history", foreignKey: "serverId" });
  BeryllHistory.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });


  BeryllHistory.belongsTo(User, { as: "user", foreignKey: "userId" });


  BeryllServer.hasMany(BeryllServerChecklist, { as: "checklists", foreignKey: "serverId" });
  BeryllServerChecklist.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });


  BeryllServerChecklist.belongsTo(BeryllChecklistTemplate, { as: "template", foreignKey: "checklistTemplateId" });
  BeryllChecklistTemplate.hasMany(BeryllServerChecklist, { as: "serverChecklists", foreignKey: "checklistTemplateId" });


  BeryllServerChecklist.belongsTo(User, { as: "completedBy", foreignKey: "completedById" });


  BeryllServerChecklist.hasMany(BeryllChecklistFile, { as: "files", foreignKey: "serverChecklistId" });
  BeryllChecklistFile.belongsTo(BeryllServerChecklist, { as: "checklist", foreignKey: "serverChecklistId" });


  BeryllChecklistFile.belongsTo(User, { as: "uploadedBy", foreignKey: "uploadedById" });


  BeryllDefectComment.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });
  BeryllServer.hasMany(BeryllDefectComment, { as: "defectComments", foreignKey: "serverId" });
  BeryllDefectComment.belongsTo(User, { as: "author", foreignKey: "userId" });
  BeryllDefectComment.belongsTo(User, { as: "resolvedBy", foreignKey: "resolvedById" });
  BeryllDefectComment.hasMany(BeryllDefectFile, { as: "files", foreignKey: "commentId", onDelete: "CASCADE" });
  BeryllDefectFile.belongsTo(BeryllDefectComment, { as: "comment", foreignKey: "commentId" });
  BeryllDefectFile.belongsTo(User, { as: "uploadedBy", foreignKey: "uploadedById" });


  BeryllServer.hasMany(BeryllServerComponent, { as: "components", foreignKey: "serverId", onDelete: "CASCADE" });
  BeryllServerComponent.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });


  BeryllRack.hasMany(BeryllRackUnit, { as: "units", foreignKey: "rackId", onDelete: "CASCADE" });
  BeryllRackUnit.belongsTo(BeryllRack, { as: "rack", foreignKey: "rackId" });


  BeryllRackUnit.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });
  BeryllServer.hasOne(BeryllRackUnit, { as: "rackUnit", foreignKey: "serverId" });


  BeryllRackUnit.belongsTo(User, { as: "installedBy", foreignKey: "installedById" });


  BeryllRackUnit.belongsTo(User, { as: "placedBy", foreignKey: "placedById" });


  BeryllExtendedHistory.belongsTo(User, { as: "user", foreignKey: "userId" });
};


module.exports = {

  BeryllServer,
  BeryllBatch,
  BeryllHistory,
  BeryllChecklistTemplate,
  BeryllServerChecklist,
  BeryllChecklistFile,
  BeryllDefectComment,
  BeryllDefectFile,
  BeryllServerComponent,
  BeryllRack,
  BeryllRackUnit,
  BeryllExtendedHistory,


  SERVER_STATUSES,
  BATCH_STATUSES,
  HISTORY_ACTIONS,
  CHECKLIST_GROUPS,
  RACK_STATUSES,


  DEFECT_CATEGORIES,
  DEFECT_PRIORITIES,
  DEFECT_STATUSES,


  COMPONENT_TYPES,
  COMPONENT_STATUSES,


  setupAssociations
};

================================================================================
FILE: QMS-Server-master/models/definitions/BeryllExtended.js
================================================================================



const sequelize = require("../../db");
const { DataTypes } = require("sequelize");


const RACK_STATUSES = {
  ACTIVE: "ACTIVE",
  MAINTENANCE: "MAINTENANCE",
  DECOMMISSIONED: "DECOMMISSIONED"
};

const CLUSTER_STATUSES = {
  FORMING: "FORMING",
  READY: "READY",
  SHIPPED: "SHIPPED",
  DEPLOYED: "DEPLOYED"
};

const SHIPMENT_STATUSES = {
  FORMING: "FORMING",
  READY: "READY",
  SHIPPED: "SHIPPED",
  IN_TRANSIT: "IN_TRANSIT",
  DELIVERED: "DELIVERED",
  ACCEPTED: "ACCEPTED"
};

const SERVER_ROLES = {
  MASTER: "MASTER",
  WORKER: "WORKER",
  STORAGE: "STORAGE",
  GATEWAY: "GATEWAY"
};

const REPAIR_PART_TYPES = {
  RAM: "RAM",
  MOTHERBOARD: "MOTHERBOARD",
  CPU: "CPU",
  HDD: "HDD",
  SSD: "SSD",
  PSU: "PSU",
  FAN: "FAN",
  RAID: "RAID",
  NIC: "NIC",
  BACKPLANE: "BACKPLANE",
  BMC: "BMC",
  CABLE: "CABLE",
  OTHER: "OTHER"
};

const DEFECT_RECORD_STATUSES = {
  NEW: "NEW",
  DIAGNOSING: "DIAGNOSING",
  WAITING_PARTS: "WAITING_PARTS",
  REPAIRING: "REPAIRING",
  SENT_TO_YADRO: "SENT_TO_YADRO",
  RETURNED: "RETURNED",
  RESOLVED: "RESOLVED",
  REPEATED: "REPEATED",
  CLOSED: "CLOSED"
};


const HISTORY_ENTITY_TYPES = {
  RACK: "RACK",
  CLUSTER: "CLUSTER",
  SHIPMENT: "SHIPMENT",
  DEFECT_RECORD: "DEFECT_RECORD",
  SERVER: "SERVER"
};


const BeryllRack = sequelize.define("BeryllRack", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  name: {
    type: DataTypes.STRING(100),
    allowNull: false,
    unique: true
  },
  location: {
    type: DataTypes.STRING(255),
    allowNull: true
  },
  totalUnits: {
    type: DataTypes.INTEGER,
    allowNull: false,
    defaultValue: 42
  },
  networkSubnet: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  gateway: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  status: {
    type: DataTypes.ENUM(...Object.values(RACK_STATUSES)),
    allowNull: false,
    defaultValue: RACK_STATUSES.ACTIVE
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  }
}, {
  tableName: "beryll_racks",
  timestamps: true,
  indexes: [
    { fields: ["name"] },
    { fields: ["status"] },
    { fields: ["location"] }
  ]
});


const BeryllRackUnit = sequelize.define("BeryllRackUnit", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  rackId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_racks",
      key: "id"
    }
  },
  serverId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },
  unitNumber: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  hostname: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  mgmtMacAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  mgmtIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  dataMacAddress: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  dataIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  accessLogin: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  accessPassword: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  installedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  installedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },


  placedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },

  placedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },


  dhcpIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },

  dhcpMacAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },

  dhcpHostname: {
    type: DataTypes.STRING(100),
    allowNull: true
  },

  dhcpLeaseActive: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },

  dhcpLastSync: {
    type: DataTypes.DATE,
    allowNull: true
  }

}, {
  tableName: "beryll_rack_units",
  timestamps: true,
  indexes: [
    { fields: ["rackId"] },
    { fields: ["serverId"] },
    { fields: ["unitNumber"] },
    { unique: true, fields: ["rackId", "unitNumber"] },
    { fields: ["hostname"] },
    { fields: ["placedById"] },
    { fields: ["installedById"] },
    { fields: ["dhcpIpAddress"] },
    { fields: ["dhcpMacAddress"] },
    { fields: ["dhcpLastSync"] }
  ]
});


const BeryllShipment = sequelize.define("BeryllShipment", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  name: {
    type: DataTypes.STRING(200),
    allowNull: false
  },
  destinationCity: {
    type: DataTypes.STRING(200),
    allowNull: true
  },
  destinationAddress: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  contactPerson: {
    type: DataTypes.STRING(200),
    allowNull: true
  },
  contactPhone: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  expectedCount: {
    type: DataTypes.INTEGER,
    allowNull: true,
    defaultValue: 80
  },
  status: {
    type: DataTypes.ENUM(...Object.values(SHIPMENT_STATUSES)),
    allowNull: false,
    defaultValue: SHIPMENT_STATUSES.FORMING
  },
  plannedShipDate: {
    type: DataTypes.DATEONLY,
    allowNull: true
  },
  actualShipDate: {
    type: DataTypes.DATEONLY,
    allowNull: true
  },
  deliveredAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  acceptedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  waybillNumber: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  carrier: {
    type: DataTypes.STRING(200),
    allowNull: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  createdById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  }
}, {
  tableName: "beryll_shipments",
  timestamps: true,
  indexes: [
    { fields: ["name"] },
    { fields: ["status"] },
    { fields: ["destinationCity"] },
    { fields: ["plannedShipDate"] }
  ]
});


const BeryllCluster = sequelize.define("BeryllCluster", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  name: {
    type: DataTypes.STRING(100),
    allowNull: false
  },
  description: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  shipmentId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: "beryll_shipments",
      key: "id"
    }
  },
  expectedCount: {
    type: DataTypes.INTEGER,
    allowNull: true,
    defaultValue: 10
  },
  status: {
    type: DataTypes.ENUM(...Object.values(CLUSTER_STATUSES)),
    allowNull: false,
    defaultValue: CLUSTER_STATUSES.FORMING
  },
  configVersion: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  createdById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  }
}, {
  tableName: "beryll_clusters",
  timestamps: true,
  indexes: [
    { fields: ["name"] },
    { fields: ["shipmentId"] },
    { fields: ["status"] }
  ]
});


const BeryllClusterServer = sequelize.define("BeryllClusterServer", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  clusterId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_clusters",
      key: "id"
    }
  },
  serverId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },
  role: {
    type: DataTypes.ENUM(...Object.values(SERVER_ROLES)),
    allowNull: false,
    defaultValue: SERVER_ROLES.WORKER
  },
  orderNumber: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  clusterHostname: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  clusterIpAddress: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  addedAt: {
    type: DataTypes.DATE,
    allowNull: true,
    defaultValue: DataTypes.NOW
  },
  addedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_cluster_servers",
  timestamps: true,
  indexes: [
    { fields: ["clusterId"] },
    { fields: ["serverId"] },
    { unique: true, fields: ["clusterId", "serverId"] },
    { fields: ["role"] }
  ]
});


const BeryllDefectRecord = sequelize.define("BeryllDefectRecord", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  serverId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_servers",
      key: "id"
    }
  },
  yadroTicketNumber: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  hasSPISI: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },
  clusterCode: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  problemDescription: {
    type: DataTypes.TEXT,
    allowNull: false
  },
  detectedAt: {
    type: DataTypes.DATE,
    allowNull: false,
    defaultValue: DataTypes.NOW
  },
  detectedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  diagnosticianId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  repairPartType: {
    type: DataTypes.ENUM(...Object.values(REPAIR_PART_TYPES)),
    allowNull: true
  },
  defectPartSerialYadro: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  defectPartSerialManuf: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  replacementPartSerialYadro: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  replacementPartSerialManuf: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  repairDetails: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  status: {
    type: DataTypes.ENUM(...Object.values(DEFECT_RECORD_STATUSES)),
    allowNull: false,
    defaultValue: DEFECT_RECORD_STATUSES.NEW
  },
  isRepeatedDefect: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },
  repeatedDefectReason: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  repeatedDefectDate: {
    type: DataTypes.DATE,
    allowNull: true
  },
  sentToYadroRepair: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },
  sentToYadroAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  returnedFromYadro: {
    type: DataTypes.BOOLEAN,
    allowNull: true,
    defaultValue: false
  },
  returnedFromYadroAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  substituteServerSerial: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  resolvedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  resolvedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  resolution: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  metadata: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  }
}, {
  tableName: "beryll_defect_records",
  timestamps: true,
  indexes: [
    { fields: ["serverId"] },
    { fields: ["yadroTicketNumber"] },
    { fields: ["status"] },
    { fields: ["detectedAt"] },
    { fields: ["repairPartType"] },
    { fields: ["diagnosticianId"] },
    { fields: ["isRepeatedDefect"] }
  ]
});


const BeryllDefectRecordFile = sequelize.define("BeryllDefectRecordFile", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  defectRecordId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: "beryll_defect_records",
      key: "id"
    }
  },
  originalName: {
    type: DataTypes.STRING(255),
    allowNull: false
  },
  fileName: {
    type: DataTypes.STRING(255),
    allowNull: false
  },
  filePath: {
    type: DataTypes.STRING(500),
    allowNull: false
  },
  mimeType: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  fileSize: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  uploadedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "beryll_defect_record_files",
  timestamps: true,
  indexes: [
    { fields: ["defectRecordId"] }
  ]
});


const BeryllExtendedHistory = sequelize.define("BeryllExtendedHistory", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  entityType: {

    type: DataTypes.ENUM(...Object.values(HISTORY_ENTITY_TYPES)),
    allowNull: false
  },
  entityId: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  action: {
    type: DataTypes.STRING(50),
    allowNull: false
  },
  userId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  comment: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  changes: {
    type: DataTypes.JSONB,
    allowNull: true
  },
  metadata: {
    type: DataTypes.JSONB,
    allowNull: true
  }
}, {
  tableName: "beryll_extended_history",
  timestamps: true,
  indexes: [
    { fields: ["entityType", "entityId"] },
    { fields: ["entityType"] },
    { fields: ["userId"] },
    { fields: ["action"] },
    { fields: ["createdAt"] }
  ]
});


const setupExtendedAssociations = (models) => {
  const { User, BeryllServer } = models;


  BeryllRack.hasMany(BeryllRackUnit, { as: "units", foreignKey: "rackId", onDelete: "CASCADE" });
  BeryllRackUnit.belongsTo(BeryllRack, { as: "rack", foreignKey: "rackId" });

  BeryllRackUnit.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });
  if (BeryllServer && BeryllServer.hasMany) {
    BeryllServer.hasMany(BeryllRackUnit, { as: "rackUnits", foreignKey: "serverId" });
  }


  BeryllRackUnit.belongsTo(User, { as: "installedBy", foreignKey: "installedById" });


  BeryllRackUnit.belongsTo(User, { as: "placedBy", foreignKey: "placedById" });


  BeryllShipment.belongsTo(User, { as: "createdBy", foreignKey: "createdById" });
  BeryllShipment.hasMany(BeryllCluster, { as: "clusters", foreignKey: "shipmentId" });


  BeryllCluster.belongsTo(BeryllShipment, { as: "shipment", foreignKey: "shipmentId" });
  BeryllCluster.belongsTo(User, { as: "createdBy", foreignKey: "createdById" });
  BeryllCluster.hasMany(BeryllClusterServer, { as: "clusterServers", foreignKey: "clusterId", onDelete: "CASCADE" });


  BeryllClusterServer.belongsTo(BeryllCluster, { as: "cluster", foreignKey: "clusterId" });
  BeryllClusterServer.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });
  BeryllClusterServer.belongsTo(User, { as: "addedBy", foreignKey: "addedById" });

  if (BeryllServer && BeryllServer.hasMany) {
    BeryllServer.hasMany(BeryllClusterServer, { as: "clusterMemberships", foreignKey: "serverId" });
  }


  BeryllDefectRecord.belongsTo(BeryllServer, { as: "server", foreignKey: "serverId" });
  BeryllDefectRecord.belongsTo(User, { as: "detectedBy", foreignKey: "detectedById" });
  BeryllDefectRecord.belongsTo(User, { as: "diagnostician", foreignKey: "diagnosticianId" });
  BeryllDefectRecord.belongsTo(User, { as: "resolvedBy", foreignKey: "resolvedById" });
  BeryllDefectRecord.hasMany(BeryllDefectRecordFile, { as: "files", foreignKey: "defectRecordId", onDelete: "CASCADE" });

  if (BeryllServer && BeryllServer.hasMany) {
    BeryllServer.hasMany(BeryllDefectRecord, { as: "defectRecords", foreignKey: "serverId" });
  }


  BeryllDefectRecordFile.belongsTo(BeryllDefectRecord, { as: "defectRecord", foreignKey: "defectRecordId" });
  BeryllDefectRecordFile.belongsTo(User, { as: "uploadedBy", foreignKey: "uploadedById" });


  BeryllExtendedHistory.belongsTo(User, { as: "user", foreignKey: "userId" });
};


module.exports = {

  BeryllRack,
  BeryllRackUnit,
  BeryllShipment,
  BeryllCluster,
  BeryllClusterServer,
  BeryllDefectRecord,
  BeryllDefectRecordFile,
  BeryllExtendedHistory,


  RACK_STATUSES,
  CLUSTER_STATUSES,
  SHIPMENT_STATUSES,
  SERVER_ROLES,
  REPAIR_PART_TYPES,
  DEFECT_RECORD_STATUSES,
  HISTORY_ENTITY_TYPES,


  setupAssociations: setupExtendedAssociations
};

================================================================================
FILE: QMS-Server-master/models/definitions/ComponentModels.js
================================================================================



const sequelize = require("../../db");
const { DataTypes, Op } = require("sequelize");


const COMPONENT_TYPES = {
  CPU: "CPU",
  RAM: "RAM",
  HDD: "HDD",
  SSD: "SSD",
  NVME: "NVME",
  MOTHERBOARD: "MOTHERBOARD",
  GPU: "GPU",
  NIC: "NIC",
  RAID: "RAID",
  PSU: "PSU",
  FAN: "FAN",
  BMC: "BMC",
  BACKPLANE: "BACKPLANE",
  CABLE: "CABLE",
  CHASSIS: "CHASSIS",
  OTHER: "OTHER"
};

const INVENTORY_STATUSES = {
  AVAILABLE: "AVAILABLE",
  RESERVED: "RESERVED",
  IN_USE: "IN_USE",
  IN_REPAIR: "IN_REPAIR",
  DEFECTIVE: "DEFECTIVE",
  SCRAPPED: "SCRAPPED",
  RETURNED: "RETURNED"
};

const COMPONENT_CONDITIONS = {
  NEW: "NEW",
  REFURBISHED: "REFURBISHED",
  USED: "USED",
  DAMAGED: "DAMAGED"
};

const HISTORY_ACTIONS = {
  RECEIVED: "RECEIVED",
  INSTALLED: "INSTALLED",
  REMOVED: "REMOVED",
  REPLACED: "REPLACED",
  SENT_TO_YADRO: "SENT_TO_YADRO",
  RETURNED_FROM_YADRO: "RETURNED_FROM_YADRO",
  TESTED: "TESTED",
  RESERVED: "RESERVED",
  RELEASED: "RELEASED",
  SCRAPPED: "SCRAPPED",
  TRANSFERRED: "TRANSFERRED"
};


const ComponentCatalog = sequelize.define("ComponentCatalog", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  type: {
    type: DataTypes.ENUM(...Object.values(COMPONENT_TYPES)),
    allowNull: false
  },
  manufacturer: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  model: {
    type: DataTypes.STRING(150),
    allowNull: false
  },
  revision: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  partNumber: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  specifications: {
    type: DataTypes.JSONB,
    allowNull: true,
    defaultValue: {}
  },
  serialNumberPattern: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  isActive: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  }
}, {
  tableName: "component_catalog",
  timestamps: true,
  indexes: [
    { fields: ["type"] },
    { fields: ["manufacturer"] },
    { fields: ["model"] },
    { unique: true, fields: ["type", "manufacturer", "model"], name: "component_catalog_unique" }
  ]
});


ComponentCatalog.findOrCreateByModel = async function(type, manufacturer, model, revision = null) {
  const [catalog, created] = await this.findOrCreate({
    where: {
      type,
      manufacturer: manufacturer || null,
      model
    },
    defaults: {
      revision,
      isActive: true
    }
  });
  return catalog;
};

ComponentCatalog.getByType = async function(type) {
  return this.findAll({
    where: { type, isActive: true },
    order: [["manufacturer", "ASC"], ["model", "ASC"]]
  });
};


const ComponentInventory = sequelize.define("ComponentInventory", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  catalogId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: { model: "component_catalog", key: "id" }
  },
  type: {
    type: DataTypes.ENUM(...Object.values(COMPONENT_TYPES)),
    allowNull: false
  },
  serialNumber: {
    type: DataTypes.STRING(100),
    allowNull: false
  },
  serialNumberYadro: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  manufacturer: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  model: {
    type: DataTypes.STRING(150),
    allowNull: true
  },
  status: {
    type: DataTypes.ENUM(...Object.values(INVENTORY_STATUSES)),
    allowNull: false,
    defaultValue: INVENTORY_STATUSES.AVAILABLE
  },
  condition: {
    type: DataTypes.ENUM(...Object.values(COMPONENT_CONDITIONS)),
    defaultValue: COMPONENT_CONDITIONS.NEW
  },
  location: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  currentServerId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  reservedForDefectId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  purchaseDate: {
    type: DataTypes.DATE,
    allowNull: true
  },
  warrantyExpires: {
    type: DataTypes.DATE,
    allowNull: true
  },
  lastTestedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  metadata: {
    type: DataTypes.JSONB,
    defaultValue: {}
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  createdById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "component_inventory",
  timestamps: true,
  indexes: [
    { fields: ["type"] },
    { fields: ["status"] },
    { fields: ["serialNumber"] },
    { fields: ["serialNumberYadro"] },
    { fields: ["currentServerId"] }
  ]
});


ComponentInventory.prototype.reserve = async function(defectId, userId) {
  if (this.status !== INVENTORY_STATUSES.AVAILABLE) {
    throw new Error(`–ö–æ–º–ø–æ–Ω–µ–Ω—Ç ${this.serialNumber} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è (—Å—Ç–∞—Ç—É—Å: ${this.status})`);
  }

  this.status = INVENTORY_STATUSES.RESERVED;
  this.reservedForDefectId = defectId;
  await this.save();


  await ComponentHistory.create({
    inventoryComponentId: this.id,
    action: HISTORY_ACTIONS.RESERVED,
    relatedDefectId: defectId,
    performedById: userId,
    notes: `–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–∞ #${defectId}`
  });

  return this;
};

ComponentInventory.prototype.release = async function(userId, notes = null) {
  this.status = INVENTORY_STATUSES.AVAILABLE;
  this.reservedForDefectId = null;
  await this.save();

  await ComponentHistory.create({
    inventoryComponentId: this.id,
    action: HISTORY_ACTIONS.RELEASED,
    performedById: userId,
    notes: notes || "–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–Ω—è—Ç–æ"
  });

  return this;
};

ComponentInventory.prototype.installToServer = async function(serverId, userId, defectId = null) {
  const prevStatus = this.status;

  this.status = INVENTORY_STATUSES.IN_USE;
  this.currentServerId = serverId;
  this.reservedForDefectId = null;
  await this.save();

  await ComponentHistory.create({
    inventoryComponentId: this.id,
    action: HISTORY_ACTIONS.INSTALLED,
    toServerId: serverId,
    relatedDefectId: defectId,
    performedById: userId,
    notes: `–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–µ—Ä–≤–µ—Ä ID=${serverId}`
  });

  return this;
};

ComponentInventory.prototype.removeFromServer = async function(userId, reason = null, defectId = null) {
  const fromServerId = this.currentServerId;

  this.status = reason === "defect" ? INVENTORY_STATUSES.DEFECTIVE : INVENTORY_STATUSES.AVAILABLE;
  this.currentServerId = null;
  await this.save();

  await ComponentHistory.create({
    inventoryComponentId: this.id,
    action: HISTORY_ACTIONS.REMOVED,
    fromServerId,
    relatedDefectId: defectId,
    performedById: userId,
    notes: reason || "–ò–∑–≤–ª–µ—á—ë–Ω –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞"
  });

  return this;
};

ComponentInventory.prototype.sendToYadro = async function(ticketNumber, userId) {
  this.status = INVENTORY_STATUSES.IN_REPAIR;
  this.metadata = {
    ...this.metadata,
    yadroTicket: ticketNumber,
    sentToYadroAt: new Date().toISOString()
  };
  await this.save();

  await ComponentHistory.create({
    inventoryComponentId: this.id,
    action: HISTORY_ACTIONS.SENT_TO_YADRO,
    yadroTicketNumber: ticketNumber,
    performedById: userId,
    notes: `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Ä–µ–º–æ–Ω—Ç –≤ –Ø–¥—Ä–æ. –ó–∞—è–≤–∫–∞: ${ticketNumber}`
  });

  return this;
};

ComponentInventory.prototype.returnFromYadro = async function(userId, condition = COMPONENT_CONDITIONS.REFURBISHED) {
  this.status = INVENTORY_STATUSES.RETURNED;
  this.condition = condition;
  this.metadata = {
    ...this.metadata,
    returnedFromYadroAt: new Date().toISOString()
  };
  await this.save();

  await ComponentHistory.create({
    inventoryComponentId: this.id,
    action: HISTORY_ACTIONS.RETURNED_FROM_YADRO,
    performedById: userId,
    notes: `–í–æ–∑–≤—Ä–∞—â—ë–Ω –∏–∑ –Ø–¥—Ä–æ. –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${condition}`
  });

  return this;
};


ComponentInventory.findAvailable = async function(type, count = 1) {
  return this.findAll({
    where: {
      type,
      status: INVENTORY_STATUSES.AVAILABLE
    },
    order: [
      ["condition", "ASC"],
      ["createdAt", "ASC"]
    ],
    limit: count
  });
};

ComponentInventory.findBySerial = async function(serial) {
  return this.findOne({
    where: {
      [Op.or]: [
        { serialNumber: serial },
        { serialNumberYadro: serial }
      ]
    }
  });
};

ComponentInventory.getStats = async function() {
  const stats = await this.findAll({
    attributes: [
      "type",
      "status",
      [sequelize.fn("COUNT", sequelize.col("id")), "count"]
    ],
    group: ["type", "status"],
    raw: true
  });

  const result = {};
  for (const row of stats) {
    if (!result[row.type]) {
      result[row.type] = { total: 0 };
    }
    result[row.type][row.status] = parseInt(row.count);
    result[row.type].total += parseInt(row.count);
  }

  return result;
};


const ComponentHistory = sequelize.define("ComponentHistory", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  serverComponentId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  inventoryComponentId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  action: {
    type: DataTypes.ENUM(...Object.values(HISTORY_ACTIONS)),
    allowNull: false
  },
  fromServerId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  toServerId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  fromLocation: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  toLocation: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  relatedDefectId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  yadroTicketNumber: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  performedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  performedAt: {
    type: DataTypes.DATE,
    defaultValue: DataTypes.NOW
  },
  metadata: {
    type: DataTypes.JSONB,
    defaultValue: {}
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  }
}, {
  tableName: "component_history",
  timestamps: true,
  updatedAt: false,
  indexes: [
    { fields: ["serverComponentId"] },
    { fields: ["inventoryComponentId"] },
    { fields: ["action"] },
    { fields: ["relatedDefectId"] },
    { fields: ["performedAt"] }
  ]
});


ComponentHistory.getComponentHistory = async function(componentId, isInventory = false) {
  const where = isInventory
    ? { inventoryComponentId: componentId }
    : { serverComponentId: componentId };

  return this.findAll({
    where,
    order: [["performedAt", "DESC"]],
    include: [
      { model: require("./General").User, as: "performedBy", attributes: ["id", "name", "surname"] }
    ]
  });
};

ComponentHistory.getServerComponentChanges = async function(serverId, dateFrom = null) {
  const where = {
    [Op.or]: [
      { fromServerId: serverId },
      { toServerId: serverId }
    ]
  };

  if (dateFrom) {
    where.performedAt = { [Op.gte]: dateFrom };
  }

  return this.findAll({
    where,
    order: [["performedAt", "DESC"]]
  });
};


function setupComponentAssociations(models) {
  const { User, BeryllServer, BeryllDefectRecord, BeryllServerComponent } = models;


  ComponentCatalog.hasMany(ComponentInventory, { foreignKey: "catalogId", as: "inventoryItems" });
  ComponentInventory.belongsTo(ComponentCatalog, { foreignKey: "catalogId", as: "catalog" });


  ComponentInventory.belongsTo(User, { foreignKey: "createdById", as: "createdBy" });
  ComponentInventory.belongsTo(BeryllServer, { foreignKey: "currentServerId", as: "currentServer" });
  ComponentInventory.belongsTo(BeryllDefectRecord, { foreignKey: "reservedForDefectId", as: "reservedForDefect" });

  ComponentInventory.hasMany(ComponentHistory, { foreignKey: "inventoryComponentId", as: "history" });
  ComponentHistory.belongsTo(ComponentInventory, { foreignKey: "inventoryComponentId", as: "inventoryComponent" });


  ComponentHistory.belongsTo(User, { foreignKey: "performedById", as: "performedBy" });
  ComponentHistory.belongsTo(BeryllServer, { foreignKey: "fromServerId", as: "fromServer" });
  ComponentHistory.belongsTo(BeryllServer, { foreignKey: "toServerId", as: "toServer" });
  ComponentHistory.belongsTo(BeryllDefectRecord, { foreignKey: "relatedDefectId", as: "relatedDefect" });


  if (BeryllServerComponent) {
    BeryllServerComponent.belongsTo(ComponentCatalog, { foreignKey: "catalogId", as: "catalogEntry" });
    BeryllServerComponent.belongsTo(ComponentInventory, { foreignKey: "inventoryId", as: "inventorySource" });
    BeryllServerComponent.belongsTo(User, { foreignKey: "installedById", as: "installedBy" });

    ComponentHistory.belongsTo(BeryllServerComponent, { foreignKey: "serverComponentId", as: "serverComponent" });
    BeryllServerComponent.hasMany(ComponentHistory, { foreignKey: "serverComponentId", as: "history" });
  }
}

module.exports = {
  ComponentCatalog,
  ComponentInventory,
  ComponentHistory,
  setupComponentAssociations,
  COMPONENT_TYPES,
  INVENTORY_STATUSES,
  COMPONENT_CONDITIONS,
  HISTORY_ACTIONS
};

================================================================================
FILE: QMS-Server-master/models/definitions/Defect.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");


const DefectCategory = sequelize.define("defect_category", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },

  code: {
    type: DataTypes.STRING(50),
    allowNull: false
  },
  title: {
    type: DataTypes.STRING(200),
    allowNull: false
  },
  description: {
    type: DataTypes.TEXT
  },

  severity: {
    type: DataTypes.ENUM("CRITICAL", "MAJOR", "MINOR"),
    defaultValue: "MAJOR"
  },

  applicableTypes: {
    type: DataTypes.JSON,
    defaultValue: []
  },

  isActive: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  }
}, {
  indexes: [
    { unique: true, fields: ["code"] }
  ]
});


const BoardDefect = sequelize.define("board_defect", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },

  boardType: {
    type: DataTypes.STRING(50),
    allowNull: false
  },
  boardId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  serialNumber: {
    type: DataTypes.STRING(100),
    allowNull: true
  },

  categoryId: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  description: {
    type: DataTypes.TEXT
  },

  detectedById: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  detectedAt: {
    type: DataTypes.DATE,
    defaultValue: DataTypes.NOW
  },

  status: {
    type: DataTypes.ENUM(
      "OPEN",
      "IN_REPAIR",
      "REPAIRED",
      "VERIFIED",
      "SCRAPPED",
      "RETURNED",
      "CLOSED"
    ),
    defaultValue: "OPEN"
  },

  closedById: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  closedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  finalResult: {
    type: DataTypes.ENUM("FIXED", "SCRAPPED", "RETURNED_TO_SUPPLIER", "FALSE_POSITIVE"),
    allowNull: true
  },

  totalRepairMinutes: {
    type: DataTypes.INTEGER,
    defaultValue: 0
  }
});


const RepairAction = sequelize.define("repair_action", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },

  boardDefectId: {
    type: DataTypes.INTEGER,
    allowNull: false
  },

  actionType: {
    type: DataTypes.ENUM(
      "DIAGNOSIS",
      "SOLDER",
      "REPLACE",
      "FLASH",
      "TEST",
      "CLEAN",
      "CLONE_DISK",
      "CABLE_REPLACE",
      "OTHER"
    ),
    allowNull: false
  },

  performedById: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  performedAt: {
    type: DataTypes.DATE,
    defaultValue: DataTypes.NOW
  },

  description: {
    type: DataTypes.TEXT,
    allowNull: false
  },
  timeSpentMinutes: {
    type: DataTypes.INTEGER,
    allowNull: true
  },

  result: {
    type: DataTypes.ENUM("SUCCESS", "PARTIAL", "FAILED", "PENDING"),
    defaultValue: "PENDING"
  }
});


const setupDefectAssociations = (models) => {
  const { User } = models;

  DefectCategory.hasMany(BoardDefect, {
    foreignKey: "categoryId",
    as: "defects"
  });
  BoardDefect.belongsTo(DefectCategory, {
    foreignKey: "categoryId",
    as: "category"
  });

  BoardDefect.belongsTo(User, {
    foreignKey: "detectedById",
    as: "detectedBy"
  });

  BoardDefect.belongsTo(User, {
    foreignKey: "closedById",
    as: "closedBy"
  });

  BoardDefect.hasMany(RepairAction, {
    foreignKey: "boardDefectId",
    as: "repairs"
  });
  RepairAction.belongsTo(BoardDefect, {
    foreignKey: "boardDefectId",
    as: "defect"
  });

  RepairAction.belongsTo(User, {
    foreignKey: "performedById",
    as: "performedBy"
  });
};

const BOARD_TYPES = {
  FC: "FC",
  ELRS_915: "ELRS_915",
  ELRS_2_4: "ELRS_2_4",
  CORAL_B: "CORAL_B",
  SMARAGD: "SMARAGD"
};

const DEFECT_STATUSES = {
  OPEN: "OPEN",
  IN_REPAIR: "IN_REPAIR",
  REPAIRED: "REPAIRED",
  VERIFIED: "VERIFIED",
  SCRAPPED: "SCRAPPED",
  RETURNED: "RETURNED",
  CLOSED: "CLOSED"
};

const ACTION_TYPES = {
  DIAGNOSIS: "DIAGNOSIS",
  SOLDER: "SOLDER",
  REPLACE: "REPLACE",
  FLASH: "FLASH",
  TEST: "TEST",
  CLEAN: "CLEAN",
  CLONE_DISK: "CLONE_DISK",
  CABLE_REPLACE: "CABLE_REPLACE",
  OTHER: "OTHER"
};

module.exports = {
  DefectCategory,
  BoardDefect,
  RepairAction,
  setupDefectAssociations,
  BOARD_TYPES,
  DEFECT_STATUSES,
  ACTION_TYPES
};

================================================================================
FILE: QMS-Server-master/models/definitions/General.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");

const User = sequelize.define("user", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  login: { type: DataTypes.STRING, unique: true },
  password: { type: DataTypes.STRING },
  role: { type: DataTypes.STRING, defaultValue: "USER" },
  name: { type: DataTypes.STRING },
  surname: { type: DataTypes.STRING },
  img: { type: DataTypes.STRING },
});

const PC = sequelize.define("PC", {
  id: { type: DataTypes.SMALLINT, primaryKey: true, autoIncrement: true },
  ip: { type: DataTypes.STRING, unique: true, allowNull: false },
  pc_name: { type: DataTypes.STRING, allowNull: false },
  cabinet: { type: DataTypes.STRING },
});

const Session = sequelize.define("session", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  online: { type: DataTypes.BOOLEAN },
  PCId: {
    type: DataTypes.SMALLINT,
    allowNull: true,
    references: {
      model: 'PCs',
      key: 'id'
    }
  }
});

const AuditLog = sequelize.define("audit_log", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  userId: { type: DataTypes.INTEGER, allowNull: true },
  action: { type: DataTypes.STRING, allowNull: false },
  entity: { type: DataTypes.STRING, allowNull: true },
  entityId: { type: DataTypes.STRING, allowNull: true },
  description: { type: DataTypes.TEXT, allowNull: true },
  metadata: { type: DataTypes.JSON, allowNull: true },
});


const Role = sequelize.define("role", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  name: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const Ability = sequelize.define("ability", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  code: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const RoleAbility = sequelize.define("role_ability", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
});

module.exports = {
  User,
  PC,
  Session,
  AuditLog,
  Role,
  Ability,
  RoleAbility,
};

================================================================================
FILE: QMS-Server-master/models/definitions/Production.js
================================================================================

const sequelize = require("../../db");
const { DataTypes, Op } = require("sequelize");


const CategoryDefect = sequelize.define("category_defect", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const FC = sequelize.define("FC", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    unique_device_id: { type: DataTypes.STRING, allowNull: true },
    firmware: { type: DataTypes.BOOLEAN },
    stand_test: { type: DataTypes.BOOLEAN, allowNull: true },
}, {
    indexes: [{ unique: true, fields: ["unique_device_id"], where: { unique_device_id: { [Op.ne]: null } } }]
});


const CategoryDefect915 = sequelize.define("category_defect_915", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const ELRS915 = sequelize.define("ELRS_915", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    MAC_address: { type: DataTypes.STRING, allowNull: true },
    firmware: { type: DataTypes.BOOLEAN },
    firmwareVersion: { type: DataTypes.STRING, allowNull: true },
}, {
    indexes: [{ unique: true, fields: ["MAC_address"], where: { MAC_address: { [Op.ne]: null } } }]
});


const CategoryDefect2_4 = sequelize.define("category_defect_2_4", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const ELRS2_4 = sequelize.define("ELRS_2_4", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    MAC_address: { type: DataTypes.STRING, allowNull: true },
    firmware: { type: DataTypes.BOOLEAN },
}, {
    indexes: [{ unique: true, fields: ["MAC_address"], where: { MAC_address: { [Op.ne]: null } } }]
});


const CategoryDefect_CoralB = sequelize.define("category_defect_CoralB", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const CoralB = sequelize.define("CoralB", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    serial: { type: DataTypes.STRING, allowNull: true },
    firmware: { type: DataTypes.BOOLEAN },
    SAW_filter: { type: DataTypes.BOOLEAN },
    firmwareVersion: { type: DataTypes.STRING, allowNull: true },
}, {
    indexes: [{ unique: true, fields: ["serial"], where: { serial: { [Op.ne]: null } } }]
});


const AssemblyRoute = sequelize.define("assembly_route", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false },
  productName: { type: DataTypes.STRING, allowNull: true },
  description: { type: DataTypes.TEXT, allowNull: true },
  isActive: { type: DataTypes.BOOLEAN, allowNull: false, defaultValue: true },
  createdById: { type: DataTypes.INTEGER, allowNull: false },
});

const AssemblyRouteStep = sequelize.define("assembly_route_step", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  routeId: { type: DataTypes.INTEGER, allowNull: false },
  order: { type: DataTypes.INTEGER, allowNull: false },
  title: { type: DataTypes.STRING, allowNull: false },
  operation: { type: DataTypes.STRING, allowNull: false },
  sectionId: { type: DataTypes.INTEGER, allowNull: true },
  teamId: { type: DataTypes.INTEGER, allowNull: true },
  description: { type: DataTypes.TEXT, allowNull: true },
});

module.exports = {
  FC, CategoryDefect,
  ELRS915, CategoryDefect915,
  ELRS2_4, CategoryDefect2_4,
  CoralB, CategoryDefect_CoralB,
  AssemblyRoute, AssemblyRouteStep
};

================================================================================
FILE: QMS-Server-master/models/definitions/Project.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");

const Project = sequelize.define("project", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false, unique: true },
  description: { type: DataTypes.TEXT, allowNull: true },
  status: { type: DataTypes.STRING, defaultValue: "ACTIVE" },
  createdById: { type: DataTypes.INTEGER, allowNull: false },
});

module.exports = { Project };
================================================================================
FILE: QMS-Server-master/models/definitions/Structure.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");

const Section = sequelize.define("production_section", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false, unique: true },
  description: { type: DataTypes.STRING },
  managerId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: 'users',
      key: 'id'
    }
  },
});

const Team = sequelize.define("production_team", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false },
  sectionId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    field: "productionSectionId",
  },
  teamLeadId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: 'users',
      key: 'id'
    }
  },
});

module.exports = {
  Section,
  Team,
};

================================================================================
FILE: QMS-Server-master/models/definitions/Warehouse.js
================================================================================

const sequelize = require("../../db");
const { DataTypes } = require("sequelize");


const Supply = sequelize.define("supply", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplier: { type: DataTypes.STRING, allowNull: true },
  docNumber: { type: DataTypes.STRING, allowNull: true },
  status: { type: DataTypes.STRING, defaultValue: "NEW" },
  comment: { type: DataTypes.TEXT, allowNull: true },
  expectedDate: { type: DataTypes.DATEONLY, allowNull: true },
  receivedAt: { type: DataTypes.DATE, defaultValue: DataTypes.NOW },
});


const WarehouseBox = sequelize.define("warehouse_box", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplyId: { type: DataTypes.INTEGER, allowNull: true },


  qrCode: { type: DataTypes.STRING, unique: true, allowNull: false },
  shortCode: { type: DataTypes.STRING, unique: true, allowNull: true },


  label: { type: DataTypes.STRING, allowNull: false },


  originType: { type: DataTypes.STRING, allowNull: true },
  originId: { type: DataTypes.INTEGER, allowNull: true },


  quantity: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 1 },
  unit: { type: DataTypes.STRING, allowNull: false, defaultValue: "—à—Ç" },


  parentBoxId: { type: DataTypes.INTEGER, allowNull: true },


  kitNumber: { type: DataTypes.STRING, allowNull: true },
  projectName: { type: DataTypes.STRING, allowNull: true },
  batchName: { type: DataTypes.STRING, allowNull: true },


  status: { type: DataTypes.STRING, allowNull: false, defaultValue: "ON_STOCK" },
  notes: { type: DataTypes.TEXT, allowNull: true },


  currentSectionId: { type: DataTypes.INTEGER, allowNull: true },
  currentTeamId: { type: DataTypes.INTEGER, allowNull: true },

  acceptedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  acceptedById: { type: DataTypes.INTEGER, allowNull: false },
});


const WarehouseMovement = sequelize.define("warehouse_movement", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  boxId: { type: DataTypes.INTEGER, allowNull: false },
  documentId: { type: DataTypes.INTEGER, allowNull: true },

  fromSectionId: { type: DataTypes.INTEGER, allowNull: true },
  fromTeamId: { type: DataTypes.INTEGER, allowNull: true },
  toSectionId: { type: DataTypes.INTEGER, allowNull: true },
  toTeamId: { type: DataTypes.INTEGER, allowNull: true },

  operation: { type: DataTypes.STRING, allowNull: false },
  statusAfter: { type: DataTypes.STRING, allowNull: true },

  deltaQty: { type: DataTypes.INTEGER, allowNull: true, defaultValue: 0 },
  goodQty: { type: DataTypes.INTEGER, allowNull: true },
  scrapQty: { type: DataTypes.INTEGER, allowNull: true },

  performedById: { type: DataTypes.INTEGER, allowNull: false },
  performedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  comment: { type: DataTypes.TEXT, allowNull: true },
});


const WarehouseDocument = sequelize.define("warehouse_document", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  boxId: { type: DataTypes.INTEGER, allowNull: true },
  number: { type: DataTypes.STRING, allowNull: false },
  type: { type: DataTypes.STRING, allowNull: true },
  date: { type: DataTypes.DATEONLY, allowNull: true },
  fileUrl: { type: DataTypes.STRING, allowNull: true },
  comment: { type: DataTypes.TEXT, allowNull: true },
  createdById: { type: DataTypes.INTEGER, allowNull: false },
});


const InventoryLimit = sequelize.define("inventory_limit", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  originType: { type: DataTypes.STRING, allowNull: true },
  originId: { type: DataTypes.INTEGER, allowNull: true },
  label: { type: DataTypes.STRING, allowNull: true },
  minQuantity: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
});


const ProductionTask = sequelize.define("production_task", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },

  title: { type: DataTypes.STRING, allowNull: false },


  originType: { type: DataTypes.STRING, allowNull: true },
  originId: { type: DataTypes.INTEGER, allowNull: true },

  targetQty: { type: DataTypes.INTEGER, allowNull: false },
  unit: { type: DataTypes.STRING, allowNull: false, defaultValue: "—à—Ç" },

  dueDate: { type: DataTypes.DATEONLY, allowNull: true },

  status: { type: DataTypes.STRING, allowNull: false, defaultValue: "NEW" },
  priority: { type: DataTypes.INTEGER, allowNull: true },

  comment: { type: DataTypes.TEXT, allowNull: true },

  createdById: { type: DataTypes.INTEGER, allowNull: false },


  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  sectionId: { type: DataTypes.INTEGER, allowNull: true },
  projectId: { type: DataTypes.INTEGER, allowNull: true },
});


const PrintHistory = sequelize.define("print_history", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  template: { type: DataTypes.STRING, allowNull: false },

  labelName: { type: DataTypes.STRING },
  startCode: { type: DataTypes.STRING },
  endCode: { type: DataTypes.STRING },

  quantity: { type: DataTypes.INTEGER },


  params: { type: DataTypes.JSONB },

  createdById: { type: DataTypes.INTEGER, allowNull: true },
  createdAt: { type: DataTypes.DATE, defaultValue: DataTypes.NOW }
});

module.exports = {
  Supply,
  WarehouseBox,
  WarehouseMovement,
  WarehouseDocument,
  InventoryLimit,
  ProductionTask,
  PrintHistory
};

================================================================================
FILE: QMS-Server-master/models/definitions/YadroIntegration.js
================================================================================



const sequelize = require("../../db");
const { DataTypes, Op } = require("sequelize");


const YADRO_REQUEST_TYPES = {
  COMPONENT_REPAIR: "COMPONENT_REPAIR",
  COMPONENT_EXCHANGE: "COMPONENT_EXCHANGE",
  WARRANTY_CLAIM: "WARRANTY_CLAIM",
  CONSULTATION: "CONSULTATION"
};

const YADRO_LOG_STATUSES = {
  SENT: "SENT",
  IN_PROGRESS: "IN_PROGRESS",
  COMPLETED: "COMPLETED",
  RECEIVED: "RECEIVED",
  CLOSED: "CLOSED"
};

const SUBSTITUTE_STATUSES = {
  AVAILABLE: "AVAILABLE",
  IN_USE: "IN_USE",
  MAINTENANCE: "MAINTENANCE",
  RETIRED: "RETIRED"
};


const YadroTicketLog = sequelize.define("YadroTicketLog", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  ticketNumber: {
    type: DataTypes.STRING(50),
    allowNull: false
  },
  defectRecordId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  serverId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  requestType: {
    type: DataTypes.ENUM(...Object.values(YADRO_REQUEST_TYPES)),
    defaultValue: YADRO_REQUEST_TYPES.COMPONENT_REPAIR
  },
  status: {
    type: DataTypes.ENUM(...Object.values(YADRO_LOG_STATUSES)),
    defaultValue: YADRO_LOG_STATUSES.SENT
  },
  componentType: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  sentComponentSerialYadro: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  sentComponentSerialManuf: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  receivedComponentSerialYadro: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  receivedComponentSerialManuf: {
    type: DataTypes.STRING(100),
    allowNull: true
  },
  sentAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  receivedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  problemDescription: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  yadroResponse: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  createdById: {
    type: DataTypes.INTEGER,
    allowNull: true
  }
}, {
  tableName: "yadro_ticket_log",
  timestamps: true,
  indexes: [
    { fields: ["ticketNumber"] },
    { fields: ["defectRecordId"] },
    { fields: ["serverId"] },
    { fields: ["status"] },
    { fields: ["sentAt"] }
  ]
});


YadroTicketLog.prototype.markInProgress = async function() {
  this.status = YADRO_LOG_STATUSES.IN_PROGRESS;
  return this.save();
};

YadroTicketLog.prototype.markCompleted = async function(yadroResponse) {
  this.status = YADRO_LOG_STATUSES.COMPLETED;
  if (yadroResponse) this.yadroResponse = yadroResponse;
  return this.save();
};

YadroTicketLog.prototype.markReceived = async function(receivedSerialYadro, receivedSerialManuf, yadroResponse) {
  this.status = YADRO_LOG_STATUSES.RECEIVED;
  this.receivedAt = new Date();
  if (receivedSerialYadro) this.receivedComponentSerialYadro = receivedSerialYadro;
  if (receivedSerialManuf) this.receivedComponentSerialManuf = receivedSerialManuf;
  if (yadroResponse) this.yadroResponse = yadroResponse;
  return this.save();
};

YadroTicketLog.prototype.close = async function(notes) {
  this.status = YADRO_LOG_STATUSES.CLOSED;
  if (notes) this.notes = (this.notes ? this.notes + "\n" : "") + notes;
  return this.save();
};

YadroTicketLog.prototype.getDaysInYadro = function() {
  if (!this.sentAt) return null;
  const endDate = this.receivedAt || new Date();
  return Math.round((endDate - this.sentAt) / (1000 * 60 * 60 * 24));
};

YadroTicketLog.getOpenRequests = async function() {
  return this.findAll({
    where: {
      status: { [Op.notIn]: [YADRO_LOG_STATUSES.CLOSED] }
    },
    order: [["sentAt", "DESC"]]
  });
};

YadroTicketLog.getByDefect = async function(defectRecordId) {
  return this.findAll({
    where: { defectRecordId },
    order: [["createdAt", "DESC"]]
  });
};

YadroTicketLog.getStats = async function(dateFrom, dateTo) {
  const where = {};
  if (dateFrom || dateTo) {
    where.sentAt = {};
    if (dateFrom) where.sentAt[Op.gte] = dateFrom;
    if (dateTo) where.sentAt[Op.lte] = dateTo;
  }

  return this.findAll({
    where,
    attributes: [
      "status",
      "requestType",
      "componentType",
      [sequelize.fn("COUNT", sequelize.col("id")), "count"]
    ],
    group: ["status", "requestType", "componentType"],
    raw: true
  });
};


const SubstituteServerPool = sequelize.define("SubstituteServerPool", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  serverId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    unique: true
  },
  status: {
    type: DataTypes.ENUM(...Object.values(SUBSTITUTE_STATUSES)),
    defaultValue: SUBSTITUTE_STATUSES.AVAILABLE
  },
  currentDefectId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  issuedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  issuedToUserId: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  returnedAt: {
    type: DataTypes.DATE,
    allowNull: true
  },
  usageCount: {
    type: DataTypes.INTEGER,
    defaultValue: 0
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  }
}, {
  tableName: "substitute_server_pool",
  timestamps: true,
  indexes: [
    { fields: ["serverId"], unique: true },
    { fields: ["status"] },
    { fields: ["currentDefectId"] }
  ]
});

SubstituteServerPool.prototype.issue = async function(defectId, userId) {
  if (this.status !== SUBSTITUTE_STATUSES.AVAILABLE) {
    throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤—ã–¥–∞—á–∏");
  }
  this.status = SUBSTITUTE_STATUSES.IN_USE;
  this.currentDefectId = defectId;
  this.issuedAt = new Date();
  this.issuedToUserId = userId;
  this.usageCount += 1;
  this.returnedAt = null;
  return this.save();
};

SubstituteServerPool.prototype.return = async function() {
  this.status = SUBSTITUTE_STATUSES.AVAILABLE;
  this.currentDefectId = null;
  this.returnedAt = new Date();
  this.issuedToUserId = null;
  return this.save();
};

SubstituteServerPool.prototype.setMaintenance = async function(notes) {
  this.status = SUBSTITUTE_STATUSES.MAINTENANCE;
  if (notes) this.notes = notes;
  return this.save();
};

SubstituteServerPool.getAvailable = async function() {
  return this.findAll({
    where: { status: SUBSTITUTE_STATUSES.AVAILABLE },
    order: [["usageCount", "ASC"]]
  });
};

SubstituteServerPool.findAvailableOne = async function() {
  return this.findOne({
    where: { status: SUBSTITUTE_STATUSES.AVAILABLE },
    order: [["usageCount", "ASC"]]
  });
};

SubstituteServerPool.getStats = async function() {
  const all = await this.findAll();
  return {
    total: all.length,
    available: all.filter(s => s.status === SUBSTITUTE_STATUSES.AVAILABLE).length,
    inUse: all.filter(s => s.status === SUBSTITUTE_STATUSES.IN_USE).length,
    maintenance: all.filter(s => s.status === SUBSTITUTE_STATUSES.MAINTENANCE).length,
    avgUsageCount: all.length > 0 ? all.reduce((sum, s) => sum + s.usageCount, 0) / all.length : 0
  };
};


const SlaConfig = sequelize.define("SlaConfig", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  name: {
    type: DataTypes.STRING(100),
    allowNull: false
  },
  defectType: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  priority: {
    type: DataTypes.STRING(20),
    allowNull: true
  },
  maxDiagnosisHours: {
    type: DataTypes.INTEGER,
    defaultValue: 24
  },
  maxRepairHours: {
    type: DataTypes.INTEGER,
    defaultValue: 72
  },
  maxTotalHours: {
    type: DataTypes.INTEGER,
    defaultValue: 168
  },
  escalationAfterHours: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  isActive: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  }
}, {
  tableName: "sla_config",
  timestamps: true,
  indexes: [
    { fields: ["defectType", "priority"] },
    { fields: ["isActive"] }
  ]
});

SlaConfig.getForDefect = async function(defectType, priority) {
  let config = await this.findOne({
    where: { defectType, priority, isActive: true }
  });

  if (!config && defectType) {
    config = await this.findOne({
      where: { defectType, priority: null, isActive: true }
    });
  }

  if (!config && priority) {
    config = await this.findOne({
      where: { defectType: null, priority, isActive: true }
    });
  }

  if (!config) {
    config = await this.findOne({
      where: { defectType: null, priority: null, isActive: true }
    });
  }

  return config;
};

SlaConfig.calculateDeadline = async function(defectType, priority, startDate = new Date()) {
  const config = await this.getForDefect(defectType, priority);
  if (!config) return null;

  const deadline = new Date(startDate);
  deadline.setHours(deadline.getHours() + config.maxTotalHours);
  return deadline;
};


const UserAlias = sequelize.define("UserAlias", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  userId: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  alias: {
    type: DataTypes.STRING(200),
    allowNull: false
  },
  source: {
    type: DataTypes.STRING(50),
    allowNull: true
  },
  isActive: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  }
}, {
  tableName: "user_aliases",
  timestamps: true,
  indexes: [
    { fields: ["alias"] },
    { fields: ["userId"] },
    { fields: ["isActive"] }
  ]
});

UserAlias.findUserByAlias = async function(alias) {
  const normalizedAlias = alias.trim().toLowerCase();

  const record = await this.findOne({
    where: {
      isActive: true,
      [Op.or]: [
        sequelize.where(sequelize.fn("LOWER", sequelize.col("alias")), normalizedAlias),
        sequelize.where(
          sequelize.fn("LOWER", sequelize.fn("REPLACE", sequelize.col("alias"), " ", "")),
          normalizedAlias.replace(/\s/g, "")
        )
      ]
    }
  });

  if (record) {
    const User = sequelize.models.User;
    if (User) {
      return User.findByPk(record.userId);
    }
  }

  return null;
};

UserAlias.generateAliasesFromUser = async function(user) {
  const aliases = [];
  const name = user.name || "";
  const surname = user.surname || "";
  const patronymic = user.patronymic || "";

  if (surname && name) {
    aliases.push(`${surname} ${name}`);
    aliases.push(`${surname} ${name[0]}.`);

    if (patronymic) {
      aliases.push(`${surname} ${name} ${patronymic}`);
      aliases.push(`${surname} ${name[0]}.${patronymic[0]}.`);
      aliases.push(`${surname} ${name[0]}. ${patronymic[0]}.`);
    }
  }

  const created = [];
  for (const alias of aliases) {
    const existing = await this.findOne({
      where: { userId: user.id, alias }
    });

    if (!existing) {
      const record = await this.create({
        userId: user.id,
        alias,
        source: "auto_generated",
        isActive: true
      });
      created.push(record);
    }
  }

  return created;
};


const BeryllClusterRack = sequelize.define("BeryllClusterRack", {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  clusterId: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  rackId: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  unitStart: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  unitEnd: {
    type: DataTypes.INTEGER,
    allowNull: true
  },
  notes: {
    type: DataTypes.TEXT,
    allowNull: true
  }
}, {
  tableName: "beryll_cluster_racks",
  timestamps: true,
  indexes: [
    { fields: ["clusterId"] },
    { fields: ["rackId"] },
    { fields: ["clusterId", "rackId"], unique: true }
  ]
});


module.exports = {
  YadroTicketLog,
  SubstituteServerPool,
  SlaConfig,
  UserAlias,
  BeryllClusterRack,
  YADRO_REQUEST_TYPES,
  YADRO_LOG_STATUSES,
  SUBSTITUTE_STATUSES
};

================================================================================
FILE: QMS-Server-master/models/index.js
================================================================================


const { User, PC, Session, AuditLog, Role, Ability, RoleAbility } = require("./definitions/General");
const { Section, Team } = require("./definitions/Structure");
const {
    FC, CategoryDefect,
    ELRS915, CategoryDefect915,
    ELRS2_4, CategoryDefect2_4,
    CoralB, CategoryDefect_CoralB,
    AssemblyRoute, AssemblyRouteStep
} = require("./definitions/Production");
const {
    Supply, WarehouseBox, WarehouseMovement,
    WarehouseDocument, InventoryLimit, ProductionTask,
    PrintHistory
} = require("./definitions/Warehouse");
const { Project } = require("./definitions/Project");
const { AssemblyRecipe, RecipeStep, AssemblyProcess } = require("./definitions/Assembly");


const {
    ProductionOutput,
    OperationType,
    OUTPUT_STATUSES
} = require("./ProductionOutput");


const {
  DefectCategory,
  BoardDefect,
  RepairAction,
  setupDefectAssociations,
  BOARD_TYPES,
  DEFECT_STATUSES: BOARD_DEFECT_STATUSES,
  ACTION_TYPES
} = require("./definitions/Defect");


const {
    BeryllServer,
    BeryllBatch,
    BeryllHistory,
    BeryllChecklistTemplate,
    BeryllServerChecklist,
    BeryllDefectComment,
    BeryllDefectFile,
    BeryllServerComponent,
    DEFECT_CATEGORIES,
    DEFECT_PRIORITIES,
    DEFECT_STATUSES,
    COMPONENT_TYPES: BERYLL_COMPONENT_TYPES,
    COMPONENT_STATUSES,
    setupAssociations: setupBeryllAssociations
} = require("./definitions/Beryll");


const {
    BeryllRack,
    BeryllRackUnit,
    BeryllShipment,
    BeryllCluster,
    BeryllClusterServer,
    BeryllDefectRecord,
    BeryllDefectRecordFile,
    BeryllExtendedHistory,
    RACK_STATUSES,
    SHIPMENT_STATUSES,
    CLUSTER_STATUSES,
    SERVER_ROLES,
    DEFECT_RECORD_STATUSES,
    REPAIR_PART_TYPES,
    setupAssociations: setupExtendedAssociations
} = require("./definitions/BeryllExtended");


const {
    ComponentCatalog,
    ComponentInventory,
    ComponentHistory,
    setupComponentAssociations,
    COMPONENT_TYPES,
    INVENTORY_STATUSES,
    COMPONENT_CONDITIONS,
    HISTORY_ACTIONS
} = require("./definitions/ComponentModels");

const {
    YadroTicketLog,
    SubstituteServerPool,
    SlaConfig,
    UserAlias,
    BeryllClusterRack,
    YADRO_REQUEST_TYPES,
    YADRO_LOG_STATUSES,
    SUBSTITUTE_STATUSES
} = require("./definitions/YadroIntegration");


User.hasMany(Session);
Session.belongsTo(User);


Session.belongsTo(PC, { foreignKey: "PCId", as: "pc" });
PC.hasMany(Session, { foreignKey: "PCId", as: "sessions" });


AuditLog.belongsTo(User, { foreignKey: "userId", as: "User" });
User.hasMany(AuditLog, { foreignKey: "userId", as: "auditLogs" });

User.belongsTo(Team, { foreignKey: "teamId" });
Team.hasMany(User, { foreignKey: "teamId" });

Team.belongsTo(Section, { foreignKey: "sectionId", as: "section" });
Team.belongsTo(Section, { foreignKey: "sectionId", as: "production_section" });
Section.hasMany(Team, { foreignKey: "sectionId", as: "teams" });

Team.belongsTo(User, { foreignKey: "teamLeadId", as: "teamLead" });


Section.belongsTo(User, { foreignKey: "managerId", as: "manager" });
User.hasMany(Section, { foreignKey: "managerId", as: "managedSections" });


Role.belongsToMany(Ability, { through: RoleAbility, foreignKey: "roleId", as: "abilities" });
Ability.belongsToMany(Role, { through: RoleAbility, foreignKey: "abilityId", as: "roles" });
User.belongsTo(Role, { foreignKey: "roleId", as: "userRole" });


Session.hasMany(FC); FC.belongsTo(Session);
CategoryDefect.hasMany(FC); FC.belongsTo(CategoryDefect);

Session.hasMany(ELRS915); ELRS915.belongsTo(Session);
CategoryDefect915.hasMany(ELRS915); ELRS915.belongsTo(CategoryDefect915);

Session.hasMany(ELRS2_4); ELRS2_4.belongsTo(Session);
CategoryDefect2_4.hasMany(ELRS2_4); ELRS2_4.belongsTo(CategoryDefect2_4);

Session.hasMany(CoralB); CoralB.belongsTo(Session);
CategoryDefect_CoralB.hasMany(CoralB); CoralB.belongsTo(CategoryDefect_CoralB);


AssemblyRoute.belongsTo(User, { foreignKey: "createdById", as: "createdBy" });
User.hasMany(AssemblyRoute, { foreignKey: "createdById", as: "assemblyRoutes" });

AssemblyRoute.hasMany(AssemblyRouteStep, { foreignKey: "routeId", as: "steps", onDelete: "CASCADE" });
AssemblyRouteStep.belongsTo(AssemblyRoute, { foreignKey: "routeId", as: "route" });

AssemblyRouteStep.belongsTo(Section, { foreignKey: "sectionId", as: "section" });
AssemblyRouteStep.belongsTo(Team, { foreignKey: "teamId", as: "team" });


Supply.hasMany(WarehouseBox, { foreignKey: "supplyId", as: "boxes" });
WarehouseBox.belongsTo(Supply, { foreignKey: "supplyId", as: "supply" });

User.hasMany(WarehouseBox, { foreignKey: "acceptedById", as: "acceptedBoxes" });
WarehouseBox.belongsTo(User, { foreignKey: "acceptedById", as: "acceptedBy" });

WarehouseBox.belongsTo(Section, { foreignKey: "currentSectionId", as: "currentSection" });
Section.hasMany(WarehouseBox, { foreignKey: "currentSectionId", as: "boxes" });

WarehouseBox.hasMany(WarehouseMovement, { foreignKey: "boxId", as: "movements" });
WarehouseMovement.belongsTo(WarehouseBox, { foreignKey: "boxId", as: "box" });

WarehouseMovement.belongsTo(User, { foreignKey: "performedById", as: "performedBy" });
WarehouseMovement.belongsTo(Section, { foreignKey: "fromSectionId", as: "fromSection" });
WarehouseMovement.belongsTo(Section, { foreignKey: "toSectionId", as: "toSection" });


ProductionTask.belongsTo(User, { foreignKey: "responsibleId", as: "responsible" });
ProductionTask.belongsTo(User, { foreignKey: "createdById", as: "createdBy" });
ProductionTask.belongsTo(Section, { foreignKey: "targetSectionId", as: "targetSection" });
ProductionTask.belongsTo(Project, { foreignKey: "projectId", as: "project" });


AssemblyRecipe.hasMany(RecipeStep, { foreignKey: "recipeId", as: "steps" });
RecipeStep.belongsTo(AssemblyRecipe, { foreignKey: "recipeId", as: "recipe" });

AssemblyProcess.belongsTo(AssemblyRecipe, { foreignKey: "recipeId", as: "recipe" });
AssemblyProcess.belongsTo(User, { foreignKey: "userId", as: "operator" });


setupBeryllAssociations(User);


setupDefectAssociations({ User });


setupExtendedAssociations({ User, BeryllServer });


setupComponentAssociations({
    User,
    BeryllServer,
    BeryllDefectRecord,
    BeryllServerComponent
});


YadroTicketLog.belongsTo(BeryllServer, { foreignKey: "serverId", as: "server" });
YadroTicketLog.belongsTo(BeryllDefectRecord, { foreignKey: "defectRecordId", as: "defectRecord" });
YadroTicketLog.belongsTo(User, { foreignKey: "createdById", as: "createdBy" });

BeryllServer.hasMany(YadroTicketLog, { foreignKey: "serverId", as: "yadroLogs" });
BeryllDefectRecord.hasMany(YadroTicketLog, { foreignKey: "defectRecordId", as: "yadroLogs" });


SubstituteServerPool.belongsTo(BeryllServer, { foreignKey: "serverId", as: "server" });
SubstituteServerPool.belongsTo(BeryllDefectRecord, { foreignKey: "currentDefectId", as: "currentDefect" });
SubstituteServerPool.belongsTo(User, { foreignKey: "issuedToUserId", as: "issuedTo" });

BeryllServer.hasOne(SubstituteServerPool, { foreignKey: "serverId", as: "substitutePoolEntry" });


UserAlias.belongsTo(User, { foreignKey: "userId", as: "user" });
User.hasMany(UserAlias, { foreignKey: "userId", as: "aliases" });


BeryllClusterRack.belongsTo(BeryllCluster, { foreignKey: "clusterId", as: "cluster" });
BeryllClusterRack.belongsTo(BeryllRack, { foreignKey: "rackId", as: "rack" });
BeryllCluster.hasMany(BeryllClusterRack, { foreignKey: "clusterId", as: "rackAssignments" });
BeryllRack.hasMany(BeryllClusterRack, { foreignKey: "rackId", as: "clusterAssignments" });


BeryllDefectRecord.belongsTo(BeryllServerComponent, {
    foreignKey: "defectComponentId",
    as: "defectComponent"
});
BeryllDefectRecord.belongsTo(BeryllServerComponent, {
    foreignKey: "replacementComponentId",
    as: "replacementComponent"
});

BeryllDefectRecord.belongsTo(ComponentInventory, {
    foreignKey: "defectInventoryId",
    as: "defectInventoryItem"
});
BeryllDefectRecord.belongsTo(ComponentInventory, {
    foreignKey: "replacementInventoryId",
    as: "replacementInventoryItem"
});


BeryllDefectRecord.belongsTo(BeryllServer, {
    foreignKey: "substituteServerId",
    as: "substituteServer"
});
BeryllServer.hasMany(BeryllDefectRecord, {
    foreignKey: "substituteServerId",
    as: "substituteForDefects"
});


ProductionOutput.belongsTo(User, { foreignKey: "userId", as: "user" });
User.hasMany(ProductionOutput, { foreignKey: "userId", as: "productionOutputs" });


ProductionOutput.belongsTo(User, { foreignKey: "approvedById", as: "approvedBy" });


ProductionOutput.belongsTo(User, { foreignKey: "createdById", as: "createdBy" });


ProductionOutput.belongsTo(Team, { foreignKey: "teamId", as: "production_team" });
Team.hasMany(ProductionOutput, { foreignKey: "teamId", as: "outputs" });


ProductionOutput.belongsTo(Section, { foreignKey: "sectionId", as: "production_section" });
Section.hasMany(ProductionOutput, { foreignKey: "sectionId", as: "outputs" });


ProductionOutput.belongsTo(Project, { foreignKey: "projectId", as: "project" });
Project.hasMany(ProductionOutput, { foreignKey: "projectId", as: "outputs" });


ProductionOutput.belongsTo(ProductionTask, { foreignKey: "taskId", as: "task" });
ProductionTask.hasMany(ProductionOutput, { foreignKey: "taskId", as: "outputs" });


ProductionOutput.belongsTo(OperationType, { foreignKey: "operationTypeId", as: "operationType" });
OperationType.hasMany(ProductionOutput, { foreignKey: "operationTypeId", as: "outputs" });


Project.belongsTo(User, { foreignKey: "createdById", as: "author" });
User.hasMany(Project, { foreignKey: "createdById", as: "projects" });


module.exports = {

    User, PC, Session, AuditLog, Role, Ability, RoleAbility,


    Section, Team,


    FC, CategoryDefect,
    ELRS915, CategoryDefect915,
    ELRS2_4, CategoryDefect2_4,
    CoralB, CategoryDefect_CoralB,


    Supply, WarehouseBox, WarehouseMovement,
    WarehouseDocument, InventoryLimit,
    ProductionTask, Project, PrintHistory,


    AssemblyRoute, AssemblyRouteStep,
    AssemblyRecipe, RecipeStep, AssemblyProcess,


    BeryllServer,
    BeryllBatch,
    BeryllHistory,
    BeryllChecklistTemplate,
    BeryllServerChecklist,
    BeryllDefectComment,
    BeryllDefectFile,
    BeryllServerComponent,


    DEFECT_CATEGORIES,
    DEFECT_PRIORITIES,
    DEFECT_STATUSES,
    BERYLL_COMPONENT_TYPES,
    COMPONENT_STATUSES,


    DefectCategory,
    BoardDefect,
    RepairAction,
    BOARD_TYPES,
    BOARD_DEFECT_STATUSES,
    ACTION_TYPES,


    BeryllRack,
    BeryllRackUnit,
    BeryllShipment,
    BeryllCluster,
    BeryllClusterServer,
    BeryllDefectRecord,
    BeryllDefectRecordFile,
    BeryllExtendedHistory,


    RACK_STATUSES,
    SHIPMENT_STATUSES,
    CLUSTER_STATUSES,
    SERVER_ROLES,
    DEFECT_RECORD_STATUSES,
    REPAIR_PART_TYPES,


    ComponentCatalog,
    ComponentInventory,
    ComponentHistory,
    COMPONENT_TYPES,
    INVENTORY_STATUSES,
    COMPONENT_CONDITIONS,
    HISTORY_ACTIONS,


    YadroTicketLog,
    SubstituteServerPool,
    SlaConfig,
    UserAlias,
    BeryllClusterRack,
    YADRO_REQUEST_TYPES,
    YADRO_LOG_STATUSES,
    SUBSTITUTE_STATUSES,


    ProductionOutput,
    OperationType,
    OUTPUT_STATUSES
};

================================================================================
FILE: QMS-Server-master/package.json
================================================================================

{
  "name": "fc-server",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "dev": "nodemon index.js",
    "start": "node index.js",
    "test": "cross-env NODE_ENV=test jest --detectOpenHandles",
    "test:watch": "cross-env NODE_ENV=test jest --watch",
    "test:coverage": "cross-env NODE_ENV=test jest --coverage"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "axios": "^1.13.2",
    "cors": "^2.8.5",
    "dotenv": "^16.4.7",
    "exceljs": "^4.4.0",
    "express": "^4.21.2",
    "express-fileupload": "^1.5.1",
    "express-oauth2-jwt-bearer": "^1.7.1",
    "jsonwebtoken": "^9.0.2",
    "multer": "^2.0.2",
    "node-ssh": "^13.2.1",
    "pdfmake": "^0.2.20",
    "pg": "^8.13.1",
    "pg-hstore": "^2.3.4",
    "sequelize": "^6.37.5",
    "uuid": "^11.1.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "cross-env": "^7.0.3",
    "jest": "^29.7.0",
    "nodemon": "^3.1.9",
    "supertest": "^6.3.3"
  }
}

================================================================================
FILE: QMS-Server-master/routes/CoralBRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const CoralB_Controller = require("../controllers/coralB_Controller");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post("/", ...protect, checkAbility("firmware.flash"), CoralB_Controller.postBoard);

router.post(
  "/addManyDefectCoralB",
  ...protect,
  checkAbility("firmware.flash"),
  CoralB_Controller.postManyDefectCoralB
);

router.post(
  "/deleteManyDefectCoralB",
  ...protect,
  checkAbility("defect.manage"),
  CoralB_Controller.deleteManyDefectCoralB
);

router.get("/", CoralB_Controller.getBoards);

router.put("/", ...protect, checkAbility("defect.manage"), CoralB_Controller.updateBoard);

router.delete(
  "/byDBid/:id",
  ...protect,
  checkAbility("defect.manage"),
  CoralB_Controller.deleteBoardByDBid
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/ELRS2_4_Router.js
================================================================================

const Router = require("express");
const router = new Router();
const Controller = require("../controllers/ELRS2_4_Controller");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post("/", ...protect, checkAbility("firmware.flash"), Controller.postBoard);
router.post("/addManyDefect2-4", ...protect, checkAbility("firmware.flash"), Controller.postManyDefect24);


router.post("/deleteManyDefect2-4", ...protect, checkAbility("defect.manage"), Controller.deleteManyDefect24);
router.delete("/byDBid/:id", ...protect, checkAbility("defect.manage"), Controller.deleteBoardByDBid);
router.put("/", ...protect, checkAbility("defect.manage"), Controller.updateBoard);


router.get("/", ...protect, checkAbility("devices.view"), Controller.getBoards);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/ELRS915_Router.js
================================================================================

const Router = require("express");
const router = new Router();
const ELRS915_Controller = require("../controllers/ELRS915_Controller");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post(
    "/",
    ...protect,
    checkAbility("firmware.flash"),
    ELRS915_Controller.postBoard
);

router.post(
    "/addManyDefect915",
    ...protect,
    checkAbility("firmware.flash"),
    ELRS915_Controller.postManyDefect915
);


router.post(
    "/deleteManyDefect915",
    ...protect,
    checkAbility("defect.manage"),
    ELRS915_Controller.deleteManyDefect915
);

router.delete(
    "/byDBid/:id",
    ...protect,
    checkAbility("defect.manage"),
    ELRS915_Controller.deleteBoardByDBid
);


router.get(
    "/",
    ...protect,
    checkAbility("devices.view"),
    ELRS915_Controller.getBoards
);


router.put(
    "/",
    ...protect,
    checkAbility("defect.manage"),
    ELRS915_Controller.updateBoard
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/assemblyRecipeRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const controller = require("../controllers/assemblyRecipeController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/project/:projectId", ...protect, checkAbility("assembly.execute"), controller.getByProject);


router.post("/", ...protect, checkAbility("recipe.manage"), controller.createOrUpdate);

router.post("/process/start", ...protect, checkAbility("assembly.execute"), controller.startAssembly);
router.put("/process/:id/step", ...protect, checkAbility("assembly.execute"), controller.updateProcessStep);
router.post("/process/:id/finish", ...protect, checkAbility("assembly.execute"), controller.finishAssembly);

router.get("/history/list", ...protect, checkAbility("devices.view"), controller.getAssembledList);
router.get("/history/:processId/passport", ...protect, checkAbility("devices.view"), controller.getAssemblyPassport);

router.put("/history/:id", ...protect, checkAbility("defect.report"), controller.updatePassport);

module.exports = router;
================================================================================
FILE: QMS-Server-master/routes/assemblyRouter.js
================================================================================

const Router = require("express");
const router = new Router();

const assemblyController = require("../controllers/assemblyController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/routes", ...protect, assemblyController.getRoutes);
router.get("/routes/:id", ...protect, assemblyController.getRouteById);

router.post(
  "/routes",
  ...protect,
  checkAbility("recipe.manage"),
  assemblyController.createRoute
);
router.put(
  "/routes/:id",
  ...protect,
  checkAbility("recipe.manage"),
  assemblyController.updateRoute
);
router.delete(
  "/routes/:id",
  ...protect,
  checkAbility("recipe.manage"),
  assemblyController.deleteRoute
);

module.exports = router;
================================================================================
FILE: QMS-Server-master/routes/auditRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const auditController = require("../controllers/auditController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");


const protect = [
    authMiddleware,
    syncUserMiddleware,
    checkAbility("rbac.manage")
];

router.get("/", ...protect, auditController.getLogs);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/beryll/beryllExtendedRoutes.js
================================================================================



const Router = require("express");
const router = new Router();


const ComponentInventoryController = require("../controllers/ComponentInventoryController");
const DefectRecordController = require("../controllers/DefectRecordController");
const YadroController = require("../controllers/YadroController");
const DefectExportController = require("../../controllers/beryll/controllers/DefectExportController");


const authMiddleware = require("../../../middleware/authMiddleware");
const checkAbilityMiddleware = require("../../../middleware/checkAbilityMiddleware");


router.get("/inventory/catalog",
    authMiddleware,
    ComponentInventoryController.getCatalog
);
router.post("/inventory/catalog",
    authMiddleware,
    checkAbilityMiddleware("beryll_component_manage"),
    ComponentInventoryController.createCatalogEntry
);
router.put("/inventory/catalog/:id",
    authMiddleware,
    checkAbilityMiddleware("beryll_component_manage"),
    ComponentInventoryController.updateCatalogEntry
);


router.get("/inventory",
    authMiddleware,
    ComponentInventoryController.getAll
);
router.get("/inventory/stats",
    authMiddleware,
    ComponentInventoryController.getStats
);
router.get("/inventory/warranty-expiring",
    authMiddleware,
    ComponentInventoryController.getWarrantyExpiring
);
router.get("/inventory/available/:type",
    authMiddleware,
    ComponentInventoryController.getAvailableByType
);
router.get("/inventory/serial/:serial",
    authMiddleware,
    ComponentInventoryController.getBySerial
);
router.get("/inventory/:id",
    authMiddleware,
    ComponentInventoryController.getById
);
router.get("/inventory/:id/history",
    authMiddleware,
    ComponentInventoryController.getHistory
);


router.post("/inventory",
    authMiddleware,
    checkAbilityMiddleware("beryll_component_manage"),
    ComponentInventoryController.create
);
router.post("/inventory/bulk",
    authMiddleware,
    checkAbilityMiddleware("beryll_component_manage"),
    ComponentInventoryController.bulkCreate
);


router.post("/inventory/:id/reserve",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    ComponentInventoryController.reserve
);
router.post("/inventory/:id/release",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    ComponentInventoryController.release
);
router.post("/inventory/:id/install",
    authMiddleware,
    checkAbilityMiddleware("beryll_component_manage"),
    ComponentInventoryController.installToServer
);
router.post("/inventory/:id/remove",
    authMiddleware,
    checkAbilityMiddleware("beryll_component_manage"),
    ComponentInventoryController.removeFromServer
);
router.post("/inventory/:id/send-to-yadro",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    ComponentInventoryController.sendToYadro
);
router.post("/inventory/:id/return-from-yadro",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    ComponentInventoryController.returnFromYadro
);
router.post("/inventory/:id/scrap",
    authMiddleware,
    checkAbilityMiddleware("beryll_component_manage"),
    ComponentInventoryController.scrap
);
router.post("/inventory/:id/location",
    authMiddleware,
    checkAbilityMiddleware("beryll_component_manage"),
    ComponentInventoryController.updateLocation
);
router.post("/inventory/:id/test",
    authMiddleware,
    checkAbilityMiddleware("beryll_component_manage"),
    ComponentInventoryController.markTested
);


router.get("/defects/part-types",
    authMiddleware,
    DefectRecordController.getRepairPartTypes
);
router.get("/defects/statuses",
    authMiddleware,
    DefectRecordController.getStatuses
);
router.get("/defects/stats",
    authMiddleware,
    DefectRecordController.getStats
);


router.get("/defects/export",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_view"),
    DefectExportController.exportDefects
);
router.get("/defects/export/stats",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_view"),
    DefectExportController.exportStats
);


router.get("/defects",
    authMiddleware,
    DefectRecordController.getAll
);
router.get("/defects/:id",
    authMiddleware,
    DefectRecordController.getById
);
router.post("/defects",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_create"),
    DefectRecordController.create
);


router.post("/defects/:id/start-diagnosis",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.startDiagnosis
);
router.post("/defects/:id/complete-diagnosis",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.completeDiagnosis
);


router.post("/defects/:id/waiting-parts",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.setWaitingParts
);
router.post("/defects/:id/reserve-component",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.reserveComponent
);


router.post("/defects/:id/start-repair",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.startRepair
);
router.post("/defects/:id/perform-replacement",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.performReplacement
);


router.post("/defects/:id/send-to-yadro",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.sendToYadro
);
router.post("/defects/:id/return-from-yadro",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.returnFromYadro
);


router.post("/defects/:id/issue-substitute",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.issueSubstitute
);
router.post("/defects/:id/return-substitute",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.returnSubstitute
);


router.post("/defects/:id/resolve",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    DefectRecordController.resolve
);


router.get("/yadro/request-types",
    authMiddleware,
    YadroController.getRequestTypes
);
router.get("/yadro/log-statuses",
    authMiddleware,
    YadroController.getLogStatuses
);


router.get("/yadro/logs",
    authMiddleware,
    YadroController.getAllLogs
);
router.get("/yadro/logs/open",
    authMiddleware,
    YadroController.getOpenLogs
);
router.get("/yadro/logs/stats",
    authMiddleware,
    YadroController.getLogStats
);
router.get("/yadro/logs/:id",
    authMiddleware,
    YadroController.getLogById
);
router.post("/yadro/logs",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    YadroController.createLog
);
router.put("/yadro/logs/:id/status",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    YadroController.updateLogStatus
);


router.get("/substitutes",
    authMiddleware,
    YadroController.getAllSubstitutes
);
router.get("/substitutes/available",
    authMiddleware,
    YadroController.getAvailableSubstitutes
);
router.get("/substitutes/stats",
    authMiddleware,
    YadroController.getSubstituteStats
);
router.post("/substitutes",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    YadroController.addToSubstitutePool
);
router.delete("/substitutes/:id",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    YadroController.removeFromSubstitutePool
);
router.post("/substitutes/:id/issue",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    YadroController.issueSubstitute
);
router.post("/substitutes/:id/return",
    authMiddleware,
    checkAbilityMiddleware("beryll_defect_manage"),
    YadroController.returnSubstitute
);
router.post("/substitutes/:id/maintenance",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    YadroController.setSubstituteMaintenance
);


router.get("/sla",
    authMiddleware,
    YadroController.getAllSlaConfigs
);
router.post("/sla",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    YadroController.createSlaConfig
);
router.put("/sla/:id",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    YadroController.updateSlaConfig
);
router.delete("/sla/:id",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    YadroController.deleteSlaConfig
);


router.get("/aliases",
    authMiddleware,
    YadroController.getAllAliases
);
router.get("/aliases/find/:alias",
    authMiddleware,
    YadroController.findUserByAlias
);
router.post("/aliases",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    YadroController.createAlias
);
router.delete("/aliases/:id",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    YadroController.deleteAlias
);
router.post("/aliases/generate/:userId",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    YadroController.generateAliasesForUser
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/beryll/importRoutes.js
================================================================================



const Router = require("express");
const router = new Router();

const ImportController = require("../controllers/ImportController");
const authMiddleware = require("../../../middleware/authMiddleware");
const checkAbilityMiddleware = require("../../../middleware/checkAbilityMiddleware");


router.post("/server-components",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    ImportController.importServerComponents
);


router.post("/defect-records",
    authMiddleware,
    checkAbilityMiddleware("beryll_admin"),
    ImportController.importDefectRecords
);


router.get("/template/server-components",
    authMiddleware,
    ImportController.downloadServerComponentsTemplate
);

router.get("/template/defect-records",
    authMiddleware,
    ImportController.downloadDefectRecordsTemplate
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/beryllExtendedRouter.js
================================================================================

const Router = require("express");
const router = new Router();

const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const RackController = require("../controllers/beryll/controllers/RackController");
const ClusterController = require("../controllers/beryll/controllers/ClusterController");
const DefectRecordController = require("../controllers/beryll/controllers/DefectRecordController");
const YadroController = require("../controllers/beryll/controllers/YadroController");
const DefectExportController = require("../controllers/beryll/controllers/DefectExportController");
const CatalogExtendedController = require("../controllers/beryll/CatalogExtendedController");
const ComponentInventoryController = require("../controllers/beryll/controllers/ComponentInventoryController");
const {
  addComponent,
  addComponentsBatch,
  updateComponent,
  updateSerials,
  replaceComponent,
  deleteComponent,
  searchComponent,
  scanYadroSerial,
  checkSerialUniqueness,
  getComponentHistory,
  getServerComponentsHistory
} = require("../controllers/beryll/ComponentsExtendedController");

const protect = [authMiddleware, syncUserMiddleware];


router.post("/servers/create", ...protect, checkAbility("beryll.work"), RackController.createServer);


router.post("/servers/create-and-place", ...protect, checkAbility("beryll.work"), RackController.createAndPlaceServer);


router.get("/dhcp/find-server/:serial", ...protect, checkAbility("beryll.view"), RackController.findServerInDhcp);


router.get("/racks", ...protect, checkAbility("beryll.view"), RackController.getAllRacks);
router.get("/racks/:id", ...protect, checkAbility("beryll.view"), RackController.getRackById);
router.post("/racks", ...protect, checkAbility("beryll.manage"), RackController.createRack);
router.put("/racks/:id", ...protect, checkAbility("beryll.manage"), RackController.updateRack);
router.delete("/racks/:id", ...protect, checkAbility("beryll.manage"), RackController.deleteRack);
router.get("/racks/:id/history", ...protect, checkAbility("beryll.view"), RackController.getRackHistory);


router.get("/racks/:rackId/summary", ...protect, checkAbility("beryll.view"), RackController.getRackSummary);


router.post("/racks/:rackId/sync-dhcp", ...protect, checkAbility("beryll.work"), RackController.syncWithDhcp);


router.get("/racks/:rackId/free-units", ...protect, checkAbility("beryll.view"), RackController.getFreeUnits);
router.get("/racks/:rackId/units/:unitNumber", ...protect, checkAbility("beryll.view"), RackController.getUnit);
router.put("/rack-units/:unitId", ...protect, checkAbility("beryll.work"), RackController.updateUnit);
router.post("/rack-units/move", ...protect, checkAbility("beryll.work"), RackController.moveServer);


router.get("/racks/:rackId/units-by-status", ...protect, checkAbility("beryll.view"), RackController.getUnitsByStatus);


router.post("/racks/:rackId/units/:unitNumber/place", ...protect, checkAbility("beryll.work"), RackController.placeServer);


router.post("/racks/:rackId/units/:unitNumber/install", ...protect, checkAbility("beryll.work"), RackController.installServer);


router.post("/racks/:rackId/units/:unitNumber/remove", ...protect, checkAbility("beryll.work"), RackController.removeServer);


router.get("/servers/:serverId/rack-location", ...protect, checkAbility("beryll.view"), RackController.findServerInRacks);


router.get("/dhcp/find-ip/:mac", ...protect, checkAbility("beryll.view"), RackController.findIpByMac);


router.get("/shipments", ...protect, checkAbility("beryll.view"), ClusterController.getAllShipments);
router.get("/shipments/:id", ...protect, checkAbility("beryll.view"), ClusterController.getShipmentById);
router.post("/shipments", ...protect, checkAbility("beryll.manage"), ClusterController.createShipment);
router.put("/shipments/:id", ...protect, checkAbility("beryll.manage"), ClusterController.updateShipment);
router.delete("/shipments/:id", ...protect, checkAbility("beryll.manage"), ClusterController.deleteShipment);
router.get("/shipments/:id/history", ...protect, checkAbility("beryll.view"), ClusterController.getShipmentHistory);


router.get("/clusters", ...protect, checkAbility("beryll.view"), ClusterController.getAllClusters);
router.get("/clusters/:id", ...protect, checkAbility("beryll.view"), ClusterController.getClusterById);
router.post("/clusters", ...protect, checkAbility("beryll.manage"), ClusterController.createCluster);
router.put("/clusters/:id", ...protect, checkAbility("beryll.manage"), ClusterController.updateCluster);
router.delete("/clusters/:id", ...protect, checkAbility("beryll.manage"), ClusterController.deleteCluster);
router.get("/clusters/:id/history", ...protect, checkAbility("beryll.view"), ClusterController.getClusterHistory);
router.post("/clusters/:clusterId/servers", ...protect, checkAbility("beryll.work"), ClusterController.addServerToCluster);
router.post("/clusters/:clusterId/servers/bulk", ...protect, checkAbility("beryll.work"), ClusterController.addServersToCluster);
router.delete("/clusters/:clusterId/servers/:serverId", ...protect, checkAbility("beryll.work"), ClusterController.removeServerFromCluster);
router.put("/cluster-servers/:id", ...protect, checkAbility("beryll.work"), ClusterController.updateClusterServer);
router.get("/servers/unassigned", ...protect, checkAbility("beryll.view"), ClusterController.getUnassignedServers);
router.get("/servers/:serverId/clusters", ...protect, checkAbility("beryll.view"), ClusterController.getServerClusters);


router.get("/catalog/grouped",       ...protect, checkAbility("beryll.view"),   CatalogExtendedController.getCatalogGrouped);
router.get("/catalog/stats",         ...protect, checkAbility("beryll.view"),   CatalogExtendedController.getCatalogStats);
router.get("/catalog/types",         ...protect, checkAbility("beryll.view"),   CatalogExtendedController.getCatalogTypes);
router.get("/catalog/search",        ...protect, checkAbility("beryll.view"),   CatalogExtendedController.searchCatalog);
router.get("/catalog/export",        ...protect, checkAbility("beryll.manage"), CatalogExtendedController.exportCatalog);
router.post("/catalog/batch",        ...protect, checkAbility("beryll.manage"), CatalogExtendedController.batchCreateCatalog);


router.get("/catalog",               ...protect, checkAbility("beryll.view"),   ComponentInventoryController.getCatalog);
router.post("/catalog",              ...protect, checkAbility("beryll.manage"), ComponentInventoryController.createCatalogEntry);
router.put("/catalog/:id",           ...protect, checkAbility("beryll.manage"), ComponentInventoryController.updateCatalogEntry);


router.delete("/catalog/:id",        ...protect, checkAbility("beryll.manage"), CatalogExtendedController.deleteCatalogEntry);
router.post("/catalog/:id/restore",  ...protect, checkAbility("beryll.manage"), CatalogExtendedController.restoreCatalogEntry);


router.get("/components/search", ...protect, checkAbility("beryll.view"), searchComponent);
router.get("/components/scan", ...protect, checkAbility("beryll.view"), scanYadroSerial);
router.post("/components/check-serial", ...protect, checkAbility("beryll.view"), checkSerialUniqueness);


router.post("/servers/:id/components", ...protect, checkAbility("beryll.work"), addComponent);
router.post("/servers/:id/components/batch", ...protect, checkAbility("beryll.work"), addComponentsBatch);
router.get("/servers/:id/components/history", ...protect, checkAbility("beryll.view"), getServerComponentsHistory);


router.put("/components/:id", ...protect, checkAbility("beryll.work"), updateComponent);
router.patch("/components/:id/serials", ...protect, checkAbility("beryll.work"), updateSerials);
router.post("/components/:id/replace", ...protect, checkAbility("beryll.work"), replaceComponent);
router.delete("/components/:id", ...protect, checkAbility("beryll.work"), deleteComponent);
router.get("/components/:id/history", ...protect, checkAbility("beryll.view"), getComponentHistory);


router.get("/defect-records/part-types", ...protect, checkAbility("beryll.view"), DefectRecordController.getRepairPartTypes);
router.get("/defect-records/statuses", ...protect, checkAbility("beryll.view"), DefectRecordController.getStatuses);
router.get("/defect-records/stats", ...protect, checkAbility("beryll.view"), DefectRecordController.getStats);


router.get("/defect-records/export", ...protect, checkAbility("beryll.view"), DefectExportController.exportDefects);
router.get("/defect-records/export/stats", ...protect, checkAbility("beryll.view"), DefectExportController.exportStats);


router.get("/defect-records", ...protect, checkAbility("beryll.view"), DefectRecordController.getAll);
router.post("/defect-records", ...protect, checkAbility("beryll.work"), DefectRecordController.create);
router.get("/defect-records/:id", ...protect, checkAbility("beryll.view"), DefectRecordController.getById);
router.put("/defect-records/:id", ...protect, checkAbility("beryll.work"), DefectRecordController.update);
router.delete("/defect-records/:id", ...protect, checkAbility("beryll.manage"), DefectRecordController.delete);


router.put("/defect-records/:id/status", ...protect, checkAbility("beryll.work"), DefectRecordController.changeStatus);


router.post("/defect-records/:id/start-diagnosis", ...protect, checkAbility("beryll.work"), DefectRecordController.startDiagnosis);
router.post("/defect-records/:id/complete-diagnosis", ...protect, checkAbility("beryll.work"), DefectRecordController.completeDiagnosis);


router.post("/defect-records/:id/waiting-parts", ...protect, checkAbility("beryll.work"), DefectRecordController.setWaitingParts);
router.post("/defect-records/:id/reserve-component", ...protect, checkAbility("beryll.work"), DefectRecordController.reserveComponent);


router.post("/defect-records/:id/start-repair", ...protect, checkAbility("beryll.work"), DefectRecordController.startRepair);
router.post("/defect-records/:id/perform-replacement", ...protect, checkAbility("beryll.work"), DefectRecordController.performReplacement);


router.post("/defect-records/:id/send-to-yadro", ...protect, checkAbility("beryll.work"), DefectRecordController.sendToYadro);
router.post("/defect-records/:id/return-from-yadro", ...protect, checkAbility("beryll.work"), DefectRecordController.returnFromYadro);


router.post("/defect-records/:id/issue-substitute", ...protect, checkAbility("beryll.work"), DefectRecordController.issueSubstitute);
router.post("/defect-records/:id/return-substitute", ...protect, checkAbility("beryll.work"), DefectRecordController.returnSubstitute);


router.post("/defect-records/:id/resolve", ...protect, checkAbility("beryll.work"), DefectRecordController.resolve);
router.post("/defect-records/:id/mark-repeated", ...protect, checkAbility("beryll.work"), DefectRecordController.markAsRepeated);


router.get("/defect-records/:id/files", ...protect, checkAbility("beryll.view"), DefectRecordController.getFiles);
router.post("/defect-records/:id/files", ...protect, checkAbility("beryll.work"), DefectRecordController.uploadFile);
router.get("/defect-record-files/:fileId", ...protect, checkAbility("beryll.view"), DefectRecordController.downloadFile);
router.delete("/defect-record-files/:fileId", ...protect, checkAbility("beryll.work"), DefectRecordController.deleteFile);


router.get("/yadro/logs", ...protect, checkAbility("beryll.view"), YadroController.getAllLogs);
router.get("/yadro/logs/open", ...protect, checkAbility("beryll.view"), YadroController.getOpenLogs);
router.get("/yadro/logs/stats", ...protect, checkAbility("beryll.view"), YadroController.getLogStats);
router.get("/yadro/logs/:id", ...protect, checkAbility("beryll.view"), YadroController.getLogById);
router.post("/yadro/logs", ...protect, checkAbility("beryll.work"), YadroController.createLog);
router.put("/yadro/logs/:id", ...protect, checkAbility("beryll.work"), YadroController.updateLog);
router.put("/yadro/logs/:id/status", ...protect, checkAbility("beryll.work"), YadroController.updateLogStatus);
router.delete("/yadro/logs/:id", ...protect, checkAbility("beryll.work"), YadroController.deleteLog);
router.post("/yadro/logs/:id/link-server", ...protect, checkAbility("beryll.work"), YadroController.linkLogToServer);
router.get("/yadro/request-types", ...protect, checkAbility("beryll.view"), YadroController.getRequestTypes);
router.get("/yadro/log-statuses", ...protect, checkAbility("beryll.view"), YadroController.getLogStatuses);


router.get("/substitutes", ...protect, checkAbility("beryll.view"), YadroController.getAllSubstitutes);
router.get("/substitutes/available", ...protect, checkAbility("beryll.view"), YadroController.getAvailableSubstitutes);
router.get("/substitutes/stats", ...protect, checkAbility("beryll.view"), YadroController.getSubstituteStats);
router.post("/substitutes", ...protect, checkAbility("beryll.manage"), YadroController.addToSubstitutePool);
router.delete("/substitutes/:id", ...protect, checkAbility("beryll.manage"), YadroController.removeFromSubstitutePool);
router.post("/substitutes/:id/issue", ...protect, checkAbility("beryll.work"), YadroController.issueSubstitute);
router.post("/substitutes/:id/return", ...protect, checkAbility("beryll.work"), YadroController.returnSubstitute);
router.post("/substitutes/:id/maintenance", ...protect, checkAbility("beryll.work"), YadroController.setSubstituteMaintenance);


router.get("/sla", ...protect, checkAbility("beryll.view"), YadroController.getAllSlaConfigs);
router.post("/sla", ...protect, checkAbility("beryll.manage"), YadroController.createSlaConfig);
router.put("/sla/:id", ...protect, checkAbility("beryll.manage"), YadroController.updateSlaConfig);
router.delete("/sla/:id", ...protect, checkAbility("beryll.manage"), YadroController.deleteSlaConfig);


router.get("/aliases", ...protect, checkAbility("beryll.view"), YadroController.getAllAliases);
router.get("/aliases/find/:alias", ...protect, checkAbility("beryll.view"), YadroController.findUserByAlias);
router.post("/aliases", ...protect, checkAbility("beryll.manage"), YadroController.createAlias);
router.delete("/aliases/:id", ...protect, checkAbility("beryll.manage"), YadroController.deleteAlias);
router.post("/aliases/generate/:userId", ...protect, checkAbility("beryll.manage"), YadroController.generateAliasesForUser);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/beryllRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const multer = require("multer");
const path = require("path");

const beryllController = require("../controllers/beryll");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");
const DefectMonitoringController = require("../controllers/beryll/controllers/DefectMonitoringController");
const ComponentsController = require("../controllers/beryll/controllers/ComponentsController");
const ChecklistController = require("../controllers/beryll/controllers/ChecklistController");


const protect = [authMiddleware, syncUserMiddleware];


const defectStorage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, path.join(__dirname, "../uploads/beryll/defects"));
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + "-" + Math.round(Math.random() * 1e9);
    cb(null, uniqueSuffix + "-" + file.originalname);
  }
});
const defectUpload = multer({
  storage: defectStorage,
  limits: { fileSize: 10 * 1024 * 1024 }
});


router.post(
  "/sync",
  ...protect,
  checkAbility("beryll.manage"),
  beryllController.syncWithDhcp
);


router.get(
  "/servers",
  ...protect,
  checkAbility("beryll.view"),
  beryllController.getServers
);

router.get(
  "/stats",
  ...protect,
  checkAbility("beryll.view"),
  beryllController.getStats
);

router.get(
  "/analytics",
  ...protect,
  checkAbility("beryll.view"),
  beryllController.getAnalytics
);

router.get(
  "/servers/:id",
  ...protect,
  checkAbility("beryll.view"),
  beryllController.getServerById
);

router.post(
  "/servers/:id/take",
  ...protect,
  checkAbility("beryll.work"),
  beryllController.takeServer
);

router.post(
  "/servers/:id/release",
  ...protect,
  checkAbility("beryll.work"),
  beryllController.releaseServer
);

router.put(
  "/servers/:id/status",
  ...protect,
  checkAbility("beryll.work"),
  beryllController.updateStatus
);

router.put(
  "/servers/:id/notes",
  ...protect,
  checkAbility("beryll.work"),
  beryllController.updateNotes
);

router.delete(
  "/servers/:id",
  ...protect,
  checkAbility("beryll.manage"),
  beryllController.deleteServer
);


router.get(
  "/servers/:serverId/checklist",
  ...protect,
  checkAbility("beryll.view"),
  ChecklistController.getServerChecklist
);


router.put(
  "/servers/:serverId/checklist/:checklistId",
  ...protect,
  checkAbility("beryll.work"),
  ChecklistController.toggleChecklistItem
);


router.post(
  "/servers/:serverId/checklist/:checklistId/file",
  ...protect,
  checkAbility("beryll.work"),
  ChecklistController.uploadChecklistFile
);


router.get(
  "/servers/:serverId/files",
  ...protect,
  checkAbility("beryll.view"),
  ChecklistController.getServerFiles
);


router.get(
  "/batches",
  ...protect,
  checkAbility("beryll.view"),
  beryllController.getBatches
);

router.get(
  "/batches/:id",
  ...protect,
  checkAbility("beryll.view"),
  beryllController.getBatchById
);

router.post(
  "/batches",
  ...protect,
  checkAbility("beryll.manage"),
  beryllController.createBatch
);

router.put(
  "/batches/:id",
  ...protect,
  checkAbility("beryll.manage"),
  beryllController.updateBatch
);

router.delete(
  "/batches/:id",
  ...protect,
  checkAbility("beryll.manage"),
  beryllController.deleteBatch
);

router.post(
  "/batches/:id/assign",
  ...protect,
  checkAbility("beryll.manage"),
  beryllController.assignServersToBatch
);

router.post(
  "/batches/:id/remove",
  ...protect,
  checkAbility("beryll.manage"),
  beryllController.removeServersFromBatch
);


router.get(
  "/history",
  ...protect,
  checkAbility("beryll.view"),
  beryllController.getHistory
);


router.get(
  "/checklists/templates",
  ...protect,
  checkAbility("beryll.view"),
  ChecklistController.getChecklistTemplates
);


router.post(
  "/checklists/templates",
  ...protect,
  checkAbility("beryll.manage"),
  ChecklistController.createChecklistTemplate
);


router.put(
  "/checklists/templates/reorder",
  ...protect,
  checkAbility("beryll.manage"),
  ChecklistController.reorderChecklistTemplates
);


router.put(
  "/checklists/templates/:id",
  ...protect,
  checkAbility("beryll.manage"),
  ChecklistController.updateChecklistTemplate
);


router.delete(
  "/checklists/templates/:id",
  ...protect,
  checkAbility("beryll.manage"),
  ChecklistController.deleteChecklistTemplate
);


router.post(
  "/checklists/templates/:id/restore",
  ...protect,
  checkAbility("beryll.manage"),
  ChecklistController.restoreChecklistTemplate
);


router.get(
  "/files/:fileId",
  ChecklistController.downloadFile
);


router.delete(
  "/checklists/files/:fileId",
  ...protect,
  checkAbility("beryll.work"),
  ChecklistController.deleteChecklistFile
);


router.get(
  "/archive",
  ...protect,
  checkAbility("beryll.view"),
  beryllController.getArchivedServers
);

router.post(
  "/servers/:id/unarchive",
  ...protect,
  checkAbility("beryll.manage"),
  beryllController.unarchiveServer
);

router.post(
  "/servers/:id/archive",
  ...protect,
  checkAbility("beryll.manage"),
  beryllController.archiveServer
);


router.put(
  "/servers/:id/apk-serial",
  ...protect,
  checkAbility("beryll.work"),
  beryllController.updateApkSerialNumber
);


router.get(
  "/servers/:id/passport",
  ...protect,
  checkAbility("beryll.view"),
  beryllController.generatePassport
);


router.get(
  "/monitoring/stats",
  ...protect,
  checkAbility("beryll.view"),
  DefectMonitoringController.getMonitoringStats
);

router.get(
  "/monitoring/status",
  ...protect,
  checkAbility("beryll.view"),
  DefectMonitoringController.getCachedStatus
);

router.get(
  "/monitoring/ping/:id",
  ...protect,
  checkAbility("beryll.view"),
  DefectMonitoringController.pingServer
);

router.post(
  "/monitoring/ping-all",
  ...protect,
  checkAbility("beryll.work"),
  DefectMonitoringController.pingAllServers
);

router.get(
  "/monitoring/servers/online",
  ...protect,
  checkAbility("beryll.view"),
  DefectMonitoringController.getOnlineServers
);

router.get(
  "/monitoring/servers/offline",
  ...protect,
  checkAbility("beryll.view"),
  DefectMonitoringController.getOfflineServers
);

router.post(
  "/monitoring/clear-cache",
  ...protect,
  checkAbility("beryll.manage"),
  DefectMonitoringController.clearCache
);


router.get(
  "/servers/:serverId/defects",
  ...protect,
  checkAbility("beryll.view"),
  DefectMonitoringController.getServerDefects
);

router.get(
  "/defects/stats",
  ...protect,
  checkAbility("beryll.view"),
  DefectMonitoringController.getDefectStats
);

router.post(
  "/servers/:serverId/defects",
  ...protect,
  checkAbility("beryll.work"),
  DefectMonitoringController.createDefect
);

router.get(
  "/defects/:id",
  ...protect,
  checkAbility("beryll.view"),
  DefectMonitoringController.getDefectById
);

router.put(
  "/defects/:id",
  ...protect,
  checkAbility("beryll.work"),
  DefectMonitoringController.updateDefect
);

router.delete(
  "/defects/:id",
  ...protect,
  checkAbility("beryll.work"),
  DefectMonitoringController.deleteDefect
);

router.post(
  "/defects/:id/resolve",
  ...protect,
  checkAbility("beryll.work"),
  DefectMonitoringController.resolveDefect
);


router.post(
  "/defects/:id/files",
  ...protect,
  checkAbility("beryll.work"),
  defectUpload.single("file"),
  DefectMonitoringController.uploadDefectFile
);

router.get(
  "/defect-files/:id/download",
  ...protect,
  checkAbility("beryll.view"),
  DefectMonitoringController.downloadDefectFile
);

router.delete(
  "/defect-files/:id",
  ...protect,
  checkAbility("beryll.work"),
  DefectMonitoringController.deleteDefectFile
);


router.get(
  "/servers/:id/bmc/check",
  ...protect,
  checkAbility("beryll.view"),
  ComponentsController.checkBMC
);

router.post(
  "/servers/:id/components/fetch",
  ...protect,
  checkAbility("beryll.work"),
  ComponentsController.fetchComponents
);

router.get(
  "/servers/:id/components",
  ...protect,
  checkAbility("beryll.view"),
  ComponentsController.getComponents
);

router.delete(
  "/servers/:id/components",
  ...protect,
  checkAbility("beryll.manage"),
  ComponentsController.deleteComponents
);

router.get(
  "/components/:id",
  ...protect,
  checkAbility("beryll.view"),
  ComponentsController.getComponentById
);

router.put(
  "/servers/:id/bmc-address",
  ...protect,
  checkAbility("beryll.work"),
  ComponentsController.updateBMCAddress
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/defectRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const DefectController = require("../controllers/defectController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.post("/", ...protect, checkAbility("defect.manage"), DefectController.postDefect);
router.get("/", DefectController.getDefects);
router.put("/", ...protect, checkAbility("defect.manage"), DefectController.updateDefect);
router.delete("/:id", ...protect, checkAbility("defect.manage"), DefectController.deleteDefect);

module.exports = router;
================================================================================
FILE: QMS-Server-master/routes/defectRouter2_4.js
================================================================================

const Router = require("express");
const router = new Router();
const DefectController2_4 = require("../controllers/defect2_4Controller");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post(
    "/",
    ...protect,
    checkAbility("defect.manage"),
    DefectController2_4.postDefect
);


router.get("/", DefectController2_4.getDefects);


router.put(
    "/",
    ...protect,
    checkAbility("defect.manage"),
    DefectController2_4.updateDefect
);


router.delete(
    "/:id",
    ...protect,
    checkAbility("defect.manage"),
    DefectController2_4.deleteDefect
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/defectRouter915.js
================================================================================

const Router = require("express");
const router = new Router();
const DefectController915 = require("../controllers/defect915Controller");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post(
    "/",
    ...protect,
    checkAbility("defect.manage"),
    DefectController915.postDefect
);

router.get("/", DefectController915.getDefects);


router.put(
    "/",
    ...protect,
    checkAbility("defect.manage"),
    DefectController915.updateDefect
);


router.delete(
    "/:id",
    ...protect,
    checkAbility("defect.manage"),
    DefectController915.deleteDefect
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/defectRouterCoralB.js
================================================================================

const Router = require("express");
const router = new Router();
const DefectController_CoralB = require("../controllers/defect_CoralB_Controller");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post(
    "/",
    ...protect,
    checkAbility("defect.manage"),
    DefectController_CoralB.postDefect
);


router.get("/", DefectController_CoralB.getDefects);


router.put(
    "/",
    ...protect,
    checkAbility("defect.manage"),
    DefectController_CoralB.updateDefect
);


router.delete(
    "/:id",
    ...protect,
    checkAbility("defect.manage"),
    DefectController_CoralB.deleteDefect
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/defectSystemRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const DefectSystemController = require("../controllers/defectSystemController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/categories", ...protect, DefectSystemController.getCategories);


router.post(
  "/categories",
  ...protect,
  checkAbility("defect.manage"),
  DefectSystemController.createCategory
);


router.put(
  "/categories/:id",
  ...protect,
  checkAbility("defect.manage"),
  DefectSystemController.updateCategory
);


router.delete(
  "/categories/:id",
  ...protect,
  checkAbility("defect.manage"),
  DefectSystemController.deleteCategory
);


router.get("/", ...protect, DefectSystemController.getDefects);


router.get("/statistics", ...protect, DefectSystemController.getStatistics);


router.get("/:id", ...protect, DefectSystemController.getDefectById);


router.post(
  "/",
  ...protect,
  checkAbility("defect.create"),
  DefectSystemController.createDefect
);


router.patch(
  "/:id/status",
  ...protect,
  checkAbility("defect.update"),
  DefectSystemController.updateDefectStatus
);


router.get(
  "/:defectId/repairs",
  ...protect,
  DefectSystemController.getRepairHistory
);


router.post(
  "/:defectId/repairs",
  ...protect,
  checkAbility("defect.repair"),
  DefectSystemController.addRepairAction
);


router.post(
  "/:id/repaired",
  ...protect,
  checkAbility("defect.repair"),
  DefectSystemController.markAsRepaired
);


router.post(
  "/:id/scrap",
  ...protect,
  checkAbility("defect.scrap"),
  DefectSystemController.markAsScrapped
);


router.post(
  "/:id/verify",
  ...protect,
  checkAbility("defect.verify"),
  DefectSystemController.verifyRepair
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/fcRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const FCController = require("../controllers/fcController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.post("/", ...protect, checkAbility("firmware.flash"), FCController.postFC);
router.post("/addManyDefectFC", ...protect, checkAbility("firmware.flash"), FCController.postManyDefectFC);

router.post(
  "/deleteManyDefectFC",
  ...protect,
  checkAbility("defect.manage"),
  FCController.deleteManyDefectFC
);


router.get("/", ...protect, checkAbility("devices.view"), FCController.getFCs);


router.put("/", ...protect, checkAbility("defect.manage"), FCController.updateFC);
router.put("/update-stand-test", ...protect, checkAbility("firmware.flash"), FCController.updateStandTestFC);


router.delete(
  "/byUniqID/:uniqueID",
  ...protect,
  checkAbility("defect.manage"),
  FCController.deleteFCByUniqueID
);
router.delete(
  "/byDBid/:id",
  ...protect,
  checkAbility("defect.manage"),
  FCController.deleteFCByDBid
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/index.js
================================================================================


const Router = require("express");
const router = new Router();


const userRouter = require("./userRouter");
const sessionRouter = require("./sessionRouter");
const pcRouter = require("./pcRouter");


const rbacRouter = require("./rbacRouter");
const structureRouter = require("./structureRouter");
const auditRouter = require("./auditRouter");


const warehouseRouter = require("./warehouseRouter");


const assemblyRouter = require("./assemblyRouter");
const assemblyRecipeRouter = require("./assemblyRecipeRouter");


const taskRouter = require("./taskRouter");
const projectRouter = require("./projectRouter");


const fcRouter = require("./fcRouter");
const ELRS915_Router = require("./ELRS915_Router");
const ELRS2_4_Router = require("./ELRS2_4_Router");
const coralB_router = require("./CoralBRouter");
const passportsExportRouter = require("./passportsExportRoutes");

const defectRouter = require("./defectRouter");
const defectRouter915 = require("./defectRouter915");
const defectRouter2_4 = require("./defectRouter2_4");
const defectRouter_CoralB = require("./defectRouterCoralB");


const beryllRouter = require("./beryllRouter");
const beryllExtendedRouter = require("./beryllExtendedRouter");


const defectSystemRouter = require("./defectSystemRouter");

const productionOutputRouter = require("./productionOutputRouter");


router.use("/users", userRouter);
router.use("/sessions", sessionRouter);
router.use("/pcs", pcRouter);


router.use("/rbac", rbacRouter);
router.use("/structure", structureRouter);
router.use("/audit", auditRouter);


router.use("/warehouse", warehouseRouter);


router.use("/assembly", assemblyRouter);
router.use("/assembly/recipes", assemblyRecipeRouter);


router.use("/tasks", taskRouter);
router.use("/projects", projectRouter);


router.use("/fcs", fcRouter);
router.use("/ELRS915", ELRS915_Router);
router.use("/ELRS2-4", ELRS2_4_Router);
router.use("/Coral-B", coralB_router);


router.use("/defectsFC", defectRouter);
router.use("/defects915", defectRouter915);
router.use("/defects2-4", defectRouter2_4);
router.use("/defects-Coral-B", defectRouter_CoralB);


router.use("/beryll", beryllRouter);
router.use("/beryll", beryllExtendedRouter);
router.use("/beryll/export/passports", passportsExportRouter);


router.use("/defects", defectSystemRouter);

router.use("/production", productionOutputRouter);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/passportsExportRoutes.js
================================================================================



const Router = require("express");
const router = new Router();
const authMiddleware = require("../middleware/authMiddleware");
const {
  exportPassports,
  getExportStats,
  getExportPreview,
  exportSinglePassport,
  exportSelectedPassports,
  exportBatchPassports
} = require("../controllers/beryll/passportsExportController");


router.use(authMiddleware);


router.post("/", exportPassports);


router.get("/stats", getExportStats);


router.get("/preview", getExportPreview);


router.get("/single/:serverId", exportSinglePassport);


router.post("/selected", exportSelectedPassports);


router.get("/batch/:batchId", exportBatchPassports);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/pcRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const PCController = require("../controllers/pcController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/", ...protect, PCController.getPCs);


router.post("/", ...protect, checkAbility("users.manage"), PCController.postPC);
router.put("/", ...protect, checkAbility("users.manage"), PCController.updatePC);
router.delete("/:id", ...protect, checkAbility("users.manage"), PCController.deletePC);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/productRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const ProductController = require("../controllers/product_componentController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post(
    "/products",
    ...protect,
    checkAbility("recipe.manage"),
    ProductController.createProduct
);

router.put(
    "/products/:id",
    ...protect,
    checkAbility("recipe.manage"),
    ProductController.updateProduct
);

router.delete(
    "/products/:id",
    ...protect,
    checkAbility("recipe.manage"),
    ProductController.deleteProduct
);


router.get(
    "/products",
    ...protect,
    ProductController.getProducts
);

router.get(
    "/products/:id",
    ...protect,
    ProductController.getProductById
);


router.post(
    "/components",
    ...protect,
    checkAbility("recipe.manage"),
    ProductController.createComponent
);

router.put(
    "/components/:id",
    ...protect,
    checkAbility("recipe.manage"),
    ProductController.updateComponent
);

router.delete(
    "/components/:id",
    ...protect,
    checkAbility("recipe.manage"),
    ProductController.deleteComponent
);

router.get(
    "/components",
    ...protect,
    ProductController.getComponents
);


router.post(
    "/statuses",
    ...protect,
    checkAbility("recipe.manage"),
    ProductController.createStatus
);

router.get(
    "/statuses",
    ...protect,
    ProductController.getStatuses
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/productionOutputRouter.js
================================================================================



const Router = require("express");
const router = new Router();
const controller = require("../controllers/productionOutputController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/operation-types", ...protect, controller.getOperationTypes);


router.post("/operation-types", ...protect, checkAbility("recipe.manage"), controller.createOperationType);
router.put("/operation-types/:id", ...protect, checkAbility("recipe.manage"), controller.updateOperationType);
router.delete("/operation-types/:id", ...protect, checkAbility("recipe.manage"), controller.deleteOperationType);


router.get("/outputs", ...protect, controller.getOutputs);


router.get("/outputs/:id", ...protect, controller.getOutputById);


router.post("/outputs", ...protect, controller.createOutput);


router.put("/outputs/:id", ...protect, controller.updateOutput);


router.delete("/outputs/:id", ...protect, controller.deleteOutput);


router.get("/pending", ...protect, controller.getPendingOutputs);


router.post("/approve", ...protect, controller.approveOutputs);


router.post("/reject", ...protect, controller.rejectOutputs);


router.get("/summary/:userId", ...protect, controller.getUserSummary);


router.get("/matrix", ...protect, controller.getMatrix);


router.get("/my-team", ...protect, controller.getMyTeamMembers);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/projectRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const controller = require("../controllers/ProjectController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post(
    "/",
    ...protect,
    checkAbility("recipe.manage"),
    controller.create
);


router.get(
    "/",
    ...protect,
    controller.getAll
);


router.delete(
    "/:id",
    ...protect,
    checkAbility("recipe.manage"),
    controller.delete
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/rbacRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const rbacController = require("../controllers/rbacController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");


const protect = [
    authMiddleware,
    syncUserMiddleware,
    checkAbility("rbac.manage")
];

router.get("/roles", ...protect, rbacController.getRoles);
router.get("/abilities", ...protect, rbacController.getAbilities);
router.post("/role/:roleId", ...protect, rbacController.updateRoleAbilities);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/sessionRouter.js
================================================================================

const Router = require("express");
const router = new Router();

const SessionController = require("../controllers/sessionController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post("/", ...protect, SessionController.postSession);
router.put("/", ...protect, SessionController.setOnlineSession);


router.get("/", ...protect, SessionController.getSessions);


router.get(
    "/offlineAll",
    ...protect,
    checkAbility("users.manage"),
    SessionController.setOfflineSession
);

router.get("/offAll", ...protect, checkAbility("users.manage"), SessionController.offlineSessionManual);
router.delete("/:id", ...protect, checkAbility("users.manage"), SessionController.deleteSession);

module.exports = router;

================================================================================
FILE: QMS-Server-master/routes/structureRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const structureController = require("../controllers/structureController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/", ...protect, structureController.getFullStructure);
router.get("/users/unassigned", ...protect, checkAbility("users.manage"), structureController.getUnassignedUsers);


router.post("/section", ...protect, checkAbility("users.manage"), structureController.createSection);
router.post("/team", ...protect, checkAbility("users.manage"), structureController.createTeam);


router.put("/section/manager", ...protect, checkAbility("users.manage"), structureController.assignSectionManager);
router.put("/team/lead", ...protect, checkAbility("users.manage"), structureController.assignTeamLead);
router.put("/user/assign", ...protect, checkAbility("users.manage"), structureController.addMemberToTeam);
router.put("/user/remove", ...protect, checkAbility("users.manage"), structureController.removeMemberFromTeam);

module.exports = router;
================================================================================
FILE: QMS-Server-master/routes/taskRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const TaskController = require("../controllers/TaskController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/", ...protect, TaskController.getTasks);
router.get("/:id", ...protect, TaskController.getTaskById);

router.post("/", ...protect, checkAbility("users.manage"), TaskController.createTask);
router.delete("/:id", ...protect, checkAbility("users.manage"), TaskController.deleteTask);
router.put("/:id", ...protect, checkAbility("users.manage"), TaskController.updateFullTask);

router.patch("/:id/status", ...protect, checkAbility("assembly.execute"), TaskController.updateTaskStatus);

module.exports = router;
================================================================================
FILE: QMS-Server-master/routes/userRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const userController = require("../controllers/userController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/auth", ...protect, (req, res) => {
    return res.json(req.user);
});

router.get("/", ...protect, userController.getUsers);

router.get("/:id", ...protect, userController.getCurrentUser);
router.put("/", ...protect, userController.updateUser); 
router.patch("/", ...protect, userController.updateUserImg);

router.delete("/:id", ...protect, checkAbility("users.manage"), userController.deleteUser);

module.exports = router;
================================================================================
FILE: QMS-Server-master/routes/warehouseRouter.js
================================================================================

const Router = require("express");
const router = new Router();

const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const SupplyController = require("../controllers/warehouse/SupplyController");
const BoxController = require("../controllers/warehouse/BoxController");
const MovementController = require("../controllers/warehouse/MovementController");
const DocumentController = require("../controllers/warehouse/DocumentController");
const AnalyticsController = require("../controllers/warehouse/AnalyticsController");
const AlertsController = require("../controllers/warehouse/AlertsController");
const RankingsController = require("../controllers/RankingsController");
const HistoryController = require("../controllers/warehouse/HistoryController");

const protect = [authMiddleware, syncUserMiddleware];


router.post("/supplies", ...protect, checkAbility("warehouse.manage"), SupplyController.createSupply);
router.get("/supplies", ...protect, checkAbility("warehouse.view"), SupplyController.getSupplies);
router.get("/supplies/:id/export-csv", ...protect, checkAbility("warehouse.view"), SupplyController.exportCsv);


router.post("/boxes", ...protect, checkAbility("warehouse.manage"), BoxController.createSingleBox);
router.post("/boxes/batch", ...protect, checkAbility("warehouse.manage"), BoxController.createBoxesBatch);


router.put("/boxes/batch", ...protect, checkAbility("warehouse.manage"), BoxController.updateBatch);


router.get("/boxes", ...protect, checkAbility("warehouse.view"), BoxController.getBoxes);
router.get("/boxes/:id", ...protect, checkAbility("warehouse.view"), BoxController.getBoxById);
router.get("/boxes/by-qr/:qr", ...protect, checkAbility("warehouse.view"), BoxController.getBoxByQr);


router.post("/boxes/export", ...protect, checkAbility("warehouse.view"), BoxController.exportCsv);
router.post("/boxes/print-pdf", ...protect, checkAbility("labels.print"), BoxController.printLabelsPdf);


router.post("/boxes/print-special", ...protect, checkAbility("labels.print"), BoxController.printSpecialLabel);


router.get("/print-history", ...protect, checkAbility("labels.print"), HistoryController.getPrintHistory);


router.post("/movements", ...protect, checkAbility("warehouse.manage"), MovementController.moveSingle);
router.post("/movements/batch", ...protect, checkAbility("warehouse.manage"), MovementController.moveBatch);
router.get("/movements", ...protect, checkAbility("warehouse.view"), MovementController.getMovements);


router.get("/balance", ...protect, checkAbility("warehouse.view"), MovementController.getBalance);


router.post("/documents", ...protect, checkAbility("warehouse.manage"), DocumentController.createDocument);
router.get("/documents", ...protect, checkAbility("warehouse.view"), DocumentController.getDocuments);


router.get("/analytics/dashboard", ...protect, checkAbility("analytics.view"), AnalyticsController.getDashboardStats);

router.get("/rankings", ...protect, checkAbility("analytics.view"), RankingsController.getStats);


router.get("/alerts", ...protect, checkAbility("warehouse.view"), AlertsController.getAlerts);
router.get("/limits", ...protect, checkAbility("warehouse.view"), AlertsController.getAllLimits);
router.post("/limits", ...protect, checkAbility("warehouse.manage"), AlertsController.setLimit);

router.get("/rankings/user/:userId", ...protect, RankingsController.getUserDetails);


module.exports = router;

================================================================================
FILE: QMS-Server-master/run-migration.js
================================================================================



require("dotenv").config();
const { Sequelize } = require("sequelize");

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASSWORD,
  {
    dialect: "postgres",
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    logging: console.log
  }
);

async function runMigration() {
  try {
    console.log("üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...");
    await sequelize.authenticate();
    console.log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫:", process.env.DB_NAME);

    console.log("\nüöÄ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏: –î–µ—Ñ–µ–∫—Ç—ã + –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n");


    console.log("üìä –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ beryll_servers...");


    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "lastPingAt" TIMESTAMP;
    `).catch(e => console.log("  - lastPingAt:", e.message));


    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_servers_pingstatus') THEN
          CREATE TYPE "enum_beryll_servers_pingstatus" AS ENUM ('ONLINE', 'OFFLINE', 'UNKNOWN');
        END IF;
      END$$;
    `).catch(e => console.log("  - ENUM pingStatus:", e.message));


    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "pingStatus" "enum_beryll_servers_pingstatus" DEFAULT 'UNKNOWN';
    `).catch(e => console.log("  - pingStatus:", e.message));


    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "pingLatency" FLOAT;
    `).catch(e => console.log("  - pingLatency:", e.message));

    console.log("‚úÖ –ü–æ–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã\n");


    console.log("üí¨ –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É beryll_defect_comments...");

    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_defect_comments_defectcategory') THEN
          CREATE TYPE "enum_beryll_defect_comments_defectcategory" AS ENUM ('HARDWARE', 'SOFTWARE', 'ASSEMBLY', 'COMPONENT', 'OTHER');
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_defect_comments_priority') THEN
          CREATE TYPE "enum_beryll_defect_comments_priority" AS ENUM ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL');
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_defect_comments_status') THEN
          CREATE TYPE "enum_beryll_defect_comments_status" AS ENUM ('NEW', 'IN_PROGRESS', 'RESOLVED', 'WONT_FIX');
        END IF;
      END$$;
    `);

    await sequelize.query(`
      CREATE TABLE IF NOT EXISTS beryll_defect_comments (
        id SERIAL PRIMARY KEY,
        "serverId" INTEGER NOT NULL REFERENCES beryll_servers(id) ON UPDATE CASCADE ON DELETE CASCADE,
        "userId" INTEGER NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        text TEXT NOT NULL,
        "defectCategory" "enum_beryll_defect_comments_defectcategory" DEFAULT 'OTHER',
        priority "enum_beryll_defect_comments_priority" DEFAULT 'MEDIUM',
        status "enum_beryll_defect_comments_status" NOT NULL DEFAULT 'NEW',
        "resolvedById" INTEGER REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        "resolvedAt" TIMESTAMP,
        resolution TEXT,
        "createdAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        "updatedAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
      );
    `);


    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_server ON beryll_defect_comments("serverId");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_status ON beryll_defect_comments(status);`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_category ON beryll_defect_comments("defectCategory");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_priority ON beryll_defect_comments(priority);`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_created ON beryll_defect_comments("createdAt");`);

    console.log("‚úÖ –¢–∞–±–ª–∏—Ü–∞ beryll_defect_comments —Å–æ–∑–¥–∞–Ω–∞\n");


    console.log("üìé –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É beryll_defect_files...");

    await sequelize.query(`
      CREATE TABLE IF NOT EXISTS beryll_defect_files (
        id SERIAL PRIMARY KEY,
        "commentId" INTEGER NOT NULL REFERENCES beryll_defect_comments(id) ON UPDATE CASCADE ON DELETE CASCADE,
        "originalName" VARCHAR(255) NOT NULL,
        "fileName" VARCHAR(255) NOT NULL,
        "filePath" VARCHAR(500) NOT NULL,
        "mimeType" VARCHAR(100),
        "fileSize" INTEGER,
        "uploadedById" INTEGER REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        "createdAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
      );
    `);

    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_files_comment ON beryll_defect_files("commentId");`);

    console.log("‚úÖ –¢–∞–±–ª–∏—Ü–∞ beryll_defect_files —Å–æ–∑–¥–∞–Ω–∞\n");


    console.log("üìù –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ action —Ç–∏–ø—ã –≤ –∏—Å—Ç–æ—Ä–∏—é...");

    const newActions = [
      'DEFECT_COMMENT_ADDED',
      'DEFECT_STATUS_CHANGED',
      'DEFECT_COMMENT_DELETED',
      'DEFECT_FILE_UPLOADED',
      'DEFECT_FILE_DELETED'
    ];

    for (const action of newActions) {
      await sequelize.query(`
        DO $$
        BEGIN
          ALTER TYPE "enum_beryll_history_action" ADD VALUE IF NOT EXISTS '${action}';
        EXCEPTION
          WHEN duplicate_object THEN NULL;
        END$$;
      `).catch(e => console.log(`  - ${action}: —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`));
    }

    console.log("‚úÖ Action —Ç–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã\n");


    const fs = require("fs");
    const path = require("path");
    const uploadsDir = path.join(__dirname, "uploads/beryll/defects");

    if (!fs.existsSync(uploadsDir)) {
      fs.mkdirSync(uploadsDir, { recursive: true });
      console.log("üìÅ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞:", uploadsDir);
    } else {
      console.log("üìÅ –ü–∞–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", uploadsDir);
    }

    console.log("\n" + "=".repeat(50));
    console.log("‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!");
    console.log("=".repeat(50));


    const [tables] = await sequelize.query(`
      SELECT table_name FROM information_schema.tables
      WHERE table_schema = 'public' AND table_name LIKE 'beryll%'
      ORDER BY table_name;
    `);
    console.log("\nüìã –¢–∞–±–ª–∏—Ü—ã Beryll:");
    tables.forEach(t => console.log("  -", t.table_name));

  } catch (error) {
    console.error("\n‚ùå –û–®–ò–ë–ö–ê –ú–ò–ì–†–ê–¶–ò–ò:", error.message);
    console.error(error);
    process.exit(1);
  } finally {
    await sequelize.close();
    console.log("\nüîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
  }
}

runMigration();

================================================================================
FILE: QMS-Server-master/scripts/import_nov_dec_2025.js
================================================================================



require('dotenv').config();

const { Sequelize, DataTypes, Op } = require("sequelize");


const sequelize = new Sequelize(
    process.env.DB_NAME || 'flight_controller_database',
    process.env.DB_USER || 'postgres',
    process.env.DB_PASSWORD || '',
    {
        host: process.env.DB_HOST || 'localhost',
        port: process.env.DB_PORT || 5432,
        dialect: 'postgres',
        logging: false
    }
);


const User = sequelize.define("user", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING },
    surname: { type: DataTypes.STRING },
}, {
    tableName: "users",
    timestamps: false
});

const OperationType = sequelize.define("operation_type", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING(100), allowNull: false },
    code: { type: DataTypes.STRING(50), allowNull: true },
    description: { type: DataTypes.TEXT, allowNull: true },
    unit: { type: DataTypes.STRING(20), allowNull: false, defaultValue: '—à—Ç' },
    normMinutes: { type: DataTypes.FLOAT, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    isActive: { type: DataTypes.BOOLEAN, defaultValue: true },
    sortOrder: { type: DataTypes.INTEGER, defaultValue: 0 }
}, {
    tableName: "operation_types",
    timestamps: true
});

const ProductionOutput = sequelize.define("production_output", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    date: { type: DataTypes.DATEONLY, allowNull: false },
    userId: { type: DataTypes.INTEGER, allowNull: false },
    teamId: { type: DataTypes.INTEGER, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    projectId: { type: DataTypes.INTEGER, allowNull: true },
    taskId: { type: DataTypes.INTEGER, allowNull: true },
    operationTypeId: { type: DataTypes.INTEGER, allowNull: true },
    claimedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    approvedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    rejectedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    status: { type: DataTypes.STRING(20), allowNull: false, defaultValue: 'approved' },
    approvedById: { type: DataTypes.INTEGER, allowNull: true },
    approvedAt: { type: DataTypes.DATE, allowNull: true },
    createdById: { type: DataTypes.INTEGER, allowNull: true },
    comment: { type: DataTypes.TEXT, allowNull: true },
    rejectReason: { type: DataTypes.TEXT, allowNull: true }
}, {
    tableName: "production_outputs",
    timestamps: true
});


const IMPORT_DATA = [

  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2025-11-01", "quantity": 175, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2025-11-05", "quantity": 180, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2025-11-01", "quantity": 60, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2025-11-05", "quantity": 180, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2025-11-01", "quantity": 50, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2025-11-05", "quantity": 210, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2025-11-01", "quantity": 200, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2025-11-05", "quantity": 260, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-11-01", "quantity": 120, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-11-05", "quantity": 120, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2025-11-01", "quantity": 170, "month_name": "–ù–æ—è–±—Ä—å 2025"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2025-11-05", "quantity": 200, "month_name": "–ù–æ—è–±—Ä—å 2025"},


  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2025-12-01", "quantity": 20, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2025-12-01", "quantity": 60, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2025-12-01", "quantity": 20, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2025-12-01", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-12-01", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-12-12", "quantity": 100, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2025-12-01", "quantity": 260, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2025-12-02", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö–∏—Ä—Å–∞–Ω–æ–≤ –û–ª–µ–≥ (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-01", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö–∏—Ä—Å–∞–Ω–æ–≤ –û–ª–µ–≥ (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–û–≤—Å—è–Ω–Ω–∏–∫–æ–≤ –ê–Ω–¥—Ä–µ–π (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-01", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–û–≤—Å—è–Ω–Ω–∏–∫–æ–≤ –ê–Ω–¥—Ä–µ–π (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2025-12-01", "quantity": 220, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2025-12-02", "quantity": 100, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-01", "quantity": 160, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-11", "quantity": 60, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-12", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2025-12-01", "quantity": 300, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2025-12-01", "quantity": 280, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2025-12-02", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
];


const NAME_VARIANTS = {

  "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è": ["–ó–µ–ª–µ–Ω–æ–≤–∞", "–ê–Ω–∞—Å—Ç–∞—Å–∏—è"],
  "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å": ["–ú–æ—Ä–æ–∑–æ–≤", "–î–µ–Ω–∏—Å"],
  "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥": ["–ö—Ä—ã–ª–æ–≤", "–û–ª–µ–≥"],
  "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π": ["–¢–∞—Ä–∞—Å–æ–≤", "–ê–ª–µ–∫—Å–µ–π"],
  "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞": ["–°–∞–ø—Ä–∏–Ω–∞", "–ï–ª–µ–Ω–∞"],
  "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω": ["–°—ã—Å–æ–µ–≤", "–ò–≤–∞–Ω"],

  "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å": ["–ú–∏—à–∏–Ω", "–ò–≥–æ—Ä—å"],
  "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π": ["–ò—à–∏–Ω", "–ê–ª–µ–∫—Å–µ–π"],
  "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä": ["–ë–æ–≥–æ–º–æ–ª–æ–≤", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä"],
  "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä": ["–ó–∏–∞—Ç–¥–∏–Ω–æ–≤", "–ê—Ä—Ç—É—Ä"],
  "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω": ["–î—Ä–æ–≥–∞–Ω", "–í–ª–∞–¥–∏—Å–ª–∞–≤"],
  "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π": ["–°–∞—É—Ç–∏–Ω", "–î–º–∏—Ç—Ä–∏–π"],


};


async function findOrCreateOperationType() {
    let opType = await OperationType.findOne({
        where: { code: "THERMAL_CALIBRATION" }
    });

    if (!opType) {
        opType = await OperationType.create({
            name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞",
            code: "THERMAL_CALIBRATION",
            description: "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤ (–∏–º–ø–æ—Ä—Ç –∏–∑ Excel)",
            unit: "—à—Ç",
            isActive: true
        });
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: ${opType.name} (ID: ${opType.id})`);
    } else {
        console.log(`‚ÑπÔ∏è  –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${opType.name} (ID: ${opType.id})`);
    }

    return opType;
}

async function findUserByName(fullName) {
    const variants = NAME_VARIANTS[fullName];
    if (!variants) {
        return null;
    }

    const [surname, name] = variants;


    let user = await User.findOne({
        where: { surname, name }
    });

    if (!user) {

        user = await User.findOne({
            where: {
                [Op.and]: [
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('surname')),
                        surname.toLowerCase()
                    ),
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('name')),
                        name.toLowerCase()
                    )
                ]
            }
        });
    }

    return user;
}

async function importData() {
    try {

        await sequelize.authenticate();
        console.log("üì¶ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
        console.log(`   –ë–∞–∑–∞: ${process.env.DB_NAME || 'flight_controller_database'}`);
        console.log(`   –•–æ—Å—Ç: ${process.env.DB_HOST || 'localhost'}\n`);


        const operationType = await findOrCreateOperationType();
        const operationTypeId = operationType.id;


        const stats = {
            total: IMPORT_DATA.length,
            success: 0,
            skipped: 0,
            userNotFound: [],
            duplicates: 0,
            byMonth: {}
        };


        const userCache = new Map();

        console.log("\nüîÑ –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç –ù–æ—è–±—Ä—å-–î–µ–∫–∞–±—Ä—å 2025...\n");

        for (const record of IMPORT_DATA) {
            const { employee, date, quantity, month_name } = record;


            let userId = userCache.get(employee);

            if (userId === undefined) {
                const user = await findUserByName(employee);
                if (user) {
                    userId = user.id;
                    userCache.set(employee, userId);
                    console.log(`üë§ –ù–∞–π–¥–µ–Ω: ${employee} -> ID ${userId}`);
                } else {
                    userCache.set(employee, null);
                    if (!stats.userNotFound.includes(employee)) {
                        stats.userNotFound.push(employee);
                        console.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω: ${employee}`);
                    }
                }
            }

            if (!userId) {
                stats.skipped++;
                continue;
            }


            const existing = await ProductionOutput.findOne({
                where: {
                    userId,
                    date,
                    operationTypeId,
                    claimedQty: quantity
                }
            });

            if (existing) {
                stats.duplicates++;
                continue;
            }


            await ProductionOutput.create({
                date,
                userId,
                operationTypeId,
                claimedQty: quantity,
                approvedQty: quantity,
                status: 'approved',
                comment: `–ò–º–ø–æ—Ä—Ç –∏–∑ Excel (${month_name})`
            });

            stats.success++;
            stats.byMonth[month_name] = (stats.byMonth[month_name] || 0) + 1;
        }


        console.log("\n" + "=".repeat(50));
        console.log("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ú–ü–û–†–¢–ê:");
        console.log("=".repeat(50));
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${stats.success}`);
        console.log(`‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${stats.skipped}`);
        console.log(`üîÑ –î—É–±–ª–∏–∫–∞—Ç—ã: ${stats.duplicates}`);

        console.log(`\nüìÖ –ü–æ –º–µ—Å—è—Ü–∞–º:`);
        for (const [month, count] of Object.entries(stats.byMonth)) {
            console.log(`   ${month}: ${count} –∑–∞–ø–∏—Å–µ–π`);
        }

        if (stats.userNotFound.length > 0) {
            console.log(`\n‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (${stats.userNotFound.length}):`);
            stats.userNotFound.forEach(name => console.log(`   - ${name}`));
        }

        console.log("\n‚ú® –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!");

    } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", error);
    } finally {
        await sequelize.close();
    }
}


importData();

================================================================================
FILE: QMS-Server-master/scripts/import_production_outputs.js
================================================================================



require('dotenv').config();

const { Sequelize, DataTypes, Op } = require("sequelize");


const sequelize = new Sequelize(
    process.env.DB_NAME || 'flight_controller_database',
    process.env.DB_USER || 'postgres',
    process.env.DB_PASSWORD || '',
    {
        host: process.env.DB_HOST || 'localhost',
        port: process.env.DB_PORT || 5432,
        dialect: 'postgres',
        logging: false
    }
);


const User = sequelize.define("user", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING },
    surname: { type: DataTypes.STRING },
}, {
    tableName: "users",
    timestamps: false
});

const OperationType = sequelize.define("operation_type", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING(100), allowNull: false },
    code: { type: DataTypes.STRING(50), allowNull: true },
    description: { type: DataTypes.TEXT, allowNull: true },
    unit: { type: DataTypes.STRING(20), allowNull: false, defaultValue: '—à—Ç' },
    normMinutes: { type: DataTypes.FLOAT, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    isActive: { type: DataTypes.BOOLEAN, defaultValue: true },
    sortOrder: { type: DataTypes.INTEGER, defaultValue: 0 }
}, {
    tableName: "operation_types",
    timestamps: true
});

const ProductionOutput = sequelize.define("production_output", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    date: { type: DataTypes.DATEONLY, allowNull: false },
    userId: { type: DataTypes.INTEGER, allowNull: false },
    teamId: { type: DataTypes.INTEGER, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    projectId: { type: DataTypes.INTEGER, allowNull: true },
    taskId: { type: DataTypes.INTEGER, allowNull: true },
    operationTypeId: { type: DataTypes.INTEGER, allowNull: true },
    claimedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    approvedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    rejectedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    status: { type: DataTypes.STRING(20), allowNull: false, defaultValue: 'approved' },
    approvedById: { type: DataTypes.INTEGER, allowNull: true },
    approvedAt: { type: DataTypes.DATE, allowNull: true },
    createdById: { type: DataTypes.INTEGER, allowNull: true },
    comment: { type: DataTypes.TEXT, allowNull: true },
    rejectReason: { type: DataTypes.TEXT, allowNull: true }
}, {
    tableName: "production_outputs",
    timestamps: true
});


const IMPORT_DATA = [
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2025-12-01", "quantity": 20, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2025-12-01", "quantity": 60, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2025-12-01", "quantity": 20, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2025-12-01", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-12-01", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞", "date": "2025-12-12", "quantity": 100, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2025-12-01", "quantity": 260, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2025-12-02", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö–∏—Ä—Å–∞–Ω–æ–≤ –û–ª–µ–≥ (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-01", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ö–∏—Ä—Å–∞–Ω–æ–≤ –û–ª–µ–≥ (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–û–≤—Å—è–Ω–Ω–∏–∫–æ–≤ –ê–Ω–¥—Ä–µ–π (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-01", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–û–≤—Å—è–Ω–Ω–∏–∫–æ–≤ –ê–Ω–¥—Ä–µ–π (–ø—Ä–∞–∫—Ç.)", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2025-12-01", "quantity": 220, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2025-12-02", "quantity": 100, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-01", "quantity": 160, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-09", "quantity": 60, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2025-12-12", "quantity": 140, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2025-12-01", "quantity": 300, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2025-12-02", "quantity": 120, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2025-12-01", "quantity": 280, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2025-12-02", "quantity": 240, "month_name": "–î–µ–∫–∞–±—Ä—å 2025"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2026-01-13", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2026-01-14", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2026-01-15", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è", "date": "2026-01-16", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-13", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-14", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-16", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-19", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å", "date": "2026-01-20", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-13", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-14", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-15", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-16", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-19", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥", "date": "2026-01-20", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-13", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-14", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-15", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-16", "quantity": 260, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-19", "quantity": 300, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-13", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-14", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-15", "quantity": 260, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-16", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-19", "quantity": 260, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-20", "quantity": 140, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å", "date": "2026-01-21", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-13", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-14", "quantity": 140, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-15", "quantity": 170, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-16", "quantity": 170, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-19", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-20", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω", "date": "2026-01-21", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-13", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-14", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-15", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-16", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π", "date": "2026-01-19", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-13", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-14", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-16", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-19", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-20", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-13", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-14", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-15", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-16", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-19", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-20", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π", "date": "2026-01-21", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-14", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-16", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-19", "quantity": 170, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º", "date": "2026-01-20", "quantity": 170, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-13", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-14", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-15", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-16", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-19", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-20", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π", "date": "2026-01-21", "quantity": 60, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-13", "quantity": 50, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-14", "quantity": 230, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-16", "quantity": 180, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-19", "quantity": 150, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-20", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-13", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-14", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-15", "quantity": 160, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-16", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-19", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-21", "quantity": 60, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-13", "quantity": 60, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-14", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-16", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª", "date": "2026-01-19", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–®–∞—Ç–∏–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-13", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–®–∞—Ç–∏–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-14", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–®–∞—Ç–∏–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä", "date": "2026-01-15", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-13", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-14", "quantity": 140, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-15", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-16", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-19", "quantity": 240, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä", "date": "2026-01-21", "quantity": 140, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-13", "quantity": 50, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-14", "quantity": 80, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-15", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-16", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤", "date": "2026-01-19", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-13", "quantity": 100, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-14", "quantity": 300, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-15", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-16", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω", "date": "2026-01-19", "quantity": 40, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-13", "quantity": 120, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-14", "quantity": 200, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-15", "quantity": 220, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-16", "quantity": 340, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-19", "quantity": 400, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-20", "quantity": 20, "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"}
];


const NAME_VARIANTS = {
  "–ë–∞–ª–∞—à–∞–π—Ç–∏—Å –ö–∏—Ä–∏–ª–ª": ["–ë–∞–ª–∞—à–∞–π—Ç–∏—Å", "–ö–∏—Ä–∏–ª–ª"],
  "–ë–æ–≥–æ–º–æ–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä": ["–ë–æ–≥–æ–º–æ–ª–æ–≤", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä"],
  "–í–ª–∞–¥–∏—Å–ª–∞–≤ –î—Ä–æ–≥–∞–Ω": ["–î—Ä–æ–≥–∞–Ω", "–í–ª–∞–¥–∏—Å–ª–∞–≤"],
  "–î—É—Ä—è–≥–∏–Ω –ê–Ω–¥—Ä–µ–π": ["–î—É—Ä—è–≥–∏–Ω", "–ê–Ω–¥—Ä–µ–π"],
  "–ó–µ–ª–µ–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è": ["–ó–µ–ª–µ–Ω–æ–≤–∞", "–ê–Ω–∞—Å—Ç–∞—Å–∏—è"],
  "–ó–∏–∞—Ç–¥–∏–Ω–æ–≤ –ê—Ä—Ç—É—Ä": ["–ó–∏–∞—Ç–¥–∏–Ω–æ–≤", "–ê—Ä—Ç—É—Ä"],
  "–ò–æ—Å–∏—Ñ –í–∞—Å–∏–ª—å–µ–≤": ["–í–∞—Å–∏–ª—å–µ–≤", "–ò–æ—Å–∏—Ñ"],
  "–ò—à–∏–Ω –ê–ª–µ–∫—Å–µ–π": ["–ò—à–∏–Ω", "–ê–ª–µ–∫—Å–µ–π"],
  "–ö—Ä–∏–≤–æ—à–µ–∏–Ω –ì—Ä–∏–≥–æ—Ä–∏–π": ["–ö—Ä–∏–≤–æ—à–µ–∏–Ω", "–ì—Ä–∏–≥–æ—Ä–∏–π"],
  "–ö—Ä—ã–ª–æ–≤ –û–ª–µ–≥": ["–ö—Ä—ã–ª–æ–≤", "–û–ª–µ–≥"],
  "–ú–∏—à–∏–Ω –ò–≥–æ—Ä—å": ["–ú–∏—à–∏–Ω", "–ò–≥–æ—Ä—å"],
  "–ú–æ—Ä–æ–∑–æ–≤ –î–µ–Ω–∏—Å": ["–ú–æ—Ä–æ–∑–æ–≤", "–î–µ–Ω–∏—Å"],
  "–ú–æ—Ö–æ–≤ –ê—Ä—Ç–µ–º": ["–ú–æ—Ö–æ–≤", "–ê—Ä—Ç–µ–º"],
  "–°–∞–ø—Ä–∏–Ω–∞ –ï–ª–µ–Ω–∞": ["–°–∞–ø—Ä–∏–Ω–∞", "–ï–ª–µ–Ω–∞"],
  "–°–∞—É—Ç–∏–Ω –î–º–∏—Ç—Ä–∏–π": ["–°–∞—É—Ç–∏–Ω", "–î–º–∏—Ç—Ä–∏–π"],
  "–°—ã—Å–æ–µ–≤ –ò–≤–∞–Ω": ["–°—ã—Å–æ–µ–≤", "–ò–≤–∞–Ω"],
  "–¢–∞—Ä–∞—Å–æ–≤ –ê–ª–µ–∫—Å–µ–π": ["–¢–∞—Ä–∞—Å–æ–≤", "–ê–ª–µ–∫—Å–µ–π"],
  "–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä": ["–ß–µ—Ä–Ω–æ–≥–æ—Ä–æ–≤", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä"],
  "–ß–∏—Ä–∫–∞ –î–º–∏—Ç—Ä–∏–π": ["–ß–∏—Ä–∫–∞", "–î–º–∏—Ç—Ä–∏–π"],
  "–®–∞—Ç–∏–ª–æ–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä": ["–®–∞—Ç–∏–ª–æ–≤", "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä"],


};


async function findOrCreateOperationType() {
    let opType = await OperationType.findOne({
        where: { code: "THERMAL_CALIBRATION" }
    });

    if (!opType) {
        opType = await OperationType.create({
            name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞",
            code: "THERMAL_CALIBRATION",
            description: "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤ (–∏–º–ø–æ—Ä—Ç –∏–∑ Excel)",
            unit: "—à—Ç",
            isActive: true
        });
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: ${opType.name} (ID: ${opType.id})`);
    } else {
        console.log(`‚ÑπÔ∏è  –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${opType.name} (ID: ${opType.id})`);
    }

    return opType;
}

async function findUserByName(fullName) {
    const variants = NAME_VARIANTS[fullName];
    if (!variants) {
        return null;
    }

    const [surname, name] = variants;


    let user = await User.findOne({
        where: { surname, name }
    });

    if (!user) {

        user = await User.findOne({
            where: {
                [Op.and]: [
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('surname')),
                        surname.toLowerCase()
                    ),
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('name')),
                        name.toLowerCase()
                    )
                ]
            }
        });
    }

    return user;
}

async function importData() {
    try {

        await sequelize.authenticate();
        console.log("üì¶ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
        console.log(`   –ë–∞–∑–∞: ${process.env.DB_NAME || 'flight_controller_database'}`);
        console.log(`   –•–æ—Å—Ç: ${process.env.DB_HOST || 'localhost'}\n`);


        const operationType = await findOrCreateOperationType();
        const operationTypeId = operationType.id;


        const stats = {
            total: IMPORT_DATA.length,
            success: 0,
            skipped: 0,
            userNotFound: [],
            duplicates: 0
        };


        const userCache = new Map();

        console.log("\nüîÑ –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç...\n");

        for (const record of IMPORT_DATA) {
            const { employee, date, quantity } = record;


            let userId = userCache.get(employee);

            if (userId === undefined) {
                const user = await findUserByName(employee);
                if (user) {
                    userId = user.id;
                    userCache.set(employee, userId);
                    console.log(`üë§ –ù–∞–π–¥–µ–Ω: ${employee} -> ID ${userId}`);
                } else {
                    userCache.set(employee, null);
                    if (!stats.userNotFound.includes(employee)) {
                        stats.userNotFound.push(employee);
                        console.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω: ${employee}`);
                    }
                }
            }

            if (!userId) {
                stats.skipped++;
                continue;
            }


            const existing = await ProductionOutput.findOne({
                where: {
                    userId,
                    date,
                    operationTypeId,
                    claimedQty: quantity
                }
            });

            if (existing) {
                stats.duplicates++;
                continue;
            }


            await ProductionOutput.create({
                date,
                userId,
                operationTypeId,
                claimedQty: quantity,
                approvedQty: quantity,
                status: 'approved',
                comment: `–ò–º–ø–æ—Ä—Ç –∏–∑ Excel (${record.month_name})`
            });

            stats.success++;
        }


        console.log("\n" + "=".repeat(50));
        console.log("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ú–ü–û–†–¢–ê:");
        console.log("=".repeat(50));
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${stats.success}`);
        console.log(`‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${stats.skipped}`);
        console.log(`üîÑ –î—É–±–ª–∏–∫–∞—Ç—ã: ${stats.duplicates}`);

        if (stats.userNotFound.length > 0) {
            console.log(`\n‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (${stats.userNotFound.length}):`);
            stats.userNotFound.forEach(name => console.log(`   - ${name}`));
        }

        console.log("\n‚ú® –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!");

    } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", error);
    } finally {
        await sequelize.close();
    }
}


importData();

================================================================================
FILE: QMS-Server-master/scripts/import_thermal_outputs_2.js
================================================================================



require('dotenv').config();

const { Sequelize, DataTypes, Op } = require("sequelize");


const sequelize = new Sequelize(
    process.env.DB_NAME || 'flight_controller_database',
    process.env.DB_USER || 'postgres',
    process.env.DB_PASSWORD || '',
    {
        host: process.env.DB_HOST || 'localhost',
        port: process.env.DB_PORT || 5432,
        dialect: 'postgres',
        logging: false
    }
);


const User = sequelize.define("user", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING },
    surname: { type: DataTypes.STRING },
}, {
    tableName: "users",
    timestamps: false
});

const OperationType = sequelize.define("operation_type", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    name: { type: DataTypes.STRING(100), allowNull: false },
    code: { type: DataTypes.STRING(50), allowNull: true },
    description: { type: DataTypes.TEXT, allowNull: true },
    unit: { type: DataTypes.STRING(20), allowNull: false, defaultValue: '—à—Ç' },
    normMinutes: { type: DataTypes.FLOAT, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    isActive: { type: DataTypes.BOOLEAN, defaultValue: true },
    sortOrder: { type: DataTypes.INTEGER, defaultValue: 0 }
}, {
    tableName: "operation_types",
    timestamps: true
});

const ProductionOutput = sequelize.define("production_output", {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    date: { type: DataTypes.DATEONLY, allowNull: false },
    userId: { type: DataTypes.INTEGER, allowNull: false },
    teamId: { type: DataTypes.INTEGER, allowNull: true },
    sectionId: { type: DataTypes.INTEGER, allowNull: true },
    projectId: { type: DataTypes.INTEGER, allowNull: true },
    taskId: { type: DataTypes.INTEGER, allowNull: true },
    operationTypeId: { type: DataTypes.INTEGER, allowNull: true },
    claimedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    approvedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    rejectedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
    status: { type: DataTypes.STRING(20), allowNull: false, defaultValue: 'approved' },
    approvedById: { type: DataTypes.INTEGER, allowNull: true },
    approvedAt: { type: DataTypes.DATE, allowNull: true },
    createdById: { type: DataTypes.INTEGER, allowNull: true },
    comment: { type: DataTypes.TEXT, allowNull: true },
    rejectReason: { type: DataTypes.TEXT, allowNull: true }
}, {
    tableName: "production_outputs",
    timestamps: true
});


const OPERATION_TYPES = {
    THERMAL_CALIBRATION: {
        name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞",
        code: "THERMAL_CALIBRATION",
        description: "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤",
        unit: "—à—Ç"
    },
    THERMAL_DEFECT_CHECK: {
        name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –æ—Ç–±—Ä–∞–∫–æ–≤–∫–∞",
        code: "THERMAL_DEFECT_CHECK",
        description: "–û—Ç–±–æ—Ä –±—Ä–∞–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤",
        unit: "—à—Ç"
    },
    THERMAL_FIRMWARE: {
        name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –ø—Ä–æ—à–∏–≤–∫–∞",
        code: "THERMAL_FIRMWARE",
        description: "–ü–µ—Ä–µ–ø—Ä–æ—à–∏–≤–∫–∞ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤ –Ω–∞ 94-—é –ø—Ä–æ—à–∏–≤–∫—É",
        unit: "—à—Ç"
    },
    THERMAL_RESTORE: {
        name: "–¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ",
        code: "THERMAL_RESTORE",
        description: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–∏–∑–æ—Ä–æ–≤",
        unit: "—à—Ç"
    }
};


const IMPORT_DATA = [

  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-12", "quantity": 120, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-13", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-14", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-15", "quantity": 120, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-16", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-19", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-20", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª", "date": "2026-01-21", "quantity": 20, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-12", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-13", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-14", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-15", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-16", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-19", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä", "date": "2026-01-21", "quantity": 170, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-12", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-13", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-14", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-15", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-16", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-19", "quantity": 90, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π", "date": "2026-01-21", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-13", "quantity": 36, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-14", "quantity": 20, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-15", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-16", "quantity": 80, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-19", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-20", "quantity": 40, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-14", "quantity": 60, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-15", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-19", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-20", "quantity": 100, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},
  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-21", "quantity": 20, "operation": "THERMAL_CALIBRATION", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},

  {"employee": "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π", "date": "2026-01-22", "quantity": 10, "operation": "THERMAL_FIRMWARE", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"},

  {"employee": "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤", "date": "2026-01-22", "quantity": 20, "operation": "THERMAL_RESTORE", "month_name": "–Ø–Ω–≤–∞—Ä—å 2026"}
];


const NAME_VARIANTS = {
  "–ì–µ–∫–º–∞–Ω –ö–∏—Ä–∏–ª–ª": ["–ì–µ–∫–º–∞–Ω", "–ö–∏—Ä–∏–ª–ª"],
  "–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ –ê—Ä—Ç—É—Ä": ["–î–º–∏—Ç—Ä–æ—á–µ–Ω–∫–æ", "–ê—Ä—Ç—É—Ä"],
  "–ó–µ–ª–µ–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π": ["–ó–µ–ª–µ–Ω–æ–≤", "–î–º–∏—Ç—Ä–∏–π"],
  "–õ–∞—Ç—ã—à –ù–∏–∫–æ–ª–∞–π": ["–õ–∞—Ç—ã—à", "–ù–∏–∫–æ–ª–∞–π"],
  "–°–≤–∏—Å—Ç—É–Ω–æ–≤ –°–µ—Ä–≥–µ–π": ["–°–≤–∏—Å—Ç—É–Ω–æ–≤", "–°–µ—Ä–≥–µ–π"],
  "–£—à–∞–∫–æ–≤ –°–≤—è—Ç–æ—Å–ª–∞–≤": ["–£—à–∞–∫–æ–≤", "–°–≤—è—Ç–æ—Å–ª–∞–≤"],
};


async function findOrCreateOperationTypes() {
    const opTypeIds = {};

    for (const [code, data] of Object.entries(OPERATION_TYPES)) {
        let opType = await OperationType.findOne({
            where: { code }
        });

        if (!opType) {
            opType = await OperationType.create({
                name: data.name,
                code: data.code,
                description: data.description,
                unit: data.unit,
                isActive: true
            });
            console.log(`‚úÖ –°–æ–∑–¥–∞–Ω —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: ${opType.name} (ID: ${opType.id})`);
        } else {
            console.log(`‚ÑπÔ∏è  –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${opType.name} (ID: ${opType.id})`);
        }

        opTypeIds[code] = opType.id;
    }

    return opTypeIds;
}

async function findUserByName(fullName) {
    const variants = NAME_VARIANTS[fullName];
    if (!variants) {
        return null;
    }

    const [surname, name] = variants;


    let user = await User.findOne({
        where: { surname, name }
    });

    if (!user) {

        user = await User.findOne({
            where: {
                [Op.and]: [
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('surname')),
                        surname.toLowerCase()
                    ),
                    sequelize.where(
                        sequelize.fn('LOWER', sequelize.col('name')),
                        name.toLowerCase()
                    )
                ]
            }
        });
    }

    return user;
}

async function importData() {
    try {

        await sequelize.authenticate();
        console.log("üì¶ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
        console.log(`   –ë–∞–∑–∞: ${process.env.DB_NAME || 'flight_controller_database'}`);
        console.log(`   –•–æ—Å—Ç: ${process.env.DB_HOST || 'localhost'}\n`);


        const operationTypeIds = await findOrCreateOperationTypes();


        const stats = {
            total: IMPORT_DATA.length,
            success: 0,
            skipped: 0,
            userNotFound: [],
            duplicates: 0,
            byOperation: {}
        };


        const userCache = new Map();

        console.log("\nüîÑ –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç...\n");

        for (const record of IMPORT_DATA) {
            const { employee, date, quantity, operation } = record;


            const operationTypeId = operationTypeIds[operation];
            if (!operationTypeId) {
                console.log(`‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: ${operation}`);
                stats.skipped++;
                continue;
            }


            let userId = userCache.get(employee);

            if (userId === undefined) {
                const user = await findUserByName(employee);
                if (user) {
                    userId = user.id;
                    userCache.set(employee, userId);
                    console.log(`üë§ –ù–∞–π–¥–µ–Ω: ${employee} -> ID ${userId}`);
                } else {
                    userCache.set(employee, null);
                    if (!stats.userNotFound.includes(employee)) {
                        stats.userNotFound.push(employee);
                        console.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω: ${employee}`);
                    }
                }
            }

            if (!userId) {
                stats.skipped++;
                continue;
            }


            const existing = await ProductionOutput.findOne({
                where: {
                    userId,
                    date,
                    operationTypeId,
                    claimedQty: quantity
                }
            });

            if (existing) {
                stats.duplicates++;
                continue;
            }


            await ProductionOutput.create({
                date,
                userId,
                operationTypeId,
                claimedQty: quantity,
                approvedQty: quantity,
                status: 'approved',
                comment: `–ò–º–ø–æ—Ä—Ç –∏–∑ Excel - –¢–µ–ø–ª–æ–≤–∏–∑–æ—Ä—ã (${record.month_name})`
            });

            stats.success++;
            stats.byOperation[operation] = (stats.byOperation[operation] || 0) + quantity;
        }


        console.log("\n" + "=".repeat(50));
        console.log("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ú–ü–û–†–¢–ê:");
        console.log("=".repeat(50));
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${stats.success}`);
        console.log(`‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${stats.skipped}`);
        console.log(`üîÑ –î—É–±–ª–∏–∫–∞—Ç—ã: ${stats.duplicates}`);

        console.log(`\nüìà –ü–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º:`);
        for (const [op, total] of Object.entries(stats.byOperation)) {
            const opName = OPERATION_TYPES[op]?.name || op;
            console.log(`   ${opName}: ${total} —à—Ç`);
        }

        if (stats.userNotFound.length > 0) {
            console.log(`\n‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (${stats.userNotFound.length}):`);
            stats.userNotFound.forEach(name => console.log(`   - ${name}`));
        }

        console.log("\n‚ú® –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!");

    } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", error);
    } finally {
        await sequelize.close();
    }
}


importData();

================================================================================
FILE: QMS-Server-master/seeders/20260123-beryll-abilities.js
================================================================================



"use strict";

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const now = new Date();


    const abilities = [

      {
        code: "beryll_component_view",
        description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_component_manage",
        description:
          "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—ë–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ, —Å–ø–∏—Å–∞–Ω–∏–µ)",
        createdAt: now,
        updatedAt: now,
      },


      {
        code: "beryll_defect_view",
        description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π –æ –±—Ä–∞–∫–µ",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_defect_create",
        description: "–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –æ –±—Ä–∞–∫–µ",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_defect_manage",
        description:
          "–ü–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –æ –±—Ä–∞–∫–µ (workflow, —Ä–µ–º–æ–Ω—Ç)",
        createdAt: now,
        updatedAt: now,
      },


      {
        code: "beryll_yadro_view",
        description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫ –≤ –Ø–¥—Ä–æ",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_yadro_manage",
        description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –≤ –Ø–¥—Ä–æ",
        createdAt: now,
        updatedAt: now,
      },


      {
        code: "beryll_substitute_view",
        description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—É–ª–∞ –ø–æ–¥–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤",
        createdAt: now,
        updatedAt: now,
      },
      {
        code: "beryll_substitute_manage",
        description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–º–µ–Ω–Ω—ã–º–∏ —Å–µ—Ä–≤–µ—Ä–∞–º–∏",
        createdAt: now,
        updatedAt: now,
      },


      {
        code: "beryll_admin",
        description: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ Beryll (SLA, —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)",
        createdAt: now,
        updatedAt: now,
      },
    ];


    const existingAbilities = await queryInterface.sequelize.query(
      `SELECT code FROM abilities WHERE code LIKE 'beryll_%'`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    const existingCodes = new Set(existingAbilities.map((a) => a.code));
    const newAbilities = abilities.filter((a) => !existingCodes.has(a.code));

    if (newAbilities.length > 0) {
      await queryInterface.bulkInsert("abilities", newAbilities);
      console.log(`‚úÖ Added ${newAbilities.length} new abilities`);
    } else {
      console.log("‚ÑπÔ∏è All abilities already exist");
    }


    const adminRole = await queryInterface.sequelize.query(
      `SELECT id FROM roles WHERE name = 'admin' LIMIT 1`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    if (adminRole.length > 0) {
      const adminRoleId = adminRole[0].id;

      const insertedAbilities = await queryInterface.sequelize.query(
        `SELECT id, code FROM abilities WHERE code LIKE 'beryll_%'`,
        { type: Sequelize.QueryTypes.SELECT }
      );

      const existingRoleAbilities = await queryInterface.sequelize.query(
        `SELECT "abilityId" FROM role_abilities WHERE "roleId" = ${adminRoleId}`,
        { type: Sequelize.QueryTypes.SELECT }
      );

      const existingAbilityIds = new Set(
        existingRoleAbilities.map((ra) => ra.abilityId)
      );

      const roleAbilities = insertedAbilities
        .filter((a) => !existingAbilityIds.has(a.id))
        .map((ability) => ({
          roleId: adminRoleId,
          abilityId: ability.id,
          createdAt: now,
          updatedAt: now,
        }));

      if (roleAbilities.length > 0) {
        await queryInterface.bulkInsert("role_abilities", roleAbilities);
        console.log(
          `‚úÖ Linked ${roleAbilities.length} abilities to admin role`
        );
      }
    }


    const techRole = await queryInterface.sequelize.query(
      `SELECT id FROM roles WHERE name IN ('technologist', 'technolog', '—Ç–µ—Ö–Ω–æ–ª–æ–≥') LIMIT 1`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    if (techRole.length > 0) {
      const techRoleId = techRole[0].id;

      const techAbilities = await queryInterface.sequelize.query(
        `SELECT id FROM abilities WHERE code IN (
          'beryll_component_view',
          'beryll_defect_view',
          'beryll_defect_create',
          'beryll_defect_manage',
          'beryll_yadro_view',
          'beryll_substitute_view'
        )`,
        { type: Sequelize.QueryTypes.SELECT }
      );

      const existingTechAbilities = await queryInterface.sequelize.query(
        `SELECT "abilityId" FROM role_abilities WHERE "roleId" = ${techRoleId}`,
        { type: Sequelize.QueryTypes.SELECT }
      );

      const existingTechAbilityIds = new Set(
        existingTechAbilities.map((ra) => ra.abilityId)
      );

      const techRoleAbilities = techAbilities
        .filter((a) => !existingTechAbilityIds.has(a.id))
        .map((ability) => ({
          roleId: techRoleId,
          abilityId: ability.id,
          createdAt: now,
          updatedAt: now,
        }));

      if (techRoleAbilities.length > 0) {
        await queryInterface.bulkInsert("role_abilities", techRoleAbilities);
        console.log(
          `‚úÖ Linked ${techRoleAbilities.length} abilities to technologist role`
        );
      }
    }
  },

  down: async (queryInterface, Sequelize) => {

    await queryInterface.sequelize.query(`
      DELETE FROM role_abilities
      WHERE "abilityId" IN (
        SELECT id FROM abilities WHERE code LIKE 'beryll_%'
      )
    `);


    await queryInterface.bulkDelete("abilities", {
      code: {
        [Sequelize.Op.like]: "beryll_%",
      },
    });
  },
};

================================================================================
FILE: QMS-Server-master/seeders/20260123-component-catalog.js
================================================================================



"use strict";

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const now = new Date();

    const catalogData = [


      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E",
        revision: "1E-",
        partNumber: "MBDX86780001E",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          memorySlots: 16,
          maxMemory: "4TB"
        }),
        serialNumberPattern: "^MBD[A-Z0-9]+$",
        isActive: true,
        notes: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞ VegamanS220v8 Rev 1E-",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E1",
        revision: "1E1-",
        partNumber: "MBDX86780001E1",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          memorySlots: 16,
          maxMemory: "4TB"
        }),
        serialNumberPattern: "^MBD[A-Z0-9]+$",
        isActive: true,
        notes: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞ VegamanS220v8 Rev 1E1-",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E+",
        revision: "1E+",
        partNumber: "MBDX86780001E+",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          memorySlots: 16,
          maxMemory: "4TB"
        }),
        serialNumberPattern: "^MBD[A-Z0-9]+$",
        isActive: true,
        notes: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞ VegamanS220v8 Rev 1E+",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "SSD",
        manufacturer: "Intel",
        model: "SSDSC2KB960G8",
        revision: null,
        partNumber: "SSDSC2KB960G8",
        specifications: JSON.stringify({
          capacity: "960GB",
          interface: "SATA 6Gb/s",
          formFactor: "2.5\"",
          type: "TLC",
          readSpeed: "560 MB/s",
          writeSpeed: "510 MB/s"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Intel SSD D3-S4510 Series 960GB",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Samsung",
        model: "MZ-QL27T60",
        revision: null,
        partNumber: "MZ-QL27T60",
        specifications: JSON.stringify({
          capacity: "7.68TB",
          interface: "NVMe PCIe 4.0",
          formFactor: "U.2",
          type: "TLC",
          readSpeed: "7000 MB/s",
          writeSpeed: "3500 MB/s"
        }),
        serialNumberPattern: "^S[A-Z0-9]+$",
        isActive: true,
        notes: "Samsung PM9A3 7.68TB NVMe",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "M393A8G40AB2-CWEC0",
        revision: "2245",
        partNumber: "KR M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MHz",
          ecc: true,
          registered: true,
          voltage: "1.2V"
        }),
        serialNumberPattern: "^Y1[A-Z0-9]+$",
        isActive: true,
        notes: "Samsung DDR4 64GB RDIMM ECC",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "M393A8G40BB4-CWE",
        revision: null,
        partNumber: "M393A8G40BB4-CWE",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MHz",
          ecc: true,
          registered: true,
          voltage: "1.2V"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Samsung DDR4 64GB RDIMM ECC (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "HDD",
        manufacturer: "Seagate",
        model: "ST16000NM001G",
        revision: null,
        partNumber: "ST16000NM001G",
        specifications: JSON.stringify({
          capacity: "16TB",
          interface: "SATA 6Gb/s",
          formFactor: "3.5\"",
          rpm: 7200,
          cache: "256MB"
        }),
        serialNumberPattern: "^ZRT[A-Z0-9]+$",
        isActive: true,
        notes: "Seagate Exos X16 16TB",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "HDD",
        manufacturer: "Seagate",
        model: "STL015",
        revision: null,
        partNumber: "STL015",
        specifications: JSON.stringify({
          capacity: "15TB",
          interface: "SAS 12Gb/s",
          formFactor: "3.5\"",
          rpm: 7200
        }),
        serialNumberPattern: "^Y1P[A-Z0-9]+$",
        isActive: true,
        notes: "Seagate SAS 15TB",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "PSU",
        manufacturer: "Aspower",
        model: "U1A-D11200-DRB",
        revision: null,
        partNumber: "U1A-D11200-DRB",
        specifications: JSON.stringify({
          power: "1200W",
          efficiency: "80+ Platinum",
          formFactor: "1U",
          redundant: true,
          hotSwap: true
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è 1200W 1U Redundant",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "CPU",
        manufacturer: "Intel",
        model: "Xeon Gold 6338",
        revision: null,
        partNumber: "CD8068904572501",
        specifications: JSON.stringify({
          cores: 32,
          threads: 64,
          baseClock: "2.0 GHz",
          turboClock: "3.2 GHz",
          tdp: "205W",
          socket: "LGA4189"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Intel Xeon Gold 6338 32-Core",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "CPU",
        manufacturer: "Intel",
        model: "Xeon Platinum 8380",
        revision: null,
        partNumber: "CD8068904572601",
        specifications: JSON.stringify({
          cores: 40,
          threads: 80,
          baseClock: "2.3 GHz",
          turboClock: "3.4 GHz",
          tdp: "270W",
          socket: "LGA4189"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Intel Xeon Platinum 8380 40-Core",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "NIC",
        manufacturer: "Intel",
        model: "X710-DA4",
        revision: null,
        partNumber: "X710DA4FHBLK",
        specifications: JSON.stringify({
          ports: 4,
          speed: "10GbE",
          connector: "SFP+",
          pcie: "x8 Gen3"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Intel X710 4x10GbE SFP+",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "MCX516A-CDAT",
        revision: null,
        partNumber: "MCX516A-CDAT",
        specifications: JSON.stringify({
          ports: 2,
          speed: "100GbE",
          connector: "QSFP28",
          pcie: "x16 Gen4"
        }),
        serialNumberPattern: "^MT[A-Z0-9]+$",
        isActive: true,
        notes: "Mellanox ConnectX-5 2x100GbE",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "RAID",
        manufacturer: "Broadcom",
        model: "MegaRAID 9460-16i",
        revision: null,
        partNumber: "05-50011-00",
        specifications: JSON.stringify({
          ports: 16,
          interface: "SAS/SATA",
          cache: "4GB",
          raidLevels: "0,1,5,6,10,50,60"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Broadcom MegaRAID 9460-16i",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "BMC",
        manufacturer: "ASPEED",
        model: "AST2600",
        revision: null,
        partNumber: "AST2600A3",
        specifications: JSON.stringify({
          type: "BMC SoC",
          processor: "ARM Cortex-A7 Dual Core",
          memory: "1GB DDR4"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "ASPEED AST2600 BMC",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "FAN",
        manufacturer: "Delta",
        model: "GFB0412EHS",
        revision: null,
        partNumber: "GFB0412EHS",
        specifications: JSON.stringify({
          size: "40x40x56mm",
          rpm: "15000",
          cfm: "24.5",
          voltage: "12V"
        }),
        serialNumberPattern: "^[A-Z0-9]+$",
        isActive: true,
        notes: "Delta –≤—ã—Å–æ–∫–æ—Å–∫–æ—Ä–æ—Å—Ç–Ω–æ–π —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "BACKPLANE",
        manufacturer: "Yadro",
        model: "BP-SAS-12",
        revision: null,
        partNumber: "BP-SAS-12",
        specifications: JSON.stringify({
          slots: 12,
          interface: "SAS/SATA",
          formFactor: "3.5\""
        }),
        serialNumberPattern: "^BP[A-Z0-9]+$",
        isActive: true,
        notes: "Backplane –Ω–∞ 12 –¥–∏—Å–∫–æ–≤ 3.5\"",
        createdAt: now,
        updatedAt: now
      }
    ];

    await queryInterface.bulkInsert("component_catalog", catalogData);

    console.log(`‚úÖ Seeded ${catalogData.length} component catalog entries`);
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.bulkDelete("component_catalog", null, {});
  }
};

================================================================================
FILE: QMS-Server-master/seeders/20260123-sla-config.js
================================================================================



"use strict";

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const now = new Date();

    const slaConfigs = [


      {
        name: "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é",
        defectType: null,
        priority: null,
        maxDiagnosisHours: 24,
        maxRepairHours: 72,
        maxTotalHours: 168,
        escalationAfterHours: 48,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        name: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
        defectType: null,
        priority: "CRITICAL",
        maxDiagnosisHours: 4,
        maxRepairHours: 24,
        maxTotalHours: 48,
        escalationAfterHours: 8,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
        defectType: null,
        priority: "HIGH",
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 96,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
        defectType: null,
        priority: "MEDIUM",
        maxDiagnosisHours: 24,
        maxRepairHours: 72,
        maxTotalHours: 168,
        escalationAfterHours: 48,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç",
        defectType: null,
        priority: "LOW",
        maxDiagnosisHours: 48,
        maxRepairHours: 120,
        maxTotalHours: 336,
        escalationAfterHours: 96,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        name: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞",
        defectType: "MOTHERBOARD",
        priority: null,
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 120,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å",
        defectType: "RAM",
        priority: null,
        maxDiagnosisHours: 4,
        maxRepairHours: 24,
        maxTotalHours: 72,
        escalationAfterHours: 16,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–ñ—ë—Å—Ç–∫–∏–π –¥–∏—Å–∫",
        defectType: "HDD",
        priority: null,
        maxDiagnosisHours: 4,
        maxRepairHours: 24,
        maxTotalHours: 72,
        escalationAfterHours: 16,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "SSD –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å",
        defectType: "SSD",
        priority: null,
        maxDiagnosisHours: 4,
        maxRepairHours: 24,
        maxTotalHours: 72,
        escalationAfterHours: 16,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è",
        defectType: "PSU",
        priority: null,
        maxDiagnosisHours: 2,
        maxRepairHours: 8,
        maxTotalHours: 24,
        escalationAfterHours: 4,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä",
        defectType: "FAN",
        priority: null,
        maxDiagnosisHours: 2,
        maxRepairHours: 4,
        maxTotalHours: 24,
        escalationAfterHours: 4,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "–°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞",
        defectType: "NIC",
        priority: null,
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 96,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä",
        defectType: "RAID",
        priority: null,
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 120,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "BMC –º–æ–¥—É–ª—å",
        defectType: "BMC",
        priority: null,
        maxDiagnosisHours: 8,
        maxRepairHours: 48,
        maxTotalHours: 120,
        escalationAfterHours: 24,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },


      {
        name: "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞ - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π",
        defectType: "MOTHERBOARD",
        priority: "CRITICAL",
        maxDiagnosisHours: 2,
        maxRepairHours: 24,
        maxTotalHours: 48,
        escalationAfterHours: 4,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "RAM - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π",
        defectType: "RAM",
        priority: "CRITICAL",
        maxDiagnosisHours: 1,
        maxRepairHours: 8,
        maxTotalHours: 24,
        escalationAfterHours: 2,
        isActive: true,
        createdAt: now,
        updatedAt: now
      },
      {
        name: "PSU - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π",
        defectType: "PSU",
        priority: "CRITICAL",
        maxDiagnosisHours: 1,
        maxRepairHours: 4,
        maxTotalHours: 8,
        escalationAfterHours: 2,
        isActive: true,
        createdAt: now,
        updatedAt: now
      }
    ];

    await queryInterface.bulkInsert("sla_config", slaConfigs);

    console.log(`‚úÖ Seeded ${slaConfigs.length} SLA configurations`);
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.bulkDelete("sla_config", null, {});
  }
};

================================================================================
FILE: QMS-Server-master/seeders/20260201-vegman-component-revisions.js
================================================================================

"use strict";


module.exports = {
  up: async (queryInterface, Sequelize) => {
    const now = new Date();


    const existing = await queryInterface.sequelize.query(
      `SELECT COUNT(*) as cnt FROM component_catalog WHERE notes LIKE '%VegmanS220v8%'`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    if (existing[0]?.cnt > 0) {
      console.log("‚ö†Ô∏è  –†–µ–≤–∏–∑–∏–∏ VegmanS220v8 —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...");
      return;
    }

    const catalogData = [


      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E",
        revision: "1E-",
        partNumber: "MBDX86780001E",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          serverModel: "Vegman S220"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ú–∞—Ç. –ø–ª–∞—Ç–∞ —Ä–µ–≤–∏–∑–∏—è 1E-",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001E1",
        revision: "1E1-",
        partNumber: "MBDX86780001E1",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          serverModel: "Vegman R220"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ú–∞—Ç. –ø–ª–∞—Ç–∞ —Ä–µ–≤–∏–∑–∏—è 1E1-",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "MOTHERBOARD",
        manufacturer: "Yadro",
        model: "MBDX86780001D",
        revision: "1D",
        partNumber: "MBDX86780001D",
        specifications: JSON.stringify({
          socket: "LGA4677",
          chipset: "Intel C741",
          formFactor: "E-ATX",
          serverModel: "–°–µ—Ä–≤–µ—Ä –•2-262",
          variants: ["1E+", "1D+", "1D-"]
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ú–∞—Ç. –ø–ª–∞—Ç–∞ —Ä–µ–≤–∏–∑–∏—è 1D (—Ç–∏–ø—ã: 1E+, 1D+, 1D-)",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.20",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.20",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.21",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.21",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.AV",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.AV",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.22",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.22",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.B3",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.B3",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.B6",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.B6",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "NIC",
        manufacturer: "Mellanox",
        model: "CX4121A",
        revision: "Rev.B7",
        partNumber: "P225P",
        specifications: JSON.stringify({ interface: "25GbE", ports: 2 }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ P225P Rev.B7",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "RAID",
        manufacturer: "Broadcom",
        model: "–¢–∏–ø 1",
        revision: null,
        partNumber: null,
        specifications: JSON.stringify({ raidType: "–¢–∏–ø 1" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî RAID-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¢–∏–ø 1 (Broadcom)",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAID",
        manufacturer: null,
        model: "–¢–∏–ø 2",
        revision: null,
        partNumber: null,
        specifications: JSON.stringify({ raidType: "–¢–∏–ø 2" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî RAID-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¢–∏–ø 2",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "FAN",
        manufacturer: null,
        model: "–¢–∏–ø 1",
        revision: null,
        partNumber: null,
        specifications: JSON.stringify({ coolerType: "–¢–∏–ø 1" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ö—É–ª–µ—Ä—ã CPU –¢–∏–ø 1",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "FAN",
        manufacturer: null,
        model: "–¢–∏–ø 2",
        revision: null,
        partNumber: null,
        specifications: JSON.stringify({ coolerType: "–¢–∏–ø 2" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ö—É–ª–µ—Ä—ã CPU –¢–∏–ø 2",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "BACKPLANE",
        manufacturer: "Yadro",
        model: "BPLSAS780002C",
        revision: null,
        partNumber: "BPLSAS780002C",
        specifications: JSON.stringify({
          slots: 12,
          interface: "SAS",
          backplanePresent: true
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî Backplane 12 –¥–∏—Å–∫–æ–≤ (Backplane: +)",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "BACKPLANE",
        manufacturer: "Yadro",
        model: "BPLSAS780001A1",
        revision: null,
        partNumber: "BPLSAS780001A1",
        specifications: JSON.stringify({
          slots: 12,
          interface: "SAS",
          backplanePresent: false
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî Backplane 12 –¥–∏—Å–∫–æ–≤ (Backplane: -)",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "BMC",
        manufacturer: "Yadro",
        model: "IOBBMC740001A1",
        revision: null,
        partNumber: "IOBBMC740001A1",
        specifications: JSON.stringify({ bmcType: "A1" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî BMC IOBBMC740001A1",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "BMC",
        manufacturer: "Yadro",
        model: "IOBBMC740001C",
        revision: null,
        partNumber: "IOBBMC740001C",
        specifications: JSON.stringify({ bmcType: "C" }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî BMC IOBBMC740001C",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "SSD",
        manufacturer: "Intel",
        model: "SSDSC2KB960G8",
        revision: null,
        partNumber: "SSDSC2KB960G8",
        specifications: JSON.stringify({
          capacity: "960GB",
          interface: "SATA",
          formFactor: "2.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Intel SSDSC2KB960G8",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Samsung",
        model: "MZ-QL27T60",
        revision: null,
        partNumber: "MZ-QL27T60",
        specifications: JSON.stringify({
          capacity: "7.68TB",
          interface: "NVMe",
          formFactor: "U.2"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Samsung MZ-QL27T60",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Micron",
        model: "MTFDHAL6T4TDR-1AT1ZABYY",
        revision: null,
        partNumber: "MTFDHAL6T4TDR-1AT1ZABYY",
        specifications: JSON.stringify({
          capacity: "6.4TB",
          interface: "NVMe"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Micron MTFDHAL6T4TDR-1AT1ZABYY",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Micron",
        model: "MTFDKCB7T6TDZ",
        revision: null,
        partNumber: "MTFDKCB7T6TDZ",
        specifications: JSON.stringify({
          capacity: "7.68TB",
          interface: "NVMe"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Micron MTFDKCB7T6TDZ",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Samsung",
        model: "MZ-7KH9600",
        revision: null,
        partNumber: "MZ-7KH9600",
        specifications: JSON.stringify({
          capacity: "960GB",
          interface: "SATA",
          formFactor: "2.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Samsung MZ-7KH9600",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "SSD",
        manufacturer: "Intel",
        model: "SSDSC2KB960GZ",
        revision: null,
        partNumber: "SSDSC2KB960GZ",
        specifications: JSON.stringify({
          capacity: "960GB",
          interface: "SATA",
          formFactor: "2.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî SSD Intel SSDSC2KB960GZ",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "HDD",
        manufacturer: "Seagate",
        model: "STL015",
        revision: null,
        partNumber: "STL015",
        specifications: JSON.stringify({
          interface: "SAS",
          formFactor: "3.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî HDD Seagate STL015",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "HDD",
        manufacturer: "Seagate",
        model: "STL009",
        revision: null,
        partNumber: "STL009",
        specifications: JSON.stringify({
          interface: "SAS",
          formFactor: "3.5\""
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî HDD Seagate STL009",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "PSU",
        manufacturer: "Aspower",
        model: "U1A-D11200-DRB",
        revision: null,
        partNumber: "U1A-D11200-DRB",
        specifications: JSON.stringify({
          wattage: "1200W",
          efficiency: "80+ Platinum"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ë–ü Aspower U1A-D11200-DRB",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "PSU",
        manufacturer: "AcBel",
        model: "R1CA2122A",
        revision: null,
        partNumber: "R1CA2122A",
        specifications: JSON.stringify({
          wattage: "1200W"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ë–ü AcBel R1CA2122A",
        createdAt: now,
        updatedAt: now
      },


      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2245",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2245",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2249",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2249",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2248",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2248",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2320",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2320",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2250",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2250",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2312",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2312",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2251",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2251",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2306",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2306",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2308",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2308",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2305",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2305",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWEC0",
        revision: "2310",
        partNumber: "M393A8G40AB2-CWEC0",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2310",
        createdAt: now,
        updatedAt: now
      },
      {
        type: "RAM",
        manufacturer: "Samsung",
        model: "KR M393A8G40AB2-CWE",
        revision: "2250",
        partNumber: "M393A8G40AB2-CWE",
        specifications: JSON.stringify({
          capacity: "64GB",
          type: "DDR4",
          speed: "3200 MT/s",
          formFactor: "RDIMM"
        }),
        isActive: true,
        notes: "VegmanS220v8 ‚Äî –ü–ª–∞–Ω–∫–∞ –ø–∞–º—è—Ç–∏ Samsung 64GB DDR4 rev.2250 (CWE)",
        createdAt: now,
        updatedAt: now
      }
    ];


    for (const entry of catalogData) {
      try {
        const exists = await queryInterface.sequelize.query(
          `SELECT id FROM component_catalog
           WHERE type = :type
           AND (manufacturer = :manufacturer OR (manufacturer IS NULL AND :manufacturer IS NULL))
           AND model = :model`,
          {
            replacements: {
              type: entry.type,
              manufacturer: entry.manufacturer,
              model: entry.model
            },
            type: Sequelize.QueryTypes.SELECT
          }
        );

        if (exists.length === 0) {
          await queryInterface.bulkInsert("component_catalog", [entry]);
          console.log(`  ‚úÖ ${entry.type}: ${entry.manufacturer || ''} ${entry.model} (rev: ${entry.revision || '-'})`);
        } else {

          await queryInterface.sequelize.query(
            `UPDATE component_catalog SET revision = :revision, notes = :notes, "updatedAt" = NOW()
             WHERE id = :id`,
            {
              replacements: {
                revision: entry.revision,
                notes: entry.notes,
                id: exists[0].id
              }
            }
          );
          console.log(`  üîÑ ${entry.type}: ${entry.manufacturer || ''} ${entry.model} ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–æ`);
        }
      } catch (err) {
        console.error(`  ‚ùå ${entry.type}: ${entry.model} ‚Äî ${err.message}`);
      }
    }

    console.log(`\n‚úÖ Seeded VegmanS220v8 component revisions (${catalogData.length} entries)`);
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.bulkDelete("component_catalog", {
      notes: { [Sequelize.Op.like]: "%VegmanS220v8%" }
    });
    console.log("‚úÖ Removed VegmanS220v8 component revisions");
  }
};

================================================================================
FILE: QMS-Server-master/seeders/beryllSeeder.js
================================================================================

const {
  BeryllChecklistTemplate,
  CHECKLIST_GROUPS
} = require("../models/definitions/Beryll");


async function seedBeryllChecklistTemplates() {
  try {

    const count = await BeryllChecklistTemplate.count();
    if (count > 0) {
      console.log(`‚úÖ [Beryll] –®–∞–±–ª–æ–Ω—ã —á–µ–∫-–ª–∏—Å—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç (${count} —à—Ç.)`);
      return { created: false, count };
    }


    const templates = [

      {
        groupCode: CHECKLIST_GROUPS.VISUAL,
        title: '–í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞',
        description: '–ü—Ä–æ–≤–µ—Å—Ç–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è), –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ',
        fileCode: null,
        requiresFile: false,
        sortOrder: 100,
        isRequired: true,
        estimatedMinutes: 10,
        isActive: true
      },


      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–°–∫—Ä–∏–Ω –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏',
        description: '–°–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞',
        fileCode: 'sn_on2',
        requiresFile: true,
        sortOrder: 200,
        isRequired: true,
        estimatedMinutes: 5,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç RAID (cachevault)',
        description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å RAID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏ cachevault',
        fileCode: 'sn_cachevault2',
        requiresFile: true,
        sortOrder: 210,
        isRequired: true,
        estimatedMinutes: 15,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–°—Ç—Ä–µ—Å—Å —Ç–µ—Å—Ç 3 (60 –º–∏–Ω)',
        description: '–ü—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ 60 –º–∏–Ω—É—Ç',
        fileCode: 'sn_gtk32',
        requiresFile: true,
        sortOrder: 220,
        isRequired: true,
        estimatedMinutes: 60,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç SSD + —Å–∫—Ä–∏–Ω RAID',
        description: '–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å SSD –∏ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç RAID',
        fileCode: 'sn_raid2',
        requiresFile: true,
        sortOrder: 230,
        isRequired: true,
        estimatedMinutes: 20,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç HDD, SSD + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤',
        description: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HDD –∏ SSD, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤',
        fileCode: null,
        requiresFile: false,
        sortOrder: 240,
        isRequired: true,
        estimatedMinutes: 30,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ (0, 3, 6)',
        description: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ 0, 3, 6 + —Å–∫—Ä–∏–Ω',
        fileCode: 'sn_dimm2',
        requiresFile: true,
        sortOrder: 250,
        isRequired: true,
        estimatedMinutes: 30,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π –ø–∞–º—è—Ç–∏ (11, 12)',
        description: '–í—ã—è–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞, –∑–∞—è–≤–∫–∞ –≤ –Ø–¥—Ä–æ, –æ—Ç–º–µ—Ç–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –±—Ä–∞–∫–∞',
        fileCode: 'sn_dimm2FAIL2',
        requiresFile: false,
        sortOrder: 260,
        isRequired: false,
        estimatedMinutes: 20,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤',
        description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤',
        fileCode: null,
        requiresFile: false,
        sortOrder: 270,
        isRequired: true,
        estimatedMinutes: 5,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–í—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –æ–±—â–∏–π –¥–∏—Å–∫',
        description: '–í—ã–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤',
        fileCode: null,
        requiresFile: false,
        sortOrder: 280,
        isRequired: true,
        estimatedMinutes: 10,
        isActive: true
      },
      {
        groupCode: CHECKLIST_GROUPS.TESTING,
        title: '–°–∫—Ä–∏–Ω BIOS, BMC [dts, die]',
        description: '–í–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ + —Å–∫—Ä–∏–Ω –∏–∑ BIOS, BMC',
        fileCode: 'sn_Bios2',
        requiresFile: true,
        sortOrder: 290,
        isRequired: true,
        estimatedMinutes: 10,
        isActive: true
      },


      {
        groupCode: CHECKLIST_GROUPS.QC_PRIMARY,
        title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤ (–û–¢–ö)',
        description: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤',
        fileCode: null,
        requiresFile: false,
        sortOrder: 300,
        isRequired: true,
        estimatedMinutes: 15,
        isActive: true
      },


      {
        groupCode: CHECKLIST_GROUPS.BURN_IN,
        title: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–æ–Ω',
        description: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–æ–Ω (burn-in)',
        fileCode: null,
        requiresFile: false,
        sortOrder: 400,
        isRequired: true,
        estimatedMinutes: 1440,
        isActive: true
      },


      {
        groupCode: CHECKLIST_GROUPS.QC_FINAL,
        title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–æ–Ω–∞ (–û–¢–ö)',
        description: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–æ–Ω–∞',
        fileCode: null,
        requiresFile: false,
        sortOrder: 500,
        isRequired: true,
        estimatedMinutes: 10,
        isActive: true
      }
    ];

    await BeryllChecklistTemplate.bulkCreate(templates);
    console.log(`‚úÖ [Beryll] –°–æ–∑–¥–∞–Ω–æ ${templates.length} —à–∞–±–ª–æ–Ω–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞`);

    return { created: true, count: templates.length };

  } catch (e) {
    console.error('‚ùå [Beryll] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —à–∞–±–ª–æ–Ω–æ–≤:', e.message);
    return { created: false, error: e.message };
  }
}

module.exports = { seedBeryllChecklistTemplates };

================================================================================
FILE: QMS-Server-master/services/ExcelImportService.js
================================================================================



const XLSX = require("xlsx");
const path = require("path");
const fs = require("fs");
const { sequelize } = require("../../models/index");

class ExcelImportService {


    async importServerComponents(filePath, options = {}) {
        const { dryRun = false, skipExisting = true } = options;

        const workbook = XLSX.readFile(filePath);
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const results = {
            servers: [],
            components: [],
            errors: [],
            skipped: []
        };

        const {
            BeryllServer,
            BeryllServerComponent,
            ComponentInventory,
            ComponentCatalog
        } = require("../../models/index");


        for (let i = 2; i < data.length; i++) {
            const row = data[i];
            if (!row || !row[0]) continue;

            try {
                const serverSerial = String(row[0]).trim();


                let server = await BeryllServer.findOne({
                    where: { apkSerialNumber: serverSerial }
                });

                if (!server) {
                    if (!dryRun) {
                        server = await BeryllServer.create({
                            apkSerialNumber: serverSerial,
                            status: "NEW"
                        });
                    }
                    results.servers.push({ serial: serverSerial, action: "created" });
                } else {
                    results.servers.push({ serial: serverSerial, action: "exists" });
                }


                const components = [];


                for (let j = 1; j <= 12; j++) {
                    const serialYadro = row[j] ? String(row[j]).trim() : null;
                    if (serialYadro) {
                        components.push({
                            type: "HDD",
                            serialNumberYadro: serialYadro,
                            serialNumber: serialYadro,
                            slot: `HDD_${j}`
                        });
                    }
                }


                for (let j = 13; j <= 24; j++) {
                    const serialYadro = row[j] ? String(row[j]).trim() : null;
                    if (serialYadro) {
                        components.push({
                            type: "RAM",
                            serialNumberYadro: serialYadro,
                            serialNumber: serialYadro,
                            slot: `DIMM_${j - 12}`
                        });
                    }
                }


                for (let j = 25; j <= 28; j++) {
                    const serialYadro = row[j] ? String(row[j]).trim() : null;
                    if (serialYadro) {
                        components.push({
                            type: "SSD",
                            serialNumberYadro: serialYadro,
                            serialNumber: serialYadro,
                            slot: `SSD_${j - 24}`
                        });
                    }
                }


                const psu1Yadro = row[29] ? String(row[29]).trim() : null;
                const psu1Manuf = row[30] ? String(row[30]).trim() : null;
                if (psu1Yadro || psu1Manuf) {
                    components.push({
                        type: "PSU",
                        serialNumberYadro: psu1Yadro,
                        serialNumber: psu1Manuf || psu1Yadro,
                        slot: "PSU_1"
                    });
                }


                const psu2Yadro = row[31] ? String(row[31]).trim() : null;
                const psu2Manuf = row[32] ? String(row[32]).trim() : null;
                if (psu2Yadro || psu2Manuf) {
                    components.push({
                        type: "PSU",
                        serialNumberYadro: psu2Yadro,
                        serialNumber: psu2Manuf || psu2Yadro,
                        slot: "PSU_2"
                    });
                }


                for (const comp of components) {
                    try {

                        const existingInventory = await ComponentInventory.findOne({
                            where: {
                                serialNumber: comp.serialNumber
                            }
                        });

                        if (existingInventory) {
                            if (skipExisting) {
                                results.skipped.push({
                                    server: serverSerial,
                                    component: comp,
                                    reason: "duplicate"
                                });
                                continue;
                            }
                        }

                        if (!dryRun) {

                            const inventoryRecord = await ComponentInventory.create({
                                type: comp.type,
                                serialNumber: comp.serialNumber,
                                serialNumberYadro: comp.serialNumberYadro,
                                status: "IN_USE",
                                condition: "NEW",
                                currentServerId: server?.id
                            });


                            if (server) {
                                await BeryllServerComponent.create({
                                    serverId: server.id,
                                    type: comp.type,
                                    serialNumberYadro: comp.serialNumberYadro,
                                    serialNumberManuf: comp.serialNumber !== comp.serialNumberYadro ? comp.serialNumber : null,
                                    slot: comp.slot,
                                    inventoryId: inventoryRecord.id,
                                    installedAt: new Date()
                                });
                            }
                        }

                        results.components.push({
                            server: serverSerial,
                            type: comp.type,
                            serial: comp.serialNumber,
                            action: "created"
                        });

                    } catch (compError) {
                        results.errors.push({
                            server: serverSerial,
                            component: comp,
                            error: compError.message
                        });
                    }
                }

            } catch (rowError) {
                results.errors.push({
                    row: i + 1,
                    error: rowError.message
                });
            }
        }

        return results;
    }


    async importDefectRecords(filePath, options = {}) {
        const { dryRun = false } = options;

        const workbook = XLSX.readFile(filePath);
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const results = {
            records: [],
            errors: [],
            skipped: []
        };

        const {
            BeryllServer,
            BeryllDefectRecord,
            UserAlias,
            User
        } = require("../../models/index");


        const headers = data[0];
        const colIndex = this.findColumnIndexes(headers, {
            ticketNumber: ["‚Ññ –∑–∞—è–≤–∫–∏", "–∑–∞—è–≤–∫–∞", "ticket"],
            serverSerial: ["S/N —Å–µ—Ä–≤–µ—Ä", "—Å–µ—Ä–∏–π–Ω—ã–π", "server"],
            clusterCode: ["–∫–ª–∞—Å—Ç–µ—Ä", "cluster"],
            defectDate: ["–¥–∞—Ç–∞", "date"],
            problemDescription: ["–æ–ø–∏—Å–∞–Ω–∏–µ", "–ø—Ä–æ–±–ª–µ–º–∞", "description"],
            partType: ["—Ç–∏–ø –¥–µ—Ç–∞–ª–∏", "–¥–µ—Ç–∞–ª—å", "part"],
            defectSerial: ["S/N –±—Ä–∞–∫–æ–≤–æ–π", "–±—Ä–∞–∫–æ–≤–∞—è"],
            replacementSerial: ["S/N –∑–∞–º–µ–Ω–∞", "–∑–∞–º–µ–Ω–∞"],
            status: ["—Å—Ç–∞—Ç—É—Å", "status"],
            diagnostician: ["–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫", "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å"]
        });


        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            if (!row || row.every(cell => !cell)) continue;

            try {
                const ticketNumber = this.getCellValue(row, colIndex.ticketNumber);
                const serverSerial = this.getCellValue(row, colIndex.serverSerial);

                if (!serverSerial) {
                    results.skipped.push({ row: i + 1, reason: "no server serial" });
                    continue;
                }


                const server = await BeryllServer.findOne({
                    where: { apkSerialNumber: serverSerial }
                });

                if (!server) {
                    results.errors.push({ row: i + 1, error: `Server not found: ${serverSerial}` });
                    continue;
                }


                if (ticketNumber) {
                    const existing = await BeryllDefectRecord.findOne({
                        where: { yadroTicketNumber: ticketNumber }
                    });

                    if (existing) {
                        results.skipped.push({ row: i + 1, reason: "duplicate ticket" });
                        continue;
                    }
                }


                let detectedAt = new Date();
                const dateValue = this.getCellValue(row, colIndex.defectDate);
                if (dateValue) {
                    if (typeof dateValue === "number") {

                        detectedAt = this.excelDateToJS(dateValue);
                    } else {
                        detectedAt = new Date(dateValue);
                    }
                }


                let diagnosticianId = null;
                const diagnosticianName = this.getCellValue(row, colIndex.diagnostician);
                if (diagnosticianName) {
                    const user = await UserAlias.findUserByAlias(diagnosticianName);
                    if (user) {
                        diagnosticianId = user.id;
                    }
                }


                const partTypeRaw = this.getCellValue(row, colIndex.partType);
                const repairPartType = this.mapPartType(partTypeRaw);


                const statusRaw = this.getCellValue(row, colIndex.status);
                const status = this.mapStatus(statusRaw);

                if (!dryRun) {
                    const record = await BeryllDefectRecord.create({
                        serverId: server.id,
                        yadroTicketNumber: ticketNumber || null,
                        clusterCode: this.getCellValue(row, colIndex.clusterCode) || null,
                        detectedAt,
                        problemDescription: this.getCellValue(row, colIndex.problemDescription) || null,
                        repairPartType,
                        defectPartSerialYadro: this.getCellValue(row, colIndex.defectSerial) || null,
                        replacementPartSerialYadro: this.getCellValue(row, colIndex.replacementSerial) || null,
                        status,
                        diagnosticianId
                    });

                    results.records.push({
                        id: record.id,
                        ticketNumber,
                        server: serverSerial
                    });
                } else {
                    results.records.push({
                        ticketNumber,
                        server: serverSerial,
                        dryRun: true
                    });
                }

            } catch (rowError) {
                results.errors.push({
                    row: i + 1,
                    error: rowError.message
                });
            }
        }

        return results;
    }


    findColumnIndexes(headers, mappings) {
        const indexes = {};

        for (const [key, searchTerms] of Object.entries(mappings)) {
            indexes[key] = null;

            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i] || "").toLowerCase().trim();

                for (const term of searchTerms) {
                    if (header.includes(term.toLowerCase())) {
                        indexes[key] = i;
                        break;
                    }
                }

                if (indexes[key] !== null) break;
            }
        }

        return indexes;
    }

    getCellValue(row, index) {
        if (index === null || index === undefined) return null;
        const value = row[index];
        if (value === null || value === undefined) return null;
        return String(value).trim();
    }

    excelDateToJS(excelDate) {


        const msPerDay = 24 * 60 * 60 * 1000;
        const excelEpoch = new Date(1899, 11, 30);
        return new Date(excelEpoch.getTime() + excelDate * msPerDay);
    }

    mapPartType(raw) {
        if (!raw) return null;

        const normalized = raw.toLowerCase().trim();

        const mappings = {
            "–º–ø": "MOTHERBOARD",
            "–º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è": "MOTHERBOARD",
            "motherboard": "MOTHERBOARD",
            "–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è": "RAM",
            "ram": "RAM",
            "–ø–∞–º—è—Ç—å": "RAM",
            "dimm": "RAM",
            "hdd": "HDD",
            "–∂—ë—Å—Ç–∫–∏–π": "HDD",
            "–∂–µ—Å—Ç–∫–∏–π": "HDD",
            "–¥–∏—Å–∫": "HDD",
            "ssd": "SSD",
            "—Ç–≤–µ—Ä–¥–æ—Ç–µ–ª—å–Ω—ã–π": "SSD",
            "nvme": "SSD",
            "–±–ø": "PSU",
            "–±–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è": "PSU",
            "psu": "PSU",
            "–≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä": "FAN",
            "fan": "FAN",
            "–∫—É–ª–µ—Ä": "FAN",
            "—Å–µ—Ç—å": "NIC",
            "—Å–µ—Ç–µ–≤–∞—è": "NIC",
            "nic": "NIC",
            "ethernet": "NIC",
            "raid": "RAID",
            "–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä": "RAID",
            "bmc": "BMC",
            "backplane": "BACKPLANE",
            "–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä": "CPU",
            "cpu": "CPU"
        };

        for (const [keyword, type] of Object.entries(mappings)) {
            if (normalized.includes(keyword)) {
                return type;
            }
        }

        return null;
    }

    mapStatus(raw) {
        if (!raw) return "NEW";

        const normalized = raw.toLowerCase().trim();

        const mappings = {
            "–Ω–æ–≤—ã–π": "NEW",
            "new": "NEW",
            "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "DIAGNOSING",
            "diagnosing": "DIAGNOSING",
            "–æ–∂–∏–¥–∞–Ω–∏–µ": "WAITING_PARTS",
            "waiting": "WAITING_PARTS",
            "—Ä–µ–º–æ–Ω—Ç": "REPAIRING",
            "repair": "REPAIRING",
            "–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω": "SENT_TO_YADRO",
            "—è–¥—Ä–æ": "SENT_TO_YADRO",
            "–≤–æ–∑–≤—Ä–∞—Ç": "RETURNED",
            "returned": "RETURNED",
            "—Ä–µ—à—ë–Ω": "RESOLVED",
            "—Ä–µ—à–µ–Ω": "RESOLVED",
            "resolved": "RESOLVED",
            "–∑–∞–∫—Ä—ã—Ç": "CLOSED",
            "closed": "CLOSED"
        };

        for (const [keyword, status] of Object.entries(mappings)) {
            if (normalized.includes(keyword)) {
                return status;
            }
        }

        return "NEW";
    }
}

module.exports = new ExcelImportService();

================================================================================
FILE: QMS-Server-master/services/PdfService.js
================================================================================

const PdfPrinter = require("pdfmake");
const fs = require("fs");
const path = require("path");


const possibleFontPaths = [
    path.join(__dirname, '..', 'node_modules', 'pdfmake', 'fonts', 'Roboto'),
    path.join(__dirname, '..', 'node_modules', 'pdfmake', 'src', 'fonts', 'Roboto'),
    path.join(__dirname, '..', 'fonts'),
];

function findFontDir() {
    for (const dir of possibleFontPaths) {
        const testFile = path.join(dir, 'Roboto-Regular.ttf');
        if (fs.existsSync(testFile)) return dir;
    }
    console.error("‚ùå [PdfService] –®—Ä–∏—Ñ—Ç—ã Roboto –Ω–µ –Ω–∞–π–¥–µ–Ω—ã! –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ.");
    return null;
}

const fontDir = findFontDir();
const fonts = fontDir ? {
    Roboto: {
        normal: path.join(fontDir, 'Roboto-Regular.ttf'),
        bold: path.join(fontDir, 'Roboto-Medium.ttf'),
        italics: path.join(fontDir, 'Roboto-Italic.ttf'),
        bolditalics: path.join(fontDir, 'Roboto-MediumItalic.ttf')
    }
} : {
    Roboto: { normal: 'Helvetica', bold: 'Helvetica-Bold', italics: 'Helvetica-Oblique', bolditalics: 'Helvetica-BoldOblique' }
};

const printer = new PdfPrinter(fonts);

class PdfService {

    _createPdf(docDefinition) {
        return new Promise((resolve, reject) => {
            try {
                const pdfDoc = printer.createPdfKitDocument(docDefinition);
                const chunks = [];
                pdfDoc.on('data', (chunk) => chunks.push(chunk));
                pdfDoc.on('end', () => resolve(Buffer.concat(chunks)));
                pdfDoc.on('error', (err) => {
                    console.error("PDFMake Stream Error:", err);
                    reject(err);
                });
                pdfDoc.end();
            } catch (err) {
                reject(err);
            }
        });
    }


    async generateLabels(boxes) {
        return this._createPdf({
            content: [{ text: '–§—É–Ω–∫—Ü–∏—è generateLabels –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏', fontSize: 15 }]
        });
    }


    async generateVideoTransmitterLabelBatch(labelsArray, options = {}) {
        if (!fontDir) console.warn("–í–Ω–∏–º–∞–Ω–∏–µ: –®—Ä–∏—Ñ—Ç—ã Roboto –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, PDF –º–æ–∂–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∏–Ω–∞—á–µ.");

        const pageWidthMm = options.widthMm || 140;
        const pageHeightMm = options.heightMm || 90;
        const pageWidthPt = pageWidthMm * 2.835;
        const pageHeightPt = pageHeightMm * 2.835;
        const lineWidth = (pageWidthPt - 20) * 0.60;
        const pageMargins = [5, 5, 5, 5];

        const docDefinition = {
            pageSize: { width: pageWidthPt, height: pageHeightPt },
            pageMargins: pageMargins,
            content: [],
            defaultStyle: { font: 'Roboto', fontSize: 10 }
        };

        labelsArray.forEach((data, index) => {
            const labelContent = [
                {
                    table: {
                        widths: ['35%', '65%'],
                        body: [
                            [
                                {
                                    text: data.code || '',
                                    fontSize: 12,
                                    bold: true,
                                    margin: [2, 10, 0, 0],
                                    border: [false, false, false, false]
                                },
                                {
                                    qr: data.qrCode || 'EMPTY',
                                    fit: 65,
                                    alignment: 'right',
                                    margin: [0, 0, 2, 5],
                                    border: [false, false, false, false]
                                }
                            ],
                            [
                                {
                                    text: data.productName || '–ò–∑–¥–µ–ª–∏–µ',
                                    colSpan: 2,
                                    fontSize: 12,
                                    bold: true,
                                    alignment: 'center',
                                    margin: [0, 2],
                                    fillColor: '#F0F0F0'
                                },
                                {}
                            ],
                            [
                                {
                                    text: data.id || '',
                                    fontSize: 24,
                                    bold: true,
                                    alignment: 'center',
                                    margin: [0, 8, 0, 0]
                                },
                                {
                                    stack: [
                                        { text: data.date || '', alignment: 'center', fontSize: 9, margin: [0, 0, 0, 2] },
                                        { canvas: [{ type: 'line', x1: 0, y1: 0, x2: lineWidth, y2: 0, lineWidth: 0.5, lineColor: '#000' }] },
                                        { text: `${data.quantity || ''} ${data.unit || ''}`, alignment: 'center', fontSize: 16, bold: true, margin: [0, 2, 0, 0] }
                                    ],
                                    margin: [0, 0]
                                }
                            ],
                            [
                                {
                                    text: data.contract || '',
                                    colSpan: 2,
                                    fontSize: 7,
                                    alignment: 'center',
                                    margin: [0, 2],
                                    fillColor: '#F0F0F0'
                                },
                                {}
                            ],
                            [
                                {
                                    qr: data.bottomQr || 'ERROR',
                                    fit: 75,
                                    alignment: 'center',
                                    margin: [0, 5, 0, 0],
                                    border: [false, false, false, false]
                                },
                                {
                                    text: '',
                                    border: [false, false, false, false]
                                }
                            ]
                        ]
                    },
                    layout: {
                        hLineWidth: (i, node) => {
                            if (i === 0 || i === node.table.body.length) return 0;
                            return 1;
                        },
                        vLineWidth: (i, node) => {
                            if (i === 0 || i === node.table.widths.length) return 0;
                            return 1;
                        },
                        hLineColor: '#000',
                        vLineColor: '#000',
                        paddingLeft: (i) => 5,
                        paddingRight: (i) => 5,
                        paddingTop: (i) => 2,
                        paddingBottom: (i) => 2
                    },
                    margin: [0, 0, 0, 0]
                }
            ];

            docDefinition.content.push(labelContent);

            if (index < labelsArray.length - 1) {
                docDefinition.content.push({ text: '', pageBreak: 'after' });
            }
        });

        return this._createPdf(docDefinition);
    }


    async generateSimpleZebraBatch(labelsArray, options = {}) {
        if (!fontDir && !options.suppressWarning) console.warn("–®—Ä–∏—Ñ—Ç—ã Roboto –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è Simple —à–∞–±–ª–æ–Ω–∞.");

        const pageWidthMm = options.widthMm || 140;
        const pageHeightMm = options.heightMm || 90;
        const pageWidthPt = pageWidthMm * 2.835;
        const pageHeightPt = pageHeightMm * 2.835;

        const docDefinition = {
            pageSize: { width: pageWidthPt, height: pageHeightPt },
            pageMargins: [10, 10, 10, 10],
            content: [],
            defaultStyle: { font: 'Roboto', fontSize: 12 }
        };

        labelsArray.forEach((data, index) => {
            const content = [
                { text: data.productName, fontSize: 16, bold: true, alignment: 'center', margin: [0, 0, 0, 15] },
                {
                    columns: [
                        { qr: data.bottomQr || data.code, fit: 80, alignment: 'center' },
                        {
                            stack: [
                                { text: 'ID / –ü–∞—Ä—Ç–∏—è:', fontSize: 10, color: 'gray' },
                                { text: data.code, fontSize: 14, bold: true, margin: [0, 0, 0, 10] },
                                { text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:', fontSize: 10, color: 'gray' },
                                { text: `${data.quantity} ${data.unit}`, fontSize: 18, bold: true },
                                { text: data.date, fontSize: 10, margin: [0, 5, 0, 0] }
                            ],
                            alignment: 'left',
                            margin: [10, 0, 0, 0]
                        }
                    ]
                }
            ];

            docDefinition.content.push(content);

            if (index < labelsArray.length - 1) {
                docDefinition.content.push({ text: '', pageBreak: 'after' });
            }
        });

        return this._createPdf(docDefinition);
    }


    async generateCustomLabelBatch(labelsArray, customLayout, options = {}) {
        const pageWidthMm = options.widthMm || 100;
        const pageHeightMm = options.heightMm || 60;
        const pageWidthPt = pageWidthMm * 2.835;
        const pageHeightPt = pageHeightMm * 2.835;
        const MM_TO_PT = 2.835;

        const docDefinition = {
            pageSize: { width: pageWidthPt, height: pageHeightPt },
            pageMargins: [0, 0, 0, 0],
            content: [],
            defaultStyle: { font: 'Roboto', fontSize: 10 }
        };


        const replaceVars = (text, data) => {
            if (!text) return '';
            return text
                .replace(/\{\{code\}\}/g, data.code || '')
                .replace(/\{\{name\}\}/g, data.productName || '')
                .replace(/\{\{productName\}\}/g, data.productName || '')
                .replace(/\{\{id\}\}/g, data.id || '')
                .replace(/\{\{date\}\}/g, data.date || '')
                .replace(/\{\{serial\}\}/g, data.code || '')
                .replace(/\{\{contract\}\}/g, data.contract || '')
                .replace(/\{\{batch\}\}/g, data.batch || '')
                .replace(/\{\{qty\}\}/g, String(data.quantity || ''))
                .replace(/\{\{quantity\}\}/g, String(data.quantity || ''))
                .replace(/\{\{unit\}\}/g, data.unit || '')
                .replace(/\{\{price\}\}/g, data.price || '')
                .replace(/\{\{weight\}\}/g, data.weight || '')
                .replace(/\{\{url\}\}/g, `https://mes.local/item/${data.code}`)
                .replace(/\{\{full_info\}\}/g, data.bottomQr || '')
                .replace(/\{\{quantity_unit\}\}/g, `${data.quantity || ''} ${data.unit || ''}`)
                .replace(/\{\{current\}\}/g, String(data.currentIndex || 1))
                .replace(/\{\{total\}\}/g, String(data.totalCount || 1));
        };


        const STANDARD_ICONS = {

            fragile: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M15 5 L15 18 Q15 28 25 28 Q35 28 35 18 L35 5" fill="none" stroke="#000" stroke-width="2.5"/><line x1="25" y1="28" x2="25" y2="40" stroke="#000" stroke-width="2.5"/><line x1="15" y1="40" x2="35" y2="40" stroke="#000" stroke-width="2.5"/><line x1="12" y1="45" x2="38" y2="45" stroke="#000" stroke-width="2.5"/></svg>',


            keep_dry: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 8 Q10 8 8 22 L25 22 L25 38 Q25 42 30 40" fill="none" stroke="#000" stroke-width="2.5"/><path d="M25 8 Q40 8 42 22 L25 22" fill="none" stroke="#000" stroke-width="2.5"/><circle cx="14" cy="32" r="2" fill="#000"/><circle cx="22" cy="38" r="2" fill="#000"/><circle cx="36" cy="35" r="2" fill="#000"/></svg>',


            this_side_up: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 5 L35 18 L29 18 L29 24 L21 24 L21 18 L15 18 Z" fill="none" stroke="#000" stroke-width="2"/><path d="M25 26 L35 39 L29 39 L29 45 L21 45 L21 39 L15 39 Z" fill="none" stroke="#000" stroke-width="2"/></svg>',


            keep_frozen: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="5" width="10" height="30" rx="5" fill="none" stroke="#000" stroke-width="2"/><circle cx="25" cy="40" r="7" fill="none" stroke="#000" stroke-width="2"/><circle cx="25" cy="40" r="4" fill="#000"/><line x1="25" y1="38" x2="25" y2="15" stroke="#000" stroke-width="3"/></svg>',


            keep_away_heat: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><circle cx="25" cy="15" r="6" fill="none" stroke="#000" stroke-width="2"/><line x1="25" y1="5" x2="25" y2="8" stroke="#000" stroke-width="2"/><line x1="25" y1="22" x2="25" y2="25" stroke="#000" stroke-width="2"/><line x1="15" y1="15" x2="18" y2="15" stroke="#000" stroke-width="2"/><line x1="32" y1="15" x2="35" y2="15" stroke="#000" stroke-width="2"/><path d="M5 45 L5 32 L25 25 L45 32 L45 45" fill="none" stroke="#000" stroke-width="2"/></svg>',


            do_not_stack: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="28" width="30" height="18" fill="none" stroke="#000" stroke-width="2"/><rect x="14" y="12" width="22" height="14" fill="none" stroke="#000" stroke-width="2"/><line x1="5" y1="5" x2="45" y2="45" stroke="#000" stroke-width="3"/></svg>',


            warning: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 5 L45 42 L5 42 Z" fill="none" stroke="#000" stroke-width="2.5"/><line x1="25" y1="18" x2="25" y2="30" stroke="#000" stroke-width="3"/><circle cx="25" cy="36" r="2" fill="#000"/></svg>'
        };


        for (let labelIndex = 0; labelIndex < labelsArray.length; labelIndex++) {
            const data = labelsArray[labelIndex];
            const pageContent = [];


            for (const el of customLayout) {
                const xPt = el.x * MM_TO_PT;
                const yPt = el.y * MM_TO_PT;
                const widthPt = el.width * MM_TO_PT;
                const heightPt = (el.height || 10) * MM_TO_PT;


                if (el.type === 'TEXT') {
                    const textContent = replaceVars(el.content || '', data);
                    pageContent.push({
                        text: textContent,
                        fontSize: el.fontSize || 10,
                        bold: el.isBold || false,
                        alignment: el.align || 'left',
                        absolutePosition: { x: xPt, y: yPt },
                        width: widthPt
                    });
                }


                if (el.type === 'QR') {
                    const qrContent = replaceVars(el.content || '{{code}}', data);
                    const qrSize = Math.min(widthPt, heightPt);
                    pageContent.push({
                        qr: qrContent || 'EMPTY',
                        fit: qrSize,
                        absolutePosition: { x: xPt, y: yPt }
                    });
                }


                if (el.type === 'COUNTER') {
                    const counterText = replaceVars(el.counterFormat || '{{current}} / {{total}}', data);
                    pageContent.push({
                        text: counterText,
                        fontSize: el.fontSize || 14,
                        bold: el.isBold || false,
                        alignment: el.align || 'left',
                        absolutePosition: { x: xPt, y: yPt },
                        width: widthPt
                    });
                }


                if (el.type === 'LINE') {
                    const isHorizontal = el.width >= (el.height || 1);
                    const lineWidth = el.strokeWidth ? el.strokeWidth * MM_TO_PT : 1;

                    if (isHorizontal) {
                        pageContent.push({
                            canvas: [{
                                type: 'line',
                                x1: 0, y1: 0,
                                x2: widthPt, y2: 0,
                                lineWidth: lineWidth,
                                lineColor: 'black'
                            }],
                            absolutePosition: { x: xPt, y: yPt }
                        });
                    } else {
                        pageContent.push({
                            canvas: [{
                                type: 'line',
                                x1: 0, y1: 0,
                                x2: 0, y2: heightPt,
                                lineWidth: lineWidth,
                                lineColor: 'black'
                            }],
                            absolutePosition: { x: xPt, y: yPt }
                        });
                    }
                }


                if (el.type === 'RECTANGLE') {
                    const lineWidth = el.strokeWidth ? el.strokeWidth * MM_TO_PT : 1;
                    pageContent.push({
                        canvas: [{
                            type: 'rect',
                            x: 0, y: 0,
                            w: widthPt,
                            h: heightPt,
                            lineWidth: lineWidth,
                            lineColor: 'black'
                        }],
                        absolutePosition: { x: xPt, y: yPt }
                    });
                }


                if (el.type === 'IMAGE' && el.imageUrl) {
                    try {
                        pageContent.push({
                            image: el.imageUrl,
                            width: widthPt,
                            height: heightPt,
                            absolutePosition: { x: xPt, y: yPt }
                        });
                    } catch (imgErr) {
                        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', imgErr.message);
                    }
                }


                if (el.type === 'ICON') {
                    if (el.imageUrl) {

                        try {
                            pageContent.push({
                                image: el.imageUrl,
                                width: widthPt,
                                height: heightPt,
                                absolutePosition: { x: xPt, y: yPt }
                            });
                        } catch (imgErr) {
                            console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∏–∫–æ–Ω–∫–∏:', imgErr.message);
                        }
                    } else if (el.iconType && STANDARD_ICONS[el.iconType]) {

                        try {
                            pageContent.push({
                                svg: STANDARD_ICONS[el.iconType],
                                width: widthPt,
                                height: heightPt,
                                absolutePosition: { x: xPt, y: yPt }
                            });
                        } catch (svgErr) {

                            pageContent.push({
                                text: el.content || el.iconType || '?',
                                fontSize: 8,
                                absolutePosition: { x: xPt, y: yPt }
                            });
                        }
                    }
                }
            }


            if (pageContent.length > 0) {
                docDefinition.content.push({
                    stack: pageContent,
                    unbreakable: true
                });
            }


            if (labelIndex < labelsArray.length - 1) {
                docDefinition.content.push({ text: '', pageBreak: 'after' });
            }
        }

        return this._createPdf(docDefinition);
    }
}

module.exports = new PdfService();

================================================================================
FILE: QMS-Server-master/static/defect-records/2/1769537183976_README.md
================================================================================

# MES Kryptonit PWA

Progressive Web Application –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º MES Kryptonit.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **PWA** ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω, —Ä–∞–±–æ—Ç–∞ –æ—Ñ–ª–∞–π–Ω
- **Keycloak SSO** ‚Äî –µ–¥–∏–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π SSO
- **–õ–æ–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω** ‚Äî fallback –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –ª–æ–≥–∏–Ω—É/–ø–∞—Ä–æ–ª—é
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö, –ø–ª–∞–Ω—à–µ—Ç–∞—Ö, –ü–ö
- **–¢—ë–º–Ω–∞—è —Ç–µ–º–∞** ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π

## üì± –ú–æ–¥—É–ª–∏

| –ú–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| –ì–ª–∞–≤–Ω–∞—è | Dashboard —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –±—ã—Å—Ç—Ä—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ |
| –°–∫–ª–∞–¥ | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏, –ø—Ä–∏—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ |
| –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ | –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —á–µ–∫–ª–∏—Å—Ç—ã, –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ |
| –ó–∞–¥–∞—á–∏ | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ |
| –†–µ–π—Ç–∏–Ω–≥–∏ | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –∫–æ–º–∞–Ω–¥ |
| –ü—Ä–æ—Ñ–∏–ª—å | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ PWA |

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `src/config/index.ts`:

```typescript
export const config = {
  // API –±—ç–∫–µ–Ω–¥–∞ MES (—á–µ—Ä–µ–∑ Vite –ø—Ä–æ–∫—Å–∏)
  API_URL: '/api',
  
  // Keycloak
  KEYCLOAK: {
    URL: 'http://10.11.0.16:8080',
    REALM: 'MES-Realm',
    CLIENT_ID: 'mes-web-client',
  },
  
  // –ü—Ä—è–º–æ–π URL API
  API_DIRECT_URL: 'http://10.11.0.16:5001',
}
```

## üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Node.js 18+
- npm –∏–ª–∏ yarn

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd mes-pwa
npm install
```

### –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
npm run dev
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ `http://localhost:3000` –∏ `http://<–≤–∞—à-ip>:3000`.

### Production —Å–±–æ—Ä–∫–∞

```bash
npm run build
```

–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –ø–æ—è–≤—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ `dist/`.

### –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–±–æ—Ä–∫–∏

```bash
npm run preview
```

## üåê –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: Vite Preview (–ø—Ä–æ—Å—Ç–æ–π)

```bash
npm run preview -- --host
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Nginx (production)

```nginx
server {
    listen 3000;
    server_name _;
    root /var/www/mes-pwa/dist;
    index index.html;

    # PWA assets
    location /assets {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Service Worker
    location /sw.js {
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # API Proxy
    location /api {
        proxy_pass http://10.11.0.16:5001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: Docker

```dockerfile
FROM node:18-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]
```

## üîß Keycloak –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç `mes-web-client` –≤ Keycloak
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞:
   - **Client Protocol:** openid-connect
   - **Access Type:** public
   - **Valid Redirect URIs:** `http://10.11.0.16:3000/*`
   - **Web Origins:** `http://10.11.0.16:3000`
   - **Standard Flow:** Enabled
   - **Direct Access Grants:** Disabled

3. –î–æ–±–∞–≤—å—Ç–µ mappers –¥–ª—è —Ä–æ–ª–µ–π –≤ token

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
mes-pwa/
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ favicon.svg
‚îÇ   ‚îú‚îÄ‚îÄ icon-192.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-512.png
‚îÇ   ‚îú‚îÄ‚îÄ robots.txt
‚îÇ   ‚îî‚îÄ‚îÄ silent-check-sso.html
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts          # Axios –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ keycloak.ts        # Keycloak –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Layout.tsx     # –ì–ª–∞–≤–Ω—ã–π layout
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.tsx      # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useDebounce.ts     # Custom hooks
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Home/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Production/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Profile/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Rankings/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Tasks/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Warehouse/
‚îÇ   ‚îú‚îÄ‚îÄ store/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ authStore.ts       # Zustand store
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # TypeScript —Ç–∏–ø—ã
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx
‚îÇ   ‚îú‚îÄ‚îÄ index.css
‚îÇ   ‚îî‚îÄ‚îÄ main.tsx
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tailwind.config.js
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ vite.config.ts
```

## üì≤ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PWA

### Android
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Chrome
2. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω" –∏–ª–∏ –∏–∫–æ–Ω–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ

### iOS
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Safari
2. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" ‚Üí "–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π"

### Desktop
1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Chrome/Edge
2. –ù–∞–∂–º–∏—Ç–µ –∏–∫–æ–Ω–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ

## üîå API Endpoints

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–∂–∏–¥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ endpoints –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:

```
POST   /api/users/login           # –õ–æ–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω
GET    /api/users/auth            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
GET    /api/warehouse/boxes       # –°–ø–∏—Å–æ–∫ –∫–æ—Ä–æ–±–æ–∫
GET    /api/warehouse/boxes/:id   # –î–µ—Ç–∞–ª–∏ –∫–æ—Ä–æ–±–∫–∏
POST   /api/warehouse/boxes/:id/movements  # –î–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
GET    /api/products              # –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
POST   /api/products/scan         # –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
POST   /api/products/:id/complete-step     # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞
GET    /api/production-steps/:id  # –î–µ—Ç–∞–ª–∏ —ç—Ç–∞–ø–∞
GET    /api/tasks                 # –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
GET    /api/rankings/users        # –†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
GET    /api/rankings/teams        # –†–µ–π—Ç–∏–Ω–≥ –∫–æ–º–∞–Ω–¥
GET    /api/rankings/my-stats     # –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```

## üêõ Troubleshooting

### –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç Keycloak SSO
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL Keycloak –≤ –∫–æ–Ω—Ñ–∏–≥–µ
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç `mes-web-client` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Keycloak

### –û—à–∏–±–∫–∞ CORS –ø—Ä–∏ API –∑–∞–ø—Ä–æ—Å–∞—Ö
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Vite proxy –Ω–∞—Å—Ç—Ä–æ–µ–Ω (dev —Ä–µ–∂–∏–º)
- –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Nginx proxy

### PWA –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ HTTPS (–∏–ª–∏ localhost)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ manifest.json –≤ DevTools ‚Üí Application

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

================================================================================
FILE: QMS-Server-master/static/defect-records/2/1769579757522_README.md
================================================================================

# MABON ‚Äî Luxury Porcelain & Sculpture

–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω –¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–æ–≥–æ —Ñ–∞—Ä—Ñ–æ—Ä–∞ –∏ —Å–∫—É–ª—å–ø—Ç—É—Ä. React + Node.js + PostgreSQL.

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Mabon_Luxury/
‚îú‚îÄ‚îÄ src/                    # Frontend (React + TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ components/         # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ pages/              # –°—Ç—Ä–∞–Ω–∏—Ü—ã
‚îÇ   ‚îú‚îÄ‚îÄ context/            # React –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ api/                # API –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ mabon-backend/          # Backend (Node.js + Express)
‚îÇ   ‚îú‚îÄ‚îÄ controllers/        # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ models/             # Sequelize –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ routes/             # –†–æ—É—Ç—ã API
‚îÇ   ‚îú‚îÄ‚îÄ middleware/         # JWT, —Ä–æ–ª–∏, –æ—à–∏–±–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ static/             # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ docker-compose.yml      # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ nginx.conf              # Nginx –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
‚îî‚îÄ‚îÄ Dockerfile              # Frontend —Å–±–æ—Ä–∫–∞
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker)

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫

```bash
git clone <repo-url>
cd Mabon_Luxury

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d --build
```

### 2. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ

- **–°–∞–π—Ç:** http://localhost:3001
- **API:** http://localhost:5000/api

### 3. –í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω

- **Email:** `admin@mabon.local`
- **–ü–∞—Ä–æ–ª—å:** `Mabon_Super_Secret_2025!`

---

## üíª –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–±–µ–∑ Docker)

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 20+
- PostgreSQL 15+
- npm –∏–ª–∏ yarn

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞—Ç—å –ë–î
psql -U postgres -c "CREATE DATABASE mabon;"
```

### 2. Backend

```bash
cd mabon-backend

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env (—Å–º. —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ)
cp .env.example .env
nano .env

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
npm run dev
```

Backend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:5000

### 3. Frontend

```bash
# –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
npm install

# –ó–∞–ø—É—Å—Ç–∏—Ç—å dev-—Å–µ—Ä–≤–µ—Ä
npm run dev
```

Frontend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:5173

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Backend: `mabon-backend/.env`

```env
# ===== –°–ï–†–í–ï–† =====
PORT=5000

# ===== –ë–ê–ó–ê –î–ê–ù–ù–´–• =====
DB_HOST=localhost          # –î–ª—è Docker: db
DB_PORT=5432               # –õ–æ–∫–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å 5435
DB_NAME=mabon
DB_USER=postgres
DB_PASSWORD=your_password  # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ =====
JWT_SECRET=your_jwt_secret_min_32_chars    # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï
SECRET_KEY=your_secret_key_min_32_chars    # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== CORS =====
CORS_ORIGINS=http://localhost:5173,http://localhost:3000

# ===== YOOKASSA (–û–ü–õ–ê–¢–ê) =====
YOOKASSA_SHOP_ID=123456                    # –í–∞—à Shop ID
YOOKASSA_SECRET_KEY=test_xxxxx             # –¢–µ—Å—Ç–æ–≤—ã–π –∏–ª–∏ –±–æ–µ–≤–æ–π –∫–ª—é—á

# ===== –ê–î–ú–ò–ù (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ) =====
ADMIN_EMAIL=admin@mabon.local
ADMIN_PASSWORD=Strong_Password_123!        # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== SEQUELIZE =====
DB_SYNC_ALTER=true         # true –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, false –¥–ª—è –ø—Ä–æ–¥–∞
```

### Frontend: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
VITE_API_BASE_URL=http://localhost:5000
```

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

```env
VITE_API_BASE_URL=https://api.your-domain.com
```

---

## üåê –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

### –í–∞—Ä–∏–∞–Ω—Ç 1: Docker Compose –Ω–∞ VPS

#### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker –∏ Docker Compose
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
```

#### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–π—Ç–µ `docker-compose.prod.yml`:

```yaml
services:
  db:
    image: postgres:15-alpine
    container_name: mabon_db
    restart: always
    environment:
      POSTGRES_USER: mabon_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # –ò–∑ .env
      POSTGRES_DB: mabon
    volumes:
      - postgres_data:/var/lib/postgresql/data

  backend:
    build: ./mabon-backend
    container_name: mabon_backend
    restart: always
    depends_on:
      - db
    environment:
      PORT: 5000
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: mabon
      DB_USER: mabon_user
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY: ${SECRET_KEY}
      CORS_ORIGINS: https://your-domain.com
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      DB_SYNC_ALTER: "false"
    volumes:
      - ./mabon-backend/static:/app/static

  frontend:
    build:
      context: .
      args:
        VITE_API_BASE_URL: https://your-domain.com
    container_name: mabon_frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"

volumes:
  postgres_data:
```

#### 3. –°–æ–∑–¥–∞–π—Ç–µ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```env
DB_PASSWORD=SuperSecurePassword123!
JWT_SECRET=your_very_long_jwt_secret_at_least_32_characters
SECRET_KEY=your_very_long_secret_key_at_least_32_characters
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxx
ADMIN_EMAIL=admin@your-domain.com
ADMIN_PASSWORD=AdminSecurePassword456!
```

#### 4. –ó–∞–ø—É—Å–∫

```bash
docker-compose -f docker-compose.prod.yml up -d --build
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

#### Backend –Ω–∞ VPS / Cloud Run / Railway

```bash
cd mabon-backend
npm install --production
npm start
```

#### Frontend –Ω–∞ Vercel / Netlify / Cloudflare Pages

```bash
npm run build
# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–ø–∫—É dist/
```

---

## üîê –ß—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|----------|--------|
| `DB_PASSWORD` | –ü–∞—Ä–æ–ª—å –ë–î | `Kj8#mNp$2qLx` |
| `JWT_SECRET` | –°–µ–∫—Ä–µ—Ç –¥–ª—è JWT —Ç–æ–∫–µ–Ω–æ–≤ (–º–∏–Ω. 32 —Å–∏–º–≤–æ–ª–∞) | `a1b2c3d4e5f6g7h8i9j0...` |
| `SECRET_KEY` | –û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á | `x9y8z7w6v5u4t3s2r1q0...` |
| `ADMIN_PASSWORD` | –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | `Admin$ecure2025!` |
| `YOOKASSA_SECRET_KEY` | –ë–æ–µ–≤–æ–π –∫–ª—é—á –ÆKassa | `live_xxxxxxxxxxxx` |
| `CORS_ORIGINS` | –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã | `https://mabon.ru` |

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–ª—é—á–µ–π

```bash
# JWT_SECRET –∏ SECRET_KEY
openssl rand -base64 32

# –ò–ª–∏ —á–µ—Ä–µ–∑ Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## üìù API Endpoints

### –ü—É–±–ª–∏—á–Ω—ã–µ

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/product` | –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ |
| GET | `/api/product/:id` | –¢–æ–≤–∞—Ä –ø–æ ID |
| GET | `/api/author` | –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤ |
| GET | `/api/author/:id` | –ê–≤—Ç–æ—Ä –ø–æ ID |
| GET | `/api/arttype` | –¢–∏–ø—ã –∏—Å–∫—É—Å—Å—Ç–≤–∞ |
| GET | `/api/review/product/:id` | –û—Ç–∑—ã–≤—ã —Ç–æ–≤–∞—Ä–∞ |

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/api/user/registration` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è |
| POST | `/api/user/login` | –í—Ö–æ–¥ |
| GET | `/api/user/auth` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ |

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Ç—Ä–µ–±—É–µ—Ç JWT)

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/cart` | –ö–æ—Ä–∑–∏–Ω–∞ |
| POST | `/api/cart` | –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É |
| DELETE | `/api/cart/:id` | –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã |
| GET | `/api/wishlist` | –ò–∑–±—Ä–∞–Ω–Ω–æ–µ |
| POST | `/api/order` | –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ |
| GET | `/api/order/my` | –ú–æ–∏ –∑–∞–∫–∞–∑—ã |

### –ê–¥–º–∏–Ω (—Ç—Ä–µ–±—É–µ—Ç JWT + —Ä–æ–ª—å ADMIN)

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/api/product` | –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä |
| PUT | `/api/product/:id` | –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä |
| DELETE | `/api/product/:id` | –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä |
| GET | `/api/order` | –í—Å–µ –∑–∞–∫–∞–∑—ã |
| PUT | `/api/order/:id` | –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ |

---

## üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ÆKassa

### –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ [–ÆKassa](https://yookassa.ru/)
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
3. –£–∫–∞–∂–∏—Ç–µ –≤ `.env`:

```env
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=test_xxxxxxxxxxxxxxxx
```

### –ë–æ–µ–≤–æ–π —Ä–µ–∂–∏–º

1. –ü—Ä–æ–π–¥–∏—Ç–µ –º–æ–¥–µ—Ä–∞—Ü–∏—é –≤ –ÆKassa
2. –ó–∞–º–µ–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á –Ω–∞ –±–æ–µ–≤–æ–π:

```env
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxxxxx
```

### Webhook –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç—ã

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:

```
URL: https://your-domain.com/api/yookassa/webhook
–ú–µ—Ç–æ–¥: POST
```

---

## üõ† –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose up -d --build

# –õ–æ–≥–∏
docker-compose logs -f backend
docker-compose logs -f frontend

# –ó–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î
docker exec -it mabon_db psql -U postgres -d mabon

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker-compose restart backend

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è volumes)
docker-compose down -v
```

---

## üêõ –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### CORS –æ—à–∏–±–∫–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ `CORS_ORIGINS` –≤ `.env` ‚Äî –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–º–µ–Ω —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.

### –ù–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–¥–º–∏–Ω

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `ADMIN_EMAIL` –∏ `ADMIN_PASSWORD` –∑–∞–¥–∞–Ω—ã –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.

### –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DB_HOST` (–¥–ª—è Docker: `db`, –ª–æ–∫–∞–ª—å–Ω–æ: `localhost`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç (`5432` –≤ Docker, –º–æ–∂–µ—Ç –±—ã—Ç—å `5435` –ª–æ–∫–∞–ª—å–Ω–æ)

### –ö–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ volume –¥–ª—è static —Ñ–∞–π–ª–æ–≤:

```yaml
volumes:
  - ./mabon-backend/static:/app/static
```

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
================================================================================
FILE: QMS-Server-master/static/defect-records/2/1769580241363_README.md
================================================================================

# MABON ‚Äî Luxury Porcelain & Sculpture

–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω –¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–æ–≥–æ —Ñ–∞—Ä—Ñ–æ—Ä–∞ –∏ —Å–∫—É–ª—å–ø—Ç—É—Ä. React + Node.js + PostgreSQL.

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Mabon_Luxury/
‚îú‚îÄ‚îÄ src/                    # Frontend (React + TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ components/         # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ pages/              # –°—Ç—Ä–∞–Ω–∏—Ü—ã
‚îÇ   ‚îú‚îÄ‚îÄ context/            # React –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ api/                # API –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ mabon-backend/          # Backend (Node.js + Express)
‚îÇ   ‚îú‚îÄ‚îÄ controllers/        # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ models/             # Sequelize –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ routes/             # –†–æ—É—Ç—ã API
‚îÇ   ‚îú‚îÄ‚îÄ middleware/         # JWT, —Ä–æ–ª–∏, –æ—à–∏–±–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ static/             # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ docker-compose.yml      # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ nginx.conf              # Nginx –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
‚îî‚îÄ‚îÄ Dockerfile              # Frontend —Å–±–æ—Ä–∫–∞
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker)

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫

```bash
git clone <repo-url>
cd Mabon_Luxury

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d --build
```

### 2. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ

- **–°–∞–π—Ç:** http://localhost:3001
- **API:** http://localhost:5000/api

### 3. –í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω

- **Email:** `admin@mabon.local`
- **–ü–∞—Ä–æ–ª—å:** `Mabon_Super_Secret_2025!`

---

## üíª –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–±–µ–∑ Docker)

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 20+
- PostgreSQL 15+
- npm –∏–ª–∏ yarn

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞—Ç—å –ë–î
psql -U postgres -c "CREATE DATABASE mabon;"
```

### 2. Backend

```bash
cd mabon-backend

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env (—Å–º. —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ)
cp .env.example .env
nano .env

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
npm run dev
```

Backend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:5000

### 3. Frontend

```bash
# –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
npm install

# –ó–∞–ø—É—Å—Ç–∏—Ç—å dev-—Å–µ—Ä–≤–µ—Ä
npm run dev
```

Frontend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:5173

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Backend: `mabon-backend/.env`

```env
# ===== –°–ï–†–í–ï–† =====
PORT=5000

# ===== –ë–ê–ó–ê –î–ê–ù–ù–´–• =====
DB_HOST=localhost          # –î–ª—è Docker: db
DB_PORT=5432               # –õ–æ–∫–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å 5435
DB_NAME=mabon
DB_USER=postgres
DB_PASSWORD=your_password  # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ =====
JWT_SECRET=your_jwt_secret_min_32_chars    # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï
SECRET_KEY=your_secret_key_min_32_chars    # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== CORS =====
CORS_ORIGINS=http://localhost:5173,http://localhost:3000

# ===== YOOKASSA (–û–ü–õ–ê–¢–ê) =====
YOOKASSA_SHOP_ID=123456                    # –í–∞—à Shop ID
YOOKASSA_SECRET_KEY=test_xxxxx             # –¢–µ—Å—Ç–æ–≤—ã–π –∏–ª–∏ –±–æ–µ–≤–æ–π –∫–ª—é—á

# ===== –ê–î–ú–ò–ù (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ) =====
ADMIN_EMAIL=admin@mabon.local
ADMIN_PASSWORD=Strong_Password_123!        # ‚ö†Ô∏è –ò–ó–ú–ï–ù–ò–¢–¨ –í –ü–†–û–î–ï

# ===== SEQUELIZE =====
DB_SYNC_ALTER=true         # true –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, false –¥–ª—è –ø—Ä–æ–¥–∞
```

### Frontend: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
VITE_API_BASE_URL=http://localhost:5000
```

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

```env
VITE_API_BASE_URL=https://api.your-domain.com
```

---

## üåê –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

### –í–∞—Ä–∏–∞–Ω—Ç 1: Docker Compose –Ω–∞ VPS

#### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker –∏ Docker Compose
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
```

#### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–π—Ç–µ `docker-compose.prod.yml`:

```yaml
services:
  db:
    image: postgres:15-alpine
    container_name: mabon_db
    restart: always
    environment:
      POSTGRES_USER: mabon_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # –ò–∑ .env
      POSTGRES_DB: mabon
    volumes:
      - postgres_data:/var/lib/postgresql/data

  backend:
    build: ./mabon-backend
    container_name: mabon_backend
    restart: always
    depends_on:
      - db
    environment:
      PORT: 5000
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: mabon
      DB_USER: mabon_user
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY: ${SECRET_KEY}
      CORS_ORIGINS: https://your-domain.com
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      DB_SYNC_ALTER: "false"
    volumes:
      - ./mabon-backend/static:/app/static

  frontend:
    build:
      context: .
      args:
        VITE_API_BASE_URL: https://your-domain.com
    container_name: mabon_frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"

volumes:
  postgres_data:
```

#### 3. –°–æ–∑–¥–∞–π—Ç–µ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```env
DB_PASSWORD=SuperSecurePassword123!
JWT_SECRET=your_very_long_jwt_secret_at_least_32_characters
SECRET_KEY=your_very_long_secret_key_at_least_32_characters
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxx
ADMIN_EMAIL=admin@your-domain.com
ADMIN_PASSWORD=AdminSecurePassword456!
```

#### 4. –ó–∞–ø—É—Å–∫

```bash
docker-compose -f docker-compose.prod.yml up -d --build
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

#### Backend –Ω–∞ VPS / Cloud Run / Railway

```bash
cd mabon-backend
npm install --production
npm start
```

#### Frontend –Ω–∞ Vercel / Netlify / Cloudflare Pages

```bash
npm run build
# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–ø–∫—É dist/
```

---

## üîê –ß—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|----------|--------|
| `DB_PASSWORD` | –ü–∞—Ä–æ–ª—å –ë–î | `Kj8#mNp$2qLx` |
| `JWT_SECRET` | –°–µ–∫—Ä–µ—Ç –¥–ª—è JWT —Ç–æ–∫–µ–Ω–æ–≤ (–º–∏–Ω. 32 —Å–∏–º–≤–æ–ª–∞) | `a1b2c3d4e5f6g7h8i9j0...` |
| `SECRET_KEY` | –û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á | `x9y8z7w6v5u4t3s2r1q0...` |
| `ADMIN_PASSWORD` | –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | `Admin$ecure2025!` |
| `YOOKASSA_SECRET_KEY` | –ë–æ–µ–≤–æ–π –∫–ª—é—á –ÆKassa | `live_xxxxxxxxxxxx` |
| `CORS_ORIGINS` | –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã | `https://mabon.ru` |

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–ª—é—á–µ–π

```bash
# JWT_SECRET –∏ SECRET_KEY
openssl rand -base64 32

# –ò–ª–∏ —á–µ—Ä–µ–∑ Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## üìù API Endpoints

### –ü—É–±–ª–∏—á–Ω—ã–µ

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/product` | –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ |
| GET | `/api/product/:id` | –¢–æ–≤–∞—Ä –ø–æ ID |
| GET | `/api/author` | –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤ |
| GET | `/api/author/:id` | –ê–≤—Ç–æ—Ä –ø–æ ID |
| GET | `/api/arttype` | –¢–∏–ø—ã –∏—Å–∫—É—Å—Å—Ç–≤–∞ |
| GET | `/api/review/product/:id` | –û—Ç–∑—ã–≤—ã —Ç–æ–≤–∞—Ä–∞ |

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/api/user/registration` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è |
| POST | `/api/user/login` | –í—Ö–æ–¥ |
| GET | `/api/user/auth` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ |

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Ç—Ä–µ–±—É–µ—Ç JWT)

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/cart` | –ö–æ—Ä–∑–∏–Ω–∞ |
| POST | `/api/cart` | –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É |
| DELETE | `/api/cart/:id` | –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã |
| GET | `/api/wishlist` | –ò–∑–±—Ä–∞–Ω–Ω–æ–µ |
| POST | `/api/order` | –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ |
| GET | `/api/order/my` | –ú–æ–∏ –∑–∞–∫–∞–∑—ã |

### –ê–¥–º–∏–Ω (—Ç—Ä–µ–±—É–µ—Ç JWT + —Ä–æ–ª—å ADMIN)

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/api/product` | –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä |
| PUT | `/api/product/:id` | –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä |
| DELETE | `/api/product/:id` | –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä |
| GET | `/api/order` | –í—Å–µ –∑–∞–∫–∞–∑—ã |
| PUT | `/api/order/:id` | –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ |

---

## üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ÆKassa

### –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ [–ÆKassa](https://yookassa.ru/)
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
3. –£–∫–∞–∂–∏—Ç–µ –≤ `.env`:

```env
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=test_xxxxxxxxxxxxxxxx
```

### –ë–æ–µ–≤–æ–π —Ä–µ–∂–∏–º

1. –ü—Ä–æ–π–¥–∏—Ç–µ –º–æ–¥–µ—Ä–∞—Ü–∏—é –≤ –ÆKassa
2. –ó–∞–º–µ–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á –Ω–∞ –±–æ–µ–≤–æ–π:

```env
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxxxxx
```

### Webhook –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç—ã

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:

```
URL: https://your-domain.com/api/yookassa/webhook
–ú–µ—Ç–æ–¥: POST
```

---

## üõ† –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose up -d --build

# –õ–æ–≥–∏
docker-compose logs -f backend
docker-compose logs -f frontend

# –ó–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î
docker exec -it mabon_db psql -U postgres -d mabon

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker-compose restart backend

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è volumes)
docker-compose down -v
```

---

## üêõ –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### CORS –æ—à–∏–±–∫–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ `CORS_ORIGINS` –≤ `.env` ‚Äî –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–º–µ–Ω —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.

### –ù–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–¥–º–∏–Ω

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `ADMIN_EMAIL` –∏ `ADMIN_PASSWORD` –∑–∞–¥–∞–Ω—ã –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.

### –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DB_HOST` (–¥–ª—è Docker: `db`, –ª–æ–∫–∞–ª—å–Ω–æ: `localhost`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç (`5432` –≤ Docker, –º–æ–∂–µ—Ç –±—ã—Ç—å `5435` –ª–æ–∫–∞–ª—å–Ω–æ)

### –ö–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ volume –¥–ª—è static —Ñ–∞–π–ª–æ–≤:

```yaml
volumes:
  - ./mabon-backend/static:/app/static
```

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
================================================================================
FILE: QMS-Server-master/tests/controllers/box.test.js
================================================================================

const BoxController = require('../../controllers/warehouse/BoxController');
const { WarehouseBox } = require('../../models/index');
const { logAudit } = require('../../utils/auditLogger');

jest.mock('../../models/index');
jest.mock('../../utils/auditLogger');

describe('BoxController - createBoxesBatch', () => {
    let req, res, next;

    beforeEach(() => {
        req = {
            body: {
                label: 'Test Item',
                quantity: 10,
                itemsPerBox: 5,
                unit: '—à—Ç'
            },
            user: { id: 1 }
        };
        res = { json: jest.fn() };
        next = jest.fn();
        jest.clearAllMocks();
    });

    test('–î–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—é –∫–æ—Ä–æ–±–æ–∫ (Bulk Create)', async () => {
        WarehouseBox.bulkCreate.mockResolvedValue([
            { id: 1, label: 'Test Item' },
            { id: 2, label: 'Test Item' }
        ]);

        await BoxController.createBoxesBatch(req, res, next);

        expect(WarehouseBox.bulkCreate).toHaveBeenCalled();

        const callArgs = WarehouseBox.bulkCreate.mock.calls[0][0];
        expect(callArgs).toHaveLength(10);
        expect(callArgs[0]).toMatchObject({
            label: 'Test Item',
            quantity: 5,
            acceptedById: 1
        });

        expect(logAudit).toHaveBeenCalledWith(expect.objectContaining({
            action: 'WAREHOUSE_BATCH'
        }));

        expect(res.json).toHaveBeenCalled();
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ > 1000', async () => {
        req.body.quantity = 1001;

        await BoxController.createBoxesBatch(req, res, next);

        expect(next).toHaveBeenCalled();


        const error = next.mock.calls[0][0];


        expect(error.status).toBe(400);
        expect(error.message).toContain('–æ—Ç 1 –¥–æ 1000');
    });
});

================================================================================
FILE: QMS-Server-master/tests/controllers/movement.test.js
================================================================================

const MovementController = require('../../controllers/warehouse/MovementController');
const { WarehouseBox, WarehouseMovement } = require('../../models/index');


jest.mock('../../db', () => {
    return {
        transaction: jest.fn(async () => ({
            commit: jest.fn(),
            rollback: jest.fn()
        })),
        define: jest.fn(() => ({
            belongsTo: jest.fn(),
            hasMany: jest.fn(),
            hasOne: jest.fn(),
            belongsToMany: jest.fn()
        })),
        fn: jest.fn(),
        col: jest.fn(),
        authenticate: jest.fn(),
        sync: jest.fn()
    };
});


jest.mock('../../models/index', () => ({
    WarehouseBox: {
        findByPk: jest.fn()
    },
    WarehouseMovement: {
        create: jest.fn()
    },
    WarehouseDocument: {
        create: jest.fn()
    },
    Section: {},
    Team: {},
    User: {},
    Supply: {}
}));

jest.mock('../../utils/auditLogger', () => ({
    logAudit: jest.fn()
}));

describe('MovementController - moveSingle', () => {
    let req, res, next;

    beforeEach(() => {
        req = {
            body: {
                boxId: 1,
                operation: 'MOVE',
                toSectionId: 5,
                deltaQty: 0
            },
            user: { id: 1 }
        };
        res = {
            json: jest.fn(),
            status: jest.fn().mockReturnThis()
        };
        next = jest.fn();
        jest.clearAllMocks();
    });

    test('–î–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–æ—Ä–æ–±–∫—É –Ω–∞ –¥—Ä—É–≥–æ–π —É—á–∞—Å—Ç–æ–∫', async () => {

        const mockBox = {
            id: 1,
            currentSectionId: 1,
            quantity: 10,
            status: 'ON_STOCK',
            save: jest.fn().mockResolvedValue(true)
        };


        WarehouseBox.findByPk.mockResolvedValue(mockBox);

        WarehouseMovement.create.mockResolvedValue({ id: 100 });

        await MovementController.moveSingle(req, res, next);


        expect(mockBox.currentSectionId).toBe(5);

        expect(mockBox.save).toHaveBeenCalled();

        expect(WarehouseMovement.create).toHaveBeenCalledWith(
            expect.objectContaining({
                boxId: 1,
                toSectionId: 5,
                operation: 'MOVE'
            }),
            expect.any(Object)
        );
        expect(res.json).toHaveBeenCalled();
    });

    test('–î–æ–ª–∂–µ–Ω –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∏—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º', async () => {
        req.body.operation = 'CONSUME';
        req.body.deltaQty = -50;

        const mockBox = {
            id: 1,
            quantity: 10,
            save: jest.fn()
        };
        WarehouseBox.findByPk.mockResolvedValue(mockBox);

        await MovementController.moveSingle(req, res, next);


        expect(mockBox.save).not.toHaveBeenCalled();

        expect(next).toHaveBeenCalled();

        const error = next.mock.calls[0][0];
        expect(error.message).toContain('–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 404, –µ—Å–ª–∏ –∫–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', async () => {
        WarehouseBox.findByPk.mockResolvedValue(null);

        await MovementController.moveSingle(req, res, next);

        expect(next).toHaveBeenCalled();
        const error = next.mock.calls[0][0];
        expect(error.status).toBe(404);
        expect(error.message).toBe('–ö–æ—Ä–æ–±–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    });
});

================================================================================
FILE: QMS-Server-master/tests/controllers/supply.test.js
================================================================================

const request = require('supertest');
const express = require('express');
const bodyParser = require('body-parser');
const SupplyController = require('../../controllers/warehouse/SupplyController');
const { Supply } = require('../../models/index');


jest.mock('../../models/index');
jest.mock('../../utils/auditLogger', () => ({
    logAudit: jest.fn()
}));

const app = express();
app.use(bodyParser.json());

app.use((req, res, next) => {
    req.user = { id: 1, role: 'WAREHOUSE_MASTER' };
    next();
});
app.post('/api/warehouse/supplies', SupplyController.createSupply);

describe('SupplyController Integration', () => {
    test('POST /supplies - –î–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É', async () => {
        const mockSupply = { id: 1, docNumber: 'TEST-123', status: 'NEW' };


        Supply.create.mockResolvedValue(mockSupply);

        const res = await request(app)
            .post('/api/warehouse/supplies')
            .send({
                docNumber: 'TEST-123',
                supplier: 'OOO Test',
                comment: 'Test supply'
            });

        expect(res.status).toBe(200);
        expect(res.body.docNumber).toBe('TEST-123');
        expect(Supply.create).toHaveBeenCalled();
    });
});

================================================================================
FILE: QMS-Server-master/tests/middleware/checkAbility.test.js
================================================================================

const checkAbility = require('../../middleware/checkAbilityMiddleware');
const ApiError = require('../../error/ApiError');

describe('checkAbilityMiddleware', () => {
    let mockReq, mockRes, mockNext;

    beforeEach(() => {
        mockReq = { method: 'GET', user: {} };
        mockRes = {};
        mockNext = jest.fn();
    });

    test('–î–æ–ª–∂–µ–Ω –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å SUPER_ADMIN –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤', () => {
        mockReq.user = { role: 'SUPER_ADMIN', abilities: [] };
        const middleware = checkAbility('warehouse.view');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledTimes(1);
        expect(mockNext).toHaveBeenCalledWith();
    });

    test('–î–æ–ª–∂–µ–Ω –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω—É–∂–Ω—ã–º –ø—Ä–∞–≤–æ–º', () => {
        mockReq.user = { role: 'USER', abilities: ['warehouse.view', 'other.ability'] };
        const middleware = checkAbility('warehouse.view');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledWith();
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É 403 (Forbidden), –µ—Å–ª–∏ –ø—Ä–∞–≤–∞ –Ω–µ—Ç', () => {
        mockReq.user = { role: 'USER', abilities: ['other.ability'] };
        const middleware = checkAbility('warehouse.view');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledTimes(1);
        const errorArg = mockNext.mock.calls[0][0];
        expect(errorArg).toBeInstanceOf(ApiError);
        expect(errorArg.status).toBe(403);
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É 401, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç (–Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω)', () => {
        mockReq.user = null;
        const middleware = checkAbility('any.right');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledTimes(1);
        expect(mockNext.mock.calls[0][0].status).toBe(401);
    });
});

================================================================================
FILE: QMS-Server-master/tests/middleware/syncUser.test.js
================================================================================

const syncUserMiddleware = require('../../middleware/syncUserMiddleware');
const { User, Role } = require('../../models/index');


jest.mock('../../models/index', () => ({
    User: {
        findOne: jest.fn(),
        create: jest.fn(),
        update: jest.fn()
    },
    Role: {
        findOne: jest.fn()
    },
    Ability: {}
}));

describe('syncUserMiddleware', () => {
    let req, res, next;

    beforeEach(() => {
        req = {
            auth: {
                payload: {
                    sub: 'keycloak-uuid-123',
                    preferred_username: 'testuser',
                    given_name: 'Ivan',
                    family_name: 'Ivanov',
                    realm_access: { roles: ['WAREHOUSE_MASTER'] }
                }
            }
        };
        res = { status: jest.fn().mockReturnThis(), json: jest.fn() };
        next = jest.fn();
        jest.clearAllMocks();
    });

    test('–î–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç', async () => {

        User.findOne.mockResolvedValue(null);


        const createdUser = {
            id: 10,
            login: 'testuser',
            role: 'WAREHOUSE_MASTER',
            save: jest.fn()
        };
        User.create.mockResolvedValue(createdUser);


        Role.findOne.mockResolvedValue({ abilities: [{ code: 'warehouse.view' }] });

        await syncUserMiddleware(req, res, next);


        expect(User.create).toHaveBeenCalledWith(expect.objectContaining({
            login: 'testuser',
            role: 'WAREHOUSE_MASTER'
        }));
        expect(req.user).toBeDefined();
        expect(req.user.id).toBe(10);
        expect(req.user.abilities).toContain('warehouse.view');
        expect(next).toHaveBeenCalled();
    });

    test('–î–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', async () => {

        const mockSave = jest.fn();
        const existingUser = {
            id: 20,
            login: 'testuser',
            role: 'ASSEMBLER',
            save: mockSave
        };


        User.findOne.mockResolvedValue(existingUser);
        Role.findOne.mockResolvedValue({ abilities: [] });

        await syncUserMiddleware(req, res, next);


        expect(existingUser.role).toBe('WAREHOUSE_MASTER');

        expect(mockSave).toHaveBeenCalled();
        expect(next).toHaveBeenCalled();
    });

    test('–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 500 –ø—Ä–∏ –æ—à–∏–±–∫–µ –ë–î', async () => {
        User.findOne.mockRejectedValue(new Error('DB Connection failed'));

        await syncUserMiddleware(req, res, next);

        expect(res.status).toHaveBeenCalledWith(500);
        expect(next).not.toHaveBeenCalled();
    });
});

================================================================================
FILE: QMS-Server-master/utils/auditLogger.js
================================================================================



const { AuditLog } = require("../models/index");


const AUDIT_ACTIONS = {

  SESSION_START: "SESSION_START",
  SESSION_END: "SESSION_END",
  SESSION_DELETE: "SESSION_DELETE",
  SESSION_AUTO_OFF: "SESSION_AUTO_OFF",
  SESSION_FORCE_OFF: "SESSION_FORCE_OFF",


  SERVER_CREATE: "SERVER_CREATE",
  SERVER_UPDATE: "SERVER_UPDATE",
  SERVER_DELETE: "SERVER_DELETE",
  SERVER_STATUS_CHANGE: "SERVER_STATUS_CHANGE",
  SERVER_DHCP_SYNC: "SERVER_DHCP_SYNC",
  SERVER_BMC_SYNC: "SERVER_BMC_SYNC",
  SERVER_ARCHIVE: "SERVER_ARCHIVE",
  SERVER_RESTORE: "SERVER_RESTORE",


  BATCH_CREATE: "BATCH_CREATE",
  BATCH_UPDATE: "BATCH_UPDATE",
  BATCH_DELETE: "BATCH_DELETE",
  BATCH_CLOSE: "BATCH_CLOSE",


  RACK_CREATE: "RACK_CREATE",
  RACK_UPDATE: "RACK_UPDATE",
  RACK_DELETE: "RACK_DELETE",
  RACK_SERVER_ADD: "RACK_SERVER_ADD",
  RACK_SERVER_REMOVE: "RACK_SERVER_REMOVE",


  CLUSTER_CREATE: "CLUSTER_CREATE",
  CLUSTER_UPDATE: "CLUSTER_UPDATE",
  CLUSTER_DELETE: "CLUSTER_DELETE",
  CLUSTER_SHIP: "CLUSTER_SHIP",


  DEFECT_CREATE: "DEFECT_CREATE",
  DEFECT_UPDATE: "DEFECT_UPDATE",
  DEFECT_RESOLVE: "DEFECT_RESOLVE",
  DEFECT_CLOSE: "DEFECT_CLOSE",
  DEFECT_REOPEN: "DEFECT_REOPEN",
  DEFECT_FILE_UPLOAD: "DEFECT_FILE_UPLOAD",
  DEFECT_FILE_DELETE: "DEFECT_FILE_DELETE",


  REPAIR_ACTION_ADD: "REPAIR_ACTION_ADD",
  REPAIR_ACTION_UPDATE: "REPAIR_ACTION_UPDATE",
  REPAIR_ACTION_DELETE: "REPAIR_ACTION_DELETE",


  YADRO_TICKET_CREATE: "YADRO_TICKET_CREATE",
  YADRO_TICKET_UPDATE: "YADRO_TICKET_UPDATE",
  YADRO_TICKET_RECEIVE: "YADRO_TICKET_RECEIVE",
  YADRO_TICKET_CLOSE: "YADRO_TICKET_CLOSE",


  WAREHOUSE_MOVE: "WAREHOUSE_MOVE",
  WAREHOUSE_MOVE_BATCH: "WAREHOUSE_MOVE_BATCH",
  BOX_CREATE: "BOX_CREATE",
  BOX_UPDATE: "BOX_UPDATE",
  BOX_DELETE: "BOX_DELETE",
  BOX_SPLIT: "BOX_SPLIT",
  BOX_MERGE: "BOX_MERGE",
  SUPPLY_CREATE: "SUPPLY_CREATE",
  SUPPLY_UPDATE: "SUPPLY_UPDATE",
  SUPPLY_RECEIVE: "SUPPLY_RECEIVE",


  COMPONENT_CREATE: "COMPONENT_CREATE",
  COMPONENT_UPDATE: "COMPONENT_UPDATE",
  COMPONENT_DELETE: "COMPONENT_DELETE",
  COMPONENT_SYNC: "COMPONENT_SYNC",
  COMPONENT_REPLACE: "COMPONENT_REPLACE",
  COMPONENT_TRANSFER: "COMPONENT_TRANSFER",
  COMPONENT_BATCH_ADD: "COMPONENT_BATCH_ADD",


  PRODUCTION_ENTRY_CREATE: "PRODUCTION_ENTRY_CREATE",
  PRODUCTION_ENTRY_UPDATE: "PRODUCTION_ENTRY_UPDATE",
  PRODUCTION_ENTRY_APPROVE: "PRODUCTION_ENTRY_APPROVE",
  PRODUCTION_ENTRY_REJECT: "PRODUCTION_ENTRY_REJECT",
  PRODUCTION_ENTRY_DELETE: "PRODUCTION_ENTRY_DELETE",
  PRODUCT_ASSEMBLE: "PRODUCT_ASSEMBLE",
  PRODUCT_QC_PASS: "PRODUCT_QC_PASS",
  PRODUCT_QC_FAIL: "PRODUCT_QC_FAIL",


  SECTION_CREATE: "SECTION_CREATE",
  SECTION_UPDATE: "SECTION_UPDATE",
  SECTION_DELETE: "SECTION_DELETE",
  TEAM_CREATE: "TEAM_CREATE",
  TEAM_UPDATE: "TEAM_UPDATE",
  TEAM_DELETE: "TEAM_DELETE",


  ROLE_CREATE: "ROLE_CREATE",
  ROLE_UPDATE: "ROLE_UPDATE",
  ROLE_DELETE: "ROLE_DELETE",
  ABILITY_CREATE: "ABILITY_CREATE",
  ABILITY_DELETE: "ABILITY_DELETE",
  ROLE_ABILITY_GRANT: "ROLE_ABILITY_GRANT",
  ROLE_ABILITY_REVOKE: "ROLE_ABILITY_REVOKE",


  USER_CREATE: "USER_CREATE",
  USER_UPDATE: "USER_UPDATE",
  USER_DELETE: "USER_DELETE",
  USER_ROLE_CHANGE: "USER_ROLE_CHANGE",


  EXPORT_PASSPORT: "EXPORT_PASSPORT",
  EXPORT_DEFECTS: "EXPORT_DEFECTS",
  EXPORT_REPORT: "EXPORT_REPORT",


  SETTINGS_UPDATE: "SETTINGS_UPDATE",
  SYSTEM_EVENT: "SYSTEM_EVENT",
};


const AUDIT_ENTITIES = {
  SESSION: "SESSION",


  BERYLL_SERVER: "BeryllServer",
  BERYLL_BATCH: "BeryllBatch",
  BERYLL_RACK: "BeryllRack",
  BERYLL_CLUSTER: "BeryllCluster",
  BERYLL_SHIPMENT: "BeryllShipment",


  BERYLL_DEFECT: "BeryllDefectRecord",
  BOARD_DEFECT: "BoardDefect",
  REPAIR_ACTION: "RepairAction",
  REPAIR_HISTORY: "RepairHistory",
  DEFECT_CATEGORY: "DefectCategory",
  YADRO_TICKET: "YadroTicketLog",


  WAREHOUSE_MOVEMENT: "WarehouseMovement",
  INVENTORY_BOX: "InventoryBox",
  SUPPLY: "Supply",
  WAREHOUSE_DOCUMENT: "WarehouseDocument",


  COMPONENT_INVENTORY: "ComponentInventory",
  COMPONENT_HISTORY: "ComponentHistory",
  COMPONENT_CATALOG: "ComponentCatalog",


  PRODUCTION_ENTRY: "ProductionEntry",
  PRODUCTION_OUTPUT: "ProductionOutput",
  ASSEMBLED_PRODUCT: "AssembledProduct",


  SECTION: "Section",
  TEAM: "Team",


  ROLE: "Role",
  ABILITY: "Ability",
  ROLE_ABILITY: "RoleAbility",


  USER: "User",
};


async function logAudit({
  req,
  userId,
  action,
  entity,
  entityId,
  description,
  metadata,
}) {
  if (!action) {
    console.warn("[AuditLogger] –ü–æ–ø—ã—Ç–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è action");
    return;
  }

  try {

    let finalUserId = null;
    if (req && req.user && req.user.id) {
      finalUserId = req.user.id;
    } else if (userId) {
      finalUserId = userId;
    }


    let meta = metadata || {};
    if (req) {
      const ipHeader = req.headers["x-forwarded-for"];
      const ip =
        (typeof ipHeader === "string" ? ipHeader.split(",")[0] : null) ||
        req.connection?.remoteAddress ||
        req.ip ||
        null;

      meta = {
        ...meta,
        ip,
        userAgent: req.headers["user-agent"] || null,
      };
    }


    await AuditLog.create({
      userId: finalUserId,
      action,
      entity: entity || null,
      entityId: entityId === undefined || entityId === null ? null : String(entityId),
      description: description || null,
      metadata: Object.keys(meta).length > 0 ? meta : null,
    });
  } catch (error) {
    console.error("[AuditLogger] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞:", error);

  }
}


async function logServerCreate(req, server, metadata = {}) {
  await logAudit({
    req,
    action: AUDIT_ACTIONS.SERVER_CREATE,
    entity: AUDIT_ENTITIES.BERYLL_SERVER,
    entityId: server.id,
    description: `–°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–µ—Ä ${server.apkSerialNumber || server.hostname || 'N/A'}`,
    metadata: {
      serverSerial: server.apkSerialNumber,
      hostname: server.hostname,
      batchId: server.batchId,
      ...metadata,
    },
  });
}


async function logServerStatusChange(req, server, oldStatus, newStatus, metadata = {}) {
  await logAudit({
    req,
    action: AUDIT_ACTIONS.SERVER_STATUS_CHANGE,
    entity: AUDIT_ENTITIES.BERYLL_SERVER,
    entityId: server.id,
    description: `–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ ${server.apkSerialNumber || 'N/A'}: ${oldStatus} ‚Üí ${newStatus}`,
    metadata: {
      serverSerial: server.apkSerialNumber,
      oldStatus,
      newStatus,
      ...metadata,
    },
  });
}


async function logDefectCreate(req, defect, server, metadata = {}) {
  await logAudit({
    req,
    action: AUDIT_ACTIONS.DEFECT_CREATE,
    entity: AUDIT_ENTITIES.BERYLL_DEFECT,
    entityId: defect.id,
    description: `–°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ ${server?.apkSerialNumber || 'N/A'}`,
    metadata: {
      serverSerial: server?.apkSerialNumber,
      serverId: server?.id,
      problemDescription: defect.problemDescription?.substring(0, 100),
      ...metadata,
    },
  });
}


async function logDefectResolve(req, defect, resolution, metadata = {}) {
  await logAudit({
    req,
    action: AUDIT_ACTIONS.DEFECT_RESOLVE,
    entity: AUDIT_ENTITIES.BERYLL_DEFECT,
    entityId: defect.id,
    description: `–î–µ—Ñ–µ–∫—Ç #${defect.id} –∑–∞–∫—Ä—ã—Ç: ${resolution}`,
    metadata: {
      resolution,
      ...metadata,
    },
  });
}


async function logWarehouseMove(req, movement, metadata = {}) {
  await logAudit({
    req,
    action: AUDIT_ACTIONS.WAREHOUSE_MOVE,
    entity: AUDIT_ENTITIES.WAREHOUSE_MOVEMENT,
    entityId: movement.id,
    description: `–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ: ${movement.operation}, –∫–æ–ª-–≤–æ: ${movement.deltaQty || 0}`,
    metadata: {
      boxId: movement.boxId,
      operation: movement.operation,
      fromSectionId: movement.fromSectionId,
      toSectionId: movement.toSectionId,
      deltaQty: movement.deltaQty,
      ...metadata,
    },
  });
}


async function logComponentSync(req, serverId, result, metadata = {}) {
  await logAudit({
    req,
    action: AUDIT_ACTIONS.COMPONENT_SYNC,
    entity: AUDIT_ENTITIES.COMPONENT_INVENTORY,
    entityId: serverId,
    description: `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞ #${serverId}`,
    metadata: {
      serverId,
      mode: result.mode,
      added: result.actions?.added?.length || 0,
      updated: result.actions?.updated?.length || 0,
      preserved: result.actions?.preserved?.length || 0,
      ...metadata,
    },
  });
}


async function logProductionEntry(req, entry, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.PRODUCTION_ENTRY_CREATE,
    approve: AUDIT_ACTIONS.PRODUCTION_ENTRY_APPROVE,
    reject: AUDIT_ACTIONS.PRODUCTION_ENTRY_REJECT,
    update: AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    delete: AUDIT_ACTIONS.PRODUCTION_ENTRY_DELETE,
  };

  await logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    entity: AUDIT_ENTITIES.PRODUCTION_ENTRY,
    entityId: entry.id,
    description: `–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å #${entry.id}: ${action}`,
    metadata: {
      entryId: entry.id,
      quantity: entry.quantity,
      productId: entry.productId,
      ...metadata,
    },
  });
}


async function logExport(req, exportType, description, metadata = {}) {
  await logAudit({
    req,
    action: AUDIT_ACTIONS.EXPORT_REPORT,
    entity: null,
    entityId: null,
    description: description || `–≠–∫—Å–ø–æ—Ä—Ç: ${exportType}`,
    metadata: {
      exportType,
      ...metadata,
    },
  });
}

module.exports = {
  logAudit,
  AUDIT_ACTIONS,
  AUDIT_ENTITIES,

  logServerCreate,
  logServerStatusChange,
  logDefectCreate,
  logDefectResolve,
  logWarehouseMove,
  logComponentSync,
  logProductionEntry,
  logExport,
};

================================================================================
FILE: dump_project_full.py
================================================================================

#!/usr/bin/env python3



from __future__ import annotations 

import io 
import os 
import tokenize 
from pathlib import Path 



PROJECT_DIR =Path .cwd ().resolve ()

DUMP_BASENAME_PREFIX ="project_dump_core"
DUMP_EXTENSION =".txt"



STRIP_COMMENTS_IN_DUMP =True 

KEEP_PY_DOCSTRINGS =False 


def get_next_output_file (project_dir :Path )->Path :

    base_file =project_dir /f"{DUMP_BASENAME_PREFIX}{DUMP_EXTENSION}"
    if not base_file .exists ():
        return base_file 

    max_version =1 

    for p in project_dir .glob (f"{DUMP_BASENAME_PREFIX}_*{DUMP_EXTENSION}"):
        stem =p .stem 
        parts =stem .split ("_")
        if not parts :
            continue 
        last =parts [-1 ]
        try :
            num =int (last )
        except ValueError :
            continue 
        if num >max_version :
            max_version =num 

    next_version =max_version +1 
    return project_dir /f"{DUMP_BASENAME_PREFIX}_{next_version}{DUMP_EXTENSION}"



ALLOWED_ROOT_FILES ={
"README.md",
"index.html",
"package.json",
"eslint.config.js",
"vite.config.ts",
"tsconfig.json",
"tsconfig.app.json",
"tsconfig.node.json",
}


ALLOWED_EXT ={

".ts",".tsx",".js",".jsx",".css",".md",".json",".jsonc",".html",

".yml",".yaml",

".sh",

".py",

".tf",".tfvars",

".cfg",".lock",
}


EXCLUDED_DIRS ={

".git",".idea",".vscode",


"node_modules","dist","build",".next",".nuxt",
"coverage",".turbo",".cache",


".venv","venv","env",".env",
"__pycache__",
"Lib","site-packages","Scripts",
".pytest_cache",".mypy_cache",
".tox",".eggs",


".terraform",
}


EXCLUDED_FILES :set [str ]={
"package-lock.json",
}


EXCLUDED_EXT ={
".map",".svg",".png",".jpg",".jpeg",".gif",".ico",".webp",
".bmp",".pdf",".mp4",".mp3",".wav",
".woff",".woff2",".ttf",".eot",
".pyc",".pyo",".pyd",".whl",
}


UNWANTED_RELATIVE_PATHS ={
"MES-Kryptonit-Client-main/package-lock.json",
"MES-Kryptonit-Server-master/package-lock.json",
"MES-Kryptonit-Client-main/README.md",
"MES-Kryptonit-Client-main/src/components/Test/Test.tsx",
}


MAX_FILE_SIZE_BYTES =400_000 
MAX_LINES_PER_FILE =2000 


def is_excluded_dir (name :str )->bool :
    return name in EXCLUDED_DIRS or name .endswith (".egg-info")


def should_keep_root_file (p :Path )->bool :
    return p .name in ALLOWED_ROOT_FILES 


def is_dump_file (path :Path )->bool :

    return (
    path .suffix ==DUMP_EXTENSION 
    and path .stem .startswith (DUMP_BASENAME_PREFIX )
    )


def should_keep (path :Path )->bool :

    if is_dump_file (path ):
        return False 

    try :
        rel =path .relative_to (PROJECT_DIR ).as_posix ()
    except ValueError :
        rel =path .as_posix ()

    if rel in UNWANTED_RELATIVE_PATHS :
        return False 

    if any (part in EXCLUDED_DIRS for part in path .parts ):
        return False 

    if path .name in EXCLUDED_FILES :
        return False 

    if path .suffix .lower ()in EXCLUDED_EXT :
        return False 

    if path .parent ==PROJECT_DIR and should_keep_root_file (path ):
        return True 

    if path .suffix .lower ()in ALLOWED_EXT :
        return True 

    return False 


def gather_files ()->list [Path ]:
    files :list [Path ]=[]
    for root ,dirs ,filenames in os .walk (PROJECT_DIR ):
        dirs [:]=[d for d in dirs if not is_excluded_dir (d )]
        for fn in filenames :
            p =Path (root )/fn 
            if not p .is_file ():
                continue 
            if should_keep (p ):
                files .append (p )
    return sorted (files ,key =lambda x :x .relative_to (PROJECT_DIR ).as_posix ())






def _strip_html_comments (text :str )->str :

    out :list [str ]=[]
    i =0 
    n =len (text )
    while i <n :
        if text .startswith ("<!--",i ):
            j =text .find ("-->",i +4 )
            if j ==-1 :
                out .extend ("\n"for ch in text [i :]if ch =="\n")
                break 
            seg =text [i :j +3 ]
            out .extend ("\n"for ch in seg if ch =="\n")
            i =j +3 
        else :
            out .append (text [i ])
            i +=1 
    return "".join (out )


def _strip_hash_line_comments (text :str ,*,keep_shebang :bool =True )->str :

    out_lines :list [str ]=[]
    lines =text .splitlines (keepends =True )

    for idx ,line in enumerate (lines ):
        if keep_shebang and idx ==0 and line .startswith ("#!"):
            out_lines .append (line )
            continue 

        in_s =False 
        in_d =False 
        i =0 
        while i <len (line ):
            ch =line [i ]
            if ch =="'"and not in_d :
                in_s =not in_s 
                i +=1 
                continue 
            if ch =='"'and not in_s :
                in_d =not in_d 
                i +=1 
                continue 
            if ch =="#"and not in_s and not in_d :

                if i ==0 or line [i -1 ].isspace ():
                    nl ="\n"if line .endswith ("\n")else ""
                    out_lines .append (line [:i ].rstrip ()+nl )
                    break 
            i +=1 
        else :
            out_lines .append (line )

    return "".join (out_lines )


def _strip_c_like_comments (text :str )->str :

    CODE ,SQ ,DQ ,BT ,LINE ,BLOCK =range (6 )
    state =CODE 
    out :list [str ]=[]
    i =0 
    n =len (text )
    esc =False 

    while i <n :
        ch =text [i ]
        nxt =text [i +1 ]if i +1 <n else ""

        if state ==CODE :
            if ch =="/"and nxt =="/":
                state =LINE 
                i +=2 
                continue 
            if ch =="/"and nxt =="*":
                state =BLOCK 
                i +=2 
                continue 
            if ch =="'":
                state =SQ 
                out .append (ch )
                esc =False 
                i +=1 
                continue 
            if ch =='"':
                state =DQ 
                out .append (ch )
                esc =False 
                i +=1 
                continue 
            if ch =="`":
                state =BT 
                out .append (ch )
                esc =False 
                i +=1 
                continue 

            out .append (ch )
            i +=1 
            continue 

        if state ==LINE :
            if ch =="\n":
                out .append ("\n")
                state =CODE 
            i +=1 
            continue 

        if state ==BLOCK :
            if ch =="\n":
                out .append ("\n")
                i +=1 
                continue 
            if ch =="*"and nxt =="/":
                state =CODE 
                i +=2 
                continue 
            i +=1 
            continue 


        out .append (ch )
        if esc :
            esc =False 
        else :
            if ch =="\\":
                esc =True 
            else :
                if state ==SQ and ch =="'":
                    state =CODE 
                elif state ==DQ and ch =='"':
                    state =CODE 
                elif state ==BT and ch =="`":
                    state =CODE 
        i +=1 

    return "".join (out )


def _strip_python (text :str ,*,keep_docstrings :bool )->str :

    shebang =""
    rest =text 
    if text .startswith ("#!"):
        first ,_ ,remainder =text .partition ("\n")
        shebang =first +"\n"
        rest =remainder 

    try :
        tokgen =tokenize .generate_tokens (io .StringIO (rest ).readline )
    except Exception :
        return shebang +_strip_hash_line_comments (rest ,keep_shebang =False )

    out_tokens :list [tuple [int ,str ]]=[]
    prev_type =tokenize .INDENT 
    at_block_start =True 

    for tok in tokgen :
        ttype =tok .type 
        tstr =tok .string 

        if ttype ==tokenize .COMMENT :
            continue 

        if (not keep_docstrings )and ttype ==tokenize .STRING and at_block_start and prev_type in (
        tokenize .INDENT ,tokenize .NEWLINE ,tokenize .NL ,tokenize .DEDENT ,tokenize .ENCODING 
        ):

            prev_type =ttype 
            at_block_start =False 
            continue 

        out_tokens .append ((ttype ,tstr ))

        if ttype ==tokenize .INDENT :
            at_block_start =True 
        elif ttype not in (tokenize .NL ,tokenize .NEWLINE ,tokenize .ENDMARKER ,tokenize .ENCODING ):
            at_block_start =False 

        prev_type =ttype 

    return shebang +tokenize .untokenize (out_tokens )


def strip_comments_for_file (path :Path ,content :str )->str :
    if not STRIP_COMMENTS_IN_DUMP :
        return content 

    ext =path .suffix .lower ()

    if ext ==".py":
        return _strip_python (content ,keep_docstrings =KEEP_PY_DOCSTRINGS )

    if ext in {".html",".htm",".md"}:
        return _strip_html_comments (content )

    if ext in {".yml",".yaml",".sh"}:
        return _strip_hash_line_comments (content ,keep_shebang =True )

    if ext in {".tf",".tfvars"}:
        content =_strip_c_like_comments (content )
        content =_strip_hash_line_comments (content ,keep_shebang =False )
        return content 

    if ext in {".ts",".tsx",".js",".jsx",".css",".json",".jsonc",".cfg",".lock"}:
        return _strip_c_like_comments (content )

    return content 


def read_file_safely (p :Path )->tuple [str ,bool ]:

    truncated =False 
    try :
        size =p .stat ().st_size 
        if size >MAX_FILE_SIZE_BYTES :
            return (
            f"[–ü—Ä–æ–ø—É—â–µ–Ω–æ: —Ñ–∞–π–ª {size} –±–∞–π—Ç –±–æ–ª—å—à–µ –ª–∏–º–∏—Ç–∞ {MAX_FILE_SIZE_BYTES}]\n",
            True ,
            )

        with p .open ("r",encoding ="utf-8",errors ="replace")as f :
            lines =f .readlines ()

        if len (lines )>MAX_LINES_PER_FILE :
            truncated =True 
            lines =lines [:MAX_LINES_PER_FILE ]
            lines .append (f"\n[... –æ–±—Ä–µ–∑–∞–Ω–æ –¥–æ {MAX_LINES_PER_FILE} —Å—Ç—Ä–æ–∫ ...]\n")

        content ="".join (lines )


        content =strip_comments_for_file (p ,content )

        return content ,truncated 
    except Exception as e :
        return f"[–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}]\n",True 


def main ():
    print (f"–°—Ç–∞—Ä—Ç—É—é —Å–±–æ—Ä–∫—É –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞: {PROJECT_DIR}")

    output_file =get_next_output_file (PROJECT_DIR )
    print (f"–§–∞–π–ª –¥–∞–º–ø–∞: {output_file.name}")

    files =gather_files ()

    toc_lines =["PROJECT CORE FILES OVERVIEW\n","="*80 +"\n"]
    for f in files :
        toc_lines .append (f"- {f.relative_to(PROJECT_DIR).as_posix()}\n")
    toc_lines .append ("\n\n")

    with output_file .open ("w",encoding ="utf-8")as out :
        out .writelines (toc_lines )

        for f in files :
            rel =f .relative_to (PROJECT_DIR ).as_posix ()
            out .write ("="*80 +"\n")
            out .write (f"FILE: {rel}\n")
            out .write ("="*80 +"\n\n")

            content ,_truncated =read_file_safely (f )
            out .write (content )
            out .write ("\n")

    print (f"–ì–æ—Ç–æ–≤–æ: {output_file}")
    print (f"–§–∞–π–ª–æ–≤ —Å–æ–±—Ä–∞–Ω–æ: {len(files)}")

    if STRIP_COMMENTS_IN_DUMP :
        print ("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –¥–∞–º–ø–µ: –£–î–ê–õ–ï–ù–´ (–∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω—ã).")
    else :
        print ("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –¥–∞–º–ø–µ: –ù–ï —Ç—Ä–æ–≥–∞–ª.")


if __name__ =="__main__":
    main ()

================================================================================
FILE: remove_comments.py
================================================================================

#!/usr/bin/env python3


import os 
import argparse 
from pathlib import Path 
from enum import Enum ,auto 
from typing import Optional 


class State (Enum ):
    CODE =auto ()
    STRING_SINGLE =auto ()
    STRING_DOUBLE =auto ()
    TEMPLATE_STRING =auto ()
    TEMPLATE_EXPR =auto ()
    REGEX =auto ()
    LINE_COMMENT =auto ()
    BLOCK_COMMENT =auto ()


class CommentRemover :




    REGEX_PREV_TOKENS ={
    '(',')','[',']','{','}',',',';',':','=','!','&','|','?',
    '~','^','<','>','+','-','*','%','\n','\r'
    }


    REGEX_KEYWORDS ={
    'return','case','throw','in','instanceof','typeof',
    'void','delete','new','else','do','yield','await'
    }

    def __init__ (self ,content :str ):
        self .content =content 
        self .length =len (content )
        self .pos =0 
        self .result :list [str ]=[]


        self .last_significant_char ='\n'
        self .last_significant_word =''

    def peek (self ,offset :int =0 )->str :
        idx =self .pos +offset 
        return self .content [idx ]if idx <self .length else ''

    def peek_str (self ,length :int )->str :
        return self .content [self .pos :self .pos +length ]

    def advance (self ,count :int =1 )->str :
        s =self .content [self .pos :self .pos +count ]
        self .pos +=count 
        return s 

    def update_last_significant (self ,char :str )->None :

        if char .isalnum ()or char =='_':
            self .last_significant_word +=char 
            return 



        if char .isspace ():
            return 

        self .last_significant_char =char 
        self .last_significant_word =''

    def can_start_regex (self )->bool :
        if self .last_significant_char in self .REGEX_PREV_TOKENS :
            return True 
        if self .last_significant_word in self .REGEX_KEYWORDS :
            return True 
        return False 

    def is_triple_slash_directive (self )->bool :

        if self .peek_str (3 )!='///':
            return False 

        i =self .pos +3 
        rest =[]
        while i <self .length and self .content [i ]!='\n':
            rest .append (self .content [i ])
            i +=1 

        rest_stripped =''.join (rest ).strip ()
        return (
        rest_stripped .startswith ('<')
        and (
        'reference'in rest_stripped 
        or 'amd-module'in rest_stripped 
        or 'amd-dependency'in rest_stripped 
        )
        )

    def is_jsx_comment_start (self )->bool :

        i =self .pos -1 
        while i >=0 and self .content [i ]in ' \t\r\n':
            i -=1 
        return i >=0 and self .content [i ]=='{'

    def remove_trailing_jsx_brace (self )->None :

        while self .result and self .result [-1 ]in ' \t':
            self .result .pop ()
        if self .result and self .result [-1 ]=='{':
            self .result .pop ()
            while self .result and self .result [-1 ]in ' \t':
                self .result .pop ()

    def process_string (self ,quote :str )->None :

        self .result .append (self .advance ())

        while self .pos <self .length :
            ch =self .peek ()
            if ch =='\\'and self .pos +1 <self .length :
                self .result .append (self .advance (2 ))
            elif ch ==quote :
                self .result .append (self .advance ())
                return 
            elif ch =='\n':

                self .result .append (self .advance ())
                return 
            else :
                self .result .append (self .advance ())

    def process_template_string (self )->None :

        self .result .append (self .advance ())

        while self .pos <self .length :
            ch =self .peek ()

            if ch =='\\'and self .pos +1 <self .length :
                self .result .append (self .advance (2 ))
                continue 

            if ch =='`':
                self .result .append (self .advance ())
                return 

            if self .peek_str (2 )=='${':
                self .result .append (self .advance (2 ))

                self .process_template_expression ()
                continue 

            self .result .append (self .advance ())

    def process_template_expression (self )->None :

        brace_depth =1 

        while self .pos <self .length and brace_depth >0 :
            ch =self .peek ()
            two =self .peek_str (2 )

            if ch =='{':
                brace_depth +=1 
                self .result .append (self .advance ())
                self .update_last_significant ('{')
                continue 

            if ch =='}':
                brace_depth -=1 
                self .result .append (self .advance ())
                self .update_last_significant ('}')
                continue 

            if ch =='"':
                self .process_string ('"')

                self .last_significant_char ='"'
                self .last_significant_word =''
                continue 

            if ch =="'":
                self .process_string ("'")
                self .last_significant_char ="'"
                self .last_significant_word =''
                continue 

            if ch =='`':
                self .process_template_string ()
                self .last_significant_char ='`'
                self .last_significant_word =''
                continue 

            if two =='//':
                self .skip_line_comment ()
                self .last_significant_char ='\n'
                self .last_significant_word =''
                continue 

            if two =='/*':
                newlines =self .skip_block_comment (is_jsx =False )
                self .result .append ('\n'*newlines )

                self .last_significant_word =''
                continue 

            if ch =='/':
                if self .can_start_regex ():
                    nxt =self .peek (1 )

                    if nxt not in ('/','*',' ','\t','\n',''):


                        if nxt !='=':
                            self .process_regex ()
                            self .last_significant_char ='/'
                            self .last_significant_word =''
                            continue 

                self .result .append (self .advance ())
                self .update_last_significant ('/')
                continue 

            self .result .append (self .advance ())
            self .update_last_significant (ch )

    def process_regex (self )->None :

        self .result .append (self .advance ())

        in_class =False 

        while self .pos <self .length :
            ch =self .peek ()

            if ch =='\\'and self .pos +1 <self .length :
                self .result .append (self .advance (2 ))
                continue 

            if ch =='['and not in_class :
                in_class =True 
                self .result .append (self .advance ())
                continue 

            if ch ==']'and in_class :
                in_class =False 
                self .result .append (self .advance ())
                continue 

            if ch =='/'and not in_class :
                self .result .append (self .advance ())

                while self .pos <self .length and self .peek ().isalpha ():
                    self .result .append (self .advance ())
                return 

            if ch =='\n':

                return 

            self .result .append (self .advance ())

    def skip_line_comment (self )->None :

        self .advance (2 )
        while self .pos <self .length and self .peek ()!='\n':
            self .advance ()
        if self .pos <self .length :
            self .result .append (self .advance ())

    def skip_block_comment (self ,is_jsx :bool =False )->int :

        self .advance (2 )
        newlines =0 

        while self .pos <self .length :
            if self .peek_str (2 )=='*/':
                self .advance (2 )
                break 
            if self .peek ()=='\n':
                newlines +=1 
            self .advance ()

        if is_jsx :

            while self .pos <self .length and self .peek ()in ' \t':
                self .advance ()

            if self .peek ()=='}':
                self .advance ()

        return newlines 

    def process (self )->str :
        while self .pos <self .length :
            ch =self .peek ()
            two =self .peek_str (2 )


            if ch =='"':
                self .process_string ('"')
                self .last_significant_char ='"'
                self .last_significant_word =''
                continue 

            if ch =="'":
                self .process_string ("'")
                self .last_significant_char ="'"
                self .last_significant_word =''
                continue 


            if ch =='`':
                self .process_template_string ()
                self .last_significant_char ='`'
                self .last_significant_word =''
                continue 


            if self .is_triple_slash_directive ():
                while self .pos <self .length and self .peek ()!='\n':
                    self .result .append (self .advance ())
                if self .pos <self .length :
                    self .result .append (self .advance ())
                self .last_significant_char ='\n'
                self .last_significant_word =''
                continue 


            if two =='//':
                self .skip_line_comment ()
                self .last_significant_char ='\n'
                self .last_significant_word =''
                continue 


            if two =='/*':
                is_jsx =self .is_jsx_comment_start ()
                if is_jsx :
                    self .remove_trailing_jsx_brace ()
                newlines =self .skip_block_comment (is_jsx =is_jsx )
                self .result .append ('\n'*newlines )

                self .last_significant_word =''
                continue 


            if ch =='/':
                if self .can_start_regex ():
                    nxt =self .peek (1 )

                    if nxt not in ('=','/','*',' ','\t','\n',''):

                        if nxt !='=':
                            self .process_regex ()
                            self .last_significant_char ='/'
                            self .last_significant_word =''
                            continue 


                self .result .append (self .advance ())
                self .update_last_significant ('/')
                continue 


            self .result .append (self .advance ())
            self .update_last_significant (ch )

        return ''.join (self .result )


def remove_comments (content :str )->str :
    remover =CommentRemover (content )
    return remover .process ()


def clean_empty_lines (content :str )->str :

    lines =content .split ('\n')
    cleaned =[]
    empty_count =0 

    for line in lines :
        if line .strip ()=='':
            empty_count +=1 
            if empty_count <=2 :
                cleaned .append (line )
        else :
            empty_count =0 
            cleaned .append (line )

    return '\n'.join (cleaned )


def process_file (filepath :Path ,dry_run :bool =False ,verbose :bool =True )->tuple [bool ,int ]:

    try :
        with open (filepath ,'r',encoding ='utf-8')as f :
            original =f .read ()
    except UnicodeDecodeError :
        if verbose :
            print (f"  ‚ö†Ô∏è  –ü—Ä–æ–ø—É—Å–∫ (–Ω–µ UTF-8): {filepath}")
        return False ,0 
    except Exception as e :
        if verbose :
            print (f"  ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {filepath}: {e}")
        return False ,0 

    cleaned =remove_comments (original )
    cleaned =clean_empty_lines (cleaned )


    cleaned ='\n'.join (line .rstrip ()for line in cleaned .split ('\n'))


    cleaned =cleaned .rstrip ()+'\n'if cleaned .strip ()else ''

    diff =len (original )-len (cleaned )

    if diff >0 :
        if not dry_run :
            with open (filepath ,'w',encoding ='utf-8')as f :
                f .write (cleaned )
        return True ,diff 

    return False ,0 


def find_code_files (root_dir :Path ,extensions :set [str ])->list [Path ]:
    files =[]

    skip_dirs ={
    'node_modules','.git','dist','build','.next',
    '__pycache__','.vscode','.idea','coverage'
    }

    for root ,dirs ,filenames in os .walk (root_dir ):
        dirs [:]=[d for d in dirs if d not in skip_dirs ]

        for filename in filenames :
            ext =Path (filename ).suffix .lower ()
            if ext in extensions :
                files .append (Path (root )/filename )

    return files 


def main ()->int :
    parser =argparse .ArgumentParser (
    description ='–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–∑ JS/TS —Ñ–∞–π–ª–æ–≤ (v2 ‚Äî regex/template/triple-slash/JSX)',
    formatter_class =argparse .RawDescriptionHelpFormatter ,
    epilog ="""
–ü—Ä–∏–º–µ—Ä—ã:
  python remove_comments_v2.py ./src                    # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞–ø–∫—É
  python remove_comments_v2.py ./src --dry-run          # –¢–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å
  python remove_comments_v2.py ./src/App.tsx            # –û–¥–∏–Ω —Ñ–∞–π–ª
  python remove_comments_v2.py ./src --ext .ts .tsx     # –¢–æ–ª—å–∫–æ TS
        """
    )

    parser .add_argument ('path',type =str ,help ='–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏')
    parser .add_argument ('--dry-run','-d',action ='store_true',
    help ='–ù–µ –∏–∑–º–µ–Ω—è—Ç—å —Ñ–∞–π–ª—ã, —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å')
    parser .add_argument ('--quiet','-q',action ='store_true',
    help ='–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥')
    parser .add_argument ('--ext',nargs ='+',
    default =['.js','.jsx','.ts','.tsx','.mjs','.cjs'],
    help ='–†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤')

    args =parser .parse_args ()

    target =Path (args .path )
    extensions =set (args .ext )
    verbose =not args .quiet 

    if not target .exists ():
        print (f"‚ùå –ü—É—Ç—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {target}")
        return 1 

    if target .is_file ():
        files =[target ]
    else :
        files =find_code_files (target ,extensions )

    if not files :
        print (f"‚ö†Ô∏è  –§–∞–π–ª—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ {extensions} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        return 0 

    if verbose :
        mode ="üîç DRY-RUN"if args .dry_run else "üîß –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï"
        print (f"\n{mode}")
        print (f"üìÅ –ü—É—Ç—å: {target}")
        print (f"üìÑ –§–∞–π–ª–æ–≤: {len(files)}")
        print ("-"*50 )

    modified_count =0 
    total_saved =0 

    for filepath in sorted (files ):
        changed ,saved =process_file (filepath ,dry_run =args .dry_run ,verbose =verbose )
        if changed :
            modified_count +=1 
            total_saved +=saved 
            if verbose :
                rel =filepath .relative_to (target )if target .is_dir ()else filepath .name 
                print (f"  ‚úÖ {rel} (-{saved} –±–∞–π—Ç)")

    if verbose :
        print ("-"*50 )
        print (f"üìä –ò–∑–º–µ–Ω–µ–Ω–æ: {modified_count} —Ñ–∞–π–ª(–æ–≤)")
        print (f"üíæ –°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ: {total_saved:,} –±–∞–π—Ç")

    return 0 


if __name__ =='__main__':
    raise SystemExit (main ())

