PROJECT CORE FILES OVERVIEW
================================================================================
- QMS-Client-main/index.html
- QMS-Client-main/package.json
- QMS-Client-main/postcss.config.js
- QMS-Client-main/src/App.css
- QMS-Client-main/src/App.tsx
- QMS-Client-main/src/api/apiClient.ts
- QMS-Client-main/src/api/auditApi.ts
- QMS-Client-main/src/api/index.ts
- QMS-Client-main/src/api/labelTemplatesApi.ts
- QMS-Client-main/src/api/projectsApi.ts
- QMS-Client-main/src/api/qmsApi.ts
- QMS-Client-main/src/api/rbacApi.ts
- QMS-Client-main/src/api/structureApi.ts
- QMS-Client-main/src/api/tasksApi.ts
- QMS-Client-main/src/api/userApi.ts
- QMS-Client-main/src/api/warehouseApi.ts
- QMS-Client-main/src/components/AppRouter.tsx
- QMS-Client-main/src/components/Footer/Footer.tsx
- QMS-Client-main/src/components/Header/DateTimeDisplay.tsx
- QMS-Client-main/src/components/Header/Header.tsx
- QMS-Client-main/src/components/Modal/ConfirmModal.tsx
- QMS-Client-main/src/components/Modal/Modal.tsx
- QMS-Client-main/src/components/common/Preloader.tsx
- QMS-Client-main/src/components/common/PreloaderMini.tsx
- QMS-Client-main/src/components/qms/ActionBtn.tsx
- QMS-Client-main/src/components/qms/Avatar.tsx
- QMS-Client-main/src/components/qms/Badge.tsx
- QMS-Client-main/src/components/qms/Card.tsx
- QMS-Client-main/src/components/qms/DataTable.tsx
- QMS-Client-main/src/components/qms/KpiRow.tsx
- QMS-Client-main/src/components/qms/ProgressBar.tsx
- QMS-Client-main/src/components/qms/QmsLayout.tsx
- QMS-Client-main/src/components/qms/SectionTitle.tsx
- QMS-Client-main/src/components/qms/StatCard.tsx
- QMS-Client-main/src/components/qms/StatusDot.tsx
- QMS-Client-main/src/components/qms/TabBar.tsx
- QMS-Client-main/src/components/qms/Timeline.tsx
- QMS-Client-main/src/hooks/useAppAuth.ts
- QMS-Client-main/src/index.css
- QMS-Client-main/src/main.tsx
- QMS-Client-main/src/pages/Admin/AdminPCs/AdminEditPC.tsx
- QMS-Client-main/src/pages/Admin/AdminPCs/AdminOnePC.tsx
- QMS-Client-main/src/pages/Admin/AdminPCs/AdminPCs.tsx
- QMS-Client-main/src/pages/Admin/AdminPanel.tsx
- QMS-Client-main/src/pages/Admin/AdminUsers/AdminEditUser.tsx
- QMS-Client-main/src/pages/Admin/AdminUsers/AdminOneUser.tsx
- QMS-Client-main/src/pages/Admin/AdminUsers/AdminUsers.tsx
- QMS-Client-main/src/pages/Admin/Audit/AuditLogPage.tsx
- QMS-Client-main/src/pages/Admin/CreateModals/CreatePC.tsx
- QMS-Client-main/src/pages/Admin/Main/AdminCard.tsx
- QMS-Client-main/src/pages/Admin/Main/StructureSection.tsx
- QMS-Client-main/src/pages/Admin/Main/UsersSection.tsx
- QMS-Client-main/src/pages/Admin/Main/WarehouseSection.tsx
- QMS-Client-main/src/pages/Admin/Modules/ModulesPage.tsx
- QMS-Client-main/src/pages/Admin/RBAC/AdminRightsPage.tsx
- QMS-Client-main/src/pages/Admin/Structure/StructurePage.tsx
- QMS-Client-main/src/pages/Admin/Warehouse/WarehousePage.tsx
- QMS-Client-main/src/pages/CAPA/CapaPage.tsx
- QMS-Client-main/src/pages/Documents/DocumentsPage.tsx
- QMS-Client-main/src/pages/Login/Login.tsx
- QMS-Client-main/src/pages/Login/LoginPage.css
- QMS-Client-main/src/pages/Login/LoginPage.tsx
- QMS-Client-main/src/pages/Login/Registration.tsx
- QMS-Client-main/src/pages/Login/themes.ts
- QMS-Client-main/src/pages/Nonconformity/NonconformityPage.tsx
- QMS-Client-main/src/pages/PCs/OnePC.tsx
- QMS-Client-main/src/pages/PCs/SelectPC.tsx
- QMS-Client-main/src/pages/Profile/Profile.tsx
- QMS-Client-main/src/pages/QMS/QmsDashboardPage.tsx
- QMS-Client-main/src/pages/QMS/QmsPrototypePage.tsx
- QMS-Client-main/src/pages/Quality/AuditsPage.tsx
- QMS-Client-main/src/pages/Quality/EquipmentPage.tsx
- QMS-Client-main/src/pages/Quality/ReviewPage.tsx
- QMS-Client-main/src/pages/Quality/RisksPage.tsx
- QMS-Client-main/src/pages/Quality/SuppliersPage.tsx
- QMS-Client-main/src/pages/Quality/TrainingPage.tsx
- QMS-Client-main/src/pages/StartPage/StartPage.tsx
- QMS-Client-main/src/pages/Tasks/ProjectsList.tsx
- QMS-Client-main/src/pages/Tasks/TasksList.tsx
- QMS-Client-main/src/pages/Tasks/TasksPage.tsx
- QMS-Client-main/src/pages/Users/OneUser.tsx
- QMS-Client-main/src/pages/Users/Users.tsx
- QMS-Client-main/src/pages/Warehouse/AnalyticsPage.tsx
- QMS-Client-main/src/pages/Warehouse/InventoryPage.tsx
- QMS-Client-main/src/pages/Warehouse/WarehousePage.tsx
- QMS-Client-main/src/pages/Warehouse/__tests__/utils.test.ts
- QMS-Client-main/src/pages/Warehouse/components/LabelConstructor.tsx
- QMS-Client-main/src/pages/Warehouse/components/LabelPreview.tsx
- QMS-Client-main/src/pages/Warehouse/components/ProjectDashboard.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/VideoTransmittersLabel.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseBalance.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseDocs.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseIntake.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseLabels.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseMoves.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehousePrintHistory.tsx
- QMS-Client-main/src/pages/Warehouse/tabs/WarehouseSettings.tsx
- QMS-Client-main/src/pages/Warehouse/utils.ts
- QMS-Client-main/src/routes.ts
- QMS-Client-main/src/setupTests.ts
- QMS-Client-main/src/store/ModuleStore.ts
- QMS-Client-main/src/store/StructureStore.ts
- QMS-Client-main/src/store/UserStore.ts
- QMS-Client-main/src/store/__tests__/UserStore.test.ts
- QMS-Client-main/src/types/AuditLogModel.ts
- QMS-Client-main/src/types/PCModel.ts
- QMS-Client-main/src/types/ProductModel.ts
- QMS-Client-main/src/types/SessionModel.ts
- QMS-Client-main/src/types/UserModel.ts
- QMS-Client-main/src/types/WarehouseModels.ts
- QMS-Client-main/src/utils/consts.ts
- QMS-Client-main/src/utils/constsModalType.ts
- QMS-Client-main/src/vite-env.d.ts
- QMS-Client-main/tailwind.config.js
- QMS-Client-main/tsconfig.json
- QMS-Client-main/tsconfig.node.json
- QMS-Client-main/vite.config.ts
- QMS-Client-main/vitest.config.ts
- QMS-Mobile/mes-pwa/deploy.sh
- QMS-Mobile/mes-pwa/index.html
- QMS-Mobile/mes-pwa/package.json
- QMS-Mobile/mes-pwa/postcss.config.js
- QMS-Mobile/mes-pwa/public/silent-check-sso.html
- QMS-Mobile/mes-pwa/src/App.tsx
- QMS-Mobile/mes-pwa/src/api/client.ts
- QMS-Mobile/mes-pwa/src/components/common/Layout.tsx
- QMS-Mobile/mes-pwa/src/components/ui/index.tsx
- QMS-Mobile/mes-pwa/src/config/index.ts
- QMS-Mobile/mes-pwa/src/hooks/index.ts
- QMS-Mobile/mes-pwa/src/index.css
- QMS-Mobile/mes-pwa/src/main.tsx
- QMS-Mobile/mes-pwa/src/pages/Auth/LoginPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Home/HomePage.tsx
- QMS-Mobile/mes-pwa/src/pages/Production/ChecklistPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Production/ProductScanPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Production/ProductionPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Profile/ProfilePage.tsx
- QMS-Mobile/mes-pwa/src/pages/Rankings/RankingsPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Tasks/TasksPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Warehouse/BoxDetailPage.tsx
- QMS-Mobile/mes-pwa/src/pages/Warehouse/WarehousePage.tsx
- QMS-Mobile/mes-pwa/src/types/index.ts
- QMS-Mobile/mes-pwa/src/vite-env.d.ts
- QMS-Mobile/mes-pwa/tailwind.config.js
- QMS-Mobile/mes-pwa/tsconfig.json
- QMS-Mobile/mes-pwa/tsconfig.node.json
- QMS-Mobile/mes-pwa/vite.config.ts
- QMS-Server-master/config/config.js
- QMS-Server-master/config/modules.js
- QMS-Server-master/db.js
- QMS-Server-master/docker-compose.yml
- QMS-Server-master/error/ApiError.js
- QMS-Server-master/fonts/README.md
- QMS-Server-master/index.js
- QMS-Server-master/jest.config.js
- QMS-Server-master/middleware/ErrorHandlingMiddleware.js
- QMS-Server-master/middleware/checkModuleMiddleware.js
- QMS-Server-master/migrations/20250126-add-structure-manager-fields.js
- QMS-Server-master/migrations/20260209-create-core.js
- QMS-Server-master/migrations/20260210-audit-hashchain.js
- QMS-Server-master/migrations/20260210-create-dms.js
- QMS-Server-master/migrations/20260210-create-nc-capa.js
- QMS-Server-master/migrations/20260210-create-rbac.js
- QMS-Server-master/migrations/20260211-p1p2-all-modules.js
- QMS-Server-master/migrations/20260211120000-fix-users-columns.js
- QMS-Server-master/migrations/20260211120001-fix-pcs-columns.js
- QMS-Server-master/migrations/20260211120002-fix-sessions-columns.js
- QMS-Server-master/migrations/20260211120003-fix-audit-logs-columns.js
- QMS-Server-master/migrations/20260211120004-fix-production-section-columns.js
- QMS-Server-master/migrations/20260211120005-fix-production-team-columns.js
- QMS-Server-master/migrations/20260211120006-create-projects.js
- QMS-Server-master/migrations/20260211120007-create-warehouse-tables.js
- QMS-Server-master/models/ProductionOutput.js
- QMS-Server-master/models/index.js
- QMS-Server-master/modules/core/controllers/ProjectController.js
- QMS-Server-master/modules/core/controllers/TaskController.js
- QMS-Server-master/modules/core/controllers/auditController.js
- QMS-Server-master/modules/core/controllers/pcController.js
- QMS-Server-master/modules/core/controllers/rbacController.js
- QMS-Server-master/modules/core/controllers/sessionController.js
- QMS-Server-master/modules/core/controllers/structureController.js
- QMS-Server-master/modules/core/controllers/userController.js
- QMS-Server-master/modules/core/index.js
- QMS-Server-master/modules/core/middleware/authMiddleware.js
- QMS-Server-master/modules/core/middleware/checkAbilityMiddleware.js
- QMS-Server-master/modules/core/middleware/checkRoleMiddleware.js
- QMS-Server-master/modules/core/middleware/syncUserMiddleware.js
- QMS-Server-master/modules/core/models/General.js
- QMS-Server-master/modules/core/models/Project.js
- QMS-Server-master/modules/core/models/Structure.js
- QMS-Server-master/modules/core/routes/auditRouter.js
- QMS-Server-master/modules/core/routes/pcRouter.js
- QMS-Server-master/modules/core/routes/projectRouter.js
- QMS-Server-master/modules/core/routes/rbacRouter.js
- QMS-Server-master/modules/core/routes/sessionRouter.js
- QMS-Server-master/modules/core/routes/structureRouter.js
- QMS-Server-master/modules/core/routes/taskRouter.js
- QMS-Server-master/modules/core/routes/userRouter.js
- QMS-Server-master/modules/core/utils/auditLogger.js
- QMS-Server-master/modules/core/utils/auditVerifier.js
- QMS-Server-master/modules/core/utils/hashChainLogger.js
- QMS-Server-master/modules/qms-audit/controllers/internalAuditController.js
- QMS-Server-master/modules/qms-audit/index.js
- QMS-Server-master/modules/qms-audit/models/InternalAudit.js
- QMS-Server-master/modules/qms-audit/routes/internalAuditRouter.js
- QMS-Server-master/modules/qms-dms/controllers/documentController.js
- QMS-Server-master/modules/qms-dms/index.js
- QMS-Server-master/modules/qms-dms/models/Document.js
- QMS-Server-master/modules/qms-dms/routes/documentRouter.js
- QMS-Server-master/modules/qms-dms/services/DocumentService.js
- QMS-Server-master/modules/qms-equipment/controllers/equipmentController.js
- QMS-Server-master/modules/qms-equipment/index.js
- QMS-Server-master/modules/qms-equipment/models/Equipment.js
- QMS-Server-master/modules/qms-equipment/routes/equipmentRouter.js
- QMS-Server-master/modules/qms-nc/controllers/ncCapaController.js
- QMS-Server-master/modules/qms-nc/index.js
- QMS-Server-master/modules/qms-nc/models/NcCapa.js
- QMS-Server-master/modules/qms-nc/routes/ncCapaRouter.js
- QMS-Server-master/modules/qms-nc/services/NcCapaService.js
- QMS-Server-master/modules/qms-review/controllers/reviewController.js
- QMS-Server-master/modules/qms-review/index.js
- QMS-Server-master/modules/qms-review/models/ManagementReview.js
- QMS-Server-master/modules/qms-review/routes/reviewRouter.js
- QMS-Server-master/modules/qms-risk/controllers/riskController.js
- QMS-Server-master/modules/qms-risk/index.js
- QMS-Server-master/modules/qms-risk/models/Risk.js
- QMS-Server-master/modules/qms-risk/routes/riskRouter.js
- QMS-Server-master/modules/qms-risk/services/RiskMatrixService.js
- QMS-Server-master/modules/qms-supplier/controllers/supplierController.js
- QMS-Server-master/modules/qms-supplier/index.js
- QMS-Server-master/modules/qms-supplier/models/Supplier.js
- QMS-Server-master/modules/qms-supplier/routes/supplierRouter.js
- QMS-Server-master/modules/qms-supplier/services/SupplierScoringService.js
- QMS-Server-master/modules/qms-training/controllers/trainingController.js
- QMS-Server-master/modules/qms-training/index.js
- QMS-Server-master/modules/qms-training/models/Training.js
- QMS-Server-master/modules/qms-training/routes/trainingRouter.js
- QMS-Server-master/modules/wms/controllers/AlertsController.js
- QMS-Server-master/modules/wms/controllers/AnalyticsController.js
- QMS-Server-master/modules/wms/controllers/BoxController.js
- QMS-Server-master/modules/wms/controllers/DocumentController.js
- QMS-Server-master/modules/wms/controllers/HistoryController.js
- QMS-Server-master/modules/wms/controllers/MovementController.js
- QMS-Server-master/modules/wms/controllers/SupplyController.js
- QMS-Server-master/modules/wms/index.js
- QMS-Server-master/modules/wms/models/Warehouse.js
- QMS-Server-master/modules/wms/routes/warehouseRouter.js
- QMS-Server-master/package.json
- QMS-Server-master/routes/index.js
- QMS-Server-master/run-migration.js
- QMS-Server-master/scripts/backfill-audit-hashes.js
- QMS-Server-master/scripts/db-reset.js
- QMS-Server-master/scripts/db-schema-compare.js
- QMS-Server-master/scripts/verify-requires.js
- QMS-Server-master/services/ExcelImportService.js
- QMS-Server-master/services/PdfService.js
- QMS-Server-master/static/defect-records/2/1769537183976_README.md
- QMS-Server-master/static/defect-records/2/1769579757522_README.md
- QMS-Server-master/static/defect-records/2/1769580241363_README.md
- QMS-Server-master/tests/controllers/box.test.js
- QMS-Server-master/tests/controllers/movement.test.js
- QMS-Server-master/tests/controllers/supply.test.js
- QMS-Server-master/tests/middleware/checkAbility.test.js
- QMS-Server-master/tests/middleware/syncUser.test.js
- README.md
- docs/ASVO-QMS-frontend-spec-v1.html
- dump_project_full.py
- integrate-qms.sh
- remove_comments.py


================================================================================
FILE: QMS-Client-main/index.html
================================================================================

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ASVO-QMS</title>
    <link rel="icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/apple-touch-icon-180x180.png" sizes="180x180" />
    <link rel="mask-icon" href="/public/maskable-icon-512x512.png" color="#FFFFFF">
    <meta name="theme-color" content="#0f172a">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: QMS-Client-main/package.json
================================================================================

{
  "name": "asvo-qms",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "lint": "eslint src/ --ext ts,tsx --report-unused-disable-directives",
    "preview": "vite preview",
    "generate-pwa-assets": "pwa-assets-generator --preset minimal src/assets/images/logo.svg",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "coverage": "vitest run --coverage"
  },
  "dependencies": {
    "@headlessui/react": "^2.0.4",
    "@heroicons/react": "^2.1.3",
    "@sendgrid/mail": "^8.1.3",
    "@skbkontur/react-ui": "^5.0.10",
    "@types/axios": "^0.14.0",
    "@types/node": "^20.12.12",
    "axios": "^1.6.8",
    "clsx": "^2.1.1",
    "dayjs": "^1.11.13",
    "jwt-decode": "^4.0.0",
    "lucide-react": "^0.562.0",
    "mobx": "^6.13.5",
    "mobx-react-lite": "^4.1.0",
    "oidc-client-ts": "^3.4.1",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-hot-toast": "^2.6.0",
    "react-oidc-context": "^3.3.0",
    "react-qr-code": "^2.0.15",
    "react-router-dom": "^6.22.3",
    "react-use": "^17.6.0",
    "recharts": "^3.5.1",
    "socket.io-client": "^4.8.1"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^6.4.5",
    "@testing-library/react": "^14.3.1",
    "@types/react": "^18.3.2",
    "@types/react-dom": "^18.3.0",
    "@types/w3c-web-serial": "^1.0.8",
    "@typescript-eslint/eslint-plugin": "^7.2.0",
    "@typescript-eslint/parser": "^7.2.0",
    "@vite-pwa/assets-generator": "^0.2.4",
    "@vitejs/plugin-react": "^4.2.1",
    "@vitejs/plugin-react-swc": "^4.2.2",
    "@vitest/ui": "^1.6.0",
    "autoprefixer": "^10.4.19",
    "eslint": "^8.57.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.6",
    "jsdom": "^24.1.0",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.3",
    "typescript": "^5.4.5",
    "vite": "^5.2.0",
    "vite-plugin-pwa": "^0.20.0",
    "vitest": "^1.6.0"
  }
}

================================================================================
FILE: QMS-Client-main/postcss.config.js
================================================================================

export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: QMS-Client-main/src/App.css
================================================================================

* {
  margin: 0;
  padding: 0;
}

.App {
  text-align: center;
}

.img {
  background-color: burlywood;
  width: 300px;
  height: 300px;
}
.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}
================================================================================
FILE: QMS-Client-main/src/App.tsx
================================================================================

import "./App.css";
import { Header } from "components/Header/Header";
import { AppRouter } from "components/AppRouter";
import { observer } from "mobx-react-lite";
import { useContext, useEffect, useState, useRef } from "react";
import { Context, getSavedPath, clearSavedPath } from "./main";
import { Preloader } from "./components/common/Preloader";
import { useAppAuth as useAuth } from "./hooks/useAppAuth";
import { useNavigate, useLocation } from "react-router-dom";
import { SELECT_PC_ROUTE } from "./utils/consts";
import { check } from "./api/userApi";
import { Toaster } from 'react-hot-toast';
import { LoginPage } from "./pages/Login/LoginPage";

const App = observer(() => {
  const auth = useAuth();
  const context = useContext(Context);
  const navigate = useNavigate();
  const location = useLocation();

  const [isUserLoading, setIsUserLoading] = useState(auth.isAuthenticated);


  const hasRestoredPath = useRef(false);


  const initialPathRef = useRef<string | null>(null);

  useEffect(() => {

    if (initialPathRef.current === null) {
      const currentPath = window.location.pathname + window.location.search;

      const hasOidcParams = window.location.search.includes('code=') ||
                            window.location.search.includes('state=');
      if (currentPath !== "/" && !hasOidcParams) {
        initialPathRef.current = currentPath;
      }
    }
  }, []);

  if (!context) throw new Error("Context required");
  const { user, modules } = context;


  useEffect(() => {
    if (auth.isAuthenticated && auth.user) {
      localStorage.setItem('token', auth.user.access_token);
      setIsUserLoading(true);

      
      if (!modules.config) {
        modules.fetchModules();
      }

      check()
        .then((userData) => {
            user.setUser(userData);
            user.setIsAuth(true);


            const pcId = localStorage.getItem('pcID');


            if (!hasRestoredPath.current) {
              hasRestoredPath.current = true;


              const savedPath = getSavedPath();
              const targetPath = initialPathRef.current || savedPath;


              if (savedPath) {
                clearSavedPath();
              }


              const currentPath = location.pathname;

              if (targetPath && targetPath !== "/" && targetPath !== currentPath) {

                console.log(`[App] Восстанавливаем путь: ${targetPath}`);
                navigate(targetPath, { replace: true });
              } else if (!pcId && currentPath !== SELECT_PC_ROUTE && currentPath === "/") {


                console.log(`[App] Нет pcID, редирект на выбор ПК`);
                navigate(SELECT_PC_ROUTE, { replace: true });
              }

            }
        })
        .catch((err) => {
            console.error("❌ Failed to fetch user profile:", err);
        })
        .finally(() => setIsUserLoading(false));

    } else if (!auth.isLoading && !auth.isAuthenticated) {
      user.resetUser();
      localStorage.removeItem('token');
      localStorage.removeItem('userID');
      setIsUserLoading(false);
      hasRestoredPath.current = false;
      initialPathRef.current = null;
    }
  }, [auth.isAuthenticated, auth.user, user, navigate, location.pathname]);


  if (auth.isLoading || isUserLoading) {
    return <Preloader />;
  }


  if (!auth.isAuthenticated) {
    return <LoginPage onLogin={() => auth.signinRedirect()} />;
  }


  return (
    <div className="bg-slate-100 min-h-screen flex flex-col">
      <Toaster
        position="top-right"
        toastOptions={{
          duration: 4000,
          style: {
            background: '#0f172a',
            color: '#e2e8f0',
            borderRadius: '12px',
            border: '1px solid #334155',
          },
        }}
      />
      <Header />
      <main className="flex-1 overflow-auto pb-4 pt-14">
        <AppRouter />
      </main>
    </div>
  );
});

export default App;

================================================================================
FILE: QMS-Client-main/src/api/apiClient.ts
================================================================================

import { $authHost } from "./index";

export const apiClient = $authHost;

================================================================================
FILE: QMS-Client-main/src/api/auditApi.ts
================================================================================

import { $authHost } from "./index";
import { AuditLogModel } from "src/types/AuditLogModel";

export interface AuditLogFilter {
  page?: number;
  limit?: number;
  userId?: number;
  action?: string;
  entity?: string;
  dateFrom?: string;
  dateTo?: string;
}

export interface AuditLogResponse {
  count: number;
  rows: AuditLogModel[];
}

export const fetchAuditLogs = async (
  params: AuditLogFilter
): Promise<AuditLogResponse> => {
  const { data } = await $authHost.get<AuditLogResponse>("api/audit", {
    params,
  });
  return data;
};

================================================================================
FILE: QMS-Client-main/src/api/index.ts
================================================================================

import axios from 'axios';


const $host = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
});

const $authHost = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
});


const authInterceptor = (config: any) => {
  const token = localStorage.getItem('token');

  if (token && token !== "undefined" && token !== "null") {
    config.headers.authorization = `Bearer ${token}`;
  }
  return config;
};

$authHost.interceptors.request.use(authInterceptor);

export {
  $host,
  $authHost,
};

================================================================================
FILE: QMS-Client-main/src/api/labelTemplatesApi.ts
================================================================================

import { $authHost } from "./index";

export type LabelElementType = "TEXT" | "QR" | "RECTANGLE" | "LINE" | "IMAGE" | "COUNTER" | "ICON";

export interface LabelElement {
  id: string;
  type: LabelElementType;
  x: number;
  y: number;
  width: number;
  height: number;
  text?: string;
  content?: string;
  fontSize?: number;
  isBold?: boolean;
  align?: "left" | "center" | "right";
  counterFormat?: string;
  imageUrl?: string;
  imageName?: string;
  iconType?: string;
  strokeWidth?: number;
}

export interface LabelTemplateModel {
  id: number;
  name: string;
  type: string;
  width: number;
  height: number;
  layout?: LabelElement[];
  elements: LabelElement[];
  createdAt: string;
  updatedAt: string;
}

export const fetchLabelTemplates = async (): Promise<LabelTemplateModel[]> => {
  const { data } = await $authHost.get("api/warehouse/label-templates");
  return data;
};

export const createLabelTemplate = async (
  name: string,
  width: number,
  height: number,
  elements: LabelElement[]
): Promise<LabelTemplateModel> => {
  const { data } = await $authHost.post("api/warehouse/label-templates", {
    name,
    width,
    height,
    elements,
  });
  return data;
};

export const deleteLabelTemplate = async (id: number): Promise<void> => {
  await $authHost.delete(`api/warehouse/label-templates/${id}`);
};

================================================================================
FILE: QMS-Client-main/src/api/projectsApi.ts
================================================================================

import { $authHost } from "./index";

export interface ProjectModel {
    id: number;
    title: string;
    description: string;
    status: string;
    createdAt: string;
    author?: { name: string; surname: string };
}

export const fetchProjects = async () => {
    const { data } = await $authHost.get("api/projects");
    return data as ProjectModel[];
};

export const createProject = async (title: string, description: string) => {
    const { data } = await $authHost.post("api/projects", { title, description });
    return data;
};

export const deleteProject = async (id: number) => {
    await $authHost.delete(`api/projects/${id}`);
};
================================================================================
FILE: QMS-Client-main/src/api/qmsApi.ts
================================================================================










import { $authHost } from "./index";






export interface AuditVerifyReport {
  valid: boolean;
  totalRecords: number;
  validRecords: number;
  invalidRecords: number;
  unchainedRecords: number;
  firstChainIndex: number | null;
  lastChainIndex: number | null;
  errors: Array<{ chainIndex: number; recordId: number; valid: boolean; errors: string[] }>;
  verifiedAt: string;
  durationMs: number;
}

export interface AuditStats {
  period: { days: number; since: string };
  total: number;
  chainedTotal: number;
  chainCoverage: number;
  bySeverity: Array<{ severity: string; count: string }>;
  byEntity: Array<{ entity: string; count: string }>;
  byAction: Array<{ action: string; count: string }>;
}

export interface AuditInspectionReport {
  system: string;
  standard: string;
  generatedAt: string;
  chainIntegrity: AuditVerifyReport;
  severityDistribution: Array<{ severity: string; count: string }>;
  monthlyActivity: Array<{ month: string; count: string }>;
  conclusion: string;
}


export type DocType = "POLICY" | "MANUAL" | "PROCEDURE" | "WORK_INSTRUCTION" | "FORM" | "RECORD" | "SPECIFICATION" | "PLAN" | "EXTERNAL" | "OTHER";
export type DocStatus = "DRAFT" | "REVIEW" | "APPROVED" | "EFFECTIVE" | "REVISION" | "OBSOLETE" | "CANCELLED";

export interface DocumentShort {
  id: number;
  code: string;
  title: string;
  type: DocType;
  status: DocStatus;
  category: string | null;
  effectiveDate: string | null;
  nextReviewDate: string | null;
  owner: { id: number; name: string; surname: string };
  currentVersion: { id: number; version: string; status: string; effectiveAt: string | null } | null;
  updatedAt: string;
}

export interface DocumentApprovalItem {
  id: number;
  step: number;
  role: string;
  decision: string;
  comment: string | null;
  decidedAt: string | null;
  dueDate: string | null;
  assignedTo: { id: number; name: string; surname: string };
  version: {
    id: number;
    version: string;
    document: { id: number; code: string; title: string; type: string };
    createdBy: { id: number; name: string; surname: string };
  };
}

export interface DocumentStats {
  byStatus: Array<{ status: string; count: string }>;
  byType: Array<{ type: string; count: string }>;
  overdueCount: number;
  pendingApprovalsCount: number;
}


export type NcStatus = "OPEN" | "INVESTIGATING" | "DISPOSITION" | "IMPLEMENTING" | "VERIFICATION" | "CLOSED" | "REOPENED";
export type NcClassification = "CRITICAL" | "MAJOR" | "MINOR";

export interface NcShort {
  id: number;
  number: string;
  title: string;
  source: string;
  classification: NcClassification;
  status: NcStatus;
  detectedAt: string;
  dueDate: string | null;
  reportedBy: { id: number; name: string; surname: string };
  assignedTo: { id: number; name: string; surname: string } | null;
}


export type CapaStatus = "INITIATED" | "INVESTIGATING" | "PLANNING" | "PLAN_APPROVED" | "IMPLEMENTING" | "VERIFYING" | "EFFECTIVE" | "INEFFECTIVE" | "CLOSED";

export interface CapaShort {
  id: number;
  number: string;
  type: "CORRECTIVE" | "PREVENTIVE";
  title: string;
  status: CapaStatus;
  priority: string;
  dueDate: string | null;
  assignedTo: { id: number; name: string; surname: string } | null;
  initiatedBy: { id: number; name: string; surname: string };
  nonconformity: { id: number; number: string; title: string; classification: string } | null;
}

export interface NcCapaStats {
  ncByStatus: Array<{ status: string; count: string }>;
  ncBySource: Array<{ source: string; count: string }>;
  ncByClassification: Array<{ classification: string; count: string }>;
  capaByStatus: Array<{ status: string; count: string }>;
  capaByType: Array<{ type: string; count: string }>;
  overdueNc: number;
  overdueCapa: number;
}





export const auditApi = {
  getLogs: (params: Record<string, any>) =>
    $authHost.get("/api/audit/", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/audit/${id}`).then(r => r.data),

  quickVerify: (count = 100): Promise<AuditVerifyReport> =>
    $authHost.get("/api/audit/verify", { params: { count } }).then(r => r.data),

  fullVerify: (fromIndex?: number, toIndex?: number): Promise<AuditVerifyReport> =>
    $authHost.get("/api/audit/verify/full", { params: { fromIndex, toIndex } }).then(r => r.data),

  getReport: (): Promise<AuditInspectionReport> =>
    $authHost.get("/api/audit/report").then(r => r.data),

  getStats: (days = 30): Promise<AuditStats> =>
    $authHost.get("/api/audit/stats", { params: { days } }).then(r => r.data),
};





export const documentsApi = {
  getAll: (params: Record<string, any>) =>
    $authHost.get("/api/documents/", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/documents/${id}`).then(r => r.data),

  getStats: (): Promise<DocumentStats> =>
    $authHost.get("/api/documents/stats").then(r => r.data),

  getPending: (): Promise<DocumentApprovalItem[]> =>
    $authHost.get("/api/documents/pending").then(r => r.data),

  getOverdue: () =>
    $authHost.get("/api/documents/overdue").then(r => r.data),

  create: (data: { title: string; type: DocType; category?: string; description?: string; isoSection?: string }) =>
    $authHost.post("/api/documents/", data).then(r => r.data),

  createVersion: (docId: number, data: { changeDescription?: string }) =>
    $authHost.post(`/api/documents/${docId}/versions`, data).then(r => r.data),

  uploadFile: (versionId: number, file: File) => {
    const form = new FormData();
    form.append("file", file);
    return $authHost.post(`/api/documents/versions/${versionId}/upload`, form).then(r => r.data);
  },

  submitForReview: (versionId: number, approvalChain: Array<{ userId: number; role: string; dueDate?: string }>) =>
    $authHost.post(`/api/documents/versions/${versionId}/submit`, { approvalChain }).then(r => r.data),

  decide: (approvalId: number, data: { decision: string; comment?: string }) =>
    $authHost.post(`/api/documents/approvals/${approvalId}/decide`, data).then(r => r.data),

  makeEffective: (versionId: number) =>
    $authHost.post(`/api/documents/versions/${versionId}/effective`).then(r => r.data),

  distribute: (versionId: number, userIds: number[]) =>
    $authHost.post(`/api/documents/versions/${versionId}/distribute`, { userIds }).then(r => r.data),

  acknowledge: (distributionId: number) =>
    $authHost.post(`/api/documents/distributions/${distributionId}/ack`).then(r => r.data),
};





export const ncApi = {
  getAll: (params: Record<string, any>) =>
    $authHost.get("/api/nc/", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/nc/${id}`).then(r => r.data),

  create: (data: Record<string, any>) =>
    $authHost.post("/api/nc/", data).then(r => r.data),

  update: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/nc/${id}`, data).then(r => r.data),

  close: (id: number, data: { closingComment?: string }) =>
    $authHost.post(`/api/nc/${id}/close`, data).then(r => r.data),

  getStats: (): Promise<NcCapaStats> =>
    $authHost.get("/api/nc/stats").then(r => r.data),
};









export const risksApi = {
  getAll: (params?: Record<string, any>) =>
    $authHost.get("/api/risks", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/risks/${id}`).then(r => r.data),

  create: (data: Record<string, any>) =>
    $authHost.post("/api/risks", data).then(r => r.data),

  update: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/risks/${id}`, data).then(r => r.data),

  getStats: () =>
    $authHost.get("/api/risks/stats").then(r => r.data),

  getMatrix: () =>
    $authHost.get("/api/risks/matrix").then(r => r.data),

  addAssessment: (riskId: number, data: Record<string, any>) =>
    $authHost.post(`/api/risks/${riskId}/assess`, data).then(r => r.data),

  addMitigation: (riskId: number, data: Record<string, any>) =>
    $authHost.post(`/api/risks/${riskId}/mitigation`, data).then(r => r.data),

  acceptRisk: (riskId: number, data: { decision: string }) =>
    $authHost.post(`/api/risks/${riskId}/accept`, data).then(r => r.data),
};





export const suppliersApi = {
  getAll: (params?: Record<string, any>) =>
    $authHost.get("/api/suppliers", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/suppliers/${id}`).then(r => r.data),

  create: (data: Record<string, any>) =>
    $authHost.post("/api/suppliers", data).then(r => r.data),

  update: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/suppliers/${id}`, data).then(r => r.data),

  remove: (id: number) =>
    $authHost.delete(`/api/suppliers/${id}`).then(r => r.data),

  getStats: () =>
    $authHost.get("/api/suppliers/stats").then(r => r.data),

  addEvaluation: (supplierId: number, data: Record<string, any>) =>
    $authHost.post(`/api/suppliers/${supplierId}/evaluations`, data).then(r => r.data),

  getEvaluations: (supplierId: number) =>
    $authHost.get(`/api/suppliers/${supplierId}/evaluations`).then(r => r.data),

  addAudit: (supplierId: number, data: Record<string, any>) =>
    $authHost.post(`/api/suppliers/${supplierId}/audits`, data).then(r => r.data),
};





export const internalAuditsApi = {
  getPlans: (params?: Record<string, any>) =>
    $authHost.get("/api/internal-audits/plans", { params }).then(r => r.data),

  getPlanOne: (id: number) =>
    $authHost.get(`/api/internal-audits/plans/${id}`).then(r => r.data),

  createPlan: (data: Record<string, any>) =>
    $authHost.post("/api/internal-audits/plans", data).then(r => r.data),

  updatePlan: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/internal-audits/plans/${id}`, data).then(r => r.data),

  getSchedules: (params?: Record<string, any>) =>
    $authHost.get("/api/internal-audits/schedules", { params }).then(r => r.data),

  getScheduleOne: (id: number) =>
    $authHost.get(`/api/internal-audits/schedules/${id}`).then(r => r.data),

  createSchedule: (data: Record<string, any>) =>
    $authHost.post("/api/internal-audits/schedules", data).then(r => r.data),

  updateSchedule: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/internal-audits/schedules/${id}`, data).then(r => r.data),

  addFinding: (scheduleId: number, data: Record<string, any>) =>
    $authHost.post(`/api/internal-audits/schedules/${scheduleId}/findings`, data).then(r => r.data),

  updateFinding: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/internal-audits/findings/${id}`, data).then(r => r.data),

  getStats: () =>
    $authHost.get("/api/internal-audits/stats").then(r => r.data),
};





export const trainingApi = {
  getPlans: (params?: Record<string, any>) =>
    $authHost.get("/api/training/plans", { params }).then(r => r.data),

  getPlanOne: (id: number) =>
    $authHost.get(`/api/training/plans/${id}`).then(r => r.data),

  createPlan: (data: Record<string, any>) =>
    $authHost.post("/api/training/plans", data).then(r => r.data),

  updatePlan: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/training/plans/${id}`, data).then(r => r.data),

  getRecords: (params?: Record<string, any>) =>
    $authHost.get("/api/training/records", { params }).then(r => r.data),

  createRecord: (data: Record<string, any>) =>
    $authHost.post("/api/training/records", data).then(r => r.data),

  updateRecord: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/training/records/${id}`, data).then(r => r.data),

  getCompetency: (params?: Record<string, any>) =>
    $authHost.get("/api/training/competency", { params }).then(r => r.data),

  createCompetency: (data: Record<string, any>) =>
    $authHost.post("/api/training/competency", data).then(r => r.data),

  updateCompetency: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/training/competency/${id}`, data).then(r => r.data),

  getStats: () =>
    $authHost.get("/api/training/stats").then(r => r.data),
};





export const equipmentApi = {
  getAll: (params?: Record<string, any>) =>
    $authHost.get("/api/equipment", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/equipment/${id}`).then(r => r.data),

  create: (data: Record<string, any>) =>
    $authHost.post("/api/equipment", data).then(r => r.data),

  update: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/equipment/${id}`, data).then(r => r.data),

  addCalibration: (equipmentId: number, data: Record<string, any>) =>
    $authHost.post(`/api/equipment/${equipmentId}/calibrations`, data).then(r => r.data),

  updateCalibration: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/equipment/calibrations/${id}`, data).then(r => r.data),

  getStats: () =>
    $authHost.get("/api/equipment/stats").then(r => r.data),
};





export const reviewsApi = {
  getAll: (params?: Record<string, any>) =>
    $authHost.get("/api/reviews", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/reviews/${id}`).then(r => r.data),

  create: (data: Record<string, any>) =>
    $authHost.post("/api/reviews", data).then(r => r.data),

  update: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/reviews/${id}`, data).then(r => r.data),

  addAction: (reviewId: number, data: Record<string, any>) =>
    $authHost.post(`/api/reviews/${reviewId}/actions`, data).then(r => r.data),

  updateAction: (id: number, data: Record<string, any>) =>
    $authHost.put(`/api/reviews/actions/${id}`, data).then(r => r.data),

  getStats: () =>
    $authHost.get("/api/reviews/stats").then(r => r.data),
};





export const capaApi = {
  getAll: (params: Record<string, any>) =>
    $authHost.get("/api/nc/capa", { params }).then(r => r.data),

  getOne: (id: number) =>
    $authHost.get(`/api/nc/capa/${id}`).then(r => r.data),

  create: (data: Record<string, any>) =>
    $authHost.post("/api/nc/capa", data).then(r => r.data),

  updateStatus: (id: number, data: { status: string; comment?: string }) =>
    $authHost.put(`/api/nc/capa/${id}/status`, data).then(r => r.data),

  addAction: (capaId: number, data: { description: string; assignedToId?: number; dueDate?: string }) =>
    $authHost.post(`/api/nc/capa/${capaId}/actions`, data).then(r => r.data),

  updateAction: (actionId: number, data: Record<string, any>) =>
    $authHost.put(`/api/nc/capa/actions/${actionId}`, data).then(r => r.data),

  verify: (capaId: number, data: { isEffective: boolean; evidence?: string; comment?: string }) =>
    $authHost.post(`/api/nc/capa/${capaId}/verify`, data).then(r => r.data),
};

================================================================================
FILE: QMS-Client-main/src/api/rbacApi.ts
================================================================================

import { $authHost } from "./index";

export interface AbilityModel {
    id: number;
    code: string;
    description: string;
}

export interface RoleModel {
    id: number;
    name: string;
    description: string;
    abilities: AbilityModel[];
}

export const fetchAllRoles = async () => {
    const { data } = await $authHost.get("api/rbac/roles");
    return data as RoleModel[];
};

export const fetchAllAbilities = async () => {
    const { data } = await $authHost.get("api/rbac/abilities");
    return data as AbilityModel[];
};

export const updateRoleAbilities = async (roleId: number, abilityIds: number[]) => {
    const { data } = await $authHost.post(`api/rbac/role/${roleId}`, { abilityIds });
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/structureApi.ts
================================================================================

import { $authHost } from "src/api";
import { userGetModel } from "src/types/UserModel";

export const fetchStructure = async () => {
    const { data } = await $authHost.get("api/structure");
    return data;
};


export const fetchUnassignedUsers = async () => {
    const { data } = await $authHost.get("api/structure/users/unassigned");
    return data as userGetModel[];
};

export const createSection = async (title: string) => {
    const { data } = await $authHost.post("api/structure/section", { title });
    return data;
};

export const createTeam = async (title: string, sectionId: number) => {
    const { data } = await $authHost.post("api/structure/team", { title, sectionId });
    return data;
};

export const assignSectionManager = async (sectionId: number, userId: number) => {
    const { data } = await $authHost.put("api/structure/section/manager", { sectionId, userId });
    return data;
};

export const assignTeamLead = async (teamId: number, userId: number) => {
    const { data } = await $authHost.put("api/structure/team/lead", { teamId, userId });
    return data;
};

export const addUserToTeam = async (teamId: number, userId: number) => {
    const { data } = await $authHost.put("api/structure/user/assign", { teamId, userId });
    return data;
};

export const removeUserFromTeam = async (userId: number) => {
    const { data } = await $authHost.put("api/structure/user/remove", { userId });
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/tasksApi.ts
================================================================================

import { $authHost } from "./index";
import { InventoryBoxModel } from "src/types/WarehouseModels";

export interface TaskStats {
  total: number;
  done: number;
  inWork: number;
  onStock: number;
}

export interface ProductionTask {
  id: number;
  title: string;
  originType?: string | null;
  originId?: number | null;
  targetQty: number;
  unit: string;
  dueDate?: string | null;
  status: string;
  priority?: number | null;
  comment?: string | null;

  responsibleId?: number | null;
  sectionId?: number | null;
  projectId?: number | null;

  responsible?: { id: number; name: string; surname: string } | null;
  project?: { id: number; title: string } | null;

  stats?: TaskStats;
  progressPercent?: number;
}

export interface TaskListResponse {
  rows: ProductionTask[];
  count: number;
  page: number;
  limit: number;
}

export interface TaskBreakdownItem {
  status: string;
  sectionId: number | null;
  sectionTitle: string | null;
  qty: number;
}

export interface TaskDetailResponse {
  task: ProductionTask;
  totalQty: number;
  breakdown: TaskBreakdownItem[];
  boxes: InventoryBoxModel[];
}

export const createTask = async (payload: {
  title: string;
  originType?: string;
  originId?: number;
  targetQty: number;
  unit: string;
  dueDate?: string;
  priority?: number;
  comment?: string;
  responsibleId?: number;
  sectionId?: number;
  projectId?: number;
}) => {
  const { data } = await $authHost.post("api/tasks", payload);
  return data as ProductionTask;
};

export const fetchTasks = async (params?: {
  page?: number;
  limit?: number;
  status?: string;
  search?: string;
  originType?: string;
}) => {
  const { data } = await $authHost.get("api/tasks", { params });
  return data as TaskListResponse;
};

export const fetchTaskById = async (id: number) => {
  const { data } = await $authHost.get(`api/tasks/${id}`);
  return data as TaskDetailResponse;
};

export const updateTaskStatus = async (id: number, status: string) => {
  const { data } = await $authHost.patch(`api/tasks/${id}/status`, { status });
  return data as ProductionTask;
};

export const updateTask = async (id: number, payload: any) => {
    const { data } = await $authHost.put(`api/tasks/${id}`, payload);
    return data as ProductionTask;
};

export const deleteTask = async (id: number) => {
    const { data } = await $authHost.delete(`api/tasks/${id}`);
    return data;
};

================================================================================
FILE: QMS-Client-main/src/api/userApi.ts
================================================================================

import { $authHost, $host } from "./index"
import { userModel } from "src/types/UserModel"

export const login = async (login: string, password: string) => {
    const { data } = await $host.post("api/users/login", { login, password })
    localStorage.setItem("token", data.token)
    return data
}

export const registration = async (login: string, password: string, name: string, surname: string) => {
    const { data } = await $host.post("api/users/registration", { login, password, name, surname })
    localStorage.setItem("token", data.token)
    return data
}

export const check = async () => {
    const { data } = await $authHost.get("api/users/auth")
    if (data && data.id) {
        localStorage.setItem("userID", String(data.id))
    }
    return data as userModel
}

export const fetchCurrentUser = async (id: number) => {
    const { data } = await $authHost.get(`api/users/${id}`)
    return data
}

export const updateUser = async (id: number, password: string, name: string, surname: string) => {
    const { data } = await $authHost.put("api/users", { id, password, name, surname })
    return data
}

export const updateUserImg = async (idAndImg: FormData) => {
    const { data } = await $authHost.patch("api/users", idAndImg)
    return data
}

export const deleteUser = async (id: number) => {
    const { data } = await $authHost.delete(`api/users/${id}`)
    return data
}

export const getUsers = async () => {
    const { data } = await $authHost.get("api/users")
    return data
}

export const fetchUsers = async () => {
    const { data } = await $authHost.get("api/users")
    return data
}

export const fetchSession = async () => {
    const { data } = await $authHost.get("api/sessions")
    return data
}

export const fetchPC = async () => {
    const { data } = await $authHost.get("api/pcs")
    return data
}

export const setSessionOnline = async (online: boolean, userId: number, pcId: number | null) => {
    const { data } = await $authHost.post("api/sessions", { online, userId, pcId })
    return data
}

export const createPC = async (ip: string, pc_name: string, cabinet: string) => {
    const { data } = await $authHost.post("api/pcs", { ip, pc_name, cabinet })
    return data
}

export const updatePC = async (id: number, ip: string, pc_name: string, cabinet: string) => {
    const { data } = await $authHost.put(`api/pcs/${id}`, { ip, pc_name, cabinet })
    return data
}

export const deletePC = async (id: number) => {
    const { data } = await $authHost.delete(`api/pcs/${id}`)
    return data
}
================================================================================
FILE: QMS-Client-main/src/api/warehouseApi.ts
================================================================================

import { $authHost } from "./index";
import {
  SupplyModel,
  InventoryBoxModel,
  WarehouseMovement,
  WarehouseDocument,
  StockBalanceItem
} from "src/types/WarehouseModels";

export type { WarehouseMovement };
export type WarehouseBox = InventoryBoxModel;

export interface SupplyCreateDto {
  supplier?: string;
  docNumber?: string;
  expectedDate?: string;
  comment?: string;
}

export interface BoxCreateDto {
  supplyId: number;
  sectionId: number;
  itemName: string;
  quantity: number;
  unit: string;
  kitNumber?: string;
  comment?: string;
}

export interface CreateBoxesBatchPayload {
  label: string;
  projectName?: string;
  batchName?: string;
  originType?: string;
  originId?: number | null;
  quantity: number;
  itemsPerBox: number;
  unit: string;
  status?: string;
  currentSectionId?: number | null;
  currentTeamId?: number | null;
  notes?: string;
}

export interface FetchBoxesParams {
  page?: number;
  limit?: number;
  search?: string;
  batchName?: string;
  projectName?: string;
  originType?: string;
  status?: string;
  sectionId?: number;
  teamId?: number;
  supplyId?: number;
}

export interface MoveBoxPayload {
  boxId: number;
  toSectionId?: number | null;
  toTeamId?: number | null;
  operation: string;
  statusAfter?: string;
  comment?: string;
  goodQty?: number;
  scrapQty?: number;
  deltaQty?: number;
}

export interface BatchMovePayload {
    movements: Array<{
        boxId: number;
        operation: string;
        toSectionId?: number | null;
        toTeamId?: number | null;
        statusAfter?: string;
        deltaQty?: number;
        goodQty?: number;
        scrapQty?: number;
        comment?: string;
    }>;
    documentData?: {
        createNew: boolean;
        number?: string;
        type?: string;
        comment?: string;
        documentId?: number;
    };
}

export interface FetchDocumentsParams {
  page?: number;
  limit?: number;
  search?: string;
  type?: string;
  boxId?: number;
  dateFrom?: string;
  dateTo?: string;
}

export interface CreateDocumentPayload {
  boxId?: number | null;
  number: string;
  type?: string;
  date?: string;
  fileUrl?: string;
  comment?: string;
}

export interface InventoryLimitModel {
    id: number;
    label: string;
    originType?: string;
    originId?: number;
    minQuantity: number;
}

export interface StockAlertModel {
    id: number;
    label: string;
    min: number;
    current: number;
    deficit: number;
}

export interface RankingResponse {
    users: {
        id: number;
        name: string;
        surname: string;
        teamName: string;
        avatar: string | null;
        output: number;
        defects: number;
        efficiency: number;
        place: number;
    }[];
    teams: {
        id: number;
        title: string;
        section: string;
        teamLead: string;
        totalOutput: number;
        avgEfficiency: number;
        progress: number;
        membersCount: number;
    }[];
}


export const createSupply = async (data: SupplyCreateDto): Promise<SupplyModel> => {
  const { data: response } = await $authHost.post('api/warehouse/supplies', data);
  return response;
};

export const fetchSupplies = async (): Promise<SupplyModel[]> => {
  const { data } = await $authHost.get('api/warehouse/supplies');
  return data;
};

export const createBox = async (data: BoxCreateDto): Promise<InventoryBoxModel> => {
  const { data: response } = await $authHost.post('api/warehouse/boxes/single', data);
  return response;
};

export const createBoxesBatch = async (payload: CreateBoxesBatchPayload) => {
  const { data } = await $authHost.post("api/warehouse/boxes/batch", payload);
  return data as { boxes: InventoryBoxModel[] };
};

export const updateBoxesBatch = async (ids: number[], updates: Partial<InventoryBoxModel>) => {
    const { data } = await $authHost.put("api/warehouse/boxes/batch", { ids, updates });
    return data;
};

export const fetchBoxes = async (params: FetchBoxesParams): Promise<any> => {
  const { data } = await $authHost.get("api/warehouse/boxes", { params });
  if (Array.isArray(data)) return data;
  return data as { rows: InventoryBoxModel[]; count: number; page: number; limit: number };
};

export const fetchBoxById = async (id: number) => {
  const { data } = await $authHost.get(`api/warehouse/boxes/${id}`);
  return data as {
    box: InventoryBoxModel;
    movements: WarehouseMovement[];
    documents: WarehouseDocument[];
  };
};

export const fetchBoxByQr = async (qrCode: string) => {
  const encoded = encodeURIComponent(qrCode);
  const { data } = await $authHost.get(`api/warehouse/boxes/by-qr/${encoded}`);
  return data as {
    box: InventoryBoxModel;
    movements: WarehouseMovement[];
    documents: WarehouseDocument[];
  };
};


export const fetchStockBalance = async () => {
    const { data } = await $authHost.get("api/warehouse/balance");
    return data as StockBalanceItem[];
};


export const fetchDashboardStats = async () => {
    const { data } = await $authHost.get("api/warehouse/analytics/dashboard");
    return data;
};

export const fetchAlerts = async () => {
    const { data } = await $authHost.get("api/warehouse/alerts");
    return data as StockAlertModel[];
};

export const fetchAllLimits = async () => {
    const { data } = await $authHost.get("api/warehouse/limits");
    return data as InventoryLimitModel[];
};

export const saveLimit = async (payload: { label: string, min: number, originType?: string, originId?: number }) => {
    const { data } = await $authHost.post("api/warehouse/limits", payload);
    return data;
};


export const moveBox = async (payload: MoveBoxPayload) => {
  const { data } = await $authHost.post("api/warehouse/movements", payload);
  return data as { box: InventoryBoxModel; movement: WarehouseMovement };
};

export const moveBoxesBatch = async (payload: BatchMovePayload) => {
    const { data } = await $authHost.post("api/warehouse/movements/batch", payload);
    return data;
};


export const downloadBoxesExcel = async (ids: number[]) => {
  const { data } = await $authHost.post(
    "api/warehouse/boxes/export",
    { ids },
    { responseType: 'blob' }
  );
  const url = window.URL.createObjectURL(new Blob([data]));
  const link = document.createElement('a');
  link.href = url;
  const date = new Date().toISOString().split('T')[0];
  link.setAttribute('download', `labels_export_${date}.csv`);
  document.body.appendChild(link); link.click(); link.remove();
};

export const printBoxesPdf = async (ids: number[]) => {
  const { data } = await $authHost.post(
    "api/warehouse/boxes/print-pdf",
    { ids },
    { responseType: 'blob' }
  );
  const url = window.URL.createObjectURL(new Blob([data], { type: 'application/pdf' }));
  const link = document.createElement('a');
  link.href = url;
  const date = new Date().toISOString().split('T')[0];
  link.setAttribute('download', `labels_print_${date}.pdf`);
  document.body.appendChild(link); link.click(); link.remove();
};

export const printSpecialLabel = async (data: any) => {
  const response = await $authHost.post("api/warehouse/boxes/print-special", data, {
    responseType: 'blob'
  });

  const url = window.URL.createObjectURL(new Blob([response.data], { type: 'application/pdf' }));

  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = url;
  document.body.appendChild(iframe);

  iframe.onload = () => {
      iframe.contentWindow?.print();
  };
};


export const fetchPrintHistory = async (params: {
    page?: number;
    limit?: number;
    search?: string;
    template?: string;
    dateFrom?: string;
    dateTo?: string;
}) => {
    const { data } = await $authHost.get("api/warehouse/print-history", { params });
    return data as { rows: any[]; count: number; page: number; limit: number };
};


export const fetchDocuments = async (params: FetchDocumentsParams) => {
  const { data } = await $authHost.get("api/warehouse/documents", { params });
  return data as { rows: WarehouseDocument[]; count: number; page: number; limit: number };
};

export const createDocument = async (payload: CreateDocumentPayload) => {
  const { data } = await $authHost.post("api/warehouse/documents", payload);
  return data as WarehouseDocument;
};

export const exportLabelsCsv = async (supplyId: number): Promise<Blob> => {
  const { data } = await $authHost.get(`api/warehouse/supplies/${supplyId}/export-csv`, {
    responseType: 'blob',
  });
  return data;
};

export const fetchRankings = async (period: 'day' | 'week' | 'month') => {
    const { data } = await $authHost.get("api/warehouse/rankings", {
        params: { period }
    });
    return data as RankingResponse;
};

================================================================================
FILE: QMS-Client-main/src/components/AppRouter.tsx
================================================================================

import { useContext } from "react";
import { Navigate, Route, Routes, useLocation } from "react-router-dom";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import { adminRoutes, authRoutes, publicRoutes, qmsRoutes } from "src/routes";
import { START_ROUTE } from "src/utils/consts";
import QmsLayout from "src/components/qms/QmsLayout";

export const AppRouter: React.FC = observer(() => {
  const context = useContext(Context);
  const location = useLocation();

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { user } = context;

  return (
    <div key={location.pathname} className="animate-slide-in-up w-full h-full">
      <Routes>
        {user.isAuth && user.can('admin.access') &&
          adminRoutes.map(({ path, Component }) => {
              if (path.includes('/users') && !user.can('users.manage')) return null;
              if (path.includes('/warehouse') && !user.can('warehouse.manage')) return null;
              return <Route key={path} path={path} element={<Component />} />;
          })
        }

        {}
        {user.isAuth && (
          <Route path="/qms" element={<QmsLayout />}>
            {qmsRoutes.map(({ path, Component }) => (
              <Route
                key={path}
                index={path === "/qms"}
                path={path === "/qms" ? undefined : path.replace("/qms/", "")}
                element={<Component />}
              />
            ))}
          </Route>
        )}

        {user.isAuth &&
          authRoutes.map(({ path, Component }) => {
              if (path.includes('/warehouse') && !user.can('warehouse.view')) return null;
              return <Route key={path} path={path} element={<Component />} />;
          })
        }

        {publicRoutes.map(({ path, Component }) => (
          <Route key={path} path={path} element={<Component />} />
        ))}

        <Route path="*" element={<Navigate to={START_ROUTE} />} />
      </Routes>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/components/Footer/Footer.tsx
================================================================================

import Logo from "assets/images/logo.svg";
import PhoneIcon from "assets/icons/Phone.svg";
import MailIcon from "assets/icons/mail.svg";
import LogoVK from "assets/icons/logoVK.svg";
import LogoYT from "assets/icons/logoYOUT.svg";

export const Footer: React.FC = () => {
  return (
    <div className="flex justify-between items-center px-8 py-4 bg-asvo-dark border-t border-asvo-dark-3/50 text-asvo-muted">
      <div className="flex items-center">
        <img src={Logo} alt="Logo" className="h-6 mr-2" />
        <div>
          <div className="text-asvo-light text-sm font-medium">© 2018-2025 ASVO-QMS</div>
        </div>
      </div>

      <div className="flex flex-col items-center text-sm">
        <div className="flex items-center mb-1">
          <img src={PhoneIcon} alt="Phone" className="h-4 mr-2 opacity-60" />
          <div>+7 (499) 455 04 13</div>
        </div>
        <div className="flex items-center">
          <img src={MailIcon} alt="Mail" className="h-4 mr-2 opacity-60" />
          <div className="text-asvo-accent">info@asvo-qms.ru</div>
        </div>
      </div>

      <div className="flex items-center">
        <img src={LogoVK} alt="VK" className="h-8 mr-4 opacity-60 hover:opacity-100 transition-opacity" />
        <img src={LogoYT} alt="YouTube" className="h-8 opacity-60 hover:opacity-100 transition-opacity" />
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/Header/DateTimeDisplay.tsx
================================================================================

import { useState, useEffect } from 'react';

export const DateTimeDisplay = () => {
  const [currentTime, setCurrentTime] = useState(new Date());

  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);

    return () => clearInterval(timer);
  }, []);


  const formatDate = (date: Date) => {
    return date.toLocaleDateString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  };

  const formatTime = (date: Date) => {
    return date.toLocaleTimeString('ru-RU', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
  };

  return (
    <div className="flex flex-col items-end justify-center">
      <div className="text-xl font-semibold text-asvo-accent tracking-wide">
        {formatDate(currentTime)}
      </div>
      <div className="text-sm text-asvo-muted font-medium bg-asvo-dark-2 px-2 py-1 rounded-md">
        {formatTime(currentTime)}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/Header/Header.tsx
================================================================================


import React, { useContext, Fragment, useState, useEffect, useRef } from "react";
import Logo from "assets/images/logo.svg";
import { NavLink, useLocation } from "react-router-dom";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import { useAppAuth as useAuth } from "src/hooks/useAppAuth";
import { Menu, Transition } from "@headlessui/react";
import { setSessionOnline } from "src/api/userApi";
import { DateTimeDisplay } from "./DateTimeDisplay";
import clsx from "clsx";


import {
  Shield, ShieldCheck, Archive,
  ClipboardList, User, LogOut,
  ChevronDown, FileText, AlertTriangle, ClipboardCheck, BarChart3, LayoutDashboard,
  Truck, GraduationCap, Wrench,
} from "lucide-react";


import {
  ADMIN_ROUTE,
  WAREHOUSE_ROUTE, TASKS_ROUTE,
  PROFILE_ROUTE,
  QMS_DASHBOARD_ROUTE, DOCUMENTS_ROUTE, NC_ROUTE, CAPA_ROUTE,
  RISKS_ROUTE, SUPPLIERS_ROUTE, INTERNAL_AUDITS_ROUTE,
  TRAINING_ROUTE, EQUIPMENT_ROUTE, REVIEW_ROUTE,
} from "src/utils/consts";

type NavItem = {
  label: string;
  icon: React.ElementType;
  to?: string;
  permissions?: string[];
  children?: { label: string; to: string; icon?: React.ElementType }[];
};


export const HEADER_HEIGHT = 56;

export const Header: React.FC = observer(() => {
  const auth = useAuth();
  const context = useContext(Context);
  const _location = useLocation();

  if (!context) throw new Error("Context required");
  const { user, modules } = context;


  const [isVisible, setIsVisible] = useState(true);
  const [isAtTop, setIsAtTop] = useState(true);
  const lastScrollY = useRef(0);
  const scrollThreshold = 10;

  useEffect(() => {
    const handleScroll = () => {
      const currentScrollY = window.scrollY;


      setIsAtTop(currentScrollY < 5);


      const scrollDiff = currentScrollY - lastScrollY.current;

      if (Math.abs(scrollDiff) < scrollThreshold) {
        return;
      }

      if (scrollDiff > 0 && currentScrollY > HEADER_HEIGHT) {

        setIsVisible(false);
      } else {

        setIsVisible(true);
      }

      lastScrollY.current = currentScrollY;
    };

    window.addEventListener("scroll", handleScroll, { passive: true });
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);


  const logOut = async () => {
    try {
      const userId = Number(localStorage.getItem("userID"));
      const pcId = localStorage.getItem("pcID");
      const pcIdNum = pcId === "PERSONAL" ? null : Number(pcId);
      if (userId) await setSessionOnline(false, userId, pcIdNum);
    } catch (error) { console.error(error); }

    user.resetUser();
    localStorage.clear();
    sessionStorage.clear();
    await auth.signoutRedirect({ post_logout_redirect_uri: window.location.origin });
  };


  const navigation: NavItem[] = [
    {
      label: "Задачи",
      icon: ClipboardList,
      to: TASKS_ROUTE,
    },
    
    ...(modules.hasGroup('qms') ? [{
      label: "Качество",
      icon: ShieldCheck,
      children: [
        modules.isEnabled('qms.dashboard') ? { label: "Дашборд", to: QMS_DASHBOARD_ROUTE, icon: BarChart3 } : null,
        modules.isEnabled('qms.dms')       ? { label: "Документы", to: DOCUMENTS_ROUTE, icon: FileText } : null,
        modules.isEnabled('qms.nc')        ? { label: "Несоответствия", to: NC_ROUTE, icon: AlertTriangle } : null,
        modules.isEnabled('qms.capa')      ? { label: "CAPA", to: CAPA_ROUTE, icon: ClipboardCheck } : null,
        modules.isEnabled('qms.risk')      ? { label: "Риски", to: RISKS_ROUTE, icon: Shield } : null,
        modules.isEnabled('qms.supplier')  ? { label: "Поставщики", to: SUPPLIERS_ROUTE, icon: Truck } : null,
        modules.isEnabled('qms.audit')     ? { label: "Аудиты", to: INTERNAL_AUDITS_ROUTE, icon: ClipboardCheck } : null,
        modules.isEnabled('qms.training')  ? { label: "Обучение", to: TRAINING_ROUTE, icon: GraduationCap } : null,
        modules.isEnabled('qms.equipment') ? { label: "Оборудование", to: EQUIPMENT_ROUTE, icon: Wrench } : null,
        modules.isEnabled('qms.review')    ? { label: "Анализ руководства", to: REVIEW_ROUTE, icon: BarChart3 } : null,
      ].filter(Boolean) as { label: string; to: string; icon?: React.ElementType }[],
    } as NavItem] : []),
    
    ...(modules.hasGroup('wms') ? [{
      label: "Склад",
      icon: Archive,
      to: WAREHOUSE_ROUTE,
      permissions: ["warehouse.view"],
    }] : []),
    
    {
      label: "Админ",
      icon: Shield,
      to: ADMIN_ROUTE,
      permissions: ["admin.access"],
    },
  ];


  const visibleNav = navigation.filter(item => {
      if (!item.permissions) return true;
      return item.permissions.some(p => user.can(p));
  });

  return (
    <div
      className={clsx(
        "fixed top-0 left-0 right-0 z-50 h-14",
        "bg-asvo-dark/95 backdrop-blur-sm border-b border-asvo-dark-3/50 shadow-sm",
        "transition-transform duration-300 ease-in-out",
        !isVisible && "-translate-y-full",
        isAtTop && "shadow-none"
      )}
    >
      <div className="max-w-[1920px] mx-auto px-4 h-full flex justify-between items-center">

        <div className="flex items-center gap-6 min-w-max">
          <NavLink to="/" className="flex items-center gap-2 group">
            <img src={Logo} alt="Logo" className="h-7 w-auto group-hover:opacity-80 transition-opacity" />
            <span className="text-lg font-bold text-asvo-accent tracking-tight leading-none">
              ASVO-QMS
            </span>
          </NavLink>
          <div className="h-6 w-px bg-asvo-dark-3 hidden lg:block"></div>
        </div>

        {auth.isAuthenticated && (
          <nav className="hidden lg:flex items-center gap-1">
            {visibleNav.map((item, idx) => (
              <Fragment key={idx}>
                {item.children ? (
                  <Menu as="div" className="relative">
                    <Menu.Button className={({ open }) => clsx(
                        "flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all outline-none",
                        open ? "bg-asvo-dark-2 text-asvo-accent" : "text-asvo-muted hover:bg-asvo-dark-2 hover:text-asvo-light"
                    )}>
                      <item.icon size={16} />
                      <span>{item.label}</span>
                      <ChevronDown size={12} className="opacity-50" />
                    </Menu.Button>
                    <Transition
                      as={Fragment}
                      enter="transition ease-[cubic-bezier(0.16,1,0.3,1)] duration-200"
                      enterFrom="transform opacity-0 scale-95 -translate-y-2"
                      enterTo="transform opacity-100 scale-100 translate-y-0"
                      leave="transition ease-in duration-150"
                      leaveFrom="transform opacity-100 scale-100 translate-y-0"
                      leaveTo="transform opacity-0 scale-95 -translate-y-2"
                    >
                      <Menu.Items className="absolute left-0 mt-2 w-56 origin-top-left divide-y divide-asvo-dark-3/30 rounded-lg bg-asvo-dark-2 shadow-lg ring-1 ring-asvo-dark-3/50 focus:outline-none z-50">
                        <div className="p-1">
                          {item.children.map((sub, sIdx) => (
                            <Menu.Item key={sIdx}>
                              {({ active }) => (
                                <NavLink
                                  to={sub.to}
                                  className={clsx(
                                    "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm",
                                    active ? "bg-asvo-dark-3/50 text-asvo-accent font-medium" : "text-asvo-muted hover:bg-asvo-dark-3/30"
                                  )}
                                >
                                  {sub.icon && <sub.icon size={14} className={active ? "text-asvo-accent" : "text-asvo-muted"} />}
                                  {sub.label}
                                </NavLink>
                              )}
                            </Menu.Item>
                          ))}
                        </div>
                      </Menu.Items>
                    </Transition>
                  </Menu>
                ) : (
                  <NavLink
                    to={item.to!}
                    className={({ isActive }) => clsx(
                        "flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-all",
                        isActive
                          ? "bg-asvo-dark-2 text-asvo-accent font-bold"
                          : "text-asvo-muted hover:bg-asvo-dark-2 hover:text-asvo-light"
                    )}
                  >
                    <item.icon size={16} />
                    <span>{item.label}</span>
                  </NavLink>
                )}
              </Fragment>
            ))}
          </nav>
        )}

        <div className="flex items-center gap-4 min-w-max">
          {modules.config?.tier === 'dev-all' && (
            <span className="text-[10px] px-2 py-0.5 rounded-full bg-yellow-900/30 border border-yellow-700/50 text-yellow-400">
              DEV — все модули
            </span>
          )}
          <div className="hidden xl:block text-right">
             <DateTimeDisplay />
          </div>

          {auth.isAuthenticated ? (
            <Menu as="div" className="relative ml-2">
                <Menu.Button className="flex items-center gap-2 pl-2 pr-1 py-1 rounded-full hover:bg-asvo-dark-2 transition border border-transparent hover:border-asvo-dark-3 group outline-none">
                    <div className="flex flex-col items-end leading-none mr-1">
                        <span className="text-xs font-bold text-asvo-light">{user.user?.surname} {user.user?.name?.[0]}.</span>
                        <span className="text-[10px] text-asvo-muted">{user.user?.role}</span>
                    </div>
                    <div className="h-8 w-8 rounded-full bg-asvo-dark-3 overflow-hidden ring-2 ring-asvo-dark-2 shadow-sm">
                         {user.user?.img
                            ? <img src={`${import.meta.env.VITE_API_URL}/${user.user.img}`} alt="" className="h-full w-full object-cover"/>
                            : <div className="h-full w-full flex items-center justify-center text-asvo-accent font-bold text-xs">{user.user?.name?.[0]}</div>
                         }
                    </div>
                </Menu.Button>

                <Transition
                  as={Fragment}
                  enter="transition ease-out duration-100"
                  enterFrom="transform opacity-0 scale-95"
                  enterTo="transform opacity-100 scale-100"
                  leave="transition ease-in duration-75"
                  leaveFrom="transform opacity-100 scale-100"
                  leaveTo="transform opacity-0 scale-95"
                >
                  <Menu.Items className="absolute right-0 mt-2 w-48 origin-top-right divide-y divide-asvo-dark-3/30 rounded-lg bg-asvo-dark-2 shadow-lg ring-1 ring-asvo-dark-3/50 focus:outline-none z-50">
                    <div className="p-1">
                      <Menu.Item>
                        {({ active }) => (
                          <NavLink
                            to={PROFILE_ROUTE}
                            className={clsx(
                              "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm",
                              active ? "bg-asvo-dark-3/50 text-asvo-accent" : "text-asvo-muted"
                            )}
                          >
                            <User size={14} />
                            Профиль
                          </NavLink>
                        )}
                      </Menu.Item>
                    </div>
                    <div className="p-1">
                      <Menu.Item>
                        {({ active }) => (
                          <button
                            onClick={logOut}
                            className={clsx(
                              "flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm",
                              active ? "bg-red-900/30 text-red-400" : "text-asvo-muted"
                            )}
                          >
                            <LogOut size={14} />
                            Выйти
                          </button>
                        )}
                      </Menu.Item>
                    </div>
                  </Menu.Items>
                </Transition>
            </Menu>
          ) : null}
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/components/Modal/ConfirmModal.tsx
================================================================================

import React from "react";

export interface ConfirmModalProps {
  isOpen?: boolean;
  title?: string;
  title1?: string;
  message?: string;
  onConfirm?: () => void;
  onCancel?: () => void;
  actionConfirm?: () => void;
  onClose?: () => void;
  confirmText?: string;
  cancelText?: string;
  confirmColor?: "red" | "green" | "blue";
}

export const ConfirmModal: React.FC<ConfirmModalProps> = ({
  isOpen,
  title = "Подтверждение",
  title1,
  message = "Вы уверены?",
  onConfirm,
  onCancel,
  actionConfirm,
  onClose,
  confirmText = "✅ ДА",
  cancelText = "❌ Отмена",
  confirmColor = "green"
}) => {
  const handleConfirm = actionConfirm || onConfirm || (() => {});
  const handleCancel = onClose || onCancel || (() => {});

  if (!isOpen) return null;

  const confirmColorClasses = {
    red: "bg-red-600 hover:bg-red-700",
    green: "bg-emerald-600 hover:bg-emerald-700",
    blue: "bg-blue-600 hover:bg-blue-700"
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">

      <div
        className="absolute inset-0 bg-black/50"
        onClick={handleCancel}
      />


      <div className="relative bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
        <div className="flex flex-col items-center justify-center text-center">
          {(title1 || title) && (
            <h2 className="text-xl font-bold text-gray-800">{title1 || title}</h2>
          )}
          {message && (
            <p className="text-gray-600 mt-2">{message}</p>
          )}
          <div className="flex justify-center gap-4 mt-6 w-full">
            <button
              type="button"
              className={`flex-1 ${confirmColorClasses[confirmColor]} text-white py-3 rounded-lg transition font-semibold shadow-lg`}
              onClick={handleConfirm}
            >
              {confirmText}
            </button>
            <button
              type="button"
              className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg"
              onClick={handleCancel}
            >
              {cancelText}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ConfirmModal;

================================================================================
FILE: QMS-Client-main/src/components/Modal/Modal.tsx
================================================================================


import React, { useEffect } from "react";

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
  title?: string;
  size?: string;
}

const SIZE_CLASSES: Record<string, string> = {
  sm: "max-w-sm",
  md: "max-w-md",
  lg: "max-w-lg",
  xl: "max-w-xl",
  "2xl": "max-w-2xl",
  "3xl": "max-w-3xl",
  "4xl": "max-w-4xl",
  "5xl": "max-w-5xl",
};

export const Modal: React.FC<ModalProps> = ({ isOpen, onClose, children, title, size }) => {

  useEffect(() => {
    if (!isOpen) return;

    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === "Escape") {
        onClose();
      }
    };

    document.addEventListener("keydown", handleKeyDown);


    document.body.style.overflow = "hidden";

    return () => {
      document.removeEventListener("keydown", handleKeyDown);
      document.body.style.overflow = "";
    };
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50"
      onClick={onClose}
    >
      <div
        className={`bg-asvo-surface border border-asvo-border rounded-2xl p-6 w-full ${size ? SIZE_CLASSES[size] || "max-w-lg" : "max-w-lg"} relative max-h-[90vh] overflow-y-auto animate-scale-in`}
        onClick={(e) => e.stopPropagation()}
      >
        <button
          className="absolute top-3 right-3 text-asvo-text-dim hover:text-asvo-text text-2xl transition-colors"
          onClick={onClose}
        >
          &times;
        </button>

        {title && (
          <h2 className="text-xl font-semibold text-asvo-text mb-4 pr-8">{title}</h2>
        )}

        {children}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/common/Preloader.tsx
================================================================================

export const Preloader: React.FC = () => {
  return (
    <div className="flex justify-center items-center h-64">
      <div className="w-8 h-8 border-4 border-t-4 border-red-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/common/PreloaderMini.tsx
================================================================================

export const PreloaderMini: React.FC = () => {
  return (
    <div className="w-full h-full">
      <div className="w-8 h-8 border-4 border-t-4 border-red-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/components/qms/ActionBtn.tsx
================================================================================

import React from "react";

interface ActionBtnProps {
  children: React.ReactNode;
  variant?: "primary" | "secondary";
  color?: string;
  icon?: React.ReactNode;
  onClick?: () => void;
  className?: string;
}

const ActionBtn: React.FC<ActionBtnProps> = ({
  children, variant = "primary", color, icon, onClick, className = "",
}) => {
  if (variant === "primary") {
    return (
      <button
        onClick={onClick}
        className={`flex items-center gap-1.5 px-4 py-2 bg-asvo-accent text-asvo-bg font-bold rounded-lg text-[13px] transition-all hover:shadow-[0_2px_12px_rgba(45,212,168,0.3)] ${className}`}
      >
        {icon}{children}
      </button>
    );
  }
  return (
    <button
      onClick={onClick}
      className={`flex items-center gap-1.5 px-4 py-2 border rounded-lg text-[13px] font-medium transition-all hover:bg-asvo-surface-2 ${className}`}
      style={color ? { borderColor: `${color}44`, color } : { borderColor: "#1A2D4244", color: "#8899AB" }}
    >
      {icon}{children}
    </button>
  );
};

export default ActionBtn;

================================================================================
FILE: QMS-Client-main/src/components/qms/Avatar.tsx
================================================================================

import React from "react";

type AvatarSize = "sm" | "md" | "lg";
type AvatarColor = "accent" | "blue" | "purple" | "amber" | "red" | "green" | "orange";

interface AvatarProps {
  name: string;
  color?: AvatarColor;
  size?: AvatarSize;
}

const SIZE_MAP: Record<AvatarSize, { container: string; text: string }> = {
  sm: { container: "w-6 h-6", text: "text-[9px]" },
  md: { container: "w-7 h-7", text: "text-[10px]" },
  lg: { container: "w-9 h-9", text: "text-[12px]" },
};

const COLOR_MAP: Record<AvatarColor, { bg: string; border: string; text: string }> = {
  accent: { bg: "bg-[#2DD4A8]/15", border: "border-[#2DD4A8]/35", text: "text-[#2DD4A8]" },
  blue:   { bg: "bg-[#4A90E8]/15", border: "border-[#4A90E8]/35", text: "text-[#4A90E8]" },
  purple: { bg: "bg-[#A06AE8]/15", border: "border-[#A06AE8]/35", text: "text-[#A06AE8]" },
  amber:  { bg: "bg-[#E8A830]/15", border: "border-[#E8A830]/35", text: "text-[#E8A830]" },
  red:    { bg: "bg-[#F06060]/15", border: "border-[#F06060]/35", text: "text-[#F06060]" },
  green:  { bg: "bg-[#2DD4A8]/15", border: "border-[#2DD4A8]/35", text: "text-[#2DD4A8]" },
  orange: { bg: "bg-[#E87040]/15", border: "border-[#E87040]/35", text: "text-[#E87040]" },
};

function getInitials(name: string): string {
  const parts = name.trim().split(/\s+/);
  if (parts.length >= 2) {
    return `${parts[0][0] || ""}${parts[1][0] || ""}`.toUpperCase();
  }
  return (parts[0]?.[0] || "?").toUpperCase();
}

const Avatar: React.FC<AvatarProps> = ({ name, color = "accent", size = "sm" }) => {
  const s = SIZE_MAP[size];
  const c = COLOR_MAP[color] || COLOR_MAP.accent;

  return (
    <div
      className={`${s.container} rounded-full ${c.bg} border-[1.5px] ${c.border} flex items-center justify-center shrink-0`}
      title={name}
    >
      <span className={`${s.text} ${c.text} font-bold leading-none`}>
        {getInitials(name)}
      </span>
    </div>
  );
};

export default Avatar;

================================================================================
FILE: QMS-Client-main/src/components/qms/Badge.tsx
================================================================================

import React from "react";

type BadgeVariant =
  | "nc" | "capa" | "risk" | "audit" | "training" | "sop"
  | "closed" | "product" | "component" | "custom";

interface BadgeProps {
  variant?: BadgeVariant;
  children: React.ReactNode;
  color?: string;
  bg?: string;
}

const VARIANT_STYLES: Record<string, string> = {
  nc:        "bg-[rgba(240,96,96,0.12)] text-[#F06060] border-[#F06060]/30",
  capa:      "bg-[rgba(232,168,48,0.12)] text-[#E8A830] border-[#E8A830]/30",
  risk:      "bg-[rgba(160,106,232,0.12)] text-[#A06AE8] border-[#A06AE8]/30",
  audit:     "bg-[rgba(74,144,232,0.12)] text-[#4A90E8] border-[#4A90E8]/30",
  training:  "bg-[rgba(54,181,224,0.12)] text-[#36B5E0] border-[#36B5E0]/30",
  sop:       "bg-[rgba(45,212,168,0.12)] text-[#2DD4A8] border-[#2DD4A8]/30",
  closed:    "bg-[rgba(58,78,98,0.15)] text-[#3A4E62] border-[#3A4E62]/30",
  product:   "bg-[rgba(224,104,144,0.12)] text-[#E06890] border-[#E06890]/30",
  component: "bg-[rgba(58,78,98,0.15)] text-[#8899AB] border-[#3A4E62]/30",
};

const Badge: React.FC<BadgeProps> = ({ variant = "closed", children, color, bg }) => {
  const cls = VARIANT_STYLES[variant] || VARIANT_STYLES.closed;
  return (
    <span
      className={`inline-flex items-center rounded-xl text-[11px] font-semibold px-2.5 py-0.5 leading-none ${!color ? cls : ""}`}
      style={color ? { backgroundColor: bg || `${color}22`, color } : undefined}
    >
      {children}
    </span>
  );
};

export default Badge;

================================================================================
FILE: QMS-Client-main/src/components/qms/Card.tsx
================================================================================

import React from "react";

interface CardProps {
  children: React.ReactNode;
  className?: string;
  onClick?: () => void;
}

const Card: React.FC<CardProps> = ({ children, className = "", onClick }) => (
  <div
    className={`bg-asvo-surface-2 border border-asvo-border rounded-xl p-4 ${onClick ? "cursor-pointer hover:bg-asvo-surface-3 transition-colors" : ""} ${className}`}
    onClick={onClick}
  >
    {children}
  </div>
);

export default Card;

================================================================================
FILE: QMS-Client-main/src/components/qms/DataTable.tsx
================================================================================

import React from "react";

interface Column<T> {
  key: string;
  label: string;
  width?: string;
  render?: (row: T, index: number) => React.ReactNode;
  align?: "left" | "center" | "right";
}

interface DataTableProps<T> {
  columns: Column<T>[];
  data: T[];
  onRowClick?: (row: T) => void;
}

function DataTable<T extends Record<string, unknown>>({
  columns,
  data,
  onRowClick,
}: DataTableProps<T>) {
  return (
    <div className="bg-asvo-surface border border-asvo-border rounded-xl overflow-hidden">
      <table className="w-full">
        <thead className="sticky top-0 bg-asvo-surface z-10">
          <tr className="border-b border-asvo-border">
            {columns.map((col) => (
              <th
                key={col.key}
                className={`px-3 py-2.5 text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider ${
                  col.align === "center" ? "text-center" : col.align === "right" ? "text-right" : "text-left"
                }`}
                style={col.width ? { width: col.width } : undefined}
              >
                {col.label}
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {data.length === 0 ? (
            <tr>
              <td colSpan={columns.length} className="text-center py-10 text-[13px] text-asvo-text-dim">
                Нет данных
              </td>
            </tr>
          ) : (
            data.map((row, i) => (
              <tr
                key={i}
                className={`border-b border-asvo-border/50 hover:bg-asvo-surface-3 transition-colors text-[13px] ${
                  onRowClick ? "cursor-pointer" : ""
                }`}
                onClick={() => onRowClick?.(row)}
              >
                {columns.map((col) => (
                  <td
                    key={col.key}
                    className={`px-3 py-2.5 ${
                      col.align === "center" ? "text-center" : col.align === "right" ? "text-right" : "text-left"
                    }`}
                  >
                    {col.render
                      ? col.render(row, i)
                      : (row[col.key] as React.ReactNode) ?? "—"}
                  </td>
                ))}
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  );
}

export default DataTable;

================================================================================
FILE: QMS-Client-main/src/components/qms/KpiRow.tsx
================================================================================

import React from "react";
import StatCard from "./StatCard";

interface KpiItem {
  label: string;
  value: string | number;
  icon?: React.ReactNode;
  color?: string;
}

interface KpiRowProps {
  items: KpiItem[];
}

const KpiRow: React.FC<KpiRowProps> = ({ items }) => (
  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-5">
    {items.map((item, i) => (
      <StatCard key={i} label={item.label} value={item.value} icon={item.icon} color={item.color} />
    ))}
  </div>
);

export default KpiRow;

================================================================================
FILE: QMS-Client-main/src/components/qms/ProgressBar.tsx
================================================================================

import React from "react";

type BarColor = "accent" | "amber" | "red" | "blue" | "purple" | "green";

interface ProgressBarProps {
  value: number;
  color?: BarColor;
}

const GRADIENT_MAP: Record<BarColor, string> = {
  accent: "from-[#2DD4A8]/50 to-[#2DD4A8]",
  green:  "from-[#2DD4A8]/50 to-[#2DD4A8]",
  amber:  "from-[#E8A830]/50 to-[#E8A830]",
  red:    "from-[#F06060]/50 to-[#F06060]",
  blue:   "from-[#4A90E8]/50 to-[#4A90E8]",
  purple: "from-[#A06AE8]/50 to-[#A06AE8]",
};

const ProgressBar: React.FC<ProgressBarProps> = ({ value, color = "accent" }) => {
  const clamped = Math.max(0, Math.min(100, value));
  return (
    <div className="h-1 bg-asvo-bg rounded-full overflow-hidden">
      <div
        className={`h-full rounded-full bg-gradient-to-r ${GRADIENT_MAP[color] || GRADIENT_MAP.accent} transition-all duration-300`}
        style={{ width: `${clamped}%` }}
      />
    </div>
  );
};

export default ProgressBar;

================================================================================
FILE: QMS-Client-main/src/components/qms/QmsLayout.tsx
================================================================================

import React from "react";
import { NavLink, Outlet } from "react-router-dom";
import {
  LayoutDashboard,
  FileText,
  AlertTriangle,
  RefreshCw,
  Target,
  Factory,
  ClipboardList,
  GraduationCap,
  Wrench,
  Users,
} from "lucide-react";

const SIDEBAR_ITEMS = [
  { label: "Дашборд",         to: "/qms",             icon: LayoutDashboard },
  { label: "Документы",       to: "/qms/documents",   icon: FileText },
  { label: "Несоответствия",  to: "/qms/nonconformity", icon: AlertTriangle },
  { label: "CAPA",            to: "/qms/capa",        icon: RefreshCw },
  { label: "Риски",           to: "/qms/risks",       icon: Target },
  { label: "Поставщики",      to: "/qms/suppliers",   icon: Factory },
  { label: "Аудиты",          to: "/qms/audits",      icon: ClipboardList },
  { label: "Обучение",        to: "/qms/training",    icon: GraduationCap },
  { label: "Оборудование",    to: "/qms/equipment",   icon: Wrench },
  { label: "Анализ руководства", to: "/qms/review",   icon: Users },
];

const QmsLayout: React.FC = () => (
  <div className="flex h-[calc(100vh-56px)] bg-asvo-bg">
    {}
    <aside className="w-[220px] shrink-0 bg-[#0C161F] border-r border-asvo-border overflow-y-auto">
      <div className="py-3">
        {SIDEBAR_ITEMS.map((item) => (
          <NavLink
            key={item.to}
            to={item.to}
            end={item.to === "/qms"}
            className={({ isActive }) =>
              `flex items-center gap-3 px-4 py-2.5 text-[13px] transition-all border-l-[3px] ${
                isActive
                  ? "bg-asvo-accent-dim text-asvo-accent font-semibold border-asvo-accent"
                  : "text-asvo-text-dim border-transparent hover:text-asvo-text-mid hover:bg-asvo-surface/50"
              }`
            }
          >
            <item.icon size={16} />
            <span>{item.label}</span>
          </NavLink>
        ))}
      </div>
    </aside>

    {}
    <main className="flex-1 overflow-y-auto">
      <Outlet />
    </main>
  </div>
);

export default QmsLayout;

================================================================================
FILE: QMS-Client-main/src/components/qms/SectionTitle.tsx
================================================================================

import React from "react";

interface SectionTitleProps {
  children: React.ReactNode;
  action?: React.ReactNode;
}

const SectionTitle: React.FC<SectionTitleProps> = ({ children, action }) => (
  <div className="flex items-center justify-between mb-3">
    <h3 className="text-sm font-semibold text-asvo-text">{children}</h3>
    {action && <div>{action}</div>}
  </div>
);

export default SectionTitle;

================================================================================
FILE: QMS-Client-main/src/components/qms/StatCard.tsx
================================================================================

import React from "react";

interface StatCardProps {
  label: string;
  value: string | number;
  icon?: React.ReactNode;
  color?: string;
}

const StatCard: React.FC<StatCardProps> = ({ label, value, icon, color = "#2DD4A8" }) => (
  <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-4">
    <div className="flex items-center gap-2 mb-2">
      {icon && <span style={{ color }} className="opacity-70">{icon}</span>}
    </div>
    <div className="text-2xl font-bold" style={{ color }}>{value}</div>
    <div className="text-xs text-asvo-text-dim mt-1">{label}</div>
  </div>
);

export default StatCard;

================================================================================
FILE: QMS-Client-main/src/components/qms/StatusDot.tsx
================================================================================

import React from "react";

type DotColor = "red" | "amber" | "accent" | "purple" | "blue" | "grey" | "orange" | "green";

interface StatusDotProps {
  color: DotColor;
  className?: string;
}

const COLOR_MAP: Record<DotColor, { bg: string; shadow: string }> = {
  red:    { bg: "bg-[#F06060]", shadow: "shadow-[0_0_6px_rgba(240,96,96,0.4)]" },
  amber:  { bg: "bg-[#E8A830]", shadow: "shadow-[0_0_6px_rgba(232,168,48,0.4)]" },
  accent: { bg: "bg-[#2DD4A8]", shadow: "shadow-[0_0_6px_rgba(45,212,168,0.4)]" },
  green:  { bg: "bg-[#2DD4A8]", shadow: "shadow-[0_0_6px_rgba(45,212,168,0.4)]" },
  purple: { bg: "bg-[#A06AE8]", shadow: "shadow-[0_0_6px_rgba(160,106,232,0.4)]" },
  blue:   { bg: "bg-[#4A90E8]", shadow: "shadow-[0_0_6px_rgba(74,144,232,0.4)]" },
  grey:   { bg: "bg-[#3A4E62]", shadow: "shadow-[0_0_6px_rgba(58,78,98,0.4)]" },
  orange: { bg: "bg-[#E87040]", shadow: "shadow-[0_0_6px_rgba(232,112,64,0.4)]" },
};

const StatusDot: React.FC<StatusDotProps> = ({ color, className = "" }) => {
  const c = COLOR_MAP[color] || COLOR_MAP.grey;
  return (
    <span className={`inline-block w-2 h-2 rounded-full ${c.bg} ${c.shadow} ${className}`} />
  );
};

export default StatusDot;

================================================================================
FILE: QMS-Client-main/src/components/qms/TabBar.tsx
================================================================================

import React from "react";

interface Tab {
  key: string;
  label: string;
}

interface TabBarProps {
  tabs: Tab[];
  active: string;
  onChange: (key: string) => void;
}

const TabBar: React.FC<TabBarProps> = ({ tabs, active, onChange }) => (
  <div className="flex gap-1 border-b border-asvo-border mb-4">
    {tabs.map((t) => (
      <button
        key={t.key}
        onClick={() => onChange(t.key)}
        className={`px-4 py-2 text-[13px] font-medium transition-all border-b-2 -mb-px ${
          active === t.key
            ? "bg-asvo-accent-dim text-asvo-accent border-asvo-accent font-semibold"
            : "text-asvo-text-dim border-transparent hover:text-asvo-text-mid"
        }`}
      >
        {t.label}
      </button>
    ))}
  </div>
);

export default TabBar;

================================================================================
FILE: QMS-Client-main/src/components/qms/Timeline.tsx
================================================================================

import React from "react";

interface TimelineEvent {
  date: string;
  title: string;
  desc?: string;
  color?: string;
}

interface TimelineProps {
  events: TimelineEvent[];
}

const Timeline: React.FC<TimelineProps> = ({ events }) => (
  <div className="relative pl-6">
    <div className="absolute left-[7px] top-2 bottom-2 w-0.5 bg-asvo-border" />
    {events.map((ev, i) => (
      <div key={i} className="relative mb-4 last:mb-0">
        <div
          className="absolute -left-6 top-1 w-3 h-3 rounded-full border-2 border-asvo-surface-2"
          style={{ backgroundColor: ev.color || "#2DD4A8" }}
        />
        <div className="text-[10px] text-asvo-text-dim mb-0.5">{ev.date}</div>
        <div className="text-[13px] font-medium text-asvo-text">{ev.title}</div>
        {ev.desc && <div className="text-xs text-asvo-text-mid mt-0.5">{ev.desc}</div>}
      </div>
    ))}
  </div>
);

export default Timeline;

================================================================================
FILE: QMS-Client-main/src/hooks/useAppAuth.ts
================================================================================

import { useAuth as useOidcAuth } from "react-oidc-context";

const AUTH_MODE = import.meta.env.VITE_AUTH_MODE || 'keycloak';

const devAuth = {
  isAuthenticated: true,
  isLoading: false,
  user: {
    access_token: 'dev-bypass-token',
    profile: {
      sub: 'dev-user-001',
      preferred_username: 'developer',
      given_name: 'Dev',
      family_name: 'User',
      realm_access: { roles: ['SUPER_ADMIN'] },
    },
  },
  signinRedirect: () => Promise.resolve(),
  signoutRedirect: () => {
    window.location.href = '/';
    return Promise.resolve();
  },
  error: null,
};

export function useAppAuth() {
  if (AUTH_MODE === 'dev-bypass') {
    return devAuth as any;
  }
  return useOidcAuth();
}

================================================================================
FILE: QMS-Client-main/src/index.css
================================================================================


@font-face {
  font-family: 'GOST type A';
  src: url('/fonts/GOST-type-A.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: 'GOST type B';
  src: url('/fonts/GOST-type-B.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}


@tailwind base;
@tailwind components;
@tailwind utilities;


::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: #1A2D42;
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
  background: #1E3A54;
}


.kanban-scroll::-webkit-scrollbar {
  width: 4px;
}
.kanban-scroll::-webkit-scrollbar-track {
  background: transparent;
}
.kanban-scroll::-webkit-scrollbar-thumb {
  background: #1A2D42;
  border-radius: 2px;
}
.kanban-scroll::-webkit-scrollbar-thumb:hover {
  background: #1E3A54;
}


@media print {
  .print-area {
    page-break-inside: avoid;
  }

  
  .no-print {
    display: none !important;
  }
}

================================================================================
FILE: QMS-Client-main/src/main.tsx
================================================================================

import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App.tsx";
import "./index.css";
import { BrowserRouter } from "react-router-dom";
import { AuthProvider } from "react-oidc-context";
import UserStore from "./store/UserStore.ts";
import StructureStore from "./store/StructureStore.ts";
import ModuleStore from "./store/ModuleStore.ts";


interface IContext {
  user: UserStore;
  structureStore: StructureStore;
  modules: ModuleStore;
}

export const Context = React.createContext<IContext | null>(null);


const REDIRECT_PATH_KEY = "qms_redirect_path";


const saveCurrentPath = () => {
  const currentPath = window.location.pathname + window.location.search;


  const hasOidcParams = window.location.search.includes('code=') ||
                        window.location.search.includes('state=');

  if (currentPath !== "/" &&
      !currentPath.includes("/login") &&
      !hasOidcParams) {
    sessionStorage.setItem(REDIRECT_PATH_KEY, currentPath);
  }
};


export const getSavedPath = (): string | null => {
  return sessionStorage.getItem(REDIRECT_PATH_KEY);
};


export const clearSavedPath = () => {
  sessionStorage.removeItem(REDIRECT_PATH_KEY);
};


saveCurrentPath();


const oidcConfig = {
  authority: `${import.meta.env.VITE_KEYCLOAK_URL || 'http://localhost:8080'}/realms/${import.meta.env.VITE_KEYCLOAK_REALM || 'QMS-Realm'}`,
  client_id: import.meta.env.VITE_KEYCLOAK_CLIENT_ID || 'qms-web-client',
  redirect_uri: window.location.origin + "/",
  post_logout_redirect_uri: window.location.origin + "/",
  response_type: "code",
  onSigninCallback: () => {
    const savedPath = getSavedPath();
    window.history.replaceState({}, document.title, savedPath || "/");
  }
};


const AUTH_MODE = import.meta.env.VITE_AUTH_MODE || 'keycloak';

const AuthWrapper = ({ children }: { children: React.ReactNode }) => {
  if (AUTH_MODE === 'dev-bypass') {
    return <>{children}</>;
  }
  return <AuthProvider {...oidcConfig}>{children}</AuthProvider>;
};

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <Context.Provider
      value={{
        user: new UserStore(),
        structureStore: new StructureStore(),
        modules: new ModuleStore(),
      }}
    >
      <BrowserRouter>
        <AuthWrapper>
          <App />
        </AuthWrapper>
      </BrowserRouter>
    </Context.Provider>
  </React.StrictMode>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPCs/AdminEditPC.tsx
================================================================================

import { useState } from "react";
import { updatePC } from "src/api/userApi";

interface AdminEditPCProps {
  updatePCList: () => void;
  PCname: string;
  IP: string;
  Cabinet: string;
  ID: number;
}

export const AdminEditPC: React.FC<AdminEditPCProps> = ({
  updatePCList,

  IP,
  PCname,
  Cabinet,
  ID,
}) => {
  const [ip, SetIp] = useState(IP);
  const [pc_name, SetPc_name] = useState(PCname);
  const [cabinet, SetCabinet] = useState(Cabinet);

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const editPC = async () => {
    try {
      await updatePC(ID, ip, pc_name, cabinet);

      SetIp("");
      SetPc_name("");
      SetCabinet("");
      setSuccessMessage("Компьютер успешно изменен");
      setErrorMessage("");
      updatePCList();
    } catch (error: any) {
      setErrorMessage(
        `Произошла ошибка при изменении. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">Изменить компьютер</h2>
      <form>
        <input
          type="text"
          placeholder="Имя компьютера"
          className="w-full p-2 border rounded-lg mb-2"
          value={pc_name}
          onChange={(e) => SetPc_name(e.target.value)}
        />
        <input
          type="text"
          placeholder="IP-адрес"
          className="w-full p-2 border rounded-lg mb-2"
          value={ip}
          onChange={(e) => SetIp(e.target.value)}
        />
        <input
          type="text"
          placeholder="Кабинет"
          className="w-full p-2 border rounded-lg mb-2"
          value={cabinet}
          onChange={(e) => SetCabinet(e.target.value)}
        />
        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          Изменить
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">Вы уверены?</h2>
            <p className="text-gray-600 mt-2">Изменить этот компьютер?</p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  editPC();
                  setConfirm(false);
                }}
              >
                ✅ Да, изменить
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ❌ Отмена
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPCs/AdminOnePC.tsx
================================================================================

import { Pencil, Trash2 } from "lucide-react";
import { useState } from "react";
import { Modal } from "src/components/Modal/Modal";
import { AdminEditPC } from "./AdminEditPC";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";

interface OnePCProps {
  deleteComputer: () => void;
  updatePCList: () => void;
  PCname: string;
  IP: string;
  cabinet: string;
  ID: number;
}

export const AdminOnePC: React.FC<OnePCProps> = ({
  deleteComputer,
  updatePCList,
  PCname,
  IP,
  cabinet,
  ID,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  return (
    <div className="bg-white p-4 rounded-lg shadow-lg border-l-4 border-blue-500 transition duration-300 hover:shadow-xl relative">
      <h3 className="text-xl font-bold text-gray-800 mb-2">Имя пк: {PCname}</h3>
      <p className="text-gray-600">
        <span className="font-semibold">IP:</span> {IP}
      </p>
      <p className="text-gray-600">
        <span className="font-semibold">Кабинет:</span> {cabinet}
      </p>


      <div className="absolute top-4 right-4 flex space-x-2">
        <button
          onClick={() => openModal("computerEdit")}
          className="p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition"
        >
          <Pencil size={18} />
        </button>
        <button
          className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition"
          onClick={() => openModal("computerDelete")}
        >
          <Trash2 size={18} />
        </button>
      </div>

      <Modal isOpen={modalType === "computerDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`Удалить компьютер ${PCname} ?`}
          actionConfirm={deleteComputer}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "computerEdit"} onClose={closeModal}>
        <AdminEditPC
          ID={ID}
          PCname={PCname}
          IP={IP}
          Cabinet={cabinet}
          updatePCList={updatePCList}
        />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPCs/AdminPCs.tsx
================================================================================

import { useEffect, useState } from "react";
import { deletePC, fetchPC } from "src/api/userApi";
import { AdminOnePC } from "./AdminOnePC";
import { pcModelFull } from "src/types/PCModel";

export const AdminPCs: React.FC = () => {
  const [pcs, setPcs] = useState<pcModelFull[]>([]);

  const updatePCList = async () => {
    fetchPC().then((data) => setPcs(data));
  };

  useEffect(() => {
    updatePCList();
  }, []);

  const deleteComputer = async (id: number) => {
    try {
      await deletePC(id);
      updatePCList()
    } catch (error: any) {
      console.error("Ошибка при удалении компа:", error);
    }
  };

  let PCs = pcs.map((el: pcModelFull) => (
    <AdminOnePC
      deleteComputer={() => deleteComputer(el.id)}
      updatePCList = {()=> updatePCList()}
      key={el.id}
      ID={el.id}
      PCname={el.pc_name}
      IP={el.ip}
      cabinet={el.cabinet}
    />
  ));

  return (
    <div className="p-4  bg-gray-100/80 shadow-lg rounded-lg h-screen overflow-y-auto">
      <h2 className="text-xl font-bold text-gray-900 mb-4 border-b-2 pb-2">
        Список ПК
      </h2>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
        {PCs}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminPanel.tsx
================================================================================

import React, { useState, useContext } from "react";
import { observer } from "mobx-react-lite";
import { useNavigate } from "react-router-dom";
import clsx from "clsx";

import { Context } from "src/main";

import {
  Shield,
  Users,
  Network,
  Package,
  History,
  Plus,
  ArrowUpRight,
  Settings,
  Blocks,
} from "lucide-react";

import { CreatePC } from "./CreateModals/CreatePC";
import { Modal } from "src/components/Modal/Modal";

import {
  ADMIN_RBAC_ROUTE,
  ADMIN_USERS_ROUTE,
  STRUCTURE_ROUTE,
  AUDIT_LOG_ROUTE,
  ADMIN_WAREHOUSE_ROUTE,
  ADMIN_MODULES_ROUTE,
} from "src/utils/consts";

import {
  CREATE_COMPUTER,
} from "src/utils/constsModalType";


interface BentoItemProps {
  title: string;
  subtitle?: string;
  icon: React.ElementType;
  link: string;
  className?: string;
  colorClass?: string;
  iconColorClass?: string;
  onAdd?: () => void;
}

const BentoItem: React.FC<BentoItemProps> = ({
  title,
  subtitle,
  icon: Icon,
  link,
  className,
  colorClass = "bg-white hover:border-indigo-300",
  iconColorClass = "text-indigo-600 bg-indigo-50",
  onAdd,
}) => {
  const navigate = useNavigate();

  return (
    <div
      onClick={() => navigate(link)}
      className={clsx(
        "relative p-6 rounded-3xl border border-transparent shadow-sm transition-all duration-300 cursor-pointer group overflow-hidden flex flex-col justify-between hover:shadow-xl hover:-translate-y-1",
        colorClass,
        className
      )}
    >
      <div className="absolute -right-6 -top-6 w-24 h-24 bg-current opacity-5 rounded-full pointer-events-none group-hover:scale-150 transition-transform duration-500" />

      <div className="flex justify-between items-start z-10">
        <div className={clsx("p-3 rounded-2xl", iconColorClass)}>
          <Icon size={28} strokeWidth={1.5} />
        </div>
        <div className="p-2 rounded-full text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity">
          <ArrowUpRight size={20} />
        </div>
      </div>

      <div className="mt-4 z-10">
        <h3 className="text-xl font-bold tracking-tight mb-1">{title}</h3>
        {subtitle && (
          <p className="text-sm opacity-70 font-medium leading-tight">
            {subtitle}
          </p>
        )}
      </div>

      {onAdd && (
        <button
          onClick={(e) => {
            e.stopPropagation();
            onAdd();
          }}
          className="absolute bottom-4 right-4 p-2 bg-white/90 backdrop-blur-sm border border-slate-200 rounded-xl text-slate-600 shadow-sm hover:bg-indigo-600 hover:text-white hover:border-indigo-600 transition-all z-20"
          title="Быстрое создание"
        >
          <Plus size={20} />
        </button>
      )}
    </div>
  );
};


export const AdminPanel: React.FC = observer(() => {
  const { user } = useContext(Context)!;
  const navigate = useNavigate();
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  const canManageUsers =
    user.can("users.manage") || user.can("admin.users_manage");

  return (
    <div className="p-6 max-w-[1600px] mx-auto min-h-screen">
      <div className="mb-8">
        <h1 className="text-4xl font-extrabold text-slate-900 tracking-tight">
          Центр управления
        </h1>
        <p className="text-slate-500 mt-2 text-lg">
          Администрирование системы менеджмента качества
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 auto-rows-[180px]">
        {(canManageUsers || user.can("rbac.manage")) && (
          <div className="md:col-span-2 row-span-2 bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden group shadow-2xl">
            <div className="absolute top-0 right-0 w-96 h-96 bg-indigo-500 rounded-full blur-[100px] opacity-20 -mr-20 -mt-20 pointer-events-none" />

            <div className="relative z-10 flex flex-col h-full justify-between">
              <div className="flex justify-between items-start">
                <div className="p-4 bg-white/10 backdrop-blur-md rounded-2xl border border-white/10">
                  <Shield size={40} className="text-emerald-400" />
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => openModal(CREATE_COMPUTER)}
                    className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-xl text-sm font-bold transition backdrop-blur-sm border border-white/5"
                  >
                    + ПК
                  </button>
                </div>
              </div>

              <div>
                <h2 className="text-3xl font-bold mb-2">Безопасность</h2>
                <p className="text-slate-400 mb-6 max-w-md">
                  Управление ролевой моделью (RBAC), пользователями и рабочими станциями.
                </p>

                <div className="flex gap-3 flex-wrap">
                  <button
                    onClick={() => navigate(ADMIN_RBAC_ROUTE)}
                    className="flex items-center gap-2 px-5 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold transition shadow-lg shadow-indigo-900/50"
                  >
                    <Settings size={18} /> Доступ (RBAC)
                  </button>
                  <button
                    onClick={() => navigate(ADMIN_USERS_ROUTE)}
                    className="flex items-center gap-2 px-5 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold transition"
                  >
                    <Users size={18} /> Пользователи
                  </button>
                  <button
                    onClick={() => navigate(AUDIT_LOG_ROUTE)}
                    className="flex items-center gap-2 px-5 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl font-bold transition"
                  >
                    <History size={18} /> Аудит
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {user.can("admin.structure_manage") && (
          <BentoItem
            title="Структура"
            subtitle="Цеха, участки и бригады"
            icon={Network}
            link={STRUCTURE_ROUTE}
            className="md:col-span-2"
            colorClass="bg-gradient-to-br from-indigo-50 to-blue-50 border border-blue-100 hover:shadow-lg"
            iconColorClass="bg-blue-100 text-blue-600"
          />
        )}

        {user.can("warehouse.manage") && (
          <BentoItem
            title="WMS Склад"
            subtitle="Поставки и хранение"
            icon={Package}
            link={ADMIN_WAREHOUSE_ROUTE}
            colorClass="bg-white border-slate-200 hover:border-emerald-400"
            iconColorClass="bg-emerald-50 text-emerald-600"
          />
        )}

        {(canManageUsers || user.can("rbac.manage")) && (
          <BentoItem
            title="Модули"
            subtitle="Тариф и активные модули"
            icon={Blocks}
            link={ADMIN_MODULES_ROUTE}
            colorClass="bg-gradient-to-br from-violet-50 to-purple-50 border border-purple-100 hover:shadow-lg"
            iconColorClass="bg-purple-100 text-purple-600"
          />
        )}
      </div>

      <Modal isOpen={modalType === CREATE_COMPUTER} onClose={closeModal}>
        <CreatePC />
      </Modal>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminUsers/AdminEditUser.tsx
================================================================================

import { UserIcon } from "lucide-react";
import { ChangeEvent, useEffect, useState } from "react";
import { fetchCurrentUser, updateUser, updateUserImg } from "src/api/userApi";

interface AdminEditUserModel {
  updateUsersList: () => void;
  ID: number;
}

export const AdminEditUser: React.FC<AdminEditUserModel> = ({
  updateUsersList,
  ID,
}) => {
  const [currentUser, setCurrentUser] = useState({
    id: 0,
    login: "",
    password: "",
    role: "",
    name: "",
    surname: "",
    createdAt: "",
    updatedAt: "",
    img: "",
  });

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [isAvatarEditVisible, setAvatarEditVisible] = useState(false);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleAvatarUpload = async () => {
    if (!selectedFile) {
      alert("Пожалуйста, выберите файл для загрузки");
      return;
    }

    const formData = new FormData();
    formData.append("id", String(currentUser.id));
    formData.append("img", selectedFile);

    try {
      await updateUserImg(formData);
      setAvatarEditVisible(false);
      setSuccessMessage("успешно изменено");
      setErrorMessage("");
      refetchUser();
      updateUsersList()
    } catch (error: any) {
      setErrorMessage(
        `Произошла ошибка при загрузке изображения. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("Ошибка при изменении:", error);
    }
  };

  const refetchUser = () => {
    fetchCurrentUser(ID).then((data) => setCurrentUser(data));
  };

  useEffect(() => {
    fetchCurrentUser(ID).then((data) => setCurrentUser(data));
  }, []);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setCurrentUser((prevUser) => ({
      ...prevUser,
      [name]: value,
    }));
  };

  const handleSave = async () => {
    try {
      await updateUser(
        currentUser.id,
        currentUser.password,
        currentUser.name,
        currentUser.surname
      );
      setSuccessMessage("успешно изменено");
      setErrorMessage("");
      refetchUser();
      updateUsersList();
    } catch (error: any) {
      setErrorMessage(
        `Произошла ошибка при изменении. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("Ошибка при изменении:", error);
    }
  };

  return (
    <div className="p-8 max-w-2xl mx-auto bg-gradient-to-br from-blue-50 to-purple-50 shadow-2xl rounded-3xl transform transition-all">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 text-center">
        Профиль пользователя
      </h1>


      <div className="flex flex-col items-center mb-8">
        <div className="relative w-32 h-32 rounded-full overflow-hidden shadow-lg border-4 border-white hover:border-purple-500 transition-all duration-300">
          {currentUser.img ? (
            <img
              src={import.meta.env.VITE_API_URL + "/" + currentUser.img}
              alt=""
              className="w-full h-full object-cover"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center bg-blue-50">
              <UserIcon className="text-blue-600 w-16 h-16" />
            </div>
          )}
        </div>
      </div>


      {isAvatarEditVisible ? (
        <div className="flex flex-col items-center mb-8">
          <input
            type="file"
            onChange={handleFileChange}
            className="mb-4 p-2 bg-white rounded-lg shadow-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={handleAvatarUpload}
          >
            Загрузить аватар
          </button>
        </div>
      ) : (
        <div className="flex justify-center mb-8">
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={() => setAvatarEditVisible(true)}
          >
            Изменить аватар
          </button>
        </div>
      )}


      <div className="space-y-6 bg-white p-8 rounded-2xl shadow-xl">

        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">Логин:</span>{" "}
          <span className="text-gray-900">{currentUser.login}</span>
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">Пароль:</span>{" "}
          <input
            type="password"
            name="password"
            value={currentUser.password}
            onChange={handleInputChange}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">Роль:</span>{" "}
          <span className="text-gray-900">{currentUser.role}</span>
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">Имя:</span>{" "}
          <input
            name="name"
            value={currentUser.name}
            onChange={handleInputChange}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </p>


        <p className="text-lg text-gray-700">
          <span className="font-bold text-purple-600">Фамилия:</span>{" "}
          <input
            name="surname"
            value={currentUser.surname}
            onChange={handleInputChange}
            className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </p>
      </div>


      <div className="mt-8 flex justify-center space-x-4">
        <button
          onClick={handleSave}
          className="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
        >
          Сохранить
        </button>
        <button
          onClick={() => {
            refetchUser();
          }}
          className="bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
        >
          Отмена
        </button>
      </div>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminUsers/AdminOneUser.tsx
================================================================================

import {
  UserIcon,
  ShieldCheck,
  MonitorDot,
  User,
  Pencil,
  Trash2,
} from "lucide-react";
import { useState } from "react";
import { ConfirmModal } from "src/components/Modal/ConfirmModal";
import { Modal } from "src/components/Modal/Modal";
import { AdminEditUser } from "./AdminEditUser";

interface AdminOneUserProps {
  updateUsersList: () => void;
  deleteUser: () => void;
  ID: number;
  login: string;
  role: string;
  name: string;
  surName: string;
  img: string | null;
  active: boolean;
  pcName: string | undefined;
  pcIP: string | undefined;
}

export const AdminOneUser: React.FC<AdminOneUserProps> = ({
  updateUsersList,
  deleteUser,
  ID,
  login,
  role,
  name,
  surName,
  img,
  active,
  pcName,
  pcIP,
}) => {
  const [modalType, setModalType] = useState<string | null>(null);

  const openModal = (type: string) => setModalType(type);
  const closeModal = () => setModalType(null);

  return (
    <div className="bg-white shadow-md rounded-xl p-4 flex items-center gap-4 border-l-4 border-blue-500 transition duration-300 hover:shadow-lg overflow-hidden flex-wrap relative">

      {img ? (
        <div className="relative w-24 h-24 rounded-full overflow-hidden shadow-2xl border-4 border-white hover:border-purple-500 transition-all duration-300 transform hover:scale-105 group">
          <img
            src={import.meta.env.VITE_API_URL + "/" + img}
            alt="Аватар пользователя"
            className="w-full h-full object-cover"
          />
        </div>
      ) : (
        <div className="bg-gradient-to-br from-blue-100 to-purple-100 p-3 rounded-full w-24 h-24 flex items-center justify-center shadow-lg transform transition-all hover:scale-105 duration-300">
          <UserIcon className="text-blue-600 w-12 h-12" />
        </div>
      )}


      <div className="flex-1">
        <h3 className="text-2xl font-bold text-gray-900">
          {name} {surName}
        </h3>
        <p className="text-gray-600 text-sm mt-1">{login}</p>
      </div>


      {active ? (
        <div className="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-full shadow-sm">
          <div className="relative">
            <MonitorDot className="text-green-600 w-6 h-6" />

            <div className="absolute inset-0 flex items-center justify-center">
              <div className="w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
            </div>
          </div>
          <p className="text-sm font-medium text-green-800">
            {pcName} ({pcIP}) – Online
          </p>
        </div>
      ) : (
        <div className="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-full shadow-sm">
          <MonitorDot className="text-red-600 w-6 h-6" />
          <p className="text-sm font-medium text-red-800">Offline</p>
        </div>
      )}


      <div className="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-purple-50 px-4 py-2 rounded-full shadow-sm">
        {role === "ADMIN" ? (
          <ShieldCheck className="text-green-600 w-6 h-6" />
        ) : (
          <User className="text-blue-600 w-6 h-6" />
        )}
        <span className="text-gray-700 font-medium">{role}</span>
      </div>


      <div className="absolute top-4 right-4 flex space-x-2 z-10">
        <button
          onClick={() => openModal("userEdit")}
          className="p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition transform hover:scale-110"
        >
          <Pencil size={18} />
        </button>
        <button
          className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition transform hover:scale-110"
          onClick={() => openModal("userDelete")}
        >
          <Trash2 size={18} />
        </button>
      </div>

      <Modal isOpen={modalType === "userDelete"} onClose={closeModal}>
        <ConfirmModal
          title1={`Удалить пользователя ${name} ${surName} ?`}
          actionConfirm={deleteUser}
          onClose={closeModal}
        />
      </Modal>

      <Modal isOpen={modalType === "userEdit"} onClose={closeModal}>
        <AdminEditUser ID={ID} updateUsersList={updateUsersList} />
      </Modal>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/AdminUsers/AdminUsers.tsx
================================================================================

import { useEffect, useState } from "react";
import { fetchPC, fetchSession, fetchUsers, deleteUser } from "src/api/userApi";
import { AdminOneUser } from "./AdminOneUser";
import { userGetModel } from "src/types/UserModel";
import { SessionModelFull } from "src/types/SessionModel";
import { pcModelFull } from "src/types/PCModel";

export const AdminUsers: React.FC = () => {
  const [users, setUsers] = useState<userGetModel[]>([]);
  const [sessions, setSessions] = useState<SessionModelFull[]>([]);
  const [pcs, setPcs] = useState<pcModelFull[]>([]);

  const updateUsersList = async () => {
    fetchUsers().then((data) => setUsers(data));
    fetchSession().then((data) => setSessions(data));
    fetchPC().then((data) => setPcs(data));
  };

  useEffect(() => {
    updateUsersList();
  }, []);

  const getActiveSession = () => {
    return sessions.filter(
      (session: SessionModelFull) => session.online === true
    );
  };

  const getUsersOnlineID = () => {
    return (

      getActiveSession().map((session: SessionModelFull) => session.userId)
    );
  };

  const isOnline = (id: number) => {
    return getUsersOnlineID().includes(id);
  };

  const getCurrentPCName = (userId: number) => {
    const currentSession = getActiveSession().find(
      (session) => session.userId === userId
    );
    const currentPC = pcs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    return currentPC;
  };

  const deleteCurrentUser = async (id: number) => {
    try {
      await deleteUser(id);
      updateUsersList();
    } catch (error: any) {
      console.error("Ошибка при удалении юзера:", error);
    }
  };

  let allUsers = users.map((user: userGetModel) => (
    <AdminOneUser
      key={user.id}
      ID={user.id}
      login={user.login}
      role={user.role}
      name={user.name}
      surName={user.surname}
      img={user.img}
      active={isOnline(user.id)}
      pcName={getCurrentPCName(user.id)?.pc_name}
      pcIP={getCurrentPCName(user.id)?.ip}
      updateUsersList={() => updateUsersList()}
      deleteUser={() => deleteCurrentUser(user.id)}
    />
  ));
  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
        📋 Список пользователей
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {allUsers}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Audit/AuditLogPage.tsx
================================================================================

import { useEffect, useMemo, useState } from "react";
import { fetchAuditLogs } from "api/auditApi";
import { Preloader } from "src/components/common/Preloader";
import {
  History, Search, LogIn, Building2, Shield,
  Warehouse, MoreHorizontal,
  Download, RefreshCw
} from "lucide-react";
import { AuditLogModel } from "types/AuditLogModel";
import { fetchUsers } from "src/api/userApi";
import { userGetModel } from "src/types/UserModel";


type AuditTab =
  | "ALL"
  | "SESSIONS"
  | "STRUCTURE"
  | "ACCESS"
  | "WAREHOUSE"
  | "OTHER";


const TABS: { id: AuditTab; label: string; icon: React.ElementType; description: string }[] = [
  { id: "ALL", label: "Все события", icon: History, description: "Все записи журнала" },
  { id: "SESSIONS", label: "Сессии", icon: LogIn, description: "Вход и выход пользователей" },
  { id: "WAREHOUSE", label: "Склад", icon: Warehouse, description: "Складские операции" },
  { id: "STRUCTURE", label: "Структура", icon: Building2, description: "Участки и бригады" },
  { id: "ACCESS", label: "Права", icon: Shield, description: "Роли и разрешения" },
  { id: "OTHER", label: "Прочее", icon: MoreHorizontal, description: "Остальные события" },
];


const ENTITY_TAB_MAP: Record<string, AuditTab> = {
  SESSION: "SESSIONS",

  Section: "STRUCTURE",
  Team: "STRUCTURE",

  Role: "ACCESS",
  Ability: "ACCESS",
  RoleAbility: "ACCESS",

  WarehouseMovement: "WAREHOUSE",
  InventoryBox: "WAREHOUSE",
  Supply: "WAREHOUSE",
  WarehouseDocument: "WAREHOUSE",
  Warehouse: "WAREHOUSE",
  Box: "WAREHOUSE",
};


const ACTION_COLORS: Record<string, string> = {
  CREATE: "bg-green-100 text-green-800",
  CREATED: "bg-green-100 text-green-800",
  UPDATE: "bg-blue-100 text-blue-800",
  UPDATED: "bg-blue-100 text-blue-800",
  DELETE: "bg-red-100 text-red-800",
  DELETED: "bg-red-100 text-red-800",
  SESSION_START: "bg-emerald-100 text-emerald-800",
  SESSION_END: "bg-amber-100 text-amber-800",
  SESSION_DELETE: "bg-red-100 text-red-800",
  SESSION_AUTO_OFF: "bg-gray-100 text-gray-800",
  SESSION_FORCE_OFF: "bg-orange-100 text-orange-800",
  WAREHOUSE_MOVE: "bg-purple-100 text-purple-800",
  WAREHOUSE_MOVE_BATCH: "bg-purple-100 text-purple-800",
  DEFECT_RESOLVED: "bg-green-100 text-green-800",
  DEFECT_CREATED: "bg-red-100 text-red-800",
  COMPONENT_SYNC: "bg-cyan-100 text-cyan-800",
  EXPORT: "bg-indigo-100 text-indigo-800",
};


export const AuditLogPage: React.FC = () => {
  const [logs, setLogs] = useState<AuditLogModel[]>([]);
  const [page, setPage] = useState(1);
  const [limit] = useState(50);
  const [totalCount, setTotalCount] = useState(0);

  const [dateFrom, setDateFrom] = useState<string>("");
  const [dateTo, setDateTo] = useState<string>("");
  const [actionFilter, setActionFilter] = useState<string>("");
  const [entityFilter, setEntityFilter] = useState<string>("");

  const [searchText, setSearchText] = useState<string>("");
  const [activeTab, setActiveTab] = useState<AuditTab>("ALL");

  const [selectedUserId, setSelectedUserId] = useState<string>("");
  const [users, setUsers] = useState<userGetModel[]>([]);

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);


  useEffect(() => {
    const loadUsers = async () => {
      try {
        const data = await fetchUsers();
        setUsers(data);
      } catch (e) {
        console.error("Не удалось загрузить пользователей для фильтра журнала", e);
      }
    };
    loadUsers();
  }, []);


  useEffect(() => {
    const load = async () => {
      setLoading(true);
      setError(null);
      try {
        const userIdParam =
          selectedUserId && selectedUserId !== "ALL"
            ? Number(selectedUserId)
            : undefined;

        const { count, rows } = await fetchAuditLogs({
          page,
          limit,
          action: actionFilter || undefined,
          entity: entityFilter || undefined,
          dateFrom: dateFrom || undefined,
          dateTo: dateTo || undefined,
          userId: userIdParam,
        });

        setLogs(rows);
        setTotalCount(count);
      } catch (e: any) {
        console.error(e);
        setError(e?.response?.data?.message || "Ошибка загрузки журнала");
      } finally {
        setLoading(false);
      }
    };

    load();
  }, [page, limit, actionFilter, entityFilter, dateFrom, dateTo, selectedUserId]);


  const actions = useMemo(() => {
    const set = new Set<string>();
    logs.forEach((log) => {
      if (log.action) set.add(log.action);
    });
    return Array.from(set).sort();
  }, [logs]);


  const _entities = useMemo(() => {
    const set = new Set<string>();
    logs.forEach((log) => {
      if (log.entity) set.add(log.entity);
    });
    return Array.from(set).sort();
  }, [logs]);


  const totalPages = useMemo(
    () => Math.max(1, Math.ceil(totalCount / limit)),
    [totalCount, limit]
  );


  const getLogTab = (log: AuditLogModel): AuditTab => {
    if (log.entity && ENTITY_TAB_MAP[log.entity]) {
      return ENTITY_TAB_MAP[log.entity];
    }

    if (log.action?.startsWith("SESSION_")) return "SESSIONS";
    if (log.action?.startsWith("WAREHOUSE_")) return "WAREHOUSE";
    return "OTHER";
  };


  const filteredLogs = useMemo(() => {
    const query = searchText.toLowerCase();
    let data = logs;


    if (activeTab !== "ALL") {
      data = data.filter((log) => getLogTab(log) === activeTab);
    }


    if (query) {
      data = data.filter((log) => {
        const description = (log.description || "").toLowerCase();
        const action = (log.action || "").toLowerCase();
        const entity = (log.entity || "").toLowerCase();
        const user = `${log.User?.name || ""} ${log.User?.surname || ""} ${log.User?.login || ""}`
          .trim()
          .toLowerCase();

        return (
          description.includes(query) ||
          action.includes(query) ||
          entity.includes(query) ||
          user.includes(query)
        );
      });
    }

    return data;
  }, [logs, searchText, activeTab]);


  const tabStats = useMemo(() => {
    const stats: Record<AuditTab, number> = {
      ALL: logs.length,
      SESSIONS: 0,
      STRUCTURE: 0,
      ACCESS: 0,
      WAREHOUSE: 0,
      OTHER: 0,
    };

    logs.forEach((log) => {
      const tab = getLogTab(log);
      stats[tab]++;
    });

    return stats;
  }, [logs]);


  const getActionBadgeClass = (action: string): string => {
    if (ACTION_COLORS[action]) return ACTION_COLORS[action];
    if (action.includes("CREATE") || action.includes("ADD")) return ACTION_COLORS.CREATE;
    if (action.includes("UPDATE") || action.includes("EDIT")) return ACTION_COLORS.UPDATE;
    if (action.includes("DELETE") || action.includes("REMOVE")) return ACTION_COLORS.DELETE;
    return "bg-gray-100 text-gray-700";
  };


  const handleExport = () => {
    const headers = ["Время", "Пользователь", "Действие", "Сущность", "Описание"];
    const rows = filteredLogs.map((log) => [
      new Date(log.createdAt).toLocaleString("ru-RU"),
      log.User ? `${log.User.name} ${log.User.surname}` : "Система",
      log.action || "",
      log.entity || "",
      log.description || "",
    ]);

    const csv = [headers, ...rows]
      .map((row) => row.map((cell) => `"${cell}"`).join(","))
      .join("\n");

    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `audit_log_${new Date().toISOString().split("T")[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="px-4 py-6 max-w-[1800px] mx-auto">

      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
            <History className="w-5 h-5 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">Журнал действий</h1>
            <p className="text-sm text-gray-500">Аудит изменений в системе QMS</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={() => window.location.reload()}
            className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
            title="Обновить"
          >
            <RefreshCw className="w-5 h-5" />
          </button>
          <button
            onClick={handleExport}
            className="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
          >
            <Download className="w-4 h-4" />
            Экспорт
          </button>
        </div>
      </div>


      <div className="mb-4 flex flex-wrap gap-2">
        {TABS.map((tab) => {
          const Icon = tab.icon;
          const count = tabStats[tab.id];
          const isActive = activeTab === tab.id;

          return (
            <button
              key={tab.id}
              type="button"
              onClick={() => {
                setActiveTab(tab.id);
                setPage(1);
              }}
              title={tab.description}
              className={[
                "flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium border transition-all",
                isActive
                  ? "bg-blue-600 text-white border-blue-600 shadow-sm"
                  : "bg-white text-gray-600 border-gray-200 hover:bg-gray-50 hover:border-gray-300",
              ].join(" ")}
            >
              <Icon className="w-4 h-4" />
              {tab.label}
              {count > 0 && (
                <span
                  className={[
                    "px-1.5 py-0.5 rounded-full text-xs",
                    isActive ? "bg-blue-500 text-white" : "bg-gray-100 text-gray-600",
                  ].join(" ")}
                >
                  {count}
                </span>
              )}
            </button>
          );
        })}
      </div>


      <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">

          <div className="lg:col-span-2">
            <label className="text-xs font-semibold text-gray-600 mb-1 block">Поиск</label>
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
              <input
                type="text"
                value={searchText}
                onChange={(e) => setSearchText(e.target.value)}
                placeholder="Поиск по описанию, действию, пользователю..."
                className="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">Дата с</label>
            <input
              type="date"
              value={dateFrom}
              onChange={(e) => {
                setDateFrom(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">Дата по</label>
            <input
              type="date"
              value={dateTo}
              onChange={(e) => {
                setDateTo(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">Пользователь</label>
            <select
              value={selectedUserId}
              onChange={(e) => {
                setSelectedUserId(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Все</option>
              {users.map((u) => (
                <option key={u.id} value={u.id}>
                  {u.name} {u.surname}
                </option>
              ))}
            </select>
          </div>


          <div>
            <label className="text-xs font-semibold text-gray-600 mb-1 block">Действие</label>
            <select
              value={actionFilter}
              onChange={(e) => {
                setActionFilter(e.target.value);
                setPage(1);
              }}
              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Все</option>
              {actions.map((a) => (
                <option key={a} value={a}>
                  {a}
                </option>
              ))}
            </select>
          </div>
        </div>
      </div>


      {loading && <Preloader />}


      {error && (
        <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
          <strong>Ошибка:</strong> {error}
        </div>
      )}


      {!loading && (
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div className="overflow-x-auto">
            <table className="min-w-full text-left text-sm">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-40">
                    Время
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-48">
                    Пользователь
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-40">
                    Действие
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase w-36">
                    Сущность
                  </th>
                  <th className="px-4 py-3 text-xs font-semibold text-gray-500 uppercase">
                    Описание
                  </th>
                </tr>
              </thead>
              <tbody>
                {filteredLogs.length === 0 && (
                  <tr>
                    <td colSpan={5} className="px-4 py-12 text-center text-gray-400">
                      <History className="w-12 h-12 mx-auto mb-3 opacity-30" />
                      <p>Нет записей по выбранным фильтрам</p>
                    </td>
                  </tr>
                )}

                {filteredLogs.map((log) => (
                  <tr
                    key={log.id}
                    className="border-b last:border-b-0 hover:bg-gray-50 transition-colors"
                  >
                    <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                      {new Date(log.createdAt).toLocaleString("ru-RU", {
                        day: "2-digit",
                        month: "2-digit",
                        year: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </td>

                    <td className="px-4 py-3 text-sm">
                      {log.User ? (
                        <div>
                          <div className="font-medium text-gray-800">
                            {log.User.name} {log.User.surname}
                          </div>
                          <div className="text-xs text-gray-400">{log.User.login}</div>
                        </div>
                      ) : (
                        <span className="text-gray-400 italic">Система</span>
                      )}
                    </td>

                    <td className="px-4 py-3">
                      <span
                        className={`inline-block px-2 py-1 rounded text-xs font-medium ${getActionBadgeClass(
                          log.action || ""
                        )}`}
                      >
                        {log.action}
                      </span>
                    </td>

                    <td className="px-4 py-3 text-sm text-gray-600">
                      {log.entity && (
                        <span className="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs">
                          {log.entity}
                          {log.entityId && <span className="text-gray-400 ml-1">#{log.entityId}</span>}
                        </span>
                      )}
                    </td>

                    <td className="px-4 py-3 text-sm text-gray-600">
                      {log.description || <span className="text-gray-300 italic">—</span>}


                      {log.metadata && (
                        <div className="mt-1 flex flex-wrap gap-1">
                          {log.metadata.pcName && (
                            <span className="text-xs bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded">
                              ПК: {log.metadata.pcName}
                            </span>
                          )}
                          {log.metadata.ip && (
                            <span className="text-xs bg-gray-50 text-gray-500 px-1.5 py-0.5 rounded">
                              IP: {log.metadata.ip}
                            </span>
                          )}
                          {log.metadata.serverSerial && (
                            <span className="text-xs bg-purple-50 text-purple-600 px-1.5 py-0.5 rounded">
                              S/N: {log.metadata.serverSerial}
                            </span>
                          )}
                          {log.metadata.count !== undefined && (
                            <span className="text-xs bg-amber-50 text-amber-600 px-1.5 py-0.5 rounded">
                              Кол-во: {log.metadata.count}
                            </span>
                          )}
                        </div>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>


          {totalPages > 1 && (
            <div className="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
              <div className="text-sm text-gray-500">
                Показано {filteredLogs.length} из {totalCount} записей
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setPage((p) => Math.max(1, p - 1))}
                  disabled={page === 1}
                  className="px-3 py-1 border border-gray-200 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition-colors"
                >
                  Назад
                </button>
                <span className="text-sm text-gray-600">
                  {page} / {totalPages}
                </span>
                <button
                  onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
                  disabled={page === totalPages}
                  className="px-3 py-1 border border-gray-200 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition-colors"
                >
                  Вперёд
                </button>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default AuditLogPage;

================================================================================
FILE: QMS-Client-main/src/pages/Admin/CreateModals/CreatePC.tsx
================================================================================

import { useState } from "react";
import { createPC } from "src/api/userApi";

export const CreatePC = () => {
  const [ip, SetIp] = useState("");
  const [pc_name, SetPc_name] = useState("");
  const [cabinet, SetCabinet] = useState("");

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [confirm, setConfirm] = useState(false);

  const addPC = async () => {
    try {
      await createPC(ip, pc_name, cabinet);

      SetIp("");
      SetPc_name("");
      SetCabinet("");
      setSuccessMessage("Компьютер успешно добавлен");
      setErrorMessage("");
    } catch (error: any) {
      setErrorMessage(
        `Произошла ошибка при добавлении. ${error.response.data.message}`
      );
      console.log(error.response.data.message);
      setSuccessMessage("");
    }
  };

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">Добавить компьютер</h2>
      <form>
        <input
          type="text"
          placeholder="Имя компьютера"
          className="w-full p-2 border rounded-lg mb-2"
          value={pc_name}
          onChange={(e) => SetPc_name(e.target.value)}
        />
        <input
          type="text"
          placeholder="IP-адрес"
          className="w-full p-2 border rounded-lg mb-2"
          value={ip}
          onChange={(e) => SetIp(e.target.value)}
        />
        <input
          type="text"
          placeholder="Кабинет"
          className="w-full p-2 border rounded-lg mb-2"
          value={cabinet}
          onChange={(e) => SetCabinet(e.target.value)}
        />
        <button
          className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition"
          type="button"
          onClick={() => setConfirm(true)}
        >
          Добавить
        </button>
      </form>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}

      {confirm && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-2xl shadow-2xl w-96 text-center animate-fadeIn">
            <h2 className="text-xl font-bold text-gray-800">Вы уверены?</h2>
            <p className="text-gray-600 mt-2">
              Добавить этот компьютер в базу?
            </p>

            <div className="flex justify-between mt-6">
              <button
                type="button"
                className="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-lg mr-2"
                onClick={() => {
                  addPC();
                  setConfirm(false);
                }}
              >
                ✅ Да, добавить
              </button>
              <button
                type="button"
                className="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-semibold shadow-lg ml-2"
                onClick={() => setConfirm(false)}
              >
                ❌ Отмена
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/AdminCard.tsx
================================================================================

import { NavLink } from "react-router-dom";

type AdminCardProps = {
  image: string | React.ReactNode;
  title: string;
  description: string;
  onAdd?: () => void;
  editLink: string;
};

export const AdminCard = ({
  image,
  title,
  description,
  onAdd,
  editLink,
}: AdminCardProps) => (
  <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer">
    <div className="flex items-center gap-4">
      {typeof image === "string" ? (
        <img src={image} alt={title} className="w-12 h-12" />
      ) : (
        image
      )}
      <div>
        <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
        <p className="text-sm text-gray-600">{description}</p>
      </div>
    </div>
    <div className="mt-4 flex gap-2">
      {onAdd && (
        <button
          className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition"
          onClick={onAdd}
        >
          Добавить
        </button>
      )}
      <NavLink
        to={editLink}
        className="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition"
      >
        Редактировать
      </NavLink>
    </div>
  </div>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/StructureSection.tsx
================================================================================

import React from "react";
import { AdminCard } from "./AdminCard";
import { Network } from "lucide-react";
import { STRUCTURE_ROUTE } from "src/utils/consts";

export const StructureSection: React.FC = () => {
  return (
    <div className="w-full max-w-4xl mt-8">
      <h2 className="text-xl font-semibold text-gray-700 mb-4">Организация производства</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <AdminCard
          image={<Network className="w-12 h-12 text-indigo-600" />}
          title="Структура и Иерархия"
          description="Управление участками, бригадами и назначение ответственных"
          editLink={STRUCTURE_ROUTE}
        />
      </div>
    </div>
  );
};
================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/UsersSection.tsx
================================================================================

import { ADMIN_PCs_ROUTE, ADMIN_USERS_ROUTE, AUDIT_LOG_ROUTE } from "src/utils/consts";
import { AdminCard } from "./AdminCard";
import ComputerImage from "assets/images/pc.png";
import { Users, History } from "lucide-react";
import { CREATE_COMPUTER } from "src/utils/constsModalType";

type UsersSectionProps = {
  openModal: (type: string) => void;
};

export const UsersSection: React.FC<UsersSectionProps> = ({ openModal }) => (
  <div className="w-full max-w-4xl mt-8">
    <h2 className="text-xl font-semibold text-gray-700 mb-4">Пользователи и Контроль</h2>

    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <AdminCard
        image={ComputerImage}
        title="Компьютеры"
        description="Управление ПК"
        onAdd={() => openModal(CREATE_COMPUTER)}
        editLink={ADMIN_PCs_ROUTE}
      />
      <AdminCard
        image={<Users className="w-12 h-12 text-purple-600" />}
        title="Пользователи"
        description="Управление пользователями"
        onAdd={() => alert("возможность отсутсвует, раздел в разработке")}
        editLink={ADMIN_USERS_ROUTE}
      />

      <AdminCard
        image={<History className="w-12 h-12 text-amber-600" />}
        title="Журнал Аудита"
        description="История действий и изменений"
        editLink={AUDIT_LOG_ROUTE}
      />
    </div>
  </div>
);

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Main/WarehouseSection.tsx
================================================================================

import React from "react";
import { AdminCard } from "./AdminCard";
import { Package } from "lucide-react";
import { ADMIN_WAREHOUSE_ROUTE } from "src/utils/consts";

export const WarehouseSection: React.FC = () => {
  return (
    <div className="w-full max-w-4xl mt-8">
      <h2 className="text-xl font-semibold text-gray-700 mb-4">
        Склад и приёмка
      </h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <AdminCard
          image={<Package className="w-12 h-12 text-emerald-600" />}
          title="Приёмка и склад"
          description="Поставки, коробки и этикетки"
          editLink={ADMIN_WAREHOUSE_ROUTE}
        />
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Modules/ModulesPage.tsx
================================================================================

import React, { useContext, useEffect } from 'react';
import { observer } from 'mobx-react-lite';
import { Context } from 'src/main';
import {
  Shield, FileText, Archive, Factory,
  CheckCircle, XCircle, Package, Crown, Globe
} from 'lucide-react';

const GROUP_META: Record<string, { label: string; icon: React.ElementType; color: string }> = {
  core:    { label: 'Ядро',              icon: Shield,        color: 'text-blue-400' },
  qms:     { label: 'Качество (QMS)',    icon: FileText,      color: 'text-teal-400' },
  wms:     { label: 'Склад (WMS)',       icon: Archive,       color: 'text-amber-400' },
  mes:     { label: 'Производство (MES)',icon: Factory,       color: 'text-orange-400' },
  erp:     { label: 'Планирование (ERP)',icon: Package,       color: 'text-purple-400' },
  ru:      { label: 'Российская специфика', icon: Globe,      color: 'text-red-400' },
  premium: { label: 'Premium',           icon: Crown,         color: 'text-yellow-400' },
  addon:   { label: 'Дополнительные',    icon: Package,       color: 'text-gray-400' },
};

export const ModulesPage: React.FC = observer(() => {
  const context = useContext(Context);
  if (!context) throw new Error('Context required');
  const { modules } = context;

  useEffect(() => {
    if (!modules.config) modules.fetchModules();
  }, []);

  if (modules.loading) {
    return <div className="p-6 text-asvo-muted">Загрузка модулей...</div>;
  }

  const config = modules.config!;
  const grouped = new Map<string, typeof config.modules>();

  for (const mod of config.modules) {
    if (!grouped.has(mod.group)) grouped.set(mod.group, []);
    grouped.get(mod.group)!.push(mod);
  }

  return (
    <div className="p-6 max-w-4xl">
      <h1 className="text-xl font-bold text-asvo-light mb-1">Модули системы</h1>
      <p className="text-sm text-asvo-muted mb-6">
        Тариф: <span className="text-asvo-accent font-bold">{modules.tierName}</span>
        {' \u2022 '}
        Активно: {config.enabled.length} из {config.modules.length} модулей
        {' \u2022 '}
        Пользователей: до {config.maxUsers}
      </p>

      <div className="space-y-6">
        {Array.from(grouped.entries()).map(([group, mods]) => {
          const meta = GROUP_META[group] || { label: group, icon: Package, color: 'text-gray-400' };
          const Icon = meta.icon;
          const enabledInGroup = mods.filter(m => m.enabled).length;

          return (
            <div key={group} className="bg-asvo-dark-2 rounded-xl border border-asvo-dark-3/50 p-4">
              <div className="flex items-center gap-2 mb-3">
                <Icon size={18} className={meta.color} />
                <h2 className="text-sm font-bold text-asvo-light">{meta.label}</h2>
                <span className="text-xs text-asvo-muted ml-auto">
                  {enabledInGroup}/{mods.length}
                </span>
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                {mods.map(mod => (
                  <div
                    key={mod.code}
                    className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${
                      mod.enabled
                        ? 'bg-asvo-dark-3/30 text-asvo-light'
                        : 'bg-asvo-dark/50 text-asvo-muted/50'
                    }`}
                  >
                    {mod.enabled
                      ? <CheckCircle size={14} className="text-emerald-400 flex-shrink-0" />
                      : <XCircle size={14} className="text-asvo-dark-3 flex-shrink-0" />
                    }
                    <span className={mod.enabled ? '' : 'line-through'}>{mod.name}</span>
                    <code className="text-[10px] text-asvo-muted/50 ml-auto">{mod.code}</code>
                  </div>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/RBAC/AdminRightsPage.tsx
================================================================================

import React, { useEffect, useState, useMemo } from "react";
import { observer } from "mobx-react-lite";
import {
    fetchAllRoles,
    fetchAllAbilities,
    updateRoleAbilities,
    RoleModel,
    AbilityModel
} from "src/api/rbacApi";
import { fetchUsers } from "src/api/userApi";
import { userGetModel } from "src/types/UserModel";
import {
    Shield, Save, CheckSquare, Square,
    Loader2, Users, Key, Search, User,
    ChevronDown, ChevronRight, X,
    AlertCircle, AlertTriangle
} from "lucide-react";
import toast from "react-hot-toast";


interface AbilityGroup {
    prefix: string;
    label: string;
    abilities: AbilityModel[];
    isExpanded: boolean;
}


const GROUP_LABELS: Record<string, string> = {
    dms: "Документы СМК",
    nc: "Несоответствия",
    capa: "CAPA",
    risk: "Управление рисками",
    supplier: "Поставщики",
    training: "Обучение",
    equipment: "Оборудование",
    review: "Анализ руководства",
    qms: "Аудит QMS",
    rbac: "Права доступа",
    users: "Пользователи",
    warehouse: "Склад",
    labels: "Этикетки",
    analytics: "Аналитика",
    audit: "Журнал аудита",
};


interface KeycloakStatus {
    connected: boolean;
    mode: string;
    message?: string;
    realm?: string;
    url?: string;
    error?: string;
}

export const AdminRightsPage: React.FC = observer(() => {

    const [viewMode, setViewMode] = useState<"USERS" | "MATRIX">("USERS");
    const [loading, setLoading] = useState(false);
    const [kcStatus, setKcStatus] = useState<KeycloakStatus | null>(null);


    const [roles, setRoles] = useState<RoleModel[]>([]);
    const [abilities, setAbilities] = useState<AbilityModel[]>([]);
    const [users, setUsers] = useState<userGetModel[]>([]);


    const [matrix, setMatrix] = useState<Record<number, Set<number>>>({});
    const [originalMatrix, setOriginalMatrix] = useState<Record<number, Set<number>>>({});
    const [savingId, setSavingId] = useState<number | null>(null);
    const [savingAll, setSavingAll] = useState(false);


    const [userSearch, setUserSearch] = useState("");
    const [abilitySearch, setAbilitySearch] = useState("");


    const [expandedGroups, setExpandedGroups] = useState<Set<string>>(new Set());
    const [compactMode, setCompactMode] = useState(false);


    useEffect(() => {
        loadData();
        loadKeycloakStatus();
    }, []);

    const loadKeycloakStatus = async () => {
        try {
            const { $authHost } = await import("src/api/index");
            const { data } = await $authHost.get("api/rbac/keycloak/status");
            setKcStatus(data);
        } catch {
            
        }
    };

    const loadData = async () => {
        setLoading(true);
        try {
            const [rolesData, abilitiesData, usersData] = await Promise.all([
                fetchAllRoles(),
                fetchAllAbilities(),
                fetchUsers()
            ]);

            setRoles(rolesData);
            setAbilities(abilitiesData);
            setUsers(usersData);


            const initialMatrix: Record<number, Set<number>> = {};
            rolesData.forEach(role => {
                const abilityIds = new Set(role.abilities.map(a => a.id));
                initialMatrix[role.id] = abilityIds;
            });
            setMatrix(initialMatrix);
            setOriginalMatrix(JSON.parse(JSON.stringify(
                Object.fromEntries(
                    Object.entries(initialMatrix).map(([k, v]) => [k, Array.from(v)])
                )
            )));


            const prefixes = new Set(abilitiesData.map(a => a.code.split('.')[0]));
            setExpandedGroups(prefixes);

        } catch (e) {
            console.error(e);
            toast.error("Ошибка загрузки данных безопасности");
        } finally {
            setLoading(false);
        }
    };


    const groupedAbilities = useMemo(() => {
        const groups: Record<string, AbilityModel[]> = {};

        abilities.forEach(ability => {
            const prefix = ability.code.split('.')[0];
            if (!groups[prefix]) groups[prefix] = [];
            groups[prefix].push(ability);
        });


        const filtered: AbilityGroup[] = Object.entries(groups)
            .map(([prefix, abs]) => ({
                prefix,
                label: GROUP_LABELS[prefix] || prefix,
                abilities: abs.filter(a =>
                    !abilitySearch ||
                    a.code.toLowerCase().includes(abilitySearch.toLowerCase()) ||
                    a.description.toLowerCase().includes(abilitySearch.toLowerCase())
                ),
                isExpanded: expandedGroups.has(prefix)
            }))
            .filter(g => g.abilities.length > 0)
            .sort((a, b) => a.label.localeCompare(b.label));

        return filtered;
    }, [abilities, abilitySearch, expandedGroups]);


    const _visibleAbilities = useMemo(() => {
        const result: { ability: AbilityModel; groupPrefix: string; isFirstInGroup: boolean; groupLabel: string; groupSize: number }[] = [];

        groupedAbilities.forEach(group => {
            if (group.isExpanded) {
                group.abilities.forEach((ability, idx) => {
                    result.push({
                        ability,
                        groupPrefix: group.prefix,
                        isFirstInGroup: idx === 0,
                        groupLabel: group.label,
                        groupSize: group.abilities.length
                    });
                });
            }
        });

        return result;
    }, [groupedAbilities]);


    const togglePermission = (roleId: number, abilityId: number) => {
        const role = roles.find(r => r.id === roleId);
        if (role?.name === 'SUPER_ADMIN') {
            toast('Права Супер-Админа неизменны', { icon: '🔒' });
            return;
        }

        setMatrix(prev => {
            const roleAbilities = new Set(prev[roleId]);
            if (roleAbilities.has(abilityId)) {
                roleAbilities.delete(abilityId);
            } else {
                roleAbilities.add(abilityId);
            }
            return { ...prev, [roleId]: roleAbilities };
        });
    };


    const toggleGroupForRole = (roleId: number, groupPrefix: string) => {
        const role = roles.find(r => r.id === roleId);
        if (role?.name === 'SUPER_ADMIN') {
            toast('Права Супер-Админа неизменны', { icon: '🔒' });
            return;
        }

        const groupAbilities = abilities.filter(a => a.code.startsWith(groupPrefix + '.'));
        const groupIds = groupAbilities.map(a => a.id);

        setMatrix(prev => {
            const roleAbilities = new Set(prev[roleId]);
            const allChecked = groupIds.every(id => roleAbilities.has(id));

            if (allChecked) {

                groupIds.forEach(id => roleAbilities.delete(id));
            } else {

                groupIds.forEach(id => roleAbilities.add(id));
            }
            return { ...prev, [roleId]: roleAbilities };
        });
    };


    const hasChanges = (roleId: number): boolean => {
        const current = matrix[roleId] || new Set();
        const original = new Set(originalMatrix[roleId] || []);

        if (current.size !== original.size) return true;
        for (const id of current) {
            if (!original.has(id)) return true;
        }
        return false;
    };


    const changedRolesCount = useMemo(() => {
        return roles.filter(r => hasChanges(r.id)).length;
    }, [roles, matrix, originalMatrix]);


    const saveRole = async (roleId: number) => {
        setSavingId(roleId);
        try {
            const abilityIds = Array.from(matrix[roleId] || []);
            await updateRoleAbilities(roleId, abilityIds);
            toast.success("Права роли обновлены");


            setOriginalMatrix(prev => ({
                ...prev,
                [roleId]: new Set(abilityIds)
            }));


            const updatedRoles = roles.map(r => {
                if (r.id === roleId) {
                    const newAbilities = abilities.filter(a => abilityIds.includes(a.id));
                    return { ...r, abilities: newAbilities };
                }
                return r;
            });
            setRoles(updatedRoles);
        } catch (e) {
            toast.error("Ошибка сохранения");
        } finally {
            setSavingId(null);
        }
    };

    const saveAllChanges = async () => {
        const changedRoles = roles.filter(r => hasChanges(r.id));
        if (changedRoles.length === 0) return;

        setSavingAll(true);
        let successCount = 0;
        let errorCount = 0;

        for (const role of changedRoles) {
            try {
                const abilityIds = Array.from(matrix[role.id] || []);
                await updateRoleAbilities(role.id, abilityIds);

                setOriginalMatrix(prev => ({
                    ...prev,
                    [role.id]: new Set(abilityIds)
                }));
                successCount++;
            } catch (e) {
                errorCount++;
            }
        }

        setSavingAll(false);

        if (errorCount === 0) {
            toast.success(`Сохранено ${successCount} ролей`);
        } else {
            toast.error(`Ошибки: ${errorCount} из ${changedRoles.length}`);
        }


        loadData();
    };


    const getUserAbilities = (userRoleName: string) => {
        if (userRoleName === 'SUPER_ADMIN') return abilities;
        const roleObj = roles.find(r => r.name === userRoleName);
        return roleObj ? roleObj.abilities : [];
    };

    const filteredUsers = users.filter(u =>
        u.login.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.name?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.surname?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.role.toLowerCase().includes(userSearch.toLowerCase())
    );


    const toggleGroup = (prefix: string) => {
        setExpandedGroups(prev => {
            const next = new Set(prev);
            if (next.has(prefix)) {
                next.delete(prefix);
            } else {
                next.add(prefix);
            }
            return next;
        });
    };

    const expandAllGroups = () => {
        const allPrefixes = new Set(abilities.map(a => a.code.split('.')[0]));
        setExpandedGroups(allPrefixes);
    };

    const collapseAllGroups = () => {
        setExpandedGroups(new Set());
    };


    if (loading && roles.length === 0) {
        return (
            <div className="flex justify-center p-20">
                <Loader2 className="animate-spin text-indigo-600" size={32}/>
            </div>
        );
    }

    return (
        <div className="p-6 bg-gray-50 min-h-screen">
            <div className="max-w-full mx-auto">

                {kcStatus && kcStatus.mode === 'dev-bypass' && (
                    <div className="mb-4 flex items-center gap-3 px-4 py-3 bg-amber-50 border border-amber-300 rounded-xl text-amber-800 text-sm font-medium">
                        <AlertTriangle size={18} className="text-amber-600 flex-shrink-0" />
                        <span>Режим разработки — Keycloak отключён (AUTH_MODE=dev-bypass)</span>
                    </div>
                )}

                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div className="flex items-center gap-4">
                        <div className="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-200 text-white">
                            <Shield size={32} />
                        </div>
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800">Контроль доступа</h1>
                            <p className="text-gray-500 font-medium">RBAC: Роли и полномочия</p>
                        </div>
                    </div>


                    <div className="bg-white p-1 rounded-xl shadow-sm border border-gray-200 flex">
                        <button
                            onClick={() => setViewMode("USERS")}
                            className={`px-6 py-2 rounded-lg font-bold transition flex items-center gap-2 ${
                                viewMode === "USERS"
                                    ? "bg-indigo-50 text-indigo-700 shadow-sm"
                                    : "text-gray-500 hover:bg-gray-50"
                            }`}
                        >
                            <Users size={18} /> Пользователи
                        </button>
                        <button
                            onClick={() => setViewMode("MATRIX")}
                            className={`px-6 py-2 rounded-lg font-bold transition flex items-center gap-2 ${
                                viewMode === "MATRIX"
                                    ? "bg-indigo-50 text-indigo-700 shadow-sm"
                                    : "text-gray-500 hover:bg-gray-50"
                            }`}
                        >
                            <Key size={18} /> Матрица прав
                        </button>
                    </div>
                </div>


                {viewMode === "USERS" && (
                    <div className="space-y-4 animate-fade-in">

                        <div className="relative max-w-md">
                            <Search className="absolute left-3 top-2.5 text-gray-400 w-5 h-5"/>
                            <input
                                value={userSearch}
                                onChange={e => setUserSearch(e.target.value)}
                                className="w-full pl-10 pr-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="Поиск сотрудника..."
                            />
                        </div>

                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                                    <tr>
                                        <th className="p-4">Сотрудник</th>
                                        <th className="p-4">Роль (Keycloak)</th>
                                        <th className="p-4">Активные права</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filteredUsers.map(user => {
                                        const effectiveAbilities = getUserAbilities(user.role);
                                        return (
                                            <tr key={user.id} className="hover:bg-indigo-50/30 transition">
                                                <td className="p-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 overflow-hidden border border-gray-200">
                                                            {user.img ? (
                                                                <img src={user.img} alt="" className="w-full h-full object-cover"/>
                                                            ) : (
                                                                <User size={20}/>
                                                            )}
                                                        </div>
                                                        <div>
                                                            <div className="font-semibold text-gray-800">
                                                                {user.surname} {user.name}
                                                            </div>
                                                            <div className="text-xs text-gray-400">{user.login}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="p-4">
                                                    <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold">
                                                        {user.role}
                                                    </span>
                                                </td>
                                                <td className="p-4">
                                                    <div className="flex flex-wrap gap-1 max-w-xl">
                                                        {effectiveAbilities.length > 0 ? effectiveAbilities.map(ab => (
                                                            <span
                                                                key={ab.id}
                                                                className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-[10px] border border-gray-200"
                                                                title={ab.code}
                                                            >
                                                                {ab.description}
                                                            </span>
                                                        )) : (
                                                            <span className="text-gray-400 text-sm italic">Нет прав</span>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {filteredUsers.length === 0 && (
                                <div className="p-8 text-center text-gray-400">Сотрудники не найдены</div>
                            )}
                        </div>
                    </div>
                )}


                {viewMode === "MATRIX" && (
                    <div className="space-y-4 animate-fade-in">


                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <div className="flex flex-wrap items-center gap-4">

                                <div className="relative flex-1 min-w-[200px] max-w-md">
                                    <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4"/>
                                    <input
                                        value={abilitySearch}
                                        onChange={e => setAbilitySearch(e.target.value)}
                                        className="w-full pl-9 pr-8 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="Поиск права..."
                                    />
                                    {abilitySearch && (
                                        <button
                                            onClick={() => setAbilitySearch("")}
                                            className="absolute right-2 top-2.5 text-gray-400 hover:text-gray-600"
                                        >
                                            <X size={16}/>
                                        </button>
                                    )}
                                </div>


                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={expandAllGroups}
                                        className="px-3 py-2 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition"
                                    >
                                        Развернуть всё
                                    </button>
                                    <button
                                        onClick={collapseAllGroups}
                                        className="px-3 py-2 text-xs font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition"
                                    >
                                        Свернуть всё
                                    </button>
                                </div>


                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={compactMode}
                                        onChange={e => setCompactMode(e.target.checked)}
                                        className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                    />
                                    <span className="text-sm text-gray-600">Компактный режим</span>
                                </label>


                                <div className="ml-auto flex items-center gap-4 text-sm text-gray-500">
                                    <span>{roles.length} ролей</span>
                                    <span>{abilities.length} прав</span>
                                    <span>{groupedAbilities.length} групп</span>
                                </div>
                            </div>
                        </div>


                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full border-collapse">
                                    <thead>
                                        <tr>

                                            <th className={`
                                                ${compactMode ? 'p-2 min-w-[160px]' : 'p-4 min-w-[220px]'}
                                                text-left bg-gray-50 border-b border-r
                                                sticky left-0 z-20
                                                shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}>
                                                <div className="text-xs text-gray-400 font-normal uppercase mb-1">Роль</div>
                                                <div className="font-bold text-gray-800">Название роли</div>
                                            </th>


                                            {groupedAbilities.map(group => (
                                                <th
                                                    key={group.prefix}
                                                    colSpan={group.isExpanded ? group.abilities.length : 1}
                                                    className={`
                                                        ${compactMode ? 'p-1' : 'p-2'}
                                                        text-center bg-gray-100 border-b border-r
                                                        ${!group.isExpanded ? 'cursor-pointer hover:bg-gray-200' : ''}
                                                    `}
                                                    onClick={() => !group.isExpanded && toggleGroup(group.prefix)}
                                                >
                                                    <div className="flex items-center justify-center gap-1">
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); toggleGroup(group.prefix); }}
                                                            className="p-1 hover:bg-gray-200 rounded transition"
                                                        >
                                                            {group.isExpanded
                                                                ? <ChevronDown size={14} className="text-gray-500"/>
                                                                : <ChevronRight size={14} className="text-gray-500"/>
                                                            }
                                                        </button>
                                                        <span className="font-bold text-gray-700 text-xs uppercase">
                                                            {group.label}
                                                        </span>
                                                        <span className="text-[10px] text-gray-400 ml-1">
                                                            ({group.abilities.length})
                                                        </span>
                                                    </div>
                                                </th>
                                            ))}


                                            <th className={`
                                                ${compactMode ? 'p-2 min-w-[70px]' : 'p-4 min-w-[100px]'}
                                                bg-gray-50 border-b
                                                sticky right-0 z-20
                                                shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}>
                                                <div className="text-xs text-gray-500 font-bold">Сохр.</div>
                                            </th>
                                        </tr>


                                        <tr>
                                            <th className={`
                                                ${compactMode ? 'p-1' : 'p-2'}
                                                bg-gray-50 border-b border-r
                                                sticky left-0 z-20
                                                shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}></th>

                                            {groupedAbilities.map(group => (
                                                group.isExpanded ? (
                                                    group.abilities.map(ab => (
                                                        <th
                                                            key={ab.id}
                                                            className={`
                                                                ${compactMode ? 'p-1 min-w-[80px]' : 'p-2 min-w-[110px]'}
                                                                text-center bg-gray-50 border-b border-r align-top
                                                            `}
                                                        >
                                                            <div className={`
                                                                ${compactMode ? 'text-[8px]' : 'text-[10px]'}
                                                                text-gray-400 font-mono mb-0.5 truncate
                                                            `} title={ab.code}>
                                                                .{ab.code.split('.')[1]}
                                                            </div>
                                                            <div className={`
                                                                ${compactMode ? 'text-[9px]' : 'text-xs'}
                                                                font-semibold text-gray-600 leading-tight
                                                            `} title={ab.description}>
                                                                {compactMode
                                                                    ? ab.description.slice(0, 12) + (ab.description.length > 12 ? '…' : '')
                                                                    : ab.description
                                                                }
                                                            </div>
                                                        </th>
                                                    ))
                                                ) : (
                                                    <th key={group.prefix + '-collapsed'} className="p-1 bg-gray-50 border-b border-r">
                                                        <div className="text-[10px] text-gray-400 italic">свёрнуто</div>
                                                    </th>
                                                )
                                            ))}

                                            <th className={`
                                                ${compactMode ? 'p-1' : 'p-2'}
                                                bg-gray-50 border-b
                                                sticky right-0 z-20
                                                shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                            `}></th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        {roles.map(role => {
                                            const isChanged = hasChanges(role.id);
                                            const isSuperAdmin = role.name === 'SUPER_ADMIN';

                                            return (
                                                <tr
                                                    key={role.id}
                                                    className={`
                                                        hover:bg-indigo-50/30 transition group
                                                        ${isChanged ? 'bg-amber-50/50' : ''}
                                                    `}
                                                >

                                                    <td className={`
                                                        ${compactMode ? 'p-2' : 'p-4'}
                                                        border-r border-b bg-white
                                                        sticky left-0 z-10
                                                        group-hover:bg-indigo-50/30
                                                        ${isChanged ? 'bg-amber-50/50 group-hover:bg-amber-100/50' : ''}
                                                        shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                                    `}>
                                                        <div className={`font-bold text-gray-800 ${compactMode ? 'text-xs' : 'text-sm'}`}>
                                                            {role.description}
                                                        </div>
                                                        <div className={`text-indigo-500 font-mono mt-0.5 ${compactMode ? 'text-[10px]' : 'text-xs'}`}>
                                                            {role.name}
                                                        </div>
                                                        {isChanged && (
                                                            <div className="flex items-center gap-1 mt-1 text-amber-600">
                                                                <AlertCircle size={12}/>
                                                                <span className="text-[10px]">Изменено</span>
                                                            </div>
                                                        )}
                                                    </td>


                                                    {groupedAbilities.map(group => (
                                                        group.isExpanded ? (
                                                            group.abilities.map(ab => {
                                                                const isChecked = isSuperAdmin || matrix[role.id]?.has(ab.id);
                                                                return (
                                                                    <td
                                                                        key={ab.id}
                                                                        onClick={() => togglePermission(role.id, ab.id)}
                                                                        className={`
                                                                            ${compactMode ? 'p-1' : 'p-2'}
                                                                            border-r border-b text-center
                                                                            ${isSuperAdmin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer'}
                                                                            transition-colors
                                                                            ${isChecked ? 'bg-indigo-50/50' : ''}
                                                                            ${!isSuperAdmin && 'hover:bg-indigo-100/50'}
                                                                        `}
                                                                    >
                                                                        <div className="flex justify-center">
                                                                            {isChecked
                                                                                ? <CheckSquare size={compactMode ? 16 : 20} className="text-indigo-600"/>
                                                                                : <Square size={compactMode ? 16 : 20} className="text-gray-300"/>
                                                                            }
                                                                        </div>
                                                                    </td>
                                                                );
                                                            })
                                                        ) : (

                                                            <td
                                                                key={group.prefix + '-collapsed'}
                                                                onClick={() => !isSuperAdmin && toggleGroupForRole(role.id, group.prefix)}
                                                                className={`
                                                                    ${compactMode ? 'p-1' : 'p-2'}
                                                                    border-r border-b text-center
                                                                    ${isSuperAdmin ? 'cursor-not-allowed opacity-60' : 'cursor-pointer hover:bg-indigo-100/50'}
                                                                    transition-colors
                                                                `}
                                                                title="Клик для переключения всей группы"
                                                            >
                                                                {(() => {
                                                                    const groupAbilities = abilities.filter(a => a.code.startsWith(group.prefix + '.'));
                                                                    const checkedCount = isSuperAdmin
                                                                        ? groupAbilities.length
                                                                        : groupAbilities.filter(a => matrix[role.id]?.has(a.id)).length;
                                                                    const total = groupAbilities.length;

                                                                    return (
                                                                        <div className={`
                                                                            font-mono font-bold
                                                                            ${checkedCount === total ? 'text-green-600' :
                                                                              checkedCount === 0 ? 'text-gray-400' : 'text-amber-600'}
                                                                            ${compactMode ? 'text-xs' : 'text-sm'}
                                                                        `}>
                                                                            {checkedCount}/{total}
                                                                        </div>
                                                                    );
                                                                })()}
                                                            </td>
                                                        )
                                                    ))}


                                                    <td className={`
                                                        ${compactMode ? 'p-1' : 'p-2'}
                                                        border-b bg-white
                                                        sticky right-0 z-10
                                                        group-hover:bg-indigo-50/30
                                                        ${isChanged ? 'bg-amber-50/50 group-hover:bg-amber-100/50' : ''}
                                                        shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]
                                                    `}>
                                                        <button
                                                            onClick={() => saveRole(role.id)}
                                                            disabled={!isChanged || savingId === role.id || isSuperAdmin}
                                                            className={`
                                                                p-2 rounded-lg transition-all flex items-center justify-center
                                                                ${isChanged && !isSuperAdmin
                                                                    ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md'
                                                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                                }
                                                            `}
                                                            title={isSuperAdmin ? 'Права Супер-Админа неизменны' : isChanged ? 'Сохранить изменения' : 'Нет изменений'}
                                                        >
                                                            {savingId === role.id
                                                                ? <Loader2 size={16} className="animate-spin"/>
                                                                : <Save size={16}/>
                                                            }
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>


                        <div className="flex flex-wrap items-center gap-6 text-xs text-gray-500 px-2">
                            <div className="flex items-center gap-2">
                                <CheckSquare size={16} className="text-indigo-600"/>
                                <span>Право включено</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <Square size={16} className="text-gray-300"/>
                                <span>Право выключено</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 bg-amber-100 rounded"/>
                                <span>Есть несохранённые изменения</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="font-mono text-green-600 font-bold">3/3</span>
                                <span>Все права группы (в свёрнутом виде)</span>
                            </div>
                        </div>
                    </div>
                )}


                {viewMode === "MATRIX" && changedRolesCount > 0 && (
                    <div className="fixed bottom-6 right-6 z-50 animate-bounce-in">
                        <button
                            onClick={saveAllChanges}
                            disabled={savingAll}
                            className="
                                flex items-center gap-3 px-6 py-4
                                bg-gradient-to-r from-indigo-600 to-purple-600
                                text-white font-bold rounded-2xl
                                shadow-2xl shadow-indigo-500/40
                                hover:from-indigo-700 hover:to-purple-700
                                transition-all transform hover:scale-105
                                disabled:opacity-70 disabled:cursor-not-allowed
                            "
                        >
                            {savingAll ? (
                                <>
                                    <Loader2 size={24} className="animate-spin"/>
                                    <span>Сохранение...</span>
                                </>
                            ) : (
                                <>
                                    <Save size={24}/>
                                    <span>Сохранить всё</span>
                                    <span className="
                                        ml-2 px-2 py-1
                                        bg-white/20 rounded-full
                                        text-sm font-mono
                                    ">
                                        {changedRolesCount}
                                    </span>
                                </>
                            )}
                        </button>
                    </div>
                )}
            </div>


            <style>{`
                @keyframes fade-in {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes bounce-in {
                    0% { opacity: 0; transform: scale(0.8) translateY(20px); }
                    50% { transform: scale(1.05) translateY(-5px); }
                    100% { opacity: 1; transform: scale(1) translateY(0); }
                }
                .animate-fade-in {
                    animation: fade-in 0.3s ease-out;
                }
                .animate-bounce-in {
                    animation: bounce-in 0.4s ease-out;
                }
            `}</style>
        </div>
    );
});

export default AdminRightsPage;

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Structure/StructurePage.tsx
================================================================================

import React, { useContext, useEffect, useState } from "react";
import { observer } from "mobx-react-lite";
import { Context } from "src/main";
import {
  Network,
  Users,
  Plus,
  ChevronRight,
  ChevronDown,
  Crown,
  UserCheck,
  UserPlus,
  Trash2,
  Layers,
  UserX,
  ArrowRight
} from "lucide-react";
import {
  fetchStructure,
  createSection,
  createTeam,
  assignSectionManager,
  assignTeamLead,
  addUserToTeam,
  removeUserFromTeam,
  fetchUnassignedUsers,
} from "src/api/structureApi";
import { fetchUsers } from "src/api/userApi";
import { Modal } from "src/components/Modal/Modal";
import { userGetModel } from "src/types/UserModel";
import toast from "react-hot-toast";

type Tab = "HIERARCHY" | "UNASSIGNED";

export const StructurePage: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { structureStore } = context;


  const [activeTab, setActiveTab] = useState<Tab>("HIERARCHY");
  const [expandedSections, setExpandedSections] = useState<number[]>([]);
  const [allUsers, setAllUsers] = useState<userGetModel[]>([]);
  const [unassignedUsers, setUnassignedUsers] = useState<userGetModel[]>([]);


  const [modalType, setModalType] = useState<"CREATE_SECTION" | "CREATE_TEAM" | "SELECT_USER" | null>(null);
  const [targetId, setTargetId] = useState<number | null>(null);
  const [actionType, setActionType] = useState<"MANAGER" | "LEAD" | "MEMBER" | null>(null);
  const [inputTitle, setInputTitle] = useState("");
  const [userSearch, setUserSearch] = useState("");


  const [assigningUserId, setAssigningUserId] = useState<number | null>(null);
  const [selectedSectionId, setSelectedSectionId] = useState<number | "">("");
  const [selectedTeamId, setSelectedTeamId] = useState<number | "">("");

  const loadData = async () => {
    try {
      const structData = await fetchStructure();
      structureStore.setSections(structData);

      const usersData = await fetchUsers();
      setAllUsers(usersData);


      try {
        const unassigned = await fetchUnassignedUsers();
        setUnassignedUsers(unassigned);
      } catch (e) {
        console.warn("API для нераспределенных еще не готово или вернуло ошибку");
      }
    } catch (e) {
      toast.error("Ошибка загрузки данных");
    }
  };

  useEffect(() => {
    void loadData();
  }, []);


  const handleCreateSection = async () => {
    if (!inputTitle.trim()) return;
    await createSection(inputTitle.trim());
    setInputTitle("");
    closeModal();
    await loadData();
    toast.success("Участок создан");
  };

  const handleCreateTeam = async () => {
    if (!targetId || !inputTitle.trim()) return;
    await createTeam(inputTitle.trim(), targetId);
    setInputTitle("");
    closeModal();
    await loadData();
    if (!expandedSections.includes(targetId)) {
      setExpandedSections((prev) => [...prev, targetId]);
    }
    toast.success("Бригада создана");
  };

  const handleUserSelect = async (userId: number) => {
    if (!targetId || !actionType) return;

    try {
      if (actionType === "MANAGER") {
        await assignSectionManager(targetId, userId);
      } else if (actionType === "LEAD") {
        await assignTeamLead(targetId, userId);
      } else if (actionType === "MEMBER") {
        await addUserToTeam(targetId, userId);
      }
      toast.success("Успешно назначено");
    } catch (e) {
      toast.error("Ошибка назначения");
    }

    closeModal();
    await loadData();
  };

  const handleRemoveMember = async (userId: number) => {
    if(!window.confirm("Убрать сотрудника из бригады?")) return;
    try {
      await removeUserFromTeam(userId);
      await loadData();
      toast.success("Сотрудник откреплен");
    } catch (e) {
      toast.error("Ошибка удаления");
    }
  };


  const handleQuickAssign = async () => {
    if (!assigningUserId || !selectedTeamId) return;
    try {
        await addUserToTeam(Number(selectedTeamId), assigningUserId);
        toast.success("Сотрудник распределен!");


        setAssigningUserId(null);
        setSelectedSectionId("");
        setSelectedTeamId("");

        await loadData();
    } catch (e) {
        toast.error("Ошибка привязки");
    }
  };


  const openUserSelect = (id: number, type: "MANAGER" | "LEAD" | "MEMBER") => {
    setTargetId(id);
    setActionType(type);
    setUserSearch("");
    setModalType("SELECT_USER");
  };

  const openCreateTeam = (sectionId: number) => {
    setTargetId(sectionId);
    setInputTitle("");
    setModalType("CREATE_TEAM");
  };

  const closeModal = () => {
    setModalType(null);
    setTargetId(null);
    setActionType(null);
  };

  const toggleSection = (id: number) => {
    setExpandedSections((prev) =>
      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id],
    );
  };

  const filteredUsers = allUsers.filter((user) => {
    const query = userSearch.trim().toLowerCase();
    if (!query) return true;
    return `${user.name} ${user.surname} ${user.login}`.toLowerCase().includes(query);
  });


  const availableTeamsForQuickAssign = structureStore.sections
      .find(s => s.id === Number(selectedSectionId))?.production_teams || [];

  return (
    <div className="min-h-screen bg-gray-50 p-8 pb-20">
      <div className="max-w-6xl mx-auto">


        <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center">
              <Network className="w-6 h-6 text-indigo-600" />
            </div>
            <div>
              <h1 className="text-2xl font-bold text-gray-800">Структура предприятия</h1>
              <p className="text-sm text-gray-500">Управление иерархией и персоналом</p>
            </div>
          </div>

          <div className="bg-white p-1 rounded-xl border border-gray-200 shadow-sm flex gap-1">
              <button
                onClick={() => setActiveTab("HIERARCHY")}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'HIERARCHY' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}
              >
                  <Layers size={16}/> Иерархия
              </button>
              <button
                onClick={() => setActiveTab("UNASSIGNED")}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition ${activeTab === 'UNASSIGNED' ? 'bg-orange-50 text-orange-600' : 'text-gray-500 hover:text-gray-700'}`}
              >
                  <UserX size={16}/> Нераспределенные
                  {unassignedUsers.length > 0 && (
                    <span className="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-1">
                        {unassignedUsers.length}
                    </span>
                  )}
              </button>
          </div>
        </div>


        {activeTab === "HIERARCHY" && (
            <div className="space-y-6 animate-fade-in">
                <div className="flex justify-end">
                    <button
                        type="button"
                        onClick={() => { setInputTitle(""); setModalType("CREATE_SECTION"); }}
                        className="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold shadow hover:bg-blue-700 transition"
                    >
                        <Plus size={18} /> Добавить участок
                    </button>
                </div>

                {structureStore.sections.map((section) => (
                    <div key={section.id} className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">

                        <div className="p-5 bg-gray-50 flex items-center justify-between gap-4 border-b border-gray-200 group">
                            <div className="flex items-center gap-4 cursor-pointer flex-1" onClick={() => toggleSection(section.id)}>
                                <button className="text-gray-400 hover:text-blue-600 transition">
                                    {expandedSections.includes(section.id) ? <ChevronDown size={20} /> : <ChevronRight size={20} />}
                                </button>
                                <div>
                                    <h2 className="font-semibold text-lg text-gray-800 flex items-center gap-2">{section.title}</h2>
                                    <div className="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                        <Crown size={14} className="text-yellow-600" /> Начальник:
                                        {section.manager ? (
                                            <span
                                                className="font-bold text-gray-700 underline decoration-dotted cursor-pointer hover:text-blue-600"
                                                onClick={(e) => { e.stopPropagation(); openUserSelect(section.id, "MANAGER"); }}
                                            >
                                                {section.manager.name} {section.manager.surname}
                                            </span>
                                        ) : (
                                            <button
                                                onClick={(e) => { e.stopPropagation(); openUserSelect(section.id, "MANAGER"); }}
                                                className="text-red-500 text-xs font-bold border border-red-200 bg-red-50 px-2 py-0.5 rounded hover:bg-red-100"
                                            >
                                                + НАЗНАЧИТЬ
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2 items-center">
                                <span className="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded-full border border-blue-100">Бригад: {section.production_teams?.length || 0}</span>
                                <button onClick={() => openCreateTeam(section.id)} className="p-2 text-gray-500 hover:text-blue-600 bg-white rounded-lg border hover:border-blue-300 transition flex items-center gap-2 text-sm font-medium">
                                    <Plus size={16} /> Бригада
                                </button>
                            </div>
                        </div>


                        {expandedSections.includes(section.id) && (
                            <div className="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white">
                                {section.production_teams?.length > 0 ? (
                                    section.production_teams.map((team) => (
                                        <div key={team.id} className="border rounded-xl p-4 bg-gray-50/60 hover:bg-gray-50 transition shadow-sm">
                                            <div className="flex justify-between items-start mb-3 pb-2 border-b border-dashed border-gray-300">
                                                <div>
                                                    <h3 className="font-bold text-lg text-gray-700 flex items-center gap-2">
                                                        <Users size={18} className="text-blue-500" /> {team.title}
                                                    </h3>
                                                    <div className="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                                        <UserCheck size={12} /> Старший:
                                                        {team.teamLead ? (
                                                            <button onClick={() => openUserSelect(team.id, "LEAD")} className="font-medium text-gray-800 cursor-pointer hover:text-blue-600 border-b border-dotted border-gray-400 ml-1">
                                                                {team.teamLead.name} {team.teamLead.surname}
                                                            </button>
                                                        ) : (
                                                            <button onClick={() => openUserSelect(team.id, "LEAD")} className="text-blue-600 font-bold hover:underline ml-1">Назначить</button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="space-y-2 min-h-[50px]">
                                                {team.users?.map((member) => (
                                                    <div key={member.id} className="flex items-center justify-between text-sm text-gray-600 bg-white border border-gray-200 p-2 rounded-lg shadow-sm">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs font-bold text-indigo-600">{member.name[0]}</div>
                                                            <span>{member.name} {member.surname}</span>
                                                        </div>
                                                        <button onClick={() => handleRemoveMember(member.id)} className="p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-50 transition" title="Убрать из бригады">
                                                            <Trash2 size={14} />
                                                        </button>
                                                    </div>
                                                ))}
                                                <button onClick={() => openUserSelect(team.id, "MEMBER")} className="w-full py-2 text-xs font-bold text-blue-500 border border-dashed border-blue-300 rounded-lg hover:bg-blue-50 transition flex items-center justify-center gap-1">
                                                    <UserPlus size={14} /> Добавить сотрудника
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="col-span-full text-center py-8 text-gray-400 border-2 border-dashed rounded-xl">В этом участке пока нет бригад. Создайте первую!</div>
                                )}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        )}


        {activeTab === "UNASSIGNED" && (
            <div className="animate-fade-in bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="p-6 border-b border-gray-100 bg-orange-50/30">
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <UserX className="text-orange-500"/> Сотрудники без бригады
                    </h2>
                    <p className="text-gray-500 text-sm mt-1">
                        Список пользователей, которые не привязаны ни к одной структурной единице.
                        Вы можете назначить их прямо здесь.
                    </p>
                </div>

                <div className="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {unassignedUsers.length === 0 && (
                        <div className="col-span-full text-center py-20">
                            <div className="inline-flex p-4 bg-green-50 rounded-full mb-3"><UserCheck size={32} className="text-green-500"/></div>
                            <h3 className="text-lg font-bold text-gray-700">Все распределены!</h3>
                            <p className="text-gray-400">Нет сотрудников без привязки к бригаде.</p>
                        </div>
                    )}

                    {unassignedUsers.map(user => (
                        <div key={user.id} className={`p-4 border rounded-xl transition-all ${assigningUserId === user.id ? 'bg-indigo-50 border-indigo-300 ring-2 ring-indigo-100 shadow-md' : 'bg-white border-gray-200 shadow-sm hover:shadow-md'}`}>
                            <div className="flex justify-between items-center mb-3">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold overflow-hidden border border-gray-300">
                                        {user.img ? <img src={`${import.meta.env.VITE_API_URL}/${user.img}`} className="w-full h-full object-cover"/> : user.name[0]}
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">{user.name} {user.surname}</div>
                                        <div className="text-xs text-gray-500">{user.login} • {user.role}</div>
                                    </div>
                                </div>

                                {assigningUserId !== user.id && (
                                    <button
                                        onClick={() => { setAssigningUserId(user.id); setSelectedSectionId(""); setSelectedTeamId(""); }}
                                        className="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 text-xs font-bold rounded-lg hover:border-indigo-500 hover:text-indigo-600 transition"
                                    >
                                        Назначить
                                    </button>
                                )}
                            </div>


                            {assigningUserId === user.id && (
                                <div className="pt-3 border-t border-indigo-200 flex flex-col gap-2 animate-fade-in">
                                    <div className="space-y-2">
                                        <div>
                                            <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">Участок</label>
                                            <select
                                                className="w-full p-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none"
                                                value={selectedSectionId}
                                                onChange={e => { setSelectedSectionId(Number(e.target.value)); setSelectedTeamId(""); }}
                                            >
                                                <option value="">Выберите...</option>
                                                {structureStore.sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">Бригада</label>
                                            <select
                                                className="w-full p-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none disabled:bg-gray-100 disabled:text-gray-400"
                                                value={selectedTeamId}
                                                onChange={e => setSelectedTeamId(Number(e.target.value))}
                                                disabled={!selectedSectionId}
                                            >
                                                <option value="">Выберите...</option>
                                                {availableTeamsForQuickAssign.map(t => <option key={t.id} value={t.id}>{t.title}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-2 mt-2">
                                        <button onClick={() => setAssigningUserId(null)} className="px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-200 rounded font-medium">Отмена</button>
                                        <button
                                            onClick={handleQuickAssign}
                                            disabled={!selectedTeamId}
                                            className="px-4 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-1 shadow-sm transition"
                                        >
                                            Сохранить <ArrowRight size={12}/>
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        )}


        <Modal isOpen={modalType === "CREATE_SECTION"} onClose={closeModal}>
          <div className="p-4">
            <h2 className="text-lg font-semibold mb-3">Новый участок</h2>
            <input
              className="w-full border rounded px-3 py-2 mb-3 text-sm"
              placeholder="Название участка"
              value={inputTitle}
              onChange={(e) => setInputTitle(e.target.value)}
            />
            <div className="flex justify-end gap-2">
              <button onClick={closeModal} className="px-3 py-1.5 text-sm rounded border border-gray-300 bg-white hover:bg-gray-50">Отмена</button>
              <button onClick={handleCreateSection} className="px-3 py-1.5 text-sm rounded bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300" disabled={!inputTitle.trim()}>Создать</button>
            </div>
          </div>
        </Modal>

        <Modal isOpen={modalType === "CREATE_TEAM"} onClose={closeModal}>
          <div className="p-4">
            <h2 className="text-lg font-semibold mb-3">Новая бригада</h2>
            <input
              className="w-full border rounded px-3 py-2 mb-3 text-sm"
              placeholder="Название бригады"
              value={inputTitle}
              onChange={(e) => setInputTitle(e.target.value)}
            />
            <div className="flex justify-end gap-2">
              <button onClick={closeModal} className="px-3 py-1.5 text-sm rounded border border-gray-300 bg-white hover:bg-gray-50">Отмена</button>
              <button onClick={handleCreateTeam} className="px-3 py-1.5 text-sm rounded bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300" disabled={!inputTitle.trim()}>Создать</button>
            </div>
          </div>
        </Modal>

        <Modal isOpen={modalType === "SELECT_USER"} onClose={closeModal}>
          <div className="p-4 h-[500px] flex flex-col">
            <h2 className="text-lg font-semibold mb-3">
              {actionType === "MANAGER" && "Выберите начальника участка"}
              {actionType === "LEAD" && "Выберите старшего бригады"}
              {actionType === "MEMBER" && "Добавить сотрудника в бригаду"}
            </h2>
            <input className="w-full p-2 border rounded mb-2 text-sm" placeholder="Поиск по имени или логину" value={userSearch} onChange={(e) => setUserSearch(e.target.value)} />
            <div className="overflow-y-auto flex-1 space-y-2 pr-1 custom-scrollbar">
              {filteredUsers.map((user) => (
                <button key={user.id} type="button" onClick={() => handleUserSelect(user.id)} className="w-full flex flex-col items-start px-3 py-2 border border-gray-200 rounded-lg bg-white hover:bg-blue-50 hover:border-blue-300 text-left transition">
                  <span className="font-medium text-gray-700">{user.name} {user.surname}</span>
                  <span className="text-xs text-gray-400">{user.login}</span>
                </button>
              ))}
            </div>
          </div>
        </Modal>

      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Admin/Warehouse/WarehousePage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  createSupply,
  fetchSupplies,
  createBox,
  fetchBoxes,
  exportLabelsCsv,
  BoxCreateDto,
  SupplyCreateDto,
} from "src/api/warehouseApi";

import { SupplyModel, InventoryBoxModel } from "src/types/WarehouseModels";
import { fetchStructure } from "src/api/structureApi";

type SectionShort = {
  id: number;
  title: string;
};

export const WarehousePage: React.FC = () => {
  const [supplies, setSupplies] = useState<SupplyModel[]>([]);
  const [selectedSupplyId, setSelectedSupplyId] = useState<number | null>(null);
  const [boxes, setBoxes] = useState<InventoryBoxModel[]>([]);
  const [sections, setSections] = useState<SectionShort[]>([]);


  const [supplier, setSupplier] = useState("");
  const [docNumber, setDocNumber] = useState("");
  const [expectedDate, setExpectedDate] = useState("");
  const [supplyComment, setSupplyComment] = useState("");


  const [sectionId, setSectionId] = useState<number | "">("");
  const [itemName, setItemName] = useState("");
  const [quantity, setQuantity] = useState<number>(1);
  const [unit, setUnit] = useState("шт");
  const [kitNumber, setKitNumber] = useState("");
  const [boxComment, setBoxComment] = useState("");

  const loadSupplies = async () => {
    const data = await fetchSupplies();
    setSupplies(data);
    if (!selectedSupplyId && data.length > 0) {
      setSelectedSupplyId(data[0].id);
    }
  };

  const loadBoxes = async (supplyId: number) => {
    const data = await fetchBoxes({ supplyId });
    setBoxes(data);
  };

  const loadSections = async () => {
    const structData = await fetchStructure();
    const shorts: SectionShort[] = structData.map((s: any) => ({
      id: s.id,
      title: s.title,
    }));
    setSections(shorts);
  };

  useEffect(() => {
    void loadSupplies();
    void loadSections();
  }, []);

  useEffect(() => {
    if (selectedSupplyId) {
      void loadBoxes(selectedSupplyId);
    } else {
      setBoxes([]);
    }
  }, [selectedSupplyId]);

  const handleCreateSupply = async () => {
    const payload: SupplyCreateDto = {
      supplier: supplier.trim() || undefined,
      docNumber: docNumber.trim() || undefined,
      expectedDate: expectedDate || undefined,
      comment: supplyComment.trim() || undefined,
    };

    const created = await createSupply(payload);
    setSupplier("");
    setDocNumber("");
    setExpectedDate("");
    setSupplyComment("");
    await loadSupplies();
    setSelectedSupplyId(created.id);
  };

  const handleCreateBox = async () => {
    if (!selectedSupplyId) {
      alert("Сначала выберите поставку или создайте новую.");
      return;
    }
    if (!sectionId) {
      alert("Выберите участок.");
      return;
    }
    if (!itemName.trim()) {
      alert("Введите наименование изделия / комплектующего.");
      return;
    }

    const payload: BoxCreateDto = {
      supplyId: selectedSupplyId,
      sectionId: Number(sectionId),
      itemName: itemName.trim(),
      quantity: quantity || 1,
      unit: unit.trim() || "шт",
      kitNumber: kitNumber.trim() || undefined,
      comment: boxComment.trim() || undefined,
    };

    await createBox(payload);
    setItemName("");
    setQuantity(1);
    setUnit("шт");
    setKitNumber("");
    setBoxComment("");
    await loadBoxes(selectedSupplyId);
  };

  const handleExportCsv = async () => {
    if (!selectedSupplyId) {
      alert("Сначала выберите поставку.");
      return;
    }
    const blob = await exportLabelsCsv(selectedSupplyId);
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `asvo_qms_labels_supply_${selectedSupplyId}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  };

  const currentSupply = supplies.find((s) => s.id === selectedSupplyId);

  return (
    <div className="p-6 bg-gray-100/80 min-h-screen">
      <h1 className="text-2xl font-bold text-gray-800 mb-4">
        Склад и приёмка
      </h1>
      <p className="text-gray-600 mb-6">
        Здесь принимаем изделия и комплектующие, раскладываем по коробкам и
        генерируем этикетки с префиксом «ASVO-QMS».
      </p>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">

        <div className="xl:col-span-1 bg-white rounded-lg shadow p-4">
          <h2 className="text-lg font-semibold mb-3">Поставки</h2>

          <div className="space-y-3 max-h-[420px] overflow-y-auto">
            {supplies.map((s) => (
              <button
                key={s.id}
                onClick={() => setSelectedSupplyId(s.id)}
                className={`w-full text-left border rounded-md p-3 mb-1 transition ${
                  selectedSupplyId === s.id
                    ? "bg-emerald-50 border-emerald-400"
                    : "bg-gray-50 hover:bg-gray-100 border-gray-200"
                }`}
              >
                <div className="text-sm text-gray-500">
                  #{s.id} • {new Date(s.createdAt).toLocaleDateString()}
                </div>
                <div className="font-semibold">
                  {s.supplier || "Без поставщика"}
                </div>
                <div className="text-sm text-gray-600">
                  Документ: {s.docNumber || "—"}
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  Статус: {s.status}
                </div>
              </button>
            ))}

            {supplies.length === 0 && (
              <div className="text-sm text-gray-500">
                Поставок пока нет. Создайте первую.
              </div>
            )}
          </div>

          <div className="mt-4 border-t pt-4">
            <h3 className="text-md font-semibold mb-2">Новая поставка</h3>
            <div className="space-y-2">
              <input
                className="w-full border rounded px-2 py-1 text-sm"
                placeholder="Поставщик (опционально)"
                value={supplier}
                onChange={(e) => setSupplier(e.target.value)}
              />
              <input
                className="w-full border rounded px-2 py-1 text-sm"
                placeholder="Номер документа"
                value={docNumber}
                onChange={(e) => setDocNumber(e.target.value)}
              />
              <input
                type="date"
                className="w-full border rounded px-2 py-1 text-sm"
                value={expectedDate}
                onChange={(e) => setExpectedDate(e.target.value)}
              />
              <textarea
                className="w-full border rounded px-2 py-1 text-sm"
                placeholder="Комментарий"
                value={supplyComment}
                onChange={(e) => setSupplyComment(e.target.value)}
                rows={2}
              />
              <button
                onClick={handleCreateSupply}
                className="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold py-2 rounded"
              >
                Создать поставку
              </button>
            </div>
          </div>
        </div>


        <div className="xl:col-span-2 space-y-6">
          <div className="bg-white rounded-lg shadow p-4">
            <h2 className="text-lg font-semibold mb-3">
              Коробки в поставке{" "}
              {currentSupply
                ? `#${currentSupply.id} (${currentSupply.supplier || "—"})`
                : "—"}
            </h2>

            <div className="flex flex-col md:flex-row gap-4 mb-4">
              <div className="flex-1 space-y-2">
                <label className="text-sm text-gray-700">
                  Участок, куда пойдёт коробка
                </label>
                <select
                  className="w-full border rounded px-2 py-1 text-sm"
                  value={sectionId}
                  onChange={(e) =>
                    setSectionId(
                      e.target.value ? Number(e.target.value) : ""
                    )
                  }
                >
                  <option value="">Не выбрано</option>
                  {sections.map((s) => (
                    <option key={s.id} value={s.id}>
                      {s.title}
                    </option>
                  ))}
                </select>

                <label className="text-sm text-gray-700">
                  Наименование (без «ASVO-QMS»)
                </label>
                <input
                  className="w-full border rounded px-2 py-1 text-sm"
                  placeholder="Например: FC 2.4 ГГц, партия 01"
                  value={itemName}
                  onChange={(e) => setItemName(e.target.value)}
                />

                <div className="flex gap-2">
                  <div className="flex-1">
                    <label className="text-sm text-gray-700">Количество</label>
                    <input
                      type="number"
                      min={1}
                      className="w-full border rounded px-2 py-1 text-sm"
                      value={quantity}
                      onChange={(e) =>
                        setQuantity(Number(e.target.value) || 1)
                      }
                    />
                  </div>
                  <div className="w-28">
                    <label className="text-sm text-gray-700">Ед. изм</label>
                    <input
                      className="w-full border rounded px-2 py-1 text-sm"
                      value={unit}
                      onChange={(e) => setUnit(e.target.value)}
                    />
                  </div>
                </div>

                <label className="text-sm text-gray-700">
                  Номер комплекта (если нужно)
                </label>
                <input
                  className="w-full border rounded px-2 py-1 text-sm"
                  placeholder="Если пусто — возьмётся номер коробки"
                  value={kitNumber}
                  onChange={(e) => setKitNumber(e.target.value)}
                />

                <label className="text-sm text-gray-700">Комментарий</label>
                <textarea
                  className="w-full border rounded px-2 py-1 text-sm"
                  rows={2}
                  value={boxComment}
                  onChange={(e) => setBoxComment(e.target.value)}
                />
              </div>

              <div className="w-full md:w-52 flex flex-col justify-between">
                <div className="border rounded-lg p-3 bg-gray-50 text-sm text-gray-700 mb-3">
                  <div className="font-semibold mb-1">
                    Предпросмотр этикетки
                  </div>
                  <div className="text-xs text-gray-500">Имя:</div>
                  <div className="font-medium">
                    {sectionId && itemName
                      ? `ASVO-QMS ${itemName.trim()}${
                          sections.find((s) => s.id === sectionId)
                            ? ` / ${
                                sections.find((s) => s.id === sectionId)?.title
                              }`
                            : ""
                        }`
                      : "Заполните наименование и участок"}
                  </div>
                  <div className="mt-2 text-xs text-gray-500">
                    Кол-во: {quantity} {unit}
                  </div>
                </div>

                <button
                  onClick={handleCreateBox}
                  className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold py-2 rounded"
                >
                  Добавить коробку
                </button>

                <button
                  onClick={handleExportCsv}
                  className="w-full mt-2 border border-emerald-500 text-emerald-700 hover:bg-emerald-50 text-sm font-semibold py-2 rounded"
                >
                  Выгрузить этикетки (CSV для Excel)
                </button>
              </div>
            </div>

            <div className="mt-4">
              <div className="overflow-x-auto max-h-[380px] border rounded-lg">
                <table className="min-w-full text-sm">
                  <thead className="bg-gray-100 sticky top-0">
                    <tr>
                      <th className="px-2 py-1 border-b">Коробка</th>
                      <th className="px-2 py-1 border-b">Имя этикетки</th>
                      <th className="px-2 py-1 border-b">Участок</th>
                      <th className="px-2 py-1 border-b">Кол-во</th>
                      <th className="px-2 py-1 border-b">Штрих/QR код</th>
                    </tr>
                  </thead>
                  <tbody>
                    {boxes.map((b) => (
                      <tr key={b.id} className="hover:bg-gray-50">
                        <td className="px-2 py-1 border-b">
                          {b.boxNumber || `#${b.id}`}
                        </td>
                        <td className="px-2 py-1 border-b">{b.displayName}</td>
                        <td className="px-2 py-1 border-b">
                          {b.section?.title || "—"}
                        </td>
                        <td className="px-2 py-1 border-b">
                          {b.quantity} {b.unit}
                        </td>
                        <td className="px-2 py-1 border-b">{b.labelCode}</td>
                      </tr>
                    ))}

                    {boxes.length === 0 && (
                      <tr>
                        <td
                          colSpan={5}
                          className="px-2 py-3 text-center text-gray-500"
                        >
                          Для выбранной поставки коробок пока нет.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
              {boxes.length > 0 && (
                <div className="mt-2 text-xs text-gray-500">
                  Всего коробок: {boxes.length}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default WarehousePage;

================================================================================
FILE: QMS-Client-main/src/pages/CAPA/CapaPage.tsx
================================================================================







import React from "react";
import {
  CheckCircle2, Plus, Download, Grid3X3,
} from "lucide-react";
import Badge from "src/components/qms/Badge";
import StatusDot from "src/components/qms/StatusDot";
import ProgressBar from "src/components/qms/ProgressBar";



interface CapaRow {
  id: string;
  title: string;
  type: "Корректирующее" | "Предупреждающее";
  nc: string;
  status: string;
  statusVariant: "nc" | "capa" | "risk" | "audit" | "closed" | "sop";
  progress: number;
  progressColor: "red" | "amber" | "blue" | "accent" | "purple";
  responsible: string;
  due: string;
}

const capaRows: CapaRow[] = [
  { id: "CAPA-049", title: "Чек-лист верификации пайки SMD", type: "Корректирующее", nc: "NC-089", status: "Инициировано", statusVariant: "audit", progress: 10, progressColor: "blue", responsible: "Костюков И.", due: "20.02.2026" },
  { id: "CAPA-047", title: "Внедрение чек-листа монтажа", type: "Корректирующее", nc: "NC-085", status: "Выполнение", statusVariant: "capa", progress: 70, progressColor: "amber", responsible: "Омельченко А.", due: "20.02.2026" },
  { id: "CAPA-045", title: "Замена поставщика PCB", type: "Корректирующее", nc: "NC-082", status: "Проверка", statusVariant: "risk", progress: 90, progressColor: "accent", responsible: "Холтобин А.", due: "15.02.2026" },
  { id: "CAPA-042", title: "Обновление IQ/OQ для пресса", type: "Предупреждающее", nc: "\u2014", status: "Закрыто", statusVariant: "closed", progress: 100, progressColor: "accent", responsible: "Костюков И.", due: "01.02.2026" },
  { id: "CAPA-041", title: "Замена клея на участке сборки", type: "Корректирующее", nc: "NC-078", status: "Просрочено", statusVariant: "nc", progress: 45, progressColor: "red", responsible: "Яровой Е.", due: "28.01.2026" },
  { id: "CAPA-038", title: "Калибровка мультиметров", type: "Предупреждающее", nc: "\u2014", status: "Просрочено", statusVariant: "nc", progress: 60, progressColor: "red", responsible: "Чирков И.", due: "01.02.2026" },
];

const d8Steps = [
  { d: "D1", label: "Команда", done: true },
  { d: "D2", label: "Описание", done: true },
  { d: "D3", label: "Сдерживание", done: true },
  { d: "D4", label: "Root Cause", done: true },
  { d: "D5", label: "Действия", done: false },
  { d: "D6", label: "Внедрение", done: false },
  { d: "D7", label: "Предотвращение", done: false },
  { d: "D8", label: "Закрытие", done: false },
];

const typeBadge: Record<string, { color: string; bg: string }> = {
  "Корректирующее":    { color: "#E8A830", bg: "rgba(232,168,48,0.12)" },
  "Предупреждающее":   { color: "#4A90E8", bg: "rgba(74,144,232,0.12)" },
};



export const CapaPage: React.FC = () => {
  return (
    <div className="min-h-screen bg-asvo-bg p-6 space-y-6">
      {}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-asvo-amber-dim rounded-xl flex items-center justify-center">
            <CheckCircle2 className="w-5 h-5 text-asvo-amber" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-asvo-text">CAPA</h1>
            <p className="text-sm text-asvo-text-dim">ISO 13485 §8.5.2/§8.5.3 — Корректирующие и предупреждающие действия</p>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <button className="flex items-center gap-2 px-4 py-2 bg-asvo-accent text-asvo-bg rounded-lg text-sm font-semibold hover:brightness-110 transition">
            <Plus size={16} />
            Создать CAPA
          </button>
          <button className="flex items-center gap-2 px-4 py-2 border border-asvo-border text-asvo-text-mid rounded-lg text-sm font-medium hover:border-asvo-text-dim transition">
            <Download size={16} />
            Экспорт
          </button>
        </div>
      </div>

      {}
      <div className="grid grid-cols-4 gap-4">
        {[
          { label: "Всего CAPA", value: 49, cls: "text-asvo-blue" },
          { label: "Активных", value: 15, cls: "text-asvo-amber" },
          { label: "Просрочено", value: 4, cls: "text-asvo-red" },
          { label: "Эффективных", value: 31, cls: "text-asvo-accent" },
        ].map((kpi) => (
          <div key={kpi.label} className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-4">
            <div className={`text-2xl font-bold ${kpi.cls}`}>{kpi.value}</div>
            <div className="text-xs text-asvo-text-dim mt-1">{kpi.label}</div>
          </div>
        ))}
      </div>

      {}
      <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl overflow-hidden">
        <table className="w-full">
          <thead>
            <tr className="bg-asvo-surface border-b border-asvo-border">
              {["ID", "Название", "Тип", "NC", "Статус", "Прогресс", "Ответственный", "Срок"].map((col) => (
                <th key={col} className="text-left px-4 py-3 text-[11px] font-semibold text-asvo-text-dim uppercase tracking-wider">
                  {col}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {capaRows.map((row) => {
              const tp = typeBadge[row.type];
              return (
                <tr
                  key={row.id}
                  className="border-b border-asvo-border/30 hover:bg-asvo-surface-3 transition-colors cursor-pointer"
                >
                  <td className="px-4 py-3 text-sm font-mono font-bold text-asvo-accent">{row.id}</td>
                  <td className="px-4 py-3 text-sm text-asvo-text">{row.title}</td>
                  <td className="px-4 py-3">
                    <Badge color={tp.color} bg={tp.bg}>{row.type}</Badge>
                  </td>
                  <td className="px-4 py-3">
                    {row.nc !== "\u2014" ? (
                      <span className="text-sm font-mono font-semibold text-asvo-accent cursor-pointer hover:underline">
                        {row.nc}
                      </span>
                    ) : (
                      <span className="text-sm text-asvo-text-dim">{row.nc}</span>
                    )}
                  </td>
                  <td className="px-4 py-3">
                    <Badge variant={row.statusVariant}>{row.status}</Badge>
                  </td>
                  <td className="px-4 py-3">
                    <div className="w-24">
                      <ProgressBar value={row.progress} color={row.progressColor} />
                      <div className="text-[10px] text-asvo-text-dim text-right mt-0.5">{row.progress}%</div>
                    </div>
                  </td>
                  <td className="px-4 py-3 text-sm text-asvo-text-mid">{row.responsible}</td>
                  <td className="px-4 py-3 text-sm text-asvo-text-mid">{row.due}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {}
      <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-5">
        <div className="flex items-center gap-2 mb-4">
          <Grid3X3 size={16} className="text-asvo-accent" />
          <h3 className="text-sm font-semibold text-asvo-text">8D Workflow</h3>
        </div>

        <div className="grid grid-cols-8 gap-3">
          {d8Steps.map((step) => (
            <div
              key={step.d}
              className={`rounded-lg p-3 text-center border ${
                step.done
                  ? "bg-asvo-accent-dim border-asvo-accent/30"
                  : "bg-asvo-surface border-asvo-border"
              }`}
            >
              <div
                className={`text-lg font-bold ${
                  step.done ? "text-asvo-accent" : "text-asvo-text-dim"
                }`}
              >
                {step.d}
              </div>
              <div
                className={`text-[10px] mt-1 ${
                  step.done ? "text-asvo-accent" : "text-asvo-text-dim"
                }`}
              >
                {step.label}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Documents/DocumentsPage.tsx
================================================================================







import React, { useState } from "react";
import { FileText, Plus, Search, Upload, ChevronRight } from "lucide-react";

import Badge from "../../components/qms/Badge";
import StatusDot from "../../components/qms/StatusDot";
import TabBar from "../../components/qms/TabBar";
import DataTable from "../../components/qms/DataTable";
import ActionBtn from "../../components/qms/ActionBtn";



interface DocRow {
  [key: string]: unknown;
  id: string;
  title: string;
  type: string;
  version: string;
  status: string;
  owner: string;
  reviewDate: string;
}

type StatusKey = "Действующий" | "Согласование" | "Пересмотр" | "Черновик";
type TypeKey =
  | "Руководство"
  | "Процедура"
  | "Инструкция"
  | "Форма"
  | "План"
  | "Спецификация"
  | "Внешний";



const STATUS_DOT: Record<StatusKey, "accent" | "blue" | "amber" | "grey"> = {
  "Действующий": "accent",
  "Согласование": "blue",
  "Пересмотр": "amber",
  "Черновик": "grey",
};

const TYPE_BADGE_COLOR: Record<TypeKey, string> = {
  "Руководство": "#4A90E8",
  "Процедура": "#2DD4A8",
  "Инструкция": "#A06AE8",
  "Форма": "#E8A830",
  "План": "#4A90E8",
  "Спецификация": "#E87040",
  "Внешний": "#3A4E62",
};



const DOCUMENTS: DocRow[] = [
  {
    id: "DOC-001",
    title: "Руководство по качеству",
    type: "Руководство",
    version: "v3.2",
    status: "Действующий",
    owner: "Холтобин А.",
    reviewDate: "15.06.2026",
  },
  {
    id: "DOC-015",
    title: "СТО-015 Управление NC",
    type: "Процедура",
    version: "v2.1",
    status: "Действующий",
    owner: "Костюков И.",
    reviewDate: "20.03.2026",
  },
  {
    id: "DOC-023",
    title: "RI-023 Пайка SMD",
    type: "Инструкция",
    version: "v1.4",
    status: "Действующий",
    owner: "Омельченко А.",
    reviewDate: "10.04.2026",
  },
  {
    id: "DOC-045",
    title: "СТО-045 Калибровка",
    type: "Процедура",
    version: "v2.0",
    status: "Пересмотр",
    owner: "Яровой Е.",
    reviewDate: "01.02.2026",
  },
  {
    id: "DOC-067",
    title: "Форма протокола NC",
    type: "Форма",
    version: "v1.2",
    status: "Действующий",
    owner: "Костюков И.",
    reviewDate: "30.07.2026",
  },
  {
    id: "DOC-089",
    title: "План аудитов 2026",
    type: "План",
    version: "v1.0",
    status: "Согласование",
    owner: "Холтобин А.",
    reviewDate: "\u2014",
  },
  {
    id: "DOC-102",
    title: "Спецификация DEXA-200",
    type: "Спецификация",
    version: "v1.1",
    status: "Черновик",
    owner: "Чирков И.",
    reviewDate: "\u2014",
  },
  {
    id: "DOC-115",
    title: "IEC 62368-1:2023",
    type: "Внешний",
    version: "\u2014",
    status: "Действующий",
    owner: "\u2014",
    reviewDate: "\u2014",
  },
];



const TABS = [
  { key: "all", label: "Все" },
  { key: "policy", label: "Политики" },
  { key: "procedure", label: "Процедуры" },
  { key: "instruction", label: "Инструкции" },
  { key: "form", label: "Формы" },
  { key: "record", label: "Записи" },
  { key: "external", label: "Внешние" },
];

const TAB_TYPE_MAP: Record<string, string | null> = {
  all: null,
  policy: "Руководство",
  procedure: "Процедура",
  instruction: "Инструкция",
  form: "Форма",
  record: "План",
  external: "Внешний",
};



const WORKFLOW_STEPS = [
  "Черновик",
  "Согласование",
  "Утверждение",
  "Действующий",
  "Пересмотр",
];
const ACTIVE_STEP = 3; 



const STATS = [
  { label: "Всего документов", value: 247, color: "#4A90E8" },
  { label: "Действующих", value: 189, color: "#2DD4A8" },
  { label: "На согласовании", value: 12, color: "#E8A830" },
  { label: "Просрочен пересмотр", value: 5, color: "#F06060" },
];



const columns = [
  {
    key: "id",
    label: "ID",
    width: "100px",
    render: (row: DocRow) => (
      <span className="font-mono text-[12px] font-bold text-asvo-accent">
        {row.id}
      </span>
    ),
  },
  {
    key: "title",
    label: "Название",
    render: (row: DocRow) => (
      <span className="font-medium text-asvo-text">{row.title}</span>
    ),
  },
  {
    key: "type",
    label: "Тип",
    width: "130px",
    render: (row: DocRow) => {
      const badgeColor = TYPE_BADGE_COLOR[row.type as TypeKey] ?? "#3A4E62";
      return (
        <Badge color={badgeColor} bg={`${badgeColor}22`}>
          {row.type}
        </Badge>
      );
    },
  },
  {
    key: "version",
    label: "Версия",
    width: "80px",
    render: (row: DocRow) => (
      <span className="font-mono text-[12px] text-asvo-text-mid">
        {row.version}
      </span>
    ),
  },
  {
    key: "status",
    label: "Статус",
    width: "140px",
    render: (row: DocRow) => {
      const dotColor = STATUS_DOT[row.status as StatusKey] ?? "grey";
      return (
        <span className="flex items-center gap-2">
          <StatusDot color={dotColor} />
          <span className="text-asvo-text text-[13px]">{row.status}</span>
        </span>
      );
    },
  },
  {
    key: "owner",
    label: "Владелец",
    width: "130px",
    render: (row: DocRow) => (
      <span className="text-asvo-text-mid text-[12px]">{row.owner}</span>
    ),
  },
  {
    key: "reviewDate",
    label: "Пересмотр",
    width: "110px",
    render: (row: DocRow) => (
      <span className="text-asvo-text-mid text-[12px]">{row.reviewDate}</span>
    ),
  },
  {
    key: "actions",
    label: "Действия",
    width: "50px",
    align: "center" as const,
    render: () => (
      <ChevronRight size={14} className="text-asvo-text-dim mx-auto" />
    ),
  },
];





export const DocumentsPage: React.FC = () => {
  const [search, setSearch] = useState("");
  const [activeTab, setActiveTab] = useState("all");

  
  const typeFilter = TAB_TYPE_MAP[activeTab] ?? null;
  const filtered = DOCUMENTS.filter((doc) => {
    if (typeFilter && doc.type !== typeFilter) return false;
    if (
      search &&
      !doc.id.toLowerCase().includes(search.toLowerCase()) &&
      !doc.title.toLowerCase().includes(search.toLowerCase())
    )
      return false;
    return true;
  });

  return (
    <div className="px-6 py-6 max-w-[1600px] mx-auto space-y-6">
      {}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-asvo-accent/15 rounded-xl flex items-center justify-center">
            <FileText className="w-5 h-5 text-asvo-accent" />
          </div>
          <div>
            <h1 className="text-xl font-bold text-asvo-text">
              Документы СМК
            </h1>
            <p className="text-[12px] text-asvo-text-dim">
              ISO 13485 &sect;4.2.4 &mdash; Управление документацией
            </p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <ActionBtn variant="primary" icon={<Plus size={14} />}>
            Создать документ
          </ActionBtn>
          <ActionBtn variant="secondary" icon={<Upload size={14} />}>
            Импорт
          </ActionBtn>
        </div>
      </div>

      {}
      <div className="flex items-center gap-4">
        <div className="relative w-full max-w-sm">
          <Search
            size={14}
            className="absolute left-3 top-1/2 -translate-y-1/2 text-asvo-text-dim"
          />
          <input
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Поиск по коду, названию..."
            className="w-full pl-9 pr-3 py-2 bg-asvo-surface border border-asvo-border rounded-lg text-[13px] text-asvo-text placeholder:text-asvo-text-dim focus:outline-none focus:border-asvo-accent/40 transition-colors"
          />
        </div>
      </div>

      <TabBar tabs={TABS} active={activeTab} onChange={setActiveTab} />

      {}
      <DataTable<DocRow>
        columns={columns}
        data={filtered}
      />

      {}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
        {}
        <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-5">
          <h3 className="text-[13px] font-semibold text-asvo-text mb-4">
            Процесс согласования документа
          </h3>
          <div className="flex items-center justify-between px-2">
            {WORKFLOW_STEPS.map((step, i) => {
              const isCompleted = i < ACTIVE_STEP;
              const isActive = i === ACTIVE_STEP;
              const isFuture = i > ACTIVE_STEP;

              return (
                <React.Fragment key={step}>
                  <div className="flex flex-col items-center gap-1.5">
                    <div
                      className={`w-7 h-7 rounded-full flex items-center justify-center text-[11px] font-bold transition-all ${
                        isActive
                          ? "bg-asvo-accent text-asvo-bg shadow-[0_0_10px_rgba(45,212,168,0.35)]"
                          : isCompleted
                          ? "border-2 border-asvo-accent text-asvo-accent bg-transparent"
                          : "border-2 border-asvo-border text-asvo-text-dim bg-transparent"
                      }`}
                    >
                      {isCompleted ? "\u2713" : i + 1}
                    </div>
                    <span
                      className={`text-[10px] whitespace-nowrap ${
                        isActive
                          ? "text-asvo-accent font-semibold"
                          : isCompleted
                          ? "text-asvo-accent"
                          : isFuture
                          ? "text-asvo-text-dim"
                          : "text-asvo-text-mid"
                      }`}
                    >
                      {step}
                    </span>
                  </div>
                  {i < WORKFLOW_STEPS.length - 1 && (
                    <div
                      className={`flex-1 h-[2px] mx-1.5 rounded ${
                        i < ACTIVE_STEP
                          ? "bg-asvo-accent"
                          : "bg-asvo-border"
                      }`}
                    />
                  )}
                </React.Fragment>
              );
            })}
          </div>
          <p className="text-[11px] text-asvo-text-dim mt-4">
            Документ DOC-089 &laquo;План аудитов 2026&raquo; ожидает
            согласования от руководителя отдела качества
          </p>
        </div>

        {}
        <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-5">
          <h3 className="text-[13px] font-semibold text-asvo-text mb-4">
            Статистика
          </h3>
          <div className="grid grid-cols-2 gap-4">
            {STATS.map((stat) => (
              <div key={stat.label} className="text-center">
                <div
                  className="text-2xl font-bold leading-none"
                  style={{ color: stat.color }}
                >
                  {stat.value}
                </div>
                <div className="text-[11px] text-asvo-text-dim mt-1.5">
                  {stat.label}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Login/Login.tsx
================================================================================

import { useContext, useState } from "react";
import { NavLink, useNavigate } from "react-router-dom";
import { login } from "src/api/userApi";
import { Context } from "src/main";
import { REGISTRATION_ROUTE, SELECT_PC_ROUTE } from "src/utils/consts";

export const Login: React.FC = () => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }

  const { user } = context;

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const navigate = useNavigate();

  const [loginName, setLoginName] = useState("");
  const [password, setPassword] = useState("");

  const signIN = async (event: React.FormEvent) => {
    event.preventDefault();

    try {
      const currentUser = await login(loginName, password);

      user.setUser(currentUser);
      user.setIsAuth(true);

      console.log(user.user);
      setSuccessMessage("Авторизация прошла успешно");
      setErrorMessage("");
      localStorage.removeItem("pcID");
      localStorage.removeItem("sessionID");

      setTimeout(() => {
        navigate(SELECT_PC_ROUTE);
        window.location.reload();
      }, 1000);
    } catch (error: any) {
      setErrorMessage(
        `Произошла ошибка при авторизации. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("Ошибка при регистрации:", error);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-asvo-dark">
      <div className="bg-asvo-dark-2 p-6 rounded-xl shadow-2xl border border-asvo-dark-3/50 w-full max-w-md">
        <h2 className="text-2xl font-bold mb-4 text-asvo-light">
          Войти в существующий аккаунт
        </h2>
        <form>
          <div className="mb-4">
            <label className="block text-asvo-muted text-sm font-bold mb-2">
              Логин
            </label>
            <input
              className="bg-asvo-dark border border-asvo-dark-3 rounded-lg w-full py-2 px-3 text-asvo-light mb-3 leading-tight focus:outline-none focus:border-asvo-accent focus:ring-1 focus:ring-asvo-accent"
              value={loginName}
              onChange={(e) => setLoginName(e.target.value)}
            />
          </div>
          <div className="mb-6">
            <label
              className="block text-asvo-muted text-sm font-bold mb-2"
              htmlFor="password"
            >
              Пароль
            </label>
            <input
              className="bg-asvo-dark border border-asvo-dark-3 rounded-lg w-full py-2 px-3 text-asvo-light mb-3 leading-tight focus:outline-none focus:border-asvo-accent focus:ring-1 focus:ring-asvo-accent"
              value={password}
              type="password"
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>
          <div className="flex items-center justify-between">
            <button
              onClick={signIN}
              type="submit"
              className="bg-asvo-accent hover:bg-asvo-accent-hover text-asvo-dark font-bold py-2 px-6 rounded-lg focus:outline-none transition-colors"
            >
              Войти
            </button>

            <NavLink
              to={REGISTRATION_ROUTE}
              className="inline-block align-baseline font-bold text-sm text-asvo-accent hover:text-asvo-accent-hover"
            >
              Нет аккаунта?
            </NavLink>
          </div>
        </form>
        {successMessage && (
          <div className="mt-4 text-asvo-accent font-medium">
            {successMessage}
          </div>
        )}
        {errorMessage && (
          <div className="mt-4 text-red-400 font-medium">{errorMessage}</div>
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Login/LoginPage.css
================================================================================


.theme-transition,
.theme-transition *,
.theme-transition *::before,
.theme-transition *::after {
  transition: background-color 0.5s ease, color 0.3s ease,
    border-color 0.4s ease, box-shadow 0.4s ease, opacity 0.4s ease !important;
}


.login-grid {
  background-image:
    linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
    linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
  background-size: 60px 60px;
}


.glow-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(120px);
  pointer-events: none;
  transition: transform 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94),
    opacity 0.5s ease;
}

.glow-orb-cyan {
  width: 500px;
  height: 500px;
  background: var(--accent);
  opacity: var(--glow-opacity);
  top: -10%;
  left: -5%;
}

.glow-orb-emerald {
  width: 400px;
  height: 400px;
  background: var(--accent-secondary);
  opacity: var(--glow-opacity);
  bottom: -10%;
  right: -5%;
}


@keyframes floatUp {
  0% {
    transform: translateY(100vh) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: var(--particle-opacity);
  }
  90% {
    opacity: var(--particle-opacity);
  }
  100% {
    transform: translateY(-10vh) rotate(360deg);
    opacity: 0;
  }
}

.particle {
  position: absolute;
  border-radius: 50%;
  pointer-events: none;
  animation: floatUp var(--duration) linear var(--delay) infinite;
  opacity: 0;
}


@keyframes spinRing {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.spin-ring {
  animation: spinRing 8s linear infinite;
}


@keyframes pulseIndicator {
  0%,
  100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.5;
    transform: scale(1.2);
  }
}

.pulse-indicator {
  animation: pulseIndicator 2s ease infinite;
}


.card-accent-line {
  height: 2px;
  background: linear-gradient(
    to right,
    transparent,
    var(--accent),
    var(--accent-secondary),
    transparent
  );
}


@keyframes slideInLeft {
  0% {
    opacity: 0;
    transform: translateX(-40px);
  }
  100% {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInUp {
  0% {
    opacity: 0;
    transform: translateY(30px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInStagger {
  0% {
    opacity: 0;
    transform: translateY(10px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}

.anim-slide-left {
  opacity: 0;
  animation: slideInLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s forwards;
}

.anim-slide-up {
  opacity: 0;
  animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s forwards;
}

.anim-fade-in {
  opacity: 0;
  animation: fadeIn 0.5s ease forwards;
}

.anim-stagger-1 {
  opacity: 0;
  animation: fadeInStagger 0.4s ease 0.6s forwards;
}
.anim-stagger-2 {
  opacity: 0;
  animation: fadeInStagger 0.4s ease 0.75s forwards;
}
.anim-stagger-3 {
  opacity: 0;
  animation: fadeInStagger 0.4s ease 0.9s forwards;
}

.anim-pills {
  opacity: 0;
  animation: fadeInStagger 0.4s ease 1s forwards;
}

.anim-footer {
  opacity: 0;
  animation: fadeIn 0.5s ease 1.2s forwards;
}


.btn-login {
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.btn-login:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 30px var(--btn-shadow), 0 8px 25px var(--shadow-card);
}


.glass-card {
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}


.theme-toggle {
  transition: all 0.3s ease;
}

.theme-toggle:hover {
  transform: scale(1.1);
}

.theme-toggle:active {
  transform: scale(0.95);
}


@media (max-width: 1023px) {
  .particle {
    display: none;
  }
}

================================================================================
FILE: QMS-Client-main/src/pages/Login/LoginPage.tsx
================================================================================

import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { Sun, Moon, ShieldCheck, Hexagon, Link2, LayoutGrid } from 'lucide-react';
import { themes, type Theme } from './themes';
import './LoginPage.css';

interface LoginPageProps {
  onLogin: () => void;
}

const MODULE_PILLS = [
  'Document Control',
  'NC / CAPA',
  'Risk Management',
  'Internal Audits',
  'Supplier QA',
  'Training Records',
];

const STATS = [
  { icon: <ShieldCheck size={18} />, label: 'ISO 13485', sub: 'Certified' },
  { icon: <Link2 size={18} />, label: 'Hash-Chain', sub: 'Audit Trail' },
  { icon: <LayoutGrid size={18} />, label: '12 Modules', sub: 'Integrated' },
];

function generateParticles(count: number) {
  return Array.from({ length: count }, (_, i) => ({
    id: i,
    left: Math.random() * 100,
    size: Math.random() * 3 + 1,
    duration: Math.random() * 15 + 15,
    delay: Math.random() * 20,
    color: Math.random() > 0.5 ? 'var(--accent)' : 'var(--accent-secondary)',
  }));
}

export const LoginPage: React.FC<LoginPageProps> = ({ onLogin }) => {
  const [theme, setTheme] = useState<Theme>(() => {
    return (localStorage.getItem('qms-theme') as Theme) || 'dark';
  });
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [clock, setClock] = useState('');
  const [mousePos, setMousePos] = useState({ x: 0.5, y: 0.5 });
  const containerRef = useRef<HTMLDivElement>(null);

  const particles = useMemo(() => generateParticles(40), []);

  
  useEffect(() => {
    const root = containerRef.current;
    if (!root) return;
    const vars = themes[theme];
    for (const [key, value] of Object.entries(vars)) {
      root.style.setProperty(key, value);
    }
  }, [theme]);

  
  useEffect(() => {
    const tick = () => {
      const now = new Date();
      setClock(
        now.toLocaleTimeString('ru-RU', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
        })
      );
    };
    tick();
    const id = setInterval(tick, 1000);
    return () => clearInterval(id);
  }, []);

  
  const handleMouseMove = useCallback((e: React.MouseEvent) => {
    if (window.innerWidth < 1024) return;
    const rect = (e.currentTarget as HTMLElement).getBoundingClientRect();
    setMousePos({
      x: (e.clientX - rect.left) / rect.width,
      y: (e.clientY - rect.top) / rect.height,
    });
  }, []);

  const toggleTheme = () => {
    setIsTransitioning(true);
    const next: Theme = theme === 'dark' ? 'light' : 'dark';
    setTheme(next);
    localStorage.setItem('qms-theme', next);
    setTimeout(() => setIsTransitioning(false), 600);
  };

  const gridTransform = `translate(${(mousePos.x - 0.5) * 8}px, ${(mousePos.y - 0.5) * 8}px)`;
  const orbCyanTransform = `translate(${(mousePos.x - 0.5) * 40}px, ${(mousePos.y - 0.5) * 40}px)`;
  const orbEmeraldTransform = `translate(${(mousePos.x - 0.5) * -30}px, ${(mousePos.y - 0.5) * -30}px)`;

  return (
    <div
      ref={containerRef}
      onMouseMove={handleMouseMove}
      className={`min-h-screen flex flex-col ${isTransitioning ? 'theme-transition' : ''}`}
      style={{
        background: `linear-gradient(135deg, var(--bg-primary), var(--bg-secondary), var(--bg-tertiary))`,
        fontFamily: "'DM Sans', sans-serif",
        ...Object.fromEntries(
          Object.entries(themes[theme]).map(([k, v]) => [k, v])
        ),
      }}
    >
      {}
      <div className="fixed inset-0 pointer-events-none overflow-hidden">
        {}
        <div
          className="absolute inset-0 login-grid"
          style={{ transform: gridTransform }}
        />

        {}
        <div
          className="glow-orb glow-orb-cyan"
          style={{ transform: orbCyanTransform }}
        />
        <div
          className="glow-orb glow-orb-emerald"
          style={{ transform: orbEmeraldTransform }}
        />

        {}
        {particles.map((p) => (
          <div
            key={p.id}
            className="particle"
            style={{
              left: `${p.left}%`,
              width: `${p.size}px`,
              height: `${p.size}px`,
              background: p.color,
              '--duration': `${p.duration}s`,
              '--delay': `${p.delay}s`,
            } as React.CSSProperties}
          />
        ))}
      </div>

      {}
      <div className="flex-1 flex items-center justify-center relative z-10 px-4 py-8 lg:py-0">
        <div className="w-full max-w-6xl flex flex-col lg:flex-row items-center lg:items-stretch gap-8 lg:gap-16">

          {}
          <div className="hidden lg:flex flex-col justify-center flex-1 anim-slide-left max-w-lg">
            {}
            <div className="flex items-center gap-3 mb-8">
              <div
                className="w-10 h-10 rounded-lg flex items-center justify-center"
                style={{
                  background: `linear-gradient(135deg, var(--accent), var(--accent-secondary))`,
                }}
              >
                <Hexagon size={20} style={{ color: 'var(--bg-primary)' }} strokeWidth={2} />
              </div>
              <span
                className="text-sm font-medium tracking-widest uppercase"
                style={{
                  color: 'var(--text-body)',
                  fontFamily: "'JetBrains Mono', monospace",
                }}
              >
                ASVOTECH
              </span>
            </div>

            {}
            <h1
              className="text-5xl xl:text-6xl leading-tight mb-6"
              style={{
                fontFamily: "'Instrument Serif', serif",
                color: 'var(--text-heading)',
              }}
            >
              Quality
              <br />
              <span
                style={{
                  background: 'linear-gradient(to right, var(--accent), var(--accent-secondary))',
                  WebkitBackgroundClip: 'text',
                  WebkitTextFillColor: 'transparent',
                }}
              >
                Management
              </span>
              <br />
              System
            </h1>

            {}
            <p
              className="text-base leading-relaxed mb-10 max-w-md"
              style={{ color: 'var(--text-body)' }}
            >
              Платформа управления качеством для производителей медицинских изделий.
              <br />
              <span
                className="text-sm"
                style={{
                  fontFamily: "'JetBrains Mono', monospace",
                  color: 'var(--text-muted)',
                }}
              >
                ISO 13485 · ГОСТ ISO 13485-2017
              </span>
            </p>

            {}
            <div className="flex gap-4 mb-8">
              {STATS.map((stat, i) => (
                <div
                  key={stat.label}
                  className={`flex items-center gap-3 px-4 py-3 rounded-xl anim-stagger-${i + 1}`}
                  style={{
                    background: 'var(--stat-bg)',
                    border: '1px solid var(--stat-border)',
                  }}
                >
                  <span style={{ color: 'var(--accent)' }}>{stat.icon}</span>
                  <div>
                    <div
                      className="text-xs font-semibold"
                      style={{
                        color: 'var(--text-heading)',
                        fontFamily: "'JetBrains Mono', monospace",
                      }}
                    >
                      {stat.label}
                    </div>
                    <div
                      className="text-[11px]"
                      style={{ color: 'var(--text-muted)' }}
                    >
                      {stat.sub}
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {}
            <div className="flex flex-wrap gap-2 anim-pills">
              {MODULE_PILLS.map((pill) => (
                <span
                  key={pill}
                  className="px-3 py-1.5 rounded-full text-xs"
                  style={{
                    background: 'var(--pill-bg)',
                    border: '1px solid var(--pill-border)',
                    color: 'var(--pill-text)',
                    fontFamily: "'JetBrains Mono', monospace",
                  }}
                >
                  {pill}
                </span>
              ))}
            </div>
          </div>

          {}
          <div className="w-full max-w-md anim-slide-up">
            {}
            <div className="flex justify-end mb-4">
              <button
                onClick={toggleTheme}
                className="theme-toggle w-10 h-10 rounded-xl flex items-center justify-center"
                style={{
                  background: 'var(--toggle-bg)',
                  border: '1px solid var(--toggle-border)',
                  color: 'var(--text-body)',
                }}
                aria-label="Toggle theme"
              >
                {theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
              </button>
            </div>

            {}
            <div
              className="glass-card rounded-2xl overflow-hidden"
              style={{
                background: 'var(--bg-card)',
                border: '1px solid var(--border-card)',
                boxShadow: `0 25px 50px -12px var(--shadow-card)`,
              }}
            >
              {}
              <div className="card-accent-line" />

              <div className="p-8 md:p-10">
                {}
                <div className="flex justify-center mb-6">
                  <div className="relative w-20 h-20 flex items-center justify-center">
                    {}
                    <div
                      className="spin-ring absolute inset-0 rounded-full"
                      style={{
                        border: '2px solid transparent',
                        borderTopColor: 'var(--accent)',
                        borderRightColor: 'var(--accent-secondary)',
                        opacity: 0.4,
                      }}
                    />
                    {}
                    <div
                      className="w-14 h-14 rounded-2xl flex items-center justify-center"
                      style={{
                        background: `linear-gradient(135deg, var(--accent), var(--accent-secondary))`,
                      }}
                    >
                      <Hexagon
                        size={28}
                        strokeWidth={1.5}
                        style={{ color: theme === 'dark' ? '#0a0e1a' : '#ffffff' }}
                      />
                    </div>
                  </div>
                </div>

                {}
                <h2
                  className="text-2xl font-bold text-center mb-1"
                  style={{
                    color: 'var(--text-heading)',
                    fontFamily: "'JetBrains Mono', monospace",
                  }}
                >
                  ASVO-QMS
                </h2>
                <p
                  className="text-sm text-center mb-8"
                  style={{ color: 'var(--text-body)' }}
                >
                  Система управления качеством
                </p>

                {}
                <button
                  onClick={onLogin}
                  className="btn-login w-full flex items-center justify-center gap-3 py-4 px-6 rounded-xl font-semibold text-sm"
                  style={{
                    background: 'var(--btn-idle-bg)',
                    border: '1px solid var(--btn-idle-border)',
                    color: 'var(--accent)',
                  }}
                  onMouseEnter={(e) => {
                    const el = e.currentTarget;
                    el.style.background = 'var(--btn-hover-bg)';
                    el.style.color = 'var(--btn-hover-text)';
                    el.style.borderColor = 'var(--btn-hover-bg)';
                  }}
                  onMouseLeave={(e) => {
                    const el = e.currentTarget;
                    el.style.background = 'var(--btn-idle-bg)';
                    el.style.color = 'var(--accent)';
                    el.style.borderColor = 'var(--btn-idle-border)';
                  }}
                >
                  <ShieldCheck size={18} />
                  <span>Войти через Keycloak</span>
                </button>

                {}
                <div className="flex items-center gap-3 my-6">
                  <div
                    className="flex-1 h-px"
                    style={{ background: 'var(--divider-color)' }}
                  />
                  <span
                    className="text-[11px] tracking-widest uppercase"
                    style={{
                      color: 'var(--text-muted)',
                      fontFamily: "'JetBrains Mono', monospace",
                    }}
                  >
                    SSO
                  </span>
                  <div
                    className="flex-1 h-px"
                    style={{ background: 'var(--divider-color)' }}
                  />
                </div>

                {}
                <div
                  className="rounded-xl p-4 mb-6 text-xs leading-relaxed"
                  style={{
                    background: 'var(--info-bg)',
                    border: '1px solid var(--info-border)',
                    color: 'var(--text-body)',
                  }}
                >
                  Единая авторизация через корпоративный Keycloak. Все действия
                  записываются в неизменяемый журнал аудита.
                </div>

                {}
                <div
                  className="flex items-center justify-center gap-4 text-[11px]"
                  style={{
                    color: 'var(--text-muted)',
                    fontFamily: "'JetBrains Mono', monospace",
                  }}
                >
                  <span className="flex items-center gap-1">
                    <Link2 size={12} style={{ color: 'var(--accent)' }} />
                    Hash-Chain
                  </span>
                  <span style={{ color: 'var(--divider-color)' }}>·</span>
                  <span className="flex items-center gap-1">
                    <ShieldCheck size={12} style={{ color: 'var(--accent)' }} />
                    RBAC
                  </span>
                  <span style={{ color: 'var(--divider-color)' }}>·</span>
                  <span>21 CFR 11</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {}
      <footer
        className="relative z-10 py-3 px-6 flex items-center justify-between text-[11px] anim-footer"
        style={{
          borderTop: '1px solid var(--footer-border)',
          background: 'var(--footer-bg)',
          color: 'var(--text-muted)',
          fontFamily: "'JetBrains Mono', monospace",
        }}
      >
        <span>© 2025 ASVOTECH · v2.1.0</span>
        <span className="hidden sm:flex items-center gap-2">
          <span
            className="pulse-indicator inline-block w-2 h-2 rounded-full"
            style={{ background: '#22c55e' }}
          />
          {clock}
        </span>
      </footer>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Login/Registration.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useState } from "react";
import { useNavigate } from "react-router-dom";
import { registration } from "src/api/userApi";
import { Context } from "src/main";
import { SELECT_PC_ROUTE } from "src/utils/consts";

export const Registration: React.FC = observer(() => {
  const context = useContext(Context);

  if (!context) {
    throw new Error("Context must be used within a Provider");
  }
  const { user } = context;

  const [successMessage, setSuccessMessage] = useState("");
  const [errorMessage, setErrorMessage] = useState("");

  const navigate = useNavigate();

  const [login, setLogin] = useState("");
  const [password, setPassword] = useState("");
  const [name, setName] = useState("");
  const [surname, setSurname] = useState("");

  const signUP = async (event: React.FormEvent) => {
    event.preventDefault();
    try {
      const currentUser = await registration(login, password, name, surname);
      user.setUser(currentUser);
      user.setIsAuth(true);
      setSuccessMessage("Регистрация прошла успешно!");
      setErrorMessage("");
      localStorage.removeItem("pcID");
      localStorage.removeItem("sessionID");
      setTimeout(() => {
        navigate(SELECT_PC_ROUTE);
        window.location.reload();

      }, 2000);
    } catch (error: any) {
      setErrorMessage(
        `Произошла ошибка при регистрации. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("Ошибка при регистрации:", error);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-yellow-200 to-green-300">
      <div className="max-w-md w-full p-6 bg-white shadow-md rounded-lg">
        <h2 className="text-2xl font-semibold mb-4">Регистрация</h2>

        <form>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">
              Логин
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={login}
              onChange={(e) => setLogin(e.target.value)}
            />
          </div>

          <div className="mb-4">
            <label
              htmlFor="password"
              className="block text-sm font-medium text-gray-700"
            >
              Пароль
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={password}
              type="password"
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">
              Имя
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={name}
              onChange={(e) => setName(e.target.value)}
            />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">
              Фамилия
            </label>
            <input
              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring focus:ring-blue-300 focus:border-blue-500"
              value={surname}
              onChange={(e) => setSurname(e.target.value)}
            />
          </div>

          <div className="mb-4">
            <button
              onClick={signUP}
              type="submit"
              className="w-full bg-blue-500 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring focus:ring-blue-300"
            >
              Зарегистрироваться
            </button>
          </div>
        </form>
        {successMessage && (
          <div className="mt-4 text-green-500 font-medium">
            {successMessage}
          </div>
        )}
        {errorMessage && (
          <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
        )}
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Login/themes.ts
================================================================================

export const themes = {
  dark: {
    '--bg-primary': '#0a0e1a',
    '--bg-secondary': '#0d1321',
    '--bg-tertiary': '#0f1729',
    '--bg-card': 'rgba(15, 23, 42, 0.6)',
    '--bg-card-hover': 'rgba(15, 23, 42, 0.7)',
    '--border-card': 'rgba(51, 65, 85, 0.4)',
    '--text-heading': '#f1f5f9',
    '--text-body': '#94a3b8',
    '--text-muted': '#475569',
    '--accent': '#06b6d4',
    '--accent-secondary': '#10b981',
    '--accent-darker': '#0891b2',
    '--btn-idle-bg': 'rgba(6, 182, 212, 0.12)',
    '--btn-idle-border': 'rgba(6, 182, 212, 0.3)',
    '--btn-hover-bg': '#06b6d4',
    '--btn-hover-text': '#0a0e1a',
    '--btn-shadow': 'rgba(6, 182, 212, 0.25)',
    '--grid-color': 'rgba(56, 189, 248, 0.03)',
    '--glow-opacity': '0.12',
    '--particle-opacity': '0.3',
    '--info-bg': 'rgba(6, 182, 212, 0.04)',
    '--info-border': 'rgba(6, 182, 212, 0.1)',
    '--footer-border': 'rgba(30, 41, 59, 0.5)',
    '--footer-bg': 'rgba(10, 14, 26, 0.8)',
    '--shadow-card': 'rgba(0, 0, 0, 0.4)',
    '--pill-bg': 'rgba(6, 182, 212, 0.08)',
    '--pill-border': 'rgba(6, 182, 212, 0.15)',
    '--pill-text': '#67e8f9',
    '--stat-bg': 'rgba(15, 23, 42, 0.5)',
    '--stat-border': 'rgba(51, 65, 85, 0.3)',
    '--divider-color': 'rgba(51, 65, 85, 0.5)',
    '--toggle-bg': 'rgba(15, 23, 42, 0.6)',
    '--toggle-border': 'rgba(51, 65, 85, 0.4)',
  },
  light: {
    '--bg-primary': '#f8fafc',
    '--bg-secondary': '#f1f5f9',
    '--bg-tertiary': '#e2e8f0',
    '--bg-card': 'rgba(255, 255, 255, 0.8)',
    '--bg-card-hover': 'rgba(255, 255, 255, 0.9)',
    '--border-card': 'rgba(203, 213, 225, 0.6)',
    '--text-heading': '#0f172a',
    '--text-body': '#475569',
    '--text-muted': '#94a3b8',
    '--accent': '#0891b2',
    '--accent-secondary': '#059669',
    '--accent-darker': '#0e7490',
    '--btn-idle-bg': 'rgba(6, 182, 212, 0.08)',
    '--btn-idle-border': 'rgba(6, 182, 212, 0.25)',
    '--btn-hover-bg': '#0891b2',
    '--btn-hover-text': '#ffffff',
    '--btn-shadow': 'rgba(6, 182, 212, 0.2)',
    '--grid-color': 'rgba(6, 182, 212, 0.04)',
    '--glow-opacity': '0.06',
    '--particle-opacity': '0.1',
    '--info-bg': 'rgba(6, 182, 212, 0.05)',
    '--info-border': 'rgba(6, 182, 212, 0.12)',
    '--footer-border': 'rgba(226, 232, 240, 0.8)',
    '--footer-bg': 'rgba(248, 250, 252, 0.8)',
    '--shadow-card': 'rgba(0, 0, 0, 0.08)',
    '--pill-bg': 'rgba(6, 182, 212, 0.06)',
    '--pill-border': 'rgba(6, 182, 212, 0.12)',
    '--pill-text': '#0e7490',
    '--stat-bg': 'rgba(255, 255, 255, 0.6)',
    '--stat-border': 'rgba(203, 213, 225, 0.4)',
    '--divider-color': 'rgba(203, 213, 225, 0.5)',
    '--toggle-bg': 'rgba(255, 255, 255, 0.8)',
    '--toggle-border': 'rgba(203, 213, 225, 0.6)',
  },
} as const;

export type Theme = keyof typeof themes;

================================================================================
FILE: QMS-Client-main/src/pages/Nonconformity/NonconformityPage.tsx
================================================================================







import React from "react";
import {
  AlertTriangle, Plus, Download, ClipboardList,
} from "lucide-react";
import Badge from "src/components/qms/Badge";
import StatusDot from "src/components/qms/StatusDot";
import ProgressBar from "src/components/qms/ProgressBar";



interface NcRow {
  id: string;
  title: string;
  source: string;
  classification: "Критическое" | "Серьёзное" | "Незначительное";
  status: string;
  statusDot: "red" | "blue" | "purple" | "amber" | "accent";
  responsible: string;
  date: string;
  due: string;
}

const ncRows: NcRow[] = [
  { id: "NC-091", title: "Дефект покрытия корпуса DEXA-200", source: "Входной контроль", classification: "Критическое", status: "Открыто", statusDot: "red", responsible: "Омельченко А.", date: "11.02.2026", due: "13.02.2026" },
  { id: "NC-089", title: "Дефект пайки разъёма J4", source: "В процессе", classification: "Серьёзное", status: "Расследование", statusDot: "blue", responsible: "Омельченко А.", date: "09.02.2026", due: "14.02.2026" },
  { id: "NC-088", title: "Отклонение размеров корпуса", source: "Выходной контроль", classification: "Незначительное", status: "Диспозиция", statusDot: "purple", responsible: "Костюков И.", date: "06.02.2026", due: "16.02.2026" },
  { id: "NC-087", title: "Нарушение маркировки партии", source: "В процессе", classification: "Незначительное", status: "Верификация", statusDot: "amber", responsible: "Яровой Е.", date: "03.02.2026", due: "10.02.2026" },
  { id: "NC-086", title: "Некомплект поставки SUP-003", source: "Поставщик", classification: "Серьёзное", status: "Закрыто", statusDot: "accent", responsible: "Холтобин А.", date: "29.01.2026", due: "05.02.2026" },
  { id: "NC-085", title: "Поставка некомплект", source: "Поставщик", classification: "Незначительное", status: "Закрыто", statusDot: "accent", responsible: "Костюков И.", date: "25.01.2026", due: "28.01.2026" },
];

const workflowSteps = [
  { label: "Регистрация", active: true },
  { label: "Расследование", active: true },
  { label: "Диспозиция", active: false },
  { label: "Коррекция", active: false },
  { label: "Верификация", active: false },
  { label: "Закрытие", active: false },
];

const paretoItems: { label: string; pct: number; color: "red" | "amber" | "blue" | "purple" | "accent" }[] = [
  { label: "Дефект пайки", pct: 35, color: "red" },
  { label: "Входной контроль", pct: 25, color: "amber" },
  { label: "Размеры", pct: 18, color: "blue" },
  { label: "Маркировка", pct: 12, color: "purple" },
  { label: "Прочее", pct: 10, color: "accent" },
];

const classificationBadge: Record<string, { color: string; bg: string }> = {
  "Критическое":   { color: "#F06060", bg: "rgba(240,96,96,0.12)" },
  "Серьёзное":     { color: "#E8A830", bg: "rgba(232,168,48,0.12)" },
  "Незначительное": { color: "#8899AB", bg: "rgba(58,78,98,0.25)" },
};



export const NonconformityPage: React.FC = () => {
  return (
    <div className="min-h-screen bg-asvo-bg p-6 space-y-6">
      {}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-asvo-red-dim rounded-xl flex items-center justify-center">
            <AlertTriangle className="w-5 h-5 text-asvo-red" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-asvo-text">Несоответствия</h1>
            <p className="text-sm text-asvo-text-dim">ISO 13485 §8.3 — Управление несоответствующей продукцией</p>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <button className="flex items-center gap-2 px-4 py-2 bg-asvo-accent text-asvo-bg rounded-lg text-sm font-semibold hover:brightness-110 transition">
            <Plus size={16} />
            Регистрировать NC
          </button>
          <button className="flex items-center gap-2 px-4 py-2 border border-asvo-border text-asvo-text-mid rounded-lg text-sm font-medium hover:border-asvo-text-dim transition">
            <Download size={16} />
            Экспорт
          </button>
        </div>
      </div>

      {}
      <div className="grid grid-cols-4 gap-4">
        {[
          { label: "Всего NC", value: 47, cls: "text-asvo-blue" },
          { label: "Открытых", value: 8, cls: "text-asvo-red" },
          { label: "Просрочено", value: 3, cls: "text-asvo-red" },
          { label: "Закрыто (мес.)", value: 12, cls: "text-asvo-accent" },
        ].map((kpi) => (
          <div key={kpi.label} className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-4">
            <div className={`text-2xl font-bold ${kpi.cls}`}>{kpi.value}</div>
            <div className="text-xs text-asvo-text-dim mt-1">{kpi.label}</div>
          </div>
        ))}
      </div>

      {}
      <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl overflow-hidden">
        <table className="w-full">
          <thead>
            <tr className="bg-asvo-surface border-b border-asvo-border">
              {["ID", "Название", "Источник", "Классификация", "Статус", "Ответственный", "Дата", "Срок"].map((col) => (
                <th key={col} className="text-left px-4 py-3 text-[11px] font-semibold text-asvo-text-dim uppercase tracking-wider">
                  {col}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {ncRows.map((row) => {
              const cls = classificationBadge[row.classification];
              return (
                <tr
                  key={row.id}
                  className="border-b border-asvo-border/30 hover:bg-asvo-surface-3 transition-colors cursor-pointer"
                >
                  <td className="px-4 py-3 text-sm font-mono font-bold text-asvo-accent">{row.id}</td>
                  <td className="px-4 py-3 text-sm text-asvo-text">{row.title}</td>
                  <td className="px-4 py-3">
                    <Badge variant="audit">{row.source}</Badge>
                  </td>
                  <td className="px-4 py-3">
                    <Badge color={cls.color} bg={cls.bg}>{row.classification}</Badge>
                  </td>
                  <td className="px-4 py-3">
                    <span className="flex items-center gap-2 text-sm text-asvo-text">
                      <StatusDot color={row.statusDot} />
                      {row.status}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-sm text-asvo-text-mid">{row.responsible}</td>
                  <td className="px-4 py-3 text-sm text-asvo-text-mid">{row.date}</td>
                  <td className="px-4 py-3 text-sm text-asvo-text-mid">{row.due}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {}
      <div className="grid grid-cols-2 gap-6">
        {}
        <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-5">
          <div className="flex items-center gap-2 mb-4">
            <ClipboardList size={16} className="text-asvo-accent" />
            <h3 className="text-sm font-semibold text-asvo-text">Workflow несоответствия</h3>
          </div>

          <div className="flex flex-col gap-1">
            {workflowSteps.map((step, idx) => (
              <div
                key={step.label}
                className={`flex items-center gap-3 px-3 py-2.5 rounded-r-lg border-l-[3px] ${
                  step.active
                    ? "border-l-asvo-accent bg-asvo-accent-dim"
                    : "border-l-asvo-border bg-transparent"
                }`}
              >
                <span
                  className={`text-xs font-bold w-5 text-center ${
                    step.active ? "text-asvo-accent" : "text-asvo-text-dim"
                  }`}
                >
                  {idx + 1}
                </span>
                <span
                  className={`text-sm font-medium ${
                    step.active ? "text-asvo-accent" : "text-asvo-text-dim"
                  }`}
                >
                  {step.label}
                </span>
              </div>
            ))}
          </div>
        </div>

        {}
        <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-5">
          <h3 className="text-sm font-semibold text-asvo-text mb-4">Pareto: источники NC (30 дн.)</h3>

          <div className="flex flex-col gap-3">
            {paretoItems.map((item) => (
              <div key={item.label}>
                <div className="flex items-center justify-between mb-1">
                  <span className="text-sm text-asvo-text">{item.label}</span>
                  <span className="text-sm font-semibold text-asvo-text-mid">{item.pct}%</span>
                </div>
                <ProgressBar value={item.pct} color={item.color} />
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/PCs/OnePC.tsx
================================================================================

import clsx from "clsx";

interface OnePCProps {
  active: boolean;
  onClick: () => void;
  PCname: string;
  IP: string;
  userName: string;
  userSurname: string;
}

export const OnePC: React.FC<OnePCProps> = ({
  active,
  onClick,
  PCname,
  IP,
  userName,
  userSurname
}) => {
  return (
    <div className="flex justify-center items-center">
      <div
        className={clsx(
          "p-3 rounded-lg shadow-md mb-2 border-l-4 transition duration-200 w-1/3",
          active
            ? "bg-red-500 text-white border-red-700 pointer-events-none opacity-70"
            : "bg-gray-100 text-gray-800 border-emerald-500 hover:bg-gray-400 cursor-pointer"
        )}
        onClick={!active ? onClick : undefined}
      >
        <p className="text-lg font-semibold">{PCname}</p>
        <p className="text-sm">{IP}</p>

        {active && (
          <p className="text-xs font-semibold mt-2 bg-red-700 px-2 py-1 rounded-md text-center">
            ПК занят {userName} {userSurname}
          </p>
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/PCs/SelectPC.tsx
================================================================================

import { observer } from "mobx-react-lite";
import { useContext, useEffect, useMemo, useState } from "react";
import { Context } from "src/main";
import {
  fetchPC,
  fetchSession,
  fetchUsers,
  setSessionOnline,
} from "src/api/userApi";
import { pcModelFull } from "src/types/PCModel";
import { SessionModelFull } from "src/types/SessionModel";
import { useNavigate } from "react-router-dom";
import { START_ROUTE } from "src/utils/consts";
import { userGetModel } from "src/types/UserModel";
import { Monitor, Search, MapPin, User, Lock, Wifi, Laptop } from "lucide-react";

export const SelectPC: React.FC = observer(() => {
  const context = useContext(Context);
  const navigate = useNavigate();
  const [searchTerm, setSearchTerm] = useState("");

  if (!context) throw new Error("Context required");
  const { user } = context;

  const [pcs, setPcs] = useState<pcModelFull[]>([]);
  const [sessions, setSessions] = useState<SessionModelFull[]>([]);
  const [users, setUsers] = useState<userGetModel[]>([]);

  useEffect(() => {

    if (!user.isAuth) return;

    const loadData = async () => {

      try {
        const [pcsData, sessionsData] = await Promise.all([fetchPC(), fetchSession()]);
        setPcs(pcsData);
        setSessions(sessionsData);
      } catch (error) {
        console.error("Ошибка при загрузке списка ПК:", error);
      }


      try {
        const usersData = await fetchUsers();
        setUsers(usersData);
      } catch (error) {
        console.warn("Не удалось загрузить список пользователей (возможно ограничены права):", error);
      }
    };

    loadData();
  }, [user.isAuth]);


  const getActiveSessionInfo = (pcId: number) => {
    const session = sessions.find(
      (s: SessionModelFull) => s.online === true && s.PCId === pcId
    );

    if (!session) return null;

    const sessionUser = users.find(
      (u: userGetModel) => u.id === session.userId
    );


    return sessionUser
      ? { name: sessionUser.name, surname: sessionUser.surname }
      : { name: "Сотрудник", surname: `ID: ${session.userId}` };
  };


  const handleSelectPC = async (pcId: number | null) => {
    const userIdStr = localStorage.getItem("userID");
    if (!userIdStr) {
        alert("Ошибка: ID пользователя не найден. Попробуйте перезайти (F5).");
        return;
    }
    const userId = Number(userIdStr);

    try {
        await setSessionOnline(true, userId, pcId);
        navigate(START_ROUTE);
    } catch (error: any) {
        console.error("Ошибка при выборе ПК:", error);
        alert("Не удалось выбрать рабочее место.");
    }
  };


  const groupedPCs = useMemo(() => {
    const filtered = pcs.filter(pc =>
        pc.pc_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        pc.ip.includes(searchTerm) ||
        pc.cabinet?.toLowerCase().includes(searchTerm.toLowerCase())
    );

    const groups: Record<string, pcModelFull[]> = {};

    filtered.forEach(pc => {
        const cab = pc.cabinet || "Без кабинета";
        if (!groups[cab]) groups[cab] = [];
        groups[cab].push(pc);
    });

    return groups;
  }, [pcs, searchTerm]);

  return (
    <div className="min-h-screen bg-slate-50 relative overflow-hidden font-sans flex flex-col">


      <div className="absolute inset-0 z-0 pointer-events-none">
          <div className="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]"></div>
          <div className="absolute left-0 right-0 top-0 -z-10 m-auto h-[500px] w-[500px] rounded-full bg-blue-400 opacity-10 blur-[120px]"></div>
      </div>

      <div className="relative z-10 container mx-auto px-4 py-8 flex flex-col h-screen">


        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 className="text-3xl font-extrabold text-slate-800 flex items-center gap-3">
                    <Monitor className="text-indigo-600" size={32}/>
                    Рабочее место
                </h1>
                <p className="text-slate-500">Выберите компьютер для начала смены</p>
            </div>


            <div className="relative w-full md:w-96">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Search className="text-gray-400" size={20}/>
                </div>
                <input
                    type="text"
                    className="block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 transition shadow-sm"
                    placeholder="Найти ПК по имени или IP..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                />
            </div>
        </div>


        <div className="mb-8 animate-fadeIn">
            <button
                onClick={() => handleSelectPC(null)}
                className="w-full md:w-auto flex items-center justify-center gap-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all group border border-purple-400"
            >
                <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm group-hover:bg-white/30 transition">
                    <Laptop size={32} />
                </div>
                <div className="text-left">
                    <h3 className="font-bold text-lg">Я на личном ноутбуке</h3>
                    <p className="text-purple-100 text-sm">Работать без привязки к стационарному ПК</p>
                </div>
            </button>
        </div>


        <div className="flex-1 overflow-y-auto pr-2 pb-10 custom-scrollbar">


            {localStorage.getItem("pcID") && (
                 <div className="mb-8 p-4 bg-yellow-50 border border-yellow-200 rounded-xl flex items-start gap-3 animate-fadeIn">
                     <div className="p-2 bg-yellow-100 rounded-full text-yellow-600">
                         <Lock size={20}/>
                     </div>
                     <div>
                         <h3 className="font-bold text-yellow-800">Внимание</h3>
                         <p className="text-sm text-yellow-700">
                             У вас уже выбран ПК в прошлой сессии. Чтобы сменить его, выйдите из системы и зайдите снова.
                         </p>
                     </div>
                 </div>
            )}

            {Object.keys(groupedPCs).length === 0 ? (
                <div className="text-center py-20 text-gray-400">
                    Компьютеры не найдены (или загружаются)
                </div>
            ) : (
                Object.entries(groupedPCs).map(([cabinet, pcsGroup]) => (
                    <div key={cabinet} className="mb-8">
                        <div className="flex items-center gap-2 mb-4 px-2">
                            <MapPin className="text-indigo-500" size={18}/>
                            <h2 className="text-lg font-bold text-gray-700 uppercase tracking-wide">
                                {cabinet}
                            </h2>
                            <span className="text-xs font-medium bg-gray-100 text-gray-500 px-2 py-1 rounded-full">
                                {pcsGroup.length} шт.
                            </span>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                            {pcsGroup.map(pc => {
                                const activeUser = getActiveSessionInfo(pc.id);
                                const isOccupied = !!activeUser;
                                const isMyPC = localStorage.getItem("pcID") === String(pc.id);

                                return (
                                    <button
                                        key={pc.id}
                                        disabled={isOccupied}
                                        onClick={() => handleSelectPC(pc.id)}
                                        className={`relative group text-left p-4 rounded-2xl border transition-all duration-200 flex flex-col gap-3
                                            ${isOccupied
                                                ? "bg-slate-50 border-slate-200 opacity-80 cursor-not-allowed"
                                                : "bg-white border-slate-200 hover:border-indigo-400 hover:shadow-lg hover:-translate-y-1 cursor-pointer"
                                            }
                                            ${isMyPC ? "ring-2 ring-indigo-500 border-indigo-500 bg-indigo-50" : ""}
                                        `}
                                    >
                                        <div className="flex justify-between items-start">
                                            <div className={`p-2.5 rounded-xl ${isOccupied ? "bg-red-100 text-red-500" : "bg-emerald-100 text-emerald-600"}`}>
                                                <Monitor size={22} strokeWidth={2}/>
                                            </div>
                                            {isOccupied ? (
                                                <span className="px-2 py-1 bg-red-50 text-red-600 text-[10px] font-bold uppercase rounded-md border border-red-100">
                                                    Занят
                                                </span>
                                            ) : (
                                                <span className="px-2 py-1 bg-emerald-50 text-emerald-600 text-[10px] font-bold uppercase rounded-md border border-emerald-100">
                                                    Свободен
                                                </span>
                                            )}
                                        </div>

                                        <div>
                                            <h3 className="font-bold text-slate-800 text-lg leading-tight truncate" title={pc.pc_name}>
                                                {pc.pc_name}
                                            </h3>
                                            <div className="flex items-center gap-1.5 mt-1 text-xs text-slate-500 font-mono">
                                                <Wifi size={12}/> {pc.ip}
                                            </div>
                                        </div>

                                        {isOccupied && (
                                            <div className="mt-auto pt-3 border-t border-slate-100 flex items-center gap-2">
                                                <div className="w-6 h-6 rounded-full bg-red-100 flex items-center justify-center text-red-600 text-xs font-bold">
                                                    <User size={12}/>
                                                </div>
                                                <div className="text-xs font-medium text-slate-600 truncate">
                                                    {activeUser.name} {activeUser.surname}
                                                </div>
                                            </div>
                                        )}

                                        {!isOccupied && (
                                            <div className="mt-auto pt-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                 <div className="w-full py-1.5 bg-indigo-600 text-white text-xs font-bold text-center rounded-lg">
                                                     Выбрать этот ПК
                                                 </div>
                                            </div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                ))
            )}
        </div>
      </div>
    </div>
  );
});

================================================================================
FILE: QMS-Client-main/src/pages/Profile/Profile.tsx
================================================================================

import { useEffect, useState, ChangeEvent } from "react";
import { fetchCurrentUser, updateUser, updateUserImg } from "src/api/userApi";
import { UserIcon } from "lucide-react";

export const Profile: React.FC = () => {
  const [currentUser, setCurrentUser] = useState({
    id: 0,
    login: "",
    password: "",
    role: "",
    name: "",
    surname: "",
    createdAt: "",
    updatedAt: "",
    img: "",
  });

  const [isEditing, setIsEditing] = useState(false);

  const [errorMessage, setErrorMessage] = useState("");
  const [successMessage, setSuccessMessage] = useState("");

  const [isAvatarEditVisible, setAvatarEditVisible] = useState(false);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleAvatarUpload = async () => {
    if (!selectedFile) {
      alert("Пожалуйста, выберите файл для загрузки");
      return;
    }

    const formData = new FormData();
    formData.append("id", String(currentUser.id));
    formData.append("img", selectedFile);

    try {
      await updateUserImg(formData);
      setAvatarEditVisible(false);
      setSuccessMessage("успешно изменено");
      setErrorMessage("");
      refetchUser();
    } catch (error: any) {
      setErrorMessage(
        `Произошла ошибка при загрузке изображения. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("Ошибка при изменении:", error);
    }
  };

  const refetchUser = () => {
    fetchCurrentUser(Number(localStorage.getItem("userID"))).then((data) => setCurrentUser(data));
  };

  useEffect(() => {
    fetchCurrentUser(Number(localStorage.getItem("userID"))).then((data) => setCurrentUser(data));
  }, []);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setCurrentUser((prevUser) => ({
      ...prevUser,
      [name]: value,
    }));
  };

  const handleEditToggle = () => {
    setIsEditing((prev) => !prev);
  };

  const handleSave = async () => {
    try {
      await updateUser(
        currentUser.id,
        currentUser.password,
        currentUser.name,
        currentUser.surname
      );
      setSuccessMessage("успешно изменено");
      setErrorMessage("");
      refetchUser();
    } catch (error: any) {
      setErrorMessage(
        `Произошла ошибка при изменении. ${error.response.data.message}`
      );
      setSuccessMessage("");
      console.error("Ошибка при изменении:", error);
    }

    setIsEditing(false);
  };


  return (
    <div className="p-8 max-w-2xl mx-auto bg-gradient-to-br from-blue-50 to-purple-50 shadow-2xl rounded-3xl transform transition-all">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 text-center">
        Профиль пользователя
      </h1>


      <div className="flex flex-col items-center mb-8">
  <div className="relative w-32 h-32 rounded-full overflow-hidden shadow-lg border-4 border-white hover:border-purple-500 transition-all duration-300">
    {currentUser.img ? (
      <img
        src={import.meta.env.VITE_API_URL + "/" + currentUser.img}
        alt=''
        className="w-full h-full object-cover"
      />
    ) : (
      <div className="w-full h-full flex items-center justify-center bg-blue-50">
        <UserIcon className="text-blue-600 w-16 h-16" />
      </div>
    )}
  </div>
</div>


      {isAvatarEditVisible ? (
        <div className="flex flex-col items-center mb-8">
          <input
            type="file"
            onChange={handleFileChange}
            className="mb-4 p-2 bg-white rounded-lg shadow-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={handleAvatarUpload}
          >
            Загрузить аватар
          </button>
        </div>
      ) : (
        <div className="flex justify-center mb-8">
          <button
            className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
            onClick={() => setAvatarEditVisible(true)}
          >
            Изменить аватар
          </button>
        </div>
      )}


<div className="space-y-6 bg-white p-8 rounded-2xl shadow-xl">

  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">Логин:</span>{" "}
    <span className="text-gray-900">{currentUser.login}</span>
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">Пароль:</span>{" "}
    {isEditing ? (
      <input
        type="password"
        name="password"
        value={currentUser.password}
        onChange={handleInputChange}
        className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    ) : (
      <span className="text-gray-900">********</span>
    )}
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">Роль:</span>{" "}
    <span className="text-gray-900">{currentUser.role}</span>
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">Имя:</span>{" "}
    {isEditing ? (
      <input
        name="name"
        value={currentUser.name}
        onChange={handleInputChange}
        className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    ) : (
      <span className="text-gray-900">{currentUser.name}</span>
    )}
  </p>


  <p className="text-lg text-gray-700">
    <span className="font-bold text-purple-600">Фамилия:</span>{" "}
    {isEditing ? (
      <input
        name="surname"
        value={currentUser.surname}
        onChange={handleInputChange}
        className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
    ) : (
      <span className="text-gray-900">{currentUser.surname}</span>
    )}
  </p>
</div>


<div className="mt-8 flex justify-center space-x-4">
  {isEditing ? (
    <>
      <button
        onClick={handleSave}
        className="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
      >
        Сохранить
      </button>
      <button
        onClick={() => {
          handleEditToggle();
          refetchUser();
        }}
        className="bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
      >
        Отмена
      </button>
    </>
  ) : (
    <button
      onClick={handleEditToggle}
      className="bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white font-semibold px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 duration-300"
    >
      Редактировать
    </button>
  )}
</div>
      {successMessage && (
        <div className="mt-4 text-green-500 font-medium">{successMessage}</div>
      )}
      {errorMessage && (
        <div className="mt-4 text-red-500 font-medium">{errorMessage}</div>
      )}
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/QMS/QmsDashboardPage.tsx
================================================================================






import React from "react";
import {
  FileText,
  AlertTriangle,
  RefreshCw,
  ClipboardList,
  Target,
  Clock,
  TrendingUp,
} from "lucide-react";





const kpiCards: {
  label: string;
  value: string | number;
  color: string;
  bgClass: string;
  icon: React.ElementType;
}[] = [
  { label: "Документы",     value: 247,   color: "text-asvo-blue",   bgClass: "bg-asvo-blue-dim",   icon: FileText },
  { label: "NC открытых",   value: 8,     color: "text-asvo-red",    bgClass: "bg-asvo-red-dim",    icon: AlertTriangle },
  { label: "CAPA активных", value: 15,    color: "text-asvo-amber",  bgClass: "bg-asvo-amber-dim",  icon: RefreshCw },
  { label: "Аудиты",        value: "92%", color: "text-asvo-accent",  bgClass: "bg-asvo-green-dim",  icon: ClipboardList },
  { label: "Риски",         value: 34,    color: "text-asvo-purple",  bgClass: "bg-asvo-purple-dim", icon: Target },
];







const riskMatrix: (number | null)[][] = [
   [null, null,    1,    3,    2],
   [null,    1,    2,    1, null],
   [   1,    2, null,    1, null],
   [   1, null,    1, null, null],
   [null,    1, null, null, null],
];

const riskCellColor = (likelihood: number, severity: number): string => {
  const score = likelihood * severity;
  if (score <= 4)  return "bg-asvo-green-dim  text-asvo-green";
  if (score <= 9)  return "bg-asvo-amber-dim  text-asvo-amber";
  if (score <= 16) return "bg-[rgba(232,112,64,0.15)] text-asvo-orange";
  return                   "bg-asvo-red-dim    text-asvo-red";
};





const timelineEvents: {
  date: string;
  code: string;
  text: string;
  dotClass: string;
}[] = [
  { date: "11.02", code: "NC-091",   text: "Дефект покрытия DEXA-200",          dotClass: "bg-asvo-red" },
  { date: "10.02", code: "DOC-247",  text: "Обновлена СТО-045",                 dotClass: "bg-asvo-blue" },
  { date: "09.02", code: "CAPA-047", text: "Верификация чек-листа пайки",       dotClass: "bg-asvo-amber" },
  { date: "08.02", code: "AUD-012",  text: "Старт аудита закупок",              dotClass: "bg-asvo-blue" },
  { date: "07.02", code: "R-019",    text: "Новый риск поставки датчиков",      dotClass: "bg-asvo-purple" },
];





const overdueCapas: { code: string; text: string; days: number }[] = [
  { code: "CAPA-041", text: "Замена клея",     days: 14 },
  { code: "CAPA-038", text: "Калибровка",      days: 7 },
  { code: "CAPA-035", text: "Поставщик PCB",   days: 3 },
];

const calibrations: { code: string; name: string; days: number }[] = [
  { code: "EQ-001", name: "Мультиметр Fluke 87V",        days: 3 },
  { code: "EQ-005", name: "Осциллограф Rigol DS1104",     days: 7 },
  { code: "EQ-012", name: "Паяльная станция JBC",         days: 14 },
];

const trainingDepts: { dept: string; pct: number; barClass: string }[] = [
  { dept: "Производство", pct: 87, barClass: "bg-asvo-accent" },
  { dept: "ОТК",          pct: 72, barClass: "bg-asvo-blue" },
  { dept: "Закупки",      pct: 45, barClass: "bg-asvo-amber" },
  { dept: "Склад",        pct: 23, barClass: "bg-asvo-red" },
];





export const QmsDashboardPage: React.FC = () => {
  

  
  const likelihoodLabels = [5, 4, 3, 2, 1];
  const severityLabels   = [1, 2, 3, 4, 5];

  return (
    <div className="min-h-screen bg-asvo-bg px-4 py-6 max-w-[1600px] mx-auto space-y-6">

      {}
      {}
      {}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
        {kpiCards.map((kpi) => {
          const Icon = kpi.icon;
          return (
            <div
              key={kpi.label}
              className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-4"
            >
              <div className="flex items-center gap-2 mb-3">
                <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${kpi.bgClass}`}>
                  <Icon size={16} className={kpi.color} />
                </div>
                <span className="text-xs text-asvo-text-dim">{kpi.label}</span>
              </div>
              <div className={`text-2xl font-bold ${kpi.color}`}>{kpi.value}</div>
            </div>
          );
        })}
      </div>

      {}
      {}
      {}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">

        {}
        <div className="lg:col-span-2 bg-asvo-surface-2 border border-asvo-border rounded-xl p-4">
          <h3 className="text-sm font-semibold text-asvo-text mb-3">
            Матрица рисков 5 × 5
          </h3>

          {}
          <div className="grid grid-cols-6 gap-1 mb-1">
            <div /> {}
            {severityLabels.map((s) => (
              <div key={s} className="text-[10px] text-asvo-text-dim text-center">
                S{s}
              </div>
            ))}
          </div>

          {}
          {riskMatrix.map((row, rowIdx) => {
            const likelihood = likelihoodLabels[rowIdx];
            return (
              <div key={likelihood} className="grid grid-cols-6 gap-1 mb-1">
                {}
                <div className="flex items-center justify-center text-[10px] text-asvo-text-dim">
                  L{likelihood}
                </div>

                {}
                {row.map((count, colIdx) => {
                  const severity = severityLabels[colIdx];
                  const hasValue = count !== null;

                  return (
                    <div
                      key={`${likelihood}-${severity}`}
                      className={`h-10 rounded flex items-center justify-center text-xs font-semibold ${
                        hasValue
                          ? riskCellColor(likelihood, severity)
                          : "bg-asvo-surface"
                      }`}
                    >
                      {hasValue ? count : ""}
                    </div>
                  );
                })}
              </div>
            );
          })}

          {}
          <div className="flex items-center gap-4 mt-3">
            {[
              { label: "Низкий ≤4",   cls: "bg-asvo-green-dim" },
              { label: "Средний ≤9",   cls: "bg-asvo-amber-dim" },
              { label: "Высокий ≤16",  cls: "bg-[rgba(232,112,64,0.15)]" },
              { label: "Крит. >16",    cls: "bg-asvo-red-dim" },
            ].map((l) => (
              <div key={l.label} className="flex items-center gap-1.5">
                <div className={`w-3 h-3 rounded ${l.cls}`} />
                <span className="text-[10px] text-asvo-text-dim">{l.label}</span>
              </div>
            ))}
          </div>
        </div>

        {}
        <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-4">
          <h3 className="text-sm font-semibold text-asvo-text mb-3">
            Последние события
          </h3>

          <div className="relative space-y-4 pl-5">
            {}
            <div className="absolute left-[7px] top-1 bottom-1 w-px bg-asvo-border" />

            {timelineEvents.map((evt, idx) => (
              <div key={idx} className="relative flex items-start gap-3">
                {}
                <div
                  className={`absolute -left-5 top-1 w-3.5 h-3.5 rounded-full border-2 border-asvo-surface-2 ${evt.dotClass}`}
                />

                {}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-asvo-text-dim">{evt.date}</span>
                    <span className="text-xs font-semibold text-asvo-text">{evt.code}</span>
                  </div>
                  <p className="text-xs text-asvo-text-mid mt-0.5 truncate">
                    {evt.text}
                  </p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {}
      {}
      {}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">

        {}
        <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-4">
          <h3 className="text-sm font-semibold text-asvo-text mb-3">
            Просроченные CAPA
          </h3>

          <div className="space-y-3">
            {overdueCapas.map((c) => (
              <div key={c.code} className="flex items-center justify-between">
                <div className="flex items-center gap-2 min-w-0">
                  <Clock size={14} className="text-asvo-red shrink-0" />
                  <span className="text-xs font-semibold text-asvo-red">{c.code}</span>
                  <span className="text-xs text-asvo-text-mid truncate">{c.text}</span>
                </div>
                <span className="text-xs font-bold text-asvo-red whitespace-nowrap ml-2">
                  {c.days}дн
                </span>
              </div>
            ))}
          </div>
        </div>

        {}
        <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-4">
          <h3 className="text-sm font-semibold text-asvo-text mb-3">
            Ближайшие калибровки
          </h3>

          <div className="space-y-3">
            {calibrations.map((eq) => (
              <div key={eq.code} className="flex items-center justify-between">
                <div className="flex items-center gap-2 min-w-0">
                  <TrendingUp size={14} className="text-asvo-text-dim shrink-0" />
                  <div className="min-w-0">
                    <span className="text-xs font-semibold text-asvo-text">{eq.code}</span>
                    <span className="text-xs text-asvo-text-mid ml-1.5 truncate">{eq.name}</span>
                  </div>
                </div>
                <span className="text-xs font-bold text-asvo-amber whitespace-nowrap ml-2">
                  {eq.days} дня{eq.days === 7 ? "" : ""}
                </span>
              </div>
            ))}
          </div>
        </div>

        {}
        <div className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-4">
          <h3 className="text-sm font-semibold text-asvo-text mb-3">
            Обучение по отделам
          </h3>

          <div className="space-y-3">
            {trainingDepts.map((d) => (
              <div key={d.dept}>
                <div className="flex items-center justify-between mb-1">
                  <span className="text-xs text-asvo-text-mid">{d.dept}</span>
                  <span className="text-xs font-bold text-asvo-text">{d.pct}%</span>
                </div>
                <div className="h-1.5 rounded-full bg-asvo-bg">
                  <div
                    className={`h-1.5 rounded-full ${d.barClass}`}
                    style={{ width: `${d.pct}%` }}
                  />
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/QMS/QmsPrototypePage.tsx
================================================================================







import React, { useState } from "react";






const ACCENT = "#2dd4a8";
const ACCENT_DIM = "rgba(45,212,168,0.15)";
const SURFACE = "#0f1923";
const SURFACE2 = "#162231";
const SURFACE3 = "#1c2d40";
const BORDER = "#1e3348";
const TEXT = "#e2e8f0";
const TEXT_DIM = "#64748b";
const RED = "#ef4444";
const AMBER = "#f59e0b";
const BLUE = "#3b82f6";
const PURPLE = "#a855f7";



const Badge: React.FC<{ color?: string; children: React.ReactNode }> = ({ color = ACCENT, children }) => (
  <span style={{
    background: color + "22",
    color,
    padding: "2px 10px",
    borderRadius: 12,
    fontSize: 11,
    fontWeight: 600,
    letterSpacing: 0.3,
    whiteSpace: "nowrap",
  }}>{children}</span>
);

const StatusDot: React.FC<{ color: string }> = ({ color }) => (
  <span style={{
    width: 8, height: 8, borderRadius: "50%",
    background: color, display: "inline-block",
    boxShadow: `0 0 6px ${color}66`,
  }} />
);

const ProgressBar: React.FC<{ value: number; color?: string; height?: number }> = ({ value, color = ACCENT, height = 6 }) => (
  <div style={{ background: SURFACE, borderRadius: height, height, width: "100%", overflow: "hidden" }}>
    <div style={{
      width: `${Math.min(100, Math.max(0, value))}%`,
      height: "100%",
      background: `linear-gradient(90deg, ${color}88, ${color})`,
      borderRadius: height,
      transition: "width 0.6s ease",
    }} />
  </div>
);

const Card: React.FC<{
  children: React.ReactNode;
  style?: React.CSSProperties;
  onClick?: () => void;
}> = ({ children, style, onClick }) => (
  <div onClick={onClick} style={{
    background: SURFACE2,
    border: `1px solid ${BORDER}`,
    borderRadius: 12,
    padding: 16,
    cursor: onClick ? "pointer" : "default",
    transition: "all 0.2s ease",
    ...style,
  }}>{children}</div>
);

interface StatCardItem {
  icon: string;
  label: string;
  value: string | number;
  sub?: string;
  color?: string;
}

const StatCard: React.FC<StatCardItem> = ({ icon, label, value, sub, color = ACCENT }) => (
  <Card style={{ textAlign: "center", minWidth: 130 }}>
    <div style={{ fontSize: 22, marginBottom: 4 }}>{icon}</div>
    <div style={{ fontSize: 24, fontWeight: 700, color, lineHeight: 1.1 }}>{value}</div>
    <div style={{ fontSize: 12, color: TEXT_DIM, marginTop: 2 }}>{label}</div>
    {sub && <div style={{ fontSize: 11, color: TEXT_DIM, marginTop: 2 }}>{sub}</div>}
  </Card>
);

const Table: React.FC<{ columns: string[]; rows: React.ReactNode[][] }> = ({ columns, rows }) => (
  <div style={{ overflowX: "auto" }}>
    <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: 0, fontSize: 13 }}>
      <thead>
        <tr>
          {columns.map((col, i) => (
            <th key={i} style={{
              textAlign: "left", padding: "10px 12px",
              color: TEXT_DIM, fontWeight: 600, fontSize: 11,
              textTransform: "uppercase", letterSpacing: 0.5,
              borderBottom: `1px solid ${BORDER}`,
              background: SURFACE,
              position: "sticky", top: 0,
            }}>{col}</th>
          ))}
        </tr>
      </thead>
      <tbody>
        {rows.map((row, ri) => (
          <tr key={ri} style={{ transition: "background 0.15s" }}
            onMouseEnter={e => (e.currentTarget.style.background = SURFACE3)}
            onMouseLeave={e => (e.currentTarget.style.background = "transparent")}>
            {row.map((cell, ci) => (
              <td key={ci} style={{
                padding: "10px 12px",
                borderBottom: `1px solid ${BORDER}22`,
                color: TEXT,
              }}>{cell}</td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
  </div>
);

const TabBar: React.FC<{ tabs: string[]; active: string; onChange: (t: string) => void }> = ({ tabs, active, onChange }) => (
  <div style={{ display: "flex", gap: 2, borderBottom: `1px solid ${BORDER}`, marginBottom: 16 }}>
    {tabs.map(t => (
      <button key={t} onClick={() => onChange(t)} style={{
        padding: "8px 16px",
        background: active === t ? ACCENT_DIM : "transparent",
        color: active === t ? ACCENT : TEXT_DIM,
        border: "none",
        borderBottom: active === t ? `2px solid ${ACCENT}` : "2px solid transparent",
        cursor: "pointer",
        fontSize: 13,
        fontWeight: 500,
        transition: "all 0.2s",
      }}>{t}</button>
    ))}
  </div>
);

const SectionTitle: React.FC<{ children: React.ReactNode; action?: React.ReactNode }> = ({ children, action }) => (
  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
    <h3 style={{ fontSize: 14, fontWeight: 600, color: TEXT, margin: 0 }}>{children}</h3>
    {action}
  </div>
);

const ActionBtn: React.FC<{
  children: React.ReactNode;
  primary?: boolean;
  small?: boolean;
  color?: string;
}> = ({ children, primary, small, color }) => (
  <button style={{
    padding: small ? "4px 12px" : "8px 20px",
    background: primary ? (color || ACCENT) : "transparent",
    color: primary ? SURFACE : (color || ACCENT),
    border: primary ? "none" : `1px solid ${color || ACCENT}44`,
    borderRadius: 8,
    fontSize: small ? 11 : 13,
    fontWeight: 600,
    cursor: "pointer",
    transition: "all 0.2s",
    display: "flex", alignItems: "center", gap: 6,
  }}>{children}</button>
);

const KpiRow: React.FC<{ items: StatCardItem[] }> = ({ items }) => (
  <div style={{ display: "grid", gridTemplateColumns: `repeat(${Math.min(items.length, 5)}, 1fr)`, gap: 12 }}>
    {items.map((item, i) => <StatCard key={i} {...item} />)}
  </div>
);

interface TimelineEvent {
  date: string;
  title: string;
  desc?: string;
  color?: string;
}

const Timeline: React.FC<{ events: TimelineEvent[] }> = ({ events }) => (
  <div style={{ position: "relative", paddingLeft: 24 }}>
    <div style={{ position: "absolute", left: 8, top: 4, bottom: 4, width: 2, background: BORDER }} />
    {events.map((ev, i) => (
      <div key={i} style={{ marginBottom: 16, position: "relative" }}>
        <div style={{
          position: "absolute", left: -20, top: 4,
          width: 12, height: 12, borderRadius: "50%",
          background: ev.color || ACCENT,
          border: `2px solid ${SURFACE2}`,
        }} />
        <div style={{ fontSize: 11, color: TEXT_DIM }}>{ev.date}</div>
        <div style={{ fontSize: 13, color: TEXT, fontWeight: 500 }}>{ev.title}</div>
        {ev.desc && <div style={{ fontSize: 12, color: TEXT_DIM }}>{ev.desc}</div>}
      </div>
    ))}
  </div>
);





const DashboardModule: React.FC = () => {
  const riskMatrix = [
    [1, 2, 3, 4, 5],
    [2, 4, 6, 8, 10],
    [3, 6, 9, 12, 15],
    [4, 8, 12, 16, 20],
    [5, 10, 15, 20, 25],
  ];
  const riskData: Record<string, number> = { "3": 2, "6": 1, "9": 3, "12": 1, "15": 1, "16": 1, "20": 1 };
  const getCellColor = (v: number) => {
    if (v <= 4) return "#22c55e";
    if (v <= 9) return "#f59e0b";
    if (v <= 16) return "#f97316";
    return "#ef4444";
  };

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <KpiRow items={[
        { icon: "\u{1F4C4}", label: "Документы", value: "247", sub: "12 на согласовании", color: BLUE },
        { icon: "\u26A0\uFE0F", label: "Несоответствия", value: "8", sub: "3 критических", color: RED },
        { icon: "\u{1F504}", label: "CAPA", value: "15", sub: "5 просрочено", color: AMBER },
        { icon: "\u2705", label: "Аудиты", value: "92%", sub: "готовность", color: ACCENT },
        { icon: "\u{1F4CA}", label: "Риски", value: "34", sub: "6 высоких", color: PURPLE },
      ]} />

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
        {}
        <Card>
          <SectionTitle>Матрица рисков (ISO 14971)</SectionTitle>
          <div style={{ display: "grid", gridTemplateColumns: "auto repeat(5, 1fr)", gap: 2, fontSize: 11 }}>
            <div />
            {[1,2,3,4,5].map(s => (
              <div key={s} style={{ textAlign: "center", color: TEXT_DIM, padding: 4, fontSize: 10 }}>S{s}</div>
            ))}
            {[...riskMatrix].reverse().map((row, ri) => (
              <React.Fragment key={`rm-${ri}`}>
                <div style={{ color: TEXT_DIM, padding: 4, display: "flex", alignItems: "center", fontSize: 10 }}>P{5-ri}</div>
                {row.map((v, ci) => (
                  <div key={`${ri}-${ci}`} style={{
                    background: getCellColor(v) + "33",
                    border: `1px solid ${getCellColor(v)}44`,
                    borderRadius: 4,
                    padding: 4,
                    textAlign: "center",
                    color: getCellColor(v),
                    fontWeight: riskData[String(v)] ? 700 : 400,
                    fontSize: riskData[String(v)] ? 13 : 11,
                  }}>
                    {riskData[String(v)] ? `\u25CF${riskData[String(v)]}` : v}
                  </div>
                ))}
              </React.Fragment>
            ))}
          </div>
        </Card>

        {}
        <Card>
          <SectionTitle>Последние действия</SectionTitle>
          <Timeline events={[
            { date: "11.02.2026 10:15", title: "SOP-042 утверждён", desc: "Холтобин А.В.", color: ACCENT },
            { date: "11.02.2026 09:40", title: "NC-089 создано", desc: "Брак на входном контроле", color: RED },
            { date: "10.02.2026 17:30", title: "CAPA-045 закрыто", desc: "Эффективность подтверждена", color: ACCENT },
            { date: "10.02.2026 15:00", title: "Аудит #12 начат", desc: "Процесс закупок", color: BLUE },
            { date: "10.02.2026 11:20", title: "Калибровка #78", desc: "Весы аналит. — годен", color: ACCENT },
          ]} />
        </Card>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 16 }}>
        <Card>
          <SectionTitle>Просроченные CAPA</SectionTitle>
          {[
            { id: "CAPA-039", title: "Несоответствие поставщика", days: 12 },
            { id: "CAPA-041", title: "Калибровка оборудования", days: 5 },
            { id: "CAPA-043", title: "Обучение персонала", days: 2 },
          ].map(c => (
            <div key={c.id} style={{
              display: "flex", justifyContent: "space-between", alignItems: "center",
              padding: "8px 0", borderBottom: `1px solid ${BORDER}22`,
            }}>
              <div>
                <span style={{ color: ACCENT, fontWeight: 600, fontSize: 12 }}>{c.id}</span>
                <div style={{ fontSize: 12, color: TEXT_DIM }}>{c.title}</div>
              </div>
              <Badge color={RED}>-{c.days}д</Badge>
            </div>
          ))}
        </Card>

        <Card>
          <SectionTitle>Сроки калибровки</SectionTitle>
          {[
            { name: "Весы XS205", date: "15.02.2026", days: 4, color: AMBER },
            { name: "Штангенциркуль МК-150", date: "20.02.2026", days: 9, color: ACCENT },
            { name: "Мультиметр Fluke 87V", date: "01.03.2026", days: 18, color: ACCENT },
          ].map(e => (
            <div key={e.name} style={{
              display: "flex", justifyContent: "space-between", alignItems: "center",
              padding: "8px 0", borderBottom: `1px solid ${BORDER}22`,
            }}>
              <div>
                <div style={{ fontSize: 13, color: TEXT }}>{e.name}</div>
                <div style={{ fontSize: 11, color: TEXT_DIM }}>{e.date}</div>
              </div>
              <Badge color={e.color}>{e.days}д</Badge>
            </div>
          ))}
        </Card>

        <Card>
          <SectionTitle>Обучение — статус</SectionTitle>
          {[
            { dept: "Производство", pct: 95 },
            { dept: "Склад", pct: 78 },
            { dept: "QA", pct: 100 },
            { dept: "Закупки", pct: 62 },
          ].map(d => (
            <div key={d.dept} style={{ marginBottom: 10 }}>
              <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, marginBottom: 4 }}>
                <span style={{ color: TEXT }}>{d.dept}</span>
                <span style={{ color: d.pct === 100 ? ACCENT : d.pct < 70 ? AMBER : TEXT_DIM }}>{d.pct}%</span>
              </div>
              <ProgressBar value={d.pct} color={d.pct === 100 ? ACCENT : d.pct < 70 ? AMBER : BLUE} />
            </div>
          ))}
        </Card>
      </div>
    </div>
  );
};





const DocumentsModule: React.FC = () => {
  const [tab, setTab] = useState("Все");
  const docs = [
    { id: "SOP-001", title: "Управление документацией", type: "SOP", version: "3.2", status: "Действует", owner: "Холтобин А.В.", effective: "01.01.2026", review: "01.01.2027" },
    { id: "SOP-012", title: "Управление несоответствиями", type: "SOP", version: "2.1", status: "Действует", owner: "Костюков И.А.", effective: "15.03.2025", review: "15.03.2026" },
    { id: "WI-045", title: "Входной контроль комплектующих", type: "РИ", version: "1.0", status: "На согласовании", owner: "Омельченко А.Г.", effective: "—", review: "—" },
    { id: "QM-001", title: "Руководство по качеству", type: "РК", version: "4.0", status: "Действует", owner: "Холтобин А.В.", effective: "01.06.2025", review: "01.06.2026" },
    { id: "F-089", title: "Протокол входного контроля", type: "Форма", version: "2.0", status: "Черновик", owner: "Костюков И.А.", effective: "—", review: "—" },
    { id: "SOP-034", title: "Управление рисками", type: "SOP", version: "1.3", status: "На пересмотре", owner: "Холтобин А.В.", effective: "01.09.2025", review: "01.02.2026" },
  ];

  const statusColor: Record<string, string> = { "Действует": ACCENT, "На согласовании": AMBER, "Черновик": TEXT_DIM, "На пересмотре": BLUE };

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div style={{ display: "flex", gap: 8 }}>
          <ActionBtn primary>{"\uFF0B"} Новый документ</ActionBtn>
          <ActionBtn>{"\u{1F4E5}"} Импорт</ActionBtn>
        </div>
        <div style={{
          display: "flex", alignItems: "center", gap: 8,
          background: SURFACE, borderRadius: 8, padding: "6px 12px",
          border: `1px solid ${BORDER}`,
        }}>
          <span style={{ color: TEXT_DIM }}>{"\u{1F50D}"}</span>
          <span style={{ color: TEXT_DIM, fontSize: 13 }}>Поиск по документам...</span>
        </div>
      </div>

      <TabBar tabs={["Все", "SOP", "РИ", "Формы", "РК", "На согласовании", "Просрочен пересмотр"]} active={tab} onChange={setTab} />

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <Table
          columns={["ID", "Название", "Тип", "Версия", "Статус", "Владелец", "Дата ввода", "Пересмотр до"]}
          rows={docs.map(d => [
            <span style={{ color: ACCENT, fontWeight: 600, fontFamily: "monospace" }}>{d.id}</span>,
            d.title,
            <Badge>{d.type}</Badge>,
            <span style={{ fontFamily: "monospace" }}>v{d.version}</span>,
            <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <StatusDot color={statusColor[d.status]} /> {d.status}
            </span>,
            d.owner,
            d.effective,
            <span style={{ color: d.review !== "—" && new Date(d.review.split(".").reverse().join("-")) < new Date("2026-03-01") ? AMBER : TEXT_DIM }}>
              {d.review}
            </span>,
          ])}
        />
      </Card>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
        <Card>
          <SectionTitle>Процесс согласования</SectionTitle>
          <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
            {["Черновик", "Проверка", "Согласование", "Утверждение", "Действует"].map((step, i) => (
              <div key={step} style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <div style={{
                  width: 28, height: 28, borderRadius: "50%",
                  background: i < 2 ? ACCENT : SURFACE,
                  border: `2px solid ${i < 2 ? ACCENT : BORDER}`,
                  display: "flex", alignItems: "center", justifyContent: "center",
                  fontSize: 12, fontWeight: 600,
                  color: i < 2 ? SURFACE : TEXT_DIM,
                }}>{i < 2 ? "\u2713" : i + 1}</div>
                <span style={{ fontSize: 11, color: i < 2 ? ACCENT : TEXT_DIM, whiteSpace: "nowrap" }}>{step}</span>
                {i < 4 && <div style={{ width: 20, height: 2, background: i < 1 ? ACCENT : BORDER }} />}
              </div>
            ))}
          </div>
          <div style={{ fontSize: 12, color: TEXT_DIM }}>
            Документ WI-045 ожидает согласования от руководителя отдела качества
          </div>
        </Card>

        <Card>
          <SectionTitle>Статистика</SectionTitle>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            {[
              { label: "Всего документов", value: 247, color: BLUE },
              { label: "Действующих", value: 198, color: ACCENT },
              { label: "На согласовании", value: 12, color: AMBER },
              { label: "Просрочен пересмотр", value: 7, color: RED },
            ].map(s => (
              <div key={s.label} style={{ textAlign: "center" }}>
                <div style={{ fontSize: 22, fontWeight: 700, color: s.color }}>{s.value}</div>
                <div style={{ fontSize: 11, color: TEXT_DIM }}>{s.label}</div>
              </div>
            ))}
          </div>
        </Card>
      </div>
    </div>
  );
};





const NonconformityModule: React.FC = () => {
  const ncs = [
    { id: "NC-089", title: "Дефект пайки разъёма J4", source: "Входной контроль", severity: "Критическое", status: "Открыто", product: "DEXA-100", date: "11.02.2026", assignee: "Омельченко А.Г." },
    { id: "NC-088", title: "Отклонение размеров корпуса", source: "Производство", severity: "Значительное", status: "Расследование", product: "DEXA-100", date: "09.02.2026", assignee: "Костюков И.А." },
    { id: "NC-087", title: "Несоответствие маркировки", source: "Аудит", severity: "Незначительное", status: "CAPA создано", product: "DEXA-200", date: "05.02.2026", assignee: "Холтобин А.В." },
    { id: "NC-085", title: "Поставка некомплект", source: "Склад", severity: "Значительное", status: "Закрыто", product: "—", date: "28.01.2026", assignee: "Костюков И.А." },
  ];

  const sevColor: Record<string, string> = { "Критическое": RED, "Значительное": AMBER, "Незначительное": BLUE };
  const statColor: Record<string, string> = { "Открыто": RED, "Расследование": AMBER, "CAPA создано": PURPLE, "Закрыто": ACCENT };

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <KpiRow items={[
        { icon: "\u{1F534}", label: "Открыто", value: "8", color: RED },
        { icon: "\u{1F7E1}", label: "Расследование", value: "5", color: AMBER },
        { icon: "\u{1F7E3}", label: "CAPA создано", value: "12", color: PURPLE },
        { icon: "\u2705", label: "Закрыто (мес.)", value: "23", color: ACCENT },
      ]} />

      <div style={{ display: "flex", justifyContent: "space-between" }}>
        <ActionBtn primary>{"\uFF0B"} Зарегистрировать NC</ActionBtn>
        <div style={{ display: "flex", gap: 8 }}>
          <ActionBtn small>Фильтр по источнику</ActionBtn>
          <ActionBtn small>Фильтр по продукту</ActionBtn>
        </div>
      </div>

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <Table
          columns={["ID", "Описание", "Источник", "Критичность", "Статус", "Продукт", "Дата", "Ответственный"]}
          rows={ncs.map(n => [
            <span style={{ color: ACCENT, fontWeight: 600, fontFamily: "monospace" }}>{n.id}</span>,
            n.title,
            <Badge color={BLUE}>{n.source}</Badge>,
            <Badge color={sevColor[n.severity]}>{n.severity}</Badge>,
            <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <StatusDot color={statColor[n.status]} /> {n.status}
            </span>,
            n.product,
            n.date,
            n.assignee,
          ])}
        />
      </Card>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
        <Card>
          <SectionTitle>Workflow несоответствия</SectionTitle>
          <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
            {[
              { step: "1. Регистрация", desc: "Описание, фото, классификация", active: true },
              { step: "2. Расследование", desc: "Root cause analysis (5 Why, Ishikawa)", active: true },
              { step: "3. Диспозиция", desc: "Решение: ремонт / утилизация / отклонение", active: false },
              { step: "4. CAPA", desc: "Корректирующее / предупреждающее действие", active: false },
              { step: "5. Верификация", desc: "Проверка эффективности", active: false },
              { step: "6. Закрытие", desc: "Финальное подтверждение УК", active: false },
            ].map(s => (
              <div key={s.step} style={{
                display: "flex", gap: 12, padding: "8px 12px",
                background: s.active ? ACCENT_DIM : "transparent",
                borderRadius: 8, borderLeft: `3px solid ${s.active ? ACCENT : BORDER}`,
              }}>
                <div>
                  <div style={{ fontSize: 13, fontWeight: 600, color: s.active ? ACCENT : TEXT }}>{s.step}</div>
                  <div style={{ fontSize: 11, color: TEXT_DIM }}>{s.desc}</div>
                </div>
              </div>
            ))}
          </div>
        </Card>

        <Card>
          <SectionTitle>Pareto: источники NC (30 дн.)</SectionTitle>
          {[
            { label: "Входной контроль", count: 12, pct: 40 },
            { label: "Производство", count: 8, pct: 27 },
            { label: "Аудиты", count: 5, pct: 17 },
            { label: "Рекламации", count: 3, pct: 10 },
            { label: "Склад", count: 2, pct: 6 },
          ].map(item => (
            <div key={item.label} style={{ marginBottom: 10 }}>
              <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, marginBottom: 3 }}>
                <span style={{ color: TEXT }}>{item.label}</span>
                <span style={{ color: TEXT_DIM }}>{item.count} ({item.pct}%)</span>
              </div>
              <ProgressBar value={item.pct * 2.5} color={item.pct > 30 ? RED : item.pct > 15 ? AMBER : BLUE} />
            </div>
          ))}
        </Card>
      </div>
    </div>
  );
};





const CapaModule: React.FC = () => {
  const capas = [
    { id: "CAPA-048", type: "CA", title: "Пересмотр процедуры входного контроля", source: "NC-089", status: "Планирование", due: "28.02.2026", owner: "Костюков И.А.", pct: 15 },
    { id: "CAPA-047", type: "PA", title: "Внедрение чек-листа для монтажа", source: "Риск R-012", status: "Реализация", due: "20.02.2026", owner: "Омельченко А.Г.", pct: 65 },
    { id: "CAPA-045", type: "CA", title: "Замена поставщика PCB", source: "NC-082", status: "Верификация", due: "15.02.2026", owner: "Холтобин А.В.", pct: 90 },
    { id: "CAPA-042", type: "CA", title: "Обновление IQ/OQ для пресса", source: "Аудит #11", status: "Закрыто", due: "01.02.2026", owner: "Костюков И.А.", pct: 100 },
  ];

  const statColor: Record<string, string> = { "Планирование": BLUE, "Реализация": AMBER, "Верификация": PURPLE, "Закрыто": ACCENT };

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <KpiRow items={[
        { icon: "\u{1F4CB}", label: "Активных", value: "15", color: BLUE },
        { icon: "\u23F0", label: "Просрочено", value: "5", color: RED },
        { icon: "\u2705", label: "Эффективных", value: "87%", sub: "за 12 мес.", color: ACCENT },
        { icon: "\u{1F4C6}", label: "Ср. срок закрытия", value: "18д", color: AMBER },
      ]} />

      <div style={{ display: "flex", gap: 8 }}>
        <ActionBtn primary>{"\uFF0B"} Новое CAPA</ActionBtn>
        <ActionBtn>{"\u{1F4CA}"} Отчёт эффективности</ActionBtn>
      </div>

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <Table
          columns={["ID", "Тип", "Описание", "Источник", "Статус", "Срок", "Ответственный", "Прогресс"]}
          rows={capas.map(c => [
            <span style={{ color: ACCENT, fontWeight: 600, fontFamily: "monospace" }}>{c.id}</span>,
            <Badge color={c.type === "CA" ? RED : AMBER}>{c.type === "CA" ? "Коррект." : "Предупр."}</Badge>,
            c.title,
            <span style={{ color: TEXT_DIM, fontSize: 12 }}>{c.source}</span>,
            <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <StatusDot color={statColor[c.status]} /> {c.status}
            </span>,
            <span style={{ color: c.status !== "Закрыто" && c.due < "15.02.2026" ? RED : TEXT }}>{c.due}</span>,
            c.owner,
            <div style={{ minWidth: 80 }}>
              <ProgressBar value={c.pct} color={c.pct === 100 ? ACCENT : c.pct > 50 ? BLUE : AMBER} />
              <div style={{ fontSize: 10, textAlign: "right", color: TEXT_DIM, marginTop: 2 }}>{c.pct}%</div>
            </div>,
          ])}
        />
      </Card>

      <Card>
        <SectionTitle>8D Workflow</SectionTitle>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(8, 1fr)", gap: 6, textAlign: "center" }}>
          {[
            { d: "D1", label: "Команда", done: true },
            { d: "D2", label: "Описание", done: true },
            { d: "D3", label: "Сдерживание", done: true },
            { d: "D4", label: "Root Cause", done: true },
            { d: "D5", label: "Корр. действия", done: false },
            { d: "D6", label: "Внедрение", done: false },
            { d: "D7", label: "Предупреждение", done: false },
            { d: "D8", label: "Закрытие", done: false },
          ].map(step => (
            <div key={step.d} style={{
              background: step.done ? ACCENT_DIM : SURFACE,
              border: `1px solid ${step.done ? ACCENT + "44" : BORDER}`,
              borderRadius: 8, padding: "8px 4px",
            }}>
              <div style={{ fontSize: 16, fontWeight: 700, color: step.done ? ACCENT : TEXT_DIM }}>{step.d}</div>
              <div style={{ fontSize: 10, color: step.done ? TEXT : TEXT_DIM, marginTop: 2 }}>{step.label}</div>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
};





const RisksModule: React.FC = () => {
  const risks = [
    { id: "R-001", title: "Отказ критического поставщика", cat: "Поставки", init: { p: 3, s: 5, lvl: 15 }, resid: { p: 2, s: 5, lvl: 10 } as { p: number; s: number; lvl: number } | null, status: "Мониторинг", mitigation: "Квалификация альт. поставщика" },
    { id: "R-005", title: "Потеря данных производства", cat: "ИТ", init: { p: 2, s: 4, lvl: 8 }, resid: { p: 1, s: 4, lvl: 4 }, status: "Контролируется", mitigation: "Ежедневные бэкапы + DR план" },
    { id: "R-012", title: "Ошибка монтажа платы DEXA", cat: "Производство", init: { p: 4, s: 4, lvl: 16 }, resid: { p: 2, s: 4, lvl: 8 }, status: "Мониторинг", mitigation: "Чек-лист + обучение" },
    { id: "R-018", title: "Задержка сертификации", cat: "Регуляторный", init: { p: 3, s: 3, lvl: 9 }, resid: null, status: "Новый", mitigation: "—" },
  ];

  const riskColor = (lvl: number) => lvl <= 4 ? ACCENT : lvl <= 9 ? AMBER : lvl <= 16 ? "#f97316" : RED;

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <KpiRow items={[
        { icon: "\u{1F4CA}", label: "Всего рисков", value: "34", color: BLUE },
        { icon: "\u{1F534}", label: "Высокие", value: "6", color: RED },
        { icon: "\u{1F7E1}", label: "Средние", value: "14", color: AMBER },
        { icon: "\u{1F7E2}", label: "Низкие", value: "14", color: ACCENT },
      ]} />

      <div style={{ display: "flex", gap: 8 }}>
        <ActionBtn primary>{"\uFF0B"} Зарегистрировать риск</ActionBtn>
        <ActionBtn>{"\u{1F504}"} Пересмотр рисков</ActionBtn>
        <ActionBtn>{"\u{1F4CA}"} Матрица рисков</ActionBtn>
      </div>

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <Table
          columns={["ID", "Описание", "Категория", "Начальный", "Остаточный", "Статус", "Меры"]}
          rows={risks.map(r => [
            <span style={{ color: ACCENT, fontWeight: 600, fontFamily: "monospace" }}>{r.id}</span>,
            r.title,
            <Badge color={BLUE}>{r.cat}</Badge>,
            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <span style={{
                background: riskColor(r.init.lvl) + "33", color: riskColor(r.init.lvl),
                padding: "2px 8px", borderRadius: 6, fontWeight: 700, fontSize: 13,
              }}>{r.init.lvl}</span>
              <span style={{ fontSize: 10, color: TEXT_DIM }}>{r.init.p}&times;{r.init.s}</span>
            </div>,
            r.resid ? (
              <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                <span style={{
                  background: riskColor(r.resid.lvl) + "33", color: riskColor(r.resid.lvl),
                  padding: "2px 8px", borderRadius: 6, fontWeight: 700, fontSize: 13,
                }}>{r.resid.lvl}</span>
                <span style={{ fontSize: 10, color: TEXT_DIM }}>{r.resid.p}&times;{r.resid.s}</span>
              </div>
            ) : <span style={{ color: TEXT_DIM }}>—</span>,
            <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <StatusDot color={r.status === "Контролируется" ? ACCENT : r.status === "Мониторинг" ? AMBER : BLUE} />
              {r.status}
            </span>,
            <span style={{ fontSize: 12 }}>{r.mitigation}</span>,
          ])}
        />
      </Card>

      <Card>
        <SectionTitle>Матрица рисков 5x5 (ISO 14971)</SectionTitle>
        <div style={{ display: "grid", gridTemplateColumns: "40px repeat(5, 1fr)", gap: 3 }}>
          <div />
          {["Незначит.", "Малая", "Средняя", "Серьёзная", "Катастроф."].map((s, i) => (
            <div key={i} style={{ textAlign: "center", fontSize: 9, color: TEXT_DIM, padding: 4 }}>{s}</div>
          ))}
          {[5,4,3,2,1].map(p => (
            <React.Fragment key={`rp-${p}`}>
              <div style={{ fontSize: 10, color: TEXT_DIM, display: "flex", alignItems: "center", justifyContent: "center" }}>P{p}</div>
              {[1,2,3,4,5].map(s => {
                const v = p * s;
                const hasRisk = risks.some(r => r.init.p === p && r.init.s === s);
                return (
                  <div key={`${p}${s}`} style={{
                    background: riskColor(v) + (hasRisk ? "55" : "22"),
                    borderRadius: 6, padding: 6, textAlign: "center",
                    border: hasRisk ? `2px solid ${riskColor(v)}` : `1px solid ${riskColor(v)}33`,
                    minHeight: 32, display: "flex", alignItems: "center", justifyContent: "center",
                  }}>
                    <span style={{ fontSize: hasRisk ? 14 : 11, fontWeight: hasRisk ? 700 : 400, color: riskColor(v) }}>
                      {hasRisk ? "\u25CF" : v}
                    </span>
                  </div>
                );
              })}
            </React.Fragment>
          ))}
        </div>
      </Card>
    </div>
  );
};





const SuppliersModule: React.FC = () => {
  const suppliers = [
    { id: "SUP-001", name: "\u041E\u041E\u041E \"\u042D\u043B\u0435\u043A\u0442\u0440\u043E\u041A\u043E\u043C\"", type: "Критический", score: 92, status: "Одобрен", nextEval: "01.06.2026", products: "PCB, разъёмы" },
    { id: "SUP-005", name: "\u0410\u041E \"\u041C\u0435\u0434\u041F\u043B\u0430\u0441\u0442\"", type: "Критический", score: 78, status: "Условно одобрен", nextEval: "01.03.2026", products: "Корпуса, крепёж" },
    { id: "SUP-012", name: "\u041E\u041E\u041E \"\u0422\u0435\u0445\u043D\u043E\u041B\u0430\u0431\"", type: "Основной", score: 85, status: "Одобрен", nextEval: "01.09.2026", products: "Датчики" },
    { id: "SUP-018", name: "\u0418\u041F \u0421\u0438\u0434\u043E\u0440\u043E\u0432", type: "Вспомогательный", score: 65, status: "На пересмотре", nextEval: "15.02.2026", products: "Упаковка" },
  ];

  const scoreColor = (s: number) => s >= 80 ? ACCENT : s >= 60 ? AMBER : RED;
  const statusColor: Record<string, string> = { "Одобрен": ACCENT, "Условно одобрен": AMBER, "На пересмотре": BLUE, "Приостановлен": RED };

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <KpiRow items={[
        { icon: "\u{1F3ED}", label: "Всего", value: "28", color: BLUE },
        { icon: "\u2705", label: "Одобрено", value: "19", color: ACCENT },
        { icon: "\u26A0\uFE0F", label: "Условно", value: "6", color: AMBER },
        { icon: "\u{1F4CA}", label: "Ср. балл", value: "81", color: ACCENT },
        { icon: "\u{1F4C5}", label: "Оценка скоро", value: "4", color: AMBER },
      ]} />

      <ActionBtn primary>{"\uFF0B"} Добавить поставщика</ActionBtn>

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <Table
          columns={["ID", "Наименование", "Тип", "Рейтинг", "Статус", "Продукция", "След. оценка"]}
          rows={suppliers.map(s => [
            <span style={{ color: ACCENT, fontWeight: 600, fontFamily: "monospace" }}>{s.id}</span>,
            <span style={{ fontWeight: 500 }}>{s.name}</span>,
            <Badge color={s.type === "Критический" ? RED : s.type === "Основной" ? BLUE : TEXT_DIM}>{s.type}</Badge>,
            <div style={{ display: "flex", alignItems: "center", gap: 8, minWidth: 80 }}>
              <ProgressBar value={s.score} color={scoreColor(s.score)} height={8} />
              <span style={{ fontWeight: 700, color: scoreColor(s.score), fontSize: 13, minWidth: 28 }}>{s.score}</span>
            </div>,
            <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <StatusDot color={statusColor[s.status]} /> {s.status}
            </span>,
            <span style={{ fontSize: 12 }}>{s.products}</span>,
            s.nextEval,
          ])}
        />
      </Card>

      <Card>
        <SectionTitle>Критерии оценки поставщика</SectionTitle>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 12 }}>
          {[
            { label: "Качество", weight: "30%", icon: "\u{1F3AF}" },
            { label: "Доставка", weight: "20%", icon: "\u{1F69A}" },
            { label: "Документация", weight: "20%", icon: "\u{1F4C4}" },
            { label: "Коммуникация", weight: "10%", icon: "\u{1F4AC}" },
            { label: "Цена", weight: "10%", icon: "\u{1F4B0}" },
            { label: "Соответствие", weight: "10%", icon: "\u2705" },
          ].map(c => (
            <div key={c.label} style={{
              display: "flex", alignItems: "center", gap: 10,
              padding: 10, background: SURFACE, borderRadius: 8, border: `1px solid ${BORDER}`,
            }}>
              <span style={{ fontSize: 20 }}>{c.icon}</span>
              <div>
                <div style={{ fontSize: 13, fontWeight: 600, color: TEXT }}>{c.label}</div>
                <div style={{ fontSize: 12, color: ACCENT, fontWeight: 600 }}>{c.weight}</div>
              </div>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
};





const AuditsModule: React.FC = () => {
  const [tab, setTab] = useState("План");
  const audits = [
    { id: "AUD-012", type: "Внутренний", process: "Закупки (7.4)", status: "В процессе", lead: "Костюков И.А.", date: "10-14.02.2026", findings: 3 },
    { id: "AUD-011", type: "Внутренний", process: "Производство (7.5)", status: "Завершён", lead: "Холтобин А.В.", date: "20-24.01.2026", findings: 5 },
    { id: "AUD-013", type: "Внутренний", process: "Управление документами (4.2)", status: "Запланирован", lead: "Костюков И.А.", date: "03-07.03.2026", findings: 0 },
  ];

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <KpiRow items={[
        { icon: "\u{1F4CB}", label: "Запланировано", value: "4", color: BLUE },
        { icon: "\u{1F504}", label: "В процессе", value: "1", color: AMBER },
        { icon: "\u2705", label: "Завершено", value: "11", sub: "за 12 мес.", color: ACCENT },
        { icon: "\u{1F4CA}", label: "Замечаний", value: "23", color: RED },
      ]} />

      <TabBar tabs={["План", "Проведение", "Замечания", "Отчёты"]} active={tab} onChange={setTab} />

      <div style={{ display: "flex", gap: 8 }}>
        <ActionBtn primary>{"\uFF0B"} Создать аудит</ActionBtn>
        <ActionBtn>{"\u{1F4C5}"} Годовой план</ActionBtn>
      </div>

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <Table
          columns={["ID", "Тип", "Процесс / Раздел ISO", "Статус", "Ведущий аудитор", "Даты", "Замечания"]}
          rows={audits.map(a => [
            <span style={{ color: ACCENT, fontWeight: 600, fontFamily: "monospace" }}>{a.id}</span>,
            <Badge>{a.type}</Badge>,
            a.process,
            <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <StatusDot color={a.status === "Завершён" ? ACCENT : a.status === "В процессе" ? AMBER : BLUE} />
              {a.status}
            </span>,
            a.lead,
            a.date,
            a.findings > 0 ? <Badge color={a.findings > 3 ? RED : AMBER}>{a.findings}</Badge> : "—",
          ])}
        />
      </Card>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
        <Card>
          <SectionTitle>Годовой план аудитов</SectionTitle>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(12, 1fr)", gap: 2 }}>
            {["Я","Ф","М","А","М","И","И","А","С","О","Н","Д"].map((m, i) => (
              <div key={i} style={{ textAlign: "center", fontSize: 10, color: TEXT_DIM, padding: 2 }}>{m}</div>
            ))}
            {["4.2","5.6","6.2","7.1","7.4","7.5","8.2","8.5"].map((proc, pi) => (
              <React.Fragment key={`ap-${proc}`}>
                {Array.from({ length: 12 }, (_, mi) => {
                  const planned = (pi + mi) % 4 === 0;
                  const done = planned && mi < 2;
                  return (
                    <div key={`${pi}-${mi}`} style={{
                      height: 16, borderRadius: 3,
                      background: done ? ACCENT + "44" : planned ? BLUE + "33" : SURFACE,
                      border: `1px solid ${done ? ACCENT + "44" : planned ? BLUE + "33" : BORDER + "33"}`,
                    }} />
                  );
                })}
              </React.Fragment>
            ))}
          </div>
          <div style={{ display: "flex", gap: 16, marginTop: 8 }}>
            <span style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: TEXT_DIM }}>
              <div style={{ width: 10, height: 10, borderRadius: 2, background: ACCENT + "44" }} /> Проведён
            </span>
            <span style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: TEXT_DIM }}>
              <div style={{ width: 10, height: 10, borderRadius: 2, background: BLUE + "33" }} /> Запланирован
            </span>
          </div>
        </Card>

        <Card>
          <SectionTitle>Классификация замечаний</SectionTitle>
          {[
            { label: "Несоответствие (major)", count: 3, color: RED },
            { label: "Несоответствие (minor)", count: 8, color: AMBER },
            { label: "Наблюдение", count: 7, color: BLUE },
            { label: "Рекомендация", count: 5, color: ACCENT },
          ].map(f => (
            <div key={f.label} style={{ marginBottom: 10 }}>
              <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, marginBottom: 3 }}>
                <span style={{ color: TEXT }}>{f.label}</span>
                <span style={{ color: f.color, fontWeight: 600 }}>{f.count}</span>
              </div>
              <ProgressBar value={f.count * 4.3} color={f.color} />
            </div>
          ))}
        </Card>
      </div>
    </div>
  );
};





const TrainingModule: React.FC = () => {
  const records = [
    { employee: "Омельченко А.Г.", role: "Backend Dev", topic: "ISO 13485:2016 основы", status: "Пройдено", date: "05.02.2026", score: 92 as number | null, valid: "05.02.2027" },
    { employee: "Чирков И.А.", role: "Junior Dev", topic: "GMP для МИ", status: "В процессе", date: "—", score: null, valid: "—" },
    { employee: "Костюков И.А.", role: "Зам. тех. директора", topic: "Внутренний аудит ISO 19011", status: "Пройдено", date: "15.01.2026", score: 88, valid: "15.01.2028" },
    { employee: "Яровой Е.А.", role: "Ком. директор", topic: "Требования к МИ (ГОСТ)", status: "Просрочено", date: "—", score: null, valid: "Просрочено" },
  ];

  const statColor: Record<string, string> = { "Пройдено": ACCENT, "В процессе": AMBER, "Просрочено": RED };

  const competencyData = [
    [3,3,3,3,2],
    [3,2,3,2,2],
    [2,1,1,1,1],
    [1,1,0,0,2],
    [1,1,0,0,0],
  ];
  const competencyNames = ["Холтобин А.В.", "Костюков И.А.", "Омельченко А.Г.", "Яровой Е.А.", "Чирков И.А."];
  const competencyHeaders = ["ISO 13485", "GMP", "Аудит", "Risk Mgmt", "ГОСТ МИ"];
  const levelLabels = ["\u2014", "\u25CF", "\u25CF\u25CF", "\u25CF\u25CF\u25CF"];

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <KpiRow items={[
        { icon: "\u{1F465}", label: "Сотрудников", value: "5", color: BLUE },
        { icon: "\u{1F4DA}", label: "Курсов", value: "12", color: PURPLE },
        { icon: "\u2705", label: "Соответствие", value: "78%", color: ACCENT },
        { icon: "\u26A0\uFE0F", label: "Просрочено", value: "3", color: RED },
      ]} />

      <div style={{ display: "flex", gap: 8 }}>
        <ActionBtn primary>{"\uFF0B"} Назначить обучение</ActionBtn>
        <ActionBtn>{"\u{1F4CA}"} Матрица компетенций</ActionBtn>
        <ActionBtn>{"\u{1F4C4}"} Отчёт</ActionBtn>
      </div>

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <Table
          columns={["Сотрудник", "Должность", "Тема", "Статус", "Дата", "Балл", "Действует до"]}
          rows={records.map(r => [
            <span style={{ fontWeight: 500 }}>{r.employee}</span>,
            <span style={{ color: TEXT_DIM, fontSize: 12 }}>{r.role}</span>,
            r.topic,
            <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <StatusDot color={statColor[r.status]} /> {r.status}
            </span>,
            r.date,
            r.score ? <span style={{ color: r.score >= 80 ? ACCENT : AMBER, fontWeight: 600 }}>{r.score}%</span> : "—",
            <span style={{ color: r.valid === "Просрочено" ? RED : TEXT_DIM }}>{r.valid}</span>,
          ])}
        />
      </Card>

      <Card>
        <SectionTitle>Матрица компетенций</SectionTitle>
        <div style={{ overflowX: "auto" }}>
          <div style={{ display: "grid", gridTemplateColumns: "140px repeat(5, 1fr)", gap: 2, fontSize: 11 }}>
            <div />
            {competencyHeaders.map(h => (
              <div key={h} style={{ textAlign: "center", color: TEXT_DIM, padding: 4, fontWeight: 600 }}>{h}</div>
            ))}
            {competencyNames.map((name, ni) => (
              <React.Fragment key={`cm-${name}`}>
                <div style={{ color: TEXT, padding: 4, fontSize: 12 }}>{name}</div>
                {competencyData[ni].map((level, li) => (
                  <div key={li} style={{
                    background: level === 3 ? ACCENT + "33" : level === 2 ? BLUE + "33" : level === 1 ? AMBER + "22" : RED + "22",
                    borderRadius: 4, textAlign: "center", padding: 4,
                    color: level === 3 ? ACCENT : level === 2 ? BLUE : level === 1 ? AMBER : RED,
                    fontWeight: 600,
                  }}>
                    {levelLabels[level]}
                  </div>
                ))}
              </React.Fragment>
            ))}
          </div>
        </div>
        <div style={{ display: "flex", gap: 16, marginTop: 8 }}>
          {[
            { l: "\u25CF\u25CF\u25CF", d: "Эксперт", c: ACCENT },
            { l: "\u25CF\u25CF", d: "Обучен", c: BLUE },
            { l: "\u25CF", d: "Базовый", c: AMBER },
            { l: "\u2014", d: "Не пройдено", c: RED },
          ].map(leg => (
            <span key={leg.l} style={{ fontSize: 10, color: TEXT_DIM, display: "flex", alignItems: "center", gap: 4 }}>
              <span style={{ color: leg.c }}>{leg.l}</span> {leg.d}
            </span>
          ))}
        </div>
      </Card>
    </div>
  );
};





const EquipmentModule: React.FC = () => {
  const items = [
    { id: "EQ-001", name: "Весы аналит. XS205", type: "Измерительное", sn: "SN-X205-4421", location: "Лаб. ВК", status: "Калиброван", lastCal: "15.08.2025", nextCal: "15.02.2026", daysLeft: 4 as number | null },
    { id: "EQ-005", name: "Штангенциркуль МК-150", type: "Измерительное", sn: "SN-MK150-112", location: "Цех", status: "Калиброван", lastCal: "20.08.2025", nextCal: "20.02.2026", daysLeft: 9 },
    { id: "EQ-010", name: "Паяльная станция JBC", type: "Производственное", sn: "SN-JBC-7788", location: "Цех", status: "Квалифицирован", lastCal: "—", nextCal: "—", daysLeft: null },
    { id: "EQ-015", name: "Мультиметр Fluke 87V", type: "Измерительное", sn: "SN-FL87V-901", location: "Лаб. ВК", status: "Просрочена калибровка", lastCal: "01.02.2025", nextCal: "01.02.2026", daysLeft: -10 },
  ];

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <KpiRow items={[
        { icon: "\u{1F527}", label: "Единиц", value: "42", color: BLUE },
        { icon: "\u2705", label: "Калибровано", value: "35", color: ACCENT },
        { icon: "\u23F0", label: "Скоро калибр.", value: "4", color: AMBER },
        { icon: "\u{1F534}", label: "Просрочено", value: "3", color: RED },
      ]} />

      <div style={{ display: "flex", gap: 8 }}>
        <ActionBtn primary>{"\uFF0B"} Добавить оборудование</ActionBtn>
        <ActionBtn>{"\u{1F4CB}"} Расписание калибровок</ActionBtn>
        <ActionBtn>{"\u{1F4C4}"} Паспорта</ActionBtn>
      </div>

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <Table
          columns={["ID", "Наименование", "Тип", "S/N", "Расположение", "Статус", "Послед. калибр.", "Следующая", "Дней"]}
          rows={items.map(e => [
            <span style={{ color: ACCENT, fontWeight: 600, fontFamily: "monospace" }}>{e.id}</span>,
            <span style={{ fontWeight: 500 }}>{e.name}</span>,
            <Badge color={e.type === "Измерительное" ? BLUE : PURPLE}>{e.type}</Badge>,
            <span style={{ fontFamily: "monospace", fontSize: 11, color: TEXT_DIM }}>{e.sn}</span>,
            e.location,
            <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <StatusDot color={e.status === "Просрочена калибровка" ? RED : e.status === "Калиброван" ? ACCENT : BLUE} />
              {e.status}
            </span>,
            e.lastCal,
            e.nextCal,
            e.daysLeft !== null ? (
              <Badge color={e.daysLeft < 0 ? RED : e.daysLeft < 7 ? AMBER : ACCENT}>
                {e.daysLeft}д
              </Badge>
            ) : "—",
          ])}
        />
      </Card>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
        <Card>
          <SectionTitle>Паспорт оборудования — EQ-001</SectionTitle>
          {[
            ["Наименование", "Весы аналитические XS205"],
            ["Производитель", "Mettler Toledo"],
            ["Серийный номер", "SN-X205-4421"],
            ["Дата ввода", "15.03.2024"],
            ["Расположение", "Лаборатория входного контроля"],
            ["Периодичность калибровки", "6 месяцев"],
            ["Допустимая погрешность", "\u00B10.1 мг"],
            ["Ответственный", "Омельченко А.Г."],
          ].map(([k, v]) => (
            <div key={k} style={{
              display: "flex", justifyContent: "space-between",
              padding: "6px 0", borderBottom: `1px solid ${BORDER}22`,
              fontSize: 12,
            }}>
              <span style={{ color: TEXT_DIM }}>{k}</span>
              <span style={{ color: TEXT, fontWeight: 500 }}>{v}</span>
            </div>
          ))}
        </Card>

        <Card>
          <SectionTitle>История калибровок — EQ-001</SectionTitle>
          <Timeline events={[
            { date: "15.08.2025", title: "Калибровка — ГОДЕН", desc: "Погрешность: 0.05 мг (норма \u00B10.1)", color: ACCENT },
            { date: "15.02.2025", title: "Калибровка — ГОДЕН", desc: "Погрешность: 0.07 мг", color: ACCENT },
            { date: "15.08.2024", title: "Калибровка — ГОДЕН", desc: "Погрешность: 0.04 мг", color: ACCENT },
            { date: "15.03.2024", title: "IQ/OQ — ПРОЙДЕНО", desc: "Первичная квалификация", color: BLUE },
          ]} />
        </Card>
      </div>
    </div>
  );
};





const ManagementReviewModule: React.FC = () => {
  const reviews = [
    { id: "MR-004", period: "H2 2025", date: "15.01.2026", status: "Утверждён", chair: "Холтобин А.В.", decisions: 8, actions: 12 },
    { id: "MR-003", period: "H1 2025", date: "10.07.2025", status: "Утверждён", chair: "Холтобин А.В.", decisions: 6, actions: 9 },
    { id: "MR-005", period: "H1 2026", date: "—", status: "Планируется", chair: "Холтобин А.В.", decisions: 0, actions: 0 },
  ];

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <KpiRow items={[
        { icon: "\u{1F4CB}", label: "Проведено", value: "4", sub: "за 2 года", color: BLUE },
        { icon: "\u2705", label: "Решений", value: "26", color: ACCENT },
        { icon: "\u{1F504}", label: "Действий", value: "38", sub: "14 открытых", color: AMBER },
        { icon: "\u{1F4C5}", label: "Следующий", value: "Июль", sub: "2026", color: PURPLE },
      ]} />

      <ActionBtn primary>{"\uFF0B"} Создать анализ</ActionBtn>

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <Table
          columns={["ID", "Период", "Дата", "Статус", "Председатель", "Решений", "Действий"]}
          rows={reviews.map(r => [
            <span style={{ color: ACCENT, fontWeight: 600, fontFamily: "monospace" }}>{r.id}</span>,
            <span style={{ fontWeight: 500 }}>{r.period}</span>,
            r.date,
            <span style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <StatusDot color={r.status === "Утверждён" ? ACCENT : BLUE} /> {r.status}
            </span>,
            r.chair,
            r.decisions || "—",
            r.actions || "—",
          ])}
        />
      </Card>

      <Card>
        <SectionTitle>Входные данные (ISO 13485, п.5.6.2)</SectionTitle>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
          {[
            { label: "Результаты аудитов", value: "11 аудитов, 23 замечания", icon: "\u{1F4CB}", status: ACCENT },
            { label: "Обратная связь от потребителей", value: "2 рекламации, NPS 78", icon: "\u{1F4AC}", status: AMBER },
            { label: "Результативность процессов", value: "KPI достигнуты на 85%", icon: "\u{1F4CA}", status: ACCENT },
            { label: "Статус CAPA", value: "42 закрыто, 15 открыто", icon: "\u{1F504}", status: AMBER },
            { label: "Изменения нормативных требований", value: "ГОСТ Р ИСО 13485-2024", icon: "\u{1F4DC}", status: BLUE },
            { label: "Результаты управления рисками", value: "6 высоких рисков", icon: "\u26A0\uFE0F", status: RED },
            { label: "Рекомендации по улучшению", value: "12 предложений", icon: "\u{1F4A1}", status: PURPLE },
            { label: "Статус обучения персонала", value: "78% соответствие", icon: "\u{1F465}", status: AMBER },
          ].map(item => (
            <div key={item.label} style={{
              display: "flex", gap: 10, padding: 10,
              background: SURFACE, borderRadius: 8,
              border: `1px solid ${BORDER}`, alignItems: "flex-start",
            }}>
              <span style={{ fontSize: 18, flexShrink: 0 }}>{item.icon}</span>
              <div>
                <div style={{ fontSize: 12, fontWeight: 600, color: TEXT }}>{item.label}</div>
                <div style={{ fontSize: 11, color: item.status, marginTop: 2 }}>{item.value}</div>
              </div>
            </div>
          ))}
        </div>
      </Card>

      <Card>
        <SectionTitle>Решения и действия — MR-004</SectionTitle>
        {[
          { title: "Обновить процедуру закупок", status: "Выполнено", owner: "Костюков И.А.", due: "01.03.2026" },
          { title: "Провести повторную квалификацию SUP-005", status: "В работе", owner: "Омельченко А.Г.", due: "15.03.2026" },
          { title: "Разработать план обучения на 2026", status: "В работе", owner: "Яровой Е.А.", due: "01.04.2026" },
          { title: "Пересмотреть риск-реестр", status: "Не начато", owner: "Холтобин А.В.", due: "01.05.2026" },
        ].map(a => (
          <div key={a.title} style={{
            display: "flex", justifyContent: "space-between", alignItems: "center",
            padding: "8px 0", borderBottom: `1px solid ${BORDER}22`,
          }}>
            <div>
              <div style={{ fontSize: 13, color: TEXT }}>{a.title}</div>
              <div style={{ fontSize: 11, color: TEXT_DIM }}>{a.owner} \u2192 {a.due}</div>
            </div>
            <Badge color={a.status === "Выполнено" ? ACCENT : a.status === "В работе" ? AMBER : TEXT_DIM}>{a.status}</Badge>
          </div>
        ))}
      </Card>
    </div>
  );
};





const MODULES: { key: string; label: string; icon: string; Component: React.FC }[] = [
  { key: "dashboard", label: "Дашборд", icon: "\u{1F4CA}", Component: DashboardModule },
  { key: "documents", label: "Документы", icon: "\u{1F4C4}", Component: DocumentsModule },
  { key: "nc", label: "Несоответствия", icon: "\u26A0\uFE0F", Component: NonconformityModule },
  { key: "capa", label: "CAPA", icon: "\u{1F504}", Component: CapaModule },
  { key: "risks", label: "Риски", icon: "\u{1F3AF}", Component: RisksModule },
  { key: "suppliers", label: "Поставщики", icon: "\u{1F3ED}", Component: SuppliersModule },
  { key: "audits", label: "Аудиты", icon: "\u{1F4CB}", Component: AuditsModule },
  { key: "training", label: "Обучение", icon: "\u{1F4DA}", Component: TrainingModule },
  { key: "equipment", label: "Оборудование", icon: "\u{1F527}", Component: EquipmentModule },
  { key: "review", label: "Анализ руководства", icon: "\u{1F454}", Component: ManagementReviewModule },
];

export const QmsPrototypePage: React.FC = () => {
  const [active, setActive] = useState("dashboard");
  const mod = MODULES.find(m => m.key === active) || MODULES[0];

  return (
    <div style={{
      background: SURFACE,
      minHeight: "100vh",
      color: TEXT,
      fontFamily: "'Segoe UI', -apple-system, sans-serif",
    }}>
      {}
      <div style={{
        background: "#0a1219",
        borderBottom: `1px solid ${BORDER}`,
        padding: "0 24px",
        display: "flex",
        alignItems: "center",
        height: 52,
        gap: 24,
      }}>
        <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
          <div style={{
            width: 32, height: 32, borderRadius: 8,
            background: `linear-gradient(135deg, ${ACCENT}, ${ACCENT}88)`,
            display: "flex", alignItems: "center", justifyContent: "center",
            fontSize: 16, fontWeight: 800, color: SURFACE,
          }}>A</div>
          <span style={{ fontWeight: 700, fontSize: 15, color: TEXT }}>ASVO-QMS</span>
          <Badge color={ACCENT}>Dev</Badge>
        </div>

        <div style={{ display: "flex", gap: 2, marginLeft: 24 }}>
          {["Задачи", "Качество", "Склад", "Админ"].map(tab => (
            <button key={tab} style={{
              padding: "6px 16px",
              background: tab === "Качество" ? ACCENT_DIM : "transparent",
              color: tab === "Качество" ? ACCENT : TEXT_DIM,
              border: "none",
              borderRadius: 6,
              fontSize: 13,
              fontWeight: 500,
              cursor: "pointer",
            }}>{tab}</button>
          ))}
        </div>

        <div style={{ marginLeft: "auto", display: "flex", gap: 16, alignItems: "center" }}>
          <span style={{ fontSize: 12, color: TEXT_DIM }}>11.02.2026 12:45</span>
          <div style={{
            width: 32, height: 32, borderRadius: "50%",
            background: SURFACE3, display: "flex", alignItems: "center", justifyContent: "center",
            fontSize: 13, fontWeight: 600, color: ACCENT,
          }}>ИК</div>
        </div>
      </div>

      {}
      <div style={{ display: "flex" }}>
        {}
        <div style={{
          width: 220,
          borderRight: `1px solid ${BORDER}`,
          background: "#0c161f",
          padding: "12px 8px",
          minHeight: "calc(100vh - 52px)",
          flexShrink: 0,
        }}>
          <div style={{ padding: "8px 12px", fontSize: 11, color: TEXT_DIM, textTransform: "uppercase", letterSpacing: 1, fontWeight: 600 }}>
            Качество
          </div>
          {MODULES.map(m => (
            <button
              key={m.key}
              onClick={() => setActive(m.key)}
              style={{
                width: "100%",
                display: "flex",
                alignItems: "center",
                gap: 10,
                padding: "9px 12px",
                background: active === m.key ? ACCENT_DIM : "transparent",
                color: active === m.key ? ACCENT : TEXT_DIM,
                border: "none",
                borderRadius: 8,
                cursor: "pointer",
                fontSize: 13,
                fontWeight: active === m.key ? 600 : 400,
                textAlign: "left",
                transition: "all 0.15s",
                marginBottom: 2,
                borderLeft: active === m.key ? `3px solid ${ACCENT}` : "3px solid transparent",
              }}
            >
              <span style={{ fontSize: 16, width: 22 }}>{m.icon}</span>
              {m.label}
            </button>
          ))}
        </div>

        {}
        <div style={{ flex: 1, padding: 24, overflow: "auto", maxHeight: "calc(100vh - 52px)" }}>
          <div style={{
            display: "flex", justifyContent: "space-between", alignItems: "center",
            marginBottom: 20,
          }}>
            <h2 style={{ fontSize: 20, fontWeight: 700, margin: 0, display: "flex", alignItems: "center", gap: 10 }}>
              <span style={{ fontSize: 24 }}>{mod.icon}</span>
              {mod.label}
            </h2>
            <div style={{ fontSize: 12, color: TEXT_DIM }}>
              ISO 13485:2016 &bull; ASVO-QMS v2.0
            </div>
          </div>
          <mod.Component />
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Quality/AuditsPage.tsx
================================================================================

import React, { useState } from "react";
import {
  ClipboardCheck,
  Plus,
  Download,
  CheckCircle2,
  AlertTriangle,
  BarChart3,
  Calendar,
} from "lucide-react";
import KpiRow from "../../components/qms/KpiRow";
import TabBar from "../../components/qms/TabBar";
import ActionBtn from "../../components/qms/ActionBtn";
import Badge from "../../components/qms/Badge";
import DataTable from "../../components/qms/DataTable";
import ProgressBar from "../../components/qms/ProgressBar";
import SectionTitle from "../../components/qms/SectionTitle";
import Card from "../../components/qms/Card";





interface AuditRow {
  [key: string]: unknown;
  id: string;
  type: string;
  process: string;
  auditor: string;
  date: string;
  status: "completed" | "in_progress" | "planned" | "cancelled";
  findings: number;
  result: string;
}

const AUDITS: AuditRow[] = [
  { id: "AUD-012", type: "Внутренний", process: "Закупки (п.7.4)",       auditor: "Костюков И.",   date: "10.02.2026", status: "in_progress", findings: 4, result: "\u2014" },
  { id: "AUD-011", type: "Внутренний", process: "Производство (п.7.5)",  auditor: "Холтобин А.",   date: "25.01.2026", status: "completed",   findings: 6, result: "Соответствует" },
  { id: "AUD-010", type: "Внешний",    process: "СМК (полный)",          auditor: "Bureau Veritas", date: "15.01.2026", status: "completed",   findings: 2, result: "Соответствует" },
  { id: "AUD-009", type: "Внутренний", process: "NC/CAPA (п.8.3\u20138.5)", auditor: "Яровой Е.",  date: "10.12.2025", status: "completed",   findings: 5, result: "Условно" },
  { id: "AUD-008", type: "Поставщика", process: "SUP-012",              auditor: "Костюков И.",   date: "01.12.2025", status: "completed",   findings: 8, result: "Не соответствует" },
  { id: "AUD-007", type: "Внутренний", process: "Документы (п.4.2)",    auditor: "Омельченко А.", date: "15.11.2025", status: "completed",   findings: 3, result: "Соответствует" },
];



const MONTHS = ["Янв", "Фев", "Мар", "Апр", "Май", "Июн", "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек"];

const ISO_PROCESSES = [
  "4.2 Документы",
  "7.1 Планирование",
  "7.4 Закупки",
  "7.5 Производство",
  "8.2 Мониторинг",
  "8.3 NC",
  "8.5 CAPA",
  "6.2 Персонал",
];

type CellState = "empty" | "planned" | "done";


const PLAN_GRID: CellState[][] = [
   ["done","empty","planned","empty","empty","empty","done","empty","empty","planned","empty","empty"],
   ["empty","done","empty","empty","planned","empty","empty","done","empty","empty","planned","empty"],
   ["empty","empty","done","empty","empty","planned","empty","empty","done","empty","empty","planned"],
   ["done","empty","empty","done","empty","empty","planned","empty","empty","done","empty","empty"],
   ["empty","planned","empty","empty","done","empty","empty","planned","empty","empty","done","empty"],
   ["empty","empty","empty","done","empty","empty","done","empty","planned","empty","empty","done"],
   ["empty","empty","planned","empty","empty","done","empty","empty","empty","planned","empty","done"],
   ["planned","empty","empty","empty","done","empty","empty","empty","done","empty","empty","planned"],
];



const FINDINGS = [
  { label: "Критические",    count: 3,  pct: 15, color: "red"   as const },
  { label: "Значительные",   count: 8,  pct: 40, color: "amber" as const },
  { label: "Незначительные", count: 18, pct: 70, color: "blue"  as const },
  { label: "Наблюдения",     count: 5,  pct: 30, color: "accent" as const },
];



const STATUS_CFG: Record<AuditRow["status"], { label: string; color: string; bg: string }> = {
  completed:   { label: "Завершён",     color: "#2DD4A8", bg: "rgba(45,212,168,0.12)" },
  in_progress: { label: "В процессе",   color: "#4A90E8", bg: "rgba(74,144,232,0.12)" },
  planned:     { label: "Запланирован", color: "#E8A830", bg: "rgba(232,168,48,0.12)" },
  cancelled:   { label: "Отменён",      color: "#F06060", bg: "rgba(240,96,96,0.12)" },
};



const resultColor = (r: string) => {
  if (r === "Соответствует")      return { color: "#2DD4A8", bg: "rgba(45,212,168,0.12)" };
  if (r === "Условно")            return { color: "#E8A830", bg: "rgba(232,168,48,0.12)" };
  if (r === "Не соответствует")   return { color: "#F06060", bg: "rgba(240,96,96,0.12)" };
  return undefined;
};



const TABS = [
  { key: "registry",  label: "Реестр" },
  { key: "plan",      label: "Годовой план" },
  { key: "findings",  label: "Замечания" },
  { key: "reports",   label: "Отчёты" },
];



const cellCls: Record<CellState, string> = {
  planned: "bg-asvo-blue-dim border border-asvo-blue/30",
  done:    "bg-asvo-accent-dim border border-asvo-accent/30",
  empty:   "bg-asvo-surface border border-asvo-border",
};





const AuditsPage: React.FC = () => {
  const [tab, setTab] = useState("registry");

  

  const columns = [
    {
      key: "id",
      label: "ID",
      width: "100px",
      render: (r: AuditRow) => (
        <span className="font-mono text-asvo-accent">{r.id}</span>
      ),
    },
    { key: "type", label: "Тип аудита", render: (r: AuditRow) => <span className="text-asvo-text">{r.type}</span> },
    { key: "process", label: "Процесс", render: (r: AuditRow) => <span className="text-asvo-text-mid">{r.process}</span> },
    { key: "auditor", label: "Аудитор", render: (r: AuditRow) => <span className="text-asvo-text-mid">{r.auditor}</span> },
    {
      key: "date",
      label: "Дата",
      render: (r: AuditRow) => (
        <span className="flex items-center gap-1 text-asvo-text-mid">
          <Calendar size={12} className="text-asvo-text-dim" />
          {r.date}
        </span>
      ),
    },
    {
      key: "status",
      label: "Статус",
      align: "center" as const,
      render: (r: AuditRow) => {
        const s = STATUS_CFG[r.status];
        return <Badge color={s.color} bg={s.bg}>{s.label}</Badge>;
      },
    },
    {
      key: "findings",
      label: "Замечаний",
      align: "center" as const,
      render: (r: AuditRow) => <span className="text-asvo-text-mid">{r.findings}</span>,
    },
    {
      key: "result",
      label: "Результат",
      align: "center" as const,
      render: (r: AuditRow) => {
        const rc = resultColor(r.result);
        return rc ? <Badge color={rc.color} bg={rc.bg}>{r.result}</Badge> : <span className="text-asvo-text-dim">{r.result}</span>;
      },
    },
  ];

  

  return (
    <div className="p-6 space-y-5 bg-asvo-bg min-h-screen">
      {}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2.5 bg-asvo-blue-dim rounded-xl">
            <ClipboardCheck size={22} className="text-asvo-blue" />
          </div>
          <div>
            <h1 className="text-xl font-bold text-asvo-text">Аудиты</h1>
            <p className="text-xs text-asvo-text-dim">ISO 13485 &sect;8.2.4 &mdash; Программа внутренних аудитов</p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <ActionBtn variant="primary" icon={<Plus size={15} />}>+ Новый аудит</ActionBtn>
          <ActionBtn variant="secondary" icon={<Download size={15} />}>Экспорт</ActionBtn>
        </div>
      </div>

      {}
      <KpiRow
        items={[
          { label: "Всего аудитов", value: 18, icon: <ClipboardCheck size={18} />, color: "#4A90E8" },
          { label: "Выполнено",     value: 12, icon: <CheckCircle2 size={18} />,   color: "#2DD4A8" },
          { label: "Замечаний",     value: 34, icon: <AlertTriangle size={18} />,   color: "#E8A830" },
          { label: "Соответствие",  value: "92%", icon: <BarChart3 size={18} />,    color: "#2DD4A8" },
        ]}
      />

      {}
      <TabBar tabs={TABS} active={tab} onChange={setTab} />

      {}
      {tab === "registry" && <DataTable columns={columns} data={AUDITS} />}

      {}
      {tab === "plan" && (
        <Card>
          <SectionTitle>Годовой план аудитов 2026</SectionTitle>

          <div className="overflow-x-auto">
            <table className="w-full border-collapse">
              <thead>
                <tr>
                  <th className="text-left text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider px-2 py-2 w-40">
                    Процесс
                  </th>
                  {MONTHS.map((m) => (
                    <th key={m} className="text-center text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider px-1 py-2">
                      {m}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {ISO_PROCESSES.map((proc, ri) => (
                  <tr key={proc} className="border-t border-asvo-border/40">
                    <td className="px-2 py-2 text-[12px] text-asvo-text-mid whitespace-nowrap">{proc}</td>
                    {PLAN_GRID[ri].map((cell, ci) => (
                      <td key={ci} className="px-1 py-2 text-center">
                        <div className={`w-4 h-4 rounded-[3px] mx-auto ${cellCls[cell]}`} />
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {}
          <div className="flex items-center gap-5 mt-4 text-[11px] text-asvo-text-dim">
            <span className="flex items-center gap-1.5">
              <div className="w-3 h-3 rounded-sm bg-asvo-blue-dim border border-asvo-blue/30" /> Запланирован
            </span>
            <span className="flex items-center gap-1.5">
              <div className="w-3 h-3 rounded-sm bg-asvo-accent-dim border border-asvo-accent/30" /> Выполнен
            </span>
            <span className="flex items-center gap-1.5">
              <div className="w-3 h-3 rounded-sm bg-asvo-surface border border-asvo-border" /> Пусто
            </span>
          </div>
        </Card>
      )}

      {}
      {tab === "findings" && (
        <Card>
          <SectionTitle>Классификация замечаний</SectionTitle>

          <div className="space-y-4">
            {FINDINGS.map((f) => (
              <div key={f.label} className="space-y-1.5">
                <div className="flex items-center justify-between">
                  <span className="text-[13px] text-asvo-text">{f.label}</span>
                  <span className="text-[13px] font-semibold text-asvo-text-mid">{f.count} ({f.pct}%)</span>
                </div>
                <ProgressBar value={f.pct} color={f.color} />
              </div>
            ))}
          </div>
        </Card>
      )}

      {}
      {tab === "reports" && (
        <Card>
          <div className="flex flex-col items-center justify-center py-12 text-asvo-text-dim">
            <BarChart3 size={40} className="mb-3 opacity-30" />
            <p className="text-[13px]">Раздел отчётов находится в разработке</p>
          </div>
        </Card>
      )}
    </div>
  );
};

export default AuditsPage;

================================================================================
FILE: QMS-Client-main/src/pages/Quality/EquipmentPage.tsx
================================================================================

import React, { useState } from "react";
import {
  Wrench,
  Plus,
  CalendarClock,
  Download,
  CheckCircle2,
  AlertTriangle,
  Clock,
  Boxes,
} from "lucide-react";
import KpiRow from "../../components/qms/KpiRow";
import ActionBtn from "../../components/qms/ActionBtn";
import DataTable from "../../components/qms/DataTable";
import Badge from "../../components/qms/Badge";
import Card from "../../components/qms/Card";
import SectionTitle from "../../components/qms/SectionTitle";
import Timeline from "../../components/qms/Timeline";



interface EquipmentRow {
  [key: string]: unknown;
  id: string;
  name: string;
  type: string;
  manufacturer: string;
  serial: string;
  lastCalibration: string;
  nextCalibration: string;
  daysUntil: number;
  status: string;
}

const equipmentData: EquipmentRow[] = [
  { id: "EQ-001", name: "Мультиметр Fluke 87V",      type: "Измерительное",   manufacturer: "Fluke",     serial: "FL87V-2024-0891",  lastCalibration: "10.01.2026", nextCalibration: "10.07.2026", daysUntil: 149,  status: "Исправно" },
  { id: "EQ-005", name: "Осциллограф Rigol DS1104",   type: "Измерительное",   manufacturer: "Rigol",     serial: "RG-DS1104-2891",   lastCalibration: "15.12.2025", nextCalibration: "15.06.2026", daysUntil: 124,  status: "Исправно" },
  { id: "EQ-008", name: "Паяльная станция JBC CD-2BE", type: "Технологическое", manufacturer: "JBC",       serial: "JBC-CD2-7721",     lastCalibration: "01.01.2026", nextCalibration: "01.04.2026", daysUntil: 49,   status: "Исправно" },
  { id: "EQ-012", name: "Паяльная станция JBC DM-2A",  type: "Технологическое", manufacturer: "JBC",       serial: "JBC-DM2-4402",     lastCalibration: "15.09.2025", nextCalibration: "15.03.2026", daysUntil: 32,   status: "Калибровка" },
  { id: "EQ-015", name: "Микроскоп Olympus SZX7",     type: "Контрольное",     manufacturer: "Olympus",   serial: "OL-SZX7-1823",     lastCalibration: "01.06.2025", nextCalibration: "01.12.2025", daysUntil: -72,  status: "Просрочено" },
  { id: "EQ-020", name: "Климатическая камера",        type: "Испытательное",   manufacturer: "Binder",    serial: "BN-MK56-3301",     lastCalibration: "01.08.2025", nextCalibration: "01.02.2026", daysUntil: -10,  status: "Просрочено" },
  { id: "EQ-025", name: "Весы аналитические",          type: "Измерительное",   manufacturer: "Sartorius", serial: "SAR-224-8812",      lastCalibration: "20.01.2026", nextCalibration: "20.07.2026", daysUntil: 159,  status: "Исправно" },
];



const passportRows: { label: string; value: string }[] = [
  { label: "Название",        value: "Мультиметр Fluke 87V" },
  { label: "Инв.номер",       value: "EQ-001" },
  { label: "Серийный",        value: "FL87V-2024-0891" },
  { label: "Производитель",   value: "Fluke Corporation" },
  { label: "Дата ввода",      value: "15.03.2024" },
  { label: "Расположение",    value: "Лаборатория ОТК" },
  { label: "Класс точности",  value: "0.05%" },
  { label: "Ответственный",   value: "Чирков И.А." },
];



const calibrationHistory = [
  { date: "10.01.2026", title: "Калибровка выполнена. Результат: годен. Отклонение: 0.02%", color: "#2DD4A8" },
  { date: "10.07.2025", title: "Калибровка выполнена. Результат: годен. Отклонение: 0.03%", color: "#2DD4A8" },
  { date: "10.01.2025", title: "Калибровка выполнена. Результат: годен. Отклонение: 0.01%", color: "#2DD4A8" },
];



const daysBadge = (d: number) => {
  if (d <= 7)  return <Badge color="#F06060">{d}&nbsp;дн.</Badge>;
  if (d <= 30) return <Badge color="#E8A830">{d}&nbsp;дн.</Badge>;
  return <Badge color="#2DD4A8">{d}&nbsp;дн.</Badge>;
};

const statusBadge = (s: string) => {
  switch (s) {
    case "Исправно":    return <Badge color="#2DD4A8">{s}</Badge>;
    case "Калибровка":  return <Badge color="#E8A830">{s}</Badge>;
    case "Просрочено":  return <Badge color="#F06060">{s}</Badge>;
    default:            return <Badge>{s}</Badge>;
  }
};



const columns = [
  {
    key: "id",
    label: "ID",
    width: "90px",
    render: (r: EquipmentRow) => (
      <span className="font-mono text-asvo-accent">{r.id}</span>
    ),
  },
  { key: "name",            label: "Название",             render: (r: EquipmentRow) => <span className="text-asvo-text">{r.name}</span> },
  { key: "type",            label: "Тип",                  render: (r: EquipmentRow) => <span className="text-asvo-text-mid">{r.type}</span> },
  { key: "manufacturer",    label: "Производитель",        render: (r: EquipmentRow) => <span className="text-asvo-text-mid">{r.manufacturer}</span> },
  { key: "serial",          label: "Серийный номер",       render: (r: EquipmentRow) => <span className="font-mono text-asvo-text-mid text-[12px]">{r.serial}</span> },
  { key: "lastCalibration", label: "Послед. калибровка",   render: (r: EquipmentRow) => <span className="text-asvo-text-mid">{r.lastCalibration}</span> },
  { key: "nextCalibration", label: "Следующая калибровка", render: (r: EquipmentRow) => <span className="text-asvo-text-mid">{r.nextCalibration}</span> },
  {
    key: "daysUntil",
    label: "Дней до калибр.",
    align: "center" as const,
    render: (r: EquipmentRow) => daysBadge(r.daysUntil),
  },
  {
    key: "status",
    label: "Статус",
    align: "center" as const,
    render: (r: EquipmentRow) => statusBadge(r.status),
  },
];



const EquipmentPage: React.FC = () => {
  const [_selected] = useState<string | null>("EQ-001");

  return (
    <div className="min-h-screen bg-asvo-bg p-6 space-y-6">
      {}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-asvo-amber-dim rounded-lg">
            <Wrench className="text-[#E8A830]" size={24} />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-asvo-text">
              Оборудование и калибровка
            </h1>
            <p className="text-asvo-text-dim text-sm">
              ISO 13485 &sect;7.6 &mdash; Управление оборудованием для мониторинга и измерений
            </p>
          </div>
        </div>
      </div>

      {}
      <KpiRow
        items={[
          { label: "Всего оборудования", value: 56, icon: <Boxes size={18} />,          color: "#4A90E8" },
          { label: "На калибровке",       value: 4,  icon: <Clock size={18} />,           color: "#E8A830" },
          { label: "Просрочено",          value: 2,  icon: <AlertTriangle size={18} />,   color: "#F06060" },
          { label: "Исправно",            value: 48, icon: <CheckCircle2 size={18} />,    color: "#2DD4A8" },
        ]}
      />

      {}
      <div className="flex items-center gap-3">
        <ActionBtn variant="primary" icon={<Plus size={15} />}>
          + Добавить оборудование
        </ActionBtn>
        <ActionBtn variant="secondary" color="#4A90E8" icon={<CalendarClock size={15} />}>
          График калибровки
        </ActionBtn>
        <ActionBtn variant="secondary" icon={<Download size={15} />}>
          Экспорт
        </ActionBtn>
      </div>

      {}
      <SectionTitle>Реестр оборудования</SectionTitle>
      <DataTable<EquipmentRow> columns={columns} data={equipmentData} />

      {}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-5">
        {}
        <Card>
          <SectionTitle>Паспорт оборудования &mdash; EQ-001</SectionTitle>
          <div className="divide-y divide-asvo-border">
            {passportRows.map((r) => (
              <div key={r.label} className="flex justify-between py-2.5 text-[13px]">
                <span className="text-asvo-text-mid">{r.label}</span>
                <span className="text-asvo-text font-medium">{r.value}</span>
              </div>
            ))}
          </div>
        </Card>

        {}
        <Card>
          <SectionTitle>История калибровок &mdash; EQ-001</SectionTitle>
          <Timeline events={calibrationHistory} />
        </Card>
      </div>
    </div>
  );
};

export default EquipmentPage;

================================================================================
FILE: QMS-Client-main/src/pages/Quality/ReviewPage.tsx
================================================================================

import React from "react";
import {
  BarChart3,
  Plus,
  FileText,
  ClipboardList,
  Users,
  Activity,
  CheckCircle2,
  RefreshCw,
  TrendingUp,
  AlertTriangle,
} from "lucide-react";
import KpiRow from "../../components/qms/KpiRow";
import ActionBtn from "../../components/qms/ActionBtn";
import DataTable from "../../components/qms/DataTable";
import Badge from "../../components/qms/Badge";
import Card from "../../components/qms/Card";
import SectionTitle from "../../components/qms/SectionTitle";



interface ReviewRow {
  [key: string]: unknown;
  id: string;
  date: string;
  topic: string;
  chairman: string;
  participants: string;
  decisions: string;
  status: string;
}

const reviewData: ReviewRow[] = [
  { id: "MR-008", date: "05.02.2026", topic: "Анализ СМК Q4-2025",  chairman: "Холтобин А.", participants: "8",  decisions: "5", status: "Проведено" },
  { id: "MR-007", date: "15.11.2025", topic: "Анализ СМК Q3-2025",  chairman: "Холтобин А.", participants: "7",  decisions: "6", status: "Проведено" },
  { id: "MR-006", date: "10.08.2025", topic: "Анализ СМК Q2-2025",  chairman: "Холтобин А.", participants: "6",  decisions: "4", status: "Проведено" },
  { id: "MR-005", date: "01.05.2025", topic: "Анализ СМК Q1-2025",  chairman: "Холтобин А.", participants: "8",  decisions: "7", status: "Проведено" },
  { id: "MR-009", date: "15.05.2026", topic: "Анализ СМК Q1-2026",  chairman: "Холтобин А.", participants: "\u2014", decisions: "\u2014", status: "Запланировано" },
];



interface InputCard {
  title: string;
  icon: React.ReactNode;
  color: string;
}

const inputDataCards: InputCard[] = [
  { title: "Результаты аудитов",            icon: <ClipboardList size={24} />, color: "#4A90E8" },
  { title: "Обратная связь потребителей",    icon: <Users size={24} />,         color: "#A06AE8" },
  { title: "Функционирование процессов",    icon: <Activity size={24} />,      color: "#2DD4A8" },
  { title: "Соответствие продукции",        icon: <CheckCircle2 size={24} />,  color: "#2DD4A8" },
  { title: "Статус CAPA",                   icon: <RefreshCw size={24} />,     color: "#E8A830" },
  { title: "Изменения СМК",                 icon: <FileText size={24} />,      color: "#E87040" },
  { title: "Рекомендации по улучшению",     icon: <TrendingUp size={24} />,    color: "#2DD4A8" },
  { title: "Новые требования",              icon: <AlertTriangle size={24} />, color: "#F06060" },
];



interface DecisionRow {
  [key: string]: unknown;
  action: string;
  responsible: string;
  status: string;
}

const decisionsData: DecisionRow[] = [
  { action: "Обновить процедуру закупок",             responsible: "Холтобин А.",   status: "В работе" },
  { action: "Провести дополнительный аудит SUP-012",  responsible: "Костюков И.",   status: "Выполнено" },
  { action: "Пересмотреть матрицу рисков",            responsible: "Яровой Е.",     status: "Назначено" },
  { action: "Обучение новых сотрудников ОТК",         responsible: "Омельченко А.", status: "Просрочено" },
];



const meetingStatusBadge = (s: string) => {
  switch (s) {
    case "Проведено":     return <Badge color="#2DD4A8">{s}</Badge>;
    case "Запланировано": return <Badge color="#4A90E8">{s}</Badge>;
    case "Отменено":      return <Badge color="#F06060">{s}</Badge>;
    default:              return <Badge>{s}</Badge>;
  }
};

const decisionStatusBadge = (s: string) => {
  switch (s) {
    case "Выполнено":  return <Badge color="#2DD4A8">{s}</Badge>;
    case "В работе":   return <Badge color="#E8A830">{s}</Badge>;
    case "Назначено":  return <Badge color="#4A90E8">{s}</Badge>;
    case "Просрочено": return <Badge color="#F06060">{s}</Badge>;
    default:           return <Badge>{s}</Badge>;
  }
};



const reviewColumns = [
  {
    key: "id",
    label: "ID",
    width: "90px",
    render: (r: ReviewRow) => (
      <span className="font-mono text-asvo-accent">{r.id}</span>
    ),
  },
  { key: "date",         label: "Дата",         render: (r: ReviewRow) => <span className="text-asvo-text-mid">{r.date}</span> },
  { key: "topic",        label: "Тема",         render: (r: ReviewRow) => <span className="text-asvo-text">{r.topic}</span> },
  { key: "chairman",     label: "Председатель", render: (r: ReviewRow) => <span className="text-asvo-text-mid">{r.chairman}</span> },
  { key: "participants", label: "Участники",    align: "center" as const, render: (r: ReviewRow) => <span className="text-asvo-text-mid">{r.participants}</span> },
  { key: "decisions",    label: "Решений",      align: "center" as const, render: (r: ReviewRow) => <span className="text-asvo-text-mid">{r.decisions}</span> },
  {
    key: "status",
    label: "Статус",
    align: "center" as const,
    render: (r: ReviewRow) => meetingStatusBadge(r.status),
  },
];

const decisionColumns = [
  { key: "action",      label: "Действие",     render: (r: DecisionRow) => <span className="text-asvo-text">{r.action}</span> },
  { key: "responsible", label: "Ответственный", render: (r: DecisionRow) => <span className="text-asvo-text-mid">{r.responsible}</span> },
  {
    key: "status",
    label: "Статус",
    align: "center" as const,
    render: (r: DecisionRow) => decisionStatusBadge(r.status),
  },
];



const ReviewPage: React.FC = () => (
  <div className="min-h-screen bg-asvo-bg p-6 space-y-6">
    {}
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-3">
        <div className="p-2 bg-asvo-blue-dim rounded-lg">
          <BarChart3 className="text-[#4A90E8]" size={24} />
        </div>
        <div>
          <h1 className="text-2xl font-bold text-asvo-text">
            Анализ со стороны руководства
          </h1>
          <p className="text-asvo-text-dim text-sm">
            ISO 13485 &sect;5.6 &mdash; Management Review
          </p>
        </div>
      </div>
    </div>

    {}
    <KpiRow
      items={[
        { label: "Всего совещаний",    value: 8,     icon: <BarChart3 size={18} />,    color: "#4A90E8" },
        { label: "Решений",            value: 24,    icon: <CheckCircle2 size={18} />, color: "#2DD4A8" },
        { label: "Открытых действий",  value: 6,     icon: <RefreshCw size={18} />,    color: "#E8A830" },
        { label: "Выполнено",          value: "85%", icon: <TrendingUp size={18} />,   color: "#2DD4A8" },
      ]}
    />

    {}
    <div className="flex items-center gap-3">
      <ActionBtn variant="primary" icon={<Plus size={15} />}>
        + Новое совещание
      </ActionBtn>
      <ActionBtn variant="secondary" icon={<FileText size={15} />}>
        Протокол
      </ActionBtn>
    </div>

    {}
    <SectionTitle>Совещания руководства</SectionTitle>
    <DataTable<ReviewRow> columns={reviewColumns} data={reviewData} />

    {}
    <SectionTitle>ISO 13485 п.5.6.2 — Входные данные анализа</SectionTitle>
    <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
      {inputDataCards.map((c) => (
        <div
          key={c.title}
          className="bg-asvo-surface-2 rounded-xl p-4 border border-asvo-border flex items-start gap-3"
        >
          <span style={{ color: c.color }} className="mt-0.5 shrink-0">
            {c.icon}
          </span>
          <span className="text-sm text-asvo-text leading-snug">{c.title}</span>
        </div>
      ))}
    </div>

    {}
    <SectionTitle>Решения и действия</SectionTitle>
    <DataTable<DecisionRow> columns={decisionColumns} data={decisionsData} />
  </div>
);

export default ReviewPage;

================================================================================
FILE: QMS-Client-main/src/pages/Quality/RisksPage.tsx
================================================================================

import React, { useState } from 'react';
import {
  Shield, Plus, Grid3X3, Download, AlertTriangle,
  Search, TrendingUp,
} from 'lucide-react';
import KpiRow from '../../components/qms/KpiRow';
import ActionBtn from '../../components/qms/ActionBtn';
import Badge from '../../components/qms/Badge';
import DataTable from '../../components/qms/DataTable';
import SectionTitle from '../../components/qms/SectionTitle';


interface RiskRow {
  id: string;
  title: string;
  category: string;
  p: number;
  s: number;
  level: number;
  riskClass: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  owner: string;
  status: string;
  [key: string]: unknown;
}


const RISKS: RiskRow[] = [
  { id: 'R-019', title: 'Задержка поставки датчиков',  category: 'Поставщик',    p: 3, s: 4, level: 12, riskClass: 'HIGH',     owner: 'Холтобин А.',  status: 'Оценка' },
  { id: 'R-018', title: 'Отказ паяльной станции',       category: 'Оборудование', p: 2, s: 5, level: 10, riskClass: 'HIGH',     owner: 'Чирков И.',    status: 'Мониторинг' },
  { id: 'R-015', title: 'Изменение требований IEC',     category: 'Регуляторный', p: 4, s: 5, level: 20, riskClass: 'CRITICAL', owner: 'Костюков И.',  status: 'Обработка' },
  { id: 'R-012', title: 'Текучесть кадров ОТК',         category: 'Персонал',     p: 3, s: 3, level: 9,  riskClass: 'MEDIUM',   owner: 'Яровой Е.',   status: 'Мониторинг' },
  { id: 'R-010', title: 'Дефект пресс-формы',           category: 'Процесс',      p: 2, s: 4, level: 8,  riskClass: 'MEDIUM',   owner: 'Омельченко А.', status: 'Снижен' },
  { id: 'R-008', title: 'Кибер-атака на ERP',           category: 'Кибер',        p: 1, s: 5, level: 5,  riskClass: 'MEDIUM',   owner: 'Холтобин А.',  status: 'Принят' },
  { id: 'R-005', title: 'Задержка сертификации',         category: 'Регуляторный', p: 5, s: 4, level: 20, riskClass: 'CRITICAL', owner: 'Костюков И.',  status: 'Оценка' },
];



const matrixCounts: Record<number, Record<number, number>> = {
  5: { 1: 0, 2: 0, 3: 1, 4: 2, 5: 0 },
  4: { 1: 0, 2: 0, 3: 1, 4: 0, 5: 0 },
  3: { 1: 0, 2: 0, 3: 1, 4: 0, 5: 0 },
  2: { 1: 0, 2: 0, 3: 0, 4: 1, 5: 1 },
  1: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 1 },
};

const severityLabels = ['1-Незначит.', '2-Малая', '3-Средняя', '4-Значит.', '5-Катастроф.'];


const cellColor = (val: number): string => {
  if (val <= 4)  return 'bg-[#2DD4A8]/20 text-[#2DD4A8]';
  if (val <= 9)  return 'bg-[#E8A830]/20 text-[#E8A830]';
  if (val <= 16) return 'bg-[#E87040]/20 text-[#E87040]';
  return 'bg-[#F06060]/20 text-[#F06060]';
};


const classColors: Record<string, { color: string; bg: string }> = {
  LOW:      { color: '#2DD4A8', bg: 'rgba(45,212,168,0.14)' },
  MEDIUM:   { color: '#E8A830', bg: 'rgba(232,168,48,0.14)' },
  HIGH:     { color: '#E87040', bg: 'rgba(232,112,64,0.14)' },
  CRITICAL: { color: '#F06060', bg: 'rgba(240,96,96,0.14)' },
};

const statusColors: Record<string, { color: string; bg: string }> = {
  'Оценка':     { color: '#A06AE8', bg: 'rgba(160,106,232,0.14)' },
  'Мониторинг': { color: '#E8A830', bg: 'rgba(232,168,48,0.14)' },
  'Обработка':  { color: '#4A90E8', bg: 'rgba(74,144,232,0.14)' },
  'Снижен':     { color: '#2DD4A8', bg: 'rgba(45,212,168,0.14)' },
  'Принят':     { color: '#3A4E62', bg: 'rgba(58,78,98,0.15)' },
};


const columns = [
  {
    key: 'id',
    label: 'ID',
    width: '80px',
    render: (r: RiskRow) => <span className="font-mono text-asvo-accent">{r.id}</span>,
  },
  {
    key: 'title',
    label: 'Название',
    render: (r: RiskRow) => <span className="text-asvo-text">{r.title}</span>,
  },
  {
    key: 'category',
    label: 'Категория',
    render: (r: RiskRow) => <span className="text-asvo-text-mid">{r.category}</span>,
  },
  {
    key: 'level',
    label: 'P\u00d7S=\u0423\u0440\u043e\u0432\u0435\u043d\u044c',
    align: 'center' as const,
    render: (r: RiskRow) => (
      <span className="text-asvo-text font-mono text-xs">{r.p}&times;{r.s}={r.level}</span>
    ),
  },
  {
    key: 'riskClass',
    label: 'Класс риска',
    align: 'center' as const,
    render: (r: RiskRow) => {
      const c = classColors[r.riskClass];
      return <Badge color={c?.color} bg={c?.bg}>{r.riskClass}</Badge>;
    },
  },
  {
    key: 'owner',
    label: 'Владелец',
    render: (r: RiskRow) => <span className="text-asvo-text-mid">{r.owner}</span>,
  },
  {
    key: 'status',
    label: 'Статус',
    align: 'center' as const,
    render: (r: RiskRow) => {
      const c = statusColors[r.status];
      return <Badge color={c?.color} bg={c?.bg}>{r.status}</Badge>;
    },
  },
];



const RisksPage: React.FC = () => {
  const [showMatrix, setShowMatrix] = useState(true);
  const [search, setSearch] = useState('');

  const filtered = RISKS.filter(
    (r) =>
      r.title.toLowerCase().includes(search.toLowerCase()) ||
      r.id.toLowerCase().includes(search.toLowerCase()),
  );

  
  const kpis = [
    { label: 'Всего рисков',         value: 34, color: '#A06AE8', icon: <Shield size={18} /> },
    { label: 'Критических',           value: 5,  color: '#F06060', icon: <AlertTriangle size={18} /> },
    { label: 'Высоких',               value: 12, color: '#E87040', icon: <TrendingUp size={18} /> },
    { label: 'Низких / Приемлемых',   value: 17, color: '#2DD4A8', icon: <Shield size={18} /> },
  ];

  return (
    <div className="min-h-screen bg-asvo-bg p-6 space-y-6">
      {}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-lg" style={{ background: 'rgba(160,106,232,0.12)' }}>
            <Shield className="text-[#A06AE8]" size={24} />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-asvo-text">Реестр рисков</h1>
            <p className="text-asvo-text-dim text-sm">ISO 14971 / ISO 13485 &sect;7.1 &mdash; Управление рисками</p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <ActionBtn icon={<Plus size={15} />}>Новый риск</ActionBtn>
          <ActionBtn variant="secondary" color="#A06AE8" icon={<Grid3X3 size={15} />} onClick={() => setShowMatrix((v) => !v)}>
            Матрица рисков
          </ActionBtn>
          <ActionBtn variant="secondary" icon={<Download size={15} />}>Экспорт</ActionBtn>
        </div>
      </div>

      {}
      <KpiRow items={kpis} />

      {}
      <div className="flex gap-3">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-asvo-text-dim" size={16} />
          <input
            type="text"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Поиск по ID или названию..."
            className="w-full pl-10 pr-4 py-2 bg-asvo-surface-2 border border-asvo-border rounded-lg text-asvo-text placeholder:text-asvo-text-dim focus:border-asvo-accent/50 focus:outline-none text-sm"
          />
        </div>
      </div>

      {}
      <DataTable columns={columns} data={filtered} />

      {}
      {showMatrix && (
        <>
          <SectionTitle>Матрица рисков 5 &times; 5</SectionTitle>

          <div className="bg-asvo-surface border border-asvo-border rounded-xl p-4 overflow-x-auto">
            <div className="grid grid-cols-6 gap-1.5 min-w-[480px]">
              {}
              <div className="min-h-[40px] rounded flex items-center justify-center text-[10px] font-bold text-asvo-text-dim uppercase">
                P \ S
              </div>
              {severityLabels.map((lbl) => (
                <div
                  key={lbl}
                  className="min-h-[40px] rounded flex items-center justify-center text-[10px] font-bold text-asvo-text-mid"
                >
                  {lbl}
                </div>
              ))}

              {}
              {[5, 4, 3, 2, 1].map((p) => (
                <React.Fragment key={p}>
                  {}
                  <div className="min-h-[40px] rounded flex items-center justify-center text-xs font-bold text-asvo-text-mid">
                    {p}
                  </div>
                  {[1, 2, 3, 4, 5].map((s) => {
                    const val = p * s;
                    const cnt = matrixCounts[p]?.[s] ?? 0;
                    return (
                      <div
                        key={`${p}-${s}`}
                        className={`min-h-[40px] rounded flex items-center justify-center text-xs font-bold ${cellColor(val)}`}
                      >
                        {cnt > 0 ? cnt : val}
                      </div>
                    );
                  })}
                </React.Fragment>
              ))}
            </div>
          </div>
        </>
      )}
    </div>
  );
};

export default RisksPage;

================================================================================
FILE: QMS-Client-main/src/pages/Quality/SuppliersPage.tsx
================================================================================

import React from 'react';
import {
  Truck, Plus, Search, Award, ShieldCheck, FileText,
  Clock, Headphones, BadgeCheck, Package,
} from 'lucide-react';
import KpiRow from '../../components/qms/KpiRow';
import ActionBtn from '../../components/qms/ActionBtn';
import Badge from '../../components/qms/Badge';
import DataTable from '../../components/qms/DataTable';
import SectionTitle from '../../components/qms/SectionTitle';
import ProgressBar from '../../components/qms/ProgressBar';


interface SupplierRow {
  id: string;
  name: string;
  category: string;
  rating: number;
  status: string;
  lastAudit: string;
  certs: string;
  [key: string]: unknown;
}


const SUPPLIERS: SupplierRow[] = [
  { id: 'SUP-001', name: 'ООО "Резонанс"',         category: 'Компоненты',  rating: 92, status: 'Одобрен',       lastAudit: '15.01.2026', certs: 'ISO 9001' },
  { id: 'SUP-003', name: 'АО "ПКБ Электро"',       category: 'PCB',         rating: 85, status: 'Одобрен',       lastAudit: '20.12.2025', certs: 'ISO 9001, IPC' },
  { id: 'SUP-005', name: 'ИП Волков',               category: 'Крепёж',      rating: 67, status: 'Условный',      lastAudit: '10.11.2025', certs: '\u2014' },
  { id: 'SUP-007', name: 'ООО "МетаПласт"',         category: 'Корпуса',     rating: 78, status: 'Одобрен',       lastAudit: '05.01.2026', certs: 'ISO 9001' },
  { id: 'SUP-012', name: 'Shenzhen Sensors Co.',     category: 'Датчики',     rating: 45, status: 'Заблокирован', lastAudit: '01.09.2025', certs: '\u2014' },
  { id: 'SUP-015', name: 'ООО "КалибрПро"',         category: 'Калибровка',  rating: 91, status: 'Одобрен',       lastAudit: '20.01.2026', certs: 'ISO 17025' },
];


const statusMap: Record<string, { color: string; bg: string }> = {
  'Одобрен':       { color: '#2DD4A8', bg: 'rgba(45,212,168,0.14)' },
  'Условный':      { color: '#E8A830', bg: 'rgba(232,168,48,0.14)' },
  'Заблокирован':  { color: '#F06060', bg: 'rgba(240,96,96,0.14)' },
  'Новый':         { color: '#4A90E8', bg: 'rgba(74,144,232,0.14)' },
};

const categoryMap: Record<string, { color: string; bg: string }> = {
  'Компоненты':  { color: '#4A90E8', bg: 'rgba(74,144,232,0.14)' },
  'PCB':         { color: '#A06AE8', bg: 'rgba(160,106,232,0.14)' },
  'Крепёж':      { color: '#E8A830', bg: 'rgba(232,168,48,0.14)' },
  'Корпуса':     { color: '#E87040', bg: 'rgba(232,112,64,0.14)' },
  'Датчики':     { color: '#F06060', bg: 'rgba(240,96,96,0.14)' },
  'Калибровка':  { color: '#2DD4A8', bg: 'rgba(45,212,168,0.14)' },
};


const barColor = (v: number) => {
  if (v >= 80) return 'green' as const;
  if (v >= 60) return 'amber' as const;
  return 'red' as const;
};


const columns = [
  {
    key: 'id',
    label: 'ID',
    width: '90px',
    render: (r: SupplierRow) => <span className="font-mono text-asvo-accent">{r.id}</span>,
  },
  {
    key: 'name',
    label: 'Название',
    render: (r: SupplierRow) => <span className="text-asvo-text">{r.name}</span>,
  },
  {
    key: 'category',
    label: 'Категория',
    align: 'center' as const,
    render: (r: SupplierRow) => {
      const c = categoryMap[r.category];
      return <Badge color={c?.color} bg={c?.bg}>{r.category}</Badge>;
    },
  },
  {
    key: 'rating',
    label: 'Рейтинг',
    width: '140px',
    render: (r: SupplierRow) => (
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <ProgressBar value={r.rating} color={barColor(r.rating)} />
          <span className="ml-2 text-asvo-text font-semibold whitespace-nowrap">{r.rating}%</span>
        </div>
      </div>
    ),
  },
  {
    key: 'status',
    label: 'Статус',
    align: 'center' as const,
    render: (r: SupplierRow) => {
      const c = statusMap[r.status];
      return <Badge color={c?.color} bg={c?.bg}>{r.status}</Badge>;
    },
  },
  {
    key: 'lastAudit',
    label: 'Последний аудит',
    render: (r: SupplierRow) => <span className="text-asvo-text-mid">{r.lastAudit}</span>,
  },
  {
    key: 'certs',
    label: 'Сертификаты',
    render: (r: SupplierRow) => <span className="text-asvo-text-mid">{r.certs}</span>,
  },
];


interface Criterion {
  label: string;
  weight: string;
  color: string;
  icon: React.ReactNode;
}

const CRITERIA: Criterion[] = [
  { label: 'Качество продукции', weight: '30%', color: '#2DD4A8', icon: <Award size={18} /> },
  { label: 'Сроки поставки',    weight: '20%', color: '#4A90E8', icon: <Clock size={18} /> },
  { label: 'Цена',              weight: '15%', color: '#E8A830', icon: <Package size={18} /> },
  { label: 'Документация',      weight: '15%', color: '#A06AE8', icon: <FileText size={18} /> },
  { label: 'Сервис',            weight: '10%', color: '#E87040', icon: <Headphones size={18} /> },
  { label: 'Сертификация',      weight: '10%', color: '#2DD4A8', icon: <BadgeCheck size={18} /> },
];



const SuppliersPage: React.FC = () => {
  const [search, setSearch] = React.useState('');

  const filtered = SUPPLIERS.filter(
    (r) =>
      r.name.toLowerCase().includes(search.toLowerCase()) ||
      r.id.toLowerCase().includes(search.toLowerCase()),
  );

  
  const kpis = [
    { label: 'Всего поставщиков', value: 28,     color: '#4A90E8', icon: <Truck size={18} /> },
    { label: 'Одобренных',        value: 22,     color: '#2DD4A8', icon: <ShieldCheck size={18} /> },
    { label: 'На аудите',         value: 3,      color: '#E8A830', icon: <Search size={18} /> },
    { label: 'Заблокированных',   value: 2,      color: '#F06060', icon: <Package size={18} /> },
    { label: 'Средний рейтинг',   value: '78%',  color: '#2DD4A8', icon: <Award size={18} /> },
  ];

  return (
    <div className="min-h-screen bg-asvo-bg p-6 space-y-6">
      {}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-lg" style={{ background: 'rgba(74,144,232,0.12)' }}>
            <Truck className="text-[#4A90E8]" size={24} />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-asvo-text">Поставщики</h1>
            <p className="text-asvo-text-dim text-sm">ISO 13485 &sect;7.4 &mdash; Управление поставщиками</p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <ActionBtn icon={<Plus size={15} />}>Новый поставщик</ActionBtn>
        </div>
      </div>

      {}
      <KpiRow items={kpis} />

      {}
      <div className="flex gap-3">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-asvo-text-dim" size={16} />
          <input
            type="text"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Поиск по ID или названию..."
            className="w-full pl-10 pr-4 py-2 bg-asvo-surface-2 border border-asvo-border rounded-lg text-asvo-text placeholder:text-asvo-text-dim focus:border-asvo-accent/50 focus:outline-none text-sm"
          />
        </div>
      </div>

      {}
      <DataTable columns={columns} data={filtered} />

      {}
      <SectionTitle>Критерии оценки поставщиков</SectionTitle>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        {CRITERIA.map((c) => (
          <div
            key={c.label}
            className="bg-asvo-surface-2 border border-asvo-border rounded-xl p-3 flex items-center gap-3"
          >
            <div
              className="p-2 rounded-lg"
              style={{ background: `${c.color}18` }}
            >
              <span style={{ color: c.color }}>{c.icon}</span>
            </div>
            <div className="flex-1 min-w-0">
              <div className="text-[13px] text-asvo-text font-medium truncate">{c.label}</div>
            </div>
            <div className="text-sm font-bold" style={{ color: c.color }}>{c.weight}</div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default SuppliersPage;

================================================================================
FILE: QMS-Client-main/src/pages/Quality/TrainingPage.tsx
================================================================================

import React, { useState } from "react";
import {
  GraduationCap,
  Plus,
  Download,
  Users,
  UserCheck,
  CalendarClock,
  AlertCircle,
  Grid3X3,
  Calendar,
  Award,
} from "lucide-react";
import KpiRow from "../../components/qms/KpiRow";
import ActionBtn from "../../components/qms/ActionBtn";
import Badge from "../../components/qms/Badge";
import DataTable from "../../components/qms/DataTable";
import Card from "../../components/qms/Card";
import SectionTitle from "../../components/qms/SectionTitle";





interface TrainingRow {
  [key: string]: unknown;
  employee: string;
  position: string;
  department: string;
  training: string;
  status: "passed" | "in_progress" | "assigned" | "overdue";
  date: string;
  certificate: string;
}

const TRAINING_DATA: TrainingRow[] = [
  { employee: "Костюков И.",   position: "Инженер по качеству", department: "ОТК",          training: "ISO 13485:2016 Основы",   status: "passed",      date: "15.01.2026", certificate: "Да" },
  { employee: "Холтобин А.",   position: "Начальник ОТК",       department: "ОТК",          training: "Внутренний аудитор ISO",  status: "passed",      date: "20.01.2026", certificate: "Да" },
  { employee: "Омельченко А.", position: "Монтажник",            department: "Производство", training: "IPC-A-610 Класс 3",      status: "in_progress", date: "10.02.2026", certificate: "\u2014" },
  { employee: "Яровой Е.",     position: "Инженер-технолог",     department: "Производство", training: "ESD-защита",              status: "assigned",    date: "15.02.2026", certificate: "\u2014" },
  { employee: "Чирков И.",     position: "Метролог",             department: "Метрология",   training: "Калибровка ISO 17025",   status: "overdue",     date: "01.02.2026", certificate: "\u2014" },
  { employee: "Петров Д.",     position: "Кладовщик",            department: "Склад",        training: "GMP для склада",          status: "assigned",    date: "20.02.2026", certificate: "\u2014" },
];



const STATUS_CFG: Record<TrainingRow["status"], { label: string; color: string; bg: string }> = {
  passed:      { label: "Пройдено",    color: "#2DD4A8", bg: "rgba(45,212,168,0.12)" },
  in_progress: { label: "В процессе",  color: "#4A90E8", bg: "rgba(74,144,232,0.12)" },
  assigned:    { label: "Назначено",   color: "#E8A830", bg: "rgba(232,168,48,0.12)" },
  overdue:     { label: "Просрочено",  color: "#F06060", bg: "rgba(240,96,96,0.12)" },
};



const SKILLS = ["ISO 13485", "IPC-A-610", "Пайка SMD", "ESD", "GMP"];

interface CompetencyRow {
  name: string;
  levels: number[]; 
}

const COMPETENCY: CompetencyRow[] = [
  { name: "Костюков И.",   levels: [3, 2, 1, 3, 2] },
  { name: "Холтобин А.",   levels: [3, 3, 2, 2, 3] },
  { name: "Омельченко А.", levels: [2, 3, 3, 2, 1] },
  { name: "Яровой Е.",     levels: [2, 1, 2, 3, 2] },
  { name: "Чирков И.",     levels: [1, 2, 3, 1, 1] },
];

const LEVEL_CFG: Record<number, { dots: string; cls: string }> = {
  3: { dots: "\u25CF\u25CF\u25CF", cls: "bg-[rgba(45,212,168,0.20)] text-[#2DD4A8]" },
  2: { dots: "\u25CF\u25CF",       cls: "bg-[rgba(74,144,232,0.20)] text-[#4A90E8]" },
  1: { dots: "\u25CF",             cls: "bg-[rgba(232,168,48,0.20)] text-[#E8A830]" },
  0: { dots: "\u2014",             cls: "bg-[rgba(240,96,96,0.20)] text-[#F06060]" },
};



type View = "table" | "matrix";





const TrainingPage: React.FC = () => {
  const [view, setView] = useState<View>("table");

  

  const columns = [
    {
      key: "employee",
      label: "Сотрудник",
      render: (r: TrainingRow) => (
        <span className="font-medium text-asvo-text">{r.employee}</span>
      ),
    },
    {
      key: "position",
      label: "Должность",
      render: (r: TrainingRow) => <span className="text-asvo-text-mid">{r.position}</span>,
    },
    {
      key: "department",
      label: "Отдел",
      render: (r: TrainingRow) => <span className="text-asvo-text-mid">{r.department}</span>,
    },
    {
      key: "training",
      label: "Обучение",
      render: (r: TrainingRow) => <span className="text-asvo-text">{r.training}</span>,
    },
    {
      key: "status",
      label: "Статус",
      align: "center" as const,
      render: (r: TrainingRow) => {
        const s = STATUS_CFG[r.status];
        return <Badge color={s.color} bg={s.bg}>{s.label}</Badge>;
      },
    },
    {
      key: "date",
      label: "Дата",
      render: (r: TrainingRow) => (
        <span className="flex items-center gap-1 text-asvo-text-mid">
          <Calendar size={12} className="text-asvo-text-dim" />
          {r.date}
        </span>
      ),
    },
    {
      key: "certificate",
      label: "Сертификат",
      align: "center" as const,
      render: (r: TrainingRow) =>
        r.certificate === "Да" ? (
          <span className="flex items-center justify-center gap-1 text-asvo-accent">
            <Award size={13} />
            Да
          </span>
        ) : (
          <span className="text-asvo-text-dim">{r.certificate}</span>
        ),
    },
  ];

  

  return (
    <div className="p-6 space-y-5 bg-asvo-bg min-h-screen">
      {}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2.5 bg-asvo-accent-dim rounded-xl">
            <GraduationCap size={22} className="text-asvo-accent" />
          </div>
          <div>
            <h1 className="text-xl font-bold text-asvo-text">Обучение персонала</h1>
            <p className="text-xs text-asvo-text-dim">ISO 13485 &sect;6.2 &mdash; Компетентность, обучение, осведомлённость</p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <ActionBtn variant="primary" icon={<Plus size={15} />}>+ Назначить обучение</ActionBtn>
          <ActionBtn
            variant="secondary"
            color="#A06AE8"
            icon={<Grid3X3 size={15} />}
            onClick={() => setView(view === "matrix" ? "table" : "matrix")}
          >
            Матрица компетенций
          </ActionBtn>
          <ActionBtn variant="secondary" icon={<Download size={15} />}>Экспорт</ActionBtn>
        </div>
      </div>

      {}
      <KpiRow
        items={[
          { label: "Всего сотрудников", value: 42, icon: <Users size={18} />,         color: "#4A90E8" },
          { label: "Обучено",           value: 38, icon: <UserCheck size={18} />,      color: "#2DD4A8" },
          { label: "План обучения",     value: 15, icon: <CalendarClock size={18} />,  color: "#E8A830" },
          { label: "Просрочено",        value: 2,  icon: <AlertCircle size={18} />,    color: "#F06060" },
        ]}
      />

      {}
      {view === "table" && <DataTable columns={columns} data={TRAINING_DATA} />}

      {}
      {view === "matrix" && (
        <Card>
          <SectionTitle>Матрица компетенций</SectionTitle>

          <div className="overflow-x-auto">
            <table className="w-full border-collapse">
              <thead>
                <tr>
                  <th className="text-left text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider px-3 py-2.5">
                    Сотрудник
                  </th>
                  {SKILLS.map((sk) => (
                    <th key={sk} className="text-center text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider px-3 py-2.5">
                      {sk}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {COMPETENCY.map((row) => (
                  <tr key={row.name} className="border-t border-asvo-border/40">
                    <td className="px-3 py-2.5 text-[13px] font-medium text-asvo-text whitespace-nowrap">
                      {row.name}
                    </td>
                    {row.levels.map((lvl, ci) => {
                      const cfg = LEVEL_CFG[lvl];
                      return (
                        <td key={ci} className="px-3 py-2.5 text-center">
                          <span
                            className={`inline-flex items-center justify-center rounded-lg text-[12px] font-bold px-2.5 py-1 min-w-[44px] ${cfg.cls}`}
                          >
                            {cfg.dots}
                          </span>
                        </td>
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {}
          <div className="flex items-center gap-5 mt-4 text-[11px] text-asvo-text-dim">
            <span className="flex items-center gap-1.5">
              <span className="inline-block w-3 h-3 rounded-sm bg-[rgba(45,212,168,0.20)]" /> 3 &mdash; Эксперт
            </span>
            <span className="flex items-center gap-1.5">
              <span className="inline-block w-3 h-3 rounded-sm bg-[rgba(74,144,232,0.20)]" /> 2 &mdash; Специалист
            </span>
            <span className="flex items-center gap-1.5">
              <span className="inline-block w-3 h-3 rounded-sm bg-[rgba(232,168,48,0.20)]" /> 1 &mdash; Базовый
            </span>
            <span className="flex items-center gap-1.5">
              <span className="inline-block w-3 h-3 rounded-sm bg-[rgba(240,96,96,0.20)]" /> 0 &mdash; Отсутствует
            </span>
          </div>
        </Card>
      )}
    </div>
  );
};

export default TrainingPage;

================================================================================
FILE: QMS-Client-main/src/pages/StartPage/StartPage.tsx
================================================================================

import React, { useState, useEffect, useContext } from "react";
import { Context } from "src/main";
import { observer } from "mobx-react-lite";
import { useNavigate } from "react-router-dom";
import clsx from "clsx";
import {
  Box, Activity, ArrowRight, Clock,
  Users, Settings,
  ClipboardList,
  Monitor, Laptop, RefreshCw, AlertTriangle, CheckCircle2, Circle
} from "lucide-react";
import {
  WAREHOUSE_ROUTE,
  TASKS_ROUTE,
  ADMIN_ROUTE,
} from "src/utils/consts";
import { fetchPC, fetchSession, fetchUsers } from "src/api/userApi";


const UPDATES = [
    { ver: "3.00", date: "10.02", desc: "QMS-ядро: документы, риски, NC/CAPA." },
    { ver: "2.04", date: "21.01", desc: "Виджет онлайн пользователей." },
];


const HeroCard = ({ title, sub, icon: Icon, to }: any) => {
    const navigate = useNavigate();
    return (
        <div
            onClick={() => navigate(to)}
            className="group relative col-span-1 md:col-span-2 lg:col-span-2 row-span-2 cursor-pointer overflow-hidden rounded-[2.5rem] bg-slate-800/60 border border-slate-700 p-8 text-white transition-all duration-500 hover:-translate-y-1 hover:border-teal-500/50 hover:shadow-lg hover:shadow-teal-500/10"
        >
            <div className="absolute -right-20 -top-20 h-64 w-64 rounded-full bg-teal-500 opacity-5 blur-3xl transition-transform duration-700 group-hover:scale-150"></div>
            <div className="absolute bottom-0 left-0 h-40 w-full bg-gradient-to-t from-black/10 to-transparent"></div>

            <div className="relative z-10 flex h-full flex-col justify-between">
                <div className="flex items-start justify-between">
                    <div className="rounded-2xl bg-teal-500/10 p-4 border border-teal-500/30 transition-transform duration-300 group-hover:rotate-12">
                        <Icon size={32} className="text-teal-400" />
                    </div>
                    <div className="rounded-full border border-teal-500/30 bg-teal-500/10 px-3 py-1 text-xs font-bold uppercase tracking-wider text-teal-400">
                        QMS
                    </div>
                </div>

                <div>
                    <h2 className="text-3xl font-black leading-tight tracking-tight md:text-4xl text-slate-100">{title}</h2>
                    <p className="mt-2 max-w-sm text-sm font-medium text-slate-400">{sub}</p>
                    <div className="mt-6 flex items-center gap-2 font-bold text-teal-400 opacity-0 transition-all duration-300 group-hover:translate-x-2 group-hover:opacity-100">
                        Перейти <ArrowRight size={18} />
                    </div>
                </div>
            </div>
        </div>
    );
};


const InfoTile = ({ title, sub, icon: Icon, to }: any) => {
    const navigate = useNavigate();
    return (
        <div
            onClick={() => navigate(to)}
            className="group relative flex cursor-pointer flex-col justify-between overflow-hidden rounded-[2rem] border border-slate-700 bg-slate-800/60 p-6 transition-all duration-300 hover:-translate-y-1 hover:border-teal-500/50 hover:shadow-lg hover:shadow-teal-500/10 col-span-1"
        >
            <div className="absolute -right-4 -top-4 h-24 w-24 rounded-full bg-teal-500 opacity-5 transition-transform duration-500 group-hover:scale-150"></div>
            <div className="flex items-start justify-between">
                <div className="rounded-2xl p-3 bg-teal-500/10 border border-teal-500/30 transition-transform duration-300 group-hover:scale-110">
                    <Icon size={24} className="text-teal-400" strokeWidth={2} />
                </div>
            </div>
            <div className="mt-4">
                <h3 className="text-lg font-bold text-slate-100 transition-colors group-hover:text-teal-400">{title}</h3>
                <p className="mt-1 text-xs font-medium text-slate-500">{sub}</p>
            </div>
        </div>
    );
};


const SystemWidget = () => (
    <div className="col-span-1 md:col-span-1 lg:row-span-2 flex flex-col gap-4">
        <div className="flex-1 rounded-[2rem] border border-slate-700 bg-slate-800/60 p-6 relative overflow-hidden">
             <div className="mb-4 flex items-center justify-between">
                <h3 className="font-bold text-slate-300 flex items-center gap-2">
                    <Activity size={18} className="text-emerald-500"/> Статус
                </h3>
                <span className="flex h-2.5 w-2.5">
                  <span className="absolute inline-flex h-2.5 w-2.5 animate-ping rounded-full bg-emerald-400 opacity-75"></span>
                  <span className="relative inline-flex h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
                </span>
             </div>
             <div className="space-y-4">
                 <div className="flex items-center justify-between rounded-xl bg-slate-900/50 p-3">
                     <div className="flex items-center gap-3">
                         <div className="text-xs font-bold text-slate-400">Core API</div>
                     </div>
                     <span className="text-[10px] font-bold text-emerald-400">ONLINE</span>
                 </div>
             </div>
        </div>

        <div className="flex-1 rounded-[2rem] border border-slate-700 bg-slate-800/60 p-6 text-slate-300 relative overflow-hidden group">
            <div className="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>
            <h3 className="mb-4 flex items-center gap-2 text-sm font-bold text-slate-200 uppercase tracking-wider">
                Updates
            </h3>
            <div className="space-y-3">
                {UPDATES.map((u, i) => (
                    <div key={i} className="flex items-start gap-3 text-xs">
                        <span className="font-mono text-teal-400 min-w-[32px]">{u.ver}</span>
                        <p className="leading-snug text-slate-400">{u.desc}</p>
                    </div>
                ))}
            </div>
        </div>
    </div>
);


interface OnlineUser {
  id: number;
  name: string;
  surname: string;
  role: string;
  pcName: string | null;
  isPersonalLaptop: boolean;
}

const OnlineUsersWidget = () => {
    const [onlineUsers, setOnlineUsers] = useState<OnlineUser[]>([]);
    const [loading, setLoading] = useState(true);
    const [lastUpdate, setLastUpdate] = useState<Date>(new Date());

    const loadOnlineUsers = async () => {
        try {
            setLoading(true);
            const [sessions, users, pcs] = await Promise.all([
                fetchSession(),
                fetchUsers(),
                fetchPC().catch(() => [])
            ]);

            const activeSessions = sessions.filter((s: any) => s.online === true);

            const online: OnlineUser[] = activeSessions.map((session: any) => {
                const user = users.find((u: any) => u.id === session.userId);
                const pc = pcs.find((p: any) => p.id === session.PCId);
                return {
                    id: user?.id || 0,
                    name: user?.name || "Неизвестный",
                    surname: user?.surname || "",
                    role: user?.role || "USER",
                    pcName: pc?.pc_name || null,
                    isPersonalLaptop: session.PCId === null
                };
            });

            const uniqueOnline = online.filter((user, index, self) =>
                index === self.findIndex(u => u.id === user.id)
            );

            setOnlineUsers(uniqueOnline);
            setLastUpdate(new Date());
        } catch (e) {
            console.error("Ошибка загрузки онлайн пользователей:", e);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        loadOnlineUsers();
        const interval = setInterval(loadOnlineUsers, 30000);
        return () => clearInterval(interval);
    }, []);

    const getRoleLabel = (role: string) => {
        const roles: Record<string, string> = {
            SUPER_ADMIN: "Админ", ADMIN: "Админ",
            WAREHOUSE_MASTER: "Склад", QC_ENGINEER: "ОТК",
            USER: "User"
        };
        return roles[role] || role;
    };

    const canReboot = onlineUsers.length === 0;

    return (
        <div className="col-span-1 md:col-span-2 row-span-2 rounded-[2rem] border border-slate-700 bg-slate-800/60 overflow-hidden flex flex-col">
            <div className="p-5 border-b border-slate-700 flex-shrink-0">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className={clsx(
                            "p-2.5 rounded-xl",
                            onlineUsers.length > 0 ? "bg-teal-500/10 border border-teal-500/30" : "bg-slate-700/50"
                        )}>
                            <Users size={20} className={onlineUsers.length > 0 ? "text-teal-400" : "text-slate-500"} />
                        </div>
                        <div>
                            <h3 className="font-bold text-slate-100">Сейчас в системе</h3>
                            <p className="text-xs text-slate-500">
                                Обн: {lastUpdate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
                            </p>
                        </div>
                    </div>

                    <div className="flex items-center gap-2">
                        <div className={clsx(
                            "flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold",
                            canReboot
                                ? "bg-emerald-500/10 text-emerald-400 border border-emerald-500/30"
                                : "bg-amber-500/10 text-amber-400 border border-amber-500/30"
                        )}>
                            {canReboot ? (
                                <><CheckCircle2 size={12} /> OK</>
                            ) : (
                                <><AlertTriangle size={12} /> {onlineUsers.length}</>
                            )}
                        </div>
                        <button
                            onClick={loadOnlineUsers}
                            disabled={loading}
                            className="p-1.5 rounded-lg hover:bg-slate-700 transition-colors"
                        >
                            <RefreshCw size={14} className={clsx("text-slate-400", loading && "animate-spin")} />
                        </button>
                    </div>
                </div>
            </div>

            <div className="flex-1 overflow-y-auto p-4">
                {loading && onlineUsers.length === 0 ? (
                    <div className="flex items-center justify-center h-full">
                        <RefreshCw size={20} className="text-slate-600 animate-spin" />
                    </div>
                ) : onlineUsers.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full text-center">
                        <div className="w-14 h-14 mb-3 rounded-full bg-slate-700/50 flex items-center justify-center">
                            <Users size={24} className="text-slate-500" />
                        </div>
                        <p className="font-medium text-slate-300 text-sm">Никого нет</p>
                        <p className="text-xs text-slate-500 mt-1">Можно ребутать сервер</p>
                    </div>
                ) : (
                    <div className="space-y-2">
                        {onlineUsers.map((user) => (
                            <div
                                key={user.id}
                                className="flex items-center justify-between p-2.5 rounded-xl bg-slate-900/50 hover:bg-slate-700/50 transition-colors"
                            >
                                <div className="flex items-center gap-2.5">
                                    <div className="relative">
                                        <div className="w-8 h-8 rounded-full bg-teal-500/20 border border-teal-500/30 flex items-center justify-center text-teal-400 text-xs font-bold">
                                            {user.name[0]}{user.surname?.[0] || ""}
                                        </div>
                                        <span className="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-emerald-500 border-2 border-slate-800 rounded-full"></span>
                                    </div>
                                    <div>
                                        <div className="font-semibold text-slate-200 text-sm leading-tight">
                                            {user.name} {user.surname?.[0] ? user.surname[0] + "." : ""}
                                        </div>
                                        <span className="text-[10px] font-medium text-slate-500">
                                            {getRoleLabel(user.role)}
                                        </span>
                                    </div>
                                </div>
                                <div className="flex items-center gap-1 text-[10px] text-slate-500">
                                    {user.isPersonalLaptop ? (
                                        <Laptop size={12} />
                                    ) : (
                                        <Monitor size={12} />
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {onlineUsers.length > 0 && (
                <div className="px-5 py-2.5 bg-slate-900/50 border-t border-slate-700 flex-shrink-0">
                    <div className="flex items-center justify-between text-xs">
                        <span className="text-slate-400">
                            Онлайн: <span className="font-bold text-emerald-400">{onlineUsers.length}</span>
                        </span>
                        <div className="flex items-center gap-1 text-slate-500">
                            <Circle size={6} className="fill-emerald-500 text-emerald-500" />
                            <span>Live</span>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};


export const StartPage: React.FC = observer(() => {
    const { user } = useContext(Context)!;
    const [greeting, setGreeting] = useState("");
    const [currentTime, setCurrentTime] = useState(new Date());

    useEffect(() => {
        const updateTime = () => {
            const now = new Date();
            setCurrentTime(now);
            const hour = now.getHours();
            if (hour < 12) setGreeting("Доброе утро");
            else if (hour < 18) setGreeting("Добрый день");
            else setGreeting("Добрый вечер");
        };
        updateTime();
        const t = setInterval(updateTime, 1000);
        return () => clearInterval(t);
    }, []);

    const today = currentTime.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
    const isAdmin = user.can('admin.access') || user.can('users.manage');

    return (
        <div className="min-h-screen bg-slate-900 p-6 lg:p-10 font-sans text-slate-100 pb-20">
            <div className="max-w-[1400px] mx-auto animate-fade-in-up">

                <div className="mb-10 flex flex-col justify-between gap-4 md:flex-row md:items-end">
                    <div>
                        <div className="mb-2 flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-slate-500">
                            <Clock size={14} className="text-teal-400"/>
                            {today}
                        </div>
                        <h1 className="text-4xl font-black tracking-tight text-slate-100 md:text-5xl">
                            {greeting}, <span className="text-teal-400">{user.user?.name || "Коллега"}</span>.
                        </h1>
                        <p className="mt-2 text-lg font-medium text-slate-400">
                            Добро пожаловать в систему менеджмента качества.
                        </p>
                    </div>

                    <div className="hidden md:block">
                        <div className="flex items-center gap-3 rounded-2xl bg-slate-800 px-5 py-3 border border-teal-500/30">
                            <div className="h-10 w-10 rounded-full bg-teal-500/10 border border-teal-500/30 flex items-center justify-center text-teal-400 font-bold">
                                {user.user?.name?.[0] || "U"}
                            </div>
                            <div>
                                <div className="text-xs font-bold uppercase text-slate-500">Ваша роль</div>
                                <div className="font-bold text-teal-400">{user.user?.role || "Сотрудник"}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4 auto-rows-auto">

                    <HeroCard
                        title="Задачи"
                        sub="Управление рабочими задачами и проектами"
                        icon={ClipboardList}
                        to={TASKS_ROUTE}
                    />

                    <InfoTile title="Склад" sub="Остатки и движение" icon={Box} to={WAREHOUSE_ROUTE} />

                    {isAdmin && (
                        <InfoTile title="Админка" sub="Настройки системы" icon={Settings} to={ADMIN_ROUTE} />
                    )}

                    <SystemWidget />

                    {isAdmin && <OnlineUsersWidget />}
                </div>
            </div>
        </div>
    );
});

================================================================================
FILE: QMS-Client-main/src/pages/Tasks/ProjectsList.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { Plus, Trash2, FolderOpen } from "lucide-react";
import {
  fetchProjects,
  createProject,
  deleteProject,
  ProjectModel,
} from "src/api/projectsApi";
import { Modal } from "src/components/Modal/Modal";

const ProjectsList: React.FC = () => {
  const [projects, setProjects] = useState<ProjectModel[]>([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [form, setForm] = useState({ title: "", description: "" });

  const load = async () => {
    const data = await fetchProjects();
    setProjects(data);
  };

  useEffect(() => {
    load();
  }, []);

  const handleCreate = async () => {
    if (!form.title) return alert("Введите название");
    await createProject(form.title, form.description);
    setIsModalOpen(false);
    setForm({ title: "", description: "" });
    load();
  };

  const handleDelete = async (id: number) => {
    if (window.confirm("Удалить проект?")) {
      await deleteProject(id);
      load();
    }
  };

  return (
    <div className="animate-fade-in">
      <div className="flex justify-end mb-5">
        <button
          onClick={() => setIsModalOpen(true)}
          className="flex items-center gap-2 bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-500 hover:to-teal-400 text-white px-5 py-2.5 rounded-xl font-semibold text-sm transition-all shadow-lg shadow-teal-500/20"
        >
          <Plus size={18} /> Новый проект
        </button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
        {projects.map((p) => (
          <div
            key={p.id}
            className="bg-slate-800/50 p-5 rounded-2xl border border-slate-700/40 hover:border-slate-600/60 hover:bg-slate-800/70 hover:shadow-lg hover:shadow-black/20 transition-all duration-200 relative group"
          >
            <div className="flex justify-between items-start mb-3">
              <div className="p-2.5 bg-indigo-500/10 text-indigo-400 rounded-xl border border-indigo-500/15">
                <FolderOpen size={22} />
              </div>
              <button
                onClick={() => handleDelete(p.id)}
                className="text-slate-600 hover:text-red-400 transition opacity-0 group-hover:opacity-100 p-1"
              >
                <Trash2 size={16} />
              </button>
            </div>
            <h3 className="text-base font-bold text-slate-100 mb-1">
              {p.title}
            </h3>
            <p className="text-sm text-slate-500 mb-4 line-clamp-2 h-10 leading-relaxed">
              {p.description || "Нет описания"}
            </p>

            <div className="flex justify-between items-center text-[11px] text-slate-500 border-t border-slate-700/40 pt-3">
              <span>Создал: {p.author?.surname || "Admin"}</span>
              <span>{new Date(p.createdAt).toLocaleDateString("ru")}</span>
            </div>
          </div>
        ))}
      </div>

      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)}>
        <div className="p-6 bg-slate-800 rounded-2xl">
          <h2 className="text-lg font-bold text-slate-100 mb-5">
            Создать проект
          </h2>
          <div className="space-y-3">
            <div>
              <label className="block text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1.5">
                Название
              </label>
              <input
                className="w-full px-3 py-2.5 bg-slate-900/80 border border-slate-600/50 rounded-xl text-slate-200 text-sm placeholder:text-slate-500 focus:border-teal-500/50 focus:outline-none focus:ring-1 focus:ring-teal-500/20 transition"
                placeholder="Напр. Дрон-разведчик"
                value={form.title}
                onChange={(e) => setForm({ ...form, title: e.target.value })}
              />
            </div>
            <div>
              <label className="block text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-1.5">
                Описание
              </label>
              <textarea
                className="w-full px-3 py-2.5 bg-slate-900/80 border border-slate-600/50 rounded-xl text-slate-200 text-sm placeholder:text-slate-500 focus:border-teal-500/50 focus:outline-none focus:ring-1 focus:ring-teal-500/20 transition resize-none"
                placeholder="Что входит в проект..."
                rows={3}
                value={form.description}
                onChange={(e) =>
                  setForm({ ...form, description: e.target.value })
                }
              />
            </div>
            <button
              onClick={handleCreate}
              className="w-full mt-2 py-3 bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-500 hover:to-teal-400 text-white font-semibold rounded-xl transition-all text-sm shadow-lg shadow-teal-500/20"
            >
              Создать
            </button>
          </div>
        </div>
      </Modal>
    </div>
  );
};

export default ProjectsList;

================================================================================
FILE: QMS-Client-main/src/pages/Tasks/TasksList.tsx
================================================================================

import React, { useEffect, useState, useCallback, DragEvent, useMemo } from "react";
import {
  ProductionTask,
  TaskDetailResponse,
  fetchTasks,
  fetchTaskById,
  createTask,
  updateTask,
  updateTaskStatus,
} from "src/api/tasksApi";
import { fetchProjects, ProjectModel } from "src/api/projectsApi";
import { fetchUsers } from "src/api/userApi";
import { userGetModel } from "src/types/UserModel";
import {
  Plus, Loader2, Edit3, Save, X, Clock,
  CheckCircle2, Circle, Calendar, Search,
  AlertTriangle, Eye, Archive, Filter, MapPin, ChevronRight,
  LayoutGrid, List,
} from "lucide-react";
import { Modal } from "src/components/Modal/Modal";
import Badge from "src/components/qms/Badge";
import StatusDot from "src/components/qms/StatusDot";
import ProgressBar from "src/components/qms/ProgressBar";
import Avatar from "src/components/qms/Avatar";



interface TaskStats { total: number; done: number; inWork: number; onStock: number; }
interface ExtendedTask extends ProductionTask { stats?: TaskStats; }



type StatusDotColor = "blue" | "amber" | "purple" | "accent" | "grey";
type ProgressBarColor = "blue" | "amber" | "purple" | "accent" | "green";

interface ColumnDef {
  key: string;
  label: string;
  icon: React.FC<{ size?: number; className?: string }>;
  dotColor: StatusDotColor;
  progressColor: ProgressBarColor;
  textCls: string;
  badgeCls: string;
  borderTopCls: string;
  gradientCls: string;
  dragBorderCls: string;
}

const COLUMNS: ColumnDef[] = [
  {
    key: "NEW", label: "Новые", icon: Circle, dotColor: "blue", progressColor: "blue",
    textCls: "text-[#4A90E8]", badgeCls: "bg-[#4A90E8]/15 text-[#4A90E8]",
    borderTopCls: "border-t-2 border-[#4A90E8]/40",
    gradientCls: "bg-gradient-to-br from-[#4A90E8]/[0.04] to-transparent",
    dragBorderCls: "border-[#4A90E8]",
  },
  {
    key: "IN_PROGRESS", label: "В работе", icon: Clock, dotColor: "amber", progressColor: "amber",
    textCls: "text-[#E8A830]", badgeCls: "bg-[#E8A830]/15 text-[#E8A830]",
    borderTopCls: "border-t-2 border-[#E8A830]/40",
    gradientCls: "bg-gradient-to-br from-[#E8A830]/[0.04] to-transparent",
    dragBorderCls: "border-[#E8A830]",
  },
  {
    key: "REVIEW", label: "На проверке", icon: Eye, dotColor: "purple", progressColor: "purple",
    textCls: "text-[#A06AE8]", badgeCls: "bg-[#A06AE8]/15 text-[#A06AE8]",
    borderTopCls: "border-t-2 border-[#A06AE8]/40",
    gradientCls: "bg-gradient-to-br from-[#A06AE8]/[0.04] to-transparent",
    dragBorderCls: "border-[#A06AE8]",
  },
  {
    key: "DONE", label: "Готово", icon: CheckCircle2, dotColor: "accent", progressColor: "accent",
    textCls: "text-[#2DD4A8]", badgeCls: "bg-[#2DD4A8]/15 text-[#2DD4A8]",
    borderTopCls: "border-t-2 border-[#2DD4A8]/40",
    gradientCls: "bg-gradient-to-br from-[#2DD4A8]/[0.04] to-transparent",
    dragBorderCls: "border-[#2DD4A8]",
  },
  {
    key: "CLOSED", label: "Закрыто", icon: Archive, dotColor: "grey", progressColor: "green",
    textCls: "text-[#3A4E62]", badgeCls: "bg-[#3A4E62]/15 text-[#8899AB]",
    borderTopCls: "border-t-2 border-[#3A4E62]/40",
    gradientCls: "bg-gradient-to-br from-[#3A4E62]/[0.04] to-transparent",
    dragBorderCls: "border-[#3A4E62]",
  },
];



const SOURCE_FILTERS = [
  { key: "ALL",       label: "Все",        color: "#2DD4A8" },
  { key: "NC",        label: "NC",         color: "#F06060" },
  { key: "CAPA",      label: "CAPA",       color: "#E8A830" },
  { key: "RISK",      label: "Риск",       color: "#A06AE8" },
  { key: "AUDIT",     label: "Аудит",      color: "#4A90E8" },
  { key: "TRAINING",  label: "Обучение",   color: "#36B5E0" },
  { key: "PRODUCT",   label: "Изделие",    color: "#E06890" },
  { key: "COMPONENT", label: "Компонент",  color: "#3A4E62" },
];

type BadgeVariant = "nc" | "capa" | "risk" | "audit" | "training" | "sop" | "closed" | "product" | "component";

const originToBadge: Record<string, BadgeVariant> = {
  NC: "nc", CAPA: "capa", RISK: "risk", AUDIT: "audit",
  TRAINING: "training", PRODUCT: "product", COMPONENT: "component",
};



interface PriorityConfig {
  icon: string;
  color: string;
  borderCls: string;
  title: string;
}

const PRIORITY_MAP: Record<number, PriorityConfig> = {
  3: { icon: "▲▲", color: "text-[#F06060]",  borderCls: "border-l-[3px] border-l-[#F06060]/60",  title: "Критический" },
  2: { icon: "●",  color: "text-[#E8A830]",  borderCls: "border-l-[3px] border-l-[#E8A830]/60",  title: "Средний" },
  1: { icon: "▼",  color: "text-[#4A90E8]",  borderCls: "border-l-[3px] border-l-[#4A90E8]/60",  title: "Низкий" },
};

const getPriority = (p: number | null | undefined): PriorityConfig => {
  return PRIORITY_MAP[p || 1] || PRIORITY_MAP[1];
};



const isOverdue = (d?: string | null) => {
  if (!d) return false;
  return new Date(d) < new Date(new Date().toISOString().slice(0, 10));
};

const formatDate = (d: string) => {
  return new Date(d).toLocaleDateString("ru", { day: "numeric", month: "short" });
};



const TasksList: React.FC = () => {
  const [tasks, setTasks] = useState<ExtendedTask[]>([]);
  const [loading, setLoading] = useState(false);
  const [users, setUsers] = useState<userGetModel[]>([]);
  const [projects, setProjects] = useState<ProjectModel[]>([]);

  
  const [search, setSearch] = useState("");
  const [sourceFilter, setSourceFilter] = useState("ALL");
  const [assigneeFilter, setAssigneeFilter] = useState<string>("");
  const [searchFocused, setSearchFocused] = useState(false);

  
  const [viewMode, setViewMode] = useState<"board" | "list">("board");

  
  const [dragOverCol, setDragOverCol] = useState<string | null>(null);
  const [draggingId, setDraggingId] = useState<number | null>(null);

  
  const [drawerTask, setDrawerTask] = useState<TaskDetailResponse | null>(null);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editForm, setEditForm] = useState<any>({});

  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [createForm, setCreateForm] = useState<any>({ priority: "1", targetQty: "" });

  
  const loadData = useCallback(async () => {
    setLoading(true);
    try {
      const res = await fetchTasks({ page: 1, limit: 500 });
      setTasks(res.rows as unknown as ExtendedTask[]);
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadData();
    fetchUsers().then(setUsers);
    fetchProjects().then(setProjects);
  }, [loadData]);

  
  const openDrawer = async (id: number) => {
    setIsEditing(false);
    try {
      const res = await fetchTaskById(id);
      setDrawerTask(res);
      setDrawerOpen(true);
    } catch (e) { console.error(e); }
  };

  const closeDrawer = () => { setDrawerOpen(false); setIsEditing(false); };

  const startEditing = () => {
    if (!drawerTask) return;
    setEditForm({
      priority: drawerTask.task.priority,
      dueDate: drawerTask.task.dueDate,
      responsibleId: drawerTask.task.responsibleId,
      projectId: drawerTask.task.projectId,
      status: drawerTask.task.status,
      comment: drawerTask.task.comment || "",
    });
    setIsEditing(true);
  };

  const saveChanges = async () => {
    if (!drawerTask) return;
    try {
      await updateTask(drawerTask.task.id, editForm);
      setIsEditing(false);
      openDrawer(drawerTask.task.id);
      loadData();
    } catch (e) { console.error(e); }
  };

  
  const onDragStart = (e: DragEvent, task: ExtendedTask) => {
    e.dataTransfer.setData("taskId", String(task.id));
    e.dataTransfer.setData("fromStatus", task.status);
    e.dataTransfer.effectAllowed = "move";
    setDraggingId(task.id);
  };
  const onDragEnd = () => { setDraggingId(null); setDragOverCol(null); };
  const onDragOver = (e: DragEvent, colKey: string) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; setDragOverCol(colKey); };
  const onDragLeave = () => setDragOverCol(null);

  const onDrop = async (e: DragEvent, toStatus: string) => {
    e.preventDefault();
    setDragOverCol(null);
    setDraggingId(null);

    const taskId = parseInt(e.dataTransfer.getData("taskId"));
    const fromStatus = e.dataTransfer.getData("fromStatus");
    if (isNaN(taskId) || fromStatus === toStatus) return;

    setTasks(prev => prev.map(t => t.id === taskId ? { ...t, status: toStatus } : t));
    try {
      await updateTaskStatus(taskId, toStatus);
      if (drawerTask?.task.id === taskId) openDrawer(taskId);
    } catch {
      loadData();
    }
  };

  
  const filtered = useMemo(() => {
    let list = tasks;
    if (sourceFilter !== "ALL") list = list.filter(t => t.originType === sourceFilter);
    if (assigneeFilter) list = list.filter(t => String(t.responsibleId) === assigneeFilter);
    if (search.trim()) {
      const q = search.toLowerCase();
      list = list.filter(t =>
        t.title.toLowerCase().includes(q) ||
        t.comment?.toLowerCase().includes(q) ||
        t.originType?.toLowerCase().includes(q)
      );
    }
    return list;
  }, [tasks, sourceFilter, assigneeFilter, search]);

  const grouped = useMemo(() => {
    const g: Record<string, ExtendedTask[]> = {};
    for (const col of COLUMNS) g[col.key] = [];
    for (const t of filtered) {
      const key = t.status in g ? t.status : "NEW";
      g[key].push(t);
    }
    return g;
  }, [filtered]);

  
  return (
    <div className="space-y-4">

      {}
      <div className="flex flex-col gap-3">
        {}
        <div className="flex items-center gap-3">
          <span className="text-xs text-asvo-text-dim">
            Всего: <b className="text-asvo-text">{tasks.length}</b>
          </span>
          {filtered.length !== tasks.length && (
            <span className="text-xs text-asvo-text-dim">
              Найдено: <b className="text-asvo-accent">{filtered.length}</b>
            </span>
          )}

          <div className="flex items-center gap-2 ml-auto">
            {}
            <div className="relative">
              <Search size={13} className="absolute left-3 top-1/2 -translate-y-1/2 text-asvo-text-dim" />
              <input
                type="text"
                value={search}
                onChange={e => setSearch(e.target.value)}
                onFocus={() => setSearchFocused(true)}
                onBlur={() => setSearchFocused(false)}
                placeholder="Поиск..."
                className={`pl-8 pr-3 py-1.5 bg-transparent border border-asvo-border rounded-lg text-xs text-asvo-text placeholder:text-asvo-text-dim focus:bg-asvo-surface focus:border-asvo-border-lt focus:outline-none transition-all ${
                  searchFocused ? "w-60" : "w-[180px]"
                }`}
              />
            </div>

            {}
            <select
              value={assigneeFilter}
              onChange={e => setAssigneeFilter(e.target.value)}
              className="px-2 py-1.5 bg-asvo-surface border border-asvo-border rounded-lg text-[13px] text-asvo-text-mid focus:border-asvo-border-lt focus:outline-none min-w-[140px]"
            >
              <option value="">Все исполнители</option>
              {users.map(u => <option key={u.id} value={u.id}>{u.surname} {u.name}</option>)}
            </select>

            {}
            <div className="flex bg-asvo-surface border border-asvo-border rounded-lg overflow-hidden">
              <button
                onClick={() => setViewMode("board")}
                className={`p-1.5 transition-all ${viewMode === "board" ? "bg-asvo-accent text-asvo-bg" : "text-asvo-text-mid hover:text-asvo-text"}`}
                title="Доска"
              >
                <LayoutGrid size={14} />
              </button>
              <button
                onClick={() => setViewMode("list")}
                className={`p-1.5 transition-all ${viewMode === "list" ? "bg-asvo-accent text-asvo-bg" : "text-asvo-text-mid hover:text-asvo-text"}`}
                title="Список"
              >
                <List size={14} />
              </button>
            </div>

            {}
            <button
              onClick={() => setIsModalOpen(true)}
              className="flex items-center gap-1.5 px-3.5 py-1.5 bg-gradient-to-br from-asvo-accent to-asvo-accent/80 text-asvo-bg font-bold rounded-lg text-xs transition-all shadow-[0_2px_12px_rgba(45,212,168,0.3)] hover:shadow-[0_4px_16px_rgba(45,212,168,0.4)]"
            >
              <Plus size={14} /> Задача
            </button>
          </div>
        </div>

        {}
        <div className="flex items-center gap-1.5 flex-wrap">
          <Filter size={13} className="text-asvo-text-dim mr-0.5" />
          {SOURCE_FILTERS.map(f => {
            const isActive = sourceFilter === f.key;
            return (
              <button
                key={f.key}
                onClick={() => setSourceFilter(f.key)}
                className={`px-3.5 py-1 rounded-full text-xs font-semibold transition-all ${
                  isActive
                    ? "border-[1.5px] bg-opacity-10 text-opacity-100"
                    : "border border-asvo-border text-asvo-text-dim hover:text-asvo-text-mid hover:border-asvo-border-lt"
                }`}
                style={isActive ? {
                  borderColor: f.color,
                  backgroundColor: `${f.color}10`,
                  color: f.color,
                  borderWidth: '1.5px',
                } : undefined}
              >
                {f.label}
              </button>
            );
          })}
        </div>
      </div>

      {}
      {viewMode === "board" && (
        <div className="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-5 gap-3">
          {COLUMNS.map(col => {
            const colTasks = grouped[col.key] || [];
            const isDragTarget = dragOverCol === col.key;

            return (
              <div
                key={col.key}
                className={`flex flex-col rounded-xl transition-all min-h-[350px] ${
                  isDragTarget
                    ? `border-2 ${col.dragBorderCls} bg-asvo-surface/80`
                    : "border border-asvo-border bg-asvo-surface/30"
                }`}
                onDragOver={e => onDragOver(e, col.key)}
                onDragLeave={onDragLeave}
                onDrop={e => onDrop(e, col.key)}
              >
                {}
                <div className={`flex items-center justify-between px-3 py-2.5 rounded-t-xl ${col.borderTopCls} ${col.gradientCls}`}>
                  <div className="flex items-center gap-2">
                    <StatusDot color={col.dotColor} />
                    <span className={`text-xs font-bold uppercase tracking-wide ${col.textCls}`}>{col.label}</span>
                  </div>
                  <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${col.badgeCls}`}>
                    {colTasks.length}
                  </span>
                </div>

                {}
                <div className="flex-1 p-2 space-y-2 overflow-y-auto max-h-[calc(100vh-310px)] kanban-scroll">
                  {loading && colTasks.length === 0 && (
                    <div className="flex items-center justify-center py-10">
                      <Loader2 className="animate-spin text-asvo-text-dim" size={18} />
                    </div>
                  )}

                  {colTasks.map(task => {
                    const stats = task.stats || { done: 0, inWork: 0, onStock: 0, total: 0 };
                    const pDone = task.targetQty > 0 ? Math.min(100, Math.round((stats.done / task.targetQty) * 100)) : 0;
                    const prio = getPriority(task.priority);
                    const isDragging = draggingId === task.id;
                    const overdue = task.status !== "DONE" && task.status !== "CLOSED" && isOverdue(task.dueDate);
                    const isSelected = drawerTask?.task.id === task.id && drawerOpen;
                    const showProgress = col.key === "IN_PROGRESS" || col.key === "REVIEW";
                    const responsibleName = task.responsible
                      ? `${task.responsible.surname} ${task.responsible.name}`
                      : null;

                    return (
                      <div
                        key={task.id}
                        draggable
                        onDragStart={e => onDragStart(e, task)}
                        onDragEnd={onDragEnd}
                        onClick={() => openDrawer(task.id)}
                        className={`group bg-asvo-card border border-asvo-border ${prio.borderCls} rounded-[10px] p-3.5 cursor-grab transition-all duration-200 select-none ${
                          isDragging
                            ? "opacity-30 scale-95"
                            : isSelected
                            ? "border-asvo-accent bg-asvo-card-hover ring-1 ring-asvo-accent/20"
                            : "hover:bg-asvo-card-hover hover:border-asvo-border-lt hover:-translate-y-0.5 hover:shadow-[0_8px_24px_rgba(0,0,0,0.3)]"
                        }`}
                      >
                        {}
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2">
                            <span className="font-mono text-[11px] font-semibold text-asvo-accent">
                              #{task.id}
                            </span>
                            {task.originType && originToBadge[task.originType] && (
                              <Badge variant={originToBadge[task.originType]}>
                                {task.originType}
                              </Badge>
                            )}
                          </div>
                          <span className={`text-[10px] font-bold ${prio.color}`} title={prio.title}>
                            {prio.icon}
                          </span>
                        </div>

                        {}
                        <h4 className="text-[13px] font-medium text-asvo-text leading-[1.45] line-clamp-2 mb-2">
                          {task.title}
                        </h4>

                        {}
                        {showProgress && (
                          <div className="mb-2">
                            <ProgressBar value={pDone} color={col.progressColor} />
                            <span className="text-[10px] text-asvo-text-dim font-mono mt-0.5 block">
                              {pDone}%
                            </span>
                          </div>
                        )}

                        {}
                        {task.originType && !originToBadge[task.originType] && (
                          <div className="mb-2">
                            <span className="text-[10px] px-2 py-0.5 rounded-full bg-asvo-accent-dim text-asvo-text-mid">
                              {task.originType}
                            </span>
                          </div>
                        )}

                        {}
                        <div className="flex items-center justify-between mt-1">
                          <div className="flex items-center gap-1.5">
                            {responsibleName && (
                              <Avatar
                                name={responsibleName}
                                size="sm"
                                color="accent"
                              />
                            )}
                          </div>
                          <div className="flex items-center gap-2 text-[11px] text-asvo-text-dim">
                            {task.dueDate && (
                              <span className={`flex items-center gap-0.5 ${overdue ? "text-asvo-red font-semibold" : ""}`}>
                                {overdue && <AlertTriangle size={9} />}
                                <Calendar size={9} />
                                {formatDate(task.dueDate)}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}

                  {}
                  {!loading && colTasks.length === 0 && (
                    <div className="border border-dashed border-asvo-border rounded-[10px] bg-asvo-surface/50 p-8 text-center">
                      <col.icon size={24} className="mx-auto mb-2 opacity-40 text-asvo-text-dim" />
                      <span className="text-[13px] text-asvo-text-dim">Нет задач</span>
                    </div>
                  )}
                </div>

                {}
                {col.key === "NEW" && (
                  <div className="p-2">
                    <button
                      onClick={() => setIsModalOpen(true)}
                      className="w-full border-[1.5px] border-dashed border-asvo-border rounded-[10px] p-2.5 text-asvo-text-dim text-[13px] font-medium hover:border-asvo-accent/30 hover:text-asvo-accent hover:bg-asvo-accent-dim transition-all flex items-center justify-center gap-1.5"
                    >
                      <Plus size={14} /> Новая задача
                    </button>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}

      {}
      {viewMode === "list" && (
        <div className="bg-asvo-surface border border-asvo-border rounded-xl overflow-hidden">
          <table className="w-full">
            <thead>
              <tr className="bg-asvo-surface border-b border-asvo-border">
                <th className="text-left px-3 py-2.5 text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider">Задача</th>
                <th className="text-left px-3 py-2.5 text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider">Статус</th>
                <th className="text-left px-3 py-2.5 text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider">Источник</th>
                <th className="text-left px-3 py-2.5 text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider">Прогресс</th>
                <th className="text-left px-3 py-2.5 text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider">Срок</th>
                <th className="text-left px-3 py-2.5 text-[10px] font-semibold text-asvo-text-dim uppercase tracking-wider">Исполнитель</th>
              </tr>
            </thead>
            <tbody>
              {loading ? (
                <tr><td colSpan={6} className="text-center py-10 text-asvo-text-dim"><Loader2 className="animate-spin inline" size={16} /></td></tr>
              ) : filtered.length === 0 ? (
                <tr><td colSpan={6} className="text-center py-10 text-asvo-text-dim text-xs">Нет задач</td></tr>
              ) : filtered.map(task => {
                const stats = task.stats || { done: 0, total: 0, inWork: 0, onStock: 0 };
                const pDone = task.targetQty > 0 ? Math.min(100, Math.round((stats.done / task.targetQty) * 100)) : 0;
                const col = COLUMNS.find(c => c.key === task.status) || COLUMNS[0];
                const overdue = task.status !== "DONE" && task.status !== "CLOSED" && isOverdue(task.dueDate);
                const prio = getPriority(task.priority);
                const responsibleName = task.responsible
                  ? `${task.responsible.surname} ${task.responsible.name}`
                  : null;

                return (
                  <tr
                    key={task.id}
                    onClick={() => openDrawer(task.id)}
                    className="border-b border-asvo-border/50 hover:bg-asvo-card cursor-pointer transition-colors"
                  >
                    <td className="px-3 py-2.5">
                      <div className="flex items-center gap-2">
                        <span className={`text-[10px] font-bold ${prio.color}`}>{prio.icon}</span>
                        <span className="font-mono text-[11px] text-asvo-accent font-semibold">#{task.id}</span>
                        <span className="text-sm text-asvo-text truncate max-w-[300px]">{task.title}</span>
                      </div>
                    </td>
                    <td className="px-3 py-2.5">
                      <span className={`text-[10px] px-2 py-0.5 rounded-full font-semibold ${col.badgeCls}`}>{col.label}</span>
                    </td>
                    <td className="px-3 py-2.5">
                      {task.originType && originToBadge[task.originType] ? (
                        <Badge variant={originToBadge[task.originType]}>{task.originType}</Badge>
                      ) : task.originType ? (
                        <span className="text-[10px] text-asvo-text-mid">{task.originType}</span>
                      ) : null}
                    </td>
                    <td className="px-3 py-2.5">
                      <div className="flex items-center gap-2">
                        <div className="w-16">
                          <ProgressBar value={pDone} color={pDone >= 100 ? "accent" : "blue"} />
                        </div>
                        <span className="text-[10px] text-asvo-text-dim font-mono">{pDone}%</span>
                      </div>
                    </td>
                    <td className="px-3 py-2.5">
                      {task.dueDate ? (
                        <span className={`text-xs ${overdue ? "text-asvo-red font-semibold" : "text-asvo-text-mid"}`}>
                          {new Date(task.dueDate).toLocaleDateString("ru")}
                        </span>
                      ) : <span className="text-asvo-text-dim">—</span>}
                    </td>
                    <td className="px-3 py-2.5">
                      {responsibleName ? (
                        <div className="flex items-center gap-1.5">
                          <Avatar name={responsibleName} size="sm" color="accent" />
                          <span className="text-xs text-asvo-text-mid">{task.responsible!.surname}</span>
                        </div>
                      ) : <span className="text-asvo-text-dim text-xs">—</span>}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}

      {}
      {drawerOpen && drawerTask && (
        <>
          {}
          <div className="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm" onClick={closeDrawer} />

          {}
          <div className="fixed top-0 right-0 z-50 h-full w-full max-w-lg bg-asvo-surface border-l border-asvo-border shadow-2xl overflow-y-auto animate-slide-in">
            {}
            <div className="sticky top-0 z-10 bg-asvo-surface/95 backdrop-blur border-b border-asvo-border px-5 py-4 flex items-center justify-between">
              <div className="flex items-center gap-2 min-w-0 pr-4">
                <span className="font-mono text-[11px] font-semibold text-asvo-accent shrink-0">#{drawerTask.task.id}</span>
                <h2 className="text-base font-bold text-asvo-text truncate">{drawerTask.task.title}</h2>
              </div>
              <div className="flex items-center gap-2 shrink-0">
                {isEditing ? (
                  <>
                    <button onClick={saveChanges} className="p-1.5 bg-asvo-accent/15 text-asvo-accent rounded-lg hover:bg-asvo-accent/25 transition"><Save size={15} /></button>
                    <button onClick={() => setIsEditing(false)} className="p-1.5 bg-asvo-card text-asvo-text-mid rounded-lg hover:bg-asvo-card-hover transition"><X size={15} /></button>
                  </>
                ) : (
                  <button onClick={startEditing} className="p-1.5 bg-asvo-accent/15 text-asvo-accent rounded-lg hover:bg-asvo-accent/25 transition"><Edit3 size={15} /></button>
                )}
                <button onClick={closeDrawer} className="p-1.5 text-asvo-text-dim hover:text-asvo-text transition"><ChevronRight size={18} /></button>
              </div>
            </div>

            <div className="p-5 space-y-5">
              {}
              {isEditing ? (
                <textarea
                  value={editForm.comment || ""}
                  onChange={e => setEditForm({ ...editForm, comment: e.target.value })}
                  placeholder="Описание задачи..."
                  className="w-full px-3 py-2 bg-asvo-card border border-asvo-border rounded-lg text-sm text-asvo-text placeholder:text-asvo-text-dim focus:border-asvo-border-lt focus:outline-none min-h-[60px] resize-none"
                />
              ) : drawerTask.task.comment ? (
                <p className="text-sm text-asvo-text-mid leading-relaxed">{drawerTask.task.comment}</p>
              ) : null}

              {}
              <div className="grid grid-cols-2 gap-3">
                {}
                <div className="bg-asvo-card border border-asvo-border rounded-lg p-3">
                  <span className="block text-[10px] text-asvo-text-dim uppercase font-bold mb-1.5">Статус</span>
                  {isEditing ? (
                    <select value={editForm.status} onChange={e => setEditForm({ ...editForm, status: e.target.value })} className="w-full px-2 py-1 bg-asvo-bg border border-asvo-border rounded text-xs text-asvo-text focus:border-asvo-border-lt focus:outline-none">
                      {COLUMNS.map(c => <option key={c.key} value={c.key}>{c.label}</option>)}
                    </select>
                  ) : (
                    <span className={`inline-block px-2 py-0.5 rounded-full text-[10px] font-semibold ${COLUMNS.find(c => c.key === drawerTask.task.status)?.badgeCls || "text-asvo-text-mid"}`}>
                      {COLUMNS.find(c => c.key === drawerTask.task.status)?.label || drawerTask.task.status}
                    </span>
                  )}
                </div>

                {}
                <div className="bg-asvo-card border border-asvo-border rounded-lg p-3">
                  <span className="block text-[10px] text-asvo-text-dim uppercase font-bold mb-1.5">Приоритет</span>
                  {isEditing ? (
                    <select value={editForm.priority || 1} onChange={e => setEditForm({ ...editForm, priority: e.target.value })} className="w-full px-2 py-1 bg-asvo-bg border border-asvo-border rounded text-xs text-asvo-text focus:border-asvo-border-lt focus:outline-none">
                      <option value="1">Низкий</option>
                      <option value="2">Средний</option>
                      <option value="3">Высокий</option>
                    </select>
                  ) : (
                    <div className="flex items-center gap-1.5">
                      <span className={`text-[11px] font-bold ${getPriority(drawerTask.task.priority).color}`}>
                        {getPriority(drawerTask.task.priority).icon}
                      </span>
                      <span className="text-xs text-asvo-text">{getPriority(drawerTask.task.priority).title}</span>
                    </div>
                  )}
                </div>

                {}
                <div className="bg-asvo-card border border-asvo-border rounded-lg p-3">
                  <span className="block text-[10px] text-asvo-text-dim uppercase font-bold mb-1.5">Проект</span>
                  {isEditing ? (
                    <select value={editForm.projectId || ""} onChange={e => setEditForm({ ...editForm, projectId: e.target.value || null })} className="w-full px-2 py-1 bg-asvo-bg border border-asvo-border rounded text-xs text-asvo-text focus:border-asvo-border-lt focus:outline-none">
                      <option value="">Без проекта</option>
                      {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                    </select>
                  ) : (
                    <span className="text-xs text-asvo-blue font-medium">{projects.find(p => p.id === drawerTask.task.projectId)?.title || "—"}</span>
                  )}
                </div>

                {}
                <div className="bg-asvo-card border border-asvo-border rounded-lg p-3">
                  <span className="block text-[10px] text-asvo-text-dim uppercase font-bold mb-1.5">Исполнитель</span>
                  {isEditing ? (
                    <select value={editForm.responsibleId || ""} onChange={e => setEditForm({ ...editForm, responsibleId: e.target.value || null })} className="w-full px-2 py-1 bg-asvo-bg border border-asvo-border rounded text-xs text-asvo-text focus:border-asvo-border-lt focus:outline-none">
                      <option value="">Не назначен</option>
                      {users.map(u => <option key={u.id} value={u.id}>{u.surname} {u.name}</option>)}
                    </select>
                  ) : (
                    <div className="flex items-center gap-2">
                      {drawerTask.task.responsible && (
                        <Avatar
                          name={`${drawerTask.task.responsible.surname} ${drawerTask.task.responsible.name}`}
                          size="sm"
                          color="accent"
                        />
                      )}
                      <span className="text-xs text-asvo-text">{drawerTask.task.responsible ? `${drawerTask.task.responsible.surname} ${drawerTask.task.responsible.name}` : "—"}</span>
                    </div>
                  )}
                </div>

                {}
                <div className="bg-asvo-card border border-asvo-border rounded-lg p-3">
                  <span className="block text-[10px] text-asvo-text-dim uppercase font-bold mb-1.5">Срок сдачи</span>
                  {isEditing ? (
                    <input type="date" value={editForm.dueDate || ""} onChange={e => setEditForm({ ...editForm, dueDate: e.target.value })} className="w-full px-2 py-1 bg-asvo-bg border border-asvo-border rounded text-xs text-asvo-text focus:border-asvo-border-lt focus:outline-none" />
                  ) : (
                    <span className={`text-xs ${isOverdue(drawerTask.task.dueDate) && drawerTask.task.status !== "DONE" && drawerTask.task.status !== "CLOSED" ? "text-asvo-red font-semibold" : "text-asvo-text"}`}>
                      {drawerTask.task.dueDate ? new Date(drawerTask.task.dueDate).toLocaleDateString("ru") : "—"}
                    </span>
                  )}
                </div>

                {}
                <div className="bg-asvo-card border border-asvo-border rounded-lg p-3">
                  <span className="block text-[10px] text-asvo-text-dim uppercase font-bold mb-1.5">Источник</span>
                  {drawerTask.task.originType ? (
                    <div className="flex items-center gap-1.5">
                      {originToBadge[drawerTask.task.originType] ? (
                        <Badge variant={originToBadge[drawerTask.task.originType]}>
                          {drawerTask.task.originType}
                          {drawerTask.task.originId ? ` #${drawerTask.task.originId}` : ""}
                        </Badge>
                      ) : (
                        <span className="text-xs text-asvo-text-mid">{drawerTask.task.originType}</span>
                      )}
                    </div>
                  ) : <span className="text-xs text-asvo-text-dim">—</span>}
                </div>
              </div>

              {}
              {drawerTask.breakdown.length > 0 && (
                <div>
                  <h3 className="flex items-center gap-2 text-[10px] font-bold text-asvo-text-dim uppercase tracking-wide mb-2">
                    <MapPin size={12} className="text-asvo-accent" /> Локализация изделий
                  </h3>
                  <div className="grid grid-cols-2 gap-2">
                    {drawerTask.breakdown.map((item, idx) => (
                      <div key={idx} className="flex items-center justify-between p-2 bg-asvo-card border border-asvo-border rounded-lg text-xs">
                        <span className="text-asvo-text-mid">{item.sectionTitle || "Склад"}</span>
                        <span className="font-bold text-asvo-text">{item.qty} шт</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        </>
      )}

      {}
      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)}>
        <div className="p-1">
          <h2 className="text-lg font-bold text-asvo-text mb-5">
            Создать задачу
          </h2>
          <div className="space-y-3">
            <input
              className="w-full px-3 py-2 bg-asvo-card border border-asvo-border rounded-lg text-asvo-text text-sm placeholder:text-asvo-text-dim focus:border-asvo-border-lt focus:outline-none"
              placeholder="Название"
              value={createForm.title || ""}
              onChange={e => setCreateForm({ ...createForm, title: e.target.value })}
            />
            <select
              className="w-full px-3 py-2 bg-asvo-card border border-asvo-border rounded-lg text-asvo-text text-sm focus:border-asvo-border-lt focus:outline-none"
              value={createForm.projectId || ""}
              onChange={e => setCreateForm({ ...createForm, projectId: e.target.value })}
            >
              <option value="">Без проекта</option>
              {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
            </select>
            <div className="grid grid-cols-2 gap-2">
              <select
                className="w-full px-3 py-2 bg-asvo-card border border-asvo-border rounded-lg text-asvo-text text-sm focus:border-asvo-border-lt focus:outline-none"
                value={createForm.originType || ""}
                onChange={e => setCreateForm({ ...createForm, originType: e.target.value })}
              >
                <option value="">Без источника</option>
                <option value="PRODUCT">Изделие</option>
                <option value="COMPONENT">Комплектующее</option>
                <option value="NC">NC</option>
                <option value="CAPA">CAPA</option>
                <option value="RISK">Риск</option>
                <option value="AUDIT">Аудит</option>
                <option value="TRAINING">Обучение</option>
              </select>
              <input
                type="number"
                className="w-full px-3 py-2 bg-asvo-card border border-asvo-border rounded-lg text-asvo-text text-sm placeholder:text-asvo-text-dim focus:border-asvo-border-lt focus:outline-none"
                placeholder="ID объекта"
                value={createForm.originId || ""}
                onChange={e => setCreateForm({ ...createForm, originId: e.target.value })}
              />
            </div>
            <div className="grid grid-cols-3 gap-2">
              <input
                type="number"
                className="w-full px-3 py-2 bg-asvo-card border border-asvo-border rounded-lg text-asvo-text text-sm font-bold placeholder:text-asvo-text-dim focus:border-asvo-border-lt focus:outline-none"
                placeholder="Кол-во"
                value={createForm.targetQty}
                onChange={e => setCreateForm({ ...createForm, targetQty: e.target.value })}
              />
              <select
                className="w-full px-3 py-2 bg-asvo-card border border-asvo-border rounded-lg text-asvo-text text-sm focus:border-asvo-border-lt focus:outline-none"
                value={createForm.priority || "1"}
                onChange={e => setCreateForm({ ...createForm, priority: e.target.value })}
              >
                <option value="1">Низкий</option>
                <option value="2">Средний</option>
                <option value="3">Высокий</option>
              </select>
              <select
                className="w-full px-3 py-2 bg-asvo-card border border-asvo-border rounded-lg text-asvo-text text-sm focus:border-asvo-border-lt focus:outline-none"
                value={createForm.responsibleId || ""}
                onChange={e => setCreateForm({ ...createForm, responsibleId: e.target.value })}
              >
                <option value="">Исполнитель</option>
                {users.map(u => <option key={u.id} value={u.id}>{u.surname} {u.name}</option>)}
              </select>
            </div>
            <input
              type="date"
              className="w-full px-3 py-2 bg-asvo-card border border-asvo-border rounded-lg text-asvo-text text-sm focus:border-asvo-border-lt focus:outline-none"
              value={createForm.dueDate || ""}
              onChange={e => setCreateForm({ ...createForm, dueDate: e.target.value })}
            />
            <button
              onClick={async () => {
                if (!createForm.title || !createForm.targetQty) return;
                await createTask({
                  ...createForm,
                  targetQty: Number(createForm.targetQty),
                  originId: createForm.originId ? Number(createForm.originId) : undefined,
                  projectId: createForm.projectId ? Number(createForm.projectId) : undefined,
                  responsibleId: createForm.responsibleId ? Number(createForm.responsibleId) : undefined,
                  priority: Number(createForm.priority) || 1,
                });
                setIsModalOpen(false);
                setCreateForm({ priority: "1", targetQty: "" });
                loadData();
              }}
              className="w-full mt-2 py-3 bg-gradient-to-r from-asvo-accent to-asvo-accent/80 hover:from-asvo-accent hover:to-asvo-accent text-asvo-bg font-bold rounded-xl transition-all text-sm shadow-[0_2px_12px_rgba(45,212,168,0.3)] hover:shadow-[0_4px_16px_rgba(45,212,168,0.4)]"
            >
              Создать
            </button>
          </div>
        </div>
      </Modal>

      {}
      <style>{`
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-slide-in { animation: slideIn 0.2s ease-out; }
      `}</style>
    </div>
  );
};

export default TasksList;

================================================================================
FILE: QMS-Client-main/src/pages/Tasks/TasksPage.tsx
================================================================================

import React, { useState } from "react";
import {
  ClipboardList,
  Layout,
  Briefcase,
} from "lucide-react";
import TasksList from "./TasksList";
import ProjectsList from "./ProjectsList";

const TasksPage: React.FC = () => {
  const [activeTab, setActiveTab] = useState<"TASKS" | "PROJECTS">("TASKS");

  return (
    <div className="bg-asvo-bg min-h-screen animate-fade-in">
      {}
      <div className="bg-asvo-bg border-b border-asvo-border px-7 pt-5 pb-3.5">
        <div className="flex items-center gap-4">
          {}
          <div className="w-[38px] h-[38px] rounded-[10px] bg-gradient-to-br from-asvo-accent/15 to-asvo-accent/5 border border-asvo-accent/20 flex items-center justify-center shadow-lg shadow-asvo-accent/5">
            <ClipboardList className="text-asvo-accent" size={20} />
          </div>

          {}
          <div>
            <h1 className="text-lg font-bold text-asvo-text tracking-tight">
              Планирование проектов и задач
            </h1>
            <p className="text-xs text-asvo-text-dim">
              Управление задачами и отслеживание прогресса
            </p>
          </div>

          {}
          <div className="flex bg-asvo-surface border border-asvo-border rounded-lg overflow-hidden ml-auto">
            <button
              onClick={() => setActiveTab("TASKS")}
              className={`flex items-center gap-2 px-4 py-2 text-[13px] font-semibold transition-all ${
                activeTab === "TASKS"
                  ? "bg-asvo-accent text-asvo-bg"
                  : "text-asvo-text-mid hover:text-asvo-text"
              }`}
            >
              <Layout size={14} />
              Канбан
            </button>
            <button
              onClick={() => setActiveTab("PROJECTS")}
              className={`flex items-center gap-2 px-4 py-2 text-[13px] font-semibold transition-all ${
                activeTab === "PROJECTS"
                  ? "bg-asvo-accent text-asvo-bg"
                  : "text-asvo-text-mid hover:text-asvo-text"
              }`}
            >
              <Briefcase size={14} />
              Проекты
            </button>
          </div>
        </div>
      </div>

      {}
      <div className="px-7 py-4">
        {activeTab === "TASKS" && <TasksList />}
        {activeTab === "PROJECTS" && <ProjectsList />}
      </div>
    </div>
  );
};

export default TasksPage;

================================================================================
FILE: QMS-Client-main/src/pages/Users/OneUser.tsx
================================================================================

import { UserIcon, ShieldCheck, MonitorDot, User } from "lucide-react";

interface OneUserProps {
  login: string;
  role: string;
  name: string;
  surName: string;
  img: string | null;
  active: boolean;
  pcName: string | undefined;
  pcIP: string | undefined;
}

export const OneUser: React.FC<OneUserProps> = ({
  login,
  role,
  name,
  surName,
  img,
  active,
  pcName,
  pcIP,
}) => {
  return (
    <div className="bg-white shadow-md rounded-xl p-4 flex items-center gap-4 border-l-4 border-blue-500 transition duration-300 hover:shadow-lg overflow-hidden flex-wrap">


      {img ? (
        <div className="relative w-24 h-24 rounded-full overflow-hidden shadow-2xl border-4 border-white hover:border-purple-500 transition-all duration-300 transform hover:scale-105 group">
          <img
            src={import.meta.env.VITE_API_URL + "/" + img}
            alt="Аватар пользователя"
            className="w-full h-full object-cover"
          />
        </div>
      ) : (
        <div className="bg-gradient-to-br from-blue-100 to-purple-100 p-3 rounded-full w-24 h-24 flex items-center justify-center shadow-lg transform transition-all hover:scale-105 duration-300">
          <UserIcon className="text-blue-600 w-12 h-12" />
        </div>
      )}


      <div className="flex-1">
        <h3 className="text-2xl font-bold text-gray-900">
          {name} {surName}
        </h3>
        <p className="text-gray-600 text-sm mt-1">{login}</p>
      </div>


      {active ? (
        <div className="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-full shadow-sm">
          <div className="relative">
            <MonitorDot className="text-green-600 w-6 h-6" />

            <div className="absolute inset-0 flex items-center justify-center">
              <div className="w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
            </div>
          </div>
          <p className="text-sm font-medium text-green-800">
            {pcName} ({pcIP}) – Online
          </p>
        </div>
      ) : (
        <div className="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-full shadow-sm">
          <MonitorDot className="text-red-600 w-6 h-6" />
          <p className="text-sm font-medium text-red-800">Offline</p>
        </div>
      )}


      <div className="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-purple-50 px-4 py-2 rounded-full shadow-sm">
        {role === "ADMIN" ? (
          <ShieldCheck className="text-green-600 w-6 h-6" />
        ) : (
          <User className="text-blue-600 w-6 h-6" />
        )}
        <span className="text-gray-700 font-medium">{role}</span>
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Users/Users.tsx
================================================================================

import { useEffect, useState } from "react";
import { fetchPC, fetchSession, fetchUsers } from "src/api/userApi";
import { OneUser } from "./OneUser";
import { userGetModel } from "src/types/UserModel";
import { SessionModelFull } from "src/types/SessionModel";
import { pcModelFull } from "src/types/PCModel";

export const Users: React.FC = () => {
  const [users, setUsers] = useState<userGetModel[]>([]);
  const [sessions, setSessions] = useState<SessionModelFull[]>([]);
  const [pcs, setPcs] = useState<pcModelFull[]>([]);

  useEffect(() => {
    fetchUsers().then((data) => setUsers(data));
    fetchSession().then((data) => setSessions(data));
    fetchPC().then((data) => setPcs(data));
  }, []);

  const getActiveSession = () => {
    return sessions.filter(
      (session: SessionModelFull) => session.online === true
    );
  };

  const getUsersOnlineID = () => {
    return (

      getActiveSession().map((session: SessionModelFull) => session.userId)
    );
  };

  const isOnline = (id: number) => {
    return getUsersOnlineID().includes(id);
  };

  const getCurrentPCName = (userId: number) => {
    const currentSession = getActiveSession().find(
      (session) => session.userId === userId
    );
    console.log(currentSession? currentSession.PCId : '00000')
    const currentPC = pcs.find(
      (pc) => pc.id === currentSession?.PCId
    );

    return currentPC;
  };

  let allUsers = users.map((user: userGetModel) => (
    <OneUser
      key={user.id}
      login={user.login}
      role={user.role}
      name={user.name}
      surName={user.surname}
      img = {user.img}
      active={isOnline(user.id)}
      pcName={getCurrentPCName(user.id)?.pc_name}
      pcIP={getCurrentPCName(user.id)?.ip}
    />
  ));
  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold text-gray-800 text-center mb-6">
        📋 Список пользователей
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {allUsers}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/AnalyticsPage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { fetchDashboardStats } from "src/api/warehouseApi";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { TrendingUp, Package, AlertTriangle, Activity, ArrowLeft } from "lucide-react";
import { WAREHOUSE_ROUTE } from "src/utils/consts";

export const AnalyticsPage: React.FC = () => {
    const navigate = useNavigate();
    const [data, setData] = useState<any>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchDashboardStats().then(res => {
            setData(res);
            setLoading(false);
        });
    }, []);

    if (loading) return <div className="p-10 text-center text-gray-500">Загрузка аналитики...</div>;

    const totalItems = data?.stock?.totalItems || 0;
    const totalBoxes = data?.stock?.totalBoxes || 0;
    const scrapOp = data?.today?.find((x: any) => x.operation === 'QUALITY' || x.operation === 'SCRAP');
    const scrapToday = scrapOp ? Number(scrapOp.sumScrap) : 0;
    const chartData = data?.chart?.map((item: any) => ({
        name: new Date(item.date).toLocaleDateString('ru-RU', {weekday: 'short'}),
        count: Number(item.count)
    })) || [];

    return (
        <div className="p-6 max-w-7xl mx-auto animate-fade-in bg-gray-50 min-h-screen">
            <button
                onClick={() => navigate(WAREHOUSE_ROUTE)}
                className="mb-4 flex items-center text-gray-500 hover:text-indigo-600 transition font-medium text-sm"
            >
                <ArrowLeft size={18} className="mr-1"/> Вернуться на склад
            </button>

            <h1 className="text-3xl font-bold text-gray-800 mb-8">Аналитическая панель</h1>


            <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-gray-500 text-sm font-medium">Всего на складе</p>
                            <h3 className="text-3xl font-bold text-indigo-600 mt-2">{Number(totalItems).toLocaleString()}</h3>
                            <p className="text-xs text-gray-400 mt-1">единиц хранения</p>
                        </div>
                        <div className="p-3 bg-indigo-50 rounded-xl text-indigo-600"><Package /></div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-gray-500 text-sm font-medium">Мест хранения</p>
                            <h3 className="text-3xl font-bold text-gray-800 mt-2">{totalBoxes}</h3>
                            <p className="text-xs text-gray-400 mt-1">активных коробок</p>
                        </div>
                        <div className="p-3 bg-gray-50 rounded-xl text-gray-600"><Activity /></div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-gray-500 text-sm font-medium">Брак за сегодня</p>
                            <h3 className="text-3xl font-bold text-red-600 mt-2">{scrapToday}</h3>
                            <p className="text-xs text-gray-400 mt-1">выявлено на ОТК</p>
                        </div>
                        <div className="p-3 bg-red-50 rounded-xl text-red-600"><AlertTriangle /></div>
                    </div>
                </div>

                <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-lg text-white">
                    <p className="text-indigo-100 text-sm font-medium">Эффективность</p>
                    <h3 className="text-3xl font-bold mt-2">98.5%</h3>
                    <div className="flex items-center gap-1 text-xs text-indigo-200 mt-1">
                        <TrendingUp size={14}/> <span>Стабильный рост</span>
                    </div>
                </div>
            </div>

            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h3 className="text-lg font-bold text-gray-700 mb-6">Динамика операций (7 дней)</h3>
                <div className="h-80 w-full">
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData}>
                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
                            <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#9ca3af'}} dy={10} />
                            <YAxis axisLine={false} tickLine={false} tick={{fill: '#9ca3af'}} />
                            <Tooltip cursor={{fill: '#f9fafb'}} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} />
                            <Bar dataKey="count" fill="#4f46e5" radius={[4, 4, 0, 0]} barSize={40} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/InventoryPage.tsx
================================================================================

import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import { fetchBoxByQr, moveBoxesBatch, fetchBoxById } from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import { Search, CheckCircle2, Save, Scale, ArrowRight, ScanLine, ArrowLeft } from "lucide-react";
import toast from 'react-hot-toast';
import { WAREHOUSE_ROUTE } from "src/utils/consts";

interface InventoryItem {
    box: InventoryBoxModel;
    systemQty: number;
    actualQty: number;
    delta: number;
}

export const InventoryPage: React.FC = () => {
    const navigate = useNavigate();
    const [scanCode, setScanCode] = useState("");
    const [loading, setLoading] = useState(false);

    const [items, setItems] = useState<InventoryItem[]>([]);
    const [scannedBox, setScannedBox] = useState<InventoryBoxModel | null>(null);
    const [actualInput, setActualInput] = useState("");

    const handleScan = async () => {
        if (!scanCode) return;
        setLoading(true);
        try {
            let res;
            if (/^\d+$/.test(scanCode)) res = await fetchBoxById(Number(scanCode));
            else res = await fetchBoxByQr(scanCode);

            if (items.some(i => i.box.id === res.box.id)) {
                toast.error("Эта коробка уже в списке!");
                setScanCode("");
                return;
            }
            setScannedBox(res.box);
            setActualInput(String(res.box.quantity));
        } catch (e) {
            toast.error("Коробка не найдена");
        } finally {
            setLoading(false);
        }
    };

    const confirmItem = () => {
        if (!scannedBox) return;
        const actual = Number(actualInput);
        if (isNaN(actual) || actual < 0) return toast.error("Неверное число");
        const delta = actual - scannedBox.quantity;
        setItems(prev => [{
            box: scannedBox,
            systemQty: scannedBox.quantity,
            actualQty: actual,
            delta
        }, ...prev]);
        setScannedBox(null);
        setScanCode("");
        setActualInput("");
        if (delta === 0) toast.success("Совпадает");
        else toast("Расхождение зафиксировано", { icon: '⚠️' });
    };

    const commitInventory = async () => {
        if (items.length === 0) return;
        const loadingToast = toast.loading("Сохранение акта...");
        try {
            await moveBoxesBatch({
                movements: items.map(item => ({
                    boxId: item.box.id,
                    operation: "INVENTORY_CHECK",
                    deltaQty: item.delta,
                    comment: `Инвентаризация. Было: ${item.systemQty}, Стало: ${item.actualQty}`
                })),
                documentData: {
                    createNew: true,
                    number: `INV-${Date.now()}`,
                    type: "INVENTORY_ACT",
                    comment: `Акт инвентаризации (${items.length} поз.)`
                }
            });
            toast.success("Инвентаризация завершена!", { id: loadingToast });
            setItems([]);
        } catch (e: any) {
            toast.error("Ошибка: " + e.message, { id: loadingToast });
        }
    };

    return (
        <div className="p-6 max-w-5xl mx-auto min-h-screen bg-gray-50">
            <button
                onClick={() => navigate(WAREHOUSE_ROUTE)}
                className="mb-4 flex items-center text-gray-500 hover:text-indigo-600 transition font-medium text-sm"
            >
                <ArrowLeft size={18} className="mr-1"/> Отмена и выход
            </button>

            <h1 className="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <Scale className="text-indigo-600"/> Инвентаризация
            </h1>

            {scannedBox && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-fade-in">
                        <h3 className="text-xl font-bold text-gray-800 mb-1">{scannedBox.label}</h3>
                        <p className="text-gray-500 text-sm mb-6">ID: {scannedBox.id} • {scannedBox.shortCode}</p>

                        <div className="flex items-center justify-between bg-gray-100 p-4 rounded-xl mb-6">
                            <div className="text-center">
                                <div className="text-xs text-gray-500 uppercase">По учету</div>
                                <div className="text-2xl font-bold text-gray-700">{scannedBox.quantity}</div>
                            </div>
                            <ArrowRight className="text-gray-400"/>
                            <div className="text-center w-1/2">
                                <div className="text-xs text-indigo-600 uppercase font-bold mb-1">По факту</div>
                                <input
                                    type="number"
                                    value={actualInput}
                                    onChange={e => setActualInput(e.target.value)}
                                    className="w-full text-center text-3xl font-bold border-b-2 border-indigo-500 bg-transparent focus:outline-none"
                                    autoFocus
                                    onKeyDown={e => e.key === 'Enter' && confirmItem()}
                                />
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={() => setScannedBox(null)} className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300">Отмена</button>
                            <button onClick={confirmItem} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">Подтвердить</button>
                        </div>
                    </div>
                </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <div className="lg:col-span-1 space-y-4">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <label className="block text-sm font-bold text-gray-700 mb-2">Сканировать QR / ID</label>
                        <div className="flex gap-2">
                            <input
                                value={scanCode} onChange={e => setScanCode(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleScan()}
                                className="w-full p-3 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 text-lg outline-none"
                                placeholder="..."
                                autoFocus={!scannedBox}
                            />
                            <button onClick={handleScan} disabled={loading} className="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700">
                                {loading ? <ScanLine className="animate-spin"/> : <Search/>}
                            </button>
                        </div>
                    </div>

                    <div className="bg-indigo-900 p-6 rounded-2xl shadow-lg text-white">
                        <div className="text-indigo-200 text-sm font-medium mb-1">Проверено позиций</div>
                        <div className="text-5xl font-black">{items.length}</div>
                    </div>
                </div>


                <div className="lg:col-span-2">
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 min-h-[500px] flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="font-bold text-gray-700">Лист инвентаризации</h3>
                            {items.length > 0 && <button onClick={commitInventory} className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition"><Save size={18}/> Завершить акт</button>}
                        </div>

                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                            {items.length === 0 && (
                                <div className="h-full flex flex-col items-center justify-center text-gray-400">
                                    <Scale size={48} className="mb-2 opacity-20"/>
                                    <p>Список пуст. Сканируйте, чтобы начать.</p>
                                </div>
                            )}
                            {items.map((item, idx) => (
                                <div key={idx} className="flex items-center justify-between p-3 bg-white border rounded-xl shadow-sm">
                                    <div>
                                        <div className="font-bold text-gray-800">{item.box.label}</div>
                                        <div className="text-xs text-gray-500">ID: {item.box.id}</div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="text-right">
                                            <div className="text-xs text-gray-400">Учет</div>
                                            <div className="font-medium">{item.systemQty}</div>
                                        </div>
                                        <ArrowRight size={14} className="text-gray-300"/>
                                        <div className="text-right">
                                            <div className="text-xs text-gray-400">Факт</div>
                                            <div className="font-bold text-lg">{item.actualQty}</div>
                                        </div>
                                        <div className={`w-20 text-center py-1 rounded-lg text-xs font-bold ${item.delta === 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                            {item.delta === 0 ? <CheckCircle2 className="mx-auto" size={16}/> : `${item.delta > 0 ? '+' : ''}${item.delta}`}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/WarehousePage.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import {
  Package, ArrowRightLeft, FileText, Truck, PieChart,
  BarChart3, ClipboardCheck, Settings, Tag, Tv, History
} from "lucide-react";

import { fetchStructure } from "src/api/structureApi";
import { fetchAlerts } from "src/api/warehouseApi";
import { SectionModel } from "src/store/StructureStore";
import { productModel } from "src/types/ProductModel";
import { componentModel } from "src/types/ComponentModel";
import { WAREHOUSE_ANALYTICS_ROUTE, WAREHOUSE_INVENTORY_ROUTE } from "src/utils/consts";

import { ProjectDashboard } from "./components/ProjectDashboard";
import { WarehouseIntake } from "./tabs/WarehouseIntake";
import { WarehouseMoves } from "./tabs/WarehouseMoves";
import { WarehouseDocs } from "./tabs/WarehouseDocs";
import { WarehouseBalance } from "./tabs/WarehouseBalance";
import { WarehouseSettings } from "./tabs/WarehouseSettings";
import { WarehouseLabels } from "./tabs/WarehouseLabels";
import { VideoTransmittersLabel } from "./tabs/VideoTransmittersLabel";
import { WarehousePrintHistory } from "./tabs/WarehousePrintHistory";

type Tab = "INTAKE" | "MOVES" | "BALANCE" | "DOCS" | "SETTINGS" | "LABELS" | "VIDEO_LABEL" | "HISTORY";

export const WarehousePage: React.FC = () => {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<Tab>("INTAKE");
  const [alertsCount, setAlertsCount] = useState(0);

  const [sections, setSections] = useState<SectionModel[]>([]);
  const [productsList, setProductsList] = useState<productModel[]>([]);
  const [componentsList, setComponentsList] = useState<componentModel[]>([]);

  useEffect(() => {
    fetchStructure().then(setSections);

    fetchAlerts().then(alerts => setAlertsCount(alerts.length)).catch(console.error);
  }, []);

  return (
    <div className="min-h-screen bg-gray-50 p-6 pb-20 font-sans text-gray-700">


      <div className="max-w-7xl mx-auto mb-6">
        <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6 mb-6">
            <div className="flex items-center gap-4">
               <div className="p-3 bg-indigo-100 rounded-2xl relative">
                  <Package className="w-8 h-8 text-indigo-600" />

                  {alertsCount > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>}
               </div>
               <div>
                  <h1 className="text-3xl font-bold text-gray-800">Складская система</h1>
                  <p className="text-indigo-600/80 font-medium">WMS ASVO-QMS v2.4</p>
               </div>
            </div>


            <div className="flex flex-col md:flex-row gap-4 items-center w-full xl:w-auto">
                <ProjectDashboard />

                <div className="flex gap-2">
                    <button
                        onClick={() => navigate(WAREHOUSE_ANALYTICS_ROUTE)}
                        className="flex flex-col items-center justify-center w-24 h-20 bg-white border border-indigo-100 rounded-xl shadow-sm hover:shadow-md hover:border-indigo-300 transition group"
                    >
                        <div className="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600 mb-1"><BarChart3 size={20}/></div>
                        <span className="text-[10px] font-bold text-gray-600 uppercase">Аналитика</span>
                    </button>

                    <button
                        onClick={() => navigate(WAREHOUSE_INVENTORY_ROUTE)}
                        className="flex flex-col items-center justify-center w-24 h-20 bg-white border border-orange-100 rounded-xl shadow-sm hover:shadow-md hover:border-orange-300 transition group"
                    >
                        <div className="p-2 bg-orange-50 rounded-full group-hover:bg-orange-100 text-orange-600 mb-1"><ClipboardCheck size={20}/></div>
                        <span className="text-[10px] font-bold text-gray-600 uppercase">Ревизия</span>
                    </button>
                </div>
            </div>
        </div>


        <div className="flex gap-2 border-b border-gray-200 pb-1 overflow-x-auto">
           {[
               { id: "INTAKE", label: "Приёмка", icon: <Truck size={18}/> },
               { id: "MOVES", label: "Операции", icon: <ArrowRightLeft size={18}/> },
               { id: "BALANCE", label: "Остатки", icon: <PieChart size={18}/> },
               { id: "DOCS", label: "Накладные", icon: <FileText size={18}/> },
               { id: "LABELS", label: "Этикетки / Реестр", icon: <Tag size={18}/> },
               { id: "VIDEO_LABEL", label: "Печать Видео", icon: <Tv size={18}/> },

               { id: "HISTORY", label: "История печати", icon: <History size={18}/> },

               { id: "SETTINGS", label: "Настройки / Лимиты", icon:
                 <div className="relative flex items-center gap-1">
                    <Settings size={18}/>
                    {alertsCount > 0 && <span className="bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full ml-1">{alertsCount}</span>}
                 </div>
               },
           ].map(tab => (
               <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as Tab)}
                  className={`flex items-center gap-2 px-5 py-3 rounded-t-lg font-bold text-sm transition-all relative top-[1px] whitespace-nowrap ${
                      activeTab === tab.id
                      ? "bg-white text-indigo-700 border border-gray-200 border-b-white shadow-sm z-10"
                      : "text-gray-500 hover:text-indigo-600 hover:bg-gray-100/50"
                  }`}
               >
                   {tab.icon} {tab.label}
               </button>
           ))}
        </div>
      </div>


      <div className="max-w-7xl mx-auto">
        {activeTab === "INTAKE" && <WarehouseIntake sections={sections} productsList={productsList} componentsList={componentsList} />}
        {activeTab === "MOVES" && <WarehouseMoves sections={sections} />}
        {activeTab === "BALANCE" && <WarehouseBalance />}
        {activeTab === "DOCS" && <WarehouseDocs />}
        {activeTab === "LABELS" && <WarehouseLabels />}
        {activeTab === "VIDEO_LABEL" && <VideoTransmittersLabel />}
        {activeTab === "HISTORY" && <WarehousePrintHistory />}
        {activeTab === "SETTINGS" && <WarehouseSettings />}
      </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/__tests__/utils.test.ts
================================================================================

import { describe, it, expect } from 'vitest';
import { calculateBatch } from '../utils';

describe('Warehouse Utils - Batch Calculator', () => {

    it('должен правильно считать полные коробки (ровное деление)', () => {

        const res = calculateBatch(1000, 100);

        expect(res.fullUnits).toBe(10);
        expect(res.remainder).toBe(0);
        expect(res.totalUnits).toBe(10);
    });

    it('должен правильно считать остаток (неровное деление)', () => {

        const res = calculateBatch(1050, 100);

        expect(res.fullUnits).toBe(10);
        expect(res.remainder).toBe(50);
        expect(res.totalUnits).toBe(11);
    });

    it('должен возвращать нули при нулевом общем количестве', () => {
        const res = calculateBatch(0, 100);

        expect(res.totalUnits).toBe(0);
        expect(res.fullUnits).toBe(0);
        expect(res.remainder).toBe(0);
    });

    it('должен обрабатывать случай, когда общее количество меньше вместимости', () => {

        const res = calculateBatch(50, 100);

        expect(res.fullUnits).toBe(0);
        expect(res.remainder).toBe(50);
        expect(res.totalUnits).toBe(1);
    });

    it('должен защищать от деления на ноль (capacity = 0)', () => {

        const res = calculateBatch(100, 0);

        expect(res.fullUnits).toBe(100);
        expect(res.totalUnits).toBe(100);
    });

    it('должен корректно обрабатывать отрицательные числа (считать как 0)', () => {
        const res = calculateBatch(-500, 100);

        expect(res.totalUnits).toBe(0);
    });
});

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/components/LabelConstructor.tsx
================================================================================

import React, { useEffect, useMemo, useRef, useState, useCallback } from "react";
import {
  Type,
  QrCode,
  Trash2,
  Save,
  X,
  AlignLeft,
  AlignCenter,
  AlignRight,
  Minus,
  Square,


  GripHorizontal,
  ZoomIn,
  ZoomOut,
  Database,
  MousePointer2,
  Image as ImageIcon,
  Hash,
  Info,
  Umbrella,
  Wine,
  Package,
  ArrowUp,
  Snowflake,
  Flame,
  AlertTriangle,
  Upload,
  Library,
  Eye,
  Layers,
  HelpCircle,
  BookOpen,


} from "lucide-react";
import QRCode from "react-qr-code";
import clsx from "clsx";
import toast from "react-hot-toast";


export type LabelElementType = "TEXT" | "QR" | "RECTANGLE" | "LINE" | "IMAGE" | "COUNTER" | "ICON";

export interface LabelElement {
  id: string;
  type: LabelElementType;
  x: number;
  y: number;
  width: number;
  height: number;
  content?: string;
  fontSize?: number;
  fontFamily?: string;
  isBold?: boolean;
  align?: "left" | "center" | "right";
  strokeWidth?: number;
  imageUrl?: string;
  imageName?: string;
  qrDescription?: string;
  qrSource?: "code" | "name" | "custom" | "serial" | "contract" | "url";
  counterFormat?: string;
  iconType?: string;
}

interface Props {
  initialName?: string;
  initialWidth?: number;
  initialHeight?: number;
  initialLayout?: LabelElement[];
  onSave?: (name: string, w: number, h: number, layout: LabelElement[]) => void | Promise<void>;
  onClose?: () => void;
}


const PX_PER_MM = 3.78;
const SNAP_MM = 1.0;
const MIN_MM = 2;


const TEXT_VARIABLES = [
  { label: "Переменная...", value: "", description: "" },
  { label: "Код товара {{code}}", value: "{{code}}", description: "Уникальный код/артикул" },
  { label: "Название {{name}}", value: "{{name}}", description: "Наименование товара" },
  { label: "Серийный номер {{serial}}", value: "{{serial}}", description: "Серийный номер изделия" },
  { label: "Цена {{price}}", value: "{{price}}", description: "Стоимость" },
  { label: "Дата {{date}}", value: "{{date}}", description: "Текущая дата" },
  { label: "Контракт {{contract}}", value: "{{contract}}", description: "Номер контракта" },
  { label: "Партия {{batch}}", value: "{{batch}}", description: "Номер партии" },
  { label: "Количество {{qty}}", value: "{{qty}}", description: "Количество в упаковке" },
];


interface CustomFont {
  name: string;
  fontFamily: string;
  fontDataUrl: string;
}


const CUSTOM_FONTS_STORAGE_KEY = "mes_label_custom_fonts";


const QR_SOURCES = [
  {
    value: "code",
    label: "Код товара",
    template: "{{code}}",
    description: "В QR будет закодирован уникальный код товара",
    example: "7342511000501"
  },
  {
    value: "serial",
    label: "Серийный номер",
    template: "{{serial}}",
    description: "В QR будет закодирован серийный номер изделия",
    example: "SN-2024-00813"
  },
  {
    value: "name",
    label: "Название товара",
    template: "{{name}}",
    description: "В QR будет закодировано наименование",
    example: "Видеопередатчик ВП-500"
  },
  {
    value: "contract",
    label: "№ Контракта",
    template: "{{contract}}",
    description: "В QR будет номер госконтракта",
    example: "187/249/9/П/25-63-ФЕ"
  },
  {
    value: "url",
    label: "Ссылка/URL",
    template: "{{url}}",
    description: "В QR будет ссылка для сканирования",
    example: "https://mes.local/item/813"
  },
  {
    value: "custom",
    label: "Свой текст",
    template: "",
    description: "Введите любой текст для кодирования",
    example: "Любой текст"
  },
];


const COUNTER_FORMATS = [
  { label: "1 / 100", value: "{{current}} / {{total}}", description: "Текущий номер / Всего" },
  { label: "1 из 100", value: "{{current}} из {{total}}", description: "Текущий номер из Всего" },
  { label: "#1", value: "#{{current}}", description: "Только текущий номер" },
  { label: "№ 1 (100)", value: "№ {{current}} ({{total}})", description: "С символом номера" },
  { label: "Этикетка 1/100", value: "Этикетка {{current}}/{{total}}", description: "С подписью" },
];


const DEFAULT_ICON_LIBRARY = [
  {
    type: "fragile",
    label: "Хрупкое",
    icon: Wine,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <path d="M18 6 L18 17 Q18 24 25 24 Q32 24 32 17 L32 6" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
      <line x1="25" y1="24" x2="25" y2="38" stroke="#000" stroke-width="2"/>
      <line x1="18" y1="38" x2="32" y2="38" stroke="#000" stroke-width="2" stroke-linecap="round"/>
      <line x1="14" y1="44" x2="36" y2="44" stroke="#000" stroke-width="2" stroke-linecap="round"/>
    </svg>`
  },
  {
    type: "keep_dry",
    label: "Влага",
    icon: Umbrella,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <line x1="25" y1="4" x2="25" y2="10" stroke="#000" stroke-width="2"/>
      <path d="M6 22 Q6 8 25 8 Q44 8 44 22 Z" fill="none" stroke="#000" stroke-width="2"/>
      <path d="M25 22 L25 38 Q25 42 21 42" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round"/>
      <circle cx="11" cy="30" r="2" fill="#000"/>
      <circle cx="25" cy="34" r="2" fill="#000"/>
      <circle cx="39" cy="30" r="2" fill="#000"/>
      <circle cx="17" cy="40" r="2" fill="#000"/>
      <circle cx="33" cy="40" r="2" fill="#000"/>
    </svg>`
  },
  {
    type: "keep_away_heat",
    label: "Нагрев",
    icon: Flame,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <circle cx="25" cy="13" r="5" fill="none" stroke="#000" stroke-width="2"/>
      <line x1="25" y1="3" x2="25" y2="6" stroke="#000" stroke-width="2"/>
      <line x1="25" y1="20" x2="25" y2="23" stroke="#000" stroke-width="2"/>
      <line x1="14" y1="13" x2="17" y2="13" stroke="#000" stroke-width="2"/>
      <line x1="33" y1="13" x2="36" y2="13" stroke="#000" stroke-width="2"/>
      <line x1="17" y1="5" x2="19" y2="8" stroke="#000" stroke-width="2"/>
      <line x1="33" y1="5" x2="31" y2="8" stroke="#000" stroke-width="2"/>
      <line x1="17" y1="21" x2="19" y2="18" stroke="#000" stroke-width="2"/>
      <line x1="33" y1="21" x2="31" y2="18" stroke="#000" stroke-width="2"/>
      <path d="M8 46 L8 34 L25 26 L42 34 L42 46" fill="none" stroke="#000" stroke-width="2" stroke-linejoin="round"/>
    </svg>`
  },
  {
    type: "this_side_up",
    label: "Верх",
    icon: ArrowUp,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <polygon points="25,4 36,16 29,16 29,22 21,22 21,16 14,16" fill="none" stroke="#000" stroke-width="2" stroke-linejoin="round"/>
      <polygon points="25,26 36,38 29,38 29,44 21,44 21,38 14,38" fill="none" stroke="#000" stroke-width="2" stroke-linejoin="round"/>
    </svg>`
  },
  {
    type: "keep_frozen",
    label: "Заморозка",
    icon: Snowflake,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <rect x="16" y="12" width="10" height="24" rx="5" fill="none" stroke="#000" stroke-width="2"/>
      <circle cx="21" cy="32" r="5" fill="none" stroke="#000" stroke-width="2"/>
      <circle cx="21" cy="32" r="3" fill="#000"/>
      <line x1="21" y1="29" x2="21" y2="18" stroke="#000" stroke-width="2"/>
      <line x1="36" y1="12" x2="36" y2="28" stroke="#000" stroke-width="1.5"/>
      <line x1="28" y1="20" x2="44" y2="20" stroke="#000" stroke-width="1.5"/>
      <line x1="30" y1="14" x2="42" y2="26" stroke="#000" stroke-width="1.5"/>
      <line x1="42" y1="14" x2="30" y2="26" stroke="#000" stroke-width="1.5"/>
      <line x1="8" y1="44" x2="44" y2="44" stroke="#000" stroke-width="2"/>
      <text x="12" y="42" font-size="8" font-family="Arial, sans-serif" fill="#000">-18°C</text>
    </svg>`
  },
  {
    type: "warning",
    label: "Внимание",
    icon: AlertTriangle,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <polygon points="25,5 46,44 4,44" fill="none" stroke="#000" stroke-width="2.5" stroke-linejoin="round"/>
      <line x1="25" y1="17" x2="25" y2="30" stroke="#000" stroke-width="3" stroke-linecap="round"/>
      <circle cx="25" cy="37" r="2.5" fill="#000"/>
    </svg>`
  },
  {
    type: "do_not_stack",
    label: "Не штабелировать",
    icon: Package,
    svg: `<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
      <rect x="10" y="28" width="30" height="16" fill="none" stroke="#000" stroke-width="2"/>
      <rect x="14" y="14" width="22" height="12" fill="none" stroke="#000" stroke-width="2"/>
      <line x1="6" y1="6" x2="44" y2="44" stroke="#000" stroke-width="2.5"/>
    </svg>`
  },
];


interface CustomIcon {
  type: string;
  label: string;
  imageUrl: string;
}


const CUSTOM_ICONS_STORAGE_KEY = "mes_label_custom_icons";

const snap = (v: number) => Math.round(v / SNAP_MM) * SNAP_MM;
const round2 = (v: number) => Math.round(v * 100) / 100;


export const LabelConstructor: React.FC<Props> = ({
  initialName = "Новый шаблон",
  initialWidth = 105,
  initialHeight = 60,
  initialLayout = [],
  onSave,
  onClose,
}) => {

  const [name, setName] = useState(initialName);
  const [size, setSize] = useState({ w: initialWidth, h: initialHeight });


  const normalizedLayout = useMemo(() => {
    return initialLayout.map(el => ({
      ...el,
      fontFamily: el.fontFamily || "Arial, sans-serif",
    }));
  }, [initialLayout]);

  const [elements, setElements] = useState<LabelElement[]>(normalizedLayout);


  useEffect(() => {
    setElements(normalizedLayout);
  }, [normalizedLayout]);
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [zoom, setZoom] = useState(1.5);
  const [_showQrHelper, setShowQrHelper] = useState(false);
  const [showIconPicker, setShowIconPicker] = useState(false);
  const [_showCounterPreview, _setShowCounterPreview] = useState(false);
  const [showHelp, setShowHelp] = useState(false);


  const [fontSizeInput, setFontSizeInput] = useState<string>('');
  const [isEditingFontSize, setIsEditingFontSize] = useState(false);


  const [customIcons, setCustomIcons] = useState<CustomIcon[]>(() => {
    try {
      const saved = localStorage.getItem(CUSTOM_ICONS_STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch {
      return [];
    }
  });


  const [customFonts, setCustomFonts] = useState<CustomFont[]>(() => {
    try {
      const saved = localStorage.getItem(CUSTOM_FONTS_STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch {
      return [];
    }
  });


  useEffect(() => {
    localStorage.setItem(CUSTOM_ICONS_STORAGE_KEY, JSON.stringify(customIcons));
  }, [customIcons]);


  useEffect(() => {
    localStorage.setItem(CUSTOM_FONTS_STORAGE_KEY, JSON.stringify(customFonts));


    customFonts.forEach((font) => {
      const styleId = `custom-font-${font.name.replace(/\s+/g, '-')}`;
      if (!document.getElementById(styleId)) {
        const style = document.createElement('style');
        style.id = styleId;
        style.textContent = `
          @font-face {
            font-family: '${font.name}';
            src: url(${font.fontDataUrl});
          }
        `;
        document.head.appendChild(style);
      }
    });
  }, [customFonts]);


  const elementRefs = useRef<Map<string, HTMLDivElement>>(new Map());
  const fileInputRef = useRef<HTMLInputElement>(null);
  const iconUploadRef = useRef<HTMLInputElement>(null);
  const fontUploadRef = useRef<HTMLInputElement>(null);

  const stateRef = useRef({ elements, zoom, selectedId });
  useEffect(() => {
    stateRef.current = { elements, zoom, selectedId };
  }, [elements, zoom, selectedId]);


  const dragInfo = useRef<{
    active: boolean;
    mode: "MOVE" | "RESIZE" | null;
    elId: string | null;
    startX: number;
    startY: number;
    initialItem: LabelElement | null;
  }>({
    active: false,
    mode: null,
    elId: null,
    startX: 0,
    startY: 0,
    initialItem: null,
  });

  useEffect(() => {
    const handlePointerMove = (e: PointerEvent) => {
      if (!dragInfo.current.active || !dragInfo.current.elId || !dragInfo.current.initialItem) return;

      const { startX, startY, initialItem, mode, elId } = dragInfo.current;
      const currentZoom = stateRef.current.zoom;

      const deltaXScreen = e.clientX - startX;
      const deltaYScreen = e.clientY - startY;

      const deltaXMm = deltaXScreen / (PX_PER_MM * currentZoom);
      const deltaYMm = deltaYScreen / (PX_PER_MM * currentZoom);

      const useSnap = e.shiftKey;

      let newX = initialItem.x;
      let newY = initialItem.y;
      let newW = initialItem.width;
      let newH = initialItem.height;

      if (mode === "MOVE") {
        newX = initialItem.x + deltaXMm;
        newY = initialItem.y + deltaYMm;

        if (useSnap) {
          newX = snap(newX);
          newY = snap(newY);
        } else {
          newX = round2(newX);
          newY = round2(newY);
        }

        if (newX < 0) newX = 0;
        if (newY < 0) newY = 0;
      } else if (mode === "RESIZE") {
        newW = initialItem.width + deltaXMm;
        newH = initialItem.height + deltaYMm;

        if (useSnap) {
          newW = snap(newW);
          newH = snap(newH);
        } else {
          newW = round2(newW);
          newH = round2(newH);
        }

        if (newW < MIN_MM) newW = MIN_MM;
        if (newH < MIN_MM) newH = MIN_MM;
      }

      const node = elementRefs.current.get(elId);
      if (node) {
        node.style.left = `${newX * PX_PER_MM * currentZoom}px`;
        node.style.top = `${newY * PX_PER_MM * currentZoom}px`;
        node.style.width = `${newW * PX_PER_MM * currentZoom}px`;
        node.style.height = `${newH * PX_PER_MM * currentZoom}px`;

        const tooltip = node.querySelector(".resize-tooltip") as HTMLElement;
        if (tooltip) {
          tooltip.textContent = `${newW.toFixed(1)} × ${newH.toFixed(1)} мм`;
        }

        (node as any).dataset.lastMm = JSON.stringify({ x: newX, y: newY, w: newW, h: newH });
      }
    };

    const handlePointerUp = () => {
      if (!dragInfo.current.active) return;

      const { elId, mode, initialItem } = dragInfo.current;
      const node = elId ? elementRefs.current.get(elId) : null;

      if (node && elId) {
        const lastMm = (node as any).dataset.lastMm;
        const finalData = lastMm ? JSON.parse(lastMm) : { x: initialItem?.x, y: initialItem?.y, w: initialItem?.width, h: initialItem?.height };

        setElements((prev) =>
          prev.map((el) => {
            if (el.id === elId) {
              const updated = { ...el, x: finalData.x, y: finalData.y, width: finalData.w, height: finalData.h };

              if (mode === "RESIZE" && el.type === "TEXT" && initialItem?.height !== finalData.h) {
                updated.fontSize = Math.max(6, Math.round(finalData.h * 2.8));
              }
              return updated;
            }
            return el;
          })
        );

        delete (node as any).dataset.lastMm;
      }

      dragInfo.current = {
        active: false,
        mode: null,
        elId: null,
        startX: 0,
        startY: 0,
        initialItem: null,
      };
    };

    window.addEventListener("pointermove", handlePointerMove);
    window.addEventListener("pointerup", handlePointerUp);

    return () => {
      window.removeEventListener("pointermove", handlePointerMove);
      window.removeEventListener("pointerup", handlePointerUp);
    };
  }, []);

  const handleStartDrag = (e: React.PointerEvent, id: string, mode: "MOVE" | "RESIZE") => {
    if (e.button !== 0) return;
    e.preventDefault();
    e.stopPropagation();

    const el = elements.find((x) => x.id === id);
    if (!el) return;

    setSelectedId(id);

    dragInfo.current = {
      active: true,
      mode,
      elId: id,
      startX: e.clientX,
      startY: e.clientY,
      initialItem: { ...el },
    };
  };


  const addElement = (type: LabelElementType, extra: Partial<LabelElement> = {}) => {
    const id = Date.now().toString() + Math.random().toString().slice(2, 6);

    const defaultSizes: Record<LabelElementType, { w: number; h: number }> = {
      TEXT: { w: 30, h: 10 },
      QR: { w: 20, h: 20 },
      LINE: { w: 30, h: 2 },
      RECTANGLE: { w: 30, h: 20 },
      IMAGE: { w: 20, h: 20 },
      COUNTER: { w: 25, h: 8 },
      ICON: { w: 15, h: 15 },
    };

    const defaults = defaultSizes[type] || { w: 20, h: 20 };

    const newEl: LabelElement = {
      id,
      type,
      x: 5,
      y: 5,
      width: defaults.w,
      height: defaults.h,
      fontSize: 10,
      fontFamily: "Arial, sans-serif",
      strokeWidth: 0.3,
      align: "left",
      isBold: false,
      content: type === "TEXT" ? "Текст" : type === "QR" ? "{{code}}" : type === "COUNTER" ? "{{current}} / {{total}}" : "",
      qrSource: type === "QR" ? "code" : undefined,
      qrDescription: type === "QR" ? "Код товара" : undefined,
      counterFormat: type === "COUNTER" ? "{{current}} / {{total}}" : undefined,
      ...extra,
    };

    setElements((prev) => {
      if (type === "RECTANGLE" || type === "LINE") return [newEl, ...prev];
      return [...prev, newEl];
    });

    setSelectedId(id);
  };

  const updateSelected = (updates: Partial<LabelElement>) => {
    if (!selectedId) return;
    setElements((prev) => prev.map((el) => (el.id === selectedId ? { ...el, ...updates } : el)));
  };

  const deleteSelected = () => {
    if (!selectedId) return;
    setElements((prev) => prev.filter((el) => el.id !== selectedId));
    setSelectedId(null);
  };


  const handleImageUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      toast.error("Выберите файл изображения");
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const dataUrl = event.target?.result as string;
      addElement("IMAGE", {
        imageUrl: dataUrl,
        imageName: file.name,
        width: 20,
        height: 20,
      });
      toast.success(`Изображение "${file.name}" добавлено`);
    };
    reader.readAsDataURL(file);

    e.target.value = "";
  }, []);


  const handleIconUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      toast.error("Выберите файл изображения");
      return;
    }

    if (file.size > 100 * 1024) {
      toast.error("Иконка слишком большая (макс. 100KB)");
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const dataUrl = event.target?.result as string;
      const iconName = file.name.replace(/\.[^.]+$/, "");
      const iconType = `custom_${Date.now()}`;

      setCustomIcons(prev => [...prev, {
        type: iconType,
        label: iconName,
        imageUrl: dataUrl,
      }]);

      toast.success(`Иконка "${iconName}" добавлена в библиотеку`);
    };
    reader.readAsDataURL(file);

    e.target.value = "";
  }, []);


  const deleteCustomIcon = useCallback((iconType: string) => {
    setCustomIcons(prev => prev.filter(i => i.type !== iconType));
    toast.success("Иконка удалена из библиотеки");
  }, []);


  const handleFontUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const ext = file.name.split('.').pop()?.toLowerCase();
    if (!['ttf', 'otf', 'woff', 'woff2'].includes(ext || '')) {
      toast.error("Поддерживаются только TTF, OTF, WOFF, WOFF2");
      return;
    }

    if (file.size > 2 * 1024 * 1024) {
      toast.error("Максимальный размер шрифта 2MB");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const fontDataUrl = reader.result as string;
      const fontName = file.name.replace(/\.(ttf|otf|woff|woff2)$/i, '');

      if (customFonts.find(f => f.name === fontName)) {
        toast.error("Шрифт с таким именем уже загружен");
        return;
      }

      setCustomFonts((prev) => [...prev, {
        name: fontName,
        fontFamily: `'${fontName}', sans-serif`,
        fontDataUrl,
      }]);
      toast.success(`Шрифт "${fontName}" загружен`);
    };
    reader.readAsDataURL(file);
    e.target.value = "";
  }, [customFonts]);


  const _deleteCustomFont = useCallback((fontName: string) => {
    setCustomFonts((prev) => prev.filter((f) => f.name !== fontName));
    const styleEl = document.getElementById(`custom-font-${fontName.replace(/\s+/g, '-')}`);
    if (styleEl) styleEl.remove();
    toast.success("Шрифт удалён");
  }, []);

  const activeElement = elements.find((el) => el.id === selectedId);

  const gridBgSize = PX_PER_MM * zoom * 5;


  const getQrDisplayInfo = (el: LabelElement) => {
    const source = QR_SOURCES.find(s => s.value === el.qrSource);
    return source || QR_SOURCES[0];
  };

  return (
    <div className="flex flex-col h-[90vh] bg-gradient-to-br from-slate-100 to-slate-200 font-sans text-slate-800 rounded-xl overflow-hidden shadow-2xl border border-slate-300 select-none">

      <input
        ref={fileInputRef}
        type="file"
        accept="image/*"
        className="hidden"
        onChange={handleImageUpload}
      />


      <input
        ref={iconUploadRef}
        type="file"
        accept="image/*"
        className="hidden"
        onChange={handleIconUpload}
      />


      <input
        ref={fontUploadRef}
        type="file"
        accept=".ttf,.otf,.woff,.woff2"
        className="hidden"
        onChange={handleFontUpload}
      />


      <div className="h-auto min-h-[64px] bg-white border-b flex flex-wrap items-center px-4 py-2 justify-between shrink-0 z-20 shadow-sm gap-2">

        <div className="flex gap-1 flex-wrap">
          <ToolBtn icon={<Type />} label="Текст" onClick={() => addElement("TEXT")} />


          <div className="relative">
            <ToolBtn
              icon={<QrCode />}
              label="QR"
              onClick={() => {
                addElement("QR", { width: 20, height: 20 });
                setShowQrHelper(true);
              }}
            />
          </div>


          <ToolBtn
            icon={<Hash />}
            label="Счётчик"
            onClick={() => addElement("COUNTER", { width: 25, height: 8 })}
            title="Нумерация этикеток: 1/100, 2/100..."
          />

          <div className="w-px h-8 bg-slate-200 mx-1 self-center"></div>


          <ToolBtn
            icon={<Upload />}
            label="Картинка"
            onClick={() => fileInputRef.current?.click()}
            title="Загрузить своё изображение"
          />


          <div className="relative">
            <ToolBtn
              icon={<Library />}
              label="Иконки"
              onClick={() => setShowIconPicker(!showIconPicker)}
              title="Стандартные символы для этикеток"
            />


            {showIconPicker && (
              <div className="absolute top-full left-0 mt-1 bg-white rounded-xl shadow-2xl border border-slate-200 p-3 z-50 w-72 max-h-96 overflow-y-auto">

                <div className="text-xs font-bold text-slate-500 mb-2 uppercase">Стандартные символы (ГОСТ 14192)</div>
                <div className="grid grid-cols-4 gap-2 mb-3">
                  {DEFAULT_ICON_LIBRARY.map((iconItem) => (
                    <button
                      key={iconItem.type}
                      onClick={() => {
                        addElement("ICON", {
                          iconType: iconItem.type,
                          content: iconItem.label,
                          width: 15,
                          height: 15
                        });
                        setShowIconPicker(false);
                      }}
                      className="flex flex-col items-center p-2 hover:bg-indigo-50 rounded-lg transition-colors group border border-transparent hover:border-indigo-200"
                      title={iconItem.label}
                    >
                      <div
                        className="w-8 h-8"
                        dangerouslySetInnerHTML={{ __html: iconItem.svg }}
                      />
                      <span className="text-[8px] mt-1 text-slate-500 group-hover:text-indigo-600 text-center leading-tight">
                        {iconItem.label}
                      </span>
                    </button>
                  ))}
                </div>


                {customIcons.length > 0 && (
                  <>
                    <div className="text-xs font-bold text-emerald-600 mb-2 uppercase border-t pt-2">Мои иконки</div>
                    <div className="grid grid-cols-4 gap-2 mb-3">
                      {customIcons.map((iconItem) => (
                        <div key={iconItem.type} className="relative group">
                          <button
                            onClick={() => {
                              addElement("ICON", {
                                iconType: iconItem.type,
                                content: iconItem.label,
                                imageUrl: iconItem.imageUrl,
                                width: 15,
                                height: 15
                              });
                              setShowIconPicker(false);
                            }}
                            className="flex flex-col items-center p-2 hover:bg-emerald-50 rounded-lg transition-colors w-full"
                            title={iconItem.label}
                          >
                            <img src={iconItem.imageUrl} alt={iconItem.label} className="w-6 h-6 object-contain" />
                            <span className="text-[8px] mt-1 text-slate-500 text-center leading-tight truncate w-full">
                              {iconItem.label}
                            </span>
                          </button>

                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteCustomIcon(iconItem.type);
                            }}
                            className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[10px] opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-600"
                            title="Удалить иконку"
                          >
                            ×
                          </button>
                        </div>
                      ))}
                    </div>
                  </>
                )}


                <button
                  onClick={() => iconUploadRef.current?.click()}
                  className="w-full flex items-center justify-center gap-2 p-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 transition-colors text-sm"
                >
                  <Upload size={16} />
                  <span>Загрузить свою иконку</span>
                </button>
                <div className="text-[10px] text-slate-400 text-center mt-1">PNG/SVG, макс. 100KB</div>
              </div>
            )}
          </div>

          <div className="w-px h-8 bg-slate-200 mx-1 self-center"></div>


          <ToolBtn
            icon={<Minus />}
            label="Линия"
            onClick={() => addElement("LINE", { width: 30, height: 0.5, strokeWidth: 0.3 })}
          />


          <ToolBtn
            icon={<Square />}
            label="Рамка"
            onClick={() => addElement("RECTANGLE", { strokeWidth: 0.3 })}
          />

          <div className="w-px h-8 bg-slate-200 mx-1 self-center"></div>


          <div className="flex items-center gap-1 bg-slate-50 rounded-lg px-2 py-1 border">
            <button onClick={() => setZoom((z) => Math.max(0.5, z - 0.25))} className="p-1 hover:bg-slate-200 rounded" type="button">
              <ZoomOut size={16} />
            </button>
            <span className="text-xs font-medium w-10 text-center tabular-nums">{Math.round(zoom * 100)}%</span>
            <button onClick={() => setZoom((z) => Math.min(3, z + 0.25))} className="p-1 hover:bg-slate-200 rounded" type="button">
              <ZoomIn size={16} />
            </button>
          </div>
        </div>


        <div className="flex items-center gap-2">
          <button
            onClick={() => setShowHelp(!showHelp)}
            className={clsx(
              "flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors",
              showHelp ? "bg-amber-100 text-amber-700 border border-amber-300" : "bg-slate-100 text-slate-600 hover:bg-slate-200"
            )}
            type="button"
          >
            <HelpCircle size={18} />
            <span className="hidden sm:inline">Справка</span>
          </button>

          {onClose && (
            <button
              onClick={onClose}
              className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
              title="Закрыть конструктор"
              type="button"
            >
              <X size={20} />
            </button>
          )}
        </div>
      </div>


      {activeElement && (
        <div className="bg-gradient-to-r from-indigo-50 to-violet-50 border-b px-4 py-3 shrink-0 z-10">
          <div className="flex items-center gap-3 flex-wrap">

            <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border border-indigo-200 shadow-sm">
              {activeElement.type === "TEXT" && <Type size={16} className="text-indigo-600" />}
              {activeElement.type === "QR" && <QrCode size={16} className="text-indigo-600" />}
              {activeElement.type === "IMAGE" && <ImageIcon size={16} className="text-indigo-600" />}
              {activeElement.type === "COUNTER" && <Hash size={16} className="text-indigo-600" />}
              {activeElement.type === "ICON" && <Library size={16} className="text-indigo-600" />}
              {(activeElement.type === "LINE" || activeElement.type === "RECTANGLE") && <Layers size={16} className="text-indigo-600" />}
              <span className="text-xs font-bold text-indigo-800 uppercase">
                {activeElement.type === "TEXT" && "Текст"}
                {activeElement.type === "QR" && "QR-код"}
                {activeElement.type === "IMAGE" && "Изображение"}
                {activeElement.type === "COUNTER" && "Счётчик"}
                {activeElement.type === "ICON" && "Иконка"}
                {activeElement.type === "LINE" && "Линия"}
                {activeElement.type === "RECTANGLE" && "Рамка"}
              </span>
            </div>


            {activeElement.type === "TEXT" && (
              <>

                <div className="relative shrink-0" style={{ width: '220px' }}>
                  <textarea
                    value={activeElement.content || ""}
                    onChange={(e) => updateSelected({ content: e.target.value })}
                    className="w-full text-sm px-3 py-2 border border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none bg-white shadow-sm resize-none"
                    placeholder="Введите текст..."
                    rows={1}
                    style={{
                      minHeight: '38px',
                      height: 'auto',
                      maxHeight: '80px',
                      overflow: 'auto'
                    }}
                    onInput={(e) => {
                      const target = e.target as HTMLTextAreaElement;
                      target.style.height = '38px';
                      target.style.height = Math.min(target.scrollHeight, 80) + 'px';
                    }}
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                  />
                </div>


                <div className="relative shrink-0">
                  <select
                    className="text-sm pl-3 pr-7 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none appearance-none"
                    style={{ width: '130px' }}
                    value=""
                    onChange={(e) => {
                      if (e.target.value) updateSelected({ content: (activeElement.content || "") + e.target.value });
                    }}
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                  >
                    <option value="">+ Переменная</option>
                    {TEXT_VARIABLES.filter(v => v.value).map((v) => (
                      <option key={v.value} value={v.value}>{v.label}</option>
                    ))}
                  </select>
                  <Database size={14} className="absolute right-2 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none" />
                </div>


                <div className="flex items-center gap-1 shrink-0">
                  <select
                    value={activeElement.fontFamily ?? "Arial, sans-serif"}
                    onChange={(e) => {
                      const newFont = e.target.value;
                      updateSelected({ fontFamily: newFont });
                    }}
                    className="text-sm px-2 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none shadow-sm"
                    style={{ width: '130px' }}
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                  >
                    <optgroup label="Стандартные">
                      <option value="Arial, sans-serif">Arial</option>
                      <option value="'Times New Roman', serif">Times New Roman</option>
                      <option value="'Courier New', monospace">Courier New</option>
                      <option value="Verdana, sans-serif">Verdana</option>
                      <option value="Tahoma, sans-serif">Tahoma</option>
                    </optgroup>
                    <optgroup label="ГОСТ">
                      <option value="'GOST type A', sans-serif">GOST type A</option>
                      <option value="'GOST type B', sans-serif">GOST type B</option>
                    </optgroup>
                    {customFonts.length > 0 && (
                      <optgroup label="Мои шрифты">
                        {customFonts.map((f) => (
                          <option key={f.name} value={f.fontFamily}>{f.name}</option>
                        ))}
                      </optgroup>
                    )}
                  </select>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      fontUploadRef.current?.click();
                    }}
                    className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                    title="Загрузить свой шрифт (TTF, OTF, WOFF)"
                    type="button"
                  >
                    <Upload size={16} />
                  </button>
                </div>


                <div className="flex items-center bg-white border border-indigo-200 rounded-lg overflow-hidden shadow-sm">
                  <button
                    onClick={() => updateSelected({ fontSize: Math.max(6, (activeElement.fontSize || 10) - 1) })}
                    className="px-3 py-2 hover:bg-slate-50 text-sm font-bold text-indigo-600"
                    type="button"
                  >
                    −
                  </button>
                  <input
                    type="text"
                    inputMode="numeric"
                    value={isEditingFontSize ? fontSizeInput : (activeElement.fontSize || 10)}
                    onFocus={(e) => {
                      setIsEditingFontSize(true);
                      setFontSizeInput(String(activeElement.fontSize || 10));
                      e.target.select();
                    }}
                    onChange={(e) => {

                      const value = e.target.value.replace(/[^0-9]/g, '');
                      setFontSizeInput(value);
                    }}
                    onBlur={() => {
                      setIsEditingFontSize(false);
                      const val = parseInt(fontSizeInput);
                      if (!isNaN(val) && val >= 6 && val <= 200) {
                        updateSelected({ fontSize: val });
                      }

                    }}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        e.currentTarget.blur();
                      }
                      if (e.key === 'Escape') {
                        setIsEditingFontSize(false);
                        setFontSizeInput('');
                      }
                    }}
                    className="w-14 text-sm font-bold text-center tabular-nums border-x border-indigo-100 py-2 outline-none focus:bg-indigo-50 focus:ring-2 focus:ring-indigo-300"
                    onPointerDown={(e) => e.stopPropagation()}
                  />
                  <button
                    onClick={() => updateSelected({ fontSize: Math.min(200, (activeElement.fontSize || 10) + 1) })}
                    className="px-3 py-2 hover:bg-slate-50 text-sm font-bold text-indigo-600"
                    type="button"
                  >
                    +
                  </button>
                </div>


                <button
                  onClick={() => updateSelected({ isBold: !activeElement.isBold })}
                  className={clsx(
                    "w-9 h-9 border rounded-lg flex items-center justify-center font-bold transition-all shadow-sm",
                    activeElement.isBold ? "bg-indigo-600 text-white border-indigo-600" : "bg-white border-indigo-200 hover:bg-slate-50"
                  )}
                  type="button"
                >
                  B
                </button>


                <div className="flex bg-white border border-indigo-200 rounded-lg overflow-hidden shadow-sm">
                  {["left", "center", "right"].map((align) => (
                    <button
                      key={align}
                      onClick={() => updateSelected({ align: align as "left" | "center" | "right" })}
                      className={clsx("p-2 hover:bg-slate-50", activeElement.align === align && "bg-indigo-100 text-indigo-700")}
                      type="button"
                    >
                      {align === "left" && <AlignLeft size={16} />}
                      {align === "center" && <AlignCenter size={16} />}
                      {align === "right" && <AlignRight size={16} />}
                    </button>
                  ))}
                </div>
              </>
            )}


            {activeElement.type === "QR" && (
              <div className="flex items-center gap-3 flex-wrap">
                <div className="flex flex-col gap-1">
                  <label className="text-[10px] font-bold text-indigo-600 uppercase">Что будет в QR:</label>
                  <select
                    value={activeElement.qrSource || "code"}
                    onChange={(e) => {
                      const source = QR_SOURCES.find(s => s.value === e.target.value);
                      if (source) {
                        updateSelected({
                          qrSource: e.target.value as any,
                          content: source.template,
                          qrDescription: source.label
                        });
                      }
                    }}
                    className="text-sm px-3 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none shadow-sm min-w-[180px]"
                    onPointerDown={(e) => e.stopPropagation()}
                  >
                    {QR_SOURCES.map((s) => (
                      <option key={s.value} value={s.value}>{s.label}</option>
                    ))}
                  </select>
                </div>

                {activeElement.qrSource === "custom" && (
                  <input
                    value={activeElement.content || ""}
                    onChange={(e) => updateSelected({ content: e.target.value })}
                    className="w-48 text-sm px-3 py-2 border border-indigo-200 rounded-lg focus:border-indigo-500 outline-none bg-white shadow-sm"
                    placeholder="Введите текст для QR..."
                    onPointerDown={(e) => e.stopPropagation()}
                  />
                )}


                <div className="flex items-start gap-2 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 max-w-sm">
                  <Info size={16} className="text-blue-500 shrink-0 mt-0.5" />
                  <div className="text-xs text-blue-700">
                    <div className="font-semibold">{getQrDisplayInfo(activeElement).description}</div>
                    <div className="text-blue-500 mt-0.5">Пример: {getQrDisplayInfo(activeElement).example}</div>
                  </div>
                </div>
              </div>
            )}


            {activeElement.type === "COUNTER" && (
              <div className="flex items-center gap-3 flex-wrap">
                <div className="flex flex-col gap-1">
                  <label className="text-[10px] font-bold text-indigo-600 uppercase">Формат нумерации:</label>
                  <select
                    value={activeElement.counterFormat || COUNTER_FORMATS[0].value}
                    onChange={(e) => updateSelected({ counterFormat: e.target.value, content: e.target.value })}
                    className="text-sm px-3 py-2 border border-indigo-200 rounded-lg bg-white cursor-pointer hover:border-indigo-400 outline-none shadow-sm min-w-[200px]"
                    onPointerDown={(e) => e.stopPropagation()}
                  >
                    {COUNTER_FORMATS.map((f) => (
                      <option key={f.value} value={f.value}>{f.label} — {f.description}</option>
                    ))}
                  </select>
                </div>

                <div className="flex items-center bg-white border border-indigo-200 rounded-lg overflow-hidden shadow-sm">
                  <button onClick={() => updateSelected({ fontSize: Math.max(6, (activeElement.fontSize || 14) - 1) })} className="px-3 py-2 hover:bg-slate-50 text-sm font-bold" type="button">−</button>
                  <span className="text-sm font-bold w-8 text-center tabular-nums border-x border-indigo-100">{activeElement.fontSize || 14}</span>
                  <button onClick={() => updateSelected({ fontSize: (activeElement.fontSize || 14) + 1 })} className="px-3 py-2 hover:bg-slate-50 text-sm font-bold" type="button">+</button>
                </div>

                <button
                  onClick={() => updateSelected({ isBold: !activeElement.isBold })}
                  className={clsx(
                    "w-9 h-9 border rounded-lg flex items-center justify-center font-bold transition-all shadow-sm",
                    activeElement.isBold ? "bg-indigo-600 text-white border-indigo-600" : "bg-white border-indigo-200 hover:bg-slate-50"
                  )}
                  type="button"
                >B</button>


                <div className="flex items-center gap-2 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2">
                  <Eye size={14} className="text-emerald-600" />
                  <span className="text-sm font-mono font-bold text-emerald-800">
                    {(activeElement.counterFormat || "{{current}} / {{total}}")
                      .replace("{{current}}", "1")
                      .replace("{{total}}", "100")}
                  </span>
                </div>
              </div>
            )}


            {activeElement.type === "IMAGE" && activeElement.imageName && (
              <div className="flex items-center gap-2 bg-slate-100 px-3 py-2 rounded-lg">
                <ImageIcon size={16} className="text-slate-500" />
                <span className="text-sm text-slate-600 truncate max-w-[200px]">{activeElement.imageName}</span>
              </div>
            )}


            {activeElement.type === "ICON" && (
              <div className="flex items-center gap-2 bg-slate-100 px-3 py-2 rounded-lg">
                <span className="text-sm font-medium text-slate-600">{activeElement.content || "Иконка"}</span>
              </div>
            )}


            {(activeElement.type === "LINE" || activeElement.type === "RECTANGLE") && (
              <div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-indigo-200 shadow-sm">
                <span className="text-xs text-indigo-900 font-medium">Толщина:</span>
                <input
                  type="number"
                  step={0.1}
                  min={0.1}
                  value={activeElement.strokeWidth}
                  onChange={(e) => updateSelected({ strokeWidth: parseFloat(e.target.value) })}
                  className="w-14 text-sm border-b border-indigo-300 px-1 py-0.5 text-center focus:outline-none focus:border-indigo-600 bg-transparent"
                  onPointerDown={(e) => e.stopPropagation()}
                />
                <span className="text-xs text-slate-400">мм</span>
              </div>
            )}

            <div className="flex-1"></div>


            <button
              onClick={deleteSelected}
              className="flex items-center gap-2 text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors border border-transparent hover:border-red-200"
              title="Удалить элемент"
              type="button"
            >
              <Trash2 size={18} />
              <span className="text-sm font-medium">Удалить</span>
            </button>
          </div>
        </div>
      )}


      {!activeElement && (
        <div className="bg-slate-50 border-b px-4 py-3 shrink-0">
          <div className="flex items-center gap-2 text-slate-400 text-sm">
            <MousePointer2 size={16} />
            <span>Выберите элемент на этикетке для редактирования или добавьте новый с панели инструментов</span>
          </div>
        </div>
      )}


      <div className="flex-1 flex overflow-hidden">

        <div
          className="flex-1 overflow-auto bg-slate-300/50 flex items-center justify-center relative touch-none p-8"
          style={{
            backgroundImage: "radial-gradient(circle, #94a3b8 1px, transparent 1px)",
            backgroundSize: "20px 20px",
          }}
          onPointerDown={() => {
            setSelectedId(null);
            setShowIconPicker(false);
          }}
        >
        <div
          className="bg-white shadow-2xl relative transition-transform duration-75 rounded-sm"
          style={{
            width: size.w * PX_PER_MM * zoom,
            height: size.h * PX_PER_MM * zoom,
            backgroundImage: "linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px)",
            backgroundSize: `${gridBgSize}px ${gridBgSize}px`,
          }}
          onPointerDown={(e) => e.stopPropagation()}
        >
          {elements.map((el, idx) => {
            const isSelected = selectedId === el.id;

            const style: React.CSSProperties = {
              left: `${el.x * PX_PER_MM * zoom}px`,
              top: `${el.y * PX_PER_MM * zoom}px`,
              width: `${el.width * PX_PER_MM * zoom}px`,
              height: `${el.height * PX_PER_MM * zoom}px`,
              zIndex: isSelected ? 9999 : idx + 1,
            };

            const strokePx = (el.strokeWidth || 0.1) * PX_PER_MM * zoom;

            return (
              <div
                key={el.id}
                ref={(node) => {
                  if (node) elementRefs.current.set(el.id, node);
                  else elementRefs.current.delete(el.id);
                }}
                className={clsx(
                  "absolute box-border transition-shadow",
                  isSelected
                    ? "outline outline-2 outline-indigo-500 shadow-lg shadow-indigo-200/50"
                    : "hover:outline hover:outline-1 hover:outline-indigo-300"
                )}
                style={style}
                onPointerDown={(e) => handleStartDrag(e, el.id, "MOVE")}
              >

                {el.type === "TEXT" && (
                  <div
                    className="w-full h-full whitespace-pre-wrap break-words leading-none pointer-events-none overflow-hidden"
                    style={{
                      fontSize: `${(el.fontSize || 10) * PX_PER_MM * zoom * 0.35}px`,
                      fontWeight: el.isBold ? "bold" : "normal",
                      fontFamily: el.fontFamily || "Arial, sans-serif",
                      textAlign: el.align,
                      color: "#1e293b",
                    }}
                  >
                    {el.content}
                  </div>
                )}


                {el.type === "QR" && (
                  <div className="w-full h-full p-[2px] pointer-events-none flex items-center justify-center bg-white rounded-sm">
                    <QRCode value={el.content || "QR"} style={{ width: "100%", height: "100%" }} viewBox="0 0 256 256" />
                  </div>
                )}


                {el.type === "IMAGE" && (
                  <div className="w-full h-full pointer-events-none flex items-center justify-center bg-slate-50 rounded-sm overflow-hidden">
                    {el.imageUrl ? (
                      <img src={el.imageUrl} alt={el.imageName || "Image"} className="w-full h-full object-contain" />
                    ) : (
                      <ImageIcon size={24} className="text-slate-300" />
                    )}
                  </div>
                )}


                {el.type === "COUNTER" && (
                  <div
                    className="w-full h-full whitespace-nowrap pointer-events-none flex items-center justify-center overflow-hidden"
                    style={{
                      fontSize: `${(el.fontSize || 14) * PX_PER_MM * zoom * 0.35}px`,
                      fontWeight: el.isBold ? "bold" : "normal",
                      color: "#1e293b",
                      fontFamily: "monospace",
                    }}
                  >
                    {(el.counterFormat || "{{current}} / {{total}}")
                      .replace("{{current}}", "1")
                      .replace("{{total}}", "100")}
                  </div>
                )}


                {el.type === "ICON" && (
                  <div className="w-full h-full pointer-events-none flex items-center justify-center p-0.5">
                    {(() => {
                      const iconData = DEFAULT_ICON_LIBRARY.find(i => i.type === el.iconType);
                      if (iconData && iconData.svg) {
                        return (
                          <div
                            className="w-full h-full"
                            dangerouslySetInnerHTML={{ __html: iconData.svg }}
                          />
                        );
                      }

                      if (el.imageUrl) {
                        return <img src={el.imageUrl} alt={el.content || 'Icon'} className="w-full h-full object-contain" />;
                      }

                      const customIcon = customIcons.find(i => i.type === el.iconType);
                      if (customIcon) {
                        return <img src={customIcon.imageUrl} alt={customIcon.label} className="w-full h-full object-contain" />;
                      }

                      return <AlertTriangle size={20} className="text-slate-400" />;
                    })()}
                  </div>
                )}


                {(el.type === "LINE" || el.type === "RECTANGLE") && (
                  <svg className="w-full h-full pointer-events-none overflow-visible" xmlns="http://www.w3.org/2000/svg">
                    {el.type === "RECTANGLE" ? (
                      <rect x="0" y="0" width="100%" height="100%" fill="none" stroke="black" strokeWidth={strokePx} vectorEffect="non-scaling-stroke" />
                    ) : el.width >= el.height ? (
                      <line x1="0" y1="50%" x2="100%" y2="50%" stroke="black" strokeWidth={strokePx} vectorEffect="non-scaling-stroke" />
                    ) : (
                      <line x1="50%" y1="0" x2="50%" y2="100%" stroke="black" strokeWidth={strokePx} vectorEffect="non-scaling-stroke" />
                    )}
                  </svg>
                )}


                {isSelected && (
                  <>
                    <div
                      className="absolute -bottom-2 -right-2 w-5 h-5 bg-indigo-600 rounded-full cursor-nwse-resize flex items-center justify-center shadow-lg hover:scale-110 transition-transform z-50"
                      onPointerDown={(e) => handleStartDrag(e, el.id, "RESIZE")}
                    >
                      <GripHorizontal size={12} className="text-white -rotate-45" />
                    </div>

                    <div className="resize-tooltip absolute -top-7 left-0 bg-indigo-600 text-white text-[10px] px-2 py-1 rounded-md opacity-90 pointer-events-none whitespace-nowrap shadow-md font-mono">
                      {el.width.toFixed(1)} × {el.height.toFixed(1)} мм
                    </div>


                    <div className="absolute -top-7 right-0 bg-slate-700 text-white text-[9px] px-1.5 py-0.5 rounded opacity-80 pointer-events-none uppercase font-bold">
                      {el.type === "QR" && el.qrSource && `QR: ${QR_SOURCES.find(s => s.value === el.qrSource)?.label || el.qrSource}`}
                      {el.type === "COUNTER" && "Счётчик"}
                      {el.type === "IMAGE" && "Картинка"}
                      {el.type === "ICON" && el.content}
                    </div>
                  </>
                )}
              </div>
            );
          })}
        </div>
      </div>


      {showHelp && (
        <div className="w-80 bg-white border-l border-slate-200 overflow-y-auto shrink-0 shadow-lg">
          <div className="sticky top-0 bg-gradient-to-r from-amber-50 to-orange-50 border-b px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <BookOpen size={20} className="text-amber-600" />
              <span className="font-bold text-amber-900">Справка</span>
            </div>
            <button
              onClick={() => setShowHelp(false)}
              className="p-1 hover:bg-amber-100 rounded text-amber-600"
              type="button"
            >
              <X size={18} />
            </button>
          </div>

          <div className="p-4 space-y-5 text-sm">

            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Database size={18} className="text-indigo-500" />
                Переменные (подставятся автоматически)
              </h3>
              <div className="space-y-2">
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{code}}"}</code>
                  <p className="text-slate-600 mt-1">Уникальный код товара</p>
                  <p className="text-slate-400 text-xs mt-1">Пример: 7342511000501</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{name}}"}</code>
                  <p className="text-slate-600 mt-1">Наименование товара</p>
                  <p className="text-slate-400 text-xs mt-1">Пример: Приёмник 2xLR1121</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{contract}}"}</code>
                  <p className="text-slate-600 mt-1">Номер госконтракта</p>
                  <p className="text-slate-400 text-xs mt-1">Пример: № 249/2/ОП/25/1/37</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{date}}"}</code>
                  <p className="text-slate-600 mt-1">Текущая дата</p>
                  <p className="text-slate-400 text-xs mt-1">Пример: 20.01.2026, 15:30</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{quantity}}"}</code>
                  <p className="text-slate-600 mt-1">Количество</p>
                  <p className="text-slate-400 text-xs mt-1">Пример: 500</p>
                </div>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                  <code className="text-blue-700 font-bold text-sm">{"{{unit}}"}</code>
                  <p className="text-slate-600 mt-1">Единица измерения</p>
                  <p className="text-slate-400 text-xs mt-1">Пример: шт.</p>
                </div>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Hash size={18} className="text-emerald-500" />
                Счётчик (нумерация этикеток)
              </h3>
              <div className="bg-emerald-50 p-3 rounded-lg border border-emerald-100 space-y-2">
                <p className="text-slate-600">При печати 100 этикеток:</p>
                <div className="grid grid-cols-2 gap-2 text-xs">
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">1 / 100</span>
                    <span className="text-slate-400 ml-2">← первая</span>
                  </div>
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">2 / 100</span>
                    <span className="text-slate-400 ml-2">← вторая</span>
                  </div>
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">...</span>
                  </div>
                  <div className="bg-white p-2 rounded border">
                    <span className="text-emerald-700 font-mono">100 / 100</span>
                    <span className="text-slate-400 ml-2">← последняя</span>
                  </div>
                </div>
                <div className="mt-2 text-xs text-slate-500">
                  <code className="text-emerald-600">{"{{current}}"}</code> — номер текущей этикетки<br/>
                  <code className="text-emerald-600">{"{{total}}"}</code> — всего этикеток в тираже
                </div>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <QrCode size={18} className="text-violet-500" />
                QR-код
              </h3>
              <div className="bg-violet-50 p-3 rounded-lg border border-violet-100">
                <p className="text-slate-600">При добавлении QR выберите, что в нём будет закодировано:</p>
                <ul className="mt-2 text-xs text-slate-600 space-y-1">
                  <li>• <strong>Код товара</strong> — уникальный идентификатор</li>
                  <li>• <strong>Серийный номер</strong> — для отслеживания</li>
                  <li>• <strong>Госконтракт</strong> — номер договора</li>
                  <li>• <strong>Ссылка</strong> — URL для сканирования</li>
                  <li>• <strong>Свой текст</strong> — любой текст</li>
                </ul>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Library size={18} className="text-orange-500" />
                Иконки маркировки
              </h3>
              <div className="bg-orange-50 p-3 rounded-lg border border-orange-100">
                <p className="text-slate-600 mb-2">Стандартные символы по ГОСТ:</p>
                <div className="grid grid-cols-2 gap-2 text-xs">
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Wine size={16} className="text-slate-600" />
                    <span>Хрупкое</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Umbrella size={16} className="text-slate-600" />
                    <span>Влага</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Flame size={16} className="text-slate-600" />
                    <span>Нагрев</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <ArrowUp size={16} className="text-slate-600" />
                    <span>Верх</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <Snowflake size={16} className="text-slate-600" />
                    <span>Заморозка</span>
                  </div>
                  <div className="flex items-center gap-2 bg-white p-2 rounded border">
                    <AlertTriangle size={16} className="text-slate-600" />
                    <span>Внимание</span>
                  </div>
                </div>
                <p className="text-slate-500 text-xs mt-2">+ можно загрузить свои иконки</p>
              </div>
            </div>


            <div>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-base">
                <Info size={18} className="text-cyan-500" />
                Советы
              </h3>
              <div className="bg-cyan-50 p-3 rounded-lg border border-cyan-100 text-xs text-slate-600 space-y-2">
                <p>• <strong>Shift + тянуть</strong> — привязка к сетке 5мм</p>
                <p>• Выберите элемент, чтобы изменить его свойства</p>
                <p>• Переменные в двойных скобках <code className="text-cyan-700">{"{{}}"}</code> заменятся при печати</p>
                <p>• Сохраните шаблон, чтобы использовать повторно</p>
              </div>
            </div>
          </div>
        </div>
      )}
      </div>


      <div className="bg-white border-t px-4 py-3 flex items-center justify-between shrink-0 z-20 gap-4 flex-wrap">
        <div className="flex gap-4 text-sm items-center">
          <label className="flex items-center gap-2 text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border">
            <span className="font-bold text-indigo-600">Ш:</span>
            <input
              type="number"
              value={size.w}
              onChange={(e) => setSize({ ...size, w: +e.target.value })}
              className="bg-transparent w-12 text-center outline-none font-medium"
            />
            <span className="text-slate-400">мм</span>
          </label>
          <label className="flex items-center gap-2 text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border">
            <span className="font-bold text-indigo-600">В:</span>
            <input
              type="number"
              value={size.h}
              onChange={(e) => setSize({ ...size, h: +e.target.value })}
              className="bg-transparent w-12 text-center outline-none font-medium"
            />
            <span className="text-slate-400">мм</span>
          </label>
          <span className="text-slate-400 hidden sm:inline">Shift = привязка к сетке</span>
        </div>

        <div className="flex gap-3 items-center">
          <input
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="border rounded-lg px-4 py-2 text-sm w-56 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all"
            placeholder="Название шаблона..."
          />
          <button
            onClick={() => {
              if (!onSave) {
                toast.error("onSave не передан");
                return;
              }
              onSave(name, size.w, size.h, elements);
              toast.success("Шаблон сохранён!");
            }}
            className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-indigo-200 transition-all active:scale-95"
            type="button"
          >
            <Save size={18} /> Сохранить
          </button>
        </div>
      </div>
    </div>
  );
};


const ToolBtn = ({ icon, label, onClick, title }: { icon: React.ReactElement; label: string; onClick: () => void; title?: string }) => (
  <button
    onClick={onClick}
    type="button"
    title={title}
    className="flex flex-col items-center justify-center w-14 h-14 hover:bg-indigo-50 text-slate-500 hover:text-indigo-600 rounded-xl transition-all group border border-transparent hover:border-indigo-200"
  >
    <div className="group-hover:-translate-y-0.5 transition-transform">
      {React.cloneElement(icon, { size: 22 })}
    </div>
    <span className="text-[10px] mt-1 font-medium">{label}</span>
  </button>
);

export default LabelConstructor;

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/components/LabelPreview.tsx
================================================================================

import React from "react";
import QRCode from "react-qr-code";

interface LabelPreviewProps {
  label: string;
  project: string;
  batch: string;
  id: string;
  qrValue: string;
  qty: number;
  unit: string;
  isPartial?: boolean;
}

export const LabelPreview: React.FC<LabelPreviewProps> = ({ label, project, batch, id, qrValue, qty, unit, isPartial }) => (
  <div className={`border-2 ${isPartial ? 'border-amber-500 bg-amber-50/30' : 'border-gray-800 bg-white'} rounded-lg p-3 w-full max-w-[280px] shadow-xl relative overflow-hidden group transition-all hover:scale-[1.02]`}>
      {isPartial && <div className="absolute top-0 right-0 bg-amber-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl shadow-sm">ОСТАТОК</div>}
      <div className="flex gap-3 items-center">
          <div className="bg-white p-1 rounded border border-gray-100">
             {qrValue ? <QRCode value={qrValue} size={70} /> : <div className="w-[70px] h-[70px] bg-gray-100 animate-pulse rounded"/>}
          </div>
          <div className="flex-1 text-left overflow-hidden">
              <div className="text-[9px] font-bold text-gray-400 uppercase tracking-wider flex justify-between">
                  <span>{batch || "БЕЗ ПАРТИИ"}</span>
              </div>
              <div className="text-sm font-black text-gray-900 leading-tight mb-1 line-clamp-2 mt-0.5">
                  {label || "Изделие"}
              </div>
              <div className="text-[10px] text-gray-500 truncate mb-1 bg-gray-100 px-1 rounded w-max max-w-full">
                  {project || "Без проекта"}
              </div>
              <div className="flex items-center justify-between border-t border-gray-200 pt-1.5 mt-1">
                  <span className="font-mono text-[9px] text-gray-400">ID: {id || "..."}</span>
                  <span className={`text-xs font-bold px-1.5 py-0.5 rounded ${isPartial ? 'bg-amber-100 text-amber-800' : 'bg-black text-white'}`}>
                      {qty} {unit}
                  </span>
              </div>
          </div>
      </div>
  </div>
);
================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/components/ProjectDashboard.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchStockBalance } from "src/api/warehouseApi";
import { StockBalanceItem } from "src/types/WarehouseModels";
import { Loader2 } from "lucide-react";

export const ProjectDashboard: React.FC = () => {
    const [topItems, setTopItems] = useState<StockBalanceItem[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {

        fetchStockBalance()
            .then(data => {

                const sorted = data.sort((a, b) => Number(b.totalQuantity) - Number(a.totalQuantity)).slice(0, 3);
                setTopItems(sorted);
            })
            .catch(console.error)
            .finally(() => setLoading(false));
    }, []);

    if (loading) return <div className="flex items-center text-sm text-gray-400"><Loader2 className="animate-spin mr-2 h-4 w-4"/> Загрузка склада...</div>;

    if (topItems.length === 0) return <div className="text-sm text-gray-400">Склад пуст</div>;

    return (
        <div className="flex gap-4 overflow-x-auto pb-2 w-full md:w-auto">
            {topItems.map((item, idx) => (
                <div key={idx} className="bg-white border border-gray-200 p-3 rounded-xl shadow-sm flex flex-col gap-1 min-w-[200px]">
                    <div className="flex justify-between items-start">
                        <div className="font-bold text-gray-700 text-sm truncate w-32" title={item.label}>
                            {item.label}
                        </div>
                        <div className="text-[10px] font-bold bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded">
                            TOP {idx + 1}
                        </div>
                    </div>


                    <div className="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden mt-1">
                        <div
                            className="bg-emerald-500 h-full rounded-full"
                            style={{ width: idx === 0 ? '100%' : `${(Number(item.totalQuantity) / Number(topItems[0].totalQuantity)) * 100}%` }}
                        ></div>
                    </div>

                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                        <span>В наличии:</span>
                        <span className="font-bold text-gray-900">{Number(item.totalQuantity).toLocaleString()} {item.unit}</span>
                    </div>
                </div>
            ))}
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/VideoTransmittersLabel.tsx
================================================================================

import React, { useState, useMemo, useEffect } from "react";
import {
    Printer, RefreshCw, ArrowRight,
    Tv, Tag, Ruler, Trash2, FolderOpen, PenTool, LayoutTemplate,

    Wine, Umbrella, ArrowUp, Snowflake, Flame, Package, AlertTriangle
} from "lucide-react";
import { printSpecialLabel } from "src/api/warehouseApi";
import {
    fetchLabelTemplates,
    createLabelTemplate,
    deleteLabelTemplate,
    LabelTemplateModel,
    LabelElement
} from "src/api/labelTemplatesApi";
import { LabelConstructor } from "../components/LabelConstructor";
import QRCode from "react-qr-code";
import toast from "react-hot-toast";
import clsx from "clsx";

type TemplateType = "VIDEO_KIT" | "SIMPLE" | "CUSTOM";


const LabelPreviewCard: React.FC<{
    data: any,
    title: string,
    template: TemplateType,
    size: { w: number, h: number },
    customLayout?: LabelElement[],
    currentIndex?: number,
    totalCount?: number
}> = ({ data, title, template, size, customLayout, currentIndex = 1, totalCount = 1 }) => {

    const infoString = `${data.productName} - ${data.quantity} ${data.unit} (ID: ${data.code})`;


    const baseWidthPx = 300;
    const cssHeight = size.w > 0 ? (baseWidthPx * (size.h / size.w)) : 190;


    const replaceVars = (text: string) => {
        if (!text) return '';
        return text

            .replace(/\{\{code\}\}/g, data.code || '')
            .replace(/\{\{name\}\}/g, data.productName || '')
            .replace(/\{\{productName\}\}/g, data.productName || '')
            .replace(/\{\{id\}\}/g, data.id || '')
            .replace(/\{\{date\}\}/g, data.date || '')
            .replace(/\{\{serial\}\}/g, data.code || '')
            .replace(/\{\{contract\}\}/g, data.contract || '')
            .replace(/\{\{batch\}\}/g, data.batch || '')
            .replace(/\{\{qty\}\}/g, String(data.quantity || ''))
            .replace(/\{\{quantity\}\}/g, String(data.quantity || ''))
            .replace(/\{\{unit\}\}/g, data.unit || '')
            .replace(/\{\{price\}\}/g, data.price || '')
            .replace(/\{\{weight\}\}/g, data.weight || '')

            .replace(/\{\{url\}\}/g, `https://mes.local/item/${data.code}`)

            .replace(/\{\{full_info\}\}/g, infoString)
            .replace(/\{\{quantity_unit\}\}/g, `${data.quantity} ${data.unit}`)

            .replace(/\{\{current\}\}/g, String(currentIndex))
            .replace(/\{\{total\}\}/g, String(totalCount));
    };

    return (
        <div className="flex flex-col items-center animate-fade-in">
            <div className="text-xs font-bold text-gray-400 uppercase mb-2 bg-white px-2 py-1 rounded shadow-sm border border-gray-100">
                {title}
            </div>

            <div className="bg-white shadow-2xl transition-all duration-300">
                <div
                    className="bg-white relative flex flex-col box-border overflow-hidden"
                    style={{
                        width: `${baseWidthPx}px`,
                        height: `${cssHeight}px`,
                        border: '1px solid #000'
                    }}
                >

                    {template === "VIDEO_KIT" && (
                        <div className="flex flex-row h-full p-2">
                            <div className="w-6 border-r border-black flex items-end justify-center py-2 bg-gray-50">
                                <div className="text-[8px] whitespace-nowrap -rotate-90 origin-bottom-left translate-x-full mb-4 w-40 truncate font-mono">
                                    {data.contract}
                                </div>
                            </div>
                            <div className="flex-1 flex flex-col pl-2">
                                <div className="flex justify-between items-start mb-2 shrink-0">
                                    <div className="font-mono text-sm font-bold truncate mt-1">{data.code}</div>
                                    <div><QRCode value={data.code} size={35} /></div>
                                </div>
                                <div className="border-2 border-black text-center text-xs w-full mb-2">
                                    <div className="border-b border-black p-1 font-bold bg-gray-50">{data.productName}</div>
                                    <div className="flex border-b border-black h-10">
                                        <div className="border-r border-black w-1/3 font-bold flex items-center justify-center text-lg">{data.id}</div>
                                        <div className="w-2/3 flex flex-col">
                                            <div className="border-b border-black h-1/2 flex items-center justify-center text-[9px]">{data.date}</div>
                                            <div className="h-1/2 font-bold flex items-center justify-center text-sm">{data.quantity} {data.unit}</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-auto flex justify-center pb-2">
                                    <QRCode value={infoString} size={60} />
                                </div>
                            </div>
                        </div>
                    )}


                    {template === "SIMPLE" && (
                        <div className="h-full flex flex-col justify-center items-center p-2">
                            <div className="text-sm font-bold text-center mb-2 leading-tight">{data.productName}</div>
                            <div className="flex items-center gap-4 w-full justify-center">
                                <QRCode value={infoString} size={70} />
                                <div className="text-left overflow-hidden">
                                    <div className="text-[9px] text-gray-500 uppercase">ID / Партия</div>
                                    <div className="font-mono font-bold text-sm mb-1 truncate">{data.code}</div>
                                    <div className="font-black text-xl">{data.quantity} {data.unit}</div>
                                </div>
                            </div>
                        </div>
                    )}


                    {template === "CUSTOM" && customLayout && customLayout.map(el => {

                        const elStyle: React.CSSProperties = {
                            position: 'absolute',
                            left: `${(el.x / size.w) * 100}%`,
                            top: `${(el.y / size.h) * 100}%`,
                            width: `${(el.width / size.w) * 100}%`,
                            height: ['QR', 'ICON', 'IMAGE', 'RECTANGLE'].includes(el.type)
                                ? `${(el.height / size.h) * 100}%`
                                : 'auto',
                            fontSize: `${(el.fontSize || 10) * (baseWidthPx / size.w) * 0.35}px`,
                            fontWeight: el.isBold ? 'bold' : 'normal',
                            textAlign: el.align || 'left',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: el.align === 'center' ? 'center' : el.align === 'right' ? 'flex-end' : 'flex-start',
                            overflow: 'hidden',
                        };

                        return (
                            <div key={el.id} style={elStyle}>


                                {el.type === 'TEXT' && (
                                    <span className="whitespace-pre-wrap break-words leading-tight">
                                        {replaceVars(el.content || '')}
                                    </span>
                                )}


                                {el.type === 'QR' && (
                                    <QRCode
                                        value={replaceVars(el.content || '{{code}}')}
                                        style={{ width: '100%', height: '100%' }}
                                        viewBox="0 0 256 256"
                                    />
                                )}


                                {el.type === 'COUNTER' && (
                                    <span
                                        className="whitespace-nowrap font-mono"
                                        style={{ fontWeight: el.isBold ? 'bold' : 'normal' }}
                                    >
                                        {replaceVars(el.counterFormat || '{{current}} / {{total}}')}
                                    </span>
                                )}


                                {el.type === 'IMAGE' && el.imageUrl && (
                                    <img
                                        src={el.imageUrl}
                                        alt={el.imageName || 'Image'}
                                        className="w-full h-full object-contain"
                                    />
                                )}


                                {el.type === 'ICON' && (
                                    <div className="w-full h-full flex items-center justify-center p-0.5">

                                        {el.imageUrl ? (
                                            <img src={el.imageUrl} alt={el.content || 'Icon'} className="w-full h-full object-contain" />
                                        ) : (

                                            <>
                                                {el.iconType === 'fragile' && <Wine className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'keep_dry' && <Umbrella className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'this_side_up' && <ArrowUp className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'keep_frozen' && <Snowflake className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'keep_away_heat' && <Flame className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'do_not_stack' && <Package className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                                {el.iconType === 'warning' && <AlertTriangle className="w-full h-full text-gray-800" strokeWidth={1.5} />}
                                            </>
                                        )}
                                    </div>
                                )}


                                {el.type === 'LINE' && (
                                    <div
                                        className="bg-black"
                                        style={{
                                            width: el.width >= el.height ? '100%' : `${(el.strokeWidth || 0.3) * 3}px`,
                                            height: el.width >= el.height ? `${(el.strokeWidth || 0.3) * 3}px` : '100%',
                                        }}
                                    />
                                )}


                                {el.type === 'RECTANGLE' && (
                                    <div
                                        className="w-full h-full border-black"
                                        style={{ borderWidth: `${(el.strokeWidth || 0.3) * 2}px` }}
                                    />
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
            <div className="mt-2 text-[10px] text-gray-400 font-mono">
                {size.w} x {size.h} мм
            </div>
        </div>
    );
};


export const VideoTransmittersLabel: React.FC = () => {
    const [templateType, setTemplateType] = useState<TemplateType>("VIDEO_KIT");


    const [form, setForm] = useState({
        code: "7342511000501",
        productName: "Приемник 2xLR1121",
        id: "734",
        date: new Date().toLocaleString('ru-RU'),
        quantity: "500",
        unit: "шт.",
        contract: "Г.к. № 249/2/ОП/25/1/37 от «05» сентября 2025 г."
    });

    const [printCount, setPrintCount] = useState<number>(1);
    const [labelSize, setLabelSize] = useState({ width: 140, height: 90 });
    const [loading, setLoading] = useState(false);


    const [isConstructorMode, setIsConstructorMode] = useState(false);
    const [customLayout, setCustomLayout] = useState<LabelElement[]>([]);
    const [customTemplateName, setCustomTemplateName] = useState("");


    const [savedTemplates, setSavedTemplates] = useState<LabelTemplateModel[]>([]);

    useEffect(() => {
        loadTemplates();
    }, []);

    const loadTemplates = async () => {
        try {
            const data = await fetchLabelTemplates();
            setSavedTemplates(data);
        } catch (e) {
            console.error(e);
        }
    };


    const endCode = useMemo(() => {
        try {
            const cleanCode = form.code.replace(/\D/g, '');
            if(!cleanCode) return form.code;
            const startBig = BigInt(cleanCode);
            const countBig = BigInt(Math.max(1, printCount));
            const endBig = startBig + countBig - 1n;
            return endBig.toString().padStart(cleanCode.length, '0');
        } catch {
            return form.code;
        }
    }, [form.code, printCount]);

    const handlePrint = async () => {
        if (printCount < 1) return toast.error("Количество копий должно быть > 0");
        setLoading(true);
        try {
            await printSpecialLabel({
                ...form,
                template: templateType,

                customLayout: templateType === "CUSTOM" ? customLayout : undefined,
                printCount,
                rotate: false,
                widthMm: labelSize.width,
                heightMm: labelSize.height
            });
            toast.success(`Отправлено ${printCount} этикеток`);
        } catch (e: any) {
            toast.error("Ошибка печати: " + e.message);
        } finally {
            setLoading(false);
        }
    };


    const onSaveConstructor = async (name: string, w: number, h: number, layout: LabelElement[]) => {
        try {
            await createLabelTemplate(name, w, h, layout);
            toast.success("Шаблон сохранен в базу!");
            setIsConstructorMode(false);
            loadTemplates();


            setTemplateType("CUSTOM");
            setCustomLayout(layout);
            setCustomTemplateName(name);
            setLabelSize({ width: w, height: h });
        } catch (e) {
            toast.error("Ошибка сохранения");
        }
    };


    const applySavedTemplate = (t: LabelTemplateModel) => {
        setIsConstructorMode(false);
        setTemplateType("CUSTOM");
        setLabelSize({ width: t.width, height: t.height });
        setCustomLayout(t.layout || []);
        setCustomTemplateName(t.name);
        toast.success(`Загружен макет: ${t.name}`);
    };

    const deleteSavedTemplate = async (id: number) => {
        if(!confirm("Удалить шаблон?")) return;
        await deleteLabelTemplate(id);
        loadTemplates();
        if(customTemplateName && templateType === 'CUSTOM') {
             setTemplateType("VIDEO_KIT");
             setCustomTemplateName("");
        }
    };

    const updateTime = () => {
        setForm(prev => ({...prev, date: new Date().toLocaleString('ru-RU')}));
    };

    const _toggleRotation = () => {
        setLabelSize({ width: labelSize.height, height: labelSize.width });
    };

    return (
        <div className="max-w-7xl mx-auto animate-fade-in pb-10">


            <div className="mb-6 flex flex-col md:flex-row justify-center items-center gap-4">
                <div className="bg-white p-1 rounded-xl border border-gray-200 shadow-sm inline-flex gap-1">
                    <button onClick={() => {setTemplateType("VIDEO_KIT"); setIsConstructorMode(false); setLabelSize({width: 140, height: 90})}} className={clsx("px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all", templateType === "VIDEO_KIT" && !isConstructorMode ? "bg-indigo-600 text-white shadow-md" : "text-gray-500 hover:bg-gray-100")}>
                        <Tv size={18}/> Стандартный
                    </button>
                    <button onClick={() => {setTemplateType("SIMPLE"); setIsConstructorMode(false); setLabelSize({width: 100, height: 60})}} className={clsx("px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all", templateType === "SIMPLE" && !isConstructorMode ? "bg-indigo-600 text-white shadow-md" : "text-gray-500 hover:bg-gray-100")}>
                        <Tag size={18}/> Простой
                    </button>

                    <button onClick={() => {setTemplateType("CUSTOM"); setIsConstructorMode(false)}} className={clsx("px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all", templateType === "CUSTOM" && !isConstructorMode ? "bg-indigo-600 text-white shadow-md" : "text-gray-500 hover:bg-gray-100")}>
                        <LayoutTemplate size={18}/> {customTemplateName || "Мои шаблоны"}
                    </button>
                </div>

                <button
                    onClick={() => setIsConstructorMode(!isConstructorMode)}
                    className={clsx("px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all border", isConstructorMode ? "bg-red-50 text-red-600 border-red-200" : "bg-white text-indigo-600 border-indigo-200 hover:bg-indigo-50")}
                >
                    {isConstructorMode ? <Trash2 size={18}/> : <PenTool size={18}/>}
                    {isConstructorMode ? "Закрыть редактор" : "Конструктор"}
                </button>
            </div>


            {isConstructorMode ? (
                <LabelConstructor
                    initialWidth={labelSize.width}
                    initialHeight={labelSize.height}
                    initialLayout={templateType === 'CUSTOM' ? customLayout : []}
                    onSave={onSaveConstructor as any}
                    onClose={() => setIsConstructorMode(false)}
                />
            ) : (
                <div className="flex flex-col xl:flex-row gap-8">


                    <div className="flex-1 space-y-5 bg-white p-6 rounded-3xl shadow-xl border border-gray-100">
                        <div className="flex items-center gap-2 text-indigo-800 border-b pb-4 mb-2">
                            <Printer className="text-indigo-600"/>
                            <h2 className="text-xl font-bold">Параметры печати</h2>
                        </div>


                        {savedTemplates.length > 0 && (
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <div className="text-[10px] font-bold text-slate-400 uppercase flex items-center gap-2 mb-2">
                                    <FolderOpen size={12}/> Выберите шаблон:
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {savedTemplates.map(t => (
                                        <div key={t.id} className={clsx("group flex items-center bg-white border rounded-lg overflow-hidden shadow-sm transition cursor-pointer", customTemplateName === t.name ? "border-indigo-500 ring-1 ring-indigo-500" : "border-gray-300 hover:border-indigo-400")}>
                                            <div onClick={() => applySavedTemplate(t)} className="px-3 py-1.5 text-xs font-bold text-gray-700 hover:text-indigo-600">
                                                {t.name} <span className="text-gray-400 font-normal ml-1">{t.width}x{t.height}</span>
                                            </div>
                                            <button onClick={(e) => { e.stopPropagation(); deleteSavedTemplate(t.id); }} className="px-2 py-1.5 hover:bg-red-50 text-gray-400 hover:text-red-500 border-l">
                                                <Trash2 size={12}/>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}


                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2">
                                <label className="text-xs font-bold text-gray-500 uppercase">Наименование</label>
                                <input value={form.productName} onChange={e => setForm({...form, productName: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg font-bold text-gray-800 focus:border-indigo-500 outline-none" />
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">ID / Номер</label>
                                <input value={form.id} onChange={e => setForm({...form, id: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg focus:border-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Дата</label>
                                <div className="flex gap-1">
                                    <input value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:border-indigo-500 outline-none" />
                                    <button onClick={updateTime} className="p-2.5 bg-gray-100 rounded-lg hover:bg-gray-200"><RefreshCw size={16}/></button>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Кол-во</label>
                                <input value={form.quantity} onChange={e => setForm({...form, quantity: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg focus:border-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Ед. изм.</label>
                                <input value={form.unit} onChange={e => setForm({...form, unit: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:border-indigo-500 outline-none" />
                            </div>

                            <div className="md:col-span-2">
                                <label className="text-xs font-bold text-gray-500 uppercase">Договор / Инфо</label>
                                <input value={form.contract} onChange={e => setForm({...form, contract: e.target.value})} className="w-full p-2.5 border border-gray-300 rounded-lg text-sm focus:border-indigo-500 outline-none" />
                            </div>
                        </div>


                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-indigo-800 uppercase flex justify-between">
                                    <span>Стартовый номер (Для QR)</span>
                                </label>
                                <input value={form.code} onChange={e => setForm({...form, code: e.target.value})} className="w-full p-3 border-2 border-indigo-200 rounded-xl font-mono text-xl font-black text-indigo-900 focus:border-indigo-500 outline-none shadow-sm" />
                            </div>

                            <div className="flex items-end gap-4">
                                <div className="flex-1">
                                    <label className="text-xs font-bold text-indigo-800 uppercase mb-1 block">Тираж</label>
                                    <input type="number" min="1" max="1000" value={printCount} onChange={e => setPrintCount(Number(e.target.value))} className="w-full p-3 border-2 border-indigo-200 rounded-xl font-bold text-lg" />
                                </div>
                                <div className="flex items-center gap-2 p-3 bg-white/60 rounded-xl border border-indigo-100">
                                    <Ruler size={18} className="text-indigo-400"/>
                                    <div className="text-xs font-bold text-indigo-900">{labelSize.width} x {labelSize.height} мм</div>
                                </div>
                            </div>

                            <div className="text-xs text-indigo-700 flex items-center justify-between">
                                <span>Диапазон:</span>
                                <div className="font-mono font-bold">{form.code} <ArrowRight size={12} className="inline"/> {endCode}</div>
                            </div>

                            <button onClick={handlePrint} disabled={loading} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl rounded-xl shadow-lg hover:shadow-indigo-300 transition flex justify-center items-center gap-3">
                                {loading ? "Генерация..." : <><Printer /> ПЕЧАТЬ</>}
                            </button>
                        </div>
                    </div>


                    <div className="flex-1 bg-gray-100 rounded-3xl p-8 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 min-h-[500px] sticky top-6">
                        <div className="grid grid-cols-1 gap-12 w-full place-items-center max-h-[800px] overflow-y-auto custom-scrollbar">
                            <LabelPreviewCard
                                title="Первая в серии"
                                data={form}
                                template={templateType}
                                size={{ w: labelSize.width, h: labelSize.height }}
                                customLayout={templateType === 'CUSTOM' ? customLayout : undefined}
                                currentIndex={1}
                                totalCount={printCount}
                            />
                            {printCount > 1 && (
                                <>
                                    <div className="text-gray-400 -my-6"><ArrowRight className="rotate-90" size={32}/></div>
                                    <LabelPreviewCard
                                        title={`Последняя (№${printCount})`}
                                        data={{...form, code: endCode}}
                                        template={templateType}
                                        size={{ w: labelSize.width, h: labelSize.height }}
                                        customLayout={templateType === 'CUSTOM' ? customLayout : undefined}
                                        currentIndex={printCount}
                                        totalCount={printCount}
                                    />
                                </>
                            )}
                        </div>
                        <p className="text-xs text-gray-400 mt-6 font-mono text-center">
                            * Визуализация может незначительно отличаться от PDF.<br/>
                            Размер бумаги: {labelSize.width}x{labelSize.height} мм
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseBalance.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchStockBalance } from "src/api/warehouseApi";
import { StockBalanceItem } from "src/types/WarehouseModels";
import { PieChart, RefreshCw, PackageX } from "lucide-react";

export const WarehouseBalance: React.FC = () => {
    const [balance, setBalance] = useState<StockBalanceItem[]>([]);
    const [loading, setLoading] = useState(false);

    const loadData = async () => {
        setLoading(true);
        try {
            const data = await fetchStockBalance();
            setBalance(data);
        } catch (e) { console.error(e); }
        finally { setLoading(false); }
    };

    useEffect(() => { loadData(); }, []);


    const products = balance.filter(i => i.originType === "PRODUCT");
    const components = balance.filter(i => i.originType === "COMPONENT");
    const others = balance.filter(i => i.originType !== "PRODUCT" && i.originType !== "COMPONENT");

    const renderTable = (title: string, items: StockBalanceItem[], colorClass: string) => (
        <div className="mb-8 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div className={`px-6 py-3 font-bold text-gray-700 bg-gray-50 border-b flex justify-between ${colorClass}`}>
                <span>{title}</span>
                <span className="text-xs bg-white px-2 py-0.5 rounded border">Позиций: {items.length}</span>
            </div>
            <table className="w-full text-left">
                <thead className="bg-gray-50/50 text-xs text-gray-500 uppercase border-b">
                    <tr>
                        <th className="px-6 py-3">Наименование</th>
                        <th className="px-6 py-3 text-right">Общий остаток</th>
                        <th className="px-6 py-3 text-right">Мест (Коробок)</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-100 text-sm">
                    {items.map((item, idx) => (
                        <tr key={idx} className="hover:bg-gray-50 transition">
                            <td className="px-6 py-3 font-medium text-gray-800">{item.label}</td>
                            <td className="px-6 py-3 text-right font-bold text-indigo-600">
                                {Number(item.totalQuantity).toLocaleString()} <span className="text-gray-400 font-normal text-xs">{item.unit}</span>
                            </td>
                            <td className="px-6 py-3 text-right text-gray-600">{item.boxCount}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );

    return (
        <div className="animate-fade-in">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <PieChart className="text-indigo-600"/> Сводные остатки склада
                </h2>
                <button onClick={loadData} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition"><RefreshCw size={18}/></button>
            </div>

            {loading ? (
                <div className="text-center py-20 text-gray-400">Загрузка данных...</div>
            ) : (
                <>
                    {products.length > 0 && renderTable("Готовая продукция", products, "border-l-4 border-l-purple-500")}
                    {components.length > 0 && renderTable("Комплектующие и материалы", components, "border-l-4 border-l-blue-500")}
                    {others.length > 0 && renderTable("Прочее оборудование", others, "border-l-4 border-l-gray-500")}

                    {balance.length === 0 && (
                        <div className="text-center py-20 bg-white rounded-xl border-2 border-dashed">
                            <PackageX size={48} className="mx-auto text-gray-300 mb-4"/>
                            <p className="text-gray-500">Склад пуст. Примите товар, чтобы увидеть остатки.</p>
                        </div>
                    )}
                </>
            )}
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseDocs.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
  FileText, Calendar, Search, Plus,
  ArrowDownToLine, Printer, User
} from "lucide-react";
import { createDocument, fetchDocuments } from "src/api/warehouseApi";
import { WarehouseDocument } from "src/types/WarehouseModels";
import { formatDateTime } from "../utils";

export const WarehouseDocs: React.FC = () => {
  const [docs, setDocs] = useState<WarehouseDocument[]>([]);
  const [loading, setLoading] = useState(false);

  const [search, setSearch] = useState("");
  const [typeFilter, setTypeFilter] = useState("");
  const [dateFrom, setDateFrom] = useState("");

  const [isCreateOpen, setIsCreateOpen] = useState(false);
  const [newDoc, setNewDoc] = useState({ number: "", type: "INCOME", comment: "" });

  const loadDocuments = async () => {
      setLoading(true);
      try {
          const res = await fetchDocuments({
            limit: 50,
            search: search || undefined,
            type: typeFilter || undefined,
            dateFrom: dateFrom || undefined
          });
          setDocs(res.rows);
      } catch(e) { console.error(e); }
      finally { setLoading(false); }
  };

  useEffect(() => {
      const timer = setTimeout(loadDocuments, 500);
      return () => clearTimeout(timer);
  }, [search, typeFilter, dateFrom]);

  const handleCreate = async () => {
      if(!newDoc.number) return alert("Введите номер!");
      try {
          await createDocument({ ...newDoc, boxId: null });
          setIsCreateOpen(false);
          setNewDoc({ number: "", type: "INCOME", comment: "" });
          loadDocuments();
      } catch(e) { alert("Ошибка"); }
  };


  const getTypeStyle = (type: string | null) => {
      const t = (type || "").toUpperCase();
      if (t.includes("INCOME") || t.includes("ПРИХОД")) return "bg-emerald-100 text-emerald-700 border-emerald-200";
      if (t.includes("OUT") || t.includes("РАСХОД") || t.includes("СПИСАНИЕ")) return "bg-orange-100 text-orange-700 border-orange-200";
      return "bg-blue-50 text-blue-700 border-blue-200";
  }

  return (
    <div className="space-y-6 animate-fade-in">


        <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between gap-4">
            <div className="flex items-center gap-4 flex-1">
                <div className="relative flex-1 max-w-md">
                    <Search className="absolute left-3 top-2.5 text-gray-400 w-5 h-5" />
                    <input
                        value={search} onChange={e => setSearch(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        placeholder="Поиск по номеру или комментарию..."
                    />
                </div>

                <select
                    value={typeFilter} onChange={e => setTypeFilter(e.target.value)}
                    className="p-2 border border-gray-200 rounded-lg bg-gray-50 text-sm font-medium"
                >
                    <option value="">Все типы</option>
                    <option value="INCOME">Приход (INCOME)</option>
                    <option value="OUTCOME">Расход (OUTCOME)</option>
                    <option value="MOVE">Перемещение</option>
                </select>

                <input
                    type="date"
                    value={dateFrom} onChange={e => setDateFrom(e.target.value)}
                    className="p-2 border border-gray-200 rounded-lg text-sm text-gray-600"
                />
            </div>

            <button
                onClick={() => setIsCreateOpen(!isCreateOpen)}
                className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm"
            >
                <Plus size={18} /> Новый документ
            </button>
        </div>


        {isCreateOpen && (
            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex flex-col md:flex-row gap-3 items-end animate-fade-in">
                <div className="flex-1 w-full">
                    <label className="text-xs font-bold text-indigo-900 uppercase">Номер</label>
                    <input value={newDoc.number} onChange={e => setNewDoc({...newDoc, number: e.target.value})} className="w-full p-2 border rounded-lg" placeholder="№ АКТ-001" />
                </div>
                <div className="w-full md:w-48">
                    <label className="text-xs font-bold text-indigo-900 uppercase">Тип</label>
                    <select value={newDoc.type} onChange={e => setNewDoc({...newDoc, type: e.target.value})} className="w-full p-2 border rounded-lg">
                        <option value="INCOME">Приход</option>
                        <option value="OUTCOME">Списание</option>
                        <option value="MOVE">Акт перемещения</option>
                    </select>
                </div>
                <div className="flex-[2] w-full">
                    <label className="text-xs font-bold text-indigo-900 uppercase">Комментарий</label>
                    <input value={newDoc.comment} onChange={e => setNewDoc({...newDoc, comment: e.target.value})} className="w-full p-2 border rounded-lg" placeholder="Основание..." />
                </div>
                <button onClick={handleCreate} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700">Сохранить</button>
            </div>
        )}


        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <table className="w-full text-left border-collapse">
                <thead>
                    <tr className="bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        <th className="px-6 py-4">Документ</th>
                        <th className="px-6 py-4">Тип</th>
                        <th className="px-6 py-4">Дата / Автор</th>
                        <th className="px-6 py-4">Комментарий</th>
                        <th className="px-6 py-4 text-right">Действия</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                    {loading ? (
                         <tr><td colSpan={5} className="p-10 text-center text-gray-400">Загрузка...</td></tr>
                    ) : docs.length === 0 ? (
                         <tr><td colSpan={5} className="p-10 text-center text-gray-400">Документы не найдены</td></tr>
                    ) : (
                        docs.map(doc => (
                            <tr key={doc.id} className="hover:bg-gray-50 transition-colors group">
                                <td className="px-6 py-4">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-gray-100 rounded-lg text-gray-500">
                                            <FileText size={20} />
                                        </div>
                                        <div>
                                            <div className="font-bold text-gray-900">{doc.number}</div>
                                            <div className="text-xs text-gray-400">ID: {doc.id}</div>
                                        </div>
                                    </div>
                                </td>
                                <td className="px-6 py-4">
                                    <span className={`px-2.5 py-1 rounded-md text-xs font-bold border ${getTypeStyle(doc.type)}`}>
                                        {doc.type || "OTHER"}
                                    </span>
                                </td>
                                <td className="px-6 py-4">
                                    <div className="flex flex-col">
                                        <span className="text-sm font-medium text-gray-700 flex items-center gap-1.5">
                                            <Calendar size={14} className="text-gray-400"/>
                                            {doc.date || formatDateTime(doc.createdAt).split(',')[0]}
                                        </span>
                                        <span className="text-xs text-gray-500 flex items-center gap-1.5 mt-0.5">
                                            <User size={12}/>
                                            {doc.createdBy?.name || "Система"}
                                        </span>
                                    </div>
                                </td>
                                <td className="px-6 py-4 max-w-xs">
                                    <div className="text-sm text-gray-600 truncate" title={doc.comment || ""}>
                                        {doc.comment || "—"}
                                    </div>
                                </td>
                                <td className="px-6 py-4 text-right">
                                    <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Печать">
                                            <Printer size={18} />
                                        </button>
                                        <button className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Скачать">
                                            <ArrowDownToLine size={18} />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))
                    )}
                </tbody>
            </table>
        </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseIntake.tsx
================================================================================

import React, { useEffect, useMemo, useState } from "react";
import QRCode from "react-qr-code";
import {
  ClipboardList, AlertCircle, Printer, Copy, Layers, FileSpreadsheet
} from "lucide-react";
import { createBoxesBatch, downloadBoxesExcel, printBoxesPdf } from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import { SectionModel } from "src/store/StructureStore";
import { productModel } from "src/types/ProductModel";
import { componentModel } from "src/types/ComponentModel";
import { LabelPreview } from "../components/LabelPreview";

interface Props {
  sections: SectionModel[];
  productsList: productModel[];
  componentsList: componentModel[];
}

export const WarehouseIntake: React.FC<Props> = ({ sections, productsList, componentsList }) => {

  const [intakeMode, setIntakeMode] = useState<"PRODUCT" | "COMPONENT" | "OTHER">("PRODUCT");
  const [selectedSkuId, setSelectedSkuId] = useState<number | "">("");
  const [label, setLabel] = useState("");
  const [projectName, setProjectName] = useState("");
  const [batchName, setBatchName] = useState("");


  const [measureType, setMeasureType] = useState<"PCS" | "METERS">("PCS");
  const [unit, setUnit] = useState("шт");
  const [shipmentTotal, setShipmentTotal] = useState<number | "">("");
  const [capacityPerUnit, setCapacityPerUnit] = useState<number>(1);

  const batchCalc = useMemo(() => {
      const total = Number(shipmentTotal) || 0;
      const capacity = Number(capacityPerUnit) || 1;
      if (total === 0) return { fullUnits: 0, remainder: 0, totalUnits: 0 };
      const fullUnits = Math.floor(total / capacity);
      const remainder = total % capacity;
      const totalUnits = fullUnits + (remainder > 0 ? 1 : 0);
      return { fullUnits, remainder, totalUnits };
  }, [shipmentTotal, capacityPerUnit]);

  const [intakeStatus, setIntakeStatus] = useState("ON_STOCK");
  const [intakeSectionId, setIntakeSectionId] = useState<number | "">("");
  const [intakeNotes, setIntakeNotes] = useState("");
  const [createdBoxes, setCreatedBoxes] = useState<InventoryBoxModel[]>([]);
  const [intakeLoading, setIntakeLoading] = useState(false);
  const [intakeError, setIntakeError] = useState<string | null>(null);


  useEffect(() => {
    setUnit(measureType === "PCS" ? "шт" : "м");
  }, [measureType]);


  useEffect(() => {
      if (intakeMode === "PRODUCT" && selectedSkuId) {
          const p = productsList.find(x => x.id === Number(selectedSkuId));
          if(p) setLabel(p.title);
      } else if (intakeMode === "COMPONENT" && selectedSkuId) {
          const c = componentsList.find(x => x.id === Number(selectedSkuId));
          if(c) setLabel(c.title);
      }
  }, [intakeMode, selectedSkuId]);


  const applyTemplate = (type: "THERMAL" | "CABLE" | "SUB") => {
      if (type === "THERMAL") {
        setLabel("Тепловизор ТП-200 (Комплект)");
        setProjectName("Project-40k");
        setBatchName("Партия 2");
        setMeasureType("PCS");
        setShipmentTotal(4000);
        setCapacityPerUnit(200);
        setIntakeNotes("Пришла часть. Сборку выполняем сами.");
      } else if (type === "CABLE") {
        setLabel("Кабель Коаксиальный RG-6");
        setProjectName("Общий запас");
        setBatchName("Поставка Дек-24");
        setMeasureType("METERS");
        setShipmentTotal(5000);
        setCapacityPerUnit(1000);
        setIntakeNotes("Кабель для нарезки");
      } else if (type === "SUB") {
        setLabel("Полётный контроллер v3 (Субподряд)");
        setProjectName("Дроны FPV");
        setBatchName("От ООО 'Техно'");
        setMeasureType("PCS");
        setShipmentTotal(10000);
        setCapacityPerUnit(500);
        setIntakeNotes("Пришли готовые, сразу на прошивку!");
        setIntakeStatus("IN_WORK");
      }
  };

  const handleCreateBatch = async () => {
    if (!label.trim()) return alert("Введите название!");
    if (batchCalc.totalUnits > 1000) return alert("Слишком много этикеток (>1000).");

    setIntakeLoading(true);
    setIntakeError(null);
    try {
      let autoNote = intakeNotes;
      if (batchCalc.remainder > 0) {
         autoNote += ` | ВНИМАНИЕ: Остаточное место: ${batchCalc.remainder} ${unit}`;
      }

      const res = await createBoxesBatch({
        label, projectName, batchName,
        originType: intakeMode,
        originId: selectedSkuId ? Number(selectedSkuId) : null,
        quantity: batchCalc.totalUnits,
        itemsPerBox: capacityPerUnit,
        unit,
        status: intakeStatus,
        currentSectionId: intakeSectionId ? Number(intakeSectionId) : null,
        notes: autoNote
      });

      setCreatedBoxes(res.boxes);
      setShipmentTotal("");
    } catch (e: any) {
        setIntakeError(e.message || "Ошибка создания");
    }
    finally { setIntakeLoading(false); }
  };

  return (
    <div className="grid grid-cols-1 xl:grid-cols-12 gap-8 animate-fade-in">

        <div className="xl:col-span-8 space-y-6">

            <div className="flex gap-2 overflow-x-auto pb-2">
                <button onClick={() => applyTemplate("THERMAL")} className="whitespace-nowrap px-4 py-2 bg-white border rounded text-xs font-bold text-gray-600 hover:bg-blue-50 transition flex gap-2"><Copy size={14}/> Пример: Тепловизоры</button>
                <button onClick={() => applyTemplate("SUB")} className="whitespace-nowrap px-4 py-2 bg-white border rounded text-xs font-bold text-gray-600 hover:bg-purple-50 transition flex gap-2"><Copy size={14}/> Пример: Субподряд</button>
                <button onClick={() => applyTemplate("CABLE")} className="whitespace-nowrap px-4 py-2 bg-white border rounded text-xs font-bold text-gray-600 hover:bg-orange-50 transition flex gap-2"><Copy size={14}/> Пример: Кабель</button>
            </div>

            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h2 className="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <ClipboardList className="text-indigo-600"/> Новая поставка
                </h2>


                <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Что принимаем?</label>
                    <div className="flex gap-2">
                        {(['PRODUCT', 'COMPONENT', 'OTHER'] as const).map(m => (
                            <button
                                key={m}
                                onClick={() => { setIntakeMode(m); setSelectedSkuId(""); setLabel(""); }}
                                className={`flex-1 py-2 rounded-lg border text-sm font-bold transition ${intakeMode === m ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-gray-50 text-gray-600'}`}
                            >
                                {m === 'PRODUCT' ? 'Изделие' : m === 'COMPONENT' ? 'Комплектующее' : 'Прочее'}
                            </button>
                        ))}
                    </div>
                </div>


                {(intakeMode === 'PRODUCT' || intakeMode === 'COMPONENT') && (
                    <div className="mb-4">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Выберите из справочника</label>
                        <select
                            className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500"
                            value={selectedSkuId} onChange={e => setSelectedSkuId(e.target.value ? Number(e.target.value) : "")}
                        >
                            <option value="">-- Не выбрано --</option>
                            {intakeMode === 'PRODUCT'
                                ? productsList.map(p => <option key={p.id} value={p.id}>{p.title}</option>)
                                : componentsList.map(c => <option key={c.id} value={c.id}>{c.title} ({c.article})</option>)
                            }
                        </select>
                    </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div className="md:col-span-2">
                         <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Название</label>
                         <input value={label} onChange={e => setLabel(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="Например: Контроллер FC v2.4"/>
                     </div>
                     <div>
                         <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Партия</label>
                         <input value={batchName} onChange={e => setBatchName(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="№ партии" />
                     </div>
                     <div>
                         <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Проект</label>
                         <input value={projectName} onChange={e => setProjectName(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="Опционально" />
                     </div>
                     <div>
                         <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">Куда (Участок)</label>
                         <select value={intakeSectionId} onChange={e => setIntakeSectionId(Number(e.target.value))} className="w-full p-2 border rounded-lg text-sm bg-gray-50">
                            <option value="">-- Склад Приёмки --</option>
                            {sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                         </select>
                     </div>
                     <div>
                         <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">Статус</label>
                         <select value={intakeStatus} onChange={e => setIntakeStatus(e.target.value)} className="w-full p-2 border rounded-lg text-sm">
                             <option value="ON_STOCK">На складе (Обычный)</option>
                             <option value="IN_WORK">Сразу в работу</option>
                         </select>
                     </div>
                     <div className="md:col-span-2">
                         <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">Примечание</label>
                         <input value={intakeNotes} onChange={e => setIntakeNotes(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="..." />
                     </div>
                </div>


                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6">
                    <div className="flex justify-between mb-2">
                        <h4 className="text-sm font-bold text-indigo-900 flex items-center gap-2"><Layers size={14}/> Расчет мест</h4>
                        <div className="flex text-[10px] font-bold bg-white rounded border overflow-hidden">
                            <button onClick={() => setMeasureType("PCS")} className={`px-2 py-1 ${measureType === 'PCS' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500'}`}>ШТ</button>
                            <button onClick={() => setMeasureType("METERS")} className={`px-2 py-1 ${measureType === 'METERS' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500'}`}>МЕТРЫ</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-2">
                         <div>
                             <label className="text-xs text-gray-600">Всего пришло ({unit})</label>
                             <input type="number" min={1} value={shipmentTotal} onChange={e => setShipmentTotal(Number(e.target.value))} className="w-full p-2 border rounded-lg font-bold" placeholder="0"/>
                         </div>
                         <div>
                             <label className="text-xs text-gray-600">В одной таре ({unit})</label>
                             <input type="number" min={1} value={capacityPerUnit} onChange={e => setCapacityPerUnit(Number(e.target.value))} className="w-full p-2 border rounded-lg" placeholder="1"/>
                         </div>
                    </div>

                    <div className="text-sm text-indigo-800 font-medium flex justify-between items-center pt-2 border-t border-indigo-200">
                        <span>Будет создано этикеток:</span>
                        <span className="text-xl font-black">{batchCalc.totalUnits}</span>
                    </div>
                    {batchCalc.remainder > 0 && (
                        <div className="mt-2 text-xs text-orange-600 font-bold flex items-center gap-1">
                            <AlertCircle size={12}/> {batchCalc.fullUnits} полных + 1 с остатком ({batchCalc.remainder} {unit})
                        </div>
                    )}
                </div>

                {intakeError && <div className="text-sm text-red-600 mb-4 p-3 bg-red-50 rounded-lg">{intakeError}</div>}

                <div className="flex justify-end">
                     <button
                        onClick={handleCreateBatch} disabled={intakeLoading || !label}
                        className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2"
                     >
                        {intakeLoading ? "..." : <Printer size={20}/>} Создать партию
                     </button>
                </div>
            </div>


            <div className="space-y-4">
                <div className="flex justify-between items-center">
                    <h3 className="text-lg font-bold text-gray-700">Результат ({createdBoxes.length})</h3>
                    <div className="flex gap-2">

                        {createdBoxes.length > 0 && (
                            <button
                                onClick={() => printBoxesPdf(createdBoxes.map(b => b.id))}
                                className="flex items-center gap-2 text-sm font-bold text-white bg-indigo-600 px-3 py-2 rounded-lg hover:bg-indigo-700 transition shadow-md"
                            >
                                <Printer size={18}/> PDF
                            </button>
                        )}

                        {createdBoxes.length > 0 && (
                            <button
                                onClick={() => downloadBoxesExcel(createdBoxes.map(b => b.id))}
                                className="flex items-center gap-2 text-sm font-bold text-green-700 bg-green-100 px-3 py-2 rounded-lg hover:bg-green-200 transition"
                            >
                                <FileSpreadsheet size={18}/> Excel
                            </button>
                        )}
                    </div>
                </div>

                {createdBoxes.length === 0 && <div className="text-center py-10 bg-white rounded-2xl border-2 border-dashed border-gray-200 text-gray-400">Здесь появятся этикетки</div>}

                <div className="grid grid-cols-2 gap-4 max-h-[600px] overflow-y-auto pr-2">
                    {createdBoxes.map(box => (
                        <div key={box.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center text-center relative group hover:border-indigo-300 transition">
                            <div className="absolute top-2 left-2 text-[10px] font-mono bg-gray-100 px-1.5 rounded text-gray-500 font-bold">{box.shortCode}</div>
                            <div className="mb-2 bg-white p-1"><QRCode value={box.qrCode} size={80} /></div>
                            <div className="text-xs font-bold text-gray-900 w-full truncate">{box.label}</div>
                            <div className="text-[10px] text-gray-500 mt-1">ID: {box.id}</div>
                            <div className="mt-2 bg-gray-900 text-white text-xs font-bold px-2 py-0.5 rounded">{box.quantity} {box.unit}</div>
                        </div>
                    ))}
                </div>
            </div>
        </div>

        <div className="xl:col-span-4">
            <div className="sticky top-6 flex justify-center">
                <LabelPreview label={label || "Название"} project={projectName} batch={batchName} id="###" qrValue={`BOX-FULL`} qty={capacityPerUnit} unit={unit} />
            </div>
        </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseLabels.tsx
================================================================================

import React, { useEffect, useState } from "react";
import {
    fetchBoxes, updateBoxesBatch, createBoxesBatch,
    printBoxesPdf
} from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import {
    Search, Filter, Printer, Edit,
    Plus, CheckSquare, Square, Tag
} from "lucide-react";
import { Modal } from "src/components/Modal/Modal";
import toast from "react-hot-toast";
import { Preloader } from "src/components/common/Preloader";

export const WarehouseLabels: React.FC = () => {

    const [boxes, setBoxes] = useState<InventoryBoxModel[]>([]);
    const [loading, setLoading] = useState(false);
    const [selectedIds, setSelectedIds] = useState<number[]>([]);


    const [search, setSearch] = useState("");
    const [batchFilter, setBatchFilter] = useState("");
    const [page, setPage] = useState(1);
    const [totalCount, setTotalCount] = useState(0);
    const limit = 50;


    const [isCreateOpen, setIsCreateOpen] = useState(false);
    const [isEditOpen, setIsEditOpen] = useState(false);


    const [createForm, setCreateForm] = useState({
        label: "", quantity: 1, count: 1, batchName: "", projectName: ""
    });


    const [editForm, setEditForm] = useState<Partial<InventoryBoxModel>>({});


    const loadData = async () => {
        setLoading(true);
        try {
            const res = await fetchBoxes({
                page, limit, search: search || undefined,
                batchName: batchFilter || undefined
            });
            setBoxes(res.rows);
            setTotalCount(res.count);
        } finally { setLoading(false); }
    };

    useEffect(() => { loadData(); }, [page, search, batchFilter]);


    const toggleSelect = (id: number) => {
        setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
    };

    const toggleSelectAll = () => {
        if (selectedIds.length === boxes.length) setSelectedIds([]);
        else setSelectedIds(boxes.map(b => b.id));
    };

    const handleCreate = async () => {
        if (!createForm.label) return toast.error("Нужно название");
        try {
            await createBoxesBatch({
                label: createForm.label,
                quantity: createForm.count,
                itemsPerBox: createForm.quantity,
                batchName: createForm.batchName,
                projectName: createForm.projectName,
                unit: "шт",
                status: "ON_STOCK"
            });
            toast.success(`Создано ${createForm.count} этикеток`);
            setIsCreateOpen(false);
            loadData();
        } catch (e) { toast.error("Ошибка создания"); }
    };

    const handleBulkEdit = async () => {
        if (selectedIds.length === 0) return;
        try {
            await updateBoxesBatch(selectedIds, editForm);
            toast.success("Обновлено успешно");
            setIsEditOpen(false);
            setEditForm({});
            setSelectedIds([]);
            loadData();
        } catch (e) { toast.error("Ошибка обновления"); }
    };

    const handlePrint = async () => {
        if (selectedIds.length === 0) return toast.error("Выберите этикетки");
        await printBoxesPdf(selectedIds);
    };

    return (
        <div className="space-y-4 animate-fade-in">

            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col xl:flex-row justify-between gap-4">
                <div className="flex gap-4 flex-1">
                    <div className="relative flex-1 max-w-md">
                        <Search className="absolute left-3 top-2.5 text-gray-400 w-5 h-5"/>
                        <input
                            value={search} onChange={e => setSearch(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="Поиск по названию, ID, QR..."
                        />
                    </div>
                    <div className="relative w-64">
                        <Filter className="absolute left-3 top-2.5 text-gray-400 w-5 h-5"/>
                        <input
                            value={batchFilter} onChange={e => setBatchFilter(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="Фильтр по Партии..."
                        />
                    </div>
                </div>

                <div className="flex gap-2">
                    {selectedIds.length > 0 && (
                        <>
                            <button onClick={() => setIsEditOpen(true)} className="flex items-center gap-2 bg-orange-100 text-orange-700 px-4 py-2 rounded-lg font-bold hover:bg-orange-200 transition">
                                <Edit size={18}/> Правка ({selectedIds.length})
                            </button>
                            <button onClick={handlePrint} className="flex items-center gap-2 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg font-bold hover:bg-indigo-200 transition">
                                <Printer size={18}/> Печать
                            </button>
                        </>
                    )}
                    <button onClick={() => setIsCreateOpen(true)} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">
                        <Plus size={18}/> Создать этикетки
                    </button>
                </div>
            </div>


            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                            <tr>
                                <th className="px-4 py-3 w-10">
                                    <button onClick={toggleSelectAll}>
                                        {selectedIds.length > 0 && selectedIds.length === boxes.length
                                            ? <CheckSquare className="text-indigo-600"/>
                                            : <Square className="text-gray-400"/>}
                                    </button>
                                </th>
                                <th className="px-4 py-3">ID / Код</th>
                                <th className="px-4 py-3">Наименование (Label)</th>
                                <th className="px-4 py-3">Партия</th>
                                <th className="px-4 py-3">Проект</th>
                                <th className="px-4 py-3">Кол-во</th>
                                <th className="px-4 py-3">Статус</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {loading ? <tr><td colSpan={7} className="p-10"><Preloader/></td></tr> :
                             boxes.map(box => (
                                <tr key={box.id} className={`hover:bg-indigo-50/50 transition cursor-pointer ${selectedIds.includes(box.id) ? 'bg-indigo-50' : ''}`} onClick={() => toggleSelect(box.id)}>
                                    <td className="px-4 py-3">
                                        {selectedIds.includes(box.id) ? <CheckSquare className="text-indigo-600" size={18}/> : <Square className="text-gray-300" size={18}/>}
                                    </td>
                                    <td className="px-4 py-3 font-mono text-xs text-gray-500">
                                        <div className="font-bold text-gray-800">#{box.id}</div>
                                        {box.shortCode}
                                    </td>
                                    <td className="px-4 py-3 font-medium text-gray-800">{box.label}</td>
                                    <td className="px-4 py-3 text-gray-600">{box.batchName || "—"}</td>
                                    <td className="px-4 py-3 text-gray-600">{box.projectName || "—"}</td>
                                    <td className="px-4 py-3 font-bold">{box.quantity} {box.unit}</td>
                                    <td className="px-4 py-3">
                                        <span className={`px-2 py-1 rounded text-xs font-bold ${box.status === 'SCRAP' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                            {box.status}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>

                <div className="p-4 border-t border-gray-200 flex justify-between items-center bg-gray-50">
                    <span className="text-xs text-gray-500">Всего: {totalCount}</span>
                    <div className="flex gap-2">
                        <button disabled={page === 1} onClick={() => setPage(p => p - 1)} className="px-3 py-1 border rounded bg-white disabled:opacity-50">Назад</button>
                        <button disabled={boxes.length < limit} onClick={() => setPage(p => p + 1)} className="px-3 py-1 border rounded bg-white disabled:opacity-50">Вперед</button>
                    </div>
                </div>
            </div>


            <Modal isOpen={isCreateOpen} onClose={() => setIsCreateOpen(false)}>
                <div className="p-6">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Tag/> Генератор этикеток</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">Наименование (Что на этикетке)</label>
                            <input className="w-full p-2 border rounded-lg" value={createForm.label} onChange={e => setCreateForm({...createForm, label: e.target.value})} placeholder="Напр. Корпус v1.0" />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Кол-во в 1 коробке</label>
                                <input type="number" className="w-full p-2 border rounded-lg" value={createForm.quantity} onChange={e => setCreateForm({...createForm, quantity: Number(e.target.value)})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Сколько наклеек создать</label>
                                <input type="number" className="w-full p-2 border rounded-lg bg-indigo-50 font-bold" value={createForm.count} onChange={e => setCreateForm({...createForm, count: Number(e.target.value)})} />
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <input className="p-2 border rounded-lg text-sm" placeholder="Партия (опционально)" value={createForm.batchName} onChange={e => setCreateForm({...createForm, batchName: e.target.value})} />
                            <input className="p-2 border rounded-lg text-sm" placeholder="Проект (опционально)" value={createForm.projectName} onChange={e => setCreateForm({...createForm, projectName: e.target.value})} />
                        </div>
                        <button onClick={handleCreate} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">Сгенерировать</button>
                    </div>
                </div>
            </Modal>


            <Modal isOpen={isEditOpen} onClose={() => setIsEditOpen(false)}>
                <div className="p-6">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-orange-600"><Edit/> Массовая правка ({selectedIds.length})</h2>
                    <p className="text-sm text-gray-500 mb-4">Заполните ТОЛЬКО те поля, которые хотите изменить для всех выбранных коробок.</p>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">Исправить название</label>
                            <input className="w-full p-2 border rounded-lg" placeholder="Оставьте пустым, чтобы не менять" onChange={e => setEditForm({...editForm, label: e.target.value})} />
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">Партия</label>
                            <input className="w-full p-2 border rounded-lg" placeholder="Новое название партии" onChange={e => setEditForm({...editForm, batchName: e.target.value})} />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Количество</label>
                                <input type="number" className="w-full p-2 border rounded-lg" placeholder="Не менять" onChange={e => setEditForm({...editForm, quantity: e.target.value ? Number(e.target.value) : undefined})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Статус</label>
                                <select className="w-full p-2 border rounded-lg" onChange={e => setEditForm({...editForm, status: e.target.value})}>
                                    <option value="">(Без изменений)</option>
                                    <option value="ON_STOCK">На склад</option>
                                    <option value="SCRAP">БРАК (SCRAP)</option>
                                    <option value="IN_WORK">В работу</option>
                                </select>
                            </div>
                        </div>

                        <button onClick={handleBulkEdit} className="w-full py-3 bg-orange-600 text-white font-bold rounded-xl hover:bg-orange-700">Применить изменения</button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseMoves.tsx
================================================================================

import React, { useState } from "react";
import { Search, Loader2, AlertCircle, MapPin, ArrowRightLeft, Trash2, ShoppingCart, Save } from "lucide-react";
import { fetchBoxById, fetchBoxByQr, moveBoxesBatch } from "src/api/warehouseApi";
import { InventoryBoxModel } from "src/types/WarehouseModels";
import { SectionModel } from "src/store/StructureStore";

interface Props { sections: SectionModel[]; }

type CartItem = {
    box: InventoryBoxModel;
    operation: string;
    toSectionId: number | null;
    statusAfter: string;
    deltaQty: number;
    goodQty: number | null;
    scrapQty: number | null;
    comment: string;
};

export const WarehouseMoves: React.FC<Props> = ({ sections }) => {
  const [scanCode, setScanCode] = useState("");
  const [loading, setLoading] = useState(false);

  const [currentBox, setCurrentBox] = useState<InventoryBoxModel | null>(null);


  const [opType, setOpType] = useState<"MOVE" | "CONSUME">("MOVE");
  const [toSectionId, setToSectionId] = useState<number | "">("");
  const [statusAfter, setStatusAfter] = useState("");
  const [consumeAmount, setConsumeAmount] = useState<number | "">("");
  const [comment, setComment] = useState("");

  const [cart, setCart] = useState<CartItem[]>([]);
  const [docNumber, setDocNumber] = useState("");

  const handleScan = async () => {
      if (!scanCode) return;
      setLoading(true);
      setCurrentBox(null);
      try {
          let res;
          if (/^\d+$/.test(scanCode)) res = await fetchBoxById(Number(scanCode));
          else res = await fetchBoxByQr(scanCode);

          setCurrentBox(res.box);

          setOpType("MOVE");
          setToSectionId(res.box.currentSectionId || "");
          setStatusAfter(res.box.status);
          setConsumeAmount("");
          setComment("");
      } catch (e) { alert("Не найдено"); }
      finally { setLoading(false); setScanCode(""); }
  };

  const addToCart = () => {
      if (!currentBox) return;

      let delta = 0;
      let op = opType;

      if (opType === "CONSUME") {
          const amount = Number(consumeAmount);
          if (!amount || amount <= 0) return alert("Введите корректное количество для списания");
          if (amount > currentBox.quantity) return alert(`Нельзя списать больше, чем есть (${currentBox.quantity})`);

          delta = -amount;
      }

      if (cart.some(i => i.box.id === currentBox.id)) {
          alert("Эта коробка уже в списке!");
          return;
      }

      const item: CartItem = {
          box: currentBox,
          operation: op,
          toSectionId: toSectionId ? Number(toSectionId) : null,
          statusAfter: statusAfter,
          deltaQty: delta,
          goodQty: null,
          scrapQty: null,
          comment: comment
      };

      setCart([item, ...cart]);
      setCurrentBox(null);
  };

  const commitBatch = async () => {
      if (cart.length === 0) return;
      if (!docNumber.trim()) return alert("Введите номер документа/накладной для проведения операции!");

      setLoading(true);
      try {
          await moveBoxesBatch({
              movements: cart.map(c => ({
                  boxId: c.box.id,
                  operation: c.operation,
                  toSectionId: c.toSectionId,
                  statusAfter: c.statusAfter,
                  deltaQty: c.deltaQty,
                  goodQty: c.goodQty || undefined,
                  scrapQty: c.scrapQty || undefined,
                  comment: c.comment
              })),
              documentData: {
                  createNew: true,
                  number: docNumber,
                  type: "MOVE_BATCH",
                  comment: `Пакетная операция (${cart.length} поз.)`
              }
          });
          setCart([]);
          setDocNumber("");
          alert("Операция успешно проведена! Создан документ.");
      } catch (e: any) { alert("Ошибка: " + e.message); }
      finally { setLoading(false); }
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">


        <div className="lg:col-span-5 space-y-4">

             <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <label className="block text-sm font-bold text-gray-700 mb-2">Сканирование</label>
                <div className="flex gap-2">
                    <input
                        value={scanCode} onChange={e => setScanCode(e.target.value)}
                        onKeyDown={e => e.key === 'Enter' && handleScan()}
                        className="w-full p-3 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 text-lg outline-none"
                        placeholder="QR или код..."
                        autoFocus
                    />
                    <button onClick={handleScan} disabled={loading} className="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition">
                        {loading ? <Loader2 className="animate-spin"/> : <Search/>}
                    </button>
                </div>
             </div>


             {currentBox ? (
                 <div className="bg-white rounded-xl shadow-lg border border-indigo-200 overflow-hidden animate-fade-in">
                     <div className="bg-gray-900 p-4 text-white">
                         <div className="flex justify-between items-start">
                            <div>
                                <div className="text-xs text-gray-400 uppercase font-bold">Текущая коробка</div>
                                <h3 className="font-bold text-lg leading-tight mt-1">{currentBox.label}</h3>
                            </div>
                            <div className="text-right">
                                <span className="bg-gray-700 px-2 py-1 rounded text-xs font-mono">{currentBox.shortCode}</span>
                            </div>
                         </div>
                         <div className="mt-2 text-sm opacity-80 flex gap-2 items-center">
                             <AlertCircle size={14}/>
                             <span>Остаток: <b>{currentBox.quantity} {currentBox.unit}</b></span>
                         </div>
                     </div>

                     <div className="p-4 space-y-4">

                         <div className="flex gap-2 bg-gray-100 p-1 rounded-lg">
                             <button onClick={() => setOpType("MOVE")} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${opType === 'MOVE' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>Перемещение</button>
                             <button onClick={() => setOpType("CONSUME")} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${opType === 'CONSUME' ? 'bg-white shadow text-orange-600' : 'text-gray-500'}`}>Расход / Списание</button>
                         </div>


                         {opType === 'CONSUME' ? (
                             <div className="bg-orange-50 p-3 rounded-lg border border-orange-200">
                                 <label className="text-xs font-bold text-orange-800 uppercase">Сколько взять?</label>
                                 <div className="flex gap-2 mt-1">
                                    <input type="number" className="flex-1 p-2 text-xl font-bold border-orange-300 rounded outline-none" value={consumeAmount} onChange={e => setConsumeAmount(Number(e.target.value))} autoFocus />
                                    <div className="flex items-center text-orange-700 font-bold px-2">{currentBox.unit}</div>
                                 </div>
                             </div>
                         ) : (
                             <div className="grid grid-cols-2 gap-3">
                                 <div>
                                     <label className="text-[10px] uppercase font-bold text-gray-500">Куда</label>
                                     <select className="w-full p-2 border rounded text-sm bg-white outline-none" value={toSectionId} onChange={e => setToSectionId(e.target.value ? Number(e.target.value) : "")}>
                                         <option value="">(Текущее)</option>
                                         {sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                     </select>
                                 </div>
                                 <div>
                                     <label className="text-[10px] uppercase font-bold text-gray-500">Статус</label>
                                     <select className="w-full p-2 border rounded text-sm bg-white outline-none" value={statusAfter} onChange={e => setStatusAfter(e.target.value)}>
                                         <option value="ON_STOCK">На складе</option>
                                         <option value="IN_WORK">В работе</option>
                                         <option value="DONE">Готово</option>
                                         <option value="SCRAP">Брак</option>
                                     </select>
                                 </div>
                             </div>
                         )}

                         <input className="w-full p-2 border rounded text-sm outline-none focus:border-indigo-500" placeholder="Комментарий..." value={comment} onChange={e => setComment(e.target.value)} />

                         <button onClick={addToCart} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-md flex justify-center items-center gap-2 transition">
                             <ShoppingCart size={18}/> Добавить в список
                         </button>
                     </div>
                 </div>
             ) : (
                <div className="text-center p-10 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed min-h-[300px] flex flex-col items-center justify-center">
                    <ArrowRightLeft className="mb-2 opacity-20" size={40}/>
                    <p>Отсканируйте коробку, чтобы начать операцию</p>
                </div>
             )}
        </div>


        <div className="lg:col-span-7 h-[calc(100vh-140px)] flex flex-col">
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 h-full flex flex-col overflow-hidden">
                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h3 className="font-bold text-gray-700 flex items-center gap-2"><ShoppingCart size={18}/> Операции к исполнению ({cart.length})</h3>
                    {cart.length > 0 && <button onClick={() => setCart([])} className="text-xs text-red-500 hover:underline">Очистить</button>}
                </div>

                <div className="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50/30">
                    {cart.length === 0 && <div className="text-center py-20 text-gray-300">Список пуст</div>}
                    {cart.map((item, idx) => (
                        <div key={idx} className="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm hover:shadow-md transition group">
                            <div className="flex-1">
                                <div className="font-bold text-sm text-gray-800">{item.box.label} <span className="text-gray-400 font-normal text-xs">#{item.box.id}</span></div>
                                <div className="text-xs text-gray-500 flex flex-wrap gap-2 mt-1 items-center">
                                    {item.deltaQty !== 0
                                        ? <span className="bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded font-bold">РАСХОД: {Math.abs(item.deltaQty)} {item.box.unit}</span>
                                        : <span className="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold">ПЕРЕМЕЩЕНИЕ</span>
                                    }
                                    {item.toSectionId && <span className="flex items-center gap-1"><MapPin size={10}/> Секция #{item.toSectionId}</span>}
                                    {item.statusAfter !== item.box.status && <span>Статус: {item.statusAfter}</span>}
                                    {item.comment && <span className="italic text-gray-400">"{item.comment}"</span>}
                                </div>
                            </div>
                            <button onClick={() => setCart(cart.filter((_, i) => i !== idx))} className="p-2 text-gray-300 hover:text-red-500 transition">
                                <Trash2 size={16}/>
                            </button>
                        </div>
                    ))}
                </div>

                <div className="p-4 border-t bg-indigo-50">
                    <label className="text-xs font-bold text-indigo-800 uppercase mb-1 block">Номер документа / Накладной</label>
                    <div className="flex gap-2">
                        <input
                            value={docNumber} onChange={e => setDocNumber(e.target.value)}
                            className="flex-1 p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="Напр: ТН-2025-10-15"
                        />
                        <button onClick={commitBatch} disabled={loading || cart.length === 0} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow transition flex items-center gap-2 disabled:opacity-50">
                            {loading ? <Loader2 className="animate-spin"/> : <Save size={18}/>} Провести
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehousePrintHistory.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchPrintHistory } from "src/api/warehouseApi";
import {
    Search, Printer, User, History,
    ArrowRight, Tv, Tag, Info, FileText
} from "lucide-react";
import { formatDateTime } from "../utils";
import { Modal } from "src/components/Modal/Modal";
import clsx from "clsx";

export const WarehousePrintHistory: React.FC = () => {
    const [data, setData] = useState<any[]>([]);
    const [totalCount, setTotalCount] = useState(0);
    const [loading, setLoading] = useState(false);


    const [page, setPage] = useState(1);
    const [search, setSearch] = useState("");
    const [template, setTemplate] = useState("");
    const [dateFrom, setDateFrom] = useState("");


    const [selectedItem, setSelectedItem] = useState<any | null>(null);

    const loadData = async () => {
        setLoading(true);
        try {
            const res = await fetchPrintHistory({
                page,
                limit: 20,
                search,
                template,
                dateFrom
            });
            setData(res.rows);
            setTotalCount(res.count);
        } catch (e) {
            console.error(e);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        const timer = setTimeout(loadData, 500);
        return () => clearTimeout(timer);
    }, [page, search, template, dateFrom]);


    const getTemplateIcon = (type: string) => {
        if (type === "VIDEO_KIT") return <Tv size={16} className="text-indigo-600"/>;
        return <Tag size={16} className="text-gray-600"/>;
    };

    return (
        <div className="space-y-6 animate-fade-in">

            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between gap-4">
                <div className="flex items-center gap-3 text-gray-700 font-bold text-lg">
                    <History className="text-indigo-600" /> История печати
                </div>

                <div className="flex flex-wrap gap-3 flex-1 justify-end">
                    <div className="relative w-full md:w-64">
                        <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4" />
                        <input
                            value={search} onChange={e => setSearch(e.target.value)}
                            className="w-full pl-9 pr-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="Название, ID или Код..."
                        />
                    </div>

                    <select
                        value={template} onChange={e => setTemplate(e.target.value)}
                        className="p-2 border rounded-lg text-sm bg-gray-50 font-medium"
                    >
                        <option value="">Все шаблоны</option>
                        <option value="VIDEO_KIT">Видеокомплект</option>
                        <option value="SIMPLE">Универсальная</option>
                    </select>

                    <input
                        type="date"
                        value={dateFrom} onChange={e => setDateFrom(e.target.value)}
                        className="p-2 border rounded-lg text-sm text-gray-600"
                    />
                </div>
            </div>


            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                        <tr>
                            <th className="px-6 py-4">Дата / Время</th>
                            <th className="px-6 py-4">Сотрудник</th>
                            <th className="px-6 py-4">Шаблон</th>
                            <th className="px-6 py-4">Наименование</th>
                            <th className="px-6 py-4">Диапазон (ID)</th>
                            <th className="px-6 py-4 text-center">Тираж</th>
                            <th className="px-6 py-4 text-right">Инфо</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100 text-sm">
                        {loading ? (
                            <tr><td colSpan={7} className="p-8 text-center text-gray-400">Загрузка...</td></tr>
                        ) : data.length === 0 ? (
                            <tr><td colSpan={7} className="p-8 text-center text-gray-400">История пуста</td></tr>
                        ) : (
                            data.map(item => (
                                <tr key={item.id} className="hover:bg-slate-50 transition group">
                                    <td className="px-6 py-4 text-gray-600 whitespace-nowrap">
                                        {formatDateTime(item.createdAt)}
                                    </td>
                                    <td className="px-6 py-4">
                                        <div className="flex items-center gap-2">
                                            <div className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">
                                                {item.createdBy?.name?.[0] || <User size={12}/>}
                                            </div>
                                            <span className="font-medium text-gray-800">
                                                {item.createdBy ? `${item.createdBy.surname} ${item.createdBy.name}` : "Система"}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4">
                                        <div className="flex items-center gap-2">
                                            {getTemplateIcon(item.template)}
                                            <span className={clsx("text-xs font-bold px-2 py-0.5 rounded", item.template === "VIDEO_KIT" ? "bg-indigo-50 text-indigo-700" : "bg-gray-100 text-gray-700")}>
                                                {item.template === "VIDEO_KIT" ? "Видео" : "Простая"}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 font-bold text-gray-800 max-w-xs truncate" title={item.labelName}>
                                        {item.labelName}
                                    </td>
                                    <td className="px-6 py-4 font-mono text-xs text-gray-600">
                                        {item.quantity > 1 ? (
                                            <div className="flex items-center gap-1">
                                                {item.startCode} <ArrowRight size={10} className="text-gray-400"/> {item.endCode}
                                            </div>
                                        ) : (
                                            item.startCode
                                        )}
                                    </td>
                                    <td className="px-6 py-4 text-center">
                                        <span className="font-bold text-lg">{item.quantity}</span>
                                        <span className="text-xs text-gray-400 ml-1">шт</span>
                                    </td>
                                    <td className="px-6 py-4 text-right">
                                        <button
                                            onClick={() => setSelectedItem(item)}
                                            className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition"
                                        >
                                            <Info size={18}/>
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>


                <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center text-xs text-gray-500">
                    <span>Всего записей: {totalCount}</span>
                    <div className="flex gap-2">
                        <button disabled={page === 1} onClick={() => setPage(p => p - 1)} className="px-3 py-1 bg-white border rounded hover:bg-gray-100 disabled:opacity-50">Назад</button>
                        <span className="py-1 px-2">Стр. {page}</span>
                        <button disabled={data.length < 20} onClick={() => setPage(p => p + 1)} className="px-3 py-1 bg-white border rounded hover:bg-gray-100 disabled:opacity-50">Вперед</button>
                    </div>
                </div>
            </div>


            <Modal isOpen={!!selectedItem} onClose={() => setSelectedItem(null)}>
                {selectedItem && (
                    <div className="p-6 max-w-lg w-full">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-indigo-50 rounded-full text-indigo-600">
                                <Printer size={24}/>
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-gray-800">Детали печати</h3>
                                <p className="text-xs text-gray-500">ID операции: {selectedItem.id}</p>
                            </div>
                        </div>

                        <div className="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm">
                            <div className="flex justify-between">
                                <span className="text-gray-500">Наименование:</span>
                                <span className="font-bold">{selectedItem.labelName}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">Дата печати:</span>
                                <span>{formatDateTime(selectedItem.createdAt)}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">Тираж:</span>
                                <span className="font-bold">{selectedItem.quantity} шт.</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">Размер бумаги:</span>
                                <span>{selectedItem.params?.widthMm} x {selectedItem.params?.heightMm} мм</span>
                            </div>

                            {selectedItem.params?.contract && (
                                <div className="border-t border-gray-200 pt-2 mt-2">
                                    <span className="text-gray-500 block mb-1">Договор:</span>
                                    <p className="bg-white p-2 rounded border border-gray-200 text-xs text-gray-700 italic">
                                        {selectedItem.params.contract}
                                    </p>
                                </div>
                            )}


                            <div className="border-t border-gray-200 pt-2 mt-2">
                                <span className="text-gray-500 block mb-1 flex items-center gap-1"><FileText size={12}/> Сырые данные (JSON):</span>
                                <pre className="bg-slate-800 text-green-400 p-2 rounded text-[10px] overflow-auto max-h-32">
                                    {JSON.stringify(selectedItem.params, null, 2)}
                                </pre>
                            </div>
                        </div>

                        <button
                            onClick={() => setSelectedItem(null)}
                            className="w-full mt-6 py-3 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition"
                        >
                            Закрыть
                        </button>
                    </div>
                )}
            </Modal>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/tabs/WarehouseSettings.tsx
================================================================================

import React, { useEffect, useState } from "react";
import { fetchStockBalance, fetchAllLimits, saveLimit } from "src/api/warehouseApi";
import { InventoryLimitModel, StockBalanceItem } from "src/types/WarehouseModels";
import { Search, AlertTriangle, Settings } from "lucide-react";
import toast from "react-hot-toast";

export const WarehouseSettings: React.FC = () => {
    const [items, setItems] = useState<any[]>([]);
    const [search, setSearch] = useState("");
    const [loading, setLoading] = useState(false);

    const loadData = async () => {
        setLoading(true);
        try {
            const [balance, limits] = await Promise.all([
                fetchStockBalance(),
                fetchAllLimits()
            ]);


            const limitsMap = new Map();
            limits.forEach(l => limitsMap.set(l.label, l.minQuantity));

            const uniqueItems = new Map();

            balance.forEach(b => {
                uniqueItems.set(b.label, {
                    label: b.label,
                    originType: b.originType,
                    originId: b.originId,
                    current: Number(b.totalQuantity),
                    min: limitsMap.get(b.label) || 0
                });
            });

            limits.forEach(l => {
                if (!uniqueItems.has(l.label)) {
                    uniqueItems.set(l.label, {
                        label: l.label,
                        originType: l.originType,
                        originId: l.originId,
                        current: 0,
                        min: l.minQuantity
                    });
                }
            });

            setItems(Array.from(uniqueItems.values()));

        } catch (e) {
            console.error(e);
            toast.error("Ошибка загрузки настроек");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => { loadData(); }, []);

    const handleSave = async (item: any, newMin: string) => {
        const val = parseInt(newMin);
        if (isNaN(val)) return;
        if (val === item.min) return;

        try {
            await saveLimit({
                label: item.label,
                min: val,
                originType: item.originType,
                originId: item.originId
            });
            toast.success(`Лимит для "${item.label}" обновлен`);
            setItems(prev => prev.map(i => i.label === item.label ? { ...i, min: val } : i));
        } catch (e) {
            toast.error("Не удалось сохранить");
        }
    };

    const filteredItems = items.filter(i => i.label.toLowerCase().includes(search.toLowerCase()));

    return (
        <div className="animate-fade-in max-w-4xl mx-auto">
            <div className="flex justify-between items-end mb-6">
                <div>
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <Settings className="text-indigo-600"/> Настройки склада
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">Установите минимальные остатки для получения уведомлений</p>
                </div>

                <div className="relative">
                    <Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4"/>
                    <input
                        value={search} onChange={e => setSearch(e.target.value)}
                        className="pl-9 pr-4 py-2 border rounded-lg text-sm w-64 focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="Поиск по названию..."
                    />
                </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table className="w-full text-left">
                    <thead className="bg-gray-50 text-xs text-gray-500 uppercase font-semibold">
                        <tr>
                            <th className="px-6 py-4">Наименование</th>
                            <th className="px-6 py-4 text-center">Текущий остаток</th>
                            <th className="px-6 py-4 text-center w-48">Мин. остаток</th>
                            <th className="px-6 py-4">Статус</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {loading && <tr><td colSpan={4} className="p-8 text-center text-gray-400">Загрузка...</td></tr>}

                        {!loading && filteredItems.map((item, idx) => (
                            <tr key={idx} className="hover:bg-gray-50 transition">
                                <td className="px-6 py-4 font-medium text-gray-800">{item.label}</td>
                                <td className="px-6 py-4 text-center text-gray-600 font-mono">{item.current}</td>
                                <td className="px-6 py-4 text-center">
                                    <input
                                        type="number"
                                        defaultValue={item.min}
                                        onBlur={(e) => handleSave(item, e.target.value)}
                                        className="w-24 p-2 text-center border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition"
                                    />
                                </td>
                                <td className="px-6 py-4">
                                    {item.min > 0 && item.current < item.min ? (
                                        <span className="flex items-center gap-1 text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded-full w-max">
                                            <AlertTriangle size={12}/> Дефицит (-{item.min - item.current})
                                        </span>
                                    ) : (
                                        item.min > 0 && <span className="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-full">OK</span>
                                    )}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                {!loading && filteredItems.length === 0 && (
                    <div className="p-8 text-center text-gray-400">Ничего не найдено</div>
                )}
            </div>
        </div>
    );
};

================================================================================
FILE: QMS-Client-main/src/pages/Warehouse/utils.ts
================================================================================

export const formatDateTime = (iso: string | null | undefined) => {
  if (!iso) return "—";
  return new Date(iso).toLocaleString("ru-RU", {
    day: "2-digit", month: "2-digit", hour: "2-digit", minute: "2-digit"
  });
};

export const getStatusBadge = (status: string) => {
  switch (status) {
    case "ON_STOCK": return "bg-emerald-100 text-emerald-700 border-emerald-200";
    case "IN_WORK": return "bg-blue-100 text-blue-700 border-blue-200";
    case "DONE": return "bg-purple-100 text-purple-700 border-purple-200";
    case "SCRAP": return "bg-red-100 text-red-700 border-red-200";
    default: return "bg-gray-100 text-gray-700 border-gray-200";
  }
};


export const calculateBatch = (total: number, capacity: number) => {

    const safeTotal = Math.max(0, Number(total) || 0);


    const safeCapacity = Math.max(1, Number(capacity) || 1);

    if (safeTotal === 0) {
        return { fullUnits: 0, remainder: 0, totalUnits: 0 };
    }

    const fullUnits = Math.floor(safeTotal / safeCapacity);
    const remainder = safeTotal % safeCapacity;


    const totalUnits = fullUnits + (remainder > 0 ? 1 : 0);

    return { fullUnits, remainder, totalUnits };
};

================================================================================
FILE: QMS-Client-main/src/routes.ts
================================================================================

import { AdminPanel } from "./pages/Admin/AdminPanel";
import { AdminPCs } from "./pages/Admin/AdminPCs/AdminPCs";
import { AdminUsers } from "./pages/Admin/AdminUsers/AdminUsers";
import { StructurePage } from "./pages/Admin/Structure/StructurePage";
import { AuditLogPage } from "./pages/Admin/Audit/AuditLogPage";
import { SelectPC } from "./pages/PCs/SelectPC";
import { Profile } from "./pages/Profile/Profile";
import { StartPage } from "./pages/StartPage/StartPage";
import { Users } from "./pages/Users/Users";
import { Login } from "./pages/Login/Login";
import { Registration } from "./pages/Login/Registration";

import { WarehousePage as AdminWarehousePage } from "./pages/Admin/Warehouse/WarehousePage";
import { WarehousePage as UserWarehousePage } from "./pages/Warehouse/WarehousePage";
import { AnalyticsPage } from "./pages/Warehouse/AnalyticsPage";
import { InventoryPage } from "./pages/Warehouse/InventoryPage";

import TasksPage from "./pages/Tasks/TasksPage";

import { AdminRightsPage } from "./pages/Admin/RBAC/AdminRightsPage";
import { ModulesPage } from "./pages/Admin/Modules/ModulesPage";


import { QmsDashboardPage } from "./pages/QMS/QmsDashboardPage";
import { DocumentsPage } from "./pages/Documents/DocumentsPage";
import { NonconformityPage } from "./pages/Nonconformity/NonconformityPage";
import { CapaPage } from "./pages/CAPA/CapaPage";
import RisksPage from "./pages/Quality/RisksPage";
import SuppliersPage from "./pages/Quality/SuppliersPage";
import AuditsPage from "./pages/Quality/AuditsPage";
import TrainingPage from "./pages/Quality/TrainingPage";
import EquipmentPage from "./pages/Quality/EquipmentPage";
import ReviewPage from "./pages/Quality/ReviewPage";

import {
  ADMIN_PCs_ROUTE,
  ADMIN_ROUTE,
  ADMIN_USERS_ROUTE,
  PROFILE_ROUTE,
  SELECT_PC_ROUTE,
  START_ROUTE,
  USERS_ROUTE,
  STRUCTURE_ROUTE,
  AUDIT_LOG_ROUTE,
  ADMIN_WAREHOUSE_ROUTE,
  WAREHOUSE_ROUTE,
  WAREHOUSE_ANALYTICS_ROUTE,
  WAREHOUSE_INVENTORY_ROUTE,
  TASKS_ROUTE,
  ADMIN_RBAC_ROUTE,
  ADMIN_MODULES_ROUTE,
  LOGIN_ROUTE,
  REGISTRATION_ROUTE,
  QMS_DASHBOARD_ROUTE,
  DOCUMENTS_ROUTE,
  NC_ROUTE,
  CAPA_ROUTE,
  RISKS_ROUTE,
  SUPPLIERS_ROUTE,
  INTERNAL_AUDITS_ROUTE,
  TRAINING_ROUTE,
  EQUIPMENT_ROUTE,
  REVIEW_ROUTE,
} from "./utils/consts";


export const qmsRoutes = [
  { path: QMS_DASHBOARD_ROUTE, Component: QmsDashboardPage },
  { path: DOCUMENTS_ROUTE, Component: DocumentsPage },
  { path: NC_ROUTE, Component: NonconformityPage },
  { path: CAPA_ROUTE, Component: CapaPage },
  { path: RISKS_ROUTE, Component: RisksPage },
  { path: SUPPLIERS_ROUTE, Component: SuppliersPage },
  { path: INTERNAL_AUDITS_ROUTE, Component: AuditsPage },
  { path: TRAINING_ROUTE, Component: TrainingPage },
  { path: EQUIPMENT_ROUTE, Component: EquipmentPage },
  { path: REVIEW_ROUTE, Component: ReviewPage },
];

export const authRoutes = [
  { path: SELECT_PC_ROUTE, Component: SelectPC },
  { path: PROFILE_ROUTE, Component: Profile },
  { path: WAREHOUSE_ROUTE, Component: UserWarehousePage },
  { path: WAREHOUSE_ANALYTICS_ROUTE, Component: AnalyticsPage },
  { path: WAREHOUSE_INVENTORY_ROUTE, Component: InventoryPage },
  { path: TASKS_ROUTE, Component: TasksPage },
];

export const adminRoutes = [
  { path: ADMIN_ROUTE, Component: AdminPanel },
  { path: STRUCTURE_ROUTE, Component: StructurePage },
  { path: AUDIT_LOG_ROUTE, Component: AuditLogPage },
  { path: ADMIN_PCs_ROUTE, Component: AdminPCs },
  { path: ADMIN_USERS_ROUTE, Component: AdminUsers },
  { path: ADMIN_WAREHOUSE_ROUTE, Component: AdminWarehousePage },
  { path: ADMIN_RBAC_ROUTE, Component: AdminRightsPage },
  { path: ADMIN_MODULES_ROUTE, Component: ModulesPage },
];

export const publicRoutes = [
  { path: START_ROUTE, Component: StartPage },
  { path: USERS_ROUTE, Component: Users },
  { path: LOGIN_ROUTE, Component: Login },
  { path: REGISTRATION_ROUTE, Component: Registration },
];

================================================================================
FILE: QMS-Client-main/src/setupTests.ts
================================================================================

import '@testing-library/jest-dom';
================================================================================
FILE: QMS-Client-main/src/store/ModuleStore.ts
================================================================================

import { makeAutoObservable, runInAction } from 'mobx';
import { $host } from '../api/index';

export interface ModuleInfo {
  code: string;
  name: string;
  group: string;
  enabled: boolean;
}

export interface ModulesConfig {
  tier: string;
  enabled: string[];
  groups: string[];
  maxUsers: number;
  modules: ModuleInfo[];
}

export default class ModuleStore {
  config: ModulesConfig | null = null;
  loading = true;
  error: string | null = null;

  constructor() {
    makeAutoObservable(this);
  }

  async fetchModules() {
    try {
      this.loading = true;
      const { data } = await $host.get<ModulesConfig>('/api/system/modules');
      runInAction(() => {
        this.config = data;
        this.error = null;
      });
    } catch (e: any) {
      console.error('Failed to fetch modules config:', e);
      runInAction(() => {
        
        this.config = {
          tier: 'fallback',
          enabled: [],
          groups: ['core', 'qms', 'wms'],
          maxUsers: 999,
          modules: [],
        };
        this.error = e?.message || 'Failed to load modules';
      });
    } finally {
      runInAction(() => { this.loading = false; });
    }
  }

  
  isEnabled(code: string): boolean {
    if (!this.config) return true; 
    if (this.config.tier === 'fallback') return true; 
    if (this.config.enabled.includes(code)) return true;
    
    return this.config.enabled.some(m => m.startsWith(code + '.'));
  }

  
  hasGroup(group: string): boolean {
    if (!this.config) return true;
    if (this.config.tier === 'fallback') return true;
    return this.config.groups.includes(group);
  }

  get tierName(): string {
    const names: Record<string, string> = {
      start: 'Старт', standard: 'Стандарт', pro: 'Про',
      industry: 'Индустрия', 'dev-all': 'Разработка', fallback: 'Все модули',
    };
    return names[this.config?.tier || ''] || this.config?.tier || '—';
  }

  get enabledCount(): number {
    return this.config?.enabled.length || 0;
  }
}

================================================================================
FILE: QMS-Client-main/src/store/StructureStore.ts
================================================================================

import { makeAutoObservable } from "mobx";
import { userGetModel } from "src/types/UserModel";

export interface TeamModel {
    id: number;
    title: string;
    sectionId: number;
    teamLead: userGetModel | null;
    users: userGetModel[];
}

export interface SectionModel {
    id: number;
    title: string;
    manager: userGetModel | null;
    production_teams: TeamModel[];
}

export default class StructureStore {
    sections: SectionModel[] = [];

    constructor() {
        makeAutoObservable(this);
    }

    setSections(sections: SectionModel[]) {
        this.sections = sections;
    }
}

================================================================================
FILE: QMS-Client-main/src/store/UserStore.ts
================================================================================

import { makeAutoObservable } from "mobx"
import { userModel } from "src/types/UserModel"

export default class UserStore {
    private _isAuth: boolean = false
    private _user: userModel | null = null

    constructor() {
        makeAutoObservable(this)
    }

    setIsAuth(bool: boolean) {
        this._isAuth = bool
    }

    setUser(user: userModel) {
        this._user = user
    }

    resetUser() {
        this._user = null
        this._isAuth = false
    }


    can(permission: string): boolean {
        if (!this._user) return false;


        if (this._user.role === 'SUPER_ADMIN') return true;


        return this._user.abilities?.includes(permission) || false;
    }


    hasRole(role: string): boolean {
        return this._user?.role === role;
    }


    get user() {
        return this._user
    }

    get isAuth() {
        return this._isAuth
    }


    get isAdmin() {
        return this.can('admin.access') || this.can('rbac.manage');
    }
}

================================================================================
FILE: QMS-Client-main/src/store/__tests__/UserStore.test.ts
================================================================================

import { describe, it, expect, beforeEach } from 'vitest';
import UserStore from '../UserStore';

describe('UserStore RBAC', () => {
    let store: UserStore;

    beforeEach(() => {
        store = new UserStore();
    });

    it('SUPER_ADMIN должен иметь доступ ко всему', () => {
        store.setUser({
            id: 1, login: 'admin', name: 'Adm', surname: 'Adm', role: 'SUPER_ADMIN', abilities: [], exp:0, iat:0, img: null
        });

        expect(store.can('warehouse.view')).toBe(true);
        expect(store.can('nuclear.launch')).toBe(true);
    });

    it('Обычный пользователь должен иметь доступ только при наличии права', () => {
        store.setUser({
            id: 2, login: 'user', name: 'User', surname: 'U', role: 'USER',
            abilities: ['warehouse.view'],
            exp:0, iat:0, img: null
        });

        expect(store.can('warehouse.view')).toBe(true);
        expect(store.can('users.manage')).toBe(false);
    });

    it('Гость (не залогинен) не должен иметь прав', () => {
        store.resetUser();
        expect(store.can('warehouse.view')).toBe(false);
    });
});

================================================================================
FILE: QMS-Client-main/src/types/AuditLogModel.ts
================================================================================

export interface AuditLogUserShort {
  id: number;
  login: string;
  name: string;
  surname: string;
}

export interface AuditLogMetadata {
  ip?: string | null;
  userAgent?: string | null;
  PCId?: number | null;
  pcName?: string | null;
  pcIp?: string | null;

  [key: string]: any;
}

export interface AuditLogModel {
  id: number;
  userId: number | null;
  action: string;
  entity: string | null;
  entityId: string | null;
  description: string | null;
  metadata: AuditLogMetadata | null;
  createdAt: string;
  updatedAt: string;
  User?: AuditLogUserShort | null;
}

================================================================================
FILE: QMS-Client-main/src/types/PCModel.ts
================================================================================

export interface pcModelFull {
    id: number;
    ip: string;
    pc_name: string;
    cabinet: string;
    createdAt: string;
    updatedAt: string;
}
export interface pcModelMed {
    id: number;
    ip: string;
    pc_name: string;
    cabinet: string;
}
export interface pcModelShort {
    ip: string;
    pc_name: string;
    cabinet: string;
}
================================================================================
FILE: QMS-Client-main/src/types/ProductModel.ts
================================================================================

export interface productModel {
    id: number;
    title: string;
    status_id: number;
    createdAt: string;
    updatedAt: string;
    Status: productStatusModel
}

export interface productStatusModel {
    id: number;
    title: string;
    createdAt: string;
    updatedAt: string;
}
================================================================================
FILE: QMS-Client-main/src/types/SessionModel.ts
================================================================================

export interface SessionModelFull {
    id: number;
    online: boolean;
    userId: number;
    PCId: number;
    createdAt: string;
    updatedAt: string;
}
export interface SessionModelShort {
    online: boolean;
    userId: number;
    PCId: number;
}
================================================================================
FILE: QMS-Client-main/src/types/UserModel.ts
================================================================================

export interface userModel {
    exp: number;
    iat: number;
    id: number;
    login: string;
    name: string;

    role: "SUPER_ADMIN" | "PRODUCTION_CHIEF" | "TECHNOLOGIST" | "WAREHOUSE_MASTER" | "ASSEMBLER" | "QC_ENGINEER" | "FIRMWARE_OPERATOR" | string;
    surname: string;
    img: string | null;
    abilities?: string[];
}

export interface userGetModel {
    id: number;
    login: string;
    password: string;
    role: string;
    name: string;
    surname: string;
    img: string | null;
    createdAt: string;
    updatedAt: string;
    abilities?: string[];
}

export interface userModelShort {
    login: string;
    password: string;
}

================================================================================
FILE: QMS-Client-main/src/types/WarehouseModels.ts
================================================================================

export interface WarehouseUserShort {
  id: number;
  login: string;
  name: string;
  surname: string;
}

export interface WarehouseSectionShort {
  id: number;
  title: string;
}

export interface WarehouseTeamShort {
  id: number;
  title: string;
}


export interface SupplyModel {
  id: number;
  supplier: string | null;
  docNumber: string | null;
  status: string;
  comment: string | null;
  expectedDate: string | null;
  createdAt: string;
  updatedAt: string;
}


export interface InventoryBoxModel {
  id: number;
  supplyId: number | null;

  qrCode: string;
  shortCode: string | null;

  label: string;
  displayName?: string;
  labelCode?: string;

  originType: string | null;
  originId: number | null;

  quantity: number;
  unit: string;

  parentBoxId: number | null;

  boxNumber: string | null;
  kitNumber: string | null;
  projectName: string | null;
  batchName: string | null;

  status: string;
  notes: string | null;

  currentSectionId: number | null;
  currentTeamId: number | null;

  createdAt: string;
  updatedAt: string;

  section?: WarehouseSectionShort | null;
  team?: WarehouseTeamShort | null;
  currentSection?: WarehouseSectionShort | null;
  currentTeam?: WarehouseTeamShort | null;
  supply?: SupplyModel | null;
}

export interface WarehouseMovement {
  id: number;
  boxId: number;
  documentId?: number | null;

  fromSectionId: number | null;
  toSectionId: number | null;
  fromTeamId: number | null;
  toTeamId: number | null;

  operation: string;
  statusAfter: string | null;

  deltaQty: number;
  goodQty?: number | null;
  scrapQty?: number | null;

  performedAt: string;
  comment: string | null;

  performedBy?: WarehouseUserShort;
  fromSection?: WarehouseSectionShort;
  toSection?: WarehouseSectionShort;
  fromTeam?: WarehouseTeamShort;
  toTeam?: WarehouseTeamShort;
}

export interface WarehouseDocument {
  id: number;
  boxId: number | null;
  number: string;
  type: string | null;
  date: string | null;
  fileUrl: string | null;
  comment: string | null;
  createdById: number;
  createdAt: string;
  updatedAt: string;
  createdBy?: WarehouseUserShort;
}

export interface StockBalanceItem {
  label: string;
  originType: string | null;
  originId: number | null;
  unit: string;
  totalQuantity: string;
  boxCount: string;
}

export interface InventoryLimitModel {
  id: number;
  label: string;
  min: number;
  originType?: string;
  originId?: number;
}

================================================================================
FILE: QMS-Client-main/src/utils/consts.ts
================================================================================



export const ADMIN_ROUTE = '/admin';
export const ADMIN_PCs_ROUTE = '/admin/pcs';
export const ADMIN_USERS_ROUTE = '/admin/users';
export const STRUCTURE_ROUTE = '/admin/structure';
export const AUDIT_LOG_ROUTE = '/admin/audit-log';
export const ADMIN_WAREHOUSE_ROUTE = '/admin/warehouse';
export const ADMIN_RBAC_ROUTE = '/admin/rbac';
export const ADMIN_MODULES_ROUTE = '/admin/modules';

export const LOGIN_ROUTE = '/login';
export const SELECT_PC_ROUTE = '/select-pc-for-start-session';
export const REGISTRATION_ROUTE = '/registration';
export const USERS_ROUTE = '/users';
export const PROFILE_ROUTE = '/profile';

export const START_ROUTE = '/';

export const WAREHOUSE_ROUTE = '/warehouse';
export const WAREHOUSE_ANALYTICS_ROUTE = '/warehouse/analytics';
export const WAREHOUSE_INVENTORY_ROUTE = '/warehouse/inventory';

export const TASKS_ROUTE = '/tasks';


export const QMS_DASHBOARD_ROUTE = '/qms';
export const DOCUMENTS_ROUTE = '/qms/documents';
export const NC_ROUTE = '/qms/nonconformity';
export const CAPA_ROUTE = '/qms/capa';
export const RISKS_ROUTE = '/qms/risks';
export const SUPPLIERS_ROUTE = '/qms/suppliers';
export const INTERNAL_AUDITS_ROUTE = '/qms/audits';
export const TRAINING_ROUTE = '/qms/training';
export const EQUIPMENT_ROUTE = '/qms/equipment';
export const REVIEW_ROUTE = '/qms/review';
export const QMS_PROTOTYPE_ROUTE = '/qms/prototype';

================================================================================
FILE: QMS-Client-main/src/utils/constsModalType.ts
================================================================================

  export const CREATE_COMPUTER = 'createPC'
  export const CREATE_USER = 'createUser'

================================================================================
FILE: QMS-Client-main/src/vite-env.d.ts
================================================================================



================================================================================
FILE: QMS-Client-main/tailwind.config.js
================================================================================


export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        asvo: {
          bg:           '#080E14',
          surface:      '#0D1520',
          'surface-2':  '#162231',
          'surface-3':  '#1C2D40',
          card:         '#111D2B',
          'card-hover': '#152436',
          border:       '#1A2D42',
          'border-lt':  '#1E3A54',
          accent:       '#2DD4A8',
          'accent-dim': 'rgba(45,212,168,0.15)',
          'accent-glow':'rgba(45,212,168,0.25)',
          text:         '#E8EDF3',
          'text-mid':   '#8899AB',
          'text-dim':   '#4A5E72',
          red:          '#F06060',
          'red-dim':    'rgba(240,96,96,0.12)',
          amber:        '#E8A830',
          'amber-dim':  'rgba(232,168,48,0.12)',
          blue:         '#4A90E8',
          'blue-dim':   'rgba(74,144,232,0.12)',
          purple:       '#A06AE8',
          'purple-dim': 'rgba(160,106,232,0.12)',
          green:        '#2DD4A8',
          'green-dim':  'rgba(45,212,168,0.12)',
          grey:         '#3A4E62',
          'grey-dim':   'rgba(58,78,98,0.15)',
          orange:       '#E87040',
        },
      },
      fontFamily: {
        sans: ['Inter', 'SF Pro Display', '-apple-system', 'sans-serif'],
        mono: ['JetBrains Mono', 'SF Mono', 'Fira Code', 'monospace'],
      },
      animation: {
        'fade-in': 'fadeIn 0.4s ease-out forwards',
        'slide-in-up': 'slideInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
        'scale-in': 'scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
        'card-hover': 'cardHover 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideInUp: {
          '0%': { opacity: '0', transform: 'translateY(15px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
        scaleIn: {
          '0%': { opacity: '0', transform: 'scale(0.95)' },
          '100%': { opacity: '1', transform: 'scale(1)' },
        },
        cardHover: {
          '0%': { transform: 'translateY(0)' },
          '100%': { transform: 'translateY(-2px)' },
        },
      },
    },
  },
  plugins: [],
}

================================================================================
FILE: QMS-Client-main/tsconfig.json
================================================================================

{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,

    
    "baseUrl": ".",
    "paths": {
      "public/*": ["public/*"],
      "src/*": ["src/*"],
      "api/*": ["src/api/*"],
      "assets/*": ["src/assets/*"],
      "components/*": ["src/components/*"],
      "pages/*": ["src/pages/*"],
      "store/*": ["src/store/*"],
      "types/*": ["src/types/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}

================================================================================
FILE: QMS-Client-main/tsconfig.node.json
================================================================================

{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true,
    "strict": true
  },
  "include": ["vite.config.ts"]
}

================================================================================
FILE: QMS-Client-main/vite.config.ts
================================================================================

import { defineConfig } from "vite";
import react from "@vitejs/plugin-react-swc";
import { VitePWA } from "vite-plugin-pwa";


export default defineConfig({
  preview: {
    host: "0.0.0.0",
    port: 4173,
  },

  plugins: [
    react(),
    VitePWA({
      registerType: "autoUpdate",
      workbox: {
        maximumFileSizeToCacheInBytes: 5 * 1024 * 1024,
      },
      includeAssets: [
        "favicon.ico",
        "apple-touch-icon.png",
        "maskable-icon-512x512.svg",
      ],
      manifest: {
        name: "MES_crypto",
        short_name: "Vite PWA Project",
        theme_color: "#ffffff",
        icons: [
          {
            src: "pwa-64x64.png",
            sizes: "64x64",
            type: "image/png",
          },
          {
            src: "pwa-192x192.png",
            sizes: "192x192",
            type: "image/png",
          },
          {
            src: "pwa-512x512.png",
            sizes: "512x512",
            type: "image/png",
            purpose: "any",
          },
          {
            src: "maskable-icon-512x512.png",
            sizes: "512x512",
            type: "image/png",
            purpose: "maskable",
          },
        ],
      },
    }),
  ],

  resolve: {
    alias: {
      public: "/public",
      src: "/src",
      api: "/src/api",
      assets: "/src/assets",
      components: "/src/components",
      pages: "src/pages",
      store: "/src/store",
      types: "/src/types",
    },
  },
});

================================================================================
FILE: QMS-Client-main/vitest.config.ts
================================================================================

import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react-swc';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      public: path.resolve(__dirname, './public'),
      src: path.resolve(__dirname, './src'),
      api: path.resolve(__dirname, './src/api'),
      assets: path.resolve(__dirname, './src/assets'),
      components: path.resolve(__dirname, './src/components'),
      pages: path.resolve(__dirname, './src/pages'),
      store: path.resolve(__dirname, './src/store'),
      types: path.resolve(__dirname, './src/types'),
    },
  },
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/setupTests.ts',
    css: true,
  },
});

================================================================================
FILE: QMS-Mobile/mes-pwa/deploy.sh
================================================================================

#!/bin/bash














set -e


RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'


APP_NAME="ASVO-QMS PWA"
VERSION="2.0.0"
BUILD_DIR="./dist"
DEPLOY_DIR="/var/www/mes-pwa"
NGINX_CONF_SRC="./nginx/mes-pwa-gateway.conf"
NGINX_CONF_DST="/etc/nginx/sites-available/mes-pwa-gateway.conf"
NGINX_ENABLED="/etc/nginx/sites-enabled/mes-pwa-gateway.conf"


ENVIRONMENT=${1:-production}





log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║            $APP_NAME v$VERSION                  ║"
    echo "║                  Deployment Script                         ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""
    log_info "Environment: $ENVIRONMENT"
    echo ""
}

check_requirements() {
    log_info "Проверка требований..."
    

    if ! command -v node &> /dev/null; then
        log_error "Node.js не установлен!"
        exit 1
    fi
    log_success "Node.js: $(node -v)"
    

    if ! command -v npm &> /dev/null; then
        log_error "npm не установлен!"
        exit 1
    fi
    log_success "npm: $(npm -v)"
    

    if [ "$ENVIRONMENT" = "production" ]; then
        if ! command -v nginx &> /dev/null; then
            log_warning "Nginx не установлен. Пропускаем настройку веб-сервера."
        else
            log_success "Nginx: $(nginx -v 2>&1 | head -1)"
        fi
    fi
}

install_dependencies() {
    log_info "Установка зависимостей..."
    
    if [ -f "package-lock.json" ]; then
        npm ci
    else
        npm install
    fi
    
    log_success "Зависимости установлены"
}

build_app() {
    log_info "Сборка приложения..."
    

    rm -rf "$BUILD_DIR"
    

    npm run build
    

    if [ ! -d "$BUILD_DIR" ]; then
        log_error "Сборка не удалась - папка dist не создана"
        exit 1
    fi
    
    log_success "Сборка завершена: $BUILD_DIR"
    log_info "Размер сборки: $(du -sh $BUILD_DIR | cut -f1)"
}

deploy_files() {
    log_info "Развёртывание файлов..."
    

    sudo mkdir -p "$DEPLOY_DIR"
    

    sudo rm -rf "${DEPLOY_DIR:?}"/*
    

    sudo cp -r "$BUILD_DIR"/* "$DEPLOY_DIR/"
    

    sudo chown -R www-data:www-data "$DEPLOY_DIR"
    

    sudo chmod -R 755 "$DEPLOY_DIR"
    
    log_success "Файлы развёрнуты в $DEPLOY_DIR"
}

configure_nginx() {
    log_info "Настройка Nginx..."
    
    if ! command -v nginx &> /dev/null; then
        log_warning "Nginx не установлен, пропускаем"
        return
    fi
    

    if [ ! -f "$NGINX_CONF_SRC" ]; then
        log_warning "Конфиг Nginx не найден: $NGINX_CONF_SRC"
        return
    fi
    

    sudo cp "$NGINX_CONF_SRC" "$NGINX_CONF_DST"
    

    if [ ! -L "$NGINX_ENABLED" ]; then
        sudo ln -s "$NGINX_CONF_DST" "$NGINX_ENABLED"
    fi
    

    log_info "Проверка конфигурации Nginx..."
    if sudo nginx -t; then
        log_success "Конфигурация Nginx валидна"
        

        sudo systemctl reload nginx
        log_success "Nginx перезагружен"
    else
        log_error "Ошибка в конфигурации Nginx!"
        exit 1
    fi
}

print_summary() {
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║                    Развёртывание завершено                  ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""
    log_success "PWA успешно развёрнут!"
    echo ""
    echo "📱 Доступ к приложению:"
    echo ""
    echo "   Основная сеть (10.11.0.x):"
    echo "   → http://10.11.0.16:3000"
    echo ""
    echo "   WiFi сеть (192.168.27.x):"
    echo "   → http://192.168.27.1:3000"
    echo ""
    echo "🔧 Keycloak:"
    echo "   → Основная сеть: http://10.11.0.16:8080"
    echo "   → WiFi сеть:     http://192.168.27.1:8080"
    echo ""
    echo "📝 Не забудьте:"
    echo "   1. Настроить Keycloak client с redirect URIs для обеих сетей"
    echo "   2. Проверить маршрутизацию между сетями на Gateway"
    echo "   3. Обновить IP адреса в nginx конфиге под вашу инфраструктуру"
    echo ""
}





print_header

case "$ENVIRONMENT" in
    production)
        check_requirements
        install_dependencies
        build_app
        deploy_files
        configure_nginx
        print_summary
        ;;
    staging)
        check_requirements
        install_dependencies
        build_app
        deploy_files
        log_success "Staging развёртывание завершено"
        ;;
    local)
        check_requirements
        install_dependencies
        build_app
        log_success "Локальная сборка завершена. Запустите: npm run preview"
        ;;
    *)
        log_error "Неизвестное окружение: $ENVIRONMENT"
        echo "Использование: $0 [production|staging|local]"
        exit 1
        ;;
esac

exit 0
================================================================================
FILE: QMS-Mobile/mes-pwa/index.html
================================================================================

<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="description" content="ASVO-QMS - Система управления качеством" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="ASVO-QMS" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <title>ASVO-QMS</title>
  </head>
  <body class="bg-background text-slate-100">
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: QMS-Mobile/mes-pwa/package.json
================================================================================

{
  "name": "asvo-qms-pwa",
  "version": "2.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview --host --port 3000"
  },
  "dependencies": {
    "axios": "^1.6.2",
    "lucide-react": "^0.303.0",
    "oidc-client-ts": "^3.0.1",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-oidc-context": "^3.1.0",
    "react-router-dom": "^6.21.0",
    "zustand": "^4.4.7"
  },
  "devDependencies": {
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.4.0",
    "typescript": "^5.2.2",
    "vite": "^5.0.8",
    "vite-plugin-pwa": "^0.17.4"
  }
}

================================================================================
FILE: QMS-Mobile/mes-pwa/postcss.config.js
================================================================================

export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: QMS-Mobile/mes-pwa/public/silent-check-sso.html
================================================================================

<!doctype html>
<html>
<head>
  <title>Silent SSO Check</title>
</head>
<body>
  <script>
    parent.postMessage(location.href, location.origin);
  </script>
</body>
</html>

================================================================================
FILE: QMS-Mobile/mes-pwa/src/App.tsx
================================================================================



import { useEffect } from 'react'
import { Routes, Route, Navigate } from 'react-router-dom'
import { useAuth } from 'react-oidc-context'
import { Loader } from './components/ui'


import { Layout } from './components/common/Layout'


import { LoginPage } from './pages/Auth/LoginPage'
import { HomePage } from './pages/Home/HomePage'
import { WarehousePage } from './pages/Warehouse/WarehousePage'
import { BoxDetailPage } from './pages/Warehouse/BoxDetailPage'
import { ProductionPage } from './pages/Production/ProductionPage'
import { ProductScanPage } from './pages/Production/ProductScanPage'
import { ChecklistPage } from './pages/Production/ChecklistPage'
import { RankingsPage } from './pages/Rankings/RankingsPage'
import { TasksPage } from './pages/Tasks/TasksPage'
import { ProfilePage } from './pages/Profile/ProfilePage'


const ProtectedRoute = ({ children }: { children: React.ReactNode }) => {
  const auth = useAuth()

  if (auth.isLoading) {
    return <Loader fullScreen text="Проверка авторизации..." />
  }

  if (!auth.isAuthenticated) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}


function App() {
  const auth = useAuth()


  useEffect(() => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.ready.then((registration) => {
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                if (confirm('Доступна новая версия приложения. Обновить?')) {
                  window.location.reload()
                }
              }
            })
          }
        })
      })
    }
  }, [])


  if (auth.isLoading) {
    return <Loader fullScreen text="Инициализация..." />
  }

  return (
    <Routes>

      <Route path="/login" element={<LoginPage />} />


      <Route
        path="/"
        element={
          <ProtectedRoute>
            <Layout />
          </ProtectedRoute>
        }
      >
        <Route index element={<HomePage />} />


        <Route path="warehouse" element={<WarehousePage />} />
        <Route path="warehouse/:id" element={<BoxDetailPage />} />


        <Route path="production" element={<ProductionPage />} />
        <Route path="production/scan" element={<ProductScanPage />} />
        <Route path="production/:id" element={<ProductionPage />} />
        <Route path="production/checklist/:productId/:stepId" element={<ChecklistPage />} />


        <Route path="tasks" element={<TasksPage />} />


        <Route path="rankings" element={<RankingsPage />} />


        <Route path="profile" element={<ProfilePage />} />
      </Route>


      <Route path="*" element={<Navigate to="/" replace />} />
    </Routes>
  )
}

export default App

================================================================================
FILE: QMS-Mobile/mes-pwa/src/api/client.ts
================================================================================

import axios, { AxiosError, InternalAxiosRequestConfig, AxiosResponse } from 'axios'
import { User } from 'oidc-client-ts'

export const API_BASE_URL = import.meta.env.VITE_API_URL || '/api'

export const KEYCLOAK_CONFIG = {
  authority: `${import.meta.env.VITE_KEYCLOAK_URL || 'http://localhost:8080'}/realms/${import.meta.env.VITE_KEYCLOAK_REALM || 'QMS-Realm'}`,
  clientId: import.meta.env.VITE_KEYCLOAK_CLIENT_ID || 'qms-mobile-client',
}

const DEBUG_HTTP = import.meta.env.DEV

const maskToken = (t?: string | null): string => {
  if (!t) return '<none>'
  const head = t.slice(0, 10)
  const tail = t.slice(-6)
  return `${head}…${tail} (len=${t.length})`
}

const joinUrl = (baseURL?: string, url?: string): string => {
  if (!url) return baseURL ?? ''
  if (/^https?:\/\
  const base = baseURL ?? ''
  return `${base.replace(/\/+$/, '')}/${url.replace(/^\/+/, '')}`
}

const getOidcStorageKey = (): string => {
  return `oidc.user:${KEYCLOAK_CONFIG.authority}:${KEYCLOAK_CONFIG.clientId}`
}

export const getAccessToken = (): string | null => {
  const key = getOidcStorageKey()
  const data = sessionStorage.getItem(key)
  if (!data) return null
  try {
    const user = JSON.parse(data) as User
    return user.access_token || null
  } catch {
    return null
  }
}

export const getUser = (): User | null => {
  const key = getOidcStorageKey()
  const data = sessionStorage.getItem(key)
  if (!data) return null
  try {
    return JSON.parse(data) as User
  } catch {
    return null
  }
}

export const api = axios.create({
  baseURL: API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
  },
})

api.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    const token = getAccessToken()

    if (DEBUG_HTTP) {
      const method = (config.method ?? 'GET').toUpperCase()
      console.log(`[HTTP] --> ${method} ${joinUrl(config.baseURL, config.url)}`)
      console.log(`[HTTP] token = ${maskToken(token)}`)
    }

    if (token) {
      config.headers = config.headers ?? {}
      config.headers.Authorization = `Bearer ${token}`
    }

    return config
  },
  (error) => {
    console.error('[API] Request error:', error)
    return Promise.reject(error)
  }
)

api.interceptors.response.use(
  (response: AxiosResponse) => {
    if (DEBUG_HTTP) {
      console.log(`[HTTP] <-- ${response.status} ${response.config.method?.toUpperCase()} ${joinUrl(response.config.baseURL, response.config.url)}`)
    }
    return response
  },
  (err: AxiosError) => {
    const status = err.response?.status
    const url = err.config?.url

    if (DEBUG_HTTP) {
      console.error(`[HTTP] <-- ERROR`, {
        message: err.message,
        status: status,
        data: err.response?.data,
      })
    }

    if (status === 401) {
      console.warn('[API] Unauthorized - token may be expired')
    }

    if (status === 403) {
      console.warn('[API] Forbidden - insufficient permissions')
    }

    if (status === 404) {
      console.warn('[API] Not Found:', url)
    }

    if (status && status >= 500) {
      console.error('[API] Server Error:', err.response?.data)
    }

    if (!err.response) {
      console.error('[API] Network Error - check connection')
    }

    return Promise.reject(err)
  }
)

export interface ApiErrorResponse {
  message: string
  error?: string
  statusCode?: number
  details?: any
}

export const getErrorMessage = (error: unknown, fallback = 'Произошла ошибка'): string => {
  if (axios.isAxiosError(error)) {
    const axiosError = error as AxiosError<ApiErrorResponse>

    if (axiosError.response?.data?.message) {
      return axiosError.response.data.message
    }

    if (axiosError.response?.status === 401) {
      return 'Сессия истекла. Пожалуйста, войдите снова.'
    }
    if (axiosError.response?.status === 403) {
      return 'Недостаточно прав для выполнения операции.'
    }
    if (axiosError.response?.status === 404) {
      return 'Запрашиваемый ресурс не найден.'
    }
    if (axiosError.response?.status && axiosError.response.status >= 500) {
      return 'Ошибка сервера. Попробуйте позже.'
    }

    if (axiosError.code === 'ECONNABORTED') {
      return 'Превышено время ожидания. Проверьте соединение.'
    }
    if (!axiosError.response) {
      return 'Нет соединения с сервером. Проверьте сеть.'
    }

    return axiosError.message
  }

  if (error instanceof Error) {
    return error.message
  }

  return fallback
}

export const isNetworkError = (error: unknown): boolean => {
  if (axios.isAxiosError(error)) {
    return !error.response || error.code === 'ECONNABORTED' || error.code === 'ERR_NETWORK'
  }
  return false
}

export const isAuthError = (error: unknown): boolean => {
  if (axios.isAxiosError(error)) {
    return error.response?.status === 401
  }
  return false
}

export const apiGet = async <T>(url: string, params?: any): Promise<T> => {
  const { data } = await api.get<T>(url, { params })
  return data
}

export const apiPost = async <T>(url: string, body?: any): Promise<T> => {
  const { data } = await api.post<T>(url, body)
  return data
}

export const apiPut = async <T>(url: string, body?: any): Promise<T> => {
  const { data } = await api.put<T>(url, body)
  return data
}

export const apiPatch = async <T>(url: string, body?: any): Promise<T> => {
  const { data } = await api.patch<T>(url, body)
  return data
}

export const apiDelete = async <T>(url: string): Promise<T> => {
  const { data } = await api.delete<T>(url)
  return data
}

export const apiUpload = async <T>(url: string, formData: FormData): Promise<T> => {
  const { data } = await api.post<T>(url, formData, {
    headers: {
      'Content-Type': 'multipart/form-data',
    },
    timeout: 60000,
  })
  return data
}

export const getNetworkInfo = () => ({
  apiUrl: API_BASE_URL,
  keycloakAuthority: KEYCLOAK_CONFIG.authority,
})

console.log(`[API] URL: ${API_BASE_URL}`)

export default api
================================================================================
FILE: QMS-Mobile/mes-pwa/src/components/common/Layout.tsx
================================================================================



import { useState, useEffect } from 'react'
import { Outlet, NavLink, useNavigate, useLocation } from 'react-router-dom'
import {
  Home, Package, Cpu, ListTodo, Trophy, User, LogOut,
  Menu, X, Bell, QrCode, Wifi, WifiOff
} from 'lucide-react'
import { useAuth } from 'react-oidc-context'
import { USER_ROLES } from '../../config'

const navItems = [
  { to: '/', icon: Home, label: 'Главная' },
  { to: '/warehouse', icon: Package, label: 'Склад' },
  { to: '/production', icon: Cpu, label: 'Производство' },
  { to: '/tasks', icon: ListTodo, label: 'Задачи' },
  { to: '/rankings', icon: Trophy, label: 'Рейтинги' },
]

export const Layout = () => {
  const [sidebarOpen, setSidebarOpen] = useState(false)
  const [isOnline, setIsOnline] = useState(navigator.onLine)
  const auth = useAuth()
  const navigate = useNavigate()
  const location = useLocation()


  const user = auth.user?.profile ? {
    name: auth.user.profile.given_name || '',
    surname: auth.user.profile.family_name || '',
    role: (auth.user.profile as any).realm_access?.roles?.[0] || 'USER',
    img: (auth.user.profile as any).picture,
  } : null

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  const handleLogout = () => {
    if (confirm('Выйти из системы?')) {
      auth.signoutRedirect()
    }
  }

  const getPageTitle = () => {
    const path = location.pathname
    if (path === '/') return 'Главная'
    if (path.startsWith('/warehouse')) return 'Склад'
    if (path.startsWith('/production')) return 'Производство'
    if (path.startsWith('/tasks')) return 'Задачи'
    if (path.startsWith('/rankings')) return 'Рейтинги'
    if (path.startsWith('/profile')) return 'Профиль'
    return 'MES'
  }

  return (
    <div className="min-h-screen bg-background flex">

      {sidebarOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-40 lg:hidden backdrop-blur-sm"
          onClick={() => setSidebarOpen(false)}
        />
      )}


      <aside className={`
        fixed lg:static inset-y-0 left-0 z-50
        w-64 bg-surface border-r border-slate-700/50
        transform transition-transform duration-300 ease-out
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
        flex flex-col
      `}>

        <div className="h-16 flex items-center justify-between px-4 border-b border-slate-700/50 shrink-0">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center shadow-lg shadow-primary/25">
              <Cpu size={20} className="text-white" />
            </div>
            <div>
              <span className="font-bold text-lg">ASVO-</span>
              <span className="text-primary font-light">QMS</span>
            </div>
          </div>
          <button
            className="lg:hidden p-2 hover:bg-surface-light rounded-lg transition-colors"
            onClick={() => setSidebarOpen(false)}
          >
            <X size={20} />
          </button>
        </div>


        <div className="p-4 shrink-0">
          <button
            onClick={() => { navigate('/production/scan'); setSidebarOpen(false) }}
            className="w-full flex items-center justify-center gap-2 px-4 py-3
              bg-gradient-to-r from-primary to-primary-dark text-white
              rounded-xl font-medium shadow-lg shadow-primary/25
              hover:shadow-primary/40 transition-all active:scale-[0.98]"
          >
            <QrCode size={20} />
            Сканировать
          </button>
        </div>


        <nav className="flex-1 px-3 space-y-1 overflow-y-auto">
          {navItems.map((item) => (
            <NavLink
              key={item.to}
              to={item.to}
              end={item.to === '/'}
              onClick={() => setSidebarOpen(false)}
              className={({ isActive }) => `
                flex items-center gap-3 px-4 py-3 rounded-xl
                transition-all duration-150
                ${isActive
                  ? 'bg-primary text-white shadow-lg shadow-primary/25'
                  : 'text-slate-400 hover:bg-surface-light hover:text-white'
                }
              `}
            >
              <item.icon size={20} />
              <span className="font-medium">{item.label}</span>
            </NavLink>
          ))}
        </nav>


        <div className="p-4 border-t border-slate-700/50 shrink-0">
          <NavLink
            to="/profile"
            onClick={() => setSidebarOpen(false)}
            className={({ isActive }) => `
              flex items-center gap-3 px-3 py-3 rounded-xl mb-2
              transition-all duration-150
              ${isActive
                ? 'bg-primary/20 text-primary'
                : 'text-slate-400 hover:bg-surface-light hover:text-white'
              }
            `}
          >
            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center border border-primary/20">
              {user?.img ? (
                <img src={user.img} alt="" className="w-full h-full rounded-full object-cover" />
              ) : (
                <User size={18} className="text-primary" />
              )}
            </div>
            <div className="flex-1 min-w-0">
              <p className="font-medium truncate text-white">
                {user?.surname} {user?.name}
              </p>
              <p className="text-xs text-slate-500 truncate">
                {USER_ROLES[user?.role || ''] || user?.role}
              </p>
            </div>
          </NavLink>

          <button
            onClick={handleLogout}
            className="w-full flex items-center gap-3 px-4 py-3 rounded-xl
              text-slate-400 hover:bg-danger/10 hover:text-danger
              transition-all duration-150"
          >
            <LogOut size={20} />
            <span className="font-medium">Выйти</span>
          </button>
        </div>
      </aside>


      <div className="flex-1 flex flex-col min-w-0">

        <header className="h-16 bg-surface/80 backdrop-blur-xl border-b border-slate-700/50 flex items-center px-4 lg:px-6 sticky top-0 z-30 shrink-0">
          <button
            className="lg:hidden p-2 hover:bg-surface-light rounded-lg mr-3 transition-colors"
            onClick={() => setSidebarOpen(true)}
          >
            <Menu size={22} />
          </button>

          <h1 className="text-lg font-semibold lg:hidden">{getPageTitle()}</h1>

          <div className="flex-1" />


          <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg mr-3 ${isOnline ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}`}>
            {isOnline ? <Wifi size={16} /> : <WifiOff size={16} />}
            <span className="text-xs font-medium hidden sm:inline">
              {isOnline ? 'Онлайн' : 'Офлайн'}
            </span>
          </div>


          <button className="p-2 hover:bg-surface-light rounded-lg relative transition-colors">
            <Bell size={20} className="text-slate-400" />
          </button>
        </header>


        <main className="flex-1 overflow-auto p-4 lg:p-6">
          <Outlet />
        </main>
      </div>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/components/ui/index.tsx
================================================================================



import { ButtonHTMLAttributes, InputHTMLAttributes, ReactNode, forwardRef } from 'react'


interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger' | 'success' | 'outline' | 'ghost'
  size?: 'sm' | 'md' | 'lg'
  loading?: boolean
  icon?: ReactNode
  fullWidth?: boolean
}

export const Button = ({
  children,
  variant = 'primary',
  size = 'md',
  loading = false,
  icon,
  fullWidth = false,
  className = '',
  disabled,
  ...props
}: ButtonProps) => {
  const base = 'inline-flex items-center justify-center font-medium rounded-xl transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed active:scale-[0.98]'

  const variants = {
    primary: 'bg-primary hover:bg-primary-dark text-white shadow-lg shadow-primary/25',
    secondary: 'bg-slate-600 hover:bg-slate-500 text-white',
    danger: 'bg-danger hover:bg-red-600 text-white',
    success: 'bg-success hover:bg-emerald-600 text-white',
    outline: 'border-2 border-primary text-primary hover:bg-primary/10',
    ghost: 'text-slate-400 hover:bg-surface-light hover:text-white',
  }

  const sizes = {
    sm: 'px-3 py-1.5 text-sm gap-1.5',
    md: 'px-4 py-2.5 text-sm gap-2',
    lg: 'px-6 py-3 text-base gap-2',
  }

  return (
    <button
      className={`${base} ${variants[variant]} ${sizes[size]} ${fullWidth ? 'w-full' : ''} ${className}`}
      disabled={disabled || loading}
      {...props}
    >
      {loading ? (
        <div className="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin" />
      ) : icon ? (
        <span className="shrink-0">{icon}</span>
      ) : null}
      {children}
    </button>
  )
}


interface CardProps {
  children: ReactNode
  className?: string
  onClick?: () => void
  hover?: boolean
  padding?: 'none' | 'sm' | 'md' | 'lg'
}

export const Card = ({
  children,
  className = '',
  onClick,
  hover = false,
  padding = 'none'
}: CardProps) => {
  const base = 'bg-surface border border-slate-700/50 rounded-2xl'
  const hoverStyles = hover || onClick ? 'cursor-pointer hover:border-slate-600 hover:bg-surface-light/30 transition-all' : ''
  const paddings = {
    none: '',
    sm: 'p-3',
    md: 'p-4',
    lg: 'p-6',
  }

  return (
    <div
      className={`${base} ${hoverStyles} ${paddings[padding]} ${className}`}
      onClick={onClick}
    >
      {children}
    </div>
  )
}


interface BadgeProps {
  children: ReactNode
  variant?: 'primary' | 'success' | 'warning' | 'danger' | 'neutral'
  size?: 'sm' | 'md'
  dot?: boolean
}

export const Badge = ({ children, variant = 'primary', size = 'md', dot = false }: BadgeProps) => {
  const variants = {
    primary: 'bg-primary/20 text-primary',
    success: 'bg-success/20 text-success',
    warning: 'bg-warning/20 text-warning',
    danger: 'bg-danger/20 text-danger',
    neutral: 'bg-slate-600/50 text-slate-400',
  }

  const sizes = {
    sm: 'px-2 py-0.5 text-xs',
    md: 'px-2.5 py-1 text-xs',
  }

  const dotColors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    danger: 'bg-danger',
    neutral: 'bg-slate-500',
  }

  return (
    <span className={`inline-flex items-center gap-1.5 font-medium rounded-lg ${variants[variant]} ${sizes[size]}`}>
      {dot && <span className={`w-1.5 h-1.5 rounded-full ${dotColors[variant]}`} />}
      {children}
    </span>
  )
}


interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string
  error?: string
  icon?: ReactNode
  rightIcon?: ReactNode
}

export const Input = forwardRef<HTMLInputElement, InputProps>(
  ({ label, error, icon, rightIcon, className = '', ...props }, ref) => {
    return (
      <div className="space-y-1.5">
        {label && (
          <label className="block text-sm font-medium text-slate-300">
            {label}
          </label>
        )}
        <div className="relative">
          {icon && (
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">
              {icon}
            </div>
          )}
          <input
            ref={ref}
            className={`
              w-full bg-surface-light border border-slate-600 rounded-xl
              px-4 py-2.5 text-white placeholder-slate-500
              focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none
              transition-all duration-150
              ${icon ? 'pl-10' : ''}
              ${rightIcon ? 'pr-10' : ''}
              ${error ? 'border-danger focus:border-danger focus:ring-danger/20' : ''}
              ${className}
            `}
            {...props}
          />
          {rightIcon && (
            <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500">
              {rightIcon}
            </div>
          )}
        </div>
        {error && <p className="text-sm text-danger">{error}</p>}
      </div>
    )
  }
)

Input.displayName = 'Input'


export const Skeleton = ({ className = '' }: { className?: string }) => (
  <div className={`bg-surface-light rounded-lg animate-pulse ${className}`} />
)


interface LoaderProps {
  size?: 'sm' | 'md' | 'lg'
  text?: string
  fullScreen?: boolean
}

export const Loader = ({ size = 'md', text, fullScreen = false }: LoaderProps) => {
  const sizes = {
    sm: 'w-4 h-4 border-2',
    md: 'w-8 h-8 border-2',
    lg: 'w-12 h-12 border-3',
  }

  const content = (
    <div className="flex flex-col items-center justify-center gap-3">
      <div className={`${sizes[size]} border-primary border-t-transparent rounded-full animate-spin`} />
      {text && <p className="text-slate-400 text-sm">{text}</p>}
    </div>
  )

  if (fullScreen) {
    return (
      <div className="fixed inset-0 bg-background flex items-center justify-center z-50">
        {content}
      </div>
    )
  }

  return content
}


interface EmptyStateProps {
  icon?: ReactNode
  title: string
  description?: string
  action?: ReactNode
}

export const EmptyState = ({ icon, title, description, action }: EmptyStateProps) => (
  <div className="flex flex-col items-center justify-center py-12 text-center">
    {icon && <div className="text-slate-600 mb-4">{icon}</div>}
    <h3 className="text-lg font-medium text-slate-300 mb-2">{title}</h3>
    {description && <p className="text-slate-500 mb-4 max-w-sm">{description}</p>}
    {action}
  </div>
)


interface StatsCardProps {
  title: string
  value: string | number
  icon?: ReactNode
  trend?: { value: number; label?: string }
  variant?: 'default' | 'primary' | 'success' | 'warning' | 'danger'
}

export const StatsCard = ({ title, value, icon, trend, variant = 'default' }: StatsCardProps) => {
  const iconBg = {
    default: 'bg-slate-600/50',
    primary: 'bg-primary/20',
    success: 'bg-success/20',
    warning: 'bg-warning/20',
    danger: 'bg-danger/20',
  }

  const iconColor = {
    default: 'text-slate-400',
    primary: 'text-primary',
    success: 'text-success',
    warning: 'text-warning',
    danger: 'text-danger',
  }

  return (
    <Card className="p-5">
      <div className="flex items-start justify-between">
        <div className="flex-1 min-w-0">
          <p className="text-sm text-slate-400 mb-1 truncate">{title}</p>
          <p className="text-2xl font-bold truncate">{value}</p>
          {trend && (
            <p className={`text-sm mt-1 ${trend.value >= 0 ? 'text-success' : 'text-danger'}`}>
              {trend.value >= 0 ? '↑' : '↓'} {Math.abs(trend.value)}%
              {trend.label && <span className="text-slate-500 ml-1">{trend.label}</span>}
            </p>
          )}
        </div>
        {icon && (
          <div className={`p-3 rounded-xl ${iconBg[variant]} shrink-0 ml-3`}>
            <div className={iconColor[variant]}>{icon}</div>
          </div>
        )}
      </div>
    </Card>
  )
}


interface ModalProps {
  isOpen: boolean
  onClose: () => void
  title?: string
  children: ReactNode
  size?: 'sm' | 'md' | 'lg'
}

export const Modal = ({ isOpen, onClose, title, children, size = 'md' }: ModalProps) => {
  if (!isOpen) return null

  const sizes = {
    sm: 'max-w-sm',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
      <div className={`relative bg-surface rounded-2xl w-full ${sizes[size]} shadow-2xl animate-slideUp`}>
        {title && (
          <div className="px-6 py-4 border-b border-slate-700">
            <h2 className="text-lg font-semibold">{title}</h2>
          </div>
        )}
        <div className="p-6">{children}</div>
      </div>
    </div>
  )
}


interface Tab {
  key: string
  label: string
  icon?: ReactNode
}

interface TabsProps {
  tabs: Tab[]
  activeTab: string
  onChange: (key: string) => void
}

export const Tabs = ({ tabs, activeTab, onChange }: TabsProps) => {
  return (
    <div className="flex gap-1 p-1 bg-surface-light rounded-xl overflow-x-auto">
      {tabs.map((tab) => (
        <button
          key={tab.key}
          onClick={() => onChange(tab.key)}
          className={`
            flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg
            text-sm font-medium transition-all duration-150 whitespace-nowrap
            ${activeTab === tab.key
              ? 'bg-primary text-white shadow-lg'
              : 'text-slate-400 hover:text-white hover:bg-surface'
            }
          `}
        >
          {tab.icon}
          {tab.label}
        </button>
      ))}
    </div>
  )
}


interface ProgressProps {
  value: number
  max?: number
  size?: 'sm' | 'md'
  variant?: 'primary' | 'success' | 'warning' | 'danger'
  showLabel?: boolean
}

export const Progress = ({
  value,
  max = 100,
  size = 'md',
  variant = 'primary',
  showLabel = false
}: ProgressProps) => {
  const percent = Math.min(100, Math.max(0, (value / max) * 100))

  const heights = { sm: 'h-1.5', md: 'h-2.5' }
  const colors = {
    primary: 'bg-primary',
    success: 'bg-success',
    warning: 'bg-warning',
    danger: 'bg-danger',
  }

  return (
    <div className="space-y-1">
      <div className={`w-full bg-surface-light rounded-full overflow-hidden ${heights[size]}`}>
        <div
          className={`${heights[size]} ${colors[variant]} rounded-full transition-all duration-300`}
          style={{ width: `${percent}%` }}
        />
      </div>
      {showLabel && (
        <div className="flex justify-between text-xs text-slate-500">
          <span>{value} / {max}</span>
          <span>{Math.round(percent)}%</span>
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/config/index.ts
================================================================================



export { API_BASE_URL, KEYCLOAK_CONFIG } from '../api/client'


export const config = {

  REQUEST_TIMEOUT: 15000,


  CACHE_TTL: 5 * 60 * 1000,


  DEBUG: import.meta.env.DEV,
}


export const PRODUCT_STATUS = {
  IN_PRODUCTION: 'IN_PRODUCTION',
  QUALITY_CONTROL: 'QUALITY_CONTROL',
  READY: 'READY',
  SHIPPED: 'SHIPPED',
  DEFECT: 'DEFECT',
  ARCHIVED: 'ARCHIVED',
} as const

export const TASK_STATUS = {
  PENDING: 'PENDING',
  IN_PROGRESS: 'IN_PROGRESS',
  COMPLETED: 'COMPLETED',
  CANCELLED: 'CANCELLED',
  ON_HOLD: 'ON_HOLD',
} as const

export const BOX_STATUS = {
  ACTIVE: 'ACTIVE',
  RESERVED: 'RESERVED',
  EMPTY: 'EMPTY',
  WRITTEN_OFF: 'WRITTEN_OFF',
} as const

export const STATUS_COLORS: Record<string, 'primary' | 'success' | 'warning' | 'danger' | 'neutral'> = {

  IN_PRODUCTION: 'warning',
  QUALITY_CONTROL: 'primary',
  READY: 'success',
  SHIPPED: 'primary',
  DEFECT: 'danger',
  ARCHIVED: 'neutral',

  PENDING: 'warning',
  IN_PROGRESS: 'primary',
  COMPLETED: 'success',
  CANCELLED: 'danger',
  ON_HOLD: 'neutral',

  ACTIVE: 'success',
  RESERVED: 'warning',
  EMPTY: 'neutral',
  WRITTEN_OFF: 'danger',
}

export const STATUS_LABELS: Record<string, string> = {

  IN_PRODUCTION: 'В производстве',
  QUALITY_CONTROL: 'Контроль качества',
  READY: 'Готов',
  SHIPPED: 'Отгружен',
  DEFECT: 'Брак',
  ARCHIVED: 'В архиве',

  PENDING: 'Ожидает',
  IN_PROGRESS: 'В работе',
  COMPLETED: 'Завершена',
  CANCELLED: 'Отменена',
  ON_HOLD: 'На паузе',

  ACTIVE: 'Активна',
  RESERVED: 'Резерв',
  EMPTY: 'Пусто',
  WRITTEN_OFF: 'Списана',
}

export const USER_ROLES: Record<string, string> = {
  SUPER_ADMIN: 'Суперадмин',
  PRODUCTION_CHIEF: 'Начальник производства',
  WAREHOUSE_MASTER: 'Кладовщик',
  TECHNOLOGIST: 'Технолог',
  ASSEMBLER: 'Сборщик',
  QC_INSPECTOR: 'Контролёр ОТК',
  REPAIR_TECHNICIAN: 'Ремонтник',
}

export default config

================================================================================
FILE: QMS-Mobile/mes-pwa/src/hooks/index.ts
================================================================================



import { useState, useEffect, useCallback, useRef } from 'react'


export function useDebounce<T>(value: T, delay: number = 300): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value)

  useEffect(() => {
    const timer = setTimeout(() => setDebouncedValue(value), delay)
    return () => clearTimeout(timer)
  }, [value, delay])

  return debouncedValue
}


export function useOnlineStatus(): boolean {
  const [isOnline, setIsOnline] = useState(navigator.onLine)

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return isOnline
}


export function useLocalStorage<T>(
  key: string,
  initialValue: T
): [T, (value: T | ((prev: T) => T)) => void] {
  const [storedValue, setStoredValue] = useState<T>(() => {
    try {
      const item = localStorage.getItem(key)
      return item ? JSON.parse(item) : initialValue
    } catch {
      return initialValue
    }
  })

  const setValue = useCallback(
    (value: T | ((prev: T) => T)) => {
      try {
        const valueToStore = value instanceof Function ? value(storedValue) : value
        setStoredValue(valueToStore)
        localStorage.setItem(key, JSON.stringify(valueToStore))
      } catch (error) {
        console.error('useLocalStorage error:', error)
      }
    },
    [key, storedValue]
  )

  return [storedValue, setValue]
}


export function usePrevious<T>(value: T): T | undefined {
  const ref = useRef<T>()
  useEffect(() => {
    ref.current = value
  }, [value])
  return ref.current
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/index.css
================================================================================

@tailwind base;
@tailwind components;
@tailwind utilities;





* {
  -webkit-tap-highlight-color: transparent;
}

html {
  scroll-behavior: smooth;
}

body {
  @apply bg-background text-slate-100 antialiased;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  overscroll-behavior: none;
}





::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  @apply bg-transparent;
}

::-webkit-scrollbar-thumb {
  @apply bg-slate-700 rounded-full;
}

::-webkit-scrollbar-thumb:hover {
  @apply bg-slate-600;
}





@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

.animate-slideUp {
  animation: slideUp 0.3s ease-out;
}

.animate-slideDown {
  animation: slideDown 0.3s ease-out;
}

.animate-scaleIn {
  animation: scaleIn 0.2s ease-out;
}

.animate-shimmer {
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.05) 50%,
    transparent 100%
  );
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}





input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -moz-appearance: textfield;
}

input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus {
  -webkit-text-fill-color: white;
  -webkit-box-shadow: 0 0 0px 1000px #1e293b inset;
  transition: background-color 5000s ease-in-out 0s;
}






.splash-screen {
  @apply fixed inset-0 bg-background flex items-center justify-center z-50;
  transition: opacity 0.3s ease-out;
}

.splash-screen.hidden {
  opacity: 0;
  pointer-events: none;
}


@supports (padding: max(0px)) {
  .safe-area-inset-top {
    padding-top: max(env(safe-area-inset-top), 0px);
  }
  
  .safe-area-inset-bottom {
    padding-bottom: max(env(safe-area-inset-bottom), 0px);
  }
}





.no-select {
  -webkit-user-select: none;
  user-select: none;
}

.truncate-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.truncate-3 {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}


.glass {
  @apply bg-surface/80 backdrop-blur-xl;
}


.gradient-text {
  @apply bg-gradient-to-r from-primary to-primary-light bg-clip-text text-transparent;
}


.hide-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.hide-scrollbar::-webkit-scrollbar {
  display: none;
}





:focus-visible {
  @apply outline-none ring-2 ring-primary ring-offset-2 ring-offset-background;
}

button:focus-visible,
a:focus-visible {
  @apply outline-none ring-2 ring-primary ring-offset-2 ring-offset-background rounded-lg;
}





@media print {
  body {
    @apply bg-white text-black;
  }
  
  .no-print {
    display: none !important;
  }
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/main.tsx
================================================================================

import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import { AuthProvider, AuthProviderProps } from 'react-oidc-context'
import App from './App'
import './index.css'
import { KEYCLOAK_CONFIG, getNetworkInfo } from './api/client'

const createOidcConfig = (): AuthProviderProps => {
  const networkInfo = getNetworkInfo()

  console.log('[MES] OIDC Authority:', KEYCLOAK_CONFIG.authority)
  console.log('[MES] OIDC Client:', KEYCLOAK_CONFIG.clientId)
  console.log('[MES] Network:', networkInfo.network)

  return {
    authority: KEYCLOAK_CONFIG.authority,
    client_id: KEYCLOAK_CONFIG.clientId,
    redirect_uri: `${window.location.origin}/`,
    post_logout_redirect_uri: `${window.location.origin}/`,
    response_type: 'code',
    scope: 'openid profile email',
    automaticSilentRenew: true,
    onSigninCallback: () => {
      window.history.replaceState({}, document.title, window.location.pathname)
    },
  }
}

const oidcConfig = createOidcConfig()

const registerServiceWorker = () => {
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' })
        console.log('[PWA] SW registered:', registration.scope)

        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[PWA] New version available')
              }
            })
          }
        })
      } catch (error) {
        console.error('[PWA] SW registration failed:', error)
      }
    })
  }
}

if (import.meta.env.PROD) {
  registerServiceWorker()
}

const networkInfo = getNetworkInfo()
console.log('[MES] PWA Mode:', import.meta.env.MODE)
console.log('[MES] Network:', networkInfo.network)
console.log('[MES] API:', networkInfo.apiUrl)

const root = document.getElementById('root')

if (!root) {
  throw new Error('Root element not found')
}

ReactDOM.createRoot(root).render(
  <React.StrictMode>
    <AuthProvider {...oidcConfig}>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </AuthProvider>
  </React.StrictMode>
)

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Auth/LoginPage.tsx
================================================================================



import { useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuth } from 'react-oidc-context'
import { Cpu, Key, AlertCircle } from 'lucide-react'
import { Button, Card } from '../../components/ui'

export const LoginPage = () => {
  const navigate = useNavigate()
  const auth = useAuth()


  useEffect(() => {
    if (auth.isAuthenticated) {
      navigate('/', { replace: true })
    }
  }, [auth.isAuthenticated, navigate])

  const handleLogin = () => {
    auth.signinRedirect()
  }

  return (
    <div className="min-h-screen bg-background flex items-center justify-center p-4">
      <div className="w-full max-w-sm">

        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-primary to-primary-dark rounded-2xl mb-4 shadow-2xl shadow-primary/30">
            <Cpu size={40} className="text-white" />
          </div>
          <h1 className="text-3xl font-bold">
            ASVO-<span className="text-primary">QMS</span>
          </h1>
          <p className="text-slate-400 mt-2">Система управления производством</p>
        </div>


        <Card className="p-6">
          <div className="space-y-4">
            {auth.error && (
              <div className="flex items-center gap-2 p-3 bg-danger/10 border border-danger/20 rounded-xl text-danger text-sm">
                <AlertCircle size={16} className="shrink-0" />
                <span>{auth.error.message}</span>
              </div>
            )}

            <Button
              onClick={handleLogin}
              className="w-full"
              size="lg"
              icon={<Key size={20} />}
              loading={auth.isLoading}
            >
              Войти через SSO
            </Button>
          </div>
        </Card>


        <div className="mt-6 text-center">
          <p className="text-slate-600 text-sm">
            ASVO-QMS PWA v2.0
          </p>
          <p className="text-slate-700 text-xs mt-1">
            Для работы требуется подключение к корпоративной сети
          </p>
        </div>
      </div>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Home/HomePage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { Link } from 'react-router-dom'
import {
  Package, Cpu, CheckCircle2, AlertTriangle, ArrowRight,
  ListTodo, Trophy, Clock, QrCode, TrendingUp
} from 'lucide-react'
import { Card, StatsCard, Badge, Skeleton, Button } from '../../components/ui'
import { useAuth } from 'react-oidc-context'
import { api } from '../../api/client'
import { STATUS_LABELS, STATUS_COLORS } from '../../config'
import type { Task, UserStats } from '../../types'

interface DashboardData {
  warehouse: { totalBoxes: number; alertsCount: number }
  production: { today: number; inProgress: number }
  userStats: UserStats | null
  recentTasks: Task[]
}

export const HomePage = () => {
  const auth = useAuth()
  const user = auth.user?.profile ? {
    name: auth.user.profile.given_name || '',
    surname: auth.user.profile.family_name || '',
  } : null
  const [data, setData] = useState<DashboardData | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadDashboard()
  }, [])

  const loadDashboard = async () => {
    try {
      const [tasksRes] = await Promise.allSettled([
        api.get('/tasks', { params: { limit: 5 } }),
      ])

      setData({
        warehouse: {
          totalBoxes: 0,
          alertsCount: 0,
        },
        production: { today: 0, inProgress: 0 },
        userStats: null,
        recentTasks: tasksRes.status === 'fulfilled' ? (tasksRes.value.data?.rows || tasksRes.value.data || []) : [],
      })
    } catch (error) {
      console.error('Dashboard load error:', error)
    } finally {
      setLoading(false)
    }
  }

  const getGreeting = () => {
    const hour = new Date().getHours()
    if (hour < 12) return 'Доброе утро'
    if (hour < 18) return 'Добрый день'
    return 'Добрый вечер'
  }

  return (
    <div className="space-y-6 animate-fadeIn">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">{getGreeting()}, {user?.name}!</h1>
          <p className="text-slate-400 mt-1">Вот что происходит сегодня</p>
        </div>
        <Link to="/production/scan">
          <Button icon={<QrCode size={18} />}>Сканировать</Button>
        </Link>
      </div>


      <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
        {loading ? (
          <>
            <Skeleton className="h-28" />
            <Skeleton className="h-28" />
            <Skeleton className="h-28" />
            <Skeleton className="h-28" />
          </>
        ) : (
          <>
            <StatsCard title="На складе" value={data?.warehouse.totalBoxes || 0} icon={<Package size={24} />} variant="primary" />
            <StatsCard title="В работе" value={data?.production.inProgress || 0} icon={<Cpu size={24} />} variant="warning" />
            <StatsCard title="Мой рейтинг" value={data?.userStats?.rank ? `#${data.userStats.rank}` : '—'} icon={<Trophy size={24} />} variant="success" />
            <StatsCard title="Критично" value={data?.warehouse.alertsCount || 0} icon={<AlertTriangle size={24} />} variant={data?.warehouse.alertsCount ? 'danger' : 'default'} />
          </>
        )}
      </div>


      {data?.userStats && (
        <Card className="p-5">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <TrendingUp size={20} className="text-primary" />
            Моя статистика
          </h2>
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold text-primary">{data.userStats.todayOperations}</p>
              <p className="text-xs text-slate-400 mt-1">Сегодня</p>
            </div>
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold">{data.userStats.weekOperations}</p>
              <p className="text-xs text-slate-400 mt-1">За неделю</p>
            </div>
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold">{data.userStats.monthOperations}</p>
              <p className="text-xs text-slate-400 mt-1">За месяц</p>
            </div>
            <div className="text-center p-3 bg-surface-light/50 rounded-xl">
              <p className="text-2xl font-bold">{data.userStats.totalOperations}</p>
              <p className="text-xs text-slate-400 mt-1">Всего</p>
            </div>
          </div>
        </Card>
      )}


      <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 lg:gap-4">
        <Link to="/warehouse">
          <Card hover className="p-5 group h-full">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-primary/20"><Package size={24} className="text-primary" /></div>
                <div><h3 className="font-semibold">Склад</h3><p className="text-sm text-slate-400">Запасы</p></div>
              </div>
              <ArrowRight size={20} className="text-slate-600 group-hover:text-primary group-hover:translate-x-1 transition-all" />
            </div>
          </Card>
        </Link>

        <Link to="/production">
          <Card hover className="p-5 group h-full">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-success/20"><Cpu size={24} className="text-success" /></div>
                <div><h3 className="font-semibold">Производство</h3><p className="text-sm text-slate-400">Сборка</p></div>
              </div>
              <ArrowRight size={20} className="text-slate-600 group-hover:text-success group-hover:translate-x-1 transition-all" />
            </div>
          </Card>
        </Link>

        <Link to="/rankings">
          <Card hover className="p-5 group h-full">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-xl bg-warning/20"><Trophy size={24} className="text-warning" /></div>
                <div><h3 className="font-semibold">Рейтинги</h3><p className="text-sm text-slate-400">Статистика</p></div>
              </div>
              <ArrowRight size={20} className="text-slate-600 group-hover:text-warning group-hover:translate-x-1 transition-all" />
            </div>
          </Card>
        </Link>
      </div>


      <Card className="p-5">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold flex items-center gap-2">
            <ListTodo size={20} className="text-primary" />
            Мои задачи
          </h2>
          <Link to="/tasks" className="text-sm text-primary hover:underline">Все задачи</Link>
        </div>

        {loading ? (
          <div className="space-y-3"><Skeleton className="h-14" /><Skeleton className="h-14" /><Skeleton className="h-14" /></div>
        ) : data?.recentTasks && data.recentTasks.length > 0 ? (
          <div className="space-y-2">
            {data.recentTasks.map((task) => (
              <Link key={task.id} to="/tasks" className="flex items-center justify-between p-3 rounded-xl hover:bg-surface-light transition-colors">
                <div className="flex items-center gap-3 min-w-0">
                  <div className={`w-2 h-2 rounded-full shrink-0 ${task.status === 'IN_PROGRESS' ? 'bg-primary' : 'bg-warning'}`} />
                  <span className="font-medium truncate">{task.title}</span>
                </div>
                <Badge variant={STATUS_COLORS[task.status] || 'neutral'}>{STATUS_LABELS[task.status] || task.status}</Badge>
              </Link>
            ))}
          </div>
        ) : (
          <div className="text-center py-8 text-slate-500">
            <CheckCircle2 size={32} className="mx-auto mb-2 opacity-50" />
            <p>Нет активных задач</p>
          </div>
        )}
      </Card>


      <Card className="p-4">
        <div className="flex items-center justify-center gap-3 text-slate-400">
          <Clock size={18} />
          <span>{new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
        </div>
      </Card>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Production/ChecklistPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import {
  ArrowLeft,
  Check,
  Circle,
  CheckCircle2,
  AlertCircle,
  Camera,
  QrCode
} from 'lucide-react'
import { Card, Button, Input, Badge, Loader, Progress } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import type { Product, ProductionStep, ChecklistItem } from '../../types'

interface ChecklistItemState {
  item: ChecklistItem
  value: string
  completed: boolean
}

export const ChecklistPage = () => {
  const { productId, stepId } = useParams<{ productId: string; stepId: string }>()
  const navigate = useNavigate()

  const [product, setProduct] = useState<Product | null>(null)
  const [step, setStep] = useState<ProductionStep | null>(null)
  const [items, setItems] = useState<ChecklistItemState[]>([])
  const [loading, setLoading] = useState(true)
  const [submitting, setSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (productId && stepId) loadData()
  }, [productId, stepId])

  const loadData = async () => {
    try {
      setLoading(true)

      const [productRes, stepRes] = await Promise.all([
        api.get(`/products/${productId}`),
        api.get(`/production-steps/${stepId}`),
      ])

      setProduct(productRes.data)
      setStep(stepRes.data)

      const checklistItems = stepRes.data.checklistItems || []
      setItems(
        checklistItems
          .sort((a: ChecklistItem, b: ChecklistItem) => a.order - b.order)
          .map((item: ChecklistItem) => ({
            item,
            value: '',
            completed: false,
          }))
      )

      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const updateItem = (index: number, value: string, completed?: boolean) => {
    setItems(prev => prev.map((item, i) => {
      if (i !== index) return item

      const newCompleted = completed !== undefined
        ? completed
        : item.item.type === 'checkbox'
          ? !item.completed
          : !!value

      return { ...item, value, completed: newCompleted }
    }))
  }

  const completedCount = items.filter(i => i.completed).length
  const canSubmit = items.filter(i => i.item.required).every(i => i.completed)

  const handleSubmit = async () => {
    if (!canSubmit) return

    try {
      setSubmitting(true)

      await api.post(`/products/${productId}/complete-step`, {
        stepId: parseInt(stepId!),
        responses: items.map(i => ({
          itemId: i.item.id,
          value: i.item.type === 'checkbox' ? (i.completed ? 'true' : 'false') : i.value,
        })),
      })

      navigate(`/production/${productId}`, { replace: true })
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setSubmitting(false)
    }
  }

  const renderItemInput = (itemState: ChecklistItemState, index: number) => {
    const { item, value, completed } = itemState

    switch (item.type) {
      case 'checkbox':
        return (
          <button
            onClick={() => updateItem(index, '', !completed)}
            className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${
              completed
                ? 'bg-success border-success'
                : 'border-slate-600 hover:border-primary'
            }`}
          >
            {completed && <Check size={14} className="text-white" />}
          </button>
        )

      case 'text':
        return (
          <Input
            value={value}
            onChange={(e) => updateItem(index, e.target.value)}
            placeholder="Введите значение..."
            className="mt-2"
          />
        )

      case 'number':
        return (
          <Input
            type="number"
            value={value}
            onChange={(e) => updateItem(index, e.target.value)}
            placeholder="Введите число..."
            className="mt-2"
          />
        )

      case 'select':
        return (
          <div className="flex flex-wrap gap-2 mt-2">
            {item.options?.map((option) => (
              <button
                key={option}
                onClick={() => updateItem(index, option, true)}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                  value === option
                    ? 'bg-primary text-white'
                    : 'bg-surface-light text-slate-400 hover:text-white'
                }`}
              >
                {option}
              </button>
            ))}
          </div>
        )

      case 'photo':
        return (
          <button
            onClick={() => updateItem(index, 'photo_captured', true)}
            className="mt-2 w-full p-4 border-2 border-dashed border-slate-600 rounded-xl
              hover:border-primary transition-colors flex flex-col items-center gap-2"
          >
            <Camera size={24} className="text-slate-500" />
            <span className="text-sm text-slate-400">
              {completed ? 'Фото добавлено ✓' : 'Сделать фото'}
            </span>
          </button>
        )

      case 'serial':
        return (
          <div className="mt-2 flex gap-2">
            <Input
              value={value}
              onChange={(e) => updateItem(index, e.target.value.toUpperCase())}
              placeholder="Серийный номер..."
              className="flex-1 font-mono"
            />
            <Button variant="outline" icon={<QrCode size={18} />}>
              Скан
            </Button>
          </div>
        )

      default:
        return null
    }
  }

  if (loading) {
    return (
      <div className="flex justify-center py-12">
        <Loader text="Загрузка..." />
      </div>
    )
  }

  if (error || !product || !step) {
    return (
      <div className="text-center py-12">
        <p className="text-danger mb-4">{error || 'Данные не найдены'}</p>
        <Button variant="outline" onClick={() => navigate(-1)}>
          Назад
        </Button>
      </div>
    )
  }

  return (
    <div className="max-w-xl mx-auto space-y-4 animate-fadeIn pb-24">

      <div className="flex items-center gap-4">
        <Button
          variant="ghost"
          icon={<ArrowLeft size={20} />}
          onClick={() => navigate(-1)}
        />
        <div className="flex-1 min-w-0">
          <h1 className="text-lg font-bold truncate">{step.title}</h1>
          <p className="text-slate-400 text-sm font-mono truncate">{product.serialNumber}</p>
        </div>
      </div>


      <Card className="p-4">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm text-slate-400">Прогресс</span>
          <span className="text-sm font-medium">{completedCount} / {items.length}</span>
        </div>
        <Progress
          value={completedCount}
          max={items.length}
          variant={completedCount === items.length ? 'success' : 'primary'}
        />
      </Card>


      <div className="space-y-3">
        {items.map((itemState, index) => (
          <Card
            key={itemState.item.id}
            className={`p-4 transition-all ${
              itemState.completed ? 'border-success/30 bg-success/5' : ''
            }`}
          >
            <div className="flex items-start gap-3">
              {itemState.item.type === 'checkbox' ? (
                renderItemInput(itemState, index)
              ) : (
                <div className={`w-6 h-6 rounded-full flex items-center justify-center shrink-0 ${
                  itemState.completed ? 'bg-success/20' : 'bg-surface-light'
                }`}>
                  {itemState.completed ? (
                    <CheckCircle2 size={16} className="text-success" />
                  ) : (
                    <Circle size={16} className="text-slate-500" />
                  )}
                </div>
              )}

              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                  <p className={`font-medium ${itemState.completed ? 'text-success' : ''}`}>
                    {itemState.item.title}
                  </p>
                  {itemState.item.required && (
                    <Badge variant="danger" size="sm">Обяз.</Badge>
                  )}
                </div>

                {itemState.item.type !== 'checkbox' && renderItemInput(itemState, index)}
              </div>
            </div>
          </Card>
        ))}
      </div>


      <div className="fixed bottom-0 left-0 right-0 p-4 bg-background/80 backdrop-blur-xl border-t border-slate-700/50">
        <div className="max-w-xl mx-auto">
          {!canSubmit && (
            <p className="text-center text-sm text-warning mb-3 flex items-center justify-center gap-2">
              <AlertCircle size={16} />
              Заполните все обязательные пункты
            </p>
          )}
          <Button
            onClick={handleSubmit}
            disabled={!canSubmit}
            loading={submitting}
            fullWidth
            size="lg"
            icon={<Check size={18} />}
          >
            Завершить операцию
          </Button>
        </div>
      </div>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Production/ProductScanPage.tsx
================================================================================



import { useState, useRef, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { QrCode, Keyboard, Search, ArrowRight, Package, ArrowLeft } from 'lucide-react'
import { Card, Input, Button, Badge, Loader, EmptyState } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { STATUS_LABELS, STATUS_COLORS } from '../../config'
import type { ScanResult } from '../../types'

export const ProductScanPage = () => {
  const navigate = useNavigate()
  const inputRef = useRef<HTMLInputElement>(null)

  const [serialNumber, setSerialNumber] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [result, setResult] = useState<ScanResult | null>(null)

  useEffect(() => {
    setTimeout(() => inputRef.current?.focus(), 100)
  }, [])

  const handleSearch = async () => {
    const code = serialNumber.trim()
    if (!code) return

    setLoading(true)
    setError(null)
    setResult(null)

    try {
      const { data } = await api.post('/products/scan', { code })
      setResult(data)
    } catch (err) {
      setError(getErrorMessage(err, 'Продукт не найден'))
    } finally {
      setLoading(false)
    }
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleSearch()
    }
  }

  const handleStartOperation = () => {
    if (result?.product && result?.nextStep) {
      navigate(`/production/checklist/${result.product.id}/${result.nextStep.id}`)
    }
  }

  const handleViewProduct = () => {
    if (result?.product) {
      navigate(`/production/${result.product.id}`)
    }
  }

  const handleReset = () => {
    setSerialNumber('')
    setResult(null)
    setError(null)
    inputRef.current?.focus()
  }

  return (
    <div className="max-w-xl mx-auto space-y-6 animate-fadeIn">

      <div className="flex items-center gap-4">
        <Button
          variant="ghost"
          icon={<ArrowLeft size={20} />}
          onClick={() => navigate(-1)}
        />
        <div>
          <h1 className="text-xl font-bold">Сканирование</h1>
          <p className="text-slate-400 text-sm">Найти продукт</p>
        </div>
      </div>


      <div className="text-center">
        <div className="inline-flex items-center justify-center w-20 h-20 bg-primary/20 rounded-2xl">
          <QrCode size={40} className="text-primary" />
        </div>
      </div>


      <Card className="p-5">
        <div className="flex gap-3">
          <div className="flex-1">
            <Input
              ref={inputRef}
              placeholder="Серийный номер или QR..."
              icon={<Keyboard size={18} />}
              value={serialNumber}
              onChange={(e) => {
                setSerialNumber(e.target.value.toUpperCase())
                setError(null)
              }}
              onKeyDown={handleKeyDown}
              className="text-lg font-mono"
            />
          </div>
          <Button
            onClick={handleSearch}
            loading={loading}
            disabled={!serialNumber.trim()}
            size="lg"
            icon={<Search size={18} />}
          >
            <span className="hidden sm:inline">Найти</span>
          </Button>
        </div>

        <p className="text-sm text-slate-500 mt-3 text-center">
          Используйте сканер или введите номер вручную
        </p>
      </Card>


      {loading && (
        <div className="flex justify-center py-8">
          <Loader text="Поиск продукта..." />
        </div>
      )}


      {error && !loading && (
        <Card className="p-6 bg-danger/10 border-danger/20">
          <div className="text-center">
            <p className="text-danger font-medium mb-4">{error}</p>
            <Button variant="outline" onClick={handleReset}>
              Попробовать снова
            </Button>
          </div>
        </Card>
      )}


      {result && !loading && (
        <Card className="p-5 animate-slideUp">
          <div className="flex items-start justify-between mb-4">
            <div>
              <h2 className="text-xl font-bold font-mono">{result.product.serialNumber}</h2>
              <p className="text-slate-400">{result.product.productType?.name || 'Продукт'}</p>
            </div>
            <Badge variant={STATUS_COLORS[result.product.status] || 'neutral'}>
              {STATUS_LABELS[result.product.status] || result.product.status}
            </Badge>
          </div>

          {result.currentStep && (
            <div className="p-4 bg-surface-light rounded-xl mb-3">
              <p className="text-sm text-slate-400 mb-1">Текущий этап</p>
              <p className="font-medium">{result.currentStep.title}</p>
            </div>
          )}

          {result.nextStep && (
            <div className="p-4 bg-primary/10 border border-primary/20 rounded-xl mb-3">
              <p className="text-sm text-primary mb-1">Следующий этап</p>
              <p className="font-medium">{result.nextStep.title}</p>
            </div>
          )}

          {result.message && (
            <p className="text-sm text-slate-400 text-center mb-4">
              {result.message}
            </p>
          )}

          <div className="flex gap-3 mt-6">
            {result.canProceed && result.nextStep && (
              <Button
                onClick={handleStartOperation}
                className="flex-1"
                icon={<ArrowRight size={18} />}
              >
                Начать операцию
              </Button>
            )}
            <Button
              onClick={handleViewProduct}
              variant={result.canProceed ? 'outline' : 'primary'}
              className="flex-1"
            >
              Подробнее
            </Button>
          </div>

          <button
            onClick={handleReset}
            className="w-full text-center text-sm text-primary hover:underline mt-4"
          >
            Сканировать другой продукт
          </button>
        </Card>
      )}


      {!loading && !error && !result && (
        <EmptyState
          icon={<Package size={48} />}
          title="Готов к сканированию"
          description="Отсканируйте QR-код или введите серийный номер"
        />
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Production/ProductionPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useNavigate, Link } from 'react-router-dom'
import {
  Search,
  Cpu,
  QrCode,
  ChevronRight
} from 'lucide-react'
import { Card, Input, Button, Badge, EmptyState, Loader, Tabs } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { useDebounce } from '../../hooks'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { Product } from '../../types'

export const ProductionPage = () => {
  const navigate = useNavigate()

  const [products, setProducts] = useState<Product[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [search, setSearch] = useState('')
  const [activeTab, setActiveTab] = useState('all')

  const debouncedSearch = useDebounce(search, 300)

  useEffect(() => {
    loadProducts()
  }, [debouncedSearch, activeTab])

  const loadProducts = async () => {
    try {
      setLoading(true)

      const params: Record<string, any> = { limit: 50 }
      if (debouncedSearch) params.search = debouncedSearch
      if (activeTab !== 'all') params.status = activeTab

      const { data } = await api.get('/production/outputs', { params })
      setProducts(Array.isArray(data) ? data : data.rows || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const tabs = [
    { key: 'all', label: 'Все' },
    { key: 'IN_PRODUCTION', label: 'В работе' },
    { key: 'QUALITY_CONTROL', label: 'ОТК' },
    { key: 'READY', label: 'Готово' },
  ]

  return (
    <div className="space-y-4 animate-fadeIn">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">Производство</h1>
          <p className="text-slate-400 text-sm">Сборка и контроль качества</p>
        </div>
        <Link to="/production/scan">
          <Button icon={<QrCode size={18} />}>
            Сканировать
          </Button>
        </Link>
      </div>


      <Card className="p-3">
        <Input
          placeholder="Поиск по серийному номеру..."
          icon={<Search size={18} />}
          value={search}
          onChange={(e) => setSearch(e.target.value.toUpperCase())}
        />
      </Card>


      <Tabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />


      {loading ? (
        <div className="flex justify-center py-12">
          <Loader text="Загрузка..." />
        </div>
      ) : error ? (
        <Card className="p-6 text-center">
          <p className="text-danger mb-4">{error}</p>
          <Button variant="outline" onClick={loadProducts}>
            Повторить
          </Button>
        </Card>
      ) : products.length === 0 ? (
        <EmptyState
          icon={<Cpu size={48} />}
          title="Продукты не найдены"
          description={search ? 'Попробуйте изменить запрос' : 'Нет продуктов с выбранным статусом'}
          action={
            <Link to="/production/scan">
              <Button icon={<QrCode size={18} />}>
                Сканировать новый
              </Button>
            </Link>
          }
        />
      ) : (
        <div className="grid gap-3">
          {products.map((product) => (
            <Card
              key={product.id}
              hover
              className="p-4"
              onClick={() => navigate(`/production/${product.id}`)}
            >
              <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-4 min-w-0">
                  <div className="w-12 h-12 rounded-xl bg-surface-light flex items-center justify-center shrink-0">
                    <Cpu size={24} className="text-primary" />
                  </div>
                  <div className="min-w-0">
                    <p className="font-bold truncate">{product.serialNumber}</p>
                    <p className="text-sm text-slate-400 truncate">
                      {product.productType?.name || 'Без типа'}
                    </p>
                    {product.currentStep && (
                      <p className="text-xs text-slate-500 truncate mt-1">
                        Этап: {product.currentStep.title}
                      </p>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-3 shrink-0">
                  <Badge variant={STATUS_COLORS[product.status] || 'neutral'}>
                    {STATUS_LABELS[product.status] || product.status}
                  </Badge>
                  <ChevronRight size={20} className="text-slate-600" />
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Profile/ProfilePage.tsx
================================================================================



import { useState } from 'react'
import { useNavigate } from 'react-router-dom'
import {
  User,
  Mail,
  Shield,
  LogOut,
  Bell,
  Moon,
  Smartphone,
  Download,
  CheckCircle,
  Info,
  ChevronRight,
  RefreshCw
} from 'lucide-react'
import { Card, Button, Badge } from '../../components/ui'
import { useAuth } from 'react-oidc-context'
import { USER_ROLES } from '../../config'

export const ProfilePage = () => {
  const navigate = useNavigate()
  const auth = useAuth()


  const user = auth.user?.profile ? {
    name: auth.user.profile.given_name || '',
    surname: auth.user.profile.family_name || '',
    login: auth.user.profile.preferred_username || auth.user.profile.email || '',
    email: auth.user.profile.email || '',
    role: (auth.user.profile as any).realm_access?.roles?.[0] || 'USER',
    img: (auth.user.profile as any).picture,
  } : null

  const authMethod = 'keycloak'
  const logout = () => auth.signoutRedirect()

  const [installPrompt, setInstallPrompt] = useState<any>(null)
  const [isInstalled, setIsInstalled] = useState(false)


  useState(() => {

    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
      setIsInstalled(true)
    }


    const handleBeforeInstall = (e: any) => {
      e.preventDefault()
      setInstallPrompt(e)
    }

    window.addEventListener('beforeinstallprompt', handleBeforeInstall)

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstall)
    }
  })

  const handleInstall = async () => {
    if (!installPrompt) return

    installPrompt.prompt()
    const { outcome } = await installPrompt.userChoice

    if (outcome === 'accepted') {
      setIsInstalled(true)
      setInstallPrompt(null)
    }
  }

  const handleLogout = () => {
    if (confirm('Выйти из системы?')) {
      logout()
      navigate('/login')
    }
  }

  const handleRefreshApp = () => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        registrations.forEach((registration) => {
          registration.update()
        })
      })
    }
    window.location.reload()
  }

  return (
    <div className="max-w-xl mx-auto space-y-4 animate-fadeIn">

      <div>
        <h1 className="text-2xl font-bold">Профиль</h1>
        <p className="text-slate-400 text-sm">Настройки аккаунта</p>
      </div>


      <Card className="p-6">
        <div className="flex items-center gap-4">
          <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center border border-primary/20">
            {user?.img ? (
              <img src={user.img} alt="" className="w-full h-full rounded-2xl object-cover" />
            ) : (
              <User size={28} className="text-primary" />
            )}
          </div>
          <div className="flex-1 min-w-0">
            <h2 className="text-xl font-bold truncate">
              {user?.surname} {user?.name}
            </h2>
            <p className="text-slate-400 truncate">@{user?.login}</p>
            <Badge variant="primary" className="mt-2">
              {USER_ROLES[user?.role || ''] || user?.role}
            </Badge>
          </div>
        </div>


        <div className="mt-4 pt-4 border-t border-slate-700/50">
          <div className="flex items-center gap-2 text-sm text-slate-400">
            <Shield size={14} />
            <span>
              Авторизация: {authMethod === 'keycloak' ? 'SSO (Keycloak)' : 'Логин/пароль'}
            </span>
          </div>
        </div>
      </Card>


      <Card className="divide-y divide-slate-700/50">
        <div className="p-4 flex items-center gap-4">
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <User size={18} className="text-slate-400" />
          </div>
          <div className="flex-1">
            <p className="text-sm text-slate-400">Логин</p>
            <p className="font-medium">{user?.login}</p>
          </div>
        </div>

        {user?.team && (
          <div className="p-4 flex items-center gap-4">
            <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
              <Shield size={18} className="text-slate-400" />
            </div>
            <div className="flex-1">
              <p className="text-sm text-slate-400">Команда</p>
              <p className="font-medium">{user.team.title}</p>
            </div>
          </div>
        )}

        {user?.section && (
          <div className="p-4 flex items-center gap-4">
            <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
              <Info size={18} className="text-slate-400" />
            </div>
            <div className="flex-1">
              <p className="text-sm text-slate-400">Участок</p>
              <p className="font-medium">{user.section.title}</p>
            </div>
          </div>
        )}
      </Card>


      {user?.abilities && user.abilities.length > 0 && (
        <Card className="p-4">
          <h3 className="font-semibold mb-3 flex items-center gap-2">
            <Shield size={18} className="text-primary" />
            Права доступа
          </h3>
          <div className="flex flex-wrap gap-2">
            {user.abilities.map((ability) => (
              <Badge key={ability} variant="neutral">
                {ability}
              </Badge>
            ))}
          </div>
        </Card>
      )}


      {!isInstalled && (
        <Card className="p-4 bg-primary/10 border-primary/20">
          <div className="flex items-center gap-4">
            <div className="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center shrink-0">
              <Smartphone size={24} className="text-primary" />
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="font-semibold">Установить приложение</h3>
              <p className="text-sm text-slate-400">
                Добавьте на главный экран для быстрого доступа
              </p>
            </div>
            <Button
              onClick={handleInstall}
              disabled={!installPrompt}
              icon={<Download size={18} />}
            >
              <span className="hidden sm:inline">Установить</span>
            </Button>
          </div>
        </Card>
      )}

      {isInstalled && (
        <Card className="p-4 bg-success/10 border-success/20">
          <div className="flex items-center gap-3 text-success">
            <CheckCircle size={20} />
            <span className="font-medium">Приложение установлено</span>
          </div>
        </Card>
      )}


      <Card className="divide-y divide-slate-700/50">
        <button className="w-full p-4 flex items-center gap-4 hover:bg-surface-light/50 transition-colors">
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <Bell size={18} className="text-slate-400" />
          </div>
          <div className="flex-1 text-left">
            <p className="font-medium">Уведомления</p>
            <p className="text-sm text-slate-500">Настройки push-уведомлений</p>
          </div>
          <ChevronRight size={20} className="text-slate-600" />
        </button>

        <button className="w-full p-4 flex items-center gap-4 hover:bg-surface-light/50 transition-colors">
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <Moon size={18} className="text-slate-400" />
          </div>
          <div className="flex-1 text-left">
            <p className="font-medium">Тема оформления</p>
            <p className="text-sm text-slate-500">Тёмная тема</p>
          </div>
          <ChevronRight size={20} className="text-slate-600" />
        </button>

        <button
          onClick={handleRefreshApp}
          className="w-full p-4 flex items-center gap-4 hover:bg-surface-light/50 transition-colors"
        >
          <div className="w-10 h-10 rounded-xl bg-surface-light flex items-center justify-center">
            <RefreshCw size={18} className="text-slate-400" />
          </div>
          <div className="flex-1 text-left">
            <p className="font-medium">Обновить приложение</p>
            <p className="text-sm text-slate-500">Проверить обновления</p>
          </div>
          <ChevronRight size={20} className="text-slate-600" />
        </button>
      </Card>


      <Card className="p-4">
        <div className="text-center text-sm text-slate-500">
          <p>ASVO-QMS PWA v2.0.0</p>
          <p className="mt-1">© 2024 Все права защищены</p>
        </div>
      </Card>


      <Button
        variant="danger"
        fullWidth
        size="lg"
        icon={<LogOut size={18} />}
        onClick={handleLogout}
      >
        Выйти из системы
      </Button>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Rankings/RankingsPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import {
  Trophy,
  Users,
  TrendingUp,
  TrendingDown,
  Medal,
  Crown,
  RefreshCw
} from 'lucide-react'
import { Card, Tabs, Badge, Loader, EmptyState } from '../../components/ui'
import { useAuth } from 'react-oidc-context'
import { api, getErrorMessage } from '../../api/client'
import type { UserRanking, TeamRanking, UserStats } from '../../types'

type Period = 'day' | 'week' | 'month' | 'all'

export const RankingsPage = () => {
  const auth = useAuth()
  const user = auth.user?.profile ? {
    id: auth.user.profile.sub,
  } : null

  const [tab, setTab] = useState<'users' | 'teams'>('users')
  const [period, setPeriod] = useState<Period>('week')
  const [userRankings, setUserRankings] = useState<UserRanking[]>([])
  const [teamRankings, setTeamRankings] = useState<TeamRanking[]>([])
  const [myStats, setMyStats] = useState<UserStats | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    loadRankings()
  }, [tab, period])

  const loadRankings = async () => {
    try {
      setLoading(true)


      setUserRankings([])
      setTeamRankings([])
      setMyStats(null)

      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const getRankIcon = (rank: number) => {
    if (rank === 1) return <Crown size={20} className="text-yellow-400" />
    if (rank === 2) return <Medal size={20} className="text-slate-300" />
    if (rank === 3) return <Medal size={20} className="text-amber-600" />
    return <span className="text-slate-500 font-mono text-sm">#{rank}</span>
  }

  const periodTabs = [
    { key: 'day', label: 'День' },
    { key: 'week', label: 'Неделя' },
    { key: 'month', label: 'Месяц' },
    { key: 'all', label: 'Всё время' },
  ]

  return (
    <div className="space-y-4 animate-fadeIn">

      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Рейтинги</h1>
          <p className="text-slate-400 text-sm">Статистика сотрудников</p>
        </div>
        <button
          onClick={loadRankings}
          className="p-2 hover:bg-surface-light rounded-lg transition-colors"
        >
          <RefreshCw size={20} className={`text-slate-400 ${loading ? 'animate-spin' : ''}`} />
        </button>
      </div>


      {myStats && tab === 'users' && (
        <Card className="p-5 bg-gradient-to-br from-primary/10 to-primary/5 border-primary/20">
          <div className="flex items-center gap-4 mb-4">
            <div className="w-14 h-14 rounded-2xl bg-primary/20 flex items-center justify-center">
              <Trophy size={28} className="text-primary" />
            </div>
            <div>
              <p className="text-sm text-slate-400">Ваш рейтинг</p>
              <p className="text-3xl font-bold">#{myStats.rank}</p>
            </div>
            <div className="ml-auto text-right">
              <p className="text-sm text-slate-400">из {myStats.totalUsers}</p>
              <p className="text-sm text-slate-500">сотрудников</p>
            </div>
          </div>

          <div className="grid grid-cols-4 gap-3">
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold text-primary">{myStats.todayOperations}</p>
              <p className="text-xs text-slate-500">Сегодня</p>
            </div>
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold">{myStats.weekOperations}</p>
              <p className="text-xs text-slate-500">Неделя</p>
            </div>
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold">{myStats.monthOperations}</p>
              <p className="text-xs text-slate-500">Месяц</p>
            </div>
            <div className="text-center p-2 bg-background/50 rounded-xl">
              <p className="text-lg font-bold">{myStats.totalOperations}</p>
              <p className="text-xs text-slate-500">Всего</p>
            </div>
          </div>
        </Card>
      )}


      <Tabs
        tabs={[
          { key: 'users', label: 'Сотрудники', icon: <Users size={16} /> },
          { key: 'teams', label: 'Команды', icon: <Trophy size={16} /> },
        ]}
        activeTab={tab}
        onChange={(key) => setTab(key as 'users' | 'teams')}
      />


      <div className="flex gap-2 overflow-x-auto pb-1">
        {periodTabs.map((p) => (
          <button
            key={p.key}
            onClick={() => setPeriod(p.key as Period)}
            className={`px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${
              period === p.key
                ? 'bg-primary text-white'
                : 'bg-surface-light text-slate-400 hover:text-white'
            }`}
          >
            {p.label}
          </button>
        ))}
      </div>


      {loading ? (
        <div className="flex justify-center py-12">
          <Loader text="Загрузка рейтингов..." />
        </div>
      ) : error ? (
        <Card className="p-6 text-center">
          <p className="text-danger mb-4">{error}</p>
        </Card>
      ) : tab === 'users' ? (
        userRankings.length > 0 ? (
          <div className="space-y-2">
            {userRankings.map((item) => {
              const isMe = item.userId === user?.id
              return (
                <Card
                  key={item.userId}
                  className={`p-4 ${isMe ? 'border-primary/50 bg-primary/5' : ''}`}
                >
                  <div className="flex items-center gap-4">
                    <div className="w-10 h-10 flex items-center justify-center">
                      {getRankIcon(item.rank)}
                    </div>

                    <div className="w-10 h-10 rounded-full bg-surface-light flex items-center justify-center shrink-0">
                      <span className="text-sm font-bold">
                        {item.user?.surname?.charAt(0)}{item.user?.name?.charAt(0)}
                      </span>
                    </div>

                    <div className="flex-1 min-w-0">
                      <p className={`font-medium truncate ${isMe ? 'text-primary' : ''}`}>
                        {item.user?.surname} {item.user?.name}
                        {isMe && <span className="text-xs text-slate-500 ml-2">(вы)</span>}
                      </p>
                      <p className="text-sm text-slate-500">
                        {item.operations} операций
                      </p>
                    </div>

                    <div className="text-right shrink-0">
                      <p className="font-bold text-lg">{item.score}</p>
                      {item.trend !== 0 && (
                        <div className={`flex items-center justify-end gap-1 text-xs ${
                          item.trend > 0 ? 'text-success' : 'text-danger'
                        }`}>
                          {item.trend > 0 ? <TrendingUp size={12} /> : <TrendingDown size={12} />}
                          {Math.abs(item.trend)}%
                        </div>
                      )}
                    </div>
                  </div>
                </Card>
              )
            })}
          </div>
        ) : (
          <EmptyState
            icon={<Trophy size={48} />}
            title="Нет данных"
            description="За выбранный период нет статистики"
          />
        )
      ) : (
        teamRankings.length > 0 ? (
          <div className="space-y-2">
            {teamRankings.map((item) => (
              <Card key={item.teamId} className="p-4">
                <div className="flex items-center gap-4">
                  <div className="w-10 h-10 flex items-center justify-center">
                    {getRankIcon(item.rank)}
                  </div>

                  <div className="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center shrink-0">
                    <Users size={18} className="text-primary" />
                  </div>

                  <div className="flex-1 min-w-0">
                    <p className="font-medium truncate">{item.team?.title || 'Команда'}</p>
                    <p className="text-sm text-slate-500">
                      {item.memberCount} участников • {item.operations} операций
                    </p>
                  </div>

                  <div className="text-right shrink-0">
                    <p className="font-bold text-lg">{item.score}</p>
                  </div>
                </div>
              </Card>
            ))}
          </div>
        ) : (
          <EmptyState
            icon={<Users size={48} />}
            title="Нет данных"
            description="За выбранный период нет статистики по командам"
          />
        )
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Tasks/TasksPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import {
  ListTodo,
  Plus,
  Search,
  Filter,
  CheckCircle2,
  Clock,
  AlertCircle,
  ChevronRight
} from 'lucide-react'
import { Card, Input, Button, Badge, Tabs, EmptyState, Loader } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { useDebounce } from '../../hooks'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { Task } from '../../types'

export const TasksPage = () => {
  const [tasks, setTasks] = useState<Task[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [search, setSearch] = useState('')
  const [activeTab, setActiveTab] = useState('my')

  const debouncedSearch = useDebounce(search, 300)

  useEffect(() => {
    loadTasks()
  }, [debouncedSearch, activeTab])

  const loadTasks = async () => {
    try {
      setLoading(true)

      const params: Record<string, any> = { limit: 50 }
      if (debouncedSearch) params.search = debouncedSearch
      if (activeTab === 'my') params.assignedToMe = true
      if (activeTab === 'active') params.status = 'IN_PROGRESS,PENDING'
      if (activeTab === 'completed') params.status = 'COMPLETED'

      const { data } = await api.get('/tasks', { params })
      setTasks(Array.isArray(data) ? data : data.rows || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'COMPLETED':
        return <CheckCircle2 size={16} className="text-success" />
      case 'IN_PROGRESS':
        return <Clock size={16} className="text-primary" />
      case 'PENDING':
        return <AlertCircle size={16} className="text-warning" />
      default:
        return <Clock size={16} className="text-slate-500" />
    }
  }

  const getPriorityColor = (priority: number): 'danger' | 'warning' | 'neutral' => {
    if (priority >= 3) return 'danger'
    if (priority >= 2) return 'warning'
    return 'neutral'
  }

  const tabs = [
    { key: 'my', label: 'Мои', icon: <ListTodo size={16} /> },
    { key: 'active', label: 'Активные' },
    { key: 'completed', label: 'Завершённые' },
    { key: 'all', label: 'Все' },
  ]

  return (
    <div className="space-y-4 animate-fadeIn">

      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">Задачи</h1>
          <p className="text-slate-400 text-sm">Управление задачами</p>
        </div>
        <Button icon={<Plus size={18} />}>
          Новая задача
        </Button>
      </div>


      <Card className="p-3">
        <div className="flex gap-3">
          <div className="flex-1">
            <Input
              placeholder="Поиск задач..."
              icon={<Search size={18} />}
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
          </div>
          <Button variant="outline" icon={<Filter size={18} />}>
            <span className="hidden sm:inline">Фильтры</span>
          </Button>
        </div>
      </Card>


      <Tabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />


      {loading ? (
        <div className="flex justify-center py-12">
          <Loader text="Загрузка задач..." />
        </div>
      ) : error ? (
        <Card className="p-6 text-center">
          <p className="text-danger mb-4">{error}</p>
          <Button variant="outline" onClick={loadTasks}>Повторить</Button>
        </Card>
      ) : tasks.length === 0 ? (
        <EmptyState
          icon={<ListTodo size={48} />}
          title="Задачи не найдены"
          description={search ? 'Попробуйте изменить запрос' : 'У вас пока нет задач'}
          action={
            <Button icon={<Plus size={18} />}>
              Создать задачу
            </Button>
          }
        />
      ) : (
        <div className="space-y-2">
          {tasks.map((task) => (
            <Card key={task.id} hover className="p-4">
              <div className="flex items-center gap-4">
                <div className="shrink-0">
                  {getStatusIcon(task.status)}
                </div>

                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <p className={`font-medium truncate ${
                      task.status === 'COMPLETED' ? 'text-slate-500 line-through' : ''
                    }`}>
                      {task.title}
                    </p>
                    {task.priority >= 2 && (
                      <Badge variant={getPriorityColor(task.priority)} size="sm">
                        {task.priority >= 3 ? 'Срочно' : 'Важно'}
                      </Badge>
                    )}
                  </div>

                  <div className="flex items-center gap-3 text-sm text-slate-500">
                    {task.project && (
                      <span className="truncate">{task.project.title}</span>
                    )}
                    {task.dueDate && (
                      <>
                        <span>•</span>
                        <span className={new Date(task.dueDate) < new Date() && task.status !== 'COMPLETED' ? 'text-danger' : ''}>
                          {new Date(task.dueDate).toLocaleDateString('ru-RU', {
                            day: 'numeric',
                            month: 'short'
                          })}
                        </span>
                      </>
                    )}
                    {task.assignee && (
                      <>
                        <span>•</span>
                        <span className="truncate">{task.assignee.surname}</span>
                      </>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-3 shrink-0">
                  <Badge variant={STATUS_COLORS[task.status] || 'neutral'}>
                    {STATUS_LABELS[task.status] || task.status}
                  </Badge>
                  <ChevronRight size={18} className="text-slate-600" />
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Warehouse/BoxDetailPage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import { ArrowLeft, Package, MapPin, Clock, QrCode, Plus, Minus, History, Edit } from 'lucide-react'
import { Card, Button, Badge, Loader, Modal, Input } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { InventoryBox, WarehouseMovement } from '../../types'

export const BoxDetailPage = () => {
  const { id } = useParams<{ id: string }>()
  const navigate = useNavigate()

  const [box, setBox] = useState<InventoryBox | null>(null)
  const [movements, setMovements] = useState<WarehouseMovement[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const [showMovementModal, setShowMovementModal] = useState(false)
  const [movementType, setMovementType] = useState<'IN' | 'OUT'>('OUT')
  const [movementQty, setMovementQty] = useState('')
  const [movementReason, setMovementReason] = useState('')
  const [submitting, setSubmitting] = useState(false)

  useEffect(() => {
    if (id) loadBox()
  }, [id])

  const loadBox = async () => {
    try {
      setLoading(true)
      const [boxRes, movementsRes] = await Promise.all([
        api.get(`/warehouse/boxes/${id}`),
        api.get(`/warehouse/boxes/${id}/movements`, { params: { limit: 10 } }),
      ])
      setBox(boxRes.data)
      setMovements(movementsRes.data?.rows || movementsRes.data || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err))
    } finally {
      setLoading(false)
    }
  }

  const handleMovement = async () => {
    if (!movementQty || !box) return
    try {
      setSubmitting(true)
      await api.post(`/warehouse/boxes/${id}/movements`, {
        type: movementType,
        quantity: parseInt(movementQty),
        reason: movementReason || undefined,
      })
      setShowMovementModal(false)
      setMovementQty('')
      setMovementReason('')
      loadBox()
    } catch (err) {
      alert(getErrorMessage(err))
    } finally {
      setSubmitting(false)
    }
  }

  const openMovementModal = (type: 'IN' | 'OUT') => {
    setMovementType(type)
    setShowMovementModal(true)
  }

  if (loading) return <div className="flex justify-center py-12"><Loader text="Загрузка..." /></div>

  if (error || !box) {
    return (
      <div className="text-center py-12">
        <p className="text-danger mb-4">{error || 'Коробка не найдена'}</p>
        <Button variant="outline" onClick={() => navigate('/warehouse')}>Назад к списку</Button>
      </div>
    )
  }

  return (
    <div className="space-y-4 animate-fadeIn">
      <div className="flex items-center gap-4">
        <Button variant="ghost" icon={<ArrowLeft size={20} />} onClick={() => navigate('/warehouse')} />
        <div className="flex-1 min-w-0">
          <h1 className="text-xl font-bold truncate">{box.label}</h1>
          <p className="text-slate-400 text-sm truncate">{box.qrCode}</p>
        </div>
        <Button variant="ghost" icon={<Edit size={18} />}><span className="hidden sm:inline">Редактировать</span></Button>
      </div>

      <Card className="p-5">
        <div className="flex items-center gap-4 mb-6">
          <div className="w-16 h-16 rounded-2xl bg-primary/20 flex items-center justify-center">
            <Package size={32} className="text-primary" />
          </div>
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-1">
              <span className="text-3xl font-bold">{box.quantity}</span>
              <span className="text-slate-400">{box.unit}</span>
            </div>
            <Badge variant={STATUS_COLORS[box.status] || 'neutral'}>{STATUS_LABELS[box.status] || box.status}</Badge>
          </div>
        </div>
        <div className="flex gap-3">
          <Button variant="outline" className="flex-1" icon={<Minus size={18} />} onClick={() => openMovementModal('OUT')}>Списать</Button>
          <Button className="flex-1" icon={<Plus size={18} />} onClick={() => openMovementModal('IN')}>Добавить</Button>
        </div>
      </Card>

      <Card className="p-5">
        <h2 className="font-semibold mb-4">Информация</h2>
        <div className="space-y-4">
          <div className="flex items-center gap-3">
            <QrCode size={18} className="text-slate-500 shrink-0" />
            <div className="min-w-0"><p className="text-sm text-slate-400">QR-код</p><p className="font-medium truncate">{box.qrCode}</p></div>
          </div>
          {box.partNumber && (
            <div className="flex items-center gap-3">
              <Package size={18} className="text-slate-500 shrink-0" />
              <div className="min-w-0"><p className="text-sm text-slate-400">Артикул</p><p className="font-medium truncate">{box.partNumber}</p></div>
            </div>
          )}
          {box.section && (
            <div className="flex items-center gap-3">
              <MapPin size={18} className="text-slate-500 shrink-0" />
              <div className="min-w-0"><p className="text-sm text-slate-400">Секция</p><p className="font-medium truncate">{box.section.title}</p></div>
            </div>
          )}
          <div className="flex items-center gap-3">
            <Clock size={18} className="text-slate-500 shrink-0" />
            <div className="min-w-0">
              <p className="text-sm text-slate-400">Обновлено</p>
              <p className="font-medium">{new Date(box.updatedAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' })}</p>
            </div>
          </div>
        </div>
      </Card>

      <Card className="p-5">
        <h2 className="font-semibold mb-4 flex items-center gap-2"><History size={18} className="text-slate-500" />История движений</h2>
        {movements.length > 0 ? (
          <div className="space-y-3">
            {movements.map((m) => (
              <div key={m.id} className="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-0">
                <div className="flex items-center gap-3">
                  <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${m.type === 'IN' ? 'bg-success/20' : 'bg-danger/20'}`}>
                    {m.type === 'IN' ? <Plus size={16} className="text-success" /> : <Minus size={16} className="text-danger" />}
                  </div>
                  <div>
                    <p className="font-medium">{m.type === 'IN' ? '+' : '-'}{m.quantity} {box.unit}</p>
                    <p className="text-xs text-slate-500">{m.user?.surname} {m.user?.name}</p>
                  </div>
                </div>
                <p className="text-xs text-slate-500">{new Date(m.createdAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</p>
              </div>
            ))}
          </div>
        ) : (
          <p className="text-slate-500 text-center py-4">История пуста</p>
        )}
      </Card>

      <Modal isOpen={showMovementModal} onClose={() => setShowMovementModal(false)} title={movementType === 'IN' ? 'Приход' : 'Расход'} size="sm">
        <div className="space-y-4">
          <Input label="Количество" type="number" value={movementQty} onChange={(e) => setMovementQty(e.target.value)} placeholder={`Введите количество (${box.unit})`} min="1" autoFocus />
          <Input label="Причина (опционально)" value={movementReason} onChange={(e) => setMovementReason(e.target.value)} placeholder="Укажите причину" />
          <div className="flex gap-3 pt-2">
            <Button variant="ghost" className="flex-1" onClick={() => setShowMovementModal(false)}>Отмена</Button>
            <Button variant={movementType === 'IN' ? 'success' : 'danger'} className="flex-1" onClick={handleMovement} loading={submitting} disabled={!movementQty || parseInt(movementQty) <= 0}>{movementType === 'IN' ? 'Добавить' : 'Списать'}</Button>
          </div>
        </div>
      </Modal>
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/pages/Warehouse/WarehousePage.tsx
================================================================================



import { useEffect, useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { Search, Package, Plus, Filter, AlertTriangle, RefreshCw } from 'lucide-react'
import { Card, Input, Button, Badge, EmptyState, Loader } from '../../components/ui'
import { api, getErrorMessage } from '../../api/client'
import { useDebounce } from '../../hooks'
import { STATUS_COLORS, STATUS_LABELS } from '../../config'
import type { InventoryBox } from '../../types'

export const WarehousePage = () => {
  const navigate = useNavigate()
  const [boxes, setBoxes] = useState<InventoryBox[]>([])
  const [loading, setLoading] = useState(true)
  const [refreshing, setRefreshing] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [search, setSearch] = useState('')

  const debouncedSearch = useDebounce(search, 300)

  useEffect(() => {
    loadBoxes()
  }, [debouncedSearch])

  const loadBoxes = async (isRefresh = false) => {
    try {
      if (isRefresh) setRefreshing(true)
      else setLoading(true)

      const params: Record<string, string | number> = { limit: 50 }
      if (debouncedSearch) params.search = debouncedSearch

      const { data } = await api.get('/warehouse/boxes', { params })
      setBoxes(Array.isArray(data) ? data : data.rows || [])
      setError(null)
    } catch (err) {
      setError(getErrorMessage(err, 'Ошибка загрузки'))
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }

  const getStatusBadge = (status: string, quantity: number, minQuantity?: number) => {
    if (minQuantity && quantity <= minQuantity) {
      return <Badge variant="danger" dot>Критично</Badge>
    }
    return <Badge variant={STATUS_COLORS[status] || 'neutral'}>{STATUS_LABELS[status] || status}</Badge>
  }

  return (
    <div className="space-y-4 animate-fadeIn">
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">Склад</h1>
          <p className="text-slate-400 text-sm">Управление запасами</p>
        </div>
        <div className="flex gap-2">
          <Button variant="ghost" icon={<RefreshCw size={18} className={refreshing ? 'animate-spin' : ''} />} onClick={() => loadBoxes(true)} disabled={refreshing}>
            <span className="hidden sm:inline">Обновить</span>
          </Button>
          <Button icon={<Plus size={18} />}><span className="hidden sm:inline">Новая коробка</span></Button>
        </div>
      </div>

      <Card className="p-3">
        <div className="flex gap-3">
          <div className="flex-1">
            <Input placeholder="Поиск по наименованию, QR или артикулу..." icon={<Search size={18} />} value={search} onChange={(e) => setSearch(e.target.value)} />
          </div>
          <Button variant="outline" icon={<Filter size={18} />}><span className="hidden sm:inline">Фильтры</span></Button>
        </div>
      </Card>

      {error && (
        <Card className="p-4 bg-danger/10 border-danger/20">
          <div className="flex items-center gap-3 text-danger">
            <AlertTriangle size={20} />
            <span>{error}</span>
            <Button variant="ghost" size="sm" onClick={() => loadBoxes()}>Повторить</Button>
          </div>
        </Card>
      )}

      {loading ? (
        <div className="flex justify-center py-12"><Loader text="Загрузка данных..." /></div>
      ) : boxes.length === 0 ? (
        <EmptyState icon={<Package size={48} />} title="Коробки не найдены" description={search ? 'Попробуйте изменить поисковый запрос' : 'На складе пока нет коробок'} action={search ? <Button variant="outline" onClick={() => setSearch('')}>Сбросить поиск</Button> : undefined} />
      ) : (
        <div className="grid gap-3">
          {boxes.map((box) => (
            <Card key={box.id} hover className="p-4" onClick={() => navigate(`/warehouse/${box.id}`)}>
              <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-4 min-w-0">
                  <div className="w-12 h-12 rounded-xl bg-primary/20 flex items-center justify-center shrink-0">
                    <Package size={24} className="text-primary" />
                  </div>
                  <div className="min-w-0">
                    <p className="font-semibold truncate">{box.label}</p>
                    <div className="flex items-center gap-2 text-sm text-slate-400">
                      <span className="truncate">{box.qrCode}</span>
                      {box.partNumber && <><span>•</span><span className="truncate">{box.partNumber}</span></>}
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-4 shrink-0">
                  <div className="text-right hidden sm:block">
                    <p className="font-bold text-lg">{box.quantity}</p>
                    <p className="text-xs text-slate-500">{box.unit}</p>
                  </div>
                  {getStatusBadge(box.status, box.quantity, box.minQuantity)}
                </div>
              </div>
              <div className="flex items-center justify-between mt-3 pt-3 border-t border-slate-700/50 sm:hidden">
                <span className="text-slate-400">Количество</span>
                <span className="font-bold">{box.quantity} {box.unit}</span>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/types/index.ts
================================================================================



export interface User {
  id: number
  login: string
  name: string
  surname: string
  role: string
  abilities: string[]
  teamId?: number
  sectionId?: number
  team?: Team
  section?: Section
  img?: string | null
}

export interface Team {
  id: number
  title: string
  leaderId?: number
}

export interface Section {
  id: number
  title: string
}


export interface InventoryBox {
  id: number
  qrCode: string
  label: string
  partNumber?: string
  quantity: number
  unit: string
  status: string
  minQuantity?: number
  sectionId?: number
  section?: Section
  createdAt: string
  updatedAt: string
}

export interface WarehouseMovement {
  id: number
  boxId: number
  userId: number
  type: 'IN' | 'OUT' | 'TRANSFER' | 'ADJUSTMENT'
  quantity: number
  reason?: string
  createdAt: string
  user?: User
  box?: InventoryBox
}


export interface Product {
  id: number
  serialNumber: string
  productTypeId: number
  productType?: ProductType
  status: string
  currentStepId?: number
  currentStep?: ProductionStep
  assignedUserId?: number
  assignedUser?: User
  createdAt: string
  updatedAt: string
}

export interface ProductType {
  id: number
  code: string
  name: string
  description?: string
  steps?: ProductionStep[]
}

export interface ProductionStep {
  id: number
  productTypeId: number
  title: string
  description?: string
  order: number
  checklistItems?: ChecklistItem[]
}

export interface ChecklistItem {
  id: number
  stepId: number
  title: string
  type: 'checkbox' | 'text' | 'number' | 'select' | 'photo' | 'serial'
  required: boolean
  options?: string[]
  order: number
}

export interface ChecklistResponse {
  id: number
  productId: number
  stepId: number
  itemId: number
  value: string
  userId: number
  createdAt: string
}


export interface Task {
  id: number
  title: string
  description?: string
  status: string
  priority: number
  projectId?: number
  project?: Project
  assigneeId?: number
  assignee?: User
  creatorId: number
  creator?: User
  dueDate?: string
  completedAt?: string
  createdAt: string
  updatedAt: string
}

export interface Project {
  id: number
  title: string
  description?: string
  status: string
}


export interface UserRanking {
  userId: number
  user: User
  rank: number
  score: number
  operations: number
  trend: number
}

export interface TeamRanking {
  teamId: number
  team: Team
  rank: number
  score: number
  operations: number
  memberCount: number
}

export interface UserStats {
  totalOperations: number
  todayOperations: number
  weekOperations: number
  monthOperations: number
  avgPerDay: number
  rank: number
  totalUsers: number
}


export interface PaginatedResponse<T> {
  rows: T[]
  count: number
  page?: number
  limit?: number
}

export interface ApiError {
  message: string
  error?: string
  statusCode?: number
}


export interface ScanResult {
  product: Product
  currentStep?: ProductionStep
  nextStep?: ProductionStep
  canProceed: boolean
  message?: string
}

================================================================================
FILE: QMS-Mobile/mes-pwa/src/vite-env.d.ts
================================================================================




================================================================================
FILE: QMS-Mobile/mes-pwa/tailwind.config.js
================================================================================


export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          DEFAULT: '#3b82f6',
          dark: '#2563eb',
          light: '#60a5fa',
        },
        surface: {
          DEFAULT: '#1e293b',
          light: '#334155',
          hover: '#3f4f63',
        },
        background: '#0f172a',
        success: '#10b981',
        warning: '#f59e0b',
        danger: '#ef4444',
      },
      animation: {
        'fadeIn': 'fadeIn 0.2s ease-out',
        'slideUp': 'slideUp 0.3s ease-out',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideUp: {
          '0%': { opacity: '0', transform: 'translateY(10px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
      },
    },
  },
  plugins: [],
}

================================================================================
FILE: QMS-Mobile/mes-pwa/tsconfig.json
================================================================================

{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}

================================================================================
FILE: QMS-Mobile/mes-pwa/tsconfig.node.json
================================================================================

{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}

================================================================================
FILE: QMS-Mobile/mes-pwa/vite.config.ts
================================================================================

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: [
        'favicon.svg',
        'favicon.ico',
        'robots.txt',
        'icon-192.png',
        'icon-512.png',
        'apple-touch-icon.png'
      ],
      manifest: {
        name: 'ASVO-QMS',
        short_name: 'MES',
        description: 'Система управления производством серверов',
        theme_color: '#0f172a',
        background_color: '#0f172a',
        display: 'standalone',
        orientation: 'portrait',
        scope: '/',
        start_url: '/',
        lang: 'ru',
        categories: ['business', 'productivity'],
        icons: [
          {
            src: '/icon-192.png',
            sizes: '192x192',
            type: 'image/png',
            purpose: 'any'
          },
          {
            src: '/icon-512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable'
          }
        ],
        shortcuts: [
          {
            name: 'Сканировать',
            short_name: 'Скан',
            url: '/production/scan',
            icons: [{ src: '/icon-192.png', sizes: '192x192' }]
          },
          {
            name: 'Склад',
            short_name: 'Склад',
            url: '/warehouse',
            icons: [{ src: '/icon-192.png', sizes: '192x192' }]
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https?:\/\/.*\/api\/.*/i,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 60 * 60
              },
              cacheableResponse: {
                statuses: [0, 200]
              },
              networkTimeoutSeconds: 10
            }
          },
          {
            urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp)$/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'images-cache',
              expiration: {
                maxEntries: 50,
                maxAgeSeconds: 60 * 60 * 24 * 30
              }
            }
          },
          {
            urlPattern: /\.(?:woff|woff2|ttf|eot)$/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'fonts-cache',
              expiration: {
                maxEntries: 10,
                maxAgeSeconds: 60 * 60 * 24 * 365
              }
            }
          }
        ],
        navigateFallbackDenylist: [/^\/realms/]
      },
      devOptions: {
        enabled: false
      }
    })
  ],
  server: {
    host: '0.0.0.0',
    port: 3000,
    strictPort: true,
    proxy: {
      '/api': {
        target: 'http://localhost:5001',
        changeOrigin: true,
        secure: false
      }
    },
    cors: true
  },
  preview: {
    host: '0.0.0.0',
    port: 3000,
    strictPort: true
  },
  build: {
    outDir: 'dist',
    sourcemap: false,
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true
      }
    },
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor-react': ['react', 'react-dom', 'react-router-dom'],
          'vendor-auth': ['oidc-client-ts', 'react-oidc-context'],
          'vendor-ui': ['lucide-react'],
          'vendor-http': ['axios']
        }
      }
    },
    chunkSizeWarningLimit: 500
  },
  resolve: {
    alias: {
      '@': '/src',
      '@components': '/src/components',
      '@pages': '/src/pages',
      '@api': '/src/api',
      '@hooks': '/src/hooks',
      '@config': '/src/config',
      '@types': '/src/types'
    }
  },
  define: {
    __APP_VERSION__: JSON.stringify('2.0.0')
  }
})
================================================================================
FILE: QMS-Server-master/config/config.js
================================================================================

require('dotenv').config();

const base = {
  username: process.env.DB_USER || 'qms',
  password: process.env.DB_PASSWORD || 'qms_dev_2026',
  database: process.env.DB_NAME || 'asvo_qms',
  host: process.env.DB_HOST || '127.0.0.1',
  port: Number(process.env.DB_PORT || 5434),
  dialect: 'postgres',
  logging: false,
  dialectOptions: {
    
    connectionTimeoutMillis: 5000,
  },
};

module.exports = {
  development: { ...base },
  test: { ...base },
  production: { ...base },
};

================================================================================
FILE: QMS-Server-master/config/modules.js
================================================================================










const MODULE_CATALOG = {
  
  'core.auth':          { name: 'Аутентификация',           group: 'core', alwaysOn: true },
  'core.users':         { name: 'Пользователи',              group: 'core', alwaysOn: true },
  'core.audit':         { name: 'Журнал аудита',             group: 'core', alwaysOn: true },
  'core.esign':         { name: 'Электронные подписи',       group: 'core', depends: ['core.auth'] },
  'core.admin':         { name: 'Администрирование',         group: 'core', alwaysOn: true },
  'core.tasks':         { name: 'Задачи и проекты',          group: 'core', alwaysOn: true },
  'core.notifications': { name: 'Уведомления',               group: 'core', depends: [] },

  
  'qms.dms':         { name: 'Документы СМК',              group: 'qms', depends: [] },
  'qms.changes':     { name: 'Управление изменениями',     group: 'qms', depends: ['qms.dms'] },
  'qms.nc':          { name: 'Несоответствия',              group: 'qms', depends: [] },
  'qms.capa':        { name: 'CAPA',                        group: 'qms', depends: ['qms.nc'] },
  'qms.complaints':  { name: 'Жалобы потребителей',         group: 'qms', depends: ['qms.nc'] },
  'qms.risk':        { name: 'Управление рисками',         group: 'qms', depends: [] },
  'qms.design':      { name: 'Управление проектированием', group: 'qms', depends: ['qms.dms', 'qms.risk', 'qms.changes'] },
  'qms.validation':  { name: 'Валидация процессов',        group: 'qms', depends: ['qms.equipment', 'qms.dms'] },
  'qms.supplier':    { name: 'Поставщики',                  group: 'qms', depends: [] },
  'qms.audit':       { name: 'Внутренние аудиты',          group: 'qms', depends: ['qms.nc'] },
  'qms.training':    { name: 'Обучение',                    group: 'qms', depends: [] },
  'qms.equipment':   { name: 'Оборудование',               group: 'qms', depends: [] },
  'qms.review':      { name: 'Анализ руководства',         group: 'qms', depends: [] },
  'qms.pms':         { name: 'Пострег. мониторинг',        group: 'qms', depends: ['qms.complaints', 'qms.nc'] },
  'qms.dashboard':   { name: 'Дашборд QMS',                group: 'qms', depends: [] },

  
  'wms.warehouse':    { name: 'Склад',                     group: 'wms', depends: [] },
  'wms.movements':    { name: 'Перемещения',               group: 'wms', depends: ['wms.warehouse'] },
  'wms.analytics':    { name: 'Аналитика склада',          group: 'wms', depends: ['wms.warehouse'] },
  'wms.inventory':    { name: 'Инвентаризация',            group: 'wms', depends: ['wms.warehouse'] },
  'wms.labels':       { name: 'Этикетки',                  group: 'wms', depends: ['wms.warehouse'] },
  'wms.alerts':       { name: 'Оповещения склада',         group: 'wms', depends: ['wms.warehouse'] },
  'wms.traceability': { name: 'Прослеживаемость',          group: 'wms', depends: ['wms.warehouse'] },

  
  'mes.routes':   { name: 'Маршруты сборки',          group: 'mes', depends: [] },
  'mes.orders':   { name: 'Произв. задания',          group: 'mes', depends: ['mes.routes'] },
  'mes.quality':  { name: 'Контроль качества',         group: 'mes', depends: ['mes.routes', 'qms.nc'] },
  'mes.dhr':      { name: 'DHR',                       group: 'mes', depends: ['mes.routes'] },
  'mes.dmr':      { name: 'DMR',                       group: 'mes', depends: [] },
  'mes.kpi':      { name: 'KPI производства',          group: 'mes', depends: ['mes.routes'] },

  
  'erp.bom':         { name: 'Спецификации (BOM)',     group: 'erp', depends: [] },
  'erp.mrp':         { name: 'Планирование MRP',       group: 'erp', depends: ['erp.bom', 'wms.warehouse'] },
  'erp.procurement': { name: 'Закупки',                 group: 'erp', depends: ['erp.bom', 'qms.supplier'] },
  'erp.costs':       { name: 'Себестоимость',           group: 'erp', depends: ['erp.bom'] },

  
  'ru.gost':      { name: 'ГОСТ / ЕСКД шаблоны',        group: 'ru', depends: ['qms.dms'] },
  'ru.rzn':       { name: 'Росздравнадзор',              group: 'ru', depends: ['qms.complaints'] },
  'ru.1c':        { name: 'Интеграция 1С',               group: 'ru', depends: ['wms.warehouse'] },
  'ru.metrology': { name: 'Метрологическое обеспечение', group: 'ru', depends: ['qms.equipment'] },

  
  'premium.ai':         { name: 'ИИ-ассистент',          group: 'premium', depends: ['qms.nc', 'qms.capa'] },
  'premium.readiness':  { name: 'Готовность к аудиту',    group: 'premium', depends: [] },
  'premium.analytics':  { name: 'Аналитика Pro',          group: 'premium', depends: [] },
  'premium.lms':        { name: 'eLearning / LMS',        group: 'premium', depends: ['qms.training'] },
  'premium.portal':     { name: 'Портал клиентов',        group: 'premium', depends: ['qms.dms', 'qms.complaints'] },
  'premium.multisite':  { name: 'Multi-Site',             group: 'premium', depends: ['core.users'] },

  
  'addon.mobile': { name: 'Мобильное приложение', group: 'addon', depends: [] },
  'addon.pdf':    { name: 'PDF-отчёты',           group: 'addon', depends: [] },
  'addon.excel':  { name: 'Excel-импорт',         group: 'addon', depends: [] },
};

const TIER_PRESETS = {
  start: [
    'qms.dms', 'qms.nc', 'qms.dashboard',
    'addon.pdf',
  ],
  standard: [
    'qms.dms', 'qms.nc', 'qms.capa', 'qms.complaints',
    'qms.risk', 'qms.dashboard',
    'wms.warehouse', 'wms.movements',
    'ru.gost',
    'addon.pdf', 'addon.excel',
  ],
  pro: [
    'qms.dms', 'qms.changes', 'qms.nc', 'qms.capa', 'qms.complaints',
    'qms.risk', 'qms.supplier', 'qms.audit', 'qms.training',
    'qms.equipment', 'qms.review', 'qms.dashboard',
    'core.esign', 'core.notifications',
    'wms.warehouse', 'wms.movements', 'wms.analytics',
    'wms.inventory', 'wms.labels', 'wms.alerts',
    'ru.gost', 'ru.rzn',
    'premium.readiness',
    'addon.mobile', 'addon.pdf', 'addon.excel',
  ],
  industry: [
    'qms.dms', 'qms.changes', 'qms.nc', 'qms.capa', 'qms.complaints',
    'qms.risk', 'qms.design', 'qms.validation',
    'qms.supplier', 'qms.audit', 'qms.training',
    'qms.equipment', 'qms.review', 'qms.pms', 'qms.dashboard',
    'core.esign', 'core.notifications',
    'wms.warehouse', 'wms.movements', 'wms.analytics',
    'wms.inventory', 'wms.labels', 'wms.alerts', 'wms.traceability',
    'mes.routes', 'mes.orders', 'mes.quality',
    'mes.dhr', 'mes.dmr', 'mes.kpi',
    'ru.gost', 'ru.rzn', 'ru.1c', 'ru.metrology',
    'premium.readiness', 'premium.analytics',
    'addon.mobile', 'addon.pdf', 'addon.excel',
  ],
};

class ModuleManager {
  constructor() {
    const tier = process.env.MODULES_TIER;
    const explicit = process.env.MODULES_ENABLED;

    if (explicit) {
      this.enabled = new Set(explicit.split(',').map(m => m.trim()));
      this.tier = 'custom';
    } else if (tier && TIER_PRESETS[tier]) {
      this.enabled = new Set(TIER_PRESETS[tier]);
      this.tier = tier;
    } else {
      
      this.enabled = new Set(Object.keys(MODULE_CATALOG));
      this.tier = 'dev-all';
    }

    
    for (const [code, mod] of Object.entries(MODULE_CATALOG)) {
      if (mod.alwaysOn) this.enabled.add(code);
    }

    this._resolveDependencies();
  }

  _resolveDependencies() {
    let changed = true;
    while (changed) {
      changed = false;
      for (const code of this.enabled) {
        const mod = MODULE_CATALOG[code];
        if (!mod || !mod.depends) continue;
        for (const dep of mod.depends) {
          if (!this.enabled.has(dep)) {
            this.enabled.add(dep);
            changed = true;
          }
        }
      }
    }
  }

  
  isEnabled(moduleCode) {
    if (this.enabled.has(moduleCode)) return true;
    
    for (const code of this.enabled) {
      if (code.startsWith(moduleCode + '.')) return true;
    }
    return false;
  }

  getEnabledGroups() {
    const groups = new Set();
    for (const code of this.enabled) {
      const mod = MODULE_CATALOG[code];
      if (mod) groups.add(mod.group);
    }
    return [...groups];
  }

  
  toClientConfig() {
    const modules = [];
    for (const [code, mod] of Object.entries(MODULE_CATALOG)) {
      modules.push({
        code,
        name: mod.name,
        group: mod.group,
        enabled: this.enabled.has(code) || !!mod.alwaysOn,
      });
    }
    return {
      tier: this.tier,
      enabled: [...this.enabled],
      groups: this.getEnabledGroups(),
      maxUsers: this._getMaxUsers(),
      modules,
    };
  }

  _getMaxUsers() {
    const limits = { start: 5, standard: 15, pro: 50, industry: 200, 'dev-all': 999, custom: 999 };
    return limits[this.tier] || 999;
  }

  
  printStatus() {
    const enabledCount = [...this.enabled].length;
    const groups = this.getEnabledGroups();
    console.log('╔══════════════════════════════════════╗');
    console.log('║       ASVO-QMS Module System         ║');
    console.log('╠══════════════════════════════════════╣');
    console.log(`║  Тариф:   ${this.tier.padEnd(26)}║`);
    console.log(`║  Модулей: ${String(enabledCount).padEnd(26)}║`);
    console.log(`║  Группы:  ${groups.join(', ').padEnd(26)}║`);
    console.log(`║  Юзеров:  до ${String(this._getMaxUsers()).padEnd(23)}║`);
    console.log('╚══════════════════════════════════════╝');
  }
}

const moduleManager = new ModuleManager();

module.exports = { moduleManager, MODULE_CATALOG, TIER_PRESETS };

================================================================================
FILE: QMS-Server-master/db.js
================================================================================

const {Sequelize} = require('sequelize')

module.exports = new Sequelize(
    process.env.DB_NAME,
    process.env.DB_USER,
    process.env.DB_PASSWORD,
    {
        dialect: 'postgres',
        host: process.env.DB_HOST,
        port: process.env.DB_PORT

    }
)
================================================================================
FILE: QMS-Server-master/docker-compose.yml
================================================================================

services:
  postgres:
    image: postgres:16-alpine
    container_name: asvo-qms-db
    environment:
      POSTGRES_DB: asvo_qms
      POSTGRES_USER: qms
      POSTGRES_PASSWORD: qms_dev_2026
    command: ["postgres","-c","listen_addresses=0.0.0.0"]
    ports:
      - "127.0.0.1:5434:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped
volumes:
  pgdata:

================================================================================
FILE: QMS-Server-master/error/ApiError.js
================================================================================

class ApiError extends Error {
  constructor(status, message) {
    super();
    this.status = status;
    this.message = message;
  }


  static badRequest(message) {
    return new ApiError(400, message);
  }


  static notFound(message) {
    return new ApiError(404, message);
  }


  static internal(message) {
    return new ApiError(500, message);
  }


  static forbidden(message) {
    return new ApiError(403, message);
  }


  static unauthorized(message) {
    return new ApiError(401, message);
  }
}

module.exports = ApiError;

================================================================================
FILE: QMS-Server-master/fonts/README.md
================================================================================

# ASVO-QMS-Server

================================================================================
FILE: QMS-Server-master/index.js
================================================================================

require("dotenv").config();
const express = require("express");
const sequelize = require("./db");
const { moduleManager } = require('./config/modules');
const models = require("./models/index");
const cors = require("cors");
const fileUpload = require("express-fileupload");
const router = require("./routes/index");
const errorHandler = require("./middleware/ErrorHandlingMiddleware");
const path = require("path");

const PORT = process.env.PORT || 5000;
const app = express();

app.use(express.json());

const corsOptions = {
  origin: "*",
  credentials: true,
  optionSuccessStatus: 200,
};

app.use(cors(corsOptions));
app.use(express.static(path.resolve(__dirname, "static")));
app.use(fileUpload({}));


app.use("/api", router);


app.use(errorHandler);

const initInitialData = async () => {
  try {
    console.log(">>> [RBAC] Начинаем инициализацию ролей и прав...");


    const permissions = [
      
      { code: "rbac.manage", description: "Управление ролями и матрицей прав" },
      { code: "users.manage", description: "Назначение ролей пользователям" },

      
      { code: "warehouse.view", description: "Просмотр остатков" },
      { code: "warehouse.manage", description: "Приемка, создание коробок, перемещение" },
      { code: "labels.print", description: "Печать этикеток" },

      
      { code: "dms.view", description: "Просмотр реестра документов" },
      { code: "dms.create", description: "Создание документов" },
      { code: "dms.approve", description: "Согласование документов" },
      { code: "dms.manage", description: "Введение в действие, рассылка" },

      
      { code: "qms.audit.view", description: "Расширенный аудит-лог" },
      { code: "qms.audit.verify", description: "Верификация hash-chain" },
      { code: "qms.audit.report", description: "Отчёты для инспекции" },

      
      { code: "nc.view", description: "Просмотр несоответствий" },
      { code: "nc.create", description: "Регистрация NC" },
      { code: "nc.manage", description: "Управление NC" },

      
      { code: "capa.view", description: "Просмотр CAPA" },
      { code: "capa.create", description: "Создание CAPA" },
      { code: "capa.manage", description: "Управление CAPA" },
      { code: "capa.verify", description: "Проверка эффективности CAPA" },

      
      { code: "risk.read", description: "Просмотр реестра рисков" },
      { code: "risk.create", description: "Идентификация рисков" },
      { code: "risk.update", description: "Обновление оценки рисков" },
      { code: "risk.assess", description: "Проведение оценки рисков" },
      { code: "risk.accept", description: "Принятие остаточного риска" },

      
      { code: "supplier.read", description: "Просмотр поставщиков" },
      { code: "supplier.manage", description: "Управление поставщиками" },

      
      { code: "training.read", description: "Просмотр записей обучения" },
      { code: "training.manage", description: "Управление обучением" },

      
      { code: "equipment.read", description: "Просмотр оборудования" },
      { code: "equipment.calibrate", description: "Калибровка/поверка" },

      
      { code: "review.read", description: "Просмотр анализа руководства" },
      { code: "review.manage", description: "Проведение анализа руководства" },

      
      { code: "analytics.view", description: "Просмотр дашбордов и KPI" },
      { code: "audit.log.view", description: "Просмотр журнала аудита" },
    ];


    for (const p of permissions) {
      await models.Ability.findOrCreate({ where: { code: p.code }, defaults: p });
    }


    const rolesData = [
      { code: "SUPER_ADMIN", name: "SUPER_ADMIN", description: "Полный доступ" },
      { code: "QMS_DIRECTOR", name: "QMS_DIRECTOR", description: "Директор по качеству" },
      { code: "QMS_ENGINEER", name: "QMS_ENGINEER", description: "Инженер по качеству" },
      { code: "QMS_AUDITOR", name: "QMS_AUDITOR", description: "Внутренний аудитор" },
      { code: "DOC_CONTROLLER", name: "DOC_CONTROLLER", description: "Управление документацией" },
      { code: "QC_ENGINEER", name: "QC_ENGINEER", description: "Инженер ОТК" },
      { code: "WAREHOUSE_MASTER", name: "WAREHOUSE_MASTER", description: "Кладовщик" },
      { code: "VIEWER", name: "VIEWER", description: "Наблюдатель — только просмотр" },
    ];

    for (const roleData of rolesData) {
      await models.Role.findOrCreate({
        where: { code: roleData.code },
        defaults: roleData,
      });
    }


    const assign = async (roleName, slugs) => {
      const role = await models.Role.findOne({ where: { name: roleName } });
      if (!role) return;

      let abilities;
      if (slugs === '*') {

        abilities = await models.Ability.findAll();
      } else {
        abilities = await models.Ability.findAll({ where: { code: slugs } });
      }

      if (abilities.length) {
        await role.setAbilities(abilities);
      }
    };


    await assign("SUPER_ADMIN", '*');

    await assign("QMS_DIRECTOR", [
      "dms.view", "dms.create", "dms.approve", "dms.manage",
      "nc.view", "nc.create", "nc.manage",
      "capa.view", "capa.create", "capa.manage", "capa.verify",
      "risk.read", "risk.create", "risk.update", "risk.assess", "risk.accept",
      "supplier.read", "supplier.manage",
      "training.read", "training.manage",
      "equipment.read", "equipment.calibrate",
      "review.read", "review.manage",
      "qms.audit.view", "qms.audit.verify", "qms.audit.report",
      "analytics.view", "audit.log.view",
      "warehouse.view", "rbac.manage", "users.manage",
    ]);

    await assign("QMS_ENGINEER", [
      "dms.view", "dms.create",
      "nc.view", "nc.create", "nc.manage",
      "capa.view", "capa.create",
      "risk.read", "risk.create", "risk.update", "risk.assess",
      "supplier.read",
      "training.read", "training.manage",
      "equipment.read", "equipment.calibrate",
      "review.read",
      "qms.audit.view",
      "analytics.view", "audit.log.view",
    ]);

    await assign("QMS_AUDITOR", [
      "dms.view",
      "nc.view",
      "capa.view",
      "risk.read",
      "supplier.read",
      "training.read",
      "equipment.read",
      "review.read",
      "qms.audit.view", "qms.audit.verify", "qms.audit.report",
      "analytics.view", "audit.log.view",
    ]);

    await assign("DOC_CONTROLLER", [
      "dms.view", "dms.create", "dms.approve", "dms.manage",
      "training.read",
      "analytics.view",
    ]);

    await assign("QC_ENGINEER", [
      "warehouse.view",
      "nc.view", "nc.create", "nc.manage",
      "capa.view", "capa.create", "capa.manage", "capa.verify",
      "qms.audit.view",
      "risk.read",
      "equipment.read",
    ]);

    await assign("WAREHOUSE_MASTER", [
      "warehouse.view", "warehouse.manage", "labels.print",
      "supplier.read",
      "nc.view", "nc.create",
      "dms.view",
    ]);

    await assign("VIEWER", [
      "dms.view", "nc.view", "capa.view", "risk.read",
      "supplier.read", "training.read", "equipment.read",
      "review.read", "analytics.view",
    ]);

    console.log(">>> [RBAC] Инициализация завершена успешно.");
  } catch (e) {
    console.error(">>> [RBAC] Ошибка инициализации:", e);
  }
};

const start = async () => {
  try {
    moduleManager.printStatus();
    await sequelize.authenticate();



    await initInitialData();

    app.listen(PORT, () => console.log(`Server started on port ${PORT}`));
  } catch (e) {
    console.log(e);
  }
};

start();

================================================================================
FILE: QMS-Server-master/jest.config.js
================================================================================

module.exports = {
  testEnvironment: 'node',
  coveragePathIgnorePatterns: [
    "/node_modules/"
  ]
};
================================================================================
FILE: QMS-Server-master/middleware/ErrorHandlingMiddleware.js
================================================================================

const ApiError = require("../error/ApiError");

module.exports = function (err, req, res, next) {

    const time = new Date().toISOString().replace('T', ' ').substring(0, 19);
    console.error(`\x1b[31m[${time}] ERROR:\x1b[0m ${req.method} ${req.url}`);


    if (!(err instanceof ApiError)) {
        console.error(err);
    } else {
        console.error(`ApiError: ${err.message}`);
    }


    if (err instanceof ApiError) {
        return res.status(err.status).json({
            message: err.message,
            errors: err.errors
        });
    }


    if (err.name === 'UnauthorizedError' || err.status === 401) {
        return res.status(401).json({
            message: "Пользователь не авторизован (Invalid Token)"
        });
    }
    if (err.name === 'InvalidTokenError') {
        return res.status(401).json({
            message: "Некорректный токен или срок действия истек"
        });
    }
    if (err.status === 403) {
        return res.status(403).json({
            message: "Нет доступа (Forbidden)"
        });
    }


    if (err.name === 'SequelizeUniqueConstraintError') {

        return res.status(409).json({
            message: "Запись с такими данными уже существует",
            details: err.errors.map(e => e.message)
        });
    }

    if (err.name === 'SequelizeValidationError') {
        return res.status(400).json({
            message: "Ошибка валидации данных",
            details: err.errors.map(e => e.message)
        });
    }

    if (err.name === 'SequelizeConnectionError') {
        return res.status(503).json({
            message: "Нет подключения к базе данных"
        });
    }


    return res.status(500).json({
        message: "Непредвиденная ошибка сервера",
        error: process.env.NODE_ENV === 'development' ? err.message : undefined
    });
};

================================================================================
FILE: QMS-Server-master/middleware/checkModuleMiddleware.js
================================================================================

const { moduleManager } = require('../config/modules');
const ApiError = require('../error/ApiError');





module.exports = function checkModule(moduleCode) {
  return function (req, res, next) {
    if (moduleManager.isEnabled(moduleCode)) {
      return next();
    }
    return next(ApiError.forbidden(
      `Модуль "${moduleCode}" не включён в текущий тариф (${moduleManager.tier}).`
    ));
  };
};

================================================================================
FILE: QMS-Server-master/migrations/20250126-add-structure-manager-fields.js
================================================================================

'use strict';


module.exports = {
  async up(queryInterface, Sequelize) {
    console.log('🚀 Добавляем поля managerId и teamLeadId...');


    await queryInterface.addColumn('production_section', 'managerId', {
      type: Sequelize.INTEGER,
      allowNull: true,
      references: {
        model: 'users',
        key: 'id'
      },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    }).then(() => console.log('✅ managerId добавлен в production_section'))
      .catch(() => console.log('⚠️ managerId уже существует в production_section'));


    await queryInterface.addColumn('production_team', 'teamLeadId', {
      type: Sequelize.INTEGER,
      allowNull: true,
      references: {
        model: 'users',
        key: 'id'
      },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    }).then(() => console.log('✅ teamLeadId добавлен в production_team'))
      .catch(() => console.log('⚠️ teamLeadId уже существует в production_team'));

    console.log('🎉 Миграция завершена!');
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.removeColumn('production_section', 'managerId')
      .catch(() => console.log('managerId не найден'));

    await queryInterface.removeColumn('production_team', 'teamLeadId')
      .catch(() => console.log('teamLeadId не найден'));
  }
};

================================================================================
FILE: QMS-Server-master/migrations/20260209-create-core.js
================================================================================

"use strict";

module.exports = {
  async up(queryInterface, Sequelize) {
    const t = await queryInterface.sequelize.transaction();
    try {
      const has = async (name) => {
        const r = await queryInterface.sequelize.query(
          `SELECT to_regclass('public.${name}') AS t`,
          { type: Sequelize.QueryTypes.SELECT, transaction: t }
        );
        return !!r?.[0]?.t;
      };

      
      if (!(await has("abilities"))) {
        await queryInterface.createTable(
          "abilities",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            code: { type: Sequelize.STRING(128), allowNull: false, unique: true },
            description: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      if (!(await has("roles"))) {
        await queryInterface.createTable(
          "roles",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            code: { type: Sequelize.STRING(128), allowNull: false, unique: true },
            name: { type: Sequelize.STRING(255), allowNull: false },
            description: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      if (!(await has("role_abilities"))) {
        await queryInterface.createTable(
          "role_abilities",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            roleId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "roles", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            abilityId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "abilities", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );

        await queryInterface.addIndex(
          "role_abilities",
          ["roleId", "abilityId"],
          { unique: true, name: "uq_role_abilities_role_ability", transaction: t }
        );
      }

      
      if (!(await has("production_section"))) {
        await queryInterface.createTable(
          "production_section",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            name: { type: Sequelize.STRING(255), allowNull: false },
            description: { type: Sequelize.TEXT, allowNull: true },
            managerId: { type: Sequelize.INTEGER, allowNull: true }, 
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      if (!(await has("production_team"))) {
        await queryInterface.createTable(
          "production_team",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            name: { type: Sequelize.STRING(255), allowNull: false },
            sectionId: { type: Sequelize.INTEGER, allowNull: true }, 
            teamLeadId: { type: Sequelize.INTEGER, allowNull: true }, 
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("users"))) {
        await queryInterface.createTable(
          "users",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            email: { type: Sequelize.STRING(255), allowNull: true, unique: true },
            login: { type: Sequelize.STRING(255), allowNull: true, unique: true },
            password: { type: Sequelize.STRING(255), allowNull: true },
            roleId: {
              type: Sequelize.INTEGER,
              allowNull: true,
              references: { model: "roles", key: "id" },
              onDelete: "SET NULL",
              onUpdate: "CASCADE",
            },
            teamId: {
              type: Sequelize.INTEGER,
              allowNull: true,
              references: { model: "production_team", key: "id" },
              onDelete: "SET NULL",
              onUpdate: "CASCADE",
            },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("pcs"))) {
        await queryInterface.createTable(
          "pcs",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            name: { type: Sequelize.STRING(255), allowNull: true },
            ip: { type: Sequelize.STRING(64), allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      if (!(await has("sessions"))) {
        await queryInterface.createTable(
          "sessions",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            userId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "users", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            PCId: {
              type: Sequelize.INTEGER,
              allowNull: true,
              references: { model: "pcs", key: "id" },
              onDelete: "SET NULL",
              onUpdate: "CASCADE",
            },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("audit_logs"))) {
        await queryInterface.createTable(
          "audit_logs",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            userId: {
              type: Sequelize.INTEGER,
              allowNull: true,
              references: { model: "users", key: "id" },
              onDelete: "SET NULL",
              onUpdate: "CASCADE",
            },
            entity: { type: Sequelize.STRING(255), allowNull: true },
            entityId: { type: Sequelize.STRING(255), allowNull: true },
            action: { type: Sequelize.STRING(255), allowNull: true },
            message: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      
      
      
      
      

      await t.commit();
      console.log("✅ [CORE] базовые таблицы созданы");
    } catch (e) {
      await t.rollback();
      throw e;
    }
  },

  async down(queryInterface, Sequelize) {
    const t = await queryInterface.sequelize.transaction();
    try {
      await queryInterface.dropTable("audit_logs", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("sessions", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("pcs", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("users", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("production_team", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("production_section", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("role_abilities", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("roles", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("abilities", { transaction: t }).catch(() => {});
      await t.commit();
    } catch (e) {
      await t.rollback();
      throw e;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260210-audit-hashchain.js
================================================================================

"use strict";









module.exports = {
  async up(queryInterface, Sequelize) {
    
    const reg = await queryInterface.sequelize.query(
      `SELECT to_regclass('public.audit_logs') AS t`,
      { type: Sequelize.QueryTypes.SELECT }
    );

    if (!reg?.[0]?.t) {
      console.log("⚠️ [audit-hashchain] Таблица public.audit_logs не найдена — пропускаем миграцию");
      return;
    }

    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      const table = await queryInterface.describeTable("audit_logs");

      
      if (!table.chainIndex) {
        await queryInterface.addColumn(
          "audit_logs",
          "chainIndex",
          {
            type: Sequelize.BIGINT,
            allowNull: true, 
            unique: true,
          },
          { transaction }
        );
      }

      if (!table.prevHash) {
        await queryInterface.addColumn(
          "audit_logs",
          "prevHash",
          {
            type: Sequelize.STRING(64),
            allowNull: true,
          },
          { transaction }
        );
      }

      if (!table.currentHash) {
        await queryInterface.addColumn(
          "audit_logs",
          "currentHash",
          {
            type: Sequelize.STRING(64),
            allowNull: true,
          },
          { transaction }
        );
      }

      if (!table.dataHash) {
        await queryInterface.addColumn(
          "audit_logs",
          "dataHash",
          {
            type: Sequelize.STRING(64),
            allowNull: true,
          },
          { transaction }
        );
      }

      
      if (!table.signedBy) {
        await queryInterface.addColumn(
          "audit_logs",
          "signedBy",
          {
            type: Sequelize.INTEGER,
            allowNull: true,
            comment: "userId кто подтвердил запись (электронная подпись)",
          },
          { transaction }
        );
      }

      if (!table.signedAt) {
        await queryInterface.addColumn(
          "audit_logs",
          "signedAt",
          {
            type: Sequelize.DATE,
            allowNull: true,
          },
          { transaction }
        );
      }

      
      if (!table.severity) {
        await queryInterface.addColumn(
          "audit_logs",
          "severity",
          {
            type: Sequelize.ENUM("INFO", "WARNING", "CRITICAL", "SECURITY"),
            allowNull: false,
            defaultValue: "INFO",
          },
          { transaction }
        );
      }

      
      
      const indexes = await queryInterface.sequelize.query(
        `SELECT indexname FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'audit_logs'`,
        { type: Sequelize.QueryTypes.SELECT, transaction }
      );
      const idx = new Set((indexes || []).map((r) => r.indexname));

      if (!idx.has("idx_audit_chain_index")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["chainIndex"],
          {
            name: "idx_audit_chain_index",
            unique: true,
            
            where: { chainIndex: { [Sequelize.Op.ne]: null } },
            transaction,
          }
        );
      }

      if (!idx.has("idx_audit_current_hash")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["currentHash"],
          { name: "idx_audit_current_hash", transaction }
        );
      }

      if (!idx.has("idx_audit_severity")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["severity"],
          { name: "idx_audit_severity", transaction }
        );
      }

      if (!idx.has("idx_audit_entity_lookup")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["entity", "entityId"],
          { name: "idx_audit_entity_lookup", transaction }
        );
      }

      if (!idx.has("idx_audit_created_at")) {
        await queryInterface.addIndex(
          "audit_logs",
          ["createdAt"],
          { name: "idx_audit_created_at", transaction }
        );
      }

      await transaction.commit();
      console.log("✅ [audit-hashchain] Миграция выполнена успешно");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },

  async down(queryInterface, Sequelize) {
    
    const reg = await queryInterface.sequelize.query(
      `SELECT to_regclass('public.audit_logs') AS t`,
      { type: Sequelize.QueryTypes.SELECT }
    );
    if (!reg?.[0]?.t) {
      console.log("⚠️ [audit-hashchain] Таблица public.audit_logs не найдена — down пропускаем");
      return;
    }

    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      const indexes = await queryInterface.sequelize.query(
        `SELECT indexname FROM pg_indexes WHERE schemaname = 'public' AND tablename = 'audit_logs'`,
        { type: Sequelize.QueryTypes.SELECT, transaction }
      );
      const idx = new Set((indexes || []).map((r) => r.indexname));

      if (idx.has("idx_audit_created_at")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_created_at", { transaction });
      }
      if (idx.has("idx_audit_entity_lookup")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_entity_lookup", { transaction });
      }
      if (idx.has("idx_audit_severity")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_severity", { transaction });
      }
      if (idx.has("idx_audit_current_hash")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_current_hash", { transaction });
      }
      if (idx.has("idx_audit_chain_index")) {
        await queryInterface.removeIndex("audit_logs", "idx_audit_chain_index", { transaction });
      }

      
      const table = await queryInterface.describeTable("audit_logs");

      if (table.severity) {
        await queryInterface.removeColumn("audit_logs", "severity", { transaction });
      }
      if (table.signedAt) {
        await queryInterface.removeColumn("audit_logs", "signedAt", { transaction });
      }
      if (table.signedBy) {
        await queryInterface.removeColumn("audit_logs", "signedBy", { transaction });
      }
      if (table.dataHash) {
        await queryInterface.removeColumn("audit_logs", "dataHash", { transaction });
      }
      if (table.currentHash) {
        await queryInterface.removeColumn("audit_logs", "currentHash", { transaction });
      }
      if (table.prevHash) {
        await queryInterface.removeColumn("audit_logs", "prevHash", { transaction });
      }
      if (table.chainIndex) {
        await queryInterface.removeColumn("audit_logs", "chainIndex", { transaction });
      }

      
      
      await queryInterface.sequelize.query(
        'DROP TYPE IF EXISTS "enum_audit_logs_severity";',
        { transaction }
      );

      await transaction.commit();
      console.log("✅ [audit-hashchain] Down выполнен успешно");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260210-create-dms.js
================================================================================

"use strict";















module.exports = {
  async up(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      await queryInterface.createTable("documents", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true,
        },
        code: {
          type: Sequelize.STRING(50),
          allowNull: false,
          unique: true,
          comment: "Уникальный код документа: СТО-СМК-001, РИ-ПР-003 и т.д.",
        },
        title: {
          type: Sequelize.STRING(500),
          allowNull: false,
        },
        type: {
          type: Sequelize.ENUM(
            "POLICY",           
            "MANUAL",           
            "PROCEDURE",        
            "WORK_INSTRUCTION", 
            "FORM",             
            "RECORD",           
            "SPECIFICATION",    
            "PLAN",             
            "EXTERNAL",         
            "OTHER"
          ),
          allowNull: false,
        },
        category: {
          type: Sequelize.STRING(100),
          allowNull: true,
          comment: "Категория: Производство, Закупки, Управление рисками и т.д.",
        },
        description: {
          type: Sequelize.TEXT,
          allowNull: true,
        },
        status: {
          type: Sequelize.ENUM(
            "DRAFT",      
            "REVIEW",     
            "APPROVED",   
            "EFFECTIVE",  
            "REVISION",   
            "OBSOLETE",   
            "CANCELLED"   
          ),
          allowNull: false,
          defaultValue: "DRAFT",
        },
        currentVersionId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          comment: "FK на текущую действующую версию",
        },
        ownerId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
          comment: "Владелец документа (ответственный за актуальность)",
        },
        reviewCycleMonths: {
          type: Sequelize.INTEGER,
          allowNull: true,
          defaultValue: 12,
          comment: "Периодичность пересмотра в месяцах",
        },
        nextReviewDate: {
          type: Sequelize.DATEONLY,
          allowNull: true,
          comment: "Дата следующего планового пересмотра",
        },
        effectiveDate: {
          type: Sequelize.DATEONLY,
          allowNull: true,
          comment: "Дата введения в действие",
        },
        obsoleteDate: {
          type: Sequelize.DATEONLY,
          allowNull: true,
        },
        replacedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "documents", key: "id" },
          comment: "Каким документом заменён (если OBSOLETE)",
        },
        
        isoSection: {
          type: Sequelize.STRING(20),
          allowNull: true,
          comment: "Раздел ISO 13485: 4.2, 7.5.1 и т.д.",
        },
        tags: {
          type: Sequelize.ARRAY(Sequelize.STRING),
          allowNull: true,
          defaultValue: [],
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("document_versions", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true,
        },
        documentId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "documents", key: "id" },
          onDelete: "CASCADE",
        },
        version: {
          type: Sequelize.STRING(20),
          allowNull: false,
          comment: "Номер версии: 1.0, 1.1, 2.0",
        },
        versionNumber: {
          type: Sequelize.INTEGER,
          allowNull: false,
          comment: "Числовой номер для сортировки (1, 2, 3...)",
        },
        status: {
          type: Sequelize.ENUM("DRAFT", "REVIEW", "APPROVED", "EFFECTIVE", "SUPERSEDED", "REJECTED"),
          allowNull: false,
          defaultValue: "DRAFT",
        },
        changeDescription: {
          type: Sequelize.TEXT,
          allowNull: true,
          comment: "Описание изменений по сравнению с предыдущей версией",
        },
        fileUrl: {
          type: Sequelize.STRING(1000),
          allowNull: true,
          comment: "Путь к файлу документа",
        },
        fileName: {
          type: Sequelize.STRING(500),
          allowNull: true,
        },
        fileSize: {
          type: Sequelize.INTEGER,
          allowNull: true,
        },
        fileMimeType: {
          type: Sequelize.STRING(100),
          allowNull: true,
        },
        fileHash: {
          type: Sequelize.STRING(64),
          allowNull: true,
          comment: "SHA-256 хеш файла — защита от подмены",
        },
        
        content: {
          type: Sequelize.TEXT,
          allowNull: true,
          comment: "Текстовое содержимое (для форм, шаблонов)",
        },
        createdById: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        approvedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
        },
        approvedAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        effectiveAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        supersededAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("document_approvals", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true,
        },
        versionId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "document_versions", key: "id" },
          onDelete: "CASCADE",
        },
        step: {
          type: Sequelize.INTEGER,
          allowNull: false,
          defaultValue: 1,
          comment: "Порядковый номер шага согласования",
        },
        role: {
          type: Sequelize.ENUM(
            "REVIEWER",       
            "APPROVER",       
            "QUALITY_OFFICER" 
          ),
          allowNull: false,
        },
        assignedToId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        decision: {
          type: Sequelize.ENUM("PENDING", "APPROVED", "REJECTED", "RETURNED"),
          allowNull: false,
          defaultValue: "PENDING",
        },
        comment: {
          type: Sequelize.TEXT,
          allowNull: true,
        },
        decidedAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        dueDate: {
          type: Sequelize.DATEONLY,
          allowNull: true,
          comment: "Срок рассмотрения",
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("document_distributions", {
        id: {
          type: Sequelize.INTEGER,
          primaryKey: true,
          autoIncrement: true,
        },
        versionId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "document_versions", key: "id" },
          onDelete: "CASCADE",
        },
        userId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        distributedAt: {
          type: Sequelize.DATE,
          allowNull: false,
          defaultValue: Sequelize.NOW,
        },
        acknowledged: {
          type: Sequelize.BOOLEAN,
          allowNull: false,
          defaultValue: false,
          comment: "Сотрудник подтвердил ознакомление",
        },
        acknowledgedAt: {
          type: Sequelize.DATE,
          allowNull: true,
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.addIndex("documents", ["code"], { unique: true, transaction });
      await queryInterface.addIndex("documents", ["status"], { transaction });
      await queryInterface.addIndex("documents", ["type"], { transaction });
      await queryInterface.addIndex("documents", ["ownerId"], { transaction });
      await queryInterface.addIndex("documents", ["nextReviewDate"], { transaction });

      await queryInterface.addIndex("document_versions", ["documentId", "versionNumber"], {
        unique: true, transaction,
      });
      await queryInterface.addIndex("document_versions", ["status"], { transaction });

      await queryInterface.addIndex("document_approvals", ["versionId", "step"], { transaction });
      await queryInterface.addIndex("document_approvals", ["assignedToId", "decision"], { transaction });

      await queryInterface.addIndex("document_distributions", ["versionId", "userId"], {
        unique: true, transaction,
      });
      await queryInterface.addIndex("document_distributions", ["userId", "acknowledged"], { transaction });

      await transaction.commit();
      console.log("✅ Миграция DMS выполнена: documents, document_versions, document_approvals, document_distributions");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },

  async down(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();
    try {
      await queryInterface.dropTable("document_distributions", { transaction });
      await queryInterface.dropTable("document_approvals", { transaction });
      await queryInterface.dropTable("document_versions", { transaction });
      await queryInterface.dropTable("documents", { transaction });

      
      for (const type of [
        "enum_documents_type",
        "enum_documents_status",
        "enum_document_versions_status",
        "enum_document_approvals_role",
        "enum_document_approvals_decision",
      ]) {
        await queryInterface.sequelize.query(`DROP TYPE IF EXISTS "${type}";`, { transaction });
      }

      await transaction.commit();
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260210-create-nc-capa.js
================================================================================

"use strict";

















module.exports = {
  async up(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      await queryInterface.createTable("nonconformities", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        number: {
          type: Sequelize.STRING(20),
          allowNull: false,
          unique: true,
          comment: "Номер NC: NC-0001, NC-0002...",
        },
        title: { type: Sequelize.STRING(500), allowNull: false },
        description: { type: Sequelize.TEXT, allowNull: false },
        source: {
          type: Sequelize.ENUM(
            "INCOMING_INSPECTION",  
            "IN_PROCESS",           
            "FINAL_INSPECTION",     
            "CUSTOMER_COMPLAINT",   
            "INTERNAL_AUDIT",       
            "EXTERNAL_AUDIT",       
            "SUPPLIER",             
            "FIELD_RETURN",         
            "OTHER"
          ),
          allowNull: false,
        },
        classification: {
          type: Sequelize.ENUM("CRITICAL", "MAJOR", "MINOR"),
          allowNull: false,
          defaultValue: "MINOR",
        },
        status: {
          type: Sequelize.ENUM(
            "OPEN",           
            "INVESTIGATING",  
            "DISPOSITION",    
            "IMPLEMENTING",   
            "VERIFICATION",   
            "CLOSED",         
            "REOPENED"        
          ),
          allowNull: false,
          defaultValue: "OPEN",
        },
        disposition: {
          type: Sequelize.ENUM(
            "USE_AS_IS",          
            "REWORK",             
            "REPAIR",             
            "SCRAP",              
            "RETURN_TO_SUPPLIER", 
            "CONCESSION",         
            "OTHER"
          ),
          allowNull: true,
          comment: "Решение по несоответствующей продукции",
        },
        dispositionJustification: {
          type: Sequelize.TEXT,
          allowNull: true,
          comment: "Обоснование решения (особенно для USE_AS_IS)",
        },

        
        productType: { type: Sequelize.STRING(100), allowNull: true },
        productSerialNumber: { type: Sequelize.STRING(100), allowNull: true },
        lotNumber: { type: Sequelize.STRING(100), allowNull: true },
        processName: { type: Sequelize.STRING(200), allowNull: true },
        supplierName: { type: Sequelize.STRING(200), allowNull: true },
        warehouseBoxId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          comment: "Связь с warehouse_box (если NC по конкретной позиции склада)",
        },
        documentId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          comment: "Связь с документом СМК (если NC по документу)",
        },

        
        totalQty: { type: Sequelize.INTEGER, allowNull: true, comment: "Общее кол-во в партии" },
        defectQty: { type: Sequelize.INTEGER, allowNull: true, comment: "Кол-во несоответствующих" },

        
        rootCause: { type: Sequelize.TEXT, allowNull: true },
        rootCauseMethod: {
          type: Sequelize.STRING(50),
          allowNull: true,
          comment: "Метод анализа: 5WHY, FISHBONE, FMEA и т.д.",
        },
        immediateAction: { type: Sequelize.TEXT, allowNull: true, comment: "Немедленное корректирующее действие" },

        
        reportedById: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        assignedToId: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
        },
        closedById: {
          type: Sequelize.INTEGER,
          allowNull: true,
          references: { model: "users", key: "id" },
        },

        
        detectedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        dueDate: { type: Sequelize.DATEONLY, allowNull: true },
        closedAt: { type: Sequelize.DATE, allowNull: true },

        
        capaRequired: {
          type: Sequelize.BOOLEAN,
          allowNull: false,
          defaultValue: false,
          comment: "Требуется ли CAPA (обязательно для CRITICAL)",
        },

        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("nc_attachments", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        nonconformityId: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "nonconformities", key: "id" }, onDelete: "CASCADE",
        },
        fileUrl: { type: Sequelize.STRING(1000), allowNull: false },
        fileName: { type: Sequelize.STRING(500), allowNull: false },
        fileSize: { type: Sequelize.INTEGER, allowNull: true },
        fileMimeType: { type: Sequelize.STRING(100), allowNull: true },
        description: { type: Sequelize.STRING(500), allowNull: true },
        uploadedById: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "users", key: "id" },
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("capas", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        number: {
          type: Sequelize.STRING(20),
          allowNull: false,
          unique: true,
          comment: "Номер: CAPA-0001",
        },
        type: {
          type: Sequelize.ENUM("CORRECTIVE", "PREVENTIVE"),
          allowNull: false,
        },
        title: { type: Sequelize.STRING(500), allowNull: false },
        description: { type: Sequelize.TEXT, allowNull: true },
        status: {
          type: Sequelize.ENUM(
            "INITIATED",      
            "INVESTIGATING",  
            "PLANNING",       
            "PLAN_APPROVED",  
            "IMPLEMENTING",   
            "VERIFYING",      
            "EFFECTIVE",      
            "INEFFECTIVE",    
            "CLOSED"          
          ),
          allowNull: false,
          defaultValue: "INITIATED",
        },
        priority: {
          type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH", "URGENT"),
          allowNull: false,
          defaultValue: "MEDIUM",
        },

        
        nonconformityId: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: "nonconformities", key: "id" },
          comment: "Первичная NC, породившая CAPA",
        },

        
        rootCauseAnalysis: { type: Sequelize.TEXT, allowNull: true },
        rootCauseMethod: { type: Sequelize.STRING(50), allowNull: true },

        
        initiatedById: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "users", key: "id" },
        },
        assignedToId: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: "users", key: "id" },
        },
        approvedById: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: "users", key: "id" },
        },

        
        dueDate: { type: Sequelize.DATEONLY, allowNull: true },
        planApprovedAt: { type: Sequelize.DATE, allowNull: true },
        implementedAt: { type: Sequelize.DATE, allowNull: true },
        closedAt: { type: Sequelize.DATE, allowNull: true },

        
        effectivenessCheckDate: {
          type: Sequelize.DATEONLY, allowNull: true,
          comment: "Дата плановой проверки эффективности (30/60/90 дней)",
        },
        effectivenessCheckDays: {
          type: Sequelize.INTEGER, allowNull: true, defaultValue: 90,
          comment: "Через сколько дней проверять эффективность",
        },

        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("capa_actions", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        capaId: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "capas", key: "id" }, onDelete: "CASCADE",
        },
        order: { type: Sequelize.INTEGER, allowNull: false, defaultValue: 1 },
        description: { type: Sequelize.TEXT, allowNull: false },
        assignedToId: {
          type: Sequelize.INTEGER, allowNull: true,
          references: { model: "users", key: "id" },
        },
        status: {
          type: Sequelize.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "CANCELLED"),
          allowNull: false,
          defaultValue: "PLANNED",
        },
        dueDate: { type: Sequelize.DATEONLY, allowNull: true },
        completedAt: { type: Sequelize.DATE, allowNull: true },
        result: { type: Sequelize.TEXT, allowNull: true },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.createTable("capa_verifications", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        capaId: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "capas", key: "id" }, onDelete: "CASCADE",
        },
        verifiedById: {
          type: Sequelize.INTEGER, allowNull: false,
          references: { model: "users", key: "id" },
        },
        isEffective: { type: Sequelize.BOOLEAN, allowNull: false },
        evidence: { type: Sequelize.TEXT, allowNull: true, comment: "Доказательства эффективности" },
        comment: { type: Sequelize.TEXT, allowNull: true },
        verifiedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
      }, { transaction });

      
      await queryInterface.addIndex("nonconformities", ["number"], { unique: true, transaction });
      await queryInterface.addIndex("nonconformities", ["status"], { transaction });
      await queryInterface.addIndex("nonconformities", ["source"], { transaction });
      await queryInterface.addIndex("nonconformities", ["classification"], { transaction });
      await queryInterface.addIndex("nonconformities", ["assignedToId"], { transaction });
      await queryInterface.addIndex("nonconformities", ["reportedById"], { transaction });
      await queryInterface.addIndex("nonconformities", ["detectedAt"], { transaction });

      await queryInterface.addIndex("capas", ["number"], { unique: true, transaction });
      await queryInterface.addIndex("capas", ["status"], { transaction });
      await queryInterface.addIndex("capas", ["type"], { transaction });
      await queryInterface.addIndex("capas", ["nonconformityId"], { transaction });
      await queryInterface.addIndex("capas", ["assignedToId"], { transaction });
      await queryInterface.addIndex("capas", ["effectivenessCheckDate"], { transaction });

      await queryInterface.addIndex("capa_actions", ["capaId", "order"], { transaction });
      await queryInterface.addIndex("capa_verifications", ["capaId"], { transaction });

      await transaction.commit();
      console.log("✅ Миграция NC/CAPA выполнена");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },

  async down(queryInterface) {
    const transaction = await queryInterface.sequelize.transaction();
    try {
      await queryInterface.dropTable("capa_verifications", { transaction });
      await queryInterface.dropTable("capa_actions", { transaction });
      await queryInterface.dropTable("capas", { transaction });
      await queryInterface.dropTable("nc_attachments", { transaction });
      await queryInterface.dropTable("nonconformities", { transaction });

      for (const type of [
        "enum_nonconformities_source", "enum_nonconformities_classification",
        "enum_nonconformities_status", "enum_nonconformities_disposition",
        "enum_capas_type", "enum_capas_status", "enum_capas_priority",
        "enum_capa_actions_status",
      ]) {
        await queryInterface.sequelize.query(`DROP TYPE IF EXISTS "${type}";`, { transaction });
      }
      await transaction.commit();
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260210-create-rbac.js
================================================================================

"use strict";

module.exports = {
  async up(queryInterface, Sequelize) {
    const t = await queryInterface.sequelize.transaction();
    try {
      const has = async (name) => {
        const r = await queryInterface.sequelize.query(
          `SELECT to_regclass('public.${name}') AS t`,
          { type: Sequelize.QueryTypes.SELECT, transaction: t }
        );
        return !!r?.[0]?.t;
      };

      
      if (!(await has("abilities"))) {
        await queryInterface.createTable(
          "abilities",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            code: { type: Sequelize.STRING(128), allowNull: false, unique: true },
            description: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("roles"))) {
        await queryInterface.createTable(
          "roles",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            code: { type: Sequelize.STRING(128), allowNull: false, unique: true },
            name: { type: Sequelize.STRING(255), allowNull: false },
            description: { type: Sequelize.TEXT, allowNull: true },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );
      }

      
      if (!(await has("role_abilities"))) {
        await queryInterface.createTable(
          "role_abilities",
          {
            id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true, allowNull: false },
            roleId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "roles", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            abilityId: {
              type: Sequelize.INTEGER,
              allowNull: false,
              references: { model: "abilities", key: "id" },
              onDelete: "CASCADE",
              onUpdate: "CASCADE",
            },
            createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
            updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
          },
          { transaction: t }
        );

        await queryInterface.addIndex(
          "role_abilities",
          ["roleId", "abilityId"],
          { unique: true, name: "uq_role_abilities_role_ability", transaction: t }
        );
      }

      await t.commit();
      console.log("✅ [RBAC] tables created");
    } catch (e) {
      await t.rollback();
      throw e;
    }
  },

  async down(queryInterface, Sequelize) {
    const t = await queryInterface.sequelize.transaction();
    try {
      await queryInterface.dropTable("role_abilities", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("roles", { transaction: t }).catch(() => {});
      await queryInterface.dropTable("abilities", { transaction: t }).catch(() => {});
      await t.commit();
    } catch (e) {
      await t.rollback();
      throw e;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211-p1p2-all-modules.js
================================================================================

"use strict";










module.exports = {
  async up(queryInterface, Sequelize) {
    const transaction = await queryInterface.sequelize.transaction();

    try {
      
      
      

      await queryInterface.createTable("risk_registers", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        riskNumber: { type: Sequelize.STRING, unique: true, allowNull: false },
        title: { type: Sequelize.STRING(500), allowNull: false },
        description: { type: Sequelize.TEXT },
        category: { type: Sequelize.ENUM("PRODUCT", "PROCESS", "SUPPLIER", "REGULATORY", "INFRASTRUCTURE", "HUMAN", "CYBER"), allowNull: false },
        relatedEntity: { type: Sequelize.STRING },
        relatedEntityId: { type: Sequelize.INTEGER },
        initialProbability: { type: Sequelize.INTEGER, allowNull: false },
        initialSeverity: { type: Sequelize.INTEGER, allowNull: false },
        initialRiskLevel: { type: Sequelize.INTEGER },
        initialRiskClass: { type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL") },
        residualProbability: { type: Sequelize.INTEGER },
        residualSeverity: { type: Sequelize.INTEGER },
        residualRiskLevel: { type: Sequelize.INTEGER },
        residualRiskClass: { type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL") },
        status: { type: Sequelize.ENUM("IDENTIFIED", "ASSESSED", "MITIGATED", "ACCEPTED", "CLOSED", "MONITORING"), defaultValue: "IDENTIFIED" },
        acceptanceDecision: { type: Sequelize.TEXT },
        acceptedBy: { type: Sequelize.INTEGER },
        acceptedAt: { type: Sequelize.DATE },
        ownerId: { type: Sequelize.INTEGER },
        reviewDate: { type: Sequelize.DATE },
        isoClause: { type: Sequelize.STRING },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("risk_assessments", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        riskRegisterId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "risk_registers", key: "id" } },
        assessmentDate: { type: Sequelize.DATE, allowNull: false },
        assessorId: { type: Sequelize.INTEGER, allowNull: false },
        probability: { type: Sequelize.INTEGER, allowNull: false },
        severity: { type: Sequelize.INTEGER, allowNull: false },
        detectability: { type: Sequelize.INTEGER },
        riskLevel: { type: Sequelize.INTEGER },
        riskClass: { type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL") },
        rationale: { type: Sequelize.TEXT },
        assessmentType: { type: Sequelize.ENUM("INITIAL", "PERIODIC", "POST_MITIGATION", "POST_INCIDENT"), defaultValue: "INITIAL" },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("risk_mitigations", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        riskRegisterId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "risk_registers", key: "id" } },
        mitigationType: { type: Sequelize.ENUM("DESIGN", "PROTECTIVE", "INFORMATION", "PROCESS_CONTROL", "TRAINING", "MONITORING"), allowNull: false },
        description: { type: Sequelize.TEXT, allowNull: false },
        responsibleId: { type: Sequelize.INTEGER },
        plannedDate: { type: Sequelize.DATE },
        completedDate: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "VERIFIED", "INEFFECTIVE"), defaultValue: "PLANNED" },
        verifiedBy: { type: Sequelize.INTEGER },
        verifiedAt: { type: Sequelize.DATE },
        verificationNotes: { type: Sequelize.TEXT },
        capaId: { type: Sequelize.INTEGER },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("suppliers", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        code: { type: Sequelize.STRING, unique: true, allowNull: false },
        name: { type: Sequelize.STRING(500), allowNull: false },
        legalName: { type: Sequelize.STRING(500) },
        inn: { type: Sequelize.STRING(12) },
        address: { type: Sequelize.TEXT },
        contactPerson: { type: Sequelize.STRING },
        phone: { type: Sequelize.STRING },
        email: { type: Sequelize.STRING },
        website: { type: Sequelize.STRING },
        category: { type: Sequelize.ENUM("RAW_MATERIAL", "COMPONENT", "SERVICE", "EQUIPMENT", "PACKAGING", "SOFTWARE", "SUBCONTRACTOR"), allowNull: false },
        criticality: { type: Sequelize.ENUM("CRITICAL", "MAJOR", "MINOR"), defaultValue: "MAJOR" },
        qualificationStatus: { type: Sequelize.ENUM("PENDING", "QUALIFIED", "CONDITIONAL", "DISQUALIFIED", "SUSPENDED"), defaultValue: "PENDING" },
        qualifiedAt: { type: Sequelize.DATE },
        qualifiedBy: { type: Sequelize.INTEGER },
        nextEvaluationDate: { type: Sequelize.DATE },
        hasCertISO9001: { type: Sequelize.BOOLEAN, defaultValue: false },
        hasCertISO13485: { type: Sequelize.BOOLEAN, defaultValue: false },
        certExpiryDate: { type: Sequelize.DATE },
        overallScore: { type: Sequelize.FLOAT },
        notes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("supplier_evaluations", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        supplierId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "suppliers", key: "id" } },
        evaluationDate: { type: Sequelize.DATE, allowNull: false },
        evaluatorId: { type: Sequelize.INTEGER, allowNull: false },
        evaluationType: { type: Sequelize.ENUM("INITIAL", "PERIODIC", "POST_INCIDENT", "REQUALIFICATION"), defaultValue: "PERIODIC" },
        qualityScore: { type: Sequelize.INTEGER },
        deliveryScore: { type: Sequelize.INTEGER },
        documentationScore: { type: Sequelize.INTEGER },
        communicationScore: { type: Sequelize.INTEGER },
        priceScore: { type: Sequelize.INTEGER },
        complianceScore: { type: Sequelize.INTEGER },
        totalScore: { type: Sequelize.FLOAT },
        decision: { type: Sequelize.ENUM("APPROVED", "CONDITIONALLY_APPROVED", "REJECTED", "SUSPENDED") },
        conditions: { type: Sequelize.TEXT },
        comments: { type: Sequelize.TEXT },
        totalOrders: { type: Sequelize.INTEGER, defaultValue: 0 },
        defectiveOrders: { type: Sequelize.INTEGER, defaultValue: 0 },
        lateDeliveries: { type: Sequelize.INTEGER, defaultValue: 0 },
        ncCount: { type: Sequelize.INTEGER, defaultValue: 0 },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("supplier_audits", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        supplierId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "suppliers", key: "id" } },
        auditDate: { type: Sequelize.DATE, allowNull: false },
        auditorId: { type: Sequelize.INTEGER, allowNull: false },
        auditType: { type: Sequelize.ENUM("ON_SITE", "REMOTE", "DOCUMENT"), defaultValue: "ON_SITE" },
        scope: { type: Sequelize.TEXT },
        findings: { type: Sequelize.TEXT },
        findingsCount: { type: Sequelize.INTEGER, defaultValue: 0 },
        majorFindings: { type: Sequelize.INTEGER, defaultValue: 0 },
        minorFindings: { type: Sequelize.INTEGER, defaultValue: 0 },
        result: { type: Sequelize.ENUM("PASS", "CONDITIONAL", "FAIL") },
        nextAuditDate: { type: Sequelize.DATE },
        reportUrl: { type: Sequelize.STRING },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("audit_plans", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        year: { type: Sequelize.INTEGER, allowNull: false },
        title: { type: Sequelize.STRING, allowNull: false },
        approvedBy: { type: Sequelize.INTEGER },
        approvedAt: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("DRAFT", "APPROVED", "IN_PROGRESS", "COMPLETED"), defaultValue: "DRAFT" },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("audit_schedules", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        auditPlanId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "audit_plans", key: "id" } },
        auditNumber: { type: Sequelize.STRING, unique: true, allowNull: false },
        title: { type: Sequelize.STRING, allowNull: false },
        scope: { type: Sequelize.TEXT },
        isoClause: { type: Sequelize.STRING },
        plannedDate: { type: Sequelize.DATE, allowNull: false },
        actualDate: { type: Sequelize.DATE },
        leadAuditorId: { type: Sequelize.INTEGER },
        auditeeId: { type: Sequelize.INTEGER },
        status: { type: Sequelize.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "CANCELLED", "OVERDUE"), defaultValue: "PLANNED" },
        criteria: { type: Sequelize.TEXT },
        conclusion: { type: Sequelize.TEXT },
        reportUrl: { type: Sequelize.STRING },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("audit_findings", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        auditScheduleId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "audit_schedules", key: "id" } },
        findingNumber: { type: Sequelize.STRING, allowNull: false },
        type: { type: Sequelize.ENUM("MAJOR_NC", "MINOR_NC", "OBSERVATION", "OPPORTUNITY", "POSITIVE"), allowNull: false },
        isoClause: { type: Sequelize.STRING },
        description: { type: Sequelize.TEXT, allowNull: false },
        evidence: { type: Sequelize.TEXT },
        nonconformityId: { type: Sequelize.INTEGER },
        capaId: { type: Sequelize.INTEGER },
        responsibleId: { type: Sequelize.INTEGER },
        dueDate: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("OPEN", "ACTION_REQUIRED", "CORRECTED", "VERIFIED", "CLOSED"), defaultValue: "OPEN" },
        closedBy: { type: Sequelize.INTEGER },
        closedAt: { type: Sequelize.DATE },
        closureNotes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("training_plans", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        title: { type: Sequelize.STRING, allowNull: false },
        description: { type: Sequelize.TEXT },
        year: { type: Sequelize.INTEGER, allowNull: false },
        status: { type: Sequelize.ENUM("DRAFT", "APPROVED", "IN_PROGRESS", "COMPLETED"), defaultValue: "DRAFT" },
        approvedBy: { type: Sequelize.INTEGER },
        approvedAt: { type: Sequelize.DATE },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("training_records", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        userId: { type: Sequelize.INTEGER, allowNull: false },
        trainerId: { type: Sequelize.INTEGER },
        trainingPlanId: { type: Sequelize.INTEGER, references: { model: "training_plans", key: "id" } },
        title: { type: Sequelize.STRING, allowNull: false },
        description: { type: Sequelize.TEXT },
        type: { type: Sequelize.ENUM("ONBOARDING", "PROCEDURE", "EQUIPMENT", "GMP", "SAFETY", "REGULATORY", "SOFTWARE", "RETRAINING"), allowNull: false },
        relatedDocumentId: { type: Sequelize.INTEGER },
        trainingDate: { type: Sequelize.DATE, allowNull: false },
        duration: { type: Sequelize.FLOAT },
        assessmentMethod: { type: Sequelize.ENUM("TEST", "PRACTICAL", "OBSERVATION", "SELF_STUDY", "NONE"), defaultValue: "NONE" },
        assessmentScore: { type: Sequelize.FLOAT },
        passed: { type: Sequelize.BOOLEAN },
        confirmedBy: { type: Sequelize.INTEGER },
        confirmedAt: { type: Sequelize.DATE },
        certificateUrl: { type: Sequelize.STRING },
        expiryDate: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("PLANNED", "COMPLETED", "FAILED", "EXPIRED"), defaultValue: "PLANNED" },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("competency_matrices", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        userId: { type: Sequelize.INTEGER, allowNull: false },
        processName: { type: Sequelize.STRING, allowNull: false },
        level: { type: Sequelize.ENUM("NONE", "AWARENESS", "TRAINED", "COMPETENT", "EXPERT"), defaultValue: "NONE" },
        requiredLevel: { type: Sequelize.ENUM("NONE", "AWARENESS", "TRAINED", "COMPETENT", "EXPERT"), defaultValue: "TRAINED" },
        lastTrainingDate: { type: Sequelize.DATE },
        nextTrainingDate: { type: Sequelize.DATE },
        notes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("equipment", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        inventoryNumber: { type: Sequelize.STRING, unique: true, allowNull: false },
        name: { type: Sequelize.STRING, allowNull: false },
        manufacturer: { type: Sequelize.STRING },
        model: { type: Sequelize.STRING },
        serialNumber: { type: Sequelize.STRING },
        type: { type: Sequelize.ENUM("MEASURING", "TEST", "PRODUCTION", "MONITORING", "IT"), allowNull: false },
        location: { type: Sequelize.STRING },
        responsibleId: { type: Sequelize.INTEGER },
        measuringRange: { type: Sequelize.STRING },
        accuracy: { type: Sequelize.STRING },
        resolution: { type: Sequelize.STRING },
        calibrationType: { type: Sequelize.ENUM("VERIFICATION", "CALIBRATION", "VALIDATION", "NONE"), defaultValue: "NONE" },
        calibrationInterval: { type: Sequelize.INTEGER },
        lastCalibrationDate: { type: Sequelize.DATE },
        nextCalibrationDate: { type: Sequelize.DATE },
        status: { type: Sequelize.ENUM("IN_SERVICE", "OUT_OF_SERVICE", "IN_CALIBRATION", "OVERDUE", "DECOMMISSIONED"), defaultValue: "IN_SERVICE" },
        commissionedDate: { type: Sequelize.DATE },
        decommissionedDate: { type: Sequelize.DATE },
        decommissionReason: { type: Sequelize.TEXT },
        certificateUrl: { type: Sequelize.STRING },
        notes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("calibration_records", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        equipmentId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "equipment", key: "id" } },
        calibrationDate: { type: Sequelize.DATE, allowNull: false },
        performedBy: { type: Sequelize.STRING },
        performedById: { type: Sequelize.INTEGER },
        type: { type: Sequelize.ENUM("VERIFICATION", "CALIBRATION", "ADJUSTMENT"), allowNull: false },
        result: { type: Sequelize.ENUM("PASS", "FAIL", "ADJUSTED", "OUT_OF_TOLERANCE"), allowNull: false },
        measuredValues: { type: Sequelize.JSON },
        certificateNumber: { type: Sequelize.STRING },
        certificateUrl: { type: Sequelize.STRING },
        nextCalibrationDate: { type: Sequelize.DATE },
        impactAssessment: { type: Sequelize.TEXT },
        ncCreated: { type: Sequelize.BOOLEAN, defaultValue: false },
        nonconformityId: { type: Sequelize.INTEGER },
        notes: { type: Sequelize.TEXT },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      

      await queryInterface.createTable("management_reviews", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        reviewNumber: { type: Sequelize.STRING, unique: true, allowNull: false },
        title: { type: Sequelize.STRING, allowNull: false },
        reviewDate: { type: Sequelize.DATE, allowNull: false },
        periodFrom: { type: Sequelize.DATE, allowNull: false },
        periodTo: { type: Sequelize.DATE, allowNull: false },
        chairpersonId: { type: Sequelize.INTEGER },
        participants: { type: Sequelize.JSON },
        status: { type: Sequelize.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "APPROVED"), defaultValue: "PLANNED" },
        inputData: { type: Sequelize.JSON },
        outputData: { type: Sequelize.JSON },
        conclusion: { type: Sequelize.TEXT },
        qmsEffectiveness: { type: Sequelize.ENUM("EFFECTIVE", "PARTIALLY_EFFECTIVE", "INEFFECTIVE") },
        minutesUrl: { type: Sequelize.STRING },
        approvedBy: { type: Sequelize.INTEGER },
        approvedAt: { type: Sequelize.DATE },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      await queryInterface.createTable("review_actions", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        managementReviewId: { type: Sequelize.INTEGER, allowNull: false, references: { model: "management_reviews", key: "id" } },
        description: { type: Sequelize.TEXT, allowNull: false },
        responsibleId: { type: Sequelize.INTEGER },
        deadline: { type: Sequelize.DATE },
        priority: { type: Sequelize.ENUM("LOW", "MEDIUM", "HIGH"), defaultValue: "MEDIUM" },
        category: { type: Sequelize.ENUM("IMPROVEMENT", "RESOURCE", "TRAINING", "PROCESS_CHANGE", "POLICY", "INFRASTRUCTURE") },
        status: { type: Sequelize.ENUM("OPEN", "IN_PROGRESS", "COMPLETED", "OVERDUE", "CANCELLED"), defaultValue: "OPEN" },
        completedAt: { type: Sequelize.DATE },
        completionNotes: { type: Sequelize.TEXT },
        capaId: { type: Sequelize.INTEGER },
        createdAt: { type: Sequelize.DATE, allowNull: false },
        updatedAt: { type: Sequelize.DATE, allowNull: false },
      }, { transaction });

      
      
      
      
      await queryInterface.addIndex("risk_registers", ["status"], { name: "idx_risk_status", transaction });
      await queryInterface.addIndex("risk_registers", ["initialRiskClass"], { name: "idx_risk_class", transaction });
      await queryInterface.addIndex("risk_registers", ["ownerId"], { name: "idx_risk_owner", transaction });
      await queryInterface.addIndex("suppliers", ["qualificationStatus"], { name: "idx_supplier_status", transaction });
      await queryInterface.addIndex("suppliers", ["category"], { name: "idx_supplier_category", transaction });
      await queryInterface.addIndex("equipment", ["status"], { name: "idx_equip_status", transaction });
      await queryInterface.addIndex("equipment", ["nextCalibrationDate"], { name: "idx_equip_next_cal", transaction });
      await queryInterface.addIndex("training_records", ["userId"], { name: "idx_training_user", transaction });
      await queryInterface.addIndex("competency_matrices", ["userId", "processName"], { name: "idx_competency_user_process", unique: true, transaction });

      await transaction.commit();
      console.log("✅ Миграция P1+P2 модулей выполнена: 17 таблиц создано");
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },

  async down(queryInterface) {
    const transaction = await queryInterface.sequelize.transaction();
    try {
      const tables = [
        "review_actions", "management_reviews",
        "calibration_records", "equipment",
        "competency_matrices", "training_records", "training_plans",
        "audit_findings", "audit_schedules", "audit_plans",
        "supplier_audits", "supplier_evaluations", "suppliers",
        "risk_mitigations", "risk_assessments", "risk_registers",
      ];
      for (const t of tables) {
        await queryInterface.dropTable(t, { transaction, cascade: true });
      }
      await transaction.commit();
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211120000-fix-users-columns.js
================================================================================

"use strict";









module.exports = {
  async up(queryInterface, Sequelize) {
    const table = await queryInterface.describeTable("users");

    if (!table.name) {
      await queryInterface.addColumn("users", "name", {
        type: Sequelize.STRING(255),
        allowNull: true,
      });
    }

    if (!table.surname) {
      await queryInterface.addColumn("users", "surname", {
        type: Sequelize.STRING(255),
        allowNull: true,
      });
    }

    if (!table.img) {
      await queryInterface.addColumn("users", "img", {
        type: Sequelize.STRING(255),
        allowNull: true,
      });
    }

    console.log("✅ [fix-users] name, surname, img columns ensured");
  },

  async down(queryInterface) {
    const table = await queryInterface.describeTable("users");
    if (table.img) await queryInterface.removeColumn("users", "img");
    if (table.surname) await queryInterface.removeColumn("users", "surname");
    if (table.name) await queryInterface.removeColumn("users", "name");
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211120001-fix-pcs-columns.js
================================================================================

"use strict";










module.exports = {
  async up(queryInterface, Sequelize) {
    const table = await queryInterface.describeTable("pcs");

    
    if (table.name && !table.pc_name) {
      await queryInterface.renameColumn("pcs", "name", "pc_name");
      console.log("  renamed pcs.name → pcs.pc_name");
    }

    
    if (!table.cabinet) {
      await queryInterface.addColumn("pcs", "cabinet", {
        type: Sequelize.STRING(255),
        allowNull: true,
      });
      console.log("  added pcs.cabinet");
    }

    console.log("✅ [fix-pcs] columns fixed");
  },

  async down(queryInterface, Sequelize) {
    const table = await queryInterface.describeTable("pcs");
    if (table.cabinet) await queryInterface.removeColumn("pcs", "cabinet");
    if (table.pc_name && !table.name) {
      await queryInterface.renameColumn("pcs", "pc_name", "name");
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211120002-fix-sessions-columns.js
================================================================================

"use strict";








module.exports = {
  async up(queryInterface, Sequelize) {
    const table = await queryInterface.describeTable("sessions");

    if (!table.online) {
      await queryInterface.addColumn("sessions", "online", {
        type: Sequelize.BOOLEAN,
        allowNull: true,
        defaultValue: false,
      });
    }

    console.log("✅ [fix-sessions] online column ensured");
  },

  async down(queryInterface) {
    const table = await queryInterface.describeTable("sessions");
    if (table.online) await queryInterface.removeColumn("sessions", "online");
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211120003-fix-audit-logs-columns.js
================================================================================

"use strict";










module.exports = {
  async up(queryInterface, Sequelize) {
    const table = await queryInterface.describeTable("audit_logs");

    
    if (table.message && !table.description) {
      await queryInterface.renameColumn("audit_logs", "message", "description");
      console.log("  renamed audit_logs.message → audit_logs.description");
    }

    
    if (!table.metadata) {
      await queryInterface.addColumn("audit_logs", "metadata", {
        type: Sequelize.JSON,
        allowNull: true,
      });
      console.log("  added audit_logs.metadata");
    }

    console.log("✅ [fix-audit-logs] columns fixed");
  },

  async down(queryInterface, Sequelize) {
    const table = await queryInterface.describeTable("audit_logs");
    if (table.metadata) await queryInterface.removeColumn("audit_logs", "metadata");
    if (table.description && !table.message) {
      await queryInterface.renameColumn("audit_logs", "description", "message");
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211120004-fix-production-section-columns.js
================================================================================

"use strict";








module.exports = {
  async up(queryInterface) {
    const table = await queryInterface.describeTable("production_section");

    if (table.name && !table.title) {
      await queryInterface.renameColumn("production_section", "name", "title");
      console.log("  renamed production_section.name → title");
    }

    console.log("✅ [fix-production-section] columns fixed");
  },

  async down(queryInterface) {
    const table = await queryInterface.describeTable("production_section");
    if (table.title && !table.name) {
      await queryInterface.renameColumn("production_section", "title", "name");
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211120005-fix-production-team-columns.js
================================================================================

"use strict";









module.exports = {
  async up(queryInterface) {
    const table = await queryInterface.describeTable("production_team");

    
    if (table.name && !table.title) {
      await queryInterface.renameColumn("production_team", "name", "title");
      console.log("  renamed production_team.name → title");
    }

    
    if (table.sectionId && !table.productionSectionId) {
      await queryInterface.renameColumn("production_team", "sectionId", "productionSectionId");
      console.log("  renamed production_team.sectionId → productionSectionId");
    }

    console.log("✅ [fix-production-team] columns fixed");
  },

  async down(queryInterface) {
    const table = await queryInterface.describeTable("production_team");
    if (table.productionSectionId && !table.sectionId) {
      await queryInterface.renameColumn("production_team", "productionSectionId", "sectionId");
    }
    if (table.title && !table.name) {
      await queryInterface.renameColumn("production_team", "title", "name");
    }
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211120006-create-projects.js
================================================================================

"use strict";








module.exports = {
  async up(queryInterface, Sequelize) {
    const reg = await queryInterface.sequelize.query(
      `SELECT to_regclass('public.projects') AS t`,
      { type: Sequelize.QueryTypes.SELECT }
    );
    if (reg?.[0]?.t) {
      console.log("⚠️ [create-projects] Table already exists, skipping");
      return;
    }

    await queryInterface.createTable("projects", {
      id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
      title: { type: Sequelize.STRING(255), allowNull: false, unique: true },
      description: { type: Sequelize.TEXT, allowNull: true },
      status: { type: Sequelize.STRING(50), allowNull: false, defaultValue: "ACTIVE" },
      createdById: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: { model: "users", key: "id" },
        onDelete: "CASCADE",
        onUpdate: "CASCADE",
      },
      createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
      updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
    });

    console.log("✅ [create-projects] Table created");
  },

  async down(queryInterface) {
    await queryInterface.dropTable("projects");
  },
};

================================================================================
FILE: QMS-Server-master/migrations/20260211120007-create-warehouse-tables.js
================================================================================

"use strict";
















module.exports = {
  async up(queryInterface, Sequelize) {
    const has = async (name) => {
      const r = await queryInterface.sequelize.query(
        `SELECT to_regclass('public.${name}') AS t`,
        { type: Sequelize.QueryTypes.SELECT }
      );
      return !!r?.[0]?.t;
    };

    
    if (!(await has("production_outputs"))) {
      await queryInterface.createTable("production_outputs", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        date: { type: Sequelize.DATEONLY, allowNull: false },
        approvedQty: { type: Sequelize.INTEGER, allowNull: false, defaultValue: 0 },
        status: { type: Sequelize.STRING(50), allowNull: false, defaultValue: "DRAFT" },
        userId: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        projectId: { type: Sequelize.INTEGER, allowNull: true },
        comment: { type: Sequelize.TEXT, allowNull: true },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
      });
      console.log("  created production_outputs");
    }

    
    if (!(await has("supplies"))) {
      await queryInterface.createTable("supplies", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        supplier: { type: Sequelize.STRING(255), allowNull: true },
        docNumber: { type: Sequelize.STRING(255), allowNull: true },
        status: { type: Sequelize.STRING(50), allowNull: false, defaultValue: "NEW" },
        comment: { type: Sequelize.TEXT, allowNull: true },
        expectedDate: { type: Sequelize.DATEONLY, allowNull: true },
        receivedAt: { type: Sequelize.DATE, allowNull: true, defaultValue: Sequelize.fn("NOW") },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
      });
      console.log("  created supplies");
    }

    
    if (!(await has("warehouse_boxes"))) {
      await queryInterface.createTable("warehouse_boxes", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        supplyId: { type: Sequelize.INTEGER, allowNull: true },
        qrCode: { type: Sequelize.STRING(255), allowNull: false, unique: true },
        shortCode: { type: Sequelize.STRING(255), allowNull: true, unique: true },
        label: { type: Sequelize.STRING(255), allowNull: false },
        originType: { type: Sequelize.STRING(255), allowNull: true },
        originId: { type: Sequelize.INTEGER, allowNull: true },
        quantity: { type: Sequelize.INTEGER, allowNull: false, defaultValue: 1 },
        unit: { type: Sequelize.STRING(50), allowNull: false, defaultValue: "шт" },
        parentBoxId: { type: Sequelize.INTEGER, allowNull: true },
        kitNumber: { type: Sequelize.STRING(255), allowNull: true },
        projectName: { type: Sequelize.STRING(255), allowNull: true },
        batchName: { type: Sequelize.STRING(255), allowNull: true },
        status: { type: Sequelize.STRING(50), allowNull: false, defaultValue: "ON_STOCK" },
        notes: { type: Sequelize.TEXT, allowNull: true },
        currentSectionId: { type: Sequelize.INTEGER, allowNull: true },
        currentTeamId: { type: Sequelize.INTEGER, allowNull: true },
        acceptedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        acceptedById: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
      });
      console.log("  created warehouse_boxes");
    }

    
    if (!(await has("warehouse_movements"))) {
      await queryInterface.createTable("warehouse_movements", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        boxId: { type: Sequelize.INTEGER, allowNull: false },
        documentId: { type: Sequelize.INTEGER, allowNull: true },
        fromSectionId: { type: Sequelize.INTEGER, allowNull: true },
        fromTeamId: { type: Sequelize.INTEGER, allowNull: true },
        toSectionId: { type: Sequelize.INTEGER, allowNull: true },
        toTeamId: { type: Sequelize.INTEGER, allowNull: true },
        operation: { type: Sequelize.STRING(255), allowNull: false },
        statusAfter: { type: Sequelize.STRING(50), allowNull: true },
        deltaQty: { type: Sequelize.INTEGER, allowNull: true, defaultValue: 0 },
        goodQty: { type: Sequelize.INTEGER, allowNull: true },
        scrapQty: { type: Sequelize.INTEGER, allowNull: true },
        performedById: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        performedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        comment: { type: Sequelize.TEXT, allowNull: true },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
      });
      console.log("  created warehouse_movements");
    }

    
    if (!(await has("warehouse_documents"))) {
      await queryInterface.createTable("warehouse_documents", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        boxId: { type: Sequelize.INTEGER, allowNull: true },
        number: { type: Sequelize.STRING(255), allowNull: false },
        type: { type: Sequelize.STRING(100), allowNull: true },
        date: { type: Sequelize.DATEONLY, allowNull: true },
        fileUrl: { type: Sequelize.STRING(1000), allowNull: true },
        comment: { type: Sequelize.TEXT, allowNull: true },
        createdById: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
      });
      console.log("  created warehouse_documents");
    }

    
    if (!(await has("inventory_limits"))) {
      await queryInterface.createTable("inventory_limits", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        originType: { type: Sequelize.STRING(255), allowNull: true },
        originId: { type: Sequelize.INTEGER, allowNull: true },
        label: { type: Sequelize.STRING(255), allowNull: true },
        minQuantity: { type: Sequelize.INTEGER, allowNull: false, defaultValue: 0 },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
      });
      console.log("  created inventory_limits");
    }

    
    if (!(await has("production_tasks"))) {
      await queryInterface.createTable("production_tasks", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        title: { type: Sequelize.STRING(255), allowNull: false },
        originType: { type: Sequelize.STRING(255), allowNull: true },
        originId: { type: Sequelize.INTEGER, allowNull: true },
        targetQty: { type: Sequelize.INTEGER, allowNull: false },
        unit: { type: Sequelize.STRING(50), allowNull: false, defaultValue: "шт" },
        dueDate: { type: Sequelize.DATEONLY, allowNull: true },
        status: { type: Sequelize.STRING(50), allowNull: false, defaultValue: "NEW" },
        priority: { type: Sequelize.INTEGER, allowNull: true },
        comment: { type: Sequelize.TEXT, allowNull: true },
        createdById: {
          type: Sequelize.INTEGER,
          allowNull: false,
          references: { model: "users", key: "id" },
        },
        responsibleId: { type: Sequelize.INTEGER, allowNull: true },
        sectionId: { type: Sequelize.INTEGER, allowNull: true },
        projectId: { type: Sequelize.INTEGER, allowNull: true },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
      });
      console.log("  created production_tasks");
    }

    
    if (!(await has("print_histories"))) {
      await queryInterface.createTable("print_histories", {
        id: { type: Sequelize.INTEGER, primaryKey: true, autoIncrement: true },
        template: { type: Sequelize.STRING(255), allowNull: false },
        labelName: { type: Sequelize.STRING(255), allowNull: true },
        startCode: { type: Sequelize.STRING(255), allowNull: true },
        endCode: { type: Sequelize.STRING(255), allowNull: true },
        quantity: { type: Sequelize.INTEGER, allowNull: true },
        params: { type: Sequelize.JSONB, allowNull: true },
        createdById: { type: Sequelize.INTEGER, allowNull: true },
        createdAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
        updatedAt: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.fn("NOW") },
      });
      console.log("  created print_histories");
    }

    console.log("✅ [create-warehouse-tables] All warehouse/production tables created");
  },

  async down(queryInterface) {
    const tables = [
      "print_histories",
      "production_tasks",
      "inventory_limits",
      "warehouse_documents",
      "warehouse_movements",
      "warehouse_boxes",
      "supplies",
      "production_outputs",
    ];
    for (const t of tables) {
      await queryInterface.dropTable(t, { cascade: true }).catch(() => {});
    }
  },
};

================================================================================
FILE: QMS-Server-master/models/ProductionOutput.js
================================================================================

const sequelize = require("../db");
const { DataTypes } = require("sequelize");

const OUTPUT_STATUSES = {
  DRAFT: "DRAFT",
  PENDING: "PENDING",
  APPROVED: "APPROVED",
  REJECTED: "REJECTED",
};

const ProductionOutput = sequelize.define("production_output", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  date: { type: DataTypes.DATEONLY, allowNull: false },
  approvedQty: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
  status: { type: DataTypes.STRING, allowNull: false, defaultValue: OUTPUT_STATUSES.DRAFT },
  userId: { type: DataTypes.INTEGER, allowNull: false },
  projectId: { type: DataTypes.INTEGER, allowNull: true },
  comment: { type: DataTypes.TEXT, allowNull: true },
});

module.exports = { ProductionOutput, OUTPUT_STATUSES };

================================================================================
FILE: QMS-Server-master/models/index.js
================================================================================

const path = require('path');
const fs = require('fs');
const { moduleManager } = require('../config/modules');

const modulesDir = path.join(__dirname, '..', 'modules');
const allModels = {};


const coreModule = require('../modules/core');
Object.assign(allModels, coreModule.getModels());


const MODULE_DIRS = {
  'qms.dms':       'qms-dms',
  'qms.nc':        'qms-nc',
  'qms.capa':      'qms-nc',       
  'qms.risk':      'qms-risk',
  'qms.supplier':  'qms-supplier',
  'qms.audit':     'qms-audit',
  'qms.training':  'qms-training',
  'qms.equipment': 'qms-equipment',
  'qms.review':    'qms-review',
  'wms.warehouse': 'wms',
};

const loadedDirs = new Set();

for (const [moduleCode, dirName] of Object.entries(MODULE_DIRS)) {
  if (loadedDirs.has(dirName)) continue;
  if (moduleManager.isEnabled(moduleCode)) {
    const indexPath = path.join(modulesDir, dirName, 'index.js');
    if (fs.existsSync(indexPath)) {
      const mod = require(indexPath);
      if (typeof mod.getModels === 'function') {
        Object.assign(allModels, mod.getModels());
      }
      loadedDirs.add(dirName);
    }
  }
}


coreModule.setupAssociations(allModels);

for (const dirName of loadedDirs) {
  const indexPath = path.join(modulesDir, dirName, 'index.js');
  const mod = require(indexPath);
  if (typeof mod.setupAssociations === 'function') {
    mod.setupAssociations(allModels);
  }
}

module.exports = allModels;

================================================================================
FILE: QMS-Server-master/modules/core/controllers/ProjectController.js
================================================================================

const { Project, User } = require("../../../models/index");
const ApiError = require("../../../error/ApiError");

class ProjectController {
  async create(req, res, next) {
    try {
      const { title, description } = req.body;
      if (!title) return next(ApiError.badRequest("Нужно название проекта"));

      const project = await Project.create({
        title,
        description,
        createdById: req.user.id
      });
      return res.json(project);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }

  async getAll(req, res, next) {
    try {
      const projects = await Project.findAll({
        order: [["createdAt", "DESC"]],
        include: [{ model: User, as: "author", attributes: ["name", "surname"] }]
      });
      return res.json(projects);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }

  async delete(req, res, next) {
    try {
        await Project.destroy({ where: { id: req.params.id } });
        return res.json({ message: "Deleted" });
    } catch(e) { next(ApiError.internal(e.message)); }
  }
}

module.exports = new ProjectController();

================================================================================
FILE: QMS-Server-master/modules/core/controllers/TaskController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../../error/ApiError");
const sequelize = require("../../../db");

const {
  ProductionTask,
  WarehouseBox,
  Section,
  Team,
  User,
  Project
} = require("../../../models/index");

class TaskController {

  async createTask(req, res, next) {
    try {
      const {
        title,
        originType,
        originId,
        targetQty,
        unit,
        dueDate,
        priority,
        comment,
        responsibleId,
        sectionId,
        projectId
      } = req.body;

      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("Нет пользователя в сессии"));
      }

      if (!title || !targetQty) {
        return next(ApiError.badRequest("Нужны title и targetQty"));
      }

      const task = await ProductionTask.create({
        title,
        originType: originType || null,
        originId: originId || null,
        targetQty,
        unit: unit || "шт",
        dueDate: dueDate || null,
        priority: priority || null,
        comment: comment || null,
        status: "NEW",
        createdById: req.user.id,
        responsibleId: responsibleId || null,
        sectionId: sectionId || null,
        projectId: projectId || null
      });

      return res.json(task);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getTasks(req, res, next) {
    try {
      let { page = 1, limit = 50, status, search, originType } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 50;
      const offset = (page - 1) * limit;

      const where = {};
      if (status) where.status = status;
      if (originType) where.originType = originType;
      if (search) {
        const s = String(search).trim();
        where[Op.or] = [
          { title: { [Op.iLike]: `%${s}%` } },
          { comment: { [Op.iLike]: `%${s}%` } },
        ];
      }

      const { rows, count } = await ProductionTask.findAndCountAll({
        where,
        limit,
        offset,
        order: [
          ["priority", "DESC"],
          ["dueDate", "ASC"],
          ["id", "ASC"],
        ],
        include: [
            {
                model: User,
                as: "responsible",
                attributes: ["id", "name", "surname"]
            },
            {
                model: Project,
                as: "project",
                attributes: ["id", "title"]
            },
            {
                model: User,
                as: "createdBy",
                attributes: ["id", "name", "surname"]
            }
        ]
      });


      for (const task of rows) {
        let stats = {
          total: 0,
          done: 0,
          inWork: 0,
          onStock: 0
        };


        if (task.originType && task.originId) {
          const boxes = await WarehouseBox.findAll({
            attributes: ['status', 'quantity'],
            where: {
              originType: task.originType,
              originId: task.originId,
              status: { [Op.notIn]: ["SCRAP"] },
            },
          });

          for (const box of boxes) {
            const qty = Number(box.quantity) || 0;
            stats.total += qty;

            const st = box.status;
            if (st === 'DONE' || st === 'SHIPPED') {
              stats.done += qty;
            } else if (st === 'ON_STOCK') {
              stats.onStock += qty;
            } else {

              stats.inWork += qty;
            }
          }
        }

        const progressPercent = task.targetQty > 0
            ? Math.min(100, Math.round((stats.done / task.targetQty) * 100))
            : 0;


        task.setDataValue("stats", stats);
        task.setDataValue("progressPercent", progressPercent);
        task.setDataValue("totalFound", stats.total);
      }

      return res.json({ rows, count, page, limit });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getTaskById(req, res, next) {
    try {
      const { id } = req.params;
      const task = await ProductionTask.findByPk(id, {
        include: [
            { model: User, as: "responsible", attributes: ["id", "name", "surname"] },
            { model: Project, as: "project", attributes: ["id", "title"] }
        ]
      });

      if (!task) {
        return next(ApiError.notFound("Задача не найдена"));
      }

      let boxes = [];
      let breakdown = [];
      let totalQty = 0;


      if (task.originType && task.originId) {
        boxes = await WarehouseBox.findAll({
          where: {
            originType: task.originType,
            originId: task.originId,
            status: { [Op.notIn]: ["SCRAP"] },
          },
          include: [
            {
              model: Section,
              as: "currentSection",
              attributes: ["id", "title"],
            },
            {
              model: Team,
              as: "currentTeam",
              attributes: ["id", "title"],
            },
          ],
          order: [["id", "ASC"]],
        });

        const map = {};

        for (const box of boxes) {
          const qty = box.quantity || 0;
          totalQty += qty;

          const key = `${box.status}|${box.currentSectionId || "null"}`;

          if (!map[key]) {
            map[key] = {
              status: box.status,
              sectionId: box.currentSectionId || null,
              sectionTitle: box.currentSection ? box.currentSection.title : null,
              qty: 0,
            };
          }
          map[key].qty += qty;
        }

        breakdown = Object.values(map);
      }

      return res.json({
        task,
        totalQty,
        breakdown,
        boxes,
      });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async updateFullTask(req, res, next) {
    try {
      const { id } = req.params;
      const {
        title, targetQty, unit, dueDate, priority, comment,
        responsibleId, sectionId, projectId, status
      } = req.body;

      const task = await ProductionTask.findByPk(id);
      if (!task) return next(ApiError.notFound("Задача не найдена"));

      await task.update({
        title: title !== undefined ? title : task.title,
        targetQty: targetQty !== undefined ? targetQty : task.targetQty,
        unit: unit !== undefined ? unit : task.unit,
        dueDate: dueDate !== undefined ? dueDate : task.dueDate,
        priority: priority !== undefined ? priority : task.priority,
        comment: comment !== undefined ? comment : task.comment,
        responsibleId: responsibleId !== undefined ? (responsibleId || null) : task.responsibleId,
        sectionId: sectionId !== undefined ? (sectionId || null) : task.sectionId,
        projectId: projectId !== undefined ? (projectId || null) : task.projectId,
        status: status !== undefined ? status : task.status
      });

      return res.json(task);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }


  async updateTaskStatus(req, res, next) {
    try {
      const { id } = req.params;
      const { status } = req.body;

      const task = await ProductionTask.findByPk(id);
      if (!task) return next(ApiError.notFound("Задача не найдена"));

      task.status = status;
      await task.save();

      return res.json(task);
    } catch (e) {
      next(ApiError.internal(e.message));
    }
  }


  async deleteTask(req, res, next) {
    try {
        const { id } = req.params;
        const deleted = await ProductionTask.destroy({ where: { id } });
        if (!deleted) return next(ApiError.notFound("Задача не найдена"));
        return res.json({ message: "Задача удалена" });
    } catch(e) {
        next(ApiError.internal(e.message));
    }
  }
}

module.exports = new TaskController();

================================================================================
FILE: QMS-Server-master/modules/core/controllers/auditController.js
================================================================================
















const { AuditLog, User } = require("../../../models/index");
const ApiError = require("../../../error/ApiError");
const { Op } = require("sequelize");
const { verifyChain, quickVerify, generateInspectionReport } = require("../utils/auditVerifier");

class AuditController {
  




  async getLogs(req, res, next) {
    try {
      let { page, limit, action, entity, userId, dateFrom, dateTo, severity, search } = req.query;

      page = Number(page) || 1;
      limit = Math.min(Number(limit) || 50, 200);
      const offset = page * limit - limit;

      const where = {};

      if (action) {
        where.action = { [Op.like]: `%${action}%` };
      }

      if (entity) {
        where.entity = entity;
      }

      if (userId) {
        const parsedUserId = Number(userId);
        if (!Number.isNaN(parsedUserId)) {
          where.userId = parsedUserId;
        }
      }

      
      if (severity) {
        where.severity = severity;
      }

      
      if (search) {
        where.description = { [Op.iLike]: `%${search}%` };
      }

      if (dateFrom || dateTo) {
        where.createdAt = {};
        if (dateFrom) where.createdAt[Op.gte] = new Date(dateFrom);
        if (dateTo) {
          const to = new Date(dateTo);
          to.setDate(to.getDate() + 1);
          where.createdAt[Op.lt] = to;
        }
      }

      const logs = await AuditLog.findAndCountAll({
        where,
        include: [
          {
            model: User,
            as: "User",
            attributes: ["id", "login", "name", "surname"],
            required: false,
          },
        ],
        order: [["createdAt", "DESC"]],
        limit,
        offset,
      });

      return res.json(logs);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  



  async getOne(req, res, next) {
    try {
      const { id } = req.params;
      const record = await AuditLog.findByPk(id, {
        include: [
          {
            model: User,
            as: "User",
            attributes: ["id", "login", "name", "surname"],
            required: false,
          },
        ],
      });

      if (!record) {
        return next(ApiError.notFound("Запись аудита не найдена"));
      }

      
      let chainContext = null;
      if (record.chainIndex) {
        const [prev, next_] = await Promise.all([
          AuditLog.findOne({
            where: { chainIndex: Number(record.chainIndex) - 1 },
            attributes: ["id", "chainIndex", "currentHash", "action", "createdAt"],
            raw: true,
          }),
          AuditLog.findOne({
            where: { chainIndex: Number(record.chainIndex) + 1 },
            attributes: ["id", "chainIndex", "prevHash", "action", "createdAt"],
            raw: true,
          }),
        ]);

        
        const prevLinkValid = prev
          ? prev.currentHash === record.prevHash
          : record.prevHash === "0".repeat(64);

        const nextLinkValid = next_
          ? next_.prevHash === record.currentHash
          : true; 

        chainContext = {
          previous: prev,
          next: next_,
          prevLinkValid,
          nextLinkValid,
          chainValid: prevLinkValid && nextLinkValid,
        };
      }

      return res.json({
        ...record.toJSON(),
        chainContext,
      });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  




  async quickVerify(req, res, next) {
    try {
      const count = Math.min(Number(req.query.count) || 100, 1000);
      const report = await quickVerify(count);
      return res.json(report);
    } catch (e) {
      next(ApiError.internal(`Ошибка верификации: ${e.message}`));
    }
  }

  




  async fullVerify(req, res, next) {
    try {
      const { fromIndex, toIndex } = req.query;
      const report = await verifyChain({
        fromIndex: fromIndex ? Number(fromIndex) : undefined,
        toIndex: toIndex ? Number(toIndex) : undefined,
      });
      return res.json(report);
    } catch (e) {
      next(ApiError.internal(`Ошибка полной верификации: ${e.message}`));
    }
  }

  




  async inspectionReport(req, res, next) {
    try {
      const report = await generateInspectionReport();
      return res.json(report);
    } catch (e) {
      next(ApiError.internal(`Ошибка генерации отчёта: ${e.message}`));
    }
  }

  



  async getStats(req, res, next) {
    try {
      const { days = 30 } = req.query;
      const since = new Date(Date.now() - Number(days) * 24 * 60 * 60 * 1000);

      const [bySeverity, byEntity, byAction, total, chainedTotal] = await Promise.all([
        
        AuditLog.findAll({
          attributes: ["severity", [require("sequelize").fn("COUNT", "*"), "count"]],
          where: { createdAt: { [Op.gte]: since } },
          group: ["severity"],
          raw: true,
        }),
        
        AuditLog.findAll({
          attributes: ["entity", [require("sequelize").fn("COUNT", "*"), "count"]],
          where: { createdAt: { [Op.gte]: since }, entity: { [Op.ne]: null } },
          group: ["entity"],
          order: [[require("sequelize").fn("COUNT", "*"), "DESC"]],
          limit: 10,
          raw: true,
        }),
        
        AuditLog.findAll({
          attributes: ["action", [require("sequelize").fn("COUNT", "*"), "count"]],
          where: { createdAt: { [Op.gte]: since } },
          group: ["action"],
          order: [[require("sequelize").fn("COUNT", "*"), "DESC"]],
          limit: 10,
          raw: true,
        }),
        
        AuditLog.count({ where: { createdAt: { [Op.gte]: since } } }),
        
        AuditLog.count({
          where: {
            createdAt: { [Op.gte]: since },
            chainIndex: { [Op.ne]: null },
          },
        }),
      ]);

      return res.json({
        period: { days: Number(days), since: since.toISOString() },
        total,
        chainedTotal,
        chainCoverage: total > 0 ? Math.round((chainedTotal / total) * 100) : 0,
        bySeverity,
        byEntity,
        byAction,
      });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new AuditController();

================================================================================
FILE: QMS-Server-master/modules/core/controllers/pcController.js
================================================================================

const { PC } = require("../../../models/index");
const ApiError = require("../../../error/ApiError");

class PCController {

  async getPCs(req, res, next) {
    try {

      const pcAll = await PC.findAll();


      if (!pcAll) {
        return res.json([]);
      }


      pcAll.sort((a, b) => {
        const nameA = (a.pc_name || "").toString();
        const nameB = (b.pc_name || "").toString();


        const numA = parseInt(nameA.replace(/\D/g, ""), 10);
        const numB = parseInt(nameB.replace(/\D/g, ""), 10);

        const hasNumA = !isNaN(numA);
        const hasNumB = !isNaN(numB);


        if (hasNumA && hasNumB) {
          if (numA !== numB) return numA - numB;
        }


        if (hasNumA && !hasNumB) return -1;
        if (!hasNumA && hasNumB) return 1;


        return nameA.localeCompare(nameB);
      });

      return res.json(pcAll);
    } catch (e) {
      console.error("🔥 Ошибка при получении списка ПК:", e);
      next(ApiError.internal("Ошибка сервера при загрузке ПК: " + e.message));
    }
  }

  async postPC(req, res, next) {
    try {
      const { ip, pc_name, cabinet } = req.body;
      const pc = await PC.create({ ip, pc_name, cabinet });
      return res.json(pc);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async updatePC(req, res, next) {
    try {
      const { id, ip, pc_name, cabinet } = req.body;
      await PC.update({ ip, pc_name, cabinet }, { where: { id } });
      const pc = await PC.findAll({ where: { id } });
      return res.json(pc[0]);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deletePC(req, res, next) {
    try {
      const id = req.params.id;
      await PC.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new PCController();

================================================================================
FILE: QMS-Server-master/modules/core/controllers/rbacController.js
================================================================================

const { Role, Ability, RoleAbility } = require("../../../models/index");
const ApiError = require("../../../error/ApiError");

class RbacController {

    async getRoles(req, res, next) {
        try {
            const roles = await Role.findAll({
                include: [{
                    model: Ability,
                    as: "abilities",
                    through: { attributes: [] }
                }],
                order: [['id', 'ASC']]
            });
            return res.json(roles);
        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }


    async getAbilities(req, res, next) {
        try {
            const abilities = await Ability.findAll({
                order: [['code', 'ASC']]
            });
            return res.json(abilities);
        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }


    async updateRoleAbilities(req, res, next) {
        try {
            const { roleId } = req.params;
            const { abilityIds } = req.body;

            const role = await Role.findByPk(roleId);
            if (!role) {
                return next(ApiError.badRequest("Роль не найдена"));
            }

            await role.setAbilities(abilityIds);

            return res.json({ message: "Права роли обновлены" });
        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }

    async getKeycloakStatus(req, res, next) {
        try {
            const authMode = process.env.AUTH_MODE || 'keycloak';
            if (authMode !== 'keycloak') {
                return res.json({ connected: false, mode: authMode, message: 'Dev-bypass режим' });
            }
            const url = `${process.env.KEYCLOAK_URL}/realms/${process.env.KEYCLOAK_REALM}/.well-known/openid-configuration`;
            const response = await fetch(url, { signal: AbortSignal.timeout(3000) });
            return res.json({
                connected: response.ok, mode: authMode,
                realm: process.env.KEYCLOAK_REALM,
                url: process.env.KEYCLOAK_URL
            });
        } catch (e) {
            return res.json({ connected: false, mode: 'keycloak', error: e.message });
        }
    }
}

module.exports = new RbacController();

================================================================================
FILE: QMS-Server-master/modules/core/controllers/sessionController.js
================================================================================

const { Session, PC } = require("../../../models/index");
const ApiError = require("../../../error/ApiError");
const { logAudit } = require("../utils/auditLogger");

class SessionController {
  async getSessions(req, res, next) {
    try {
      const sessionAll = await Session.findAll();
      return res.json(sessionAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async postSession(req, res, next) {
    try {
      const { online, userId, PCId } = req.body;

      const newSession = await Session.create({
        online,
        userId,
        PCId: PCId || null,
      });

      await logAudit({
        req,
        userId,
        action: "SESSION_CREATE",
        entity: "SESSION",
        entityId: newSession.id,
        description: `Создана сессия вручную (userId=${userId}, PCId=${PCId || 'PERSONAL'}, online=${online})`,
        metadata: { userId, PCId, online },
      });

      return res.json(newSession);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async setOnlineSession(req, res, next) {
    try {

      const { online, PCId, userId: bodyUserId } = req.body;

      const currentUserId = (req.user && req.user.id) || bodyUserId;

      if (typeof online === "undefined" || !currentUserId) {
        return next(
          ApiError.badRequest(
            "Не переданы обязательные поля: online, userId"
          )
        );
      }


      if (online === true) {
        await Session.update(
            { online: false },
            {
                where: {
                    userId: currentUserId,
                    online: true
                }
            }
        );
      }


      let session;

      if (PCId) {

          session = await Session.findOne({
            where: { userId: currentUserId, PCId },
          });
      } else {

          session = await Session.findOne({
            where: { userId: currentUserId, PCId: null },
          });
      }

      if (session) {
        await session.update({ online });
      } else {
        session = await Session.create({
          online,
          userId: currentUserId,
          PCId: PCId || null,
        });
      }


      let pcName = "Личный ноутбук";
      let pcIp = "Dynamic";

      if (PCId) {
        try {
          const pc = await PC.findByPk(PCId);
          if (pc) {
            pcName = pc.pc_name;
            pcIp = pc.ip;
          }
        } catch (err) {
          console.error("Ошибка при чтении ПК для аудита:", err);
        }
      }

      const action = online ? "LOGIN" : "LOGOUT";
      const humanPc = pcName;
      const descr = online
        ? `Вход в систему. Устройство: ${humanPc}${pcIp !== "Dynamic" ? ` (${pcIp})` : ""}`
        : `Выход из системы. Устройство: ${humanPc}`;

      await logAudit({
        req,
        userId: currentUserId,
        action,
        entity: "SESSION",
        entityId: session.id,
        description: descr,
        metadata: {
          PCId: PCId || "PERSONAL",
          pcName,
          pcIp,
          online,
          userId: currentUserId,
        },
      });

      return res.json(session);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async deleteSession(req, res, next) {
    try {
      const id = req.params.id;
      const session = await Session.findByPk(id);

      await Session.destroy({ where: { id } });

      await logAudit({
        req,
        userId: session ? session.userId : undefined,
        action: "SESSION_DELETE",
        entity: "SESSION",
        entityId: id,
        description: "Сессия удалена администратором",
        metadata: session
          ? { userId: session.userId, PCId: session.PCId }
          : { sessionId: id },
      });

      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async setOfflineSession(req, res, next) {
    try {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();


      if (
        (hours === 23 && minutes >= 59) ||
        hours === 0 ||
        (hours === 1 && minutes <= 1)
      ) {
        const [updated] = await Session.update(
          { online: false },
          { where: { online: true } }
        );

        await logAudit({
          req,
          action: "SESSION_AUTO_OFF",
          entity: "SESSION",
          description: `Ночной сброс сессий. Переведено в offline: ${updated}`,
          metadata: { updatedCount: updated },
        });

        return res.json("Все активные сессии сброшены");
      } else {
        return res.json("Сейчас не время для сброса");
      }
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async offlineSessionManual(req, res, next) {
    try {
      const [updated] = await Session.update(
        { online: false },
        { where: { online: true } }
      );

      await logAudit({
        req,
        action: "SESSION_FORCE_OFF",
        entity: "SESSION",
        description: `Ручной сброс всех активных сессий. Переведено в offline: ${updated}`,
        metadata: { updatedCount: updated },
      });

      return res.json("Все активные сессии сброшены");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new SessionController();

================================================================================
FILE: QMS-Server-master/modules/core/controllers/structureController.js
================================================================================

const { Section, Team, User, Role } = require("../../../models/index");
const ApiError = require("../../../error/ApiError");
const { logAudit } = require("../utils/auditLogger");
const { Op } = require("sequelize");

class StructureController {

  async getFullStructure(req, res, next) {
    try {
      const structure = await Section.findAll({
        include: [
          {
            model: User,
            as: "manager",
            attributes: ["id", "name", "surname", "img"],
          },
          {
            model: Team,
            as: "teams",
            include: [
              {
                model: User,
                as: "teamLead",
                attributes: ["id", "name", "surname", "img"],
              },
              {
                model: User,
                attributes: ["id", "name", "surname", "img"],
              },

              {
                model: Section,
                as: "section",
                attributes: ["id", "title"],
              },
            ],
          },
        ],
        order: [["id", "ASC"]],
      });
      return res.json(structure);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async getUnassignedUsers(req, res, next) {
    try {
      const superAdminRole = await Role.findOne({ where: { name: "SUPER_ADMIN" } });
      const whereClause = { teamId: { [Op.is]: null } };
      if (superAdminRole) {
        whereClause.roleId = { [Op.ne]: superAdminRole.id };
      }
      const users = await User.findAll({
        where: whereClause,
        attributes: ["id", "name", "surname", "login", "img"],
        include: [{ model: Role, as: "userRole", attributes: ["name"] }],
        order: [["surname", "ASC"]]
      });
      return res.json(users);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async createSection(req, res, next) {
    try {
      const { title } = req.body;
      const section = await Section.create({ title });

      await logAudit({
        req,
        action: "SECTION_CREATE",
        entity: "Section",
        entityId: section.id,
        description: `Создан участок "${title}"`,
      });

      return res.json(section);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async createTeam(req, res, next) {
    try {
      const { title, sectionId } = req.body;

      const team = await Team.create({ title, sectionId });

      await logAudit({
        req,
        action: "TEAM_CREATE",
        entity: "Team",
        entityId: team.id,
        description: `Создана бригада "${title}" в участке ${sectionId}`,
      });

      return res.json(team);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async assignSectionManager(req, res, next) {
    try {
      const { sectionId, userId } = req.body;

      const section = await Section.findByPk(sectionId);
      if (!section) {
        return next(ApiError.notFound("Участок не найден"));
      }

      await section.update({ managerId: userId });

      await logAudit({
        req,
        action: "SECTION_MANAGER_ASSIGN",
        entity: "Section",
        entityId: sectionId,
        description: `Назначен менеджер ${userId} на участок ${sectionId}`,
      });

      return res.json(section);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async assignTeamLead(req, res, next) {
    try {
      const { teamId, userId } = req.body;

      const team = await Team.findByPk(teamId);
      if (!team) {
        return next(ApiError.notFound("Бригада не найдена"));
      }

      await team.update({ teamLeadId: userId });

      await logAudit({
        req,
        action: "TEAM_LEAD_ASSIGN",
        entity: "Team",
        entityId: teamId,
        description: `Назначен бригадир ${userId} на бригаду ${teamId}`,
      });

      return res.json(team);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async addMemberToTeam(req, res, next) {
    try {
      const { teamId, userId } = req.body;

      const user = await User.findByPk(userId);
      if (!user) {
        return next(ApiError.notFound("Пользователь не найден"));
      }

      await user.update({ teamId });

      await logAudit({
        req,
        action: "USER_TEAM_ASSIGN",
        entity: "User",
        entityId: userId,
        description: `Пользователь ${userId} добавлен в бригаду ${teamId}`,
      });

      return res.json(user);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async removeMemberFromTeam(req, res, next) {
    try {
      const { userId } = req.body;

      const user = await User.findByPk(userId);
      if (!user) {
        return next(ApiError.notFound("Пользователь не найден"));
      }

      const previousTeamId = user.teamId;
      await user.update({ teamId: null });

      await logAudit({
        req,
        action: "USER_TEAM_REMOVE",
        entity: "User",
        entityId: userId,
        description: `Пользователь ${userId} удалён из бригады ${previousTeamId}`,
      });

      return res.json(user);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new StructureController();

================================================================================
FILE: QMS-Server-master/modules/core/controllers/userController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const { User, Session, Role } = require("../../../models/index");
const jwt = require("jsonwebtoken");
const uuid = require("uuid");
const path = require("path");

const generateJWT = (id, login, role, name, surname, img) => {
  return jwt.sign(
    { id, login, role, name, surname, img },
    process.env.SECRET_KEY,
    {
      expiresIn: "5h",
    }
  );
};


const checkAccess = (req, targetUserId) => {

  const isSelf = req.user.id === Number(targetUserId);


  const hasManageRights = req.user.abilities && req.user.abilities.includes('users.manage');


  const isSuperAdmin = req.user.role === 'SUPER_ADMIN';


  if (!isSelf && !hasManageRights && !isSuperAdmin) {
      throw ApiError.forbidden("Нет доступа к чужому профилю");
  }
};

class UserController {

  async getUsers(req, res, next) {
    try {
      const usersAll = await User.findAll({
        order: [["name", "ASC"]],
      });
      return res.json(usersAll);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async getCurrentUser(req, res, next) {
    try {
      const id = req.params.id;


      checkAccess(req, id);

      const user = await User.findOne({
        where: { id },
      });
      return res.json(user);
    } catch (e) {

      if (e instanceof ApiError) return next(e);
      next(ApiError.badRequest(e.message));
    }
  }


  async updateUser(req, res, next) {
    try {
      const { id, password, name, surname } = req.body;


      checkAccess(req, id);


      const updateData = { name, surname };


      if (password && password.trim() !== "") {
        updateData.password = password;
      }

      await User.update(updateData, { where: { id } });
      const user = await User.findAll({ where: { id } });
      return res.json(user[0]);
    } catch (e) {
      if (e instanceof ApiError) return next(e);
      next(ApiError.badRequest(e.message));
    }
  }


  async updateUserImg(req, res, next) {
    try {
      const { id } = req.body;


      checkAccess(req, id);

      const { img } = req.files;
      let fileName = uuid.v4() + ".jpg";
      img.mv(path.resolve(__dirname, "..", "static", fileName));

      await User.update({ img: fileName }, { where: { id } });

      const user = await User.findAll({ where: { id } });
      return res.json(user[0]);
    } catch (e) {
      if (e instanceof ApiError) return next(e);
      next(ApiError.badRequest(e.message));
    }
  }

  async registration(req, res, next) {
    try {
      const { login, password, role, name, surname } = req.body;

      if (!login || !password) {
        return next(ApiError.badRequest("нет логина или пароля в запросе"));
      }
      const candidate = await User.findOne({ where: { login } });
      if (candidate) {
        return next(
          ApiError.badRequest("Такой пользователь с таким логином уже есть")
        );
      }

      let roleId = null;
      const roleName = role || 'USER';
      if (roleName) {
        const roleEntity = await Role.findOne({ where: { name: roleName } });
        if (roleEntity) roleId = roleEntity.id;
      }

      const user = await User.create({ login, password, roleId, name, surname });
      const token = generateJWT(
        user.id,
        user.login,
        roleName,
        user.name,
        user.surname,
        null
      );
      return res.json({ token });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async login(req, res, next) {
    try {
      const { login, password } = req.body;

      if (!login || !password) {
        return next(ApiError.badRequest("нет логина или пароля в запросе"));
      }
      const currentUser = await User.findOne({
        where: { login },
        include: [{ model: Role, as: "userRole", attributes: ["name"] }]
      });
      if (!currentUser) {
        return next(ApiError.internal("Такого пользователя нет"));
      }

      if (currentUser.password != password) {
        return next(ApiError.internal("неверный пароль"));
      }

      const isAciveSession = await Session.findAll({
        where: { userId: currentUser.id, online: true },
      });

      if (isAciveSession.length >= 1) {
        await Session.update(
          { online: false },
          { where: { userId: currentUser.id, online: true } }
        );
      }

      const roleName = currentUser.userRole ? currentUser.userRole.name : 'USER';
      const token = generateJWT(
        currentUser.id,
        currentUser.login,
        roleName,
        currentUser.name,
        currentUser.surname,
        currentUser.img
      );
      return res.json({ token });
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }


  async check(req, res, next) {
    const token = generateJWT(
      req.user.id,
      req.user.login,
      req.user.role,
      req.user.name,
      req.user.surname,
      req.user.img
    );
    res.json({ token });
  }


  async deleteUser(req, res, next) {
    try {
      const id = req.params.id;
      const deleteUser = await User.destroy({
        where: { id },
      });
      return res.json("ok");
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new UserController();

================================================================================
FILE: QMS-Server-master/modules/core/index.js
================================================================================

module.exports = {
  code: 'core',

  register(router) {
    router.use('/users',     require('./routes/userRouter'));
    router.use('/sessions',  require('./routes/sessionRouter'));
    router.use('/pcs',       require('./routes/pcRouter'));
    router.use('/rbac',      require('./routes/rbacRouter'));
    router.use('/structure', require('./routes/structureRouter'));
    router.use('/audit',     require('./routes/auditRouter'));
    router.use('/tasks',     require('./routes/taskRouter'));
    router.use('/projects',  require('./routes/projectRouter'));
  },

  getModels() {
    const general = require('./models/General');
    const structure = require('./models/Structure');
    const project = require('./models/Project');
    return { ...general, ...structure, ...project };
  },

  setupAssociations(m) {
    
    m.User.hasMany(m.Session);
    m.Session.belongsTo(m.User);
    m.Session.belongsTo(m.PC, { foreignKey: 'PCId', as: 'pc' });
    m.PC.hasMany(m.Session, { foreignKey: 'PCId', as: 'sessions' });

    
    m.AuditLog.belongsTo(m.User, { foreignKey: 'userId', as: 'User' });
    m.User.hasMany(m.AuditLog, { foreignKey: 'userId', as: 'auditLogs' });

    
    m.User.belongsTo(m.Team, { foreignKey: 'teamId' });
    m.Team.hasMany(m.User, { foreignKey: 'teamId' });
    m.Team.belongsTo(m.Section, { foreignKey: 'sectionId', as: 'section' });
    m.Section.hasMany(m.Team, { foreignKey: 'sectionId', as: 'teams' });
    m.Team.belongsTo(m.User, { foreignKey: 'teamLeadId', as: 'teamLead' });
    m.Section.belongsTo(m.User, { foreignKey: 'managerId', as: 'manager' });
    m.User.hasMany(m.Section, { foreignKey: 'managerId', as: 'managedSections' });

    
    m.Role.belongsToMany(m.Ability, { through: m.RoleAbility, foreignKey: 'roleId', as: 'abilities' });
    m.Ability.belongsToMany(m.Role, { through: m.RoleAbility, foreignKey: 'abilityId', as: 'roles' });
    m.User.belongsTo(m.Role, { foreignKey: 'roleId', as: 'userRole' });

    
    m.Project.belongsTo(m.User, { foreignKey: 'createdById', as: 'author' });
    m.User.hasMany(m.Project, { foreignKey: 'createdById', as: 'projects' });
  },
};

================================================================================
FILE: QMS-Server-master/modules/core/middleware/authMiddleware.js
================================================================================

const { auth } = require('express-oauth2-jwt-bearer');
const AUTH_MODE = process.env.AUTH_MODE || 'keycloak';

if (AUTH_MODE === 'dev-bypass') {
  
  module.exports = (req, res, next) => {
    req.auth = {
      payload: {
        sub: 'dev-user-001',
        preferred_username: process.env.DEV_USER || 'developer',
        given_name: 'Dev',
        family_name: 'User',
        realm_access: { roles: [process.env.DEV_ROLE || 'SUPER_ADMIN'] }
      }
    };
    next();
  };
} else {
  const KEYCLOAK_URL = process.env.KEYCLOAK_URL || 'http://localhost:8080';
  const KEYCLOAK_REALM = process.env.KEYCLOAK_REALM || 'QMS-Realm';

  const checkJwt = auth({
    audience: 'account',
    issuerBaseURL: `${KEYCLOAK_URL}/realms/${KEYCLOAK_REALM}`,
    tokenSigningAlg: 'RS256'
  });
  module.exports = checkJwt;
}

================================================================================
FILE: QMS-Server-master/modules/core/middleware/checkAbilityMiddleware.js
================================================================================

const ApiError = require("../../../error/ApiError");

module.exports = function (requiredSlug) {
    return function (req, res, next) {
        if (req.method === "OPTIONS") return next();

        try {
            const user = req.user;
            if (!user) return next(ApiError.unauthorized("Нет пользователя"));


            if (user.role === 'SUPER_ADMIN') {
                return next();
            }


            if (user.abilities && user.abilities.includes(requiredSlug)) {
                return next();
            }

            return next(ApiError.forbidden(`Нет доступа. Требуется право: ${requiredSlug}`));

        } catch (e) {
            return next(ApiError.internal("Ошибка проверки прав"));
        }
    };
};

================================================================================
FILE: QMS-Server-master/modules/core/middleware/checkRoleMiddleware.js
================================================================================

module.exports = function (role) {
  return function (req, res, next) {
    if (req.method === "OPTIONS") {
      return next();
    }

    try {
      if (!req.user) {
        return res.status(401).json({ message: "Пользователь не идентифицирован (Backend Error)" });
      }

      if (req.user.role !== role) {
        return res.status(403).json({
            message: `Нет доступа. Требуется роль ${role}, у вас ${req.user.role}`
        });
      }

      next();
    } catch (e) {
      console.error("CheckRole Error:", e);
      return res.status(500).json({ message: "Ошибка проверки роли" });
    }
  };
};

================================================================================
FILE: QMS-Server-master/modules/core/middleware/syncUserMiddleware.js
================================================================================




const { User, Role, Ability } = require("../../../models/index");

module.exports = async function (req, res, next) {

    if (req.method === "OPTIONS") return next();

    try {

        if (!req.auth || !req.auth.payload) {
            console.error("ОШИБКА: authMiddleware не передал payload. Токен невалиден или не проверен.");
            return res.status(401).json({ message: "Invalid token payload" });
        }

        const payload = req.auth.payload;

        const keycloakUUID = payload.sub;

        const login = payload.preferred_username || payload.nickname || payload.email;

        if (!login) {
            console.error("ОШИБКА: В токене нет поля login (preferred_username/nickname/email).");
            return res.status(500).json({ message: "Token structure error: missing username" });
        }

        const name = payload.given_name || login;
        const surname = payload.family_name || '';

        const kcRoles = payload.realm_access?.roles || [];

        
        const allDbRoles = await Role.findAll({ attributes: ['name'], order: [['id', 'ASC']] });
        const dbRoleNames = allDbRoles.map(r => r.name);

        
        const matchedRole = kcRoles.find(r => dbRoleNames.includes(r));
        const DEFAULT_ROLE = process.env.DEFAULT_ROLE || 'VIEWER';
        const mainRole = matchedRole || DEFAULT_ROLE;

        
        if (!dbRoleNames.includes(mainRole) && mainRole !== DEFAULT_ROLE) {
            await Role.findOrCreate({
                where: { name: mainRole },
                defaults: { code: mainRole, description: 'Автоимпорт из Keycloak' }
            });
        }

        
        const roleEntity = await Role.findOne({
            where: { name: mainRole },
            include: [{
                model: Ability,
                as: "abilities",
                through: { attributes: [] }
            }]
        });

        let user = await User.findOne({ where: { login } });

        if (!user) {
            console.log(`Пользователь ${login} не найден. Создаем с ролью ${mainRole}...`);
            try {
                user = await User.create({
                    login,
                    name,
                    surname,
                    roleId: roleEntity ? roleEntity.id : null,
                    password: 'sso_managed_account',
                    img: null
                });
                console.log(`Пользователь создан. ID: ${user.id}`);
            } catch (dbError) {
                console.error("ОШИБКА БАЗЫ ДАННЫХ при создании:", dbError);
                return res.status(500).json({ message: "DB Error during user creation" });
            }
        } else {

            if (user.roleId !== (roleEntity ? roleEntity.id : null)) {
                console.log(`Обновление роли пользователя ${login}: roleId ${user.roleId} -> ${roleEntity ? roleEntity.id : null} (${mainRole})`);
                user.roleId = roleEntity ? roleEntity.id : null;
                await user.save();
            }
        }

        let abilities = [];
        if (roleEntity && roleEntity.abilities) {
            abilities = roleEntity.abilities.map(ab => ab.code);
        }

        req.user = {
            id: user.id,
            login: user.login,
            name: user.name,
            surname: user.surname,
            role: mainRole,
            roles: kcRoles,
            abilities: abilities,
            keycloakId: keycloakUUID
        };

        next();

    } catch (e) {
        console.error("КРИТИЧЕСКАЯ ОШИБКА в syncUserMiddleware:", e);
        return res.status(500).json({ message: "Sync Middleware Crash", error: e.message });
    }
};

================================================================================
FILE: QMS-Server-master/modules/core/models/General.js
================================================================================











const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");



const User = sequelize.define("user", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  login: { type: DataTypes.STRING, unique: true },
  password: { type: DataTypes.STRING },
  name: { type: DataTypes.STRING },
  surname: { type: DataTypes.STRING },
  img: { type: DataTypes.STRING },
});

const PC = sequelize.define("PC", {
  id: { type: DataTypes.SMALLINT, primaryKey: true, autoIncrement: true },
  ip: { type: DataTypes.STRING, unique: true, allowNull: false },
  pc_name: { type: DataTypes.STRING, allowNull: false },
  cabinet: { type: DataTypes.STRING },
}, { tableName: "pcs" });

const Session = sequelize.define("session", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  online: { type: DataTypes.BOOLEAN },
  PCId: {
    type: DataTypes.SMALLINT,
    allowNull: true,
    references: {
      model: "pcs",
      key: "id",
    },
  },
});



const AuditLog = sequelize.define("audit_log", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  userId: { type: DataTypes.INTEGER, allowNull: true },
  action: { type: DataTypes.STRING, allowNull: false },
  entity: { type: DataTypes.STRING, allowNull: true },
  entityId: { type: DataTypes.STRING, allowNull: true },
  description: { type: DataTypes.TEXT, allowNull: true },
  metadata: { type: DataTypes.JSON, allowNull: true },

  
  chainIndex: {
    type: DataTypes.BIGINT,
    allowNull: true,
    
    comment: "Порядковый номер в hash-цепочке (глобальный)",
  },
  prevHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
    comment: "SHA-256 хеш предыдущей записи в цепочке",
  },
  currentHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
    comment: "SHA-256 хеш текущей записи (включая prevHash)",
  },
  dataHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
    comment: "SHA-256 только данных (без chain-полей) — для детекции изменений",
  },

  
  signedBy: {
    type: DataTypes.INTEGER,
    allowNull: true,
    comment: "userId подтвердившего запись",
  },
  signedAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },

  
  severity: {
    type: DataTypes.ENUM("INFO", "WARNING", "CRITICAL", "SECURITY"),
    allowNull: false,
    defaultValue: "INFO",
    comment: "Уровень значимости для QMS отчётов",
  },
});



const Role = sequelize.define("role", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  code: { type: DataTypes.STRING, unique: true, allowNull: false },
  name: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const Ability = sequelize.define("ability", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  code: { type: DataTypes.STRING, unique: true, allowNull: false },
  description: { type: DataTypes.STRING },
});

const RoleAbility = sequelize.define("role_ability", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
});

module.exports = {
  User,
  PC,
  Session,
  AuditLog,
  Role,
  Ability,
  RoleAbility,
};

================================================================================
FILE: QMS-Server-master/modules/core/models/Project.js
================================================================================

const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");

const Project = sequelize.define("project", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false, unique: true },
  description: { type: DataTypes.TEXT, allowNull: true },
  status: { type: DataTypes.STRING, defaultValue: "ACTIVE" },
  createdById: { type: DataTypes.INTEGER, allowNull: false },
});

module.exports = { Project };
================================================================================
FILE: QMS-Server-master/modules/core/models/Structure.js
================================================================================

const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");

const Section = sequelize.define("production_section", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false, unique: true },
  description: { type: DataTypes.STRING },
  managerId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: 'users',
      key: 'id'
    }
  },
}, { freezeTableName: true });

const Team = sequelize.define("production_team", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false },
  sectionId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    field: "productionSectionId",
  },
  teamLeadId: {
    type: DataTypes.INTEGER,
    allowNull: true,
    references: {
      model: 'users',
      key: 'id'
    }
  },
}, { freezeTableName: true });

module.exports = {
  Section,
  Team,
};

================================================================================
FILE: QMS-Server-master/modules/core/routes/auditRouter.js
================================================================================




















const Router = require("express");
const router = new Router();
const auditController = require("../controllers/auditController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");


const protect = [authMiddleware, syncUserMiddleware, checkAbility("rbac.manage")];


const protectQmsAudit = [authMiddleware, syncUserMiddleware, checkAbility("qms.audit.verify")];
const protectQmsReport = [authMiddleware, syncUserMiddleware, checkAbility("qms.audit.report")];


router.get("/", ...protect, auditController.getLogs);


router.get("/stats", ...protect, auditController.getStats);
router.get("/verify", ...protectQmsAudit, auditController.quickVerify);
router.get("/verify/full", ...protectQmsAudit, auditController.fullVerify);
router.get("/report", ...protectQmsReport, auditController.inspectionReport);
router.get("/:id", ...protect, auditController.getOne);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/core/routes/pcRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const PCController = require("../controllers/pcController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/", ...protect, PCController.getPCs);


router.post("/", ...protect, checkAbility("users.manage"), PCController.postPC);
router.put("/", ...protect, checkAbility("users.manage"), PCController.updatePC);
router.delete("/:id", ...protect, checkAbility("users.manage"), PCController.deletePC);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/core/routes/projectRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const controller = require("../controllers/ProjectController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post(
    "/",
    ...protect,
    checkAbility("recipe.manage"),
    controller.create
);


router.get(
    "/",
    ...protect,
    controller.getAll
);


router.delete(
    "/:id",
    ...protect,
    checkAbility("recipe.manage"),
    controller.delete
);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/core/routes/rbacRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const rbacController = require("../controllers/rbacController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");


const protect = [
    authMiddleware,
    syncUserMiddleware,
    checkAbility("rbac.manage")
];

router.get("/roles", ...protect, rbacController.getRoles);
router.get("/abilities", ...protect, rbacController.getAbilities);
router.post("/role/:roleId", ...protect, rbacController.updateRoleAbilities);
router.get("/keycloak/status", authMiddleware, syncUserMiddleware, rbacController.getKeycloakStatus);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/core/routes/sessionRouter.js
================================================================================

const Router = require("express");
const router = new Router();

const SessionController = require("../controllers/sessionController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.post("/", ...protect, SessionController.postSession);
router.put("/", ...protect, SessionController.setOnlineSession);


router.get("/", ...protect, SessionController.getSessions);


router.get(
    "/offlineAll",
    ...protect,
    checkAbility("users.manage"),
    SessionController.setOfflineSession
);

router.get("/offAll", ...protect, checkAbility("users.manage"), SessionController.offlineSessionManual);
router.delete("/:id", ...protect, checkAbility("users.manage"), SessionController.deleteSession);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/core/routes/structureRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const structureController = require("../controllers/structureController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/", ...protect, structureController.getFullStructure);
router.get("/users/unassigned", ...protect, checkAbility("users.manage"), structureController.getUnassignedUsers);


router.post("/section", ...protect, checkAbility("users.manage"), structureController.createSection);
router.post("/team", ...protect, checkAbility("users.manage"), structureController.createTeam);


router.put("/section/manager", ...protect, checkAbility("users.manage"), structureController.assignSectionManager);
router.put("/team/lead", ...protect, checkAbility("users.manage"), structureController.assignTeamLead);
router.put("/user/assign", ...protect, checkAbility("users.manage"), structureController.addMemberToTeam);
router.put("/user/remove", ...protect, checkAbility("users.manage"), structureController.removeMemberFromTeam);

module.exports = router;
================================================================================
FILE: QMS-Server-master/modules/core/routes/taskRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const TaskController = require("../controllers/TaskController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/", ...protect, TaskController.getTasks);
router.get("/:id", ...protect, TaskController.getTaskById);

router.post("/", ...protect, checkAbility("users.manage"), TaskController.createTask);
router.delete("/:id", ...protect, checkAbility("users.manage"), TaskController.deleteTask);
router.put("/:id", ...protect, checkAbility("users.manage"), TaskController.updateFullTask);

router.patch("/:id/status", ...protect, checkAbility("assembly.execute"), TaskController.updateTaskStatus);

module.exports = router;
================================================================================
FILE: QMS-Server-master/modules/core/routes/userRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const userController = require("../controllers/userController");
const authMiddleware = require("../middleware/authMiddleware");
const syncUserMiddleware = require("../middleware/syncUserMiddleware");
const checkAbility = require("../middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];

router.get("/auth", ...protect, (req, res) => {
    return res.json(req.user);
});

router.get("/check", ...protect, (req, res) => {
    return res.json(req.user);
});

router.get("/", ...protect, userController.getUsers);

router.get("/:id", ...protect, userController.getCurrentUser);
router.put("/", ...protect, userController.updateUser); 
router.patch("/", ...protect, userController.updateUserImg);

router.delete("/:id", ...protect, checkAbility("users.manage"), userController.deleteUser);

module.exports = router;
================================================================================
FILE: QMS-Server-master/modules/core/utils/auditLogger.js
================================================================================






















const crypto = require("crypto");
const { AuditLog } = require("../../../models/index");
const sequelize = require("../../../db");





const AUDIT_ACTIONS = {
  
  SESSION_START: "SESSION_START",
  SESSION_END: "SESSION_END",
  SESSION_DELETE: "SESSION_DELETE",
  SESSION_AUTO_OFF: "SESSION_AUTO_OFF",
  SESSION_FORCE_OFF: "SESSION_FORCE_OFF",

  
  WAREHOUSE_MOVE: "WAREHOUSE_MOVE",
  WAREHOUSE_MOVE_BATCH: "WAREHOUSE_MOVE_BATCH",
  BOX_CREATE: "BOX_CREATE",
  BOX_UPDATE: "BOX_UPDATE",
  BOX_DELETE: "BOX_DELETE",
  BOX_SPLIT: "BOX_SPLIT",
  BOX_MERGE: "BOX_MERGE",
  SUPPLY_CREATE: "SUPPLY_CREATE",
  SUPPLY_UPDATE: "SUPPLY_UPDATE",
  SUPPLY_RECEIVE: "SUPPLY_RECEIVE",

  
  COMPONENT_CREATE: "COMPONENT_CREATE",
  COMPONENT_UPDATE: "COMPONENT_UPDATE",
  COMPONENT_DELETE: "COMPONENT_DELETE",
  COMPONENT_SYNC: "COMPONENT_SYNC",
  COMPONENT_REPLACE: "COMPONENT_REPLACE",
  COMPONENT_TRANSFER: "COMPONENT_TRANSFER",
  COMPONENT_BATCH_ADD: "COMPONENT_BATCH_ADD",

  
  PRODUCTION_ENTRY_CREATE: "PRODUCTION_ENTRY_CREATE",
  PRODUCTION_ENTRY_UPDATE: "PRODUCTION_ENTRY_UPDATE",
  PRODUCTION_ENTRY_APPROVE: "PRODUCTION_ENTRY_APPROVE",
  PRODUCTION_ENTRY_REJECT: "PRODUCTION_ENTRY_REJECT",
  PRODUCTION_ENTRY_DELETE: "PRODUCTION_ENTRY_DELETE",
  PRODUCT_ASSEMBLE: "PRODUCT_ASSEMBLE",
  PRODUCT_QC_PASS: "PRODUCT_QC_PASS",
  PRODUCT_QC_FAIL: "PRODUCT_QC_FAIL",

  
  SECTION_CREATE: "SECTION_CREATE",
  SECTION_UPDATE: "SECTION_UPDATE",
  SECTION_DELETE: "SECTION_DELETE",
  TEAM_CREATE: "TEAM_CREATE",
  TEAM_UPDATE: "TEAM_UPDATE",
  TEAM_DELETE: "TEAM_DELETE",

  
  ROLE_CREATE: "ROLE_CREATE",
  ROLE_UPDATE: "ROLE_UPDATE",
  ROLE_DELETE: "ROLE_DELETE",
  ABILITY_CREATE: "ABILITY_CREATE",
  ABILITY_DELETE: "ABILITY_DELETE",
  ROLE_ABILITY_GRANT: "ROLE_ABILITY_GRANT",
  ROLE_ABILITY_REVOKE: "ROLE_ABILITY_REVOKE",

  
  USER_CREATE: "USER_CREATE",
  USER_UPDATE: "USER_UPDATE",
  USER_DELETE: "USER_DELETE",
  USER_ROLE_CHANGE: "USER_ROLE_CHANGE",

  
  EXPORT_PASSPORT: "EXPORT_PASSPORT",
  EXPORT_DEFECTS: "EXPORT_DEFECTS",
  EXPORT_REPORT: "EXPORT_REPORT",

  
  SETTINGS_UPDATE: "SETTINGS_UPDATE",
  SYSTEM_EVENT: "SYSTEM_EVENT",

  

  
  DOCUMENT_CREATE: "DOCUMENT_CREATE",
  DOCUMENT_UPDATE: "DOCUMENT_UPDATE",
  DOCUMENT_DELETE: "DOCUMENT_DELETE",
  DOCUMENT_VERSION_CREATE: "DOCUMENT_VERSION_CREATE",
  DOCUMENT_SUBMIT_REVIEW: "DOCUMENT_SUBMIT_REVIEW",
  DOCUMENT_APPROVE: "DOCUMENT_APPROVE",
  DOCUMENT_REJECT: "DOCUMENT_REJECT",
  DOCUMENT_MAKE_EFFECTIVE: "DOCUMENT_MAKE_EFFECTIVE",
  DOCUMENT_OBSOLETE: "DOCUMENT_OBSOLETE",
  DOCUMENT_DISTRIBUTE: "DOCUMENT_DISTRIBUTE",
  DOCUMENT_ACKNOWLEDGE: "DOCUMENT_ACKNOWLEDGE",

  
  NC_CREATE: "NC_CREATE",
  NC_UPDATE: "NC_UPDATE",
  NC_INVESTIGATE: "NC_INVESTIGATE",
  NC_DISPOSITION: "NC_DISPOSITION",
  NC_CLOSE: "NC_CLOSE",
  NC_REOPEN: "NC_REOPEN",

  
  CAPA_CREATE: "CAPA_CREATE",
  CAPA_UPDATE: "CAPA_UPDATE",
  CAPA_PLAN_APPROVE: "CAPA_PLAN_APPROVE",
  CAPA_IMPLEMENT: "CAPA_IMPLEMENT",
  CAPA_VERIFY: "CAPA_VERIFY",
  CAPA_CLOSE: "CAPA_CLOSE",
  CAPA_EFFECTIVENESS_CHECK: "CAPA_EFFECTIVENESS_CHECK",

  
  AUDIT_PLAN_CREATE: "AUDIT_PLAN_CREATE",
  AUDIT_CONDUCT: "AUDIT_CONDUCT",
  AUDIT_FINDING_CREATE: "AUDIT_FINDING_CREATE",
  AUDIT_REPORT_APPROVE: "AUDIT_REPORT_APPROVE",

  
  RISK_CREATE: "RISK_CREATE",
  RISK_UPDATE: "RISK_UPDATE",
  RISK_ASSESS: "RISK_ASSESS",
  RISK_MITIGATE: "RISK_MITIGATE",

  
  SUPPLIER_CREATE: "SUPPLIER_CREATE",
  SUPPLIER_EVALUATE: "SUPPLIER_EVALUATE",
  SUPPLIER_APPROVE: "SUPPLIER_APPROVE",
  SUPPLIER_SUSPEND: "SUPPLIER_SUSPEND",

  
  TRAINING_COMPLETE: "TRAINING_COMPLETE",
  COMPETENCY_ASSIGN: "COMPETENCY_ASSIGN",

  
  EQUIPMENT_CALIBRATE: "EQUIPMENT_CALIBRATE",
  EQUIPMENT_OVERDUE: "EQUIPMENT_OVERDUE",

  
  MANAGEMENT_REVIEW_CREATE: "MANAGEMENT_REVIEW_CREATE",
  MANAGEMENT_REVIEW_CLOSE: "MANAGEMENT_REVIEW_CLOSE",
};





const AUDIT_ENTITIES = {
  
  SESSION: "SESSION",
  WAREHOUSE_MOVEMENT: "WarehouseMovement",
  INVENTORY_BOX: "InventoryBox",
  SUPPLY: "Supply",
  WAREHOUSE_DOCUMENT: "WarehouseDocument",
  COMPONENT_INVENTORY: "ComponentInventory",
  COMPONENT_HISTORY: "ComponentHistory",
  COMPONENT_CATALOG: "ComponentCatalog",
  PRODUCTION_ENTRY: "ProductionEntry",
  PRODUCTION_OUTPUT: "ProductionOutput",
  ASSEMBLED_PRODUCT: "AssembledProduct",
  SECTION: "Section",
  TEAM: "Team",
  ROLE: "Role",
  ABILITY: "Ability",
  ROLE_ABILITY: "RoleAbility",
  USER: "User",

  
  DOCUMENT: "Document",
  DOCUMENT_VERSION: "DocumentVersion",
  DOCUMENT_APPROVAL: "DocumentApproval",
  NONCONFORMITY: "Nonconformity",
  CAPA: "Capa",
  CAPA_ACTION: "CapaAction",
  RISK: "Risk",
  RISK_ASSESSMENT: "RiskAssessment",
  SUPPLIER: "Supplier",
  SUPPLIER_EVALUATION: "SupplierEvaluation",
  INTERNAL_AUDIT: "InternalAudit",
  AUDIT_FINDING: "AuditFinding",
  TRAINING_RECORD: "TrainingRecord",
  EQUIPMENT: "Equipment",
  CALIBRATION: "CalibrationRecord",
  MANAGEMENT_REVIEW: "ManagementReview",
};





const SEVERITY_MAP = {
  
  DOCUMENT_APPROVE: "CRITICAL",
  DOCUMENT_MAKE_EFFECTIVE: "CRITICAL",
  NC_CREATE: "CRITICAL",
  NC_DISPOSITION: "CRITICAL",
  CAPA_CLOSE: "CRITICAL",
  PRODUCT_QC_PASS: "CRITICAL",
  PRODUCT_QC_FAIL: "CRITICAL",
  SUPPLIER_APPROVE: "CRITICAL",
  SUPPLIER_SUSPEND: "CRITICAL",
  EQUIPMENT_OVERDUE: "CRITICAL",
  MANAGEMENT_REVIEW_CLOSE: "CRITICAL",

  
  DOCUMENT_REJECT: "WARNING",
  NC_REOPEN: "WARNING",
  PRODUCTION_ENTRY_REJECT: "WARNING",
  RISK_ASSESS: "WARNING",

  
  USER_ROLE_CHANGE: "SECURITY",
  ROLE_ABILITY_GRANT: "SECURITY",
  ROLE_ABILITY_REVOKE: "SECURITY",
  SESSION_FORCE_OFF: "SECURITY",
  ROLE_CREATE: "SECURITY",
  ROLE_DELETE: "SECURITY",
};

function getSeverity(action) {
  return SEVERITY_MAP[action] || "INFO";
}





const GENESIS_HASH = "0".repeat(64);





function computeDataHash({ userId, action, entity, entityId, description, metadata, createdAt }) {
  const payload = JSON.stringify({
    userId: userId ?? null,
    action: action || "",
    entity: entity || "",
    entityId: entityId === undefined || entityId === null ? "" : String(entityId),
    description: description || "",
    metadata: metadata || {},
    createdAt: createdAt || new Date().toISOString(),
  });

  return crypto.createHash("sha256").update(payload, "utf8").digest("hex");
}





function computeChainHash(chainIndex, prevHash, dataHash) {
  const payload = `${chainIndex}:${prevHash}:${dataHash}`;
  return crypto.createHash("sha256").update(payload, "utf8").digest("hex");
}





async function getLastChainEntry(transaction) {
  const [results] = await sequelize.query(
    `SELECT "chainIndex", "currentHash" 
     FROM audit_logs 
     WHERE "chainIndex" IS NOT NULL 
     ORDER BY "chainIndex" DESC 
     LIMIT 1
     FOR UPDATE`,
    { transaction, type: sequelize.QueryTypes.SELECT }
  );

  if (results) {
    return {
      chainIndex: Number(results.chainIndex),
      currentHash: results.currentHash,
    };
  }

  return { chainIndex: 0, currentHash: GENESIS_HASH };
}
























async function logAudit({
  req,
  userId,
  action,
  entity,
  entityId,
  description,
  metadata,
  severity,
}) {
  if (!action) {
    console.warn("[HashChainLogger] Попытка логирования без указания action");
    return null;
  }

  
  const transaction = await sequelize.transaction({
    isolationLevel: "SERIALIZABLE", 
  });

  try {
    
    let finalUserId = null;
    if (req && req.user && req.user.id) {
      finalUserId = req.user.id;
    } else if (userId) {
      finalUserId = userId;
    }

    
    let meta = metadata || {};
    if (req) {
      const ipHeader = req.headers["x-forwarded-for"];
      const ip =
        (typeof ipHeader === "string" ? ipHeader.split(",")[0] : null) ||
        req.connection?.remoteAddress ||
        req.ip ||
        null;

      meta = {
        ...meta,
        ip,
        userAgent: req.headers["user-agent"] || null,
      };
    }

    
    const normalizedEntityId =
      entityId === undefined || entityId === null ? null : String(entityId);

    
    const now = new Date();
    const dataHash = computeDataHash({
      userId: finalUserId,
      action,
      entity: entity || null,
      entityId: normalizedEntityId,
      description: description || null,
      metadata: Object.keys(meta).length > 0 ? meta : null,
      createdAt: now.toISOString(),
    });

    
    const lastEntry = await getLastChainEntry(transaction);
    const newChainIndex = lastEntry.chainIndex + 1;
    const prevHash = lastEntry.currentHash;

    
    const currentHash = computeChainHash(newChainIndex, prevHash, dataHash);

    
    const finalSeverity = severity || getSeverity(action);

    
    const record = await AuditLog.create(
      {
        userId: finalUserId,
        action,
        entity: entity || null,
        entityId: normalizedEntityId,
        description: description || null,
        metadata: Object.keys(meta).length > 0 ? meta : null,
        chainIndex: newChainIndex,
        prevHash,
        currentHash,
        dataHash,
        severity: finalSeverity,
        createdAt: now,
      },
      { transaction }
    );

    await transaction.commit();
    return record;
  } catch (error) {
    await transaction.rollback();
    console.error("[HashChainLogger] Ошибка записи в журнал аудита:", error);

    
    try {
      return await AuditLog.create({
        userId:
          (req && req.user && req.user.id) || userId || null,
        action,
        entity: entity || null,
        entityId:
          entityId === undefined || entityId === null
            ? null
            : String(entityId),
        description: `[CHAIN_ERROR] ${description || ""}`,
        metadata: { ...(metadata || {}), chainError: error.message },
        severity: severity || getSeverity(action),
      });
    } catch (fallbackError) {
      console.error("[HashChainLogger] CRITICAL: Даже fallback-запись не удалась:", fallbackError);
      return null;
    }
  }
}







async function logWarehouseMove(req, movement, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.WAREHOUSE_MOVE,
    entity: AUDIT_ENTITIES.WAREHOUSE_MOVEMENT,
    entityId: movement.id,
    description: `Перемещение: ${movement.operation}, кол-во: ${movement.deltaQty || 0}`,
    metadata: {
      boxId: movement.boxId,
      operation: movement.operation,
      fromSectionId: movement.fromSectionId,
      toSectionId: movement.toSectionId,
      deltaQty: movement.deltaQty,
      ...metadata,
    },
  });
}



async function logProductionEntry(req, entry, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.PRODUCTION_ENTRY_CREATE,
    approve: AUDIT_ACTIONS.PRODUCTION_ENTRY_APPROVE,
    reject: AUDIT_ACTIONS.PRODUCTION_ENTRY_REJECT,
    update: AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    delete: AUDIT_ACTIONS.PRODUCTION_ENTRY_DELETE,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    entity: AUDIT_ENTITIES.PRODUCTION_ENTRY,
    entityId: entry.id,
    description: `Производственная запись #${entry.id}: ${action}`,
    metadata: {
      entryId: entry.id,
      quantity: entry.quantity,
      productId: entry.productId,
      ...metadata,
    },
  });
}



async function logComponentSync(req, serverId, result, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.COMPONENT_SYNC,
    entity: AUDIT_ENTITIES.COMPONENT_INVENTORY,
    entityId: serverId,
    description: `Синхронизация компонентов #${serverId}`,
    metadata: {
      serverId,
      mode: result.mode,
      added: result.actions?.added?.length || 0,
      updated: result.actions?.updated?.length || 0,
      preserved: result.actions?.preserved?.length || 0,
      ...metadata,
    },
  });
}



async function logExport(req, exportType, description, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.EXPORT_REPORT,
    entity: null,
    entityId: null,
    description: description || `Экспорт: ${exportType}`,
    metadata: { exportType, ...metadata },
  });
}







async function logDocumentCreate(req, doc, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.DOCUMENT_CREATE,
    entity: AUDIT_ENTITIES.DOCUMENT,
    entityId: doc.id,
    description: `Создан документ: ${doc.code} "${doc.title}"`,
    metadata: { code: doc.code, type: doc.type, ...metadata },
  });
}

async function logDocumentApproval(req, doc, version, decision, metadata = {}) {
  const action =
    decision === "APPROVED"
      ? AUDIT_ACTIONS.DOCUMENT_APPROVE
      : AUDIT_ACTIONS.DOCUMENT_REJECT;

  return logAudit({
    req,
    action,
    entity: AUDIT_ENTITIES.DOCUMENT_APPROVAL,
    entityId: doc.id,
    description: `Документ ${doc.code} v${version.version}: ${decision}`,
    metadata: {
      documentId: doc.id,
      versionId: version.id,
      versionNumber: version.version,
      decision,
      ...metadata,
    },
  });
}

async function logDocumentEffective(req, doc, version, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.DOCUMENT_MAKE_EFFECTIVE,
    entity: AUDIT_ENTITIES.DOCUMENT,
    entityId: doc.id,
    description: `Документ ${doc.code} v${version.version} введён в действие`,
    metadata: {
      documentId: doc.id,
      versionId: version.id,
      ...metadata,
    },
  });
}



async function logNonconformity(req, nc, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.NC_CREATE,
    update: AUDIT_ACTIONS.NC_UPDATE,
    investigate: AUDIT_ACTIONS.NC_INVESTIGATE,
    disposition: AUDIT_ACTIONS.NC_DISPOSITION,
    close: AUDIT_ACTIONS.NC_CLOSE,
    reopen: AUDIT_ACTIONS.NC_REOPEN,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.NC_UPDATE,
    entity: AUDIT_ENTITIES.NONCONFORMITY,
    entityId: nc.id,
    description: `NC-${String(nc.id).padStart(4, "0")}: ${action}`,
    metadata: {
      ncNumber: nc.number,
      source: nc.source,
      classification: nc.classification,
      ...metadata,
    },
  });
}



async function logCapa(req, capa, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.CAPA_CREATE,
    update: AUDIT_ACTIONS.CAPA_UPDATE,
    planApprove: AUDIT_ACTIONS.CAPA_PLAN_APPROVE,
    implement: AUDIT_ACTIONS.CAPA_IMPLEMENT,
    verify: AUDIT_ACTIONS.CAPA_VERIFY,
    close: AUDIT_ACTIONS.CAPA_CLOSE,
    effectivenessCheck: AUDIT_ACTIONS.CAPA_EFFECTIVENESS_CHECK,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.CAPA_UPDATE,
    entity: AUDIT_ENTITIES.CAPA,
    entityId: capa.id,
    description: `CAPA-${String(capa.id).padStart(4, "0")}: ${action}`,
    metadata: {
      capaNumber: capa.number,
      type: capa.type,
      ...metadata,
    },
  });
}





module.exports = {
  
  logAudit,
  AUDIT_ACTIONS,
  AUDIT_ENTITIES,
  GENESIS_HASH,

  
  computeDataHash,
  computeChainHash,

  
  logWarehouseMove,
  logComponentSync,
  logProductionEntry,
  logExport,

  
  logDocumentCreate,
  logDocumentApproval,
  logDocumentEffective,
  logNonconformity,
  logCapa,

  
  getSeverity,
};

================================================================================
FILE: QMS-Server-master/modules/core/utils/auditVerifier.js
================================================================================



















const { AuditLog } = require("../../../models/index");
const { computeDataHash, computeChainHash, GENESIS_HASH } = require("./hashChainLogger");
const { Op } = require("sequelize");







































async function verifyChain({ fromIndex, toIndex, batchSize = 1000 } = {}) {
  const startTime = Date.now();
  const errors = [];
  let totalRecords = 0;
  let validRecords = 0;
  let unchainedRecords = 0;
  let firstChainIndex = null;
  let lastChainIndex = null;

  
  unchainedRecords = await AuditLog.count({
    where: { chainIndex: null },
  });

  
  const where = { chainIndex: { [Op.ne]: null } };
  if (fromIndex !== undefined) {
    where.chainIndex[Op.gte] = fromIndex;
  }
  if (toIndex !== undefined) {
    where.chainIndex[Op.lte] = toIndex;
  }

  
  let offset = 0;
  let prevHash = null; 
  let prevChainIndex = null;

  
  if (fromIndex && fromIndex > 1) {
    const prevRecord = await AuditLog.findOne({
      where: { chainIndex: fromIndex - 1 },
      attributes: ["currentHash", "chainIndex"],
    });

    if (prevRecord) {
      prevHash = prevRecord.currentHash;
      prevChainIndex = Number(prevRecord.chainIndex);
    } else {
      
      prevHash = null;
      prevChainIndex = fromIndex - 2; 
    }
  }

  while (true) {
    const records = await AuditLog.findAll({
      where,
      order: [["chainIndex", "ASC"]],
      limit: batchSize,
      offset,
      raw: true,
    });

    if (records.length === 0) break;

    for (const record of records) {
      totalRecords++;
      const ci = Number(record.chainIndex);

      if (firstChainIndex === null) firstChainIndex = ci;
      lastChainIndex = ci;

      const recordErrors = [];

      
      if (prevChainIndex !== null && ci !== prevChainIndex + 1) {
        recordErrors.push(
          `Пропуск в цепочке: ожидался chainIndex=${prevChainIndex + 1}, получен ${ci}`
        );
      }

      
      const expectedDataHash = computeDataHash({
        userId: record.userId,
        action: record.action,
        entity: record.entity,
        entityId: record.entityId,
        description: record.description,
        metadata: record.metadata,
        createdAt: record.createdAt,
      });

      if (record.dataHash !== expectedDataHash) {
        recordErrors.push(
          `dataHash не совпадает: stored=${record.dataHash?.substring(0, 12)}..., computed=${expectedDataHash.substring(0, 12)}...`
        );
      }

      
      if (prevHash !== null && record.prevHash !== prevHash) {
        recordErrors.push(
          `prevHash разрыв: stored=${record.prevHash?.substring(0, 12)}..., expected=${prevHash.substring(0, 12)}...`
        );
      } else if (prevHash === null && ci === 1 && record.prevHash !== GENESIS_HASH) {
        recordErrors.push(
          `Genesis запись должна иметь prevHash=${"0".repeat(12)}...`
        );
      }

      
      const expectedCurrentHash = computeChainHash(
        ci,
        record.prevHash,
        record.dataHash
      );

      if (record.currentHash !== expectedCurrentHash) {
        recordErrors.push(
          `currentHash не совпадает: stored=${record.currentHash?.substring(0, 12)}..., computed=${expectedCurrentHash.substring(0, 12)}...`
        );
      }

      
      if (recordErrors.length > 0) {
        errors.push({
          chainIndex: ci,
          recordId: record.id,
          valid: false,
          errors: recordErrors,
        });
      } else {
        validRecords++;
      }

      
      prevHash = record.currentHash;
      prevChainIndex = ci;
    }

    offset += batchSize;
  }

  const durationMs = Date.now() - startTime;

  return {
    valid: errors.length === 0,
    totalRecords,
    validRecords,
    invalidRecords: errors.length,
    unchainedRecords,
    firstChainIndex,
    lastChainIndex,
    errors: errors.slice(0, 100), 
    verifiedAt: new Date().toISOString(),
    durationMs,
  };
}








async function quickVerify(count = 100) {
  const lastRecord = await AuditLog.findOne({
    where: { chainIndex: { [Op.ne]: null } },
    order: [["chainIndex", "DESC"]],
    attributes: ["chainIndex"],
    raw: true,
  });

  if (!lastRecord) {
    return {
      valid: true,
      totalRecords: 0,
      validRecords: 0,
      invalidRecords: 0,
      unchainedRecords: 0,
      firstChainIndex: null,
      lastChainIndex: null,
      errors: [],
      verifiedAt: new Date().toISOString(),
      durationMs: 0,
    };
  }

  const fromIndex = Math.max(1, Number(lastRecord.chainIndex) - count + 1);
  return verifyChain({ fromIndex });
}






async function generateInspectionReport() {
  const fullReport = await verifyChain();

  
  const severityStats = await AuditLog.findAll({
    attributes: [
      "severity",
      [require("sequelize").fn("COUNT", "*"), "count"],
    ],
    where: { chainIndex: { [Op.ne]: null } },
    group: ["severity"],
    raw: true,
  });

  
  const monthlyStats = await AuditLog.findAll({
    attributes: [
      [require("sequelize").fn("DATE_TRUNC", "month", require("sequelize").col("createdAt")), "month"],
      [require("sequelize").fn("COUNT", "*"), "count"],
    ],
    where: {
      chainIndex: { [Op.ne]: null },
      createdAt: { [Op.gte]: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000) },
    },
    group: [require("sequelize").fn("DATE_TRUNC", "month", require("sequelize").col("createdAt"))],
    order: [[require("sequelize").fn("DATE_TRUNC", "month", require("sequelize").col("createdAt")), "ASC"]],
    raw: true,
  });

  return {
    system: "ASVO-QMS",
    standard: "ГОСТ ISO 13485-2017 §4.2.5",
    generatedAt: new Date().toISOString(),
    chainIntegrity: fullReport,
    severityDistribution: severityStats,
    monthlyActivity: monthlyStats,
    conclusion: fullReport.valid
      ? "Целостность аудит-трейла подтверждена. Разрывов в hash-цепочке не обнаружено."
      : `ВНИМАНИЕ: Обнаружено ${fullReport.invalidRecords} нарушений целостности. Требуется расследование.`,
  };
}

module.exports = {
  verifyChain,
  quickVerify,
  generateInspectionReport,
};

================================================================================
FILE: QMS-Server-master/modules/core/utils/hashChainLogger.js
================================================================================






















const crypto = require("crypto");
const { AuditLog } = require("../../../models/index");
const sequelize = require("../../../db");





const AUDIT_ACTIONS = {
  
  SESSION_START: "SESSION_START",
  SESSION_END: "SESSION_END",
  SESSION_DELETE: "SESSION_DELETE",
  SESSION_AUTO_OFF: "SESSION_AUTO_OFF",
  SESSION_FORCE_OFF: "SESSION_FORCE_OFF",

  
  WAREHOUSE_MOVE: "WAREHOUSE_MOVE",
  WAREHOUSE_MOVE_BATCH: "WAREHOUSE_MOVE_BATCH",
  BOX_CREATE: "BOX_CREATE",
  BOX_UPDATE: "BOX_UPDATE",
  BOX_DELETE: "BOX_DELETE",
  BOX_SPLIT: "BOX_SPLIT",
  BOX_MERGE: "BOX_MERGE",
  SUPPLY_CREATE: "SUPPLY_CREATE",
  SUPPLY_UPDATE: "SUPPLY_UPDATE",
  SUPPLY_RECEIVE: "SUPPLY_RECEIVE",

  
  COMPONENT_CREATE: "COMPONENT_CREATE",
  COMPONENT_UPDATE: "COMPONENT_UPDATE",
  COMPONENT_DELETE: "COMPONENT_DELETE",
  COMPONENT_SYNC: "COMPONENT_SYNC",
  COMPONENT_REPLACE: "COMPONENT_REPLACE",
  COMPONENT_TRANSFER: "COMPONENT_TRANSFER",
  COMPONENT_BATCH_ADD: "COMPONENT_BATCH_ADD",

  
  PRODUCTION_ENTRY_CREATE: "PRODUCTION_ENTRY_CREATE",
  PRODUCTION_ENTRY_UPDATE: "PRODUCTION_ENTRY_UPDATE",
  PRODUCTION_ENTRY_APPROVE: "PRODUCTION_ENTRY_APPROVE",
  PRODUCTION_ENTRY_REJECT: "PRODUCTION_ENTRY_REJECT",
  PRODUCTION_ENTRY_DELETE: "PRODUCTION_ENTRY_DELETE",
  PRODUCT_ASSEMBLE: "PRODUCT_ASSEMBLE",
  PRODUCT_QC_PASS: "PRODUCT_QC_PASS",
  PRODUCT_QC_FAIL: "PRODUCT_QC_FAIL",

  
  SECTION_CREATE: "SECTION_CREATE",
  SECTION_UPDATE: "SECTION_UPDATE",
  SECTION_DELETE: "SECTION_DELETE",
  TEAM_CREATE: "TEAM_CREATE",
  TEAM_UPDATE: "TEAM_UPDATE",
  TEAM_DELETE: "TEAM_DELETE",

  
  ROLE_CREATE: "ROLE_CREATE",
  ROLE_UPDATE: "ROLE_UPDATE",
  ROLE_DELETE: "ROLE_DELETE",
  ABILITY_CREATE: "ABILITY_CREATE",
  ABILITY_DELETE: "ABILITY_DELETE",
  ROLE_ABILITY_GRANT: "ROLE_ABILITY_GRANT",
  ROLE_ABILITY_REVOKE: "ROLE_ABILITY_REVOKE",

  
  USER_CREATE: "USER_CREATE",
  USER_UPDATE: "USER_UPDATE",
  USER_DELETE: "USER_DELETE",
  USER_ROLE_CHANGE: "USER_ROLE_CHANGE",

  
  EXPORT_PASSPORT: "EXPORT_PASSPORT",
  EXPORT_DEFECTS: "EXPORT_DEFECTS",
  EXPORT_REPORT: "EXPORT_REPORT",

  
  SETTINGS_UPDATE: "SETTINGS_UPDATE",
  SYSTEM_EVENT: "SYSTEM_EVENT",

  

  
  DOCUMENT_CREATE: "DOCUMENT_CREATE",
  DOCUMENT_UPDATE: "DOCUMENT_UPDATE",
  DOCUMENT_DELETE: "DOCUMENT_DELETE",
  DOCUMENT_VERSION_CREATE: "DOCUMENT_VERSION_CREATE",
  DOCUMENT_SUBMIT_REVIEW: "DOCUMENT_SUBMIT_REVIEW",
  DOCUMENT_APPROVE: "DOCUMENT_APPROVE",
  DOCUMENT_REJECT: "DOCUMENT_REJECT",
  DOCUMENT_MAKE_EFFECTIVE: "DOCUMENT_MAKE_EFFECTIVE",
  DOCUMENT_OBSOLETE: "DOCUMENT_OBSOLETE",
  DOCUMENT_DISTRIBUTE: "DOCUMENT_DISTRIBUTE",
  DOCUMENT_ACKNOWLEDGE: "DOCUMENT_ACKNOWLEDGE",

  
  NC_CREATE: "NC_CREATE",
  NC_UPDATE: "NC_UPDATE",
  NC_INVESTIGATE: "NC_INVESTIGATE",
  NC_DISPOSITION: "NC_DISPOSITION",
  NC_CLOSE: "NC_CLOSE",
  NC_REOPEN: "NC_REOPEN",

  
  CAPA_CREATE: "CAPA_CREATE",
  CAPA_UPDATE: "CAPA_UPDATE",
  CAPA_PLAN_APPROVE: "CAPA_PLAN_APPROVE",
  CAPA_IMPLEMENT: "CAPA_IMPLEMENT",
  CAPA_VERIFY: "CAPA_VERIFY",
  CAPA_CLOSE: "CAPA_CLOSE",
  CAPA_EFFECTIVENESS_CHECK: "CAPA_EFFECTIVENESS_CHECK",

  
  AUDIT_PLAN_CREATE: "AUDIT_PLAN_CREATE",
  AUDIT_CONDUCT: "AUDIT_CONDUCT",
  AUDIT_FINDING_CREATE: "AUDIT_FINDING_CREATE",
  AUDIT_REPORT_APPROVE: "AUDIT_REPORT_APPROVE",

  
  RISK_CREATE: "RISK_CREATE",
  RISK_UPDATE: "RISK_UPDATE",
  RISK_ASSESS: "RISK_ASSESS",
  RISK_MITIGATE: "RISK_MITIGATE",

  
  SUPPLIER_CREATE: "SUPPLIER_CREATE",
  SUPPLIER_EVALUATE: "SUPPLIER_EVALUATE",
  SUPPLIER_APPROVE: "SUPPLIER_APPROVE",
  SUPPLIER_SUSPEND: "SUPPLIER_SUSPEND",

  
  TRAINING_COMPLETE: "TRAINING_COMPLETE",
  COMPETENCY_ASSIGN: "COMPETENCY_ASSIGN",

  
  EQUIPMENT_CALIBRATE: "EQUIPMENT_CALIBRATE",
  EQUIPMENT_OVERDUE: "EQUIPMENT_OVERDUE",

  
  MANAGEMENT_REVIEW_CREATE: "MANAGEMENT_REVIEW_CREATE",
  MANAGEMENT_REVIEW_CLOSE: "MANAGEMENT_REVIEW_CLOSE",
};





const AUDIT_ENTITIES = {
  
  SESSION: "SESSION",
  WAREHOUSE_MOVEMENT: "WarehouseMovement",
  INVENTORY_BOX: "InventoryBox",
  SUPPLY: "Supply",
  WAREHOUSE_DOCUMENT: "WarehouseDocument",
  COMPONENT_INVENTORY: "ComponentInventory",
  COMPONENT_HISTORY: "ComponentHistory",
  COMPONENT_CATALOG: "ComponentCatalog",
  PRODUCTION_ENTRY: "ProductionEntry",
  PRODUCTION_OUTPUT: "ProductionOutput",
  ASSEMBLED_PRODUCT: "AssembledProduct",
  SECTION: "Section",
  TEAM: "Team",
  ROLE: "Role",
  ABILITY: "Ability",
  ROLE_ABILITY: "RoleAbility",
  USER: "User",

  
  DOCUMENT: "Document",
  DOCUMENT_VERSION: "DocumentVersion",
  DOCUMENT_APPROVAL: "DocumentApproval",
  NONCONFORMITY: "Nonconformity",
  CAPA: "Capa",
  CAPA_ACTION: "CapaAction",
  RISK: "Risk",
  RISK_ASSESSMENT: "RiskAssessment",
  SUPPLIER: "Supplier",
  SUPPLIER_EVALUATION: "SupplierEvaluation",
  INTERNAL_AUDIT: "InternalAudit",
  AUDIT_FINDING: "AuditFinding",
  TRAINING_RECORD: "TrainingRecord",
  EQUIPMENT: "Equipment",
  CALIBRATION: "CalibrationRecord",
  MANAGEMENT_REVIEW: "ManagementReview",
};





const SEVERITY_MAP = {
  
  DOCUMENT_APPROVE: "CRITICAL",
  DOCUMENT_MAKE_EFFECTIVE: "CRITICAL",
  NC_CREATE: "CRITICAL",
  NC_DISPOSITION: "CRITICAL",
  CAPA_CLOSE: "CRITICAL",
  PRODUCT_QC_PASS: "CRITICAL",
  PRODUCT_QC_FAIL: "CRITICAL",
  SUPPLIER_APPROVE: "CRITICAL",
  SUPPLIER_SUSPEND: "CRITICAL",
  EQUIPMENT_OVERDUE: "CRITICAL",
  MANAGEMENT_REVIEW_CLOSE: "CRITICAL",

  
  DOCUMENT_REJECT: "WARNING",
  NC_REOPEN: "WARNING",
  PRODUCTION_ENTRY_REJECT: "WARNING",
  RISK_ASSESS: "WARNING",

  
  USER_ROLE_CHANGE: "SECURITY",
  ROLE_ABILITY_GRANT: "SECURITY",
  ROLE_ABILITY_REVOKE: "SECURITY",
  SESSION_FORCE_OFF: "SECURITY",
  ROLE_CREATE: "SECURITY",
  ROLE_DELETE: "SECURITY",
};

function getSeverity(action) {
  return SEVERITY_MAP[action] || "INFO";
}





const GENESIS_HASH = "0".repeat(64);





function computeDataHash({ userId, action, entity, entityId, description, metadata, createdAt }) {
  const payload = JSON.stringify({
    userId: userId ?? null,
    action: action || "",
    entity: entity || "",
    entityId: entityId === undefined || entityId === null ? "" : String(entityId),
    description: description || "",
    metadata: metadata || {},
    createdAt: createdAt || new Date().toISOString(),
  });

  return crypto.createHash("sha256").update(payload, "utf8").digest("hex");
}





function computeChainHash(chainIndex, prevHash, dataHash) {
  const payload = `${chainIndex}:${prevHash}:${dataHash}`;
  return crypto.createHash("sha256").update(payload, "utf8").digest("hex");
}





async function getLastChainEntry(transaction) {
  const [results] = await sequelize.query(
    `SELECT "chainIndex", "currentHash" 
     FROM audit_logs 
     WHERE "chainIndex" IS NOT NULL 
     ORDER BY "chainIndex" DESC 
     LIMIT 1
     FOR UPDATE`,
    { transaction, type: sequelize.QueryTypes.SELECT }
  );

  if (results) {
    return {
      chainIndex: Number(results.chainIndex),
      currentHash: results.currentHash,
    };
  }

  return { chainIndex: 0, currentHash: GENESIS_HASH };
}
























async function logAudit({
  req,
  userId,
  action,
  entity,
  entityId,
  description,
  metadata,
  severity,
}) {
  if (!action) {
    console.warn("[HashChainLogger] Попытка логирования без указания action");
    return null;
  }

  
  const transaction = await sequelize.transaction({
    isolationLevel: "SERIALIZABLE", 
  });

  try {
    
    let finalUserId = null;
    if (req && req.user && req.user.id) {
      finalUserId = req.user.id;
    } else if (userId) {
      finalUserId = userId;
    }

    
    let meta = metadata || {};
    if (req) {
      const ipHeader = req.headers["x-forwarded-for"];
      const ip =
        (typeof ipHeader === "string" ? ipHeader.split(",")[0] : null) ||
        req.connection?.remoteAddress ||
        req.ip ||
        null;

      meta = {
        ...meta,
        ip,
        userAgent: req.headers["user-agent"] || null,
      };
    }

    
    const normalizedEntityId =
      entityId === undefined || entityId === null ? null : String(entityId);

    
    const now = new Date();
    const dataHash = computeDataHash({
      userId: finalUserId,
      action,
      entity: entity || null,
      entityId: normalizedEntityId,
      description: description || null,
      metadata: Object.keys(meta).length > 0 ? meta : null,
      createdAt: now.toISOString(),
    });

    
    const lastEntry = await getLastChainEntry(transaction);
    const newChainIndex = lastEntry.chainIndex + 1;
    const prevHash = lastEntry.currentHash;

    
    const currentHash = computeChainHash(newChainIndex, prevHash, dataHash);

    
    const finalSeverity = severity || getSeverity(action);

    
    const record = await AuditLog.create(
      {
        userId: finalUserId,
        action,
        entity: entity || null,
        entityId: normalizedEntityId,
        description: description || null,
        metadata: Object.keys(meta).length > 0 ? meta : null,
        chainIndex: newChainIndex,
        prevHash,
        currentHash,
        dataHash,
        severity: finalSeverity,
        createdAt: now,
      },
      { transaction }
    );

    await transaction.commit();
    return record;
  } catch (error) {
    await transaction.rollback();
    console.error("[HashChainLogger] Ошибка записи в журнал аудита:", error);

    
    try {
      return await AuditLog.create({
        userId:
          (req && req.user && req.user.id) || userId || null,
        action,
        entity: entity || null,
        entityId:
          entityId === undefined || entityId === null
            ? null
            : String(entityId),
        description: `[CHAIN_ERROR] ${description || ""}`,
        metadata: { ...(metadata || {}), chainError: error.message },
        severity: severity || getSeverity(action),
      });
    } catch (fallbackError) {
      console.error("[HashChainLogger] CRITICAL: Даже fallback-запись не удалась:", fallbackError);
      return null;
    }
  }
}







async function logWarehouseMove(req, movement, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.WAREHOUSE_MOVE,
    entity: AUDIT_ENTITIES.WAREHOUSE_MOVEMENT,
    entityId: movement.id,
    description: `Перемещение: ${movement.operation}, кол-во: ${movement.deltaQty || 0}`,
    metadata: {
      boxId: movement.boxId,
      operation: movement.operation,
      fromSectionId: movement.fromSectionId,
      toSectionId: movement.toSectionId,
      deltaQty: movement.deltaQty,
      ...metadata,
    },
  });
}



async function logProductionEntry(req, entry, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.PRODUCTION_ENTRY_CREATE,
    approve: AUDIT_ACTIONS.PRODUCTION_ENTRY_APPROVE,
    reject: AUDIT_ACTIONS.PRODUCTION_ENTRY_REJECT,
    update: AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    delete: AUDIT_ACTIONS.PRODUCTION_ENTRY_DELETE,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.PRODUCTION_ENTRY_UPDATE,
    entity: AUDIT_ENTITIES.PRODUCTION_ENTRY,
    entityId: entry.id,
    description: `Производственная запись #${entry.id}: ${action}`,
    metadata: {
      entryId: entry.id,
      quantity: entry.quantity,
      productId: entry.productId,
      ...metadata,
    },
  });
}



async function logComponentSync(req, serverId, result, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.COMPONENT_SYNC,
    entity: AUDIT_ENTITIES.COMPONENT_INVENTORY,
    entityId: serverId,
    description: `Синхронизация компонентов #${serverId}`,
    metadata: {
      serverId,
      mode: result.mode,
      added: result.actions?.added?.length || 0,
      updated: result.actions?.updated?.length || 0,
      preserved: result.actions?.preserved?.length || 0,
      ...metadata,
    },
  });
}



async function logExport(req, exportType, description, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.EXPORT_REPORT,
    entity: null,
    entityId: null,
    description: description || `Экспорт: ${exportType}`,
    metadata: { exportType, ...metadata },
  });
}







async function logDocumentCreate(req, doc, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.DOCUMENT_CREATE,
    entity: AUDIT_ENTITIES.DOCUMENT,
    entityId: doc.id,
    description: `Создан документ: ${doc.code} "${doc.title}"`,
    metadata: { code: doc.code, type: doc.type, ...metadata },
  });
}

async function logDocumentApproval(req, doc, version, decision, metadata = {}) {
  const action =
    decision === "APPROVED"
      ? AUDIT_ACTIONS.DOCUMENT_APPROVE
      : AUDIT_ACTIONS.DOCUMENT_REJECT;

  return logAudit({
    req,
    action,
    entity: AUDIT_ENTITIES.DOCUMENT_APPROVAL,
    entityId: doc.id,
    description: `Документ ${doc.code} v${version.version}: ${decision}`,
    metadata: {
      documentId: doc.id,
      versionId: version.id,
      versionNumber: version.version,
      decision,
      ...metadata,
    },
  });
}

async function logDocumentEffective(req, doc, version, metadata = {}) {
  return logAudit({
    req,
    action: AUDIT_ACTIONS.DOCUMENT_MAKE_EFFECTIVE,
    entity: AUDIT_ENTITIES.DOCUMENT,
    entityId: doc.id,
    description: `Документ ${doc.code} v${version.version} введён в действие`,
    metadata: {
      documentId: doc.id,
      versionId: version.id,
      ...metadata,
    },
  });
}



async function logNonconformity(req, nc, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.NC_CREATE,
    update: AUDIT_ACTIONS.NC_UPDATE,
    investigate: AUDIT_ACTIONS.NC_INVESTIGATE,
    disposition: AUDIT_ACTIONS.NC_DISPOSITION,
    close: AUDIT_ACTIONS.NC_CLOSE,
    reopen: AUDIT_ACTIONS.NC_REOPEN,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.NC_UPDATE,
    entity: AUDIT_ENTITIES.NONCONFORMITY,
    entityId: nc.id,
    description: `NC-${String(nc.id).padStart(4, "0")}: ${action}`,
    metadata: {
      ncNumber: nc.number,
      source: nc.source,
      classification: nc.classification,
      ...metadata,
    },
  });
}



async function logCapa(req, capa, action, metadata = {}) {
  const actionMap = {
    create: AUDIT_ACTIONS.CAPA_CREATE,
    update: AUDIT_ACTIONS.CAPA_UPDATE,
    planApprove: AUDIT_ACTIONS.CAPA_PLAN_APPROVE,
    implement: AUDIT_ACTIONS.CAPA_IMPLEMENT,
    verify: AUDIT_ACTIONS.CAPA_VERIFY,
    close: AUDIT_ACTIONS.CAPA_CLOSE,
    effectivenessCheck: AUDIT_ACTIONS.CAPA_EFFECTIVENESS_CHECK,
  };

  return logAudit({
    req,
    action: actionMap[action] || AUDIT_ACTIONS.CAPA_UPDATE,
    entity: AUDIT_ENTITIES.CAPA,
    entityId: capa.id,
    description: `CAPA-${String(capa.id).padStart(4, "0")}: ${action}`,
    metadata: {
      capaNumber: capa.number,
      type: capa.type,
      ...metadata,
    },
  });
}





module.exports = {
  
  logAudit,
  AUDIT_ACTIONS,
  AUDIT_ENTITIES,
  GENESIS_HASH,

  
  computeDataHash,
  computeChainHash,

  
  logWarehouseMove,
  logComponentSync,
  logProductionEntry,
  logExport,

  
  logDocumentCreate,
  logDocumentApproval,
  logDocumentEffective,
  logNonconformity,
  logCapa,

  
  getSeverity,
};

================================================================================
FILE: QMS-Server-master/modules/qms-audit/controllers/internalAuditController.js
================================================================================

const { AuditPlan, AuditSchedule, AuditFinding } = require("../models/InternalAudit");
const { User } = require("../../../models/index");
const { logAudit } = require("../../core/utils/auditLogger");





const getPlans = async (req, res) => {
  try {
    const { year, status, page = 1, limit = 20 } = req.query;
    const where = {};
    if (year) where.year = year;
    if (status) where.status = status;

    const offset = (page - 1) * limit;
    const { count, rows } = await AuditPlan.findAndCountAll({
      where,
      include: [{ model: AuditSchedule, as: "audits" }],
      order: [["year", "DESC"]],
      limit: parseInt(limit),
      offset,
    });
    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("AuditPlan getPlans error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getPlanOne = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const plan = await AuditPlan.findByPk(id, {
      include: [{
        model: AuditSchedule, as: "audits",
        include: [{ model: AuditFinding, as: "findings" }],
      }],
    });
    if (!plan) return res.status(404).json({ error: "Plan not found" });
    res.json(plan);
  } catch (e) {
    console.error("AuditPlan getPlanOne error:", e);
    res.status(500).json({ error: e.message });
  }
};

const createPlan = async (req, res) => {
  try {
    const plan = await AuditPlan.create(req.body);
    await logAudit(req, "audit.plan.create", "audit_plan", plan.id, { title: plan.title, year: plan.year });
    res.status(201).json(plan);
  } catch (e) {
    console.error("AuditPlan createPlan error:", e);
    res.status(500).json({ error: e.message });
  }
};

const updatePlan = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const plan = await AuditPlan.findByPk(id);
    if (!plan) return res.status(404).json({ error: "Plan not found" });

    await plan.update(req.body);
    await logAudit(req, "audit.plan.update", "audit_plan", plan.id, req.body);
    res.json(plan);
  } catch (e) {
    console.error("AuditPlan updatePlan error:", e);
    res.status(500).json({ error: e.message });
  }
};





const getSchedules = async (req, res) => {
  try {
    const { planId, status, page = 1, limit = 20 } = req.query;
    const where = {};
    if (planId) where.auditPlanId = planId;
    if (status) where.status = status;

    const offset = (page - 1) * limit;
    const { count, rows } = await AuditSchedule.findAndCountAll({
      where,
      include: [
        { model: AuditFinding, as: "findings" },
        { model: AuditPlan, as: "auditPlan", attributes: ["id", "title", "year"] },
      ],
      order: [["plannedDate", "ASC"]],
      limit: parseInt(limit),
      offset,
    });
    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("AuditSchedule getSchedules error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getScheduleOne = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const schedule = await AuditSchedule.findByPk(id, {
      include: [
        { model: AuditFinding, as: "findings" },
        { model: AuditPlan, as: "auditPlan" },
      ],
    });
    if (!schedule) return res.status(404).json({ error: "Audit not found" });
    res.json(schedule);
  } catch (e) {
    console.error("AuditSchedule getScheduleOne error:", e);
    res.status(500).json({ error: e.message });
  }
};

const createSchedule = async (req, res) => {
  try {
    const year = new Date().getFullYear();
    const count = await AuditSchedule.count();
    const auditNumber = `IA-${year}-${String(count + 1).padStart(3, "0")}`;

    const schedule = await AuditSchedule.create({ ...req.body, auditNumber });
    await logAudit(req, "audit.schedule.create", "internal_audit", schedule.id, { auditNumber });
    res.status(201).json(schedule);
  } catch (e) {
    console.error("AuditSchedule createSchedule error:", e);
    res.status(500).json({ error: e.message });
  }
};

const updateSchedule = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const schedule = await AuditSchedule.findByPk(id);
    if (!schedule) return res.status(404).json({ error: "Audit not found" });

    await schedule.update(req.body);
    await logAudit(req, "audit.schedule.update", "internal_audit", schedule.id, req.body);
    res.json(schedule);
  } catch (e) {
    console.error("AuditSchedule updateSchedule error:", e);
    res.status(500).json({ error: e.message });
  }
};





const addFinding = async (req, res) => {
  try {
    const scheduleId = parseInt(req.params.scheduleId);
    if (isNaN(scheduleId)) return res.status(400).json({ error: "Invalid ID" });

    const schedule = await AuditSchedule.findByPk(scheduleId);
    if (!schedule) return res.status(404).json({ error: "Audit not found" });

    const year = new Date().getFullYear();
    const count = await AuditFinding.count();
    const findingNumber = `AF-${year}-${String(count + 1).padStart(3, "0")}`;

    const finding = await AuditFinding.create({
      ...req.body,
      auditScheduleId: scheduleId,
      findingNumber,
    });

    await logAudit(req, "audit.finding.create", "audit_finding", finding.id, { findingNumber, scheduleId });
    res.status(201).json(finding);
  } catch (e) {
    console.error("AuditFinding addFinding error:", e);
    res.status(500).json({ error: e.message });
  }
};

const updateFinding = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const finding = await AuditFinding.findByPk(id);
    if (!finding) return res.status(404).json({ error: "Finding not found" });

    await finding.update(req.body);
    await logAudit(req, "audit.finding.update", "audit_finding", finding.id, req.body);
    res.json(finding);
  } catch (e) {
    console.error("AuditFinding updateFinding error:", e);
    res.status(500).json({ error: e.message });
  }
};





const getStats = async (req, res) => {
  try {
    const totalPlans = await AuditPlan.count();
    const totalAudits = await AuditSchedule.count();
    const completedAudits = await AuditSchedule.count({ where: { status: "COMPLETED" } });
    const inProgressAudits = await AuditSchedule.count({ where: { status: "IN_PROGRESS" } });
    const overdueAudits = await AuditSchedule.count({ where: { status: "OVERDUE" } });
    const openFindings = await AuditFinding.count({ where: { status: "OPEN" } });
    const totalFindings = await AuditFinding.count();

    res.json({ totalPlans, totalAudits, completedAudits, inProgressAudits, overdueAudits, openFindings, totalFindings });
  } catch (e) {
    console.error("InternalAudit getStats error:", e);
    res.status(500).json({ error: e.message });
  }
};

module.exports = {
  getPlans, getPlanOne, createPlan, updatePlan,
  getSchedules, getScheduleOne, createSchedule, updateSchedule,
  addFinding, updateFinding, getStats,
};

================================================================================
FILE: QMS-Server-master/modules/qms-audit/index.js
================================================================================

module.exports = {
  code: 'qms.audit',

  register(router) {
    router.use('/internal-audits', require('./routes/internalAuditRouter'));
  },

  getModels() { return require('./models/InternalAudit'); },
  setupAssociations() {},
};

================================================================================
FILE: QMS-Server-master/modules/qms-audit/models/InternalAudit.js
================================================================================

const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");





const AuditPlan = sequelize.define("audit_plan", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  year: { type: DataTypes.INTEGER, allowNull: false },
  title: { type: DataTypes.STRING, allowNull: false, comment: "Например: Годовой план внутренних аудитов 2026" },
  approvedBy: { type: DataTypes.INTEGER, allowNull: true },
  approvedAt: { type: DataTypes.DATE, allowNull: true },
  status: { type: DataTypes.ENUM("DRAFT", "APPROVED", "IN_PROGRESS", "COMPLETED"), defaultValue: "DRAFT" },
});

const AuditSchedule = sequelize.define("audit_schedule", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  auditPlanId: { type: DataTypes.INTEGER, allowNull: false },
  
  auditNumber: { type: DataTypes.STRING, unique: true, allowNull: false, comment: "IA-YYYY-NNN" },
  title: { type: DataTypes.STRING, allowNull: false },
  scope: { type: DataTypes.TEXT, comment: "Область аудита: процесс, подразделение, пункты ISO" },
  isoClause: { type: DataTypes.STRING, comment: "Проверяемые пункты ISO 13485" },
  
  plannedDate: { type: DataTypes.DATE, allowNull: false },
  actualDate: { type: DataTypes.DATE, allowNull: true },
  
  leadAuditorId: { type: DataTypes.INTEGER, allowNull: true },
  auditeeId: { type: DataTypes.INTEGER, allowNull: true, comment: "Ответственный за проверяемый процесс" },
  
  status: {
    type: DataTypes.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "CANCELLED", "OVERDUE"),
    defaultValue: "PLANNED"
  },
  
  criteria: { type: DataTypes.TEXT, comment: "Критерии аудита" },
  conclusion: { type: DataTypes.TEXT, comment: "Общее заключение" },
  reportUrl: { type: DataTypes.STRING, allowNull: true },
});

const AuditFinding = sequelize.define("audit_finding", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  auditScheduleId: { type: DataTypes.INTEGER, allowNull: false },
  
  findingNumber: { type: DataTypes.STRING, allowNull: false, comment: "AF-YYYY-NNN" },
  
  type: {
    type: DataTypes.ENUM("MAJOR_NC", "MINOR_NC", "OBSERVATION", "OPPORTUNITY", "POSITIVE"),
    allowNull: false,
    comment: "MAJOR_NC=критическое, MINOR_NC=незначительное, OBSERVATION=наблюдение"
  },
  
  isoClause: { type: DataTypes.STRING, comment: "Нарушенный пункт ISO" },
  description: { type: DataTypes.TEXT, allowNull: false },
  evidence: { type: DataTypes.TEXT, comment: "Объективные свидетельства" },
  
  
  nonconformityId: { type: DataTypes.INTEGER, allowNull: true, comment: "Связь с NC если создан" },
  capaId: { type: DataTypes.INTEGER, allowNull: true, comment: "Связь с CAPA если создан" },
  
  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  dueDate: { type: DataTypes.DATE, allowNull: true },
  
  status: {
    type: DataTypes.ENUM("OPEN", "ACTION_REQUIRED", "CORRECTED", "VERIFIED", "CLOSED"),
    defaultValue: "OPEN"
  },
  
  closedBy: { type: DataTypes.INTEGER, allowNull: true },
  closedAt: { type: DataTypes.DATE, allowNull: true },
  closureNotes: { type: DataTypes.TEXT, allowNull: true },
});


AuditPlan.hasMany(AuditSchedule, { as: "audits", foreignKey: "auditPlanId" });
AuditSchedule.belongsTo(AuditPlan, { as: "auditPlan", foreignKey: "auditPlanId" });

AuditSchedule.hasMany(AuditFinding, { as: "findings", foreignKey: "auditScheduleId" });
AuditFinding.belongsTo(AuditSchedule, { foreignKey: "auditScheduleId" });

module.exports = { AuditPlan, AuditSchedule, AuditFinding };

================================================================================
FILE: QMS-Server-master/modules/qms-audit/routes/internalAuditRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const ctrl = require("../controllers/internalAuditController");
const authMiddleware = require("../../core/middleware/authMiddleware");
const syncUserMiddleware = require("../../core/middleware/syncUserMiddleware");
const checkAbility = require("../../core/middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/stats", ...protect, checkAbility("internal-audit.read"), ctrl.getStats);


router.get("/plans",      ...protect, checkAbility("internal-audit.read"),   ctrl.getPlans);
router.get("/plans/:id",  ...protect, checkAbility("internal-audit.read"),   ctrl.getPlanOne);
router.post("/plans",     ...protect, checkAbility("internal-audit.manage"), ctrl.createPlan);
router.put("/plans/:id",  ...protect, checkAbility("internal-audit.manage"), ctrl.updatePlan);


router.get("/schedules",       ...protect, checkAbility("internal-audit.read"),   ctrl.getSchedules);
router.get("/schedules/:id",   ...protect, checkAbility("internal-audit.read"),   ctrl.getScheduleOne);
router.post("/schedules",      ...protect, checkAbility("internal-audit.manage"), ctrl.createSchedule);
router.put("/schedules/:id",   ...protect, checkAbility("internal-audit.manage"), ctrl.updateSchedule);


router.post("/schedules/:scheduleId/findings", ...protect, checkAbility("internal-audit.manage"), ctrl.addFinding);
router.put("/findings/:id",                     ...protect, checkAbility("internal-audit.manage"), ctrl.updateFinding);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/qms-dms/controllers/documentController.js
================================================================================






















const ApiError = require("../../../error/ApiError");
const DocumentService = require("../services/DocumentService");

class DocumentController {
  

  async getAll(req, res, next) {
    try {
      const { page, limit, status, type, category, search, ownerId } = req.query;
      const result = await DocumentService.getDocuments({
        page: Number(page) || 1,
        limit: Number(limit) || 20,
        status,
        type,
        category,
        search,
        ownerId: ownerId ? Number(ownerId) : undefined,
      });
      return res.json(result);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async getOne(req, res, next) {
    try {
      const doc = await DocumentService.getDocumentDetail(Number(req.params.id));
      if (!doc) return next(ApiError.notFound("Документ не найден"));
      return res.json(doc);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async getStats(req, res, next) {
    try {
      const stats = await DocumentService.getStats();
      return res.json(stats);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async getPending(req, res, next) {
    try {
      const approvals = await DocumentService.getPendingApprovals(req.user.id);
      return res.json(approvals);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async getOverdue(req, res, next) {
    try {
      const docs = await DocumentService.getOverdueReviews();
      return res.json(docs);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  

  async create(req, res, next) {
    try {
      const { title, type, category, description, isoSection, tags, reviewCycleMonths } = req.body;

      if (!title || !type) {
        return next(ApiError.badRequest("Обязательные поля: title, type"));
      }

      const result = await DocumentService.createDocument(req, {
        title, type, category, description, isoSection, tags, reviewCycleMonths,
      });

      return res.status(201).json(result);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  

  async createVersion(req, res, next) {
    try {
      const { changeDescription } = req.body;
      const version = await DocumentService.createNewVersion(
        req,
        Number(req.params.id),
        { changeDescription }
      );
      return res.status(201).json(version);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async uploadFile(req, res, next) {
    try {
      if (!req.files || !req.files.file) {
        return next(ApiError.badRequest("Файл не загружен"));
      }

      const version = await DocumentService.uploadVersionFile(
        req,
        Number(req.params.id),
        req.files.file
      );

      return res.json(version);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  

  async submitForReview(req, res, next) {
    try {
      const { approvalChain } = req.body;
      if (!approvalChain || !Array.isArray(approvalChain)) {
        return next(ApiError.badRequest("approvalChain обязателен (массив)"));
      }

      const version = await DocumentService.submitForReview(
        req,
        Number(req.params.id),
        approvalChain
      );

      return res.json(version);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async decide(req, res, next) {
    try {
      const { decision, comment } = req.body;
      if (!decision) {
        return next(ApiError.badRequest("decision обязателен: APPROVED, REJECTED, RETURNED"));
      }

      const approval = await DocumentService.makeDecision(
        req,
        Number(req.params.id),
        { decision, comment }
      );

      return res.json(approval);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async makeEffective(req, res, next) {
    try {
      const version = await DocumentService.makeEffective(req, Number(req.params.id));
      return res.json(version);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  

  async distribute(req, res, next) {
    try {
      const { userIds } = req.body;
      if (!userIds || !Array.isArray(userIds)) {
        return next(ApiError.badRequest("userIds обязателен (массив)"));
      }

      const distributions = await DocumentService.distribute(
        req,
        Number(req.params.id),
        userIds
      );

      return res.json(distributions);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }

  async acknowledge(req, res, next) {
    try {
      const dist = await DocumentService.acknowledge(req, Number(req.params.id));
      return res.json(dist);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new DocumentController();

================================================================================
FILE: QMS-Server-master/modules/qms-dms/index.js
================================================================================

module.exports = {
  code: 'qms.dms',

  register(router) {
    router.use('/documents', require('./routes/documentRouter'));
  },

  getModels() {
    return require('./models/Document');
  },

  setupAssociations(m) {
    if (m.Document && m.User) {
      m.Document.belongsTo(m.User, { as: 'author', foreignKey: 'authorId' });
      m.Document.belongsTo(m.User, { as: 'approver', foreignKey: 'currentApproverId' });
    }
    const { setupDocumentAssociations } = require('./models/Document');
    if (typeof setupDocumentAssociations === 'function') {
      setupDocumentAssociations(m);
    }
  },
};

================================================================================
FILE: QMS-Server-master/modules/qms-dms/models/Document.js
================================================================================















const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");





const DOCUMENT_TYPES = {
  POLICY: "POLICY",
  MANUAL: "MANUAL",
  PROCEDURE: "PROCEDURE",
  WORK_INSTRUCTION: "WORK_INSTRUCTION",
  FORM: "FORM",
  RECORD: "RECORD",
  SPECIFICATION: "SPECIFICATION",
  PLAN: "PLAN",
  EXTERNAL: "EXTERNAL",
  OTHER: "OTHER",
};

const DOCUMENT_STATUSES = {
  DRAFT: "DRAFT",
  REVIEW: "REVIEW",
  APPROVED: "APPROVED",
  EFFECTIVE: "EFFECTIVE",
  REVISION: "REVISION",
  OBSOLETE: "OBSOLETE",
  CANCELLED: "CANCELLED",
};

const VERSION_STATUSES = {
  DRAFT: "DRAFT",
  REVIEW: "REVIEW",
  APPROVED: "APPROVED",
  EFFECTIVE: "EFFECTIVE",
  SUPERSEDED: "SUPERSEDED",
  REJECTED: "REJECTED",
};

const APPROVAL_ROLES = {
  REVIEWER: "REVIEWER",
  APPROVER: "APPROVER",
  QUALITY_OFFICER: "QUALITY_OFFICER",
};

const APPROVAL_DECISIONS = {
  PENDING: "PENDING",
  APPROVED: "APPROVED",
  REJECTED: "REJECTED",
  RETURNED: "RETURNED",
};


const TYPE_CODE_PREFIX = {
  POLICY: "ПК",         
  MANUAL: "РК",         
  PROCEDURE: "СТО",     
  WORK_INSTRUCTION: "РИ", 
  FORM: "Ф",            
  RECORD: "ЗП",         
  SPECIFICATION: "СП",  
  PLAN: "ПЛ",           
  EXTERNAL: "ВН",       
  OTHER: "ДОК",         
};





const Document = sequelize.define("document", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  code: {
    type: DataTypes.STRING(50),
    allowNull: false,
    unique: true,
    validate: {
      notEmpty: true,
    },
  },
  title: {
    type: DataTypes.STRING(500),
    allowNull: false,
    validate: {
      notEmpty: true,
      len: [3, 500],
    },
  },
  type: {
    type: DataTypes.ENUM(...Object.values(DOCUMENT_TYPES)),
    allowNull: false,
  },
  category: {
    type: DataTypes.STRING(100),
    allowNull: true,
  },
  description: {
    type: DataTypes.TEXT,
    allowNull: true,
  },
  status: {
    type: DataTypes.ENUM(...Object.values(DOCUMENT_STATUSES)),
    allowNull: false,
    defaultValue: DOCUMENT_STATUSES.DRAFT,
  },
  currentVersionId: {
    type: DataTypes.INTEGER,
    allowNull: true,
  },
  ownerId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  reviewCycleMonths: {
    type: DataTypes.INTEGER,
    allowNull: true,
    defaultValue: 12,
  },
  nextReviewDate: {
    type: DataTypes.DATEONLY,
    allowNull: true,
  },
  effectiveDate: {
    type: DataTypes.DATEONLY,
    allowNull: true,
  },
  obsoleteDate: {
    type: DataTypes.DATEONLY,
    allowNull: true,
  },
  replacedById: {
    type: DataTypes.INTEGER,
    allowNull: true,
  },
  isoSection: {
    type: DataTypes.STRING(20),
    allowNull: true,
  },
  tags: {
    type: DataTypes.ARRAY(DataTypes.STRING),
    allowNull: true,
    defaultValue: [],
  },
});

const DocumentVersion = sequelize.define("document_version", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  documentId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  version: {
    type: DataTypes.STRING(20),
    allowNull: false,
  },
  versionNumber: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  status: {
    type: DataTypes.ENUM(...Object.values(VERSION_STATUSES)),
    allowNull: false,
    defaultValue: VERSION_STATUSES.DRAFT,
  },
  changeDescription: {
    type: DataTypes.TEXT,
    allowNull: true,
  },
  fileUrl: {
    type: DataTypes.STRING(1000),
    allowNull: true,
  },
  fileName: {
    type: DataTypes.STRING(500),
    allowNull: true,
  },
  fileSize: {
    type: DataTypes.INTEGER,
    allowNull: true,
  },
  fileMimeType: {
    type: DataTypes.STRING(100),
    allowNull: true,
  },
  fileHash: {
    type: DataTypes.STRING(64),
    allowNull: true,
  },
  content: {
    type: DataTypes.TEXT,
    allowNull: true,
  },
  createdById: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  approvedById: {
    type: DataTypes.INTEGER,
    allowNull: true,
  },
  approvedAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
  effectiveAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
  supersededAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
});

const DocumentApproval = sequelize.define("document_approval", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  versionId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  step: {
    type: DataTypes.INTEGER,
    allowNull: false,
    defaultValue: 1,
  },
  role: {
    type: DataTypes.ENUM(...Object.values(APPROVAL_ROLES)),
    allowNull: false,
  },
  assignedToId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  decision: {
    type: DataTypes.ENUM(...Object.values(APPROVAL_DECISIONS)),
    allowNull: false,
    defaultValue: APPROVAL_DECISIONS.PENDING,
  },
  comment: {
    type: DataTypes.TEXT,
    allowNull: true,
  },
  decidedAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
  dueDate: {
    type: DataTypes.DATEONLY,
    allowNull: true,
  },
});

const DocumentDistribution = sequelize.define("document_distribution", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  versionId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  userId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  distributedAt: {
    type: DataTypes.DATE,
    allowNull: false,
    defaultValue: DataTypes.NOW,
  },
  acknowledged: {
    type: DataTypes.BOOLEAN,
    allowNull: false,
    defaultValue: false,
  },
  acknowledgedAt: {
    type: DataTypes.DATE,
    allowNull: true,
  },
});





function setupDocumentAssociations({ User }) {
  
  Document.belongsTo(User, { foreignKey: "ownerId", as: "owner" });
  User.hasMany(Document, { foreignKey: "ownerId", as: "ownedDocuments" });

  
  Document.belongsTo(Document, { foreignKey: "replacedById", as: "replacedBy" });
  Document.hasMany(Document, { foreignKey: "replacedById", as: "replacements" });

  
  Document.hasMany(DocumentVersion, { foreignKey: "documentId", as: "versions", onDelete: "CASCADE" });
  DocumentVersion.belongsTo(Document, { foreignKey: "documentId", as: "document" });

  
  Document.belongsTo(DocumentVersion, { foreignKey: "currentVersionId", as: "currentVersion" });

  
  DocumentVersion.belongsTo(User, { foreignKey: "createdById", as: "createdBy" });
  DocumentVersion.belongsTo(User, { foreignKey: "approvedById", as: "approvedBy" });

  
  DocumentVersion.hasMany(DocumentApproval, { foreignKey: "versionId", as: "approvals", onDelete: "CASCADE" });
  DocumentApproval.belongsTo(DocumentVersion, { foreignKey: "versionId", as: "version" });

  
  DocumentApproval.belongsTo(User, { foreignKey: "assignedToId", as: "assignedTo" });

  
  DocumentVersion.hasMany(DocumentDistribution, { foreignKey: "versionId", as: "distributions", onDelete: "CASCADE" });
  DocumentDistribution.belongsTo(DocumentVersion, { foreignKey: "versionId", as: "version" });

  
  DocumentDistribution.belongsTo(User, { foreignKey: "userId", as: "user" });
  User.hasMany(DocumentDistribution, { foreignKey: "userId", as: "documentDistributions" });
}



module.exports = {
  Document,
  DocumentVersion,
  DocumentApproval,
  DocumentDistribution,
  setupDocumentAssociations,

  
  DOCUMENT_TYPES,
  DOCUMENT_STATUSES,
  VERSION_STATUSES,
  APPROVAL_ROLES,
  APPROVAL_DECISIONS,
  TYPE_CODE_PREFIX,
};

================================================================================
FILE: QMS-Server-master/modules/qms-dms/routes/documentRouter.js
================================================================================

















const Router = require("express");
const router = new Router();
const documentController = require("../controllers/documentController");
const authMiddleware = require("../../core/middleware/authMiddleware");
const syncUserMiddleware = require("../../core/middleware/syncUserMiddleware");
const checkAbility = require("../../core/middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/",        ...protect, checkAbility("dms.view"), documentController.getAll);
router.get("/stats",   ...protect, checkAbility("dms.view"), documentController.getStats);
router.get("/pending", ...protect, documentController.getPending); 
router.get("/overdue", ...protect, checkAbility("dms.manage"), documentController.getOverdue);
router.get("/:id",     ...protect, checkAbility("dms.view"), documentController.getOne);


router.post("/",                       ...protect, checkAbility("dms.create"), documentController.create);
router.post("/:id/versions",          ...protect, checkAbility("dms.create"), documentController.createVersion);
router.post("/versions/:id/upload",   ...protect, checkAbility("dms.create"), documentController.uploadFile);


router.post("/versions/:id/submit",   ...protect, checkAbility("dms.create"), documentController.submitForReview);
router.post("/approvals/:id/decide",  ...protect, documentController.decide); 


router.post("/versions/:id/effective",  ...protect, checkAbility("dms.manage"), documentController.makeEffective);
router.post("/versions/:id/distribute", ...protect, checkAbility("dms.manage"), documentController.distribute);


router.post("/distributions/:id/ack", ...protect, documentController.acknowledge);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/qms-dms/services/DocumentService.js
================================================================================
















const crypto = require("crypto");
const path = require("path");
const fs = require("fs").promises;
const { Op } = require("sequelize");
const sequelize = require("../../../db");

const {
  Document,
  DocumentVersion,
  DocumentApproval,
  DocumentDistribution,
  DOCUMENT_STATUSES,
  VERSION_STATUSES,
  APPROVAL_DECISIONS,
  TYPE_CODE_PREFIX,
} = require("../models/Document");
const { User } = require("../../../models/index");
const { logDocumentCreate, logDocumentApproval, logDocumentEffective, logAudit, AUDIT_ACTIONS } = require("../../core/utils/hashChainLogger");


const DOCS_STORAGE = process.env.DOCS_STORAGE_PATH || path.join(__dirname, "..", "static", "documents");

class DocumentService {
  
  
  

  



  async createDocument(req, { title, type, category, description, isoSection, tags, reviewCycleMonths }) {
    const transaction = await sequelize.transaction();

    try {
      
      const prefix = TYPE_CODE_PREFIX[type] || "ДОК";
      const lastDoc = await Document.findOne({
        where: { type },
        order: [["id", "DESC"]],
        attributes: ["code"],
        transaction,
      });

      let number = 1;
      if (lastDoc && lastDoc.code) {
        const match = lastDoc.code.match(/(\d+)$/);
        if (match) number = parseInt(match[1]) + 1;
      }

      const code = `${prefix}-СМК-${String(number).padStart(3, "0")}`;

      
      const document = await Document.create(
        {
          code,
          title,
          type,
          category: category || null,
          description: description || null,
          status: DOCUMENT_STATUSES.DRAFT,
          ownerId: req.user.id,
          isoSection: isoSection || null,
          tags: tags || [],
          reviewCycleMonths: reviewCycleMonths || 12,
        },
        { transaction }
      );

      
      const version = await DocumentVersion.create(
        {
          documentId: document.id,
          version: "1.0",
          versionNumber: 1,
          status: VERSION_STATUSES.DRAFT,
          changeDescription: "Первоначальная версия",
          createdById: req.user.id,
        },
        { transaction }
      );

      
      await document.update({ currentVersionId: version.id }, { transaction });

      await transaction.commit();

      
      await logDocumentCreate(req, document);

      return { document, version };
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  



  async uploadVersionFile(req, versionId, file) {
    const version = await DocumentVersion.findByPk(versionId);
    if (!version) throw new Error("Версия не найдена");
    if (version.status !== VERSION_STATUSES.DRAFT) {
      throw new Error("Загрузка файла возможна только для черновика");
    }

    
    const docDir = path.join(DOCS_STORAGE, String(version.documentId));
    await fs.mkdir(docDir, { recursive: true });

    
    const ext = path.extname(file.name);
    const safeFileName = `v${version.versionNumber}_${Date.now()}${ext}`;
    const filePath = path.join(docDir, safeFileName);

    
    await fs.writeFile(filePath, file.data);

    
    const fileHash = crypto
      .createHash("sha256")
      .update(file.data)
      .digest("hex");

    
    await version.update({
      fileUrl: `/documents/${version.documentId}/${safeFileName}`,
      fileName: file.name,
      fileSize: file.size,
      fileMimeType: file.mimetype,
      fileHash,
    });

    
    await logAudit({
      req,
      action: AUDIT_ACTIONS.DOCUMENT_VERSION_CREATE,
      entity: "DocumentVersion",
      entityId: version.id,
      description: `Загружен файл для версии ${version.version}: ${file.name}`,
      metadata: { fileHash, fileSize: file.size },
    });

    return version;
  }

  
  
  

  





  async submitForReview(req, versionId, approvalChain) {
    const transaction = await sequelize.transaction();

    try {
      const version = await DocumentVersion.findByPk(versionId, {
        include: [{ model: Document, as: "document" }],
        transaction,
      });

      if (!version) throw new Error("Версия не найдена");
      if (version.status !== VERSION_STATUSES.DRAFT) {
        throw new Error("Можно отправить на согласование только черновик");
      }

      
      if (!approvalChain || approvalChain.length === 0) {
        throw new Error("Цепочка согласования не может быть пустой");
      }

      
      for (let i = 0; i < approvalChain.length; i++) {
        const { userId, role, dueDate } = approvalChain[i];

        await DocumentApproval.create(
          {
            versionId: version.id,
            step: i + 1,
            role,
            assignedToId: userId,
            decision: APPROVAL_DECISIONS.PENDING,
            dueDate: dueDate || null,
          },
          { transaction }
        );
      }

      
      await version.update({ status: VERSION_STATUSES.REVIEW }, { transaction });
      await version.document.update({ status: DOCUMENT_STATUSES.REVIEW }, { transaction });

      await transaction.commit();

      
      await logAudit({
        req,
        action: AUDIT_ACTIONS.DOCUMENT_SUBMIT_REVIEW,
        entity: "DocumentVersion",
        entityId: version.id,
        description: `Документ ${version.document.code} v${version.version} отправлен на согласование`,
        metadata: {
          approvers: approvalChain.map((a) => a.userId),
          steps: approvalChain.length,
        },
      });

      return version;
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  




  async makeDecision(req, approvalId, { decision, comment }) {
    const transaction = await sequelize.transaction();

    try {
      const approval = await DocumentApproval.findByPk(approvalId, {
        include: [
          {
            model: DocumentVersion,
            as: "version",
            include: [{ model: Document, as: "document" }],
          },
        ],
        transaction,
      });

      if (!approval) throw new Error("Шаг согласования не найден");
      if (approval.assignedToId !== req.user.id) {
        throw new Error("Вы не являетесь назначенным согласователем");
      }
      if (approval.decision !== APPROVAL_DECISIONS.PENDING) {
        throw new Error("Решение уже принято");
      }

      
      if (approval.step > 1) {
        const prevSteps = await DocumentApproval.findAll({
          where: {
            versionId: approval.versionId,
            step: { [Op.lt]: approval.step },
          },
          transaction,
        });

        const allPrevApproved = prevSteps.every(
          (s) => s.decision === APPROVAL_DECISIONS.APPROVED
        );

        if (!allPrevApproved) {
          throw new Error("Предыдущие шаги согласования ещё не завершены");
        }
      }

      
      await approval.update(
        {
          decision,
          comment: comment || null,
          decidedAt: new Date(),
        },
        { transaction }
      );

      const version = approval.version;
      const doc = version.document;

      if (decision === APPROVAL_DECISIONS.REJECTED || decision === APPROVAL_DECISIONS.RETURNED) {
        
        await version.update({ status: VERSION_STATUSES.REJECTED }, { transaction });
        await doc.update({ status: DOCUMENT_STATUSES.DRAFT }, { transaction });
      } else if (decision === APPROVAL_DECISIONS.APPROVED) {
        
        const allApprovals = await DocumentApproval.findAll({
          where: { versionId: version.id },
          transaction,
        });

        const allApproved = allApprovals.every(
          (a) => a.decision === APPROVAL_DECISIONS.APPROVED
        );

        if (allApproved) {
          
          await version.update(
            {
              status: VERSION_STATUSES.APPROVED,
              approvedById: req.user.id,
              approvedAt: new Date(),
            },
            { transaction }
          );
          await doc.update({ status: DOCUMENT_STATUSES.APPROVED }, { transaction });
        }
      }

      await transaction.commit();

      
      await logDocumentApproval(req, doc, version, decision, { comment });

      return approval;
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  



  async makeEffective(req, versionId) {
    const transaction = await sequelize.transaction();

    try {
      const version = await DocumentVersion.findByPk(versionId, {
        include: [{ model: Document, as: "document" }],
        transaction,
      });

      if (!version) throw new Error("Версия не найдена");
      if (version.status !== VERSION_STATUSES.APPROVED) {
        throw new Error("Только утверждённую версию можно ввести в действие");
      }

      const doc = version.document;

      
      if (doc.currentVersionId && doc.currentVersionId !== version.id) {
        const oldVersion = await DocumentVersion.findByPk(doc.currentVersionId, { transaction });
        if (oldVersion && oldVersion.status === VERSION_STATUSES.EFFECTIVE) {
          await oldVersion.update(
            {
              status: VERSION_STATUSES.SUPERSEDED,
              supersededAt: new Date(),
            },
            { transaction }
          );
        }
      }

      
      const now = new Date();
      await version.update(
        { status: VERSION_STATUSES.EFFECTIVE, effectiveAt: now },
        { transaction }
      );

      
      const nextReview = new Date(now);
      nextReview.setMonth(nextReview.getMonth() + (doc.reviewCycleMonths || 12));

      await doc.update(
        {
          status: DOCUMENT_STATUSES.EFFECTIVE,
          currentVersionId: version.id,
          effectiveDate: now,
          nextReviewDate: nextReview,
        },
        { transaction }
      );

      await transaction.commit();

      
      await logDocumentEffective(req, doc, version);

      return version;
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  



  async createNewVersion(req, documentId, { changeDescription }) {
    const transaction = await sequelize.transaction();

    try {
      const doc = await Document.findByPk(documentId, {
        include: [{ model: DocumentVersion, as: "versions" }],
        transaction,
      });

      if (!doc) throw new Error("Документ не найден");

      
      const existingDraft = doc.versions.find(
        (v) => v.status === VERSION_STATUSES.DRAFT || v.status === VERSION_STATUSES.REVIEW
      );
      if (existingDraft) {
        throw new Error(`Уже есть незавершённая версия: ${existingDraft.version} (${existingDraft.status})`);
      }

      const maxVersionNum = Math.max(...doc.versions.map((v) => v.versionNumber), 0);
      const newVersionNum = maxVersionNum + 1;

      const version = await DocumentVersion.create(
        {
          documentId: doc.id,
          version: `${newVersionNum}.0`,
          versionNumber: newVersionNum,
          status: VERSION_STATUSES.DRAFT,
          changeDescription: changeDescription || null,
          createdById: req.user.id,
        },
        { transaction }
      );

      
      if (doc.status === DOCUMENT_STATUSES.EFFECTIVE) {
        await doc.update({ status: DOCUMENT_STATUSES.REVISION }, { transaction });
      }

      await transaction.commit();

      
      await logAudit({
        req,
        action: AUDIT_ACTIONS.DOCUMENT_VERSION_CREATE,
        entity: "DocumentVersion",
        entityId: version.id,
        description: `Создана новая версия ${doc.code} v${version.version}`,
        metadata: { documentId: doc.id, changeDescription },
      });

      return version;
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  
  
  

  


  async distribute(req, versionId, userIds) {
    const version = await DocumentVersion.findByPk(versionId, {
      include: [{ model: Document, as: "document" }],
    });

    if (!version) throw new Error("Версия не найдена");
    if (version.status !== VERSION_STATUSES.EFFECTIVE) {
      throw new Error("Рассылка возможна только для действующей версии");
    }

    const distributions = [];
    for (const userId of userIds) {
      const [dist, created] = await DocumentDistribution.findOrCreate({
        where: { versionId, userId },
        defaults: { distributedAt: new Date() },
      });
      distributions.push(dist);
    }

    
    await logAudit({
      req,
      action: AUDIT_ACTIONS.DOCUMENT_DISTRIBUTE,
      entity: "Document",
      entityId: version.document.id,
      description: `Документ ${version.document.code} разослан ${userIds.length} сотрудникам`,
      metadata: { userIds, versionId },
    });

    return distributions;
  }

  


  async acknowledge(req, distributionId) {
    const dist = await DocumentDistribution.findByPk(distributionId);
    if (!dist) throw new Error("Запись рассылки не найдена");
    if (dist.userId !== req.user.id) throw new Error("Нельзя подтвердить за другого");
    if (dist.acknowledged) throw new Error("Уже подтверждено");

    await dist.update({
      acknowledged: true,
      acknowledgedAt: new Date(),
    });

    
    await logAudit({
      req,
      action: AUDIT_ACTIONS.DOCUMENT_ACKNOWLEDGE,
      entity: "DocumentDistribution",
      entityId: dist.id,
      description: `Подтверждено ознакомление с документом`,
      metadata: { versionId: dist.versionId },
    });

    return dist;
  }

  
  
  

  


  async getDocuments({ page = 1, limit = 20, status, type, category, search, ownerId }) {
    const where = {};
    if (status) where.status = status;
    if (type) where.type = type;
    if (category) where.category = category;
    if (ownerId) where.ownerId = ownerId;
    if (search) {
      where[Op.or] = [
        { title: { [Op.iLike]: `%${search}%` } },
        { code: { [Op.iLike]: `%${search}%` } },
        { description: { [Op.iLike]: `%${search}%` } },
      ];
    }

    return Document.findAndCountAll({
      where,
      include: [
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
        {
          model: DocumentVersion,
          as: "currentVersion",
          attributes: ["id", "version", "status", "effectiveAt"],
        },
      ],
      order: [["updatedAt", "DESC"]],
      limit: Math.min(limit, 100),
      offset: (page - 1) * limit,
    });
  }

  


  async getDocumentDetail(documentId) {
    return Document.findByPk(documentId, {
      include: [
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
        {
          model: DocumentVersion,
          as: "versions",
          order: [["versionNumber", "DESC"]],
          include: [
            { model: User, as: "createdBy", attributes: ["id", "name", "surname"] },
            { model: User, as: "approvedBy", attributes: ["id", "name", "surname"] },
            {
              model: DocumentApproval,
              as: "approvals",
              order: [["step", "ASC"]],
              include: [
                { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
              ],
            },
            {
              model: DocumentDistribution,
              as: "distributions",
              include: [
                { model: User, as: "user", attributes: ["id", "name", "surname"] },
              ],
            },
          ],
        },
      ],
    });
  }

  


  async getPendingApprovals(userId) {
    return DocumentApproval.findAll({
      where: {
        assignedToId: userId,
        decision: APPROVAL_DECISIONS.PENDING,
      },
      include: [
        {
          model: DocumentVersion,
          as: "version",
          include: [
            {
              model: Document,
              as: "document",
              attributes: ["id", "code", "title", "type"],
            },
            { model: User, as: "createdBy", attributes: ["id", "name", "surname"] },
          ],
        },
      ],
      order: [["dueDate", "ASC NULLS LAST"], ["createdAt", "ASC"]],
    });
  }

  


  async getOverdueReviews() {
    return Document.findAll({
      where: {
        status: DOCUMENT_STATUSES.EFFECTIVE,
        nextReviewDate: { [Op.lt]: new Date() },
      },
      include: [
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
      ],
      order: [["nextReviewDate", "ASC"]],
    });
  }

  


  async getStats() {
    const [byStatus, byType, overdueCount, pendingApprovalsCount] = await Promise.all([
      Document.findAll({
        attributes: ["status", [sequelize.fn("COUNT", "*"), "count"]],
        group: ["status"],
        raw: true,
      }),
      Document.findAll({
        attributes: ["type", [sequelize.fn("COUNT", "*"), "count"]],
        group: ["type"],
        raw: true,
      }),
      Document.count({
        where: {
          status: DOCUMENT_STATUSES.EFFECTIVE,
          nextReviewDate: { [Op.lt]: new Date() },
        },
      }),
      DocumentApproval.count({
        where: { decision: APPROVAL_DECISIONS.PENDING },
      }),
    ]);

    return { byStatus, byType, overdueCount, pendingApprovalsCount };
  }
}

module.exports = new DocumentService();

================================================================================
FILE: QMS-Server-master/modules/qms-equipment/controllers/equipmentController.js
================================================================================

const { Equipment, CalibrationRecord } = require("../models/Equipment");
const { User } = require("../../../models/index");
const { logAudit } = require("../../core/utils/auditLogger");
const { Op } = require("sequelize");





const getAll = async (req, res) => {
  try {
    const { type, status, overdue, page = 1, limit = 50 } = req.query;
    const where = {};
    if (type) where.type = type;
    if (status) where.status = status;
    if (overdue === "true") {
      where.nextCalibrationDate = { [Op.lt]: new Date() };
      where.status = { [Op.ne]: "DECOMMISSIONED" };
    }

    const offset = (page - 1) * limit;
    const { count, rows } = await Equipment.findAndCountAll({
      where,
      include: [
        { model: CalibrationRecord, as: "calibrations", limit: 1, order: [["calibrationDate", "DESC"]] },
        { model: User, as: "responsible", attributes: ["id", "name", "surname"] },
      ],
      order: [["name", "ASC"]],
      limit: parseInt(limit),
      offset,
    });
    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("Equipment getAll error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getOne = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const equipment = await Equipment.findByPk(id, {
      include: [
        { model: CalibrationRecord, as: "calibrations", order: [["calibrationDate", "DESC"]] },
        { model: User, as: "responsible", attributes: ["id", "name", "surname"] },
      ],
    });
    if (!equipment) return res.status(404).json({ error: "Equipment not found" });
    res.json(equipment);
  } catch (e) {
    console.error("Equipment getOne error:", e);
    res.status(500).json({ error: e.message });
  }
};

const create = async (req, res) => {
  try {
    const count = await Equipment.count();
    const inventoryNumber = `EQ-${String(count + 1).padStart(4, "0")}`;

    const equipment = await Equipment.create({ ...req.body, inventoryNumber });
    await logAudit(req, "equipment.create", "equipment", equipment.id, { inventoryNumber, name: equipment.name });
    res.status(201).json(equipment);
  } catch (e) {
    console.error("Equipment create error:", e);
    res.status(500).json({ error: e.message });
  }
};

const update = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const equipment = await Equipment.findByPk(id);
    if (!equipment) return res.status(404).json({ error: "Equipment not found" });

    await equipment.update(req.body);
    await logAudit(req, "equipment.update", "equipment", equipment.id, req.body);
    res.json(equipment);
  } catch (e) {
    console.error("Equipment update error:", e);
    res.status(500).json({ error: e.message });
  }
};





const addCalibration = async (req, res) => {
  try {
    const equipmentId = parseInt(req.params.id);
    if (isNaN(equipmentId)) return res.status(400).json({ error: "Invalid ID" });

    const equipment = await Equipment.findByPk(equipmentId);
    if (!equipment) return res.status(404).json({ error: "Equipment not found" });

    const record = await CalibrationRecord.create({
      ...req.body,
      equipmentId,
      performedById: req.user?.id || 1,
    });

    
    if (record.calibrationDate) {
      equipment.lastCalibrationDate = record.calibrationDate;
    }
    if (record.nextCalibrationDate) {
      equipment.nextCalibrationDate = record.nextCalibrationDate;
    }
    if (record.result === "FAIL" || record.result === "OUT_OF_TOLERANCE") {
      equipment.status = "OUT_OF_SERVICE";
    } else {
      equipment.status = "IN_SERVICE";
    }
    await equipment.save();

    await logAudit(req, "equipment.calibrate", "calibration", record.id, {
      equipmentId,
      result: record.result,
    });
    res.status(201).json(record);
  } catch (e) {
    console.error("Equipment addCalibration error:", e);
    res.status(500).json({ error: e.message });
  }
};

const updateCalibration = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const record = await CalibrationRecord.findByPk(id);
    if (!record) return res.status(404).json({ error: "Calibration record not found" });

    await record.update(req.body);
    await logAudit(req, "equipment.calibration.update", "calibration", record.id, req.body);
    res.json(record);
  } catch (e) {
    console.error("Equipment updateCalibration error:", e);
    res.status(500).json({ error: e.message });
  }
};





const getStats = async (req, res) => {
  try {
    const total = await Equipment.count();
    const inService = await Equipment.count({ where: { status: "IN_SERVICE" } });
    const outOfService = await Equipment.count({ where: { status: "OUT_OF_SERVICE" } });
    const inCalibration = await Equipment.count({ where: { status: "IN_CALIBRATION" } });
    const overdue = await Equipment.count({
      where: {
        nextCalibrationDate: { [Op.lt]: new Date() },
        status: { [Op.ne]: "DECOMMISSIONED" },
      },
    });
    const decommissioned = await Equipment.count({ where: { status: "DECOMMISSIONED" } });
    const totalCalibrations = await CalibrationRecord.count();

    res.json({ total, inService, outOfService, inCalibration, overdue, decommissioned, totalCalibrations });
  } catch (e) {
    console.error("Equipment getStats error:", e);
    res.status(500).json({ error: e.message });
  }
};

module.exports = {
  getAll, getOne, create, update, getStats,
  addCalibration, updateCalibration,
};

================================================================================
FILE: QMS-Server-master/modules/qms-equipment/index.js
================================================================================

module.exports = {
  code: 'qms.equipment',

  register(router) {
    router.use('/equipment', require('./routes/equipmentRouter'));
  },

  getModels() { return require('./models/Equipment'); },

  setupAssociations(m) {
    if (m.Equipment && m.User) {
      m.User.hasMany(m.Equipment, { as: 'responsibleEquipment', foreignKey: 'responsibleId' });
      m.Equipment.belongsTo(m.User, { as: 'responsible', foreignKey: 'responsibleId' });
    }
  },
};

================================================================================
FILE: QMS-Server-master/modules/qms-equipment/models/Equipment.js
================================================================================

const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");





const Equipment = sequelize.define("equipment", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  inventoryNumber: { type: DataTypes.STRING, unique: true, allowNull: false, comment: "Инвентарный номер" },
  name: { type: DataTypes.STRING, allowNull: false },
  manufacturer: { type: DataTypes.STRING },
  model: { type: DataTypes.STRING },
  serialNumber: { type: DataTypes.STRING, allowNull: true },
  
  type: {
    type: DataTypes.ENUM(
      "MEASURING",       
      "TEST",            
      "PRODUCTION",      
      "MONITORING",      
      "IT"               
    ),
    allowNull: false
  },
  
  
  location: { type: DataTypes.STRING, comment: "Участок/цех/помещение" },
  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  
  
  measuringRange: { type: DataTypes.STRING, allowNull: true, comment: "Диапазон измерений" },
  accuracy: { type: DataTypes.STRING, allowNull: true, comment: "Точность/погрешность" },
  resolution: { type: DataTypes.STRING, allowNull: true },
  
  
  calibrationType: { type: DataTypes.ENUM("VERIFICATION", "CALIBRATION", "VALIDATION", "NONE"), defaultValue: "NONE" },
  calibrationInterval: { type: DataTypes.INTEGER, allowNull: true, comment: "Интервал в месяцах" },
  lastCalibrationDate: { type: DataTypes.DATE, allowNull: true },
  nextCalibrationDate: { type: DataTypes.DATE, allowNull: true },
  
  
  status: {
    type: DataTypes.ENUM("IN_SERVICE", "OUT_OF_SERVICE", "IN_CALIBRATION", "OVERDUE", "DECOMMISSIONED"),
    defaultValue: "IN_SERVICE"
  },
  
  commissionedDate: { type: DataTypes.DATE, allowNull: true },
  decommissionedDate: { type: DataTypes.DATE, allowNull: true },
  decommissionReason: { type: DataTypes.TEXT, allowNull: true },
  
  certificateUrl: { type: DataTypes.STRING, allowNull: true },
  notes: { type: DataTypes.TEXT },
});

const CalibrationRecord = sequelize.define("calibration_record", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  equipmentId: { type: DataTypes.INTEGER, allowNull: false },
  
  calibrationDate: { type: DataTypes.DATE, allowNull: false },
  performedBy: { type: DataTypes.STRING, comment: "Организация-исполнитель или сотрудник" },
  performedById: { type: DataTypes.INTEGER, allowNull: true },
  
  type: { type: DataTypes.ENUM("VERIFICATION", "CALIBRATION", "ADJUSTMENT"), allowNull: false },
  
  
  result: { type: DataTypes.ENUM("PASS", "FAIL", "ADJUSTED", "OUT_OF_TOLERANCE"), allowNull: false },
  
  measuredValues: { type: DataTypes.JSON, allowNull: true, comment: "Измеренные значения: [{reference, measured, deviation}]" },
  
  certificateNumber: { type: DataTypes.STRING, allowNull: true },
  certificateUrl: { type: DataTypes.STRING, allowNull: true },
  
  nextCalibrationDate: { type: DataTypes.DATE, allowNull: true },
  
  
  impactAssessment: { type: DataTypes.TEXT, allowNull: true, comment: "Оценка влияния на ранее произведённую продукцию" },
  ncCreated: { type: DataTypes.BOOLEAN, defaultValue: false, comment: "Создано ли NC при провале" },
  nonconformityId: { type: DataTypes.INTEGER, allowNull: true },
  
  notes: { type: DataTypes.TEXT },
});


Equipment.hasMany(CalibrationRecord, { as: "calibrations", foreignKey: "equipmentId" });
CalibrationRecord.belongsTo(Equipment, { foreignKey: "equipmentId" });

module.exports = { Equipment, CalibrationRecord };

================================================================================
FILE: QMS-Server-master/modules/qms-equipment/routes/equipmentRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const ctrl = require("../controllers/equipmentController");
const authMiddleware = require("../../core/middleware/authMiddleware");
const syncUserMiddleware = require("../../core/middleware/syncUserMiddleware");
const checkAbility = require("../../core/middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/stats", ...protect, checkAbility("equipment.read"), ctrl.getStats);


router.get("/",      ...protect, checkAbility("equipment.read"),      ctrl.getAll);
router.get("/:id",   ...protect, checkAbility("equipment.read"),      ctrl.getOne);
router.post("/",     ...protect, checkAbility("equipment.calibrate"), ctrl.create);
router.put("/:id",   ...protect, checkAbility("equipment.calibrate"), ctrl.update);


router.post("/:id/calibrations",  ...protect, checkAbility("equipment.calibrate"), ctrl.addCalibration);
router.put("/calibrations/:id",   ...protect, checkAbility("equipment.calibrate"), ctrl.updateCalibration);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/qms-nc/controllers/ncCapaController.js
================================================================================






const ApiError = require("../../../error/ApiError");
const NcCapaService = require("../services/NcCapaService");

class NcCapaController {
  
  async getNcList(req, res, next) {
    try {
      const result = await NcCapaService.getNCList(req.query);
      return res.json(result);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async getNcOne(req, res, next) {
    try {
      const id = Number(req.params.id);
      if (isNaN(id)) return next(ApiError.badRequest("Некорректный ID"));
      const nc = await NcCapaService.getNCDetail(id);
      if (!nc) return next(ApiError.notFound("NC не найдена"));
      return res.json(nc);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async createNc(req, res, next) {
    try {
      const nc = await NcCapaService.createNC(req, req.body);
      return res.status(201).json(nc);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async updateNc(req, res, next) {
    try {
      const id = Number(req.params.id);
      if (isNaN(id)) return next(ApiError.badRequest("Некорректный ID"));
      const nc = await NcCapaService.updateNC(req, id, req.body);
      return res.json(nc);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async closeNc(req, res, next) {
    try {
      const id = Number(req.params.id);
      if (isNaN(id)) return next(ApiError.badRequest("Некорректный ID"));
      const nc = await NcCapaService.closeNC(req, id, req.body);
      return res.json(nc);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  
  async getCapaList(req, res, next) {
    try {
      const result = await NcCapaService.getCAPAList(req.query);
      return res.json(result);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async getCapaOne(req, res, next) {
    try {
      const id = Number(req.params.id);
      if (isNaN(id)) return next(ApiError.badRequest("Некорректный ID"));
      const capa = await NcCapaService.getCAPADetail(id);
      if (!capa) return next(ApiError.notFound("CAPA не найдена"));
      return res.json(capa);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async createCapa(req, res, next) {
    try {
      const capa = await NcCapaService.createCAPA(req, req.body);
      return res.status(201).json(capa);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async updateCapaStatus(req, res, next) {
    try {
      const id = Number(req.params.id);
      if (isNaN(id)) return next(ApiError.badRequest("Некорректный ID"));
      const capa = await NcCapaService.updateCAPAStatus(req, id, req.body);
      return res.json(capa);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async addCapaAction(req, res, next) {
    try {
      const id = Number(req.params.id);
      if (isNaN(id)) return next(ApiError.badRequest("Некорректный ID"));
      const action = await NcCapaService.addCapaAction(req, id, req.body);
      return res.status(201).json(action);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async updateCapaAction(req, res, next) {
    try {
      const id = Number(req.params.id);
      if (isNaN(id)) return next(ApiError.badRequest("Некорректный ID"));
      const action = await NcCapaService.updateCapaAction(req, id, req.body);
      return res.json(action);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  async verifyEffectiveness(req, res, next) {
    try {
      const id = Number(req.params.id);
      if (isNaN(id)) return next(ApiError.badRequest("Некорректный ID"));
      const v = await NcCapaService.verifyCapaEffectiveness(req, id, req.body);
      return res.json(v);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }

  
  async getStats(req, res, next) {
    try {
      const stats = await NcCapaService.getStats();
      return res.json(stats);
    } catch (e) { next(ApiError.badRequest(e.message)); }
  }
}

module.exports = new NcCapaController();

================================================================================
FILE: QMS-Server-master/modules/qms-nc/index.js
================================================================================

module.exports = {
  code: 'qms.nc',

  register(router) {
    router.use('/nc', require('./routes/ncCapaRouter'));
  },

  getModels() {
    return require('./models/NcCapa');
  },

  setupAssociations(m) {
    const { setupNcCapaAssociations } = require('./models/NcCapa');
    if (typeof setupNcCapaAssociations === 'function') {
      setupNcCapaAssociations(m);
    }
  },
};

================================================================================
FILE: QMS-Server-master/modules/qms-nc/models/NcCapa.js
================================================================================







const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");



const NC_SOURCES = {
  INCOMING_INSPECTION: "INCOMING_INSPECTION",
  IN_PROCESS: "IN_PROCESS",
  FINAL_INSPECTION: "FINAL_INSPECTION",
  CUSTOMER_COMPLAINT: "CUSTOMER_COMPLAINT",
  INTERNAL_AUDIT: "INTERNAL_AUDIT",
  EXTERNAL_AUDIT: "EXTERNAL_AUDIT",
  SUPPLIER: "SUPPLIER",
  FIELD_RETURN: "FIELD_RETURN",
  OTHER: "OTHER",
};

const NC_CLASSIFICATIONS = { CRITICAL: "CRITICAL", MAJOR: "MAJOR", MINOR: "MINOR" };

const NC_STATUSES = {
  OPEN: "OPEN", INVESTIGATING: "INVESTIGATING", DISPOSITION: "DISPOSITION",
  IMPLEMENTING: "IMPLEMENTING", VERIFICATION: "VERIFICATION", CLOSED: "CLOSED", REOPENED: "REOPENED",
};

const NC_DISPOSITIONS = {
  USE_AS_IS: "USE_AS_IS", REWORK: "REWORK", REPAIR: "REPAIR", SCRAP: "SCRAP",
  RETURN_TO_SUPPLIER: "RETURN_TO_SUPPLIER", CONCESSION: "CONCESSION", OTHER: "OTHER",
};

const CAPA_TYPES = { CORRECTIVE: "CORRECTIVE", PREVENTIVE: "PREVENTIVE" };
const CAPA_STATUSES = {
  INITIATED: "INITIATED", INVESTIGATING: "INVESTIGATING", PLANNING: "PLANNING",
  PLAN_APPROVED: "PLAN_APPROVED", IMPLEMENTING: "IMPLEMENTING", VERIFYING: "VERIFYING",
  EFFECTIVE: "EFFECTIVE", INEFFECTIVE: "INEFFECTIVE", CLOSED: "CLOSED",
};
const CAPA_PRIORITIES = { LOW: "LOW", MEDIUM: "MEDIUM", HIGH: "HIGH", URGENT: "URGENT" };
const CAPA_ACTION_STATUSES = { PLANNED: "PLANNED", IN_PROGRESS: "IN_PROGRESS", COMPLETED: "COMPLETED", CANCELLED: "CANCELLED" };



const Nonconformity = sequelize.define("nonconformity", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  number: { type: DataTypes.STRING(20), allowNull: false, unique: true },
  title: { type: DataTypes.STRING(500), allowNull: false },
  description: { type: DataTypes.TEXT, allowNull: false },
  source: { type: DataTypes.ENUM(...Object.values(NC_SOURCES)), allowNull: false },
  classification: { type: DataTypes.ENUM(...Object.values(NC_CLASSIFICATIONS)), allowNull: false, defaultValue: "MINOR" },
  status: { type: DataTypes.ENUM(...Object.values(NC_STATUSES)), allowNull: false, defaultValue: "OPEN" },
  disposition: { type: DataTypes.ENUM(...Object.values(NC_DISPOSITIONS)), allowNull: true },
  dispositionJustification: { type: DataTypes.TEXT, allowNull: true },
  productType: { type: DataTypes.STRING(100), allowNull: true },
  productSerialNumber: { type: DataTypes.STRING(100), allowNull: true },
  lotNumber: { type: DataTypes.STRING(100), allowNull: true },
  processName: { type: DataTypes.STRING(200), allowNull: true },
  supplierName: { type: DataTypes.STRING(200), allowNull: true },
  warehouseBoxId: { type: DataTypes.INTEGER, allowNull: true },
  documentId: { type: DataTypes.INTEGER, allowNull: true },
  totalQty: { type: DataTypes.INTEGER, allowNull: true },
  defectQty: { type: DataTypes.INTEGER, allowNull: true },
  rootCause: { type: DataTypes.TEXT, allowNull: true },
  rootCauseMethod: { type: DataTypes.STRING(50), allowNull: true },
  immediateAction: { type: DataTypes.TEXT, allowNull: true },
  reportedById: { type: DataTypes.INTEGER, allowNull: false },
  assignedToId: { type: DataTypes.INTEGER, allowNull: true },
  closedById: { type: DataTypes.INTEGER, allowNull: true },
  detectedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  dueDate: { type: DataTypes.DATEONLY, allowNull: true },
  closedAt: { type: DataTypes.DATE, allowNull: true },
  capaRequired: { type: DataTypes.BOOLEAN, allowNull: false, defaultValue: false },
});

const NcAttachment = sequelize.define("nc_attachment", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  nonconformityId: { type: DataTypes.INTEGER, allowNull: false },
  fileUrl: { type: DataTypes.STRING(1000), allowNull: false },
  fileName: { type: DataTypes.STRING(500), allowNull: false },
  fileSize: { type: DataTypes.INTEGER, allowNull: true },
  fileMimeType: { type: DataTypes.STRING(100), allowNull: true },
  description: { type: DataTypes.STRING(500), allowNull: true },
  uploadedById: { type: DataTypes.INTEGER, allowNull: false },
});

const Capa = sequelize.define("capa", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  number: { type: DataTypes.STRING(20), allowNull: false, unique: true },
  type: { type: DataTypes.ENUM(...Object.values(CAPA_TYPES)), allowNull: false },
  title: { type: DataTypes.STRING(500), allowNull: false },
  description: { type: DataTypes.TEXT, allowNull: true },
  status: { type: DataTypes.ENUM(...Object.values(CAPA_STATUSES)), allowNull: false, defaultValue: "INITIATED" },
  priority: { type: DataTypes.ENUM(...Object.values(CAPA_PRIORITIES)), allowNull: false, defaultValue: "MEDIUM" },
  nonconformityId: { type: DataTypes.INTEGER, allowNull: true },
  rootCauseAnalysis: { type: DataTypes.TEXT, allowNull: true },
  rootCauseMethod: { type: DataTypes.STRING(50), allowNull: true },
  initiatedById: { type: DataTypes.INTEGER, allowNull: false },
  assignedToId: { type: DataTypes.INTEGER, allowNull: true },
  approvedById: { type: DataTypes.INTEGER, allowNull: true },
  dueDate: { type: DataTypes.DATEONLY, allowNull: true },
  planApprovedAt: { type: DataTypes.DATE, allowNull: true },
  implementedAt: { type: DataTypes.DATE, allowNull: true },
  closedAt: { type: DataTypes.DATE, allowNull: true },
  effectivenessCheckDate: { type: DataTypes.DATEONLY, allowNull: true },
  effectivenessCheckDays: { type: DataTypes.INTEGER, allowNull: true, defaultValue: 90 },
});

const CapaAction = sequelize.define("capa_action", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  capaId: { type: DataTypes.INTEGER, allowNull: false },
  order: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 1 },
  description: { type: DataTypes.TEXT, allowNull: false },
  assignedToId: { type: DataTypes.INTEGER, allowNull: true },
  status: { type: DataTypes.ENUM(...Object.values(CAPA_ACTION_STATUSES)), allowNull: false, defaultValue: "PLANNED" },
  dueDate: { type: DataTypes.DATEONLY, allowNull: true },
  completedAt: { type: DataTypes.DATE, allowNull: true },
  result: { type: DataTypes.TEXT, allowNull: true },
});

const CapaVerification = sequelize.define("capa_verification", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  capaId: { type: DataTypes.INTEGER, allowNull: false },
  verifiedById: { type: DataTypes.INTEGER, allowNull: false },
  isEffective: { type: DataTypes.BOOLEAN, allowNull: false },
  evidence: { type: DataTypes.TEXT, allowNull: true },
  comment: { type: DataTypes.TEXT, allowNull: true },
  verifiedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
});



function setupNcCapaAssociations({ User, Document }) {
  
  Nonconformity.belongsTo(User, { foreignKey: "reportedById", as: "reportedBy" });
  Nonconformity.belongsTo(User, { foreignKey: "assignedToId", as: "assignedTo" });
  Nonconformity.belongsTo(User, { foreignKey: "closedById", as: "closedBy" });

  
  Nonconformity.hasMany(NcAttachment, { foreignKey: "nonconformityId", as: "attachments", onDelete: "CASCADE" });
  NcAttachment.belongsTo(Nonconformity, { foreignKey: "nonconformityId", as: "nonconformity" });
  NcAttachment.belongsTo(User, { foreignKey: "uploadedById", as: "uploadedBy" });

  
  Nonconformity.hasMany(Capa, { foreignKey: "nonconformityId", as: "capas" });
  Capa.belongsTo(Nonconformity, { foreignKey: "nonconformityId", as: "nonconformity" });

  
  if (Document) {
    Nonconformity.belongsTo(Document, { foreignKey: "documentId", as: "document" });
  }

  
  Capa.belongsTo(User, { foreignKey: "initiatedById", as: "initiatedBy" });
  Capa.belongsTo(User, { foreignKey: "assignedToId", as: "assignedTo" });
  Capa.belongsTo(User, { foreignKey: "approvedById", as: "approvedBy" });

  
  Capa.hasMany(CapaAction, { foreignKey: "capaId", as: "actions", onDelete: "CASCADE" });
  CapaAction.belongsTo(Capa, { foreignKey: "capaId", as: "capa" });
  CapaAction.belongsTo(User, { foreignKey: "assignedToId", as: "assignedTo" });

  
  Capa.hasMany(CapaVerification, { foreignKey: "capaId", as: "verifications", onDelete: "CASCADE" });
  CapaVerification.belongsTo(Capa, { foreignKey: "capaId", as: "capa" });
  CapaVerification.belongsTo(User, { foreignKey: "verifiedById", as: "verifiedBy" });
}

module.exports = {
  Nonconformity, NcAttachment, Capa, CapaAction, CapaVerification,
  setupNcCapaAssociations,
  NC_SOURCES, NC_CLASSIFICATIONS, NC_STATUSES, NC_DISPOSITIONS,
  CAPA_TYPES, CAPA_STATUSES, CAPA_PRIORITIES, CAPA_ACTION_STATUSES,
};

================================================================================
FILE: QMS-Server-master/modules/qms-nc/routes/ncCapaRouter.js
================================================================================









const Router = require("express");
const router = new Router();
const ctrl = require("../controllers/ncCapaController");
const authMiddleware = require("../../core/middleware/authMiddleware");
const syncUserMiddleware = require("../../core/middleware/syncUserMiddleware");
const checkAbility = require("../../core/middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/stats", ...protect, checkAbility("nc.view"), ctrl.getStats);


router.get("/capa",             ...protect, checkAbility("capa.view"),   ctrl.getCapaList);
router.get("/capa/:id",         ...protect, checkAbility("capa.view"),   ctrl.getCapaOne);
router.post("/capa",            ...protect, checkAbility("capa.create"), ctrl.createCapa);
router.put("/capa/:id/status",  ...protect, checkAbility("capa.manage"), ctrl.updateCapaStatus);
router.post("/capa/:id/actions",...protect, checkAbility("capa.manage"), ctrl.addCapaAction);
router.put("/capa/actions/:id", ...protect, checkAbility("capa.manage"), ctrl.updateCapaAction);
router.post("/capa/:id/verify", ...protect, checkAbility("capa.verify"), ctrl.verifyEffectiveness);


router.get("/",          ...protect, checkAbility("nc.view"),   ctrl.getNcList);
router.get("/:id",       ...protect, checkAbility("nc.view"),   ctrl.getNcOne);
router.post("/",         ...protect, checkAbility("nc.create"), ctrl.createNc);
router.put("/:id",       ...protect, checkAbility("nc.manage"), ctrl.updateNc);
router.post("/:id/close",...protect, checkAbility("nc.manage"), ctrl.closeNc);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/qms-nc/services/NcCapaService.js
================================================================================






const { Op } = require("sequelize");
const sequelize = require("../../../db");
const {
  Nonconformity, NcAttachment, Capa, CapaAction, CapaVerification,
  NC_STATUSES, CAPA_STATUSES,
} = require("../models/NcCapa");
const { User } = require("../../../models/index");
const { logNonconformity, logCapa } = require("../../core/utils/auditLogger");

class NcCapaService {
  

  async createNC(req, data) {
    const t = await sequelize.transaction();
    try {
      const lastNc = await Nonconformity.findOne({ order: [["id", "DESC"]], attributes: ["id"], transaction: t });
      const num = (lastNc?.id || 0) + 1;
      const number = `NC-${String(num).padStart(4, "0")}`;

      
      const capaRequired = data.classification === "CRITICAL" ? true : (data.capaRequired || false);

      const nc = await Nonconformity.create({
        ...data,
        number,
        status: NC_STATUSES.OPEN,
        reportedById: req.user.id,
        detectedAt: data.detectedAt || new Date(),
        capaRequired,
      }, { transaction: t });

      await t.commit();
      await logNonconformity(req, nc, "create");
      return nc;
    } catch (e) { await t.rollback(); throw e; }
  }

  async updateNC(req, id, data) {
    const nc = await Nonconformity.findByPk(id);
    if (!nc) throw new Error("NC не найдена");
    if (nc.status === NC_STATUSES.CLOSED) throw new Error("Нельзя редактировать закрытую NC");

    const oldStatus = nc.status;
    await nc.update(data);

    if (data.status && data.status !== oldStatus) {
      const actionMap = {
        INVESTIGATING: "investigate",
        DISPOSITION: "disposition",
        CLOSED: "close",
        REOPENED: "reopen",
      };
      await logNonconformity(req, nc, actionMap[data.status] || "update");
    } else {
      await logNonconformity(req, nc, "update");
    }

    return nc;
  }

  async closeNC(req, id, { closingComment }) {
    const t = await sequelize.transaction();
    try {
      const nc = await Nonconformity.findByPk(id, { transaction: t });
      if (!nc) throw new Error("NC не найдена");

      
      if (nc.capaRequired) {
        const openCapas = await Capa.count({
          where: { nonconformityId: id, status: { [Op.notIn]: ["CLOSED", "EFFECTIVE"] } },
          transaction: t,
        });
        if (openCapas > 0) throw new Error(`Невозможно закрыть: ${openCapas} CAPA ещё не завершены`);
      }

      await nc.update({
        status: NC_STATUSES.CLOSED,
        closedById: req.user.id,
        closedAt: new Date(),
      }, { transaction: t });

      await t.commit();
      await logNonconformity(req, nc, "close", { closingComment });
      return nc;
    } catch (e) { await t.rollback(); throw e; }
  }

  async getNCList({ page = 1, limit = 20, status, source, classification, assignedToId, search, dateFrom, dateTo }) {
    const where = {};
    if (status) where.status = status;
    if (source) where.source = source;
    if (classification) where.classification = classification;
    if (assignedToId) where.assignedToId = assignedToId;
    if (search) {
      where[Op.or] = [
        { number: { [Op.iLike]: `%${search}%` } },
        { title: { [Op.iLike]: `%${search}%` } },
        { description: { [Op.iLike]: `%${search}%` } },
      ];
    }
    if (dateFrom || dateTo) {
      where.detectedAt = {};
      if (dateFrom) where.detectedAt[Op.gte] = new Date(dateFrom);
      if (dateTo) where.detectedAt[Op.lte] = new Date(dateTo);
    }

    return Nonconformity.findAndCountAll({
      where,
      include: [
        { model: User, as: "reportedBy", attributes: ["id", "name", "surname"] },
        { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
      ],
      order: [["detectedAt", "DESC"]],
      limit: Math.min(limit, 100),
      offset: (page - 1) * limit,
    });
  }

  async getNCDetail(id) {
    return Nonconformity.findByPk(id, {
      include: [
        { model: User, as: "reportedBy", attributes: ["id", "name", "surname"] },
        { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
        { model: User, as: "closedBy", attributes: ["id", "name", "surname"] },
        { model: NcAttachment, as: "attachments", include: [{ model: User, as: "uploadedBy", attributes: ["id", "name", "surname"] }] },
        {
          model: Capa, as: "capas",
          attributes: ["id", "number", "type", "status", "title", "dueDate"],
          include: [{ model: User, as: "assignedTo", attributes: ["id", "name", "surname"] }],
        },
      ],
    });
  }

  

  async createCAPA(req, data) {
    const t = await sequelize.transaction();
    try {
      const lastCapa = await Capa.findOne({ order: [["id", "DESC"]], attributes: ["id"], transaction: t });
      const num = (lastCapa?.id || 0) + 1;
      const number = `CAPA-${String(num).padStart(4, "0")}`;

      
      let effectivenessCheckDate = null;
      const checkDays = data.effectivenessCheckDays || 90;
      if (data.dueDate) {
        const d = new Date(data.dueDate);
        d.setDate(d.getDate() + checkDays);
        effectivenessCheckDate = d;
      }

      const capa = await Capa.create({
        ...data,
        number,
        status: CAPA_STATUSES.INITIATED,
        initiatedById: req.user.id,
        effectivenessCheckDate,
        effectivenessCheckDays: checkDays,
      }, { transaction: t });

      
      if (data.actions?.length) {
        for (let i = 0; i < data.actions.length; i++) {
          await CapaAction.create({
            capaId: capa.id,
            order: i + 1,
            ...data.actions[i],
          }, { transaction: t });
        }
      }

      await t.commit();
      await logCapa(req, capa, "create");
      return capa;
    } catch (e) { await t.rollback(); throw e; }
  }

  async updateCAPAStatus(req, id, { status, comment }) {
    const capa = await Capa.findByPk(id);
    if (!capa) throw new Error("CAPA не найдена");

    const updates = { status };
    const actionMap = {
      PLAN_APPROVED: "planApprove",
      IMPLEMENTING: "implement",
      VERIFYING: "verify",
      CLOSED: "close",
    };

    if (status === "PLAN_APPROVED") {
      updates.approvedById = req.user.id;
      updates.planApprovedAt = new Date();
    } else if (status === "IMPLEMENTING") {
      updates.implementedAt = new Date();
    } else if (status === "CLOSED") {
      updates.closedAt = new Date();
    }

    await capa.update(updates);
    await logCapa(req, capa, actionMap[status] || "update", { comment });
    return capa;
  }

  async addCapaAction(req, capaId, data) {
    const capa = await Capa.findByPk(capaId);
    if (!capa) throw new Error("CAPA не найдена");

    const maxOrder = await CapaAction.max("order", { where: { capaId } }) || 0;
    return CapaAction.create({ capaId, order: maxOrder + 1, ...data });
  }

  async updateCapaAction(req, actionId, data) {
    const action = await CapaAction.findByPk(actionId);
    if (!action) throw new Error("Действие не найдено");
    if (data.status === "COMPLETED") data.completedAt = new Date();
    return action.update(data);
  }

  async verifyCapaEffectiveness(req, capaId, { isEffective, evidence, comment }) {
    const t = await sequelize.transaction();
    try {
      const capa = await Capa.findByPk(capaId, { transaction: t });
      if (!capa) throw new Error("CAPA не найдена");

      const verification = await CapaVerification.create({
        capaId,
        verifiedById: req.user.id,
        isEffective,
        evidence,
        comment,
      }, { transaction: t });

      await capa.update({
        status: isEffective ? CAPA_STATUSES.EFFECTIVE : CAPA_STATUSES.INEFFECTIVE,
      }, { transaction: t });

      await t.commit();
      await logCapa(req, capa, "effectivenessCheck", { isEffective });
      return verification;
    } catch (e) { await t.rollback(); throw e; }
  }

  async getCAPAList({ page = 1, limit = 20, status, type, priority, assignedToId, search }) {
    const where = {};
    if (status) where.status = status;
    if (type) where.type = type;
    if (priority) where.priority = priority;
    if (assignedToId) where.assignedToId = assignedToId;
    if (search) {
      where[Op.or] = [
        { number: { [Op.iLike]: `%${search}%` } },
        { title: { [Op.iLike]: `%${search}%` } },
      ];
    }

    return Capa.findAndCountAll({
      where,
      include: [
        { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
        { model: User, as: "initiatedBy", attributes: ["id", "name", "surname"] },
        { model: Nonconformity, as: "nonconformity", attributes: ["id", "number", "title", "classification"] },
      ],
      order: [["createdAt", "DESC"]],
      limit: Math.min(limit, 100),
      offset: (page - 1) * limit,
    });
  }

  async getCAPADetail(id) {
    return Capa.findByPk(id, {
      include: [
        { model: User, as: "initiatedBy", attributes: ["id", "name", "surname"] },
        { model: User, as: "assignedTo", attributes: ["id", "name", "surname"] },
        { model: User, as: "approvedBy", attributes: ["id", "name", "surname"] },
        { model: Nonconformity, as: "nonconformity" },
        {
          model: CapaAction, as: "actions", order: [["order", "ASC"]],
          include: [{ model: User, as: "assignedTo", attributes: ["id", "name", "surname"] }],
        },
        {
          model: CapaVerification, as: "verifications", order: [["verifiedAt", "DESC"]],
          include: [{ model: User, as: "verifiedBy", attributes: ["id", "name", "surname"] }],
        },
      ],
    });
  }

  

  async getStats() {
    const [ncByStatus, ncBySource, ncByClassification, capaByStatus, capaByType, overdueNc, overdueCapa] = await Promise.all([
      Nonconformity.findAll({ attributes: ["status", [sequelize.fn("COUNT", "*"), "count"]], group: ["status"], raw: true }),
      Nonconformity.findAll({ attributes: ["source", [sequelize.fn("COUNT", "*"), "count"]], group: ["source"], raw: true }),
      Nonconformity.findAll({ attributes: ["classification", [sequelize.fn("COUNT", "*"), "count"]], group: ["classification"], raw: true }),
      Capa.findAll({ attributes: ["status", [sequelize.fn("COUNT", "*"), "count"]], group: ["status"], raw: true }),
      Capa.findAll({ attributes: ["type", [sequelize.fn("COUNT", "*"), "count"]], group: ["type"], raw: true }),
      Nonconformity.count({ where: { status: { [Op.notIn]: ["CLOSED"] }, dueDate: { [Op.lt]: new Date() } } }),
      Capa.count({ where: { status: { [Op.notIn]: ["CLOSED", "EFFECTIVE"] }, dueDate: { [Op.lt]: new Date() } } }),
    ]);

    return { ncByStatus, ncBySource, ncByClassification, capaByStatus, capaByType, overdueNc, overdueCapa };
  }
}

module.exports = new NcCapaService();

================================================================================
FILE: QMS-Server-master/modules/qms-review/controllers/reviewController.js
================================================================================

const { ManagementReview, ReviewAction } = require("../models/ManagementReview");
const { User } = require("../../../models/index");
const { logAudit } = require("../../core/utils/auditLogger");





const getAll = async (req, res) => {
  try {
    const { year, status, page = 1, limit = 20 } = req.query;
    const where = {};
    if (year) {
      const { Op } = require("sequelize");
      where.reviewDate = {
        [Op.gte]: new Date(`${year}-01-01`),
        [Op.lte]: new Date(`${year}-12-31`),
      };
    }
    if (status) where.status = status;

    const offset = (page - 1) * limit;
    const { count, rows } = await ManagementReview.findAndCountAll({
      where,
      include: [{ model: ReviewAction, as: "actions" }],
      order: [["reviewDate", "DESC"]],
      limit: parseInt(limit),
      offset,
    });
    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("ManagementReview getAll error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getOne = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const review = await ManagementReview.findByPk(id, {
      include: [{ model: ReviewAction, as: "actions" }],
    });
    if (!review) return res.status(404).json({ error: "Review not found" });
    res.json(review);
  } catch (e) {
    console.error("ManagementReview getOne error:", e);
    res.status(500).json({ error: e.message });
  }
};

const create = async (req, res) => {
  try {
    const year = new Date().getFullYear();
    const count = await ManagementReview.count();
    const reviewNumber = `MR-${year}-${String(count + 1).padStart(2, "0")}`;

    const review = await ManagementReview.create({
      ...req.body,
      reviewNumber,
      chairpersonId: req.body.chairpersonId || req.user?.id || 1,
    });
    await logAudit(req, "management_review.create", "management_review", review.id, { reviewNumber });
    res.status(201).json(review);
  } catch (e) {
    console.error("ManagementReview create error:", e);
    res.status(500).json({ error: e.message });
  }
};

const update = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const review = await ManagementReview.findByPk(id);
    if (!review) return res.status(404).json({ error: "Review not found" });

    await review.update(req.body);
    await logAudit(req, "management_review.update", "management_review", review.id, req.body);
    res.json(review);
  } catch (e) {
    console.error("ManagementReview update error:", e);
    res.status(500).json({ error: e.message });
  }
};





const addAction = async (req, res) => {
  try {
    const reviewId = parseInt(req.params.id);
    if (isNaN(reviewId)) return res.status(400).json({ error: "Invalid ID" });

    const review = await ManagementReview.findByPk(reviewId);
    if (!review) return res.status(404).json({ error: "Review not found" });

    const action = await ReviewAction.create({
      ...req.body,
      managementReviewId: reviewId,
    });
    await logAudit(req, "management_review.action.create", "management_review", reviewId, {
      actionId: action.id,
      description: action.description,
    });
    res.status(201).json(action);
  } catch (e) {
    console.error("ReviewAction addAction error:", e);
    res.status(500).json({ error: e.message });
  }
};

const updateAction = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const action = await ReviewAction.findByPk(id);
    if (!action) return res.status(404).json({ error: "Action not found" });

    
    if (req.body.status === "COMPLETED" && !action.completedAt) {
      req.body.completedAt = new Date();
    }

    await action.update(req.body);
    await logAudit(req, "management_review.action.update", "management_review", action.managementReviewId, {
      actionId: action.id,
    });
    res.json(action);
  } catch (e) {
    console.error("ReviewAction updateAction error:", e);
    res.status(500).json({ error: e.message });
  }
};





const getStats = async (req, res) => {
  try {
    const totalReviews = await ManagementReview.count();
    const completed = await ManagementReview.count({ where: { status: "COMPLETED" } });
    const approved = await ManagementReview.count({ where: { status: "APPROVED" } });
    const planned = await ManagementReview.count({ where: { status: "PLANNED" } });
    const totalActions = await ReviewAction.count();
    const openActions = await ReviewAction.count({ where: { status: "OPEN" } });
    const overdueActions = await ReviewAction.count({ where: { status: "OVERDUE" } });

    res.json({ totalReviews, completed, approved, planned, totalActions, openActions, overdueActions });
  } catch (e) {
    console.error("ManagementReview getStats error:", e);
    res.status(500).json({ error: e.message });
  }
};

module.exports = {
  getAll, getOne, create, update,
  addAction, updateAction, getStats,
};

================================================================================
FILE: QMS-Server-master/modules/qms-review/index.js
================================================================================

module.exports = {
  code: 'qms.review',

  register(router) {
    router.use('/reviews', require('./routes/reviewRouter'));
  },

  getModels() { return require('./models/ManagementReview'); },
  setupAssociations() {},
};

================================================================================
FILE: QMS-Server-master/modules/qms-review/models/ManagementReview.js
================================================================================

const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");





const ManagementReview = sequelize.define("management_review", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  reviewNumber: { type: DataTypes.STRING, unique: true, allowNull: false, comment: "MR-YYYY-NN" },
  title: { type: DataTypes.STRING, allowNull: false },
  
  reviewDate: { type: DataTypes.DATE, allowNull: false },
  periodFrom: { type: DataTypes.DATE, allowNull: false, comment: "Начало анализируемого периода" },
  periodTo: { type: DataTypes.DATE, allowNull: false, comment: "Конец анализируемого периода" },
  
  chairpersonId: { type: DataTypes.INTEGER, allowNull: true, comment: "Председатель (обычно генеральный директор)" },
  participants: { type: DataTypes.JSON, allowNull: true, comment: "Массив {userId, name, role}" },
  
  status: { type: DataTypes.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "APPROVED"), defaultValue: "PLANNED" },
  
  
  inputData: {
    type: DataTypes.JSON,
    allowNull: true,
    comment: `{
      auditResults: { total, findings, closed },
      customerFeedback: { complaints, satisfaction },
      processPerformance: { ncStats, capaStats },
      productConformity: { defectRate, yieldRate },
      preventiveActions: { count, effective },
      previousActions: { completed, pending },
      regulatoryChanges: [],
      recommendations: []
    }`
  },
  
  
  outputData: {
    type: DataTypes.JSON,
    allowNull: true,
    comment: `{
      decisions: [{ description, responsible, deadline }],
      resourceNeeds: [],
      improvementActions: [],
      policyChanges: [],
      qualityObjectives: []
    }`
  },
  
  
  conclusion: { type: DataTypes.TEXT, comment: "Общее заключение о результативности СМК" },
  qmsEffectiveness: { type: DataTypes.ENUM("EFFECTIVE", "PARTIALLY_EFFECTIVE", "INEFFECTIVE"), allowNull: true },
  
  
  minutesUrl: { type: DataTypes.STRING, allowNull: true, comment: "Ссылка на протокол совещания" },
  
  approvedBy: { type: DataTypes.INTEGER, allowNull: true },
  approvedAt: { type: DataTypes.DATE, allowNull: true },
});


const ReviewAction = sequelize.define("review_action", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  managementReviewId: { type: DataTypes.INTEGER, allowNull: false },
  
  description: { type: DataTypes.TEXT, allowNull: false },
  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  deadline: { type: DataTypes.DATE, allowNull: true },
  
  priority: { type: DataTypes.ENUM("LOW", "MEDIUM", "HIGH"), defaultValue: "MEDIUM" },
  category: {
    type: DataTypes.ENUM("IMPROVEMENT", "RESOURCE", "TRAINING", "PROCESS_CHANGE", "POLICY", "INFRASTRUCTURE"),
    allowNull: true
  },
  
  status: { type: DataTypes.ENUM("OPEN", "IN_PROGRESS", "COMPLETED", "OVERDUE", "CANCELLED"), defaultValue: "OPEN" },
  completedAt: { type: DataTypes.DATE, allowNull: true },
  completionNotes: { type: DataTypes.TEXT, allowNull: true },
  
  
  capaId: { type: DataTypes.INTEGER, allowNull: true },
});


ManagementReview.hasMany(ReviewAction, { as: "actions", foreignKey: "managementReviewId" });
ReviewAction.belongsTo(ManagementReview, { foreignKey: "managementReviewId" });

module.exports = { ManagementReview, ReviewAction };

================================================================================
FILE: QMS-Server-master/modules/qms-review/routes/reviewRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const ctrl = require("../controllers/reviewController");
const authMiddleware = require("../../core/middleware/authMiddleware");
const syncUserMiddleware = require("../../core/middleware/syncUserMiddleware");
const checkAbility = require("../../core/middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/stats", ...protect, checkAbility("review.read"), ctrl.getStats);


router.get("/",      ...protect, checkAbility("review.read"),   ctrl.getAll);
router.get("/:id",   ...protect, checkAbility("review.read"),   ctrl.getOne);
router.post("/",     ...protect, checkAbility("review.manage"), ctrl.create);
router.put("/:id",   ...protect, checkAbility("review.manage"), ctrl.update);


router.post("/:id/actions",  ...protect, checkAbility("review.manage"), ctrl.addAction);
router.put("/actions/:id",   ...protect, checkAbility("review.manage"), ctrl.updateAction);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/qms-risk/controllers/riskController.js
================================================================================

const { RiskRegister, RiskAssessment, RiskMitigation } = require("../models/Risk");
const { User } = require("../../../models/index");
const RiskMatrixService = require("../services/RiskMatrixService");
const { logAudit } = require("../../core/utils/auditLogger");
const { Op } = require("sequelize");





const getAll = async (req, res) => {
  try {
    const { category, status, riskClass, ownerId, page = 1, limit = 50 } = req.query;
    const where = {};

    if (category) where.category = category;
    if (status) where.status = status;
    if (riskClass) where.initialRiskClass = riskClass;
    if (ownerId) where.ownerId = ownerId;

    const offset = (page - 1) * limit;
    const { count, rows } = await RiskRegister.findAndCountAll({
      where,
      include: [
        { model: RiskAssessment, as: "assessments", limit: 1, order: [["assessmentDate", "DESC"]] },
        { model: RiskMitigation, as: "mitigations" },
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
      ],
      order: [["initialRiskLevel", "DESC"], ["createdAt", "DESC"]],
      limit: parseInt(limit),
      offset,
    });

    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("Risk getAll error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getOne = async (req, res) => {
  try {
    const risk = await RiskRegister.findByPk(req.params.id, {
      include: [
        { model: RiskAssessment, as: "assessments", order: [["assessmentDate", "DESC"]] },
        { model: RiskMitigation, as: "mitigations", order: [["createdAt", "ASC"]] },
        { model: User, as: "owner", attributes: ["id", "name", "surname"] },
      ],
    });

    if (!risk) return res.status(404).json({ error: "Риск не найден" });
    res.json(risk);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

const create = async (req, res) => {
  try {
    const { title, description, category, initialProbability, initialSeverity, ownerId, relatedEntity, relatedEntityId, isoClause } = req.body;

    
    const count = await RiskRegister.count();
    const riskNumber = RiskMatrixService.generateRiskNumber(count + 1);

    
    const { level, riskClass } = RiskMatrixService.calculate(initialProbability, initialSeverity);

    const risk = await RiskRegister.create({
      riskNumber,
      title,
      description,
      category,
      initialProbability,
      initialSeverity,
      initialRiskLevel: level,
      initialRiskClass: riskClass,
      ownerId,
      relatedEntity,
      relatedEntityId,
      isoClause,
      status: "IDENTIFIED",
    });

    
    await RiskAssessment.create({
      riskRegisterId: risk.id,
      assessorId: req.user?.id || 1,
      probability: initialProbability,
      severity: initialSeverity,
      riskLevel: level,
      riskClass,
      assessmentType: "INITIAL",
      rationale: `Первичная идентификация риска: ${title}`,
    });

    await logAudit(req, "risk.create", "risk_register", risk.id, { riskNumber, riskClass });
    res.status(201).json(risk);
  } catch (e) {
    console.error("Risk create error:", e);
    res.status(500).json({ error: e.message });
  }
};

const update = async (req, res) => {
  try {
    const risk = await RiskRegister.findByPk(req.params.id);
    if (!risk) return res.status(404).json({ error: "Риск не найден" });

    const updateData = { ...req.body };
    
    
    if (updateData.initialProbability && updateData.initialSeverity) {
      const { level, riskClass } = RiskMatrixService.calculate(updateData.initialProbability, updateData.initialSeverity);
      updateData.initialRiskLevel = level;
      updateData.initialRiskClass = riskClass;
    }

    await risk.update(updateData);
    await logAudit(req, "risk.update", "risk_register", risk.id, updateData);
    res.json(risk);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};





const addAssessment = async (req, res) => {
  try {
    const { probability, severity, detectability, rationale, assessmentType } = req.body;
    const risk = await RiskRegister.findByPk(req.params.id);
    if (!risk) return res.status(404).json({ error: "Риск не найден" });

    const { level, riskClass } = RiskMatrixService.calculate(probability, severity);

    const assessment = await RiskAssessment.create({
      riskRegisterId: risk.id,
      assessorId: req.user?.id || 1,
      probability,
      severity,
      detectability,
      riskLevel: level,
      riskClass,
      rationale,
      assessmentType: assessmentType || "PERIODIC",
    });

    
    if (assessmentType === "POST_MITIGATION") {
      await RiskMatrixService.recalculateRisk(risk, { probability, severity, isResidual: true });
      risk.status = RiskMatrixService.isAcceptable(riskClass) ? "ACCEPTED" : "MITIGATED";
      await risk.save();
    }

    await logAudit(req, "risk.assess", "risk_register", risk.id, { riskClass, level });
    res.status(201).json(assessment);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};





const addMitigation = async (req, res) => {
  try {
    const risk = await RiskRegister.findByPk(req.params.id);
    if (!risk) return res.status(404).json({ error: "Риск не найден" });

    const mitigation = await RiskMitigation.create({
      riskRegisterId: risk.id,
      ...req.body,
      status: "PLANNED",
    });

    if (risk.status === "IDENTIFIED") {
      risk.status = "ASSESSED";
      await risk.save();
    }

    await logAudit(req, "risk.mitigation.add", "risk_register", risk.id, { mitigationType: req.body.mitigationType });
    res.status(201).json(mitigation);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

const completeMitigation = async (req, res) => {
  try {
    const mitigation = await RiskMitigation.findByPk(req.params.mitigationId);
    if (!mitigation) return res.status(404).json({ error: "Мера не найдена" });

    mitigation.status = "COMPLETED";
    mitigation.completedDate = new Date();
    await mitigation.save();

    await logAudit(req, "risk.mitigation.complete", "risk_mitigation", mitigation.id);
    res.json(mitigation);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

const verifyMitigation = async (req, res) => {
  try {
    const mitigation = await RiskMitigation.findByPk(req.params.mitigationId);
    if (!mitigation) return res.status(404).json({ error: "Мера не найдена" });

    mitigation.status = "VERIFIED";
    mitigation.verifiedBy = req.user?.id || 1;
    mitigation.verifiedAt = new Date();
    mitigation.verificationNotes = req.body.notes;
    await mitigation.save();

    
    const risk = await RiskRegister.findByPk(mitigation.riskRegisterId, {
      include: [{ model: RiskMitigation, as: "mitigations" }],
    });
    
    const allVerified = risk.mitigations.every(m => m.status === "VERIFIED");
    if (allVerified) {
      risk.status = "MITIGATED";
      await risk.save();
    }

    await logAudit(req, "risk.mitigation.verify", "risk_mitigation", mitigation.id);
    res.json(mitigation);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};





const acceptRisk = async (req, res) => {
  try {
    const risk = await RiskRegister.findByPk(req.params.id);
    if (!risk) return res.status(404).json({ error: "Риск не найден" });

    risk.status = "ACCEPTED";
    risk.acceptanceDecision = req.body.decision;
    risk.acceptedBy = req.user?.id || 1;
    risk.acceptedAt = new Date();
    await risk.save();

    await logAudit(req, "risk.accept", "risk_register", risk.id, { severity: "WARNING" });
    res.json(risk);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};





const getMatrix = async (req, res) => {
  try {
    const matrix = RiskMatrixService.getMatrix();
    const labels = RiskMatrixService.getScaleLabels();

    
    const risks = await RiskRegister.findAll({
      attributes: ["initialProbability", "initialSeverity"],
      where: { status: { [Op.notIn]: ["CLOSED"] } },
    });

    const cellCounts = {};
    risks.forEach(r => {
      const key = `${r.initialProbability}-${r.initialSeverity}`;
      cellCounts[key] = (cellCounts[key] || 0) + 1;
    });

    res.json({ matrix, labels, cellCounts });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

const getStats = async (req, res) => {
  try {
    const total = await RiskRegister.count();
    const byClass = {};
    for (const cls of ["LOW", "MEDIUM", "HIGH", "CRITICAL"]) {
      byClass[cls] = await RiskRegister.count({ where: { initialRiskClass: cls, status: { [Op.ne]: "CLOSED" } } });
    }
    const byStatus = {};
    for (const s of ["IDENTIFIED", "ASSESSED", "MITIGATED", "ACCEPTED", "CLOSED", "MONITORING"]) {
      byStatus[s] = await RiskRegister.count({ where: { status: s } });
    }

    const overdue = await RiskRegister.count({
      where: { reviewDate: { [Op.lt]: new Date() }, status: { [Op.notIn]: ["CLOSED", "ACCEPTED"] } },
    });

    res.json({ total, byClass, byStatus, overdue });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

module.exports = {
  getAll, getOne, create, update,
  addAssessment,
  addMitigation, completeMitigation, verifyMitigation,
  acceptRisk,
  getMatrix, getStats,
};

================================================================================
FILE: QMS-Server-master/modules/qms-risk/index.js
================================================================================

module.exports = {
  code: 'qms.risk',

  register(router) {
    router.use('/risks', require('./routes/riskRouter'));
  },

  getModels() {
    return require('./models/Risk');
  },

  setupAssociations(m) {
    if (m.RiskRegister && m.User) {
      m.User.hasMany(m.RiskRegister, { as: 'ownedRisks', foreignKey: 'ownerId' });
      m.RiskRegister.belongsTo(m.User, { as: 'owner', foreignKey: 'ownerId' });
    }
  },
};

================================================================================
FILE: QMS-Server-master/modules/qms-risk/models/Risk.js
================================================================================

const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");






const RiskRegister = sequelize.define("risk_register", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  
  riskNumber: { 
    type: DataTypes.STRING, 
    unique: true, 
    allowNull: false,
    comment: "Автогенерируемый номер: RISK-YYYY-NNN"
  },
  title: { type: DataTypes.STRING(500), allowNull: false },
  description: { type: DataTypes.TEXT },
  
  
  category: { 
    type: DataTypes.ENUM(
      "PRODUCT",        
      "PROCESS",        
      "SUPPLIER",       
      "REGULATORY",     
      "INFRASTRUCTURE", 
      "HUMAN",          
      "CYBER"           
    ),
    allowNull: false 
  },
  
  
  relatedEntity: { type: DataTypes.STRING, allowNull: true, comment: "Тип: product, process, supplier, document" },
  relatedEntityId: { type: DataTypes.INTEGER, allowNull: true },
  
  
  initialProbability: { type: DataTypes.INTEGER, allowNull: false, validate: { min: 1, max: 5 }, comment: "1=Невероятно, 5=Частое" },
  initialSeverity: { type: DataTypes.INTEGER, allowNull: false, validate: { min: 1, max: 5 }, comment: "1=Незначительное, 5=Катастрофическое" },
  initialRiskLevel: { type: DataTypes.INTEGER, allowNull: true, comment: "probability × severity (авторасчёт)" },
  initialRiskClass: { type: DataTypes.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL"), allowNull: true },
  
  
  residualProbability: { type: DataTypes.INTEGER, allowNull: true, validate: { min: 1, max: 5 } },
  residualSeverity: { type: DataTypes.INTEGER, allowNull: true, validate: { min: 1, max: 5 } },
  residualRiskLevel: { type: DataTypes.INTEGER, allowNull: true },
  residualRiskClass: { type: DataTypes.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL"), allowNull: true },
  
  
  status: {
    type: DataTypes.ENUM("IDENTIFIED", "ASSESSED", "MITIGATED", "ACCEPTED", "CLOSED", "MONITORING"),
    defaultValue: "IDENTIFIED"
  },
  acceptanceDecision: { type: DataTypes.TEXT, allowNull: true, comment: "Обоснование принятия остаточного риска" },
  acceptedBy: { type: DataTypes.INTEGER, allowNull: true },
  acceptedAt: { type: DataTypes.DATE, allowNull: true },
  
  
  ownerId: { type: DataTypes.INTEGER, allowNull: true, comment: "Владелец риска" },
  reviewDate: { type: DataTypes.DATE, allowNull: true, comment: "Дата следующего пересмотра" },
  
  
  isoClause: { type: DataTypes.STRING, allowNull: true, comment: "Пункт ISO 13485/14971" },
});





const RiskAssessment = sequelize.define("risk_assessment", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  riskRegisterId: { type: DataTypes.INTEGER, allowNull: false },
  
  assessmentDate: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  assessorId: { type: DataTypes.INTEGER, allowNull: false, comment: "Кто проводил оценку" },
  
  probability: { type: DataTypes.INTEGER, allowNull: false, validate: { min: 1, max: 5 } },
  severity: { type: DataTypes.INTEGER, allowNull: false, validate: { min: 1, max: 5 } },
  detectability: { type: DataTypes.INTEGER, allowNull: true, validate: { min: 1, max: 5 }, comment: "Обнаруживаемость (опционально, для FMEA)" },
  riskLevel: { type: DataTypes.INTEGER, allowNull: true },
  riskClass: { type: DataTypes.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL"), allowNull: true },
  
  rationale: { type: DataTypes.TEXT, comment: "Обоснование оценки" },
  assessmentType: { type: DataTypes.ENUM("INITIAL", "PERIODIC", "POST_MITIGATION", "POST_INCIDENT"), defaultValue: "INITIAL" },
});





const RiskMitigation = sequelize.define("risk_mitigation", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  riskRegisterId: { type: DataTypes.INTEGER, allowNull: false },
  
  mitigationType: {
    type: DataTypes.ENUM(
      "DESIGN",          
      "PROTECTIVE",      
      "INFORMATION",     
      "PROCESS_CONTROL", 
      "TRAINING",        
      "MONITORING"       
    ),
    allowNull: false
  },
  
  description: { type: DataTypes.TEXT, allowNull: false },
  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  
  plannedDate: { type: DataTypes.DATE, allowNull: true },
  completedDate: { type: DataTypes.DATE, allowNull: true },
  
  status: {
    type: DataTypes.ENUM("PLANNED", "IN_PROGRESS", "COMPLETED", "VERIFIED", "INEFFECTIVE"),
    defaultValue: "PLANNED"
  },
  
  verifiedBy: { type: DataTypes.INTEGER, allowNull: true },
  verifiedAt: { type: DataTypes.DATE, allowNull: true },
  verificationNotes: { type: DataTypes.TEXT, allowNull: true },
  
  
  capaId: { type: DataTypes.INTEGER, allowNull: true },
});





RiskRegister.hasMany(RiskAssessment, { as: "assessments", foreignKey: "riskRegisterId" });
RiskAssessment.belongsTo(RiskRegister, { foreignKey: "riskRegisterId" });

RiskRegister.hasMany(RiskMitigation, { as: "mitigations", foreignKey: "riskRegisterId" });
RiskMitigation.belongsTo(RiskRegister, { foreignKey: "riskRegisterId" });

module.exports = {
  RiskRegister,
  RiskAssessment,
  RiskMitigation,
};

================================================================================
FILE: QMS-Server-master/modules/qms-risk/routes/riskRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const riskController = require("../controllers/riskController");
const authMiddleware = require("../../core/middleware/authMiddleware");
const syncUserMiddleware = require("../../core/middleware/syncUserMiddleware");
const checkAbility = require("../../core/middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/matrix",    ...protect, checkAbility("risk.read"),    riskController.getMatrix);
router.get("/stats",     ...protect, checkAbility("risk.read"),    riskController.getStats);


router.get("/",          ...protect, checkAbility("risk.read"),    riskController.getAll);
router.get("/:id",       ...protect, checkAbility("risk.read"),    riskController.getOne);
router.post("/",         ...protect, checkAbility("risk.create"),  riskController.create);
router.put("/:id",       ...protect, checkAbility("risk.update"),  riskController.update);


router.post("/:id/assess",    ...protect, checkAbility("risk.assess"),  riskController.addAssessment);
router.post("/:id/accept",    ...protect, checkAbility("risk.accept"),  riskController.acceptRisk);


router.post("/:id/mitigation",                         ...protect, checkAbility("risk.update"),   riskController.addMitigation);
router.put("/mitigation/:mitigationId/complete",        ...protect, checkAbility("risk.update"),   riskController.completeMitigation);
router.put("/mitigation/:mitigationId/verify",          ...protect, checkAbility("risk.verify"),   riskController.verifyMitigation);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/qms-risk/services/RiskMatrixService.js
================================================================================














const RISK_THRESHOLDS = {
  LOW: { min: 1, max: 4 },
  MEDIUM: { min: 5, max: 9 },
  HIGH: { min: 10, max: 15 },
  CRITICAL: { min: 16, max: 25 },
};

const PROBABILITY_LABELS = {
  1: "Невероятное (< 1 раз в 10 лет)",
  2: "Маловероятное (1 раз в 5-10 лет)",
  3: "Возможное (1 раз в 1-5 лет)",
  4: "Вероятное (1 раз в год)",
  5: "Частое (> 1 раза в год)",
};

const SEVERITY_LABELS = {
  1: "Незначительное (нет влияния на пациента)",
  2: "Несущественное (временный дискомфорт)",
  3: "Серьёзное (травма, требующая лечения)",
  4: "Критическое (тяжёлая травма / инвалидность)",
  5: "Катастрофическое (смерть пациента)",
};

class RiskMatrixService {
  


  static calculate(probability, severity) {
    const level = probability * severity;
    const riskClass = this.classify(level);
    return { level, riskClass };
  }

  


  static classify(level) {
    if (level <= RISK_THRESHOLDS.LOW.max) return "LOW";
    if (level <= RISK_THRESHOLDS.MEDIUM.max) return "MEDIUM";
    if (level <= RISK_THRESHOLDS.HIGH.max) return "HIGH";
    return "CRITICAL";
  }

  



  static calculateRPN(severity, probability, detectability) {
    return severity * probability * (detectability || 1);
  }

  



  static isAcceptable(riskClass) {
    return riskClass === "LOW" || riskClass === "MEDIUM";
  }

  


  static getMatrix() {
    const matrix = [];
    for (let p = 5; p >= 1; p--) {
      const row = [];
      for (let s = 1; s <= 5; s++) {
        const { level, riskClass } = this.calculate(p, s);
        row.push({ probability: p, severity: s, level, riskClass });
      }
      matrix.push(row);
    }
    return matrix;
  }

  


  static generateRiskNumber(sequenceNumber) {
    const year = new Date().getFullYear();
    const num = String(sequenceNumber).padStart(3, "0");
    return `RISK-${year}-${num}`;
  }

  


  static getScaleLabels() {
    return {
      probability: PROBABILITY_LABELS,
      severity: SEVERITY_LABELS,
      thresholds: RISK_THRESHOLDS,
    };
  }

  


  static async recalculateRisk(riskRecord, { probability, severity, isResidual = false }) {
    const { level, riskClass } = this.calculate(probability, severity);

    if (isResidual) {
      riskRecord.residualProbability = probability;
      riskRecord.residualSeverity = severity;
      riskRecord.residualRiskLevel = level;
      riskRecord.residualRiskClass = riskClass;
    } else {
      riskRecord.initialProbability = probability;
      riskRecord.initialSeverity = severity;
      riskRecord.initialRiskLevel = level;
      riskRecord.initialRiskClass = riskClass;
    }

    await riskRecord.save();
    return { level, riskClass };
  }
}

module.exports = RiskMatrixService;

================================================================================
FILE: QMS-Server-master/modules/qms-supplier/controllers/supplierController.js
================================================================================

const { Supplier, SupplierEvaluation, SupplierAudit } = require("../models/Supplier");
const { User } = require("../../../models/index");
const SupplierScoringService = require("../services/SupplierScoringService");
const { logAudit } = require("../../core/utils/auditLogger");





const getAll = async (req, res, next) => {
  try {
    const { category, criticality, qualificationStatus, page = 1, limit = 50 } = req.query;
    const where = {};
    if (category) where.category = category;
    if (criticality) where.criticality = criticality;
    if (qualificationStatus) where.qualificationStatus = qualificationStatus;

    const offset = (page - 1) * limit;
    const { count, rows } = await Supplier.findAndCountAll({
      where,
      include: [
        { model: SupplierEvaluation, as: "evaluations", limit: 1, order: [["evaluationDate", "DESC"]] },
      ],
      order: [["name", "ASC"]],
      limit: parseInt(limit),
      offset,
    });
    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("Supplier getAll error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getOne = async (req, res, next) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const supplier = await Supplier.findByPk(id, {
      include: [
        { model: SupplierEvaluation, as: "evaluations", order: [["evaluationDate", "DESC"]] },
        { model: SupplierAudit, as: "audits", order: [["auditDate", "DESC"]] },
      ],
    });
    if (!supplier) return res.status(404).json({ error: "Supplier not found" });
    res.json(supplier);
  } catch (e) {
    console.error("Supplier getOne error:", e);
    res.status(500).json({ error: e.message });
  }
};

const create = async (req, res, next) => {
  try {
    const count = await Supplier.count();
    const code = `SUP-${String(count + 1).padStart(3, "0")}`;

    const supplier = await Supplier.create({ ...req.body, code });
    await logAudit(req, "supplier.create", "supplier", supplier.id, { code, name: supplier.name });
    res.status(201).json(supplier);
  } catch (e) {
    console.error("Supplier create error:", e);
    res.status(500).json({ error: e.message });
  }
};

const update = async (req, res, next) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const supplier = await Supplier.findByPk(id);
    if (!supplier) return res.status(404).json({ error: "Supplier not found" });

    await supplier.update(req.body);
    await logAudit(req, "supplier.update", "supplier", supplier.id, req.body);
    res.json(supplier);
  } catch (e) {
    console.error("Supplier update error:", e);
    res.status(500).json({ error: e.message });
  }
};

const remove = async (req, res, next) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const supplier = await Supplier.findByPk(id);
    if (!supplier) return res.status(404).json({ error: "Supplier not found" });

    await supplier.update({ qualificationStatus: "DISQUALIFIED" });
    await logAudit(req, "supplier.delete", "supplier", supplier.id, { name: supplier.name });
    res.json({ message: "Supplier disqualified", id });
  } catch (e) {
    console.error("Supplier delete error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getStats = async (req, res, next) => {
  try {
    const total = await Supplier.count();
    const qualified = await Supplier.count({ where: { qualificationStatus: "QUALIFIED" } });
    const pending = await Supplier.count({ where: { qualificationStatus: "PENDING" } });
    const suspended = await Supplier.count({ where: { qualificationStatus: "SUSPENDED" } });
    const disqualified = await Supplier.count({ where: { qualificationStatus: "DISQUALIFIED" } });
    const critical = await Supplier.count({ where: { criticality: "CRITICAL" } });

    res.json({ total, qualified, pending, suspended, disqualified, critical });
  } catch (e) {
    console.error("Supplier getStats error:", e);
    res.status(500).json({ error: e.message });
  }
};





const addEvaluation = async (req, res, next) => {
  try {
    const supplierId = parseInt(req.params.id);
    if (isNaN(supplierId)) return res.status(400).json({ error: "Invalid ID" });

    const supplier = await Supplier.findByPk(supplierId);
    if (!supplier) return res.status(404).json({ error: "Supplier not found" });

    const evaluation = await SupplierEvaluation.create({
      ...req.body,
      supplierId,
      evaluatorId: req.user?.id || 1,
    });

    
    const scores = [
      evaluation.qualityScore, evaluation.deliveryScore,
      evaluation.documentationScore, evaluation.communicationScore,
      evaluation.priceScore, evaluation.complianceScore,
    ].filter(s => s != null);

    if (scores.length > 0) {
      const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
      evaluation.totalScore = Math.round(avg * 10) / 10;
      await evaluation.save();

      supplier.overallScore = Math.round(evaluation.totalScore * 10);
      await supplier.save();
    }

    await logAudit(req, "supplier.evaluate", "supplier_evaluation", evaluation.id, { supplierId });
    res.status(201).json(evaluation);
  } catch (e) {
    console.error("Supplier addEvaluation error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getEvaluations = async (req, res, next) => {
  try {
    const supplierId = parseInt(req.params.id);
    if (isNaN(supplierId)) return res.status(400).json({ error: "Invalid ID" });

    const evaluations = await SupplierEvaluation.findAll({
      where: { supplierId },
      order: [["evaluationDate", "DESC"]],
    });
    res.json(evaluations);
  } catch (e) {
    console.error("Supplier getEvaluations error:", e);
    res.status(500).json({ error: e.message });
  }
};





const addAudit = async (req, res, next) => {
  try {
    const supplierId = parseInt(req.params.id);
    if (isNaN(supplierId)) return res.status(400).json({ error: "Invalid ID" });

    const supplier = await Supplier.findByPk(supplierId);
    if (!supplier) return res.status(404).json({ error: "Supplier not found" });

    const audit = await SupplierAudit.create({
      ...req.body,
      supplierId,
      auditorId: req.user?.id || 1,
    });

    await logAudit(req, "supplier.audit", "supplier", supplierId, { auditId: audit.id });
    res.status(201).json(audit);
  } catch (e) {
    console.error("Supplier addAudit error:", e);
    res.status(500).json({ error: e.message });
  }
};

module.exports = {
  getAll, getOne, create, update, remove, getStats,
  addEvaluation, getEvaluations, addAudit,
};

================================================================================
FILE: QMS-Server-master/modules/qms-supplier/index.js
================================================================================

module.exports = {
  code: 'qms.supplier',

  register(router) {
    router.use('/suppliers', require('./routes/supplierRouter'));
  },

  getModels() { return require('./models/Supplier'); },
  setupAssociations() {},
};

================================================================================
FILE: QMS-Server-master/modules/qms-supplier/models/Supplier.js
================================================================================

const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");





const Supplier = sequelize.define("supplier", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  
  code: { type: DataTypes.STRING, unique: true, allowNull: false, comment: "Код поставщика: SUP-NNN" },
  name: { type: DataTypes.STRING(500), allowNull: false },
  legalName: { type: DataTypes.STRING(500), allowNull: true, comment: "Полное юридическое название" },
  inn: { type: DataTypes.STRING(12), allowNull: true, comment: "ИНН" },
  
  
  address: { type: DataTypes.TEXT },
  contactPerson: { type: DataTypes.STRING },
  phone: { type: DataTypes.STRING },
  email: { type: DataTypes.STRING },
  website: { type: DataTypes.STRING },
  
  
  category: {
    type: DataTypes.ENUM(
      "RAW_MATERIAL",    
      "COMPONENT",       
      "SERVICE",         
      "EQUIPMENT",       
      "PACKAGING",       
      "SOFTWARE",        
      "SUBCONTRACTOR"    
    ),
    allowNull: false
  },
  
  criticality: {
    type: DataTypes.ENUM("CRITICAL", "MAJOR", "MINOR"),
    defaultValue: "MAJOR",
    comment: "Критичность: влияет на частоту переоценки"
  },
  
  
  qualificationStatus: {
    type: DataTypes.ENUM("PENDING", "QUALIFIED", "CONDITIONAL", "DISQUALIFIED", "SUSPENDED"),
    defaultValue: "PENDING"
  },
  qualifiedAt: { type: DataTypes.DATE, allowNull: true },
  qualifiedBy: { type: DataTypes.INTEGER, allowNull: true },
  
  nextEvaluationDate: { type: DataTypes.DATE, allowNull: true, comment: "Дата следующей периодической оценки" },
  
  
  hasCertISO9001: { type: DataTypes.BOOLEAN, defaultValue: false },
  hasCertISO13485: { type: DataTypes.BOOLEAN, defaultValue: false },
  certExpiryDate: { type: DataTypes.DATE, allowNull: true },
  
  
  overallScore: { type: DataTypes.FLOAT, allowNull: true, comment: "Общий балл 0-100" },
  
  notes: { type: DataTypes.TEXT },
});





const SupplierEvaluation = sequelize.define("supplier_evaluation", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplierId: { type: DataTypes.INTEGER, allowNull: false },
  
  evaluationDate: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  evaluatorId: { type: DataTypes.INTEGER, allowNull: false },
  evaluationType: {
    type: DataTypes.ENUM("INITIAL", "PERIODIC", "POST_INCIDENT", "REQUALIFICATION"),
    defaultValue: "PERIODIC"
  },
  
  
  qualityScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "Качество продукции/услуг" },
  deliveryScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "Соблюдение сроков" },
  documentationScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "Полнота документации" },
  communicationScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "Коммуникация и отзывчивость" },
  priceScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "Соотношение цена/качество" },
  complianceScore: { type: DataTypes.INTEGER, validate: { min: 1, max: 10 }, comment: "Соответствие нормативам" },
  
  totalScore: { type: DataTypes.FLOAT, allowNull: true, comment: "Средневзвешенный балл" },
  
  
  decision: {
    type: DataTypes.ENUM("APPROVED", "CONDITIONALLY_APPROVED", "REJECTED", "SUSPENDED"),
    allowNull: true
  },
  conditions: { type: DataTypes.TEXT, allowNull: true, comment: "Условия при условном одобрении" },
  comments: { type: DataTypes.TEXT },
  
  
  totalOrders: { type: DataTypes.INTEGER, defaultValue: 0 },
  defectiveOrders: { type: DataTypes.INTEGER, defaultValue: 0 },
  lateDeliveries: { type: DataTypes.INTEGER, defaultValue: 0 },
  ncCount: { type: DataTypes.INTEGER, defaultValue: 0, comment: "Число NC за период" },
});





const SupplierAudit = sequelize.define("supplier_audit", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplierId: { type: DataTypes.INTEGER, allowNull: false },
  
  auditDate: { type: DataTypes.DATE, allowNull: false },
  auditorId: { type: DataTypes.INTEGER, allowNull: false },
  auditType: { type: DataTypes.ENUM("ON_SITE", "REMOTE", "DOCUMENT"), defaultValue: "ON_SITE" },
  
  scope: { type: DataTypes.TEXT, comment: "Область аудита" },
  findings: { type: DataTypes.TEXT, comment: "Замечания" },
  
  findingsCount: { type: DataTypes.INTEGER, defaultValue: 0 },
  majorFindings: { type: DataTypes.INTEGER, defaultValue: 0 },
  minorFindings: { type: DataTypes.INTEGER, defaultValue: 0 },
  
  result: { type: DataTypes.ENUM("PASS", "CONDITIONAL", "FAIL"), allowNull: true },
  nextAuditDate: { type: DataTypes.DATE, allowNull: true },
  
  reportUrl: { type: DataTypes.STRING, allowNull: true },
});





Supplier.hasMany(SupplierEvaluation, { as: "evaluations", foreignKey: "supplierId" });
SupplierEvaluation.belongsTo(Supplier, { foreignKey: "supplierId" });

Supplier.hasMany(SupplierAudit, { as: "audits", foreignKey: "supplierId" });
SupplierAudit.belongsTo(Supplier, { foreignKey: "supplierId" });

module.exports = {
  Supplier,
  SupplierEvaluation,
  SupplierAudit,
};

================================================================================
FILE: QMS-Server-master/modules/qms-supplier/routes/supplierRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const ctrl = require("../controllers/supplierController");
const authMiddleware = require("../../core/middleware/authMiddleware");
const syncUserMiddleware = require("../../core/middleware/syncUserMiddleware");
const checkAbility = require("../../core/middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/stats", ...protect, checkAbility("supplier.read"), ctrl.getStats);


router.get("/",      ...protect, checkAbility("supplier.read"),   ctrl.getAll);
router.get("/:id",   ...protect, checkAbility("supplier.read"),   ctrl.getOne);
router.post("/",     ...protect, checkAbility("supplier.manage"), ctrl.create);
router.put("/:id",   ...protect, checkAbility("supplier.manage"), ctrl.update);
router.delete("/:id",...protect, checkAbility("supplier.manage"), ctrl.remove);


router.get("/:id/evaluations",  ...protect, checkAbility("supplier.read"),   ctrl.getEvaluations);
router.post("/:id/evaluations", ...protect, checkAbility("supplier.manage"), ctrl.addEvaluation);
router.post("/:id/audits",      ...protect, checkAbility("supplier.manage"), ctrl.addAudit);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/qms-supplier/services/SupplierScoringService.js
================================================================================


















const WEIGHTS = {
  qualityScore: 0.30,
  deliveryScore: 0.20,
  documentationScore: 0.20,
  communicationScore: 0.10,
  priceScore: 0.10,
  complianceScore: 0.10,
};

const DECISION_THRESHOLDS = {
  APPROVED: 80,
  CONDITIONALLY_APPROVED: 60,
  
};


const EVALUATION_PERIODS = {
  CRITICAL: 6,   
  MAJOR: 12,     
  MINOR: 24,     
};

class SupplierScoringService {
  


  static calculateScore(scores) {
    let total = 0;
    let weightSum = 0;

    for (const [field, weight] of Object.entries(WEIGHTS)) {
      const value = scores[field];
      if (value !== null && value !== undefined) {
        total += value * weight;
        weightSum += weight;
      }
    }

    
    return weightSum > 0 ? Math.round((total / weightSum) * 10) : 0;
  }

  


  static determineDecision(score) {
    if (score >= DECISION_THRESHOLDS.APPROVED) return "APPROVED";
    if (score >= DECISION_THRESHOLDS.CONDITIONALLY_APPROVED) return "CONDITIONALLY_APPROVED";
    return "REJECTED";
  }

  


  static getNextEvaluationDate(criticality) {
    const months = EVALUATION_PERIODS[criticality] || 12;
    const next = new Date();
    next.setMonth(next.getMonth() + months);
    return next;
  }

  


  static calculateDeliveryMetrics(supplies) {
    const total = supplies.length;
    if (total === 0) return { totalOrders: 0, defectiveOrders: 0, lateDeliveries: 0, defectRate: 0 };

    const defective = supplies.filter(s => s.hasDefects || s.status === "REJECTED").length;
    const late = supplies.filter(s => {
      if (!s.expectedDate || !s.actualDate) return false;
      return new Date(s.actualDate) > new Date(s.expectedDate);
    }).length;

    return {
      totalOrders: total,
      defectiveOrders: defective,
      lateDeliveries: late,
      defectRate: Math.round((defective / total) * 100),
      onTimeRate: Math.round(((total - late) / total) * 100),
    };
  }

  


  static getConfig() {
    return {
      weights: WEIGHTS,
      thresholds: DECISION_THRESHOLDS,
      evaluationPeriods: EVALUATION_PERIODS,
    };
  }
}

module.exports = SupplierScoringService;

================================================================================
FILE: QMS-Server-master/modules/qms-training/controllers/trainingController.js
================================================================================

const { TrainingPlan, TrainingRecord, CompetencyMatrix } = require("../models/Training");
const { User } = require("../../../models/index");
const { logAudit } = require("../../core/utils/auditLogger");





const getPlans = async (req, res) => {
  try {
    const { year, status, page = 1, limit = 20 } = req.query;
    const where = {};
    if (year) where.year = year;
    if (status) where.status = status;

    const offset = (page - 1) * limit;
    const { count, rows } = await TrainingPlan.findAndCountAll({
      where,
      include: [{ model: TrainingRecord, as: "records" }],
      order: [["year", "DESC"]],
      limit: parseInt(limit),
      offset,
    });
    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("TrainingPlan getPlans error:", e);
    res.status(500).json({ error: e.message });
  }
};

const getPlanOne = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const plan = await TrainingPlan.findByPk(id, {
      include: [{
        model: TrainingRecord, as: "records",
        include: [{ model: User, as: "trainee", attributes: ["id", "name", "surname"] }],
      }],
    });
    if (!plan) return res.status(404).json({ error: "Training plan not found" });
    res.json(plan);
  } catch (e) {
    console.error("TrainingPlan getPlanOne error:", e);
    res.status(500).json({ error: e.message });
  }
};

const createPlan = async (req, res) => {
  try {
    const plan = await TrainingPlan.create(req.body);
    await logAudit(req, "training.plan.create", "training_record", plan.id, { title: plan.title });
    res.status(201).json(plan);
  } catch (e) {
    console.error("TrainingPlan createPlan error:", e);
    res.status(500).json({ error: e.message });
  }
};

const updatePlan = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const plan = await TrainingPlan.findByPk(id);
    if (!plan) return res.status(404).json({ error: "Training plan not found" });

    await plan.update(req.body);
    await logAudit(req, "training.plan.update", "training_record", plan.id, req.body);
    res.json(plan);
  } catch (e) {
    console.error("TrainingPlan updatePlan error:", e);
    res.status(500).json({ error: e.message });
  }
};





const getRecords = async (req, res) => {
  try {
    const { userId, type, status, trainingPlanId, page = 1, limit = 50 } = req.query;
    const where = {};
    if (userId) where.userId = userId;
    if (type) where.type = type;
    if (status) where.status = status;
    if (trainingPlanId) where.trainingPlanId = trainingPlanId;

    const offset = (page - 1) * limit;
    const { count, rows } = await TrainingRecord.findAndCountAll({
      where,
      include: [
        { model: User, as: "trainee", attributes: ["id", "name", "surname"] },
        { model: TrainingPlan, as: "trainingPlan", attributes: ["id", "title", "year"] },
      ],
      order: [["trainingDate", "DESC"]],
      limit: parseInt(limit),
      offset,
    });
    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("TrainingRecord getRecords error:", e);
    res.status(500).json({ error: e.message });
  }
};

const createRecord = async (req, res) => {
  try {
    const record = await TrainingRecord.create({
      ...req.body,
      status: req.body.status || "PLANNED",
    });
    await logAudit(req, "training.record.create", "training_record", record.id, { title: record.title });
    res.status(201).json(record);
  } catch (e) {
    console.error("TrainingRecord createRecord error:", e);
    res.status(500).json({ error: e.message });
  }
};

const updateRecord = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const record = await TrainingRecord.findByPk(id);
    if (!record) return res.status(404).json({ error: "Training record not found" });

    await record.update(req.body);
    await logAudit(req, "training.record.update", "training_record", record.id, req.body);
    res.json(record);
  } catch (e) {
    console.error("TrainingRecord updateRecord error:", e);
    res.status(500).json({ error: e.message });
  }
};





const getCompetency = async (req, res) => {
  try {
    const { userId, page = 1, limit = 50 } = req.query;
    const where = {};
    if (userId) where.userId = userId;

    const offset = (page - 1) * limit;
    const { count, rows } = await CompetencyMatrix.findAndCountAll({
      where,
      include: [{ model: User, as: "user", attributes: ["id", "name", "surname"] }],
      order: [["processName", "ASC"]],
      limit: parseInt(limit),
      offset,
    });
    res.json({ count, rows, page: parseInt(page), totalPages: Math.ceil(count / limit) });
  } catch (e) {
    console.error("CompetencyMatrix getCompetency error:", e);
    res.status(500).json({ error: e.message });
  }
};

const createCompetency = async (req, res) => {
  try {
    const entry = await CompetencyMatrix.create(req.body);
    await logAudit(req, "training.competency.create", "training_record", entry.id, {
      userId: entry.userId,
      processName: entry.processName,
    });
    res.status(201).json(entry);
  } catch (e) {
    console.error("CompetencyMatrix createCompetency error:", e);
    res.status(500).json({ error: e.message });
  }
};

const updateCompetency = async (req, res) => {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) return res.status(400).json({ error: "Invalid ID" });

    const entry = await CompetencyMatrix.findByPk(id);
    if (!entry) return res.status(404).json({ error: "Competency entry not found" });

    await entry.update(req.body);
    await logAudit(req, "training.competency.update", "training_record", entry.id, req.body);
    res.json(entry);
  } catch (e) {
    console.error("CompetencyMatrix updateCompetency error:", e);
    res.status(500).json({ error: e.message });
  }
};





const getStats = async (req, res) => {
  try {
    const totalPlans = await TrainingPlan.count();
    const totalRecords = await TrainingRecord.count();
    const completed = await TrainingRecord.count({ where: { status: "COMPLETED" } });
    const planned = await TrainingRecord.count({ where: { status: "PLANNED" } });
    const failed = await TrainingRecord.count({ where: { status: "FAILED" } });
    const expired = await TrainingRecord.count({ where: { status: "EXPIRED" } });
    const competencyEntries = await CompetencyMatrix.count();

    res.json({ totalPlans, totalRecords, completed, planned, failed, expired, competencyEntries });
  } catch (e) {
    console.error("Training getStats error:", e);
    res.status(500).json({ error: e.message });
  }
};

module.exports = {
  getPlans, getPlanOne, createPlan, updatePlan,
  getRecords, createRecord, updateRecord,
  getCompetency, createCompetency, updateCompetency,
  getStats,
};

================================================================================
FILE: QMS-Server-master/modules/qms-training/index.js
================================================================================

module.exports = {
  code: 'qms.training',

  register(router) {
    router.use('/training', require('./routes/trainingRouter'));
  },

  getModels() { return require('./models/Training'); },

  setupAssociations(m) {
    if (m.TrainingRecord && m.User) {
      m.User.hasMany(m.TrainingRecord, { as: 'trainings', foreignKey: 'userId' });
      m.TrainingRecord.belongsTo(m.User, { as: 'trainee', foreignKey: 'userId' });
    }
    if (m.CompetencyMatrix && m.User) {
      m.User.hasMany(m.CompetencyMatrix, { as: 'competencies', foreignKey: 'userId' });
      m.CompetencyMatrix.belongsTo(m.User, { as: 'user', foreignKey: 'userId' });
    }
  },
};

================================================================================
FILE: QMS-Server-master/modules/qms-training/models/Training.js
================================================================================

const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");





const TrainingPlan = sequelize.define("training_plan", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  title: { type: DataTypes.STRING, allowNull: false },
  description: { type: DataTypes.TEXT },
  year: { type: DataTypes.INTEGER, allowNull: false },
  status: { type: DataTypes.ENUM("DRAFT", "APPROVED", "IN_PROGRESS", "COMPLETED"), defaultValue: "DRAFT" },
  approvedBy: { type: DataTypes.INTEGER, allowNull: true },
  approvedAt: { type: DataTypes.DATE, allowNull: true },
});

const TrainingRecord = sequelize.define("training_record", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  userId: { type: DataTypes.INTEGER, allowNull: false, comment: "Кого обучали" },
  trainerId: { type: DataTypes.INTEGER, allowNull: true, comment: "Кто обучал" },
  trainingPlanId: { type: DataTypes.INTEGER, allowNull: true },
  
  title: { type: DataTypes.STRING, allowNull: false },
  description: { type: DataTypes.TEXT },
  
  type: {
    type: DataTypes.ENUM(
      "ONBOARDING",      
      "PROCEDURE",       
      "EQUIPMENT",       
      "GMP",             
      "SAFETY",          
      "REGULATORY",      
      "SOFTWARE",        
      "RETRAINING"       
    ),
    allowNull: false
  },
  
  
  relatedDocumentId: { type: DataTypes.INTEGER, allowNull: true, comment: "Документ, по которому обучали" },
  
  trainingDate: { type: DataTypes.DATE, allowNull: false },
  duration: { type: DataTypes.FLOAT, allowNull: true, comment: "Продолжительность в часах" },
  
  
  assessmentMethod: { type: DataTypes.ENUM("TEST", "PRACTICAL", "OBSERVATION", "SELF_STUDY", "NONE"), defaultValue: "NONE" },
  assessmentScore: { type: DataTypes.FLOAT, allowNull: true, comment: "Балл 0-100" },
  passed: { type: DataTypes.BOOLEAN, allowNull: true },
  
  
  confirmedBy: { type: DataTypes.INTEGER, allowNull: true, comment: "Руководитель, подтвердивший компетентность" },
  confirmedAt: { type: DataTypes.DATE, allowNull: true },
  
  certificateUrl: { type: DataTypes.STRING, allowNull: true },
  
  
  expiryDate: { type: DataTypes.DATE, allowNull: true, comment: "Когда нужно переобучение" },
  
  status: { type: DataTypes.ENUM("PLANNED", "COMPLETED", "FAILED", "EXPIRED"), defaultValue: "PLANNED" },
});


const CompetencyMatrix = sequelize.define("competency_matrix", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  
  userId: { type: DataTypes.INTEGER, allowNull: false },
  processName: { type: DataTypes.STRING, allowNull: false, comment: "Название процесса/операции" },
  
  level: {
    type: DataTypes.ENUM("NONE", "AWARENESS", "TRAINED", "COMPETENT", "EXPERT"),
    defaultValue: "NONE",
    comment: "Уровень компетенции"
  },
  
  requiredLevel: {
    type: DataTypes.ENUM("NONE", "AWARENESS", "TRAINED", "COMPETENT", "EXPERT"),
    defaultValue: "TRAINED",
    comment: "Требуемый уровень для должности"
  },
  
  lastTrainingDate: { type: DataTypes.DATE, allowNull: true },
  nextTrainingDate: { type: DataTypes.DATE, allowNull: true },
  
  notes: { type: DataTypes.TEXT, allowNull: true },
});


TrainingPlan.hasMany(TrainingRecord, { as: "records", foreignKey: "trainingPlanId" });
TrainingRecord.belongsTo(TrainingPlan, { as: "trainingPlan", foreignKey: "trainingPlanId" });

module.exports = { TrainingPlan, TrainingRecord, CompetencyMatrix };

================================================================================
FILE: QMS-Server-master/modules/qms-training/routes/trainingRouter.js
================================================================================

const Router = require("express");
const router = new Router();
const ctrl = require("../controllers/trainingController");
const authMiddleware = require("../../core/middleware/authMiddleware");
const syncUserMiddleware = require("../../core/middleware/syncUserMiddleware");
const checkAbility = require("../../core/middleware/checkAbilityMiddleware");

const protect = [authMiddleware, syncUserMiddleware];


router.get("/stats", ...protect, checkAbility("training.read"), ctrl.getStats);


router.get("/plans",      ...protect, checkAbility("training.read"),   ctrl.getPlans);
router.get("/plans/:id",  ...protect, checkAbility("training.read"),   ctrl.getPlanOne);
router.post("/plans",     ...protect, checkAbility("training.manage"), ctrl.createPlan);
router.put("/plans/:id",  ...protect, checkAbility("training.manage"), ctrl.updatePlan);


router.get("/records",      ...protect, checkAbility("training.read"),   ctrl.getRecords);
router.post("/records",     ...protect, checkAbility("training.manage"), ctrl.createRecord);
router.put("/records/:id",  ...protect, checkAbility("training.manage"), ctrl.updateRecord);


router.get("/competency",      ...protect, checkAbility("training.read"),   ctrl.getCompetency);
router.post("/competency",     ...protect, checkAbility("training.manage"), ctrl.createCompetency);
router.put("/competency/:id",  ...protect, checkAbility("training.manage"), ctrl.updateCompetency);

module.exports = router;

================================================================================
FILE: QMS-Server-master/modules/wms/controllers/AlertsController.js
================================================================================

const { Op } = require("sequelize");
const { WarehouseBox, InventoryLimit } = require("../../../models/index");
const sequelize = require("../../../db");
const ApiError = require("../../../error/ApiError");

class AlertsController {
  async getAlerts(req, res, next) {
    try {
      const limits = await InventoryLimit.findAll();

      const balances = await WarehouseBox.findAll({
        attributes: [
          "label",
          "originType",
          "originId",
          [sequelize.fn("SUM", sequelize.col("quantity")), "total"],
        ],
        where: {
          status: {
            [Op.notIn]: ["SCRAP", "SHIPPED"],
          },
        },
        group: ["label", "originType", "originId"],
      });

      const alerts = [];

      for (const limit of limits) {
        let currentQty = 0;

        const foundBalance = balances.find(
          (b) =>
            b.label === limit.label &&
            b.originType === limit.originType &&
            (limit.originId == null || b.originId === limit.originId)
        );

        if (foundBalance) {
          currentQty = Number(foundBalance.get("total")) || 0;
        }

        if (currentQty < limit.minQuantity) {
          alerts.push({
            id: limit.id,
            label: limit.label,
            min: limit.minQuantity,
            current: currentQty,
            deficit: limit.minQuantity - currentQty,
          });
        }
      }

      res.json(alerts);
    } catch (e) {
      console.error("Alerts Error:", e);
      next(ApiError.internal(e.message));
    }
  }

  async getAllLimits(req, res, next) {
    try {
      const limits = await InventoryLimit.findAll({
        order: [["label", "ASC"]],
      });
      res.json(limits);
    } catch (e) {
      console.error("Get Limits Error:", e);
      next(ApiError.internal(e.message));
    }
  }

  async setLimit(req, res, next) {
    try {
      const { label, originType, originId, min } = req.body;

      let whereClause = {};
      if (originId && originType) {
        whereClause = { originId, originType };
      } else {
        whereClause = { label };
      }

      let limit = await InventoryLimit.findOne({ where: whereClause });

      if (limit) {
        if (min <= 0) {
          await limit.destroy();
          return res.json({ message: "Лимит удален" });
        }
        await limit.update({ minQuantity: min, label });
      } else if (min > 0) {
        limit = await InventoryLimit.create({
          label,
          originType,
          originId,
          minQuantity: min,
        });
      }

      res.json(limit);
    } catch (e) {
      next(ApiError.badRequest(e.message));
    }
  }
}

module.exports = new AlertsController();

================================================================================
FILE: QMS-Server-master/modules/wms/controllers/AnalyticsController.js
================================================================================



const { Op } = require("sequelize");
const { WarehouseBox, WarehouseMovement, User, Team, Project } = require("../../../models/index");
const { ProductionOutput, OUTPUT_STATUSES } = require("../../../models/ProductionOutput");
const sequelize = require("../../../db");
const ApiError = require("../../../error/ApiError");

let BoardDefect = null;
let DefectCategory = null;
try {
  const defectModels = require("../../../models/definitions/Defect");
  BoardDefect = defectModels.BoardDefect;
  DefectCategory = defectModels.DefectCategory;
} catch (e) {
  console.log("[Analytics] Модели дефектов не найдены");
}

function calculateDateRange(period, customStartDate, customEndDate) {
  const now = new Date();
  let startDate = new Date(now);
  let endDate = new Date(now);

  startDate.setHours(0, 0, 0, 0);
  endDate.setHours(23, 59, 59, 999);

  switch (period) {
    case 'day':
      break;
    case 'week':
      const dayOfWeek = startDate.getDay() || 7;
      startDate.setDate(startDate.getDate() - (dayOfWeek - 1));
      break;
    case 'month':
      startDate.setDate(1);
      break;
    case 'year':
      startDate.setMonth(0, 1);
      break;
    case 'all':
      startDate = new Date('2020-01-01');
      break;
    case 'custom':
      if (customStartDate) {
        startDate = new Date(customStartDate);
        startDate.setHours(0, 0, 0, 0);
      }
      if (customEndDate) {
        endDate = new Date(customEndDate);
        endDate.setHours(23, 59, 59, 999);
      }
      break;
    default:
      const defaultDay = startDate.getDay() || 7;
      startDate.setDate(startDate.getDate() - (defaultDay - 1));
  }

  return { startDate, endDate };
}

function generateDateRange(startDate, endDate) {
  const dates = [];
  const current = new Date(startDate);
  current.setHours(0, 0, 0, 0);

  const end = new Date(endDate);
  end.setHours(0, 0, 0, 0);

  while (current <= end) {
    dates.push(current.toISOString().split('T')[0]);
    current.setDate(current.getDate() + 1);
  }

  return dates;
}

class AnalyticsController {

  async getDashboardStats(req, res, next) {
    try {
      const {
        period = 'week',
        startDate: customStart,
        endDate: customEnd,
        projectId
      } = req.query;

      const { startDate, endDate } = calculateDateRange(period, customStart, customEnd);
      const startDateStr = startDate.toISOString().split('T')[0];
      const endDateStr = endDate.toISOString().split('T')[0];

      const parsedProjectId = projectId ? Number(projectId) : null;

      console.log(`>>> [Analytics] период=${period}, проект=${parsedProjectId || 'все'}, с ${startDateStr} по ${endDateStr}`);

      const now = new Date();
      const todayStart = new Date(now);
      todayStart.setHours(0, 0, 0, 0);

      const yesterdayStart = new Date(todayStart);
      yesterdayStart.setDate(yesterdayStart.getDate() - 1);

      const warehouseDateCondition = period === 'all'
        ? { [Op.gte]: startDate }
        : { [Op.gte]: startDate, [Op.lte]: endDate };

      const productionDateCondition = period === 'all'
        ? { [Op.gte]: startDateStr }
        : { [Op.gte]: startDateStr, [Op.lte]: endDateStr };

      const productionProjectCondition = parsedProjectId
        ? { projectId: parsedProjectId }
        : {};


      const stockStats = await WarehouseBox.findOne({
        attributes: [
          [sequelize.fn("SUM", sequelize.col("quantity")), "totalItems"],
          [sequelize.fn("COUNT", sequelize.col("id")), "totalBoxes"],
        ],
        where: { status: "ON_STOCK" },
        raw: true
      });


      const periodWarehouse = parsedProjectId ? null : await WarehouseMovement.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("goodQty")), "goodQty"]],
        where: {
          performedAt: warehouseDateCondition,
          performedById: { [Op.ne]: null },
          goodQty: { [Op.gt]: 0 }
        },
        raw: true
      });


      const periodProduction = await ProductionOutput.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("approvedQty")), "approvedQty"]],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });


      const todayWarehouse = parsedProjectId ? null : await WarehouseMovement.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("goodQty")), "goodQty"]],
        where: {
          performedAt: { [Op.gte]: todayStart },
          performedById: { [Op.ne]: null },
          goodQty: { [Op.gt]: 0 }
        },
        raw: true
      });

      const todayProduction = await ProductionOutput.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("approvedQty")), "approvedQty"]],
        where: {
          date: todayStart.toISOString().split('T')[0],
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });


      const yesterdayWarehouse = parsedProjectId ? null : await WarehouseMovement.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("goodQty")), "goodQty"]],
        where: {
          performedAt: { [Op.gte]: yesterdayStart, [Op.lt]: todayStart },
          performedById: { [Op.ne]: null },
          goodQty: { [Op.gt]: 0 }
        },
        raw: true
      });

      const yesterdayProduction = await ProductionOutput.findOne({
        attributes: [[sequelize.fn("SUM", sequelize.col("approvedQty")), "approvedQty"]],
        where: {
          date: yesterdayStart.toISOString().split('T')[0],
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });


      let periodDefects = 0;
      let defectTypes = [];

      if (BoardDefect) {
        try {
          periodDefects = await BoardDefect.count({
            where: { detectedAt: warehouseDateCondition }
          });

          if (DefectCategory && periodDefects > 0) {
            try {
              const defectsByCategory = await BoardDefect.findAll({
                attributes: [
                  "categoryId",
                  [sequelize.fn("COUNT", sequelize.col("board_defect.id")), "count"]
                ],
                where: { detectedAt: warehouseDateCondition },
                include: [{
                  model: DefectCategory,
                  as: "category",
                  attributes: ["title"],
                  required: false
                }],
                group: ["categoryId", "category.id"],
                raw: false
              });

              defectTypes = defectsByCategory
                .filter(d => d.dataValues.count > 0)
                .map(d => ({
                  name: d.category?.title || "Без категории",
                  value: Number(d.dataValues.count) || 0
                }));
            } catch (e) {
              console.log("[Analytics] Ошибка категорий:", e.message);
            }
          }

          if (defectTypes.length === 0 && periodDefects > 0) {
            defectTypes = [{ name: "Дефекты", value: periodDefects }];
          }
        } catch (e) {
          console.log("[Analytics] Ошибка дефектов:", e.message);
        }
      }


      let warehouseUsers = [];
      if (!parsedProjectId) {
        warehouseUsers = await WarehouseMovement.findAll({
          attributes: [[sequelize.fn("DISTINCT", sequelize.col("performedById")), "userId"]],
          where: {
            performedAt: warehouseDateCondition,
            performedById: { [Op.ne]: null }
          },
          raw: true
        });
      }

      const productionUsers = await ProductionOutput.findAll({
        attributes: [[sequelize.fn("DISTINCT", sequelize.col("userId")), "userId"]],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });

      const allUserIds = new Set([
        ...warehouseUsers.map(u => u.userId),
        ...productionUsers.map(u => u.userId)
      ]);
      const activeUsers = allUserIds.size;


      let todayWarehouseUsers = [];
      if (!parsedProjectId) {
        todayWarehouseUsers = await WarehouseMovement.findAll({
          attributes: [[sequelize.fn("DISTINCT", sequelize.col("performedById")), "userId"]],
          where: {
            performedAt: { [Op.gte]: todayStart },
            performedById: { [Op.ne]: null }
          },
          raw: true
        });
      }

      const todayProductionUsers = await ProductionOutput.findAll({
        attributes: [[sequelize.fn("DISTINCT", sequelize.col("userId")), "userId"]],
        where: {
          date: todayStart.toISOString().split('T')[0],
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        raw: true
      });

      const todayUserIds = new Set([
        ...todayWarehouseUsers.map(u => u.userId),
        ...todayProductionUsers.map(u => u.userId)
      ]);
      const activeUsersToday = todayUserIds.size;


      let chartByDay = [];
      if (!parsedProjectId) {
        chartByDay = await WarehouseMovement.findAll({
          attributes: [
            [sequelize.fn("DATE", sequelize.col("performedAt")), "date"],
            [sequelize.fn("SUM", sequelize.col("goodQty")), "output"],
          ],
          where: {
            performedAt: warehouseDateCondition,
            performedById: { [Op.ne]: null },
            goodQty: { [Op.gt]: 0 }
          },
          group: [sequelize.fn("DATE", sequelize.col("performedAt"))],
          order: [[sequelize.fn("DATE", sequelize.col("performedAt")), "ASC"]],
          raw: true
        });
      }

      const productionByDayRaw = await ProductionOutput.findAll({
        attributes: [
          "date",
          [sequelize.fn("SUM", sequelize.col("approvedQty")), "output"],
        ],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        group: ["date"],
        order: [["date", "ASC"]],
        raw: true
      });

      const daysMap = new Map();

      chartByDay.forEach(row => {
        const dateKey = row.date;
        if (!daysMap.has(dateKey)) daysMap.set(dateKey, { output: 0 });
        daysMap.get(dateKey).output += Number(row.output) || 0;
      });

      productionByDayRaw.forEach(row => {
        const dateKey = row.date;
        if (!daysMap.has(dateKey)) daysMap.set(dateKey, { output: 0 });
        daysMap.get(dateKey).output += Number(row.output) || 0;
      });

      const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
      const allDates = generateDateRange(startDate, endDate);

      let filteredDates = allDates;
      let skipFactor = 1;

      if (allDates.length > 90) {
        skipFactor = Math.ceil(allDates.length / 90);
        filteredDates = allDates.filter((_, idx) => idx % skipFactor === 0);
      }

      const productionByDay = filteredDates.map(date => {
        const d = new Date(date);
        const dayOfWeek = d.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

        let output = 0;
        if (skipFactor > 1) {
          const idx = allDates.indexOf(date);
          for (let i = 0; i < skipFactor && idx + i < allDates.length; i++) {
            output += daysMap.get(allDates[idx + i])?.output || 0;
          }
        } else {
          output = daysMap.get(date)?.output || 0;
        }

        return {
          date,
          name: dayNames[dayOfWeek],
          fullDate: date,
          output,
          isWeekend
        };
      });


      let warehouseByUser = [];
      if (!parsedProjectId) {
        warehouseByUser = await WarehouseMovement.findAll({
          attributes: [
            "performedById",
            [sequelize.fn("SUM", sequelize.col("goodQty")), "output"],
          ],
          where: {
            performedAt: warehouseDateCondition,
            performedById: { [Op.ne]: null },
            goodQty: { [Op.gt]: 0 }
          },
          group: ["performedById"],
          raw: true
        });
      }


      const productionByUser = await ProductionOutput.findAll({
        attributes: [
          "userId",
          [sequelize.fn("SUM", sequelize.col("approvedQty")), "output"],
        ],
        where: {
          date: productionDateCondition,
          status: OUTPUT_STATUSES.APPROVED,
          ...productionProjectCondition
        },
        group: ["userId"],
        raw: true
      });


      const userOutputMap = new Map();

      warehouseByUser.forEach(row => {
        const userId = row.performedById;
        if (!userOutputMap.has(userId)) {
          userOutputMap.set(userId, { output: 0 });
        }
        userOutputMap.get(userId).output += Number(row.output) || 0;
      });

      productionByUser.forEach(row => {
        const userId = row.userId;
        if (!userOutputMap.has(userId)) {
          userOutputMap.set(userId, { output: 0 });
        }
        userOutputMap.get(userId).output += Number(row.output) || 0;
      });


      const allUserIdsList = [...userOutputMap.keys()].filter(id => id != null);

      let usersData = [];
      if (allUserIdsList.length > 0) {
        usersData = await User.findAll({
          attributes: ["id", "name", "surname", "teamId"],
          where: { id: { [Op.in]: allUserIdsList } },
          include: [{
            model: Team,
            attributes: ["id", "title"],
            required: false
          }],
          raw: false
        });
      }


      const userDataMap = new Map();
      usersData.forEach(u => {
        const plain = u.get({ plain: true });

        const teamData = plain.Team || plain.team || null;
        userDataMap.set(plain.id, {
          name: plain.name,
          surname: plain.surname,
          teamId: plain.teamId,
          team: teamData
        });
      });

      console.log(`>>> [Analytics] Загружено ${usersData.length} пользователей`);


      let usersWithTeams = 0;
      userDataMap.forEach((data) => {
        if (data.team) usersWithTeams++;
      });
      console.log(`>>> [Analytics] Из них с бригадами: ${usersWithTeams}`);


      const formattedTopUsers = Array.from(userOutputMap.entries())
        .map(([userId, data]) => {
          const user = userDataMap.get(userId);
          return {
            id: userId,
            name: user
              ? `${user.surname || ''} ${(user.name || '')[0] || ''}.`.trim()
              : `ID: ${userId}`,
            output: data.output
          };
        })
        .filter(u => u.output > 0)
        .sort((a, b) => b.output - a.output)
        .slice(0, 5);


      const teamsMap = new Map();


      const teamIds = new Set();
      userDataMap.forEach((data) => {
        if (data.teamId) teamIds.add(data.teamId);
      });


      let teamsData = new Map();
      if (teamIds.size > 0) {
        const teams = await Team.findAll({
          attributes: ["id", "title"],
          where: { id: { [Op.in]: [...teamIds] } },
          raw: true
        });
        teams.forEach(t => teamsData.set(t.id, t));
      }


      userOutputMap.forEach((data, userId) => {
        const user = userDataMap.get(userId);
        const teamId = user?.teamId;

        if (teamId) {
          const team = user.team || teamsData.get(teamId);

          if (team) {
            if (!teamsMap.has(teamId)) {
              teamsMap.set(teamId, {
                id: teamId,
                name: team.title,
                output: 0,
                members: new Set()
              });
            }
            const t = teamsMap.get(teamId);
            t.output += data.output;
            t.members.add(userId);
          }
        }
      });

      const teamStats = Array.from(teamsMap.values())
        .map(t => ({ id: t.id, name: t.name, output: t.output, members: t.members.size }))
        .sort((a, b) => b.output - a.output)
        .slice(0, 5);

      console.log(`>>> [Analytics] Бригад с данными: ${teamStats.length}`);


      const periodOutput = (Number(periodWarehouse?.goodQty) || 0) + (Number(periodProduction?.approvedQty) || 0);
      const todayOutput = (Number(todayWarehouse?.goodQty) || 0) + (Number(todayProduction?.approvedQty) || 0);
      const yesterdayOutput = (Number(yesterdayWarehouse?.goodQty) || 0) + (Number(yesterdayProduction?.approvedQty) || 0);

      const defectRate = (periodOutput + periodDefects) > 0
        ? Number(((periodDefects / (periodOutput + periodDefects)) * 100).toFixed(1))
        : 0;

      const daysDiff = Math.max(1, Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)));


      let projectName = null;
      if (parsedProjectId) {
        const project = await Project.findByPk(parsedProjectId, { attributes: ["title"] });
        projectName = project?.title || null;
      }

      res.json({
        period,
        projectId: parsedProjectId,
        projectName,
        startDate: startDate.toISOString(),
        endDate: endDate.toISOString(),
        daysInPeriod: daysDiff,

        periodOutput,
        periodDefects,
        defectRate,

        todayOutput,
        yesterdayOutput,

        activeUsers,
        activeUsersToday,

        stock: {
          totalItems: Number(stockStats?.totalItems) || 0,
          totalBoxes: Number(stockStats?.totalBoxes) || 0
        },

        productionByDay,
        defectTypes,
        topUsers: formattedTopUsers,
        teamStats,

        generatedAt: new Date().toISOString()
      });

    } catch (e) {
      console.error("Analytics Dashboard Error:", e);
      next(ApiError.internal("Ошибка загрузки аналитики: " + e.message));
    }
  }
}

module.exports = new AnalyticsController();

================================================================================
FILE: QMS-Server-master/modules/wms/controllers/BoxController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../../error/ApiError");
const {
  WarehouseBox,
  WarehouseMovement,
  WarehouseDocument,
  Supply,
  Section,
  Team,
  User,
  PrintHistory
} = require("../../../models/index");
const { logAudit } = require("../../core/utils/auditLogger");
const sequelize = require("../../../db");
const PdfService = require("../../../services/PdfService");

const generateShortCode = () =>
  Math.floor(100000 + Math.random() * 900000).toString();

class BoxController {


  async createSingleBox(req, res, next) {
    try {
      const { supplyId, sectionId, itemName, quantity, unit, kitNumber, comment } = req.body;

      if (!itemName) {
        return next(ApiError.badRequest("Не указано наименование"));
      }
      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("Нет информации о пользователе"));
      }

      const uniqueSuffix = Date.now().toString(36);
      const qrCode = `KRYPTO-${uniqueSuffix.toUpperCase()}`;
      const shortCode = generateShortCode();

      const box = await WarehouseBox.create({
        supplyId: supplyId || null,
        currentSectionId: sectionId || null,
        label: itemName,
        quantity: quantity || 1,
        unit: unit || "шт",
        kitNumber: kitNumber || null,
        qrCode,
        shortCode,
        notes: comment || null,
        status: "ON_STOCK",
        acceptedById: req.user.id,
        acceptedAt: new Date(),
      });

      await logAudit({
        req,
        action: "WAREHOUSE_BOX_CREATE",
        entity: "WarehouseBox",
        entityId: String(box.id),
        description: `Создана коробка ${itemName} (${shortCode})`,
        metadata: { supplyId, sectionId, itemName, quantity },
      });

      return res.json(box);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async createBoxesBatch(req, res, next) {
    try {
      const {
        label,
        projectName,
        batchName,
        originType,
        originId,
        quantity = 1,
        itemsPerBox = 1,
        unit = "шт",
        status = "ON_STOCK",
        currentSectionId = null,
        currentTeamId = null,
        notes,
      } = req.body;

      if (!label) {
        return next(ApiError.badRequest("Не задано название (label)"));
      }

      const qty = Number(quantity);
      if (qty <= 0 || qty > 1000) {
        return next(
          ApiError.badRequest(
            "Количество этикеток должно быть от 1 до 1000",
          ),
        );
      }

      if (!req.user || !req.user.id) {
        return next(ApiError.unauthorized("Нет пользователя"));
      }

      const acceptedById = req.user.id;
      const now = new Date();
      const boxesData = [];

      for (let i = 0; i < qty; i++) {
        const suffix = String(i + 1).padStart(3, "0");
        const qrCode = `BOX-${Date.now()}-${suffix}-${Math.random()
          .toString(36)
          .substr(2, 3)
          .toUpperCase()}`;
        const shortCode = generateShortCode();

        boxesData.push({
          qrCode,
          shortCode,
          label,
          originType: originType || "OTHER",
          originId: originId || null,
          projectName: projectName || null,
          batchName: batchName || null,
          quantity: itemsPerBox,
          unit,
          acceptedAt: now,
          acceptedById,
          status,
          currentSectionId,
          currentTeamId,
          notes: notes || null,
        });
      }

      const created = await WarehouseBox.bulkCreate(boxesData, {
        returning: true,
      });

      await logAudit({
        req,
        action: "WAREHOUSE_BATCH",
        entity: "WarehouseBox",
        description: `Создана партия: ${qty} мест по ${itemsPerBox} ${unit}`,
        metadata: { label, batchName },
      });

      return res.json({ boxes: created });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getBoxes(req, res, next) {
    try {
      const {
        page = 1,
        limit = 50,
        search,
        ...filters
      } = req.query;

      const where = { ...filters };

      Object.keys(where).forEach((key) => {
        if (where[key] === undefined || where[key] === "") {
          delete where[key];
        }
      });

      if (search) {
        const s = String(search).trim();
        where[Op.or] = [
          { qrCode: { [Op.iLike]: `%${s}%` } },
          { shortCode: s },
          { label: { [Op.iLike]: `%${s}%` } },
          { batchName: { [Op.iLike]: `%${s}%` } },
        ];
      }

      const pageNum = Number(page) || 1;
      const limitNum = Number(limit) || 50;
      const offset = (pageNum - 1) * limitNum;

      const { rows, count } = await WarehouseBox.findAndCountAll({
        where,
        limit: limitNum,
        offset,
        order: [["id", "DESC"]],
        include: [
          {
            model: User,
            as: "acceptedBy",
            attributes: ["id", "login", "name", "surname"],
          },
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      res.json({ rows, count, page: pageNum, limit: limitNum });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getBoxById(req, res, next) {
    try {
      const { id } = req.params;

      const box = await WarehouseBox.findByPk(id, {
        include: [
          {
            model: User,
            as: "acceptedBy",
            attributes: ["id", "login", "name", "surname"],
          },
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      if (!box) {
        return next(ApiError.notFound("Коробка не найдена"));
      }

      const movements = await WarehouseMovement.findAll({
        where: { boxId: box.id },
        order: [["performedAt", "DESC"]],
        include: [
          { model: Section, as: "fromSection", attributes: ["id", "title"] },
          { model: Section, as: "toSection", attributes: ["id", "title"] },
          { model: Team, as: "fromTeam", attributes: ["id", "title"] },
          { model: Team, as: "toTeam", attributes: ["id", "title"] },
          {
            model: User,
            as: "performedBy",
            attributes: ["id", "name", "surname"],
          },
        ],
      });

      const documents = await WarehouseDocument.findAll({
        where: { boxId: box.id },
        order: [["date", "DESC"]],
      });

      return res.json({ box, movements, documents });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getBoxByQr(req, res, next) {
    try {
      const encoded = req.params.qr;
      const qrCode = decodeURIComponent(encoded);

      const box = await WarehouseBox.findOne({
        where: { qrCode },
        include: [
          {
            model: User,
            as: "acceptedBy",
            attributes: ["id", "login", "name", "surname"],
          },
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      if (!box) {
        return next(ApiError.notFound("Коробка не найдена"));
      }

      const movements = await WarehouseMovement.findAll({
        where: { boxId: box.id },
        order: [["performedAt", "DESC"]],
      });

      const documents = await WarehouseDocument.findAll({
        where: { boxId: box.id },
        order: [["date", "DESC"]],
      });

      return res.json({ box, movements, documents });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async exportCsv(req, res, next) {
    try {
      const { ids } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return next(ApiError.badRequest("Не переданы ID коробок"));
      }

      const boxes = await WarehouseBox.findAll({
        where: { id: { [Op.in]: ids } },
        include: [{ model: Section, as: "currentSection" }],
        order: [["id", "ASC"]],
      });

      if (!boxes || boxes.length === 0) {
        return next(ApiError.badRequest("Коробки не найдены"));
      }

      let csv = "\uFEFF";
      csv += "ID;ShortCode;Label;Quantity;Unit;Section;QRCode\n";

      boxes.forEach((b) => {
        const section = b.currentSection ? b.currentSection.title : "";
        const row = [
          b.id,
          b.shortCode || "",
          b.label,
          b.quantity,
          b.unit,
          section,
          b.qrCode,
        ]
          .map((field) => `"${String(field).replace(/"/g, '""')}"`)
          .join(";");

        csv += row + "\n";
      });

      res.header("Content-Type", "text/csv; charset=utf-8");
      res.attachment("labels.csv");
      return res.send(csv);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async printLabelsPdf(req, res, next) {
    try {
      const { ids } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return next(ApiError.badRequest("Не переданы ID коробок"));
      }

      const boxes = await WarehouseBox.findAll({
        where: { id: { [Op.in]: ids } },
        order: [["id", "ASC"]],
      });

      if (!boxes.length) {
        return next(ApiError.badRequest("Коробки не найдены"));
      }

      const pdfBuffer = await PdfService.generateLabels(boxes);

      res.set({
        "Content-Type": "application/pdf",
        "Content-Length": pdfBuffer.length,
        "Content-Disposition": `attachment; filename="labels_${Date.now()}.pdf"`,
      });

      return res.send(pdfBuffer);
    } catch (e) {
      console.error("PDF Gen Error:", e);
      next(ApiError.internal("Ошибка генерации PDF: " + e.message));
    }
  }


  async updateBatch(req, res, next) {
    try {
      const { ids, updates } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return next(ApiError.badRequest("Не выбраны коробки для обновления"));
      }

      const allowedFields = ['label', 'quantity', 'unit', 'status', 'batchName', 'projectName', 'notes'];
      const cleanUpdates = {};

      Object.keys(updates).forEach(key => {
        if (allowedFields.includes(key) && updates[key] !== undefined && updates[key] !== "") {
          cleanUpdates[key] = updates[key];
        }
      });

      if (Object.keys(cleanUpdates).length === 0) {
        return next(ApiError.badRequest("Нет данных для обновления"));
      }

      await WarehouseBox.update(cleanUpdates, {
        where: { id: { [Op.in]: ids } }
      });

      await logAudit({
        req,
        action: "WAREHOUSE_BOX_BATCH_UPDATE",
        entity: "WarehouseBox",
        description: `Массовое обновление ${ids.length} коробок`,
        metadata: { ids, updates: cleanUpdates }
      });

      return res.json({ message: "Успешно обновлено" });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async printSpecialLabel(req, res, next) {
    try {
      const {
        template = "VIDEO_KIT",
        customLayout,
        printCount = 1,
        code,
        rotate,
        widthMm,
        heightMm,
        ...restData
      } = req.body;

      const labelsData = [];
      const count = Math.max(1, Number(printCount));

      let startCodeStr = String(code).trim();

      if (/^\d+$/.test(startCodeStr)) {
          const originalLength = startCodeStr.length;
          const startBigInt = BigInt(startCodeStr);

          for (let i = 0; i < count; i++) {
              const nextVal = startBigInt + BigInt(i);
              const nextCodeStr = nextVal.toString().padStart(originalLength, '0');
              const infoString = `${restData.productName} - ${restData.quantity} ${restData.unit} (ID: ${nextCodeStr})`;

              labelsData.push({
                  ...restData,
                  code: nextCodeStr,
                  qrCode: nextCodeStr,
                  bottomQr: infoString,
                  rotate: rotate,
                  currentIndex: i + 1,
                  totalCount: count
              });
          }
      } else {
          const infoString = `${restData.productName} - ${restData.quantity} ${restData.unit} (ID: ${startCodeStr})`;

          for (let i = 0; i < count; i++) {
              labelsData.push({
                  ...restData,
                  code: startCodeStr,
                  qrCode: startCodeStr,
                  bottomQr: infoString,
                  rotate: rotate,
                  currentIndex: i + 1,
                  totalCount: count
              });
          }
      }

      const options = {
          widthMm: Number(widthMm) || 105,
          heightMm: Number(heightMm) || 60
      };

      let pdfBuffer;


      if (template === "VIDEO_KIT") {
          pdfBuffer = await PdfService.generateVideoTransmitterLabelBatch(labelsData, options);
      } else if (template === "CUSTOM" && customLayout && customLayout.length > 0) {

          pdfBuffer = await PdfService.generateCustomLabelBatch(labelsData, customLayout, options);
      } else {
          pdfBuffer = await PdfService.generateSimpleZebraBatch(labelsData, options);
      }


      const userId = req.user ? req.user.id : null;
      let endCodeStr = startCodeStr;

      if (labelsData.length > 0) {
          startCodeStr = labelsData[0].code;
          endCodeStr = labelsData[labelsData.length - 1].code;
      }

      await PrintHistory.create({
          template,
          labelName: restData.productName || "Этикетка",
          startCode: startCodeStr,
          endCode: endCodeStr,
          quantity: count,
          params: {
            ...restData,
            widthMm,
            heightMm,
            rotate,
            customLayout: template === "CUSTOM" ? customLayout : undefined
          },
          createdById: userId
      });

      res.set({
        "Content-Type": "application/pdf",
        "Content-Length": pdfBuffer.length,
        "Content-Disposition": `inline; filename="zebra_label_${template}.pdf"`,
      });

      return res.send(pdfBuffer);
    } catch (e) {
      console.error("Print Special Error:", e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new BoxController();

================================================================================
FILE: QMS-Server-master/modules/wms/controllers/DocumentController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../../error/ApiError");
const { WarehouseDocument, User } = require("../../../models/index");

class DocumentController {
  async createDocument(req, res, next) {
    try {
      const { boxId, number, type, date, fileUrl, comment } = req.body;

      if (!number) {
        return next(ApiError.badRequest("Нужен номер документа"));
      }

      const doc = await WarehouseDocument.create({
        boxId: boxId || null,
        number,
        type: type || null,
        date: date || null,
        fileUrl: fileUrl || null,
        comment: comment || null,
        createdById: req.user.id,
      });

      return res.json(doc);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getDocuments(req, res, next) {
    try {
      let { page = 1, limit = 50, search, type } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 50;

      const where = {};
      if (type) where.type = type;
      if (search) where.number = { [Op.iLike]: `%${search}%` };

      const offset = (page - 1) * limit;

      const data = await WarehouseDocument.findAndCountAll({
        where,
        limit,
        offset,
        order: [["date", "DESC"]],
        include: [
          {
            model: User,
            as: "createdBy",
            attributes: ["name", "surname"],
          },
        ],
      });

      return res.json({
        rows: data.rows,
        count: data.count,
        page,
        limit,
      });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new DocumentController();

================================================================================
FILE: QMS-Server-master/modules/wms/controllers/HistoryController.js
================================================================================

const { PrintHistory, User } = require("../../../models/index");
const { Op } = require("sequelize");
const ApiError = require("../../../error/ApiError");

class HistoryController {
    async getPrintHistory(req, res, next) {
        try {
            let { page = 1, limit = 50, search, template, dateFrom, dateTo } = req.query;
            page = Number(page) || 1;
            limit = Number(limit) || 50;
            const offset = (page - 1) * limit;

            const where = {};

            if (template) where.template = template;

            if (search) {
                const s = String(search).trim();
                where[Op.or] = [
                    { labelName: { [Op.iLike]: `%${s}%` } },
                    { startCode: { [Op.iLike]: `%${s}%` } },
                    { endCode: { [Op.iLike]: `%${s}%` } }
                ];
            }

            if (dateFrom || dateTo) {
                where.createdAt = {};
                if (dateFrom) where.createdAt[Op.gte] = new Date(dateFrom);
                if (dateTo) {
                    const to = new Date(dateTo);
                    to.setDate(to.getDate() + 1);
                    where.createdAt[Op.lt] = to;
                }
            }

            const history = await PrintHistory.findAndCountAll({
                where,
                limit,
                offset,
                order: [["createdAt", "DESC"]],
                include: [
                    {
                        model: User,
                        as: "createdBy",
                        attributes: ["id", "name", "surname"]
                    }
                ]
            });

            return res.json({
                rows: history.rows,
                count: history.count,
                page,
                limit
            });

        } catch (e) {
            next(ApiError.internal(e.message));
        }
    }
}

module.exports = new HistoryController();

================================================================================
FILE: QMS-Server-master/modules/wms/controllers/MovementController.js
================================================================================

const { Op } = require("sequelize");
const ApiError = require("../../../error/ApiError");
const {
  WarehouseBox,
  WarehouseMovement,
  WarehouseDocument,
  Supply,
  Section,
  Team,
  User,
} = require("../../../models/index");
const { logAudit } = require("../../core/utils/auditLogger");
const sequelize = require("../../../db");

class MovementController {

  async moveSingle(req, res, next) {
    const t = await sequelize.transaction();
    try {
      const {
        boxId,
        operation,
        toSectionId,
        toTeamId,
        statusAfter,
        deltaQty = 0,
        goodQty = null,
        scrapQty = null,
        comment,
        documentId,
      } = req.body;

      if (!boxId || !operation) {
        await t.rollback();
        return next(ApiError.badRequest("Не указан boxId или operation"));
      }

      const box = await WarehouseBox.findByPk(boxId, { transaction: t });
      if (!box) {
        await t.rollback();
        return next(ApiError.notFound("Коробка не найдена"));
      }

      const fromSectionId = box.currentSectionId;
      const fromTeamId = box.currentTeamId;

      let newQty = box.quantity;
      const delta = Number(deltaQty) || 0;

      if (delta !== 0) {
        newQty = box.quantity + delta;
        if (newQty < 0) {
          await t.rollback();
          return next(ApiError.badRequest("Количество не может быть отрицательным"));
        }
        box.quantity = newQty;
      }

      if (toSectionId !== undefined) box.currentSectionId = toSectionId || null;
      if (toTeamId !== undefined) box.currentTeamId = toTeamId || null;
      if (statusAfter) box.status = statusAfter;

      await box.save({ transaction: t });

      const movement = await WarehouseMovement.create(
        {
          boxId: box.id,
          documentId: documentId || null,
          fromSectionId,
          toSectionId: toSectionId || null,
          fromTeamId,
          toTeamId: toTeamId || null,
          operation,
          statusAfter: box.status,
          deltaQty: delta,
          goodQty: goodQty !== undefined ? goodQty : null,
          scrapQty: scrapQty !== undefined ? scrapQty : null,
          performedAt: new Date(),
          comment: comment || null,
          performedById: req.user ? req.user.id : null,
        },
        { transaction: t }
      );

      await logAudit({
        req,
        action: "WAREHOUSE_MOVE",
        entity: "WarehouseMovement",
        entityId: String(movement.id),
        description: `Операция ${operation} с коробкой #${box.id}`,
        metadata: {
          boxId: box.id,
          fromSectionId,
          toSectionId,
          deltaQty: delta,
        },
      });

      await t.commit();

      const reloadedBox = await WarehouseBox.findByPk(box.id, {
        include: [
          { model: Section, as: "currentSection", attributes: ["id", "title"] },
          { model: Team, as: "currentTeam", attributes: ["id", "title"] },
          { model: Supply, as: "supply" },
        ],
      });

      return res.json({ box: reloadedBox, movement });
    } catch (e) {
      await t.rollback();
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async moveBatch(req, res, next) {
    const t = await sequelize.transaction();
    try {
      const { docNumber, items } = req.body;

      if (!items || !Array.isArray(items) || items.length === 0) {
        await t.rollback();
        return next(ApiError.badRequest("Пустой список операций"));
      }

      let document = null;
      if (docNumber) {
        document = await WarehouseDocument.create(
          {
            boxId: null,
            number: docNumber,
            type: "MOVEMENT",
            date: new Date(),
            fileUrl: null,
            comment: null,
            createdById: req.user ? req.user.id : null,
          },
          { transaction: t }
        );
      }

      const documentId = document ? document.id : null;

      const movements = [];
      const updatedBoxes = [];

      for (const raw of items) {
        const boxId = raw.boxId || (raw.box && raw.box.id);
        if (!boxId) {
          await t.rollback();
          return next(ApiError.badRequest("В одном из элементов нет boxId"));
        }

        const {
          operation,
          toSectionId,
          toTeamId,
          statusAfter,
          deltaQty = 0,
          goodQty = null,
          scrapQty = null,
          comment,
        } = raw;

        const box = await WarehouseBox.findByPk(boxId, { transaction: t });
        if (!box) {
          await t.rollback();
          return next(ApiError.notFound(`Коробка ${boxId} не найдена`));
        }

        const fromSectionId = box.currentSectionId;
        const fromTeamId = box.currentTeamId;
        const delta = Number(deltaQty) || 0;

        if (delta !== 0) {
          const newQty = box.quantity + delta;
          if (newQty < 0) {
            await t.rollback();
            return next(
              ApiError.badRequest(`Отрицательное количество для коробки ${boxId}`)
            );
          }
          box.quantity = newQty;
        }

        if (toSectionId !== undefined) box.currentSectionId = toSectionId || null;
        if (toTeamId !== undefined) box.currentTeamId = toTeamId || null;
        if (statusAfter) box.status = statusAfter;

        await box.save({ transaction: t });

        const movement = await WarehouseMovement.create(
          {
            boxId: box.id,
            documentId,
            fromSectionId,
            toSectionId: toSectionId || null,
            fromTeamId,
            toTeamId: toTeamId || null,
            operation,
            statusAfter: box.status,
            deltaQty: delta,
            goodQty: goodQty !== undefined ? goodQty : null,
            scrapQty: scrapQty !== undefined ? scrapQty : null,
            performedAt: new Date(),
            comment: comment || null,
            performedById: req.user ? req.user.id : null,
          },
          { transaction: t }
        );

        movements.push(movement);
        updatedBoxes.push(box);
      }

      await logAudit({
        req,
        action: "WAREHOUSE_MOVE_BATCH",
        entity: "WarehouseMovement",
        description: `Пакетное перемещение, операций: ${movements.length}`,
        metadata: {
          docNumber: docNumber || null,
          count: movements.length,
        },
      });

      await t.commit();

      return res.json({
        message: "Операции успешно выполнены",
        count: movements.length,
        document: document || null,
      });
    } catch (e) {
      await t.rollback();
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getMovements(req, res, next) {
    try {
      let { page = 1, limit = 50, boxId, fromDate, toDate } = req.query;
      page = Number(page) || 1;
      limit = Number(limit) || 50;

      const where = {};
      if (boxId) where.boxId = boxId;

      if (fromDate || toDate) {
        where.performedAt = {};
        if (fromDate) where.performedAt[Op.gte] = new Date(fromDate);
        if (toDate) where.performedAt[Op.lte] = new Date(toDate);
      }

      const offset = (page - 1) * limit;

      const { rows, count } = await WarehouseMovement.findAndCountAll({
        where,
        limit,
        offset,
        order: [["performedAt", "DESC"]],
        include: [
          { model: Section, as: "fromSection", attributes: ["id", "title"] },
          { model: Section, as: "toSection", attributes: ["id", "title"] },
          { model: Team, as: "fromTeam", attributes: ["id", "title"] },
          { model: Team, as: "toTeam", attributes: ["id", "title"] },
          {
            model: User,
            as: "performedBy",
            attributes: ["id", "name", "surname"],
          },
        ],
      });

      return res.json({ rows, count, page, limit });
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async getBalance(req, res, next) {
    try {
      const balances = await WarehouseBox.findAll({
        attributes: [
          "label",
          "originType",
          "originId",
          "unit",
          [sequelize.fn("SUM", sequelize.col("quantity")), "totalQuantity"],
          [sequelize.fn("COUNT", sequelize.col("id")), "boxCount"],
        ],
        where: {
          status: {
            [Op.notIn]: ["SCRAP", "SHIPPED"],
          },
        },
        group: ["label", "originType", "originId", "unit"],
        order: [["label", "ASC"]],
      });

      return res.json(balances);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new MovementController();

================================================================================
FILE: QMS-Server-master/modules/wms/controllers/SupplyController.js
================================================================================

const ApiError = require("../../../error/ApiError");
const { Supply, WarehouseBox, Section } = require("../../../models/index");
const { logAudit } = require("../../core/utils/auditLogger");

class SupplyController {
  async createSupply(req, res, next) {
    try {
      const { supplier, docNumber, expectedDate, comment } = req.body;

      const supply = await Supply.create({
        supplier: supplier || null,
        docNumber: docNumber || null,
        expectedDate: expectedDate || null,
        comment: comment || null,
        status: "NEW",
      });

      await logAudit({
        req,
        action: "SUPPLY_CREATE",
        entity: "Supply",
        entityId: String(supply.id),
        description: `Поставка ${docNumber || `#${supply.id}`}`,
      });

      return res.json(supply);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }

  async getSupplies(req, res, next) {
    try {
      const supplies = await Supply.findAll({
        order: [["createdAt", "DESC"]],
      });
      return res.json(supplies);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }


  async exportCsv(req, res, next) {
    try {
      const { id } = req.params;

      const boxes = await WarehouseBox.findAll({
        where: { supplyId: id },
        include: [{ model: Section, as: "currentSection" }],
        order: [["id", "ASC"]],
      });

      if (!boxes || boxes.length === 0) {
        return next(ApiError.badRequest("Нет коробок в этой поставке"));
      }

      let csvContent = "\uFEFF";
      csvContent += "ID;ShortCode;Label;Quantity;Unit;Section;QRCode\n";

      boxes.forEach((box) => {
        const section = box.currentSection ? box.currentSection.title : "";
        const row = [
          box.id,
          box.shortCode || "",
          box.label,
          box.quantity,
          box.unit,
          section,
          box.qrCode,
        ]
          .map((field) => `"${String(field).replace(/"/g, '""')}"`)
          .join(";");

        csvContent += row + "\n";
      });

      res.header("Content-Type", "text/csv; charset=utf-8");
      res.attachment(`supply_${id}_labels.csv`);
      return res.send(csvContent);
    } catch (e) {
      console.error(e);
      next(ApiError.internal(e.message));
    }
  }
}

module.exports = new SupplyController();

================================================================================
FILE: QMS-Server-master/modules/wms/index.js
================================================================================

module.exports = {
  code: 'wms.warehouse',

  register(router) {
    router.use('/warehouse', require('./routes/warehouseRouter'));
  },

  getModels() {
    return require('./models/Warehouse');
  },

  setupAssociations(m) {
    
    m.Supply.hasMany(m.WarehouseBox, { foreignKey: 'supplyId', as: 'boxes' });
    m.WarehouseBox.belongsTo(m.Supply, { foreignKey: 'supplyId', as: 'supply' });

    
    m.User.hasMany(m.WarehouseBox, { foreignKey: 'acceptedById', as: 'acceptedBoxes' });
    m.WarehouseBox.belongsTo(m.User, { foreignKey: 'acceptedById', as: 'acceptedBy' });

    
    m.WarehouseBox.belongsTo(m.Section, { foreignKey: 'currentSectionId', as: 'currentSection' });
    m.Section.hasMany(m.WarehouseBox, { foreignKey: 'currentSectionId', as: 'boxes' });

    
    m.WarehouseBox.hasMany(m.WarehouseMovement, { foreignKey: 'boxId', as: 'movements' });
    m.WarehouseMovement.belongsTo(m.WarehouseBox, { foreignKey: 'boxId', as: 'box' });

    
    m.WarehouseMovement.belongsTo(m.User, { foreignKey: 'performedById', as: 'performedBy' });
    m.WarehouseMovement.belongsTo(m.Section, { foreignKey: 'fromSectionId', as: 'fromSection' });
    m.WarehouseMovement.belongsTo(m.Section, { foreignKey: 'toSectionId', as: 'toSection' });

    
    if (m.ProductionTask) {
      m.ProductionTask.belongsTo(m.User, { foreignKey: 'responsibleId', as: 'responsible' });
      m.ProductionTask.belongsTo(m.User, { foreignKey: 'createdById', as: 'createdBy' });
      if (m.Project) {
        m.ProductionTask.belongsTo(m.Project, { foreignKey: 'projectId', as: 'project' });
      }
    }
  },
};

================================================================================
FILE: QMS-Server-master/modules/wms/models/Warehouse.js
================================================================================

const sequelize = require("../../../db");
const { DataTypes } = require("sequelize");


const Supply = sequelize.define("supply", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplier: { type: DataTypes.STRING, allowNull: true },
  docNumber: { type: DataTypes.STRING, allowNull: true },
  status: { type: DataTypes.STRING, defaultValue: "NEW" },
  comment: { type: DataTypes.TEXT, allowNull: true },
  expectedDate: { type: DataTypes.DATEONLY, allowNull: true },
  receivedAt: { type: DataTypes.DATE, defaultValue: DataTypes.NOW },
});


const WarehouseBox = sequelize.define("warehouse_box", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  supplyId: { type: DataTypes.INTEGER, allowNull: true },


  qrCode: { type: DataTypes.STRING, unique: true, allowNull: false },
  shortCode: { type: DataTypes.STRING, unique: true, allowNull: true },


  label: { type: DataTypes.STRING, allowNull: false },


  originType: { type: DataTypes.STRING, allowNull: true },
  originId: { type: DataTypes.INTEGER, allowNull: true },


  quantity: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 1 },
  unit: { type: DataTypes.STRING, allowNull: false, defaultValue: "шт" },


  parentBoxId: { type: DataTypes.INTEGER, allowNull: true },


  kitNumber: { type: DataTypes.STRING, allowNull: true },
  projectName: { type: DataTypes.STRING, allowNull: true },
  batchName: { type: DataTypes.STRING, allowNull: true },


  status: { type: DataTypes.STRING, allowNull: false, defaultValue: "ON_STOCK" },
  notes: { type: DataTypes.TEXT, allowNull: true },


  currentSectionId: { type: DataTypes.INTEGER, allowNull: true },
  currentTeamId: { type: DataTypes.INTEGER, allowNull: true },

  acceptedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  acceptedById: { type: DataTypes.INTEGER, allowNull: false },
});


const WarehouseMovement = sequelize.define("warehouse_movement", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  boxId: { type: DataTypes.INTEGER, allowNull: false },
  documentId: { type: DataTypes.INTEGER, allowNull: true },

  fromSectionId: { type: DataTypes.INTEGER, allowNull: true },
  fromTeamId: { type: DataTypes.INTEGER, allowNull: true },
  toSectionId: { type: DataTypes.INTEGER, allowNull: true },
  toTeamId: { type: DataTypes.INTEGER, allowNull: true },

  operation: { type: DataTypes.STRING, allowNull: false },
  statusAfter: { type: DataTypes.STRING, allowNull: true },

  deltaQty: { type: DataTypes.INTEGER, allowNull: true, defaultValue: 0 },
  goodQty: { type: DataTypes.INTEGER, allowNull: true },
  scrapQty: { type: DataTypes.INTEGER, allowNull: true },

  performedById: { type: DataTypes.INTEGER, allowNull: false },
  performedAt: { type: DataTypes.DATE, allowNull: false, defaultValue: DataTypes.NOW },
  comment: { type: DataTypes.TEXT, allowNull: true },
});


const WarehouseDocument = sequelize.define("warehouse_document", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  boxId: { type: DataTypes.INTEGER, allowNull: true },
  number: { type: DataTypes.STRING, allowNull: false },
  type: { type: DataTypes.STRING, allowNull: true },
  date: { type: DataTypes.DATEONLY, allowNull: true },
  fileUrl: { type: DataTypes.STRING, allowNull: true },
  comment: { type: DataTypes.TEXT, allowNull: true },
  createdById: { type: DataTypes.INTEGER, allowNull: false },
});


const InventoryLimit = sequelize.define("inventory_limit", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  originType: { type: DataTypes.STRING, allowNull: true },
  originId: { type: DataTypes.INTEGER, allowNull: true },
  label: { type: DataTypes.STRING, allowNull: true },
  minQuantity: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
});


const ProductionTask = sequelize.define("production_task", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },

  title: { type: DataTypes.STRING, allowNull: false },


  originType: { type: DataTypes.STRING, allowNull: true },
  originId: { type: DataTypes.INTEGER, allowNull: true },

  targetQty: { type: DataTypes.INTEGER, allowNull: false },
  unit: { type: DataTypes.STRING, allowNull: false, defaultValue: "шт" },

  dueDate: { type: DataTypes.DATEONLY, allowNull: true },

  status: { type: DataTypes.STRING, allowNull: false, defaultValue: "NEW" },
  priority: { type: DataTypes.INTEGER, allowNull: true },

  comment: { type: DataTypes.TEXT, allowNull: true },

  createdById: { type: DataTypes.INTEGER, allowNull: false },


  responsibleId: { type: DataTypes.INTEGER, allowNull: true },
  sectionId: { type: DataTypes.INTEGER, allowNull: true },
  projectId: { type: DataTypes.INTEGER, allowNull: true },
});


const PrintHistory = sequelize.define("print_history", {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  template: { type: DataTypes.STRING, allowNull: false },

  labelName: { type: DataTypes.STRING },
  startCode: { type: DataTypes.STRING },
  endCode: { type: DataTypes.STRING },

  quantity: { type: DataTypes.INTEGER },


  params: { type: DataTypes.JSONB },

  createdById: { type: DataTypes.INTEGER, allowNull: true },
  createdAt: { type: DataTypes.DATE, defaultValue: DataTypes.NOW }
});

module.exports = {
  Supply,
  WarehouseBox,
  WarehouseMovement,
  WarehouseDocument,
  InventoryLimit,
  ProductionTask,
  PrintHistory
};

================================================================================
FILE: QMS-Server-master/modules/wms/routes/warehouseRouter.js
================================================================================

const Router = require("express");
const router = new Router();

const authMiddleware = require("../../core/middleware/authMiddleware");
const syncUserMiddleware = require("../../core/middleware/syncUserMiddleware");
const checkAbility = require("../../core/middleware/checkAbilityMiddleware");

const SupplyController = require("../controllers/SupplyController");
const BoxController = require("../controllers/BoxController");
const MovementController = require("../controllers/MovementController");
const DocumentController = require("../controllers/DocumentController");
const AnalyticsController = require("../controllers/AnalyticsController");
const AlertsController = require("../controllers/AlertsController");
const HistoryController = require("../controllers/HistoryController");

const protect = [authMiddleware, syncUserMiddleware];


router.post("/supplies", ...protect, checkAbility("warehouse.manage"), SupplyController.createSupply);
router.get("/supplies", ...protect, checkAbility("warehouse.view"), SupplyController.getSupplies);
router.get("/supplies/:id/export-csv", ...protect, checkAbility("warehouse.view"), SupplyController.exportCsv);


router.post("/boxes", ...protect, checkAbility("warehouse.manage"), BoxController.createSingleBox);
router.post("/boxes/batch", ...protect, checkAbility("warehouse.manage"), BoxController.createBoxesBatch);


router.put("/boxes/batch", ...protect, checkAbility("warehouse.manage"), BoxController.updateBatch);


router.get("/boxes", ...protect, checkAbility("warehouse.view"), BoxController.getBoxes);
router.get("/boxes/:id", ...protect, checkAbility("warehouse.view"), BoxController.getBoxById);
router.get("/boxes/by-qr/:qr", ...protect, checkAbility("warehouse.view"), BoxController.getBoxByQr);


router.post("/boxes/export", ...protect, checkAbility("warehouse.view"), BoxController.exportCsv);
router.post("/boxes/print-pdf", ...protect, checkAbility("labels.print"), BoxController.printLabelsPdf);


router.post("/boxes/print-special", ...protect, checkAbility("labels.print"), BoxController.printSpecialLabel);


router.get("/print-history", ...protect, checkAbility("labels.print"), HistoryController.getPrintHistory);


router.post("/movements", ...protect, checkAbility("warehouse.manage"), MovementController.moveSingle);
router.post("/movements/batch", ...protect, checkAbility("warehouse.manage"), MovementController.moveBatch);
router.get("/movements", ...protect, checkAbility("warehouse.view"), MovementController.getMovements);


router.get("/balance", ...protect, checkAbility("warehouse.view"), MovementController.getBalance);


router.post("/documents", ...protect, checkAbility("warehouse.manage"), DocumentController.createDocument);
router.get("/documents", ...protect, checkAbility("warehouse.view"), DocumentController.getDocuments);


router.get("/analytics/dashboard", ...protect, checkAbility("analytics.view"), AnalyticsController.getDashboardStats);

router.get("/alerts", ...protect, checkAbility("warehouse.view"), AlertsController.getAlerts);
router.get("/limits", ...protect, checkAbility("warehouse.view"), AlertsController.getAllLimits);
router.post("/limits", ...protect, checkAbility("warehouse.manage"), AlertsController.setLimit);


module.exports = router;

================================================================================
FILE: QMS-Server-master/package.json
================================================================================

{
  "name": "fc-server",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "dev": "nodemon index.js",
    "start": "node index.js",
    "db:reset": "node scripts/db-reset.js",
    "db:compare": "node scripts/db-schema-compare.js",
    "db:compare:json": "node scripts/db-schema-compare.js --json",
    "db:compare:fix": "node scripts/db-schema-compare.js --fix-sql",
    "db:migrate": "npx sequelize-cli db:migrate",
    "test": "cross-env NODE_ENV=test jest --detectOpenHandles",
    "test:watch": "cross-env NODE_ENV=test jest --watch",
    "test:coverage": "cross-env NODE_ENV=test jest --coverage"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "axios": "^1.13.2",
    "cors": "^2.8.5",
    "dotenv": "^16.4.7",
    "exceljs": "^4.4.0",
    "express": "^4.21.2",
    "express-fileupload": "^1.5.1",
    "express-oauth2-jwt-bearer": "^1.7.1",
    "jsonwebtoken": "^9.0.2",
    "multer": "^2.0.2",
    "node-ssh": "^13.2.1",
    "pdfmake": "^0.2.20",
    "pg": "^8.13.1",
    "pg-hstore": "^2.3.4",
    "sequelize": "^6.37.5",
    "uuid": "^11.1.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "cross-env": "^7.0.3",
    "jest": "^29.7.0",
    "nodemon": "^3.1.9",
    "sequelize-cli": "^6.6.5",
    "supertest": "^6.3.3"
  }
}

================================================================================
FILE: QMS-Server-master/routes/index.js
================================================================================

const Router = require("express");
const path = require("path");
const fs = require("fs");
const router = new Router();
const { moduleManager } = require("../config/modules");
const checkModule = require("../middleware/checkModuleMiddleware");


const coreModule = require("../modules/core");
coreModule.register(router);


const MODULE_DIRS = {
  'qms.dms':       'qms-dms',
  'qms.nc':        'qms-nc',
  'qms.risk':      'qms-risk',
  'qms.supplier':  'qms-supplier',
  'qms.audit':     'qms-audit',
  'qms.training':  'qms-training',
  'qms.equipment': 'qms-equipment',
  'qms.review':    'qms-review',
  'wms.warehouse': 'wms',
};

const loadedDirs = new Set();

for (const [moduleCode, dirName] of Object.entries(MODULE_DIRS)) {
  if (loadedDirs.has(dirName)) continue;
  if (moduleManager.isEnabled(moduleCode)) {
    const indexPath = path.join(__dirname, '..', 'modules', dirName, 'index.js');
    if (fs.existsSync(indexPath)) {
      const mod = require(indexPath);
      if (typeof mod.register === 'function') {
        mod.register(router);
        console.log(`  Routes: ${dirName}`);
      }
      loadedDirs.add(dirName);
    }
  }
}


router.get("/system/modules", (req, res) => {
  res.json(moduleManager.toClientConfig());
});

module.exports = router;

================================================================================
FILE: QMS-Server-master/run-migration.js
================================================================================



require("dotenv").config();
const { Sequelize } = require("sequelize");

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASSWORD,
  {
    dialect: "postgres",
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    logging: console.log
  }
);

async function runMigration() {
  try {
    console.log("🔌 Подключение к базе данных...");
    await sequelize.authenticate();
    console.log("✅ Подключено к:", process.env.DB_NAME);

    console.log("\n🚀 Запуск миграции: Дефекты + Мониторинг\n");


    console.log("📊 Добавляем поля мониторинга в beryll_servers...");


    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "lastPingAt" TIMESTAMP;
    `).catch(e => console.log("  - lastPingAt:", e.message));


    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_servers_pingstatus') THEN
          CREATE TYPE "enum_beryll_servers_pingstatus" AS ENUM ('ONLINE', 'OFFLINE', 'UNKNOWN');
        END IF;
      END$$;
    `).catch(e => console.log("  - ENUM pingStatus:", e.message));


    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "pingStatus" "enum_beryll_servers_pingstatus" DEFAULT 'UNKNOWN';
    `).catch(e => console.log("  - pingStatus:", e.message));


    await sequelize.query(`
      ALTER TABLE beryll_servers
      ADD COLUMN IF NOT EXISTS "pingLatency" FLOAT;
    `).catch(e => console.log("  - pingLatency:", e.message));

    console.log("✅ Поля мониторинга добавлены\n");


    console.log("💬 Создаём таблицу beryll_defect_comments...");

    await sequelize.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_defect_comments_defectcategory') THEN
          CREATE TYPE "enum_beryll_defect_comments_defectcategory" AS ENUM ('HARDWARE', 'SOFTWARE', 'ASSEMBLY', 'COMPONENT', 'OTHER');
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_defect_comments_priority') THEN
          CREATE TYPE "enum_beryll_defect_comments_priority" AS ENUM ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL');
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'enum_beryll_defect_comments_status') THEN
          CREATE TYPE "enum_beryll_defect_comments_status" AS ENUM ('NEW', 'IN_PROGRESS', 'RESOLVED', 'WONT_FIX');
        END IF;
      END$$;
    `);

    await sequelize.query(`
      CREATE TABLE IF NOT EXISTS beryll_defect_comments (
        id SERIAL PRIMARY KEY,
        "serverId" INTEGER NOT NULL REFERENCES beryll_servers(id) ON UPDATE CASCADE ON DELETE CASCADE,
        "userId" INTEGER NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        text TEXT NOT NULL,
        "defectCategory" "enum_beryll_defect_comments_defectcategory" DEFAULT 'OTHER',
        priority "enum_beryll_defect_comments_priority" DEFAULT 'MEDIUM',
        status "enum_beryll_defect_comments_status" NOT NULL DEFAULT 'NEW',
        "resolvedById" INTEGER REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        "resolvedAt" TIMESTAMP,
        resolution TEXT,
        "createdAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        "updatedAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
      );
    `);


    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_server ON beryll_defect_comments("serverId");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_status ON beryll_defect_comments(status);`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_category ON beryll_defect_comments("defectCategory");`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_priority ON beryll_defect_comments(priority);`);
    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_comments_created ON beryll_defect_comments("createdAt");`);

    console.log("✅ Таблица beryll_defect_comments создана\n");


    console.log("📎 Создаём таблицу beryll_defect_files...");

    await sequelize.query(`
      CREATE TABLE IF NOT EXISTS beryll_defect_files (
        id SERIAL PRIMARY KEY,
        "commentId" INTEGER NOT NULL REFERENCES beryll_defect_comments(id) ON UPDATE CASCADE ON DELETE CASCADE,
        "originalName" VARCHAR(255) NOT NULL,
        "fileName" VARCHAR(255) NOT NULL,
        "filePath" VARCHAR(500) NOT NULL,
        "mimeType" VARCHAR(100),
        "fileSize" INTEGER,
        "uploadedById" INTEGER REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
        "createdAt" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
      );
    `);

    await sequelize.query(`CREATE INDEX IF NOT EXISTS idx_defect_files_comment ON beryll_defect_files("commentId");`);

    console.log("✅ Таблица beryll_defect_files создана\n");


    console.log("📝 Добавляем новые action типы в историю...");

    const newActions = [
      'DEFECT_COMMENT_ADDED',
      'DEFECT_STATUS_CHANGED',
      'DEFECT_COMMENT_DELETED',
      'DEFECT_FILE_UPLOADED',
      'DEFECT_FILE_DELETED'
    ];

    for (const action of newActions) {
      await sequelize.query(`
        DO $$
        BEGIN
          ALTER TYPE "enum_beryll_history_action" ADD VALUE IF NOT EXISTS '${action}';
        EXCEPTION
          WHEN duplicate_object THEN NULL;
        END$$;
      `).catch(e => console.log(`  - ${action}: уже существует`));
    }

    console.log("✅ Action типы добавлены\n");


    const fs = require("fs");
    const path = require("path");
    const uploadsDir = path.join(__dirname, "uploads/beryll/defects");

    if (!fs.existsSync(uploadsDir)) {
      fs.mkdirSync(uploadsDir, { recursive: true });
      console.log("📁 Создана папка:", uploadsDir);
    } else {
      console.log("📁 Папка уже существует:", uploadsDir);
    }

    console.log("\n" + "=".repeat(50));
    console.log("✅ МИГРАЦИЯ УСПЕШНО ЗАВЕРШЕНА!");
    console.log("=".repeat(50));


    const [tables] = await sequelize.query(`
      SELECT table_name FROM information_schema.tables
      WHERE table_schema = 'public' AND table_name LIKE 'beryll%'
      ORDER BY table_name;
    `);
    console.log("\n📋 Таблицы Beryll:");
    tables.forEach(t => console.log("  -", t.table_name));

  } catch (error) {
    console.error("\n❌ ОШИБКА МИГРАЦИИ:", error.message);
    console.error(error);
    process.exit(1);
  } finally {
    await sequelize.close();
    console.log("\n🔌 Соединение закрыто");
  }
}

runMigration();

================================================================================
FILE: QMS-Server-master/scripts/backfill-audit-hashes.js
================================================================================



















require("dotenv").config();
const sequelize = require("../db");
const { AuditLog } = require("../models/index");
const { computeDataHash, computeChainHash, GENESIS_HASH } = require("../utils/hashChainLogger");

const BATCH_SIZE = 100;

async function backfill() {
  console.log("═══════════════════════════════════════════════");
  console.log("  ASVO-QMS: Backfill hash-chain для audit_logs");
  console.log("═══════════════════════════════════════════════\n");

  
  const unchainedCount = await AuditLog.count({
    where: { chainIndex: null },
  });

  const chainedCount = await AuditLog.count({
    where: { chainIndex: { [sequelize.Sequelize.Op.ne]: null } },
  });

  console.log(`Записей без hash-chain: ${unchainedCount}`);
  console.log(`Записей с hash-chain:   ${chainedCount}`);

  if (unchainedCount === 0) {
    console.log("\n✅ Все записи уже имеют hash-chain. Нечего делать.");
    process.exit(0);
  }

  
  let startChainIndex = 1;
  let prevHash = GENESIS_HASH;

  if (chainedCount > 0) {
    const lastChained = await AuditLog.findOne({
      where: { chainIndex: { [sequelize.Sequelize.Op.ne]: null } },
      order: [["chainIndex", "DESC"]],
      attributes: ["chainIndex", "currentHash"],
      raw: true,
    });

    if (lastChained) {
      startChainIndex = Number(lastChained.chainIndex) + 1;
      prevHash = lastChained.currentHash;
      console.log(`Продолжаем цепочку с chainIndex=${startChainIndex}`);
    }
  }

  console.log(`\nНачинаем backfill с chainIndex=${startChainIndex}...\n`);

  
  let processed = 0;
  let currentChainIndex = startChainIndex;
  let currentPrevHash = prevHash;
  const startTime = Date.now();

  while (true) {
    
    const records = await AuditLog.findAll({
      where: { chainIndex: null },
      order: [["createdAt", "ASC"], ["id", "ASC"]],
      limit: BATCH_SIZE,
      raw: true,
    });

    if (records.length === 0) break;

    
    const transaction = await sequelize.transaction();

    try {
      for (const record of records) {
        const dataHash = computeDataHash({
          userId: record.userId,
          action: record.action,
          entity: record.entity,
          entityId: record.entityId,
          description: record.description,
          metadata: record.metadata,
          createdAt: record.createdAt,
        });

        const currentHash = computeChainHash(currentChainIndex, currentPrevHash, dataHash);

        await AuditLog.update(
          {
            chainIndex: currentChainIndex,
            prevHash: currentPrevHash,
            currentHash,
            dataHash,
            severity: record.severity || "INFO",
          },
          {
            where: { id: record.id },
            transaction,
          }
        );

        currentPrevHash = currentHash;
        currentChainIndex++;
        processed++;
      }

      await transaction.commit();

      
      const percent = Math.round((processed / unchainedCount) * 100);
      const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      const rate = Math.round(processed / (elapsed || 1));
      process.stdout.write(
        `\r  [${percent}%] ${processed}/${unchainedCount} записей | ${elapsed}s | ${rate} записей/сек`
      );
    } catch (error) {
      await transaction.rollback();
      console.error(`\n\n❌ Ошибка на записи #${processed + 1}:`, error.message);
      process.exit(1);
    }
  }

  const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);

  console.log(`\n\n═══════════════════════════════════════════════`);
  console.log(`  ✅ Backfill завершён!`);
  console.log(`  Обработано: ${processed} записей`);
  console.log(`  Время: ${totalTime}s`);
  console.log(`  chainIndex: ${startChainIndex} → ${currentChainIndex - 1}`);
  console.log(`  Последний hash: ${currentPrevHash.substring(0, 16)}...`);
  console.log(`═══════════════════════════════════════════════\n`);

  
  console.log("Запускаем верификацию...");
  const { quickVerify } = require("../utils/auditVerifier");
  const report = await quickVerify(Math.min(processed, 100));

  if (report.valid) {
    console.log(`✅ Верификация пройдена: ${report.validRecords}/${report.totalRecords} записей ОК`);
  } else {
    console.log(`❌ Найдены ошибки: ${report.invalidRecords} нарушений`);
    report.errors.forEach((e) => {
      console.log(`   chainIndex=${e.chainIndex}: ${e.errors.join("; ")}`);
    });
  }

  process.exit(0);
}

backfill().catch((err) => {
  console.error("Fatal error:", err);
  process.exit(1);
});

================================================================================
FILE: QMS-Server-master/scripts/db-reset.js
================================================================================

#!/usr/bin/env node













require("dotenv").config();
const { execSync } = require("child_process");
const path = require("path");

async function main() {
  console.log("╔══════════════════════════════════════╗");
  console.log("║       ASVO-QMS Database Reset        ║");
  console.log("╚══════════════════════════════════════╝");
  console.log();

  
  const sequelize = require("../db");
  try {
    await sequelize.authenticate();
    console.log("✅ Database connection OK");
  } catch (e) {
    console.error("❌ Cannot connect to database:", e.message);
    process.exit(1);
  }

  
  console.log("\n>>> Dropping all tables...");
  try {
    await sequelize.query("DROP SCHEMA public CASCADE;");
    await sequelize.query("CREATE SCHEMA public;");
    await sequelize.query("GRANT ALL ON SCHEMA public TO public;");
    console.log("✅ Schema dropped and recreated");
  } catch (e) {
    console.error("❌ Error dropping schema:", e.message);
    process.exit(1);
  }

  
  console.log("\n>>> Running migrations...");
  try {
    const migrationsDir = path.resolve(__dirname, "..");
    const output = execSync("npx sequelize-cli db:migrate", {
      cwd: migrationsDir,
      encoding: "utf8",
      stdio: ["pipe", "pipe", "pipe"],
      env: { ...process.env },
    });
    console.log(output);
    console.log("✅ All migrations applied");
  } catch (e) {
    console.error("❌ Migration failed:");
    if (e.stdout) console.error(e.stdout);
    if (e.stderr) console.error(e.stderr);
    process.exit(1);
  }

  
  console.log("\n>>> Syncing remaining models (alter: true for safety)...");
  try {
    
    require("../models/index");
    await sequelize.sync({ alter: true });
    console.log("✅ Model sync complete");
  } catch (e) {
    console.error("⚠️  Model sync warning:", e.message);
    
  }

  
  console.log("\n>>> Initializing RBAC (roles, abilities)...");
  try {
    const models = require("../models/index");

    
    const permissions = [
      { code: "rbac.manage", description: "Управление ролями и матрицей прав" },
      { code: "users.manage", description: "Назначение ролей пользователям" },
      { code: "warehouse.view", description: "Просмотр остатков" },
      { code: "warehouse.manage", description: "Приемка, создание коробок, перемещение" },
      { code: "labels.print", description: "Печать этикеток" },
      { code: "dms.view", description: "Просмотр реестра документов" },
      { code: "dms.create", description: "Создание документов" },
      { code: "dms.approve", description: "Согласование документов" },
      { code: "dms.manage", description: "Введение в действие, рассылка" },
      { code: "qms.audit.view", description: "Расширенный аудит-лог" },
      { code: "qms.audit.verify", description: "Верификация hash-chain" },
      { code: "qms.audit.report", description: "Отчёты для инспекции" },
      { code: "nc.view", description: "Просмотр несоответствий" },
      { code: "nc.create", description: "Регистрация NC" },
      { code: "nc.manage", description: "Управление NC" },
      { code: "capa.view", description: "Просмотр CAPA" },
      { code: "capa.create", description: "Создание CAPA" },
      { code: "capa.manage", description: "Управление CAPA" },
      { code: "capa.verify", description: "Проверка эффективности CAPA" },
      { code: "risk.read", description: "Просмотр реестра рисков" },
      { code: "risk.create", description: "Идентификация рисков" },
      { code: "risk.update", description: "Обновление оценки рисков" },
      { code: "risk.assess", description: "Проведение оценки рисков" },
      { code: "risk.accept", description: "Принятие остаточного риска" },
      { code: "internal-audit.read", description: "Просмотр внутренних аудитов" },
      { code: "internal-audit.manage", description: "Управление внутренними аудитами" },
      { code: "supplier.read", description: "Просмотр поставщиков" },
      { code: "supplier.manage", description: "Управление поставщиками" },
      { code: "training.read", description: "Просмотр записей обучения" },
      { code: "training.manage", description: "Управление обучением" },
      { code: "equipment.read", description: "Просмотр оборудования" },
      { code: "equipment.calibrate", description: "Калибровка/поверка" },
      { code: "review.read", description: "Просмотр анализа руководства" },
      { code: "review.manage", description: "Проведение анализа руководства" },
      { code: "analytics.view", description: "Просмотр дашбордов и KPI" },
      { code: "audit.log.view", description: "Просмотр журнала аудита" },
    ];

    for (const p of permissions) {
      await models.Ability.findOrCreate({ where: { code: p.code }, defaults: p });
    }
    console.log(`  ✅ ${permissions.length} abilities ensured`);

    
    const rolesData = [
      { code: "SUPER_ADMIN", name: "SUPER_ADMIN", description: "Полный доступ" },
      { code: "QMS_DIRECTOR", name: "QMS_DIRECTOR", description: "Директор по качеству" },
      { code: "QMS_ENGINEER", name: "QMS_ENGINEER", description: "Инженер по качеству" },
      { code: "QMS_AUDITOR", name: "QMS_AUDITOR", description: "Внутренний аудитор" },
      { code: "DOC_CONTROLLER", name: "DOC_CONTROLLER", description: "Управление документацией" },
      { code: "QC_ENGINEER", name: "QC_ENGINEER", description: "Инженер ОТК" },
      { code: "WAREHOUSE_MASTER", name: "WAREHOUSE_MASTER", description: "Кладовщик" },
      { code: "VIEWER", name: "VIEWER", description: "Наблюдатель — только просмотр" },
    ];

    for (const roleData of rolesData) {
      await models.Role.findOrCreate({
        where: { code: roleData.code },
        defaults: roleData,
      });
    }
    console.log(`  ✅ ${rolesData.length} roles ensured`);

    
    const assign = async (roleName, slugs) => {
      const role = await models.Role.findOne({ where: { name: roleName } });
      if (!role) return;
      let abilities;
      if (slugs === "*") {
        abilities = await models.Ability.findAll();
      } else {
        abilities = await models.Ability.findAll({ where: { code: slugs } });
      }
      if (abilities.length) {
        await role.setAbilities(abilities);
      }
    };

    await assign("SUPER_ADMIN", "*");
    await assign("QMS_DIRECTOR", [
      "dms.view", "dms.create", "dms.approve", "dms.manage",
      "nc.view", "nc.create", "nc.manage",
      "capa.view", "capa.create", "capa.manage", "capa.verify",
      "risk.read", "risk.create", "risk.update", "risk.assess", "risk.accept",
      "supplier.read", "supplier.manage",
      "internal-audit.read", "internal-audit.manage",
      "training.read", "training.manage",
      "equipment.read", "equipment.calibrate",
      "review.read", "review.manage",
      "qms.audit.view", "qms.audit.verify", "qms.audit.report",
      "analytics.view", "audit.log.view",
      "warehouse.view", "rbac.manage", "users.manage",
    ]);
    await assign("QMS_ENGINEER", [
      "dms.view", "dms.create",
      "nc.view", "nc.create", "nc.manage",
      "capa.view", "capa.create",
      "risk.read", "risk.create", "risk.update", "risk.assess",
      "supplier.read",
      "internal-audit.read",
      "training.read", "training.manage",
      "equipment.read", "equipment.calibrate",
      "review.read",
      "qms.audit.view",
      "analytics.view", "audit.log.view",
    ]);
    await assign("QMS_AUDITOR", [
      "dms.view", "nc.view", "capa.view", "risk.read",
      "supplier.read", "training.read", "equipment.read", "review.read",
      "internal-audit.read", "internal-audit.manage",
      "qms.audit.view", "qms.audit.verify", "qms.audit.report",
      "analytics.view", "audit.log.view",
    ]);
    await assign("DOC_CONTROLLER", [
      "dms.view", "dms.create", "dms.approve", "dms.manage",
      "training.read", "analytics.view",
    ]);
    await assign("QC_ENGINEER", [
      "warehouse.view",
      "nc.view", "nc.create", "nc.manage",
      "capa.view", "capa.create", "capa.manage", "capa.verify",
      "qms.audit.view", "risk.read", "equipment.read",
    ]);
    await assign("WAREHOUSE_MASTER", [
      "warehouse.view", "warehouse.manage", "labels.print",
      "supplier.read", "nc.view", "nc.create", "dms.view",
    ]);
    await assign("VIEWER", [
      "dms.view", "nc.view", "capa.view", "risk.read",
      "supplier.read", "internal-audit.read", "training.read", "equipment.read",
      "review.read", "analytics.view",
    ]);

    console.log("  ✅ Role-ability assignments complete");

    
    const tableCount = await sequelize.query(
      "SELECT COUNT(*) AS cnt FROM pg_tables WHERE schemaname = 'public'",
      { type: sequelize.constructor.QueryTypes.SELECT }
    );
    const roleCount = await models.Role.count();
    const abilityCount = await models.Ability.count();

    console.log("\n╔══════════════════════════════════════╗");
    console.log("║         DB Reset — Summary           ║");
    console.log("╠══════════════════════════════════════╣");
    console.log(`║  Tables:     ${String(tableCount[0].cnt).padEnd(24)}║`);
    console.log(`║  Roles:      ${String(roleCount).padEnd(24)}║`);
    console.log(`║  Abilities:  ${String(abilityCount).padEnd(24)}║`);
    console.log("╚══════════════════════════════════════╝");
    console.log("\n✅ Database reset complete!");
  } catch (e) {
    console.error("❌ RBAC initialization failed:", e);
    process.exit(1);
  }

  process.exit(0);
}

main();

================================================================================
FILE: QMS-Server-master/scripts/db-schema-compare.js
================================================================================

#!/usr/bin/env node























require("dotenv").config();

const path = require("path");
const fs = require("fs");



const SEQ_TO_PG = {
  INTEGER:   "integer",
  BIGINT:    "bigint",
  SMALLINT:  "smallint",
  FLOAT:     "double precision",
  REAL:      "real",
  DOUBLE:    "double precision",
  "DOUBLE PRECISION": "double precision",
  DECIMAL:   "numeric",
  NUMERIC:   "numeric",
  BOOLEAN:   "boolean",
  STRING:    "character varying",
  VARCHAR:   "character varying",
  TEXT:      "text",
  CITEXT:    "citext",
  UUID:      "uuid",
  UUIDV4:   "uuid",
  DATE:      "timestamp with time zone",
  DATEONLY:  "date",
  TIME:      "time without time zone",
  NOW:       "timestamp with time zone",
  BLOB:      "bytea",
  JSON:      "json",
  JSONB:     "jsonb",
  ENUM:      "USER-DEFINED",
  ARRAY:     "ARRAY",
  GEOMETRY:  "USER-DEFINED",
};




function seqTypeToPg(attribute) {
  const type = attribute.type;
  if (!type) return "unknown";

  const key = type.key || type.constructor?.key || "";

  if (key === "ENUM") return "USER-DEFINED";
  if (key === "ARRAY") return "ARRAY";

  
  const match = SEQ_TO_PG[key];
  if (match) return match;

  
  const raw = String(type).toUpperCase();
  for (const [k, v] of Object.entries(SEQ_TO_PG)) {
    if (raw.startsWith(k)) return v;
  }

  return raw.toLowerCase();
}




async function main() {
  const args = process.argv.slice(2);
  const jsonMode = args.includes("--json");
  const fixSql = args.includes("--fix-sql");

  
  const sequelize = require("../db");
  try {
    await sequelize.authenticate();
    if (!jsonMode) console.log("  Connected to database\n");
  } catch (e) {
    console.error("Cannot connect to database:", e.message);
    process.exit(1);
  }

  
  if (!jsonMode) console.log("  Loading Sequelize models...\n");

  const modulesDir = path.join(__dirname, "..", "modules");
  const allModels = {};

  
  const corePath = path.join(modulesDir, "core", "index.js");
  if (fs.existsSync(corePath)) {
    const core = require(corePath);
    if (typeof core.getModels === "function") Object.assign(allModels, core.getModels());
  }

  
  const dirs = fs.readdirSync(modulesDir).filter(d => {
    const full = path.join(modulesDir, d, "index.js");
    return d !== "core" && fs.existsSync(full);
  });

  for (const dir of dirs) {
    try {
      const mod = require(path.join(modulesDir, dir, "index.js"));
      if (typeof mod.getModels === "function") {
        Object.assign(allModels, mod.getModels());
      }
    } catch (e) {
      if (!jsonMode) console.warn(`  Warning: could not load module "${dir}": ${e.message}`);
    }
  }

  
  try {
    const core = require(corePath);
    if (typeof core.setupAssociations === "function") core.setupAssociations(allModels);
  } catch (_) {  }

  for (const dir of dirs) {
    try {
      const mod = require(path.join(modulesDir, dir, "index.js"));
      if (typeof mod.setupAssociations === "function") mod.setupAssociations(allModels);
    } catch (_) {  }
  }

  
  const modelDefs = {}; 

  for (const [modelName, model] of Object.entries(allModels)) {
    if (!model || !model.rawAttributes) continue;
    const tableName = model.getTableName();
    if (typeof tableName !== "string") continue;

    const columns = {};
    for (const [colName, attr] of Object.entries(model.rawAttributes)) {
      const field = attr.field || colName;
      columns[field] = {
        seqType: seqTypeToPg(attr),
        allowNull: attr.allowNull !== false,
        defaultValue: attr.defaultValue,
        primaryKey: !!attr.primaryKey,
        autoIncrement: !!attr.autoIncrement,
        modelName,
        attributeName: colName,
      };
    }
    
    if (!columns.createdAt && model.options.timestamps !== false) {
      columns.createdAt = { seqType: "timestamp with time zone", allowNull: false, defaultValue: null, primaryKey: false, autoIncrement: false, modelName, attributeName: "createdAt" };
      columns.updatedAt = { seqType: "timestamp with time zone", allowNull: false, defaultValue: null, primaryKey: false, autoIncrement: false, modelName, attributeName: "updatedAt" };
    }

    modelDefs[tableName] = { modelName, columns };
  }

  if (!jsonMode) console.log(`  Found ${Object.keys(modelDefs).length} model tables\n`);

  
  const [dbColumns] = await sequelize.query(`
    SELECT
      c.table_name,
      c.column_name,
      c.data_type,
      c.udt_name,
      c.is_nullable,
      c.column_default,
      c.character_maximum_length
    FROM information_schema.columns c
    WHERE c.table_schema = 'public'
    ORDER BY c.table_name, c.ordinal_position;
  `);

  
  const dbTables = {};
  for (const row of dbColumns) {
    if (!dbTables[row.table_name]) dbTables[row.table_name] = {};
    dbTables[row.table_name][row.column_name] = {
      dataType: row.data_type,
      udtName: row.udt_name,
      isNullable: row.is_nullable === "YES",
      columnDefault: row.column_default,
      maxLength: row.character_maximum_length,
    };
  }

  if (!jsonMode) console.log(`  Found ${Object.keys(dbTables).length} DB tables\n`);

  
  const report = {
    summary: { modelTables: 0, dbTables: 0, missingTables: 0, extraTables: 0, tablesDiffCount: 0, totalIssues: 0 },
    missingInDb: [],       
    extraInDb: [],         
    tableDiffs: [],        
  };

  const systemTables = new Set(["SequelizeMeta", "sequelizemeta"]);
  const modelTableNames = new Set(Object.keys(modelDefs));
  const dbTableNames = new Set(Object.keys(dbTables));

  report.summary.modelTables = modelTableNames.size;
  report.summary.dbTables = dbTableNames.size;

  
  for (const t of modelTableNames) {
    if (!dbTableNames.has(t)) {
      report.missingInDb.push({ table: t, model: modelDefs[t].modelName });
      report.summary.missingTables++;
      report.summary.totalIssues++;
    }
  }

  
  for (const t of dbTableNames) {
    if (!modelTableNames.has(t) && !systemTables.has(t)) {
      report.extraInDb.push({ table: t });
      report.summary.extraTables++;
    }
  }

  
  for (const tableName of modelTableNames) {
    if (!dbTableNames.has(tableName)) continue;

    const modelCols = modelDefs[tableName].columns;
    const dbCols = dbTables[tableName];
    const diff = {
      table: tableName,
      model: modelDefs[tableName].modelName,
      missingColumns: [],
      extraColumns: [],
      typeMismatches: [],
      nullableMismatches: [],
    };

    const modelColNames = new Set(Object.keys(modelCols));
    const dbColNames = new Set(Object.keys(dbCols));

    
    for (const col of modelColNames) {
      if (!dbColNames.has(col)) {
        diff.missingColumns.push({
          column: col,
          expectedType: modelCols[col].seqType,
          nullable: modelCols[col].allowNull,
        });
        report.summary.totalIssues++;
      }
    }

    
    for (const col of dbColNames) {
      if (!modelColNames.has(col)) {
        diff.extraColumns.push({
          column: col,
          dbType: dbCols[col].dataType,
        });
      }
    }

    
    for (const col of modelColNames) {
      if (!dbColNames.has(col)) continue;

      const mCol = modelCols[col];
      const dCol = dbCols[col];

      
      const expectedPg = mCol.seqType;
      const actualPg = dCol.dataType;
      const typeMatch =
        expectedPg === actualPg ||
        (expectedPg === "USER-DEFINED" && actualPg === "USER-DEFINED") ||
        (expectedPg === "character varying" && actualPg === "character varying") ||
        (expectedPg === "integer" && actualPg === "integer" && mCol.autoIncrement) ||
        
        (expectedPg === "integer" && actualPg === "integer");

      if (!typeMatch) {
        diff.typeMismatches.push({
          column: col,
          expected: expectedPg,
          actual: actualPg,
        });
        report.summary.totalIssues++;
      }

      
      if (!mCol.primaryKey && mCol.allowNull !== dCol.isNullable) {
        diff.nullableMismatches.push({
          column: col,
          expectedNullable: mCol.allowNull,
          actualNullable: dCol.isNullable,
        });
        report.summary.totalIssues++;
      }
    }

    const hasDiffs =
      diff.missingColumns.length > 0 ||
      diff.extraColumns.length > 0 ||
      diff.typeMismatches.length > 0 ||
      diff.nullableMismatches.length > 0;

    if (hasDiffs) {
      report.tableDiffs.push(diff);
      report.summary.tablesDiffCount++;
    }
  }

  
  if (jsonMode) {
    console.log(JSON.stringify(report, null, 2));
    await sequelize.close();
    process.exit(report.summary.totalIssues > 0 ? 1 : 0);
    return;
  }

  
  console.log("=".repeat(60));
  console.log("  ASVO-QMS  Schema Comparison Report");
  console.log("=".repeat(60));
  console.log();
  console.log(`  Model tables:   ${report.summary.modelTables}`);
  console.log(`  DB tables:      ${report.summary.dbTables}`);
  console.log(`  Missing in DB:  ${report.summary.missingTables}`);
  console.log(`  Extra in DB:    ${report.summary.extraTables}`);
  console.log(`  Tables w/diffs: ${report.summary.tablesDiffCount}`);
  console.log(`  Total issues:   ${report.summary.totalIssues}`);
  console.log();

  
  if (report.missingInDb.length > 0) {
    console.log("-".repeat(60));
    console.log("  MISSING TABLES (in models, not in DB)");
    console.log("-".repeat(60));
    for (const t of report.missingInDb) {
      console.log(`    [!]  ${t.table}  (model: ${t.model})`);
    }
    console.log();
  }

  
  if (report.extraInDb.length > 0) {
    console.log("-".repeat(60));
    console.log("  EXTRA TABLES (in DB, not in models)");
    console.log("-".repeat(60));
    for (const t of report.extraInDb) {
      console.log(`    [?]  ${t.table}`);
    }
    console.log();
  }

  
  if (report.tableDiffs.length > 0) {
    console.log("-".repeat(60));
    console.log("  TABLE-LEVEL DIFFERENCES");
    console.log("-".repeat(60));

    for (const diff of report.tableDiffs) {
      console.log(`\n  >> ${diff.table} (model: ${diff.model})`);

      if (diff.missingColumns.length > 0) {
        console.log("     Missing columns (in model, not in DB):");
        for (const c of diff.missingColumns) {
          console.log(`       [-] ${c.column}  (${c.expectedType}, nullable=${c.nullable})`);
        }
      }

      if (diff.extraColumns.length > 0) {
        console.log("     Extra columns (in DB, not in model):");
        for (const c of diff.extraColumns) {
          console.log(`       [+] ${c.column}  (${c.dbType})`);
        }
      }

      if (diff.typeMismatches.length > 0) {
        console.log("     Type mismatches:");
        for (const c of diff.typeMismatches) {
          console.log(`       [~] ${c.column}  model=${c.expected}  db=${c.actual}`);
        }
      }

      if (diff.nullableMismatches.length > 0) {
        console.log("     Nullable mismatches:");
        for (const c of diff.nullableMismatches) {
          console.log(`       [N] ${c.column}  model.nullable=${c.expectedNullable}  db.nullable=${c.actualNullable}`);
        }
      }
    }
    console.log();
  }

  
  if (fixSql) {
    console.log("=".repeat(60));
    console.log("  SUGGESTED ALTER STATEMENTS");
    console.log("=".repeat(60));
    console.log();
    console.log("-- WARNING: Review carefully before executing!\n");

    
    for (const t of report.missingInDb) {
      const cols = modelDefs[t.table]?.columns || {};
      const colDefs = Object.entries(cols).map(([colName, col]) => {
        let def = `  "${colName}" ${col.seqType}`;
        if (col.primaryKey) def += " PRIMARY KEY";
        if (col.autoIncrement) def = `  "${colName}" SERIAL PRIMARY KEY`;
        if (!col.allowNull && !col.primaryKey) def += " NOT NULL";
        return def;
      });
      console.log(`CREATE TABLE IF NOT EXISTS "${t.table}" (`);
      console.log(colDefs.join(",\n"));
      console.log(`);\n`);
    }

    
    for (const diff of report.tableDiffs) {
      for (const c of diff.missingColumns) {
        const nullable = c.nullable ? "" : " NOT NULL";
        console.log(`ALTER TABLE "${diff.table}" ADD COLUMN IF NOT EXISTS "${c.column}" ${c.expectedType}${nullable};`);
      }
    }

    console.log();
  }

  
  if (report.summary.totalIssues === 0) {
    console.log("  All model definitions match the database schema.\n");
  } else {
    console.log(`  Found ${report.summary.totalIssues} issue(s). Review above.\n`);
  }

  await sequelize.close();
  process.exit(report.summary.totalIssues > 0 ? 1 : 0);
}

main().catch(e => {
  console.error("Fatal error:", e);
  process.exit(2);
});

================================================================================
FILE: QMS-Server-master/scripts/verify-requires.js
================================================================================

const path = require('path');
const fs = require('fs');
let broken = 0;
let checked = 0;

const dirs = process.argv.slice(2);
if (dirs.length === 0) {
  dirs.push('modules/', 'models/', 'routes/', 'middleware/', 'services/');
}

function check(dir) {
  if (!fs.existsSync(dir)) return;
  const entries = fs.readdirSync(dir, { withFileTypes: true, recursive: true });
  for (const entry of entries) {
    const fp = path.join(entry.parentPath || entry.path, entry.name);
    if (!fp.endsWith('.js') || entry.isDirectory()) continue;
    const content = fs.readFileSync(fp, 'utf8');
    const matches = content.matchAll(/require\(['"](\.[^'"]+)['"]\)/g);
    for (const m of matches) {
      checked++;
      const resolved = path.resolve(path.dirname(fp), m[1]);
      if (!fs.existsSync(resolved + '.js') && !fs.existsSync(resolved + '/index.js') && !fs.existsSync(resolved)) {
        console.log('BROKEN:', fp, '->', m[1]);
        broken++;
      }
    }
  }
}

for (const d of dirs) {
  check(d);
}

console.log('Checked', checked, 'requires.');
if (broken) {
  console.log(broken + ' BROKEN requires found!');
  process.exit(1);
} else {
  console.log('OK: All requires resolve');
}

================================================================================
FILE: QMS-Server-master/services/ExcelImportService.js
================================================================================



const XLSX = require("xlsx");
const path = require("path");
const fs = require("fs");
const { sequelize } = require("../models/index");

class ExcelImportService {


    async importServerComponents(filePath, options = {}) {
        const { dryRun = false, skipExisting = true } = options;

        const workbook = XLSX.readFile(filePath);
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const results = {
            servers: [],
            components: [],
            errors: [],
            skipped: []
        };

        const {
            BeryllServer,
            BeryllServerComponent,
            ComponentInventory,
            ComponentCatalog
        } = require("../models/index");


        for (let i = 2; i < data.length; i++) {
            const row = data[i];
            if (!row || !row[0]) continue;

            try {
                const serverSerial = String(row[0]).trim();


                let server = await BeryllServer.findOne({
                    where: { apkSerialNumber: serverSerial }
                });

                if (!server) {
                    if (!dryRun) {
                        server = await BeryllServer.create({
                            apkSerialNumber: serverSerial,
                            status: "NEW"
                        });
                    }
                    results.servers.push({ serial: serverSerial, action: "created" });
                } else {
                    results.servers.push({ serial: serverSerial, action: "exists" });
                }


                const components = [];


                for (let j = 1; j <= 12; j++) {
                    const serialYadro = row[j] ? String(row[j]).trim() : null;
                    if (serialYadro) {
                        components.push({
                            type: "HDD",
                            serialNumberYadro: serialYadro,
                            serialNumber: serialYadro,
                            slot: `HDD_${j}`
                        });
                    }
                }


                for (let j = 13; j <= 24; j++) {
                    const serialYadro = row[j] ? String(row[j]).trim() : null;
                    if (serialYadro) {
                        components.push({
                            type: "RAM",
                            serialNumberYadro: serialYadro,
                            serialNumber: serialYadro,
                            slot: `DIMM_${j - 12}`
                        });
                    }
                }


                for (let j = 25; j <= 28; j++) {
                    const serialYadro = row[j] ? String(row[j]).trim() : null;
                    if (serialYadro) {
                        components.push({
                            type: "SSD",
                            serialNumberYadro: serialYadro,
                            serialNumber: serialYadro,
                            slot: `SSD_${j - 24}`
                        });
                    }
                }


                const psu1Yadro = row[29] ? String(row[29]).trim() : null;
                const psu1Manuf = row[30] ? String(row[30]).trim() : null;
                if (psu1Yadro || psu1Manuf) {
                    components.push({
                        type: "PSU",
                        serialNumberYadro: psu1Yadro,
                        serialNumber: psu1Manuf || psu1Yadro,
                        slot: "PSU_1"
                    });
                }


                const psu2Yadro = row[31] ? String(row[31]).trim() : null;
                const psu2Manuf = row[32] ? String(row[32]).trim() : null;
                if (psu2Yadro || psu2Manuf) {
                    components.push({
                        type: "PSU",
                        serialNumberYadro: psu2Yadro,
                        serialNumber: psu2Manuf || psu2Yadro,
                        slot: "PSU_2"
                    });
                }


                for (const comp of components) {
                    try {

                        const existingInventory = await ComponentInventory.findOne({
                            where: {
                                serialNumber: comp.serialNumber
                            }
                        });

                        if (existingInventory) {
                            if (skipExisting) {
                                results.skipped.push({
                                    server: serverSerial,
                                    component: comp,
                                    reason: "duplicate"
                                });
                                continue;
                            }
                        }

                        if (!dryRun) {

                            const inventoryRecord = await ComponentInventory.create({
                                type: comp.type,
                                serialNumber: comp.serialNumber,
                                serialNumberYadro: comp.serialNumberYadro,
                                status: "IN_USE",
                                condition: "NEW",
                                currentServerId: server?.id
                            });


                            if (server) {
                                await BeryllServerComponent.create({
                                    serverId: server.id,
                                    type: comp.type,
                                    serialNumberYadro: comp.serialNumberYadro,
                                    serialNumberManuf: comp.serialNumber !== comp.serialNumberYadro ? comp.serialNumber : null,
                                    slot: comp.slot,
                                    inventoryId: inventoryRecord.id,
                                    installedAt: new Date()
                                });
                            }
                        }

                        results.components.push({
                            server: serverSerial,
                            type: comp.type,
                            serial: comp.serialNumber,
                            action: "created"
                        });

                    } catch (compError) {
                        results.errors.push({
                            server: serverSerial,
                            component: comp,
                            error: compError.message
                        });
                    }
                }

            } catch (rowError) {
                results.errors.push({
                    row: i + 1,
                    error: rowError.message
                });
            }
        }

        return results;
    }


    async importDefectRecords(filePath, options = {}) {
        const { dryRun = false } = options;

        const workbook = XLSX.readFile(filePath);
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const results = {
            records: [],
            errors: [],
            skipped: []
        };

        const {
            BeryllServer,
            BeryllDefectRecord,
            UserAlias,
            User
        } = require("../models/index");


        const headers = data[0];
        const colIndex = this.findColumnIndexes(headers, {
            ticketNumber: ["№ заявки", "заявка", "ticket"],
            serverSerial: ["S/N сервер", "серийный", "server"],
            clusterCode: ["кластер", "cluster"],
            defectDate: ["дата", "date"],
            problemDescription: ["описание", "проблема", "description"],
            partType: ["тип детали", "деталь", "part"],
            defectSerial: ["S/N браковой", "браковая"],
            replacementSerial: ["S/N замена", "замена"],
            status: ["статус", "status"],
            diagnostician: ["диагностик", "исполнитель"]
        });


        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            if (!row || row.every(cell => !cell)) continue;

            try {
                const ticketNumber = this.getCellValue(row, colIndex.ticketNumber);
                const serverSerial = this.getCellValue(row, colIndex.serverSerial);

                if (!serverSerial) {
                    results.skipped.push({ row: i + 1, reason: "no server serial" });
                    continue;
                }


                const server = await BeryllServer.findOne({
                    where: { apkSerialNumber: serverSerial }
                });

                if (!server) {
                    results.errors.push({ row: i + 1, error: `Server not found: ${serverSerial}` });
                    continue;
                }


                if (ticketNumber) {
                    const existing = await BeryllDefectRecord.findOne({
                        where: { yadroTicketNumber: ticketNumber }
                    });

                    if (existing) {
                        results.skipped.push({ row: i + 1, reason: "duplicate ticket" });
                        continue;
                    }
                }


                let detectedAt = new Date();
                const dateValue = this.getCellValue(row, colIndex.defectDate);
                if (dateValue) {
                    if (typeof dateValue === "number") {

                        detectedAt = this.excelDateToJS(dateValue);
                    } else {
                        detectedAt = new Date(dateValue);
                    }
                }


                let diagnosticianId = null;
                const diagnosticianName = this.getCellValue(row, colIndex.diagnostician);
                if (diagnosticianName) {
                    const user = await UserAlias.findUserByAlias(diagnosticianName);
                    if (user) {
                        diagnosticianId = user.id;
                    }
                }


                const partTypeRaw = this.getCellValue(row, colIndex.partType);
                const repairPartType = this.mapPartType(partTypeRaw);


                const statusRaw = this.getCellValue(row, colIndex.status);
                const status = this.mapStatus(statusRaw);

                if (!dryRun) {
                    const record = await BeryllDefectRecord.create({
                        serverId: server.id,
                        yadroTicketNumber: ticketNumber || null,
                        clusterCode: this.getCellValue(row, colIndex.clusterCode) || null,
                        detectedAt,
                        problemDescription: this.getCellValue(row, colIndex.problemDescription) || null,
                        repairPartType,
                        defectPartSerialYadro: this.getCellValue(row, colIndex.defectSerial) || null,
                        replacementPartSerialYadro: this.getCellValue(row, colIndex.replacementSerial) || null,
                        status,
                        diagnosticianId
                    });

                    results.records.push({
                        id: record.id,
                        ticketNumber,
                        server: serverSerial
                    });
                } else {
                    results.records.push({
                        ticketNumber,
                        server: serverSerial,
                        dryRun: true
                    });
                }

            } catch (rowError) {
                results.errors.push({
                    row: i + 1,
                    error: rowError.message
                });
            }
        }

        return results;
    }


    findColumnIndexes(headers, mappings) {
        const indexes = {};

        for (const [key, searchTerms] of Object.entries(mappings)) {
            indexes[key] = null;

            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i] || "").toLowerCase().trim();

                for (const term of searchTerms) {
                    if (header.includes(term.toLowerCase())) {
                        indexes[key] = i;
                        break;
                    }
                }

                if (indexes[key] !== null) break;
            }
        }

        return indexes;
    }

    getCellValue(row, index) {
        if (index === null || index === undefined) return null;
        const value = row[index];
        if (value === null || value === undefined) return null;
        return String(value).trim();
    }

    excelDateToJS(excelDate) {


        const msPerDay = 24 * 60 * 60 * 1000;
        const excelEpoch = new Date(1899, 11, 30);
        return new Date(excelEpoch.getTime() + excelDate * msPerDay);
    }

    mapPartType(raw) {
        if (!raw) return null;

        const normalized = raw.toLowerCase().trim();

        const mappings = {
            "мп": "MOTHERBOARD",
            "материнская": "MOTHERBOARD",
            "motherboard": "MOTHERBOARD",
            "оперативная": "RAM",
            "ram": "RAM",
            "память": "RAM",
            "dimm": "RAM",
            "hdd": "HDD",
            "жёсткий": "HDD",
            "жесткий": "HDD",
            "диск": "HDD",
            "ssd": "SSD",
            "твердотельный": "SSD",
            "nvme": "SSD",
            "бп": "PSU",
            "блок питания": "PSU",
            "psu": "PSU",
            "вентилятор": "FAN",
            "fan": "FAN",
            "кулер": "FAN",
            "сеть": "NIC",
            "сетевая": "NIC",
            "nic": "NIC",
            "ethernet": "NIC",
            "raid": "RAID",
            "контроллер": "RAID",
            "bmc": "BMC",
            "backplane": "BACKPLANE",
            "процессор": "CPU",
            "cpu": "CPU"
        };

        for (const [keyword, type] of Object.entries(mappings)) {
            if (normalized.includes(keyword)) {
                return type;
            }
        }

        return null;
    }

    mapStatus(raw) {
        if (!raw) return "NEW";

        const normalized = raw.toLowerCase().trim();

        const mappings = {
            "новый": "NEW",
            "new": "NEW",
            "диагностика": "DIAGNOSING",
            "diagnosing": "DIAGNOSING",
            "ожидание": "WAITING_PARTS",
            "waiting": "WAITING_PARTS",
            "ремонт": "REPAIRING",
            "repair": "REPAIRING",
            "отправлен": "SENT_TO_YADRO",
            "ядро": "SENT_TO_YADRO",
            "возврат": "RETURNED",
            "returned": "RETURNED",
            "решён": "RESOLVED",
            "решен": "RESOLVED",
            "resolved": "RESOLVED",
            "закрыт": "CLOSED",
            "closed": "CLOSED"
        };

        for (const [keyword, status] of Object.entries(mappings)) {
            if (normalized.includes(keyword)) {
                return status;
            }
        }

        return "NEW";
    }
}

module.exports = new ExcelImportService();

================================================================================
FILE: QMS-Server-master/services/PdfService.js
================================================================================

const PdfPrinter = require("pdfmake");
const fs = require("fs");
const path = require("path");


const possibleFontPaths = [
    path.join(__dirname, '..', 'node_modules', 'pdfmake', 'fonts', 'Roboto'),
    path.join(__dirname, '..', 'node_modules', 'pdfmake', 'src', 'fonts', 'Roboto'),
    path.join(__dirname, '..', 'fonts'),
];

function findFontDir() {
    for (const dir of possibleFontPaths) {
        const testFile = path.join(dir, 'Roboto-Regular.ttf');
        if (fs.existsSync(testFile)) return dir;
    }
    console.error("❌ [PdfService] Шрифты Roboto не найдены! Используются стандартные.");
    return null;
}

const fontDir = findFontDir();
const fonts = fontDir ? {
    Roboto: {
        normal: path.join(fontDir, 'Roboto-Regular.ttf'),
        bold: path.join(fontDir, 'Roboto-Medium.ttf'),
        italics: path.join(fontDir, 'Roboto-Italic.ttf'),
        bolditalics: path.join(fontDir, 'Roboto-MediumItalic.ttf')
    }
} : {
    Roboto: { normal: 'Helvetica', bold: 'Helvetica-Bold', italics: 'Helvetica-Oblique', bolditalics: 'Helvetica-BoldOblique' }
};

const printer = new PdfPrinter(fonts);

class PdfService {

    _createPdf(docDefinition) {
        return new Promise((resolve, reject) => {
            try {
                const pdfDoc = printer.createPdfKitDocument(docDefinition);
                const chunks = [];
                pdfDoc.on('data', (chunk) => chunks.push(chunk));
                pdfDoc.on('end', () => resolve(Buffer.concat(chunks)));
                pdfDoc.on('error', (err) => {
                    console.error("PDFMake Stream Error:", err);
                    reject(err);
                });
                pdfDoc.end();
            } catch (err) {
                reject(err);
            }
        });
    }


    async generateLabels(boxes) {
        return this._createPdf({
            content: [{ text: 'Функция generateLabels не реализована в этой версии', fontSize: 15 }]
        });
    }


    async generateVideoTransmitterLabelBatch(labelsArray, options = {}) {
        if (!fontDir) console.warn("Внимание: Шрифты Roboto не найдены, PDF может выглядеть иначе.");

        const pageWidthMm = options.widthMm || 140;
        const pageHeightMm = options.heightMm || 90;
        const pageWidthPt = pageWidthMm * 2.835;
        const pageHeightPt = pageHeightMm * 2.835;
        const lineWidth = (pageWidthPt - 20) * 0.60;
        const pageMargins = [5, 5, 5, 5];

        const docDefinition = {
            pageSize: { width: pageWidthPt, height: pageHeightPt },
            pageMargins: pageMargins,
            content: [],
            defaultStyle: { font: 'Roboto', fontSize: 10 }
        };

        labelsArray.forEach((data, index) => {
            const labelContent = [
                {
                    table: {
                        widths: ['35%', '65%'],
                        body: [
                            [
                                {
                                    text: data.code || '',
                                    fontSize: 12,
                                    bold: true,
                                    margin: [2, 10, 0, 0],
                                    border: [false, false, false, false]
                                },
                                {
                                    qr: data.qrCode || 'EMPTY',
                                    fit: 65,
                                    alignment: 'right',
                                    margin: [0, 0, 2, 5],
                                    border: [false, false, false, false]
                                }
                            ],
                            [
                                {
                                    text: data.productName || 'Изделие',
                                    colSpan: 2,
                                    fontSize: 12,
                                    bold: true,
                                    alignment: 'center',
                                    margin: [0, 2],
                                    fillColor: '#F0F0F0'
                                },
                                {}
                            ],
                            [
                                {
                                    text: data.id || '',
                                    fontSize: 24,
                                    bold: true,
                                    alignment: 'center',
                                    margin: [0, 8, 0, 0]
                                },
                                {
                                    stack: [
                                        { text: data.date || '', alignment: 'center', fontSize: 9, margin: [0, 0, 0, 2] },
                                        { canvas: [{ type: 'line', x1: 0, y1: 0, x2: lineWidth, y2: 0, lineWidth: 0.5, lineColor: '#000' }] },
                                        { text: `${data.quantity || ''} ${data.unit || ''}`, alignment: 'center', fontSize: 16, bold: true, margin: [0, 2, 0, 0] }
                                    ],
                                    margin: [0, 0]
                                }
                            ],
                            [
                                {
                                    text: data.contract || '',
                                    colSpan: 2,
                                    fontSize: 7,
                                    alignment: 'center',
                                    margin: [0, 2],
                                    fillColor: '#F0F0F0'
                                },
                                {}
                            ],
                            [
                                {
                                    qr: data.bottomQr || 'ERROR',
                                    fit: 75,
                                    alignment: 'center',
                                    margin: [0, 5, 0, 0],
                                    border: [false, false, false, false]
                                },
                                {
                                    text: '',
                                    border: [false, false, false, false]
                                }
                            ]
                        ]
                    },
                    layout: {
                        hLineWidth: (i, node) => {
                            if (i === 0 || i === node.table.body.length) return 0;
                            return 1;
                        },
                        vLineWidth: (i, node) => {
                            if (i === 0 || i === node.table.widths.length) return 0;
                            return 1;
                        },
                        hLineColor: '#000',
                        vLineColor: '#000',
                        paddingLeft: (i) => 5,
                        paddingRight: (i) => 5,
                        paddingTop: (i) => 2,
                        paddingBottom: (i) => 2
                    },
                    margin: [0, 0, 0, 0]
                }
            ];

            docDefinition.content.push(labelContent);

            if (index < labelsArray.length - 1) {
                docDefinition.content.push({ text: '', pageBreak: 'after' });
            }
        });

        return this._createPdf(docDefinition);
    }


    async generateSimpleZebraBatch(labelsArray, options = {}) {
        if (!fontDir && !options.suppressWarning) console.warn("Шрифты Roboto не найдены для Simple шаблона.");

        const pageWidthMm = options.widthMm || 140;
        const pageHeightMm = options.heightMm || 90;
        const pageWidthPt = pageWidthMm * 2.835;
        const pageHeightPt = pageHeightMm * 2.835;

        const docDefinition = {
            pageSize: { width: pageWidthPt, height: pageHeightPt },
            pageMargins: [10, 10, 10, 10],
            content: [],
            defaultStyle: { font: 'Roboto', fontSize: 12 }
        };

        labelsArray.forEach((data, index) => {
            const content = [
                { text: data.productName, fontSize: 16, bold: true, alignment: 'center', margin: [0, 0, 0, 15] },
                {
                    columns: [
                        { qr: data.bottomQr || data.code, fit: 80, alignment: 'center' },
                        {
                            stack: [
                                { text: 'ID / Партия:', fontSize: 10, color: 'gray' },
                                { text: data.code, fontSize: 14, bold: true, margin: [0, 0, 0, 10] },
                                { text: 'Количество:', fontSize: 10, color: 'gray' },
                                { text: `${data.quantity} ${data.unit}`, fontSize: 18, bold: true },
                                { text: data.date, fontSize: 10, margin: [0, 5, 0, 0] }
                            ],
                            alignment: 'left',
                            margin: [10, 0, 0, 0]
                        }
                    ]
                }
            ];

            docDefinition.content.push(content);

            if (index < labelsArray.length - 1) {
                docDefinition.content.push({ text: '', pageBreak: 'after' });
            }
        });

        return this._createPdf(docDefinition);
    }


    async generateCustomLabelBatch(labelsArray, customLayout, options = {}) {
        const pageWidthMm = options.widthMm || 100;
        const pageHeightMm = options.heightMm || 60;
        const pageWidthPt = pageWidthMm * 2.835;
        const pageHeightPt = pageHeightMm * 2.835;
        const MM_TO_PT = 2.835;

        const docDefinition = {
            pageSize: { width: pageWidthPt, height: pageHeightPt },
            pageMargins: [0, 0, 0, 0],
            content: [],
            defaultStyle: { font: 'Roboto', fontSize: 10 }
        };


        const replaceVars = (text, data) => {
            if (!text) return '';
            return text
                .replace(/\{\{code\}\}/g, data.code || '')
                .replace(/\{\{name\}\}/g, data.productName || '')
                .replace(/\{\{productName\}\}/g, data.productName || '')
                .replace(/\{\{id\}\}/g, data.id || '')
                .replace(/\{\{date\}\}/g, data.date || '')
                .replace(/\{\{serial\}\}/g, data.code || '')
                .replace(/\{\{contract\}\}/g, data.contract || '')
                .replace(/\{\{batch\}\}/g, data.batch || '')
                .replace(/\{\{qty\}\}/g, String(data.quantity || ''))
                .replace(/\{\{quantity\}\}/g, String(data.quantity || ''))
                .replace(/\{\{unit\}\}/g, data.unit || '')
                .replace(/\{\{price\}\}/g, data.price || '')
                .replace(/\{\{weight\}\}/g, data.weight || '')
                .replace(/\{\{url\}\}/g, `https://mes.local/item/${data.code}`)
                .replace(/\{\{full_info\}\}/g, data.bottomQr || '')
                .replace(/\{\{quantity_unit\}\}/g, `${data.quantity || ''} ${data.unit || ''}`)
                .replace(/\{\{current\}\}/g, String(data.currentIndex || 1))
                .replace(/\{\{total\}\}/g, String(data.totalCount || 1));
        };


        const STANDARD_ICONS = {

            fragile: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M15 5 L15 18 Q15 28 25 28 Q35 28 35 18 L35 5" fill="none" stroke="#000" stroke-width="2.5"/><line x1="25" y1="28" x2="25" y2="40" stroke="#000" stroke-width="2.5"/><line x1="15" y1="40" x2="35" y2="40" stroke="#000" stroke-width="2.5"/><line x1="12" y1="45" x2="38" y2="45" stroke="#000" stroke-width="2.5"/></svg>',


            keep_dry: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 8 Q10 8 8 22 L25 22 L25 38 Q25 42 30 40" fill="none" stroke="#000" stroke-width="2.5"/><path d="M25 8 Q40 8 42 22 L25 22" fill="none" stroke="#000" stroke-width="2.5"/><circle cx="14" cy="32" r="2" fill="#000"/><circle cx="22" cy="38" r="2" fill="#000"/><circle cx="36" cy="35" r="2" fill="#000"/></svg>',


            this_side_up: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 5 L35 18 L29 18 L29 24 L21 24 L21 18 L15 18 Z" fill="none" stroke="#000" stroke-width="2"/><path d="M25 26 L35 39 L29 39 L29 45 L21 45 L21 39 L15 39 Z" fill="none" stroke="#000" stroke-width="2"/></svg>',


            keep_frozen: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="5" width="10" height="30" rx="5" fill="none" stroke="#000" stroke-width="2"/><circle cx="25" cy="40" r="7" fill="none" stroke="#000" stroke-width="2"/><circle cx="25" cy="40" r="4" fill="#000"/><line x1="25" y1="38" x2="25" y2="15" stroke="#000" stroke-width="3"/></svg>',


            keep_away_heat: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><circle cx="25" cy="15" r="6" fill="none" stroke="#000" stroke-width="2"/><line x1="25" y1="5" x2="25" y2="8" stroke="#000" stroke-width="2"/><line x1="25" y1="22" x2="25" y2="25" stroke="#000" stroke-width="2"/><line x1="15" y1="15" x2="18" y2="15" stroke="#000" stroke-width="2"/><line x1="32" y1="15" x2="35" y2="15" stroke="#000" stroke-width="2"/><path d="M5 45 L5 32 L25 25 L45 32 L45 45" fill="none" stroke="#000" stroke-width="2"/></svg>',


            do_not_stack: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="28" width="30" height="18" fill="none" stroke="#000" stroke-width="2"/><rect x="14" y="12" width="22" height="14" fill="none" stroke="#000" stroke-width="2"/><line x1="5" y1="5" x2="45" y2="45" stroke="#000" stroke-width="3"/></svg>',


            warning: '<svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 5 L45 42 L5 42 Z" fill="none" stroke="#000" stroke-width="2.5"/><line x1="25" y1="18" x2="25" y2="30" stroke="#000" stroke-width="3"/><circle cx="25" cy="36" r="2" fill="#000"/></svg>'
        };


        for (let labelIndex = 0; labelIndex < labelsArray.length; labelIndex++) {
            const data = labelsArray[labelIndex];
            const pageContent = [];


            for (const el of customLayout) {
                const xPt = el.x * MM_TO_PT;
                const yPt = el.y * MM_TO_PT;
                const widthPt = el.width * MM_TO_PT;
                const heightPt = (el.height || 10) * MM_TO_PT;


                if (el.type === 'TEXT') {
                    const textContent = replaceVars(el.content || '', data);
                    pageContent.push({
                        text: textContent,
                        fontSize: el.fontSize || 10,
                        bold: el.isBold || false,
                        alignment: el.align || 'left',
                        absolutePosition: { x: xPt, y: yPt },
                        width: widthPt
                    });
                }


                if (el.type === 'QR') {
                    const qrContent = replaceVars(el.content || '{{code}}', data);
                    const qrSize = Math.min(widthPt, heightPt);
                    pageContent.push({
                        qr: qrContent || 'EMPTY',
                        fit: qrSize,
                        absolutePosition: { x: xPt, y: yPt }
                    });
                }


                if (el.type === 'COUNTER') {
                    const counterText = replaceVars(el.counterFormat || '{{current}} / {{total}}', data);
                    pageContent.push({
                        text: counterText,
                        fontSize: el.fontSize || 14,
                        bold: el.isBold || false,
                        alignment: el.align || 'left',
                        absolutePosition: { x: xPt, y: yPt },
                        width: widthPt
                    });
                }


                if (el.type === 'LINE') {
                    const isHorizontal = el.width >= (el.height || 1);
                    const lineWidth = el.strokeWidth ? el.strokeWidth * MM_TO_PT : 1;

                    if (isHorizontal) {
                        pageContent.push({
                            canvas: [{
                                type: 'line',
                                x1: 0, y1: 0,
                                x2: widthPt, y2: 0,
                                lineWidth: lineWidth,
                                lineColor: 'black'
                            }],
                            absolutePosition: { x: xPt, y: yPt }
                        });
                    } else {
                        pageContent.push({
                            canvas: [{
                                type: 'line',
                                x1: 0, y1: 0,
                                x2: 0, y2: heightPt,
                                lineWidth: lineWidth,
                                lineColor: 'black'
                            }],
                            absolutePosition: { x: xPt, y: yPt }
                        });
                    }
                }


                if (el.type === 'RECTANGLE') {
                    const lineWidth = el.strokeWidth ? el.strokeWidth * MM_TO_PT : 1;
                    pageContent.push({
                        canvas: [{
                            type: 'rect',
                            x: 0, y: 0,
                            w: widthPt,
                            h: heightPt,
                            lineWidth: lineWidth,
                            lineColor: 'black'
                        }],
                        absolutePosition: { x: xPt, y: yPt }
                    });
                }


                if (el.type === 'IMAGE' && el.imageUrl) {
                    try {
                        pageContent.push({
                            image: el.imageUrl,
                            width: widthPt,
                            height: heightPt,
                            absolutePosition: { x: xPt, y: yPt }
                        });
                    } catch (imgErr) {
                        console.warn('Ошибка загрузки изображения:', imgErr.message);
                    }
                }


                if (el.type === 'ICON') {
                    if (el.imageUrl) {

                        try {
                            pageContent.push({
                                image: el.imageUrl,
                                width: widthPt,
                                height: heightPt,
                                absolutePosition: { x: xPt, y: yPt }
                            });
                        } catch (imgErr) {
                            console.warn('Ошибка загрузки пользовательской иконки:', imgErr.message);
                        }
                    } else if (el.iconType && STANDARD_ICONS[el.iconType]) {

                        try {
                            pageContent.push({
                                svg: STANDARD_ICONS[el.iconType],
                                width: widthPt,
                                height: heightPt,
                                absolutePosition: { x: xPt, y: yPt }
                            });
                        } catch (svgErr) {

                            pageContent.push({
                                text: el.content || el.iconType || '?',
                                fontSize: 8,
                                absolutePosition: { x: xPt, y: yPt }
                            });
                        }
                    }
                }
            }


            if (pageContent.length > 0) {
                docDefinition.content.push({
                    stack: pageContent,
                    unbreakable: true
                });
            }


            if (labelIndex < labelsArray.length - 1) {
                docDefinition.content.push({ text: '', pageBreak: 'after' });
            }
        }

        return this._createPdf(docDefinition);
    }
}

module.exports = new PdfService();

================================================================================
FILE: QMS-Server-master/static/defect-records/2/1769537183976_README.md
================================================================================

# ASVO-QMS PWA

Progressive Web Application для системы управления качеством ASVO-QMS.

## 🚀 Возможности

- **PWA** — установка на главный экран, работа офлайн
- **Keycloak SSO** — единая авторизация через корпоративный SSO
- **Локальный логин** — fallback авторизация по логину/паролю
- **Адаптивный дизайн** — работает на телефонах, планшетах, ПК
- **Тёмная тема** — современный дизайн для производственных условий

## 📱 Модули

| Модуль | Описание |
|--------|----------|
| Главная | Dashboard со статистикой и быстрыми действиями |
| Склад | Управление запасами, приход/расход |
| Производство | Сканирование, чеклисты, контроль качества |
| Задачи | Управление задачами |
| Рейтинги | Статистика сотрудников и команд |
| Профиль | Настройки пользователя, установка PWA |

## ⚙️ Конфигурация

Настройки находятся в `src/config/index.ts`:

```typescript
export const config = {
  // API бэкенда MES (через Vite прокси)
  API_URL: '/api',
  
  // Keycloak
  KEYCLOAK: {
    URL: 'http://10.11.0.16:8080',
    REALM: 'MES-Realm',
    CLIENT_ID: 'mes-web-client',
  },
  
  // Прямой URL API
  API_DIRECT_URL: 'http://10.11.0.16:5001',
}
```

## 🛠 Установка и запуск

### Требования
- Node.js 18+
- npm или yarn

### Установка зависимостей

```bash
cd mes-pwa
npm install
```

### Режим разработки

```bash
npm run dev
```

Приложение будет доступно на `http://localhost:3000` и `http://<ваш-ip>:3000`.

### Production сборка

```bash
npm run build
```

Статические файлы появятся в папке `dist/`.

### Предпросмотр сборки

```bash
npm run preview
```

## 🌐 Развёртывание

### Вариант 1: Vite Preview (простой)

```bash
npm run preview -- --host
```

### Вариант 2: Nginx (production)

```nginx
server {
    listen 3000;
    server_name _;
    root /var/www/mes-pwa/dist;
    index index.html;

    # PWA assets
    location /assets {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Service Worker
    location /sw.js {
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # API Proxy
    location /api {
        proxy_pass http://10.11.0.16:5001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### Вариант 3: Docker

```dockerfile
FROM node:18-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]
```

## 🔧 Keycloak настройка

1. Создайте клиент `mes-web-client` в Keycloak
2. Настройки клиента:
   - **Client Protocol:** openid-connect
   - **Access Type:** public
   - **Valid Redirect URIs:** `http://10.11.0.16:3000/*`
   - **Web Origins:** `http://10.11.0.16:3000`
   - **Standard Flow:** Enabled
   - **Direct Access Grants:** Disabled

3. Добавьте mappers для ролей в token

## 📂 Структура проекта

```
mes-pwa/
├── public/
│   ├── favicon.svg
│   ├── icon-192.png
│   ├── icon-512.png
│   ├── robots.txt
│   └── silent-check-sso.html
├── src/
│   ├── api/
│   │   ├── client.ts          # Axios клиент
│   │   └── keycloak.ts        # Keycloak интеграция
│   ├── components/
│   │   ├── common/
│   │   │   └── Layout.tsx     # Главный layout
│   │   └── ui/
│   │       └── index.tsx      # UI компоненты
│   ├── config/
│   │   └── index.ts           # Конфигурация
│   ├── hooks/
│   │   └── useDebounce.ts     # Custom hooks
│   ├── pages/
│   │   ├── Auth/
│   │   ├── Home/
│   │   ├── Production/
│   │   ├── Profile/
│   │   ├── Rankings/
│   │   ├── Tasks/
│   │   └── Warehouse/
│   ├── store/
│   │   └── authStore.ts       # Zustand store
│   ├── types/
│   │   └── index.ts           # TypeScript типы
│   ├── App.tsx
│   ├── index.css
│   └── main.tsx
├── index.html
├── package.json
├── tailwind.config.js
├── tsconfig.json
└── vite.config.ts
```

## 📲 Установка PWA

### Android
1. Откройте приложение в Chrome
2. Нажмите "Добавить на главный экран" или иконку установки в адресной строке

### iOS
1. Откройте приложение в Safari
2. Нажмите "Поделиться" → "На экран Домой"

### Desktop
1. Откройте в Chrome/Edge
2. Нажмите иконку установки в адресной строке

## 🔌 API Endpoints

Приложение ожидает следующие endpoints на бэкенде:

```
POST   /api/users/login           # Локальный логин
GET    /api/users/auth            # Проверка авторизации
GET    /api/warehouse/boxes       # Список коробок
GET    /api/warehouse/boxes/:id   # Детали коробки
POST   /api/warehouse/boxes/:id/movements  # Движение товара
GET    /api/products              # Список продуктов
POST   /api/products/scan         # Сканирование продукта
POST   /api/products/:id/complete-step     # Завершение этапа
GET    /api/production-steps/:id  # Детали этапа
GET    /api/tasks                 # Список задач
GET    /api/rankings/users        # Рейтинг пользователей
GET    /api/rankings/teams        # Рейтинг команд
GET    /api/rankings/my-stats     # Моя статистика
```

## 🐛 Troubleshooting

### Не работает Keycloak SSO
- Проверьте URL Keycloak в конфиге
- Убедитесь, что клиент `mes-web-client` настроен правильно
- Проверьте CORS настройки в Keycloak

### Ошибка CORS при API запросах
- Убедитесь, что Vite proxy настроен (dev режим)
- В production используйте Nginx proxy

### PWA не устанавливается
- Приложение должно работать по HTTPS (или localhost)
- Проверьте manifest.json в DevTools → Application

## 📄 Лицензия

MIT

================================================================================
FILE: QMS-Server-master/static/defect-records/2/1769579757522_README.md
================================================================================

# MABON — Luxury Porcelain & Sculpture

Интернет-магазин дизайнерского фарфора и скульптур. React + Node.js + PostgreSQL.

## 📦 Структура проекта

```
Mabon_Luxury/
├── src/                    # Frontend (React + TypeScript)
│   ├── components/         # UI компоненты
│   ├── pages/              # Страницы
│   ├── context/            # React контексты
│   └── api/                # API клиент
├── mabon-backend/          # Backend (Node.js + Express)
│   ├── controllers/        # Контроллеры
│   ├── models/             # Sequelize модели
│   ├── routes/             # Роуты API
│   ├── middleware/         # JWT, роли, ошибки
│   └── static/             # Загруженные файлы
├── docker-compose.yml      # Docker конфигурация
├── nginx.conf              # Nginx для продакшена
└── Dockerfile              # Frontend сборка
```

---

## 🚀 Быстрый старт (Docker)

### 1. Клонирование и запуск

```bash
git clone <repo-url>
cd Mabon_Luxury

# Запуск всех сервисов
docker-compose up -d --build
```

### 2. Открыть в браузере

- **Сайт:** http://localhost:3001
- **API:** http://localhost:5000/api

### 3. Войти как админ

- **Email:** `admin@mabon.local`
- **Пароль:** `Mabon_Super_Secret_2025!`

---

## 💻 Локальная разработка (без Docker)

### Требования

- Node.js 20+
- PostgreSQL 15+
- npm или yarn

### 1. База данных

```bash
# Создать БД
psql -U postgres -c "CREATE DATABASE mabon;"
```

### 2. Backend

```bash
cd mabon-backend

# Установить зависимости
npm install

# Настроить .env (см. раздел ниже)
cp .env.example .env
nano .env

# Запустить
npm run dev
```

Backend запустится на http://localhost:5000

### 3. Frontend

```bash
# В корне проекта
npm install

# Запустить dev-сервер
npm run dev
```

Frontend запустится на http://localhost:5173

---

## ⚙️ Конфигурация

### Backend: `mabon-backend/.env`

```env
# ===== СЕРВЕР =====
PORT=5000

# ===== БАЗА ДАННЫХ =====
DB_HOST=localhost          # Для Docker: db
DB_PORT=5432               # Локально может быть 5435
DB_NAME=mabon
DB_USER=postgres
DB_PASSWORD=your_password  # ⚠️ ИЗМЕНИТЬ В ПРОДЕ

# ===== БЕЗОПАСНОСТЬ =====
JWT_SECRET=your_jwt_secret_min_32_chars    # ⚠️ ИЗМЕНИТЬ В ПРОДЕ
SECRET_KEY=your_secret_key_min_32_chars    # ⚠️ ИЗМЕНИТЬ В ПРОДЕ

# ===== CORS =====
CORS_ORIGINS=http://localhost:5173,http://localhost:3000

# ===== YOOKASSA (ОПЛАТА) =====
YOOKASSA_SHOP_ID=123456                    # Ваш Shop ID
YOOKASSA_SECRET_KEY=test_xxxxx             # Тестовый или боевой ключ

# ===== АДМИН (создаётся при первом запуске) =====
ADMIN_EMAIL=admin@mabon.local
ADMIN_PASSWORD=Strong_Password_123!        # ⚠️ ИЗМЕНИТЬ В ПРОДЕ

# ===== SEQUELIZE =====
DB_SYNC_ALTER=true         # true для разработки, false для прода
```

### Frontend: переменные окружения

Создайте `.env` в корне проекта:

```env
VITE_API_BASE_URL=http://localhost:5000
```

Для продакшена:

```env
VITE_API_BASE_URL=https://api.your-domain.com
```

---

## 🌐 Деплой в продакшен

### Вариант 1: Docker Compose на VPS

#### 1. Подготовка сервера

```bash
# Установить Docker и Docker Compose
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
```

#### 2. Настройка переменных

Создайте `docker-compose.prod.yml`:

```yaml
services:
  db:
    image: postgres:15-alpine
    container_name: mabon_db
    restart: always
    environment:
      POSTGRES_USER: mabon_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # Из .env
      POSTGRES_DB: mabon
    volumes:
      - postgres_data:/var/lib/postgresql/data

  backend:
    build: ./mabon-backend
    container_name: mabon_backend
    restart: always
    depends_on:
      - db
    environment:
      PORT: 5000
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: mabon
      DB_USER: mabon_user
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY: ${SECRET_KEY}
      CORS_ORIGINS: https://your-domain.com
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      DB_SYNC_ALTER: "false"
    volumes:
      - ./mabon-backend/static:/app/static

  frontend:
    build:
      context: .
      args:
        VITE_API_BASE_URL: https://your-domain.com
    container_name: mabon_frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"

volumes:
  postgres_data:
```

#### 3. Создайте `.env` на сервере

```env
DB_PASSWORD=SuperSecurePassword123!
JWT_SECRET=your_very_long_jwt_secret_at_least_32_characters
SECRET_KEY=your_very_long_secret_key_at_least_32_characters
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxx
ADMIN_EMAIL=admin@your-domain.com
ADMIN_PASSWORD=AdminSecurePassword456!
```

#### 4. Запуск

```bash
docker-compose -f docker-compose.prod.yml up -d --build
```

### Вариант 2: Отдельные сервисы

#### Backend на VPS / Cloud Run / Railway

```bash
cd mabon-backend
npm install --production
npm start
```

#### Frontend на Vercel / Netlify / Cloudflare Pages

```bash
npm run build
# Загрузить папку dist/
```

---

## 🔐 Что обязательно изменить для продакшена

| Переменная | Описание | Пример |
|------------|----------|--------|
| `DB_PASSWORD` | Пароль БД | `Kj8#mNp$2qLx` |
| `JWT_SECRET` | Секрет для JWT токенов (мин. 32 символа) | `a1b2c3d4e5f6g7h8i9j0...` |
| `SECRET_KEY` | Общий секретный ключ | `x9y8z7w6v5u4t3s2r1q0...` |
| `ADMIN_PASSWORD` | Пароль администратора | `Admin$ecure2025!` |
| `YOOKASSA_SECRET_KEY` | Боевой ключ ЮKassa | `live_xxxxxxxxxxxx` |
| `CORS_ORIGINS` | Разрешённые домены | `https://mabon.ru` |

### Генерация безопасных ключей

```bash
# JWT_SECRET и SECRET_KEY
openssl rand -base64 32

# Или через Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## 📝 API Endpoints

### Публичные

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/product` | Список товаров |
| GET | `/api/product/:id` | Товар по ID |
| GET | `/api/author` | Список авторов |
| GET | `/api/author/:id` | Автор по ID |
| GET | `/api/arttype` | Типы искусства |
| GET | `/api/review/product/:id` | Отзывы товара |

### Авторизация

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/user/registration` | Регистрация |
| POST | `/api/user/login` | Вход |
| GET | `/api/user/auth` | Проверка токена |

### Пользователь (требует JWT)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/cart` | Корзина |
| POST | `/api/cart` | Добавить в корзину |
| DELETE | `/api/cart/:id` | Удалить из корзины |
| GET | `/api/wishlist` | Избранное |
| POST | `/api/order` | Создать заказ |
| GET | `/api/order/my` | Мои заказы |

### Админ (требует JWT + роль ADMIN)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/product` | Создать товар |
| PUT | `/api/product/:id` | Обновить товар |
| DELETE | `/api/product/:id` | Удалить товар |
| GET | `/api/order` | Все заказы |
| PUT | `/api/order/:id` | Обновить статус заказа |

---

## 💳 Интеграция ЮKassa

### Тестовый режим

1. Зарегистрируйтесь в [ЮKassa](https://yookassa.ru/)
2. Получите тестовые ключи в личном кабинете
3. Укажите в `.env`:

```env
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=test_xxxxxxxxxxxxxxxx
```

### Боевой режим

1. Пройдите модерацию в ЮKassa
2. Замените тестовый ключ на боевой:

```env
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxxxxx
```

### Webhook для статусов оплаты

Настройте в личном кабинете ЮKassa:

```
URL: https://your-domain.com/api/yookassa/webhook
Метод: POST
```

---

## 🛠 Полезные команды

```bash
# Пересобрать контейнеры
docker-compose up -d --build

# Логи
docker-compose logs -f backend
docker-compose logs -f frontend

# Зайти в контейнер БД
docker exec -it mabon_db psql -U postgres -d mabon

# Перезапуск
docker-compose restart backend

# Остановка
docker-compose down

# Полная очистка (включая volumes)
docker-compose down -v
```

---

## 🐛 Частые проблемы

### CORS ошибки

Проверьте `CORS_ORIGINS` в `.env` — должен содержать домен фронтенда.

### Не создаётся админ

Убедитесь что `ADMIN_EMAIL` и `ADMIN_PASSWORD` заданы до первого запуска.

### Ошибки подключения к БД

- Проверьте что PostgreSQL запущен
- Проверьте `DB_HOST` (для Docker: `db`, локально: `localhost`)
- Проверьте порт (`5432` в Docker, может быть `5435` локально)

### Картинки не загружаются

Проверьте volume для static файлов:

```yaml
volumes:
  - ./mabon-backend/static:/app/static
```

---

## 📄 Лицензия

MIT
================================================================================
FILE: QMS-Server-master/static/defect-records/2/1769580241363_README.md
================================================================================

# MABON — Luxury Porcelain & Sculpture

Интернет-магазин дизайнерского фарфора и скульптур. React + Node.js + PostgreSQL.

## 📦 Структура проекта

```
Mabon_Luxury/
├── src/                    # Frontend (React + TypeScript)
│   ├── components/         # UI компоненты
│   ├── pages/              # Страницы
│   ├── context/            # React контексты
│   └── api/                # API клиент
├── mabon-backend/          # Backend (Node.js + Express)
│   ├── controllers/        # Контроллеры
│   ├── models/             # Sequelize модели
│   ├── routes/             # Роуты API
│   ├── middleware/         # JWT, роли, ошибки
│   └── static/             # Загруженные файлы
├── docker-compose.yml      # Docker конфигурация
├── nginx.conf              # Nginx для продакшена
└── Dockerfile              # Frontend сборка
```

---

## 🚀 Быстрый старт (Docker)

### 1. Клонирование и запуск

```bash
git clone <repo-url>
cd Mabon_Luxury

# Запуск всех сервисов
docker-compose up -d --build
```

### 2. Открыть в браузере

- **Сайт:** http://localhost:3001
- **API:** http://localhost:5000/api

### 3. Войти как админ

- **Email:** `admin@mabon.local`
- **Пароль:** `Mabon_Super_Secret_2025!`

---

## 💻 Локальная разработка (без Docker)

### Требования

- Node.js 20+
- PostgreSQL 15+
- npm или yarn

### 1. База данных

```bash
# Создать БД
psql -U postgres -c "CREATE DATABASE mabon;"
```

### 2. Backend

```bash
cd mabon-backend

# Установить зависимости
npm install

# Настроить .env (см. раздел ниже)
cp .env.example .env
nano .env

# Запустить
npm run dev
```

Backend запустится на http://localhost:5000

### 3. Frontend

```bash
# В корне проекта
npm install

# Запустить dev-сервер
npm run dev
```

Frontend запустится на http://localhost:5173

---

## ⚙️ Конфигурация

### Backend: `mabon-backend/.env`

```env
# ===== СЕРВЕР =====
PORT=5000

# ===== БАЗА ДАННЫХ =====
DB_HOST=localhost          # Для Docker: db
DB_PORT=5432               # Локально может быть 5435
DB_NAME=mabon
DB_USER=postgres
DB_PASSWORD=your_password  # ⚠️ ИЗМЕНИТЬ В ПРОДЕ

# ===== БЕЗОПАСНОСТЬ =====
JWT_SECRET=your_jwt_secret_min_32_chars    # ⚠️ ИЗМЕНИТЬ В ПРОДЕ
SECRET_KEY=your_secret_key_min_32_chars    # ⚠️ ИЗМЕНИТЬ В ПРОДЕ

# ===== CORS =====
CORS_ORIGINS=http://localhost:5173,http://localhost:3000

# ===== YOOKASSA (ОПЛАТА) =====
YOOKASSA_SHOP_ID=123456                    # Ваш Shop ID
YOOKASSA_SECRET_KEY=test_xxxxx             # Тестовый или боевой ключ

# ===== АДМИН (создаётся при первом запуске) =====
ADMIN_EMAIL=admin@mabon.local
ADMIN_PASSWORD=Strong_Password_123!        # ⚠️ ИЗМЕНИТЬ В ПРОДЕ

# ===== SEQUELIZE =====
DB_SYNC_ALTER=true         # true для разработки, false для прода
```

### Frontend: переменные окружения

Создайте `.env` в корне проекта:

```env
VITE_API_BASE_URL=http://localhost:5000
```

Для продакшена:

```env
VITE_API_BASE_URL=https://api.your-domain.com
```

---

## 🌐 Деплой в продакшен

### Вариант 1: Docker Compose на VPS

#### 1. Подготовка сервера

```bash
# Установить Docker и Docker Compose
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
```

#### 2. Настройка переменных

Создайте `docker-compose.prod.yml`:

```yaml
services:
  db:
    image: postgres:15-alpine
    container_name: mabon_db
    restart: always
    environment:
      POSTGRES_USER: mabon_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # Из .env
      POSTGRES_DB: mabon
    volumes:
      - postgres_data:/var/lib/postgresql/data

  backend:
    build: ./mabon-backend
    container_name: mabon_backend
    restart: always
    depends_on:
      - db
    environment:
      PORT: 5000
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: mabon
      DB_USER: mabon_user
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY: ${SECRET_KEY}
      CORS_ORIGINS: https://your-domain.com
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      DB_SYNC_ALTER: "false"
    volumes:
      - ./mabon-backend/static:/app/static

  frontend:
    build:
      context: .
      args:
        VITE_API_BASE_URL: https://your-domain.com
    container_name: mabon_frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"

volumes:
  postgres_data:
```

#### 3. Создайте `.env` на сервере

```env
DB_PASSWORD=SuperSecurePassword123!
JWT_SECRET=your_very_long_jwt_secret_at_least_32_characters
SECRET_KEY=your_very_long_secret_key_at_least_32_characters
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxx
ADMIN_EMAIL=admin@your-domain.com
ADMIN_PASSWORD=AdminSecurePassword456!
```

#### 4. Запуск

```bash
docker-compose -f docker-compose.prod.yml up -d --build
```

### Вариант 2: Отдельные сервисы

#### Backend на VPS / Cloud Run / Railway

```bash
cd mabon-backend
npm install --production
npm start
```

#### Frontend на Vercel / Netlify / Cloudflare Pages

```bash
npm run build
# Загрузить папку dist/
```

---

## 🔐 Что обязательно изменить для продакшена

| Переменная | Описание | Пример |
|------------|----------|--------|
| `DB_PASSWORD` | Пароль БД | `Kj8#mNp$2qLx` |
| `JWT_SECRET` | Секрет для JWT токенов (мин. 32 символа) | `a1b2c3d4e5f6g7h8i9j0...` |
| `SECRET_KEY` | Общий секретный ключ | `x9y8z7w6v5u4t3s2r1q0...` |
| `ADMIN_PASSWORD` | Пароль администратора | `Admin$ecure2025!` |
| `YOOKASSA_SECRET_KEY` | Боевой ключ ЮKassa | `live_xxxxxxxxxxxx` |
| `CORS_ORIGINS` | Разрешённые домены | `https://mabon.ru` |

### Генерация безопасных ключей

```bash
# JWT_SECRET и SECRET_KEY
openssl rand -base64 32

# Или через Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## 📝 API Endpoints

### Публичные

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/product` | Список товаров |
| GET | `/api/product/:id` | Товар по ID |
| GET | `/api/author` | Список авторов |
| GET | `/api/author/:id` | Автор по ID |
| GET | `/api/arttype` | Типы искусства |
| GET | `/api/review/product/:id` | Отзывы товара |

### Авторизация

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/user/registration` | Регистрация |
| POST | `/api/user/login` | Вход |
| GET | `/api/user/auth` | Проверка токена |

### Пользователь (требует JWT)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/cart` | Корзина |
| POST | `/api/cart` | Добавить в корзину |
| DELETE | `/api/cart/:id` | Удалить из корзины |
| GET | `/api/wishlist` | Избранное |
| POST | `/api/order` | Создать заказ |
| GET | `/api/order/my` | Мои заказы |

### Админ (требует JWT + роль ADMIN)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/product` | Создать товар |
| PUT | `/api/product/:id` | Обновить товар |
| DELETE | `/api/product/:id` | Удалить товар |
| GET | `/api/order` | Все заказы |
| PUT | `/api/order/:id` | Обновить статус заказа |

---

## 💳 Интеграция ЮKassa

### Тестовый режим

1. Зарегистрируйтесь в [ЮKassa](https://yookassa.ru/)
2. Получите тестовые ключи в личном кабинете
3. Укажите в `.env`:

```env
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=test_xxxxxxxxxxxxxxxx
```

### Боевой режим

1. Пройдите модерацию в ЮKassa
2. Замените тестовый ключ на боевой:

```env
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxxxxx
```

### Webhook для статусов оплаты

Настройте в личном кабинете ЮKassa:

```
URL: https://your-domain.com/api/yookassa/webhook
Метод: POST
```

---

## 🛠 Полезные команды

```bash
# Пересобрать контейнеры
docker-compose up -d --build

# Логи
docker-compose logs -f backend
docker-compose logs -f frontend

# Зайти в контейнер БД
docker exec -it mabon_db psql -U postgres -d mabon

# Перезапуск
docker-compose restart backend

# Остановка
docker-compose down

# Полная очистка (включая volumes)
docker-compose down -v
```

---

## 🐛 Частые проблемы

### CORS ошибки

Проверьте `CORS_ORIGINS` в `.env` — должен содержать домен фронтенда.

### Не создаётся админ

Убедитесь что `ADMIN_EMAIL` и `ADMIN_PASSWORD` заданы до первого запуска.

### Ошибки подключения к БД

- Проверьте что PostgreSQL запущен
- Проверьте `DB_HOST` (для Docker: `db`, локально: `localhost`)
- Проверьте порт (`5432` в Docker, может быть `5435` локально)

### Картинки не загружаются

Проверьте volume для static файлов:

```yaml
volumes:
  - ./mabon-backend/static:/app/static
```

---

## 📄 Лицензия

MIT
================================================================================
FILE: QMS-Server-master/tests/controllers/box.test.js
================================================================================

const BoxController = require('../../controllers/warehouse/BoxController');
const { WarehouseBox } = require('../../models/index');
const { logAudit } = require('../../utils/auditLogger');

jest.mock('../../models/index');
jest.mock('../../utils/auditLogger');

describe('BoxController - createBoxesBatch', () => {
    let req, res, next;

    beforeEach(() => {
        req = {
            body: {
                label: 'Test Item',
                quantity: 10,
                itemsPerBox: 5,
                unit: 'шт'
            },
            user: { id: 1 }
        };
        res = { json: jest.fn() };
        next = jest.fn();
        jest.clearAllMocks();
    });

    test('Должен создать партию коробок (Bulk Create)', async () => {
        WarehouseBox.bulkCreate.mockResolvedValue([
            { id: 1, label: 'Test Item' },
            { id: 2, label: 'Test Item' }
        ]);

        await BoxController.createBoxesBatch(req, res, next);

        expect(WarehouseBox.bulkCreate).toHaveBeenCalled();

        const callArgs = WarehouseBox.bulkCreate.mock.calls[0][0];
        expect(callArgs).toHaveLength(10);
        expect(callArgs[0]).toMatchObject({
            label: 'Test Item',
            quantity: 5,
            acceptedById: 1
        });

        expect(logAudit).toHaveBeenCalledWith(expect.objectContaining({
            action: 'WAREHOUSE_BATCH'
        }));

        expect(res.json).toHaveBeenCalled();
    });

    test('Должен вернуть ошибку, если количество > 1000', async () => {
        req.body.quantity = 1001;

        await BoxController.createBoxesBatch(req, res, next);

        expect(next).toHaveBeenCalled();


        const error = next.mock.calls[0][0];


        expect(error.status).toBe(400);
        expect(error.message).toContain('от 1 до 1000');
    });
});

================================================================================
FILE: QMS-Server-master/tests/controllers/movement.test.js
================================================================================

const MovementController = require('../../controllers/warehouse/MovementController');
const { WarehouseBox, WarehouseMovement } = require('../../models/index');


jest.mock('../../db', () => {
    return {
        transaction: jest.fn(async () => ({
            commit: jest.fn(),
            rollback: jest.fn()
        })),
        define: jest.fn(() => ({
            belongsTo: jest.fn(),
            hasMany: jest.fn(),
            hasOne: jest.fn(),
            belongsToMany: jest.fn()
        })),
        fn: jest.fn(),
        col: jest.fn(),
        authenticate: jest.fn(),
        sync: jest.fn()
    };
});


jest.mock('../../models/index', () => ({
    WarehouseBox: {
        findByPk: jest.fn()
    },
    WarehouseMovement: {
        create: jest.fn()
    },
    WarehouseDocument: {
        create: jest.fn()
    },
    Section: {},
    Team: {},
    User: {},
    Supply: {}
}));

jest.mock('../../utils/auditLogger', () => ({
    logAudit: jest.fn()
}));

describe('MovementController - moveSingle', () => {
    let req, res, next;

    beforeEach(() => {
        req = {
            body: {
                boxId: 1,
                operation: 'MOVE',
                toSectionId: 5,
                deltaQty: 0
            },
            user: { id: 1 }
        };
        res = {
            json: jest.fn(),
            status: jest.fn().mockReturnThis()
        };
        next = jest.fn();
        jest.clearAllMocks();
    });

    test('Должен успешно переместить коробку на другой участок', async () => {

        const mockBox = {
            id: 1,
            currentSectionId: 1,
            quantity: 10,
            status: 'ON_STOCK',
            save: jest.fn().mockResolvedValue(true)
        };


        WarehouseBox.findByPk.mockResolvedValue(mockBox);

        WarehouseMovement.create.mockResolvedValue({ id: 100 });

        await MovementController.moveSingle(req, res, next);


        expect(mockBox.currentSectionId).toBe(5);

        expect(mockBox.save).toHaveBeenCalled();

        expect(WarehouseMovement.create).toHaveBeenCalledWith(
            expect.objectContaining({
                boxId: 1,
                toSectionId: 5,
                operation: 'MOVE'
            }),
            expect.any(Object)
        );
        expect(res.json).toHaveBeenCalled();
    });

    test('Должен выдать ошибку, если итоговое количество становится отрицательным', async () => {
        req.body.operation = 'CONSUME';
        req.body.deltaQty = -50;

        const mockBox = {
            id: 1,
            quantity: 10,
            save: jest.fn()
        };
        WarehouseBox.findByPk.mockResolvedValue(mockBox);

        await MovementController.moveSingle(req, res, next);


        expect(mockBox.save).not.toHaveBeenCalled();

        expect(next).toHaveBeenCalled();

        const error = next.mock.calls[0][0];
        expect(error.message).toContain('отрицательным');
    });

    test('Должен вернуть 404, если коробка не найдена', async () => {
        WarehouseBox.findByPk.mockResolvedValue(null);

        await MovementController.moveSingle(req, res, next);

        expect(next).toHaveBeenCalled();
        const error = next.mock.calls[0][0];
        expect(error.status).toBe(404);
        expect(error.message).toBe('Коробка не найдена');
    });
});

================================================================================
FILE: QMS-Server-master/tests/controllers/supply.test.js
================================================================================

const request = require('supertest');
const express = require('express');
const bodyParser = require('body-parser');
const SupplyController = require('../../controllers/warehouse/SupplyController');
const { Supply } = require('../../models/index');


jest.mock('../../models/index');
jest.mock('../../utils/auditLogger', () => ({
    logAudit: jest.fn()
}));

const app = express();
app.use(bodyParser.json());

app.use((req, res, next) => {
    req.user = { id: 1, role: 'WAREHOUSE_MASTER' };
    next();
});
app.post('/api/warehouse/supplies', SupplyController.createSupply);

describe('SupplyController Integration', () => {
    test('POST /supplies - Должен создать поставку', async () => {
        const mockSupply = { id: 1, docNumber: 'TEST-123', status: 'NEW' };


        Supply.create.mockResolvedValue(mockSupply);

        const res = await request(app)
            .post('/api/warehouse/supplies')
            .send({
                docNumber: 'TEST-123',
                supplier: 'OOO Test',
                comment: 'Test supply'
            });

        expect(res.status).toBe(200);
        expect(res.body.docNumber).toBe('TEST-123');
        expect(Supply.create).toHaveBeenCalled();
    });
});

================================================================================
FILE: QMS-Server-master/tests/middleware/checkAbility.test.js
================================================================================

const checkAbility = require('../../middleware/checkAbilityMiddleware');
const ApiError = require('../../error/ApiError');

describe('checkAbilityMiddleware', () => {
    let mockReq, mockRes, mockNext;

    beforeEach(() => {
        mockReq = { method: 'GET', user: {} };
        mockRes = {};
        mockNext = jest.fn();
    });

    test('Должен пропустить SUPER_ADMIN без проверки прав', () => {
        mockReq.user = { role: 'SUPER_ADMIN', abilities: [] };
        const middleware = checkAbility('warehouse.view');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledTimes(1);
        expect(mockNext).toHaveBeenCalledWith();
    });

    test('Должен пропустить пользователя с нужным правом', () => {
        mockReq.user = { role: 'USER', abilities: ['warehouse.view', 'other.ability'] };
        const middleware = checkAbility('warehouse.view');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledWith();
    });

    test('Должен вернуть ошибку 403 (Forbidden), если права нет', () => {
        mockReq.user = { role: 'USER', abilities: ['other.ability'] };
        const middleware = checkAbility('warehouse.view');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledTimes(1);
        const errorArg = mockNext.mock.calls[0][0];
        expect(errorArg).toBeInstanceOf(ApiError);
        expect(errorArg.status).toBe(403);
    });

    test('Должен вернуть ошибку 401, если пользователя нет (не залогинен)', () => {
        mockReq.user = null;
        const middleware = checkAbility('any.right');

        middleware(mockReq, mockRes, mockNext);

        expect(mockNext).toHaveBeenCalledTimes(1);
        expect(mockNext.mock.calls[0][0].status).toBe(401);
    });
});

================================================================================
FILE: QMS-Server-master/tests/middleware/syncUser.test.js
================================================================================

const syncUserMiddleware = require('../../middleware/syncUserMiddleware');
const { User, Role } = require('../../models/index');


jest.mock('../../models/index', () => ({
    User: {
        findOne: jest.fn(),
        create: jest.fn(),
        update: jest.fn()
    },
    Role: {
        findAll: jest.fn(),
        findOne: jest.fn(),
        findOrCreate: jest.fn()
    },
    Ability: {}
}));

describe('syncUserMiddleware', () => {
    let req, res, next;

    beforeEach(() => {
        req = {
            auth: {
                payload: {
                    sub: 'keycloak-uuid-123',
                    preferred_username: 'testuser',
                    given_name: 'Ivan',
                    family_name: 'Ivanov',
                    realm_access: { roles: ['WAREHOUSE_MASTER'] }
                }
            }
        };
        res = { status: jest.fn().mockReturnThis(), json: jest.fn() };
        next = jest.fn();
        jest.clearAllMocks();
    });

    test('Должен создать нового пользователя, если его нет', async () => {

        Role.findAll.mockResolvedValue([{ name: 'WAREHOUSE_MASTER' }, { name: 'VIEWER' }]);

        Role.findOne.mockResolvedValue({ id: 6, name: 'WAREHOUSE_MASTER', abilities: [{ code: 'warehouse.view' }] });

        User.findOne.mockResolvedValue(null);

        const createdUser = {
            id: 10,
            login: 'testuser',
            roleId: 6,
            save: jest.fn()
        };
        User.create.mockResolvedValue(createdUser);

        await syncUserMiddleware(req, res, next);

        expect(User.create).toHaveBeenCalledWith(expect.objectContaining({
            login: 'testuser',
            roleId: 6
        }));
        expect(req.user).toBeDefined();
        expect(req.user.id).toBe(10);
        expect(req.user.abilities).toContain('warehouse.view');
        expect(next).toHaveBeenCalled();
    });

    test('Должен обновить роль существующего пользователя', async () => {

        Role.findAll.mockResolvedValue([{ name: 'WAREHOUSE_MASTER' }, { name: 'ASSEMBLER' }]);

        Role.findOne.mockResolvedValue({ id: 6, name: 'WAREHOUSE_MASTER', abilities: [] });

        const mockSave = jest.fn();
        const existingUser = {
            id: 20,
            login: 'testuser',
            roleId: 3,
            save: mockSave
        };

        User.findOne.mockResolvedValue(existingUser);

        await syncUserMiddleware(req, res, next);

        expect(existingUser.roleId).toBe(6);
        expect(mockSave).toHaveBeenCalled();
        expect(next).toHaveBeenCalled();
    });

    test('Должен вернуть 500 при ошибке БД', async () => {
        Role.findAll.mockRejectedValue(new Error('DB Connection failed'));

        await syncUserMiddleware(req, res, next);

        expect(res.status).toHaveBeenCalledWith(500);
        expect(next).not.toHaveBeenCalled();
    });
});

================================================================================
FILE: README.md
================================================================================

# QMS
# QMS

================================================================================
FILE: docs/ASVO-QMS-frontend-spec-v1.html
================================================================================

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ASVO-QMS — ТЗ Frontend v1</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');

  :root {
    --bg: #080E14;
    --surface: #0D1520;
    --card: #111D2B;
    --card-hover: #152436;
    --border: #1A2D42;
    --border-light: #1E3A54;
    --accent: #2DD4A8;
    --accent-dim: rgba(45,212,168,0.08);
    --accent-glow: rgba(45,212,168,0.25);
    --text: #E8EDF3;
    --text-mid: #8899AB;
    --text-dim: #4A5E72;
    --red: #F06060;
    --red-dim: rgba(240,96,96,0.12);
    --amber: #E8A830;
    --amber-dim: rgba(232,168,48,0.12);
    --blue: #4A90E8;
    --blue-dim: rgba(74,144,232,0.12);
    --purple: #A06AE8;
    --purple-dim: rgba(160,106,232,0.12);
    --green: #2DD4A8;
    --green-dim: rgba(45,212,168,0.12);
    --grey: #3A4E62;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, sans-serif;
    font-size: 14px;
    line-height: 1.65;
    padding: 0;
  }

  /* ─── Header ─── */
  .doc-header {
    background: linear-gradient(135deg, var(--surface), var(--card));
    border-bottom: 1px solid var(--border);
    padding: 48px 0 40px;
    text-align: center;
  }
  .doc-header .logo {
    display: inline-flex; align-items: center; gap: 12px;
    margin-bottom: 24px;
  }
  .doc-header .logo-icon {
    width: 48px; height: 48px; border-radius: 14px;
    background: linear-gradient(135deg, var(--accent), rgba(45,212,168,0.6));
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; font-weight: 800; color: var(--bg);
  }
  .doc-header .logo-text { font-size: 24px; font-weight: 800; color: var(--text); }
  .doc-header .logo-badge {
    background: var(--accent-dim); color: var(--accent);
    padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;
    border: 1px solid rgba(45,212,168,0.2);
  }
  .doc-header h1 {
    font-size: 32px; font-weight: 800; letter-spacing: -0.5px;
    margin-bottom: 8px;
  }
  .doc-header .subtitle { color: var(--text-mid); font-size: 16px; }

  .meta-table {
    display: inline-grid; grid-template-columns: auto auto;
    gap: 2px; margin-top: 28px; text-align: left;
    background: var(--border); border-radius: 10px; overflow: hidden;
    border: 1px solid var(--border);
  }
  .meta-table dt {
    background: var(--surface); padding: 8px 16px;
    font-weight: 600; color: var(--text-dim); font-size: 12px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .meta-table dd {
    background: var(--card); padding: 8px 20px;
    font-weight: 500; color: var(--text); font-size: 13px;
  }

  /* ─── Layout ─── */
  .container { max-width: 960px; margin: 0 auto; padding: 40px 32px; }

  /* ─── Sections ─── */
  .section { margin-bottom: 48px; }
  .section-num {
    display: inline-flex; align-items: center; justify-content: center;
    width: 32px; height: 32px; border-radius: 8px;
    background: var(--accent-dim); color: var(--accent);
    font-weight: 800; font-size: 14px; margin-right: 12px;
    border: 1px solid rgba(45,212,168,0.2);
    flex-shrink: 0;
  }
  h2.section-title {
    display: flex; align-items: center;
    font-size: 22px; font-weight: 800; letter-spacing: -0.3px;
    margin-bottom: 20px; padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  h3 {
    font-size: 15px; font-weight: 700; color: var(--accent);
    margin: 24px 0 10px; letter-spacing: -0.2px;
  }
  h4 {
    font-size: 13px; font-weight: 700; color: var(--text-mid);
    margin: 16px 0 8px; text-transform: uppercase; letter-spacing: 0.5px;
  }

  p { margin-bottom: 10px; color: var(--text); line-height: 1.7; }
  .dim { color: var(--text-mid); }
  .accent { color: var(--accent); }
  .bold { font-weight: 700; }
  .mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; }

  /* ─── Lists ─── */
  ul { list-style: none; margin: 8px 0 16px; }
  ul li {
    padding: 5px 0 5px 20px; position: relative;
    color: var(--text); font-size: 13px;
  }
  ul li::before {
    content: ''; position: absolute; left: 0; top: 12px;
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent); opacity: 0.6;
  }
  ul.dim-list li::before { background: var(--text-dim); }
  ul.red-list li::before { background: var(--red); }

  ol { margin: 8px 0 16px 20px; }
  ol li { padding: 4px 0; font-size: 13px; }

  /* ─── Tables ─── */
  table {
    width: 100%; border-collapse: separate; border-spacing: 0;
    margin: 12px 0 20px; font-size: 13px;
    border: 1px solid var(--border); border-radius: 10px; overflow: hidden;
  }
  th {
    background: var(--surface); color: var(--text-dim);
    font-weight: 700; font-size: 11px; text-transform: uppercase;
    letter-spacing: 0.5px; padding: 10px 14px; text-align: left;
    border-bottom: 1px solid var(--border);
  }
  td {
    padding: 9px 14px; border-bottom: 1px solid rgba(26,45,66,0.5);
    color: var(--text);
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(21,36,54,0.4); }

  /* ─── Color Swatches ─── */
  .color-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 8px; margin: 12px 0 20px;
  }
  .color-swatch {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 14px; border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card); transition: all 0.15s;
  }
  .color-swatch:hover { border-color: var(--border-light); }
  .color-dot {
    width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.08);
  }
  .color-name { font-weight: 600; font-size: 12px; }
  .color-hex { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-dim); }
  .color-use { font-size: 11px; color: var(--text-dim); }

  /* ─── Code Blocks ─── */
  .code-block {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 16px 20px; margin: 10px 0 16px;
    font-family: 'JetBrains Mono', monospace; font-size: 12px;
    line-height: 1.8; color: var(--text-mid); overflow-x: auto;
    white-space: pre;
  }
  .code-block .keyword { color: var(--purple); }
  .code-block .string { color: var(--accent); }
  .code-block .comment { color: var(--text-dim); font-style: italic; }
  .code-block .create { color: var(--red); font-weight: 600; }
  .code-block .update { color: var(--amber); font-weight: 600; }
  .code-block .ready { color: var(--accent); }

  /* ─── Cards ─── */
  .info-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 16px 20px; margin: 10px 0;
  }
  .info-card.accent-border { border-left: 3px solid var(--accent); }
  .info-card.red-border { border-left: 3px solid var(--red); }
  .info-card.amber-border { border-left: 3px solid var(--amber); }
  .info-card.blue-border { border-left: 3px solid var(--blue); }

  .label {
    display: inline-block; padding: 2px 10px; border-radius: 4px;
    font-size: 11px; font-weight: 700; letter-spacing: 0.3px;
  }
  .label-accent { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(45,212,168,0.2); }
  .label-red { background: var(--red-dim); color: var(--red); border: 1px solid rgba(240,96,96,0.2); }
  .label-amber { background: var(--amber-dim); color: var(--amber); border: 1px solid rgba(232,168,48,0.2); }
  .label-blue { background: var(--blue-dim); color: var(--blue); border: 1px solid rgba(74,144,232,0.2); }
  .label-purple { background: var(--purple-dim); color: var(--purple); border: 1px solid rgba(160,106,232,0.2); }
  .label-grey { background: rgba(58,78,98,0.15); color: var(--grey); border: 1px solid rgba(58,78,98,0.25); }

  /* ─── Module Cards ─── */
  .module-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px 24px; margin: 16px 0;
  }
  .module-card h3 { margin-top: 0; }
  .module-meta {
    display: flex; flex-wrap: wrap; gap: 12px; margin: 8px 0 14px;
    font-size: 12px;
  }
  .module-meta span { display: flex; align-items: center; gap: 5px; }
  .module-meta .key { color: var(--text-dim); }
  .module-meta .val { color: var(--text); font-weight: 600; }

  /* ─── Component Preview ─── */
  .component-preview {
    display: flex; flex-wrap: wrap; gap: 12px;
    padding: 20px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 10px;
    margin: 12px 0 20px; align-items: center;
  }

  .preview-badge {
    padding: 3px 10px; border-radius: 4px;
    font-size: 11px; font-weight: 700;
  }
  .preview-btn {
    padding: 8px 20px; border-radius: 8px;
    font-size: 13px; font-weight: 700; border: none;
    cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
  }
  .preview-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .preview-progress {
    height: 6px; border-radius: 6px; overflow: hidden;
    width: 120px;
  }
  .preview-progress-fill { height: 100%; border-radius: 6px; }

  .preview-card-sample {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px; border-left: 3px solid var(--red);
    width: 280px;
  }

  .preview-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    display: inline-flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 700;
  }

  /* ─── Priority Table ─── */
  .priority-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
  .priority-icon { font-size: 12px; font-weight: 700; width: 24px; text-align: center; }

  /* ─── Kanban Column Preview ─── */
  .kanban-columns {
    display: flex; gap: 8px; margin: 12px 0 20px; overflow-x: auto;
  }
  .kanban-col {
    flex: 1; min-width: 140px; border-radius: 10px;
    padding: 10px; text-align: center;
  }
  .kanban-col-header {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    font-size: 12px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.3px; margin-bottom: 8px;
  }
  .kanban-col-dot { width: 8px; height: 8px; border-radius: 50%; }

  /* ─── Divider ─── */
  .divider { border: none; border-top: 1px solid var(--border); margin: 40px 0; }

  /* ─── Footer ─── */
  .doc-footer {
    text-align: center; padding: 32px;
    border-top: 1px solid var(--border);
    color: var(--text-dim); font-size: 12px;
  }

  /* ─── Timeline preview ─── */
  .timeline-preview {
    position: relative; padding-left: 24px; margin: 12px 0;
  }
  .timeline-preview::before {
    content: ''; position: absolute; left: 8px; top: 4px; bottom: 4px;
    width: 2px; background: var(--border);
  }
  .timeline-item { margin-bottom: 12px; position: relative; }
  .timeline-item::before {
    content: ''; position: absolute; left: -20px; top: 4px;
    width: 12px; height: 12px; border-radius: 50%;
    border: 2px solid var(--card);
  }
  .timeline-item.green::before { background: var(--accent); }
  .timeline-item.red::before { background: var(--red); }
  .timeline-item.blue::before { background: var(--blue); }
  .timeline-date { font-size: 11px; color: var(--text-dim); }
  .timeline-text { font-size: 13px; color: var(--text); }

  @media print {
    body { background: #fff; color: #111; }
    .color-dot { border: 1px solid #ccc; }
  }
</style>
</head>
<body>




<div class="doc-header">
  <div class="logo">
    <div class="logo-icon">A</div>
    <span class="logo-text">ASVO-QMS</span>
    <span class="logo-badge">v2.0</span>
  </div>
  <h1>ТЕХНИЧЕСКОЕ ЗАДАНИЕ</h1>
  <div class="subtitle">Редизайн UI и реализация модулей качества</div>

  <dl class="meta-table">
    <dt>Проект</dt><dd>ASVO-QMS v2.0</dd>
    <dt>Автор</dt><dd>Костюков И.А., зам. тех. директора</dd>
    <dt>Исполнитель</dt><dd>Frontend-разработчик</dd>
    <dt>Дата</dt><dd>11.02.2026</dd>
    <dt>Приоритет</dt><dd style="color:var(--red); font-weight:700">ВЫСОКИЙ</dd>
    <dt>Дедлайн MVP</dt><dd style="color:var(--amber); font-weight:700">15.03.2026</dd>
    <dt>Стек</dt><dd>React 18 + TypeScript + Tailwind CSS</dd>
  </dl>
</div>

<div class="container">




<div class="section">
  <h2 class="section-title"><span class="section-num">1</span>Контекст и цели</h2>

  <p>ASVO-QMS — платформа управления качеством для производителей медицинских изделий по ISO 13485:2016. Система включает QMS, WMS и MES модули на единой платформе.</p>

  <h3>Текущее состояние</h3>
  <div class="info-card blue-border">
    <ul>
      <li><span class="bold">Backend:</span> 9 QMS-модулей реализованы (модели Sequelize, контроллеры, роутеры, сервисы)</li>
      <li><span class="bold">Frontend:</span> реализованы только Documents, NC, CAPA (частично). Остальные 6 модулей — только backend</li>
      <li><span class="bold">Задачи (Канбан):</span> работает, но в светлой теме — не соответствует общему дизайну</li>
      <li><span class="bold">QMS Dashboard:</span> заглушка</li>
    </ul>
  </div>

  <h3>Цели задачи</h3>
  <ol>
    <li><span class="bold">Переделать канбан-доску задач</span> в тёмную тему по прототипу</li>
    <li><span class="bold">Реализовать UI для всех 10 QMS-модулей</span> (меню «Качество»)</li>
    <li><span class="bold">Единый дизайн-язык:</span> тёмная тема, акцент <code style="color:var(--accent)">#2DD4A8</code></li>
    <li><span class="bold">Подключить frontend</span> к существующим API-эндпоинтам</li>
  </ol>
</div>




<div class="section">
  <h2 class="section-title"><span class="section-num">2</span>Дизайн-система</h2>

  <h3>2.1 Цветовая палитра</h3>

  <h4>Фоны и поверхности</h4>
  <div class="color-grid">
    <div class="color-swatch">
      <div class="color-dot" style="background:#080E14"></div>
      <div><div class="color-name">bg</div><div class="color-hex">#080E14</div><div class="color-use">Фон страницы</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#0D1520"></div>
      <div><div class="color-name">surface</div><div class="color-hex">#0D1520</div><div class="color-use">Панели, сайдбар, header таблиц</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#111D2B"></div>
      <div><div class="color-name">card</div><div class="color-hex">#111D2B</div><div class="color-use">Карточки, модальные окна</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#152436"></div>
      <div><div class="color-name">card-hover</div><div class="color-hex">#152436</div><div class="color-use">Hover-состояние карточек</div></div>
    </div>
  </div>

  <h4>Границы</h4>
  <div class="color-grid">
    <div class="color-swatch">
      <div class="color-dot" style="background:#1A2D42"></div>
      <div><div class="color-name">border</div><div class="color-hex">#1A2D42</div><div class="color-use">Основные границы</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#1E3A54"></div>
      <div><div class="color-name">border-light</div><div class="color-hex">#1E3A54</div><div class="color-use">Hover, фокус, active state</div></div>
    </div>
  </div>

  <h4>Акценты и семантика</h4>
  <div class="color-grid">
    <div class="color-swatch">
      <div class="color-dot" style="background:#2DD4A8"></div>
      <div><div class="color-name">accent / green</div><div class="color-hex">#2DD4A8</div><div class="color-use">Кнопки, ссылки, «Готово», «Одобрено»</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:rgba(45,212,168,0.08)"></div>
      <div><div class="color-name">accent-dim</div><div class="color-hex">rgba(45,212,168,0.08)</div><div class="color-use">Фон активных элементов, теги</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#F06060"></div>
      <div><div class="color-name">red</div><div class="color-hex">#F06060</div><div class="color-use">Ошибки, критический, NC</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#E8A830"></div>
      <div><div class="color-name">amber</div><div class="color-hex">#E8A830</div><div class="color-use">Предупреждения, «В работе»</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#4A90E8"></div>
      <div><div class="color-name">blue</div><div class="color-hex">#4A90E8</div><div class="color-use">Информация, аудиты, «Новые»</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#A06AE8"></div>
      <div><div class="color-name">purple</div><div class="color-hex">#A06AE8</div><div class="color-use">«На проверке», риски</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#3A4E62"></div>
      <div><div class="color-name">grey</div><div class="color-hex">#3A4E62</div><div class="color-use">«Закрыто», неактивные элементы</div></div>
    </div>
  </div>

  <h4>Текст</h4>
  <div class="color-grid">
    <div class="color-swatch">
      <div class="color-dot" style="background:#E8EDF3"></div>
      <div><div class="color-name">text</div><div class="color-hex">#E8EDF3</div><div class="color-use">Основной текст, заголовки</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#8899AB"></div>
      <div><div class="color-name">text-mid</div><div class="color-hex">#8899AB</div><div class="color-use">Вторичный текст, описания</div></div>
    </div>
    <div class="color-swatch">
      <div class="color-dot" style="background:#4A5E72"></div>
      <div><div class="color-name">text-dim</div><div class="color-hex">#4A5E72</div><div class="color-use">Плейсхолдеры, мелкий текст</div></div>
    </div>
  </div>

  
  <h3>2.2 Типографика</h3>
  <table>
    <tr><th>Элемент</th><th>Шрифт</th><th>Размер</th><th>Вес</th></tr>
    <tr><td>Заголовок страницы</td><td>Inter</td><td>18px</td><td>700-800</td></tr>
    <tr><td>Заголовок секции</td><td>Inter</td><td>14-15px</td><td>600-700</td></tr>
    <tr><td>Текст в таблицах</td><td>Inter</td><td>13px</td><td>400-500</td></tr>
    <tr><td>Мелкий текст (теги, даты)</td><td>Inter</td><td>11px</td><td>500-600</td></tr>
    <tr><td>ID записей</td><td style="font-family:'JetBrains Mono',monospace; color:var(--accent)">JetBrains Mono</td><td>11px</td><td>600</td></tr>
    <tr><td>Код, серийные номера</td><td style="font-family:'JetBrains Mono',monospace">JetBrains Mono</td><td>11-12px</td><td>400</td></tr>
  </table>

  
  <h3>2.3 Компоненты — визуальный референс</h3>

  <h4>Бейджи (Badge / Label)</h4>
  <div class="component-preview">
    <span class="preview-badge" style="background:var(--red-dim); color:var(--red); border:1px solid rgba(240,96,96,0.3)">NC</span>
    <span class="preview-badge" style="background:var(--amber-dim); color:var(--amber); border:1px solid rgba(232,168,48,0.3)">CAPA</span>
    <span class="preview-badge" style="background:var(--purple-dim); color:var(--purple); border:1px solid rgba(160,106,232,0.3)">РИСК</span>
    <span class="preview-badge" style="background:var(--blue-dim); color:var(--blue); border:1px solid rgba(74,144,232,0.3)">АУДИТ</span>
    <span class="preview-badge" style="background:var(--accent-dim); color:var(--accent); border:1px solid rgba(45,212,168,0.2)">SOP</span>
    <span class="preview-badge" style="background:rgba(58,78,98,0.15); color:var(--grey); border:1px solid rgba(58,78,98,0.25)">ЗАКРЫТО</span>
  </div>
  <p class="dim" style="font-size:12px">border-radius: 4px · font-size: 10-11px · font-weight: 700 · padding: 2px 7-10px · uppercase</p>

  <h4>Кнопки</h4>
  <div class="component-preview">
    <button class="preview-btn" style="background:linear-gradient(135deg,#2DD4A8,rgba(45,212,168,0.8)); color:#080E14; box-shadow:0 2px 12px rgba(45,212,168,0.3)">+ Задача</button>
    <button class="preview-btn" style="background:transparent; color:var(--accent); border:1px solid rgba(45,212,168,0.3)">📊 Отчёт</button>
    <button class="preview-btn" style="background:transparent; color:var(--text-dim); border:1px solid var(--border); font-size:12px; padding:5px 14px">Фильтр</button>
  </div>
  <p class="dim" style="font-size:12px">Primary: gradient accent · Secondary: border accent · Small: border border, text-dim</p>

  <h4>Status Dot</h4>
  <div class="component-preview">
    <span style="display:flex; align-items:center; gap:6px"><span class="preview-dot" style="background:var(--accent); box-shadow:0 0 6px rgba(45,212,168,0.4)"></span> Действует</span>
    <span style="display:flex; align-items:center; gap:6px"><span class="preview-dot" style="background:var(--amber); box-shadow:0 0 6px rgba(232,168,48,0.4)"></span> В работе</span>
    <span style="display:flex; align-items:center; gap:6px"><span class="preview-dot" style="background:var(--red); box-shadow:0 0 6px rgba(240,96,96,0.4)"></span> Открыто</span>
    <span style="display:flex; align-items:center; gap:6px"><span class="preview-dot" style="background:var(--purple); box-shadow:0 0 6px rgba(160,106,232,0.4)"></span> На проверке</span>
    <span style="display:flex; align-items:center; gap:6px"><span class="preview-dot" style="background:var(--blue); box-shadow:0 0 6px rgba(74,144,232,0.4)"></span> Запланирован</span>
  </div>
  <p class="dim" style="font-size:12px">width: 8px · height: 8px · border-radius: 50% · box-shadow: 0 0 6px {color}66</p>

  <h4>Progress Bar</h4>
  <div class="component-preview" style="flex-direction:column; gap:8px">
    <div style="display:flex; align-items:center; gap:12px; width:100%">
      <span style="font-size:12px; color:var(--text-dim); width:60px">92%</span>
      <div class="preview-progress" style="background:var(--bg); flex:1"><div class="preview-progress-fill" style="width:92%; background:linear-gradient(90deg,rgba(45,212,168,0.5),#2DD4A8)"></div></div>
    </div>
    <div style="display:flex; align-items:center; gap:12px; width:100%">
      <span style="font-size:12px; color:var(--text-dim); width:60px">65%</span>
      <div class="preview-progress" style="background:var(--bg); flex:1"><div class="preview-progress-fill" style="width:65%; background:linear-gradient(90deg,rgba(232,168,48,0.5),#E8A830)"></div></div>
    </div>
    <div style="display:flex; align-items:center; gap:12px; width:100%">
      <span style="font-size:12px; color:var(--text-dim); width:60px">25%</span>
      <div class="preview-progress" style="background:var(--bg); flex:1"><div class="preview-progress-fill" style="width:25%; background:linear-gradient(90deg,rgba(240,96,96,0.5),#F06060)"></div></div>
    </div>
  </div>
  <p class="dim" style="font-size:12px">height: 4-6px · border-radius: 6px · bg: var(--bg) · fill: linear-gradient(90deg, {color}88, {color})</p>

  <h4>Avatar (инициалы)</h4>
  <div class="component-preview">
    <span class="preview-avatar" style="background:rgba(45,212,168,0.15); border:1.5px solid rgba(45,212,168,0.35); color:#2DD4A8">ИК</span>
    <span class="preview-avatar" style="background:rgba(74,144,232,0.15); border:1.5px solid rgba(74,144,232,0.35); color:#4A90E8">АХ</span>
    <span class="preview-avatar" style="background:rgba(232,168,48,0.15); border:1.5px solid rgba(232,168,48,0.35); color:#E8A830">АО</span>
    <span class="preview-avatar" style="background:rgba(160,106,232,0.15); border:1.5px solid rgba(160,106,232,0.35); color:#A06AE8">ЕЯ</span>
    <span class="preview-avatar" style="background:rgba(224,104,144,0.15); border:1.5px solid rgba(224,104,144,0.35); color:#E06890">ИЧ</span>
  </div>
  <p class="dim" style="font-size:12px">28px · border-radius: 50% · bg: {color}15 · border: 1.5px solid {color}55 · font-size: 10px · weight: 700</p>

  <h4>Карточка задачи (Kanban Card)</h4>
  <div class="component-preview">
    <div class="preview-card-sample">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <div style="display:flex; align-items:center; gap:6px">
          <span style="font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--accent); font-weight:600">NC-089</span>
          <span class="preview-badge" style="background:var(--red-dim); color:var(--red); border:1px solid rgba(240,96,96,0.3); font-size:9px">NC</span>
        </div>
        <span style="font-size:10px; color:var(--red); font-weight:700">▲▲</span>
      </div>
      <div style="font-size:13px; font-weight:500; color:var(--text); line-height:1.45; margin-bottom:10px">Расследование дефекта пайки разъёма J4 — root cause analysis</div>
      <div style="height:4px; background:var(--bg); border-radius:4px; overflow:hidden; margin-bottom:10px"><div style="width:65%; height:100%; background:linear-gradient(90deg,rgba(232,168,48,0.5),#E8A830); border-radius:4px"></div></div>
      <div style="display:flex; gap:4px; margin-bottom:10px">
        <span style="font-size:10px; padding:2px 8px; border-radius:10px; background:var(--accent-dim); color:var(--text-mid)">RCA</span>
        <span style="font-size:10px; padding:2px 8px; border-radius:10px; background:var(--accent-dim); color:var(--text-mid)">5 Why</span>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between">
        <span class="preview-avatar" style="background:rgba(232,168,48,0.15); border:1.5px solid rgba(232,168,48,0.35); color:#E8A830; width:24px; height:24px; font-size:9px">АО</span>
        <div style="display:flex; gap:10px; align-items:center; font-size:11px; color:var(--text-dim)">
          <span>💬 8</span>
          <span>📎 4</span>
          <span style="color:var(--red)">⏰ 14.02</span>
        </div>
      </div>
    </div>
  </div>
  <p class="dim" style="font-size:12px">bg: card · border: 1px border · border-left: 3px solid {priority_color} · border-radius: 10px · padding: 14px · hover: translateY(-2px) + shadow</p>

  <h4>Иконки</h4>
  <p>Использовать <span class="bold">lucide-react</span>. В продакшне заменить emoji на SVG-иконки из lucide.</p>
</div>




<div class="section">
  <h2 class="section-title"><span class="section-num">3</span>Задача 1: Редизайн канбан-доски</h2>

  <div class="module-meta">
    <span><span class="key">Файлы:</span> <span class="val mono">TasksPage.tsx, TasksList.tsx</span></span>
    <span><span class="label label-red">ВЫСОКИЙ</span></span>
    <span><span class="key">Срок:</span> <span class="val">3-4 дня</span></span>
  </div>

  <h3>3.1 Шапка страницы</h3>
  <ul>
    <li>Иконка (svg grid 2x2) + заголовок «Планирование проектов и задач»</li>
    <li>Счётчик «Всего: N» с учётом активного фильтра</li>
    <li>Поле поиска: width 180px → 240px при фокусе, border анимация</li>
    <li>Dropdown «Все исполнители» — фильтр по assignee</li>
    <li>Toggle «Канбан-доска | Проекты» — active: bg accent, color bg</li>
    <li>Кнопка «+ Задача» — primary стиль с glow-тенью</li>
  </ul>

  <h3>3.2 Фильтры (pill-кнопки)</h3>
  <div class="component-preview">
    <span style="padding:4px 14px; border-radius:16px; font-size:12px; font-weight:600; border:1.5px solid var(--accent); background:rgba(45,212,168,0.1); color:var(--accent)">Все</span>
    <span style="padding:4px 14px; border-radius:16px; font-size:12px; font-weight:600; border:1px solid var(--border); color:var(--text-dim)">NC</span>
    <span style="padding:4px 14px; border-radius:16px; font-size:12px; font-weight:600; border:1px solid var(--border); color:var(--text-dim)">CAPA</span>
    <span style="padding:4px 14px; border-radius:16px; font-size:12px; font-weight:600; border:1px solid var(--border); color:var(--text-dim)">Риск</span>
    <span style="padding:4px 14px; border-radius:16px; font-size:12px; font-weight:600; border:1px solid var(--border); color:var(--text-dim)">Аудит</span>
    <span style="padding:4px 14px; border-radius:16px; font-size:12px; font-weight:600; border:1px solid var(--border); color:var(--text-dim)">Обучение</span>
  </div>
  <p class="dim" style="font-size:12px">Active: border {type_color} + bg {type_color}18 + color {type_color} · Inactive: border border + color text-dim</p>

  <h3>3.3 Колонки канбана</h3>
  <div class="kanban-columns">
    <div class="kanban-col" style="background:rgba(74,144,232,0.05); border-top:2px solid rgba(74,144,232,0.4)">
      <div class="kanban-col-header"><span class="kanban-col-dot" style="background:#4A90E8; box-shadow:0 0 8px rgba(74,144,232,0.4)"></span><span style="color:#4A90E8">НОВЫЕ</span></div>
    </div>
    <div class="kanban-col" style="background:rgba(232,168,48,0.05); border-top:2px solid rgba(232,168,48,0.4)">
      <div class="kanban-col-header"><span class="kanban-col-dot" style="background:#E8A830; box-shadow:0 0 8px rgba(232,168,48,0.4)"></span><span style="color:#E8A830">В РАБОТЕ</span></div>
    </div>
    <div class="kanban-col" style="background:rgba(160,106,232,0.05); border-top:2px solid rgba(160,106,232,0.4)">
      <div class="kanban-col-header"><span class="kanban-col-dot" style="background:#A06AE8; box-shadow:0 0 8px rgba(160,106,232,0.4)"></span><span style="color:#A06AE8">НА ПРОВЕРКЕ</span></div>
    </div>
    <div class="kanban-col" style="background:rgba(45,212,168,0.05); border-top:2px solid rgba(45,212,168,0.4)">
      <div class="kanban-col-header"><span class="kanban-col-dot" style="background:#2DD4A8; box-shadow:0 0 8px rgba(45,212,168,0.4)"></span><span style="color:#2DD4A8">ГОТОВО</span></div>
    </div>
    <div class="kanban-col" style="background:rgba(58,78,98,0.05); border-top:2px solid rgba(58,78,98,0.4)">
      <div class="kanban-col-header"><span class="kanban-col-dot" style="background:#3A4E62; box-shadow:0 0 8px rgba(58,78,98,0.4)"></span><span style="color:#3A4E62">ЗАКРЫТО</span></div>
    </div>
  </div>

  <h3>3.4 Приоритеты</h3>
  <table>
    <tr><th>Ключ</th><th>Название</th><th>Цвет</th><th>Иконка</th><th>border-left</th></tr>
    <tr><td>critical</td><td>Критический</td><td><span style="color:var(--red)">#F06060</span></td><td style="color:var(--red); font-weight:700">▲▲</td><td>3px solid <span style="color:var(--red)">#F06060</span>66</td></tr>
    <tr><td>high</td><td>Высокий</td><td><span style="color:#E87040">#E87040</span></td><td style="color:#E87040; font-weight:700">▲</td><td>3px solid #E8704066</td></tr>
    <tr><td>medium</td><td>Средний</td><td><span style="color:var(--amber)">#E8A830</span></td><td style="color:var(--amber); font-weight:700">●</td><td>3px solid <span style="color:var(--amber)">#E8A830</span>66</td></tr>
    <tr><td>low</td><td>Низкий</td><td><span style="color:var(--blue)">#4A90E8</span></td><td style="color:var(--blue); font-weight:700">▼</td><td>3px solid <span style="color:var(--blue)">#4A90E8</span>66</td></tr>
  </table>
</div>




<div class="section">
  <h2 class="section-title"><span class="section-num">4</span>QMS-модули: UI и функционал</h2>

  <h3>4.0 Общая навигация и роутинг</h3>
  <p>Меню «Качество» в хедере → dropdown → 10 пунктов. Внутри QMS — сайдбар 220px с дублированием навигации.</p>

  <div class="code-block"><span class="comment">// routes.ts — добавить:</span>
/quality/dashboard   → <span class="ready">QmsDashboardPage</span>        <span class="comment">// переписать</span>
/quality/documents   → <span class="ready">DocumentsPage</span>           <span class="comment">// доработать</span>
/quality/nc          → <span class="ready">NonconformityPage</span>       <span class="comment">// доработать</span>
/quality/capa        → <span class="ready">CapaPage</span>                <span class="comment">// доработать</span>
/quality/risks       → <span class="create">RiskPage</span>                <span class="comment">// СОЗДАТЬ</span>
/quality/suppliers   → <span class="create">SupplierPage</span>            <span class="comment">// СОЗДАТЬ</span>
/quality/audits      → <span class="create">AuditPage</span>              <span class="comment">// СОЗДАТЬ</span>
/quality/training    → <span class="create">TrainingPage</span>            <span class="comment">// СОЗДАТЬ</span>
/quality/equipment   → <span class="create">EquipmentPage</span>           <span class="comment">// СОЗДАТЬ</span>
/quality/review      → <span class="create">ManagementReviewPage</span>    <span class="comment">// СОЗДАТЬ</span>

<span class="comment">// Обёртка:</span>
<span class="keyword">QmsLayout.tsx</span> — сайдбар + outlet для /quality/* страниц</div>

  

  <div class="module-card" style="border-left:3px solid var(--accent)">
    <h3>4.1 📊 Дашборд</h3>
    <div class="module-meta">
      <span><span class="key">Файл:</span> <span class="val mono">pages/QMS/QmsDashboardPage.tsx</span></span>
      <span><span class="label label-amber">ПЕРЕПИСАТЬ</span></span>
      <span><span class="key">API:</span> <span class="val">агрегация из всех QMS-эндпоинтов</span></span>
    </div>
    <ul>
      <li><span class="bold">KPI-карточки (5 шт.):</span> Документы <span class="label label-blue">247</span>, Несоответствия <span class="label label-red">8</span>, CAPA <span class="label label-amber">15</span>, Аудиты <span class="label label-accent">92%</span>, Риски <span class="label label-purple">34</span></li>
      <li><span class="bold">Матрица рисков 5×5</span> (мини-версия) — цветовое кодирование, точки с кол-вом рисков</li>
      <li><span class="bold">Лента активности (Timeline)</span> — последние 10 действий из audit log</li>
      <li><span class="bold">Виджет просроченных CAPA</span> — ID, описание, дней просрочки (бейдж red)</li>
      <li><span class="bold">Виджет сроков калибровки</span> — оборудование с ближайшими сроками</li>
      <li><span class="bold">Виджет обучения</span> — progress bars по отделам</li>
    </ul>
  </div>

  <div class="module-card">
    <h3>4.2 📄 Документы</h3>
    <div class="module-meta">
      <span><span class="key">Файл:</span> <span class="val mono">pages/Documents/DocumentsPage.tsx</span></span>
      <span><span class="label label-amber">ДОРАБОТАТЬ</span></span>
      <span><span class="key">API:</span> <span class="val mono">/api/documents</span></span>
      <span><span class="label label-accent">Backend ГОТОВ</span></span>
    </div>
    <ul>
      <li>Табличный реестр: ID, Название, Тип (SOP/РИ/Форма/РК), Версия, Статус, Владелец, Даты</li>
      <li>Вкладки-фильтры: Все | SOP | РИ | Формы | РК | На согласовании | Просрочен пересмотр</li>
      <li>Workflow согласования: Черновик → Проверка → Согласование → Утверждение → Действует</li>
      <li>Статусы: <span style="display:inline-flex; align-items:center; gap:4px"><span class="preview-dot" style="background:var(--accent)"></span> Действует</span> · <span style="display:inline-flex; align-items:center; gap:4px"><span class="preview-dot" style="background:var(--amber)"></span> На согласовании</span> · <span style="display:inline-flex; align-items:center; gap:4px"><span class="preview-dot" style="background:var(--text-dim)"></span> Черновик</span> · <span style="display:inline-flex; align-items:center; gap:4px"><span class="preview-dot" style="background:var(--blue)"></span> На пересмотре</span></li>
      <li>Блок статистики: 4 числа с цветами</li>
    </ul>
  </div>

  <div class="module-card">
    <h3>4.3 ⚠️ Несоответствия</h3>
    <div class="module-meta">
      <span><span class="key">Файл:</span> <span class="val mono">pages/Nonconformity/NonconformityPage.tsx</span></span>
      <span><span class="label label-amber">ДОРАБОТАТЬ</span></span>
      <span><span class="key">API:</span> <span class="val mono">/api/nc</span></span>
      <span><span class="label label-accent">Backend ГОТОВ</span></span>
    </div>
    <ul>
      <li>KPI: Открыто <span class="label label-red">8</span>, Расследование <span class="label label-amber">5</span>, CAPA создано <span class="label label-purple">12</span>, Закрыто <span class="label label-accent">23</span></li>
      <li>Таблица: ID, Описание, Источник, Критичность (Крит./Знач./Незнач.), Статус, Продукт, Дата, Ответственный</li>
      <li>6-шаговый workflow: Регистрация → Расследование (5 Why, Ishikawa) → Диспозиция → CAPA → Верификация → Закрытие</li>
      <li>Pareto-диаграмма источников NC (горизонтальные progress bars)</li>
    </ul>
  </div>

  <div class="module-card">
    <h3>4.4 🔄 CAPA</h3>
    <div class="module-meta">
      <span><span class="key">Файл:</span> <span class="val mono">pages/CAPA/CapaPage.tsx</span></span>
      <span><span class="label label-amber">ДОРАБОТАТЬ</span></span>
      <span><span class="key">API:</span> <span class="val mono">/api/capa</span></span>
      <span><span class="label label-accent">Backend ГОТОВ</span></span>
    </div>
    <ul>
      <li>KPI: Активных <span class="label label-blue">15</span>, Просрочено <span class="label label-red">5</span>, Эффективность <span class="label label-accent">87%</span>, Ср. срок <span class="label label-amber">18д</span></li>
      <li>Таблица: ID, Тип (<span class="label label-red">CA</span> / <span class="label label-amber">PA</span>), Описание, Источник, Статус, Срок, Ответственный, Прогресс-бар</li>
      <li>Визуализация 8D: D1-D8 блоки, заполненные — bg accent-dim + border accent</li>
      <li>Просроченные сроки: color red</li>
    </ul>
  </div>

  <div class="module-card" style="border-left:3px solid var(--red)">
    <h3>4.5 🎯 Риски — <span style="color:var(--red)">СОЗДАТЬ</span></h3>
    <div class="module-meta">
      <span><span class="key">Создать:</span> <span class="val mono">pages/Risk/RiskPage.tsx</span></span>
      <span><span class="label label-red">НОВАЯ</span></span>
      <span><span class="key">API:</span> <span class="val mono">/api/risks</span></span>
      <span><span class="label label-accent">Backend ГОТОВ</span></span>
    </div>
    <ul>
      <li>KPI: Всего <span class="label label-blue">34</span>, Высокие <span class="label label-red">6</span>, Средние <span class="label label-amber">14</span>, Низкие <span class="label label-accent">14</span></li>
      <li>Таблица: ID, Описание, Категория, Начальный P×S=Level, Остаточный, Статус, Меры</li>
      <li><span class="bold">Матрица 5×5 (ISO 14971):</span> Probability (1-5) × Severity (1-5)</li>
      <li>Цвета ячеек: 1-4 <span style="color:var(--accent)">■</span> green · 5-9 <span style="color:var(--amber)">■</span> amber · 10-16 <span style="color:#f97316">■</span> orange · 17-25 <span style="color:var(--red)">■</span> red</li>
      <li>Ячейки с рисками: увеличенный шрифт, жирная рамка, точка</li>
    </ul>
  </div>

  <div class="module-card" style="border-left:3px solid var(--red)">
    <h3>4.6 🏭 Поставщики — <span style="color:var(--red)">СОЗДАТЬ</span></h3>
    <div class="module-meta">
      <span><span class="key">Создать:</span> <span class="val mono">pages/Supplier/SupplierPage.tsx</span></span>
      <span><span class="label label-red">НОВАЯ</span></span>
      <span><span class="key">API:</span> <span class="val mono">/api/suppliers</span></span>
      <span><span class="key">Backend:</span> <span class="val">SupplierScoringService.js — ГОТОВ</span></span>
    </div>
    <ul>
      <li>Таблица: ID, Наименование, Тип (Критический <span class="label label-red">●</span> / Основной <span class="label label-blue">●</span> / Вспомогательный), Рейтинг (progress bar + число), Статус, Продукция, След. оценка</li>
      <li>Рейтинг: ≥80 <span style="color:var(--accent)">green</span> · ≥60 <span style="color:var(--amber)">amber</span> · &lt;60 <span style="color:var(--red)">red</span></li>
      <li>Критерии оценки (6 карточек): Качество 30%, Доставка 20%, Документация 20%, Коммуникация 10%, Цена 10%, Соответствие 10%</li>
    </ul>
  </div>

  <div class="module-card" style="border-left:3px solid var(--red)">
    <h3>4.7 📋 Аудиты — <span style="color:var(--red)">СОЗДАТЬ</span></h3>
    <div class="module-meta">
      <span><span class="key">Создать:</span> <span class="val mono">pages/Audit/AuditPage.tsx</span></span>
      <span><span class="label label-red">НОВАЯ</span></span>
      <span><span class="key">API:</span> <span class="val mono">/api/audits</span></span>
    </div>
    <ul>
      <li>Вкладки: План | Проведение | Замечания | Отчёты</li>
      <li>Таблица: ID, Тип, Процесс/Раздел ISO, Статус, Ведущий аудитор, Даты, Замечания</li>
      <li><span class="bold">Годовой план-матрица:</span> строки = процессы ISO (4.2, 5.6, 7.1...), столбцы = 12 месяцев, ячейки = <span style="color:var(--accent)">■</span> проведён / <span style="color:var(--blue)">■</span> запланирован</li>
      <li>Замечания: <span class="label label-red">Major</span> <span class="label label-amber">Minor</span> <span class="label label-blue">Наблюдение</span> <span class="label label-accent">Рекомендация</span></li>
    </ul>
  </div>

  <div class="module-card" style="border-left:3px solid var(--red)">
    <h3>4.8 📚 Обучение — <span style="color:var(--red)">СОЗДАТЬ</span></h3>
    <div class="module-meta">
      <span><span class="key">Создать:</span> <span class="val mono">pages/Training/TrainingPage.tsx</span></span>
      <span><span class="label label-red">НОВАЯ</span></span>
      <span><span class="key">API:</span> <span class="val mono">/api/training</span></span>
    </div>
    <ul>
      <li>Таблица: Сотрудник, Должность, Тема, Статус, Дата, Балл, Действует до</li>
      <li><span class="bold">Матрица компетенций:</span> строки = сотрудники, столбцы = навыки</li>
      <li>Уровни: <span style="color:var(--accent)">●●●</span> Эксперт · <span style="color:var(--blue)">●●</span> Обучен · <span style="color:var(--amber)">●</span> Базовый · <span style="color:var(--red)">—</span> Не пройдено</li>
    </ul>
  </div>

  <div class="module-card" style="border-left:3px solid var(--red)">
    <h3>4.9 🔧 Оборудование — <span style="color:var(--red)">СОЗДАТЬ</span></h3>
    <div class="module-meta">
      <span><span class="key">Создать:</span> <span class="val mono">pages/Equipment/EquipmentPage.tsx</span></span>
      <span><span class="label label-red">НОВАЯ</span></span>
      <span><span class="key">API:</span> <span class="val mono">/api/equipment</span></span>
    </div>
    <ul>
      <li>Таблица: ID, Наименование, Тип, S/N (mono), Расположение, Статус, Калибровки, Дней до</li>
      <li>Бейдж «Дней до»: <span class="label label-red">-10д</span> просрочено · <span class="label label-amber">4д</span> скоро · <span class="label label-accent">18д</span> норма</li>
      <li>Паспорт оборудования: key-value карточка</li>
      <li>История калибровок: Timeline с результатами и погрешностями</li>
    </ul>
  </div>

  <div class="module-card" style="border-left:3px solid var(--red)">
    <h3>4.10 👔 Анализ руководства — <span style="color:var(--red)">СОЗДАТЬ</span></h3>
    <div class="module-meta">
      <span><span class="key">Создать:</span> <span class="val mono">pages/Review/ManagementReviewPage.tsx</span></span>
      <span><span class="label label-red">НОВАЯ</span></span>
      <span><span class="key">API:</span> <span class="val mono">/api/reviews</span></span>
    </div>
    <ul>
      <li>Таблица: ID, Период, Дата, Статус, Председатель, Решений, Действий</li>
      <li><span class="bold">Входные данные (ISO 13485, п.5.6.2):</span> 8 карточек — аудиты, обратная связь, KPI, CAPA, нормативка, риски, рекомендации, обучение</li>
      <li>Решения и действия: <span class="label label-accent">Выполнено</span> <span class="label label-amber">В работе</span> <span class="label label-grey">Не начато</span></li>
    </ul>
  </div>
</div>




<div class="section">
  <h2 class="section-title"><span class="section-num">5</span>API-эндпоинты</h2>

  <table>
    <tr><th>Модуль</th><th>Эндпоинт</th><th>Методы</th><th>Backend</th></tr>
    <tr><td>Документы</td><td class="mono">/api/documents</td><td>GET POST PUT DELETE</td><td><span class="label label-accent">ГОТОВ</span></td></tr>
    <tr><td>NC</td><td class="mono">/api/nc</td><td>GET POST PUT</td><td><span class="label label-accent">ГОТОВ</span></td></tr>
    <tr><td>CAPA</td><td class="mono">/api/capa</td><td>GET POST PUT</td><td><span class="label label-accent">ГОТОВ</span></td></tr>
    <tr><td>Риски</td><td class="mono">/api/risks</td><td>GET POST PUT</td><td><span class="label label-accent">ГОТОВ</span></td></tr>
    <tr><td>Поставщики</td><td class="mono">/api/suppliers</td><td>GET POST PUT</td><td><span class="label label-amber">Нужен контроллер</span></td></tr>
    <tr><td>Аудиты</td><td class="mono">/api/audits</td><td>GET POST PUT</td><td><span class="label label-amber">Нужен контроллер</span></td></tr>
    <tr><td>Обучение</td><td class="mono">/api/training</td><td>GET POST PUT</td><td><span class="label label-amber">Нужен контроллер</span></td></tr>
    <tr><td>Оборудование</td><td class="mono">/api/equipment</td><td>GET POST PUT</td><td><span class="label label-amber">Нужен контроллер</span></td></tr>
    <tr><td>Анализ рук-ва</td><td class="mono">/api/reviews</td><td>GET POST PUT</td><td><span class="label label-amber">Нужен контроллер</span></td></tr>
  </table>

  <div class="info-card accent-border">
    <p style="margin:0"><span class="bold" style="color:var(--accent)">Важно:</span> Для модулей где API ещё не готов — сначала создать страницу с моковыми данными, затем подключить API.</p>
  </div>
</div>




<div class="section">
  <h2 class="section-title"><span class="section-num">6</span>Файловая структура</h2>

  <div class="code-block">src/
  pages/
    QMS/
      <span class="keyword">QmsLayout.tsx</span>              <span class="comment">← обёртка с сайдбаром</span>
      <span class="update">QmsDashboardPage.tsx</span>       <span class="comment">← переписать</span>
    Documents/
      <span class="update">DocumentsPage.tsx</span>          <span class="comment">← доработать</span>
    Nonconformity/
      <span class="update">NonconformityPage.tsx</span>      <span class="comment">← доработать</span>
    CAPA/
      <span class="update">CapaPage.tsx</span>               <span class="comment">← доработать</span>
    Risk/
      <span class="create">RiskPage.tsx</span>               <span class="comment">← СОЗДАТЬ</span>
    Supplier/
      <span class="create">SupplierPage.tsx</span>           <span class="comment">← СОЗДАТЬ</span>
    Audit/
      <span class="create">AuditPage.tsx</span>              <span class="comment">← СОЗДАТЬ</span>
    Training/
      <span class="create">TrainingPage.tsx</span>           <span class="comment">← СОЗДАТЬ</span>
    Equipment/
      <span class="create">EquipmentPage.tsx</span>          <span class="comment">← СОЗДАТЬ</span>
    Review/
      <span class="create">ManagementReviewPage.tsx</span>   <span class="comment">← СОЗДАТЬ</span>
    Tasks/
      <span class="update">TasksPage.tsx</span>              <span class="comment">← переписать (канбан)</span>
      <span class="update">TasksList.tsx</span>              <span class="comment">← переписать</span>

  components/qms/                   <span class="comment">← shared UI</span>
    <span class="keyword">Badge.tsx</span>
    <span class="keyword">StatusDot.tsx</span>
    <span class="keyword">ProgressBar.tsx</span>
    <span class="keyword">StatCard.tsx</span>
    <span class="keyword">DataTable.tsx</span>               <span class="comment">← reusable table</span>
    <span class="keyword">Timeline.tsx</span>
    <span class="keyword">KpiRow.tsx</span>

  api/
    <span class="update">qmsApi.ts</span>                    <span class="comment">← дополнить эндпоинтами</span></div>
</div>




<div class="section">
  <h2 class="section-title"><span class="section-num">7</span>Приоритеты и сроки</h2>

  <table>
    <tr><th>#</th><th>Задача</th><th>Приоритет</th><th>Оценка</th><th>Зависит от</th></tr>
    <tr><td>1</td><td>Shared компоненты (Badge, Table, StatCard, ProgressBar...)</td><td><span class="label label-red">P0</span></td><td>1 день</td><td>—</td></tr>
    <tr><td>2</td><td>QmsLayout + сайдбар + роутинг</td><td><span class="label label-red">P0</span></td><td>0.5 дня</td><td>—</td></tr>
    <tr><td>3</td><td>Редизайн канбан-доски</td><td><span class="label label-amber">P1</span></td><td>3-4 дня</td><td>#1</td></tr>
    <tr><td>4</td><td>QMS Dashboard</td><td><span class="label label-amber">P1</span></td><td>2 дня</td><td>#1, #2</td></tr>
    <tr><td>5</td><td>Доработка Documents</td><td><span class="label label-amber">P1</span></td><td>1 день</td><td>#1, #2</td></tr>
    <tr><td>6</td><td>Доработка NC + CAPA</td><td><span class="label label-amber">P1</span></td><td>2 дня</td><td>#1, #2</td></tr>
    <tr><td>7</td><td>Risk Page + матрица 5×5</td><td><span class="label label-amber">P1</span></td><td>2 дня</td><td>#1, #2</td></tr>
    <tr><td>8</td><td>Supplier Page</td><td><span class="label label-blue">P2</span></td><td>1.5 дня</td><td>#1, #2</td></tr>
    <tr><td>9</td><td>Audit Page + годовой план</td><td><span class="label label-blue">P2</span></td><td>2 дня</td><td>#1, #2</td></tr>
    <tr><td>10</td><td>Training Page + матрица компет.</td><td><span class="label label-blue">P2</span></td><td>1.5 дня</td><td>#1, #2</td></tr>
    <tr><td>11</td><td>Equipment Page</td><td><span class="label label-blue">P2</span></td><td>1.5 дня</td><td>#1, #2</td></tr>
    <tr><td>12</td><td>Management Review Page</td><td><span class="label label-blue">P2</span></td><td>1 день</td><td>#1, #2</td></tr>
  </table>

  <div class="info-card accent-border" style="margin-top:16px">
    <p style="margin:0"><span class="bold" style="color:var(--accent)">Итого:</span> 18-20 рабочих дней (~4 недели). При 2 разработчиках: 2-2.5 недели.</p>
  </div>
</div>




<div class="section">
  <h2 class="section-title"><span class="section-num">8</span>Критерии приёмки</h2>

  <h3>Обязательно</h3>
  <ol>
    <li>Все 10 QMS-модулей доступны через меню «Качество»</li>
    <li>Канбан-доска полностью в тёмной теме с информативными карточками</li>
    <li>Единый дизайн-язык: цвета, шрифты, компоненты из раздела 2</li>
    <li>Таблицы с сортировкой и sticky-заголовками</li>
    <li>Shared компоненты переиспользуются во всех модулях</li>
    <li>Страницы работают с моковыми данными, если API не готов</li>
    <li>Нет ошибок TypeScript (strict mode)</li>
    <li>Responsive: корректно на 1280px+ (десктоп-приоритет)</li>
  </ol>

  <h3>Желательно</h3>
  <ul class="dim-list">
    <li>Drag-and-drop карточек между колонками канбана</li>
    <li>Анимации при hover и переходах между модулями</li>
    <li>Экспорт таблиц в Excel</li>
    <li>Печатные формы для аудитов и анализа руководства</li>
  </ul>
</div>




<div class="section">
  <h2 class="section-title"><span class="section-num">9</span>Прототипы</h2>

  <p>К ТЗ прилагаются два интерактивных React-прототипа. Открыть в любом React-проекте для визуального референса:</p>

  <div class="info-card" style="display:flex; gap:16px; margin-top:12px">
    <div style="flex:1; padding:12px; background:var(--surface); border-radius:8px; border:1px solid var(--border)">
      <div style="font-weight:700; color:var(--accent); margin-bottom:4px; font-size:13px">kanban-board.jsx</div>
      <div style="font-size:12px; color:var(--text-mid)">Канбан-доска задач — тёмная тема, карточки с данными, фильтры, колонки</div>
    </div>
    <div style="flex:1; padding:12px; background:var(--surface); border-radius:8px; border:1px solid var(--border)">
      <div style="font-weight:700; color:var(--accent); margin-bottom:4px; font-size:13px">qms-modules-design.jsx</div>
      <div style="font-size:12px; color:var(--text-mid)">Все 10 QMS-модулей — таблицы, KPI, матрицы, workflow</div>
    </div>
  </div>

  <p style="margin-top:12px" class="dim">Прототипы используют inline-стили. В продакшне заменить на Tailwind CSS классы.</p>
</div>

</div>




<div class="doc-footer">
  ASVOTECH · ASVO-QMS · ISO 13485:2016 · Confidential · v1.0 · 11.02.2026
</div>

</body>
</html>

================================================================================
FILE: dump_project_full.py
================================================================================

#!/usr/bin/env python3



from __future__ import annotations 

import io 
import os 
import tokenize 
from pathlib import Path 



PROJECT_DIR =Path .cwd ().resolve ()

DUMP_BASENAME_PREFIX ="project_dump_core"
DUMP_EXTENSION =".txt"



STRIP_COMMENTS_IN_DUMP =True 

KEEP_PY_DOCSTRINGS =False 


def get_next_output_file (project_dir :Path )->Path :

    base_file =project_dir /f"{DUMP_BASENAME_PREFIX}{DUMP_EXTENSION}"
    if not base_file .exists ():
        return base_file 

    max_version =1 

    for p in project_dir .glob (f"{DUMP_BASENAME_PREFIX}_*{DUMP_EXTENSION}"):
        stem =p .stem 
        parts =stem .split ("_")
        if not parts :
            continue 
        last =parts [-1 ]
        try :
            num =int (last )
        except ValueError :
            continue 
        if num >max_version :
            max_version =num 

    next_version =max_version +1 
    return project_dir /f"{DUMP_BASENAME_PREFIX}_{next_version}{DUMP_EXTENSION}"



ALLOWED_ROOT_FILES ={
"README.md",
"index.html",
"package.json",
"eslint.config.js",
"vite.config.ts",
"tsconfig.json",
"tsconfig.app.json",
"tsconfig.node.json",
}


ALLOWED_EXT ={

".ts",".tsx",".js",".jsx",".css",".md",".json",".jsonc",".html",

".yml",".yaml",

".sh",

".py",

".tf",".tfvars",

".cfg",".lock",
}


EXCLUDED_DIRS ={

".git",".idea",".vscode",


"node_modules","dist","build",".next",".nuxt",
"coverage",".turbo",".cache",


".venv","venv","env",".env",
"__pycache__",
"Lib","site-packages","Scripts",
".pytest_cache",".mypy_cache",
".tox",".eggs",


".terraform",
}


EXCLUDED_FILES :set [str ]={
"package-lock.json",
}


EXCLUDED_EXT ={
".map",".svg",".png",".jpg",".jpeg",".gif",".ico",".webp",
".bmp",".pdf",".mp4",".mp3",".wav",
".woff",".woff2",".ttf",".eot",
".pyc",".pyo",".pyd",".whl",
}


UNWANTED_RELATIVE_PATHS ={
"QMS-Client-main/package-lock.json",
"QMS-Server-master/package-lock.json",
"QMS-Client-main/README.md",
"QMS-Client-main/src/components/Test/Test.tsx",
}


MAX_FILE_SIZE_BYTES =400_000 
MAX_LINES_PER_FILE =2000 


def is_excluded_dir (name :str )->bool :
    return name in EXCLUDED_DIRS or name .endswith (".egg-info")


def should_keep_root_file (p :Path )->bool :
    return p .name in ALLOWED_ROOT_FILES 


def is_dump_file (path :Path )->bool :

    return (
    path .suffix ==DUMP_EXTENSION 
    and path .stem .startswith (DUMP_BASENAME_PREFIX )
    )


def should_keep (path :Path )->bool :

    if is_dump_file (path ):
        return False 

    try :
        rel =path .relative_to (PROJECT_DIR ).as_posix ()
    except ValueError :
        rel =path .as_posix ()

    if rel in UNWANTED_RELATIVE_PATHS :
        return False 

    if any (part in EXCLUDED_DIRS for part in path .parts ):
        return False 

    if path .name in EXCLUDED_FILES :
        return False 

    if path .suffix .lower ()in EXCLUDED_EXT :
        return False 

    if path .parent ==PROJECT_DIR and should_keep_root_file (path ):
        return True 

    if path .suffix .lower ()in ALLOWED_EXT :
        return True 

    return False 


def gather_files ()->list [Path ]:
    files :list [Path ]=[]
    for root ,dirs ,filenames in os .walk (PROJECT_DIR ):
        dirs [:]=[d for d in dirs if not is_excluded_dir (d )]
        for fn in filenames :
            p =Path (root )/fn 
            if not p .is_file ():
                continue 
            if should_keep (p ):
                files .append (p )
    return sorted (files ,key =lambda x :x .relative_to (PROJECT_DIR ).as_posix ())






def _strip_html_comments (text :str )->str :

    out :list [str ]=[]
    i =0 
    n =len (text )
    while i <n :
        if text .startswith ("<!--",i ):
            j =text .find ("-->",i +4 )
            if j ==-1 :
                out .extend ("\n"for ch in text [i :]if ch =="\n")
                break 
            seg =text [i :j +3 ]
            out .extend ("\n"for ch in seg if ch =="\n")
            i =j +3 
        else :
            out .append (text [i ])
            i +=1 
    return "".join (out )


def _strip_hash_line_comments (text :str ,*,keep_shebang :bool =True )->str :

    out_lines :list [str ]=[]
    lines =text .splitlines (keepends =True )

    for idx ,line in enumerate (lines ):
        if keep_shebang and idx ==0 and line .startswith ("#!"):
            out_lines .append (line )
            continue 

        in_s =False 
        in_d =False 
        i =0 
        while i <len (line ):
            ch =line [i ]
            if ch =="'"and not in_d :
                in_s =not in_s 
                i +=1 
                continue 
            if ch =='"'and not in_s :
                in_d =not in_d 
                i +=1 
                continue 
            if ch =="#"and not in_s and not in_d :

                if i ==0 or line [i -1 ].isspace ():
                    nl ="\n"if line .endswith ("\n")else ""
                    out_lines .append (line [:i ].rstrip ()+nl )
                    break 
            i +=1 
        else :
            out_lines .append (line )

    return "".join (out_lines )


def _strip_c_like_comments (text :str )->str :

    CODE ,SQ ,DQ ,BT ,LINE ,BLOCK =range (6 )
    state =CODE 
    out :list [str ]=[]
    i =0 
    n =len (text )
    esc =False 

    while i <n :
        ch =text [i ]
        nxt =text [i +1 ]if i +1 <n else ""

        if state ==CODE :
            if ch =="/"and nxt =="/":
                state =LINE 
                i +=2 
                continue 
            if ch =="/"and nxt =="*":
                state =BLOCK 
                i +=2 
                continue 
            if ch =="'":
                state =SQ 
                out .append (ch )
                esc =False 
                i +=1 
                continue 
            if ch =='"':
                state =DQ 
                out .append (ch )
                esc =False 
                i +=1 
                continue 
            if ch =="`":
                state =BT 
                out .append (ch )
                esc =False 
                i +=1 
                continue 

            out .append (ch )
            i +=1 
            continue 

        if state ==LINE :
            if ch =="\n":
                out .append ("\n")
                state =CODE 
            i +=1 
            continue 

        if state ==BLOCK :
            if ch =="\n":
                out .append ("\n")
                i +=1 
                continue 
            if ch =="*"and nxt =="/":
                state =CODE 
                i +=2 
                continue 
            i +=1 
            continue 


        out .append (ch )
        if esc :
            esc =False 
        else :
            if ch =="\\":
                esc =True 
            else :
                if state ==SQ and ch =="'":
                    state =CODE 
                elif state ==DQ and ch =='"':
                    state =CODE 
                elif state ==BT and ch =="`":
                    state =CODE 
        i +=1 

    return "".join (out )


def _strip_python (text :str ,*,keep_docstrings :bool )->str :

    shebang =""
    rest =text 
    if text .startswith ("#!"):
        first ,_ ,remainder =text .partition ("\n")
        shebang =first +"\n"
        rest =remainder 

    try :
        tokgen =tokenize .generate_tokens (io .StringIO (rest ).readline )
    except Exception :
        return shebang +_strip_hash_line_comments (rest ,keep_shebang =False )

    out_tokens :list [tuple [int ,str ]]=[]
    prev_type =tokenize .INDENT 
    at_block_start =True 

    for tok in tokgen :
        ttype =tok .type 
        tstr =tok .string 

        if ttype ==tokenize .COMMENT :
            continue 

        if (not keep_docstrings )and ttype ==tokenize .STRING and at_block_start and prev_type in (
        tokenize .INDENT ,tokenize .NEWLINE ,tokenize .NL ,tokenize .DEDENT ,tokenize .ENCODING 
        ):

            prev_type =ttype 
            at_block_start =False 
            continue 

        out_tokens .append ((ttype ,tstr ))

        if ttype ==tokenize .INDENT :
            at_block_start =True 
        elif ttype not in (tokenize .NL ,tokenize .NEWLINE ,tokenize .ENDMARKER ,tokenize .ENCODING ):
            at_block_start =False 

        prev_type =ttype 

    return shebang +tokenize .untokenize (out_tokens )


def strip_comments_for_file (path :Path ,content :str )->str :
    if not STRIP_COMMENTS_IN_DUMP :
        return content 

    ext =path .suffix .lower ()

    if ext ==".py":
        return _strip_python (content ,keep_docstrings =KEEP_PY_DOCSTRINGS )

    if ext in {".html",".htm",".md"}:
        return _strip_html_comments (content )

    if ext in {".yml",".yaml",".sh"}:
        return _strip_hash_line_comments (content ,keep_shebang =True )

    if ext in {".tf",".tfvars"}:
        content =_strip_c_like_comments (content )
        content =_strip_hash_line_comments (content ,keep_shebang =False )
        return content 

    if ext in {".ts",".tsx",".js",".jsx",".css",".json",".jsonc",".cfg",".lock"}:
        return _strip_c_like_comments (content )

    return content 


def read_file_safely (p :Path )->tuple [str ,bool ]:

    truncated =False 
    try :
        size =p .stat ().st_size 
        if size >MAX_FILE_SIZE_BYTES :
            return (
            f"[Пропущено: файл {size} байт больше лимита {MAX_FILE_SIZE_BYTES}]\n",
            True ,
            )

        with p .open ("r",encoding ="utf-8",errors ="replace")as f :
            lines =f .readlines ()

        if len (lines )>MAX_LINES_PER_FILE :
            truncated =True 
            lines =lines [:MAX_LINES_PER_FILE ]
            lines .append (f"\n[... обрезано до {MAX_LINES_PER_FILE} строк ...]\n")

        content ="".join (lines )


        content =strip_comments_for_file (p ,content )

        return content ,truncated 
    except Exception as e :
        return f"[Ошибка чтения файла: {e}]\n",True 


def main ():
    print (f"Стартую сборку из каталога: {PROJECT_DIR}")

    output_file =get_next_output_file (PROJECT_DIR )
    print (f"Файл дампа: {output_file.name}")

    files =gather_files ()

    toc_lines =["PROJECT CORE FILES OVERVIEW\n","="*80 +"\n"]
    for f in files :
        toc_lines .append (f"- {f.relative_to(PROJECT_DIR).as_posix()}\n")
    toc_lines .append ("\n\n")

    with output_file .open ("w",encoding ="utf-8")as out :
        out .writelines (toc_lines )

        for f in files :
            rel =f .relative_to (PROJECT_DIR ).as_posix ()
            out .write ("="*80 +"\n")
            out .write (f"FILE: {rel}\n")
            out .write ("="*80 +"\n\n")

            content ,_truncated =read_file_safely (f )
            out .write (content )
            out .write ("\n")

    print (f"Готово: {output_file}")
    print (f"Файлов собрано: {len(files)}")

    if STRIP_COMMENTS_IN_DUMP :
        print ("Комментарии в дампе: УДАЛЕНЫ (исходники проекта не изменены).")
    else :
        print ("Комментарии в дампе: НЕ трогал.")


if __name__ =="__main__":
    main ()

================================================================================
FILE: integrate-qms.sh
================================================================================

#!/bin/bash





set -e
cd ~/Documents/ASVO-QMS

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}═══════════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}  ASVO-QMS: Интеграция модулей (Audit, DMS, NC, CAPA)     ${NC}"
echo -e "${YELLOW}═══════════════════════════════════════════════════════════${NC}"

SERVER="QMS-Server-master"
CLIENT="QMS-Client-main"


echo -e "\n${GREEN}[1/5] Бэкапы...${NC}"
for f in models/index.js routes/index.js index.js; do
  if [ -f "$SERVER/$f" ] && [ ! -f "$SERVER/$f.pre-qms" ]; then
    cp "$SERVER/$f" "$SERVER/$f.pre-qms"
    echo -e "  ✓ $f → $f.pre-qms"
  fi
done


echo -e "\n${GREEN}[2/5] models/index.js...${NC}"
MODELS_FILE="$SERVER/models/index.js"

if ! grep -q "definitions/Document" "$MODELS_FILE"; then
  sed -i '/require("\.\/ProductionOutput")/a\
\
\
const {\
    Document,\
    DocumentVersion,\
    DocumentApproval,\
    DocumentDistribution,\
    setupDocumentAssociations,\
    DOCUMENT_TYPES,\
    DOCUMENT_STATUSES,\
    VERSION_STATUSES,\
    APPROVAL_ROLES,\
    APPROVAL_DECISIONS,\
} = require("./definitions/Document");\
\
\
const {\
    Nonconformity,\
    NcAttachment,\
    Capa,\
    CapaAction,\
    CapaVerification,\
    setupNcCapaAssociations,\
    NC_SOURCES,\
    NC_CLASSIFICATIONS,\
    NC_STATUSES,\
    NC_DISPOSITIONS,\
    CAPA_TYPES,\
    CAPA_STATUSES,\
    CAPA_PRIORITIES,\
    CAPA_ACTION_STATUSES,\
} = require("./definitions/NcCapa");' "$MODELS_FILE"
  echo -e "  ✓ Импорты Document + NcCapa"
fi

if ! grep -q "setupDocumentAssociations" "$MODELS_FILE"; then
  sed -i '/^module\.exports = {/i\
\
// QMS: Document Management System\
setupDocumentAssociations({ User });\
\
// QMS: NC + CAPA\
setupNcCapaAssociations({ User, Document });' "$MODELS_FILE"
  echo -e "  ✓ Associations"
fi

if ! grep -q "CAPA_ACTION_STATUSES" "$MODELS_FILE"; then
  sed -i '/^};$/i\
\
\
    // QMS: Document Management System\
    Document,\
    DocumentVersion,\
    DocumentApproval,\
    DocumentDistribution,\
    DOCUMENT_TYPES,\
    DOCUMENT_STATUSES,\
    VERSION_STATUSES,\
    APPROVAL_ROLES,\
    APPROVAL_DECISIONS,\
\
    // QMS: NC + CAPA\
    Nonconformity,\
    NcAttachment,\
    Capa,\
    CapaAction,\
    CapaVerification,\
    NC_SOURCES,\
    NC_CLASSIFICATIONS,\
    NC_STATUSES,\
    NC_DISPOSITIONS,\
    CAPA_TYPES,\
    CAPA_STATUSES,\
    CAPA_PRIORITIES,\
    CAPA_ACTION_STATUSES,' "$MODELS_FILE"
  echo -e "  ✓ Экспорты в module.exports"
fi


echo -e "\n${GREEN}[3/5] routes/index.js...${NC}"
ROUTES_FILE="$SERVER/routes/index.js"

if ! grep -q "documentRouter" "$ROUTES_FILE"; then
  sed -i '/const productionOutputRouter/a\
\
// QMS модули\
const documentRouter = require("./documentRouter");\
const ncCapaRouter = require("./ncCapaRouter");' "$ROUTES_FILE"
  echo -e "  ✓ require documentRouter + ncCapaRouter"
fi

if ! grep -q '"/documents"' "$ROUTES_FILE"; then
  sed -i '/router\.use("\/production", productionOutputRouter);/a\
\
// QMS: Document Management System\
router.use("/documents", documentRouter);\
// QMS: Nonconformity + CAPA\
router.use("/nc", ncCapaRouter);' "$ROUTES_FILE"
  echo -e "  ✓ router.use /documents + /nc"
fi


echo -e "\n${GREEN}[4/5] Abilities в index.js...${NC}"
INDEX_FILE="$SERVER/index.js"

if ! grep -q "dms.view" "$INDEX_FILE"; then
  sed -i '/beryll\.manage/a\
\
      // QMS: DMS\
      { code: "dms.view", description: "Просмотр реестра документов" },\
      { code: "dms.create", description: "Создание документов" },\
      { code: "dms.approve", description: "Согласование документов" },\
      { code: "dms.manage", description: "Введение в действие, рассылка" },\
      // QMS: Audit\
      { code: "qms.audit.view", description: "Расширенный аудит-лог" },\
      { code: "qms.audit.verify", description: "Верификация hash-chain" },\
      { code: "qms.audit.report", description: "Отчёты для инспекции" },\
      // QMS: NC\
      { code: "nc.view", description: "Просмотр несоответствий" },\
      { code: "nc.create", description: "Регистрация NC" },\
      { code: "nc.manage", description: "Управление NC" },\
      // QMS: CAPA\
      { code: "capa.view", description: "Просмотр CAPA" },\
      { code: "capa.create", description: "Создание CAPA" },\
      { code: "capa.manage", description: "Управление CAPA" },\
      { code: "capa.verify", description: "Проверка эффективности CAPA" },' "$INDEX_FILE"
  echo -e "  ✓ 14 abilities добавлены"
fi


echo -e "\n${GREEN}[5/5] hashChainLogger → auditLogger...${NC}"
if [ -f "$SERVER/utils/hashChainLogger.js" ]; then
  [ -f "$SERVER/utils/auditLogger.js" ] && cp "$SERVER/utils/auditLogger.js" "$SERVER/utils/auditLogger.js.original"
  mv "$SERVER/utils/hashChainLogger.js" "$SERVER/utils/auditLogger.js"
  echo -e "  ✓ Переименован (все require совместимы)"
else
  echo -e "  → Уже готово"
fi


echo -e "\n${YELLOW}═══ ПРОВЕРКА ═══${NC}"

check() { [ "$1" = "true" ] && echo -e "  ${GREEN}✓${NC} $2" || echo -e "  ${RED}✕${NC} $2"; }

check "$(grep -q 'setupDocumentAssociations' $MODELS_FILE && echo true)" "models: DMS associations"
check "$(grep -q 'setupNcCapaAssociations' $MODELS_FILE && echo true)" "models: NC/CAPA associations"
check "$(grep -q 'documentRouter' $ROUTES_FILE && echo true)" "routes: /documents"
check "$(grep -q 'ncCapaRouter' $ROUTES_FILE && echo true)" "routes: /nc"
check "$(grep -q 'dms.view' $INDEX_FILE && echo true)" "index: DMS abilities"
check "$(grep -q 'capa.verify' $INDEX_FILE && echo true)" "index: CAPA abilities"
check "$([ -f $SERVER/utils/auditVerifier.js ] && echo true)" "utils: auditVerifier.js"
check "$([ -f $SERVER/services/DocumentService.js ] && echo true)" "services: DocumentService.js"
check "$([ -f $SERVER/services/NcCapaService.js ] && echo true)" "services: NcCapaService.js"
check "$([ -f $CLIENT/src/api/qmsApi.ts ] && echo true)" "client: qmsApi.ts"
check "$([ -f $CLIENT/src/pages/QMS/QmsDashboardPage.tsx ] && echo true)" "client: QmsDashboardPage"

echo -e "\n${GREEN}✅ Готово!${NC} Дальше:
  cd $SERVER
  git diff --stat
  npx sequelize-cli db:migrate
  node scripts/backfill-audit-hashes.js
  npm run dev
"

================================================================================
FILE: remove_comments.py
================================================================================

#!/usr/bin/env python3


import os 
import argparse 
from pathlib import Path 
from enum import Enum ,auto 
from typing import Optional 


class State (Enum ):
    CODE =auto ()
    STRING_SINGLE =auto ()
    STRING_DOUBLE =auto ()
    TEMPLATE_STRING =auto ()
    TEMPLATE_EXPR =auto ()
    REGEX =auto ()
    LINE_COMMENT =auto ()
    BLOCK_COMMENT =auto ()


class CommentRemover :




    REGEX_PREV_TOKENS ={
    '(',')','[',']','{','}',',',';',':','=','!','&','|','?',
    '~','^','<','>','+','-','*','%','\n','\r'
    }


    REGEX_KEYWORDS ={
    'return','case','throw','in','instanceof','typeof',
    'void','delete','new','else','do','yield','await'
    }

    def __init__ (self ,content :str ):
        self .content =content 
        self .length =len (content )
        self .pos =0 
        self .result :list [str ]=[]


        self .last_significant_char ='\n'
        self .last_significant_word =''

    def peek (self ,offset :int =0 )->str :
        idx =self .pos +offset 
        return self .content [idx ]if idx <self .length else ''

    def peek_str (self ,length :int )->str :
        return self .content [self .pos :self .pos +length ]

    def advance (self ,count :int =1 )->str :
        s =self .content [self .pos :self .pos +count ]
        self .pos +=count 
        return s 

    def update_last_significant (self ,char :str )->None :

        if char .isalnum ()or char =='_':
            self .last_significant_word +=char 
            return 



        if char .isspace ():
            return 

        self .last_significant_char =char 
        self .last_significant_word =''

    def can_start_regex (self )->bool :
        if self .last_significant_char in self .REGEX_PREV_TOKENS :
            return True 
        if self .last_significant_word in self .REGEX_KEYWORDS :
            return True 
        return False 

    def is_triple_slash_directive (self )->bool :

        if self .peek_str (3 )!='///':
            return False 

        i =self .pos +3 
        rest =[]
        while i <self .length and self .content [i ]!='\n':
            rest .append (self .content [i ])
            i +=1 

        rest_stripped =''.join (rest ).strip ()
        return (
        rest_stripped .startswith ('<')
        and (
        'reference'in rest_stripped 
        or 'amd-module'in rest_stripped 
        or 'amd-dependency'in rest_stripped 
        )
        )

    def is_jsx_comment_start (self )->bool :

        i =self .pos -1 
        while i >=0 and self .content [i ]in ' \t\r\n':
            i -=1 
        return i >=0 and self .content [i ]=='{'

    def remove_trailing_jsx_brace (self )->None :

        while self .result and self .result [-1 ]in ' \t':
            self .result .pop ()
        if self .result and self .result [-1 ]=='{':
            self .result .pop ()
            while self .result and self .result [-1 ]in ' \t':
                self .result .pop ()

    def process_string (self ,quote :str )->None :

        self .result .append (self .advance ())

        while self .pos <self .length :
            ch =self .peek ()
            if ch =='\\'and self .pos +1 <self .length :
                self .result .append (self .advance (2 ))
            elif ch ==quote :
                self .result .append (self .advance ())
                return 
            elif ch =='\n':

                self .result .append (self .advance ())
                return 
            else :
                self .result .append (self .advance ())

    def process_template_string (self )->None :

        self .result .append (self .advance ())

        while self .pos <self .length :
            ch =self .peek ()

            if ch =='\\'and self .pos +1 <self .length :
                self .result .append (self .advance (2 ))
                continue 

            if ch =='`':
                self .result .append (self .advance ())
                return 

            if self .peek_str (2 )=='${':
                self .result .append (self .advance (2 ))

                self .process_template_expression ()
                continue 

            self .result .append (self .advance ())

    def process_template_expression (self )->None :

        brace_depth =1 

        while self .pos <self .length and brace_depth >0 :
            ch =self .peek ()
            two =self .peek_str (2 )

            if ch =='{':
                brace_depth +=1 
                self .result .append (self .advance ())
                self .update_last_significant ('{')
                continue 

            if ch =='}':
                brace_depth -=1 
                self .result .append (self .advance ())
                self .update_last_significant ('}')
                continue 

            if ch =='"':
                self .process_string ('"')

                self .last_significant_char ='"'
                self .last_significant_word =''
                continue 

            if ch =="'":
                self .process_string ("'")
                self .last_significant_char ="'"
                self .last_significant_word =''
                continue 

            if ch =='`':
                self .process_template_string ()
                self .last_significant_char ='`'
                self .last_significant_word =''
                continue 

            if two =='//':
                self .skip_line_comment ()
                self .last_significant_char ='\n'
                self .last_significant_word =''
                continue 

            if two =='/*':
                newlines =self .skip_block_comment (is_jsx =False )
                self .result .append ('\n'*newlines )

                self .last_significant_word =''
                continue 

            if ch =='/':
                if self .can_start_regex ():
                    nxt =self .peek (1 )

                    if nxt not in ('/','*',' ','\t','\n',''):


                        if nxt !='=':
                            self .process_regex ()
                            self .last_significant_char ='/'
                            self .last_significant_word =''
                            continue 

                self .result .append (self .advance ())
                self .update_last_significant ('/')
                continue 

            self .result .append (self .advance ())
            self .update_last_significant (ch )

    def process_regex (self )->None :

        self .result .append (self .advance ())

        in_class =False 

        while self .pos <self .length :
            ch =self .peek ()

            if ch =='\\'and self .pos +1 <self .length :
                self .result .append (self .advance (2 ))
                continue 

            if ch =='['and not in_class :
                in_class =True 
                self .result .append (self .advance ())
                continue 

            if ch ==']'and in_class :
                in_class =False 
                self .result .append (self .advance ())
                continue 

            if ch =='/'and not in_class :
                self .result .append (self .advance ())

                while self .pos <self .length and self .peek ().isalpha ():
                    self .result .append (self .advance ())
                return 

            if ch =='\n':

                return 

            self .result .append (self .advance ())

    def skip_line_comment (self )->None :

        self .advance (2 )
        while self .pos <self .length and self .peek ()!='\n':
            self .advance ()
        if self .pos <self .length :
            self .result .append (self .advance ())

    def skip_block_comment (self ,is_jsx :bool =False )->int :

        self .advance (2 )
        newlines =0 

        while self .pos <self .length :
            if self .peek_str (2 )=='*/':
                self .advance (2 )
                break 
            if self .peek ()=='\n':
                newlines +=1 
            self .advance ()

        if is_jsx :

            while self .pos <self .length and self .peek ()in ' \t':
                self .advance ()

            if self .peek ()=='}':
                self .advance ()

        return newlines 

    def process (self )->str :
        while self .pos <self .length :
            ch =self .peek ()
            two =self .peek_str (2 )


            if ch =='"':
                self .process_string ('"')
                self .last_significant_char ='"'
                self .last_significant_word =''
                continue 

            if ch =="'":
                self .process_string ("'")
                self .last_significant_char ="'"
                self .last_significant_word =''
                continue 


            if ch =='`':
                self .process_template_string ()
                self .last_significant_char ='`'
                self .last_significant_word =''
                continue 


            if self .is_triple_slash_directive ():
                while self .pos <self .length and self .peek ()!='\n':
                    self .result .append (self .advance ())
                if self .pos <self .length :
                    self .result .append (self .advance ())
                self .last_significant_char ='\n'
                self .last_significant_word =''
                continue 


            if two =='//':
                self .skip_line_comment ()
                self .last_significant_char ='\n'
                self .last_significant_word =''
                continue 


            if two =='/*':
                is_jsx =self .is_jsx_comment_start ()
                if is_jsx :
                    self .remove_trailing_jsx_brace ()
                newlines =self .skip_block_comment (is_jsx =is_jsx )
                self .result .append ('\n'*newlines )

                self .last_significant_word =''
                continue 


            if ch =='/':
                if self .can_start_regex ():
                    nxt =self .peek (1 )

                    if nxt not in ('=','/','*',' ','\t','\n',''):

                        if nxt !='=':
                            self .process_regex ()
                            self .last_significant_char ='/'
                            self .last_significant_word =''
                            continue 


                self .result .append (self .advance ())
                self .update_last_significant ('/')
                continue 


            self .result .append (self .advance ())
            self .update_last_significant (ch )

        return ''.join (self .result )


def remove_comments (content :str )->str :
    remover =CommentRemover (content )
    return remover .process ()


def clean_empty_lines (content :str )->str :

    lines =content .split ('\n')
    cleaned =[]
    empty_count =0 

    for line in lines :
        if line .strip ()=='':
            empty_count +=1 
            if empty_count <=2 :
                cleaned .append (line )
        else :
            empty_count =0 
            cleaned .append (line )

    return '\n'.join (cleaned )


def process_file (filepath :Path ,dry_run :bool =False ,verbose :bool =True )->tuple [bool ,int ]:

    try :
        with open (filepath ,'r',encoding ='utf-8')as f :
            original =f .read ()
    except UnicodeDecodeError :
        if verbose :
            print (f"  ⚠️  Пропуск (не UTF-8): {filepath}")
        return False ,0 
    except Exception as e :
        if verbose :
            print (f"  ❌ Ошибка чтения {filepath}: {e}")
        return False ,0 

    cleaned =remove_comments (original )
    cleaned =clean_empty_lines (cleaned )


    cleaned ='\n'.join (line .rstrip ()for line in cleaned .split ('\n'))


    cleaned =cleaned .rstrip ()+'\n'if cleaned .strip ()else ''

    diff =len (original )-len (cleaned )

    if diff >0 :
        if not dry_run :
            with open (filepath ,'w',encoding ='utf-8')as f :
                f .write (cleaned )
        return True ,diff 

    return False ,0 


def find_code_files (root_dir :Path ,extensions :set [str ])->list [Path ]:
    files =[]

    skip_dirs ={
    'node_modules','.git','dist','build','.next',
    '__pycache__','.vscode','.idea','coverage'
    }

    for root ,dirs ,filenames in os .walk (root_dir ):
        dirs [:]=[d for d in dirs if d not in skip_dirs ]

        for filename in filenames :
            ext =Path (filename ).suffix .lower ()
            if ext in extensions :
                files .append (Path (root )/filename )

    return files 


def main ()->int :
    parser =argparse .ArgumentParser (
    description ='Удаление комментариев из JS/TS файлов (v2 — regex/template/triple-slash/JSX)',
    formatter_class =argparse .RawDescriptionHelpFormatter ,
    epilog ="""
Примеры:
  python remove_comments_v2.py ./src                    # Обработать папку
  python remove_comments_v2.py ./src --dry-run          # Только показать
  python remove_comments_v2.py ./src/App.tsx            # Один файл
  python remove_comments_v2.py ./src --ext .ts .tsx     # Только TS
        """
    )

    parser .add_argument ('path',type =str ,help ='Путь к файлу или директории')
    parser .add_argument ('--dry-run','-d',action ='store_true',
    help ='Не изменять файлы, только показать')
    parser .add_argument ('--quiet','-q',action ='store_true',
    help ='Минимальный вывод')
    parser .add_argument ('--ext',nargs ='+',
    default =['.js','.jsx','.ts','.tsx','.mjs','.cjs'],
    help ='Расширения файлов')

    args =parser .parse_args ()

    target =Path (args .path )
    extensions =set (args .ext )
    verbose =not args .quiet 

    if not target .exists ():
        print (f"❌ Путь не существует: {target}")
        return 1 

    if target .is_file ():
        files =[target ]
    else :
        files =find_code_files (target ,extensions )

    if not files :
        print (f"⚠️  Файлы с расширениями {extensions} не найдены")
        return 0 

    if verbose :
        mode ="🔍 DRY-RUN"if args .dry_run else "🔧 РЕДАКТИРОВАНИЕ"
        print (f"\n{mode}")
        print (f"📁 Путь: {target}")
        print (f"📄 Файлов: {len(files)}")
        print ("-"*50 )

    modified_count =0 
    total_saved =0 

    for filepath in sorted (files ):
        changed ,saved =process_file (filepath ,dry_run =args .dry_run ,verbose =verbose )
        if changed :
            modified_count +=1 
            total_saved +=saved 
            if verbose :
                rel =filepath .relative_to (target )if target .is_dir ()else filepath .name 
                print (f"  ✅ {rel} (-{saved} байт)")

    if verbose :
        print ("-"*50 )
        print (f"📊 Изменено: {modified_count} файл(ов)")
        print (f"💾 Сэкономлено: {total_saved:,} байт")

    return 0 


if __name__ =='__main__':
    raise SystemExit (main ())

